# Comparing `tmp/fibsem-0.3.3.tar.gz` & `tmp/fibsem-0.3.4.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "fibsem-0.3.3.tar", last modified: Sat Mar 16 05:16:52 2024, max compression
+gzip compressed data, was "fibsem-0.3.4.tar", last modified: Fri May 17 04:31:54 2024, max compression
```

## Comparing `fibsem-0.3.3.tar` & `fibsem-0.3.4.tar`

### file list

```diff
@@ -1,218 +1,233 @@
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/.github/
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/.github/workflows/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      377 2024-01-04 07:09:38.000000 fibsem-0.3.3/.github/workflows/docs.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      815 2024-01-04 07:09:38.000000 fibsem-0.3.3/.github/workflows/python-package.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      948 2024-02-25 07:12:43.000000 fibsem-0.3.3/.gitignore
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4727 2024-01-20 08:34:48.000000 fibsem-0.3.3/CHANGES.md
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7010 2024-01-04 07:09:38.000000 fibsem-0.3.3/INSTALLATION.md
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1067 2023-12-17 09:12:30.000000 fibsem-0.3.3/LICENSE
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      120 2024-01-14 00:27:09.000000 fibsem-0.3.3/MANIFEST.in
--rw-r--r--   0 patrick   (1000) patrick   (1000)     7115 2024-03-16 05:16:52.744751 fibsem-0.3.3/PKG-INFO
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5921 2024-03-11 01:36:32.000000 fibsem-0.3.3/README.md
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/example/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     3771 2024-02-03 06:47:09.000000 fibsem-0.3.3/example/autolamella.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    17203 2024-01-20 05:39:54.000000 fibsem-0.3.3/example/example.ipynb
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      764 2024-01-09 10:20:24.000000 fibsem-0.3.3/example/example.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1894 2024-01-09 09:56:25.000000 fibsem-0.3.3/example/example_imaging.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2142 2024-01-27 03:35:48.000000 fibsem-0.3.3/example/example_milling.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     3256 2024-01-09 09:55:59.000000 fibsem-0.3.3/example/example_movement.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2707 2024-01-20 08:34:48.000000 fibsem-0.3.3/example/lithography.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)   600128 2023-12-17 09:12:30.000000 fibsem-0.3.3/example/profile.npy
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1250 2024-01-19 10:51:55.000000 fibsem-0.3.3/example/protocol_autolamella.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      259 2023-12-17 09:12:30.000000 fibsem-0.3.3/example/protocol_lithography.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      199 2024-01-04 07:09:38.000000 fibsem-0.3.3/example/protocol_slice_and_view.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2509 2024-01-27 03:35:55.000000 fibsem-0.3.3/example/slice_and_view.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/external/
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/external/application_files/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2725 2024-01-04 07:09:38.000000 fibsem-0.3.3/external/application_files/autolamella.xml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      796 2024-01-04 07:09:38.000000 fibsem-0.3.3/external/application_files/cryo_Pt_dep.xml
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/fibsem/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      152 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/__init__.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      469 2024-01-13 12:55:09.000000 fibsem-0.3.3/fibsem/_version.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5224 2024-01-20 08:34:48.000000 fibsem-0.3.3/fibsem/acquire.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    29463 2024-02-24 07:09:36.000000 fibsem-0.3.3/fibsem/alignment.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    11384 2024-01-20 13:51:46.000000 fibsem-0.3.3/fibsem/calibration.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/fibsem/chat/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)       51 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/chat/.gitignore
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1498 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/chat/main.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)       75 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/chat/requirements.txt
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.736751 fibsem-0.3.3/fibsem/config/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      693 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/config/deposition.dbp
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7084 2024-02-03 04:12:28.000000 fibsem-0.3.3/fibsem/config/microscope-configuration.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2081 2024-02-04 08:09:03.000000 fibsem-0.3.3/fibsem/config/positions.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2518 2024-01-27 02:18:28.000000 fibsem-0.3.3/fibsem/config/protocol.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      425 2024-01-27 04:26:44.000000 fibsem-0.3.3/fibsem/config/tescan_manipulator.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)       87 2024-01-11 10:13:06.000000 fibsem-0.3.3/fibsem/config/user-configurations.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7380 2024-03-11 01:37:12.000000 fibsem-0.3.3/fibsem/config.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4916 2024-01-20 08:34:48.000000 fibsem-0.3.3/fibsem/configuration.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      532 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/constants.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4745 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/conversions.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.736751 fibsem-0.3.3/fibsem/db/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    14325 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/db/app.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)       80 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/db/config.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13731 2024-02-25 07:16:46.000000 fibsem-0.3.3/fibsem/db/notebook.ipynb
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     8300 2024-02-02 06:25:19.000000 fibsem-0.3.3/fibsem/db/util.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.736751 fibsem-0.3.3/fibsem/detection/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/detection/__init__.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      732 2024-01-28 05:46:14.000000 fibsem-0.3.3/fibsem/detection/config-autolamella-liftout.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      752 2024-01-28 05:47:01.000000 fibsem-0.3.3/fibsem/detection/config-autolamella-serial-liftout.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      720 2024-01-28 05:52:25.000000 fibsem-0.3.3/fibsem/detection/config-autolamella-waffle-v2.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      693 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/config-autolamella-waffle.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      716 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/config-autoliftout-dm-embryo.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    44373 2024-01-21 04:32:34.000000 fibsem-0.3.3/fibsem/detection/detection.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    14988 2024-01-28 05:38:41.000000 fibsem-0.3.3/fibsem/detection/evaluation.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1908 2024-01-28 05:32:08.000000 fibsem-0.3.3/fibsem/detection/run_evaluation.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)  1573120 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_image.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)  1583228 2024-02-02 02:54:10.000000 fibsem-0.3.3/fibsem/detection/test_image_2.tif
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.736751 fibsem-0.3.3/fibsem/detection/test_images/
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.736751 fibsem-0.3.3/fibsem/detection/test_images/serial/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13342 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_00.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    14595 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_01.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13662 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_02.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13457 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_03.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13823 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_04.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    14016 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_05.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    14460 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_06.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    14370 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_07.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5487 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/test_needle_mask.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4781 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/test_needle_mask2.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4762 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/detection/test_images/test_needle_mask3.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5012 2024-01-15 04:34:49.000000 fibsem-0.3.3/fibsem/detection/utils.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2307 2024-01-20 08:34:48.000000 fibsem-0.3.3/fibsem/gis.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.736751 fibsem-0.3.3/fibsem/imaging/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/imaging/.gitkeep
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/imaging/__init__.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    15306 2024-01-20 12:14:40.000000 fibsem-0.3.3/fibsem/imaging/_tile.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5999 2024-01-20 08:34:48.000000 fibsem-0.3.3/fibsem/imaging/autogamma.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     6991 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/imaging/masks.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1865 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/imaging/utils.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)   241491 2024-03-01 02:13:29.000000 fibsem-0.3.3/fibsem/microscope.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     9518 2024-02-03 23:48:27.000000 fibsem-0.3.3/fibsem/milling.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2327 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/movement.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    36337 2024-03-09 00:57:02.000000 fibsem-0.3.3/fibsem/patterning.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.740751 fibsem-0.3.3/fibsem/segmentation/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7471 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/README.md
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/segmentation/__init__.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13299 2024-03-09 00:57:02.000000 fibsem-0.3.3/fibsem/segmentation/_nnunet.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4944 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/segmentation/augmentation.ipynb
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1111 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/segmentation/config-autolamella-mega-v4-xl.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1108 2024-01-06 07:16:55.000000 fibsem-0.3.3/fibsem/segmentation/config-autolamella-mega-v4.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1531 2024-01-10 04:41:16.000000 fibsem-0.3.3/fibsem/segmentation/config-autolamella-mega-v5.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1680 2024-01-07 03:58:44.000000 fibsem-0.3.3/fibsem/segmentation/config-autolamella-serial-liftout-v1.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      361 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/segmentation/config-autolamella-waffle4.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      938 2024-01-21 05:06:16.000000 fibsem-0.3.3/fibsem/segmentation/config.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1534 2024-02-24 07:09:36.000000 fibsem-0.3.3/fibsem/segmentation/config.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7727 2024-02-24 07:09:36.000000 fibsem-0.3.3/fibsem/segmentation/dataset.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.740751 fibsem-0.3.3/fibsem/segmentation/docs/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)  2954372 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/docs/example_napari.png
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.732751 fibsem-0.3.3/fibsem/segmentation/docs/imgs/
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.740751 fibsem-0.3.3/fibsem/segmentation/docs/imgs/combined/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)  1270161 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/docs/imgs/combined/combined.jpg
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.740751 fibsem-0.3.3/fibsem/segmentation/docs/imgs/labelled/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)  1572986 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/docs/imgs/labelled/label.tif
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.740751 fibsem-0.3.3/fibsem/segmentation/docs/imgs/raw/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)  1393274 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/docs/imgs/raw/image.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    80125 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/example.ipynb
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     3499 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/inference.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7181 2024-02-25 06:32:22.000000 fibsem-0.3.3/fibsem/segmentation/model.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/fibsem/segmentation/models/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/segmentation/models/.gitkeep
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2688 2024-02-19 06:12:06.000000 fibsem-0.3.3/fibsem/segmentation/nnunet_model.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     3448 2024-01-20 12:49:48.000000 fibsem-0.3.3/fibsem/segmentation/onnx_model.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      137 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/segmentation/requirements.txt
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2216 2024-01-13 10:29:28.000000 fibsem-0.3.3/fibsem/segmentation/sam_model.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1018 2024-01-06 03:38:28.000000 fibsem-0.3.3/fibsem/segmentation/segmentation_config.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      995 2024-02-18 06:49:37.000000 fibsem-0.3.3/fibsem/segmentation/spacetomo_config.yaml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)  1407827 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/segmentation/test_image.tif
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     9386 2024-02-24 07:09:36.000000 fibsem-0.3.3/fibsem/segmentation/train.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    10348 2024-02-01 04:22:10.000000 fibsem-0.3.3/fibsem/segmentation/utils.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    69844 2024-02-25 09:08:09.000000 fibsem-0.3.3/fibsem/structures.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/fibsem/tools/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2046 2024-03-09 01:52:38.000000 fibsem-0.3.3/fibsem/tools/_parser.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1146 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/tools/run_manipulator_calibration.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2160 2024-01-14 08:15:19.000000 fibsem-0.3.3/fibsem/tools/run_split_dataset.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4888 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/tools/telemetry.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/fibsem/ui/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/ui/.gitkeep
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7795 2024-01-27 03:36:18.000000 fibsem-0.3.3/fibsem/ui/FibsemAlignmentWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2403 2024-01-17 06:12:20.000000 fibsem-0.3.3/fibsem/ui/FibsemCryoDepositionWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     6536 2024-01-17 06:10:48.000000 fibsem-0.3.3/fibsem/ui/FibsemCryoDepositionWidget_qt.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     8930 2024-01-20 08:34:48.000000 fibsem-0.3.3/fibsem/ui/FibsemDetectionUI.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    19175 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/FibsemDetectionWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    15135 2024-02-02 02:54:33.000000 fibsem-0.3.3/fibsem/ui/FibsemEmbeddedDetectionWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    16491 2024-02-15 13:33:17.000000 fibsem-0.3.3/fibsem/ui/FibsemFeatureLabellingUI.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7039 2024-01-15 07:12:23.000000 fibsem-0.3.3/fibsem/ui/FibsemGISWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    31037 2024-01-20 09:45:55.000000 fibsem-0.3.3/fibsem/ui/FibsemImageSettingsWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     9339 2024-01-20 08:34:48.000000 fibsem-0.3.3/fibsem/ui/FibsemImageViewer.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    21900 2024-02-19 06:12:06.000000 fibsem-0.3.3/fibsem/ui/FibsemLabellingUI.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13705 2024-01-27 04:42:52.000000 fibsem-0.3.3/fibsem/ui/FibsemManipulatorWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1917 2024-02-03 04:28:26.000000 fibsem-0.3.3/fibsem/ui/FibsemMicroscopeConfigurationWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    19868 2024-02-03 05:04:55.000000 fibsem-0.3.3/fibsem/ui/FibsemMicroscopeConfigurationWidgetBase.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    40087 2024-02-25 10:18:19.000000 fibsem-0.3.3/fibsem/ui/FibsemMillingWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    31445 2024-02-25 10:13:37.000000 fibsem-0.3.3/fibsem/ui/FibsemMinimapWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     6394 2024-02-01 10:09:28.000000 fibsem-0.3.3/fibsem/ui/FibsemModelTrainingWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    19241 2024-01-27 06:14:39.000000 fibsem-0.3.3/fibsem/ui/FibsemMovementWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2966 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/FibsemMultiChemWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     6425 2024-01-20 08:34:48.000000 fibsem-0.3.3/fibsem/ui/FibsemPositionsWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4440 2024-02-19 06:12:06.000000 fibsem-0.3.3/fibsem/ui/FibsemSegmentationModelWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7853 2024-03-11 01:36:52.000000 fibsem-0.3.3/fibsem/ui/FibsemSystemSetupWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     9104 2024-03-11 01:36:54.000000 fibsem-0.3.3/fibsem/ui/FibsemUI.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/ui/__init__.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1207 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/_stylesheets.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/fibsem/ui/qtdesigner_files/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4100 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     6536 2024-01-17 06:04:37.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemCryoDepositionWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    11414 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemDetectionWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5518 2024-01-20 13:41:46.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5009 2024-01-28 06:54:05.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemFeatureDetectionUI.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     6136 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemGISWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     8649 2024-02-19 06:12:06.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemLabellingUI.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     7329 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2791 2024-02-03 04:22:59.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    46776 2024-02-03 23:24:30.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidgetBase.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    15819 2024-02-24 11:26:13.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMillingWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    25110 2024-01-20 12:11:01.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMinimapWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    11180 2024-02-01 10:02:13.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    13317 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMovementWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4643 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4112 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemPositionsWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     2885 2024-01-13 10:09:09.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     3324 2024-02-03 04:54:08.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     3886 2024-01-10 12:55:01.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemUI.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    20155 2024-02-24 11:31:52.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/ImageSettingsWidget.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     5162 2023-12-17 09:12:30.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/detection_dialog.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    25843 2024-01-04 07:09:38.000000 fibsem-0.3.3/fibsem/ui/qtdesigner_files/image_viewer.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    30221 2024-02-25 13:41:42.000000 fibsem-0.3.3/fibsem/ui/utils.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     4855 2024-01-18 13:17:52.000000 fibsem-0.3.3/fibsem/ui/windows.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    18665 2024-03-11 01:37:46.000000 fibsem-0.3.3/fibsem/utils.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    11830 2024-02-04 01:42:34.000000 fibsem-0.3.3/fibsem/validation.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/fibsem.egg-info/
--rw-r--r--   0 patrick   (1000) patrick   (1000)     7115 2024-03-16 05:16:52.000000 fibsem-0.3.3/fibsem.egg-info/PKG-INFO
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     6512 2024-03-16 05:16:52.000000 fibsem-0.3.3/fibsem.egg-info/SOURCES.txt
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        1 2024-03-16 05:16:52.000000 fibsem-0.3.3/fibsem.egg-info/dependency_links.txt
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      233 2024-03-16 05:16:52.000000 fibsem-0.3.3/fibsem.egg-info/entry_points.txt
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      353 2024-03-16 05:16:52.000000 fibsem-0.3.3/fibsem.egg-info/requires.txt
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        7 2024-03-16 05:16:52.000000 fibsem-0.3.3/fibsem.egg-info/top_level.txt
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      188 2024-01-04 07:09:38.000000 fibsem-0.3.3/mkdocs.yml
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      352 2024-01-13 10:25:18.000000 fibsem-0.3.3/requirements.txt
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/scripts/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/.gitkeep
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1423 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/convert_to_nnunet_dataset.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      541 2024-01-09 12:27:59.000000 fibsem-0.3.3/scripts/convert_to_onnx.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     3563 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/export_nnunet_checkpoint.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1015 2024-01-06 05:51:46.000000 fibsem-0.3.3/scripts/generate_segmentation_objects.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      103 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/install.bat
--rwxrwxr-x   0 patrick   (1000) patrick   (1000)       59 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/install.sh
--rw-rw-r--   0 patrick   (1000) patrick   (1000)    10575 2024-02-23 13:50:29.000000 fibsem-0.3.3/scripts/notebook.ipynb
--rwxrwxr-x   0 patrick   (1000) patrick   (1000)       21 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/run.sh
--rw-rw-r--   0 patrick   (1000) patrick   (1000)       56 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/run_ui.bat
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      692 2024-01-04 07:09:38.000000 fibsem-0.3.3/scripts/shortcut.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1646 2024-01-09 09:23:56.000000 fibsem-0.3.3/scripts/test_installation.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      963 2024-03-16 05:16:52.744751 fibsem-0.3.3/setup.cfg
--rw-rw-r--   0 patrick   (1000) patrick   (1000)       36 2023-12-17 09:12:30.000000 fibsem-0.3.3/setup.py
-drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-03-16 05:16:52.744751 fibsem-0.3.3/tests/
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1294 2024-02-04 01:34:43.000000 fibsem-0.3.3/tests/test_alignment.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)       58 2024-01-20 02:29:48.000000 fibsem-0.3.3/tests/test_example.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)     1731 2024-02-04 01:34:53.000000 fibsem-0.3.3/tests/test_movement.py
--rw-rw-r--   0 patrick   (1000) patrick   (1000)      543 2024-02-04 03:24:33.000000 fibsem-0.3.3/tests/test_structures.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.110029 fibsem-0.3.4/
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.094029 fibsem-0.3.4/.github/
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.094029 fibsem-0.3.4/.github/workflows/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      377 2024-01-04 07:09:38.000000 fibsem-0.3.4/.github/workflows/docs.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      815 2024-01-04 07:09:38.000000 fibsem-0.3.4/.github/workflows/python-package.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      970 2024-03-30 10:08:45.000000 fibsem-0.3.4/.gitignore
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4727 2024-01-20 08:34:48.000000 fibsem-0.3.4/CHANGES.md
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7010 2024-01-04 07:09:38.000000 fibsem-0.3.4/INSTALLATION.md
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1067 2023-12-17 09:12:30.000000 fibsem-0.3.4/LICENSE
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      120 2024-01-14 00:27:09.000000 fibsem-0.3.4/MANIFEST.in
+-rw-r--r--   0 patrick   (1000) patrick   (1000)     7115 2024-05-17 04:31:54.110029 fibsem-0.3.4/PKG-INFO
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5921 2024-03-29 10:37:50.000000 fibsem-0.3.4/README.md
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.094029 fibsem-0.3.4/example/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3771 2024-03-16 05:40:11.000000 fibsem-0.3.4/example/autolamella.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    17203 2024-03-16 05:40:11.000000 fibsem-0.3.4/example/example.ipynb
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      764 2024-01-09 10:20:24.000000 fibsem-0.3.4/example/example.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1894 2024-01-09 09:56:25.000000 fibsem-0.3.4/example/example_imaging.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2142 2024-03-16 05:40:11.000000 fibsem-0.3.4/example/example_milling.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3256 2024-01-09 09:55:59.000000 fibsem-0.3.4/example/example_movement.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2707 2024-01-20 08:34:48.000000 fibsem-0.3.4/example/lithography.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)   600128 2023-12-17 09:12:30.000000 fibsem-0.3.4/example/profile.npy
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1250 2024-01-19 10:51:55.000000 fibsem-0.3.4/example/protocol_autolamella.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      259 2023-12-17 09:12:30.000000 fibsem-0.3.4/example/protocol_lithography.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      195 2024-03-29 10:37:50.000000 fibsem-0.3.4/example/protocol_slice_and_view.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2491 2024-03-29 10:37:50.000000 fibsem-0.3.4/example/slice_and_view.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.094029 fibsem-0.3.4/external/
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.094029 fibsem-0.3.4/external/application_files/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2725 2024-01-04 07:09:38.000000 fibsem-0.3.4/external/application_files/autolamella.xml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      796 2024-01-04 07:09:38.000000 fibsem-0.3.4/external/application_files/cryo_Pt_dep.xml
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.094029 fibsem-0.3.4/fibsem/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      152 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/__init__.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      469 2024-01-13 12:55:09.000000 fibsem-0.3.4/fibsem/_version.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5224 2024-01-20 08:34:48.000000 fibsem-0.3.4/fibsem/acquire.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    29463 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/alignment.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    11384 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/calibration.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/chat/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)       51 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/chat/.gitignore
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1498 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/chat/main.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)       75 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/chat/requirements.txt
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/config/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      693 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/config/deposition.dbp
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7084 2024-02-03 04:12:28.000000 fibsem-0.3.4/fibsem/config/microscope-configuration.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2322 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/config/positions.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2712 2024-05-01 06:34:35.000000 fibsem-0.3.4/fibsem/config/protocol.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      425 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/config/tescan_manipulator.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)       87 2024-01-11 10:13:06.000000 fibsem-0.3.4/fibsem/config/user-configurations.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7380 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/config.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4916 2024-03-29 10:22:02.000000 fibsem-0.3.4/fibsem/configuration.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      532 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/constants.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4745 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/conversions.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/db/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    14325 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/db/app.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)       80 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/db/config.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13731 2024-03-16 07:15:11.000000 fibsem-0.3.4/fibsem/db/notebook.ipynb
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     8300 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/db/util.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/db/v2/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2592 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v2/app.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7774 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v2/models.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4405 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v2/notebook.ipynb
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3298 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v2/util.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/db/v3/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2205 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v3/app.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5568 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v3/models.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2365 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v3/notebook.ipynb
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      672 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/db/v3/util.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/detection/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/detection/__init__.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      801 2024-04-02 01:50:40.000000 fibsem-0.3.4/fibsem/detection/config-autolamella-liftout-hf-mega.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      732 2024-04-02 01:49:22.000000 fibsem-0.3.4/fibsem/detection/config-autolamella-liftout.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      812 2024-04-02 01:32:14.000000 fibsem-0.3.4/fibsem/detection/config-autolamella-serial-liftout-hf-mega.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      752 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/detection/config-autolamella-serial-liftout.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      792 2024-04-02 02:09:39.000000 fibsem-0.3.4/fibsem/detection/config-autolamella-waffle-v2-hf-mega.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      720 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/detection/config-autolamella-waffle-v2.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      693 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/config-autolamella-waffle.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      716 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/config-autoliftout-dm-embryo.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    46161 2024-05-05 03:12:06.000000 fibsem-0.3.4/fibsem/detection/detection.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    14988 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/detection/evaluation.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1908 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/detection/run_evaluation.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)  1573120 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_image.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)  1583228 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/detection/test_image_2.tif
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/detection/test_images/
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/detection/test_images/serial/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13342 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_00.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    14595 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_01.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13662 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_02.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13457 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_03.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13823 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_04.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    14016 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_05.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    14460 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_06.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    14370 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_07.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5487 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/test_needle_mask.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4781 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/test_needle_mask2.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4762 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/detection/test_images/test_needle_mask3.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5012 2024-01-15 04:34:49.000000 fibsem-0.3.4/fibsem/detection/utils.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3338 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/gis.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.098029 fibsem-0.3.4/fibsem/imaging/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/imaging/.gitkeep
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/imaging/__init__.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    15696 2024-04-29 09:15:57.000000 fibsem-0.3.4/fibsem/imaging/_tile.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5999 2024-01-20 08:34:48.000000 fibsem-0.3.4/fibsem/imaging/autogamma.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     6991 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/imaging/masks.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1865 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/imaging/utils.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)   252011 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/microscope.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     9626 2024-04-08 04:25:28.000000 fibsem-0.3.4/fibsem/milling.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2327 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/movement.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    39856 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/patterning.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.102029 fibsem-0.3.4/fibsem/segmentation/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7471 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/README.md
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/segmentation/__init__.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13299 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/segmentation/_nnunet.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4944 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/segmentation/augmentation.ipynb
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1111 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/segmentation/config-autolamella-mega-v4-xl.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1108 2024-01-06 07:16:55.000000 fibsem-0.3.4/fibsem/segmentation/config-autolamella-mega-v4.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1531 2024-01-10 04:41:16.000000 fibsem-0.3.4/fibsem/segmentation/config-autolamella-mega-v5.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1680 2024-01-07 03:58:44.000000 fibsem-0.3.4/fibsem/segmentation/config-autolamella-serial-liftout-v1.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      361 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/segmentation/config-autolamella-waffle4.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      938 2024-01-21 05:06:16.000000 fibsem-0.3.4/fibsem/segmentation/config.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1534 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/segmentation/config.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7727 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/segmentation/dataset.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.102029 fibsem-0.3.4/fibsem/segmentation/docs/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)  2954372 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/docs/example_napari.png
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.094029 fibsem-0.3.4/fibsem/segmentation/docs/imgs/
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.102029 fibsem-0.3.4/fibsem/segmentation/docs/imgs/combined/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)  1270161 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/docs/imgs/combined/combined.jpg
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.102029 fibsem-0.3.4/fibsem/segmentation/docs/imgs/labelled/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)  1572986 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/docs/imgs/labelled/label.tif
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/fibsem/segmentation/docs/imgs/raw/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)  1393274 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/docs/imgs/raw/image.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    80125 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/example.ipynb
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2521 2024-04-02 01:43:28.000000 fibsem-0.3.4/fibsem/segmentation/hf_segmentation_model.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    20411 2024-04-02 01:45:33.000000 fibsem-0.3.4/fibsem/segmentation/huggingface.ipynb
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3499 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/inference.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7494 2024-04-02 01:36:23.000000 fibsem-0.3.4/fibsem/segmentation/model.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/fibsem/segmentation/models/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/segmentation/models/.gitkeep
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2688 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/segmentation/nnunet_model.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3448 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/segmentation/onnx_model.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      137 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/segmentation/requirements.txt
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2216 2024-01-13 10:29:28.000000 fibsem-0.3.4/fibsem/segmentation/sam_model.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1018 2024-01-06 03:38:28.000000 fibsem-0.3.4/fibsem/segmentation/segmentation_config.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      995 2024-02-18 06:49:37.000000 fibsem-0.3.4/fibsem/segmentation/spacetomo_config.yaml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)  1407827 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/segmentation/test_image.tif
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     9386 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/segmentation/train.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    10348 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/segmentation/utils.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    72147 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/structures.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/fibsem/tools/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2046 2024-03-09 01:52:38.000000 fibsem-0.3.4/fibsem/tools/_parser.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1146 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/tools/run_manipulator_calibration.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2160 2024-01-14 08:15:19.000000 fibsem-0.3.4/fibsem/tools/run_split_dataset.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4888 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/tools/telemetry.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/fibsem/ui/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/ui/.gitkeep
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7795 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/FibsemAlignmentWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2991 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/ui/FibsemCryoDepositionWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     6536 2024-01-17 06:10:48.000000 fibsem-0.3.4/fibsem/ui/FibsemCryoDepositionWidget_qt.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     8930 2024-01-20 08:34:48.000000 fibsem-0.3.4/fibsem/ui/FibsemDetectionUI.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    19175 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/FibsemDetectionWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    15135 2024-04-29 09:15:57.000000 fibsem-0.3.4/fibsem/ui/FibsemEmbeddedDetectionWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    16491 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/FibsemFeatureLabellingUI.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7039 2024-01-15 07:12:23.000000 fibsem-0.3.4/fibsem/ui/FibsemGISWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    31037 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/FibsemImageSettingsWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     9339 2024-01-20 08:34:48.000000 fibsem-0.3.4/fibsem/ui/FibsemImageViewer.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    21861 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/ui/FibsemLabellingUI.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13705 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/FibsemManipulatorWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1917 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/FibsemMicroscopeConfigurationWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    19868 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/FibsemMicroscopeConfigurationWidgetBase.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    42158 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/ui/FibsemMillingWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    33453 2024-05-17 00:59:22.000000 fibsem-0.3.4/fibsem/ui/FibsemMinimapWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     6394 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/FibsemModelTrainingWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    20414 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/ui/FibsemMovementWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2966 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/FibsemMultiChemWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     6425 2024-01-20 08:34:48.000000 fibsem-0.3.4/fibsem/ui/FibsemPositionsWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4440 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/ui/FibsemSegmentationModelWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7853 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/ui/FibsemSystemSetupWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     9104 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/ui/FibsemUI.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/ui/__init__.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1207 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/_stylesheets.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/fibsem/ui/qtdesigner_files/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4100 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4113 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemCryoDepositionWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    11414 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemDetectionWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5518 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5009 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemFeatureDetectionUI.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     6136 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemGISWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     8649 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemLabellingUI.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     7329 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2791 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    46776 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidgetBase.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    16653 2024-05-05 02:00:58.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMillingWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    25080 2024-05-17 00:45:53.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMinimapWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    11180 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    13317 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMovementWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4643 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4112 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemPositionsWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     2885 2024-01-13 10:09:09.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3324 2024-02-03 04:54:08.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3886 2024-01-10 12:55:01.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemUI.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    20155 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/ImageSettingsWidget.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     5162 2023-12-17 09:12:30.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/detection_dialog.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    25843 2024-01-04 07:09:38.000000 fibsem-0.3.4/fibsem/ui/qtdesigner_files/image_viewer.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    30221 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/ui/utils.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4855 2024-01-18 13:17:52.000000 fibsem-0.3.4/fibsem/ui/windows.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    18665 2024-03-29 10:37:50.000000 fibsem-0.3.4/fibsem/utils.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)    11830 2024-03-16 05:40:11.000000 fibsem-0.3.4/fibsem/validation.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/fibsem.egg-info/
+-rw-r--r--   0 patrick   (1000) patrick   (1000)     7115 2024-05-17 04:31:54.000000 fibsem-0.3.4/fibsem.egg-info/PKG-INFO
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     6959 2024-05-17 04:31:54.000000 fibsem-0.3.4/fibsem.egg-info/SOURCES.txt
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        1 2024-05-17 04:31:54.000000 fibsem-0.3.4/fibsem.egg-info/dependency_links.txt
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      233 2024-05-17 04:31:54.000000 fibsem-0.3.4/fibsem.egg-info/entry_points.txt
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      353 2024-05-17 04:31:54.000000 fibsem-0.3.4/fibsem.egg-info/requires.txt
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        7 2024-05-17 04:31:54.000000 fibsem-0.3.4/fibsem.egg-info/top_level.txt
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      188 2024-01-04 07:09:38.000000 fibsem-0.3.4/mkdocs.yml
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      352 2024-01-13 10:25:18.000000 fibsem-0.3.4/requirements.txt
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/scripts/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)        0 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/.gitkeep
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1423 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/convert_to_nnunet_dataset.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      541 2024-01-09 12:27:59.000000 fibsem-0.3.4/scripts/convert_to_onnx.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     3563 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/export_nnunet_checkpoint.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1015 2024-01-06 05:51:46.000000 fibsem-0.3.4/scripts/generate_segmentation_objects.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      103 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/install.bat
+-rwxrwxr-x   0 patrick   (1000) patrick   (1000)       59 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/install.sh
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4912 2024-03-29 10:37:17.000000 fibsem-0.3.4/scripts/notebook.ipynb
+-rwxrwxr-x   0 patrick   (1000) patrick   (1000)       21 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/run.sh
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)       56 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/run_ui.bat
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      692 2024-01-04 07:09:38.000000 fibsem-0.3.4/scripts/shortcut.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1646 2024-01-09 09:23:56.000000 fibsem-0.3.4/scripts/test_installation.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)      963 2024-05-17 04:31:54.110029 fibsem-0.3.4/setup.cfg
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)       36 2023-12-17 09:12:30.000000 fibsem-0.3.4/setup.py
+drwxrwxr-x   0 patrick   (1000) patrick   (1000)        0 2024-05-17 04:31:54.106029 fibsem-0.3.4/tests/
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1294 2024-03-16 05:40:11.000000 fibsem-0.3.4/tests/test_alignment.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)       58 2024-01-20 02:29:48.000000 fibsem-0.3.4/tests/test_example.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     1731 2024-02-04 01:34:53.000000 fibsem-0.3.4/tests/test_movement.py
+-rw-rw-r--   0 patrick   (1000) patrick   (1000)     4928 2024-05-05 02:00:58.000000 fibsem-0.3.4/tests/test_structures.py
```

### Comparing `fibsem-0.3.3/.github/workflows/python-package.yml` & `fibsem-0.3.4/.github/workflows/python-package.yml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/.gitignore` & `fibsem-0.3.4/.gitignore`

 * *Files 2% similar despite different names*

```diff
@@ -48,7 +48,8 @@
 !fibsem/config/microscope-configuration.yaml
 !fibsem/config/user-configurations.yaml
 !fibsem/config/tescan_manipulator.yaml
 
 **/wandb/*
 tests/notebook.ipynb
 fibsem/db/v2/notebook.ipynb
+scripts/segformer-*/*
```

### Comparing `fibsem-0.3.3/CHANGES.md` & `fibsem-0.3.4/CHANGES.md`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/INSTALLATION.md` & `fibsem-0.3.4/INSTALLATION.md`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/LICENSE` & `fibsem-0.3.4/LICENSE`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/PKG-INFO` & `fibsem-0.3.4/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: fibsem
-Version: 0.3.3
+Version: 0.3.4
 Summary: a universal api for fibsem control
 Home-page: https://github.com/DeMarcoLab/fibsem
 Author: Patrick Cleeve
 Author-email: Patrick.Cleeve@monash.edu
 Project-URL: Bug Tracker, https://github.com/DeMarcoLab/fibsem/issues
 Classifier: Programming Language :: Python :: 3.9
 Classifier: License :: OSI Approved :: MIT License
```

### Comparing `fibsem-0.3.3/README.md` & `fibsem-0.3.4/README.md`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/autolamella.py` & `fibsem-0.3.4/example/autolamella.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/example.ipynb` & `fibsem-0.3.4/example/example.ipynb`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/example.py` & `fibsem-0.3.4/example/example.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/example_imaging.py` & `fibsem-0.3.4/example/example_imaging.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/example_milling.py` & `fibsem-0.3.4/example/example_milling.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/example_movement.py` & `fibsem-0.3.4/example/example_movement.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/lithography.py` & `fibsem-0.3.4/example/lithography.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/profile.npy` & `fibsem-0.3.4/example/profile.npy`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/protocol_autolamella.yaml` & `fibsem-0.3.4/example/protocol_autolamella.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/example/slice_and_view.py` & `fibsem-0.3.4/example/slice_and_view.py`

 * *Files 2% similar despite different names*

```diff
@@ -20,15 +20,15 @@
         mill_settings = settings.milling)
     
     pattern_settings = FibsemRectangleSettings(
         width = settings.protocol["milling"]["width"],
         height = settings.protocol["milling"]["height"],
         depth = settings.protocol["milling"]["depth"],
         scan_direction= settings.protocol["milling"]["scan_direction"],
-        cleaning_cross_section= settings.protocol["milling"]["cleaning_cross_section"]
+        cross_section= settings.protocol["milling"]["cross_section"]
     )
 
     # angle correction
     microscope.set("angular_correction_tilt_correction", True)
     microscope.set("angular_correction_angle", np.deg2rad(-38))
 
     # update image settings
```

### Comparing `fibsem-0.3.3/external/application_files/autolamella.xml` & `fibsem-0.3.4/external/application_files/autolamella.xml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/external/application_files/cryo_Pt_dep.xml` & `fibsem-0.3.4/external/application_files/cryo_Pt_dep.xml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/acquire.py` & `fibsem-0.3.4/fibsem/acquire.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/alignment.py` & `fibsem-0.3.4/fibsem/alignment.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/calibration.py` & `fibsem-0.3.4/fibsem/calibration.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/chat/main.py` & `fibsem-0.3.4/fibsem/chat/main.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/config/deposition.dbp` & `fibsem-0.3.4/fibsem/config/deposition.dbp`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/config/microscope-configuration.yaml` & `fibsem-0.3.4/fibsem/config/microscope-configuration.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/config/positions.yaml` & `fibsem-0.3.4/fibsem/config/positions.yaml`

 * *Files 6% similar despite different names*

```diff
@@ -64,7 +64,21 @@
 -   coordinate_system: RAW
     name: autoliftout-serial-pre-tilt-35-deg-grid-02-landing
     r: 0.8551927515811997
     t: 0.4537750687010593
     x: 0.0029505833333333333
     y: 0.004088416666666666
     z: 0.03178491512345679
+-   coordinate_system: RAW
+    name: arctis-grid-01-electron
+    r: 0
+    t: -3.141592653589793
+    x: 0
+    y: 0
+    z: 0
+-   coordinate_system: RAW
+    name: arctis-grid-01-ion
+    r: 0
+    t: -2.234021442552742
+    x: 0
+    y: 0
+    z: 0
```

### Comparing `fibsem-0.3.3/fibsem/config/protocol.yaml` & `fibsem-0.3.4/fibsem/config/protocol.yaml`

 * *Files 6% similar despite different names*

```diff
@@ -55,14 +55,22 @@
     depth: 4.0e-6
     height: 5.0e-05
     width: 2.0e-05
     scan_direction: TopToBottom
     side_trench_width: 5.0e-06
     top_trench_height: 10.0e-6
     inverted: False
+  SerialSection:
+    section_thickness: 4.0e-6
+    section_width: 50.0e-6
+    section_depth: 20.0e-6
+    side_width: 10.0e-6
+    side_depth: 40.0e-6
+    side_height: 10.0e-6
+    inverted: false
   Undercut: 
     height: 10.0e-6
     width: 10.0e-6
     depth: 5.0e-6
     trench_width: 2.0e-6
     rhs_height: 10.0e-6
     h_offset: 5.0e-6
```

### Comparing `fibsem-0.3.3/fibsem/config.py` & `fibsem-0.3.4/fibsem/config.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/configuration.py` & `fibsem-0.3.4/fibsem/configuration.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/constants.py` & `fibsem-0.3.4/fibsem/constants.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/conversions.py` & `fibsem-0.3.4/fibsem/conversions.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/db/app.py` & `fibsem-0.3.4/fibsem/db/app.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/db/notebook.ipynb` & `fibsem-0.3.4/fibsem/db/notebook.ipynb`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/db/util.py` & `fibsem-0.3.4/fibsem/db/util.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/config-autolamella-liftout.yaml` & `fibsem-0.3.4/fibsem/detection/config-autolamella-liftout.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/config-autolamella-serial-liftout.yaml` & `fibsem-0.3.4/fibsem/detection/config-autolamella-serial-liftout.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/config-autolamella-waffle-v2.yaml` & `fibsem-0.3.4/fibsem/detection/config-autolamella-waffle-v2.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/config-autolamella-waffle.yml` & `fibsem-0.3.4/fibsem/detection/config-autolamella-waffle.yml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/config-autoliftout-dm-embryo.yml` & `fibsem-0.3.4/fibsem/detection/config-autoliftout-dm-embryo.yml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/detection.py` & `fibsem-0.3.4/fibsem/detection/detection.py`

 * *Files 2% similar despite different names*

```diff
@@ -155,14 +155,42 @@
     class_name: str = "landing_post"
 
     def detect(self, img: np.ndarray, mask: np.ndarray = None, point:Point=None) -> 'LandingGridCentre':
         mask = mask == self.class_id  
         self.px = detect_centre_point(mask, threshold=500)
         return self.px
 
+@dataclass
+class LandingGridLeftEdge(Feature):
+    feature_m: Point = None
+    px: Point = None
+    color = "cyan"
+    name: str = "LandingGridLeftEdge"
+    class_id: int = 3
+    class_name: str = "landing_post"
+
+    def detect(self, img: np.ndarray, mask: np.ndarray = None, point:Point=None) -> 'LandingGridLeftEdge':
+        mask = mask == self.class_id  
+        self.px = detect_grid_edge(mask, edge="left")
+        return self.px
+
+@dataclass
+class LandingGridRightEdge(Feature):
+    feature_m: Point = None
+    px: Point = None
+    color = "cyan"
+    name: str = "LandingGridRightEdge"
+    class_id: int = 3
+    class_name: str = "landing_post"
+
+    def detect(self, img: np.ndarray, mask: np.ndarray = None, point:Point=None) -> 'LandingGridRightEdge':
+        mask = mask == self.class_id  
+        self.px = detect_grid_edge(mask, edge="right")
+        return self.px
+
 
 @dataclass
 class CoreFeature(Feature):
     feature_m: Point = None
     px: Point = None
     color = "white"
     name: str = "CoreFeature"
@@ -319,15 +347,15 @@
         return self.px  
 
 # TODO: we can probably consolidate this, rather than have so many classes
 # Feature(class_idx, name, keypoint)
                 
 __FEATURES__ = [ImageCentre, NeedleTip, 
                 LamellaCentre, LamellaLeftEdge, LamellaRightEdge, 
-        LandingPost, LandingGridCentre, 
+        LandingPost, LandingGridCentre, LandingGridLeftEdge, LandingGridRightEdge,
     CoreFeature, LamellaTopEdge, LamellaBottomEdge, 
     NeedleTipBottom, 
     CopperAdapterCentre, CopperAdapterTopEdge, CopperAdapterBottomEdge,
     VolumeBlockCentre, VolumeBlockTopEdge, VolumeBlockBottomEdge, 
     VolumeBlockTopLeftCorner, VolumeBlockTopRightCorner, VolumeBlockBottomLeftCorner, VolumeBlockBottomRightCorner ]
  
 
@@ -446,28 +474,28 @@
             # get the centre point of each coordinate
             py = int(np.mean(edge_mask[0]))
             px = int(np.mean(edge_mask[1]))
 
             # get the min and max x and y coordinates at these median points
             x_min = np.min(edge_mask[1][edge_mask[0] == py])
             x_max = np.max(edge_mask[1][edge_mask[0] == py])
-            y_min = np.min(edge_mask[0][edge_mask[1] == px])
-            y_max = np.max(edge_mask[0][edge_mask[1] == px])
-
 
             if edge == "left":
                 edge_px = Point(x=x_min, y=py)
             if edge == "right":
                 edge_px = Point(x=x_max, y=py)
+
+            y_min = np.min(edge_mask[0][edge_mask[1] == px])
+            y_max = np.max(edge_mask[0][edge_mask[1] == px])
             if edge == "top":
                 edge_px = Point(x=px, y=y_min)
             if edge == "bottom":
                 edge_px = Point(x=px, y=y_max)
-        except:
-            pass
+        except Exception as e:
+            logging.warning(f"Error detecting edge: {e}")
     return Point(x=int(edge_px.x), y=int(edge_px.y))
 
 
 def detect_absolute_edge(mask, edge: str, _filter:str = "largest", _mode: str = "median", threshold: int = 150) -> Point:
 
     # _mode: median or strict
     #   median: take median of points with same extremity
@@ -561,14 +589,39 @@
 
     if isinstance(feature, LamellaBottomEdge):
         px = detect_median_edge(lamella_mask, edge="bottom")
     
     return px
 
 
+def detect_grid_edge(mask: np.ndarray, edge: str, null_top: int = 3) -> Point:
+    """Detect the central internal edge of the grid bar"""
+
+    if edge not in ["left", "right"]:
+        raise ValueError("side must be either 'left' or 'right'")
+
+    # null mask values in top / bottom 1/null_top
+    h, w = mask.shape
+    mask[:h//null_top] = 0
+    mask[(null_top-1)*h//null_top:] = 0
+
+    # split the grid in half vertically
+    if edge == "left":
+        mask[:, w//2:] = 0
+        detect_edge = "right"
+    if edge ==  "right":
+        mask[:, :w//2] = 0
+        detect_edge = "left"
+
+    # detect the edge of the grid (opposite edge as we want the internal edge)
+    px = detect_median_edge(mask, edge=detect_edge)
+
+    return px
+
+
 def detect_needle_v4(mask: np.ndarray, idx:int=2) -> Point:
     needle_mask = mask == idx
     return detect_corner(needle_mask, threshold=100)
 
 def detect_needle_v5(mask: np.ndarray, idx:int=2, edge: str ="right") -> Point:
     needle_mask = mask == idx
     return detect_absolute_edge(needle_mask, edge=edge, 
@@ -743,16 +796,19 @@
         try:
             pixelsize = image.metadata.pixel_size.x
         except: # default (wrong value)
             pixelsize = 25e-9
         
     # model inference
     mask = model.inference(image, rgb=False)
-    rgb = model.postprocess(mask, model.num_classes)
-    mask = mask[0] # remove channel dim
+    if mask.ndim == 3:
+        rgb = model.postprocess(mask, model.num_classes)
+        mask = mask[0] # remove channel dim
+    else:
+        rgb = decode_segmap_v2(mask)
 
     # detect features
     features = detect_features_v2(img=image, 
                                   mask=mask, 
                                   features=features, 
                                   filter=filter, point=point)
 
@@ -1356,16 +1412,16 @@
 
         # get center of mass, from list of points
         cy, cx = np.array(ndimage.center_of_mass(mask))
 
         # get edges
         imask = np.argwhere(mask==1) # probably inefficient to recompute this
 
-        ymin = np.max(imask[:, 0])
-        ymax = np.min(imask[:, 0])
+        ymin = np.min(imask[:, 0])
+        ymax = np.max(imask[:, 0])
         xmin = np.min(imask[:, 1])
         xmax = np.max(imask[:, 1])
 
         centre = cx, cy
         bot = cx, ymin
         top = cx, ymax
         left = xmin, cy
```

### Comparing `fibsem-0.3.3/fibsem/detection/evaluation.py` & `fibsem-0.3.4/fibsem/detection/evaluation.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/run_evaluation.py` & `fibsem-0.3.4/fibsem/detection/run_evaluation.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_image.tif` & `fibsem-0.3.4/fibsem/detection/test_image.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_image_2.tif` & `fibsem-0.3.4/fibsem/detection/test_image_2.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_00.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_00.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_01.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_01.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_02.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_02.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_03.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_03.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_04.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_04.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_05.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_05.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_06.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_06.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/serial/serial_liftout_mask_07.tif` & `fibsem-0.3.4/fibsem/detection/test_images/serial/serial_liftout_mask_07.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/test_needle_mask.tif` & `fibsem-0.3.4/fibsem/detection/test_images/test_needle_mask.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/test_needle_mask2.tif` & `fibsem-0.3.4/fibsem/detection/test_images/test_needle_mask2.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/test_images/test_needle_mask3.tif` & `fibsem-0.3.4/fibsem/detection/test_images/test_needle_mask3.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/detection/utils.py` & `fibsem-0.3.4/fibsem/detection/utils.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/gis.py` & `fibsem-0.3.4/fibsem/gis.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,11 +1,12 @@
 from fibsem.microscope import FibsemMicroscope
 import logging
 import time
-from fibsem.structures import BeamType
+from fibsem.structures import BeamType, FibsemGasInjectionSettings
+
 
 
 gis_protocol = {
     "application_file": "cryo_Pt_dep",
     "gas": "Pt cryo",
     "position": "cryo",
     "hfw": 3.0e-05 ,
@@ -77,7 +78,36 @@
     microscope.move_stage_relative(FibsemStagePosition(z=-1e-3))
 
     # sputter
     deposit_platinum(microscope, protocol)
 
     # return to previous position
     microscope.safe_absolute_stage_movement(position)
+
+def cryo_deposition_v2(microscope: FibsemMicroscope, gis_settings: FibsemGasInjectionSettings, name: str = None, move_down: bool = True):
+
+    # get current position
+    position = microscope.get_microscope_state().stage_position
+
+    # move to deposition position
+    if name is not None:
+        
+        # move to position
+        from fibsem import utils
+        deposition_position = utils._get_position(name)
+        
+        if deposition_position is None:
+            raise RuntimeError(f"Position {name} requested but not found")
+        
+        logging.info(f"Moving to depositon position: {name}")
+        microscope.safe_absolute_stage_movement(deposition_position)
+
+    # move down 
+    if move_down:
+        from fibsem.structures import FibsemStagePosition
+        microscope.move_stage_relative(FibsemStagePosition(z=-1e-3))
+
+    # cryo deposition
+    microscope.cryo_deposition_v2(gis_settings)
+
+    # return to previous position
+    microscope.safe_absolute_stage_movement(position)
```

### Comparing `fibsem-0.3.3/fibsem/imaging/_tile.py` & `fibsem-0.3.4/fibsem/imaging/_tile.py`

 * *Files 2% similar despite different names*

```diff
@@ -206,14 +206,24 @@
     dx = delta.x
     dy = np.sqrt(delta.y**2 + delta.z**2) # TODO: correct for perspective here
     dy = dy if (delta.y<0) else -dy
 
     pt_delta = Point(dx, dy)
     px_delta = pt_delta._to_pixels(image.metadata.pixel_size.x)
 
+    beam_type = image.metadata.image_settings.beam_type
+    if beam_type is BeamType.ELECTRON:
+        scan_rotation = image.metadata.microscope_state.electron_beam.scan_rotation
+    if beam_type is BeamType.ION:
+        scan_rotation = image.metadata.microscope_state.ion_beam.scan_rotation
+    
+    if np.isclose(scan_rotation, np.pi):
+        px_delta.x *= -1.0
+        px_delta.y *= -1.0
+
     image_centre = Point(x=image.data.shape[1]/2, y=image.data.shape[0]/2)
     point = image_centre + px_delta
 
     # NB: there is a small reprojection error that grows with distance from centre
     # print(f"ERROR: dy: {dy}, delta_y: {delta.y}, delta_z: {delta.z}")
 
     return point
@@ -282,15 +292,15 @@
         # clip points to image 
         if _clip:
             pt.x = np.clip(pt.x, 0, image.data.shape[1])
             pt.y = np.clip(pt.y, 0, image.data.shape[0])
 
 
         c =COLOURS[i%len(COLOURS)]
-        plt.plot(pt.x, pt.y, ms=20, c=c, marker="+", markeredgewidth=2, filename=f"{pos.name}")
+        plt.plot(pt.x, pt.y, ms=20, c=c, marker="+", markeredgewidth=2, label=f"{pos.name}")
         if minimap:
             fontsize = 30
         else:
             fontsize = 14
         # draw filename next to point
         plt.text(pt.x-225, pt.y-50, pos.name, fontsize=fontsize, color=c, alpha=0.75)
```

### Comparing `fibsem-0.3.3/fibsem/imaging/autogamma.py` & `fibsem-0.3.4/fibsem/imaging/autogamma.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/imaging/masks.py` & `fibsem-0.3.4/fibsem/imaging/masks.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/imaging/utils.py` & `fibsem-0.3.4/fibsem/imaging/utils.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/microscope.py` & `fibsem-0.3.4/fibsem/microscope.py`

 * *Files 1% similar despite different names*

```diff
@@ -173,14922 +173,15579 @@
 00000ac0: 6d69 6372 6f73 636f 7065 5f63 6c69 656e  microscope_clien
 00000ad0: 742e 656e 756d 6572 6174 696f 6e73 2069  t.enumerations i
 00000ae0: 6d70 6f72 7420 4d61 6e69 7075 6c61 746f  mport Manipulato
 00000af0: 7243 6f6f 7264 696e 6174 6553 7973 7465  rCoordinateSyste
 00000b00: 6d2c 204d 616e 6970 756c 6174 6f72 5361  m, ManipulatorSa
 00000b10: 7665 6450 6f73 6974 696f 6e20 2c4d 756c  vedPosition ,Mul
 00000b20: 7469 4368 656d 496e 7365 7274 506f 7369  tiChemInsertPosi
-00000b30: 7469 6f6e 0a20 2020 205f 5448 4552 4d4f  tion.    _THERMO
-00000b40: 5f41 5049 5f41 5641 494c 4142 4c45 203d  _API_AVAILABLE =
-00000b50: 2054 7275 6520 0a65 7863 6570 7420 4578   True .except Ex
-00000b60: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00000b70: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
-00000b80: 2241 7574 6f73 6372 6970 7420 2854 6865  "Autoscript (The
-00000b90: 726d 6f46 6973 6865 7229 206e 6f74 2069  rmoFisher) not i
-00000ba0: 6e73 7461 6c6c 6564 2e22 290a 2020 2020  nstalled.").    
-00000bb0: 6966 2069 7369 6e73 7461 6e63 6528 652c  if isinstance(e,
-00000bc0: 204e 616d 6545 7272 6f72 293a 0a20 2020   NameError):.   
-00000bd0: 2020 2020 2072 6169 7365 2065 200a 0a69       raise e ..i
-00000be0: 6d70 6f72 7420 7379 730a 0a66 726f 6d20  mport sys..from 
-00000bf0: 6669 6273 656d 2e73 7472 7563 7475 7265  fibsem.structure
-00000c00: 7320 696d 706f 7274 2028 4265 616d 5365  s import (BeamSe
-00000c10: 7474 696e 6773 2c20 4265 616d 5379 7374  ttings, BeamSyst
-00000c20: 656d 5365 7474 696e 6773 2c20 4265 616d  emSettings, Beam
-00000c30: 5479 7065 2c0a 2020 2020 2020 2020 2020  Type,.          
-00000c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000c50: 2020 2020 2046 6962 7365 6d49 6d61 6765       FibsemImage
-00000c60: 2c20 4669 6273 656d 496d 6167 654d 6574  , FibsemImageMet
-00000c70: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-00000c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000c90: 2020 2020 2020 4669 6273 656d 4d61 6e69        FibsemMani
-00000ca0: 7075 6c61 746f 7250 6f73 6974 696f 6e2c  pulatorPosition,
-00000cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000cd0: 4669 6273 656d 4d69 6c6c 696e 6753 6574  FibsemMillingSet
-00000ce0: 7469 6e67 732c 2046 6962 7365 6d52 6563  tings, FibsemRec
-00000cf0: 7461 6e67 6c65 2c0a 2020 2020 2020 2020  tangle,.        
-00000d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000d10: 2020 2020 2020 2046 6962 7365 6d53 7461         FibsemSta
-00000d20: 6765 506f 7369 7469 6f6e 2c0a 2020 2020  gePosition,.    
-00000d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000d40: 2020 2020 2020 2020 2020 2049 6d61 6765             Image
-00000d50: 5365 7474 696e 6773 2c20 5379 7374 656d  Settings, System
-00000d60: 5365 7474 696e 6773 2c20 0a20 2020 2020  Settings, .     
-00000d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000d80: 2020 2020 2020 2020 2020 5379 7374 656d            System
-00000d90: 496e 666f 2c0a 2020 2020 2020 2020 2020  Info,.          
-00000da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000db0: 2020 2020 204d 6963 726f 7363 6f70 6553       MicroscopeS
-00000dc0: 7461 7465 2c20 506f 696e 742c 2046 6962  tate, Point, Fib
-00000dd0: 7365 6d44 6574 6563 746f 7253 6574 7469  semDetectorSetti
-00000de0: 6e67 732c 0a20 2020 2020 2020 2020 2020  ngs,.           
-00000df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000e00: 2020 2020 5468 6572 6d6f 4749 534c 696e      ThermoGISLin
-00000e10: 652c 5468 6572 6d6f 4d75 6c74 6943 6865  e,ThermoMultiChe
-00000e20: 6d4c 696e 652c 0a20 2020 2020 2020 2020  mLine,.         
-00000e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000e40: 2020 2046 6962 7365 6d55 7365 722c 2046     FibsemUser, F
-00000e50: 6962 7365 6d45 7870 6572 696d 656e 742c  ibsemExperiment,
-00000e60: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00000e70: 2020 2020 2020 2020 2020 2020 2020 4669                Fi
-00000e80: 6273 656d 5061 7474 6572 6e53 6574 7469  bsemPatternSetti
-00000e90: 6e67 732c 2046 6962 7365 6d52 6563 7461  ngs, FibsemRecta
-00000ea0: 6e67 6c65 5365 7474 696e 6773 2c20 0a20  ngleSettings, . 
-00000eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000ec0: 2020 2020 2020 2020 2020 2046 6962 7365             Fibse
-00000ed0: 6d43 6972 636c 6553 6574 7469 6e67 732c  mCircleSettings,
-00000ee0: 2046 6962 7365 6d4c 696e 6553 6574 7469   FibsemLineSetti
-00000ef0: 6e67 732c 2046 6962 7365 6d42 6974 6d61  ngs, FibsemBitma
-00000f00: 7053 6574 7469 6e67 732c 200a 2020 2020  pSettings, .    
+00000b30: 7469 6f6e 0a20 2020 2066 726f 6d20 6175  tion.    from au
+00000b40: 746f 7363 7269 7074 5f73 6462 5f6d 6963  toscript_sdb_mic
+00000b50: 726f 7363 6f70 655f 636c 6965 6e74 2e65  roscope_client.e
+00000b60: 6e75 6d65 7261 7469 6f6e 7320 696d 706f  numerations impo
+00000b70: 7274 2052 6567 756c 6172 4372 6f73 7353  rt RegularCrossS
+00000b80: 6563 7469 6f6e 5363 616e 4d65 7468 6f64  ectionScanMethod
+00000b90: 0a20 2020 205f 5448 4552 4d4f 5f41 5049  .    _THERMO_API
+00000ba0: 5f41 5641 494c 4142 4c45 203d 2054 7275  _AVAILABLE = Tru
+00000bb0: 6520 0a65 7863 6570 7420 4578 6365 7074  e .except Except
+00000bc0: 696f 6e20 6173 2065 3a0a 2020 2020 6c6f  ion as e:.    lo
+00000bd0: 6767 696e 672e 6465 6275 6728 2241 7574  gging.debug("Aut
+00000be0: 6f73 6372 6970 7420 2854 6865 726d 6f46  oscript (ThermoF
+00000bf0: 6973 6865 7229 206e 6f74 2069 6e73 7461  isher) not insta
+00000c00: 6c6c 6564 2e22 290a 2020 2020 6966 2069  lled.").    if i
+00000c10: 7369 6e73 7461 6e63 6528 652c 204e 616d  sinstance(e, Nam
+00000c20: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+00000c30: 2072 6169 7365 2065 200a 0a69 6d70 6f72   raise e ..impor
+00000c40: 7420 7379 730a 0a66 726f 6d20 6669 6273  t sys..from fibs
+00000c50: 656d 2e73 7472 7563 7475 7265 7320 696d  em.structures im
+00000c60: 706f 7274 2028 4265 616d 5365 7474 696e  port (BeamSettin
+00000c70: 6773 2c20 4265 616d 5379 7374 656d 5365  gs, BeamSystemSe
+00000c80: 7474 696e 6773 2c20 4265 616d 5479 7065  ttings, BeamType
+00000c90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00000ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000cb0: 2046 6962 7365 6d49 6d61 6765 2c20 4669   FibsemImage, Fi
+00000cc0: 6273 656d 496d 6167 654d 6574 6164 6174  bsemImageMetadat
+00000cd0: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+00000ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000cf0: 2020 4669 6273 656d 4d61 6e69 7075 6c61    FibsemManipula
+00000d00: 746f 7250 6f73 6974 696f 6e2c 0a20 2020  torPosition,.   
+00000d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000d20: 2020 2020 2020 2020 2020 2020 4669 6273              Fibs
+00000d30: 656d 4d69 6c6c 696e 6753 6574 7469 6e67  emMillingSetting
+00000d40: 732c 2046 6962 7365 6d52 6563 7461 6e67  s, FibsemRectang
+00000d50: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00000d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000d70: 2020 2046 6962 7365 6d53 7461 6765 506f     FibsemStagePo
+00000d80: 7369 7469 6f6e 2c0a 2020 2020 2020 2020  sition,.        
+00000d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000da0: 2020 2020 2020 2049 6d61 6765 5365 7474         ImageSett
+00000db0: 696e 6773 2c20 5379 7374 656d 5365 7474  ings, SystemSett
+00000dc0: 696e 6773 2c20 0a20 2020 2020 2020 2020  ings, .         
+00000dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000de0: 2020 2020 2020 5379 7374 656d 496e 666f        SystemInfo
+00000df0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00000e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000e10: 204d 6963 726f 7363 6f70 6553 7461 7465   MicroscopeState
+00000e20: 2c20 506f 696e 742c 2046 6962 7365 6d44  , Point, FibsemD
+00000e30: 6574 6563 746f 7253 6574 7469 6e67 732c  etectorSettings,
+00000e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000e60: 5468 6572 6d6f 4749 534c 696e 652c 5468  ThermoGISLine,Th
+00000e70: 6572 6d6f 4d75 6c74 6943 6865 6d4c 696e  ermoMultiChemLin
+00000e80: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00000e90: 2020 2020 2020 2020 2020 2020 2020 2046                 F
+00000ea0: 6962 7365 6d55 7365 722c 2046 6962 7365  ibsemUser, Fibse
+00000eb0: 6d45 7870 6572 696d 656e 742c 200a 2020  mExperiment, .  
+00000ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000ed0: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
+00000ee0: 5061 7474 6572 6e53 6574 7469 6e67 732c  PatternSettings,
+00000ef0: 2046 6962 7365 6d52 6563 7461 6e67 6c65   FibsemRectangle
+00000f00: 5365 7474 696e 6773 2c20 0a20 2020 2020  Settings, .     
 00000f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000f20: 2020 2020 2020 2020 4372 6f73 7353 6563          CrossSec
-00000f30: 7469 6f6e 5061 7474 6572 6e29 0a69 6d70  tionPattern).imp
-00000f40: 6f72 7420 7468 7265 6164 696e 670a 696d  ort threading.im
-00000f50: 706f 7274 2074 696d 650a 6672 6f6d 2061  port time.from a
-00000f60: 6263 2069 6d70 6f72 7420 4142 432c 2061  bc import ABC, a
-00000f70: 6273 7472 6163 746d 6574 686f 640a 6672  bstractmethod.fr
-00000f80: 6f6d 2063 6f70 7920 696d 706f 7274 2064  om copy import d
-00000f90: 6565 7063 6f70 790a 6672 6f6d 2071 7565  eepcopy.from que
-00000fa0: 7565 2069 6d70 6f72 7420 5175 6575 650a  ue import Queue.
-00000fb0: 6672 6f6d 2074 7970 696e 6720 696d 706f  from typing impo
-00000fc0: 7274 2055 6e69 6f6e 0a69 6d70 6f72 7420  rt Union.import 
-00000fd0: 6e75 6d70 7920 6173 206e 700a 2020 2020  numpy as np.    
-00000fe0: 0a0a 0a0a 636c 6173 7320 4669 6273 656d  ....class Fibsem
-00000ff0: 4d69 6372 6f73 636f 7065 2841 4243 293a  Microscope(ABC):
-00001000: 0a20 2020 2022 2222 4162 7374 7261 6374  .    """Abstract
-00001010: 2063 6c61 7373 2063 6f6e 7461 696e 696e   class containin
-00001020: 6720 616c 6c20 7468 6520 636f 7265 206d  g all the core m
-00001030: 6963 726f 7363 6f70 6520 6675 6e63 7469  icroscope functi
-00001040: 6f6e 616c 6974 6965 7322 2222 0a0a 2020  onalities"""..  
-00001050: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
-00001060: 640a 2020 2020 6465 6620 636f 6e6e 6563  d.    def connec
-00001070: 745f 746f 5f6d 6963 726f 7363 6f70 6528  t_to_microscope(
-00001080: 7365 6c66 2c20 6970 5f61 6464 7265 7373  self, ip_address
-00001090: 3a20 7374 722c 2070 6f72 743a 2069 6e74  : str, port: int
-000010a0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-000010b0: 2020 2070 6173 730a 0a20 2020 2040 6162     pass..    @ab
-000010c0: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
-000010d0: 2064 6566 2064 6973 636f 6e6e 6563 7428   def disconnect(
-000010e0: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
-000010f0: 6173 730a 0a20 2020 2040 6162 7374 7261  ass..    @abstra
-00001100: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
-00001110: 2061 6371 7569 7265 5f69 6d61 6765 2873   acquire_image(s
-00001120: 656c 662c 2069 6d61 6765 5f73 6574 7469  elf, image_setti
-00001130: 6e67 733a 496d 6167 6553 6574 7469 6e67  ngs:ImageSetting
-00001140: 7329 202d 3e20 4669 6273 656d 496d 6167  s) -> FibsemImag
-00001150: 653a 0a20 2020 2020 2020 2070 6173 730a  e:.        pass.
-00001160: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
-00001170: 7468 6f64 0a20 2020 2064 6566 206c 6173  thod.    def las
-00001180: 745f 696d 6167 6528 7365 6c66 2c20 6265  t_image(self, be
-00001190: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-000011a0: 6529 202d 3e20 4669 6273 656d 496d 6167  e) -> FibsemImag
-000011b0: 653a 0a20 2020 2020 2020 2070 6173 730a  e:.        pass.
-000011c0: 2020 2020 0a20 2020 2040 6162 7374 7261      .    @abstra
-000011d0: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
-000011e0: 206c 6976 655f 696d 6167 696e 6728 7365   live_imaging(se
-000011f0: 6c66 2c20 696d 6167 655f 7365 7474 696e  lf, image_settin
-00001200: 6773 3a20 496d 6167 6553 6574 7469 6e67  gs: ImageSetting
-00001210: 732c 2069 6d61 6765 5f71 7565 7565 3a20  s, image_queue: 
-00001220: 5175 6575 652c 2073 746f 705f 6576 656e  Queue, stop_even
-00001230: 743a 2074 6872 6561 6469 6e67 2e45 7665  t: threading.Eve
-00001240: 6e74 293a 0a20 2020 2020 2020 2070 6173  nt):.        pas
-00001250: 730a 2020 2020 0a20 2020 2040 6162 7374  s.    .    @abst
-00001260: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
-00001270: 6566 2061 6371 7569 7265 5f63 6861 6d62  ef acquire_chamb
-00001280: 6572 5f69 6d61 6765 2873 656c 6629 202d  er_image(self) -
-00001290: 3e20 4669 6273 656d 496d 6167 653a 0a20  > FibsemImage:. 
-000012a0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-000012b0: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
-000012c0: 0a20 2020 2040 7468 7265 6164 5f77 6f72  .    @thread_wor
-000012d0: 6b65 720a 2020 2020 6465 6620 636f 6e73  ker.    def cons
-000012e0: 756d 655f 696d 6167 655f 7175 6575 6528  ume_image_queue(
-000012f0: 7365 6c66 2c20 7061 7265 6e74 5f75 6920  self, parent_ui 
-00001300: 3d20 4e6f 6e65 2c20 736c 6565 703a 2066  = None, sleep: f
-00001310: 6c6f 6174 203d 2030 2e31 293a 0a20 2020  loat = 0.1):.   
-00001320: 2020 2020 2070 6173 730a 2020 2020 0a20       pass.    . 
-00001330: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
-00001340: 6f64 0a20 2020 2064 6566 2061 7574 6f63  od.    def autoc
-00001350: 6f6e 7472 6173 7428 7365 6c66 2c20 6265  ontrast(self, be
-00001360: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-00001370: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-00001380: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
-00001390: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
-000013a0: 2020 6465 6620 6175 746f 5f66 6f63 7573    def auto_focus
-000013b0: 2873 656c 662c 2062 6561 6d5f 7479 7065  (self, beam_type
-000013c0: 3a20 4265 616d 5479 7065 2920 2d3e 204e  : BeamType) -> N
-000013d0: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
-000013e0: 730a 0a20 2020 2064 6566 2072 6573 6574  s..    def reset
-000013f0: 5f62 6561 6d5f 7368 6966 7473 2873 656c  _beam_shifts(sel
-00001400: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
-00001410: 2020 2020 2222 2253 6574 2074 6865 2062      """Set the b
-00001420: 6561 6d20 7368 6966 7420 746f 207a 6572  eam shift to zer
-00001430: 6f20 666f 7220 7468 6520 656c 6563 7472  o for the electr
-00001440: 6f6e 2061 6e64 2069 6f6e 2062 6561 6d73  on and ion beams
-00001450: 2e22 2222 0a20 2020 2020 2020 2073 656c  .""".        sel
-00001460: 662e 7365 7428 2273 6869 6674 222c 2050  f.set("shift", P
-00001470: 6f69 6e74 2830 2c20 3029 2c20 4265 616d  oint(0, 0), Beam
-00001480: 5479 7065 2e45 4c45 4354 524f 4e29 0a20  Type.ELECTRON). 
-00001490: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
-000014a0: 2273 6869 6674 222c 2050 6f69 6e74 2830  "shift", Point(0
-000014b0: 2c20 3029 2c20 4265 616d 5479 7065 2e49  , 0), BeamType.I
-000014c0: 4f4e 290a 0a20 2020 2040 6162 7374 7261  ON)..    @abstra
-000014d0: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
-000014e0: 2062 6561 6d5f 7368 6966 7428 7365 6c66   beam_shift(self
-000014f0: 2c20 6478 3a20 666c 6f61 742c 2064 793a  , dx: float, dy:
-00001500: 2066 6c6f 6174 2c20 6265 616d 5f74 7970   float, beam_typ
-00001510: 653a 2042 6561 6d54 7970 6529 202d 3e20  e: BeamType) -> 
-00001520: 4e6f 6e65 3a0a 2020 2020 2020 2020 7061  None:.        pa
-00001530: 7373 0a0a 2020 2020 6465 6620 6765 745f  ss..    def get_
-00001540: 7374 6167 655f 706f 7369 7469 6f6e 2873  stage_position(s
-00001550: 656c 6629 202d 3e20 4669 6273 656d 5374  elf) -> FibsemSt
-00001560: 6167 6550 6f73 6974 696f 6e3a 0a20 2020  agePosition:.   
-00001570: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00001580: 2047 6574 2074 6865 2063 7572 7265 6e74   Get the current
-00001590: 2073 7461 6765 2070 6f73 6974 696f 6e2e   stage position.
-000015a0: 0a0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
-000015b0: 6574 686f 6420 7265 7472 6965 7665 7320  ethod retrieves 
-000015c0: 7468 6520 6375 7272 656e 7420 7374 6167  the current stag
-000015d0: 6520 706f 7369 7469 6f6e 2066 726f 6d20  e position from 
-000015e0: 7468 6520 6d69 6372 6f73 636f 7065 2061  the microscope a
-000015f0: 6e64 2072 6574 7572 6e73 2069 7420 6173  nd returns it as
-00001600: 0a20 2020 2020 2020 2061 2046 6962 7365  .        a Fibse
-00001610: 6d53 7461 6765 506f 7369 7469 6f6e 206f  mStagePosition o
-00001620: 626a 6563 742e 2046 6962 7365 6d53 7461  bject. FibsemSta
-00001630: 6765 2050 6f73 6974 696f 6e20 6973 2069  ge Position is i
-00001640: 6e20 7468 6520 5241 5720 636f 6f72 6469  n the RAW coordi
-00001650: 6e61 7465 2066 7261 6d65 0a0a 2020 2020  nate frame..    
-00001660: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-00001670: 2020 2020 2020 2020 2046 6962 7365 6d53           FibsemS
-00001680: 7461 6765 506f 7369 7469 6f6e 3a20 5468  tagePosition: Th
-00001690: 6520 6375 7272 656e 7420 7374 6167 6520  e current stage 
-000016a0: 706f 7369 7469 6f6e 2e0a 2020 2020 2020  position..      
-000016b0: 2020 2222 220a 0a20 2020 2020 2020 2073    """..        s
-000016c0: 7461 6765 5f70 6f73 6974 696f 6e20 3d20  tage_position = 
-000016d0: 7365 6c66 2e67 6574 2822 7374 6167 655f  self.get("stage_
-000016e0: 706f 7369 7469 6f6e 2229 0a20 2020 2020  position").     
-000016f0: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
-00001700: 287b 226d 7367 223a 2022 6765 745f 7374  ({"msg": "get_st
-00001710: 6167 655f 706f 7369 7469 6f6e 222c 2022  age_position", "
-00001720: 706f 7322 3a20 7374 6167 655f 706f 7369  pos": stage_posi
-00001730: 7469 6f6e 2e74 6f5f 6469 6374 2829 7d29  tion.to_dict()})
-00001740: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00001750: 7374 6167 655f 706f 7369 7469 6f6e 0a20  stage_position. 
-00001760: 2020 200a 2020 2020 4061 6273 7472 6163     .    @abstrac
-00001770: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
-00001780: 6d6f 7665 5f73 7461 6765 5f61 6273 6f6c  move_stage_absol
-00001790: 7574 6528 7365 6c66 2c20 706f 7369 7469  ute(self, positi
-000017a0: 6f6e 3a20 4669 6273 656d 5374 6167 6550  on: FibsemStageP
-000017b0: 6f73 6974 696f 6e29 202d 3e20 4e6f 6e65  osition) -> None
-000017c0: 3a0a 2020 2020 2020 2020 7061 7373 0a0a  :.        pass..
-000017d0: 2020 2020 4061 6273 7472 6163 746d 6574      @abstractmet
-000017e0: 686f 640a 2020 2020 6465 6620 6d6f 7665  hod.    def move
-000017f0: 5f73 7461 6765 5f72 656c 6174 6976 6528  _stage_relative(
-00001800: 7365 6c66 2c20 706f 7369 7469 6f6e 3a20  self, position: 
-00001810: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-00001820: 696f 6e29 202d 3e20 4e6f 6e65 3a0a 2020  ion) -> None:.  
-00001830: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00001840: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
-00001850: 2020 2020 6465 6620 7374 6162 6c65 5f6d      def stable_m
-00001860: 6f76 6528 7365 6c66 2c64 783a 2066 6c6f  ove(self,dx: flo
-00001870: 6174 2c20 6479 3a20 666c 6f61 742c 2062  at, dy: float, b
-00001880: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
-00001890: 7065 2920 2d3e 2046 6962 7365 6d53 7461  pe) -> FibsemSta
-000018a0: 6765 506f 7369 7469 6f6e 3a0a 2020 2020  gePosition:.    
-000018b0: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
-000018c0: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
-000018d0: 2020 6465 6620 7665 7274 6963 616c 5f6d    def vertical_m
-000018e0: 6f76 6528 7365 6c66 2c20 6479 3a20 666c  ove(self, dy: fl
-000018f0: 6f61 742c 2064 783a 2066 6c6f 6174 203d  oat, dx: float =
-00001900: 2030 2c20 7374 6174 6963 5f77 643a 2062   0, static_wd: b
-00001910: 6f6f 6c20 3d20 5472 7565 2920 2d3e 204e  ool = True) -> N
-00001920: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
-00001930: 730a 0a20 2020 2064 6566 206d 6f76 655f  s..    def move_
-00001940: 666c 6174 5f74 6f5f 6265 616d 2873 656c  flat_to_beam(sel
-00001950: 662c 2062 6561 6d5f 7479 7065 3a20 4265  f, beam_type: Be
-00001960: 616d 5479 7065 2c20 5f73 6166 653a 626f  amType, _safe:bo
-00001970: 6f6c 203d 2054 7275 6529 202d 3e20 4e6f  ol = True) -> No
-00001980: 6e65 3a0a 2020 2020 2020 2020 2222 224d  ne:.        """M
-00001990: 6f76 6520 7468 6520 7361 6d70 6c65 2073  ove the sample s
-000019a0: 7572 6661 6365 2066 6c61 7420 746f 2074  urface flat to t
-000019b0: 6865 2065 6c65 6374 726f 6e20 6f72 2069  he electron or i
-000019c0: 6f6e 2062 6561 6d2e 2222 220a 0a20 2020  on beam."""..   
-000019d0: 2020 2020 205f 6368 6563 6b5f 7374 6167       _check_stag
-000019e0: 6528 7365 6c66 2e73 7973 7465 6d2c 2072  e(self.system, r
-000019f0: 6f74 6174 696f 6e3d 2054 7275 652c 2074  otation= True, t
-00001a00: 696c 743d 5472 7565 290a 2020 2020 2020  ilt=True).      
-00001a10: 2020 7374 6167 655f 7365 7474 696e 6773    stage_settings
-00001a20: 203d 2073 656c 662e 7379 7374 656d 2e73   = self.system.s
-00001a30: 7461 6765 0a20 2020 2020 2020 2073 6875  tage.        shu
-00001a40: 7474 6c65 5f70 7265 5f74 696c 7420 3d20  ttle_pre_tilt = 
-00001a50: 7374 6167 655f 7365 7474 696e 6773 2e73  stage_settings.s
-00001a60: 6875 7474 6c65 5f70 7265 5f74 696c 740a  huttle_pre_tilt.
-00001a70: 0a20 2020 2020 2020 2069 6620 6265 616d  .        if beam
-00001a80: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
-00001a90: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
-00001aa0: 2020 2020 2020 2020 726f 7461 7469 6f6e          rotation
-00001ab0: 203d 206e 702e 6465 6732 7261 6428 7374   = np.deg2rad(st
-00001ac0: 6167 655f 7365 7474 696e 6773 2e72 6f74  age_settings.rot
-00001ad0: 6174 696f 6e5f 7265 6665 7265 6e63 6529  ation_reference)
-00001ae0: 0a20 2020 2020 2020 2020 2020 2074 696c  .            til
-00001af0: 7420 3d20 6e70 2e64 6567 3272 6164 2873  t = np.deg2rad(s
-00001b00: 6875 7474 6c65 5f70 7265 5f74 696c 7429  huttle_pre_tilt)
-00001b10: 0a0a 2020 2020 2020 2020 6966 2062 6561  ..        if bea
-00001b20: 6d5f 7479 7065 2069 7320 4265 616d 5479  m_type is BeamTy
-00001b30: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
-00001b40: 2020 2020 726f 7461 7469 6f6e 203d 206e      rotation = n
-00001b50: 702e 6465 6732 7261 6428 7374 6167 655f  p.deg2rad(stage_
-00001b60: 7365 7474 696e 6773 2e72 6f74 6174 696f  settings.rotatio
-00001b70: 6e5f 3138 3029 0a20 2020 2020 2020 2020  n_180).         
-00001b80: 2020 2074 696c 7420 3d20 6e70 2e64 6567     tilt = np.deg
-00001b90: 3272 6164 2873 656c 662e 7379 7374 656d  2rad(self.system
-00001ba0: 2e69 6f6e 2e63 6f6c 756d 6e5f 7469 6c74  .ion.column_tilt
-00001bb0: 202d 2073 6875 7474 6c65 5f70 7265 5f74   - shuttle_pre_t
-00001bc0: 696c 7429 0a0a 2020 2020 2020 2020 2320  ilt)..        # 
-00001bd0: 7570 6461 7465 6420 7361 6665 2072 6f74  updated safe rot
-00001be0: 6174 696f 6e20 6d6f 7665 0a20 2020 2020  ation move.     
-00001bf0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00001c00: 6622 6d6f 7669 6e67 2066 6c61 7420 746f  f"moving flat to
-00001c10: 207b 6265 616d 5f74 7970 652e 6e61 6d65   {beam_type.name
-00001c20: 7d22 290a 2020 2020 2020 2020 7374 6167  }").        stag
-00001c30: 655f 706f 7369 7469 6f6e 203d 2046 6962  e_position = Fib
-00001c40: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00001c50: 2872 3d72 6f74 6174 696f 6e2c 2074 3d74  (r=rotation, t=t
-00001c60: 696c 7429 0a0a 2020 2020 2020 2020 6c6f  ilt)..        lo
-00001c70: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
-00001c80: 6722 3a20 226d 6f76 655f 666c 6174 5f74  g": "move_flat_t
-00001c90: 6f5f 6265 616d 222c 2022 7374 6167 655f  o_beam", "stage_
-00001ca0: 706f 7369 7469 6f6e 223a 2073 7461 6765  position": stage
-00001cb0: 5f70 6f73 6974 696f 6e2e 746f 5f64 6963  _position.to_dic
-00001cc0: 7428 292c 2022 6265 616d 5f74 7970 6522  t(), "beam_type"
-00001cd0: 3a20 6265 616d 5f74 7970 652e 6e61 6d65  : beam_type.name
-00001ce0: 7d29 0a20 2020 2020 2020 2020 2020 200a  }).            .
-00001cf0: 2020 2020 2020 2020 6966 205f 7361 6665          if _safe
-00001d00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00001d10: 6c66 2e73 6166 655f 6162 736f 6c75 7465  lf.safe_absolute
-00001d20: 5f73 7461 6765 5f6d 6f76 656d 656e 7428  _stage_movement(
-00001d30: 7374 6167 655f 706f 7369 7469 6f6e 290a  stage_position).
-00001d40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00001d50: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00001d60: 6f76 655f 7374 6167 655f 6162 736f 6c75  ove_stage_absolu
-00001d70: 7465 2873 7461 6765 5f70 6f73 6974 696f  te(stage_positio
-00001d80: 6e29 0a0a 2020 2020 4061 6273 7472 6163  n)..    @abstrac
-00001d90: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
-00001da0: 7361 6665 5f61 6273 6f6c 7574 655f 7374  safe_absolute_st
-00001db0: 6167 655f 6d6f 7665 6d65 6e74 2873 656c  age_movement(sel
-00001dc0: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
-00001dd0: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00001de0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00001df0: 2020 2070 6173 730a 0a20 2020 2064 6566     pass..    def
-00001e00: 2067 6574 5f6d 616e 6970 756c 6174 6f72   get_manipulator
-00001e10: 5f73 7461 7465 2873 656c 6629 202d 3e20  _state(self) -> 
-00001e20: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
-00001e30: 2247 6574 2074 6865 206d 616e 6970 756c  "Get the manipul
-00001e40: 6174 6f72 2073 7461 7465 2028 496e 7365  ator state (Inse
-00001e50: 7274 6564 203d 2054 7275 652c 2052 6574  rted = True, Ret
-00001e60: 7261 6374 6564 203d 2046 616c 7365 2922  racted = False)"
-00001e70: 2222 0a20 2020 2020 2020 2023 2054 4f44  "".        # TOD
-00001e80: 4f3a 2063 6f6e 7665 7274 2074 6f20 656e  O: convert to en
-00001e90: 756d 0a20 2020 2020 2020 2072 6574 7572  um.        retur
-00001ea0: 6e20 7365 6c66 2e67 6574 2822 6d61 6e69  n self.get("mani
-00001eb0: 7075 6c61 746f 725f 7374 6174 6522 290a  pulator_state").
-00001ec0: 2020 2020 0a20 2020 2064 6566 2067 6574      .    def get
-00001ed0: 5f6d 616e 6970 756c 6174 6f72 5f70 6f73  _manipulator_pos
-00001ee0: 6974 696f 6e28 7365 6c66 2920 2d3e 2046  ition(self) -> F
-00001ef0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-00001f00: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
-00001f10: 2020 2222 2247 6574 2074 6865 206d 616e    """Get the man
-00001f20: 6970 756c 6174 6f72 2070 6f73 6974 696f  ipulator positio
-00001f30: 6e2e 2222 220a 2020 2020 2020 2020 7265  n.""".        re
-00001f40: 7475 726e 2073 656c 662e 6765 7428 226d  turn self.get("m
-00001f50: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
-00001f60: 696f 6e22 290a 0a20 2020 2040 6162 7374  ion")..    @abst
-00001f70: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
-00001f80: 6566 2069 6e73 6572 745f 6d61 6e69 7075  ef insert_manipu
-00001f90: 6c61 746f 7228 7365 6c66 2c20 6e61 6d65  lator(self, name
-00001fa0: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-00001fb0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-00001fc0: 2020 4061 6273 7472 6163 746d 6574 686f    @abstractmetho
-00001fd0: 640a 2020 2020 6465 6620 7265 7472 6163  d.    def retrac
-00001fe0: 745f 6d61 6e69 7075 6c61 746f 7228 7365  t_manipulator(se
-00001ff0: 6c66 293a 0a20 2020 2020 2020 2070 6173  lf):.        pas
-00002000: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
-00002010: 6d65 7468 6f64 0a20 2020 2064 6566 206d  method.    def m
-00002020: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
-00002030: 7265 6c61 7469 7665 2873 656c 662c 2070  relative(self, p
-00002040: 6f73 6974 696f 6e3a 2046 6962 7365 6d4d  osition: FibsemM
-00002050: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-00002060: 6f6e 2920 2d3e 204e 6f6e 653a 0a20 2020  on) -> None:.   
-00002070: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
-00002080: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
-00002090: 2020 2064 6566 206d 6f76 655f 6d61 6e69     def move_mani
-000020a0: 7075 6c61 746f 725f 6162 736f 6c75 7465  pulator_absolute
-000020b0: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
-000020c0: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
-000020d0: 6f72 506f 7369 7469 6f6e 2920 2d3e 204e  orPosition) -> N
-000020e0: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
-000020f0: 730a 2020 2020 0a20 2020 2040 6162 7374  s.    .    @abst
-00002100: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
-00002110: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
-00002120: 746f 725f 636f 7272 6563 7465 6428 7365  tor_corrected(se
-00002130: 6c66 2c20 6478 3a20 666c 6f61 742c 2064  lf, dx: float, d
-00002140: 793a 2066 6c6f 6174 2c20 6265 616d 5f74  y: float, beam_t
-00002150: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
-00002160: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00002170: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
-00002180: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
-00002190: 6620 6d6f 7665 5f6d 616e 6970 756c 6174  f move_manipulat
-000021a0: 6f72 5f74 6f5f 706f 7369 7469 6f6e 5f6f  or_to_position_o
-000021b0: 6666 7365 7428 7365 6c66 2c20 6f66 6673  ffset(self, offs
-000021c0: 6574 3a20 4669 6273 656d 4d61 6e69 7075  et: FibsemManipu
-000021d0: 6c61 746f 7250 6f73 6974 696f 6e2c 206e  latorPosition, n
-000021e0: 616d 653a 2073 7472 2920 2d3e 204e 6f6e  ame: str) -> Non
-000021f0: 653a 0a20 2020 2020 2020 2070 6173 730a  e:.        pass.
-00002200: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
-00002210: 7468 6f64 0a20 2020 2064 6566 205f 6765  thod.    def _ge
-00002220: 745f 7361 7665 645f 6d61 6e69 7075 6c61  t_saved_manipula
-00002230: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
-00002240: 662c 206e 616d 653a 2073 7472 2920 2d3e  f, name: str) ->
-00002250: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
-00002260: 6f72 506f 7369 7469 6f6e 3a0a 2020 2020  orPosition:.    
-00002270: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
-00002280: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
-00002290: 2020 6465 6620 7365 7475 705f 6d69 6c6c    def setup_mill
-000022a0: 696e 6728 7365 6c66 2c20 6d69 6c6c 5f73  ing(self, mill_s
-000022b0: 6574 7469 6e67 733a 2046 6962 7365 6d4d  ettings: FibsemM
-000022c0: 696c 6c69 6e67 5365 7474 696e 6773 2920  illingSettings) 
-000022d0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-000022e0: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
-000022f0: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
-00002300: 6566 2072 756e 5f6d 696c 6c69 6e67 2873  ef run_milling(s
-00002310: 656c 662c 206d 696c 6c69 6e67 5f63 7572  elf, milling_cur
-00002320: 7265 6e74 3a20 666c 6f61 742c 2061 7379  rent: float, asy
-00002330: 6e63 683a 2062 6f6f 6c29 202d 3e20 4e6f  nch: bool) -> No
-00002340: 6e65 3a0a 2020 2020 2020 2020 7061 7373  ne:.        pass
-00002350: 0a20 2020 200a 2020 2020 4061 6273 7472  .    .    @abstr
-00002360: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
-00002370: 6620 7275 6e5f 6d69 6c6c 696e 675f 6472  f run_milling_dr
-00002380: 6966 745f 636f 7272 6563 7465 6428 7365  ift_corrected(se
-00002390: 6c66 2c20 6d69 6c6c 696e 675f 6375 7272  lf, milling_curr
-000023a0: 656e 743a 2066 6c6f 6174 2c20 200a 2020  ent: float,  .  
-000023b0: 2020 2020 2020 696d 6167 655f 7365 7474        image_sett
-000023c0: 696e 6773 3a20 496d 6167 6553 6574 7469  ings: ImageSetti
-000023d0: 6e67 732c 200a 2020 2020 2020 2020 7265  ngs, .        re
-000023e0: 665f 696d 6167 653a 2046 6962 7365 6d49  f_image: FibsemI
-000023f0: 6d61 6765 2c20 0a20 2020 2020 2020 2072  mage, .        r
-00002400: 6564 7563 6564 5f61 7265 613a 2046 6962  educed_area: Fib
-00002410: 7365 6d52 6563 7461 6e67 6c65 203d 204e  semRectangle = N
-00002420: 6f6e 652c 0a20 2020 2020 2020 2061 7379  one,.        asy
-00002430: 6e63 683a 2062 6f6f 6c20 3d20 4661 6c73  nch: bool = Fals
-00002440: 650a 2020 2020 2020 2020 293a 0a20 2020  e.        ):.   
-00002450: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
-00002460: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
-00002470: 2020 2064 6566 2066 696e 6973 685f 6d69     def finish_mi
-00002480: 6c6c 696e 6728 7365 6c66 2c20 696d 6167  lling(self, imag
-00002490: 696e 675f 6375 7272 656e 743a 2066 6c6f  ing_current: flo
-000024a0: 6174 2c20 696d 6167 696e 675f 766f 6c74  at, imaging_volt
-000024b0: 6167 653a 2066 6c6f 6174 2920 2d3e 204e  age: float) -> N
-000024c0: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
-000024d0: 730a 2020 2020 4061 6273 7472 6163 746d  s.    @abstractm
-000024e0: 6574 686f 640a 2020 2020 6465 6620 6573  ethod.    def es
-000024f0: 7469 6d61 7465 5f6d 696c 6c69 6e67 5f74  timate_milling_t
-00002500: 696d 6528 7365 6c66 2c70 6174 7465 726e  ime(self,pattern
-00002510: 7329 202d 3e20 666c 6f61 743a 0a20 2020  s) -> float:.   
-00002520: 2020 2020 2070 6173 730a 0a20 2020 2040       pass..    @
-00002530: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
-00002540: 2020 2064 6566 2064 7261 775f 7265 6374     def draw_rect
-00002550: 616e 676c 6528 7365 6c66 2c20 7061 7474  angle(self, patt
-00002560: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
-00002570: 6273 656d 5265 6374 616e 676c 6553 6574  bsemRectangleSet
-00002580: 7469 6e67 7329 3a0a 2020 2020 2020 2020  tings):.        
-00002590: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
-000025a0: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
-000025b0: 6620 6472 6177 5f6c 696e 6528 7365 6c66  f draw_line(self
-000025c0: 2c20 7061 7474 6572 6e5f 7365 7474 696e  , pattern_settin
-000025d0: 6773 3a20 4669 6273 656d 4c69 6e65 5365  gs: FibsemLineSe
-000025e0: 7474 696e 6773 293a 0a20 2020 2020 2020  ttings):.       
-000025f0: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
-00002600: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
-00002610: 6566 2064 7261 775f 6369 7263 6c65 2873  ef draw_circle(s
-00002620: 656c 662c 2070 6174 7465 726e 5f73 6574  elf, pattern_set
-00002630: 7469 6e67 733a 2046 6962 7365 6d43 6972  tings: FibsemCir
-00002640: 636c 6553 6574 7469 6e67 7329 3a0a 2020  cleSettings):.  
-00002650: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00002660: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
-00002670: 2020 2020 6465 6620 6472 6177 5f62 6974      def draw_bit
-00002680: 6d61 705f 7061 7474 6572 6e28 0a20 2020  map_pattern(.   
-00002690: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-000026a0: 2020 2070 6174 7465 726e 5f73 6574 7469     pattern_setti
-000026b0: 6e67 733a 2046 6962 7365 6d42 6974 6d61  ngs: FibsemBitma
-000026c0: 7053 6574 7469 6e67 732c 0a20 2020 2020  pSettings,.     
-000026d0: 2020 2070 6174 683a 2073 7472 2c0a 2020     path: str,.  
-000026e0: 2020 293a 0a20 2020 2020 2020 2070 6173    ):.        pas
-000026f0: 730a 0a0a 2020 2020 4061 6273 7472 6163  s...    @abstrac
-00002700: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
-00002710: 7365 7475 705f 7370 7574 7465 7228 7365  setup_sputter(se
-00002720: 6c66 2c20 2a61 7267 732c 202a 2a6b 7761  lf, *args, **kwa
-00002730: 7267 7329 3a0a 2020 2020 2020 2020 7061  rgs):.        pa
-00002740: 7373 0a0a 2020 2020 4061 6273 7472 6163  ss..    @abstrac
-00002750: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
-00002760: 6472 6177 5f73 7075 7474 6572 5f70 6174  draw_sputter_pat
-00002770: 7465 726e 2873 656c 662c 202a 6172 6773  tern(self, *args
-00002780: 2c20 2a2a 6b77 6172 6773 2920 2d3e 204e  , **kwargs) -> N
-00002790: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
-000027a0: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
-000027b0: 6d65 7468 6f64 0a20 2020 2064 6566 2072  method.    def r
-000027c0: 756e 5f73 7075 7474 6572 2873 656c 662c  un_sputter(self,
-000027d0: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+00000f20: 2020 2020 2020 2046 6962 7365 6d43 6972         FibsemCir
+00000f30: 636c 6553 6574 7469 6e67 732c 2046 6962  cleSettings, Fib
+00000f40: 7365 6d4c 696e 6553 6574 7469 6e67 732c  semLineSettings,
+00000f50: 2046 6962 7365 6d42 6974 6d61 7053 6574   FibsemBitmapSet
+00000f60: 7469 6e67 732c 200a 2020 2020 2020 2020  tings, .        
+00000f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000f80: 2020 2020 4372 6f73 7353 6563 7469 6f6e      CrossSection
+00000f90: 5061 7474 6572 6e2c 2046 6962 7365 6d47  Pattern, FibsemG
+00000fa0: 6173 496e 6a65 6374 696f 6e53 6574 7469  asInjectionSetti
+00000fb0: 6e67 7329 0a69 6d70 6f72 7420 7468 7265  ngs).import thre
+00000fc0: 6164 696e 670a 696d 706f 7274 2074 696d  ading.import tim
+00000fd0: 650a 6672 6f6d 2061 6263 2069 6d70 6f72  e.from abc impor
+00000fe0: 7420 4142 432c 2061 6273 7472 6163 746d  t ABC, abstractm
+00000ff0: 6574 686f 640a 6672 6f6d 2063 6f70 7920  ethod.from copy 
+00001000: 696d 706f 7274 2064 6565 7063 6f70 790a  import deepcopy.
+00001010: 6672 6f6d 2071 7565 7565 2069 6d70 6f72  from queue impor
+00001020: 7420 5175 6575 650a 6672 6f6d 2074 7970  t Queue.from typ
+00001030: 696e 6720 696d 706f 7274 2055 6e69 6f6e  ing import Union
+00001040: 0a69 6d70 6f72 7420 6e75 6d70 7920 6173  .import numpy as
+00001050: 206e 700a 2020 2020 0a0a 0a0a 636c 6173   np.    ....clas
+00001060: 7320 4669 6273 656d 4d69 6372 6f73 636f  s FibsemMicrosco
+00001070: 7065 2841 4243 293a 0a20 2020 2022 2222  pe(ABC):.    """
+00001080: 4162 7374 7261 6374 2063 6c61 7373 2063  Abstract class c
+00001090: 6f6e 7461 696e 696e 6720 616c 6c20 7468  ontaining all th
+000010a0: 6520 636f 7265 206d 6963 726f 7363 6f70  e core microscop
+000010b0: 6520 6675 6e63 7469 6f6e 616c 6974 6965  e functionalitie
+000010c0: 7322 2222 0a0a 2020 2020 4061 6273 7472  s"""..    @abstr
+000010d0: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
+000010e0: 6620 636f 6e6e 6563 745f 746f 5f6d 6963  f connect_to_mic
+000010f0: 726f 7363 6f70 6528 7365 6c66 2c20 6970  roscope(self, ip
+00001100: 5f61 6464 7265 7373 3a20 7374 722c 2070  _address: str, p
+00001110: 6f72 743a 2069 6e74 2920 2d3e 204e 6f6e  ort: int) -> Non
+00001120: 653a 0a20 2020 2020 2020 2070 6173 730a  e:.        pass.
+00001130: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
+00001140: 7468 6f64 0a20 2020 2064 6566 2064 6973  thod.    def dis
+00001150: 636f 6e6e 6563 7428 7365 6c66 293a 0a20  connect(self):. 
+00001160: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00001170: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+00001180: 0a20 2020 2064 6566 2061 6371 7569 7265  .    def acquire
+00001190: 5f69 6d61 6765 2873 656c 662c 2069 6d61  _image(self, ima
+000011a0: 6765 5f73 6574 7469 6e67 733a 496d 6167  ge_settings:Imag
+000011b0: 6553 6574 7469 6e67 7329 202d 3e20 4669  eSettings) -> Fi
+000011c0: 6273 656d 496d 6167 653a 0a20 2020 2020  bsemImage:.     
+000011d0: 2020 2070 6173 730a 0a20 2020 2040 6162     pass..    @ab
+000011e0: 7374 7261 6374 6d65 7468 6f64 0a20 2020  stractmethod.   
+000011f0: 2064 6566 206c 6173 745f 696d 6167 6528   def last_image(
+00001200: 7365 6c66 2c20 6265 616d 5f74 7970 653a  self, beam_type:
+00001210: 2042 6561 6d54 7970 6529 202d 3e20 4669   BeamType) -> Fi
+00001220: 6273 656d 496d 6167 653a 0a20 2020 2020  bsemImage:.     
+00001230: 2020 2070 6173 730a 2020 2020 0a20 2020     pass.    .   
+00001240: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+00001250: 0a20 2020 2064 6566 206c 6976 655f 696d  .    def live_im
+00001260: 6167 696e 6728 7365 6c66 2c20 696d 6167  aging(self, imag
+00001270: 655f 7365 7474 696e 6773 3a20 496d 6167  e_settings: Imag
+00001280: 6553 6574 7469 6e67 732c 2069 6d61 6765  eSettings, image
+00001290: 5f71 7565 7565 3a20 5175 6575 652c 2073  _queue: Queue, s
+000012a0: 746f 705f 6576 656e 743a 2074 6872 6561  top_event: threa
+000012b0: 6469 6e67 2e45 7665 6e74 293a 0a20 2020  ding.Event):.   
+000012c0: 2020 2020 2070 6173 730a 2020 2020 0a20       pass.    . 
+000012d0: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
+000012e0: 6f64 0a20 2020 2064 6566 2061 6371 7569  od.    def acqui
+000012f0: 7265 5f63 6861 6d62 6572 5f69 6d61 6765  re_chamber_image
+00001300: 2873 656c 6629 202d 3e20 4669 6273 656d  (self) -> Fibsem
+00001310: 496d 6167 653a 0a20 2020 2020 2020 2070  Image:.        p
+00001320: 6173 730a 0a20 2020 2040 6162 7374 7261  ass..    @abstra
+00001330: 6374 6d65 7468 6f64 0a20 2020 2040 7468  ctmethod.    @th
+00001340: 7265 6164 5f77 6f72 6b65 720a 2020 2020  read_worker.    
+00001350: 6465 6620 636f 6e73 756d 655f 696d 6167  def consume_imag
+00001360: 655f 7175 6575 6528 7365 6c66 2c20 7061  e_queue(self, pa
+00001370: 7265 6e74 5f75 6920 3d20 4e6f 6e65 2c20  rent_ui = None, 
+00001380: 736c 6565 703a 2066 6c6f 6174 203d 2030  sleep: float = 0
+00001390: 2e31 293a 0a20 2020 2020 2020 2070 6173  .1):.        pas
+000013a0: 730a 2020 2020 0a20 2020 2040 6162 7374  s.    .    @abst
+000013b0: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
+000013c0: 6566 2061 7574 6f63 6f6e 7472 6173 7428  ef autocontrast(
+000013d0: 7365 6c66 2c20 6265 616d 5f74 7970 653a  self, beam_type:
+000013e0: 2042 6561 6d54 7970 6529 202d 3e20 4e6f   BeamType) -> No
+000013f0: 6e65 3a0a 2020 2020 2020 2020 7061 7373  ne:.        pass
+00001400: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+00001410: 6574 686f 640a 2020 2020 6465 6620 6175  ethod.    def au
+00001420: 746f 5f66 6f63 7573 2873 656c 662c 2062  to_focus(self, b
+00001430: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
+00001440: 7065 2920 2d3e 204e 6f6e 653a 0a20 2020  pe) -> None:.   
+00001450: 2020 2020 2070 6173 730a 0a20 2020 2064       pass..    d
+00001460: 6566 2072 6573 6574 5f62 6561 6d5f 7368  ef reset_beam_sh
+00001470: 6966 7473 2873 656c 6629 202d 3e20 4e6f  ifts(self) -> No
+00001480: 6e65 3a0a 2020 2020 2020 2020 2222 2253  ne:.        """S
+00001490: 6574 2074 6865 2062 6561 6d20 7368 6966  et the beam shif
+000014a0: 7420 746f 207a 6572 6f20 666f 7220 7468  t to zero for th
+000014b0: 6520 656c 6563 7472 6f6e 2061 6e64 2069  e electron and i
+000014c0: 6f6e 2062 6561 6d73 2e22 2222 0a20 2020  on beams.""".   
+000014d0: 2020 2020 2073 656c 662e 7365 7428 2273       self.set("s
+000014e0: 6869 6674 222c 2050 6f69 6e74 2830 2c20  hift", Point(0, 
+000014f0: 3029 2c20 4265 616d 5479 7065 2e45 4c45  0), BeamType.ELE
+00001500: 4354 524f 4e29 0a20 2020 2020 2020 2073  CTRON).        s
+00001510: 656c 662e 7365 7428 2273 6869 6674 222c  elf.set("shift",
+00001520: 2050 6f69 6e74 2830 2c20 3029 2c20 4265   Point(0, 0), Be
+00001530: 616d 5479 7065 2e49 4f4e 290a 0a20 2020  amType.ION)..   
+00001540: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+00001550: 0a20 2020 2064 6566 2062 6561 6d5f 7368  .    def beam_sh
+00001560: 6966 7428 7365 6c66 2c20 6478 3a20 666c  ift(self, dx: fl
+00001570: 6f61 742c 2064 793a 2066 6c6f 6174 2c20  oat, dy: float, 
+00001580: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
+00001590: 7970 6529 202d 3e20 4e6f 6e65 3a0a 2020  ype) -> None:.  
+000015a0: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+000015b0: 6465 6620 6765 745f 7374 6167 655f 706f  def get_stage_po
+000015c0: 7369 7469 6f6e 2873 656c 6629 202d 3e20  sition(self) -> 
+000015d0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+000015e0: 696f 6e3a 0a20 2020 2020 2020 2022 2222  ion:.        """
+000015f0: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
+00001600: 2063 7572 7265 6e74 2073 7461 6765 2070   current stage p
+00001610: 6f73 6974 696f 6e2e 0a0a 2020 2020 2020  osition...      
+00001620: 2020 5468 6973 206d 6574 686f 6420 7265    This method re
+00001630: 7472 6965 7665 7320 7468 6520 6375 7272  trieves the curr
+00001640: 656e 7420 7374 6167 6520 706f 7369 7469  ent stage positi
+00001650: 6f6e 2066 726f 6d20 7468 6520 6d69 6372  on from the micr
+00001660: 6f73 636f 7065 2061 6e64 2072 6574 7572  oscope and retur
+00001670: 6e73 2069 7420 6173 0a20 2020 2020 2020  ns it as.       
+00001680: 2061 2046 6962 7365 6d53 7461 6765 506f   a FibsemStagePo
+00001690: 7369 7469 6f6e 206f 626a 6563 742e 2046  sition object. F
+000016a0: 6962 7365 6d53 7461 6765 2050 6f73 6974  ibsemStage Posit
+000016b0: 696f 6e20 6973 2069 6e20 7468 6520 5241  ion is in the RA
+000016c0: 5720 636f 6f72 6469 6e61 7465 2066 7261  W coordinate fra
+000016d0: 6d65 0a0a 2020 2020 2020 2020 5265 7475  me..        Retu
+000016e0: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+000016f0: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
+00001700: 7469 6f6e 3a20 5468 6520 6375 7272 656e  tion: The curren
+00001710: 7420 7374 6167 6520 706f 7369 7469 6f6e  t stage position
+00001720: 2e0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
+00001730: 2020 2020 2020 2073 7461 6765 5f70 6f73         stage_pos
+00001740: 6974 696f 6e20 3d20 7365 6c66 2e67 6574  ition = self.get
+00001750: 2822 7374 6167 655f 706f 7369 7469 6f6e  ("stage_position
+00001760: 2229 0a20 2020 2020 2020 206c 6f67 6769  ").        loggi
+00001770: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
+00001780: 2022 6765 745f 7374 6167 655f 706f 7369   "get_stage_posi
+00001790: 7469 6f6e 222c 2022 706f 7322 3a20 7374  tion", "pos": st
+000017a0: 6167 655f 706f 7369 7469 6f6e 2e74 6f5f  age_position.to_
+000017b0: 6469 6374 2829 7d29 0a20 2020 2020 2020  dict()}).       
+000017c0: 2072 6574 7572 6e20 7374 6167 655f 706f   return stage_po
+000017d0: 7369 7469 6f6e 0a20 2020 200a 2020 2020  sition.    .    
+000017e0: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
+000017f0: 2020 2020 6465 6620 6d6f 7665 5f73 7461      def move_sta
+00001800: 6765 5f61 6273 6f6c 7574 6528 7365 6c66  ge_absolute(self
+00001810: 2c20 706f 7369 7469 6f6e 3a20 4669 6273  , position: Fibs
+00001820: 656d 5374 6167 6550 6f73 6974 696f 6e29  emStagePosition)
+00001830: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00001840: 2020 7061 7373 0a0a 2020 2020 4061 6273    pass..    @abs
+00001850: 7472 6163 746d 6574 686f 640a 2020 2020  tractmethod.    
+00001860: 6465 6620 6d6f 7665 5f73 7461 6765 5f72  def move_stage_r
+00001870: 656c 6174 6976 6528 7365 6c66 2c20 706f  elative(self, po
+00001880: 7369 7469 6f6e 3a20 4669 6273 656d 5374  sition: FibsemSt
+00001890: 6167 6550 6f73 6974 696f 6e29 202d 3e20  agePosition) -> 
+000018a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7061  None:.        pa
+000018b0: 7373 0a0a 2020 2020 4061 6273 7472 6163  ss..    @abstrac
+000018c0: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
+000018d0: 7374 6162 6c65 5f6d 6f76 6528 7365 6c66  stable_move(self
+000018e0: 2c64 783a 2066 6c6f 6174 2c20 6479 3a20  ,dx: float, dy: 
+000018f0: 666c 6f61 742c 2062 6561 6d5f 7479 7065  float, beam_type
+00001900: 3a20 4265 616d 5479 7065 2920 2d3e 2046  : BeamType) -> F
+00001910: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
+00001920: 6f6e 3a0a 2020 2020 2020 2020 7061 7373  on:.        pass
+00001930: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+00001940: 6574 686f 640a 2020 2020 6465 6620 7665  ethod.    def ve
+00001950: 7274 6963 616c 5f6d 6f76 6528 7365 6c66  rtical_move(self
+00001960: 2c20 6479 3a20 666c 6f61 742c 2064 783a  , dy: float, dx:
+00001970: 2066 6c6f 6174 203d 2030 2c20 7374 6174   float = 0, stat
+00001980: 6963 5f77 643a 2062 6f6f 6c20 3d20 5472  ic_wd: bool = Tr
+00001990: 7565 2920 2d3e 204e 6f6e 653a 0a20 2020  ue) -> None:.   
+000019a0: 2020 2020 2070 6173 730a 0a20 2020 2064       pass..    d
+000019b0: 6566 206d 6f76 655f 666c 6174 5f74 6f5f  ef move_flat_to_
+000019c0: 6265 616d 2873 656c 662c 2062 6561 6d5f  beam(self, beam_
+000019d0: 7479 7065 3a20 4265 616d 5479 7065 2c20  type: BeamType, 
+000019e0: 5f73 6166 653a 626f 6f6c 203d 2054 7275  _safe:bool = Tru
+000019f0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+00001a00: 2020 2020 2222 224d 6f76 6520 7468 6520      """Move the 
+00001a10: 7361 6d70 6c65 2073 7572 6661 6365 2066  sample surface f
+00001a20: 6c61 7420 746f 2074 6865 2065 6c65 6374  lat to the elect
+00001a30: 726f 6e20 6f72 2069 6f6e 2062 6561 6d2e  ron or ion beam.
+00001a40: 2222 220a 0a20 2020 2020 2020 205f 6368  """..        _ch
+00001a50: 6563 6b5f 7374 6167 6528 7365 6c66 2e73  eck_stage(self.s
+00001a60: 7973 7465 6d2c 2072 6f74 6174 696f 6e3d  ystem, rotation=
+00001a70: 2054 7275 652c 2074 696c 743d 5472 7565   True, tilt=True
+00001a80: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
+00001a90: 7365 7474 696e 6773 203d 2073 656c 662e  settings = self.
+00001aa0: 7379 7374 656d 2e73 7461 6765 0a20 2020  system.stage.   
+00001ab0: 2020 2020 2073 6875 7474 6c65 5f70 7265       shuttle_pre
+00001ac0: 5f74 696c 7420 3d20 7374 6167 655f 7365  _tilt = stage_se
+00001ad0: 7474 696e 6773 2e73 6875 7474 6c65 5f70  ttings.shuttle_p
+00001ae0: 7265 5f74 696c 740a 0a20 2020 2020 2020  re_tilt..       
+00001af0: 2069 6620 6265 616d 5f74 7970 6520 6973   if beam_type is
+00001b00: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+00001b10: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+00001b20: 726f 7461 7469 6f6e 203d 206e 702e 6465  rotation = np.de
+00001b30: 6732 7261 6428 7374 6167 655f 7365 7474  g2rad(stage_sett
+00001b40: 696e 6773 2e72 6f74 6174 696f 6e5f 7265  ings.rotation_re
+00001b50: 6665 7265 6e63 6529 0a20 2020 2020 2020  ference).       
+00001b60: 2020 2020 2074 696c 7420 3d20 6e70 2e64       tilt = np.d
+00001b70: 6567 3272 6164 2873 6875 7474 6c65 5f70  eg2rad(shuttle_p
+00001b80: 7265 5f74 696c 7429 0a0a 2020 2020 2020  re_tilt)..      
+00001b90: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
+00001ba0: 7320 4265 616d 5479 7065 2e49 4f4e 3a0a  s BeamType.ION:.
+00001bb0: 2020 2020 2020 2020 2020 2020 726f 7461              rota
+00001bc0: 7469 6f6e 203d 206e 702e 6465 6732 7261  tion = np.deg2ra
+00001bd0: 6428 7374 6167 655f 7365 7474 696e 6773  d(stage_settings
+00001be0: 2e72 6f74 6174 696f 6e5f 3138 3029 0a20  .rotation_180). 
+00001bf0: 2020 2020 2020 2020 2020 2074 696c 7420             tilt 
+00001c00: 3d20 6e70 2e64 6567 3272 6164 2873 656c  = np.deg2rad(sel
+00001c10: 662e 7379 7374 656d 2e69 6f6e 2e63 6f6c  f.system.ion.col
+00001c20: 756d 6e5f 7469 6c74 202d 2073 6875 7474  umn_tilt - shutt
+00001c30: 6c65 5f70 7265 5f74 696c 7429 0a0a 2020  le_pre_tilt)..  
+00001c40: 2020 2020 2020 2320 636f 6d70 7573 7461        # compusta
+00001c50: 6765 2069 7320 7469 6c74 6564 2062 7920  ge is tilted by 
+00001c60: 3138 3020 6465 6772 6565 7320 666f 7220  180 degrees for 
+00001c70: 666c 6174 2074 6f20 6265 616d 2c20 6265  flat to beam, be
+00001c80: 6361 7573 6520 7765 2069 6d61 6765 2074  cause we image t
+00001c90: 6865 2062 6163 6b73 6964 6520 666f 2074  he backside fo t
+00001ca0: 6865 2067 7269 642c 0a20 2020 2020 2020  he grid,.       
+00001cb0: 2023 2074 6865 7265 666f 7265 2c20 7765   # therefore, we
+00001cc0: 206e 6565 6420 746f 206f 6666 7365 7420   need to offset 
+00001cd0: 7468 6520 7469 6c74 2062 7920 3138 3020  the tilt by 180 
+00001ce0: 6465 6772 6565 730a 2020 2020 2020 2020  degrees.        
+00001cf0: 6966 2073 656c 662e 7374 6167 655f 6973  if self.stage_is
+00001d00: 5f63 6f6d 7075 7374 6167 6520 616e 6420  _compustage and 
+00001d10: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
+00001d20: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
+00001d30: 2020 2020 2020 2074 696c 7420 3d20 2d6e         tilt = -n
+00001d40: 702e 7069 202b 2074 696c 740a 2020 2020  p.pi + tilt.    
+00001d50: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00001d60: 2023 2075 7064 6174 6564 2073 6166 6520   # updated safe 
+00001d70: 726f 7461 7469 6f6e 206d 6f76 650a 2020  rotation move.  
+00001d80: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00001d90: 666f 2866 226d 6f76 696e 6720 666c 6174  fo(f"moving flat
+00001da0: 2074 6f20 7b62 6561 6d5f 7479 7065 2e6e   to {beam_type.n
+00001db0: 616d 657d 2229 0a20 2020 2020 2020 2073  ame}").        s
+00001dc0: 7461 6765 5f70 6f73 6974 696f 6e20 3d20  tage_position = 
+00001dd0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+00001de0: 696f 6e28 723d 726f 7461 7469 6f6e 2c20  ion(r=rotation, 
+00001df0: 743d 7469 6c74 2c20 636f 6f72 6469 6e61  t=tilt, coordina
+00001e00: 7465 5f73 7973 7465 6d3d 2252 6177 2229  te_system="Raw")
+00001e10: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
+00001e20: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
+00001e30: 226d 6f76 655f 666c 6174 5f74 6f5f 6265  "move_flat_to_be
+00001e40: 616d 222c 2022 7374 6167 655f 706f 7369  am", "stage_posi
+00001e50: 7469 6f6e 223a 2073 7461 6765 5f70 6f73  tion": stage_pos
+00001e60: 6974 696f 6e2e 746f 5f64 6963 7428 292c  ition.to_dict(),
+00001e70: 2022 6265 616d 5f74 7970 6522 3a20 6265   "beam_type": be
+00001e80: 616d 5f74 7970 652e 6e61 6d65 7d29 0a20  am_type.name}). 
+00001e90: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00001ea0: 2020 2020 6966 205f 7361 6665 3a0a 2020      if _safe:.  
+00001eb0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00001ec0: 6166 655f 6162 736f 6c75 7465 5f73 7461  afe_absolute_sta
+00001ed0: 6765 5f6d 6f76 656d 656e 7428 7374 6167  ge_movement(stag
+00001ee0: 655f 706f 7369 7469 6f6e 290a 2020 2020  e_position).    
+00001ef0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00001f00: 2020 2020 2020 7365 6c66 2e6d 6f76 655f        self.move_
+00001f10: 7374 6167 655f 6162 736f 6c75 7465 2873  stage_absolute(s
+00001f20: 7461 6765 5f70 6f73 6974 696f 6e29 0a0a  tage_position)..
+00001f30: 2020 2020 4061 6273 7472 6163 746d 6574      @abstractmet
+00001f40: 686f 640a 2020 2020 6465 6620 7361 6665  hod.    def safe
+00001f50: 5f61 6273 6f6c 7574 655f 7374 6167 655f  _absolute_stage_
+00001f60: 6d6f 7665 6d65 6e74 2873 656c 662c 2070  movement(self, p
+00001f70: 6f73 6974 696f 6e3a 2046 6962 7365 6d53  osition: FibsemS
+00001f80: 7461 6765 506f 7369 7469 6f6e 2920 2d3e  tagePosition) ->
+00001f90: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+00001fa0: 6173 730a 0a20 2020 2064 6566 2067 6574  ass..    def get
+00001fb0: 5f6d 616e 6970 756c 6174 6f72 5f73 7461  _manipulator_sta
+00001fc0: 7465 2873 656c 6629 202d 3e20 626f 6f6c  te(self) -> bool
+00001fd0: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
+00001fe0: 2074 6865 206d 616e 6970 756c 6174 6f72   the manipulator
+00001ff0: 2073 7461 7465 2028 496e 7365 7274 6564   state (Inserted
+00002000: 203d 2054 7275 652c 2052 6574 7261 6374   = True, Retract
+00002010: 6564 203d 2046 616c 7365 2922 2222 0a20  ed = False)""". 
+00002020: 2020 2020 2020 2023 2054 4f44 4f3a 2063         # TODO: c
+00002030: 6f6e 7665 7274 2074 6f20 656e 756d 0a20  onvert to enum. 
+00002040: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00002050: 6c66 2e67 6574 2822 6d61 6e69 7075 6c61  lf.get("manipula
+00002060: 746f 725f 7374 6174 6522 290a 2020 2020  tor_state").    
+00002070: 0a20 2020 2064 6566 2067 6574 5f6d 616e  .    def get_man
+00002080: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+00002090: 6e28 7365 6c66 2920 2d3e 2046 6962 7365  n(self) -> Fibse
+000020a0: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+000020b0: 7469 6f6e 3a0a 2020 2020 2020 2020 2222  tion:.        ""
+000020c0: 2247 6574 2074 6865 206d 616e 6970 756c  "Get the manipul
+000020d0: 6174 6f72 2070 6f73 6974 696f 6e2e 2222  ator position.""
+000020e0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+000020f0: 2073 656c 662e 6765 7428 226d 616e 6970   self.get("manip
+00002100: 756c 6174 6f72 5f70 6f73 6974 696f 6e22  ulator_position"
+00002110: 290a 0a20 2020 2040 6162 7374 7261 6374  )..    @abstract
+00002120: 6d65 7468 6f64 0a20 2020 2064 6566 2069  method.    def i
+00002130: 6e73 6572 745f 6d61 6e69 7075 6c61 746f  nsert_manipulato
+00002140: 7228 7365 6c66 2c20 6e61 6d65 3a20 7374  r(self, name: st
+00002150: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+00002160: 2020 2020 7061 7373 0a0a 2020 2020 4061      pass..    @a
+00002170: 6273 7472 6163 746d 6574 686f 640a 2020  bstractmethod.  
+00002180: 2020 6465 6620 7265 7472 6163 745f 6d61    def retract_ma
+00002190: 6e69 7075 6c61 746f 7228 7365 6c66 293a  nipulator(self):
+000021a0: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
+000021b0: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
+000021c0: 6f64 0a20 2020 2064 6566 206d 6f76 655f  od.    def move_
+000021d0: 6d61 6e69 7075 6c61 746f 725f 7265 6c61  manipulator_rela
+000021e0: 7469 7665 2873 656c 662c 2070 6f73 6974  tive(self, posit
+000021f0: 696f 6e3a 2046 6962 7365 6d4d 616e 6970  ion: FibsemManip
+00002200: 756c 6174 6f72 506f 7369 7469 6f6e 2920  ulatorPosition) 
+00002210: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00002220: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
+00002230: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
+00002240: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
+00002250: 746f 725f 6162 736f 6c75 7465 2873 656c  tor_absolute(sel
+00002260: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
+00002270: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+00002280: 7369 7469 6f6e 2920 2d3e 204e 6f6e 653a  sition) -> None:
+00002290: 0a20 2020 2020 2020 2070 6173 730a 2020  .        pass.  
+000022a0: 2020 0a20 2020 2040 6162 7374 7261 6374    .    @abstract
+000022b0: 6d65 7468 6f64 0a20 2020 2064 6566 206d  method.    def m
+000022c0: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
+000022d0: 636f 7272 6563 7465 6428 7365 6c66 2c20  corrected(self, 
+000022e0: 6478 3a20 666c 6f61 742c 2064 793a 2066  dx: float, dy: f
+000022f0: 6c6f 6174 2c20 6265 616d 5f74 7970 653a  loat, beam_type:
+00002300: 2042 6561 6d54 7970 6529 202d 3e20 4e6f   BeamType) -> No
+00002310: 6e65 3a0a 2020 2020 2020 2020 7061 7373  ne:.        pass
+00002320: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+00002330: 6574 686f 640a 2020 2020 6465 6620 6d6f  ethod.    def mo
+00002340: 7665 5f6d 616e 6970 756c 6174 6f72 5f74  ve_manipulator_t
+00002350: 6f5f 706f 7369 7469 6f6e 5f6f 6666 7365  o_position_offse
+00002360: 7428 7365 6c66 2c20 6f66 6673 6574 3a20  t(self, offset: 
+00002370: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
+00002380: 7250 6f73 6974 696f 6e2c 206e 616d 653a  rPosition, name:
+00002390: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+000023a0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+000023b0: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+000023c0: 0a20 2020 2064 6566 205f 6765 745f 7361  .    def _get_sa
+000023d0: 7665 645f 6d61 6e69 7075 6c61 746f 725f  ved_manipulator_
+000023e0: 706f 7369 7469 6f6e 2873 656c 662c 206e  position(self, n
+000023f0: 616d 653a 2073 7472 2920 2d3e 2046 6962  ame: str) -> Fib
+00002400: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+00002410: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
+00002420: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
+00002430: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
+00002440: 6620 7365 7475 705f 6d69 6c6c 696e 6728  f setup_milling(
+00002450: 7365 6c66 2c20 6d69 6c6c 5f73 6574 7469  self, mill_setti
+00002460: 6e67 733a 2046 6962 7365 6d4d 696c 6c69  ngs: FibsemMilli
+00002470: 6e67 5365 7474 696e 6773 2920 2d3e 204e  ngSettings) -> N
+00002480: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
+00002490: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
+000024a0: 6d65 7468 6f64 0a20 2020 2064 6566 2072  method.    def r
+000024b0: 756e 5f6d 696c 6c69 6e67 2873 656c 662c  un_milling(self,
+000024c0: 206d 696c 6c69 6e67 5f63 7572 7265 6e74   milling_current
+000024d0: 3a20 666c 6f61 742c 2061 7379 6e63 683a  : float, asynch:
+000024e0: 2062 6f6f 6c29 202d 3e20 4e6f 6e65 3a0a   bool) -> None:.
+000024f0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+00002500: 200a 2020 2020 4061 6273 7472 6163 746d   .    @abstractm
+00002510: 6574 686f 640a 2020 2020 6465 6620 7275  ethod.    def ru
+00002520: 6e5f 6d69 6c6c 696e 675f 6472 6966 745f  n_milling_drift_
+00002530: 636f 7272 6563 7465 6428 7365 6c66 2c20  corrected(self, 
+00002540: 6d69 6c6c 696e 675f 6375 7272 656e 743a  milling_current:
+00002550: 2066 6c6f 6174 2c20 200a 2020 2020 2020   float,  .      
+00002560: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
+00002570: 3a20 496d 6167 6553 6574 7469 6e67 732c  : ImageSettings,
+00002580: 200a 2020 2020 2020 2020 7265 665f 696d   .        ref_im
+00002590: 6167 653a 2046 6962 7365 6d49 6d61 6765  age: FibsemImage
+000025a0: 2c20 0a20 2020 2020 2020 2072 6564 7563  , .        reduc
+000025b0: 6564 5f61 7265 613a 2046 6962 7365 6d52  ed_area: FibsemR
+000025c0: 6563 7461 6e67 6c65 203d 204e 6f6e 652c  ectangle = None,
+000025d0: 0a20 2020 2020 2020 2061 7379 6e63 683a  .        asynch:
+000025e0: 2062 6f6f 6c20 3d20 4661 6c73 650a 2020   bool = False.  
+000025f0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+00002600: 2070 6173 730a 0a20 2020 2040 6162 7374   pass..    @abst
+00002610: 7261 6374 6d65 7468 6f64 0a20 2020 2064  ractmethod.    d
+00002620: 6566 2066 696e 6973 685f 6d69 6c6c 696e  ef finish_millin
+00002630: 6728 7365 6c66 2c20 696d 6167 696e 675f  g(self, imaging_
+00002640: 6375 7272 656e 743a 2066 6c6f 6174 2c20  current: float, 
+00002650: 696d 6167 696e 675f 766f 6c74 6167 653a  imaging_voltage:
+00002660: 2066 6c6f 6174 2920 2d3e 204e 6f6e 653a   float) -> None:
+00002670: 0a20 2020 2020 2020 2070 6173 730a 0a20  .        pass.. 
+00002680: 2020 2040 6162 7374 7261 6374 6d65 7468     @abstractmeth
+00002690: 6f64 0a20 2020 2064 6566 2073 746f 705f  od.    def stop_
+000026a0: 6d69 6c6c 696e 6728 7365 6c66 2920 2d3e  milling(self) ->
+000026b0: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
+000026c0: 6574 7572 6e20 0a20 2020 200a 2020 2020  eturn .    .    
+000026d0: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
+000026e0: 2020 2020 6465 6620 6573 7469 6d61 7465      def estimate
+000026f0: 5f6d 696c 6c69 6e67 5f74 696d 6528 7365  _milling_time(se
+00002700: 6c66 2c70 6174 7465 726e 7329 202d 3e20  lf,patterns) -> 
+00002710: 666c 6f61 743a 0a20 2020 2020 2020 2070  float:.        p
+00002720: 6173 730a 0a20 2020 2040 6162 7374 7261  ass..    @abstra
+00002730: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
+00002740: 2064 7261 775f 7265 6374 616e 676c 6528   draw_rectangle(
+00002750: 7365 6c66 2c20 7061 7474 6572 6e5f 7365  self, pattern_se
+00002760: 7474 696e 6773 3a20 4669 6273 656d 5265  ttings: FibsemRe
+00002770: 6374 616e 676c 6553 6574 7469 6e67 7329  ctangleSettings)
+00002780: 3a0a 2020 2020 2020 2020 7061 7373 0a0a  :.        pass..
+00002790: 2020 2020 4061 6273 7472 6163 746d 6574      @abstractmet
+000027a0: 686f 640a 2020 2020 6465 6620 6472 6177  hod.    def draw
+000027b0: 5f6c 696e 6528 7365 6c66 2c20 7061 7474  _line(self, patt
+000027c0: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
+000027d0: 6273 656d 4c69 6e65 5365 7474 696e 6773  bsemLineSettings
 000027e0: 293a 0a20 2020 2020 2020 2070 6173 730a  ):.        pass.
 000027f0: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
-00002800: 7468 6f64 0a20 2020 2064 6566 2066 696e  thod.    def fin
-00002810: 6973 685f 7370 7574 7465 7228 7365 6c66  ish_sputter(self
-00002820: 293a 0a20 2020 2020 2020 2070 6173 730a  ):.        pass.
-00002830: 2020 2020 0a20 2020 2040 6162 7374 7261      .    @abstra
-00002840: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
-00002850: 2067 6574 5f61 7661 696c 6162 6c65 5f76   get_available_v
-00002860: 616c 7565 7328 7365 6c66 2c20 6b65 793a  alues(self, key:
-00002870: 7374 722c 2062 6561 6d5f 7479 7065 3a20  str, beam_type: 
-00002880: 4265 616d 5479 7065 203d 204e 6f6e 6529  BeamType = None)
-00002890: 202d 3e20 6c69 7374 3a0a 2020 2020 2020   -> list:.      
-000028a0: 2020 7061 7373 0a0a 2020 2020 2320 544f    pass..    # TO
-000028b0: 444f 3a20 7573 6520 6120 6465 636f 7261  DO: use a decora
-000028c0: 746f 7220 696e 7374 6561 643f 0a20 2020  tor instead?.   
-000028d0: 2064 6566 2067 6574 2873 656c 662c 206b   def get(self, k
-000028e0: 6579 3a20 7374 722c 2062 6561 6d5f 7479  ey: str, beam_ty
-000028f0: 7065 3a20 4265 616d 5479 7065 203d 204e  pe: BeamType = N
-00002900: 6f6e 6529 202d 3e20 556e 696f 6e5b 666c  one) -> Union[fl
-00002910: 6f61 742c 2069 6e74 2c20 626f 6f6c 2c20  oat, int, bool, 
-00002920: 7374 722c 206c 6973 745d 3a0a 2020 2020  str, list]:.    
-00002930: 2020 2020 2222 2247 6574 2077 7261 7070      """Get wrapp
-00002940: 6572 2066 6f72 206c 6f67 6769 6e67 2e22  er for logging."
-00002950: 2222 0a20 2020 2020 2020 206c 6f67 6769  "".        loggi
-00002960: 6e67 2e64 6562 7567 2866 2247 6574 7469  ng.debug(f"Getti
-00002970: 6e67 207b 6b65 797d 2028 7b62 6561 6d5f  ng {key} ({beam_
-00002980: 7479 7065 7d29 2229 0a20 2020 2020 2020  type})").       
-00002990: 2076 616c 7565 203d 2073 656c 662e 5f67   value = self._g
-000029a0: 6574 286b 6579 2c20 6265 616d 5f74 7970  et(key, beam_typ
-000029b0: 6529 0a20 2020 2020 2020 2062 6561 6d5f  e).        beam_
-000029c0: 6e61 6d65 203d 2022 4e6f 6e65 2220 6966  name = "None" if
-000029d0: 2062 6561 6d5f 7479 7065 2069 7320 4e6f   beam_type is No
-000029e0: 6e65 2065 6c73 6520 6265 616d 5f74 7970  ne else beam_typ
-000029f0: 652e 6e61 6d65 0a20 2020 2020 2020 206c  e.name.        l
-00002a00: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
-00002a10: 7367 223a 2022 6765 7422 2c20 226b 6579  sg": "get", "key
-00002a20: 223a 206b 6579 2c20 2262 6561 6d5f 7479  ": key, "beam_ty
-00002a30: 7065 223a 2062 6561 6d5f 6e61 6d65 2c20  pe": beam_name, 
-00002a40: 2276 616c 7565 223a 2076 616c 7565 7d29  "value": value})
-00002a50: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00002a60: 7661 6c75 650a 0a20 2020 2064 6566 2073  value..    def s
-00002a70: 6574 2873 656c 662c 206b 6579 3a20 7374  et(self, key: st
-00002a80: 722c 2076 616c 7565 2c20 6265 616d 5f74  r, value, beam_t
-00002a90: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
-00002aa0: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
-00002ab0: 2020 2020 2020 2022 2222 5365 7420 7772         """Set wr
-00002ac0: 6170 7065 7220 666f 7220 6c6f 6767 696e  apper for loggin
-00002ad0: 6722 2222 0a20 2020 2020 2020 206c 6f67  g""".        log
-00002ae0: 6769 6e67 2e64 6562 7567 2866 2253 6574  ging.debug(f"Set
-00002af0: 7469 6e67 207b 6b65 797d 2074 6f20 7b76  ting {key} to {v
-00002b00: 616c 7565 7d20 287b 6265 616d 5f74 7970  alue} ({beam_typ
-00002b10: 657d 2922 290a 2020 2020 2020 2020 7365  e})").        se
-00002b20: 6c66 2e5f 7365 7428 6b65 792c 2076 616c  lf._set(key, val
-00002b30: 7565 2c20 6265 616d 5f74 7970 6529 0a20  ue, beam_type). 
-00002b40: 2020 2020 2020 2062 6561 6d5f 6e61 6d65         beam_name
-00002b50: 203d 2022 4e6f 6e65 2220 6966 2062 6561   = "None" if bea
-00002b60: 6d5f 7479 7065 2069 7320 4e6f 6e65 2065  m_type is None e
-00002b70: 6c73 6520 6265 616d 5f74 7970 652e 6e61  lse beam_type.na
-00002b80: 6d65 0a20 2020 2020 2020 206c 6f67 6769  me.        loggi
-00002b90: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
-00002ba0: 2022 7365 7422 2c20 226b 6579 223a 206b   "set", "key": k
-00002bb0: 6579 2c20 2262 6561 6d5f 7479 7065 223a  ey, "beam_type":
-00002bc0: 2062 6561 6d5f 6e61 6d65 2c20 2276 616c   beam_name, "val
-00002bd0: 7565 223a 2076 616c 7565 7d29 0a20 2020  ue": value}).   
-00002be0: 200a 2020 2020 4061 6273 7472 6163 746d   .    @abstractm
-00002bf0: 6574 686f 640a 2020 2020 6465 6620 5f67  ethod.    def _g
-00002c00: 6574 2873 656c 662c 206b 6579 3a20 7374  et(self, key: st
-00002c10: 722c 2062 6561 6d5f 7479 7065 3a20 4265  r, beam_type: Be
-00002c20: 616d 5479 7065 203d 204e 6f6e 6529 202d  amType = None) -
-00002c30: 3e20 556e 696f 6e5b 666c 6f61 742c 2069  > Union[float, i
-00002c40: 6e74 2c20 626f 6f6c 2c20 7374 722c 206c  nt, bool, str, l
-00002c50: 6973 745d 3a0a 2020 2020 2020 2020 7061  ist]:.        pa
-00002c60: 7373 0a20 2020 2020 2020 200a 2020 2020  ss.        .    
-00002c70: 4061 6273 7472 6163 746d 6574 686f 640a  @abstractmethod.
-00002c80: 2020 2020 6465 6620 5f73 6574 2873 656c      def _set(sel
-00002c90: 662c 206b 6579 3a20 7374 722c 2076 616c  f, key: str, val
-00002ca0: 7565 2c20 6265 616d 5f74 7970 653a 2042  ue, beam_type: B
-00002cb0: 6561 6d54 7970 6520 3d20 4e6f 6e65 2920  eamType = None) 
-00002cc0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00002cd0: 2070 6173 730a 2020 2020 2020 2020 0a20   pass.        . 
-00002ce0: 2020 200a 2020 2020 2320 544f 444f 3a20     .    # TODO: 
-00002cf0: 6920 646f 6e74 2074 6869 6e6b 2074 6869  i dont think thi
-00002d00: 7320 6973 206e 6565 6465 642c 2079 6f75  s is needed, you
-00002d10: 2073 6574 2074 6865 2062 6561 6d20 7365   set the beam se
-00002d20: 7474 696e 6773 2061 6e64 2064 6574 6563  ttings and detec
-00002d30: 746f 7220 7365 7474 696e 6773 2073 6570  tor settings sep
-00002d40: 6172 6174 656c 790a 2020 2020 2320 796f  arately.    # yo
-00002d50: 7520 6361 6e27 7420 7365 7420 696d 6167  u can't set imag
-00002d60: 6520 7365 7474 696e 6773 2c20 6f6e 6c79  e settings, only
-00002d70: 2077 6865 6e20 6163 7175 6972 696e 6720   when acquiring 
-00002d80: 616e 2069 6d61 6765 0a20 2020 2064 6566  an image.    def
-00002d90: 2067 6574 5f69 6d61 6769 6e67 5f73 6574   get_imaging_set
-00002da0: 7469 6e67 7328 7365 6c66 2c20 6265 616d  tings(self, beam
-00002db0: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
-00002dc0: 202d 3e20 496d 6167 6553 6574 7469 6e67   -> ImageSetting
-00002dd0: 733a 0a20 2020 2020 2020 2022 2222 4765  s:.        """Ge
-00002de0: 7420 7468 6520 6375 7272 656e 7420 696d  t the current im
-00002df0: 6167 696e 6720 7365 7474 696e 6773 2066  aging settings f
-00002e00: 6f72 2074 6865 2073 7065 6369 6669 6564  or the specified
-00002e10: 2062 6561 6d20 7479 7065 2e22 2222 0a20   beam type.""". 
-00002e20: 2020 2020 2020 2023 2054 4f44 4f3a 2066         # TODO: f
-00002e30: 696e 6973 6820 7468 6973 2077 6974 6820  inish this with 
-00002e40: 7468 6520 6f74 6865 7220 696d 6167 696e  the other imagin
-00002e50: 6720 7365 7474 696e 6773 2e2e 2e20 4070  g settings... @p
-00002e60: 6174 7269 636b 0a20 2020 2020 2020 206c  atrick.        l
-00002e70: 6f67 6769 6e67 2e64 6562 7567 2866 2247  ogging.debug(f"G
-00002e80: 6574 7469 6e67 207b 6265 616d 5f74 7970  etting {beam_typ
-00002e90: 652e 6e61 6d65 7d20 696d 6167 696e 6720  e.name} imaging 
-00002ea0: 7365 7474 696e 6773 2e2e 2e22 290a 2020  settings...").  
-00002eb0: 2020 2020 2020 696d 6167 655f 7365 7474        image_sett
-00002ec0: 696e 6773 203d 2049 6d61 6765 5365 7474  ings = ImageSett
-00002ed0: 696e 6773 280a 2020 2020 2020 2020 2020  ings(.          
-00002ee0: 2020 6265 616d 5f74 7970 653d 6265 616d    beam_type=beam
-00002ef0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
-00002f00: 2020 2072 6573 6f6c 7574 696f 6e3d 7365     resolution=se
-00002f10: 6c66 2e67 6574 2822 7265 736f 6c75 7469  lf.get("resoluti
-00002f20: 6f6e 222c 2062 6561 6d5f 7479 7065 292c  on", beam_type),
-00002f30: 0a20 2020 2020 2020 2020 2020 2064 7765  .            dwe
-00002f40: 6c6c 5f74 696d 653d 7365 6c66 2e67 6574  ll_time=self.get
-00002f50: 2822 6477 656c 6c5f 7469 6d65 222c 2062  ("dwell_time", b
-00002f60: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-00002f70: 2020 2020 2020 2068 6677 3d73 656c 662e         hfw=self.
-00002f80: 6765 7428 2268 6677 222c 2062 6561 6d5f  get("hfw", beam_
-00002f90: 7479 7065 292c 0a20 2020 2020 2020 2029  type),.        )
-00002fa0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00002fb0: 2e64 6562 7567 287b 226d 7367 223a 2022  .debug({"msg": "
-00002fc0: 6765 745f 696d 6167 696e 675f 7365 7474  get_imaging_sett
-00002fd0: 696e 6773 222c 2022 696d 6167 655f 7365  ings", "image_se
-00002fe0: 7474 696e 6773 223a 2069 6d61 6765 5f73  ttings": image_s
-00002ff0: 6574 7469 6e67 732e 746f 5f64 6963 7428  ettings.to_dict(
-00003000: 292c 2022 6265 616d 5f74 7970 6522 3a20  ), "beam_type": 
-00003010: 6265 616d 5f74 7970 652e 6e61 6d65 7d29  beam_type.name})
-00003020: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00003030: 696d 6167 655f 7365 7474 696e 6773 0a0a  image_settings..
-00003040: 2020 2020 6465 6620 7365 745f 696d 6167      def set_imag
-00003050: 696e 675f 7365 7474 696e 6773 2873 656c  ing_settings(sel
-00003060: 662c 2069 6d61 6765 5f73 6574 7469 6e67  f, image_setting
-00003070: 733a 2049 6d61 6765 5365 7474 696e 6773  s: ImageSettings
-00003080: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00003090: 2020 2022 2222 5365 7420 7468 6520 696d     """Set the im
-000030a0: 6167 696e 6720 7365 7474 696e 6773 2066  aging settings f
-000030b0: 6f72 2074 6865 2073 7065 6369 6669 6564  or the specified
-000030c0: 2062 6561 6d20 7479 7065 2e22 2222 0a20   beam type.""". 
-000030d0: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
-000030e0: 6562 7567 2866 2253 6574 7469 6e67 207b  ebug(f"Setting {
-000030f0: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
-00003100: 6561 6d5f 7479 7065 2e6e 616d 657d 2069  eam_type.name} i
-00003110: 6d61 6769 6e67 2073 6574 7469 6e67 732e  maging settings.
-00003120: 2e2e 2229 0a20 2020 2020 2020 2073 656c  ..").        sel
-00003130: 662e 7365 7428 2272 6573 6f6c 7574 696f  f.set("resolutio
-00003140: 6e22 2c20 696d 6167 655f 7365 7474 696e  n", image_settin
-00003150: 6773 2e72 6573 6f6c 7574 696f 6e2c 2069  gs.resolution, i
-00003160: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
-00003170: 616d 5f74 7970 6529 0a20 2020 2020 2020  am_type).       
-00003180: 2073 656c 662e 7365 7428 2264 7765 6c6c   self.set("dwell
-00003190: 5f74 696d 6522 2c20 696d 6167 655f 7365  _time", image_se
-000031a0: 7474 696e 6773 2e64 7765 6c6c 5f74 696d  ttings.dwell_tim
-000031b0: 652c 2069 6d61 6765 5f73 6574 7469 6e67  e, image_setting
-000031c0: 732e 6265 616d 5f74 7970 6529 0a20 2020  s.beam_type).   
-000031d0: 2020 2020 2073 656c 662e 7365 7428 2268       self.set("h
-000031e0: 6677 222c 2069 6d61 6765 5f73 6574 7469  fw", image_setti
-000031f0: 6e67 732e 6866 772c 2069 6d61 6765 5f73  ngs.hfw, image_s
-00003200: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
-00003210: 6529 0a20 2020 2020 2020 2023 2073 656c  e).        # sel
-00003220: 662e 7365 7428 2266 7261 6d65 5f69 6e74  f.set("frame_int
-00003230: 6567 7261 7469 6f6e 222c 2069 6d61 6765  egration", image
-00003240: 5f73 6574 7469 6e67 732e 6672 616d 655f  _settings.frame_
-00003250: 696e 7465 6772 6174 696f 6e2c 2069 6d61  integration, ima
-00003260: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
-00003270: 5f74 7970 6529 0a20 2020 2020 2020 2023  _type).        #
-00003280: 2073 656c 662e 7365 7428 226c 696e 655f   self.set("line_
-00003290: 696e 7465 6772 6174 696f 6e22 2c20 696d  integration", im
-000032a0: 6167 655f 7365 7474 696e 6773 2e6c 696e  age_settings.lin
-000032b0: 655f 696e 7465 6772 6174 696f 6e2c 2069  e_integration, i
-000032c0: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
-000032d0: 616d 5f74 7970 6529 0a20 2020 2020 2020  am_type).       
-000032e0: 2023 2073 656c 662e 7365 7428 2273 6361   # self.set("sca
-000032f0: 6e5f 696e 7465 726c 6163 696e 6722 2c20  n_interlacing", 
-00003300: 696d 6167 655f 7365 7474 696e 6773 2e73  image_settings.s
-00003310: 6361 6e5f 696e 7465 726c 6163 696e 672c  can_interlacing,
-00003320: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
-00003330: 6265 616d 5f74 7970 6529 0a20 2020 2020  beam_type).     
-00003340: 2020 2023 2073 656c 662e 7365 7428 2264     # self.set("d
-00003350: 7269 6674 5f63 6f72 7265 6374 696f 6e22  rift_correction"
-00003360: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
-00003370: 2e64 7269 6674 5f63 6f72 7265 6374 696f  .drift_correctio
-00003380: 6e2c 2069 6d61 6765 5f73 6574 7469 6e67  n, image_setting
-00003390: 732e 6265 616d 5f74 7970 6529 0a20 2020  s.beam_type).   
-000033a0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-000033b0: 2020 2320 544f 444f 3a20 696d 706c 656d    # TODO: implem
-000033c0: 656e 7420 7468 6520 7265 7374 206f 6620  ent the rest of 
-000033d0: 7468 6573 6520 7365 7474 696e 6773 2e2e  these settings..
-000033e0: 2e20 4070 6174 7269 636b 0a20 2020 2020  . @patrick.     
-000033f0: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
-00003400: 287b 226d 7367 223a 2022 7365 745f 696d  ({"msg": "set_im
-00003410: 6167 696e 675f 7365 7474 696e 6773 222c  aging_settings",
-00003420: 2022 696d 6167 655f 7365 7474 696e 6773   "image_settings
-00003430: 223a 2069 6d61 6765 5f73 6574 7469 6e67  ": image_setting
-00003440: 732e 746f 5f64 6963 7428 292c 2022 6265  s.to_dict(), "be
-00003450: 616d 5f74 7970 6522 3a20 696d 6167 655f  am_type": image_
-00003460: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
-00003470: 7065 2e6e 616d 657d 290a 0a20 2020 2020  pe.name})..     
-00003480: 2020 2072 6574 7572 6e20 0a0a 2020 2020     return ..    
-00003490: 6465 6620 6765 745f 6265 616d 5f73 6574  def get_beam_set
-000034a0: 7469 6e67 7328 7365 6c66 2c20 6265 616d  tings(self, beam
-000034b0: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
-000034c0: 202d 3e20 4265 616d 5365 7474 696e 6773   -> BeamSettings
-000034d0: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
-000034e0: 2074 6865 2063 7572 7265 6e74 2062 6561   the current bea
-000034f0: 6d20 7365 7474 696e 6773 2066 6f72 2074  m settings for t
-00003500: 6865 2073 7065 6369 6669 6564 2062 6561  he specified bea
-00003510: 6d20 7479 7065 2e0a 2020 2020 2020 2020  m type..        
-00003520: 2222 220a 0a20 2020 2020 2020 206c 6f67  """..        log
-00003530: 6769 6e67 2e64 6562 7567 2866 2247 6574  ging.debug(f"Get
-00003540: 7469 6e67 207b 6265 616d 5f74 7970 652e  ting {beam_type.
-00003550: 6e61 6d65 7d20 6265 616d 2073 6574 7469  name} beam setti
-00003560: 6e67 732e 2e2e 2229 0a20 2020 2020 2020  ngs...").       
-00003570: 2062 6561 6d5f 7365 7474 696e 6773 203d   beam_settings =
-00003580: 2042 6561 6d53 6574 7469 6e67 7328 0a20   BeamSettings(. 
-00003590: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-000035a0: 7479 7065 3d62 6561 6d5f 7479 7065 2c0a  type=beam_type,.
-000035b0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000035c0: 696e 675f 6469 7374 616e 6365 3d73 656c  ing_distance=sel
-000035d0: 662e 6765 7428 2277 6f72 6b69 6e67 5f64  f.get("working_d
-000035e0: 6973 7461 6e63 6522 2c20 6265 616d 5f74  istance", beam_t
-000035f0: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
-00003600: 2020 6265 616d 5f63 7572 7265 6e74 3d73    beam_current=s
-00003610: 656c 662e 6765 7428 2263 7572 7265 6e74  elf.get("current
-00003620: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
-00003630: 2020 2020 2020 2020 2020 2076 6f6c 7461             volta
-00003640: 6765 3d73 656c 662e 6765 7428 2276 6f6c  ge=self.get("vol
-00003650: 7461 6765 222c 2062 6561 6d5f 7479 7065  tage", beam_type
-00003660: 292c 0a20 2020 2020 2020 2020 2020 2068  ),.            h
-00003670: 6677 3d73 656c 662e 6765 7428 2268 6677  fw=self.get("hfw
-00003680: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
-00003690: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
-000036a0: 7574 696f 6e3d 7365 6c66 2e67 6574 2822  ution=self.get("
-000036b0: 7265 736f 6c75 7469 6f6e 222c 2062 6561  resolution", bea
-000036c0: 6d5f 7479 7065 292c 2020 0a20 2020 2020  m_type),  .     
-000036d0: 2020 2020 2020 2064 7765 6c6c 5f74 696d         dwell_tim
-000036e0: 653d 7365 6c66 2e67 6574 2822 6477 656c  e=self.get("dwel
-000036f0: 6c5f 7469 6d65 2220 2c20 6265 616d 5f74  l_time" , beam_t
-00003700: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
-00003710: 2020 7374 6967 6d61 7469 6f6e 3d73 656c    stigmation=sel
-00003720: 662e 6765 7428 2273 7469 676d 6174 696f  f.get("stigmatio
-00003730: 6e22 2c20 6265 616d 5f74 7970 6529 2c0a  n", beam_type),.
-00003740: 2020 2020 2020 2020 2020 2020 7368 6966              shif
-00003750: 743d 7365 6c66 2e67 6574 2822 7368 6966  t=self.get("shif
-00003760: 7422 2c20 6265 616d 5f74 7970 6529 2c0a  t", beam_type),.
-00003770: 2020 2020 2020 2020 2020 2020 7363 616e              scan
-00003780: 5f72 6f74 6174 696f 6e3d 7365 6c66 2e67  _rotation=self.g
-00003790: 6574 2822 7363 616e 5f72 6f74 6174 696f  et("scan_rotatio
-000037a0: 6e22 2c20 6265 616d 5f74 7970 6529 2c0a  n", beam_type),.
-000037b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000037c0: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
-000037d0: 7b22 6d73 6722 3a20 2267 6574 5f62 6561  {"msg": "get_bea
-000037e0: 6d5f 7365 7474 696e 6773 222c 2022 6265  m_settings", "be
-000037f0: 616d 5f73 6574 7469 6e67 7322 3a20 6265  am_settings": be
-00003800: 616d 5f73 6574 7469 6e67 732e 746f 5f64  am_settings.to_d
-00003810: 6963 7428 292c 2022 6265 616d 5f74 7970  ict(), "beam_typ
-00003820: 6522 3a20 6265 616d 5f74 7970 652e 6e61  e": beam_type.na
-00003830: 6d65 7d29 0a20 2020 2020 2020 200a 2020  me}).        .  
-00003840: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
-00003850: 6d5f 7365 7474 696e 6773 0a20 2020 2020  m_settings.     
-00003860: 2020 200a 2020 2020 6465 6620 7365 745f     .    def set_
-00003870: 6265 616d 5f73 6574 7469 6e67 7328 7365  beam_settings(se
-00003880: 6c66 2c20 6265 616d 5f73 6574 7469 6e67  lf, beam_setting
-00003890: 733a 2042 6561 6d53 6574 7469 6e67 7329  s: BeamSettings)
-000038a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000038b0: 2020 2222 2253 6574 2074 6865 2062 6561    """Set the bea
-000038c0: 6d20 7365 7474 696e 6773 2066 6f72 2074  m settings for t
-000038d0: 6865 2073 7065 6369 6669 6564 2062 6561  he specified bea
-000038e0: 6d20 7479 7065 2222 220a 2020 2020 2020  m type""".      
-000038f0: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
-00003900: 6622 5365 7474 696e 6720 7b62 6561 6d5f  f"Setting {beam_
-00003910: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
-00003920: 7065 2e6e 616d 657d 2062 6561 6d20 7365  pe.name} beam se
-00003930: 7474 696e 6773 2e2e 2e22 290a 2020 2020  ttings...").    
-00003940: 2020 2020 7365 6c66 2e73 6574 2822 776f      self.set("wo
-00003950: 726b 696e 675f 6469 7374 616e 6365 222c  rking_distance",
-00003960: 2062 6561 6d5f 7365 7474 696e 6773 2e77   beam_settings.w
-00003970: 6f72 6b69 6e67 5f64 6973 7461 6e63 652c  orking_distance,
-00003980: 2062 6561 6d5f 7365 7474 696e 6773 2e62   beam_settings.b
-00003990: 6561 6d5f 7479 7065 290a 2020 2020 2020  eam_type).      
-000039a0: 2020 7365 6c66 2e73 6574 2822 6375 7272    self.set("curr
-000039b0: 656e 7422 2c20 6265 616d 5f73 6574 7469  ent", beam_setti
-000039c0: 6e67 732e 6265 616d 5f63 7572 7265 6e74  ngs.beam_current
-000039d0: 2c20 6265 616d 5f73 6574 7469 6e67 732e  , beam_settings.
-000039e0: 6265 616d 5f74 7970 6529 0a20 2020 2020  beam_type).     
-000039f0: 2020 2073 656c 662e 7365 7428 2276 6f6c     self.set("vol
-00003a00: 7461 6765 222c 2062 6561 6d5f 7365 7474  tage", beam_sett
-00003a10: 696e 6773 2e76 6f6c 7461 6765 2c20 6265  ings.voltage, be
-00003a20: 616d 5f73 6574 7469 6e67 732e 6265 616d  am_settings.beam
-00003a30: 5f74 7970 6529 0a20 2020 2020 2020 2073  _type).        s
-00003a40: 656c 662e 7365 7428 2268 6677 222c 2062  elf.set("hfw", b
-00003a50: 6561 6d5f 7365 7474 696e 6773 2e68 6677  eam_settings.hfw
-00003a60: 2c20 6265 616d 5f73 6574 7469 6e67 732e  , beam_settings.
-00003a70: 6265 616d 5f74 7970 6529 0a20 2020 2020  beam_type).     
-00003a80: 2020 2073 656c 662e 7365 7428 2272 6573     self.set("res
-00003a90: 6f6c 7574 696f 6e22 2c20 6265 616d 5f73  olution", beam_s
-00003aa0: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
-00003ab0: 6f6e 2c20 6265 616d 5f73 6574 7469 6e67  on, beam_setting
-00003ac0: 732e 6265 616d 5f74 7970 6529 0a20 2020  s.beam_type).   
-00003ad0: 2020 2020 2073 656c 662e 7365 7428 2264       self.set("d
-00003ae0: 7765 6c6c 5f74 696d 6522 2c20 6265 616d  well_time", beam
-00003af0: 5f73 6574 7469 6e67 732e 6477 656c 6c5f  _settings.dwell_
-00003b00: 7469 6d65 2c20 6265 616d 5f73 6574 7469  time, beam_setti
-00003b10: 6e67 732e 6265 616d 5f74 7970 6529 0a20  ngs.beam_type). 
-00003b20: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
-00003b30: 2273 7469 676d 6174 696f 6e22 2c20 6265  "stigmation", be
-00003b40: 616d 5f73 6574 7469 6e67 732e 7374 6967  am_settings.stig
-00003b50: 6d61 7469 6f6e 2c20 6265 616d 5f73 6574  mation, beam_set
-00003b60: 7469 6e67 732e 6265 616d 5f74 7970 6529  tings.beam_type)
-00003b70: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
-00003b80: 7428 2273 6869 6674 222c 2062 6561 6d5f  t("shift", beam_
-00003b90: 7365 7474 696e 6773 2e73 6869 6674 2c20  settings.shift, 
-00003ba0: 6265 616d 5f73 6574 7469 6e67 732e 6265  beam_settings.be
-00003bb0: 616d 5f74 7970 6529 0a20 2020 2020 2020  am_type).       
-00003bc0: 2073 656c 662e 7365 7428 2273 6361 6e5f   self.set("scan_
-00003bd0: 726f 7461 7469 6f6e 222c 2062 6561 6d5f  rotation", beam_
-00003be0: 7365 7474 696e 6773 2e73 6361 6e5f 726f  settings.scan_ro
-00003bf0: 7461 7469 6f6e 2c20 6265 616d 5f73 6574  tation, beam_set
-00003c00: 7469 6e67 732e 6265 616d 5f74 7970 6529  tings.beam_type)
-00003c10: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
-00003c20: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
-00003c30: 2273 6574 5f62 6561 6d5f 7365 7474 696e  "set_beam_settin
-00003c40: 6773 222c 2022 6265 616d 5f73 6574 7469  gs", "beam_setti
-00003c50: 6e67 7322 3a20 6265 616d 5f73 6574 7469  ngs": beam_setti
-00003c60: 6e67 732e 746f 5f64 6963 7428 292c 2022  ngs.to_dict(), "
-00003c70: 6265 616d 5f74 7970 6522 3a20 6265 616d  beam_type": beam
-00003c80: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-00003c90: 7970 652e 6e61 6d65 7d29 0a20 2020 2020  ype.name}).     
-00003ca0: 2020 2072 6574 7572 6e20 0a20 2020 2020     return .     
-00003cb0: 2020 200a 2020 2020 6465 6620 6765 745f     .    def get_
-00003cc0: 6265 616d 5f73 7973 7465 6d5f 7365 7474  beam_system_sett
-00003cd0: 696e 6773 2873 656c 662c 2062 6561 6d5f  ings(self, beam_
-00003ce0: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
-00003cf0: 2d3e 2042 6561 6d53 7973 7465 6d53 6574  -> BeamSystemSet
-00003d00: 7469 6e67 733a 0a20 2020 2020 2020 2022  tings:.        "
-00003d10: 2222 4765 7420 7468 6520 6375 7272 656e  ""Get the curren
-00003d20: 7420 6265 616d 2073 7973 7465 6d20 7365  t beam system se
-00003d30: 7474 696e 6773 2066 6f72 2074 6865 2073  ttings for the s
-00003d40: 7065 6369 6669 6564 2062 6561 6d20 7479  pecified beam ty
-00003d50: 7065 2e0a 2020 2020 2020 2020 2222 220a  pe..        """.
-00003d60: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00003d70: 6465 6275 6728 6622 4765 7474 696e 6720  debug(f"Getting 
-00003d80: 7b62 6561 6d5f 7479 7065 2e6e 616d 657d  {beam_type.name}
-00003d90: 2062 6561 6d20 7379 7374 656d 2073 6574   beam system set
-00003da0: 7469 6e67 732e 2e2e 2229 0a20 2020 2020  tings...").     
-00003db0: 2020 2062 6561 6d5f 7379 7374 656d 5f73     beam_system_s
-00003dc0: 6574 7469 6e67 7320 3d20 4265 616d 5379  ettings = BeamSy
-00003dd0: 7374 656d 5365 7474 696e 6773 280a 2020  stemSettings(.  
-00003de0: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
-00003df0: 7970 653d 6265 616d 5f74 7970 652c 0a20  ype=beam_type,. 
-00003e00: 2020 2020 2020 2020 2020 2065 6e61 626c             enabl
-00003e10: 6564 3d73 656c 662e 6765 7428 2262 6561  ed=self.get("bea
-00003e20: 6d5f 656e 6162 6c65 6422 2c20 6265 616d  m_enabled", beam
-00003e30: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
-00003e40: 2020 2020 6265 616d 3d73 656c 662e 6765      beam=self.ge
-00003e50: 745f 6265 616d 5f73 6574 7469 6e67 7328  t_beam_settings(
-00003e60: 6265 616d 5f74 7970 6529 2c0a 2020 2020  beam_type),.    
-00003e70: 2020 2020 2020 2020 6465 7465 6374 6f72          detector
-00003e80: 3d73 656c 662e 6765 745f 6465 7465 6374  =self.get_detect
-00003e90: 6f72 5f73 6574 7469 6e67 7328 6265 616d  or_settings(beam
-00003ea0: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
-00003eb0: 2020 2020 6575 6365 6e74 7269 635f 6865      eucentric_he
-00003ec0: 6967 6874 3d73 656c 662e 6765 7428 2265  ight=self.get("e
-00003ed0: 7563 656e 7472 6963 5f68 6569 6768 7422  ucentric_height"
-00003ee0: 2c20 6265 616d 5f74 7970 6529 2c0a 2020  , beam_type),.  
-00003ef0: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
-00003f00: 5f74 696c 743d 7365 6c66 2e67 6574 2822  _tilt=self.get("
-00003f10: 636f 6c75 6d6e 5f74 696c 7422 2c20 6265  column_tilt", be
-00003f20: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
-00003f30: 2020 2020 2020 706c 6173 6d61 3d73 656c        plasma=sel
-00003f40: 662e 6765 7428 2270 6c61 736d 6122 2c20  f.get("plasma", 
-00003f50: 6265 616d 5f74 7970 6529 2c0a 2020 2020  beam_type),.    
-00003f60: 2020 2020 2020 2020 706c 6173 6d61 5f67          plasma_g
-00003f70: 6173 3d73 656c 662e 6765 7428 2270 6c61  as=self.get("pla
-00003f80: 736d 615f 6761 7322 2c20 6265 616d 5f74  sma_gas", beam_t
-00003f90: 7970 6529 2c0a 2020 2020 2020 2020 2920  ype),.        ) 
-00003fa0: 2020 2020 200a 2020 2020 2020 2020 0a20       .        . 
-00003fb0: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
-00003fc0: 6562 7567 287b 226d 7367 223a 2022 6765  ebug({"msg": "ge
-00003fd0: 745f 6265 616d 5f73 7973 7465 6d5f 7365  t_beam_system_se
-00003fe0: 7474 696e 6773 222c 2022 7365 7474 696e  ttings", "settin
-00003ff0: 6773 223a 2062 6561 6d5f 7379 7374 656d  gs": beam_system
-00004000: 5f73 6574 7469 6e67 732e 746f 5f64 6963  _settings.to_dic
-00004010: 7428 292c 2022 6265 616d 5f74 7970 6522  t(), "beam_type"
-00004020: 3a20 6265 616d 5f74 7970 652e 6e61 6d65  : beam_type.name
-00004030: 7d29 0a20 2020 2020 2020 2072 6574 7572  }).        retur
-00004040: 6e20 6265 616d 5f73 7973 7465 6d5f 7365  n beam_system_se
-00004050: 7474 696e 6773 0a20 2020 2020 2020 200a  ttings.        .
-00004060: 2020 2020 6465 6620 7365 745f 6265 616d      def set_beam
-00004070: 5f73 7973 7465 6d5f 7365 7474 696e 6773  _system_settings
-00004080: 2873 656c 662c 2073 6574 7469 6e67 733a  (self, settings:
-00004090: 2042 6561 6d53 7973 7465 6d53 6574 7469   BeamSystemSetti
-000040a0: 6e67 7329 202d 3e20 4e6f 6e65 3a0a 2020  ngs) -> None:.  
-000040b0: 2020 2020 2020 2222 2253 6574 2074 6865        """Set the
-000040c0: 2062 6561 6d20 7379 7374 656d 2073 6574   beam system set
-000040d0: 7469 6e67 7320 666f 7220 7468 6520 7370  tings for the sp
-000040e0: 6563 6966 6965 6420 6265 616d 2074 7970  ecified beam typ
-000040f0: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-00004100: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
-00004110: 203d 2073 6574 7469 6e67 732e 6265 616d   = settings.beam
-00004120: 5f74 7970 650a 2020 2020 2020 2020 6c6f  _type.        lo
-00004130: 6767 696e 672e 6465 6275 6728 6622 5365  gging.debug(f"Se
-00004140: 7474 696e 6720 7b73 6574 7469 6e67 732e  tting {settings.
-00004150: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
-00004160: 6265 616d 2073 7973 7465 6d20 7365 7474  beam system sett
-00004170: 696e 6773 2e2e 2e22 290a 2020 2020 2020  ings...").      
-00004180: 2020 7365 6c66 2e73 6574 2822 6265 616d    self.set("beam
-00004190: 5f65 6e61 626c 6564 222c 2073 6574 7469  _enabled", setti
-000041a0: 6e67 732e 656e 6162 6c65 642c 2062 6561  ngs.enabled, bea
-000041b0: 6d5f 7479 7065 290a 2020 2020 2020 2020  m_type).        
-000041c0: 7365 6c66 2e73 6574 5f62 6561 6d5f 7365  self.set_beam_se
-000041d0: 7474 696e 6773 2873 6574 7469 6e67 732e  ttings(settings.
-000041e0: 6265 616d 290a 2020 2020 2020 2020 7365  beam).        se
-000041f0: 6c66 2e73 6574 5f64 6574 6563 746f 725f  lf.set_detector_
-00004200: 7365 7474 696e 6773 2873 6574 7469 6e67  settings(setting
-00004210: 732e 6465 7465 6374 6f72 2c20 6265 616d  s.detector, beam
-00004220: 5f74 7970 6529 0a20 2020 2020 2020 2073  _type).        s
-00004230: 656c 662e 7365 7428 2265 7563 656e 7472  elf.set("eucentr
-00004240: 6963 5f68 6569 6768 7422 2c20 7365 7474  ic_height", sett
-00004250: 696e 6773 2e65 7563 656e 7472 6963 5f68  ings.eucentric_h
-00004260: 6569 6768 742c 2062 6561 6d5f 7479 7065  eight, beam_type
-00004270: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-00004280: 6574 2822 636f 6c75 6d6e 5f74 696c 7422  et("column_tilt"
-00004290: 2c20 7365 7474 696e 6773 2e63 6f6c 756d  , settings.colum
-000042a0: 6e5f 7469 6c74 2c20 6265 616d 5f74 7970  n_tilt, beam_typ
-000042b0: 6529 0a20 2020 2020 2020 200a 2020 2020  e).        .    
-000042c0: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
-000042d0: 2069 7320 4265 616d 5479 7065 2e49 4f4e   is BeamType.ION
-000042e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000042f0: 6c66 2e73 6574 2822 706c 6173 6d61 5f67  lf.set("plasma_g
-00004300: 6173 222c 2073 6574 7469 6e67 732e 706c  as", settings.pl
-00004310: 6173 6d61 5f67 6173 2c20 6265 616d 5f74  asma_gas, beam_t
-00004320: 7970 6529 0a20 2020 2020 2020 2020 2020  ype).           
-00004330: 2073 656c 662e 7365 7428 2270 6c61 736d   self.set("plasm
-00004340: 6122 2c20 7365 7474 696e 6773 2e70 6c61  a", settings.pla
-00004350: 736d 612c 2062 6561 6d5f 7479 7065 290a  sma, beam_type).
-00004360: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00004370: 2e64 6562 7567 2820 7b22 6d73 6722 3a20  .debug( {"msg": 
-00004380: 2273 6574 5f62 6561 6d5f 7379 7374 656d  "set_beam_system
-00004390: 5f73 6574 7469 6e67 7322 2c20 2273 6574  _settings", "set
-000043a0: 7469 6e67 7322 3a20 7365 7474 696e 6773  tings": settings
-000043b0: 2e74 6f5f 6469 6374 2829 2c20 2262 6561  .to_dict(), "bea
-000043c0: 6d5f 7479 7065 223a 2062 6561 6d5f 7479  m_type": beam_ty
-000043d0: 7065 2e6e 616d 657d 290a 2020 2020 0a20  pe.name}).    . 
-000043e0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-000043f0: 2020 2064 6566 2067 6574 5f64 6574 6563     def get_detec
-00004400: 746f 725f 7365 7474 696e 6773 2873 656c  tor_settings(sel
-00004410: 662c 2062 6561 6d5f 7479 7065 3a20 4265  f, beam_type: Be
-00004420: 616d 5479 7065 203d 2042 6561 6d54 7970  amType = BeamTyp
-00004430: 652e 454c 4543 5452 4f4e 2920 2d3e 2046  e.ELECTRON) -> F
-00004440: 6962 7365 6d44 6574 6563 746f 7253 6574  ibsemDetectorSet
-00004450: 7469 6e67 733a 0a20 2020 2020 2020 2022  tings:.        "
-00004460: 2222 4765 7420 7468 6520 6375 7272 656e  ""Get the curren
-00004470: 7420 6465 7465 6374 6f72 2073 6574 7469  t detector setti
-00004480: 6e67 7320 666f 7220 7468 6520 7370 6563  ngs for the spec
-00004490: 6966 6965 6420 6265 616d 2074 7970 652e  ified beam type.
-000044a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000044b0: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
-000044c0: 7567 2866 2247 6574 7469 6e67 207b 6265  ug(f"Getting {be
-000044d0: 616d 5f74 7970 652e 6e61 6d65 7d20 6465  am_type.name} de
-000044e0: 7465 6374 6f72 2073 6574 7469 6e67 732e  tector settings.
-000044f0: 2e2e 2229 0a20 2020 2020 2020 2064 6574  ..").        det
-00004500: 6563 746f 725f 7365 7474 696e 6773 203d  ector_settings =
-00004510: 2046 6962 7365 6d44 6574 6563 746f 7253   FibsemDetectorS
-00004520: 6574 7469 6e67 7328 0a20 2020 2020 2020  ettings(.       
-00004530: 2020 2020 2074 7970 653d 7365 6c66 2e67       type=self.g
-00004540: 6574 2822 6465 7465 6374 6f72 5f74 7970  et("detector_typ
-00004550: 6522 2c20 6265 616d 5f74 7970 6529 2c0a  e", beam_type),.
-00004560: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00004570: 3d73 656c 662e 6765 7428 2264 6574 6563  =self.get("detec
-00004580: 746f 725f 6d6f 6465 222c 2062 6561 6d5f  tor_mode", beam_
-00004590: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
-000045a0: 2020 2062 7269 6768 746e 6573 733d 7365     brightness=se
-000045b0: 6c66 2e67 6574 2822 6465 7465 6374 6f72  lf.get("detector
-000045c0: 5f62 7269 6768 746e 6573 7322 2c20 6265  _brightness", be
-000045d0: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
-000045e0: 2020 2020 2020 636f 6e74 7261 7374 3d73        contrast=s
-000045f0: 656c 662e 6765 7428 2264 6574 6563 746f  elf.get("detecto
-00004600: 725f 636f 6e74 7261 7374 222c 2062 6561  r_contrast", bea
-00004610: 6d5f 7479 7065 292c 0a20 2020 2020 2020  m_type),.       
-00004620: 2029 0a20 2020 2020 2020 206c 6f67 6769   ).        loggi
-00004630: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
-00004640: 2022 6765 745f 6465 7465 6374 6f72 5f73   "get_detector_s
-00004650: 6574 7469 6e67 7322 2c20 2264 6574 6563  ettings", "detec
-00004660: 746f 725f 7365 7474 696e 6773 223a 2064  tor_settings": d
-00004670: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
-00004680: 2e74 6f5f 6469 6374 2829 2c20 2262 6561  .to_dict(), "bea
-00004690: 6d5f 7479 7065 223a 2062 6561 6d5f 7479  m_type": beam_ty
-000046a0: 7065 2e6e 616d 657d 290a 2020 2020 2020  pe.name}).      
-000046b0: 2020 7265 7475 726e 2064 6574 6563 746f    return detecto
-000046c0: 725f 7365 7474 696e 6773 0a20 2020 200a  r_settings.    .
-000046d0: 2020 2020 6465 6620 7365 745f 6465 7465      def set_dete
-000046e0: 6374 6f72 5f73 6574 7469 6e67 7328 7365  ctor_settings(se
-000046f0: 6c66 2c20 6465 7465 6374 6f72 5f73 6574  lf, detector_set
-00004700: 7469 6e67 733a 2046 6962 7365 6d44 6574  tings: FibsemDet
-00004710: 6563 746f 7253 6574 7469 6e67 732c 2062  ectorSettings, b
-00004720: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
-00004730: 7065 203d 2042 6561 6d54 7970 652e 454c  pe = BeamType.EL
-00004740: 4543 5452 4f4e 2920 2d3e 204e 6f6e 653a  ECTRON) -> None:
-00004750: 0a20 2020 2020 2020 2022 2222 5365 7420  .        """Set 
-00004760: 7468 6520 6465 7465 6374 6f72 2073 6574  the detector set
-00004770: 7469 6e67 7320 666f 7220 7468 6520 7370  tings for the sp
-00004780: 6563 6966 6965 6420 6265 616d 2074 7970  ecified beam typ
-00004790: 6522 2222 0a20 2020 2020 2020 206c 6f67  e""".        log
-000047a0: 6769 6e67 2e64 6562 7567 2866 2253 6574  ging.debug(f"Set
-000047b0: 7469 6e67 207b 6265 616d 5f74 7970 652e  ting {beam_type.
-000047c0: 6e61 6d65 7d20 6465 7465 6374 6f72 2073  name} detector s
-000047d0: 6574 7469 6e67 732e 2e2e 2229 0a20 2020  ettings...").   
-000047e0: 2020 2020 2073 656c 662e 7365 7428 2264       self.set("d
-000047f0: 6574 6563 746f 725f 7479 7065 222c 2064  etector_type", d
-00004800: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
-00004810: 2e74 7970 652c 2062 6561 6d5f 7479 7065  .type, beam_type
-00004820: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-00004830: 6574 2822 6465 7465 6374 6f72 5f6d 6f64  et("detector_mod
-00004840: 6522 2c20 6465 7465 6374 6f72 5f73 6574  e", detector_set
-00004850: 7469 6e67 732e 6d6f 6465 2c20 6265 616d  tings.mode, beam
-00004860: 5f74 7970 6529 0a20 2020 2020 2020 2073  _type).        s
-00004870: 656c 662e 7365 7428 2264 6574 6563 746f  elf.set("detecto
-00004880: 725f 6272 6967 6874 6e65 7373 222c 2064  r_brightness", d
-00004890: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
-000048a0: 2e62 7269 6768 746e 6573 732c 2062 6561  .brightness, bea
-000048b0: 6d5f 7479 7065 290a 2020 2020 2020 2020  m_type).        
-000048c0: 7365 6c66 2e73 6574 2822 6465 7465 6374  self.set("detect
-000048d0: 6f72 5f63 6f6e 7472 6173 7422 2c20 6465  or_contrast", de
+00002800: 7468 6f64 0a20 2020 2064 6566 2064 7261  thod.    def dra
+00002810: 775f 6369 7263 6c65 2873 656c 662c 2070  w_circle(self, p
+00002820: 6174 7465 726e 5f73 6574 7469 6e67 733a  attern_settings:
+00002830: 2046 6962 7365 6d43 6972 636c 6553 6574   FibsemCircleSet
+00002840: 7469 6e67 7329 3a0a 2020 2020 2020 2020  tings):.        
+00002850: 7061 7373 0a0a 2020 2020 4061 6273 7472  pass..    @abstr
+00002860: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
+00002870: 6620 6472 6177 5f62 6974 6d61 705f 7061  f draw_bitmap_pa
+00002880: 7474 6572 6e28 0a20 2020 2020 2020 2073  ttern(.        s
+00002890: 656c 662c 0a20 2020 2020 2020 2070 6174  elf,.        pat
+000028a0: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
+000028b0: 6962 7365 6d42 6974 6d61 7053 6574 7469  ibsemBitmapSetti
+000028c0: 6e67 732c 0a20 2020 2020 2020 2070 6174  ngs,.        pat
+000028d0: 683a 2073 7472 2c0a 2020 2020 293a 0a20  h: str,.    ):. 
+000028e0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+000028f0: 2040 6162 7374 7261 6374 6d65 7468 6f64   @abstractmethod
+00002900: 0a20 2020 2064 6566 2063 7279 6f5f 6465  .    def cryo_de
+00002910: 706f 7369 7469 6f6e 5f76 3228 7365 6c66  position_v2(self
+00002920: 2c20 6769 735f 7365 7474 696e 6773 3a20  , gis_settings: 
+00002930: 4669 6273 656d 4761 7349 6e6a 6563 7469  FibsemGasInjecti
+00002940: 6f6e 5365 7474 696e 6773 2920 2d3e 204e  onSettings) -> N
+00002950: 6f6e 653a 0a20 2020 2020 2020 2070 6173  one:.        pas
+00002960: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
+00002970: 6d65 7468 6f64 0a20 2020 2064 6566 2073  method.    def s
+00002980: 6574 7570 5f73 7075 7474 6572 2873 656c  etup_sputter(sel
+00002990: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
+000029a0: 6773 293a 0a20 2020 2020 2020 2070 6173  gs):.        pas
+000029b0: 730a 0a20 2020 2040 6162 7374 7261 6374  s..    @abstract
+000029c0: 6d65 7468 6f64 0a20 2020 2064 6566 2064  method.    def d
+000029d0: 7261 775f 7370 7574 7465 725f 7061 7474  raw_sputter_patt
+000029e0: 6572 6e28 7365 6c66 2c20 2a61 7267 732c  ern(self, *args,
+000029f0: 202a 2a6b 7761 7267 7329 202d 3e20 4e6f   **kwargs) -> No
+00002a00: 6e65 3a0a 2020 2020 2020 2020 7061 7373  ne:.        pass
+00002a10: 0a0a 2020 2020 4061 6273 7472 6163 746d  ..    @abstractm
+00002a20: 6574 686f 640a 2020 2020 6465 6620 7275  ethod.    def ru
+00002a30: 6e5f 7370 7574 7465 7228 7365 6c66 2c20  n_sputter(self, 
+00002a40: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00002a50: 3a0a 2020 2020 2020 2020 7061 7373 0a0a  :.        pass..
+00002a60: 2020 2020 4061 6273 7472 6163 746d 6574      @abstractmet
+00002a70: 686f 640a 2020 2020 6465 6620 6669 6e69  hod.    def fini
+00002a80: 7368 5f73 7075 7474 6572 2873 656c 6629  sh_sputter(self)
+00002a90: 3a0a 2020 2020 2020 2020 7061 7373 0a20  :.        pass. 
+00002aa0: 2020 200a 2020 2020 4061 6273 7472 6163     .    @abstrac
+00002ab0: 746d 6574 686f 640a 2020 2020 6465 6620  tmethod.    def 
+00002ac0: 6765 745f 6176 6169 6c61 626c 655f 7661  get_available_va
+00002ad0: 6c75 6573 2873 656c 662c 206b 6579 3a73  lues(self, key:s
+00002ae0: 7472 2c20 6265 616d 5f74 7970 653a 2042  tr, beam_type: B
+00002af0: 6561 6d54 7970 6520 3d20 4e6f 6e65 2920  eamType = None) 
+00002b00: 2d3e 206c 6973 743a 0a20 2020 2020 2020  -> list:.       
+00002b10: 2070 6173 730a 0a20 2020 2023 2054 4f44   pass..    # TOD
+00002b20: 4f3a 2075 7365 2061 2064 6563 6f72 6174  O: use a decorat
+00002b30: 6f72 2069 6e73 7465 6164 3f0a 2020 2020  or instead?.    
+00002b40: 6465 6620 6765 7428 7365 6c66 2c20 6b65  def get(self, ke
+00002b50: 793a 2073 7472 2c20 6265 616d 5f74 7970  y: str, beam_typ
+00002b60: 653a 2042 6561 6d54 7970 6520 3d20 4e6f  e: BeamType = No
+00002b70: 6e65 2920 2d3e 2055 6e69 6f6e 5b66 6c6f  ne) -> Union[flo
+00002b80: 6174 2c20 696e 742c 2062 6f6f 6c2c 2073  at, int, bool, s
+00002b90: 7472 2c20 6c69 7374 5d3a 0a20 2020 2020  tr, list]:.     
+00002ba0: 2020 2022 2222 4765 7420 7772 6170 7065     """Get wrappe
+00002bb0: 7220 666f 7220 6c6f 6767 696e 672e 2222  r for logging.""
+00002bc0: 220a 2020 2020 2020 2020 6c6f 6767 696e  ".        loggin
+00002bd0: 672e 6465 6275 6728 6622 4765 7474 696e  g.debug(f"Gettin
+00002be0: 6720 7b6b 6579 7d20 287b 6265 616d 5f74  g {key} ({beam_t
+00002bf0: 7970 657d 2922 290a 2020 2020 2020 2020  ype})").        
+00002c00: 7661 6c75 6520 3d20 7365 6c66 2e5f 6765  value = self._ge
+00002c10: 7428 6b65 792c 2062 6561 6d5f 7479 7065  t(key, beam_type
+00002c20: 290a 2020 2020 2020 2020 6265 616d 5f6e  ).        beam_n
+00002c30: 616d 6520 3d20 224e 6f6e 6522 2069 6620  ame = "None" if 
+00002c40: 6265 616d 5f74 7970 6520 6973 204e 6f6e  beam_type is Non
+00002c50: 6520 656c 7365 2062 6561 6d5f 7479 7065  e else beam_type
+00002c60: 2e6e 616d 650a 2020 2020 2020 2020 6c6f  .name.        lo
+00002c70: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00002c80: 6722 3a20 2267 6574 222c 2022 6b65 7922  g": "get", "key"
+00002c90: 3a20 6b65 792c 2022 6265 616d 5f74 7970  : key, "beam_typ
+00002ca0: 6522 3a20 6265 616d 5f6e 616d 652c 2022  e": beam_name, "
+00002cb0: 7661 6c75 6522 3a20 7661 6c75 657d 290a  value": value}).
+00002cc0: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+00002cd0: 616c 7565 0a0a 2020 2020 6465 6620 7365  alue..    def se
+00002ce0: 7428 7365 6c66 2c20 6b65 793a 2073 7472  t(self, key: str
+00002cf0: 2c20 7661 6c75 652c 2062 6561 6d5f 7479  , value, beam_ty
+00002d00: 7065 3a20 4265 616d 5479 7065 203d 204e  pe: BeamType = N
+00002d10: 6f6e 6529 202d 3e20 4e6f 6e65 3a0a 2020  one) -> None:.  
+00002d20: 2020 2020 2020 2222 2253 6574 2077 7261        """Set wra
+00002d30: 7070 6572 2066 6f72 206c 6f67 6769 6e67  pper for logging
+00002d40: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
+00002d50: 696e 672e 6465 6275 6728 6622 5365 7474  ing.debug(f"Sett
+00002d60: 696e 6720 7b6b 6579 7d20 746f 207b 7661  ing {key} to {va
+00002d70: 6c75 657d 2028 7b62 6561 6d5f 7479 7065  lue} ({beam_type
+00002d80: 7d29 2229 0a20 2020 2020 2020 2073 656c  })").        sel
+00002d90: 662e 5f73 6574 286b 6579 2c20 7661 6c75  f._set(key, valu
+00002da0: 652c 2062 6561 6d5f 7479 7065 290a 2020  e, beam_type).  
+00002db0: 2020 2020 2020 6265 616d 5f6e 616d 6520        beam_name 
+00002dc0: 3d20 224e 6f6e 6522 2069 6620 6265 616d  = "None" if beam
+00002dd0: 5f74 7970 6520 6973 204e 6f6e 6520 656c  _type is None el
+00002de0: 7365 2062 6561 6d5f 7479 7065 2e6e 616d  se beam_type.nam
+00002df0: 650a 2020 2020 2020 2020 6c6f 6767 696e  e.        loggin
+00002e00: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
+00002e10: 2273 6574 222c 2022 6b65 7922 3a20 6b65  "set", "key": ke
+00002e20: 792c 2022 6265 616d 5f74 7970 6522 3a20  y, "beam_type": 
+00002e30: 6265 616d 5f6e 616d 652c 2022 7661 6c75  beam_name, "valu
+00002e40: 6522 3a20 7661 6c75 657d 290a 2020 2020  e": value}).    
+00002e50: 0a20 2020 2040 6162 7374 7261 6374 6d65  .    @abstractme
+00002e60: 7468 6f64 0a20 2020 2064 6566 205f 6765  thod.    def _ge
+00002e70: 7428 7365 6c66 2c20 6b65 793a 2073 7472  t(self, key: str
+00002e80: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+00002e90: 6d54 7970 6520 3d20 4e6f 6e65 2920 2d3e  mType = None) ->
+00002ea0: 2055 6e69 6f6e 5b66 6c6f 6174 2c20 696e   Union[float, in
+00002eb0: 742c 2062 6f6f 6c2c 2073 7472 2c20 6c69  t, bool, str, li
+00002ec0: 7374 5d3a 0a20 2020 2020 2020 2070 6173  st]:.        pas
+00002ed0: 730a 2020 2020 2020 2020 0a20 2020 2040  s.        .    @
+00002ee0: 6162 7374 7261 6374 6d65 7468 6f64 0a20  abstractmethod. 
+00002ef0: 2020 2064 6566 205f 7365 7428 7365 6c66     def _set(self
+00002f00: 2c20 6b65 793a 2073 7472 2c20 7661 6c75  , key: str, valu
+00002f10: 652c 2062 6561 6d5f 7479 7065 3a20 4265  e, beam_type: Be
+00002f20: 616d 5479 7065 203d 204e 6f6e 6529 202d  amType = None) -
+00002f30: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00002f40: 7061 7373 0a20 2020 2020 2020 200a 2020  pass.        .  
+00002f50: 2020 0a20 2020 2023 2054 4f44 4f3a 2069    .    # TODO: i
+00002f60: 2064 6f6e 7420 7468 696e 6b20 7468 6973   dont think this
+00002f70: 2069 7320 6e65 6564 6564 2c20 796f 7520   is needed, you 
+00002f80: 7365 7420 7468 6520 6265 616d 2073 6574  set the beam set
+00002f90: 7469 6e67 7320 616e 6420 6465 7465 6374  tings and detect
+00002fa0: 6f72 2073 6574 7469 6e67 7320 7365 7061  or settings sepa
+00002fb0: 7261 7465 6c79 0a20 2020 2023 2079 6f75  rately.    # you
+00002fc0: 2063 616e 2774 2073 6574 2069 6d61 6765   can't set image
+00002fd0: 2073 6574 7469 6e67 732c 206f 6e6c 7920   settings, only 
+00002fe0: 7768 656e 2061 6371 7569 7269 6e67 2061  when acquiring a
+00002ff0: 6e20 696d 6167 650a 2020 2020 6465 6620  n image.    def 
+00003000: 6765 745f 696d 6167 696e 675f 7365 7474  get_imaging_sett
+00003010: 696e 6773 2873 656c 662c 2062 6561 6d5f  ings(self, beam_
+00003020: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+00003030: 2d3e 2049 6d61 6765 5365 7474 696e 6773  -> ImageSettings
+00003040: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
+00003050: 2074 6865 2063 7572 7265 6e74 2069 6d61   the current ima
+00003060: 6769 6e67 2073 6574 7469 6e67 7320 666f  ging settings fo
+00003070: 7220 7468 6520 7370 6563 6966 6965 6420  r the specified 
+00003080: 6265 616d 2074 7970 652e 2222 220a 2020  beam type.""".  
+00003090: 2020 2020 2020 2320 544f 444f 3a20 6669        # TODO: fi
+000030a0: 6e69 7368 2074 6869 7320 7769 7468 2074  nish this with t
+000030b0: 6865 206f 7468 6572 2069 6d61 6769 6e67  he other imaging
+000030c0: 2073 6574 7469 6e67 732e 2e2e 2040 7061   settings... @pa
+000030d0: 7472 6963 6b0a 2020 2020 2020 2020 6c6f  trick.        lo
+000030e0: 6767 696e 672e 6465 6275 6728 6622 4765  gging.debug(f"Ge
+000030f0: 7474 696e 6720 7b62 6561 6d5f 7479 7065  tting {beam_type
+00003100: 2e6e 616d 657d 2069 6d61 6769 6e67 2073  .name} imaging s
+00003110: 6574 7469 6e67 732e 2e2e 2229 0a20 2020  ettings...").   
+00003120: 2020 2020 2069 6d61 6765 5f73 6574 7469       image_setti
+00003130: 6e67 7320 3d20 496d 6167 6553 6574 7469  ngs = ImageSetti
+00003140: 6e67 7328 0a20 2020 2020 2020 2020 2020  ngs(.           
+00003150: 2062 6561 6d5f 7479 7065 3d62 6561 6d5f   beam_type=beam_
+00003160: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+00003170: 2020 7265 736f 6c75 7469 6f6e 3d73 656c    resolution=sel
+00003180: 662e 6765 7428 2272 6573 6f6c 7574 696f  f.get("resolutio
+00003190: 6e22 2c20 6265 616d 5f74 7970 6529 2c0a  n", beam_type),.
+000031a0: 2020 2020 2020 2020 2020 2020 6477 656c              dwel
+000031b0: 6c5f 7469 6d65 3d73 656c 662e 6765 7428  l_time=self.get(
+000031c0: 2264 7765 6c6c 5f74 696d 6522 2c20 6265  "dwell_time", be
+000031d0: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+000031e0: 2020 2020 2020 6866 773d 7365 6c66 2e67        hfw=self.g
+000031f0: 6574 2822 6866 7722 2c20 6265 616d 5f74  et("hfw", beam_t
+00003200: 7970 6529 2c0a 2020 2020 2020 2020 290a  ype),.        ).
+00003210: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00003220: 6465 6275 6728 7b22 6d73 6722 3a20 2267  debug({"msg": "g
+00003230: 6574 5f69 6d61 6769 6e67 5f73 6574 7469  et_imaging_setti
+00003240: 6e67 7322 2c20 2269 6d61 6765 5f73 6574  ngs", "image_set
+00003250: 7469 6e67 7322 3a20 696d 6167 655f 7365  tings": image_se
+00003260: 7474 696e 6773 2e74 6f5f 6469 6374 2829  ttings.to_dict()
+00003270: 2c20 2262 6561 6d5f 7479 7065 223a 2062  , "beam_type": b
+00003280: 6561 6d5f 7479 7065 2e6e 616d 657d 290a  eam_type.name}).
+00003290: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+000032a0: 6d61 6765 5f73 6574 7469 6e67 730a 0a20  mage_settings.. 
+000032b0: 2020 2064 6566 2073 6574 5f69 6d61 6769     def set_imagi
+000032c0: 6e67 5f73 6574 7469 6e67 7328 7365 6c66  ng_settings(self
+000032d0: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
+000032e0: 3a20 496d 6167 6553 6574 7469 6e67 7329  : ImageSettings)
+000032f0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00003300: 2020 2222 2253 6574 2074 6865 2069 6d61    """Set the ima
+00003310: 6769 6e67 2073 6574 7469 6e67 7320 666f  ging settings fo
+00003320: 7220 7468 6520 7370 6563 6966 6965 6420  r the specified 
+00003330: 6265 616d 2074 7970 652e 2222 220a 2020  beam type.""".  
+00003340: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00003350: 6275 6728 6622 5365 7474 696e 6720 7b69  bug(f"Setting {i
+00003360: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+00003370: 616d 5f74 7970 652e 6e61 6d65 7d20 696d  am_type.name} im
+00003380: 6167 696e 6720 7365 7474 696e 6773 2e2e  aging settings..
+00003390: 2e22 290a 2020 2020 2020 2020 7365 6c66  .").        self
+000033a0: 2e73 6574 2822 7265 736f 6c75 7469 6f6e  .set("resolution
+000033b0: 222c 2069 6d61 6765 5f73 6574 7469 6e67  ", image_setting
+000033c0: 732e 7265 736f 6c75 7469 6f6e 2c20 696d  s.resolution, im
+000033d0: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+000033e0: 6d5f 7479 7065 290a 2020 2020 2020 2020  m_type).        
+000033f0: 7365 6c66 2e73 6574 2822 6477 656c 6c5f  self.set("dwell_
+00003400: 7469 6d65 222c 2069 6d61 6765 5f73 6574  time", image_set
+00003410: 7469 6e67 732e 6477 656c 6c5f 7469 6d65  tings.dwell_time
+00003420: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
+00003430: 2e62 6561 6d5f 7479 7065 290a 2020 2020  .beam_type).    
+00003440: 2020 2020 7365 6c66 2e73 6574 2822 6866      self.set("hf
+00003450: 7722 2c20 696d 6167 655f 7365 7474 696e  w", image_settin
+00003460: 6773 2e68 6677 2c20 696d 6167 655f 7365  gs.hfw, image_se
+00003470: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
+00003480: 290a 2020 2020 2020 2020 2320 7365 6c66  ).        # self
+00003490: 2e73 6574 2822 6672 616d 655f 696e 7465  .set("frame_inte
+000034a0: 6772 6174 696f 6e22 2c20 696d 6167 655f  gration", image_
+000034b0: 7365 7474 696e 6773 2e66 7261 6d65 5f69  settings.frame_i
+000034c0: 6e74 6567 7261 7469 6f6e 2c20 696d 6167  ntegration, imag
+000034d0: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
+000034e0: 7479 7065 290a 2020 2020 2020 2020 2320  type).        # 
+000034f0: 7365 6c66 2e73 6574 2822 6c69 6e65 5f69  self.set("line_i
+00003500: 6e74 6567 7261 7469 6f6e 222c 2069 6d61  ntegration", ima
+00003510: 6765 5f73 6574 7469 6e67 732e 6c69 6e65  ge_settings.line
+00003520: 5f69 6e74 6567 7261 7469 6f6e 2c20 696d  _integration, im
+00003530: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+00003540: 6d5f 7479 7065 290a 2020 2020 2020 2020  m_type).        
+00003550: 2320 7365 6c66 2e73 6574 2822 7363 616e  # self.set("scan
+00003560: 5f69 6e74 6572 6c61 6369 6e67 222c 2069  _interlacing", i
+00003570: 6d61 6765 5f73 6574 7469 6e67 732e 7363  mage_settings.sc
+00003580: 616e 5f69 6e74 6572 6c61 6369 6e67 2c20  an_interlacing, 
+00003590: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
+000035a0: 6561 6d5f 7479 7065 290a 2020 2020 2020  eam_type).      
+000035b0: 2020 2320 7365 6c66 2e73 6574 2822 6472    # self.set("dr
+000035c0: 6966 745f 636f 7272 6563 7469 6f6e 222c  ift_correction",
+000035d0: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
+000035e0: 6472 6966 745f 636f 7272 6563 7469 6f6e  drift_correction
+000035f0: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
+00003600: 2e62 6561 6d5f 7479 7065 290a 2020 2020  .beam_type).    
+00003610: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00003620: 2023 2054 4f44 4f3a 2069 6d70 6c65 6d65   # TODO: impleme
+00003630: 6e74 2074 6865 2072 6573 7420 6f66 2074  nt the rest of t
+00003640: 6865 7365 2073 6574 7469 6e67 732e 2e2e  hese settings...
+00003650: 2040 7061 7472 6963 6b0a 2020 2020 2020   @patrick.      
+00003660: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
+00003670: 7b22 6d73 6722 3a20 2273 6574 5f69 6d61  {"msg": "set_ima
+00003680: 6769 6e67 5f73 6574 7469 6e67 7322 2c20  ging_settings", 
+00003690: 2269 6d61 6765 5f73 6574 7469 6e67 7322  "image_settings"
+000036a0: 3a20 696d 6167 655f 7365 7474 696e 6773  : image_settings
+000036b0: 2e74 6f5f 6469 6374 2829 2c20 2262 6561  .to_dict(), "bea
+000036c0: 6d5f 7479 7065 223a 2069 6d61 6765 5f73  m_type": image_s
+000036d0: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
+000036e0: 652e 6e61 6d65 7d29 0a0a 2020 2020 2020  e.name})..      
+000036f0: 2020 7265 7475 726e 200a 0a20 2020 2064    return ..    d
+00003700: 6566 2067 6574 5f62 6561 6d5f 7365 7474  ef get_beam_sett
+00003710: 696e 6773 2873 656c 662c 2062 6561 6d5f  ings(self, beam_
+00003720: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+00003730: 2d3e 2042 6561 6d53 6574 7469 6e67 733a  -> BeamSettings:
+00003740: 0a20 2020 2020 2020 2022 2222 4765 7420  .        """Get 
+00003750: 7468 6520 6375 7272 656e 7420 6265 616d  the current beam
+00003760: 2073 6574 7469 6e67 7320 666f 7220 7468   settings for th
+00003770: 6520 7370 6563 6966 6965 6420 6265 616d  e specified beam
+00003780: 2074 7970 652e 0a20 2020 2020 2020 2022   type..        "
+00003790: 2222 0a0a 2020 2020 2020 2020 6c6f 6767  ""..        logg
+000037a0: 696e 672e 6465 6275 6728 6622 4765 7474  ing.debug(f"Gett
+000037b0: 696e 6720 7b62 6561 6d5f 7479 7065 2e6e  ing {beam_type.n
+000037c0: 616d 657d 2062 6561 6d20 7365 7474 696e  ame} beam settin
+000037d0: 6773 2e2e 2e22 290a 2020 2020 2020 2020  gs...").        
+000037e0: 6265 616d 5f73 6574 7469 6e67 7320 3d20  beam_settings = 
+000037f0: 4265 616d 5365 7474 696e 6773 280a 2020  BeamSettings(.  
+00003800: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
+00003810: 7970 653d 6265 616d 5f74 7970 652c 0a20  ype=beam_type,. 
+00003820: 2020 2020 2020 2020 2020 2077 6f72 6b69             worki
+00003830: 6e67 5f64 6973 7461 6e63 653d 7365 6c66  ng_distance=self
+00003840: 2e67 6574 2822 776f 726b 696e 675f 6469  .get("working_di
+00003850: 7374 616e 6365 222c 2062 6561 6d5f 7479  stance", beam_ty
+00003860: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
+00003870: 2062 6561 6d5f 6375 7272 656e 743d 7365   beam_current=se
+00003880: 6c66 2e67 6574 2822 6375 7272 656e 7422  lf.get("current"
+00003890: 2c20 6265 616d 5f74 7970 6529 2c0a 2020  , beam_type),.  
+000038a0: 2020 2020 2020 2020 2020 766f 6c74 6167            voltag
+000038b0: 653d 7365 6c66 2e67 6574 2822 766f 6c74  e=self.get("volt
+000038c0: 6167 6522 2c20 6265 616d 5f74 7970 6529  age", beam_type)
+000038d0: 2c0a 2020 2020 2020 2020 2020 2020 6866  ,.            hf
+000038e0: 773d 7365 6c66 2e67 6574 2822 6866 7722  w=self.get("hfw"
+000038f0: 2c20 6265 616d 5f74 7970 6529 2c0a 2020  , beam_type),.  
+00003900: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
+00003910: 7469 6f6e 3d73 656c 662e 6765 7428 2272  tion=self.get("r
+00003920: 6573 6f6c 7574 696f 6e22 2c20 6265 616d  esolution", beam
+00003930: 5f74 7970 6529 2c20 200a 2020 2020 2020  _type),  .      
+00003940: 2020 2020 2020 6477 656c 6c5f 7469 6d65        dwell_time
+00003950: 3d73 656c 662e 6765 7428 2264 7765 6c6c  =self.get("dwell
+00003960: 5f74 696d 6522 202c 2062 6561 6d5f 7479  _time" , beam_ty
+00003970: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
+00003980: 2073 7469 676d 6174 696f 6e3d 7365 6c66   stigmation=self
+00003990: 2e67 6574 2822 7374 6967 6d61 7469 6f6e  .get("stigmation
+000039a0: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
+000039b0: 2020 2020 2020 2020 2020 2073 6869 6674             shift
+000039c0: 3d73 656c 662e 6765 7428 2273 6869 6674  =self.get("shift
+000039d0: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
+000039e0: 2020 2020 2020 2020 2020 2073 6361 6e5f             scan_
+000039f0: 726f 7461 7469 6f6e 3d73 656c 662e 6765  rotation=self.ge
+00003a00: 7428 2273 6361 6e5f 726f 7461 7469 6f6e  t("scan_rotation
+00003a10: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
+00003a20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00003a30: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
+00003a40: 226d 7367 223a 2022 6765 745f 6265 616d  "msg": "get_beam
+00003a50: 5f73 6574 7469 6e67 7322 2c20 2262 6561  _settings", "bea
+00003a60: 6d5f 7365 7474 696e 6773 223a 2062 6561  m_settings": bea
+00003a70: 6d5f 7365 7474 696e 6773 2e74 6f5f 6469  m_settings.to_di
+00003a80: 6374 2829 2c20 2262 6561 6d5f 7479 7065  ct(), "beam_type
+00003a90: 223a 2062 6561 6d5f 7479 7065 2e6e 616d  ": beam_type.nam
+00003aa0: 657d 290a 2020 2020 2020 2020 0a20 2020  e}).        .   
+00003ab0: 2020 2020 2072 6574 7572 6e20 6265 616d       return beam
+00003ac0: 5f73 6574 7469 6e67 730a 2020 2020 2020  _settings.      
+00003ad0: 2020 0a20 2020 2064 6566 2073 6574 5f62    .    def set_b
+00003ae0: 6561 6d5f 7365 7474 696e 6773 2873 656c  eam_settings(sel
+00003af0: 662c 2062 6561 6d5f 7365 7474 696e 6773  f, beam_settings
+00003b00: 3a20 4265 616d 5365 7474 696e 6773 2920  : BeamSettings) 
+00003b10: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00003b20: 2022 2222 5365 7420 7468 6520 6265 616d   """Set the beam
+00003b30: 2073 6574 7469 6e67 7320 666f 7220 7468   settings for th
+00003b40: 6520 7370 6563 6966 6965 6420 6265 616d  e specified beam
+00003b50: 2074 7970 6522 2222 0a20 2020 2020 2020   type""".       
+00003b60: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
+00003b70: 2253 6574 7469 6e67 207b 6265 616d 5f73  "Setting {beam_s
+00003b80: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
+00003b90: 652e 6e61 6d65 7d20 6265 616d 2073 6574  e.name} beam set
+00003ba0: 7469 6e67 732e 2e2e 2229 0a20 2020 2020  tings...").     
+00003bb0: 2020 2073 656c 662e 7365 7428 2277 6f72     self.set("wor
+00003bc0: 6b69 6e67 5f64 6973 7461 6e63 6522 2c20  king_distance", 
+00003bd0: 6265 616d 5f73 6574 7469 6e67 732e 776f  beam_settings.wo
+00003be0: 726b 696e 675f 6469 7374 616e 6365 2c20  rking_distance, 
+00003bf0: 6265 616d 5f73 6574 7469 6e67 732e 6265  beam_settings.be
+00003c00: 616d 5f74 7970 6529 0a20 2020 2020 2020  am_type).       
+00003c10: 2073 656c 662e 7365 7428 2263 7572 7265   self.set("curre
+00003c20: 6e74 222c 2062 6561 6d5f 7365 7474 696e  nt", beam_settin
+00003c30: 6773 2e62 6561 6d5f 6375 7272 656e 742c  gs.beam_current,
+00003c40: 2062 6561 6d5f 7365 7474 696e 6773 2e62   beam_settings.b
+00003c50: 6561 6d5f 7479 7065 290a 2020 2020 2020  eam_type).      
+00003c60: 2020 7365 6c66 2e73 6574 2822 766f 6c74    self.set("volt
+00003c70: 6167 6522 2c20 6265 616d 5f73 6574 7469  age", beam_setti
+00003c80: 6e67 732e 766f 6c74 6167 652c 2062 6561  ngs.voltage, bea
+00003c90: 6d5f 7365 7474 696e 6773 2e62 6561 6d5f  m_settings.beam_
+00003ca0: 7479 7065 290a 2020 2020 2020 2020 7365  type).        se
+00003cb0: 6c66 2e73 6574 2822 6866 7722 2c20 6265  lf.set("hfw", be
+00003cc0: 616d 5f73 6574 7469 6e67 732e 6866 772c  am_settings.hfw,
+00003cd0: 2062 6561 6d5f 7365 7474 696e 6773 2e62   beam_settings.b
+00003ce0: 6561 6d5f 7479 7065 290a 2020 2020 2020  eam_type).      
+00003cf0: 2020 7365 6c66 2e73 6574 2822 7265 736f    self.set("reso
+00003d00: 6c75 7469 6f6e 222c 2062 6561 6d5f 7365  lution", beam_se
+00003d10: 7474 696e 6773 2e72 6573 6f6c 7574 696f  ttings.resolutio
+00003d20: 6e2c 2062 6561 6d5f 7365 7474 696e 6773  n, beam_settings
+00003d30: 2e62 6561 6d5f 7479 7065 290a 2020 2020  .beam_type).    
+00003d40: 2020 2020 7365 6c66 2e73 6574 2822 6477      self.set("dw
+00003d50: 656c 6c5f 7469 6d65 222c 2062 6561 6d5f  ell_time", beam_
+00003d60: 7365 7474 696e 6773 2e64 7765 6c6c 5f74  settings.dwell_t
+00003d70: 696d 652c 2062 6561 6d5f 7365 7474 696e  ime, beam_settin
+00003d80: 6773 2e62 6561 6d5f 7479 7065 290a 2020  gs.beam_type).  
+00003d90: 2020 2020 2020 7365 6c66 2e73 6574 2822        self.set("
+00003da0: 7374 6967 6d61 7469 6f6e 222c 2062 6561  stigmation", bea
+00003db0: 6d5f 7365 7474 696e 6773 2e73 7469 676d  m_settings.stigm
+00003dc0: 6174 696f 6e2c 2062 6561 6d5f 7365 7474  ation, beam_sett
+00003dd0: 696e 6773 2e62 6561 6d5f 7479 7065 290a  ings.beam_type).
+00003de0: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
+00003df0: 2822 7368 6966 7422 2c20 6265 616d 5f73  ("shift", beam_s
+00003e00: 6574 7469 6e67 732e 7368 6966 742c 2062  ettings.shift, b
+00003e10: 6561 6d5f 7365 7474 696e 6773 2e62 6561  eam_settings.bea
+00003e20: 6d5f 7479 7065 290a 2020 2020 2020 2020  m_type).        
+00003e30: 7365 6c66 2e73 6574 2822 7363 616e 5f72  self.set("scan_r
+00003e40: 6f74 6174 696f 6e22 2c20 6265 616d 5f73  otation", beam_s
+00003e50: 6574 7469 6e67 732e 7363 616e 5f72 6f74  ettings.scan_rot
+00003e60: 6174 696f 6e2c 2062 6561 6d5f 7365 7474  ation, beam_sett
+00003e70: 696e 6773 2e62 6561 6d5f 7479 7065 290a  ings.beam_type).
+00003e80: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00003e90: 2e64 6562 7567 287b 226d 7367 223a 2022  .debug({"msg": "
+00003ea0: 7365 745f 6265 616d 5f73 6574 7469 6e67  set_beam_setting
+00003eb0: 7322 2c20 2262 6561 6d5f 7365 7474 696e  s", "beam_settin
+00003ec0: 6773 223a 2062 6561 6d5f 7365 7474 696e  gs": beam_settin
+00003ed0: 6773 2e74 6f5f 6469 6374 2829 2c20 2262  gs.to_dict(), "b
+00003ee0: 6561 6d5f 7479 7065 223a 2062 6561 6d5f  eam_type": beam_
+00003ef0: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
+00003f00: 7065 2e6e 616d 657d 290a 2020 2020 2020  pe.name}).      
+00003f10: 2020 7265 7475 726e 200a 2020 2020 2020    return .      
+00003f20: 2020 0a20 2020 2064 6566 2067 6574 5f62    .    def get_b
+00003f30: 6561 6d5f 7379 7374 656d 5f73 6574 7469  eam_system_setti
+00003f40: 6e67 7328 7365 6c66 2c20 6265 616d 5f74  ngs(self, beam_t
+00003f50: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
+00003f60: 3e20 4265 616d 5379 7374 656d 5365 7474  > BeamSystemSett
+00003f70: 696e 6773 3a0a 2020 2020 2020 2020 2222  ings:.        ""
+00003f80: 2247 6574 2074 6865 2063 7572 7265 6e74  "Get the current
+00003f90: 2062 6561 6d20 7379 7374 656d 2073 6574   beam system set
+00003fa0: 7469 6e67 7320 666f 7220 7468 6520 7370  tings for the sp
+00003fb0: 6563 6966 6965 6420 6265 616d 2074 7970  ecified beam typ
+00003fc0: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
+00003fd0: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00003fe0: 6562 7567 2866 2247 6574 7469 6e67 207b  ebug(f"Getting {
+00003ff0: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
+00004000: 6265 616d 2073 7973 7465 6d20 7365 7474  beam system sett
+00004010: 696e 6773 2e2e 2e22 290a 2020 2020 2020  ings...").      
+00004020: 2020 6265 616d 5f73 7973 7465 6d5f 7365    beam_system_se
+00004030: 7474 696e 6773 203d 2042 6561 6d53 7973  ttings = BeamSys
+00004040: 7465 6d53 6574 7469 6e67 7328 0a20 2020  temSettings(.   
+00004050: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
+00004060: 7065 3d62 6561 6d5f 7479 7065 2c0a 2020  pe=beam_type,.  
+00004070: 2020 2020 2020 2020 2020 656e 6162 6c65            enable
+00004080: 643d 7365 6c66 2e67 6574 2822 6265 616d  d=self.get("beam
+00004090: 5f65 6e61 626c 6564 222c 2062 6561 6d5f  _enabled", beam_
+000040a0: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
+000040b0: 2020 2062 6561 6d3d 7365 6c66 2e67 6574     beam=self.get
+000040c0: 5f62 6561 6d5f 7365 7474 696e 6773 2862  _beam_settings(b
+000040d0: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
+000040e0: 2020 2020 2020 2064 6574 6563 746f 723d         detector=
+000040f0: 7365 6c66 2e67 6574 5f64 6574 6563 746f  self.get_detecto
+00004100: 725f 7365 7474 696e 6773 2862 6561 6d5f  r_settings(beam_
+00004110: 7479 7065 292c 0a20 2020 2020 2020 2020  type),.         
+00004120: 2020 2065 7563 656e 7472 6963 5f68 6569     eucentric_hei
+00004130: 6768 743d 7365 6c66 2e67 6574 2822 6575  ght=self.get("eu
+00004140: 6365 6e74 7269 635f 6865 6967 6874 222c  centric_height",
+00004150: 2062 6561 6d5f 7479 7065 292c 0a20 2020   beam_type),.   
+00004160: 2020 2020 2020 2020 2063 6f6c 756d 6e5f           column_
+00004170: 7469 6c74 3d73 656c 662e 6765 7428 2263  tilt=self.get("c
+00004180: 6f6c 756d 6e5f 7469 6c74 222c 2062 6561  olumn_tilt", bea
+00004190: 6d5f 7479 7065 292c 0a20 2020 2020 2020  m_type),.       
+000041a0: 2020 2020 2070 6c61 736d 613d 7365 6c66       plasma=self
+000041b0: 2e67 6574 2822 706c 6173 6d61 222c 2062  .get("plasma", b
+000041c0: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
+000041d0: 2020 2020 2020 2070 6c61 736d 615f 6761         plasma_ga
+000041e0: 733d 7365 6c66 2e67 6574 2822 706c 6173  s=self.get("plas
+000041f0: 6d61 5f67 6173 222c 2062 6561 6d5f 7479  ma_gas", beam_ty
+00004200: 7065 292c 0a20 2020 2020 2020 2029 2020  pe),.        )  
+00004210: 2020 2020 0a20 2020 2020 2020 200a 2020      .        .  
+00004220: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00004230: 6275 6728 7b22 6d73 6722 3a20 2267 6574  bug({"msg": "get
+00004240: 5f62 6561 6d5f 7379 7374 656d 5f73 6574  _beam_system_set
+00004250: 7469 6e67 7322 2c20 2273 6574 7469 6e67  tings", "setting
+00004260: 7322 3a20 6265 616d 5f73 7973 7465 6d5f  s": beam_system_
+00004270: 7365 7474 696e 6773 2e74 6f5f 6469 6374  settings.to_dict
+00004280: 2829 2c20 2262 6561 6d5f 7479 7065 223a  (), "beam_type":
+00004290: 2062 6561 6d5f 7479 7065 2e6e 616d 657d   beam_type.name}
+000042a0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+000042b0: 2062 6561 6d5f 7379 7374 656d 5f73 6574   beam_system_set
+000042c0: 7469 6e67 730a 2020 2020 2020 2020 0a20  tings.        . 
+000042d0: 2020 2064 6566 2073 6574 5f62 6561 6d5f     def set_beam_
+000042e0: 7379 7374 656d 5f73 6574 7469 6e67 7328  system_settings(
+000042f0: 7365 6c66 2c20 7365 7474 696e 6773 3a20  self, settings: 
+00004300: 4265 616d 5379 7374 656d 5365 7474 696e  BeamSystemSettin
+00004310: 6773 2920 2d3e 204e 6f6e 653a 0a20 2020  gs) -> None:.   
+00004320: 2020 2020 2022 2222 5365 7420 7468 6520       """Set the 
+00004330: 6265 616d 2073 7973 7465 6d20 7365 7474  beam system sett
+00004340: 696e 6773 2066 6f72 2074 6865 2073 7065  ings for the spe
+00004350: 6369 6669 6564 2062 6561 6d20 7479 7065  cified beam type
+00004360: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00004370: 2020 2020 2020 6265 616d 5f74 7970 6520        beam_type 
+00004380: 3d20 7365 7474 696e 6773 2e62 6561 6d5f  = settings.beam_
+00004390: 7479 7065 0a20 2020 2020 2020 206c 6f67  type.        log
+000043a0: 6769 6e67 2e64 6562 7567 2866 2253 6574  ging.debug(f"Set
+000043b0: 7469 6e67 207b 7365 7474 696e 6773 2e62  ting {settings.b
+000043c0: 6561 6d5f 7479 7065 2e6e 616d 657d 2062  eam_type.name} b
+000043d0: 6561 6d20 7379 7374 656d 2073 6574 7469  eam system setti
+000043e0: 6e67 732e 2e2e 2229 0a20 2020 2020 2020  ngs...").       
+000043f0: 2073 656c 662e 7365 7428 2262 6561 6d5f   self.set("beam_
+00004400: 656e 6162 6c65 6422 2c20 7365 7474 696e  enabled", settin
+00004410: 6773 2e65 6e61 626c 6564 2c20 6265 616d  gs.enabled, beam
+00004420: 5f74 7970 6529 0a20 2020 2020 2020 2073  _type).        s
+00004430: 656c 662e 7365 745f 6265 616d 5f73 6574  elf.set_beam_set
+00004440: 7469 6e67 7328 7365 7474 696e 6773 2e62  tings(settings.b
+00004450: 6561 6d29 0a20 2020 2020 2020 2073 656c  eam).        sel
+00004460: 662e 7365 745f 6465 7465 6374 6f72 5f73  f.set_detector_s
+00004470: 6574 7469 6e67 7328 7365 7474 696e 6773  ettings(settings
+00004480: 2e64 6574 6563 746f 722c 2062 6561 6d5f  .detector, beam_
+00004490: 7479 7065 290a 2020 2020 2020 2020 7365  type).        se
+000044a0: 6c66 2e73 6574 2822 6575 6365 6e74 7269  lf.set("eucentri
+000044b0: 635f 6865 6967 6874 222c 2073 6574 7469  c_height", setti
+000044c0: 6e67 732e 6575 6365 6e74 7269 635f 6865  ngs.eucentric_he
+000044d0: 6967 6874 2c20 6265 616d 5f74 7970 6529  ight, beam_type)
+000044e0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+000044f0: 7428 2263 6f6c 756d 6e5f 7469 6c74 222c  t("column_tilt",
+00004500: 2073 6574 7469 6e67 732e 636f 6c75 6d6e   settings.column
+00004510: 5f74 696c 742c 2062 6561 6d5f 7479 7065  _tilt, beam_type
+00004520: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+00004530: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
+00004540: 6973 2042 6561 6d54 7970 652e 494f 4e3a  is BeamType.ION:
+00004550: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00004560: 662e 7365 7428 2270 6c61 736d 615f 6761  f.set("plasma_ga
+00004570: 7322 2c20 7365 7474 696e 6773 2e70 6c61  s", settings.pla
+00004580: 736d 615f 6761 732c 2062 6561 6d5f 7479  sma_gas, beam_ty
+00004590: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
+000045a0: 7365 6c66 2e73 6574 2822 706c 6173 6d61  self.set("plasma
+000045b0: 222c 2073 6574 7469 6e67 732e 706c 6173  ", settings.plas
+000045c0: 6d61 2c20 6265 616d 5f74 7970 6529 0a0a  ma, beam_type)..
+000045d0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000045e0: 6465 6275 6728 207b 226d 7367 223a 2022  debug( {"msg": "
+000045f0: 7365 745f 6265 616d 5f73 7973 7465 6d5f  set_beam_system_
+00004600: 7365 7474 696e 6773 222c 2022 7365 7474  settings", "sett
+00004610: 696e 6773 223a 2073 6574 7469 6e67 732e  ings": settings.
+00004620: 746f 5f64 6963 7428 292c 2022 6265 616d  to_dict(), "beam
+00004630: 5f74 7970 6522 3a20 6265 616d 5f74 7970  _type": beam_typ
+00004640: 652e 6e61 6d65 7d29 0a20 2020 200a 2020  e.name}).    .  
+00004650: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00004660: 2020 6465 6620 6765 745f 6465 7465 6374    def get_detect
+00004670: 6f72 5f73 6574 7469 6e67 7328 7365 6c66  or_settings(self
+00004680: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+00004690: 6d54 7970 6520 3d20 4265 616d 5479 7065  mType = BeamType
+000046a0: 2e45 4c45 4354 524f 4e29 202d 3e20 4669  .ELECTRON) -> Fi
+000046b0: 6273 656d 4465 7465 6374 6f72 5365 7474  bsemDetectorSett
+000046c0: 696e 6773 3a0a 2020 2020 2020 2020 2222  ings:.        ""
+000046d0: 2247 6574 2074 6865 2063 7572 7265 6e74  "Get the current
+000046e0: 2064 6574 6563 746f 7220 7365 7474 696e   detector settin
+000046f0: 6773 2066 6f72 2074 6865 2073 7065 6369  gs for the speci
+00004700: 6669 6564 2062 6561 6d20 7479 7065 2e0a  fied beam type..
+00004710: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00004720: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+00004730: 6728 6622 4765 7474 696e 6720 7b62 6561  g(f"Getting {bea
+00004740: 6d5f 7479 7065 2e6e 616d 657d 2064 6574  m_type.name} det
+00004750: 6563 746f 7220 7365 7474 696e 6773 2e2e  ector settings..
+00004760: 2e22 290a 2020 2020 2020 2020 6465 7465  .").        dete
+00004770: 6374 6f72 5f73 6574 7469 6e67 7320 3d20  ctor_settings = 
+00004780: 4669 6273 656d 4465 7465 6374 6f72 5365  FibsemDetectorSe
+00004790: 7474 696e 6773 280a 2020 2020 2020 2020  ttings(.        
+000047a0: 2020 2020 7479 7065 3d73 656c 662e 6765      type=self.ge
+000047b0: 7428 2264 6574 6563 746f 725f 7479 7065  t("detector_type
+000047c0: 222c 2062 6561 6d5f 7479 7065 292c 0a20  ", beam_type),. 
+000047d0: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
+000047e0: 7365 6c66 2e67 6574 2822 6465 7465 6374  self.get("detect
+000047f0: 6f72 5f6d 6f64 6522 2c20 6265 616d 5f74  or_mode", beam_t
+00004800: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
+00004810: 2020 6272 6967 6874 6e65 7373 3d73 656c    brightness=sel
+00004820: 662e 6765 7428 2264 6574 6563 746f 725f  f.get("detector_
+00004830: 6272 6967 6874 6e65 7373 222c 2062 6561  brightness", bea
+00004840: 6d5f 7479 7065 292c 0a20 2020 2020 2020  m_type),.       
+00004850: 2020 2020 2063 6f6e 7472 6173 743d 7365       contrast=se
+00004860: 6c66 2e67 6574 2822 6465 7465 6374 6f72  lf.get("detector
+00004870: 5f63 6f6e 7472 6173 7422 2c20 6265 616d  _contrast", beam
+00004880: 5f74 7970 6529 2c0a 2020 2020 2020 2020  _type),.        
+00004890: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+000048a0: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
+000048b0: 2267 6574 5f64 6574 6563 746f 725f 7365  "get_detector_se
+000048c0: 7474 696e 6773 222c 2022 6465 7465 6374  ttings", "detect
+000048d0: 6f72 5f73 6574 7469 6e67 7322 3a20 6465  or_settings": de
 000048e0: 7465 6374 6f72 5f73 6574 7469 6e67 732e  tector_settings.
-000048f0: 636f 6e74 7261 7374 2c20 6265 616d 5f74  contrast, beam_t
-00004900: 7970 6529 0a20 2020 2020 2020 206c 6f67  ype).        log
-00004910: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
-00004920: 223a 2022 7365 745f 6465 7465 6374 6f72  ": "set_detector
-00004930: 5f73 6574 7469 6e67 7322 2c20 2264 6574  _settings", "det
-00004940: 6563 746f 725f 7365 7474 696e 6773 223a  ector_settings":
-00004950: 2064 6574 6563 746f 725f 7365 7474 696e   detector_settin
-00004960: 6773 2e74 6f5f 6469 6374 2829 2c20 2262  gs.to_dict(), "b
-00004970: 6561 6d5f 7479 7065 223a 2062 6561 6d5f  eam_type": beam_
-00004980: 7479 7065 2e6e 616d 657d 290a 2020 2020  type.name}).    
-00004990: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-000049a0: 0a20 2020 2064 6566 2067 6574 5f6d 6963  .    def get_mic
-000049b0: 726f 7363 6f70 655f 7374 6174 6528 7365  roscope_state(se
-000049c0: 6c66 2c20 6265 616d 5f74 7970 653a 2042  lf, beam_type: B
-000049d0: 6561 6d54 7970 6520 3d20 4e6f 6e65 2920  eamType = None) 
-000049e0: 2d3e 204d 6963 726f 7363 6f70 6553 7461  -> MicroscopeSta
-000049f0: 7465 3a0a 2020 2020 2020 2020 2222 2247  te:.        """G
-00004a00: 6574 2074 6865 2063 7572 7265 6e74 206d  et the current m
-00004a10: 6963 726f 7363 6f70 6520 7374 6174 652e  icroscope state.
-00004a20: 2222 220a 0a20 2020 2020 2020 2023 2064  """..        # d
-00004a30: 6566 6175 6c74 2076 616c 7565 730a 2020  efault values.  
-00004a40: 2020 2020 2020 656c 6563 7472 6f6e 5f62        electron_b
-00004a50: 6561 6d2c 2065 6c65 6374 726f 6e5f 6465  eam, electron_de
-00004a60: 7465 6374 6f72 203d 204e 6f6e 652c 204e  tector = None, N
-00004a70: 6f6e 650a 2020 2020 2020 2020 696f 6e5f  one.        ion_
-00004a80: 6265 616d 2c20 696f 6e5f 6465 7465 6374  beam, ion_detect
-00004a90: 6f72 203d 204e 6f6e 652c 204e 6f6e 650a  or = None, None.
-00004aa0: 2020 2020 2020 2020 7374 6167 655f 706f          stage_po
-00004ab0: 7369 7469 6f6e 203d 204e 6f6e 650a 2020  sition = None.  
-00004ac0: 2020 2020 2020 6765 745f 656c 6563 7472        get_electr
-00004ad0: 6f6e 5f73 7461 7465 203d 2062 6561 6d5f  on_state = beam_
-00004ae0: 7479 7065 2069 6e20 5b42 6561 6d54 7970  type in [BeamTyp
-00004af0: 652e 454c 4543 5452 4f4e 2c20 4e6f 6e65  e.ELECTRON, None
-00004b00: 5d0a 2020 2020 2020 2020 6765 745f 696f  ].        get_io
-00004b10: 6e5f 7374 6174 6520 3d20 6265 616d 5f74  n_state = beam_t
-00004b20: 7970 6520 696e 205b 4265 616d 5479 7065  ype in [BeamType
-00004b30: 2e49 4f4e 2c20 4e6f 6e65 5d0a 0a20 2020  .ION, None]..   
-00004b40: 2020 2020 2023 2067 6574 2074 6865 2073       # get the s
-00004b50: 7461 7465 206f 6620 7468 6520 656c 6563  tate of the elec
-00004b60: 7472 6f6e 2062 6561 6d0a 2020 2020 2020  tron beam.      
-00004b70: 2020 6966 2073 656c 662e 6973 5f61 7661    if self.is_ava
-00004b80: 696c 6162 6c65 2822 656c 6563 7472 6f6e  ilable("electron
-00004b90: 5f62 6561 6d22 2920 616e 6420 6765 745f  _beam") and get_
-00004ba0: 656c 6563 7472 6f6e 5f73 7461 7465 3a0a  electron_state:.
-00004bb0: 2020 2020 2020 2020 2020 2020 656c 6563              elec
-00004bc0: 7472 6f6e 5f62 6561 6d20 3d20 7365 6c66  tron_beam = self
-00004bd0: 2e67 6574 5f62 6561 6d5f 7365 7474 696e  .get_beam_settin
-00004be0: 6773 2862 6561 6d5f 7479 7065 3d42 6561  gs(beam_type=Bea
-00004bf0: 6d54 7970 652e 454c 4543 5452 4f4e 290a  mType.ELECTRON).
-00004c00: 2020 2020 2020 2020 2020 2020 656c 6563              elec
-00004c10: 7472 6f6e 5f64 6574 6563 746f 7220 3d20  tron_detector = 
-00004c20: 7365 6c66 2e67 6574 5f64 6574 6563 746f  self.get_detecto
-00004c30: 725f 7365 7474 696e 6773 2862 6561 6d5f  r_settings(beam_
-00004c40: 7479 7065 3d42 6561 6d54 7970 652e 454c  type=BeamType.EL
-00004c50: 4543 5452 4f4e 290a 200a 2020 2020 2020  ECTRON). .      
-00004c60: 2020 2320 6765 7420 7468 6520 7374 6174    # get the stat
-00004c70: 6520 6f66 2074 6865 2069 6f6e 2062 6561  e of the ion bea
-00004c80: 6d20 2020 2020 2020 200a 2020 2020 2020  m        .      
-00004c90: 2020 6966 2073 656c 662e 6973 5f61 7661    if self.is_ava
-00004ca0: 696c 6162 6c65 2822 696f 6e5f 6265 616d  ilable("ion_beam
-00004cb0: 2229 2061 6e64 2067 6574 5f69 6f6e 5f73  ") and get_ion_s
-00004cc0: 7461 7465 3a0a 2020 2020 2020 2020 2020  tate:.          
-00004cd0: 2020 696f 6e5f 6265 616d 203d 2073 656c    ion_beam = sel
-00004ce0: 662e 6765 745f 6265 616d 5f73 6574 7469  f.get_beam_setti
-00004cf0: 6e67 7328 6265 616d 5f74 7970 653d 4265  ngs(beam_type=Be
-00004d00: 616d 5479 7065 2e49 4f4e 290a 2020 2020  amType.ION).    
-00004d10: 2020 2020 2020 2020 696f 6e5f 6465 7465          ion_dete
-00004d20: 6374 6f72 203d 2073 656c 662e 6765 745f  ctor = self.get_
-00004d30: 6465 7465 6374 6f72 5f73 6574 7469 6e67  detector_setting
-00004d40: 7328 6265 616d 5f74 7970 653d 4265 616d  s(beam_type=Beam
-00004d50: 5479 7065 2e49 4f4e 290a 0a20 2020 2020  Type.ION)..     
-00004d60: 2020 2023 2067 6574 2074 6865 2073 7461     # get the sta
-00004d70: 7465 206f 6620 7468 6520 7374 6167 650a  te of the stage.
-00004d80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00004d90: 6973 5f61 7661 696c 6162 6c65 2822 7374  is_available("st
-00004da0: 6167 6522 293a 0a20 2020 2020 2020 2020  age"):.         
-00004db0: 2020 2073 7461 6765 5f70 6f73 6974 696f     stage_positio
-00004dc0: 6e20 3d20 7365 6c66 2e67 6574 5f73 7461  n = self.get_sta
-00004dd0: 6765 5f70 6f73 6974 696f 6e28 2920 2020  ge_position()   
-00004de0: 2020 2020 0a0a 2020 2020 2020 2020 6375      ..        cu
-00004df0: 7272 656e 745f 6d69 6372 6f73 636f 7065  rrent_microscope
-00004e00: 5f73 7461 7465 203d 204d 6963 726f 7363  _state = Microsc
-00004e10: 6f70 6553 7461 7465 280a 2020 2020 2020  opeState(.      
-00004e20: 2020 2020 2020 7469 6d65 7374 616d 703d        timestamp=
-00004e30: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-00004e40: 652e 7469 6d65 7374 616d 7028 6461 7465  e.timestamp(date
-00004e50: 7469 6d65 2e64 6174 6574 696d 652e 6e6f  time.datetime.no
-00004e60: 7728 2929 2c0a 2020 2020 2020 2020 2020  w()),.          
-00004e70: 2020 7374 6167 655f 706f 7369 7469 6f6e    stage_position
-00004e80: 3d73 7461 6765 5f70 6f73 6974 696f 6e2c  =stage_position,
-00004e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004eb0: 2020 2320 6765 7420 6162 736f 6c75 7465    # get absolute
-00004ec0: 2073 7461 6765 2063 6f6f 7264 696e 6174   stage coordinat
-00004ed0: 6573 2028 5241 5729 0a20 2020 2020 2020  es (RAW).       
-00004ee0: 2020 2020 2065 6c65 6374 726f 6e5f 6265       electron_be
-00004ef0: 616d 3d65 6c65 6374 726f 6e5f 6265 616d  am=electron_beam
-00004f00: 2c20 2020 2020 2020 2020 2020 2020 2020  ,               
-00004f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f20: 2020 2020 2023 2065 6c65 6374 726f 6e20       # electron 
-00004f30: 6265 616d 2073 7461 7465 0a20 2020 2020  beam state.     
-00004f40: 2020 2020 2020 2069 6f6e 5f62 6561 6d3d         ion_beam=
-00004f50: 696f 6e5f 6265 616d 2c20 2020 2020 2020  ion_beam,       
-00004f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004f80: 2020 2020 2020 2023 2069 6f6e 2062 6561         # ion bea
-00004f90: 6d20 7374 6174 650a 2020 2020 2020 2020  m state.        
-00004fa0: 2020 2020 656c 6563 7472 6f6e 5f64 6574      electron_det
-00004fb0: 6563 746f 723d 656c 6563 7472 6f6e 5f64  ector=electron_d
-00004fc0: 6574 6563 746f 722c 2020 2020 2020 2020  etector,        
-00004fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fe0: 2020 2020 2320 656c 6563 7472 6f6e 2062      # electron b
-00004ff0: 6561 6d20 6465 7465 6374 6f72 2073 7461  eam detector sta
-00005000: 7465 0a20 2020 2020 2020 2020 2020 2069  te.            i
-00005010: 6f6e 5f64 6574 6563 746f 723d 696f 6e5f  on_detector=ion_
-00005020: 6465 7465 6374 6f72 2c20 2020 2020 2020  detector,       
-00005030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005040: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005050: 2069 6f6e 2062 6561 6d20 6465 7465 6374   ion beam detect
-00005060: 6f72 2073 7461 7465 0a20 2020 2020 2020  or state.       
-00005070: 2029 0a20 2020 2020 2020 200a 2020 2020   ).        .    
-00005080: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
-00005090: 6728 7b22 6d73 6722 3a20 2267 6574 5f6d  g({"msg": "get_m
-000050a0: 6963 726f 7363 6f70 655f 7374 6174 6522  icroscope_state"
-000050b0: 2c20 2273 7461 7465 223a 2063 7572 7265  , "state": curre
-000050c0: 6e74 5f6d 6963 726f 7363 6f70 655f 7374  nt_microscope_st
-000050d0: 6174 652e 746f 5f64 6963 7428 297d 290a  ate.to_dict()}).
-000050e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000050f0: 6375 7272 656e 745f 6d69 6372 6f73 636f  current_microsco
-00005100: 7065 5f73 7461 7465 0a0a 2020 2020 6465  pe_state..    de
-00005110: 6620 7365 745f 6d69 6372 6f73 636f 7065  f set_microscope
-00005120: 5f73 7461 7465 2873 656c 662c 206d 6963  _state(self, mic
-00005130: 726f 7363 6f70 655f 7374 6174 653a 204d  roscope_state: M
-00005140: 6963 726f 7363 6f70 6553 7461 7465 2920  icroscopeState) 
-00005150: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00005160: 2022 2222 5265 7365 7420 7468 6520 6d69   """Reset the mi
-00005170: 6372 6f73 636f 7065 2073 7461 7465 2074  croscope state t
-00005180: 6f20 7468 6520 7072 6f76 6964 6564 2073  o the provided s
-00005190: 7461 7465 2e22 2222 0a20 2020 2020 2020  tate.""".       
-000051a0: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-000051b0: 2073 656c 662e 6973 5f61 7661 696c 6162   self.is_availab
-000051c0: 6c65 2822 656c 6563 7472 6f6e 5f62 6561  le("electron_bea
-000051d0: 6d22 293a 0a20 2020 2020 2020 2020 2020  m"):.           
-000051e0: 2069 6620 6d69 6372 6f73 636f 7065 5f73   if microscope_s
-000051f0: 7461 7465 2e65 6c65 6374 726f 6e5f 6265  tate.electron_be
-00005200: 616d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  am is not None:.
-00005210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005220: 7365 6c66 2e73 6574 5f62 6561 6d5f 7365  self.set_beam_se
-00005230: 7474 696e 6773 286d 6963 726f 7363 6f70  ttings(microscop
-00005240: 655f 7374 6174 652e 656c 6563 7472 6f6e  e_state.electron
-00005250: 5f62 6561 6d29 0a20 2020 2020 2020 2020  _beam).         
-00005260: 2020 2069 6620 6d69 6372 6f73 636f 7065     if microscope
-00005270: 5f73 7461 7465 2e65 6c65 6374 726f 6e5f  _state.electron_
-00005280: 6465 7465 6374 6f72 2069 7320 6e6f 7420  detector is not 
-00005290: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000052a0: 2020 2020 2020 7365 6c66 2e73 6574 5f64        self.set_d
-000052b0: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
-000052c0: 286d 6963 726f 7363 6f70 655f 7374 6174  (microscope_stat
-000052d0: 652e 656c 6563 7472 6f6e 5f64 6574 6563  e.electron_detec
-000052e0: 746f 722c 2042 6561 6d54 7970 652e 454c  tor, BeamType.EL
-000052f0: 4543 5452 4f4e 290a 2020 2020 2020 2020  ECTRON).        
-00005300: 6966 2073 656c 662e 6973 5f61 7661 696c  if self.is_avail
-00005310: 6162 6c65 2822 696f 6e5f 6265 616d 2229  able("ion_beam")
-00005320: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00005330: 206d 6963 726f 7363 6f70 655f 7374 6174   microscope_stat
-00005340: 652e 696f 6e5f 6265 616d 2069 7320 6e6f  e.ion_beam is no
-00005350: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00005360: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-00005370: 5f62 6561 6d5f 7365 7474 696e 6773 286d  _beam_settings(m
-00005380: 6963 726f 7363 6f70 655f 7374 6174 652e  icroscope_state.
-00005390: 696f 6e5f 6265 616d 290a 2020 2020 2020  ion_beam).      
-000053a0: 2020 2020 2020 6966 206d 6963 726f 7363        if microsc
-000053b0: 6f70 655f 7374 6174 652e 696f 6e5f 6465  ope_state.ion_de
-000053c0: 7465 6374 6f72 2069 7320 6e6f 7420 4e6f  tector is not No
-000053d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000053e0: 2020 2020 7365 6c66 2e73 6574 5f64 6574      self.set_det
-000053f0: 6563 746f 725f 7365 7474 696e 6773 286d  ector_settings(m
-00005400: 6963 726f 7363 6f70 655f 7374 6174 652e  icroscope_state.
-00005410: 696f 6e5f 6465 7465 6374 6f72 2c20 4265  ion_detector, Be
-00005420: 616d 5479 7065 2e49 4f4e 290a 2020 2020  amType.ION).    
-00005430: 2020 2020 6966 2073 656c 662e 6973 5f61      if self.is_a
-00005440: 7661 696c 6162 6c65 2822 7374 6167 6522  vailable("stage"
-00005450: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00005460: 656c 662e 7361 6665 5f61 6273 6f6c 7574  elf.safe_absolut
-00005470: 655f 7374 6167 655f 6d6f 7665 6d65 6e74  e_stage_movement
-00005480: 286d 6963 726f 7363 6f70 655f 7374 6174  (microscope_stat
-00005490: 652e 7374 6167 655f 706f 7369 7469 6f6e  e.stage_position
-000054a0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-000054b0: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
-000054c0: 6562 7567 287b 226d 7367 223a 2022 7365  ebug({"msg": "se
-000054d0: 745f 6d69 6372 6f73 636f 7065 5f73 7461  t_microscope_sta
-000054e0: 7465 222c 2022 7374 6174 6522 3a20 6d69  te", "state": mi
-000054f0: 6372 6f73 636f 7065 5f73 7461 7465 2e74  croscope_state.t
-00005500: 6f5f 6469 6374 2829 7d29 0a0a 2020 2020  o_dict()})..    
-00005510: 2020 2020 7265 7475 726e 2020 2020 2020      return      
-00005520: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00005530: 0a20 2020 2064 6566 2069 735f 6176 6169  .    def is_avai
-00005540: 6c61 626c 6528 7365 6c66 2c20 7379 7374  lable(self, syst
-00005550: 656d 3a20 7374 7229 202d 3e20 626f 6f6c  em: str) -> bool
-00005560: 3a0a 0a20 2020 2020 2020 2069 6620 7379  :..        if sy
-00005570: 7374 656d 203d 3d20 2265 6c65 6374 726f  stem == "electro
-00005580: 6e5f 6265 616d 223a 0a20 2020 2020 2020  n_beam":.       
-00005590: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000055a0: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
-000055b0: 2e65 6e61 626c 6564 0a20 2020 2020 2020  .enabled.       
-000055c0: 2065 6c69 6620 7379 7374 656d 203d 3d20   elif system == 
-000055d0: 2269 6f6e 5f62 6561 6d22 3a0a 2020 2020  "ion_beam":.    
-000055e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000055f0: 656c 662e 7379 7374 656d 2e69 6f6e 2e65  elf.system.ion.e
-00005600: 6e61 626c 6564 0a20 2020 2020 2020 2065  nabled.        e
-00005610: 6c69 6620 7379 7374 656d 203d 3d20 2269  lif system == "i
-00005620: 6f6e 5f70 6c61 736d 6122 3a0a 2020 2020  on_plasma":.    
-00005630: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00005640: 656c 662e 7379 7374 656d 2e69 6f6e 2e70  elf.system.ion.p
-00005650: 6c61 736d 610a 2020 2020 2020 2020 656c  lasma.        el
-00005660: 6966 2073 7973 7465 6d20 3d3d 2022 7374  if system == "st
-00005670: 6167 6522 3a0a 2020 2020 2020 2020 2020  age":.          
-00005680: 2020 7265 7475 726e 2073 656c 662e 7379    return self.sy
-00005690: 7374 656d 2e73 7461 6765 2e65 6e61 626c  stem.stage.enabl
-000056a0: 6564 0a20 2020 2020 2020 2065 6c69 6620  ed.        elif 
-000056b0: 7379 7374 656d 203d 3d20 2273 7461 6765  system == "stage
-000056c0: 5f72 6f74 6174 696f 6e22 3a0a 2020 2020  _rotation":.    
-000056d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000056e0: 656c 662e 7379 7374 656d 2e73 7461 6765  elf.system.stage
-000056f0: 2e72 6f74 6174 696f 6e0a 2020 2020 2020  .rotation.      
-00005700: 2020 656c 6966 2073 7973 7465 6d20 3d3d    elif system ==
-00005710: 2022 7374 6167 655f 7469 6c74 223a 0a20   "stage_tilt":. 
-00005720: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00005730: 6e20 7365 6c66 2e73 7973 7465 6d2e 7374  n self.system.st
-00005740: 6167 652e 7469 6c74 0a20 2020 2020 2020  age.tilt.       
-00005750: 2065 6c69 6620 7379 7374 656d 203d 3d20   elif system == 
-00005760: 226d 616e 6970 756c 6174 6f72 223a 0a20  "manipulator":. 
-00005770: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00005780: 6e20 7365 6c66 2e73 7973 7465 6d2e 6d61  n self.system.ma
-00005790: 6e69 7075 6c61 746f 722e 656e 6162 6c65  nipulator.enable
-000057a0: 640a 2020 2020 2020 2020 656c 6966 2073  d.        elif s
-000057b0: 7973 7465 6d20 3d3d 2022 6d61 6e69 7075  ystem == "manipu
-000057c0: 6c61 746f 725f 726f 7461 7469 6f6e 223a  lator_rotation":
-000057d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000057e0: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
-000057f0: 6d61 6e69 7075 6c61 746f 722e 726f 7461  manipulator.rota
-00005800: 7469 6f6e 0a20 2020 2020 2020 2065 6c69  tion.        eli
-00005810: 6620 7379 7374 656d 203d 3d20 226d 616e  f system == "man
-00005820: 6970 756c 6174 6f72 5f74 696c 7422 3a0a  ipulator_tilt":.
-00005830: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00005840: 726e 2073 656c 662e 7379 7374 656d 2e6d  rn self.system.m
-00005850: 616e 6970 756c 6174 6f72 2e74 696c 740a  anipulator.tilt.
-00005860: 2020 2020 2020 2020 656c 6966 2073 7973          elif sys
-00005870: 7465 6d20 3d3d 2022 6769 7322 3a0a 2020  tem == "gis":.  
-00005880: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00005890: 2073 656c 662e 7379 7374 656d 2e67 6973   self.system.gis
-000058a0: 2e65 6e61 626c 6564 0a20 2020 2020 2020  .enabled.       
-000058b0: 2065 6c69 6620 7379 7374 656d 203d 3d20   elif system == 
-000058c0: 2267 6973 5f6d 756c 7469 6368 656d 223a  "gis_multichem":
-000058d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000058e0: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
-000058f0: 6769 732e 6d75 6c74 6963 6865 6d0a 2020  gis.multichem.  
-00005900: 2020 2020 2020 656c 6966 2073 7973 7465        elif syste
-00005910: 6d20 3d3d 2022 6769 735f 7370 7574 7465  m == "gis_sputte
-00005920: 725f 636f 6174 6572 223a 0a20 2020 2020  r_coater":.     
-00005930: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00005940: 6c66 2e73 7973 7465 6d2e 6769 732e 7370  lf.system.gis.sp
-00005950: 7574 7465 725f 636f 6174 6572 0a20 2020  utter_coater.   
-00005960: 200a 2020 2020 6465 6620 7365 745f 6176   .    def set_av
-00005970: 6169 6c61 626c 6528 7365 6c66 2c20 7379  ailable(self, sy
-00005980: 7374 656d 3a20 7374 722c 2076 616c 7565  stem: str, value
-00005990: 3a20 626f 6f6c 2920 2d3e 204e 6f6e 653a  : bool) -> None:
-000059a0: 0a0a 2020 2020 2020 2020 6966 2073 7973  ..        if sys
-000059b0: 7465 6d20 3d3d 2022 656c 6563 7472 6f6e  tem == "electron
-000059c0: 5f62 6561 6d22 3a0a 2020 2020 2020 2020  _beam":.        
-000059d0: 2020 2020 7365 6c66 2e73 7973 7465 6d2e      self.system.
-000059e0: 656c 6563 7472 6f6e 2e65 6e61 626c 6564  electron.enabled
-000059f0: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
-00005a00: 2065 6c69 6620 7379 7374 656d 203d 3d20   elif system == 
-00005a10: 2269 6f6e 5f62 6561 6d22 3a0a 2020 2020  "ion_beam":.    
-00005a20: 2020 2020 2020 2020 7365 6c66 2e73 7973          self.sys
-00005a30: 7465 6d2e 696f 6e2e 656e 6162 6c65 6420  tem.ion.enabled 
-00005a40: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00005a50: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
-00005a60: 696f 6e5f 706c 6173 6d61 223a 0a20 2020  ion_plasma":.   
-00005a70: 2020 2020 2020 2020 2073 656c 662e 7379           self.sy
-00005a80: 7374 656d 2e69 6f6e 2e70 6c61 736d 6120  stem.ion.plasma 
-00005a90: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00005aa0: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
-00005ab0: 7374 6167 6522 3a0a 2020 2020 2020 2020  stage":.        
-00005ac0: 2020 2020 7365 6c66 2e73 7973 7465 6d2e      self.system.
-00005ad0: 7374 6167 652e 656e 6162 6c65 6420 3d20  stage.enabled = 
-00005ae0: 7661 6c75 650a 2020 2020 2020 2020 656c  value.        el
-00005af0: 6966 2073 7973 7465 6d20 3d3d 2022 7374  if system == "st
-00005b00: 6167 655f 726f 7461 7469 6f6e 223a 0a20  age_rotation":. 
-00005b10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00005b20: 7379 7374 656d 2e73 7461 6765 2e72 6f74  system.stage.rot
-00005b30: 6174 696f 6e20 3d20 7661 6c75 650a 2020  ation = value.  
-00005b40: 2020 2020 2020 656c 6966 2073 7973 7465        elif syste
-00005b50: 6d20 3d3d 2022 7374 6167 655f 7469 6c74  m == "stage_tilt
-00005b60: 223a 0a20 2020 2020 2020 2020 2020 2073  ":.            s
-00005b70: 656c 662e 7379 7374 656d 2e73 7461 6765  elf.system.stage
-00005b80: 2e74 696c 7420 3d20 7661 6c75 650a 2020  .tilt = value.  
-00005b90: 2020 2020 2020 656c 6966 2073 7973 7465        elif syste
-00005ba0: 6d20 3d3d 2022 6d61 6e69 7075 6c61 746f  m == "manipulato
-00005bb0: 7222 3a0a 2020 2020 2020 2020 2020 2020  r":.            
-00005bc0: 7365 6c66 2e73 7973 7465 6d2e 6d61 6e69  self.system.mani
-00005bd0: 7075 6c61 746f 722e 656e 6162 6c65 6420  pulator.enabled 
-00005be0: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00005bf0: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
-00005c00: 6d61 6e69 7075 6c61 746f 725f 726f 7461  manipulator_rota
-00005c10: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
-00005c20: 2020 2073 656c 662e 7379 7374 656d 2e6d     self.system.m
-00005c30: 616e 6970 756c 6174 6f72 2e72 6f74 6174  anipulator.rotat
-00005c40: 696f 6e20 3d20 7661 6c75 650a 2020 2020  ion = value.    
-00005c50: 2020 2020 656c 6966 2073 7973 7465 6d20      elif system 
-00005c60: 3d3d 2022 6d61 6e69 7075 6c61 746f 725f  == "manipulator_
-00005c70: 7469 6c74 223a 0a20 2020 2020 2020 2020  tilt":.         
-00005c80: 2020 2073 656c 662e 7379 7374 656d 2e6d     self.system.m
-00005c90: 616e 6970 756c 6174 6f72 2e74 696c 7420  anipulator.tilt 
-00005ca0: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00005cb0: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
-00005cc0: 6769 7322 3a0a 2020 2020 2020 2020 2020  gis":.          
-00005cd0: 2020 7365 6c66 2e73 7973 7465 6d2e 6769    self.system.gi
-00005ce0: 732e 656e 6162 6c65 6420 3d20 7661 6c75  s.enabled = valu
-00005cf0: 650a 2020 2020 2020 2020 656c 6966 2073  e.        elif s
-00005d00: 7973 7465 6d20 3d3d 2022 6769 735f 6d75  ystem == "gis_mu
-00005d10: 6c74 6963 6865 6d22 3a0a 2020 2020 2020  ltichem":.      
-00005d20: 2020 2020 2020 7365 6c66 2e73 7973 7465        self.syste
-00005d30: 6d2e 6769 732e 6d75 6c74 6963 6865 6d20  m.gis.multichem 
-00005d40: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00005d50: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
-00005d60: 6769 735f 7370 7574 7465 725f 636f 6174  gis_sputter_coat
-00005d70: 6572 223a 0a20 2020 2020 2020 2020 2020  er":.           
-00005d80: 2073 656c 662e 7379 7374 656d 2e67 6973   self.system.gis
-00005d90: 2e73 7075 7474 6572 5f63 6f61 7465 7220  .sputter_coater 
-00005da0: 3d20 7661 6c75 650a 0a20 2020 200a 2020  = value..    .  
-00005db0: 2020 6465 6620 6170 706c 795f 636f 6e66    def apply_conf
-00005dc0: 6967 7572 6174 696f 6e28 7365 6c66 2c20  iguration(self, 
-00005dd0: 7379 7374 656d 5f73 6574 7469 6e67 733a  system_settings:
-00005de0: 2053 7973 7465 6d53 6574 7469 6e67 7320   SystemSettings 
-00005df0: 3d20 4e6f 6e65 2920 2d3e 204e 6f6e 653a  = None) -> None:
-00005e00: 0a20 2020 2020 2020 2022 2222 4170 706c  .        """Appl
-00005e10: 7920 7468 6520 7379 7374 656d 2073 6574  y the system set
-00005e20: 7469 6e67 7320 746f 2074 6865 206d 6963  tings to the mic
-00005e30: 726f 7363 6f70 652e 2222 220a 2020 2020  roscope.""".    
-00005e40: 2020 2020 0a20 2020 2020 2020 206c 6f67      .        log
-00005e50: 6769 6e67 2e69 6e66 6f28 6622 4170 706c  ging.info(f"Appl
-00005e60: 7969 6e67 204d 6963 726f 7363 6f70 6520  ying Microscope 
-00005e70: 436f 6e66 6967 7572 6174 696f 6e2e 2e2e  Configuration...
-00005e80: 2229 0a20 2020 2020 2020 200a 2020 2020  ").        .    
-00005e90: 2020 2020 6966 2073 7973 7465 6d5f 7365      if system_se
-00005ea0: 7474 696e 6773 2069 7320 4e6f 6e65 3a0a  ttings is None:.
-00005eb0: 2020 2020 2020 2020 2020 2020 7379 7374              syst
-00005ec0: 656d 5f73 6574 7469 6e67 7320 3d20 7365  em_settings = se
-00005ed0: 6c66 2e73 7973 7465 6d0a 2020 2020 2020  lf.system.      
-00005ee0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00005ef0: 666f 2866 2255 7369 6e67 2063 7572 7265  fo(f"Using curre
-00005f00: 6e74 2073 7973 7465 6d20 7365 7474 696e  nt system settin
-00005f10: 6773 2e22 290a 2020 2020 2020 2020 0a20  gs.").        . 
-00005f20: 2020 2020 2020 2023 2061 7070 6c79 2074         # apply t
-00005f30: 6865 2073 7973 7465 6d20 7365 7474 696e  he system settin
-00005f40: 6773 0a20 2020 2020 2020 2069 6620 7365  gs.        if se
-00005f50: 6c66 2e69 735f 6176 6169 6c61 626c 6528  lf.is_available(
-00005f60: 2265 6c65 6374 726f 6e5f 6265 616d 2229  "electron_beam")
-00005f70: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00005f80: 6c66 2e73 6574 5f62 6561 6d5f 7379 7374  lf.set_beam_syst
-00005f90: 656d 5f73 6574 7469 6e67 7328 7379 7374  em_settings(syst
-00005fa0: 656d 5f73 6574 7469 6e67 732e 656c 6563  em_settings.elec
-00005fb0: 7472 6f6e 290a 2020 2020 2020 2020 6966  tron).        if
-00005fc0: 2073 656c 662e 6973 5f61 7661 696c 6162   self.is_availab
-00005fd0: 6c65 2822 696f 6e5f 6265 616d 2229 3a0a  le("ion_beam"):.
-00005fe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005ff0: 2e73 6574 5f62 6561 6d5f 7379 7374 656d  .set_beam_system
-00006000: 5f73 6574 7469 6e67 7328 7379 7374 656d  _settings(system
-00006010: 5f73 6574 7469 6e67 732e 696f 6e29 0a0a  _settings.ion)..
-00006020: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00006030: 6973 5f61 7661 696c 6162 6c65 2822 7374  is_available("st
-00006040: 6167 6522 293a 0a20 2020 2020 2020 2020  age"):.         
-00006050: 2020 2073 656c 662e 7379 7374 656d 2e73     self.system.s
-00006060: 7461 6765 203d 2073 7973 7465 6d5f 7365  tage = system_se
-00006070: 7474 696e 6773 2e73 7461 6765 0a0a 2020  ttings.stage..  
-00006080: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
-00006090: 5f61 7661 696c 6162 6c65 2822 6d61 6e69  _available("mani
-000060a0: 7075 6c61 746f 7222 293a 0a20 2020 2020  pulator"):.     
-000060b0: 2020 2020 2020 2073 656c 662e 7379 7374         self.syst
-000060c0: 656d 2e6d 616e 6970 756c 6174 6f72 203d  em.manipulator =
-000060d0: 2073 7973 7465 6d5f 7365 7474 696e 6773   system_settings
-000060e0: 2e6d 616e 6970 756c 6174 6f72 0a0a 2020  .manipulator..  
-000060f0: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
-00006100: 5f61 7661 696c 6162 6c65 2822 6769 7322  _available("gis"
-00006110: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00006120: 656c 662e 7379 7374 656d 2e67 6973 203d  elf.system.gis =
-00006130: 2073 7973 7465 6d5f 7365 7474 696e 6773   system_settings
-00006140: 2e67 6973 0a20 2020 2020 2020 200a 2020  .gis.        .  
-00006150: 2020 2020 2020 2320 646f 6e74 2075 7064        # dont upd
-00006160: 6174 6520 696e 666f 202d 3e20 7265 6164  ate info -> read
-00006170: 206f 6e6c 790a 2020 2020 2020 2020 6c6f   only.        lo
-00006180: 6767 696e 672e 696e 666f 2866 224d 6963  gging.info(f"Mic
-00006190: 726f 7363 6f70 6520 636f 6e66 6967 7572  roscope configur
-000061a0: 6174 696f 6e20 6170 706c 6965 642e 2229  ation applied.")
-000061b0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-000061c0: 2e64 6562 7567 287b 226d 7367 223a 2022  .debug({"msg": "
-000061d0: 6170 706c 795f 636f 6e66 6967 7572 6174  apply_configurat
-000061e0: 696f 6e22 2c20 2273 7973 7465 6d5f 7365  ion", "system_se
-000061f0: 7474 696e 6773 223a 2073 7973 7465 6d5f  ttings": system_
-00006200: 7365 7474 696e 6773 2e74 6f5f 6469 6374  settings.to_dict
-00006210: 2829 7d29 0a0a 2020 2020 4061 6273 7472  ()})..    @abstr
-00006220: 6163 746d 6574 686f 640a 2020 2020 6465  actmethod.    de
-00006230: 6620 6368 6563 6b5f 6176 6169 6c61 626c  f check_availabl
-00006240: 655f 7661 6c75 6573 2873 656c 662c 206b  e_values(self, k
-00006250: 6579 3a73 7472 2c20 7661 6c75 6573 2c20  ey:str, values, 
-00006260: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-00006270: 7970 6520 3d20 4e6f 6e65 2920 2d3e 2062  ype = None) -> b
-00006280: 6f6f 6c3a 0a20 2020 2020 2020 2070 6173  ool:.        pas
-00006290: 730a 0a20 2020 2064 6566 2068 6f6d 6528  s..    def home(
-000062a0: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
-000062b0: 2020 2020 2020 2022 2222 486f 6d65 2074         """Home t
-000062c0: 6865 2073 7461 6765 2e22 2222 0a20 2020  he stage.""".   
-000062d0: 2020 2020 2073 656c 662e 7365 7428 2273       self.set("s
-000062e0: 7461 6765 5f68 6f6d 6522 2c20 5472 7565  tage_home", True
-000062f0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00006300: 2073 656c 662e 6765 7428 2273 7461 6765   self.get("stage
-00006310: 5f68 6f6d 6564 2229 0a0a 2020 2020 6465  _homed")..    de
-00006320: 6620 6c69 6e6b 5f73 7461 6765 2873 656c  f link_stage(sel
-00006330: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
-00006340: 2020 2020 2222 224c 696e 6b20 7468 6520      """Link the 
-00006350: 7374 6167 6520 746f 2074 6865 2077 6f72  stage to the wor
-00006360: 6b69 6e67 2064 6973 7461 6e63 6522 2222  king distance"""
-00006370: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
-00006380: 7428 2273 7461 6765 5f6c 696e 6b22 2c20  t("stage_link", 
-00006390: 5472 7565 290a 2020 2020 2020 2020 7265  True).        re
-000063a0: 7475 726e 2073 656c 662e 6765 7428 2273  turn self.get("s
-000063b0: 7461 6765 5f6c 696e 6b65 6422 290a 0a20  tage_linked").. 
-000063c0: 2020 2064 6566 2070 756d 7028 7365 6c66     def pump(self
-000063d0: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-000063e0: 2020 2222 2222 5075 6d70 2074 6865 2063    """"Pump the c
-000063f0: 6861 6d62 6572 2e22 2222 0a20 2020 2020  hamber.""".     
-00006400: 2020 2073 656c 662e 7365 7428 2270 756d     self.set("pum
-00006410: 705f 6368 616d 6265 7222 2c20 5472 7565  p_chamber", True
-00006420: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00006430: 2073 656c 662e 6765 7428 2263 6861 6d62   self.get("chamb
-00006440: 6572 5f73 7461 7465 2229 0a0a 2020 2020  er_state")..    
-00006450: 6465 6620 7665 6e74 2873 656c 6629 202d  def vent(self) -
-00006460: 3e20 7374 723a 0a20 2020 2020 2020 2022  > str:.        "
-00006470: 2222 5665 6e74 2074 6865 2063 6861 6d62  ""Vent the chamb
-00006480: 6572 2e22 2222 0a20 2020 2020 2020 2073  er.""".        s
-00006490: 656c 662e 7365 7428 2276 656e 745f 6368  elf.set("vent_ch
-000064a0: 616d 6265 7222 2c20 5472 7565 290a 2020  amber", True).  
-000064b0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-000064c0: 662e 6765 7428 2263 6861 6d62 6572 5f73  f.get("chamber_s
-000064d0: 7461 7465 2229 0a20 2020 200a 2020 2020  tate").    .    
-000064e0: 6465 6620 7475 726e 5f6f 6e28 7365 6c66  def turn_on(self
-000064f0: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-00006500: 6d54 7970 6529 202d 3e20 626f 6f6c 3a0a  mType) -> bool:.
-00006510: 2020 2020 2020 2020 2222 2254 7572 6e20          """Turn 
-00006520: 6f6e 2074 6865 2073 7065 6369 6669 6564  on the specified
-00006530: 2062 6561 6d20 7479 7065 2e22 2222 0a20   beam type.""". 
-00006540: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
-00006550: 226f 6e22 2c20 5472 7565 2c20 6265 616d  "on", True, beam
-00006560: 5f74 7970 6529 0a20 2020 2020 2020 2072  _type).        r
-00006570: 6574 7572 6e20 7365 6c66 2e67 6574 2822  eturn self.get("
-00006580: 6f6e 222c 2062 6561 6d5f 7479 7065 290a  on", beam_type).
-00006590: 0a20 2020 2064 6566 2074 7572 6e5f 6f66  .    def turn_of
-000065a0: 6628 7365 6c66 2c20 6265 616d 5f74 7970  f(self, beam_typ
-000065b0: 653a 2042 6561 6d54 7970 6529 202d 3e20  e: BeamType) -> 
-000065c0: 626f 6f6c 3a0a 2020 2020 2020 2020 2254  bool:.        "T
-000065d0: 7572 6e20 6f66 6620 7468 6520 7370 6563  urn off the spec
-000065e0: 6966 6965 6420 6265 616d 2074 7970 652e  ified beam type.
-000065f0: 220a 2020 2020 2020 2020 7365 6c66 2e73  ".        self.s
-00006600: 6574 2822 6f6e 222c 2046 616c 7365 2c20  et("on", False, 
-00006610: 6265 616d 5f74 7970 6529 0a20 2020 2020  beam_type).     
-00006620: 2020 2072 6574 7572 6e20 7365 6c66 2e67     return self.g
-00006630: 6574 2822 6f6e 222c 2062 6561 6d5f 7479  et("on", beam_ty
-00006640: 7065 290a 0a63 6c61 7373 2054 6865 726d  pe)..class Therm
-00006650: 6f4d 6963 726f 7363 6f70 6528 4669 6273  oMicroscope(Fibs
-00006660: 656d 4d69 6372 6f73 636f 7065 293a 0a20  emMicroscope):. 
-00006670: 2020 2022 2222 0a20 2020 2041 2063 6c61     """.    A cla
-00006680: 7373 2072 6570 7265 7365 6e74 696e 6720  ss representing 
-00006690: 6120 5468 6572 6d6f 2046 6973 6865 7220  a Thermo Fisher 
-000066a0: 4649 422d 5345 4d20 6d69 6372 6f73 636f  FIB-SEM microsco
-000066b0: 7065 2e0a 0a20 2020 2054 6869 7320 636c  pe...    This cl
-000066c0: 6173 7320 696e 6865 7269 7473 2066 726f  ass inherits fro
-000066d0: 6d20 7468 6520 6162 7374 7261 6374 2062  m the abstract b
-000066e0: 6173 6520 636c 6173 7320 6046 6962 7365  ase class `Fibse
-000066f0: 6d4d 6963 726f 7363 6f70 6560 2c20 7768  mMicroscope`, wh
-00006700: 6963 6820 6465 6669 6e65 7320 7468 6520  ich defines the 
-00006710: 636f 7265 2066 756e 6374 696f 6e61 6c69  core functionali
-00006720: 7479 206f 6620 610a 2020 2020 6d69 6372  ty of a.    micr
-00006730: 6f73 636f 7065 2e20 496e 2061 6464 6974  oscope. In addit
-00006740: 696f 6e20 746f 2074 6865 206d 6574 686f  ion to the metho
-00006750: 6473 2064 6566 696e 6564 2069 6e20 7468  ds defined in th
-00006760: 6520 6261 7365 2063 6c61 7373 2c20 7468  e base class, th
-00006770: 6973 2063 6c61 7373 2070 726f 7669 6465  is class provide
-00006780: 7320 6164 6469 7469 6f6e 616c 206d 6574  s additional met
-00006790: 686f 6473 2073 7065 6369 6669 630a 2020  hods specific.  
-000067a0: 2020 746f 2074 6865 2054 6865 726d 6f20    to the Thermo 
-000067b0: 4669 7368 6572 2046 4942 2d53 454d 206d  Fisher FIB-SEM m
-000067c0: 6963 726f 7363 6f70 652e 0a0a 2020 2020  icroscope...    
-000067d0: 4174 7472 6962 7574 6573 3a0a 2020 2020  Attributes:.    
-000067e0: 2020 2020 636f 6e6e 6563 7469 6f6e 2028      connection (
-000067f0: 5364 624d 6963 726f 7363 6f70 6543 6c69  SdbMicroscopeCli
-00006800: 656e 7429 3a20 5468 6520 6d69 6372 6f73  ent): The micros
-00006810: 636f 7065 2063 6c69 656e 7420 636f 6e6e  cope client conn
-00006820: 6563 7469 6f6e 2e0a 0a20 2020 2049 6e68  ection...    Inh
-00006830: 6572 6974 6564 204d 6574 686f 6473 3a0a  erited Methods:.
-00006840: 2020 2020 2020 2020 636f 6e6e 6563 745f          connect_
-00006850: 746f 5f6d 6963 726f 7363 6f70 6528 7365  to_microscope(se
-00006860: 6c66 2c20 6970 5f61 6464 7265 7373 3a20  lf, ip_address: 
-00006870: 7374 722c 2070 6f72 743a 2069 6e74 203d  str, port: int =
-00006880: 2037 3532 3029 202d 3e20 4e6f 6e65 3a20   7520) -> None: 
-00006890: 0a20 2020 2020 2020 2020 2020 2043 6f6e  .            Con
-000068a0: 6e65 6374 2074 6f20 6120 5468 6572 6d6f  nect to a Thermo
-000068b0: 2046 6973 6865 7220 6d69 6372 6f73 636f   Fisher microsco
-000068c0: 7065 2061 7420 7468 6520 7370 6563 6966  pe at the specif
-000068d0: 6965 6420 4950 2061 6464 7265 7373 2061  ied IP address a
-000068e0: 6e64 2070 6f72 742e 0a0a 2020 2020 2020  nd port...      
-000068f0: 2020 6469 7363 6f6e 6e65 6374 2873 656c    disconnect(sel
-00006900: 6629 202d 3e20 4e6f 6e65 3a20 0a20 2020  f) -> None: .   
-00006910: 2020 2020 2020 2020 2044 6973 636f 6e6e           Disconn
-00006920: 6563 7473 2074 6865 206d 6963 726f 7363  ects the microsc
-00006930: 6f70 6520 636c 6965 6e74 2063 6f6e 6e65  ope client conne
-00006940: 6374 696f 6e2e 0a0a 2020 2020 2020 2020  ction...        
-00006950: 6163 7175 6972 655f 696d 6167 6528 7365  acquire_image(se
-00006960: 6c66 2c20 696d 6167 655f 7365 7474 696e  lf, image_settin
-00006970: 6773 3a20 496d 6167 6553 6574 7469 6e67  gs: ImageSetting
-00006980: 7329 202d 3e20 4669 6273 656d 496d 6167  s) -> FibsemImag
-00006990: 653a 200a 2020 2020 2020 2020 2020 2020  e: .            
-000069a0: 4163 7175 6972 6520 6120 6e65 7720 696d  Acquire a new im
-000069b0: 6167 6520 7769 7468 2074 6865 2073 7065  age with the spe
-000069c0: 6369 6669 6564 2073 6574 7469 6e67 732e  cified settings.
-000069d0: 0a0a 2020 2020 2020 2020 6c61 7374 5f69  ..        last_i
-000069e0: 6d61 6765 2873 656c 662c 2062 6561 6d5f  mage(self, beam_
-000069f0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-00006a00: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-00006a10: 4f4e 2920 2d3e 2046 6962 7365 6d49 6d61  ON) -> FibsemIma
-00006a20: 6765 3a20 0a20 2020 2020 2020 2020 2020  ge: .           
-00006a30: 2047 6574 2074 6865 206c 6173 7420 7072   Get the last pr
-00006a40: 6576 696f 7573 6c79 2061 6371 7569 7265  eviously acquire
-00006a50: 6420 696d 6167 652e 0a0a 2020 2020 2020  d image...      
-00006a60: 2020 6175 746f 636f 6e74 7261 7374 2873    autocontrast(s
-00006a70: 656c 662c 2062 6561 6d5f 7479 7065 3a20  elf, beam_type: 
-00006a80: 4265 616d 5479 7065 2920 2d3e 204e 6f6e  BeamType) -> Non
-00006a90: 653a 200a 2020 2020 2020 2020 2020 2020  e: .            
-00006aa0: 4175 746f 6d61 7469 6361 6c6c 7920 6164  Automatically ad
-00006ab0: 6a75 7374 2074 6865 206d 6963 726f 7363  just the microsc
-00006ac0: 6f70 6520 696d 6167 6520 636f 6e74 7261  ope image contra
-00006ad0: 7374 2066 6f72 2074 6865 2073 7065 6369  st for the speci
-00006ae0: 6669 6564 2062 6561 6d20 7479 7065 2e0a  fied beam type..
-00006af0: 0a20 2020 2020 2020 2061 7574 6f5f 666f  .        auto_fo
-00006b00: 6375 7328 7365 6c66 2c20 6265 616d 5f74  cus(self, beam_t
-00006b10: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
-00006b20: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00006b30: 2020 2020 4175 746f 6d61 7469 6361 6c6c      Automaticall
-00006b40: 7920 6164 6a75 7374 2074 6865 206d 6963  y adjust the mic
-00006b50: 726f 7363 6f70 6520 666f 6375 7320 666f  roscope focus fo
-00006b60: 7220 7468 6520 7370 6563 6966 6965 6420  r the specified 
-00006b70: 6265 616d 2074 7970 652e 0a0a 2020 2020  beam type...    
-00006b80: 2020 2020 0a20 2020 2020 2020 2062 6561      .        bea
-00006b90: 6d5f 7368 6966 7428 7365 6c66 2c20 6478  m_shift(self, dx
-00006ba0: 3a20 666c 6f61 742c 2064 793a 2066 6c6f  : float, dy: flo
-00006bb0: 6174 2c20 2062 6561 6d5f 7479 7065 3a20  at,  beam_type: 
-00006bc0: 4265 616d 5479 7065 2920 2d3e 204e 6f6e  BeamType) -> Non
-00006bd0: 653a 0a20 2020 2020 2020 2020 2020 2041  e:.            A
-00006be0: 646a 7573 7473 2074 6865 2062 6561 6d20  djusts the beam 
-00006bf0: 7368 6966 7420 6f66 2067 6976 656e 2062  shift of given b
-00006c00: 6561 6d20 6261 7365 6420 6f6e 2072 656c  eam based on rel
-00006c10: 6174 6976 6520 7661 6c75 6573 2074 6861  ative values tha
-00006c20: 7420 6172 6520 7072 6f76 6964 6564 2e0a  t are provided..
-00006c30: 0a20 2020 2020 2020 206d 6f76 655f 7374  .        move_st
-00006c40: 6167 655f 6162 736f 6c75 7465 2873 656c  age_absolute(sel
-00006c50: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
-00006c60: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00006c70: 293a 0a20 2020 2020 2020 2020 2020 204d  ):.            M
-00006c80: 6f76 6520 7468 6520 7374 6167 6520 746f  ove the stage to
-00006c90: 2074 6865 2073 7065 6369 6669 6564 2063   the specified c
-00006ca0: 6f6f 7264 696e 6174 6573 2e0a 0a20 2020  oordinates...   
-00006cb0: 2020 2020 206d 6f76 655f 7374 6167 655f       move_stage_
-00006cc0: 7265 6c61 7469 7665 2873 656c 662c 2070  relative(self, p
-00006cd0: 6f73 6974 696f 6e3a 2046 6962 7365 6d53  osition: FibsemS
-00006ce0: 7461 6765 506f 7369 7469 6f6e 293a 0a20  tagePosition):. 
-00006cf0: 2020 2020 2020 2020 2020 204d 6f76 6520             Move 
-00006d00: 7468 6520 7374 6167 6520 6279 2074 6865  the stage by the
-00006d10: 2073 7065 6369 6669 6564 2072 656c 6174   specified relat
-00006d20: 6976 6520 6d6f 7665 2e0a 0a20 2020 2020  ive move...     
-00006d30: 2020 2073 7461 626c 655f 6d6f 7665 2873     stable_move(s
-00006d40: 656c 662c 2064 783a 2066 6c6f 6174 2c20  elf, dx: float, 
-00006d50: 6479 3a20 666c 6f61 742c 2062 6561 6d5f  dy: float, beam_
-00006d60: 7479 7065 3a20 4265 616d 5479 7065 2c29  type: BeamType,)
-00006d70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00006d80: 2020 2020 2020 4361 6c63 756c 6174 6520        Calculate 
-00006d90: 7468 6520 636f 7272 6563 7465 6420 7374  the corrected st
-00006da0: 6167 6520 6d6f 7665 6d65 6e74 7320 6261  age movements ba
-00006db0: 7365 6420 6f6e 2074 6865 2062 6561 6d5f  sed on the beam_
-00006dc0: 7479 7065 2c20 616e 6420 7468 656e 206d  type, and then m
-00006dd0: 6f76 6520 7468 6520 7374 6167 6520 7265  ove the stage re
-00006de0: 6c61 7469 7665 6c79 2e0a 0a20 2020 2020  latively...     
-00006df0: 2020 2076 6572 7469 6361 6c5f 6d6f 7665     vertical_move
-00006e00: 2873 656c 662c 2020 6479 3a20 666c 6f61  (self,  dy: floa
-00006e10: 742c 2064 783a 2066 6c6f 6174 203d 2030  t, dx: float = 0
-00006e20: 2c20 7374 6174 6963 5f77 643a 2062 6f6f  , static_wd: boo
-00006e30: 6c20 3d20 5472 7565 2920 2d3e 204e 6f6e  l = True) -> Non
-00006e40: 653a 0a20 2020 2020 2020 2020 2020 204d  e:.            M
-00006e50: 6f76 6520 7468 6520 7374 6167 6520 7665  ove the stage ve
-00006e60: 7274 6963 616c 6c79 2074 6f20 636f 7272  rtically to corr
-00006e70: 6563 7420 6575 6365 6e74 7269 6320 706f  ect eucentric po
-00006e80: 696e 740a 2020 2020 2020 2020 0a20 2020  int.        .   
-00006e90: 2020 2020 2067 6574 5f6d 616e 6970 756c       get_manipul
-00006ea0: 6174 6f72 5f70 6f73 6974 696f 6e28 7365  ator_position(se
-00006eb0: 6c66 2920 2d3e 2046 6962 7365 6d4d 616e  lf) -> FibsemMan
-00006ec0: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
-00006ed0: 3a0a 2020 2020 2020 2020 2020 2020 4765  :.            Ge
-00006ee0: 7420 7468 6520 6375 7272 656e 7420 6d61  t the current ma
-00006ef0: 6e69 7075 6c61 746f 7220 706f 7369 7469  nipulator positi
-00006f00: 6f6e 2e0a 2020 2020 2020 2020 0a20 2020  on..        .   
-00006f10: 2020 2020 2069 6e73 6572 745f 6d61 6e69       insert_mani
-00006f20: 7075 6c61 746f 7228 7365 6c66 2c20 6e61  pulator(self, na
-00006f30: 6d65 3a20 7374 7229 202d 3e20 4e6f 6e65  me: str) -> None
-00006f40: 3a0a 2020 2020 2020 2020 2020 2020 496e  :.            In
-00006f50: 7365 7274 2074 6865 206d 616e 6970 756c  sert the manipul
-00006f60: 6174 6f72 2069 6e74 6f20 7468 6520 7361  ator into the sa
-00006f70: 6d70 6c65 2e0a 2020 2020 2020 2020 0a20  mple..        . 
-00006f80: 2020 2020 2020 2072 6574 7261 6374 5f6d         retract_m
-00006f90: 616e 6970 756c 6174 6f72 2873 656c 6629  anipulator(self)
-00006fa0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00006fb0: 2020 2020 2020 5265 7472 6163 7420 7468        Retract th
-00006fc0: 6520 6d61 6e69 7075 6c61 746f 7220 6672  e manipulator fr
-00006fd0: 6f6d 2074 6865 2073 616d 706c 652e 0a0a  om the sample...
-00006fe0: 2020 2020 2020 2020 6d6f 7665 5f6d 616e          move_man
-00006ff0: 6970 756c 6174 6f72 5f72 656c 6174 6976  ipulator_relativ
-00007000: 6528 7365 6c66 2c20 706f 7369 7469 6f6e  e(self, position
-00007010: 3a20 4669 6273 656d 4d61 6e69 7075 6c61  : FibsemManipula
-00007020: 746f 7250 6f73 6974 696f 6e29 202d 3e20  torPosition) -> 
-00007030: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00007040: 2020 4d6f 7665 2074 6865 206d 616e 6970    Move the manip
-00007050: 756c 6174 6f72 2062 7920 7468 6520 7370  ulator by the sp
-00007060: 6563 6966 6965 6420 7265 6c61 7469 7665  ecified relative
-00007070: 206d 6f76 652e 0a20 2020 2020 2020 200a   move..        .
-00007080: 2020 2020 2020 2020 6d6f 7665 5f6d 616e          move_man
-00007090: 6970 756c 6174 6f72 5f61 6273 6f6c 7574  ipulator_absolut
-000070a0: 6528 7365 6c66 2c20 706f 7369 7469 6f6e  e(self, position
-000070b0: 3a20 4669 6273 656d 4d61 6e69 7075 6c61  : FibsemManipula
-000070c0: 746f 7250 6f73 6974 696f 6e29 202d 3e20  torPosition) -> 
-000070d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000070e0: 2020 4d6f 7665 2074 6865 206d 616e 6970    Move the manip
-000070f0: 756c 6174 6f72 2074 6f20 7468 6520 7370  ulator to the sp
-00007100: 6563 6966 6965 6420 636f 6f72 6469 6e61  ecified coordina
-00007110: 7465 732e 0a0a 2020 2020 2020 2020 6d6f  tes...        mo
-00007120: 7665 5f6d 616e 6970 756c 6174 6f72 5f63  ve_manipulator_c
-00007130: 6f72 7265 6374 6564 2873 656c 662c 2064  orrected(self, d
-00007140: 783a 2066 6c6f 6174 2c20 6479 3a20 666c  x: float, dy: fl
-00007150: 6f61 742c 2062 6561 6d5f 7479 7065 3a20  oat, beam_type: 
-00007160: 4265 616d 5479 7065 2920 2d3e 204e 6f6e  BeamType) -> Non
-00007170: 653a 0a20 2020 2020 2020 2020 2020 204d  e:.            M
-00007180: 6f76 6520 7468 6520 6d61 6e69 7075 6c61  ove the manipula
-00007190: 746f 7220 6279 2074 6865 2073 7065 6369  tor by the speci
-000071a0: 6669 6564 2072 656c 6174 6976 6520 6d6f  fied relative mo
-000071b0: 7665 2c20 636f 7272 6563 7469 6e67 2066  ve, correcting f
-000071c0: 6f72 2074 6865 2062 6561 6d20 7479 7065  or the beam type
-000071d0: 2e20 2020 2020 200a 0a20 2020 2020 2020  .      ..       
-000071e0: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
-000071f0: 725f 746f 5f70 6f73 6974 696f 6e5f 6f66  r_to_position_of
-00007200: 6673 6574 2873 656c 662c 206f 6666 7365  fset(self, offse
-00007210: 743a 2046 6962 7365 6d4d 616e 6970 756c  t: FibsemManipul
-00007220: 6174 6f72 506f 7369 7469 6f6e 2c20 6e61  atorPosition, na
-00007230: 6d65 3a20 7374 7229 202d 3e20 4e6f 6e65  me: str) -> None
-00007240: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
-00007250: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
-00007260: 6f72 2074 6f20 7468 6520 7370 6563 6966  or to the specif
-00007270: 6965 6420 706f 7369 7469 6f6e 206f 6666  ied position off
-00007280: 7365 742e 0a0a 2020 2020 2020 2020 5f67  set...        _g
-00007290: 6574 5f73 6176 6564 5f6d 616e 6970 756c  et_saved_manipul
-000072a0: 6174 6f72 5f70 6f73 6974 696f 6e28 7365  ator_position(se
-000072b0: 6c66 2c20 6e61 6d65 3a20 7374 7229 202d  lf, name: str) -
-000072c0: 3e20 4669 6273 656d 4d61 6e69 7075 6c61  > FibsemManipula
-000072d0: 746f 7250 6f73 6974 696f 6e3a 0a20 2020  torPosition:.   
-000072e0: 2020 2020 2020 2020 2047 6574 2074 6865           Get the
-000072f0: 2073 6176 6564 206d 616e 6970 756c 6174   saved manipulat
-00007300: 6f72 2070 6f73 6974 696f 6e20 7769 7468  or position with
-00007310: 2074 6865 2073 7065 6369 6669 6564 206e   the specified n
-00007320: 616d 652e 0a0a 2020 2020 2020 2020 7365  ame...        se
-00007330: 7475 705f 6d69 6c6c 696e 6728 7365 6c66  tup_milling(self
-00007340: 2c20 6d69 6c6c 5f73 6574 7469 6e67 733a  , mill_settings:
-00007350: 2046 6962 7365 6d4d 696c 6c69 6e67 5365   FibsemMillingSe
-00007360: 7474 696e 6773 293a 0a20 2020 2020 2020  ttings):.       
-00007370: 2020 2020 2043 6f6e 6669 6775 7265 2074       Configure t
-00007380: 6865 206d 6963 726f 7363 6f70 6520 666f  he microscope fo
-00007390: 7220 6d69 6c6c 696e 6720 7573 696e 6720  r milling using 
-000073a0: 7468 6520 696f 6e20 6265 616d 2e0a 0a20  the ion beam... 
-000073b0: 2020 2020 2020 2072 756e 5f6d 696c 6c69         run_milli
-000073c0: 6e67 2873 656c 662c 206d 696c 6c69 6e67  ng(self, milling
-000073d0: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
-000073e0: 2061 7379 6e63 683a 2062 6f6f 6c20 3d20   asynch: bool = 
-000073f0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-00007400: 2020 2020 5275 6e20 696f 6e20 6265 616d      Run ion beam
-00007410: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
-00007420: 6865 2073 7065 6369 6669 6564 206d 696c  he specified mil
-00007430: 6c69 6e67 2063 7572 7265 6e74 2e0a 0a20  ling current... 
-00007440: 2020 2020 2020 2072 756e 5f6d 696c 6c69         run_milli
-00007450: 6e67 5f64 7269 6674 5f63 6f72 7265 6374  ng_drift_correct
-00007460: 6564 2873 656c 662c 206d 696c 6c69 6e67  ed(self, milling
-00007470: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
-00007480: 206d 696c 6c69 6e67 5f76 6f6c 7461 6765   milling_voltage
-00007490: 3a20 666c 6f61 742c 2072 6566 5f69 6d61  : float, ref_ima
-000074a0: 6765 3a20 4669 6273 656d 496d 6167 6529  ge: FibsemImage)
-000074b0: 3a0a 2020 2020 2020 2020 2020 2020 5275  :.            Ru
-000074c0: 6e20 696f 6e20 6265 616d 206d 696c 6c69  n ion beam milli
-000074d0: 6e67 2075 7369 6e67 2074 6865 2073 7065  ng using the spe
-000074e0: 6369 6669 6564 206d 696c 6c69 6e67 2063  cified milling c
-000074f0: 7572 7265 6e74 2c20 616e 6420 636f 7272  urrent, and corr
-00007500: 6563 7420 666f 7220 6472 6966 7420 7573  ect for drift us
-00007510: 696e 6720 7468 6520 7072 6f76 6964 6564  ing the provided
-00007520: 2072 6566 6572 656e 6365 2069 6d61 6765   reference image
-00007530: 2e0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
-00007540: 2020 2066 696e 6973 685f 6d69 6c6c 696e     finish_millin
-00007550: 6728 7365 6c66 2c20 696d 6167 696e 675f  g(self, imaging_
-00007560: 6375 7272 656e 743a 2066 6c6f 6174 293a  current: float):
-00007570: 0a20 2020 2020 2020 2020 2020 2046 696e  .            Fin
-00007580: 616c 6973 6573 2074 6865 206d 696c 6c69  alises the milli
-00007590: 6e67 2070 726f 6365 7373 2062 7920 636c  ng process by cl
-000075a0: 6561 7269 6e67 2074 6865 206d 6963 726f  earing the micro
-000075b0: 7363 6f70 6520 6f66 2061 6e79 2070 6174  scope of any pat
-000075c0: 7465 726e 7320 616e 6420 7265 7475 726e  terns and return
-000075d0: 696e 6720 7468 6520 6375 7272 656e 7420  ing the current 
-000075e0: 746f 2074 6865 2069 6d61 6769 6e67 2063  to the imaging c
-000075f0: 7572 7265 6e74 2e0a 0a20 2020 2020 2020  urrent...       
-00007600: 2073 6574 7570 5f73 7075 7474 6572 2873   setup_sputter(s
-00007610: 656c 662c 2070 726f 746f 636f 6c3a 2064  elf, protocol: d
-00007620: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-00007630: 2020 5365 7420 7570 2074 6865 2073 7075    Set up the spu
-00007640: 7474 6572 2063 6f61 7469 6e67 2070 726f  tter coating pro
-00007650: 6365 7373 206f 6e20 7468 6520 6d69 6372  cess on the micr
-00007660: 6f73 636f 7065 2e0a 0a20 2020 2020 2020  oscope...       
-00007670: 2064 7261 775f 7370 7574 7465 725f 7061   draw_sputter_pa
-00007680: 7474 6572 6e28 7365 6c66 2c20 6866 773a  ttern(self, hfw:
-00007690: 2066 6c6f 6174 2c20 6c69 6e65 5f70 6174   float, line_pat
-000076a0: 7465 726e 5f6c 656e 6774 683a 2066 6c6f  tern_length: flo
-000076b0: 6174 2c20 7370 7574 7465 725f 7469 6d65  at, sputter_time
-000076c0: 3a20 666c 6f61 7429 3a0a 2020 2020 2020  : float):.      
-000076d0: 2020 2020 2020 4472 6177 7320 6120 6c69        Draws a li
-000076e0: 6e65 2070 6174 7465 726e 2066 6f72 2073  ne pattern for s
-000076f0: 7075 7474 6572 696e 6720 7769 7468 2074  puttering with t
-00007700: 6865 2067 6976 656e 2070 6172 616d 6574  he given paramet
-00007710: 6572 732e 0a0a 2020 2020 2020 2020 7275  ers...        ru
-00007720: 6e5f 7370 7574 7465 7228 7365 6c66 2c20  n_sputter(self, 
-00007730: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00007740: 2020 2020 2020 2052 756e 7320 7468 6520         Runs the 
-00007750: 4749 5320 506c 6174 696e 756d 2053 7075  GIS Platinum Spu
-00007760: 7474 6572 2e0a 0a20 2020 2020 2020 2066  tter...        f
-00007770: 696e 6973 685f 7370 7574 7465 7228 7365  inish_sputter(se
-00007780: 6c66 2c20 6170 706c 6963 6174 696f 6e5f  lf, application_
-00007790: 6669 6c65 3a20 7374 7229 202d 3e20 4e6f  file: str) -> No
-000077a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000077b0: 4669 6e69 7368 2074 6865 2073 7075 7474  Finish the sputt
-000077c0: 6572 2070 726f 6365 7373 2062 7920 636c  er process by cl
-000077d0: 6561 7269 6e67 2070 6174 7465 726e 7320  earing patterns 
-000077e0: 616e 6420 7265 7365 7474 696e 6720 6265  and resetting be
-000077f0: 616d 2061 6e64 2069 6d61 6769 6e67 2073  am and imaging s
-00007800: 6574 7469 6e67 732e 0a0a 2020 2020 2020  ettings...      
-00007810: 2020 7365 745f 6d69 6372 6f73 636f 7065    set_microscope
-00007820: 5f73 7461 7465 2873 656c 662c 206d 6963  _state(self, mic
-00007830: 726f 7363 6f70 655f 7374 6174 653a 204d  roscope_state: M
-00007840: 6963 726f 7363 6f70 6553 7461 7465 2920  icroscopeState) 
-00007850: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00007860: 2020 2020 2052 6573 6574 2074 6865 206d       Reset the m
-00007870: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
-00007880: 746f 2074 6865 2070 726f 7669 6465 6420  to the provided 
-00007890: 7374 6174 652e 0a20 2020 2020 2020 200a  state..        .
-000078a0: 2020 2020 2020 2020 6765 7428 7365 6c66          get(self
-000078b0: 2c20 6b65 793a 7374 722c 2062 6561 6d5f  , key:str, beam_
-000078c0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-000078d0: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
-000078e0: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
-000078f0: 7661 6c75 6520 6f66 2074 6865 2073 7065  value of the spe
-00007900: 6369 6669 6564 206b 6579 2e0a 0a20 2020  cified key...   
-00007910: 2020 2020 2073 6574 2873 656c 662c 206b       set(self, k
-00007920: 6579 3a20 7374 722c 2076 616c 7565 2c20  ey: str, value, 
-00007930: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
-00007940: 7970 6520 3d20 4e6f 6e65 2920 2d3e 204e  ype = None) -> N
-00007950: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00007960: 2053 6574 7320 7468 6520 7661 6c75 6520   Sets the value 
-00007970: 6f66 2074 6865 2073 7065 6369 6669 6564  of the specified
-00007980: 206b 6579 2e0a 0a20 2020 204e 6577 206d   key...    New m
-00007990: 6574 686f 6473 3a0a 2020 2020 2020 2020  ethods:.        
-000079a0: 5f5f 696e 6974 5f5f 2873 656c 6629 3a20  __init__(self): 
-000079b0: 0a20 2020 2020 2020 2020 2020 2049 6e69  .            Ini
-000079c0: 7469 616c 697a 6573 2061 206e 6577 2069  tializes a new i
-000079d0: 6e73 7461 6e63 6520 6f66 2074 6865 2063  nstance of the c
-000079e0: 6c61 7373 2e0a 0a20 2020 2020 2020 205f  lass...        _
-000079f0: 795f 636f 7272 6563 7465 645f 7374 6167  y_corrected_stag
-00007a00: 655f 6d6f 7665 6d65 6e74 2873 656c 662c  e_movement(self,
-00007a10: 2065 7870 6563 7465 645f 793a 2066 6c6f   expected_y: flo
-00007a20: 6174 2c20 6265 616d 5f74 7970 653a 2042  at, beam_type: B
-00007a30: 6561 6d54 7970 6520 3d20 4265 616d 5479  eamType = BeamTy
-00007a40: 7065 2e45 4c45 4354 524f 4e29 202d 3e20  pe.ELECTRON) -> 
-00007a50: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-00007a60: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-00007a70: 2043 616c 6375 6c61 7465 2074 6865 2079   Calculate the y
-00007a80: 2063 6f72 7265 6374 6564 2073 7461 6765   corrected stage
-00007a90: 206d 6f76 656d 656e 742c 2063 6f72 7265   movement, corre
-00007aa0: 6374 6564 2066 6f72 2074 6865 2061 6464  cted for the add
-00007ab0: 6974 696f 6e61 6c20 7469 6c74 206f 6620  itional tilt of 
-00007ac0: 7468 6520 7361 6d70 6c65 2068 6f6c 6465  the sample holde
-00007ad0: 7220 2870 7265 2d74 696c 7420 616e 676c  r (pre-tilt angl
-00007ae0: 6529 2e0a 2020 2020 2222 220a 0a20 2020  e)..    """..   
-00007af0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00007b00: 6c66 2c20 7379 7374 656d 5f73 6574 7469  lf, system_setti
-00007b10: 6e67 733a 2053 7973 7465 6d53 6574 7469  ngs: SystemSetti
-00007b20: 6e67 7320 3d20 4e6f 6e65 293a 0a20 2020  ngs = None):.   
-00007b30: 2020 2020 2069 6620 5f54 4845 524d 4f5f       if _THERMO_
-00007b40: 4150 495f 4156 4149 4c41 424c 4520 3d3d  API_AVAILABLE ==
-00007b50: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
-00007b60: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-00007b70: 696f 6e28 2241 7574 6f73 6372 6970 7420  ion("Autoscript 
-00007b80: 2854 6865 726d 6f46 6973 6865 7229 206e  (ThermoFisher) n
-00007b90: 6f74 2069 6e73 7461 6c6c 6564 2e20 506c  ot installed. Pl
-00007ba0: 6561 7365 2073 6565 2074 6865 2075 7365  ease see the use
-00007bb0: 7220 6775 6964 6520 666f 7220 696e 7374  r guide for inst
-00007bc0: 616c 6c61 7469 6f6e 2069 6e73 7472 7563  allation instruc
-00007bd0: 7469 6f6e 732e 2229 2020 2020 2020 2020  tions.")        
-00007be0: 2020 2020 0a20 2020 2020 2020 200a 2020      .        .  
-00007bf0: 2020 2020 2020 2320 6372 6561 7465 206d        # create m
-00007c00: 6963 726f 7363 6f70 6520 636c 6965 6e74  icroscope client
-00007c10: 200a 2020 2020 2020 2020 7365 6c66 2e63   .        self.c
-00007c20: 6f6e 6e65 6374 696f 6e20 3d20 5364 624d  onnection = SdbM
-00007c30: 6963 726f 7363 6f70 6543 6c69 656e 7428  icroscopeClient(
-00007c40: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-00007c50: 2020 2023 2069 6e69 7469 616c 6973 6520     # initialise 
-00007c60: 7379 7374 656d 2073 6574 7469 6e67 730a  system settings.
-00007c70: 2020 2020 2020 2020 7365 6c66 2e73 7973          self.sys
-00007c80: 7465 6d3a 2053 7973 7465 6d53 6574 7469  tem: SystemSetti
-00007c90: 6e67 7320 3d20 7379 7374 656d 5f73 6574  ngs = system_set
-00007ca0: 7469 6e67 730a 0a20 2020 2020 2020 2023  tings..        #
-00007cb0: 2075 7365 722c 2065 7870 6572 696d 656e   user, experimen
-00007cc0: 7420 6d65 7461 6461 7461 0a20 2020 2020  t metadata.     
-00007cd0: 2020 2023 2054 4f44 4f3a 2072 656d 6f76     # TODO: remov
-00007ce0: 6520 6f6e 6365 2064 6220 696e 7465 6772  e once db integr
-00007cf0: 6174 6564 0a20 2020 2020 2020 2073 656c  ated.        sel
-00007d00: 662e 7573 6572 203d 2046 6962 7365 6d55  f.user = FibsemU
-00007d10: 7365 722e 6672 6f6d 5f65 6e76 6972 6f6e  ser.from_environ
-00007d20: 6d65 6e74 2829 0a20 2020 2020 2020 2073  ment().        s
-00007d30: 656c 662e 6578 7065 7269 6d65 6e74 203d  elf.experiment =
-00007d40: 2046 6962 7365 6d45 7870 6572 696d 656e   FibsemExperimen
-00007d50: 7428 290a 0a20 2020 2020 2020 2023 206c  t()..        # l
-00007d60: 6f67 6769 6e67 0a20 2020 2020 2020 206c  ogging.        l
-00007d70: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
-00007d80: 7367 223a 2022 6372 6561 7465 5f6d 6963  sg": "create_mic
-00007d90: 726f 7363 6f70 655f 636c 6965 6e74 222c  roscope_client",
-00007da0: 2022 7379 7374 656d 5f73 6574 7469 6e67   "system_setting
-00007db0: 7322 3a20 7379 7374 656d 5f73 6574 7469  s": system_setti
-00007dc0: 6e67 732e 746f 5f64 6963 7428 297d 290a  ngs.to_dict()}).
-00007dd0: 0a20 2020 2064 6566 2072 6563 6f6e 6e65  .    def reconne
-00007de0: 6374 2873 656c 6629 3a0a 2020 2020 2020  ct(self):.      
-00007df0: 2020 6966 206e 6f74 2068 6173 6174 7472    if not hasattr
-00007e00: 2873 656c 662c 2022 7379 7374 656d 2229  (self, "system")
-00007e10: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00007e20: 6973 6520 4578 6365 7074 696f 6e28 2250  ise Exception("P
-00007e30: 6c65 6173 6520 636f 6e6e 6563 7420 746f  lease connect to
-00007e40: 2074 6865 206d 6963 726f 7363 6f70 6520   the microscope 
-00007e50: 6669 7273 7422 290a 2020 2020 2020 2020  first").        
-00007e60: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
-00007e70: 7363 6f6e 6e65 6374 2829 0a20 2020 2020  sconnect().     
-00007e80: 2020 2073 656c 662e 636f 6e6e 6563 745f     self.connect_
-00007e90: 746f 5f6d 6963 726f 7363 6f70 6528 7365  to_microscope(se
-00007ea0: 6c66 2e73 7973 7465 6d2e 696e 666f 2e69  lf.system.info.i
-00007eb0: 705f 6164 6472 6573 7329 0a0a 2020 2020  p_address)..    
-00007ec0: 6465 6620 6469 7363 6f6e 6e65 6374 2873  def disconnect(s
-00007ed0: 656c 6629 3a0a 2020 2020 2020 2020 7365  elf):.        se
-00007ee0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6469  lf.connection.di
-00007ef0: 7363 6f6e 6e65 6374 2829 0a20 2020 2020  sconnect().     
-00007f00: 2020 2064 656c 2073 656c 662e 636f 6e6e     del self.conn
-00007f10: 6563 7469 6f6e 0a20 2020 2020 2020 2073  ection.        s
-00007f20: 656c 662e 636f 6e6e 6563 7469 6f6e 203d  elf.connection =
-00007f30: 204e 6f6e 650a 0a20 2020 2064 6566 2063   None..    def c
-00007f40: 6f6e 6e65 6374 5f74 6f5f 6d69 6372 6f73  onnect_to_micros
-00007f50: 636f 7065 2873 656c 662c 2069 705f 6164  cope(self, ip_ad
-00007f60: 6472 6573 733a 2073 7472 2c20 706f 7274  dress: str, port
-00007f70: 3a20 696e 7420 3d20 3735 3230 2920 2d3e  : int = 7520) ->
-00007f80: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00007f90: 2222 0a20 2020 2020 2020 2043 6f6e 6e65  "".        Conne
-00007fa0: 6374 2074 6f20 6120 5468 6572 6d6f 2046  ct to a Thermo F
-00007fb0: 6973 6865 7220 6d69 6372 6f73 636f 7065  isher microscope
-00007fc0: 2061 7420 7468 6520 7370 6563 6966 6965   at the specifie
-00007fd0: 6420 4950 2061 6464 7265 7373 2061 6e64  d IP address and
-00007fe0: 2070 6f72 742e 0a0a 2020 2020 2020 2020   port...        
-00007ff0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-00008000: 2020 6970 5f61 6464 7265 7373 2028 7374    ip_address (st
-00008010: 7229 3a20 5468 6520 4950 2061 6464 7265  r): The IP addre
-00008020: 7373 206f 6620 7468 6520 6d69 6372 6f73  ss of the micros
-00008030: 636f 7065 2074 6f20 636f 6e6e 6563 7420  cope to connect 
-00008040: 746f 2e0a 2020 2020 2020 2020 2020 2020  to..            
-00008050: 706f 7274 2028 696e 7429 3a20 5468 6520  port (int): The 
-00008060: 706f 7274 206e 756d 6265 7220 6f66 2074  port number of t
-00008070: 6865 206d 6963 726f 7363 6f70 6520 2864  he microscope (d
-00008080: 6566 6175 6c74 3a20 3735 3230 292e 0a0a  efault: 7520)...
-00008090: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
-000080a0: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-000080b0: 653a 2054 6869 7320 6675 6e63 7469 6f6e  e: This function
-000080c0: 2064 6f65 736e 2774 2072 6574 7572 6e20   doesn't return 
-000080d0: 616e 7974 6869 6e67 2e0a 0a20 2020 2020  anything...     
-000080e0: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-000080f0: 2020 2020 2020 2045 7863 6570 7469 6f6e         Exception
-00008100: 3a20 4966 2074 6865 7265 2773 2061 6e20  : If there's an 
-00008110: 6572 726f 7220 7768 696c 6520 636f 6e6e  error while conn
-00008120: 6563 7469 6e67 2074 6f20 7468 6520 6d69  ecting to the mi
-00008130: 6372 6f73 636f 7065 2e0a 0a20 2020 2020  croscope...     
-00008140: 2020 2045 7861 6d70 6c65 3a0a 2020 2020     Example:.    
-00008150: 2020 2020 2020 2020 546f 2063 6f6e 6e65          To conne
-00008160: 6374 2074 6f20 6120 6d69 6372 6f73 636f  ct to a microsco
-00008170: 7065 2077 6974 6820 4950 2061 6464 7265  pe with IP addre
-00008180: 7373 2031 3932 2e31 3638 2e30 2e31 3020  ss 192.168.0.10 
-00008190: 616e 6420 706f 7274 2037 3532 303a 0a0a  and port 7520:..
-000081a0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-000081b0: 6d69 6372 6f73 636f 7065 203d 2054 6865  microscope = The
-000081c0: 726d 6f4d 6963 726f 7363 6f70 6528 290a  rmoMicroscope().
-000081d0: 2020 2020 2020 2020 2020 2020 3e3e 3e20              >>> 
-000081e0: 6d69 6372 6f73 636f 7065 2e63 6f6e 6e65  microscope.conne
-000081f0: 6374 5f74 6f5f 6d69 6372 6f73 636f 7065  ct_to_microscope
-00008200: 2822 3139 322e 3136 382e 302e 3130 222c  ("192.168.0.10",
-00008210: 2037 3532 3029 0a0a 2020 2020 2020 2020   7520)..        
-00008220: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-00008230: 656c 662e 636f 6e6e 6563 7469 6f6e 2069  elf.connection i
-00008240: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00008250: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00008260: 696f 6e20 3d20 5364 624d 6963 726f 7363  ion = SdbMicrosc
-00008270: 6f70 6543 6c69 656e 7428 290a 0a20 2020  opeClient()..   
-00008280: 2020 2020 2023 2054 4f44 4f3a 2067 6574       # TODO: get
-00008290: 2074 6865 2070 6f72 740a 2020 2020 2020   the port.      
-000082a0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-000082b0: 224d 6963 726f 7363 6f70 6520 636c 6965  "Microscope clie
-000082c0: 6e74 2063 6f6e 6e65 6374 696e 6720 746f  nt connecting to
-000082d0: 205b 7b69 705f 6164 6472 6573 737d 3a7b   [{ip_address}:{
-000082e0: 706f 7274 7d5d 2229 0a20 2020 2020 2020  port}]").       
-000082f0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00008300: 2e63 6f6e 6e65 6374 2868 6f73 743d 6970  .connect(host=ip
-00008310: 5f61 6464 7265 7373 2c20 706f 7274 3d70  _address, port=p
-00008320: 6f72 7429 0a20 2020 2020 2020 206c 6f67  ort).        log
-00008330: 6769 6e67 2e69 6e66 6f28 6622 4d69 6372  ging.info(f"Micr
-00008340: 6f73 636f 7065 2063 6c69 656e 7420 636f  oscope client co
-00008350: 6e6e 6563 7465 6420 746f 205b 7b69 705f  nnected to [{ip_
-00008360: 6164 6472 6573 737d 3a7b 706f 7274 7d5d  address}:{port}]
-00008370: 2229 0a20 2020 2020 2020 200a 2020 2020  ").        .    
-00008380: 2020 2020 2320 7379 7374 656d 2069 6e66      # system inf
-00008390: 6f72 6d61 7469 6f6e 0a20 2020 2020 2020  ormation.       
-000083a0: 2073 656c 662e 7379 7374 656d 2e69 6e66   self.system.inf
-000083b0: 6f2e 6d6f 6465 6c20 3d20 7365 6c66 2e63  o.model = self.c
-000083c0: 6f6e 6e65 6374 696f 6e2e 7365 7276 6963  onnection.servic
-000083d0: 652e 7379 7374 656d 2e6e 616d 650a 2020  e.system.name.  
-000083e0: 2020 2020 2020 7365 6c66 2e73 7973 7465        self.syste
-000083f0: 6d2e 696e 666f 2e73 6572 6961 6c5f 6e75  m.info.serial_nu
-00008400: 6d62 6572 203d 2073 656c 662e 636f 6e6e  mber = self.conn
-00008410: 6563 7469 6f6e 2e73 6572 7669 6365 2e73  ection.service.s
-00008420: 7973 7465 6d2e 7365 7269 616c 5f6e 756d  ystem.serial_num
-00008430: 6265 720a 2020 2020 2020 2020 7365 6c66  ber.        self
-00008440: 2e73 7973 7465 6d2e 696e 666f 2e68 6172  .system.info.har
-00008450: 6477 6172 655f 7665 7273 696f 6e20 3d20  dware_version = 
-00008460: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00008470: 7365 7276 6963 652e 7379 7374 656d 2e76  service.system.v
-00008480: 6572 7369 6f6e 0a20 2020 2020 2020 2073  ersion.        s
-00008490: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
-000084a0: 736f 6674 7761 7265 5f76 6572 7369 6f6e  software_version
-000084b0: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-000084c0: 6f6e 2e73 6572 7669 6365 2e61 7574 6f73  on.service.autos
-000084d0: 6372 6970 742e 636c 6965 6e74 2e76 6572  cript.client.ver
-000084e0: 7369 6f6e 0a20 2020 2020 2020 2069 6e66  sion.        inf
-000084f0: 6f20 3d20 7365 6c66 2e73 7973 7465 6d2e  o = self.system.
-00008500: 696e 666f 0a20 2020 2020 2020 206c 6f67  info.        log
-00008510: 6769 6e67 2e69 6e66 6f28 6622 4d69 6372  ging.info(f"Micr
-00008520: 6f73 636f 7065 2063 6c69 656e 7420 636f  oscope client co
-00008530: 6e6e 6563 7465 6420 746f 206d 6f64 656c  nnected to model
-00008540: 207b 696e 666f 2e6d 6f64 656c 7d20 7769   {info.model} wi
-00008550: 7468 2073 6572 6961 6c20 6e75 6d62 6572  th serial number
-00008560: 207b 696e 666f 2e73 6572 6961 6c5f 6e75   {info.serial_nu
-00008570: 6d62 6572 7d20 616e 6420 736f 6674 7761  mber} and softwa
-00008580: 7265 2076 6572 7369 6f6e 207b 696e 666f  re version {info
-00008590: 2e73 6f66 7477 6172 655f 7665 7273 696f  .software_versio
-000085a0: 6e7d 2e22 290a 2020 2020 2020 2020 0a20  n}.").        . 
-000085b0: 2020 2020 2020 2023 2061 7574 6f73 6372         # autoscr
-000085c0: 6970 7420 696e 666f 726d 6174 696f 6e0a  ipt information.
-000085d0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-000085e0: 696e 666f 2866 2241 7574 6f73 6372 6970  info(f"Autoscrip
-000085f0: 7420 436c 6965 6e74 3a20 7b73 656c 662e  t Client: {self.
-00008600: 636f 6e6e 6563 7469 6f6e 2e73 6572 7669  connection.servi
-00008610: 6365 2e61 7574 6f73 6372 6970 742e 636c  ce.autoscript.cl
-00008620: 6965 6e74 2e76 6572 7369 6f6e 7d22 290a  ient.version}").
-00008630: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00008640: 696e 666f 2866 2241 7574 6f73 6372 6970  info(f"Autoscrip
-00008650: 7420 5365 7276 6572 3a20 7b73 656c 662e  t Server: {self.
-00008660: 636f 6e6e 6563 7469 6f6e 2e73 6572 7669  connection.servi
-00008670: 6365 2e61 7574 6f73 6372 6970 742e 7365  ce.autoscript.se
-00008680: 7276 6572 2e76 6572 7369 6f6e 7d22 290a  rver.version}").
-00008690: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-000086a0: 7365 745f 6265 616d 5f73 6869 6674 7328  set_beam_shifts(
-000086b0: 290a 2020 2020 2020 2020 0a20 2020 2064  ).        .    d
-000086c0: 6566 2061 6371 7569 7265 5f69 6d61 6765  ef acquire_image
-000086d0: 2873 656c 662c 2069 6d61 6765 5f73 6574  (self, image_set
-000086e0: 7469 6e67 733a 496d 6167 6553 6574 7469  tings:ImageSetti
-000086f0: 6e67 7329 202d 3e20 4669 6273 656d 496d  ngs) -> FibsemIm
-00008700: 6167 653a 0a20 2020 2020 2020 2022 2222  age:.        """
-00008710: 0a20 2020 2020 2020 2041 6371 7569 7265  .        Acquire
-00008720: 2061 206e 6577 2069 6d61 6765 2077 6974   a new image wit
-00008730: 6820 7468 6520 7370 6563 6966 6965 6420  h the specified 
-00008740: 7365 7474 696e 6773 2e0a 0a20 2020 2020  settings...     
-00008750: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-00008760: 2020 2020 2020 2020 2069 6d61 6765 5f73           image_s
-00008770: 6574 7469 6e67 7320 2849 6d61 6765 5365  ettings (ImageSe
-00008780: 7474 696e 6773 293a 2054 6865 2073 6574  ttings): The set
-00008790: 7469 6e67 7320 666f 7220 7468 6520 6e65  tings for the ne
-000087a0: 7720 696d 6167 652e 0a0a 2020 2020 2020  w image...      
-000087b0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-000087c0: 2020 2020 2020 2046 6962 7365 6d49 6d61         FibsemIma
-000087d0: 6765 3a20 4120 6e65 7720 4669 6273 656d  ge: A new Fibsem
-000087e0: 496d 6167 6520 6f62 6a65 6374 2072 6570  Image object rep
-000087f0: 7265 7365 6e74 696e 6720 7468 6520 6163  resenting the ac
-00008800: 7175 6972 6564 2069 6d61 6765 2e0a 2020  quired image..  
-00008810: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00008820: 2020 2023 2063 6865 636b 2062 6561 6d20     # check beam 
-00008830: 656e 6162 6c65 0a20 2020 2020 2020 205f  enable.        _
-00008840: 6368 6563 6b5f 6265 616d 2869 6d61 6765  check_beam(image
-00008850: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-00008860: 7970 652c 2073 656c 662e 7379 7374 656d  ype, self.system
-00008870: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-00008880: 2020 2023 2067 6574 2074 6865 2062 6561     # get the bea
-00008890: 6d20 6170 690a 2020 2020 2020 2020 6265  m api.        be
-000088a0: 616d 203d 2028 7365 6c66 2e63 6f6e 6e65  am = (self.conne
-000088b0: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
-000088c0: 7472 6f6e 5f62 6561 6d20 0a20 2020 2020  tron_beam .     
-000088d0: 2020 2020 2020 2020 2020 2069 6620 696d             if im
-000088e0: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
-000088f0: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
-00008900: 7065 2e45 4c45 4354 524f 4e20 0a20 2020  pe.ELECTRON .   
-00008910: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00008920: 6520 7365 6c66 2e63 6f6e 6e65 6374 696f  e self.connectio
-00008930: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
-00008940: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-00008950: 2020 2020 2020 2023 2073 6574 2072 6564         # set red
-00008960: 7563 6564 2061 7265 6120 7365 7474 696e  uced area settin
-00008970: 6773 0a20 2020 2020 2020 2069 6620 696d  gs.        if im
-00008980: 6167 655f 7365 7474 696e 6773 2e72 6564  age_settings.red
-00008990: 7563 6564 5f61 7265 6120 6973 206e 6f74  uced_area is not
-000089a0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000089b0: 2020 2072 6564 7563 6564 5f61 7265 6120     reduced_area 
-000089c0: 3d20 696d 6167 655f 7365 7474 696e 6773  = image_settings
-000089d0: 2e72 6564 7563 6564 5f61 7265 612e 5f5f  .reduced_area.__
-000089e0: 746f 5f46 4549 5f5f 2829 0a20 2020 2020  to_FEI__().     
-000089f0: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
-00008a00: 6172 6e69 6e67 2866 222d 2d2d 2d2d 2d2d  arning(f"-------
-00008a10: 2d2d 2d2d 2052 4544 5543 4544 2041 5245  ---- REDUCED ARE
-00008a20: 413a 207b 7265 6475 6365 645f 6172 6561  A: {reduced_area
-00008a30: 7d20 2d2d 2d2d 2d2d 2d2d 2d2d 2d22 290a  } -----------").
-00008a40: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00008a50: 696e 672e 7761 726e 696e 6728 6622 2d2d  ing.warning(f"--
-00008a60: 2d2d 2d2d 2d2d 2d2d 2d20 4245 414d 5f54  --------- BEAM_T
-00008a70: 5950 4520 7b69 6d61 6765 5f73 6574 7469  YPE {image_setti
-00008a80: 6e67 732e 6265 616d 5f74 7970 657d 202d  ngs.beam_type} -
-00008a90: 2d2d 2d2d 2d2d 2d2d 2d2d 2229 0a20 2020  ----------").   
-00008aa0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00008ab0: 2020 2020 2020 2072 6564 7563 6564 5f61         reduced_a
-00008ac0: 7265 6120 3d20 4e6f 6e65 0a20 2020 2020  rea = None.     
-00008ad0: 2020 2020 2020 2062 6561 6d2e 7363 616e         beam.scan
-00008ae0: 6e69 6e67 2e6d 6f64 652e 7365 745f 6675  ning.mode.set_fu
-00008af0: 6c6c 5f66 7261 6d65 2829 0a0a 2020 2020  ll_frame()..    
-00008b00: 2020 2020 2320 7365 7420 7468 6520 696d      # set the im
-00008b10: 6167 696e 6720 6866 770a 2020 2020 2020  aging hfw.      
-00008b20: 2020 7365 6c66 2e73 6574 2822 6866 7722    self.set("hfw"
-00008b30: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
-00008b40: 2e68 6677 2c20 696d 6167 655f 7365 7474  .hfw, image_sett
-00008b50: 696e 6773 2e62 6561 6d5f 7479 7065 290a  ings.beam_type).
-00008b60: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00008b70: 2e69 6e66 6f28 6622 6163 7175 6972 696e  .info(f"acquirin
-00008b80: 6720 6e65 7720 7b69 6d61 6765 5f73 6574  g new {image_set
-00008b90: 7469 6e67 732e 6265 616d 5f74 7970 652e  tings.beam_type.
-00008ba0: 6e61 6d65 7d20 696d 6167 652e 2229 0a20  name} image."). 
-00008bb0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00008bc0: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e73  ection.imaging.s
-00008bd0: 6574 5f61 6374 6976 655f 7669 6577 2869  et_active_view(i
-00008be0: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
-00008bf0: 616d 5f74 7970 652e 7661 6c75 6529 0a20  am_type.value). 
-00008c00: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00008c10: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e73  ection.imaging.s
-00008c20: 6574 5f61 6374 6976 655f 6465 7669 6365  et_active_device
-00008c30: 2869 6d61 6765 5f73 6574 7469 6e67 732e  (image_settings.
-00008c40: 6265 616d 5f74 7970 652e 7661 6c75 6529  beam_type.value)
-00008c50: 0a0a 2020 2020 2020 2020 2320 7365 7420  ..        # set 
-00008c60: 7468 6520 696d 6167 696e 6720 6672 616d  the imaging fram
-00008c70: 6520 7365 7474 696e 6773 0a20 2020 2020  e settings.     
-00008c80: 2020 2066 7261 6d65 5f73 6574 7469 6e67     frame_setting
-00008c90: 7320 3d20 4772 6162 4672 616d 6553 6574  s = GrabFrameSet
-00008ca0: 7469 6e67 7328 0a20 2020 2020 2020 2020  tings(.         
-00008cb0: 2020 2072 6573 6f6c 7574 696f 6e3d 6622     resolution=f"
-00008cc0: 7b69 6d61 6765 5f73 6574 7469 6e67 732e  {image_settings.
-00008cd0: 7265 736f 6c75 7469 6f6e 5b30 5d7d 787b  resolution[0]}x{
-00008ce0: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
-00008cf0: 6573 6f6c 7574 696f 6e5b 315d 7d22 2c0a  esolution[1]}",.
-00008d00: 2020 2020 2020 2020 2020 2020 6477 656c              dwel
-00008d10: 6c5f 7469 6d65 3d69 6d61 6765 5f73 6574  l_time=image_set
-00008d20: 7469 6e67 732e 6477 656c 6c5f 7469 6d65  tings.dwell_time
-00008d30: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00008d40: 6475 6365 645f 6172 6561 3d72 6564 7563  duced_area=reduc
-00008d50: 6564 5f61 7265 612c 0a20 2020 2020 2020  ed_area,.       
-00008d60: 2020 2020 206c 696e 655f 696e 7465 6772       line_integr
-00008d70: 6174 696f 6e3d 696d 6167 655f 7365 7474  ation=image_sett
-00008d80: 696e 6773 2e6c 696e 655f 696e 7465 6772  ings.line_integr
-00008d90: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
-00008da0: 2020 2073 6361 6e5f 696e 7465 726c 6163     scan_interlac
-00008db0: 696e 673d 696d 6167 655f 7365 7474 696e  ing=image_settin
-00008dc0: 6773 2e73 6361 6e5f 696e 7465 726c 6163  gs.scan_interlac
-00008dd0: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-00008de0: 2066 7261 6d65 5f69 6e74 6567 7261 7469   frame_integrati
-00008df0: 6f6e 3d69 6d61 6765 5f73 6574 7469 6e67  on=image_setting
-00008e00: 732e 6672 616d 655f 696e 7465 6772 6174  s.frame_integrat
-00008e10: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-00008e20: 2064 7269 6674 5f63 6f72 7265 6374 696f   drift_correctio
-00008e30: 6e3d 696d 6167 655f 7365 7474 696e 6773  n=image_settings
-00008e40: 2e64 7269 6674 5f63 6f72 7265 6374 696f  .drift_correctio
-00008e50: 6e2c 0a20 2020 2020 2020 2029 0a0a 2020  n,.        )..  
-00008e60: 2020 2020 2020 696d 6167 6520 3d20 7365        image = se
-00008e70: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 696d  lf.connection.im
-00008e80: 6167 696e 672e 6772 6162 5f66 7261 6d65  aging.grab_frame
-00008e90: 2866 7261 6d65 5f73 6574 7469 6e67 7329  (frame_settings)
-00008ea0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00008eb0: 2020 2320 7265 7374 6f72 6520 746f 2066    # restore to f
-00008ec0: 756c 6c20 6672 616d 6520 696d 6167 696e  ull frame imagin
-00008ed0: 670a 2020 2020 2020 2020 6966 2069 6d61  g.        if ima
-00008ee0: 6765 5f73 6574 7469 6e67 732e 7265 6475  ge_settings.redu
-00008ef0: 6365 645f 6172 6561 2069 7320 6e6f 7420  ced_area is not 
-00008f00: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00008f10: 2020 6265 616d 2e73 6361 6e6e 696e 672e    beam.scanning.
-00008f20: 6d6f 6465 2e73 6574 5f66 756c 6c5f 6672  mode.set_full_fr
-00008f30: 616d 6528 2920 0a0a 2020 2020 2020 2020  ame() ..        
-00008f40: 2320 6765 7420 7468 6520 6d69 6372 6f73  # get the micros
-00008f50: 636f 7065 2073 7461 7465 2028 666f 7220  cope state (for 
-00008f60: 6d65 7461 6461 7461 290a 2020 2020 2020  metadata).      
-00008f70: 2020 2320 544f 444f 3a20 636f 6e76 6572    # TODO: conver
-00008f80: 7420 746f 2075 7369 6e67 2066 726f 6d41  t to using fromA
-00008f90: 646f 726e 6564 496d 6167 652c 2077 6520  dornedImage, we 
-00008fa0: 646f 6e74 206e 6565 6420 746f 2066 756c  dont need to ful
-00008fb0: 6c20 7374 6174 650a 2020 2020 2020 2020  l state.        
-00008fc0: 2320 7765 2073 686f 756c 6420 6a75 7374  # we should just
-00008fd0: 2067 6574 2074 6865 2027 7374 6174 6527   get the 'state'
-00008fe0: 206f 6620 7468 6520 696d 6167 6520 6265   of the image be
-00008ff0: 616d 2c20 652e 672e 2073 7461 6765 2c20  am, e.g. stage, 
-00009000: 6265 616d 2c20 6465 7465 6374 6f72 2066  beam, detector f
-00009010: 6f72 2065 6c65 6374 726f 6e0a 2020 2020  or electron.    
-00009020: 2020 2020 2320 7468 6572 6566 6f72 6520      # therefore 
-00009030: 7765 2064 6f6e 2774 2074 7269 6767 6572  we don't trigger
-00009040: 2074 6865 2076 6965 7720 746f 2073 7769   the view to swi
-00009050: 7463 680a 2020 2020 2020 2020 7374 6174  tch.        stat
-00009060: 6520 3d20 7365 6c66 2e67 6574 5f6d 6963  e = self.get_mic
-00009070: 726f 7363 6f70 655f 7374 6174 6528 6265  roscope_state(be
-00009080: 616d 5f74 7970 653d 696d 6167 655f 7365  am_type=image_se
-00009090: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
-000090a0: 290a 0a20 2020 2020 2020 2066 6962 7365  )..        fibse
-000090b0: 6d5f 696d 6167 6520 3d20 4669 6273 656d  m_image = Fibsem
-000090c0: 496d 6167 652e 6672 6f6d 4164 6f72 6e65  Image.fromAdorne
-000090d0: 6449 6d61 6765 280a 2020 2020 2020 2020  dImage(.        
-000090e0: 2020 2020 636f 7079 2e64 6565 7063 6f70      copy.deepcop
-000090f0: 7928 696d 6167 6529 2c20 0a20 2020 2020  y(image), .     
-00009100: 2020 2020 2020 2063 6f70 792e 6465 6570         copy.deep
-00009110: 636f 7079 2869 6d61 6765 5f73 6574 7469  copy(image_setti
-00009120: 6e67 7329 2c20 0a20 2020 2020 2020 2020  ngs), .         
-00009130: 2020 2063 6f70 792e 6465 6570 636f 7079     copy.deepcopy
-00009140: 2873 7461 7465 292c 0a20 2020 2020 2020  (state),.       
-00009150: 2029 0a0a 2020 2020 2020 2020 2320 7365   )..        # se
-00009160: 7420 6164 6469 7469 6f6e 616c 206d 6574  t additional met
-00009170: 6164 6174 610a 2020 2020 2020 2020 6669  adata.        fi
-00009180: 6273 656d 5f69 6d61 6765 2e6d 6574 6164  bsem_image.metad
-00009190: 6174 612e 7573 6572 203d 2073 656c 662e  ata.user = self.
-000091a0: 7573 6572 0a20 2020 2020 2020 2066 6962  user.        fib
-000091b0: 7365 6d5f 696d 6167 652e 6d65 7461 6461  sem_image.metada
-000091c0: 7461 2e65 7870 6572 696d 656e 7420 3d20  ta.experiment = 
-000091d0: 7365 6c66 2e65 7870 6572 696d 656e 740a  self.experiment.
-000091e0: 2020 2020 2020 2020 6669 6273 656d 5f69          fibsem_i
-000091f0: 6d61 6765 2e6d 6574 6164 6174 612e 7379  mage.metadata.sy
-00009200: 7374 656d 203d 2073 656c 662e 7379 7374  stem = self.syst
-00009210: 656d 0a0a 2020 2020 2020 2020 6c6f 6767  em..        logg
-00009220: 696e 672e 6465 6275 6728 7b22 6d73 6722  ing.debug({"msg"
-00009230: 3a20 2261 6371 7569 7265 5f69 6d61 6765  : "acquire_image
-00009240: 222c 2022 6d65 7461 6461 7461 223a 2066  ", "metadata": f
-00009250: 6962 7365 6d5f 696d 6167 652e 6d65 7461  ibsem_image.meta
-00009260: 6461 7461 2e74 6f5f 6469 6374 2829 7d29  data.to_dict()})
-00009270: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00009280: 2066 6962 7365 6d5f 696d 6167 650a 0a20   fibsem_image.. 
-00009290: 2020 2064 6566 206c 6173 745f 696d 6167     def last_imag
-000092a0: 6528 7365 6c66 2c20 6265 616d 5f74 7970  e(self, beam_typ
-000092b0: 653a 2042 6561 6d54 7970 6520 3d20 4265  e: BeamType = Be
-000092c0: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
-000092d0: 202d 3e20 4669 6273 656d 496d 6167 653a   -> FibsemImage:
-000092e0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000092f0: 2020 2020 2047 6574 2074 6865 206c 6173       Get the las
-00009300: 7420 7072 6576 696f 7573 6c79 2061 6371  t previously acq
-00009310: 7569 7265 6420 696d 6167 652e 0a0a 2020  uired image...  
-00009320: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-00009330: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
-00009340: 6520 2842 6561 6d54 7970 652c 206f 7074  e (BeamType, opt
-00009350: 696f 6e61 6c29 3a20 5468 6520 696d 6167  ional): The imag
-00009360: 696e 6720 6265 616d 2074 7970 6520 6f66  ing beam type of
-00009370: 2074 6865 206c 6173 7420 696d 6167 652e   the last image.
-00009380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009390: 2044 6566 6175 6c74 7320 746f 2042 6561   Defaults to Bea
-000093a0: 6d54 7970 652e 454c 4543 5452 4f4e 2e0a  mType.ELECTRON..
-000093b0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-000093c0: 3a0a 2020 2020 2020 2020 2020 2020 4669  :.            Fi
-000093d0: 6273 656d 496d 6167 653a 2041 206e 6577  bsemImage: A new
-000093e0: 2046 6962 7365 6d49 6d61 6765 206f 626a   FibsemImage obj
-000093f0: 6563 7420 7265 7072 6573 656e 7469 6e67  ect representing
-00009400: 2074 6865 206c 6173 7420 6163 7175 6972   the last acquir
-00009410: 6564 2069 6d61 6765 2e0a 0a20 2020 2020  ed image...     
-00009420: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-00009430: 2020 2020 2020 2045 7863 6570 7469 6f6e         Exception
-00009440: 3a20 4966 2074 6865 7265 2773 2061 6e20  : If there's an 
-00009450: 6572 726f 7220 7768 696c 6520 6765 7474  error while gett
-00009460: 696e 6720 7468 6520 6c61 7374 2069 6d61  ing the last ima
-00009470: 6765 2e0a 2020 2020 2020 2020 2222 220a  ge..        """.
-00009480: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
-00009490: 6561 6d28 6265 616d 5f74 7970 6520 3d20  eam(beam_type = 
-000094a0: 6265 616d 5f74 7970 652c 2073 6574 7469  beam_type, setti
-000094b0: 6e67 7320 3d20 7365 6c66 2e73 7973 7465  ngs = self.syste
-000094c0: 6d29 2020 2020 2020 2020 0a20 2020 2020  m)        .     
-000094d0: 2020 200a 2020 2020 2020 2020 2320 7365     .        # se
-000094e0: 7420 6163 7469 7665 2076 6965 7720 616e  t active view an
-000094f0: 6420 6465 7669 6365 0a20 2020 2020 2020  d device.       
-00009500: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00009510: 2e69 6d61 6769 6e67 2e73 6574 5f61 6374  .imaging.set_act
-00009520: 6976 655f 7669 6577 2862 6561 6d5f 7479  ive_view(beam_ty
-00009530: 7065 2e76 616c 7565 290a 2020 2020 2020  pe.value).      
-00009540: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00009550: 6e2e 696d 6167 696e 672e 7365 745f 6163  n.imaging.set_ac
-00009560: 7469 7665 5f64 6576 6963 6528 6265 616d  tive_device(beam
-00009570: 5f74 7970 652e 7661 6c75 6529 0a0a 2020  _type.value)..  
-00009580: 2020 2020 2020 2320 6765 7420 7468 6520        # get the 
-00009590: 6c61 7374 2069 6d61 6765 0a20 2020 2020  last image.     
-000095a0: 2020 2069 6d61 6765 203d 2073 656c 662e     image = self.
-000095b0: 636f 6e6e 6563 7469 6f6e 2e69 6d61 6769  connection.imagi
-000095c0: 6e67 2e67 6574 5f69 6d61 6765 2829 0a20  ng.get_image(). 
-000095d0: 2020 2020 2020 2069 6d61 6765 203d 2041         image = A
-000095e0: 646f 726e 6564 496d 6167 6528 6461 7461  dornedImage(data
-000095f0: 3d69 6d61 6765 2e64 6174 612e 6173 7479  =image.data.asty
-00009600: 7065 286e 702e 7569 6e74 3829 2c20 6d65  pe(np.uint8), me
-00009610: 7461 6461 7461 3d69 6d61 6765 2e6d 6574  tadata=image.met
-00009620: 6164 6174 6129 0a0a 2020 2020 2020 2020  adata)..        
-00009630: 2320 6765 7420 7468 6520 6d69 6372 6f73  # get the micros
-00009640: 636f 7065 2073 7461 7465 2028 666f 7220  cope state (for 
-00009650: 6d65 7461 6461 7461 290a 2020 2020 2020  metadata).      
-00009660: 2020 7374 6174 6520 3d20 7365 6c66 2e67    state = self.g
-00009670: 6574 5f6d 6963 726f 7363 6f70 655f 7374  et_microscope_st
-00009680: 6174 6528 6265 616d 5f74 7970 653d 6265  ate(beam_type=be
-00009690: 616d 5f74 7970 6529 0a0a 2020 2020 2020  am_type)..      
-000096a0: 2020 2320 6765 7420 7468 6520 696d 6167    # get the imag
-000096b0: 6520 7365 7474 696e 6773 2066 726f 6d20  e settings from 
-000096c0: 7468 6520 696d 6167 650a 2020 2020 2020  the image.      
-000096d0: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
-000096e0: 203d 2046 6962 7365 6d49 6d61 6765 4d65   = FibsemImageMe
-000096f0: 7461 6461 7461 2e69 6d61 6765 5f73 6574  tadata.image_set
-00009700: 7469 6e67 735f 6672 6f6d 5f61 646f 726e  tings_from_adorn
-00009710: 6564 280a 2020 2020 2020 2020 2020 2020  ed(.            
-00009720: 696d 6167 652c 2062 6561 6d5f 7479 7065  image, beam_type
-00009730: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00009740: 2020 2020 2320 6372 6561 7465 2074 6865      # create the
-00009750: 2066 6962 7365 6d20 696d 6167 650a 2020   fibsem image.  
-00009760: 2020 2020 2020 6669 6273 656d 5f69 6d61        fibsem_ima
-00009770: 6765 203d 2046 6962 7365 6d49 6d61 6765  ge = FibsemImage
-00009780: 2e66 726f 6d41 646f 726e 6564 496d 6167  .fromAdornedImag
-00009790: 6528 696d 6167 652c 2069 6d61 6765 5f73  e(image, image_s
-000097a0: 6574 7469 6e67 732c 2073 7461 7465 290a  ettings, state).
-000097b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000097c0: 2023 2073 6574 2061 6464 6974 696f 6e61   # set additiona
-000097d0: 6c20 6d65 7461 6461 7461 0a20 2020 2020  l metadata.     
-000097e0: 2020 2066 6962 7365 6d5f 696d 6167 652e     fibsem_image.
-000097f0: 6d65 7461 6461 7461 2e75 7365 7220 3d20  metadata.user = 
-00009800: 7365 6c66 2e75 7365 720a 2020 2020 2020  self.user.      
-00009810: 2020 6669 6273 656d 5f69 6d61 6765 2e6d    fibsem_image.m
-00009820: 6574 6164 6174 612e 6578 7065 7269 6d65  etadata.experime
-00009830: 6e74 203d 2073 656c 662e 6578 7065 7269  nt = self.experi
-00009840: 6d65 6e74 0a20 2020 2020 2020 2066 6962  ment.        fib
-00009850: 7365 6d5f 696d 6167 652e 6d65 7461 6461  sem_image.metada
-00009860: 7461 2e73 7973 7465 6d20 3d20 7365 6c66  ta.system = self
-00009870: 2e73 7973 7465 6d0a 0a20 2020 2020 2020  .system..       
-00009880: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-00009890: 226d 7367 223a 2022 6163 7175 6972 655f  "msg": "acquire_
-000098a0: 696d 6167 6522 2c20 226d 6574 6164 6174  image", "metadat
-000098b0: 6122 3a20 6669 6273 656d 5f69 6d61 6765  a": fibsem_image
-000098c0: 2e6d 6574 6164 6174 612e 746f 5f64 6963  .metadata.to_dic
-000098d0: 7428 297d 290a 2020 2020 0a20 2020 2020  t()}).    .     
-000098e0: 2020 2072 6574 7572 6e20 6669 6273 656d     return fibsem
-000098f0: 5f69 6d61 6765 0a0a 2020 2020 6465 6620  _image..    def 
-00009900: 6163 7175 6972 655f 6368 616d 6265 725f  acquire_chamber_
-00009910: 696d 6167 6528 7365 6c66 2920 2d3e 2046  image(self) -> F
-00009920: 6962 7365 6d49 6d61 6765 3a0a 2020 2020  ibsemImage:.    
-00009930: 2020 2020 2222 2241 6371 7569 7265 2061      """Acquire a
-00009940: 6e20 696d 6167 6520 6f66 2074 6865 2063  n image of the c
-00009950: 6861 6d62 6572 2069 6e73 6964 652e 2222  hamber inside.""
-00009960: 220a 2020 2020 2020 2020 7365 6c66 2e63  ".        self.c
-00009970: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
-00009980: 672e 7365 745f 6163 7469 7665 5f76 6965  g.set_active_vie
-00009990: 7728 3429 0a20 2020 2020 2020 2073 656c  w(4).        sel
-000099a0: 662e 636f 6e6e 6563 7469 6f6e 2e69 6d61  f.connection.ima
-000099b0: 6769 6e67 2e73 6574 5f61 6374 6976 655f  ging.set_active_
-000099c0: 6465 7669 6365 2833 290a 2020 2020 2020  device(3).      
-000099d0: 2020 696d 6167 6520 3d20 7365 6c66 2e63    image = self.c
-000099e0: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
-000099f0: 672e 6765 745f 696d 6167 6528 290a 2020  g.get_image().  
-00009a00: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
-00009a10: 6275 6728 7b22 6d73 6722 3a20 2261 6371  bug({"msg": "acq
-00009a20: 7569 7265 5f63 6861 6d62 6572 5f69 6d61  uire_chamber_ima
-00009a30: 6765 227d 290a 2020 2020 2020 2020 7265  ge"}).        re
-00009a40: 7475 726e 2046 6962 7365 6d49 6d61 6765  turn FibsemImage
-00009a50: 2864 6174 613d 696d 6167 652e 6461 7461  (data=image.data
-00009a60: 2c20 6d65 7461 6461 7461 3d4e 6f6e 6529  , metadata=None)
-00009a70: 2020 200a 2020 2020 0a20 2020 2064 6566     .    .    def
-00009a80: 206c 6976 655f 696d 6167 696e 6728 7365   live_imaging(se
-00009a90: 6c66 2c20 696d 6167 655f 7365 7474 696e  lf, image_settin
-00009aa0: 6773 3a20 496d 6167 6553 6574 7469 6e67  gs: ImageSetting
-00009ab0: 732c 2069 6d61 6765 5f71 7565 7565 3a20  s, image_queue: 
-00009ac0: 5175 6575 652c 2073 746f 705f 6576 656e  Queue, stop_even
-00009ad0: 743a 2074 6872 6561 6469 6e67 2e45 7665  t: threading.Eve
-00009ae0: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-00009af0: 2073 656c 662e 696d 6167 655f 7175 6575   self.image_queu
-00009b00: 6520 3d20 696d 6167 655f 7175 6575 650a  e = image_queue.
-00009b10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00009b20: 2e73 746f 705f 6576 656e 7420 3d20 7374  .stop_event = st
-00009b30: 6f70 5f65 7665 6e74 0a20 2020 2020 2020  op_event.       
-00009b40: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00009b50: 2869 6d61 6765 5f73 6574 7469 6e67 732e  (image_settings.
-00009b60: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-00009b70: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
-00009b80: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00009b90: 2866 224c 6976 6520 696d 6167 696e 673a  (f"Live imaging:
-00009ba0: 207b 696d 6167 655f 7365 7474 696e 6773   {image_settings
-00009bb0: 2e62 6561 6d5f 7479 7065 7d22 290a 2020  .beam_type}").  
-00009bc0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00009bd0: 6e6f 7420 7365 6c66 2e73 746f 705f 6576  not self.stop_ev
-00009be0: 656e 742e 6973 5f73 6574 2829 3a0a 2020  ent.is_set():.  
-00009bf0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00009c00: 6167 6520 3d20 7365 6c66 2e61 6371 7569  age = self.acqui
-00009c10: 7265 5f69 6d61 6765 2864 6565 7063 6f70  re_image(deepcop
-00009c20: 7928 696d 6167 655f 7365 7474 696e 6773  y(image_settings
-00009c30: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00009c40: 2020 2069 6d61 6765 5f71 7565 7565 2e70     image_queue.p
-00009c50: 7574 2869 6d61 6765 290a 0a0a 0a20 2020  ut(image)....   
-00009c60: 2040 7468 7265 6164 5f77 6f72 6b65 720a   @thread_worker.
-00009c70: 2020 2020 6465 6620 636f 6e73 756d 655f      def consume_
-00009c80: 696d 6167 655f 7175 6575 6528 7365 6c66  image_queue(self
-00009c90: 2c20 7061 7265 6e74 5f75 6920 3d20 4e6f  , parent_ui = No
-00009ca0: 6e65 2c20 736c 6565 7020 3d20 302e 3129  ne, sleep = 0.1)
-00009cb0: 3a0a 0a20 2020 2020 2020 206c 6f67 6769  :..        loggi
-00009cc0: 6e67 2e69 6e66 6f28 2243 6f6e 7375 6d69  ng.info("Consumi
-00009cd0: 6e67 2069 6d61 6765 2071 7565 7565 2229  ng image queue")
-00009ce0: 0a0a 2020 2020 2020 2020 7768 696c 6520  ..        while 
-00009cf0: 6e6f 7420 7365 6c66 2e73 746f 705f 6576  not self.stop_ev
-00009d00: 656e 742e 6973 5f73 6574 2829 3a0a 2020  ent.is_set():.  
-00009d10: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00009d20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00009d30: 696d 652e 736c 6565 7028 736c 6565 7029  ime.sleep(sleep)
-00009d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009d50: 2069 6620 6e6f 7420 7365 6c66 2e69 6d61   if not self.ima
-00009d60: 6765 5f71 7565 7565 2e65 6d70 7479 2829  ge_queue.empty()
-00009d70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009d80: 2020 2020 2020 696d 6167 6520 3d20 7365        image = se
-00009d90: 6c66 2e69 6d61 6765 5f71 7565 7565 2e67  lf.image_queue.g
-00009da0: 6574 2874 696d 656f 7574 3d31 290a 2020  et(timeout=1).  
-00009db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009dc0: 2020 6966 2069 6d61 6765 2e6d 6574 6164    if image.metad
-00009dd0: 6174 612e 696d 6167 655f 7365 7474 696e  ata.image_settin
-00009de0: 6773 2e73 6176 653a 0a20 2020 2020 2020  gs.save:.       
-00009df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009e00: 2069 6d61 6765 2e6d 6574 6164 6174 612e   image.metadata.
-00009e10: 696d 6167 655f 7365 7474 696e 6773 2e66  image_settings.f
-00009e20: 696c 656e 616d 6520 3d20 6622 7b69 6d61  ilename = f"{ima
-00009e30: 6765 2e6d 6574 6164 6174 612e 696d 6167  ge.metadata.imag
-00009e40: 655f 7365 7474 696e 6773 2e66 696c 656e  e_settings.filen
-00009e50: 616d 657d 5f7b 7574 696c 732e 6375 7272  ame}_{utils.curr
-00009e60: 656e 745f 7469 6d65 7374 616d 7028 297d  ent_timestamp()}
-00009e70: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00009e80: 2020 2020 2020 2020 2020 6669 6c65 6e61            filena
-00009e90: 6d65 203d 206f 732e 7061 7468 2e6a 6f69  me = os.path.joi
-00009ea0: 6e28 696d 6167 652e 6d65 7461 6461 7461  n(image.metadata
-00009eb0: 2e69 6d61 6765 5f73 6574 7469 6e67 732e  .image_settings.
-00009ec0: 7061 7468 2c20 696d 6167 652e 6d65 7461  path, image.meta
-00009ed0: 6461 7461 2e69 6d61 6765 5f73 6574 7469  data.image_setti
-00009ee0: 6e67 732e 6669 6c65 6e61 6d65 290a 2020  ngs.filename).  
-00009ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f00: 2020 2020 2020 696d 6167 652e 7361 7665        image.save
-00009f10: 2870 6174 683d 6669 6c65 6e61 6d65 290a  (path=filename).
-00009f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f30: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00009f40: 696e 666f 2866 2253 6176 6564 2069 6d61  info(f"Saved ima
-00009f50: 6765 2074 6f20 7b66 696c 656e 616d 657d  ge to {filename}
-00009f60: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-00009f70: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00009f80: 696e 666f 2866 2249 6d61 6765 3a20 7b69  info(f"Image: {i
-00009f90: 6d61 6765 2e64 6174 612e 7368 6170 657d  mage.data.shape}
-00009fa0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00009fb0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00009fc0: 6e66 6f28 6622 2d22 202a 2035 3029 0a0a  nfo(f"-" * 50)..
-00009fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fe0: 2020 2020 6966 2070 6172 656e 745f 7569      if parent_ui
-00009ff0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a010: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
-0000a020: 5f75 692e 6c69 7665 5f69 6d61 6769 6e67  _ui.live_imaging
-0000a030: 5f73 6967 6e61 6c2e 656d 6974 287b 2269  _signal.emit({"i
-0000a040: 6d61 6765 223a 2069 6d61 6765 7d29 0a0a  mage": image})..
-0000a050: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000a060: 6570 7420 4b65 7962 6f61 7264 496e 7465  ept KeyboardInte
-0000a070: 7272 7570 743a 0a20 2020 2020 2020 2020  rrupt:.         
-0000a080: 2020 2020 2020 2073 656c 662e 7374 6f70         self.stop
-0000a090: 5f65 7665 6e74 0a20 2020 2020 2020 2020  _event.         
-0000a0a0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0000a0b0: 6e66 6f28 224b 6579 626f 6172 6420 696e  nfo("Keyboard in
-0000a0c0: 7465 7272 7570 742c 2073 746f 7070 696e  terrupt, stoppin
-0000a0d0: 6720 6c69 7665 2069 6d61 6769 6e67 2229  g live imaging")
-0000a0e0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000a0f0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-0000a100: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-0000a110: 2020 2020 7365 6c66 2e73 746f 705f 6576      self.stop_ev
-0000a120: 656e 742e 7365 7428 290a 2020 2020 2020  ent.set().      
-0000a130: 2020 2020 2020 2020 2020 696d 706f 7274            import
-0000a140: 2074 7261 6365 6261 636b 0a20 2020 2020   traceback.     
-0000a150: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-0000a160: 6e67 2e65 7272 6f72 2874 7261 6365 6261  ng.error(traceba
-0000a170: 636b 2e66 6f72 6d61 745f 6578 6328 2929  ck.format_exc())
-0000a180: 0a0a 2020 2020 6465 6620 6175 746f 636f  ..    def autoco
-0000a190: 6e74 7261 7374 2873 656c 662c 2062 6561  ntrast(self, bea
-0000a1a0: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
-0000a1b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0000a1c0: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
-0000a1d0: 7574 6f6d 6174 6963 616c 6c79 2061 646a  utomatically adj
-0000a1e0: 7573 7420 7468 6520 6d69 6372 6f73 636f  ust the microsco
-0000a1f0: 7065 2069 6d61 6765 2063 6f6e 7472 6173  pe image contras
-0000a200: 7420 666f 7220 7468 6520 7370 6563 6966  t for the specif
-0000a210: 6965 6420 6265 616d 2074 7970 652e 0a0a  ied beam type...
-0000a220: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0000a230: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
-0000a240: 7970 6520 2842 6561 6d54 7970 6529 2054  ype (BeamType) T
-0000a250: 6865 2069 6d61 6769 6e67 2062 6561 6d20  he imaging beam 
-0000a260: 7479 7065 2066 6f72 2077 6869 6368 2074  type for which t
-0000a270: 6f20 6164 6a75 7374 2074 6865 2063 6f6e  o adjust the con
-0000a280: 7472 6173 742e 0a20 2020 2020 2020 2022  trast..        "
-0000a290: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
-0000a2a0: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-0000a2b0: 203d 2062 6561 6d5f 7479 7065 2c20 7365   = beam_type, se
-0000a2c0: 7474 696e 6773 203d 2073 656c 662e 7379  ttings = self.sy
-0000a2d0: 7374 656d 290a 2020 2020 2020 2020 6c6f  stem).        lo
-0000a2e0: 6767 696e 672e 6465 6275 6728 6622 5275  gging.debug(f"Ru
-0000a2f0: 6e6e 696e 6720 6175 746f 636f 6e74 7261  nning autocontra
-0000a300: 7374 206f 6e20 7b62 6561 6d5f 7479 7065  st on {beam_type
-0000a310: 2e6e 616d 657d 2e22 290a 2020 2020 2020  .name}.").      
-0000a320: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-0000a330: 6e2e 696d 6167 696e 672e 7365 745f 6163  n.imaging.set_ac
-0000a340: 7469 7665 5f76 6965 7728 6265 616d 5f74  tive_view(beam_t
-0000a350: 7970 652e 7661 6c75 6529 0a20 2020 2020  ype.value).     
-0000a360: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0000a370: 6f6e 2e69 6d61 6769 6e67 2e73 6574 5f61  on.imaging.set_a
-0000a380: 6374 6976 655f 6465 7669 6365 2862 6561  ctive_device(bea
-0000a390: 6d5f 7479 7065 2e76 616c 7565 290a 2020  m_type.value).  
-0000a3a0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0000a3b0: 6374 696f 6e2e 6175 746f 5f66 756e 6374  ction.auto_funct
-0000a3c0: 696f 6e73 2e72 756e 5f61 7574 6f5f 6362  ions.run_auto_cb
-0000a3d0: 2829 0a20 2020 2020 2020 206c 6f67 6769  ().        loggi
-0000a3e0: 6e67 2e64 6562 7567 287b 6622 6d73 6722  ng.debug({f"msg"
-0000a3f0: 3a20 2261 7574 6f63 6f6e 7472 6173 7422  : "autocontrast"
-0000a400: 2c20 2262 6561 6d5f 7479 7065 223a 2062  , "beam_type": b
-0000a410: 6561 6d5f 7479 7065 2e6e 616d 657d 290a  eam_type.name}).
-0000a420: 0a20 2020 2064 6566 2061 7574 6f5f 666f  .    def auto_fo
-0000a430: 6375 7328 7365 6c66 2c20 6265 616d 5f74  cus(self, beam_t
-0000a440: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
-0000a450: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000a460: 2222 2241 7574 6f6d 6174 6963 616c 6c79  """Automatically
-0000a470: 2066 6f63 7573 2074 6865 2073 7065 6369   focus the speci
-0000a480: 6669 6564 2062 6561 6d20 7479 7065 2e0a  fied beam type..
-0000a490: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-0000a4a0: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-0000a4b0: 7479 7065 2028 4265 616d 5479 7065 293a  type (BeamType):
-0000a4c0: 2054 6865 2069 6d61 6769 6e67 2062 6561   The imaging bea
-0000a4d0: 6d20 7479 7065 2066 6f72 2077 6869 6368  m type for which
-0000a4e0: 2074 6f20 666f 6375 732e 0a20 2020 2020   to focus..     
-0000a4f0: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
-0000a500: 6368 6563 6b5f 6265 616d 2862 6561 6d5f  check_beam(beam_
-0000a510: 7479 7065 203d 2062 6561 6d5f 7479 7065  type = beam_type
-0000a520: 2c20 7365 7474 696e 6773 203d 2073 656c  , settings = sel
-0000a530: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
-0000a540: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
-0000a550: 6622 5275 6e6e 696e 6720 6175 746f 2d66  f"Running auto-f
-0000a560: 6f63 7573 206f 6e20 7b62 6561 6d5f 7479  ocus on {beam_ty
-0000a570: 7065 2e6e 616d 657d 2e22 290a 2020 2020  pe.name}.").    
-0000a580: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0000a590: 696f 6e2e 696d 6167 696e 672e 7365 745f  ion.imaging.set_
-0000a5a0: 6163 7469 7665 5f76 6965 7728 6265 616d  active_view(beam
-0000a5b0: 5f74 7970 652e 7661 6c75 6529 2020 0a20  _type.value)  . 
-0000a5c0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0000a5d0: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e73  ection.imaging.s
-0000a5e0: 6574 5f61 6374 6976 655f 6465 7669 6365  et_active_device
-0000a5f0: 2862 6561 6d5f 7479 7065 2e76 616c 7565  (beam_type.value
-0000a600: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0000a610: 6f6e 6e65 6374 696f 6e2e 6175 746f 5f66  onnection.auto_f
-0000a620: 756e 6374 696f 6e73 2e72 756e 5f61 7574  unctions.run_aut
-0000a630: 6f5f 666f 6375 7328 290a 2020 2020 2020  o_focus().      
-0000a640: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
-0000a650: 7b22 6d73 6722 3a20 2261 7574 6f5f 666f  {"msg": "auto_fo
-0000a660: 6375 7322 2c20 2262 6561 6d5f 7479 7065  cus", "beam_type
-0000a670: 223a 2062 6561 6d5f 7479 7065 2e6e 616d  ": beam_type.nam
-0000a680: 657d 2920 2020 2020 2020 0a0a 2020 2020  e})       ..    
-0000a690: 6465 6620 6265 616d 5f73 6869 6674 2873  def beam_shift(s
-0000a6a0: 656c 662c 2064 783a 2066 6c6f 6174 2c20  elf, dx: float, 
-0000a6b0: 6479 3a20 666c 6f61 742c 2062 6561 6d5f  dy: float, beam_
-0000a6c0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-0000a6d0: 2042 6561 6d54 7970 652e 494f 4e29 202d   BeamType.ION) -
-0000a6e0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000a6f0: 2222 220a 2020 2020 2020 2020 4164 6a75  """.        Adju
-0000a700: 7374 7320 7468 6520 6265 616d 2073 6869  sts the beam shi
-0000a710: 6674 2062 6173 6564 206f 6e20 7265 6c61  ft based on rela
-0000a720: 7469 7665 2076 616c 7565 7320 7468 6174  tive values that
-0000a730: 2061 7265 2070 726f 7669 6465 642e 0a20   are provided.. 
-0000a740: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0000a750: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-0000a760: 2020 7365 6c66 2028 4669 6273 656d 4d69    self (FibsemMi
-0000a770: 6372 6f73 636f 7065 293a 2046 6962 7365  croscope): Fibse
-0000a780: 6d20 6d69 6372 6f73 636f 7065 206f 626a  m microscope obj
-0000a790: 6563 740a 2020 2020 2020 2020 2020 2020  ect.            
-0000a7a0: 6478 2028 666c 6f61 7429 3a20 7468 6520  dx (float): the 
-0000a7b0: 7265 6c61 7469 7665 2078 2074 6572 6d0a  relative x term.
-0000a7c0: 2020 2020 2020 2020 2020 2020 6479 2028              dy (
-0000a7d0: 666c 6f61 7429 3a20 7468 6520 7265 6c61  float): the rela
-0000a7e0: 7469 7665 2079 2074 6572 6d0a 2020 2020  tive y term.    
-0000a7f0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000a800: 2320 544f 444f 3a20 6368 616e 6765 2074  # TODO: change t
-0000a810: 6869 7320 746f 2075 7365 2074 6865 2073  his to use the s
-0000a820: 6574 2061 7069 2020 2020 0a20 2020 2020  et api    .     
-0000a830: 2020 205f 6368 6563 6b5f 6265 616d 2862     _check_beam(b
-0000a840: 6561 6d5f 7479 7065 2c20 7365 6c66 2e73  eam_type, self.s
-0000a850: 7973 7465 6d29 0a0a 2020 2020 2020 2020  ystem)..        
-0000a860: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
-0000a870: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
-0000a880: 7368 6966 7469 6e67 2062 7920 287b 6478  shifting by ({dx
-0000a890: 7d2c 207b 6479 7d29 2229 0a20 2020 2020  }, {dy})").     
-0000a8a0: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
-0000a8b0: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
-0000a8c0: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
-0000a8d0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-0000a8e0: 6e2e 6265 616d 732e 656c 6563 7472 6f6e  n.beams.electron
-0000a8f0: 5f62 6561 6d2e 6265 616d 5f73 6869 6674  _beam.beam_shift
-0000a900: 2e76 616c 7565 202b 3d20 2864 782c 2064  .value += (dx, d
-0000a910: 7929 0a20 2020 2020 2020 2065 6c73 653a  y).        else:
-0000a920: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000a930: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
-0000a940: 6d73 2e69 6f6e 5f62 6561 6d2e 6265 616d  ms.ion_beam.beam
-0000a950: 5f73 6869 6674 2e76 616c 7565 202b 3d20  _shift.value += 
-0000a960: 2864 782c 2064 7929 0a20 2020 200a 2020  (dx, dy).    .  
-0000a970: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
-0000a980: 6275 6728 7b22 6d73 6722 3a20 2262 6561  bug({"msg": "bea
-0000a990: 6d5f 7368 6966 7422 2c20 2264 7822 3a20  m_shift", "dx": 
-0000a9a0: 6478 2c20 2264 7922 3a20 6479 2c20 2262  dx, "dy": dy, "b
-0000a9b0: 6561 6d5f 7479 7065 223a 2062 6561 6d5f  eam_type": beam_
-0000a9c0: 7479 7065 2e6e 616d 657d 2920 0a0a 2020  type.name}) ..  
-0000a9d0: 2020 0a20 2020 2064 6566 206d 6f76 655f    .    def move_
-0000a9e0: 7374 6167 655f 6162 736f 6c75 7465 2873  stage_absolute(s
-0000a9f0: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
-0000aa00: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-0000aa10: 6f6e 2920 2d3e 2046 6962 7365 6d53 7461  on) -> FibsemSta
-0000aa20: 6765 506f 7369 7469 6f6e 3a0a 2020 2020  gePosition:.    
-0000aa30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000aa40: 4d6f 7665 2074 6865 2073 7461 6765 2074  Move the stage t
-0000aa50: 6f20 7468 6520 7370 6563 6966 6965 6420  o the specified 
-0000aa60: 636f 6f72 6469 6e61 7465 732e 0a0a 2020  coordinates...  
-0000aa70: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-0000aa80: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
-0000aa90: 3a20 5468 6520 7261 7720 7374 6167 6520  : The raw stage 
-0000aaa0: 706f 7369 7469 6f6e 2074 6f20 6d6f 7665  position to move
-0000aab0: 2074 6f2e 0a0a 2020 2020 2020 2020 5265   to...        Re
-0000aac0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-0000aad0: 2020 2046 6962 7365 6d53 7461 6765 506f     FibsemStagePo
-0000aae0: 7369 7469 6f6e 3a20 5468 6520 7374 6167  sition: The stag
-0000aaf0: 6520 706f 7369 7469 6f6e 2061 6674 6572  e position after
-0000ab00: 206d 6f76 656d 656e 742e 0a20 2020 2020   movement..     
-0000ab10: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0000ab20: 2222 220a 2020 2020 2020 2020 5f63 6865  """.        _che
-0000ab30: 636b 5f73 7461 6765 5f6d 6f76 656d 656e  ck_stage_movemen
-0000ab40: 7428 7365 6c66 2e73 7973 7465 6d2c 2070  t(self.system, p
-0000ab50: 6f73 6974 696f 6e29 0a0a 2020 2020 2020  osition)..      
-0000ab60: 2020 2320 6765 7420 6375 7272 656e 7420    # get current 
-0000ab70: 776f 726b 696e 6720 6469 7374 616e 6365  working distance
-0000ab80: 2c20 746f 2062 6520 7265 7374 6f72 6564  , to be restored
-0000ab90: 206c 6174 6572 2020 2020 2020 2020 2020   later          
-0000aba0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0000abb0: 2020 7764 203d 2073 656c 662e 6765 7428    wd = self.get(
-0000abc0: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
-0000abd0: 6522 2c20 4265 616d 5479 7065 2e45 4c45  e", BeamType.ELE
-0000abe0: 4354 524f 4e29 0a20 2020 2020 2020 200a  CTRON).        .
-0000abf0: 2020 2020 2020 2020 2320 636f 6e76 6572          # conver
-0000ac00: 7420 746f 2061 7574 6f73 6372 6970 7420  t to autoscript 
-0000ac10: 706f 7369 7469 6f6e 0a20 2020 2020 2020  position.       
-0000ac20: 2061 7574 6f73 6372 6970 745f 706f 7369   autoscript_posi
-0000ac30: 7469 6f6e 203d 2070 6f73 6974 696f 6e2e  tion = position.
-0000ac40: 746f 5f61 7574 6f73 6372 6970 745f 706f  to_autoscript_po
-0000ac50: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
-0000ac60: 2061 7574 6f73 6372 6970 745f 706f 7369   autoscript_posi
-0000ac70: 7469 6f6e 2e63 6f6f 7264 696e 6174 655f  tion.coordinate_
-0000ac80: 7379 7374 656d 203d 2043 6f6f 7264 696e  system = Coordin
-0000ac90: 6174 6553 7973 7465 6d2e 5241 570a 2020  ateSystem.RAW.  
-0000aca0: 2020 2020 2020 0a20 2020 2020 2020 206c        .        l
-0000acb0: 6f67 6769 6e67 2e69 6e66 6f28 6622 4d6f  ogging.info(f"Mo
-0000acc0: 7669 6e67 2073 7461 6765 2074 6f20 7b70  ving stage to {p
-0000acd0: 6f73 6974 696f 6e7d 2e22 290a 2020 2020  osition}.").    
-0000ace0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0000acf0: 696f 6e2e 7370 6563 696d 656e 2e73 7461  ion.specimen.sta
-0000ad00: 6765 2e61 6273 6f6c 7574 655f 6d6f 7665  ge.absolute_move
-0000ad10: 2861 7574 6f73 6372 6970 745f 706f 7369  (autoscript_posi
-0000ad20: 7469 6f6e 2c20 4d6f 7665 5365 7474 696e  tion, MoveSettin
-0000ad30: 6773 2872 6f74 6174 655f 636f 6d70 7563  gs(rotate_compuc
-0000ad40: 656e 7472 6963 3d54 7275 6529 2920 2320  entric=True)) # 
-0000ad50: 544f 444f 3a20 5468 6973 206e 6565 6473  TODO: This needs
-0000ad60: 2061 7420 6c65 6173 7420 616e 206f 7074   at least an opt
-0000ad70: 696f 6e61 6c20 7361 6665 206d 6f76 6520  ional safe move 
-0000ad80: 746f 2070 7265 7665 6e74 2063 6f6c 6c69  to prevent colli
-0000ad90: 7369 6f6e 3f0a 2020 2020 2020 2020 2020  sion?.          
-0000ada0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0000adb0: 2020 2320 7265 7374 6f72 6520 776f 726b    # restore work
-0000adc0: 696e 6720 6469 7374 616e 6365 2074 6f20  ing distance to 
-0000add0: 6164 6a75 7374 2066 6f72 206d 6963 726f  adjust for micro
-0000ade0: 7363 6f70 6520 636f 6d70 656e 7374 6174  scope compenstat
-0000adf0: 696f 6e0a 2020 2020 2020 2020 7365 6c66  ion.        self
-0000ae00: 2e73 6574 2822 776f 726b 696e 675f 6469  .set("working_di
-0000ae10: 7374 616e 6365 222c 2077 642c 2042 6561  stance", wd, Bea
-0000ae20: 6d54 7970 652e 454c 4543 5452 4f4e 290a  mType.ELECTRON).
-0000ae30: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0000ae40: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
-0000ae50: 7567 287b 226d 7367 223a 2022 6d6f 7665  ug({"msg": "move
-0000ae60: 5f73 7461 6765 5f61 6273 6f6c 7574 6522  _stage_absolute"
-0000ae70: 2c20 2270 6f73 6974 696f 6e22 3a20 706f  , "position": po
-0000ae80: 7369 7469 6f6e 2e74 6f5f 6469 6374 2829  sition.to_dict()
-0000ae90: 7d29 0a20 2020 2020 2020 200a 2020 2020  }).        .    
-0000aea0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000aeb0: 6765 745f 7374 6167 655f 706f 7369 7469  get_stage_positi
-0000aec0: 6f6e 2829 0a20 2020 2020 2020 200a 2020  on().        .  
-0000aed0: 2020 6465 6620 6d6f 7665 5f73 7461 6765    def move_stage
-0000aee0: 5f72 656c 6174 6976 6528 7365 6c66 2c20  _relative(self, 
-0000aef0: 706f 7369 7469 6f6e 3a20 4669 6273 656d  position: Fibsem
-0000af00: 5374 6167 6550 6f73 6974 696f 6e29 202d  StagePosition) -
-0000af10: 3e20 4669 6273 656d 5374 6167 6550 6f73  > FibsemStagePos
-0000af20: 6974 696f 6e3a 0a20 2020 2020 2020 2022  ition:.        "
-0000af30: 2222 0a20 2020 2020 2020 204d 6f76 6520  "".        Move 
-0000af40: 7468 6520 7374 6167 6520 6279 2074 6865  the stage by the
-0000af50: 2073 7065 6369 6669 6564 2072 656c 6174   specified relat
-0000af60: 6976 6520 6d6f 7665 2e0a 0a20 2020 2020  ive move...     
-0000af70: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000af80: 2020 2020 2070 6f73 6974 696f 6e3a 2074       position: t
-0000af90: 6865 2072 656c 6174 6976 6520 7374 6167  he relative stag
-0000afa0: 6520 706f 7369 7469 6f6e 2074 6f20 6d6f  e position to mo
-0000afb0: 7665 2062 792e 0a0a 2020 2020 2020 2020  ve by...        
-0000afc0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-0000afd0: 2020 2020 204e 6f6e 650a 2020 2020 2020       None.      
-0000afe0: 2020 2222 220a 0a20 2020 2020 2020 205f    """..        _
-0000aff0: 6368 6563 6b5f 7374 6167 655f 6d6f 7665  check_stage_move
-0000b000: 6d65 6e74 2873 656c 662e 7379 7374 656d  ment(self.system
-0000b010: 2c20 706f 7369 7469 6f6e 290a 0a20 2020  , position)..   
-0000b020: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0000b030: 6f28 6622 4d6f 7669 6e67 2073 7461 6765  o(f"Moving stage
-0000b040: 2062 7920 7b70 6f73 6974 696f 6e7d 2e22   by {position}."
-0000b050: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-0000b060: 2020 2023 2063 6f6e 7665 7274 2074 6f20     # convert to 
-0000b070: 6175 746f 7363 7269 7074 2070 6f73 6974  autoscript posit
-0000b080: 696f 6e0a 2020 2020 2020 2020 7468 6572  ion.        ther
-0000b090: 6d6f 5f70 6f73 6974 696f 6e20 3d20 706f  mo_position = po
-0000b0a0: 7369 7469 6f6e 2e74 6f5f 6175 746f 7363  sition.to_autosc
-0000b0b0: 7269 7074 5f70 6f73 6974 696f 6e28 290a  ript_position().
-0000b0c0: 2020 2020 2020 2020 7468 6572 6d6f 5f70          thermo_p
-0000b0d0: 6f73 6974 696f 6e2e 636f 6f72 6469 6e61  osition.coordina
-0000b0e0: 7465 5f73 7973 7465 6d20 3d20 436f 6f72  te_system = Coor
-0000b0f0: 6469 6e61 7465 5379 7374 656d 2e52 4157  dinateSystem.RAW
-0000b100: 0a0a 2020 2020 2020 2020 2320 6d6f 7665  ..        # move
-0000b110: 2073 7461 6765 0a20 2020 2020 2020 2073   stage.        s
-0000b120: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
-0000b130: 7065 6369 6d65 6e2e 7374 6167 652e 7265  pecimen.stage.re
-0000b140: 6c61 7469 7665 5f6d 6f76 6528 7468 6572  lative_move(ther
-0000b150: 6d6f 5f70 6f73 6974 696f 6e29 0a0a 2020  mo_position)..  
-0000b160: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
-0000b170: 6275 6728 7b22 6d73 6722 3a20 226d 6f76  bug({"msg": "mov
-0000b180: 655f 7374 6167 655f 7265 6c61 7469 7665  e_stage_relative
-0000b190: 222c 2022 706f 7369 7469 6f6e 223a 2070  ", "position": p
-0000b1a0: 6f73 6974 696f 6e2e 746f 5f64 6963 7428  osition.to_dict(
-0000b1b0: 297d 290a 0a20 2020 2020 2020 2072 6574  )})..        ret
-0000b1c0: 7572 6e20 7365 6c66 2e67 6574 5f73 7461  urn self.get_sta
-0000b1d0: 6765 5f70 6f73 6974 696f 6e28 290a 0a20  ge_position().. 
-0000b1e0: 2020 2064 6566 2073 7461 626c 655f 6d6f     def stable_mo
-0000b1f0: 7665 2873 656c 662c 2064 783a 2066 6c6f  ve(self, dx: flo
-0000b200: 6174 2c20 6479 3a20 666c 6f61 742c 2062  at, dy: float, b
-0000b210: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
-0000b220: 7065 2c20 7374 6174 6963 5f77 643a 2062  pe, static_wd: b
-0000b230: 6f6f 6c20 3d20 4661 6c73 6529 202d 3e20  ool = False) -> 
-0000b240: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-0000b250: 696f 6e3a 0a20 2020 2020 2020 2022 2222  ion:.        """
-0000b260: 0a20 2020 2020 2020 2043 616c 6375 6c61  .        Calcula
-0000b270: 7465 2074 6865 2063 6f72 7265 6374 6564  te the corrected
-0000b280: 2073 7461 6765 206d 6f76 656d 656e 7473   stage movements
-0000b290: 2062 6173 6564 206f 6e20 7468 6520 6265   based on the be
-0000b2a0: 616d 5f74 7970 6520 7374 6167 6520 7469  am_type stage ti
-0000b2b0: 6c74 2c20 7368 7574 746c 6520 7072 652d  lt, shuttle pre-
-0000b2c0: 7469 6c74 2c20 0a20 2020 2020 2020 2061  tilt, .        a
-0000b2d0: 6e64 2074 6865 6e20 6d6f 7665 2074 6865  nd then move the
-0000b2e0: 2073 7461 6765 2072 656c 6174 6976 656c   stage relativel
-0000b2f0: 792e 0a0a 2020 2020 2020 2020 4172 6773  y...        Args
-0000b300: 3a0a 2020 2020 2020 2020 2020 2020 6478  :.            dx
-0000b310: 2028 666c 6f61 7429 3a20 6469 7374 616e   (float): distan
-0000b320: 6365 2061 6c6f 6e67 2074 6865 2078 2d61  ce along the x-a
-0000b330: 7869 7320 2869 6d61 6765 2063 6f6f 7264  xis (image coord
-0000b340: 696e 6174 6573 290a 2020 2020 2020 2020  inates).        
-0000b350: 2020 2020 6479 2028 666c 6f61 7429 3a20      dy (float): 
-0000b360: 6469 7374 616e 6365 2061 6c6f 6e67 2074  distance along t
-0000b370: 6865 2079 2d61 7869 7320 2869 6d61 6765  he y-axis (image
-0000b380: 2063 6f6f 7264 696e 6174 6573 290a 2020   coordinates).  
-0000b390: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
-0000b3a0: 7970 6520 2842 6561 6d54 7970 6529 3a20  ype (BeamType): 
-0000b3b0: 6265 616d 2074 7970 6520 746f 206d 6f76  beam type to mov
-0000b3c0: 6520 696e 0a20 2020 2020 2020 2020 2020  e in.           
-0000b3d0: 2073 7461 7469 635f 7764 2028 626f 6f6c   static_wd (bool
-0000b3e0: 2c20 6f70 7469 6f6e 616c 293a 2077 6865  , optional): whe
-0000b3f0: 7468 6572 2074 6f20 6669 7820 7468 6520  ther to fix the 
-0000b400: 776f 726b 696e 6720 6469 7374 616e 6365  working distance
-0000b410: 2074 6f20 7468 6520 6575 6365 6e74 7269   to the eucentri
-0000b420: 6320 6865 6967 6874 732e 2044 6566 6175  c heights. Defau
-0000b430: 6c74 7320 746f 2046 616c 7365 2e0a 2020  lts to False..  
-0000b440: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000b450: 2020 0a20 2020 2020 2020 205f 6368 6563    .        _chec
-0000b460: 6b5f 7374 6167 6528 7365 6c66 2e73 7973  k_stage(self.sys
-0000b470: 7465 6d29 0a0a 2020 2020 2020 2020 7764  tem)..        wd
-0000b480: 203d 2073 656c 662e 6765 7428 2277 6f72   = self.get("wor
-0000b490: 6b69 6e67 5f64 6973 7461 6e63 6522 2c20  king_distance", 
-0000b4a0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-0000b4b0: 4e29 0a0a 2020 2020 2020 2020 7363 616e  N)..        scan
-0000b4c0: 5f72 6f74 6174 696f 6e20 3d20 7365 6c66  _rotation = self
-0000b4d0: 2e67 6574 2822 7363 616e 5f72 6f74 6174  .get("scan_rotat
-0000b4e0: 696f 6e22 2c20 6265 616d 5f74 7970 6529  ion", beam_type)
-0000b4f0: 0a20 2020 2020 2020 2069 6620 6e70 2e69  .        if np.i
-0000b500: 7363 6c6f 7365 2873 6361 6e5f 726f 7461  sclose(scan_rota
-0000b510: 7469 6f6e 2c20 6e70 2e70 6929 3a0a 2020  tion, np.pi):.  
-0000b520: 2020 2020 2020 2020 2020 6478 202a 3d20            dx *= 
-0000b530: 2d31 2e30 0a20 2020 2020 2020 2020 2020  -1.0.           
-0000b540: 2064 7920 2a3d 202d 312e 300a 2020 2020   dy *= -1.0.    
-0000b550: 2020 2020 0a20 2020 2020 2020 2023 2063      .        # c
-0000b560: 616c 6375 6c61 7465 2073 7461 626c 6520  alculate stable 
-0000b570: 6d6f 7665 6d65 6e74 0a20 2020 2020 2020  movement.       
-0000b580: 2079 7a5f 6d6f 7665 203d 2073 656c 662e   yz_move = self.
-0000b590: 5f79 5f63 6f72 7265 6374 6564 5f73 7461  _y_corrected_sta
-0000b5a0: 6765 5f6d 6f76 656d 656e 7428 0a20 2020  ge_movement(.   
-0000b5b0: 2020 2020 2020 2020 2065 7870 6563 7465           expecte
-0000b5c0: 645f 793d 6479 2c0a 2020 2020 2020 2020  d_y=dy,.        
-0000b5d0: 2020 2020 6265 616d 5f74 7970 653d 6265      beam_type=be
-0000b5e0: 616d 5f74 7970 652c 0a20 2020 2020 2020  am_type,.       
-0000b5f0: 2029 0a20 2020 2020 2020 2073 7461 6765   ).        stage
-0000b600: 5f70 6f73 6974 696f 6e20 3d20 4669 6273  _position = Fibs
-0000b610: 656d 5374 6167 6550 6f73 6974 696f 6e28  emStagePosition(
-0000b620: 783d 6478 2c20 793d 797a 5f6d 6f76 652e  x=dx, y=yz_move.
-0000b630: 792c 207a 3d79 7a5f 6d6f 7665 2e7a 2c20  y, z=yz_move.z, 
-0000b640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b660: 2020 2020 2020 2020 2020 2020 2020 723d                r=
-0000b670: 302c 2074 3d30 2c20 636f 6f72 6469 6e61  0, t=0, coordina
-0000b680: 7465 5f73 7973 7465 6d3d 2252 4157 2229  te_system="RAW")
-0000b690: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-0000b6a0: 2020 2320 6d6f 7665 2073 7461 6765 0a20    # move stage. 
-0000b6b0: 2020 2020 2020 2073 656c 662e 6d6f 7665         self.move
-0000b6c0: 5f73 7461 6765 5f72 656c 6174 6976 6528  _stage_relative(
-0000b6d0: 7374 6167 655f 706f 7369 7469 6f6e 290a  stage_position).
-0000b6e0: 0a20 2020 2020 2020 2023 2061 646a 7573  .        # adjus
-0000b6f0: 7420 776f 726b 696e 6720 6469 7374 616e  t working distan
-0000b700: 6365 2074 6f20 636f 6d70 656e 7361 7465  ce to compensate
-0000b710: 2066 6f72 2073 7461 6765 206d 6f76 656d   for stage movem
-0000b720: 656e 740a 2020 2020 2020 2020 6966 2073  ent.        if s
-0000b730: 7461 7469 635f 7764 3a0a 2020 2020 2020  tatic_wd:.      
-0000b740: 2020 2020 2020 7764 203d 2073 656c 662e        wd = self.
-0000b750: 7379 7374 656d 2e65 6c65 6374 726f 6e2e  system.electron.
-0000b760: 6575 6365 6e74 7269 635f 6865 6967 6874  eucentric_height
-0000b770: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-0000b780: 2020 7365 6c66 2e73 6574 2822 776f 726b    self.set("work
-0000b790: 696e 675f 6469 7374 616e 6365 222c 2077  ing_distance", w
-0000b7a0: 642c 2042 6561 6d54 7970 652e 454c 4543  d, BeamType.ELEC
-0000b7b0: 5452 4f4e 290a 0a20 2020 2020 2020 2023  TRON)..        #
-0000b7c0: 206c 6f67 6769 6e67 0a20 2020 2020 2020   logging.       
-0000b7d0: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-0000b7e0: 226d 7367 223a 2022 7374 6162 6c65 5f6d  "msg": "stable_m
-0000b7f0: 6f76 6522 2c20 2264 7822 3a20 6478 2c20  ove", "dx": dx, 
-0000b800: 2264 7922 3a20 6479 2c20 0a20 2020 2020  "dy": dy, .     
-0000b810: 2020 2020 2020 2020 2020 2022 6265 616d             "beam
-0000b820: 5f74 7970 6522 3a20 6265 616d 5f74 7970  _type": beam_typ
-0000b830: 652e 6e61 6d65 2c20 2273 7461 7469 635f  e.name, "static_
-0000b840: 7764 223a 2073 7461 7469 635f 7764 2c0a  wd": static_wd,.
-0000b850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b860: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
-0000b870: 6522 3a20 7764 2c20 2273 6361 6e5f 726f  e": wd, "scan_ro
-0000b880: 7461 7469 6f6e 223a 2073 6361 6e5f 726f  tation": scan_ro
-0000b890: 7461 7469 6f6e 2c20 0a20 2020 2020 2020  tation, .       
-0000b8a0: 2020 2020 2020 2020 2022 706f 7369 7469           "positi
-0000b8b0: 6f6e 223a 2073 7461 6765 5f70 6f73 6974  on": stage_posit
-0000b8c0: 696f 6e2e 746f 5f64 6963 7428 297d 290a  ion.to_dict()}).
-0000b8d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b8e0: 7365 6c66 2e67 6574 5f73 7461 6765 5f70  self.get_stage_p
-0000b8f0: 6f73 6974 696f 6e28 290a 0a20 2020 2064  osition()..    d
-0000b900: 6566 2076 6572 7469 6361 6c5f 6d6f 7665  ef vertical_move
-0000b910: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-0000b920: 2020 2020 2020 2020 6479 3a20 666c 6f61          dy: floa
-0000b930: 742c 0a20 2020 2020 2020 2064 783a 2066  t,.        dx: f
-0000b940: 6c6f 6174 203d 2030 2e30 2c0a 2020 2020  loat = 0.0,.    
-0000b950: 2020 2020 7374 6174 6963 5f77 643a 2062      static_wd: b
-0000b960: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-0000b970: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0000b980: 2020 2022 2222 204d 6f76 6520 7468 6520     """ Move the 
-0000b990: 7374 6167 6520 7665 7274 6963 616c 6c79  stage vertically
-0000b9a0: 2074 6f20 636f 7272 6563 7420 636f 696e   to correct coin
-0000b9b0: 6369 6465 6e63 6520 706f 696e 740a 0a20  cidence point.. 
-0000b9c0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-0000b9d0: 2020 2020 2020 2020 2064 7920 2866 6c6f           dy (flo
-0000b9e0: 6174 293a 2064 6973 7461 6e63 6520 616c  at): distance al
-0000b9f0: 6f6e 6720 7468 6520 792d 6178 6973 2028  ong the y-axis (
-0000ba00: 696d 6167 6520 636f 6f72 6469 6e61 7465  image coordinate
-0000ba10: 7329 0a20 2020 2020 2020 2020 2020 2064  s).            d
-0000ba20: 7820 2866 6c6f 6174 2c20 6f70 7469 6f6e  x (float, option
-0000ba30: 616c 293a 2064 6973 7461 6e63 6520 616c  al): distance al
-0000ba40: 6f6e 6720 7468 6520 782d 6178 6973 2028  ong the x-axis (
-0000ba50: 696d 6167 6520 636f 6f72 6469 6e61 7465  image coordinate
-0000ba60: 7329 2e20 4465 6661 756c 7473 2074 6f20  s). Defaults to 
-0000ba70: 302e 302e 0a20 2020 2020 2020 2020 2020  0.0..           
-0000ba80: 2073 7461 7469 635f 7764 2028 626f 6f6c   static_wd (bool
-0000ba90: 2c20 6f70 7469 6f6e 616c 293a 2077 6865  , optional): whe
-0000baa0: 7468 6572 2074 6f20 6669 7820 7468 6520  ther to fix the 
-0000bab0: 776f 726b 696e 6720 6469 7374 616e 6365  working distance
-0000bac0: 2e20 4465 6661 756c 7473 2074 6f20 5472  . Defaults to Tr
-0000bad0: 7565 2e0a 0a20 2020 2020 2020 2022 2222  ue...        """
-0000bae0: 0a20 2020 2020 2020 2023 2063 6f6e 6669  .        # confi
-0000baf0: 726d 2073 7461 6765 2069 7320 656e 6162  rm stage is enab
-0000bb00: 6c65 640a 2020 2020 2020 2020 5f63 6865  led.        _che
-0000bb10: 636b 5f73 7461 6765 2873 656c 662e 7379  ck_stage(self.sy
-0000bb20: 7374 656d 290a 0a20 2020 2020 2020 2023  stem)..        #
-0000bb30: 2067 6574 2063 7572 7265 6e74 2077 6f72   get current wor
-0000bb40: 6b69 6e67 2064 6973 7461 6e63 652c 2074  king distance, t
-0000bb50: 6f20 6265 2072 6573 746f 7265 6420 6c61  o be restored la
-0000bb60: 7465 720a 2020 2020 2020 2020 7764 203d  ter.        wd =
-0000bb70: 2073 656c 662e 6765 7428 2277 6f72 6b69   self.get("worki
-0000bb80: 6e67 5f64 6973 7461 6e63 6522 2c20 4265  ng_distance", Be
-0000bb90: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
-0000bba0: 0a0a 2020 2020 2020 2020 2320 6164 6a75  ..        # adju
-0000bbb0: 7374 2066 6f72 2073 6361 6e20 726f 7461  st for scan rota
-0000bbc0: 7469 6f6e 0a20 2020 2020 2020 2073 6361  tion.        sca
-0000bbd0: 6e5f 726f 7461 7469 6f6e 203d 2073 656c  n_rotation = sel
-0000bbe0: 662e 6765 7428 2273 6361 6e5f 726f 7461  f.get("scan_rota
-0000bbf0: 7469 6f6e 222c 2042 6561 6d54 7970 652e  tion", BeamType.
-0000bc00: 494f 4e29 0a20 2020 2020 2020 2069 6620  ION).        if 
-0000bc10: 6e70 2e69 7363 6c6f 7365 2873 6361 6e5f  np.isclose(scan_
-0000bc20: 726f 7461 7469 6f6e 2c20 6e70 2e70 6929  rotation, np.pi)
-0000bc30: 3a0a 2020 2020 2020 2020 2020 2020 6478  :.            dx
-0000bc40: 202a 3d20 2d31 2e30 0a20 2020 2020 2020   *= -1.0.       
-0000bc50: 2020 2020 2064 7920 2a3d 202d 312e 300a       dy *= -1.0.
-0000bc60: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
-0000bc70: 2069 6d70 6c65 6d65 6e74 2070 6572 7370   implement persp
-0000bc80: 6563 7469 7665 2063 6f72 7265 6374 696f  ective correctio
-0000bc90: 6e0a 2020 2020 2020 2020 5045 5253 5045  n.        PERSPE
-0000bca0: 4354 4956 455f 434f 5252 4543 5449 4f4e  CTIVE_CORRECTION
-0000bcb0: 203d 2030 2e39 0a20 2020 2020 2020 207a   = 0.9.        z
-0000bcc0: 5f6d 6f76 6520 3d20 6479 202f 206e 702e  _move = dy / np.
-0000bcd0: 636f 7328 6e70 2e64 6567 3272 6164 2839  cos(np.deg2rad(9
-0000bce0: 3020 2d20 7365 6c66 2e73 7973 7465 6d2e  0 - self.system.
-0000bcf0: 696f 6e2e 636f 6c75 6d6e 5f74 696c 7429  ion.column_tilt)
-0000bd00: 2920 2a20 5045 5253 5045 4354 4956 455f  ) * PERSPECTIVE_
-0000bd10: 434f 5252 4543 5449 4f4e 2020 2320 544f  CORRECTION  # TO
-0000bd20: 444f 3a20 4d41 4749 4320 4e55 4d42 4552  DO: MAGIC NUMBER
-0000bd30: 2c20 3930 202d 2066 6962 2074 696c 740a  , 90 - fib tilt.
-0000bd40: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
-0000bd50: 2064 6f20 7468 6973 206d 616e 7561 6c6c   do this manuall
-0000bd60: 7920 7769 7468 6f75 7420 6175 746f 7363  y without autosc
-0000bd70: 7269 7074 2069 6e20 7261 7720 636f 6f72  ript in raw coor
-0000bd80: 6469 6e61 7465 730a 2020 2020 2020 2020  dinates.        
-0000bd90: 7374 6167 655f 706f 7369 7469 6f6e 203d  stage_position =
-0000bda0: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
-0000bdb0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0000bdc0: 2020 783d 6478 2c0a 2020 2020 2020 2020    x=dx,.        
-0000bdd0: 2020 2020 7a3d 7a5f 6d6f 7665 2c20 0a20      z=z_move, . 
-0000bde0: 2020 2020 2020 2020 2020 2063 6f6f 7264             coord
-0000bdf0: 696e 6174 655f 7379 7374 656d 3d22 5370  inate_system="Sp
-0000be00: 6563 696d 656e 220a 2020 2020 2020 2020  ecimen".        
-0000be10: 290a 0a20 2020 2020 2020 2023 206d 6f76  )..        # mov
-0000be20: 6520 7374 6167 650a 2020 2020 2020 2020  e stage.        
-0000be30: 6d6f 7665 5f73 6574 7469 6e67 7320 3d20  move_settings = 
-0000be40: 4d6f 7665 5365 7474 696e 6773 286c 696e  MoveSettings(lin
-0000be50: 6b5f 7a5f 793d 5472 7565 290a 2020 2020  k_z_y=True).    
-0000be60: 2020 2020 6175 746f 7363 7269 7074 5f70      autoscript_p
-0000be70: 6f73 6974 696f 6e20 3d20 7374 6167 655f  osition = stage_
-0000be80: 706f 7369 7469 6f6e 2e74 6f5f 6175 746f  position.to_auto
-0000be90: 7363 7269 7074 5f70 6f73 6974 696f 6e28  script_position(
-0000bea0: 2920 0a20 2020 2020 2020 2073 656c 662e  ) .        self.
-0000beb0: 636f 6e6e 6563 7469 6f6e 2e73 7065 6369  connection.speci
-0000bec0: 6d65 6e2e 7374 6167 652e 7265 6c61 7469  men.stage.relati
-0000bed0: 7665 5f6d 6f76 6528 6175 746f 7363 7269  ve_move(autoscri
-0000bee0: 7074 5f70 6f73 6974 696f 6e2c 206d 6f76  pt_position, mov
-0000bef0: 655f 7365 7474 696e 6773 290a 0a20 2020  e_settings)..   
-0000bf00: 2020 2020 2023 2072 6573 746f 7265 2077       # restore w
-0000bf10: 6f72 6b69 6e67 2064 6973 7461 6e63 6520  orking distance 
-0000bf20: 746f 2061 646a 7573 7420 666f 7220 6d69  to adjust for mi
-0000bf30: 6372 6f73 636f 7065 2063 6f6d 7065 6e73  croscope compens
-0000bf40: 7461 7469 6f6e 0a20 2020 2020 2020 2069  tation.        i
-0000bf50: 6620 7374 6174 6963 5f77 643a 0a20 2020  f static_wd:.   
-0000bf60: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
-0000bf70: 7428 2277 6f72 6b69 6e67 5f64 6973 7461  t("working_dista
-0000bf80: 6e63 6522 2c20 7365 6c66 2e73 7973 7465  nce", self.syste
-0000bf90: 6d2e 656c 6563 7472 6f6e 2e65 7563 656e  m.electron.eucen
-0000bfa0: 7472 6963 5f68 6569 6768 742c 2042 6561  tric_height, Bea
-0000bfb0: 6d54 7970 652e 454c 4543 5452 4f4e 290a  mType.ELECTRON).
-0000bfc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000bfd0: 2e73 6574 2822 776f 726b 696e 675f 6469  .set("working_di
-0000bfe0: 7374 616e 6365 222c 2073 656c 662e 7379  stance", self.sy
-0000bff0: 7374 656d 2e69 6f6e 2e65 7563 656e 7472  stem.ion.eucentr
-0000c000: 6963 5f68 6569 6768 742c 2042 6561 6d54  ic_height, BeamT
-0000c010: 7970 652e 494f 4e29 0a20 2020 2020 2020  ype.ION).       
-0000c020: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000c030: 2020 2073 656c 662e 7365 7428 2277 6f72     self.set("wor
-0000c040: 6b69 6e67 5f64 6973 7461 6e63 6522 2c20  king_distance", 
-0000c050: 7764 2c20 4265 616d 5479 7065 2e45 4c45  wd, BeamType.ELE
-0000c060: 4354 524f 4e29 0a0a 2020 2020 2020 2020  CTRON)..        
-0000c070: 2320 6c6f 6767 696e 670a 2020 2020 2020  # logging.      
-0000c080: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
-0000c090: 7b22 6d73 6722 3a20 2276 6572 7469 6361  {"msg": "vertica
-0000c0a0: 6c5f 6d6f 7665 222c 2022 6479 223a 2064  l_move", "dy": d
-0000c0b0: 792c 2022 6478 223a 2064 782c 200a 2020  y, "dx": dx, .  
-0000c0c0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0000c0d0: 7461 7469 635f 7764 223a 2073 7461 7469  tatic_wd": stati
-0000c0e0: 635f 7764 2c20 2277 6422 3a20 7764 2c20  c_wd, "wd": wd, 
-0000c0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c100: 2022 7363 616e 5f72 6f74 6174 696f 6e22   "scan_rotation"
-0000c110: 3a20 7363 616e 5f72 6f74 6174 696f 6e2c  : scan_rotation,
-0000c120: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0000c130: 2020 2270 6f73 6974 696f 6e22 3a20 7374    "position": st
-0000c140: 6167 655f 706f 7369 7469 6f6e 2e74 6f5f  age_position.to_
-0000c150: 6469 6374 2829 7d29 0a0a 0a20 2020 2020  dict()})...     
-0000c160: 2020 2072 6574 7572 6e20 7365 6c66 2e67     return self.g
-0000c170: 6574 5f73 7461 6765 5f70 6f73 6974 696f  et_stage_positio
-0000c180: 6e28 290a 0a20 2020 2064 6566 205f 795f  n()..    def _y_
-0000c190: 636f 7272 6563 7465 645f 7374 6167 655f  corrected_stage_
-0000c1a0: 6d6f 7665 6d65 6e74 280a 2020 2020 2020  movement(.      
-0000c1b0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0000c1c0: 6578 7065 6374 6564 5f79 3a20 666c 6f61  expected_y: floa
-0000c1d0: 742c 0a20 2020 2020 2020 2062 6561 6d5f  t,.        beam_
-0000c1e0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-0000c1f0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-0000c200: 4f4e 2c0a 2020 2020 2920 2d3e 2046 6962  ON,.    ) -> Fib
-0000c210: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-0000c220: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0000c230: 2020 2020 2020 4361 6c63 756c 6174 6520        Calculate 
-0000c240: 7468 6520 7920 636f 7272 6563 7465 6420  the y corrected 
-0000c250: 7374 6167 6520 6d6f 7665 6d65 6e74 2c20  stage movement, 
-0000c260: 636f 7272 6563 7465 6420 666f 7220 7468  corrected for th
-0000c270: 6520 6164 6469 7469 6f6e 616c 2074 696c  e additional til
-0000c280: 7420 6f66 2074 6865 2073 616d 706c 6520  t of the sample 
-0000c290: 686f 6c64 6572 2028 7072 652d 7469 6c74  holder (pre-tilt
-0000c2a0: 2061 6e67 6c65 292e 0a0a 2020 2020 2020   angle)...      
-0000c2b0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0000c2c0: 2020 2020 6578 7065 6374 6564 5f79 2028      expected_y (
-0000c2d0: 666c 6f61 742c 206f 7074 696f 6e61 6c29  float, optional)
-0000c2e0: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
-0000c2f0: 2079 2d61 7869 732e 0a20 2020 2020 2020   y-axis..       
-0000c300: 2020 2020 2062 6561 6d5f 7479 7065 2028       beam_type (
-0000c310: 4265 616d 5479 7065 2c20 6f70 7469 6f6e  BeamType, option
-0000c320: 616c 293a 2062 6561 6d5f 7479 7065 2074  al): beam_type t
-0000c330: 6f20 6d6f 7665 2069 6e2e 2044 6566 6175  o move in. Defau
-0000c340: 6c74 7320 746f 2042 6561 6d54 7970 652e  lts to BeamType.
-0000c350: 454c 4543 5452 4f4e 2e0a 0a20 2020 2020  ELECTRON...     
-0000c360: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0000c370: 2020 2020 2020 2020 5374 6167 6550 6f73          StagePos
-0000c380: 6974 696f 6e3a 2079 2063 6f72 7265 6374  ition: y correct
-0000c390: 6564 2073 7461 6765 206d 6f76 656d 656e  ed stage movemen
-0000c3a0: 7420 2872 656c 6174 6976 6520 706f 7369  t (relative posi
-0000c3b0: 7469 6f6e 290a 2020 2020 2020 2020 2222  tion).        ""
-0000c3c0: 220a 0a20 2020 2020 2020 2023 2054 4f44  "..        # TOD
-0000c3d0: 4f3a 2072 6570 6c61 6365 2077 6974 6820  O: replace with 
-0000c3e0: 6361 6d65 7261 206d 6174 7269 7820 2a20  camera matrix * 
-0000c3f0: 696e 7665 7273 6520 6b69 6e65 6d61 7469  inverse kinemati
-0000c400: 6373 0a0a 2020 2020 2020 2020 2320 616c  cs..        # al
-0000c410: 6c20 616e 676c 6573 2069 6e20 7261 6469  l angles in radi
-0000c420: 616e 730a 2020 2020 2020 2020 7374 6167  ans.        stag
-0000c430: 655f 7469 6c74 5f66 6c61 745f 746f 5f65  e_tilt_flat_to_e
-0000c440: 6c65 6374 726f 6e20 3d20 6e70 2e64 6567  lectron = np.deg
-0000c450: 3272 6164 2873 656c 662e 7379 7374 656d  2rad(self.system
-0000c460: 2e65 6c65 6374 726f 6e2e 636f 6c75 6d6e  .electron.column
-0000c470: 5f74 696c 7429 0a20 2020 2020 2020 2073  _tilt).        s
-0000c480: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
-0000c490: 6f5f 696f 6e20 3d20 6e70 2e64 6567 3272  o_ion = np.deg2r
-0000c4a0: 6164 2873 656c 662e 7379 7374 656d 2e69  ad(self.system.i
-0000c4b0: 6f6e 2e63 6f6c 756d 6e5f 7469 6c74 290a  on.column_tilt).
-0000c4c0: 0a20 2020 2020 2020 2073 7461 6765 5f70  .        stage_p
-0000c4d0: 7265 7469 6c74 203d 206e 702e 6465 6732  retilt = np.deg2
-0000c4e0: 7261 6428 7365 6c66 2e73 7973 7465 6d2e  rad(self.system.
-0000c4f0: 7374 6167 652e 7368 7574 746c 655f 7072  stage.shuttle_pr
-0000c500: 655f 7469 6c74 290a 0a20 2020 2020 2020  e_tilt)..       
-0000c510: 2073 7461 6765 5f72 6f74 6174 696f 6e5f   stage_rotation_
-0000c520: 666c 6174 5f74 6f5f 6562 203d 206e 702e  flat_to_eb = np.
-0000c530: 6465 6732 7261 6428 0a20 2020 2020 2020  deg2rad(.       
-0000c540: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
-0000c550: 2e73 7461 6765 2e72 6f74 6174 696f 6e5f  .stage.rotation_
-0000c560: 7265 6665 7265 6e63 650a 2020 2020 2020  reference.      
-0000c570: 2020 2920 2520 2832 202a 206e 702e 7069    ) % (2 * np.pi
-0000c580: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
-0000c590: 726f 7461 7469 6f6e 5f66 6c61 745f 746f  rotation_flat_to
-0000c5a0: 5f69 6f6e 203d 206e 702e 6465 6732 7261  _ion = np.deg2ra
-0000c5b0: 6428 0a20 2020 2020 2020 2020 2020 2073  d(.            s
-0000c5c0: 656c 662e 7379 7374 656d 2e73 7461 6765  elf.system.stage
-0000c5d0: 2e72 6f74 6174 696f 6e5f 3138 300a 2020  .rotation_180.  
-0000c5e0: 2020 2020 2020 2920 2520 2832 202a 206e        ) % (2 * n
-0000c5f0: 702e 7069 290a 0a20 2020 2020 2020 2023  p.pi)..        #
-0000c600: 2063 7572 7265 6e74 2073 7461 6765 2070   current stage p
-0000c610: 6f73 6974 696f 6e0a 2020 2020 2020 2020  osition.        
-0000c620: 6375 7272 656e 745f 7374 6167 655f 706f  current_stage_po
-0000c630: 7369 7469 6f6e 203d 2073 656c 662e 6765  sition = self.ge
-0000c640: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
-0000c650: 2829 0a20 2020 2020 2020 2073 7461 6765  ().        stage
-0000c660: 5f72 6f74 6174 696f 6e20 3d20 6375 7272  _rotation = curr
-0000c670: 656e 745f 7374 6167 655f 706f 7369 7469  ent_stage_positi
-0000c680: 6f6e 2e72 2025 2028 3220 2a20 6e70 2e70  on.r % (2 * np.p
-0000c690: 6929 0a20 2020 2020 2020 2073 7461 6765  i).        stage
-0000c6a0: 5f74 696c 7420 3d20 6375 7272 656e 745f  _tilt = current_
-0000c6b0: 7374 6167 655f 706f 7369 7469 6f6e 2e74  stage_position.t
-0000c6c0: 0a0a 2020 2020 2020 2020 5052 4554 494c  ..        PRETIL
-0000c6d0: 545f 5349 474e 203d 2031 2e30 0a20 2020  T_SIGN = 1.0.   
-0000c6e0: 2020 2020 2023 2070 7265 7469 6c74 2061       # pretilt a
-0000c6f0: 6e67 6c65 2064 6570 656e 6473 206f 6e20  ngle depends on 
-0000c700: 726f 7461 7469 6f6e 0a20 2020 2020 2020  rotation.       
-0000c710: 2066 726f 6d20 6669 6273 656d 2069 6d70   from fibsem imp
-0000c720: 6f72 7420 6d6f 7665 6d65 6e74 0a20 2020  ort movement.   
-0000c730: 2020 2020 2069 6620 6d6f 7665 6d65 6e74       if movement
-0000c740: 2e72 6f74 6174 696f 6e5f 616e 676c 655f  .rotation_angle_
-0000c750: 6973 5f73 6d61 6c6c 6572 2873 7461 6765  is_smaller(stage
-0000c760: 5f72 6f74 6174 696f 6e2c 2073 7461 6765  _rotation, stage
-0000c770: 5f72 6f74 6174 696f 6e5f 666c 6174 5f74  _rotation_flat_t
-0000c780: 6f5f 6562 2c20 6174 6f6c 3d35 293a 0a20  o_eb, atol=5):. 
-0000c790: 2020 2020 2020 2020 2020 2050 5245 5449             PRETI
-0000c7a0: 4c54 5f53 4947 4e20 3d20 312e 300a 2020  LT_SIGN = 1.0.  
-0000c7b0: 2020 2020 2020 6966 206d 6f76 656d 656e        if movemen
-0000c7c0: 742e 726f 7461 7469 6f6e 5f61 6e67 6c65  t.rotation_angle
-0000c7d0: 5f69 735f 736d 616c 6c65 7228 0a20 2020  _is_smaller(.   
-0000c7e0: 2020 2020 2020 2020 2073 7461 6765 5f72           stage_r
-0000c7f0: 6f74 6174 696f 6e2c 2073 7461 6765 5f72  otation, stage_r
-0000c800: 6f74 6174 696f 6e5f 666c 6174 5f74 6f5f  otation_flat_to_
-0000c810: 696f 6e2c 2061 746f 6c3d 350a 2020 2020  ion, atol=5.    
-0000c820: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-0000c830: 2020 2050 5245 5449 4c54 5f53 4947 4e20     PRETILT_SIGN 
-0000c840: 3d20 2d31 2e30 0a0a 2020 2020 2020 2020  = -1.0..        
-0000c850: 2320 636f 7272 6563 7465 645f 7072 6574  # corrected_pret
-0000c860: 696c 745f 616e 676c 6520 3d20 5052 4554  ilt_angle = PRET
-0000c870: 494c 545f 5349 474e 202a 2073 7461 6765  ILT_SIGN * stage
-0000c880: 5f74 696c 745f 666c 6174 5f74 6f5f 656c  _tilt_flat_to_el
-0000c890: 6563 7472 6f6e 0a20 2020 2020 2020 2063  ectron.        c
-0000c8a0: 6f72 7265 6374 6564 5f70 7265 7469 6c74  orrected_pretilt
-0000c8b0: 5f61 6e67 6c65 203d 2050 5245 5449 4c54  _angle = PRETILT
-0000c8c0: 5f53 4947 4e20 2a20 2873 7461 6765 5f70  _SIGN * (stage_p
-0000c8d0: 7265 7469 6c74 202b 2073 7461 6765 5f74  retilt + stage_t
-0000c8e0: 696c 745f 666c 6174 5f74 6f5f 656c 6563  ilt_flat_to_elec
-0000c8f0: 7472 6f6e 2920 2320 656c 6563 7472 6f6e  tron) # electron
-0000c900: 2061 6e67 6c65 203d 2030 2c20 696f 6e20   angle = 0, ion 
-0000c910: 3d20 3532 0a0a 2020 2020 2020 2020 2320  = 52..        # 
-0000c920: 7065 7273 7065 6374 6976 6520 7469 6c74  perspective tilt
-0000c930: 2061 646a 7573 746d 656e 7420 2864 6966   adjustment (dif
-0000c940: 6665 7265 6e63 6520 6265 7477 6565 6e20  ference between 
-0000c950: 7065 7273 7065 6374 6976 6520 7669 6577  perspective view
-0000c960: 2061 6e64 2073 616d 706c 6520 636f 6f72   and sample coor
-0000c970: 6469 6e61 7465 2073 7973 7465 6d29 0a20  dinate system). 
-0000c980: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-0000c990: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
-0000c9a0: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-0000c9b0: 2020 2020 2020 7065 7273 7065 6374 6976        perspectiv
-0000c9c0: 655f 7469 6c74 5f61 646a 7573 746d 656e  e_tilt_adjustmen
-0000c9d0: 7420 3d20 2d63 6f72 7265 6374 6564 5f70  t = -corrected_p
-0000c9e0: 7265 7469 6c74 5f61 6e67 6c65 0a20 2020  retilt_angle.   
-0000c9f0: 2020 2020 2020 2020 2053 4341 4c45 5f46           SCALE_F
-0000ca00: 4143 544f 5220 3d20 312e 3020 2023 2030  ACTOR = 1.0  # 0
-0000ca10: 2e37 3833 3432 2020 2320 7061 7465 6e74  .78342  # patent
-0000ca20: 6564 2074 6563 686e 6f6c 6f67 790a 2020  ed technology.  
-0000ca30: 2020 2020 2020 656c 6966 2062 6561 6d5f        elif beam_
-0000ca40: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-0000ca50: 2e49 4f4e 3a0a 2020 2020 2020 2020 2020  .ION:.          
-0000ca60: 2020 7065 7273 7065 6374 6976 655f 7469    perspective_ti
-0000ca70: 6c74 5f61 646a 7573 746d 656e 7420 3d20  lt_adjustment = 
-0000ca80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000ca90: 2020 2d63 6f72 7265 6374 6564 5f70 7265    -corrected_pre
-0000caa0: 7469 6c74 5f61 6e67 6c65 202d 2073 7461  tilt_angle - sta
-0000cab0: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
-0000cac0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-0000cad0: 290a 2020 2020 2020 2020 2020 2020 5343  ).            SC
-0000cae0: 414c 455f 4641 4354 4f52 203d 2031 2e30  ALE_FACTOR = 1.0
-0000caf0: 0a0a 2020 2020 2020 2020 2320 7468 6520  ..        # the 
-0000cb00: 616d 6f75 6e74 2074 6865 2073 616d 706c  amount the sampl
-0000cb10: 6520 6861 7320 746f 206d 6f76 6520 696e  e has to move in
-0000cb20: 2074 6865 2079 2d61 7869 730a 2020 2020   the y-axis.    
-0000cb30: 2020 2020 795f 7361 6d70 6c65 5f6d 6f76      y_sample_mov
-0000cb40: 6520 3d20 2865 7870 6563 7465 645f 7920  e = (expected_y 
-0000cb50: 2a20 5343 414c 455f 4641 4354 4f52 2920  * SCALE_FACTOR) 
-0000cb60: 2f20 6e70 2e63 6f73 280a 2020 2020 2020  / np.cos(.      
-0000cb70: 2020 2020 2020 7374 6167 655f 7469 6c74        stage_tilt
-0000cb80: 202b 2070 6572 7370 6563 7469 7665 5f74   + perspective_t
-0000cb90: 696c 745f 6164 6a75 7374 6d65 6e74 0a20  ilt_adjustment. 
-0000cba0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000cbb0: 0a20 2020 2020 2020 2023 2074 6865 2061  .        # the a
-0000cbc0: 6d6f 756e 7420 7468 6520 7374 6167 6520  mount the stage 
-0000cbd0: 6861 7320 746f 206d 6f76 6520 696e 2065  has to move in e
-0000cbe0: 6163 6820 6178 6973 0a20 2020 2020 2020  ach axis.       
-0000cbf0: 2079 5f6d 6f76 6520 3d20 795f 7361 6d70   y_move = y_samp
-0000cc00: 6c65 5f6d 6f76 6520 2a20 6e70 2e63 6f73  le_move * np.cos
-0000cc10: 2863 6f72 7265 6374 6564 5f70 7265 7469  (corrected_preti
-0000cc20: 6c74 5f61 6e67 6c65 290a 2020 2020 2020  lt_angle).      
-0000cc30: 2020 7a5f 6d6f 7665 203d 202d 795f 7361    z_move = -y_sa
-0000cc40: 6d70 6c65 5f6d 6f76 6520 2a20 6e70 2e73  mple_move * np.s
-0000cc50: 696e 2863 6f72 7265 6374 6564 5f70 7265  in(corrected_pre
-0000cc60: 7469 6c74 5f61 6e67 6c65 2920 2354 4f44  tilt_angle) #TOD
-0000cc70: 4f3a 2069 6e76 6573 7469 6761 7465 2074  O: investigate t
-0000cc80: 6869 730a 0a20 2020 2020 2020 2072 6574  his..        ret
-0000cc90: 7572 6e20 4669 6273 656d 5374 6167 6550  urn FibsemStageP
-0000cca0: 6f73 6974 696f 6e28 783d 302c 2079 3d79  osition(x=0, y=y
-0000ccb0: 5f6d 6f76 652c 207a 3d7a 5f6d 6f76 6529  _move, z=z_move)
-0000ccc0: 0a20 2020 200a 2020 2020 6465 6620 5f73  .    .    def _s
-0000ccd0: 6166 655f 726f 7461 7469 6f6e 5f6d 6f76  afe_rotation_mov
-0000cce0: 656d 656e 7428 0a20 2020 2020 2020 2073  ement(.        s
-0000ccf0: 656c 662c 2073 7461 6765 5f70 6f73 6974  elf, stage_posit
-0000cd00: 696f 6e3a 2046 6962 7365 6d53 7461 6765  ion: FibsemStage
-0000cd10: 506f 7369 7469 6f6e 0a20 2020 2029 3a0a  Position.    ):.
-0000cd20: 2020 2020 2020 2020 2222 2254 696c 7420          """Tilt 
-0000cd30: 7468 6520 7374 6167 6520 666c 6174 2077  the stage flat w
-0000cd40: 6865 6e20 7065 7266 6f72 6d69 6e67 2061  hen performing a
-0000cd50: 206c 6172 6765 2072 6f74 6174 696f 6e20   large rotation 
-0000cd60: 746f 2070 7265 7665 6e74 2063 6f6c 6c69  to prevent colli
-0000cd70: 7369 6f6e 2e0a 0a20 2020 2020 2020 2041  sion...        A
-0000cd80: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-0000cd90: 2073 7461 6765 5f70 6f73 6974 696f 6e20   stage_position 
-0000cda0: 2853 7461 6765 506f 7369 7469 6f6e 293a  (StagePosition):
-0000cdb0: 2064 6573 6972 6564 2073 7461 6765 2070   desired stage p
-0000cdc0: 6f73 6974 696f 6e2e 0a20 2020 2020 2020  osition..       
-0000cdd0: 2022 2222 0a20 2020 2020 2020 2063 7572   """.        cur
-0000cde0: 7265 6e74 5f70 6f73 6974 696f 6e20 3d20  rent_position = 
-0000cdf0: 7365 6c66 2e67 6574 5f73 7461 6765 5f70  self.get_stage_p
-0000ce00: 6f73 6974 696f 6e28 290a 0a20 2020 2020  osition()..     
-0000ce10: 2020 2023 2074 696c 7420 666c 6174 2066     # tilt flat f
-0000ce20: 6f72 206c 6172 6765 2072 6f74 6174 696f  or large rotatio
-0000ce30: 6e73 2074 6f20 7072 6576 656e 7420 636f  ns to prevent co
-0000ce40: 6c6c 6973 696f 6e73 0a20 2020 2020 2020  llisions.       
-0000ce50: 2066 726f 6d20 6669 6273 656d 2069 6d70   from fibsem imp
-0000ce60: 6f72 7420 6d6f 7665 6d65 6e74 0a20 2020  ort movement.   
-0000ce70: 2020 2020 2069 6620 6d6f 7665 6d65 6e74       if movement
-0000ce80: 2e72 6f74 6174 696f 6e5f 616e 676c 655f  .rotation_angle_
-0000ce90: 6973 5f6c 6172 6765 7228 7374 6167 655f  is_larger(stage_
-0000cea0: 706f 7369 7469 6f6e 2e72 2c20 6375 7272  position.r, curr
-0000ceb0: 656e 745f 706f 7369 7469 6f6e 2e72 293a  ent_position.r):
-0000cec0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0000ced0: 6c66 2e6d 6f76 655f 7374 6167 655f 6162  lf.move_stage_ab
-0000cee0: 736f 6c75 7465 2846 6962 7365 6d53 7461  solute(FibsemSta
-0000cef0: 6765 506f 7369 7469 6f6e 2874 3d30 2929  gePosition(t=0))
-0000cf00: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0000cf10: 6769 6e67 2e69 6e66 6f28 6622 7469 6c74  ging.info(f"tilt
-0000cf20: 696e 6720 746f 2066 6c61 7420 666f 7220  ing to flat for 
-0000cf30: 6c61 7267 6520 726f 7461 7469 6f6e 2e22  large rotation."
-0000cf40: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0000cf50: 6e0a 0a0a 2020 2020 6465 6620 7361 6665  n...    def safe
-0000cf60: 5f61 6273 6f6c 7574 655f 7374 6167 655f  _absolute_stage_
-0000cf70: 6d6f 7665 6d65 6e74 2873 656c 662c 2073  movement(self, s
-0000cf80: 7461 6765 5f70 6f73 6974 696f 6e3a 2046  tage_position: F
-0000cf90: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-0000cfa0: 6f6e 0a20 2020 2029 202d 3e20 4e6f 6e65  on.    ) -> None
-0000cfb0: 3a0a 2020 2020 2020 2020 2222 224d 6f76  :.        """Mov
-0000cfc0: 6520 7468 6520 7374 6167 6520 746f 2074  e the stage to t
-0000cfd0: 6865 2064 6573 6972 6564 2070 6f73 6974  he desired posit
-0000cfe0: 696f 6e20 696e 2061 2073 6166 6520 6d61  ion in a safe ma
-0000cff0: 6e6e 6572 2c20 7573 696e 6720 636f 6d70  nner, using comp
-0000d000: 7563 656e 7472 6963 2072 6f74 6174 696f  ucentric rotatio
-0000d010: 6e2e 0a20 2020 2020 2020 2053 7570 706f  n..        Suppo
-0000d020: 7274 7320 6d6f 7665 6d65 6e74 7320 696e  rts movements in
-0000d030: 2074 6865 2073 7461 6765 5f70 6f73 6974   the stage_posit
-0000d040: 696f 6e20 636f 6f72 6469 6e61 7465 2073  ion coordinate s
-0000d050: 7973 7465 6d0a 0a20 2020 2020 2020 2022  ystem..        "
-0000d060: 2222 0a0a 2020 2020 2020 2020 2320 7469  ""..        # ti
-0000d070: 6c74 2066 6c61 7420 666f 7220 6c61 7267  lt flat for larg
-0000d080: 6520 726f 7461 7469 6f6e 7320 746f 2070  e rotations to p
-0000d090: 7265 7665 6e74 2063 6f6c 6c69 7369 6f6e  revent collision
-0000d0a0: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
-0000d0b0: 7361 6665 5f72 6f74 6174 696f 6e5f 6d6f  safe_rotation_mo
-0000d0c0: 7665 6d65 6e74 2873 7461 6765 5f70 6f73  vement(stage_pos
-0000d0d0: 6974 696f 6e29 0a0a 2020 2020 2020 2020  ition)..        
-0000d0e0: 2320 6d6f 7665 2074 6f20 636f 6d70 7563  # move to compuc
-0000d0f0: 656e 7472 6963 2072 6f74 6174 696f 6e0a  entric rotation.
-0000d100: 2020 2020 2020 2020 7365 6c66 2e6d 6f76          self.mov
-0000d110: 655f 7374 6167 655f 6162 736f 6c75 7465  e_stage_absolute
-0000d120: 2846 6962 7365 6d53 7461 6765 506f 7369  (FibsemStagePosi
-0000d130: 7469 6f6e 2872 3d73 7461 6765 5f70 6f73  tion(r=stage_pos
-0000d140: 6974 696f 6e2e 7229 290a 0a20 2020 2020  ition.r))..     
-0000d150: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
-0000d160: 2866 2273 6166 6520 6d6f 7669 6e67 2074  (f"safe moving t
-0000d170: 6f20 7b73 7461 6765 5f70 6f73 6974 696f  o {stage_positio
-0000d180: 6e7d 2229 0a20 2020 2020 2020 2073 656c  n}").        sel
-0000d190: 662e 6d6f 7665 5f73 7461 6765 5f61 6273  f.move_stage_abs
-0000d1a0: 6f6c 7574 6528 7374 6167 655f 706f 7369  olute(stage_posi
-0000d1b0: 7469 6f6e 290a 0a20 2020 2020 2020 206c  tion)..        l
-0000d1c0: 6f67 6769 6e67 2e64 6562 7567 2866 2273  ogging.debug(f"s
-0000d1d0: 6166 6520 6d6f 7665 6d65 6e74 2063 6f6d  afe movement com
-0000d1e0: 706c 6574 652e 2229 0a0a 2020 2020 2020  plete.")..      
-0000d1f0: 2020 7265 7475 726e 0a0a 2020 2020 6465    return..    de
-0000d200: 6620 7072 6f6a 6563 745f 7374 6162 6c65  f project_stable
-0000d210: 5f6d 6f76 6528 7365 6c66 2c20 0a20 2020  _move(self, .   
-0000d220: 2020 2020 2064 783a 666c 6f61 742c 2064       dx:float, d
-0000d230: 793a 666c 6f61 742c 200a 2020 2020 2020  y:float, .      
-0000d240: 2020 6265 616d 5f74 7970 653a 4265 616d    beam_type:Beam
-0000d250: 5479 7065 2c20 0a20 2020 2020 2020 2062  Type, .        b
-0000d260: 6173 655f 706f 7369 7469 6f6e 3a46 6962  ase_position:Fib
-0000d270: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-0000d280: 2920 2d3e 2046 6962 7365 6d53 7461 6765  ) -> FibsemStage
-0000d290: 506f 7369 7469 6f6e 3a0a 0a20 2020 2020  Position:..     
-0000d2a0: 2020 2023 2073 7461 626c 652d 6d6f 7665     # stable-move
-0000d2b0: 2d70 726f 6a65 6374 696f 6e0a 2020 2020  -projection.    
-0000d2c0: 2020 2020 706f 696e 745f 797a 203d 2073      point_yz = s
-0000d2d0: 656c 662e 5f79 5f63 6f72 7265 6374 6564  elf._y_corrected
-0000d2e0: 5f73 7461 6765 5f6d 6f76 656d 656e 7428  _stage_movement(
-0000d2f0: 6479 2c20 6265 616d 5f74 7970 6529 0a20  dy, beam_type). 
-0000d300: 2020 2020 2020 2064 792c 2064 7a20 3d20         dy, dz = 
-0000d310: 706f 696e 745f 797a 2e79 2c20 706f 696e  point_yz.y, poin
-0000d320: 745f 797a 2e7a 0a0a 2020 2020 2020 2020  t_yz.z..        
-0000d330: 2320 6361 6c63 756c 6174 6520 7468 6520  # calculate the 
-0000d340: 636f 7272 6563 7465 6420 6d6f 7665 2074  corrected move t
-0000d350: 6f20 7265 6163 6820 7468 6174 2070 6f69  o reach that poi
-0000d360: 6e74 2066 726f 6d20 6261 7365 2d73 7461  nt from base-sta
-0000d370: 7465 3f0a 2020 2020 2020 2020 5f6e 6577  te?.        _new
-0000d380: 5f70 6f73 6974 696f 6e20 3d20 6465 6570  _position = deep
-0000d390: 636f 7079 2862 6173 655f 706f 7369 7469  copy(base_positi
-0000d3a0: 6f6e 290a 2020 2020 2020 2020 5f6e 6577  on).        _new
-0000d3b0: 5f70 6f73 6974 696f 6e2e 7820 2b3d 2064  _position.x += d
-0000d3c0: 780a 2020 2020 2020 2020 5f6e 6577 5f70  x.        _new_p
-0000d3d0: 6f73 6974 696f 6e2e 7920 2b3d 2064 790a  osition.y += dy.
-0000d3e0: 2020 2020 2020 2020 5f6e 6577 5f70 6f73          _new_pos
-0000d3f0: 6974 696f 6e2e 7a20 2b3d 2064 7a0a 0a20  ition.z += dz.. 
-0000d400: 2020 2020 2020 2072 6574 7572 6e20 5f6e         return _n
-0000d410: 6577 5f70 6f73 6974 696f 6e0a 2020 2020  ew_position.    
-0000d420: 0a20 2020 2064 6566 2069 6e73 6572 745f  .    def insert_
-0000d430: 6d61 6e69 7075 6c61 746f 7228 7365 6c66  manipulator(self
-0000d440: 2c20 6e61 6d65 3a20 7374 7220 3d20 2250  , name: str = "P
-0000d450: 4152 4b22 293a 0a20 2020 2020 2020 2022  ARK"):.        "
-0000d460: 2222 496e 7365 7274 2074 6865 206d 616e  ""Insert the man
-0000d470: 6970 756c 6174 6f72 2074 6f20 7468 6520  ipulator to the 
-0000d480: 7370 6563 6966 6965 6420 706f 7369 7469  specified positi
-0000d490: 6f6e 2222 220a 0a20 2020 2020 2020 2069  on"""..        i
-0000d4a0: 6620 6e6f 7420 7365 6c66 2e69 735f 6176  f not self.is_av
-0000d4b0: 6169 6c61 626c 6528 226d 616e 6970 756c  ailable("manipul
-0000d4c0: 6174 6f72 2229 3a0a 2020 2020 2020 2020  ator"):.        
-0000d4d0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-0000d4e0: 7272 6f72 2822 4d61 6e69 7075 6c61 746f  rror("Manipulato
-0000d4f0: 7220 6e6f 7420 6176 6169 6c61 626c 652e  r not available.
-0000d500: 2229 0a20 2020 2020 2020 2020 0a20 2020  ").         .   
-0000d510: 2020 2020 2069 6620 6e61 6d65 206e 6f74       if name not
-0000d520: 2069 6e20 5b22 5041 524b 222c 2022 4555   in ["PARK", "EU
-0000d530: 4345 4e54 5249 4322 5d3a 0a20 2020 2020  CENTRIC"]:.     
-0000d540: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-0000d550: 7565 4572 726f 7228 6622 696e 7365 7274  ueError(f"insert
-0000d560: 2070 6f73 6974 696f 6e20 7b6e 616d 657d   position {name}
-0000d570: 206e 6f74 2073 7570 706f 7274 6564 2e22   not supported."
-0000d580: 290a 2020 2020 2020 2020 6966 2056 4552  ).        if VER
-0000d590: 5349 4f4e 203c 2034 2e37 3a0a 2020 2020  SION < 4.7:.    
-0000d5a0: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
-0000d5b0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
-0000d5c0: 7228 224d 616e 6970 756c 6174 6f72 2073  r("Manipulator s
-0000d5d0: 6176 6564 2070 6f73 6974 696f 6e73 206e  aved positions n
-0000d5e0: 6f74 2073 7570 706f 7274 6564 2069 6e20  ot supported in 
-0000d5f0: 7468 6973 2076 6572 7369 6f6e 2e20 506c  this version. Pl
-0000d600: 6561 7365 2075 7067 7261 6465 2074 6f20  ease upgrade to 
-0000d610: 342e 3720 6f72 2068 6967 6865 7222 290a  4.7 or higher").
-0000d620: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0000d630: 2023 2067 6574 2074 6865 2073 6176 6564   # get the saved
-0000d640: 2070 6f73 6974 696f 6e20 6e61 6d65 0a20   position name. 
-0000d650: 2020 2020 2020 2073 6176 6564 5f70 6f73         saved_pos
-0000d660: 6974 696f 6e20 3d20 4d61 6e69 7075 6c61  ition = Manipula
-0000d670: 746f 7253 6176 6564 506f 7369 7469 6f6e  torSavedPosition
-0000d680: 2e50 4152 4b20 6966 206e 616d 6520 3d3d  .PARK if name ==
-0000d690: 2022 5041 524b 2220 656c 7365 204d 616e   "PARK" else Man
-0000d6a0: 6970 756c 6174 6f72 5361 7665 6450 6f73  ipulatorSavedPos
-0000d6b0: 6974 696f 6e2e 4555 4345 4e54 5249 430a  ition.EUCENTRIC.
-0000d6c0: 0a20 2020 2020 2020 2023 2067 6574 2074  .        # get t
-0000d6d0: 6865 2069 6e73 6572 7420 706f 7369 7469  he insert positi
-0000d6e0: 6f6e 0a20 2020 2020 2020 2069 6e73 6572  on.        inser
-0000d6f0: 745f 706f 7369 7469 6f6e 203d 2073 656c  t_position = sel
-0000d700: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
-0000d710: 6369 6d65 6e2e 6d61 6e69 7075 6c61 746f  cimen.manipulato
-0000d720: 722e 6765 745f 7361 7665 645f 706f 7369  r.get_saved_posi
-0000d730: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
-0000d740: 2020 7361 7665 645f 706f 7369 7469 6f6e    saved_position
-0000d750: 2c20 4d61 6e69 7075 6c61 746f 7243 6f6f  , ManipulatorCoo
-0000d760: 7264 696e 6174 6553 7973 7465 6d2e 5241  rdinateSystem.RA
-0000d770: 570a 2020 2020 2020 2020 290a 2020 2020  W.        ).    
-0000d780: 2020 2020 2320 696e 7365 7274 2074 6865      # insert the
-0000d790: 206d 616e 6970 756c 6174 6f72 0a20 2020   manipulator.   
-0000d7a0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0000d7b0: 6f28 6622 696e 7365 7274 696e 6720 6d61  o(f"inserting ma
-0000d7c0: 6e69 7075 6c61 746f 7220 746f 207b 7361  nipulator to {sa
-0000d7d0: 7665 645f 706f 7369 7469 6f6e 7d3a 207b  ved_position}: {
-0000d7e0: 696e 7365 7274 5f70 6f73 6974 696f 6e7d  insert_position}
-0000d7f0: 2e22 290a 2020 2020 2020 2020 7365 6c66  .").        self
-0000d800: 2e63 6f6e 6e65 6374 696f 6e2e 7370 6563  .connection.spec
-0000d810: 696d 656e 2e6d 616e 6970 756c 6174 6f72  imen.manipulator
-0000d820: 2e69 6e73 6572 7428 696e 7365 7274 5f70  .insert(insert_p
-0000d830: 6f73 6974 696f 6e29 0a20 2020 2020 2020  osition).       
-0000d840: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-0000d850: 696e 7365 7274 206d 616e 6970 756c 6174  insert manipulat
-0000d860: 6f72 2063 6f6d 706c 6574 652e 2229 0a0a  or complete.")..
-0000d870: 2020 2020 2020 2020 2320 7265 7475 726e          # return
-0000d880: 2074 6865 206d 616e 6970 756c 6174 6f72   the manipulator
-0000d890: 2070 6f73 6974 696f 6e0a 2020 2020 2020   position.      
-0000d8a0: 2020 6d61 6e69 7075 6c61 746f 725f 706f    manipulator_po
-0000d8b0: 7369 7469 6f6e 203d 2073 656c 662e 6765  sition = self.ge
-0000d8c0: 745f 6d61 6e69 7075 6c61 746f 725f 706f  t_manipulator_po
-0000d8d0: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
-0000d8e0: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-0000d8f0: 226d 7367 223a 2022 696e 7365 7274 5f6d  "msg": "insert_m
-0000d900: 616e 6970 756c 6174 6f72 222c 2022 6e61  anipulator", "na
-0000d910: 6d65 223a 206e 616d 652c 2022 706f 7369  me": name, "posi
-0000d920: 7469 6f6e 223a 206d 616e 6970 756c 6174  tion": manipulat
-0000d930: 6f72 5f70 6f73 6974 696f 6e2e 746f 5f64  or_position.to_d
-0000d940: 6963 7428 297d 2920 2020 2020 2020 2020  ict()})         
-0000d950: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0000d960: 2020 2020 2020 7265 7475 726e 206d 616e        return man
-0000d970: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
-0000d980: 6e0a 0a20 2020 2064 6566 2072 6574 7261  n..    def retra
-0000d990: 6374 5f6d 616e 6970 756c 6174 6f72 2873  ct_manipulator(s
-0000d9a0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-0000d9b0: 2252 6574 7261 6374 2074 6865 206d 616e  "Retract the man
-0000d9c0: 6970 756c 6174 6f72 2222 2220 2020 2020  ipulator"""     
-0000d9d0: 2020 200a 0a20 2020 2020 2020 2069 6620     ..        if 
-0000d9e0: 5645 5253 494f 4e20 3c20 342e 373a 0a20  VERSION < 4.7:. 
-0000d9f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000da00: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
-0000da10: 7272 6f72 2822 4d61 6e69 7075 6c61 746f  rror("Manipulato
-0000da20: 7220 7361 7665 6420 706f 7369 7469 6f6e  r saved position
-0000da30: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
-0000da40: 696e 2074 6869 7320 7665 7273 696f 6e2e  in this version.
-0000da50: 2050 6c65 6173 6520 7570 6772 6164 6520   Please upgrade 
-0000da60: 746f 2034 2e37 206f 7220 6869 6768 6572  to 4.7 or higher
-0000da70: 2229 0a0a 2020 2020 2020 2020 6966 206e  ")..        if n
-0000da80: 6f74 2073 656c 662e 6973 5f61 7661 696c  ot self.is_avail
-0000da90: 6162 6c65 2822 6d61 6e69 7075 6c61 746f  able("manipulato
-0000daa0: 7222 293a 0a20 2020 2020 2020 2020 2020  r"):.           
-0000dab0: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-0000dac0: 656e 7465 6445 7272 6f72 2822 4d61 6e69  entedError("Mani
-0000dad0: 7075 6c61 746f 7220 6e6f 7420 6176 6169  pulator not avai
-0000dae0: 6c61 626c 652e 2229 0a0a 2020 2020 2020  lable.")..      
-0000daf0: 2020 2320 5265 7472 6163 7420 7468 6520    # Retract the 
-0000db00: 6e65 6564 6c65 2c20 7072 6573 6572 7669  needle, preservi
-0000db10: 6e67 2074 6865 2063 6f72 7265 6374 2070  ng the correct p
-0000db20: 6172 6b69 6e67 2070 6f73 7469 696f 6e0a  arking postiion.
-0000db30: 2020 2020 2020 2020 6e65 6564 6c65 203d          needle =
-0000db40: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0000db50: 2e73 7065 6369 6d65 6e2e 6d61 6e69 7075  .specimen.manipu
-0000db60: 6c61 746f 720a 2020 2020 2020 2020 7061  lator.        pa
-0000db70: 726b 5f70 6f73 6974 696f 6e20 3d20 6e65  rk_position = ne
-0000db80: 6564 6c65 2e67 6574 5f73 6176 6564 5f70  edle.get_saved_p
-0000db90: 6f73 6974 696f 6e28 0a20 2020 2020 2020  osition(.       
-0000dba0: 2020 2020 204d 616e 6970 756c 6174 6f72       Manipulator
-0000dbb0: 5361 7665 6450 6f73 6974 696f 6e2e 5041  SavedPosition.PA
-0000dbc0: 524b 2c20 4d61 6e69 7075 6c61 746f 7243  RK, ManipulatorC
-0000dbd0: 6f6f 7264 696e 6174 6553 7973 7465 6d2e  oordinateSystem.
-0000dbe0: 5241 570a 2020 2020 2020 2020 290a 0a20  RAW.        ).. 
-0000dbf0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0000dc00: 6e66 6f28 6622 7265 7472 6163 7469 6e67  nfo(f"retracting
-0000dc10: 206e 6565 646c 6520 746f 207b 7061 726b   needle to {park
-0000dc20: 5f70 6f73 6974 696f 6e7d 2229 0a20 2020  _position}").   
-0000dc30: 2020 2020 206e 6565 646c 652e 6162 736f       needle.abso
-0000dc40: 6c75 7465 5f6d 6f76 6528 7061 726b 5f70  lute_move(park_p
-0000dc50: 6f73 6974 696f 6e29 0a20 2020 2020 2020  osition).       
-0000dc60: 2074 696d 652e 736c 6565 7028 3129 2020   time.sleep(1)  
-0000dc70: 2320 4175 746f 5363 7269 7074 2073 6f6d  # AutoScript som
-0000dc80: 6574 696d 6573 2074 6872 6f77 7320 6572  etimes throws er
-0000dc90: 726f 7273 2069 6620 796f 7520 7265 7472  rors if you retr
-0000dca0: 6163 7420 746f 6f20 7175 6963 6b3f 0a20  act too quick?. 
-0000dcb0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0000dcc0: 6e66 6f28 6622 7265 7472 6163 7469 6e67  nfo(f"retracting
-0000dcd0: 206e 6565 646c 652e 2e2e 2229 0a20 2020   needle...").   
-0000dce0: 2020 2020 206e 6565 646c 652e 7265 7472       needle.retr
-0000dcf0: 6163 7428 290a 2020 2020 2020 2020 6c6f  act().        lo
-0000dd00: 6767 696e 672e 696e 666f 2866 2272 6574  gging.info(f"ret
-0000dd10: 7261 6374 206e 6565 646c 6520 636f 6d70  ract needle comp
-0000dd20: 6c65 7465 2229 0a20 2020 200a 2020 2020  lete").    .    
-0000dd30: 6465 6620 6d6f 7665 5f6d 616e 6970 756c  def move_manipul
-0000dd40: 6174 6f72 5f72 656c 6174 6976 6528 7365  ator_relative(se
-0000dd50: 6c66 2c20 706f 7369 7469 6f6e 3a20 4669  lf, position: Fi
-0000dd60: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-0000dd70: 6f73 6974 696f 6e29 3a0a 2020 2020 2020  osition):.      
-0000dd80: 2020 5f63 6865 636b 5f6d 616e 6970 756c    _check_manipul
-0000dd90: 6174 6f72 5f6d 6f76 656d 656e 7428 7365  ator_movement(se
-0000dda0: 6c66 2e73 7973 7465 6d2c 2070 6f73 6974  lf.system, posit
-0000ddb0: 696f 6e29 0a0a 2020 2020 2020 2020 6c6f  ion)..        lo
-0000ddc0: 6767 696e 672e 696e 666f 2866 226d 6f76  gging.info(f"mov
-0000ddd0: 696e 6720 6d61 6e69 7075 6c61 746f 7220  ing manipulator 
-0000dde0: 6279 207b 706f 7369 7469 6f6e 7d22 290a  by {position}").
-0000ddf0: 0a20 2020 2020 2020 2023 2063 6f6e 7665  .        # conve
-0000de00: 7274 2074 6f20 6175 746f 7363 7269 7074  rt to autoscript
-0000de10: 2070 6f73 6974 696f 6e0a 2020 2020 2020   position.      
-0000de20: 2020 6175 746f 7363 7269 7074 5f70 6f73    autoscript_pos
-0000de30: 6974 696f 6e20 3d20 706f 7369 7469 6f6e  ition = position
-0000de40: 2e74 6f5f 6175 746f 7363 7269 7074 5f70  .to_autoscript_p
-0000de50: 6f73 6974 696f 6e28 290a 2020 2020 2020  osition().      
-0000de60: 2020 2320 6d6f 7665 206d 616e 6970 756c    # move manipul
-0000de70: 6174 6f72 2072 656c 6174 6976 650a 2020  ator relative.  
-0000de80: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0000de90: 6374 696f 6e2e 7370 6563 696d 656e 2e6d  ction.specimen.m
-0000dea0: 616e 6970 756c 6174 6f72 2e72 656c 6174  anipulator.relat
-0000deb0: 6976 655f 6d6f 7665 2861 7574 6f73 6372  ive_move(autoscr
-0000dec0: 6970 745f 706f 7369 7469 6f6e 290a 2020  ipt_position).  
-0000ded0: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
-0000dee0: 6275 6728 7b22 6d73 6722 3a20 226d 6f76  bug({"msg": "mov
-0000def0: 655f 6d61 6e69 7075 6c61 746f 725f 7265  e_manipulator_re
-0000df00: 6c61 7469 7665 222c 2022 706f 7369 7469  lative", "positi
-0000df10: 6f6e 223a 2070 6f73 6974 696f 6e2e 746f  on": position.to
-0000df20: 5f64 6963 7428 297d 290a 0a20 2020 2064  _dict()})..    d
-0000df30: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
-0000df40: 746f 725f 6162 736f 6c75 7465 2873 656c  tor_absolute(sel
-0000df50: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
-0000df60: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
-0000df70: 7369 7469 6f6e 293a 0a20 2020 2020 2020  sition):.       
-0000df80: 2022 2222 4d6f 7665 2074 6865 206d 616e   """Move the man
-0000df90: 6970 756c 6174 6f72 2074 6f20 7468 6520  ipulator to the 
-0000dfa0: 7370 6563 6966 6965 6420 636f 6f72 6469  specified coordi
-0000dfb0: 6e61 7465 732e 2222 220a 0a20 2020 2020  nates."""..     
-0000dfc0: 2020 205f 6368 6563 6b5f 6d61 6e69 7075     _check_manipu
-0000dfd0: 6c61 746f 725f 6d6f 7665 6d65 6e74 2873  lator_movement(s
-0000dfe0: 656c 662e 7379 7374 656d 2c20 706f 7369  elf.system, posi
-0000dff0: 7469 6f6e 290a 2020 2020 2020 2020 6c6f  tion).        lo
-0000e000: 6767 696e 672e 696e 666f 2866 226d 6f76  gging.info(f"mov
-0000e010: 696e 6720 6d61 6e69 7075 6c61 746f 7220  ing manipulator 
-0000e020: 746f 207b 706f 7369 7469 6f6e 7d22 290a  to {position}").
-0000e030: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0000e040: 2023 2063 6f6e 7665 7274 2074 6f20 6175   # convert to au
-0000e050: 746f 7363 7269 7074 0a20 2020 2020 2020  toscript.       
-0000e060: 2061 7574 6f73 6372 6970 745f 706f 7369   autoscript_posi
-0000e070: 7469 6f6e 203d 2070 6f73 6974 696f 6e2e  tion = position.
-0000e080: 746f 5f61 7574 6f73 6372 6970 745f 706f  to_autoscript_po
-0000e090: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
-0000e0a0: 200a 2020 2020 2020 2020 2320 6d6f 7665   .        # move
-0000e0b0: 206d 616e 6970 756c 6174 6f72 0a20 2020   manipulator.   
-0000e0c0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0000e0d0: 7469 6f6e 2e73 7065 6369 6d65 6e2e 6d61  tion.specimen.ma
-0000e0e0: 6e69 7075 6c61 746f 722e 6162 736f 6c75  nipulator.absolu
-0000e0f0: 7465 5f6d 6f76 6528 6175 746f 7363 7269  te_move(autoscri
-0000e100: 7074 5f70 6f73 6974 696f 6e29 0a20 2020  pt_position).   
-0000e110: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
-0000e120: 7567 287b 226d 7367 223a 2022 6d6f 7665  ug({"msg": "move
-0000e130: 5f6d 616e 6970 756c 6174 6f72 5f61 6273  _manipulator_abs
-0000e140: 6f6c 7574 6522 2c20 2270 6f73 6974 696f  olute", "positio
-0000e150: 6e22 3a20 706f 7369 7469 6f6e 2e74 6f5f  n": position.to_
-0000e160: 6469 6374 2829 7d29 0a0a 2020 2020 6465  dict()})..    de
-0000e170: 6620 5f78 5f63 6f72 7265 6374 6564 5f6e  f _x_corrected_n
-0000e180: 6565 646c 655f 6d6f 7665 6d65 6e74 2873  eedle_movement(s
-0000e190: 656c 662c 2065 7870 6563 7465 645f 783a  elf, expected_x:
-0000e1a0: 2066 6c6f 6174 2920 2d3e 2046 6962 7365   float) -> Fibse
-0000e1b0: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
-0000e1c0: 7469 6f6e 3a0a 2020 2020 2020 2020 2222  tion:.        ""
-0000e1d0: 2243 616c 6375 6c61 7465 2074 6865 2063  "Calculate the c
-0000e1e0: 6f72 7265 6374 6564 206e 6565 646c 6520  orrected needle 
-0000e1f0: 6d6f 7665 6d65 6e74 2074 6f20 6d6f 7665  movement to move
-0000e200: 2069 6e20 7468 6520 782d 6178 6973 2e0a   in the x-axis..
-0000e210: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-0000e220: 2020 2020 2020 2020 2020 2065 7870 6563             expec
-0000e230: 7465 645f 7820 2866 6c6f 6174 293a 2064  ted_x (float): d
-0000e240: 6973 7461 6e63 6520 616c 6f6e 6720 7468  istance along th
-0000e250: 6520 782d 6178 6973 2028 696d 6167 6520  e x-axis (image 
-0000e260: 636f 6f72 6469 6e61 7465 7329 0a20 2020  coordinates).   
-0000e270: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-0000e280: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
-0000e290: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
-0000e2a0: 696f 6e3a 2078 2d63 6f72 7265 6374 6564  ion: x-corrected
-0000e2b0: 206e 6565 646c 6520 6d6f 7665 6d65 6e74   needle movement
-0000e2c0: 2028 7265 6c61 7469 7665 2070 6f73 6974   (relative posit
-0000e2d0: 696f 6e29 0a20 2020 2020 2020 2022 2222  ion).        """
-0000e2e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000e2f0: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
-0000e300: 7250 6f73 6974 696f 6e28 783d 6578 7065  rPosition(x=expe
-0000e310: 6374 6564 5f78 2c20 793d 302c 207a 3d30  cted_x, y=0, z=0
-0000e320: 2920 2023 206e 6f20 6164 6a75 7374 6d65  )  # no adjustme
-0000e330: 6e74 206e 6565 6465 640a 0a0a 2020 2020  nt needed...    
-0000e340: 6465 6620 5f79 5f63 6f72 7265 6374 6564  def _y_corrected
-0000e350: 5f6e 6565 646c 655f 6d6f 7665 6d65 6e74  _needle_movement
-0000e360: 2873 656c 662c 200a 2020 2020 2020 2020  (self, .        
-0000e370: 6578 7065 6374 6564 5f79 3a20 666c 6f61  expected_y: floa
-0000e380: 742c 2073 7461 6765 5f74 696c 743a 2066  t, stage_tilt: f
-0000e390: 6c6f 6174 0a20 2020 2029 202d 3e20 4669  loat.    ) -> Fi
-0000e3a0: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-0000e3b0: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-0000e3c0: 2022 2222 4361 6c63 756c 6174 6520 7468   """Calculate th
-0000e3d0: 6520 636f 7272 6563 7465 6420 6e65 6564  e corrected need
-0000e3e0: 6c65 206d 6f76 656d 656e 7420 746f 206d  le movement to m
-0000e3f0: 6f76 6520 696e 2074 6865 2079 2d61 7869  ove in the y-axi
-0000e400: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
-0000e410: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-0000e420: 7065 6374 6564 5f79 2028 666c 6f61 7429  pected_y (float)
-0000e430: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
-0000e440: 2074 6865 2079 2d61 7869 7320 2869 6d61   the y-axis (ima
-0000e450: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
-0000e460: 2020 2020 2020 2020 2020 2020 7374 6167              stag
-0000e470: 655f 7469 6c74 2028 666c 6f61 742c 206f  e_tilt (float, o
-0000e480: 7074 696f 6e61 6c29 3a20 7374 6167 6520  ptional): stage 
-0000e490: 7469 6c74 2e0a 0a20 2020 2020 2020 2052  tilt...        R
-0000e4a0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0000e4b0: 2020 2020 4669 6273 656d 4d61 6e69 7075      FibsemManipu
-0000e4c0: 6c61 746f 7250 6f73 6974 696f 6e3a 2079  latorPosition: y
-0000e4d0: 2d63 6f72 7265 6374 6564 206e 6565 646c  -corrected needl
-0000e4e0: 6520 6d6f 7665 6d65 6e74 2028 7265 6c61  e movement (rela
-0000e4f0: 7469 7665 2070 6f73 6974 696f 6e29 0a20  tive position). 
-0000e500: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000e510: 2020 2079 5f6d 6f76 6520 3d20 2b6e 702e     y_move = +np.
-0000e520: 636f 7328 7374 6167 655f 7469 6c74 2920  cos(stage_tilt) 
-0000e530: 2a20 6578 7065 6374 6564 5f79 0a20 2020  * expected_y.   
-0000e540: 2020 2020 207a 5f6d 6f76 6520 3d20 2b6e       z_move = +n
-0000e550: 702e 7369 6e28 7374 6167 655f 7469 6c74  p.sin(stage_tilt
-0000e560: 2920 2a20 6578 7065 6374 6564 5f79 0a20  ) * expected_y. 
-0000e570: 2020 2020 2020 2072 6574 7572 6e20 4669         return Fi
-0000e580: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-0000e590: 6f73 6974 696f 6e28 783d 302c 2079 3d79  osition(x=0, y=y
-0000e5a0: 5f6d 6f76 652c 207a 3d7a 5f6d 6f76 6529  _move, z=z_move)
-0000e5b0: 0a0a 0a20 2020 2064 6566 205f 7a5f 636f  ...    def _z_co
-0000e5c0: 7272 6563 7465 645f 6e65 6564 6c65 5f6d  rrected_needle_m
-0000e5d0: 6f76 656d 656e 7428 7365 6c66 2c20 0a20  ovement(self, . 
-0000e5e0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-0000e5f0: 7a3a 2066 6c6f 6174 2c20 7374 6167 655f  z: float, stage_
-0000e600: 7469 6c74 3a20 666c 6f61 740a 2020 2020  tilt: float.    
-0000e610: 2920 2d3e 2046 6962 7365 6d4d 616e 6970  ) -> FibsemManip
-0000e620: 756c 6174 6f72 506f 7369 7469 6f6e 3a0a  ulatorPosition:.
-0000e630: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
-0000e640: 6c61 7465 2074 6865 2063 6f72 7265 6374  late the correct
-0000e650: 6564 206e 6565 646c 6520 6d6f 7665 6d65  ed needle moveme
-0000e660: 6e74 2074 6f20 6d6f 7665 2069 6e20 7468  nt to move in th
-0000e670: 6520 7a2d 6178 6973 2e0a 0a20 2020 2020  e z-axis...     
-0000e680: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0000e690: 2020 2020 2065 7870 6563 7465 645f 7a20       expected_z 
-0000e6a0: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
-0000e6b0: 6520 616c 6f6e 6720 7468 6520 7a2d 6178  e along the z-ax
-0000e6c0: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
-0000e6d0: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
-0000e6e0: 2020 2073 7461 6765 5f74 696c 7420 2866     stage_tilt (f
-0000e6f0: 6c6f 6174 2c20 6f70 7469 6f6e 616c 293a  loat, optional):
-0000e700: 2073 7461 6765 2074 696c 742e 0a0a 2020   stage tilt...  
-0000e710: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0000e720: 2020 2020 2020 2020 2020 2046 6962 7365             Fibse
-0000e730: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
-0000e740: 7469 6f6e 3a20 7a2d 636f 7272 6563 7465  tion: z-correcte
-0000e750: 6420 6e65 6564 6c65 206d 6f76 656d 656e  d needle movemen
-0000e760: 7420 2872 656c 6174 6976 6520 706f 7369  t (relative posi
-0000e770: 7469 6f6e 290a 2020 2020 2020 2020 2222  tion).        ""
-0000e780: 220a 2020 2020 2020 2020 795f 6d6f 7665  ".        y_move
-0000e790: 203d 202d 6e70 2e73 696e 2873 7461 6765   = -np.sin(stage
-0000e7a0: 5f74 696c 7429 202a 2065 7870 6563 7465  _tilt) * expecte
-0000e7b0: 645f 7a0a 2020 2020 2020 2020 7a5f 6d6f  d_z.        z_mo
-0000e7c0: 7665 203d 202b 6e70 2e63 6f73 2873 7461  ve = +np.cos(sta
-0000e7d0: 6765 5f74 696c 7429 202a 2065 7870 6563  ge_tilt) * expec
-0000e7e0: 7465 645f 7a0a 2020 2020 2020 2020 7265  ted_z.        re
-0000e7f0: 7475 726e 2046 6962 7365 6d4d 616e 6970  turn FibsemManip
-0000e800: 756c 6174 6f72 506f 7369 7469 6f6e 2878  ulatorPosition(x
-0000e810: 3d30 2c20 793d 795f 6d6f 7665 2c20 7a3d  =0, y=y_move, z=
-0000e820: 7a5f 6d6f 7665 290a 0a20 2020 2064 6566  z_move)..    def
-0000e830: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
-0000e840: 725f 636f 7272 6563 7465 6428 7365 6c66  r_corrected(self
-0000e850: 2c20 0a20 2020 2020 2020 2064 783a 2066  , .        dx: f
-0000e860: 6c6f 6174 203d 2030 2c0a 2020 2020 2020  loat = 0,.      
-0000e870: 2020 6479 3a20 666c 6f61 7420 3d20 302c    dy: float = 0,
-0000e880: 0a20 2020 2020 2020 2062 6561 6d5f 7479  .        beam_ty
-0000e890: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
-0000e8a0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0000e8b0: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
-0000e8c0: 0a20 2020 2020 2020 2022 2222 4361 6c63  .        """Calc
-0000e8d0: 756c 6174 6520 7468 6520 7265 7175 6972  ulate the requir
-0000e8e0: 6564 2063 6f72 7265 6374 6564 206e 6565  ed corrected nee
-0000e8f0: 646c 6520 6d6f 7665 6d65 6e74 7320 6261  dle movements ba
-0000e900: 7365 6420 6f6e 2074 6865 2042 6561 6d54  sed on the BeamT
-0000e910: 7970 6520 746f 206d 6f76 6520 696e 2074  ype to move in t
-0000e920: 6865 2064 6573 6972 6564 2069 6d61 6765  he desired image
-0000e930: 2063 6f6f 7264 696e 6174 6573 2e0a 2020   coordinates..  
-0000e940: 2020 2020 2020 5468 656e 206d 6f76 6520        Then move 
-0000e950: 7468 6520 6e65 6564 6c65 2072 656c 6174  the needle relat
-0000e960: 6976 656c 792e 204d 616e 6970 756c 6174  ively. Manipulat
-0000e970: 6f72 206d 6f76 656d 656e 7420 6178 6973  or movement axis
-0000e980: 2069 7320 6261 7365 6420 6f6e 2073 7461   is based on sta
-0000e990: 6765 2074 696c 742c 2073 6f20 7765 206e  ge tilt, so we n
-0000e9a0: 6565 6420 746f 2061 646a 7573 7420 666f  eed to adjust fo
-0000e9b0: 7220 7468 6174 200a 2020 2020 2020 2020  r that .        
-0000e9c0: 7769 7468 2063 6f72 7265 6374 6564 206d  with corrected m
-0000e9d0: 6f76 656d 656e 7473 2c20 6465 7065 6e64  ovements, depend
-0000e9e0: 696e 6720 6f6e 2074 6865 2073 7461 6765  ing on the stage
-0000e9f0: 2074 696c 7420 616e 6420 696d 6167 696e   tilt and imagin
-0000ea00: 6720 7065 7273 7065 6374 6976 652e 0a0a  g perspective...
-0000ea10: 2020 2020 2020 2020 4265 616d 5479 7065          BeamType
-0000ea20: 2e45 4c45 4354 524f 4e3a 2020 6d6f 7665  .ELECTRON:  move
-0000ea30: 2069 6e20 782c 2079 2028 7261 7720 636f   in x, y (raw co
-0000ea40: 6f72 6469 6e61 7465 7329 0a20 2020 2020  ordinates).     
-0000ea50: 2020 2042 6561 6d54 7970 652e 494f 4e3a     BeamType.ION:
-0000ea60: 2020 2020 2020 206d 6f76 6520 696e 2078         move in x
-0000ea70: 2c20 7a20 2872 6177 2063 6f6f 7264 696e  , z (raw coordin
-0000ea80: 6174 6573 290a 0a20 2020 2020 2020 2041  ates)..        A
-0000ea90: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-0000eaa0: 206d 6963 726f 7363 6f70 6520 2846 6962   microscope (Fib
-0000eab0: 7365 6d4d 6963 726f 7363 6f70 6529 200a  semMicroscope) .
-0000eac0: 2020 2020 2020 2020 2020 2020 6478 2028              dx (
-0000ead0: 666c 6f61 7429 3a20 6469 7374 616e 6365  float): distance
-0000eae0: 2061 6c6f 6e67 2074 6865 2078 2d61 7869   along the x-axi
-0000eaf0: 7320 2869 6d61 6765 2063 6f6f 7264 696e  s (image coordin
-0000eb00: 6174 6573 290a 2020 2020 2020 2020 2020  ates).          
-0000eb10: 2020 6479 2028 666c 6f61 7429 3a20 6469    dy (float): di
-0000eb20: 7374 616e 6365 2061 6c6f 6e67 2074 6865  stance along the
-0000eb30: 2079 2d61 7869 7320 2869 6d61 6765 2063   y-axis (image c
-0000eb40: 6f72 6f64 696e 6174 6573 290a 2020 2020  orodinates).    
-0000eb50: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
-0000eb60: 6520 2842 6561 6d54 7970 652c 206f 7074  e (BeamType, opt
-0000eb70: 696f 6e61 6c29 3a20 7468 6520 6265 616d  ional): the beam
-0000eb80: 2074 7970 6520 746f 206d 6f76 6520 696e   type to move in
-0000eb90: 2e20 4465 6661 756c 7473 2074 6f20 4265  . Defaults to Be
-0000eba0: 616d 5479 7065 2e45 4c45 4354 524f 4e2e  amType.ELECTRON.
-0000ebb0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000ebc0: 2020 2020 205f 6368 6563 6b5f 6d61 6e69       _check_mani
-0000ebd0: 7075 6c61 746f 7228 7365 6c66 2e73 7973  pulator(self.sys
-0000ebe0: 7465 6d29 0a20 2020 2020 2020 2073 7461  tem).        sta
-0000ebf0: 6765 5f74 696c 7420 3d20 7365 6c66 2e67  ge_tilt = self.g
-0000ec00: 6574 5f73 7461 6765 5f70 6f73 6974 696f  et_stage_positio
-0000ec10: 6e28 292e 740a 0a20 2020 2020 2020 2023  n().t..        #
-0000ec20: 2078 790a 2020 2020 2020 2020 6966 2062   xy.        if b
-0000ec30: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
-0000ec40: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
-0000ec50: 2020 2020 2020 2020 2020 2078 5f6d 6f76             x_mov
-0000ec60: 6520 3d20 7365 6c66 2e5f 785f 636f 7272  e = self._x_corr
-0000ec70: 6563 7465 645f 6e65 6564 6c65 5f6d 6f76  ected_needle_mov
-0000ec80: 656d 656e 7428 6578 7065 6374 6564 5f78  ement(expected_x
-0000ec90: 3d64 7829 0a20 2020 2020 2020 2020 2020  =dx).           
-0000eca0: 2079 7a5f 6d6f 7665 203d 2073 656c 662e   yz_move = self.
-0000ecb0: 5f79 5f63 6f72 7265 6374 6564 5f6e 6565  _y_corrected_nee
-0000ecc0: 646c 655f 6d6f 7665 6d65 6e74 2864 792c  dle_movement(dy,
-0000ecd0: 2073 7461 6765 5f74 696c 743d 7374 6167   stage_tilt=stag
-0000ece0: 655f 7469 6c74 290a 0a20 2020 2020 2020  e_tilt)..       
-0000ecf0: 2023 2078 7a2c 0a20 2020 2020 2020 2069   # xz,.        i
-0000ed00: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-0000ed10: 6561 6d54 7970 652e 494f 4e3a 0a0a 2020  eamType.ION:..  
-0000ed20: 2020 2020 2020 2020 2020 785f 6d6f 7665            x_move
-0000ed30: 203d 2073 656c 662e 5f78 5f63 6f72 7265   = self._x_corre
-0000ed40: 6374 6564 5f6e 6565 646c 655f 6d6f 7665  cted_needle_move
-0000ed50: 6d65 6e74 2865 7870 6563 7465 645f 783d  ment(expected_x=
-0000ed60: 6478 290a 2020 2020 2020 2020 2020 2020  dx).            
-0000ed70: 797a 5f6d 6f76 6520 3d20 7365 6c66 2e5f  yz_move = self._
-0000ed80: 7a5f 636f 7272 6563 7465 645f 6e65 6564  z_corrected_need
-0000ed90: 6c65 5f6d 6f76 656d 656e 7428 6578 7065  le_movement(expe
-0000eda0: 6374 6564 5f7a 3d64 792c 2073 7461 6765  cted_z=dy, stage
-0000edb0: 5f74 696c 743d 7374 6167 655f 7469 6c74  _tilt=stage_tilt
-0000edc0: 290a 0a20 2020 2020 2020 2023 2065 7870  )..        # exp
-0000edd0: 6c69 6369 746c 7920 7365 7420 7468 6520  licitly set the 
-0000ede0: 636f 6f72 6469 6e61 7465 2073 7973 7465  coordinate syste
-0000edf0: 6d0a 2020 2020 2020 2020 7365 6c66 2e63  m.        self.c
-0000ee00: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
-0000ee10: 656e 2e6d 616e 6970 756c 6174 6f72 2e73  en.manipulator.s
-0000ee20: 6574 5f64 6566 6175 6c74 5f63 6f6f 7264  et_default_coord
-0000ee30: 696e 6174 655f 7379 7374 656d 280a 2020  inate_system(.  
-0000ee40: 2020 2020 2020 2020 2020 4d61 6e69 7075            Manipu
-0000ee50: 6c61 746f 7243 6f6f 7264 696e 6174 6553  latorCoordinateS
-0000ee60: 7973 7465 6d2e 5354 4147 450a 2020 2020  ystem.STAGE.    
-0000ee70: 2020 2020 290a 2020 2020 2020 2020 6d61      ).        ma
-0000ee80: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
-0000ee90: 6f6e 203d 2046 6962 7365 6d4d 616e 6970  on = FibsemManip
-0000eea0: 756c 6174 6f72 506f 7369 7469 6f6e 2878  ulatorPosition(x
-0000eeb0: 3d78 5f6d 6f76 652e 782c 2079 3d79 7a5f  =x_move.x, y=yz_
-0000eec0: 6d6f 7665 2e79 2c20 0a20 2020 2020 2020  move.y, .       
-0000eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eef0: 2020 2020 2020 2020 2020 2020 207a 3d79               z=y
-0000ef00: 7a5f 6d6f 7665 2e7a 2c20 0a20 2020 2020  z_move.z, .     
-0000ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000ef40: 203d 2030 2e30 202c 636f 6f72 6469 6e61   = 0.0 ,coordina
-0000ef50: 7465 5f73 7973 7465 6d3d 2253 5441 4745  te_system="STAGE
-0000ef60: 2229 0a20 2020 2020 2020 200a 2020 2020  ").        .    
-0000ef70: 2020 2020 2320 6d6f 7665 206d 616e 6970      # move manip
-0000ef80: 756c 6174 6f72 0a20 2020 2020 2020 2073  ulator.        s
-0000ef90: 656c 662e 6d6f 7665 5f6d 616e 6970 756c  elf.move_manipul
-0000efa0: 6174 6f72 5f72 656c 6174 6976 6528 6d61  ator_relative(ma
-0000efb0: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
-0000efc0: 6f6e 290a 0a20 2020 2020 2020 2072 6574  on)..        ret
-0000efd0: 7572 6e20 7365 6c66 2e67 6574 5f6d 616e  urn self.get_man
-0000efe0: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
-0000eff0: 6e28 290a 2020 2020 0a20 2020 2064 6566  n().    .    def
-0000f000: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
-0000f010: 725f 746f 5f70 6f73 6974 696f 6e5f 6f66  r_to_position_of
-0000f020: 6673 6574 2873 656c 662c 206f 6666 7365  fset(self, offse
-0000f030: 743a 2046 6962 7365 6d4d 616e 6970 756c  t: FibsemManipul
-0000f040: 6174 6f72 506f 7369 7469 6f6e 2c20 6e61  atorPosition, na
-0000f050: 6d65 3a20 7374 7220 3d20 4e6f 6e65 2920  me: str = None) 
-0000f060: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0000f070: 2022 2222 4d6f 7665 2074 6865 206d 616e   """Move the man
-0000f080: 6970 756c 6174 6f72 2074 6f20 7468 6520  ipulator to the 
-0000f090: 7370 6563 6966 6965 6420 636f 6f72 6469  specified coordi
-0000f0a0: 6e61 7465 732c 206f 6666 7365 7420 6279  nates, offset by
-0000f0b0: 2074 6865 2070 726f 7669 6465 6420 6f66   the provided of
-0000f0c0: 6673 6574 2e22 2222 0a20 2020 2020 2020  fset.""".       
-0000f0d0: 205f 6368 6563 6b5f 6d61 6e69 7075 6c61   _check_manipula
-0000f0e0: 746f 725f 6d6f 7665 6d65 6e74 2873 656c  tor_movement(sel
-0000f0f0: 662e 7379 7374 656d 2c20 6f66 6673 6574  f.system, offset
-0000f100: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-0000f110: 2020 2073 6176 6564 5f70 6f73 6974 696f     saved_positio
-0000f120: 6e20 3d20 7365 6c66 2e5f 6765 745f 7361  n = self._get_sa
-0000f130: 7665 645f 6d61 6e69 7075 6c61 746f 725f  ved_manipulator_
-0000f140: 706f 7369 7469 6f6e 286e 616d 6529 0a0a  position(name)..
-0000f150: 2020 2020 2020 2020 2320 6361 6c63 756c          # calcul
-0000f160: 6174 6520 636f 7272 6563 7465 6420 6d61  ate corrected ma
-0000f170: 6e69 7075 6c61 746f 7220 6d6f 7665 6d65  nipulator moveme
-0000f180: 6e74 0a20 2020 2020 2020 2073 7461 6765  nt.        stage
-0000f190: 5f74 696c 7420 3d20 7365 6c66 2e67 6574  _tilt = self.get
-0000f1a0: 5f73 7461 6765 5f70 6f73 6974 696f 6e28  _stage_position(
-0000f1b0: 292e 740a 2020 2020 2020 2020 797a 5f6d  ).t.        yz_m
-0000f1c0: 6f76 6520 3d20 7365 6c66 2e5f 7a5f 636f  ove = self._z_co
-0000f1d0: 7272 6563 7465 645f 6e65 6564 6c65 5f6d  rrected_needle_m
-0000f1e0: 6f76 656d 656e 7428 6f66 6673 6574 2e7a  ovement(offset.z
-0000f1f0: 2c20 7374 6167 655f 7469 6c74 290a 0a20  , stage_tilt).. 
-0000f200: 2020 2020 2020 2023 2061 646a 7573 7420         # adjust 
-0000f210: 666f 7220 6f66 6673 6574 0a20 2020 2020  for offset.     
-0000f220: 2020 2073 6176 6564 5f70 6f73 6974 696f     saved_positio
-0000f230: 6e2e 7820 2b3d 206f 6666 7365 742e 780a  n.x += offset.x.
-0000f240: 2020 2020 2020 2020 7361 7665 645f 706f          saved_po
-0000f250: 7369 7469 6f6e 2e79 202b 3d20 797a 5f6d  sition.y += yz_m
-0000f260: 6f76 652e 7920 2b20 6f66 6673 6574 2e79  ove.y + offset.y
-0000f270: 0a20 2020 2020 2020 2073 6176 6564 5f70  .        saved_p
-0000f280: 6f73 6974 696f 6e2e 7a20 2b3d 2079 7a5f  osition.z += yz_
-0000f290: 6d6f 7665 2e7a 2020 2320 5241 572c 2075  move.z  # RAW, u
-0000f2a0: 7020 3d20 6e65 6761 7469 7665 2c20 5354  p = negative, ST
-0000f2b0: 4147 453a 2064 6f77 6e20 3d20 6e65 6761  AGE: down = nega
-0000f2c0: 7469 7665 0a20 2020 2020 2020 2073 6176  tive.        sav
-0000f2d0: 6564 5f70 6f73 6974 696f 6e2e 7220 3d20  ed_position.r = 
-0000f2e0: 4e6f 6e65 2020 2320 726f 7461 7469 6f6e  None  # rotation
-0000f2f0: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-0000f300: 640a 0a20 2020 2020 2020 206c 6f67 6769  d..        loggi
-0000f310: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
-0000f320: 2022 6d6f 7665 5f6d 616e 6970 756c 6174   "move_manipulat
-0000f330: 6f72 5f74 6f5f 706f 7369 7469 6f6e 5f6f  or_to_position_o
-0000f340: 6666 7365 7422 2c20 0a20 2020 2020 2020  ffset", .       
-0000f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f360: 226e 616d 6522 3a20 6e61 6d65 2c20 226f  "name": name, "o
-0000f370: 6666 7365 7422 3a20 6f66 6673 6574 2e74  ffset": offset.t
-0000f380: 6f5f 6469 6374 2829 2c20 0a20 2020 2020  o_dict(), .     
-0000f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3a0: 2020 2273 6176 6564 5f70 6f73 6974 696f    "saved_positio
-0000f3b0: 6e22 3a20 7361 7665 645f 706f 7369 7469  n": saved_positi
-0000f3c0: 6f6e 2e74 6f5f 6469 6374 2829 7d29 0a0a  on.to_dict()})..
-0000f3d0: 2020 2020 2020 2020 2320 6d6f 7665 206d          # move m
-0000f3e0: 616e 6970 756c 6174 6f72 2061 6273 6f6c  anipulator absol
-0000f3f0: 7574 650a 2020 2020 2020 2020 7365 6c66  ute.        self
-0000f400: 2e6d 6f76 655f 6d61 6e69 7075 6c61 746f  .move_manipulato
-0000f410: 725f 6162 736f 6c75 7465 2873 6176 6564  r_absolute(saved
-0000f420: 5f70 6f73 6974 696f 6e29 0a20 2020 2020  _position).     
-0000f430: 2020 200a 0a20 2020 2064 6566 205f 6765     ..    def _ge
-0000f440: 745f 7361 7665 645f 6d61 6e69 7075 6c61  t_saved_manipula
-0000f450: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
-0000f460: 662c 206e 616d 653a 2073 7472 203d 2022  f, name: str = "
-0000f470: 5041 524b 2229 202d 3e20 4669 6273 656d  PARK") -> Fibsem
-0000f480: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
-0000f490: 696f 6e3a 0a20 2020 2020 2020 200a 2020  ion:.        .  
-0000f4a0: 2020 2020 2020 6966 206e 616d 6520 6e6f        if name no
-0000f4b0: 7420 696e 205b 2250 4152 4b22 2c20 2245  t in ["PARK", "E
-0000f4c0: 5543 454e 5452 4943 225d 3a0a 2020 2020  UCENTRIC"]:.    
-0000f4d0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000f4e0: 6c75 6545 7272 6f72 2866 2273 6176 6564  lueError(f"saved
-0000f4f0: 2070 6f73 6974 696f 6e20 7b6e 616d 657d   position {name}
-0000f500: 206e 6f74 2073 7570 706f 7274 6564 2e22   not supported."
-0000f510: 290a 2020 2020 2020 2020 6966 2056 4552  ).        if VER
-0000f520: 5349 4f4e 203c 2034 2e37 3a0a 2020 2020  SION < 4.7:.    
-0000f530: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
-0000f540: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
-0000f550: 7228 224d 616e 6970 756c 6174 6f72 2073  r("Manipulator s
-0000f560: 6176 6564 2070 6f73 6974 696f 6e73 206e  aved positions n
-0000f570: 6f74 2073 7570 706f 7274 6564 2069 6e20  ot supported in 
-0000f580: 7468 6973 2076 6572 7369 6f6e 2e20 506c  this version. Pl
-0000f590: 6561 7365 2075 7067 7261 6465 2074 6f20  ease upgrade to 
-0000f5a0: 342e 3720 6f72 2068 6967 6865 7222 290a  4.7 or higher").
-0000f5b0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0000f5c0: 206e 616d 6564 5f70 6f73 6974 696f 6e20   named_position 
-0000f5d0: 3d20 4d61 6e69 7075 6c61 746f 7253 6176  = ManipulatorSav
-0000f5e0: 6564 506f 7369 7469 6f6e 2e50 4152 4b20  edPosition.PARK 
-0000f5f0: 6966 206e 616d 6520 3d3d 2022 5041 524b  if name == "PARK
-0000f600: 2220 656c 7365 204d 616e 6970 756c 6174  " else Manipulat
-0000f610: 6f72 5361 7665 6450 6f73 6974 696f 6e2e  orSavedPosition.
-0000f620: 4555 4345 4e54 5249 430a 2020 2020 2020  EUCENTRIC.      
-0000f630: 2020 6175 746f 7363 7269 7074 5f70 6f73    autoscript_pos
-0000f640: 6974 696f 6e20 3d20 7365 6c66 2e63 6f6e  ition = self.con
-0000f650: 6e65 6374 696f 6e2e 7370 6563 696d 656e  nection.specimen
-0000f660: 2e6d 616e 6970 756c 6174 6f72 2e67 6574  .manipulator.get
-0000f670: 5f73 6176 6564 5f70 6f73 6974 696f 6e28  _saved_position(
-0000f680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f690: 206e 616d 6564 5f70 6f73 6974 696f 6e2c   named_position,
-0000f6a0: 204d 616e 6970 756c 6174 6f72 436f 6f72   ManipulatorCoor
-0000f6b0: 6469 6e61 7465 5379 7374 656d 2e53 5441  dinateSystem.STA
-0000f6c0: 4745 2023 2054 4f44 4f3a 2077 6879 2069  GE # TODO: why i
-0000f6d0: 7320 7468 6973 2053 5441 4745 206e 6f74  s this STAGE not
-0000f6e0: 2052 4157 3f0a 2020 2020 2020 2020 2020   RAW?.          
-0000f6f0: 2020 290a 0a20 2020 2020 2020 2023 2063    )..        # c
-0000f700: 6f6e 7665 7274 2074 6f20 4669 6273 656d  onvert to Fibsem
-0000f710: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
-0000f720: 696f 6e0a 2020 2020 2020 2020 6d61 6e69  ion.        mani
-0000f730: 7075 6c61 746f 725f 706f 7369 7469 6f6e  pulator_position
-0000f740: 203d 2046 6962 7365 6d4d 616e 6970 756c   = FibsemManipul
-0000f750: 6174 6f72 506f 7369 7469 6f6e 2e66 726f  atorPosition.fro
-0000f760: 6d5f 6175 746f 7363 7269 7074 5f70 6f73  m_autoscript_pos
-0000f770: 6974 696f 6e28 6175 746f 7363 7269 7074  ition(autoscript
-0000f780: 5f70 6f73 6974 696f 6e29 2020 2020 2020  _position)      
-0000f790: 2020 0a20 2020 2020 2020 200a 2020 2020    .        .    
-0000f7a0: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
-0000f7b0: 6728 7b22 6d73 6722 3a20 2267 6574 5f73  g({"msg": "get_s
-0000f7c0: 6176 6564 5f6d 616e 6970 756c 6174 6f72  aved_manipulator
-0000f7d0: 5f70 6f73 6974 696f 6e22 2c20 226e 616d  _position", "nam
-0000f7e0: 6522 3a20 6e61 6d65 2c20 2270 6f73 6974  e": name, "posit
-0000f7f0: 696f 6e22 3a20 6d61 6e69 7075 6c61 746f  ion": manipulato
-0000f800: 725f 706f 7369 7469 6f6e 2e74 6f5f 6469  r_position.to_di
-0000f810: 6374 2829 7d29 0a0a 2020 2020 2020 2020  ct()})..        
-0000f820: 7265 7475 726e 206d 616e 6970 756c 6174  return manipulat
-0000f830: 6f72 5f70 6f73 6974 696f 6e20 0a0a 2020  or_position ..  
-0000f840: 2020 6465 6620 7365 7475 705f 6d69 6c6c    def setup_mill
-0000f850: 696e 6728 0a20 2020 2020 2020 2073 656c  ing(.        sel
-0000f860: 662c 0a20 2020 2020 2020 206d 696c 6c5f  f,.        mill_
-0000f870: 7365 7474 696e 6773 3a20 4669 6273 656d  settings: Fibsem
-0000f880: 4d69 6c6c 696e 6753 6574 7469 6e67 732c  MillingSettings,
-0000f890: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-0000f8a0: 2222 220a 2020 2020 2020 2020 436f 6e66  """.        Conf
-0000f8b0: 6967 7572 6520 7468 6520 6d69 6372 6f73  igure the micros
-0000f8c0: 636f 7065 2066 6f72 206d 696c 6c69 6e67  cope for milling
-0000f8d0: 2075 7369 6e67 2074 6865 2069 6f6e 2062   using the ion b
-0000f8e0: 6561 6d2e 0a0a 2020 2020 2020 2020 4172  eam...        Ar
-0000f8f0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-0000f900: 6d69 6c6c 5f73 6574 7469 6e67 7320 2846  mill_settings (F
-0000f910: 6962 7365 6d4d 696c 6c69 6e67 5365 7474  ibsemMillingSett
-0000f920: 696e 6773 293a 204d 696c 6c69 6e67 2073  ings): Milling s
-0000f930: 6574 7469 6e67 732e 0a20 2020 2020 2020  ettings..       
-0000f940: 2022 2222 0a20 2020 2020 2020 205f 6368   """.        _ch
-0000f950: 6563 6b5f 6265 616d 2842 6561 6d54 7970  eck_beam(BeamTyp
-0000f960: 652e 494f 4e2c 2073 656c 662e 7379 7374  e.ION, self.syst
-0000f970: 656d 290a 2020 2020 2020 2020 7365 6c66  em).        self
-0000f980: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
-0000f990: 696e 672e 7365 745f 6163 7469 7665 5f76  ing.set_active_v
-0000f9a0: 6965 7728 4265 616d 5479 7065 2e49 4f4e  iew(BeamType.ION
-0000f9b0: 2e76 616c 7565 2920 2023 2074 6865 2069  .value)  # the i
-0000f9c0: 6f6e 2062 6561 6d20 7669 6577 0a20 2020  on beam view.   
-0000f9d0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0000f9e0: 7469 6f6e 2e69 6d61 6769 6e67 2e73 6574  tion.imaging.set
-0000f9f0: 5f61 6374 6976 655f 6465 7669 6365 2842  _active_device(B
-0000fa00: 6561 6d54 7970 652e 494f 4e2e 7661 6c75  eamType.ION.valu
-0000fa10: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-0000fa20: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-0000fa30: 726e 696e 672e 7365 745f 6465 6661 756c  rning.set_defaul
-0000fa40: 745f 6265 616d 5f74 7970 6528 4265 616d  t_beam_type(Beam
-0000fa50: 5479 7065 2e49 4f4e 2e76 616c 7565 290a  Type.ION.value).
-0000fa60: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000fa70: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000fa80: 6e67 2e73 6574 5f64 6566 6175 6c74 5f61  ng.set_default_a
-0000fa90: 7070 6c69 6361 7469 6f6e 5f66 696c 6528  pplication_file(
-0000faa0: 6d69 6c6c 5f73 6574 7469 6e67 732e 6170  mill_settings.ap
-0000fab0: 706c 6963 6174 696f 6e5f 6669 6c65 290a  plication_file).
-0000fac0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0000fad0: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-0000fae0: 6e67 2e6d 6f64 6520 3d20 6d69 6c6c 5f73  ng.mode = mill_s
-0000faf0: 6574 7469 6e67 732e 7061 7474 6572 6e69  ettings.patterni
-0000fb00: 6e67 5f6d 6f64 650a 2020 2020 2020 2020  ng_mode.        
-0000fb10: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0000fb20: 7061 7474 6572 6e69 6e67 2e63 6c65 6172  patterning.clear
-0000fb30: 5f70 6174 7465 726e 7328 2920 2023 2063  _patterns()  # c
-0000fb40: 6c65 6172 2061 6e79 2065 7869 7374 696e  lear any existin
-0000fb50: 6720 7061 7474 6572 6e73 0a20 2020 2020  g patterns.     
-0000fb60: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0000fb70: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
-0000fb80: 6d2e 686f 7269 7a6f 6e74 616c 5f66 6965  m.horizontal_fie
-0000fb90: 6c64 5f77 6964 7468 2e76 616c 7565 203d  ld_width.value =
-0000fba0: 206d 696c 6c5f 7365 7474 696e 6773 2e68   mill_settings.h
-0000fbb0: 6677 0a0a 2020 2020 2020 2020 2320 7365  fw..        # se
-0000fbc0: 6c66 2e73 6574 2822 6866 7722 2c20 6d69  lf.set("hfw", mi
-0000fbd0: 6c6c 5f73 6574 7469 6e67 732e 6866 772c  ll_settings.hfw,
-0000fbe0: 2042 6561 6d54 7970 652e 494f 4e29 2023   BeamType.ION) #
-0000fbf0: 2054 4f44 4f3a 2072 6570 6c61 6365 0a20   TODO: replace. 
-0000fc00: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
-0000fc10: 2263 7572 7265 6e74 222c 206d 696c 6c5f  "current", mill_
-0000fc20: 7365 7474 696e 6773 2e6d 696c 6c69 6e67  settings.milling
-0000fc30: 5f63 7572 7265 6e74 2c20 4265 616d 5479  _current, BeamTy
-0000fc40: 7065 2e49 4f4e 290a 2020 2020 2020 2020  pe.ION).        
-0000fc50: 7365 6c66 2e73 6574 2822 766f 6c74 6167  self.set("voltag
-0000fc60: 6522 2c20 6d69 6c6c 5f73 6574 7469 6e67  e", mill_setting
-0000fc70: 732e 6d69 6c6c 696e 675f 766f 6c74 6167  s.milling_voltag
-0000fc80: 652c 2042 6561 6d54 7970 652e 494f 4e29  e, BeamType.ION)
-0000fc90: 0a20 2020 200a 2020 2020 2020 2020 6c6f  .    .        lo
-0000fca0: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
-0000fcb0: 6722 3a20 2273 6574 7570 5f6d 696c 6c69  g": "setup_milli
-0000fcc0: 6e67 222c 2022 6d69 6c6c 5f73 6574 7469  ng", "mill_setti
-0000fcd0: 6e67 7322 3a20 6d69 6c6c 5f73 6574 7469  ngs": mill_setti
-0000fce0: 6e67 732e 746f 5f64 6963 7428 297d 290a  ngs.to_dict()}).
-0000fcf0: 0a20 2020 2064 6566 2072 756e 5f6d 696c  .    def run_mil
-0000fd00: 6c69 6e67 2873 656c 662c 206d 696c 6c69  ling(self, milli
-0000fd10: 6e67 5f63 7572 7265 6e74 3a20 666c 6f61  ng_current: floa
-0000fd20: 742c 206d 696c 6c69 6e67 5f76 6f6c 7461  t, milling_volta
-0000fd30: 6765 3a20 666c 6f61 742c 2061 7379 6e63  ge: float, async
-0000fd40: 683a 2062 6f6f 6c20 3d20 4661 6c73 6529  h: bool = False)
-0000fd50: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0000fd60: 2020 2020 2020 5275 6e20 696f 6e20 6265        Run ion be
-0000fd70: 616d 206d 696c 6c69 6e67 2075 7369 6e67  am milling using
-0000fd80: 2074 6865 2073 7065 6369 6669 6564 206d   the specified m
-0000fd90: 696c 6c69 6e67 2063 7572 7265 6e74 2e0a  illing current..
-0000fda0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-0000fdb0: 2020 2020 2020 2020 2020 206d 696c 6c69             milli
-0000fdc0: 6e67 5f63 7572 7265 6e74 2028 666c 6f61  ng_current (floa
-0000fdd0: 7429 3a20 5468 6520 6375 7272 656e 7420  t): The current 
-0000fde0: 746f 2075 7365 2066 6f72 206d 696c 6c69  to use for milli
-0000fdf0: 6e67 2069 6e20 616d 7073 2e0a 2020 2020  ng in amps..    
-0000fe00: 2020 2020 2020 2020 6173 796e 6368 2028          asynch (
-0000fe10: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
-0000fe20: 2049 6620 5472 7565 2c20 7468 6520 6d69   If True, the mi
-0000fe30: 6c6c 696e 6720 7769 6c6c 2062 6520 7275  lling will be ru
-0000fe40: 6e20 6173 796e 6368 726f 6e6f 7573 6c79  n asynchronously
-0000fe50: 2e20 0a20 2020 2020 2020 2020 2020 2020  . .             
-0000fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe70: 2020 2020 2020 2020 4465 6661 756c 7473          Defaults
-0000fe80: 2074 6f20 4661 6c73 652c 2069 6e20 7768   to False, in wh
-0000fe90: 6963 6820 6361 7365 2069 7420 7769 6c6c  ich case it will
-0000fea0: 2072 756e 2073 796e 6368 726f 6e6f 7573   run synchronous
-0000feb0: 6c79 2e0a 0a20 2020 2020 2020 2022 2222  ly...        """
-0000fec0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0000fed0: 7365 6c66 2e69 735f 6176 6169 6c61 626c  self.is_availabl
-0000fee0: 6528 2269 6f6e 5f62 6561 6d22 293a 0a20  e("ion_beam"):. 
-0000fef0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000ff00: 2056 616c 7565 4572 726f 7228 2249 6f6e   ValueError("Ion
-0000ff10: 2062 6561 6d20 6e6f 7420 6176 6169 6c61   beam not availa
-0000ff20: 626c 652e 2229 0a20 2020 2020 2020 200a  ble.").        .
-0000ff30: 2020 2020 2020 2020 2320 6368 616e 6765          # change
-0000ff40: 2074 6f20 6d69 6c6c 696e 6720 6375 7272   to milling curr
-0000ff50: 656e 742c 2076 6f6c 7461 6765 0a20 2020  ent, voltage.   
-0000ff60: 2020 2020 2069 6620 7365 6c66 2e67 6574       if self.get
-0000ff70: 2822 766f 6c74 6167 6522 2c20 4265 616d  ("voltage", Beam
-0000ff80: 5479 7065 2e49 4f4e 2920 213d 206d 696c  Type.ION) != mil
-0000ff90: 6c69 6e67 5f76 6f6c 7461 6765 3a0a 2020  ling_voltage:.  
-0000ffa0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0000ffb0: 6574 2822 766f 6c74 6167 6522 2c20 6d69  et("voltage", mi
-0000ffc0: 6c6c 696e 675f 766f 6c74 6167 652c 2042  lling_voltage, B
-0000ffd0: 6561 6d54 7970 652e 494f 4e29 0a20 2020  eamType.ION).   
-0000ffe0: 2020 2020 2069 6620 7365 6c66 2e67 6574       if self.get
-0000fff0: 2822 6375 7272 656e 7422 2c20 4265 616d  ("current", Beam
-00010000: 5479 7065 2e49 4f4e 2920 213d 206d 696c  Type.ION) != mil
-00010010: 6c69 6e67 5f63 7572 7265 6e74 3a0a 2020  ling_current:.  
-00010020: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00010030: 6574 2822 6375 7272 656e 7422 2c20 6d69  et("current", mi
-00010040: 6c6c 696e 675f 6375 7272 656e 742c 2042  lling_current, B
-00010050: 6561 6d54 7970 652e 494f 4e29 0a0a 2020  eamType.ION)..  
-00010060: 2020 2020 2020 2320 7275 6e20 6d69 6c6c        # run mill
-00010070: 696e 6720 2861 7379 6e63 6872 6f6e 6f75  ing (asynchronou
-00010080: 736c 7929 0a20 2020 2020 2020 2073 656c  sly).        sel
-00010090: 662e 636f 6e6e 6563 7469 6f6e 2e69 6d61  f.connection.ima
-000100a0: 6769 6e67 2e73 6574 5f61 6374 6976 655f  ging.set_active_
-000100b0: 7669 6577 2842 6561 6d54 7970 652e 494f  view(BeamType.IO
-000100c0: 4e2e 7661 6c75 6529 2020 2320 7468 6520  N.value)  # the 
-000100d0: 696f 6e20 6265 616d 2076 6965 770a 2020  ion beam view.  
-000100e0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-000100f0: 666f 2866 2272 756e 6e69 6e67 2069 6f6e  fo(f"running ion
-00010100: 2062 6561 6d20 6d69 6c6c 696e 6720 6e6f   beam milling no
-00010110: 772e 2e2e 2061 7379 6e63 6872 6f6e 6f75  w... asynchronou
-00010120: 733d 7b61 7379 6e63 687d 2229 0a20 2020  s={asynch}").   
-00010130: 2020 2020 2069 6620 6173 796e 6368 3a0a       if asynch:.
-00010140: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00010150: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
-00010160: 6572 6e69 6e67 2e73 7461 7274 2829 0a20  erning.start(). 
-00010170: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00010180: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00010190: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-000101a0: 696e 672e 7275 6e28 290a 2020 2020 2020  ing.run().      
-000101b0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-000101c0: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
-000101d0: 2e63 6c65 6172 5f70 6174 7465 726e 7328  .clear_patterns(
-000101e0: 290a 2020 2020 2020 2020 2320 4e4f 5445  ).        # NOTE
-000101f0: 3a20 4d61 6b65 2074 6573 6361 6e20 6c6f  : Make tescan lo
-00010200: 6773 2074 6865 2073 616d 653f 3f0a 2020  gs the same??.  
-00010210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010230: 2020 0a20 2020 2020 2020 206c 6f67 6769    .        loggi
-00010240: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
-00010250: 2022 7275 6e5f 6d69 6c6c 696e 6722 2c20   "run_milling", 
-00010260: 226d 696c 6c69 6e67 5f63 7572 7265 6e74  "milling_current
-00010270: 223a 206d 696c 6c69 6e67 5f63 7572 7265  ": milling_curre
-00010280: 6e74 2c20 226d 696c 6c69 6e67 5f76 6f6c  nt, "milling_vol
-00010290: 7461 6765 223a 206d 696c 6c69 6e67 5f76  tage": milling_v
-000102a0: 6f6c 7461 6765 2c20 2261 7379 6e63 6822  oltage, "asynch"
-000102b0: 3a20 6173 796e 6368 7d29 0a0a 2020 2020  : asynch})..    
-000102c0: 6465 6620 7275 6e5f 6d69 6c6c 696e 675f  def run_milling_
-000102d0: 6472 6966 745f 636f 7272 6563 7465 6428  drift_corrected(
-000102e0: 7365 6c66 2c20 6d69 6c6c 696e 675f 6375  self, milling_cu
-000102f0: 7272 656e 743a 2066 6c6f 6174 2c20 0a20  rrent: float, . 
-00010300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010320: 2020 206d 696c 6c69 6e67 5f76 6f6c 7461     milling_volta
-00010330: 6765 3a20 666c 6f61 742c 2020 0a20 2020  ge: float,  .   
-00010340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010360: 2069 6d61 6765 5f73 6574 7469 6e67 733a   image_settings:
-00010370: 2049 6d61 6765 5365 7474 696e 6773 2c20   ImageSettings, 
-00010380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103a0: 2020 2020 2072 6566 5f69 6d61 6765 3a20       ref_image: 
-000103b0: 4669 6273 656d 496d 6167 652c 200a 2020  FibsemImage, .  
-000103c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103e0: 2020 7265 6475 6365 645f 6172 6561 3a20    reduced_area: 
-000103f0: 4669 6273 656d 5265 6374 616e 676c 6520  FibsemRectangle 
-00010400: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00010410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010420: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-00010430: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00010440: 2020 2052 756e 2069 6f6e 2062 6561 6d20     Run ion beam 
-00010450: 6d69 6c6c 696e 6720 7573 696e 6720 7468  milling using th
-00010460: 6520 7370 6563 6966 6965 6420 6d69 6c6c  e specified mill
-00010470: 696e 6720 6375 7272 656e 742e 0a0a 2020  ing current...  
-00010480: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-00010490: 2020 2020 2020 2020 6d69 6c6c 696e 675f          milling_
-000104a0: 6375 7272 656e 7420 2866 6c6f 6174 293a  current (float):
-000104b0: 2054 6865 2063 7572 7265 6e74 2074 6f20   The current to 
-000104c0: 7573 6520 666f 7220 6d69 6c6c 696e 6720  use for milling 
-000104d0: 696e 2061 6d70 732e 0a20 2020 2020 2020  in amps..       
-000104e0: 2020 2020 2061 7379 6e63 6820 2862 6f6f       asynch (boo
-000104f0: 6c2c 206f 7074 696f 6e61 6c29 3a20 4966  l, optional): If
-00010500: 2054 7275 652c 2074 6865 206d 696c 6c69   True, the milli
-00010510: 6e67 2077 696c 6c20 6265 2072 756e 2061  ng will be run a
-00010520: 7379 6e63 6872 6f6e 6f75 736c 792e 200a  synchronously. .
-00010530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010550: 2020 2020 2044 6566 6175 6c74 7320 746f       Defaults to
-00010560: 2046 616c 7365 2c20 696e 2077 6869 6368   False, in which
-00010570: 2063 6173 6520 6974 2077 696c 6c20 7275   case it will ru
-00010580: 6e20 7379 6e63 6872 6f6e 6f75 736c 792e  n synchronously.
-00010590: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-000105a0: 733a 0a20 2020 2020 2020 2020 2020 204e  s:.            N
-000105b0: 6f6e 650a 0a20 2020 2020 2020 2052 6169  one..        Rai
-000105c0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
-000105d0: 204e 6f6e 650a 2020 2020 2020 2020 2222   None.        ""
-000105e0: 220a 2020 2020 2020 2020 5f63 6865 636b  ".        _check
-000105f0: 5f62 6561 6d28 4265 616d 5479 7065 2e49  _beam(BeamType.I
-00010600: 4f4e 2c20 7365 6c66 2e73 7973 7465 6d29  ON, self.system)
-00010610: 0a20 2020 2020 2020 2023 2063 6861 6e67  .        # chang
-00010620: 6520 746f 206d 696c 6c69 6e67 2063 7572  e to milling cur
-00010630: 7265 6e74 0a20 2020 2020 2020 2073 656c  rent.        sel
-00010640: 662e 636f 6e6e 6563 7469 6f6e 2e69 6d61  f.connection.ima
-00010650: 6769 6e67 2e73 6574 5f61 6374 6976 655f  ging.set_active_
-00010660: 7669 6577 2842 6561 6d54 7970 652e 494f  view(BeamType.IO
-00010670: 4e2e 7661 6c75 6529 2020 2320 7468 6520  N.value)  # the 
-00010680: 696f 6e20 6265 616d 2076 6965 770a 2020  ion beam view.  
-00010690: 2020 2020 2020 6966 2073 656c 662e 6765        if self.ge
-000106a0: 7428 2276 6f6c 7461 6765 222c 2042 6561  t("voltage", Bea
-000106b0: 6d54 7970 652e 494f 4e29 2021 3d20 6d69  mType.ION) != mi
-000106c0: 6c6c 696e 675f 766f 6c74 6167 653a 0a20  lling_voltage:. 
-000106d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000106e0: 7365 7428 2276 6f6c 7461 6765 222c 206d  set("voltage", m
-000106f0: 696c 6c69 6e67 5f76 6f6c 7461 6765 2c20  illing_voltage, 
-00010700: 4265 616d 5479 7065 2e49 4f4e 290a 2020  BeamType.ION).  
-00010710: 2020 2020 2020 6966 2073 656c 662e 6765        if self.ge
-00010720: 7428 2263 7572 7265 6e74 222c 2042 6561  t("current", Bea
-00010730: 6d54 7970 652e 494f 4e29 2021 3d20 6d69  mType.ION) != mi
-00010740: 6c6c 696e 675f 6375 7272 656e 743a 0a20  lling_current:. 
-00010750: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00010760: 7365 7428 2263 7572 7265 6e74 222c 206d  set("current", m
-00010770: 696c 6c69 6e67 5f63 7572 7265 6e74 2c20  illing_current, 
-00010780: 4265 616d 5479 7065 2e49 4f4e 290a 0a0a  BeamType.ION)...
-00010790: 2020 2020 2020 2020 2320 7275 6e20 6d69          # run mi
-000107a0: 6c6c 696e 6720 2861 7379 6e63 6872 6f6e  lling (asynchron
-000107b0: 6f75 736c 7929 0a20 2020 2020 2020 206c  ously).        l
-000107c0: 6f67 6769 6e67 2e69 6e66 6f28 6622 7275  ogging.info(f"ru
-000107d0: 6e6e 696e 6720 696f 6e20 6265 616d 206d  nning ion beam m
-000107e0: 696c 6c69 6e67 206e 6f77 2e22 290a 0a20  illing now.").. 
-000107f0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00010800: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-00010810: 672e 7374 6172 7428 290a 2020 2020 2020  g.start().      
-00010820: 2020 2320 4e4f 5445 3a20 4d61 6b65 2074    # NOTE: Make t
-00010830: 6573 6361 6e20 6c6f 6773 2074 6865 2073  escan logs the s
-00010840: 616d 653f 3f0a 2020 2020 2020 2020 6672  ame??.        fr
-00010850: 6f6d 2066 6962 7365 6d20 696d 706f 7274  om fibsem import
-00010860: 2061 6c69 676e 6d65 6e74 0a20 2020 2020   alignment.     
-00010870: 2020 2077 6869 6c65 2073 656c 662e 636f     while self.co
-00010880: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-00010890: 696e 672e 7374 6174 6520 3d3d 2050 6174  ing.state == Pat
-000108a0: 7465 726e 696e 6753 7461 7465 2e49 444c  terningState.IDL
-000108b0: 453a 2023 2067 6976 696e 6720 7469 6d65  E: # giving time
-000108c0: 2074 6f20 7374 6172 7420 0a20 2020 2020   to start .     
-000108d0: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-000108e0: 7028 302e 3529 0a20 2020 2020 2020 2077  p(0.5).        w
-000108f0: 6869 6c65 2073 656c 662e 636f 6e6e 6563  hile self.connec
-00010900: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
-00010910: 7374 6174 6520 3d3d 2050 6174 7465 726e  state == Pattern
-00010920: 696e 6753 7461 7465 2e52 554e 4e49 4e47  ingState.RUNNING
-00010930: 3a0a 0a20 2020 2020 2020 2020 2020 2073  :..            s
-00010940: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-00010950: 6174 7465 726e 696e 672e 7061 7573 6528  atterning.pause(
-00010960: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-00010970: 6767 696e 672e 696e 666f 2822 4472 6966  gging.info("Drif
-00010980: 7420 636f 7272 6563 7469 6f6e 2229 0a20  t correction"). 
-00010990: 2020 2020 2020 2020 2020 2061 6c69 676e             align
-000109a0: 6d65 6e74 2e62 6561 6d5f 7368 6966 745f  ment.beam_shift_
-000109b0: 616c 6967 6e6d 656e 745f 7632 286d 6963  alignment_v2(mic
-000109c0: 726f 7363 6f70 6520 3d20 7365 6c66 2c20  roscope = self, 
-000109d0: 7265 665f 696d 6167 653d 7265 665f 696d  ref_image=ref_im
-000109e0: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
-000109f0: 2074 696d 652e 736c 6565 7028 3129 2023   time.sleep(1) #
-00010a00: 206e 6565 6420 6465 6c61 7920 746f 2073   need delay to s
-00010a10: 7769 7463 6820 6261 636b 2074 6f20 7061  witch back to pa
-00010a20: 7474 6572 6e69 6e67 206d 6f64 6520 0a20  tterning mode . 
-00010a30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00010a40: 636f 6e6e 6563 7469 6f6e 2e69 6d61 6769  connection.imagi
-00010a50: 6e67 2e73 6574 5f61 6374 6976 655f 7669  ng.set_active_vi
-00010a60: 6577 2842 6561 6d54 7970 652e 494f 4e2e  ew(BeamType.ION.
-00010a70: 7661 6c75 6529 0a20 2020 2020 2020 2020  value).         
-00010a80: 2020 2069 6620 7365 6c66 2e63 6f6e 6e65     if self.conne
-00010a90: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
-00010aa0: 2e73 7461 7465 203d 3d20 5061 7474 6572  .state == Patter
-00010ab0: 6e69 6e67 5374 6174 652e 5041 5553 4544  ningState.PAUSED
-00010ac0: 3a20 2320 6368 6563 6b20 6966 2066 696e  : # check if fin
-00010ad0: 6973 6865 6420 0a20 2020 2020 2020 2020  ished .         
-00010ae0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00010af0: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-00010b00: 672e 7265 7375 6d65 2829 0a20 2020 2020  g.resume().     
-00010b10: 2020 2020 2020 2020 2020 2074 696d 652e             time.
-00010b20: 736c 6565 7028 3529 0a20 2020 2020 2020  sleep(5).       
-00010b30: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-00010b40: 6f28 6622 5061 7474 6572 6e69 6e67 2053  o(f"Patterning S
-00010b50: 7461 7465 3a20 7b73 656c 662e 636f 6e6e  tate: {self.conn
-00010b60: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-00010b70: 672e 7374 6174 657d 2229 0a0a 0a20 2020  g.state}")...   
-00010b80: 2064 6566 2066 696e 6973 685f 6d69 6c6c   def finish_mill
-00010b90: 696e 6728 7365 6c66 2c20 696d 6167 696e  ing(self, imagin
-00010ba0: 675f 6375 7272 656e 743a 2066 6c6f 6174  g_current: float
-00010bb0: 2c20 696d 6167 696e 675f 766f 6c74 6167  , imaging_voltag
-00010bc0: 653a 2066 6c6f 6174 293a 0a20 2020 2020  e: float):.     
-00010bd0: 2020 2022 2222 0a20 2020 2020 2020 2046     """.        F
-00010be0: 696e 616c 6973 6573 2074 6865 206d 696c  inalises the mil
-00010bf0: 6c69 6e67 2070 726f 6365 7373 2062 7920  ling process by 
-00010c00: 636c 6561 7269 6e67 2074 6865 206d 6963  clearing the mic
-00010c10: 726f 7363 6f70 6520 6f66 2061 6e79 2070  roscope of any p
-00010c20: 6174 7465 726e 7320 616e 6420 7265 7475  atterns and retu
-00010c30: 726e 696e 6720 7468 6520 6375 7272 656e  rning the curren
-00010c40: 7420 746f 2074 6865 2069 6d61 6769 6e67  t to the imaging
-00010c50: 2063 7572 7265 6e74 2e0a 0a20 2020 2020   current...     
-00010c60: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00010c70: 2020 2020 2069 6d61 6769 6e67 5f63 7572       imaging_cur
-00010c80: 7265 6e74 2028 666c 6f61 7429 3a20 5468  rent (float): Th
-00010c90: 6520 6375 7272 656e 7420 746f 2075 7365  e current to use
-00010ca0: 2066 6f72 2069 6d61 6769 6e67 2069 6e20   for imaging in 
-00010cb0: 616d 7073 2e0a 2020 2020 2020 2020 2222  amps..        ""
-00010cc0: 220a 2020 2020 2020 2020 5f63 6865 636b  ".        _check
-00010cd0: 5f62 6561 6d28 4265 616d 5479 7065 2e49  _beam(BeamType.I
-00010ce0: 4f4e 2c20 7365 6c66 2e73 7973 7465 6d29  ON, self.system)
-00010cf0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-00010d00: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-00010d10: 696e 672e 636c 6561 725f 7061 7474 6572  ing.clear_patter
-00010d20: 6e73 2829 0a20 2020 2020 2020 2073 656c  ns().        sel
-00010d30: 662e 7365 7428 2263 7572 7265 6e74 222c  f.set("current",
-00010d40: 2069 6d61 6769 6e67 5f63 7572 7265 6e74   imaging_current
-00010d50: 2c20 4265 616d 5479 7065 2e49 4f4e 290a  , BeamType.ION).
-00010d60: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
-00010d70: 2822 766f 6c74 6167 6522 2c20 696d 6167  ("voltage", imag
-00010d80: 696e 675f 766f 6c74 6167 652c 2042 6561  ing_voltage, Bea
-00010d90: 6d54 7970 652e 494f 4e29 0a20 2020 2020  mType.ION).     
-00010da0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00010db0: 6f6e 2e70 6174 7465 726e 696e 672e 6d6f  on.patterning.mo
-00010dc0: 6465 203d 2022 5365 7269 616c 220a 0a20  de = "Serial".. 
-00010dd0: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
-00010de0: 6562 7567 287b 226d 7367 223a 2022 6669  ebug({"msg": "fi
-00010df0: 6e69 7368 5f6d 696c 6c69 6e67 222c 2022  nish_milling", "
-00010e00: 696d 6167 696e 675f 6375 7272 656e 7422  imaging_current"
-00010e10: 3a20 696d 6167 696e 675f 6375 7272 656e  : imaging_curren
-00010e20: 742c 2022 696d 6167 696e 675f 766f 6c74  t, "imaging_volt
-00010e30: 6167 6522 3a20 696d 6167 696e 675f 766f  age": imaging_vo
-00010e40: 6c74 6167 657d 290a 0a20 2020 2064 6566  ltage})..    def
-00010e50: 2065 7374 696d 6174 655f 6d69 6c6c 696e   estimate_millin
-00010e60: 675f 7469 6d65 2873 656c 662c 2070 6174  g_time(self, pat
-00010e70: 7465 726e 733a 206c 6973 7420 2920 2d3e  terns: list ) ->
-00010e80: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
-00010e90: 2222 2243 616c 6375 6c61 7465 7320 7468  """Calculates th
-00010ea0: 6520 6573 7469 6d61 7465 6420 6d69 6c6c  e estimated mill
-00010eb0: 696e 6720 7469 6d65 2066 6f72 2061 206c  ing time for a l
-00010ec0: 6973 7420 6f66 2070 6174 7465 726e 732e  ist of patterns.
-00010ed0: 2222 220a 0a20 2020 2020 2020 2074 6f74  """..        tot
-00010ee0: 616c 5f74 696d 6520 3d20 300a 2020 2020  al_time = 0.    
-00010ef0: 2020 2020 666f 7220 7061 7474 6572 6e20      for pattern 
-00010f00: 696e 2070 6174 7465 726e 733a 0a20 2020  in patterns:.   
-00010f10: 2020 2020 2020 2020 2074 6f74 616c 5f74           total_t
-00010f20: 696d 6520 2b3d 2070 6174 7465 726e 2e74  ime += pattern.t
-00010f30: 696d 650a 0a20 2020 2020 2020 2072 6574  ime..        ret
-00010f40: 7572 6e20 746f 7461 6c5f 7469 6d65 0a0a  urn total_time..
-00010f50: 2020 2020 6465 6620 6472 6177 5f72 6563      def draw_rec
-00010f60: 7461 6e67 6c65 280a 2020 2020 2020 2020  tangle(.        
-00010f70: 7365 6c66 2c0a 2020 2020 2020 2020 7061  self,.        pa
-00010f80: 7474 6572 6e5f 7365 7474 696e 6773 3a20  ttern_settings: 
-00010f90: 4669 6273 656d 5265 6374 616e 676c 6553  FibsemRectangleS
-00010fa0: 6574 7469 6e67 732c 0a20 2020 2029 3a0a  ettings,.    ):.
-00010fb0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00010fc0: 2020 2020 4472 6177 7320 6120 7265 6374      Draws a rect
-00010fd0: 616e 676c 6520 7061 7474 6572 6e20 7573  angle pattern us
-00010fe0: 696e 6720 7468 6520 6375 7272 656e 7420  ing the current 
-00010ff0: 696f 6e20 6265 616d 2e0a 0a20 2020 2020  ion beam...     
-00011000: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00011010: 2020 2020 2070 6174 7465 726e 5f73 6574       pattern_set
-00011020: 7469 6e67 7320 2846 6962 7365 6d52 6563  tings (FibsemRec
-00011030: 7461 6e67 6c65 5365 7474 696e 6773 293a  tangleSettings):
-00011040: 2074 6865 2073 6574 7469 6e67 7320 666f   the settings fo
-00011050: 7220 7468 6520 7061 7474 6572 6e20 746f  r the pattern to
-00011060: 2064 7261 772e 0a0a 2020 2020 2020 2020   draw...        
-00011070: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00011080: 2020 2020 2050 6174 7465 726e 3a20 7468       Pattern: th
-00011090: 6520 6372 6561 7465 6420 7061 7474 6572  e created patter
-000110a0: 6e2e 0a0a 2020 2020 2020 2020 5261 6973  n...        Rais
-000110b0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000110c0: 4175 746f 7363 7269 7074 4572 726f 723a  AutoscriptError:
-000110d0: 2069 6620 616e 2065 7272 6f72 206f 6363   if an error occ
-000110e0: 7572 7320 7768 696c 6520 6372 6561 7469  urs while creati
-000110f0: 6e67 2074 6865 2070 6174 7465 726e 2e0a  ng the pattern..
-00011100: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00011110: 2020 2020 0a20 2020 2020 2020 2023 2067      .        # g
-00011120: 6574 2070 6174 7465 726e 696e 6720 6170  et patterning ap
-00011130: 690a 2020 2020 2020 2020 2320 7061 7474  i.        # patt
-00011140: 6572 6e69 6e67 5f61 7069 203d 2073 656c  erning_api = sel
-00011150: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
-00011160: 7465 726e 696e 670a 2020 2020 2020 2020  terning.        
-00011170: 2320 6372 6561 7465 5f70 6174 7465 726e  # create_pattern
-00011180: 5f66 756e 6374 696f 6e20 3d20 7061 7474  _function = patt
-00011190: 6572 6e69 6e67 5f61 7069 2e63 7265 6174  erning_api.creat
-000111a0: 655f 636c 6561 6e69 6e67 5f63 726f 7373  e_cleaning_cross
-000111b0: 5f73 6563 7469 6f6e 2069 6620 7061 7474  _section if patt
-000111c0: 6572 6e5f 7365 7474 696e 6773 2e63 6c65  ern_settings.cle
-000111d0: 616e 696e 675f 6372 6f73 735f 7365 6374  aning_cross_sect
-000111e0: 696f 6e20 656c 7365 2070 6174 7465 726e  ion else pattern
-000111f0: 696e 675f 6170 692e 6372 6561 7465 5f72  ing_api.create_r
-00011200: 6563 7461 6e67 6c65 0a0a 2020 2020 2020  ectangle..      
-00011210: 2020 7061 7474 6572 6e69 6e67 5f61 7069    patterning_api
-00011220: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-00011230: 6f6e 2e70 6174 7465 726e 696e 670a 2020  on.patterning.  
-00011240: 2020 2020 2020 6966 2070 6174 7465 726e        if pattern
-00011250: 5f73 6574 7469 6e67 732e 6372 6f73 735f  _settings.cross_
-00011260: 7365 6374 696f 6e20 6973 2043 726f 7373  section is Cross
-00011270: 5365 6374 696f 6e50 6174 7465 726e 2e52  SectionPattern.R
-00011280: 6567 756c 6172 4372 6f73 7353 6563 7469  egularCrossSecti
-00011290: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-000112a0: 6372 6561 7465 5f70 6174 7465 726e 5f66  create_pattern_f
-000112b0: 756e 6374 696f 6e20 3d20 7061 7474 6572  unction = patter
-000112c0: 6e69 6e67 5f61 7069 2e63 7265 6174 655f  ning_api.create_
-000112d0: 7265 6775 6c61 725f 6372 6f73 735f 7365  regular_cross_se
-000112e0: 6374 696f 6e0a 2020 2020 2020 2020 656c  ction.        el
-000112f0: 6966 2070 6174 7465 726e 5f73 6574 7469  if pattern_setti
-00011300: 6e67 732e 6372 6f73 735f 7365 6374 696f  ngs.cross_sectio
-00011310: 6e20 6973 2043 726f 7373 5365 6374 696f  n is CrossSectio
-00011320: 6e50 6174 7465 726e 2e43 6c65 616e 696e  nPattern.Cleanin
-00011330: 6743 726f 7373 5365 6374 696f 6e3a 0a20  gCrossSection:. 
-00011340: 2020 2020 2020 2020 2020 2063 7265 6174             creat
-00011350: 655f 7061 7474 6572 6e5f 6675 6e63 7469  e_pattern_functi
-00011360: 6f6e 203d 2070 6174 7465 726e 696e 675f  on = patterning_
-00011370: 6170 692e 6372 6561 7465 5f63 6c65 616e  api.create_clean
-00011380: 696e 675f 6372 6f73 735f 7365 6374 696f  ing_cross_sectio
-00011390: 6e0a 2020 2020 2020 2020 656c 7365 3a0a  n.        else:.
-000113a0: 2020 2020 2020 2020 2020 2020 6372 6561              crea
-000113b0: 7465 5f70 6174 7465 726e 5f66 756e 6374  te_pattern_funct
-000113c0: 696f 6e20 3d20 7061 7474 6572 6e69 6e67  ion = patterning
-000113d0: 5f61 7069 2e63 7265 6174 655f 7265 6374  _api.create_rect
-000113e0: 616e 676c 650a 2020 2020 2020 2020 0a20  angle.        . 
-000113f0: 2020 2020 2020 2069 6620 7061 7474 6572         if patter
-00011400: 6e5f 7365 7474 696e 6773 2e63 6c65 616e  n_settings.clean
-00011410: 696e 675f 6372 6f73 735f 7365 6374 696f  ing_cross_sectio
-00011420: 6e3a 0a20 2020 2020 2020 2020 2020 206c  n:.            l
-00011430: 6f67 6769 6e67 2e77 6172 6e69 6e67 2866  ogging.warning(f
-00011440: 2244 6570 7265 6361 7465 643a 2063 6c65  "Deprecated: cle
-00011450: 616e 696e 675f 6372 6f73 735f 7365 6374  aning_cross_sect
-00011460: 696f 6e20 6973 2064 6570 7265 6361 7465  ion is deprecate
-00011470: 642e 2055 7365 2063 726f 7373 5f73 6563  d. Use cross_sec
-00011480: 7469 6f6e 2069 6e73 7465 6164 2e20 5468  tion instead. Th
-00011490: 6973 2077 696c 6c20 6265 2072 656d 6f76  is will be remov
-000114a0: 6564 2069 6e20 6120 6675 7475 7265 2072  ed in a future r
-000114b0: 656c 6561 7365 2e22 2920 2020 200a 2020  elease.")    .  
-000114c0: 2020 2020 2020 2020 2020 6372 6561 7465            create
-000114d0: 5f70 6174 7465 726e 5f66 756e 6374 696f  _pattern_functio
-000114e0: 6e20 3d20 7061 7474 6572 6e69 6e67 5f61  n = patterning_a
-000114f0: 7069 2e63 7265 6174 655f 636c 6561 6e69  pi.create_cleani
-00011500: 6e67 5f63 726f 7373 5f73 6563 7469 6f6e  ng_cross_section
-00011510: 0a0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
-00011520: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00011530: 2320 6372 6561 7465 2070 6174 7465 726e  # create pattern
-00011540: 0a20 2020 2020 2020 2070 6174 7465 726e  .        pattern
-00011550: 203d 2063 7265 6174 655f 7061 7474 6572   = create_patter
-00011560: 6e5f 6675 6e63 7469 6f6e 280a 2020 2020  n_function(.    
-00011570: 2020 2020 2020 2020 6365 6e74 6572 5f78          center_x
-00011580: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
-00011590: 732e 6365 6e74 7265 5f78 2c0a 2020 2020  s.centre_x,.    
-000115a0: 2020 2020 2020 2020 6365 6e74 6572 5f79          center_y
-000115b0: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
-000115c0: 732e 6365 6e74 7265 5f79 2c0a 2020 2020  s.centre_y,.    
-000115d0: 2020 2020 2020 2020 7769 6474 683d 7061          width=pa
-000115e0: 7474 6572 6e5f 7365 7474 696e 6773 2e77  ttern_settings.w
-000115f0: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-00011600: 2020 6865 6967 6874 3d70 6174 7465 726e    height=pattern
-00011610: 5f73 6574 7469 6e67 732e 6865 6967 6874  _settings.height
-00011620: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
-00011630: 7074 683d 7061 7474 6572 6e5f 7365 7474  pth=pattern_sett
-00011640: 696e 6773 2e64 6570 7468 2c0a 2020 2020  ings.depth,.    
-00011650: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
-00011660: 2073 6574 2070 6174 7465 726e 2072 6f74   set pattern rot
-00011670: 6174 696f 6e0a 2020 2020 2020 2020 7061  ation.        pa
-00011680: 7474 6572 6e2e 726f 7461 7469 6f6e 203d  ttern.rotation =
-00011690: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
-000116a0: 732e 726f 7461 7469 6f6e 0a0a 2020 2020  s.rotation..    
-000116b0: 2020 2020 2320 7365 7420 7363 616e 2064      # set scan d
-000116c0: 6972 6563 7469 6f6e 0a20 2020 2020 2020  irection.       
-000116d0: 2061 7661 696c 6162 6c65 5f73 6361 6e5f   available_scan_
-000116e0: 6469 7265 6374 696f 6e73 203d 2073 656c  directions = sel
-000116f0: 662e 6765 745f 6176 6169 6c61 626c 655f  f.get_available_
-00011700: 7661 6c75 6573 2822 7363 616e 5f64 6972  values("scan_dir
-00011710: 6563 7469 6f6e 2229 2020 2020 2020 2020  ection")        
-00011720: 0a20 2020 200a 2020 2020 2020 2020 6966  .    .        if
-00011730: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
-00011740: 732e 7363 616e 5f64 6972 6563 7469 6f6e  s.scan_direction
-00011750: 2069 6e20 6176 6169 6c61 626c 655f 7363   in available_sc
-00011760: 616e 5f64 6972 6563 7469 6f6e 733a 0a20  an_directions:. 
-00011770: 2020 2020 2020 2020 2020 2070 6174 7465             patte
-00011780: 726e 2e73 6361 6e5f 6469 7265 6374 696f  rn.scan_directio
-00011790: 6e20 3d20 7061 7474 6572 6e5f 7365 7474  n = pattern_sett
-000117a0: 696e 6773 2e73 6361 6e5f 6469 7265 6374  ings.scan_direct
-000117b0: 696f 6e0a 2020 2020 2020 2020 656c 7365  ion.        else
-000117c0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-000117d0: 7474 6572 6e2e 7363 616e 5f64 6972 6563  ttern.scan_direc
-000117e0: 7469 6f6e 203d 2022 546f 7054 6f42 6f74  tion = "TopToBot
-000117f0: 746f 6d22 0a20 2020 2020 2020 2020 2020  tom".           
-00011800: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
-00011810: 2866 2253 6361 6e20 6469 7265 6374 696f  (f"Scan directio
-00011820: 6e20 7b70 6174 7465 726e 5f73 6574 7469  n {pattern_setti
-00011830: 6e67 732e 7363 616e 5f64 6972 6563 7469  ngs.scan_directi
-00011840: 6f6e 7d20 6e6f 7420 7375 7070 6f72 7465  on} not supporte
-00011850: 642e 2055 7369 6e67 2054 6f70 546f 426f  d. Using TopToBo
-00011860: 7474 6f6d 2069 6e73 7465 6164 2e22 290a  ttom instead.").
-00011870: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00011880: 696e 672e 7761 726e 696e 6728 6622 5375  ing.warning(f"Su
-00011890: 7070 6f72 7465 6420 7363 616e 2064 6972  pported scan dir
-000118a0: 6563 7469 6f6e 7320 6172 653a 207b 6176  ections are: {av
-000118b0: 6169 6c61 626c 655f 7363 616e 5f64 6972  ailable_scan_dir
-000118c0: 6563 7469 6f6e 737d 2229 2020 2020 2020  ections}")      
-000118d0: 2020 0a20 2020 2020 2020 200a 2020 2020    .        .    
-000118e0: 2020 2020 2320 7365 7420 7061 7373 6573      # set passes
-000118f0: 0a20 2020 2020 2020 2023 2069 6620 7061  .        # if pa
-00011900: 7474 6572 6e5f 7365 7474 696e 6773 2e70  ttern_settings.p
-00011910: 6173 7365 733a 2023 206e 6f74 207a 6572  asses: # not zer
-00011920: 6f0a 2020 2020 2020 2020 2320 2020 2020  o.        #     
-00011930: 7061 7474 6572 6e2e 6477 656c 6c5f 7469  pattern.dwell_ti
-00011940: 6d65 203d 2070 6174 7465 726e 2e64 7765  me = pattern.dwe
-00011950: 6c6c 5f74 696d 6520 2a20 2870 6174 7465  ll_time * (patte
-00011960: 726e 2e70 6173 735f 636f 756e 7420 2f20  rn.pass_count / 
-00011970: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-00011980: 2e70 6173 7365 7329 0a20 2020 2020 2020  .passes).       
-00011990: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-000119a0: 2020 2320 4e42 3a20 7061 7373 6573 2c20    # NB: passes, 
-000119b0: 7469 6d65 2c20 6477 656c 6c20 7469 6d65  time, dwell time
-000119c0: 2061 7265 2061 6c6c 2069 6e74 6572 6c69   are all interli
-000119d0: 6e6b 6564 2c20 7468 6572 6566 6f72 6520  nked, therefore 
-000119e0: 6361 6e20 6f6e 6c79 2061 646a 7573 7420  can only adjust 
-000119f0: 7061 7373 6573 2069 6e64 6972 6563 746c  passes indirectl
-00011a00: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
-00011a10: 6966 2077 6520 6164 6a75 7374 2070 6173  if we adjust pas
-00011a20: 7365 7320 6469 7265 6374 6c79 2c20 6974  ses directly, it
-00011a30: 206a 7573 7420 7265 6475 6365 7320 7468   just reduces th
-00011a40: 6520 746f 7461 6c20 7469 6d65 2074 6f20  e total time to 
-00011a50: 636f 6d70 656e 7361 7465 2c20 7261 7468  compensate, rath
-00011a60: 6572 2074 6861 6e20 696e 6372 6561 7369  er than increasi
-00011a70: 6e67 2074 6865 2064 7765 6c6c 5f74 696d  ng the dwell_tim
-00011a80: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00011a90: 4e42 3a20 7468 6520 6375 7272 656e 7420  NB: the current 
-00011aa0: 6d75 7374 2062 6520 7365 7420 6265 666f  must be set befo
-00011ab0: 7265 2064 6f69 6e67 2074 6869 732c 206f  re doing this, o
-00011ac0: 7468 6572 7769 7365 2069 7420 7769 6c6c  therwise it will
-00011ad0: 2062 6520 6f75 7420 6f66 2072 616e 6765   be out of range
-00011ae0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00011af0: 2020 6966 2070 6174 7465 726e 5f73 6574    if pattern_set
-00011b00: 7469 6e67 732e 7061 7373 6573 3a20 2320  tings.passes: # 
-00011b10: 6e6f 7420 7a65 726f 0a20 2020 2020 2020  not zero.       
-00011b20: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00011b30: 6365 2870 6174 7465 726e 2c20 5265 6775  ce(pattern, Regu
-00011b40: 6c61 7243 726f 7373 5365 6374 696f 6e50  larCrossSectionP
-00011b50: 6174 7465 726e 293a 0a20 2020 2020 2020  attern):.       
-00011b60: 2020 2020 2020 2020 2070 6174 7465 726e           pattern
-00011b70: 2e6d 756c 7469 5f73 6361 6e5f 7061 7373  .multi_scan_pass
-00011b80: 5f63 6f75 6e74 203d 2070 6174 7465 726e  _count = pattern
-00011b90: 5f73 6574 7469 6e67 732e 7061 7373 6573  _settings.passes
-00011ba0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00011bb0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00011bc0: 2020 2070 6174 7465 726e 2e64 7765 6c6c     pattern.dwell
-00011bd0: 5f74 696d 6520 3d20 7061 7474 6572 6e2e  _time = pattern.
-00011be0: 6477 656c 6c5f 7469 6d65 202a 2028 7061  dwell_time * (pa
-00011bf0: 7474 6572 6e2e 7061 7373 5f63 6f75 6e74  ttern.pass_count
-00011c00: 202f 2070 6174 7465 726e 5f73 6574 7469   / pattern_setti
-00011c10: 6e67 732e 7061 7373 6573 290a 2020 2020  ngs.passes).    
-00011c20: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00011c30: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-00011c40: 423a 2070 6173 7365 732c 2074 696d 652c  B: passes, time,
-00011c50: 2064 7765 6c6c 2074 696d 6520 6172 6520   dwell time are 
-00011c60: 616c 6c20 696e 7465 726c 696e 6b65 642c  all interlinked,
-00011c70: 2074 6865 7265 666f 7265 2063 616e 206f   therefore can o
-00011c80: 6e6c 7920 6164 6a75 7374 2070 6173 7365  nly adjust passe
-00011c90: 7320 696e 6469 7265 6374 6c79 0a20 2020  s indirectly.   
-00011ca0: 2020 2020 2020 2020 2020 2020 2023 2069               # i
-00011cb0: 6620 7765 2061 646a 7573 7420 7061 7373  f we adjust pass
-00011cc0: 6573 2064 6972 6563 746c 792c 2069 7420  es directly, it 
-00011cd0: 6a75 7374 2072 6564 7563 6573 2074 6865  just reduces the
-00011ce0: 2074 6f74 616c 2074 696d 6520 746f 2063   total time to c
-00011cf0: 6f6d 7065 6e73 6174 652c 2072 6174 6865  ompensate, rathe
-00011d00: 7220 7468 616e 2069 6e63 7265 6173 696e  r than increasin
-00011d10: 6720 7468 6520 6477 656c 6c5f 7469 6d65  g the dwell_time
-00011d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011d30: 2023 204e 423a 2074 6865 2063 7572 7265   # NB: the curre
-00011d40: 6e74 206d 7573 7420 6265 2073 6574 2062  nt must be set b
-00011d50: 6566 6f72 6520 646f 696e 6720 7468 6973  efore doing this
-00011d60: 2c20 6f74 6865 7277 6973 6520 6974 2077  , otherwise it w
-00011d70: 696c 6c20 6265 206f 7574 206f 6620 7261  ill be out of ra
-00011d80: 6e67 650a 0a20 2020 2020 2020 206c 6f67  nge..        log
-00011d90: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
-00011da0: 223a 2022 6472 6177 5f72 6563 7461 6e67  ": "draw_rectang
-00011db0: 6c65 222c 2022 7061 7474 6572 6e5f 7365  le", "pattern_se
-00011dc0: 7474 696e 6773 223a 2070 6174 7465 726e  ttings": pattern
-00011dd0: 5f73 6574 7469 6e67 732e 746f 5f64 6963  _settings.to_dic
-00011de0: 7428 297d 290a 0a20 2020 2020 2020 2072  t()})..        r
-00011df0: 6574 7572 6e20 7061 7474 6572 6e0a 0a20  eturn pattern.. 
-00011e00: 2020 2064 6566 2064 7261 775f 6c69 6e65     def draw_line
-00011e10: 2873 656c 662c 2070 6174 7465 726e 5f73  (self, pattern_s
-00011e20: 6574 7469 6e67 733a 2046 6962 7365 6d4c  ettings: FibsemL
-00011e30: 696e 6553 6574 7469 6e67 7329 3a0a 2020  ineSettings):.  
-00011e40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00011e50: 2020 4472 6177 7320 6120 6c69 6e65 2070    Draws a line p
-00011e60: 6174 7465 726e 206f 6e20 7468 6520 6375  attern on the cu
-00011e70: 7272 656e 7420 696d 6167 696e 6720 7669  rrent imaging vi
-00011e80: 6577 206f 6620 7468 6520 6d69 6372 6f73  ew of the micros
-00011e90: 636f 7065 2e0a 0a20 2020 2020 2020 2041  cope...        A
-00011ea0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
-00011eb0: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
-00011ec0: 7320 2846 6962 7365 6d4c 696e 6553 6574  s (FibsemLineSet
-00011ed0: 7469 6e67 7329 3a20 4120 6461 7461 2063  tings): A data c
-00011ee0: 6c61 7373 206f 626a 6563 7420 7370 6563  lass object spec
-00011ef0: 6966 7969 6e67 2074 6865 2070 6174 7465  ifying the patte
-00011f00: 726e 2070 6172 616d 6574 6572 732c 0a20  rn parameters,. 
-00011f10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00011f20: 6e63 6c75 6469 6e67 2074 6865 2073 7461  ncluding the sta
-00011f30: 7274 2061 6e64 2065 6e64 2070 6f69 6e74  rt and end point
-00011f40: 732c 2061 6e64 2074 6865 2064 6570 7468  s, and the depth
-00011f50: 206f 6620 7468 6520 7061 7474 6572 6e2e   of the pattern.
-00011f60: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-00011f70: 733a 0a20 2020 2020 2020 2020 2020 204c  s:.            L
-00011f80: 696e 6550 6174 7465 726e 3a20 4120 6c69  inePattern: A li
-00011f90: 6e65 2070 6174 7465 726e 206f 626a 6563  ne pattern objec
-00011fa0: 742c 2077 6869 6368 2063 616e 2062 6520  t, which can be 
-00011fb0: 7573 6564 2074 6f20 636f 6e66 6967 7572  used to configur
-00011fc0: 6520 6675 7274 6865 7220 7072 6f70 6572  e further proper
-00011fd0: 7469 6573 206f 7220 746f 2061 6464 2074  ties or to add t
-00011fe0: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
-00011ff0: 2020 2070 6174 7465 726e 2074 6f20 7468     pattern to th
-00012000: 6520 6d69 6c6c 696e 6720 6c69 7374 2e0a  e milling list..
-00012010: 0a20 2020 2020 2020 2052 6169 7365 733a  .        Raises:
-00012020: 0a20 2020 2020 2020 2020 2020 2061 7574  .            aut
-00012030: 6f73 6372 6970 742e 6578 6365 7074 696f  oscript.exceptio
-00012040: 6e73 2e49 6e76 616c 6964 4172 6775 6d65  ns.InvalidArgume
-00012050: 6e74 4578 6365 7074 696f 6e3a 2069 6620  ntException: if 
-00012060: 616e 7920 6f66 2074 6865 2070 6174 7465  any of the patte
-00012070: 726e 2070 6172 616d 6574 6572 7320 6172  rn parameters ar
-00012080: 6520 696e 7661 6c69 642e 0a20 2020 2020  e invalid..     
-00012090: 2020 2022 2222 0a20 2020 2020 2020 2070     """.        p
-000120a0: 6174 7465 726e 203d 2073 656c 662e 636f  attern = self.co
-000120b0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-000120c0: 696e 672e 6372 6561 7465 5f6c 696e 6528  ing.create_line(
-000120d0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-000120e0: 7274 5f78 3d70 6174 7465 726e 5f73 6574  rt_x=pattern_set
-000120f0: 7469 6e67 732e 7374 6172 745f 782c 0a20  tings.start_x,. 
-00012100: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00012110: 5f79 3d70 6174 7465 726e 5f73 6574 7469  _y=pattern_setti
-00012120: 6e67 732e 7374 6172 745f 792c 0a20 2020  ngs.start_y,.   
-00012130: 2020 2020 2020 2020 2065 6e64 5f78 3d70           end_x=p
-00012140: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
-00012150: 656e 645f 782c 0a20 2020 2020 2020 2020  end_x,.         
-00012160: 2020 2065 6e64 5f79 3d70 6174 7465 726e     end_y=pattern
-00012170: 5f73 6574 7469 6e67 732e 656e 645f 792c  _settings.end_y,
-00012180: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
-00012190: 7468 3d70 6174 7465 726e 5f73 6574 7469  th=pattern_setti
-000121a0: 6e67 732e 6465 7074 682c 0a20 2020 2020  ngs.depth,.     
-000121b0: 2020 2029 0a20 2020 2020 2020 206c 6f67     ).        log
-000121c0: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
-000121d0: 223a 2022 6472 6177 5f6c 696e 6522 2c20  ": "draw_line", 
-000121e0: 2270 6174 7465 726e 5f73 6574 7469 6e67  "pattern_setting
-000121f0: 7322 3a20 7061 7474 6572 6e5f 7365 7474  s": pattern_sett
-00012200: 696e 6773 2e74 6f5f 6469 6374 2829 7d29  ings.to_dict()})
-00012210: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00012220: 7061 7474 6572 6e0a 2020 2020 0a20 2020  pattern.    .   
-00012230: 2064 6566 2064 7261 775f 6369 7263 6c65   def draw_circle
-00012240: 2873 656c 662c 2070 6174 7465 726e 5f73  (self, pattern_s
-00012250: 6574 7469 6e67 733a 2046 6962 7365 6d43  ettings: FibsemC
-00012260: 6972 636c 6553 6574 7469 6e67 7329 3a0a  ircleSettings):.
-00012270: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00012280: 2020 2020 4472 6177 7320 6120 6369 7263      Draws a circ
-00012290: 6c65 2070 6174 7465 726e 206f 6e20 7468  le pattern on th
-000122a0: 6520 6375 7272 656e 7420 696d 6167 696e  e current imagin
-000122b0: 6720 7669 6577 206f 6620 7468 6520 6d69  g view of the mi
-000122c0: 6372 6f73 636f 7065 2e0a 0a20 2020 2020  croscope...     
-000122d0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-000122e0: 2020 2020 2070 6174 7465 726e 5f73 6574       pattern_set
-000122f0: 7469 6e67 7320 2846 6962 7365 6d43 6972  tings (FibsemCir
-00012300: 636c 6553 6574 7469 6e67 7329 3a20 4120  cleSettings): A 
-00012310: 6461 7461 2063 6c61 7373 206f 626a 6563  data class objec
-00012320: 7420 7370 6563 6966 7969 6e67 2074 6865  t specifying the
-00012330: 2070 6174 7465 726e 2070 6172 616d 6574   pattern paramet
-00012340: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-00012350: 2020 2020 2069 6e63 6c75 6469 6e67 2074       including t
-00012360: 6865 2063 656e 7472 6520 706f 696e 742c  he centre point,
-00012370: 2072 6164 6975 7320 616e 6420 6465 7074   radius and dept
-00012380: 6820 6f66 2074 6865 2070 6174 7465 726e  h of the pattern
-00012390: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-000123a0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-000123b0: 4369 7263 6c65 5061 7474 6572 6e3a 2041  CirclePattern: A
-000123c0: 2063 6972 636c 6520 7061 7474 6572 6e20   circle pattern 
-000123d0: 6f62 6a65 6374 2c20 7768 6963 6820 6361  object, which ca
-000123e0: 6e20 6265 2075 7365 6420 746f 2063 6f6e  n be used to con
-000123f0: 6669 6775 7265 2066 7572 7468 6572 2070  figure further p
-00012400: 726f 7065 7274 6965 7320 6f72 2074 6f20  roperties or to 
-00012410: 6164 6420 7468 650a 2020 2020 2020 2020  add the.        
-00012420: 2020 2020 2020 2020 7061 7474 6572 6e20          pattern 
-00012430: 746f 2074 6865 206d 696c 6c69 6e67 206c  to the milling l
-00012440: 6973 742e 0a0a 2020 2020 2020 2020 5261  ist...        Ra
-00012450: 6973 6573 3a0a 2020 2020 2020 2020 2020  ises:.          
-00012460: 2020 6175 746f 7363 7269 7074 2e65 7863    autoscript.exc
-00012470: 6570 7469 6f6e 732e 496e 7661 6c69 6441  eptions.InvalidA
-00012480: 7267 756d 656e 7445 7863 6570 7469 6f6e  rgumentException
-00012490: 3a20 6966 2061 6e79 206f 6620 7468 6520  : if any of the 
-000124a0: 7061 7474 6572 6e20 7061 7261 6d65 7465  pattern paramete
-000124b0: 7273 2061 7265 2069 6e76 616c 6964 2e0a  rs are invalid..
-000124c0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000124d0: 2020 2020 7061 7474 6572 6e20 3d20 7365      pattern = se
-000124e0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
-000124f0: 7474 6572 6e69 6e67 2e63 7265 6174 655f  tterning.create_
-00012500: 6369 7263 6c65 280a 2020 2020 2020 2020  circle(.        
-00012510: 2020 2020 6365 6e74 6572 5f78 3d70 6174      center_x=pat
-00012520: 7465 726e 5f73 6574 7469 6e67 732e 6365  tern_settings.ce
-00012530: 6e74 7265 5f78 2c0a 2020 2020 2020 2020  ntre_x,.        
-00012540: 2020 2020 6365 6e74 6572 5f79 3d70 6174      center_y=pat
-00012550: 7465 726e 5f73 6574 7469 6e67 732e 6365  tern_settings.ce
-00012560: 6e74 7265 5f79 2c0a 2020 2020 2020 2020  ntre_y,.        
-00012570: 2020 2020 6f75 7465 725f 6469 616d 6574      outer_diamet
-00012580: 6572 3d32 2a70 6174 7465 726e 5f73 6574  er=2*pattern_set
-00012590: 7469 6e67 732e 7261 6469 7573 2c0a 2020  tings.radius,.  
-000125a0: 2020 2020 2020 2020 2020 696e 6e65 725f            inner_
-000125b0: 6469 616d 6574 6572 203d 2030 2c0a 2020  diameter = 0,.  
-000125c0: 2020 2020 2020 2020 2020 6465 7074 683d            depth=
-000125d0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-000125e0: 2e64 6570 7468 2c0a 2020 2020 2020 2020  .depth,.        
-000125f0: 290a 0a20 2020 2020 2020 206c 6f67 6769  )..        loggi
-00012600: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
-00012610: 2022 6472 6177 5f63 6972 636c 6522 2c20   "draw_circle", 
-00012620: 2270 6174 7465 726e 5f73 6574 7469 6e67  "pattern_setting
-00012630: 7322 3a20 7061 7474 6572 6e5f 7365 7474  s": pattern_sett
-00012640: 696e 6773 2e74 6f5f 6469 6374 2829 7d29  ings.to_dict()})
-00012650: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00012660: 2070 6174 7465 726e 0a0a 2020 2020 6465   pattern..    de
-00012670: 6620 6472 6177 5f61 6e6e 756c 7573 2873  f draw_annulus(s
-00012680: 656c 662c 2070 6174 7465 726e 5f73 6574  elf, pattern_set
-00012690: 7469 6e67 733a 2046 6962 7365 6d43 6972  tings: FibsemCir
-000126a0: 636c 6553 6574 7469 6e67 7329 3a0a 0a20  cleSettings):.. 
-000126b0: 2020 2020 2020 206f 7574 6572 5f64 6961         outer_dia
-000126c0: 6d65 7465 7220 3d20 322a 7061 7474 6572  meter = 2*patter
-000126d0: 6e5f 7365 7474 696e 6773 2e72 6164 6975  n_settings.radiu
-000126e0: 730a 2020 2020 2020 2020 696e 6e65 725f  s.        inner_
-000126f0: 6469 616d 6574 6572 203d 206f 7574 6572  diameter = outer
-00012700: 5f64 6961 6d65 7465 7220 2d20 322a 7061  _diameter - 2*pa
-00012710: 7474 6572 6e5f 7365 7474 696e 6773 2e74  ttern_settings.t
-00012720: 6869 636b 6e65 7373 0a0a 2020 2020 2020  hickness..      
-00012730: 2020 7061 7474 6572 6e20 3d20 7365 6c66    pattern = self
-00012740: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
-00012750: 6572 6e69 6e67 2e63 7265 6174 655f 6369  erning.create_ci
-00012760: 7263 6c65 280a 2020 2020 2020 2020 2020  rcle(.          
-00012770: 2020 6365 6e74 6572 5f78 3d70 6174 7465    center_x=patte
-00012780: 726e 5f73 6574 7469 6e67 732e 6365 6e74  rn_settings.cent
-00012790: 7265 5f78 2c0a 2020 2020 2020 2020 2020  re_x,.          
-000127a0: 2020 6365 6e74 6572 5f79 3d70 6174 7465    center_y=patte
-000127b0: 726e 5f73 6574 7469 6e67 732e 6365 6e74  rn_settings.cent
-000127c0: 7265 5f79 2c0a 2020 2020 2020 2020 2020  re_y,.          
-000127d0: 2020 6f75 7465 725f 6469 616d 6574 6572    outer_diameter
-000127e0: 3d6f 7574 6572 5f64 6961 6d65 7465 722c  =outer_diameter,
-000127f0: 0a20 2020 2020 2020 2020 2020 2069 6e6e  .            inn
-00012800: 6572 5f64 6961 6d65 7465 7220 3d20 696e  er_diameter = in
-00012810: 6e65 725f 6469 616d 6574 6572 2c0a 2020  ner_diameter,.  
-00012820: 2020 2020 2020 2020 2020 6465 7074 683d            depth=
-00012830: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-00012840: 2e64 6570 7468 2c0a 2020 2020 2020 2020  .depth,.        
-00012850: 290a 0a20 2020 2020 2020 206c 6f67 6769  )..        loggi
-00012860: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
-00012870: 2022 6472 6177 5f61 6e6e 756c 7573 222c   "draw_annulus",
-00012880: 2022 7061 7474 6572 6e5f 7365 7474 696e   "pattern_settin
-00012890: 6773 223a 2070 6174 7465 726e 5f73 6574  gs": pattern_set
-000128a0: 7469 6e67 732e 746f 5f64 6963 7428 297d  tings.to_dict()}
-000128b0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-000128c0: 6e20 7061 7474 6572 6e0a 2020 2020 0a20  n pattern.    . 
-000128d0: 2020 200a 2020 2020 6465 6620 6472 6177     .    def draw
-000128e0: 5f62 6974 6d61 705f 7061 7474 6572 6e28  _bitmap_pattern(
-000128f0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00012900: 2020 2020 2020 2070 6174 7465 726e 5f73         pattern_s
-00012910: 6574 7469 6e67 733a 2046 6962 7365 6d42  ettings: FibsemB
-00012920: 6974 6d61 7053 6574 7469 6e67 732c 0a20  itmapSettings,. 
-00012930: 2020 2020 2020 2070 6174 683a 2073 7472         path: str
-00012940: 2c0a 2020 2020 293a 0a0a 2020 2020 2020  ,.    ):..      
-00012950: 2020 6269 746d 6170 5f70 6174 7465 726e    bitmap_pattern
-00012960: 203d 2042 6974 6d61 7050 6174 7465 726e   = BitmapPattern
-00012970: 4465 6669 6e69 7469 6f6e 2e6c 6f61 6428  Definition.load(
-00012980: 7061 7468 290a 0a20 2020 2020 2020 2070  path)..        p
-00012990: 6174 7465 726e 203d 2073 656c 662e 636f  attern = self.co
-000129a0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-000129b0: 696e 672e 6372 6561 7465 5f62 6974 6d61  ing.create_bitma
-000129c0: 7028 0a20 2020 2020 2020 2020 2020 2063  p(.            c
-000129d0: 656e 7465 725f 783d 7061 7474 6572 6e5f  enter_x=pattern_
-000129e0: 7365 7474 696e 6773 2e63 656e 7472 655f  settings.centre_
-000129f0: 782c 0a20 2020 2020 2020 2020 2020 2063  x,.            c
-00012a00: 656e 7465 725f 793d 7061 7474 6572 6e5f  enter_y=pattern_
-00012a10: 7365 7474 696e 6773 2e63 656e 7472 655f  settings.centre_
-00012a20: 792c 0a20 2020 2020 2020 2020 2020 2077  y,.            w
-00012a30: 6964 7468 3d70 6174 7465 726e 5f73 6574  idth=pattern_set
-00012a40: 7469 6e67 732e 7769 6474 682c 0a20 2020  tings.width,.   
-00012a50: 2020 2020 2020 2020 2068 6569 6768 743d           height=
-00012a60: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-00012a70: 2e68 6569 6768 742c 0a20 2020 2020 2020  .height,.       
-00012a80: 2020 2020 2064 6570 7468 3d70 6174 7465       depth=patte
-00012a90: 726e 5f73 6574 7469 6e67 732e 6465 7074  rn_settings.dept
-00012aa0: 682c 0a20 2020 2020 2020 2020 2020 2062  h,.            b
-00012ab0: 6974 6d61 705f 7061 7474 6572 6e5f 6465  itmap_pattern_de
-00012ac0: 6669 6e69 7469 6f6e 3d62 6974 6d61 705f  finition=bitmap_
-00012ad0: 7061 7474 6572 6e2c 0a20 2020 2020 2020  pattern,.       
-00012ae0: 2029 0a0a 2020 2020 2020 2020 6c6f 6767   )..        logg
-00012af0: 696e 672e 6465 6275 6728 7b22 6d73 6722  ing.debug({"msg"
-00012b00: 3a20 2264 7261 775f 6269 746d 6170 5f70  : "draw_bitmap_p
-00012b10: 6174 7465 726e 222c 2022 7061 7474 6572  attern", "patter
-00012b20: 6e5f 7365 7474 696e 6773 223a 2070 6174  n_settings": pat
-00012b30: 7465 726e 5f73 6574 7469 6e67 732e 746f  tern_settings.to
-00012b40: 5f64 6963 7428 292c 2022 7061 7468 223a  _dict(), "path":
-00012b50: 2070 6174 687d 290a 0a20 2020 2020 2020   path})..       
-00012b60: 2072 6574 7572 6e20 7061 7474 6572 6e0a   return pattern.
-00012b70: 0a20 2020 2064 6566 2067 6574 5f73 6361  .    def get_sca
-00012b80: 6e5f 6469 7265 6374 696f 6e73 2873 656c  n_directions(sel
-00012b90: 6629 202d 3e20 6c69 7374 3a0a 2020 2020  f) -> list:.    
-00012ba0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00012bb0: 5265 7475 726e 7320 7468 6520 6176 6169  Returns the avai
-00012bc0: 6c61 626c 6520 7363 616e 2064 6972 6563  lable scan direc
-00012bd0: 7469 6f6e 7320 6f66 2074 6865 206d 6963  tions of the mic
-00012be0: 726f 7363 6f70 652e 0a0a 2020 2020 2020  roscope...      
-00012bf0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00012c00: 2020 2020 2020 206c 6973 743a 2054 6865         list: The
-00012c10: 2073 6361 6e20 6469 7265 6374 696f 6e20   scan direction 
-00012c20: 6f66 2074 6865 206d 6963 726f 7363 6f70  of the microscop
-00012c30: 652e 0a0a 2020 2020 2020 2020 5261 6973  e...        Rais
-00012c40: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00012c50: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
-00012c60: 0a20 2020 2020 2020 206c 6973 7420 3d20  .        list = 
-00012c70: 5b22 426f 7474 6f6d 546f 546f 7022 2c20  ["BottomToTop", 
-00012c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012c90: 2022 4479 6e61 6d69 6341 6c6c 4469 7265   "DynamicAllDire
-00012ca0: 6374 696f 6e73 222c 200a 2020 2020 2020  ctions", .      
-00012cb0: 2020 2020 2020 2020 2020 2244 796e 616d            "Dynam
-00012cc0: 6963 496e 6e65 7254 6f4f 7574 6572 222c  icInnerToOuter",
-00012cd0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00012ce0: 2020 2244 796e 616d 6963 4c65 6674 546f    "DynamicLeftTo
-00012cf0: 5269 6768 7422 2c20 0a20 2020 2020 2020  Right", .       
-00012d00: 2020 2020 2020 2020 2022 4479 6e61 6d69           "Dynami
-00012d10: 6354 6f70 546f 426f 7474 6f6d 222c 200a  cTopToBottom", .
-00012d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d30: 2249 6e6e 6572 546f 4f75 7465 7222 2c20  "InnerToOuter", 
-00012d40: 090a 2020 2020 2020 2020 2020 2020 2020  ..              
-00012d50: 2020 224c 6566 7454 6f52 6967 6874 222c    "LeftToRight",
-00012d60: 2009 0a20 2020 2020 2020 2020 2020 2020   ..             
-00012d70: 2020 2022 4f75 7465 7254 6f49 6e6e 6572     "OuterToInner
-00012d80: 222c 200a 2020 2020 2020 2020 2020 2020  ", .            
-00012d90: 2020 2020 2252 6967 6874 546f 4c65 6674      "RightToLeft
-00012da0: 222c 2009 0a20 2020 2020 2020 2020 2020  ", ..           
-00012db0: 2020 2020 2022 546f 7054 6f42 6f74 746f       "TopToBotto
-00012dc0: 6d22 5d0a 2020 2020 2020 2020 0a20 2020  m"].        .   
-00012dd0: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
-00012de0: 7567 287b 226d 7367 223a 2022 6765 745f  ug({"msg": "get_
-00012df0: 7363 616e 5f64 6972 6563 7469 6f6e 7322  scan_directions"
-00012e00: 2c20 2273 6361 6e5f 6469 7265 6374 696f  , "scan_directio
-00012e10: 6e73 223a 206c 6973 747d 290a 0a20 2020  ns": list})..   
-00012e20: 2020 2020 2072 6574 7572 6e20 6c69 7374       return list
-00012e30: 200a 0a0a 2020 2020 6465 6620 7365 7475   ...    def setu
-00012e40: 705f 7370 7574 7465 7228 7365 6c66 2c20  p_sputter(self, 
-00012e50: 7072 6f74 6f63 6f6c 3a20 6469 6374 293a  protocol: dict):
-00012e60: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00012e70: 2020 2020 2053 6574 2075 7020 7468 6520       Set up the 
-00012e80: 7370 7574 7465 7220 636f 6174 696e 6720  sputter coating 
-00012e90: 7072 6f63 6573 7320 6f6e 2074 6865 206d  process on the m
-00012ea0: 6963 726f 7363 6f70 652e 0a0a 2020 2020  icroscope...    
-00012eb0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00012ec0: 2020 2020 2020 7072 6f74 6f63 6f6c 2028        protocol (
-00012ed0: 6469 6374 293a 2044 6963 7469 6f6e 6172  dict): Dictionar
-00012ee0: 7920 636f 6e74 6169 6e69 6e67 2074 6865  y containing the
-00012ef0: 2070 726f 746f 636f 6c20 6465 7461 696c   protocol detail
-00012f00: 7320 666f 7220 7370 7574 7465 7220 636f  s for sputter co
-00012f10: 6174 696e 672e 0a0a 2020 2020 2020 2020  ating...        
-00012f20: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00012f30: 2020 2020 204e 6f6e 650a 0a20 2020 2020       None..     
-00012f40: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-00012f50: 2020 2020 2020 204e 6f6e 650a 0a20 2020         None..   
-00012f60: 2020 2020 204e 6f74 6573 3a0a 2020 2020       Notes:.    
-00012f70: 2020 2020 2020 2020 5468 6973 2066 756e          This fun
-00012f80: 6374 696f 6e20 7365 7473 2075 7020 7468  ction sets up th
-00012f90: 6520 7370 7574 7465 7220 636f 6174 696e  e sputter coatin
-00012fa0: 6720 7072 6f63 6573 7320 6f6e 2074 6865  g process on the
-00012fb0: 206d 6963 726f 7363 6f70 652e 200a 2020   microscope. .  
-00012fc0: 2020 2020 2020 2020 2020 4974 2073 6574            It set
-00012fd0: 7320 7468 6520 6163 7469 7665 2076 6965  s the active vie
-00012fe0: 7720 746f 2074 6865 2065 6c65 6374 726f  w to the electro
-00012ff0: 6e20 6265 616d 2c20 636c 6561 7273 2061  n beam, clears a
-00013000: 6e79 2065 7869 7374 696e 6720 7061 7474  ny existing patt
-00013010: 6572 6e73 2c20 616e 6420 7365 7473 2074  erns, and sets t
-00013020: 6865 2064 6566 6175 6c74 2062 6561 6d20  he default beam 
-00013030: 7479 7065 2074 6f20 7468 6520 656c 6563  type to the elec
-00013040: 7472 6f6e 2062 6561 6d2e 200a 2020 2020  tron beam. .    
-00013050: 2020 2020 2020 2020 4974 2074 6865 6e20          It then 
-00013060: 696e 7365 7274 7320 7468 6520 6d75 6c74  inserts the mult
-00013070: 6963 6865 6d20 616e 6420 7475 726e 7320  ichem and turns 
-00013080: 6f6e 2074 6865 2068 6561 7465 7220 666f  on the heater fo
-00013090: 7220 7468 6520 7370 6563 6966 6965 6420  r the specified 
-000130a0: 6761 7320 6163 636f 7264 696e 6720 746f  gas according to
-000130b0: 2074 6865 2067 6976 656e 2070 726f 746f   the given proto
-000130c0: 636f 6c2e 200a 2020 2020 2020 2020 2020  col. .          
-000130d0: 2020 5468 6973 2066 756e 6374 696f 6e20    This function 
-000130e0: 616c 736f 2077 6169 7473 2066 6f72 2033  also waits for 3
-000130f0: 2073 6563 6f6e 6473 2074 6f20 616c 6c6f   seconds to allo
-00013100: 7720 7468 6520 6865 6174 6572 2074 6f20  w the heater to 
-00013110: 7761 726d 2075 702e 0a20 2020 2020 2020  warm up..       
-00013120: 2022 2222 0a20 2020 2020 2020 205f 6368   """.        _ch
-00013130: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
-00013140: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
-00013150: 2073 656c 662e 6f72 6967 696e 616c 5f61   self.original_a
-00013160: 6374 6976 655f 7669 6577 203d 2073 656c  ctive_view = sel
-00013170: 662e 636f 6e6e 6563 7469 6f6e 2e69 6d61  f.connection.ima
-00013180: 6769 6e67 2e67 6574 5f61 6374 6976 655f  ging.get_active_
-00013190: 7669 6577 2829 0a20 2020 2020 2020 2073  view().        s
-000131a0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
-000131b0: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
-000131c0: 655f 7669 6577 2842 6561 6d54 7970 652e  e_view(BeamType.
-000131d0: 454c 4543 5452 4f4e 2e76 616c 7565 290a  ELECTRON.value).
-000131e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-000131f0: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-00013200: 6e67 2e63 6c65 6172 5f70 6174 7465 726e  ng.clear_pattern
-00013210: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-00013220: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
-00013230: 6572 6e69 6e67 2e73 6574 5f64 6566 6175  erning.set_defau
-00013240: 6c74 5f61 7070 6c69 6361 7469 6f6e 5f66  lt_application_f
-00013250: 696c 6528 7072 6f74 6f63 6f6c 5b22 6170  ile(protocol["ap
-00013260: 706c 6963 6174 696f 6e5f 6669 6c65 225d  plication_file"]
-00013270: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-00013280: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
-00013290: 6e69 6e67 2e73 6574 5f64 6566 6175 6c74  ning.set_default
-000132a0: 5f62 6561 6d5f 7479 7065 2842 6561 6d54  _beam_type(BeamT
-000132b0: 7970 652e 454c 4543 5452 4f4e 2e76 616c  ype.ELECTRON.val
-000132c0: 7565 290a 2020 2020 2020 2020 7365 6c66  ue).        self
-000132d0: 2e6d 756c 7469 6368 656d 203d 2073 656c  .multichem = sel
-000132e0: 662e 636f 6e6e 6563 7469 6f6e 2e67 6173  f.connection.gas
-000132f0: 2e67 6574 5f6d 756c 7469 6368 656d 2829  .get_multichem()
-00013300: 0a20 2020 2020 2020 2073 656c 662e 6d75  .        self.mu
-00013310: 6c74 6963 6865 6d2e 696e 7365 7274 2870  ltichem.insert(p
-00013320: 726f 746f 636f 6c5b 2270 6f73 6974 696f  rotocol["positio
-00013330: 6e22 5d29 0a20 2020 2020 2020 2073 656c  n"]).        sel
-00013340: 662e 6d75 6c74 6963 6865 6d2e 7475 726e  f.multichem.turn
-00013350: 5f68 6561 7465 725f 6f6e 2870 726f 746f  _heater_on(proto
-00013360: 636f 6c5b 2267 6173 225d 2920 2023 2022  col["gas"])  # "
-00013370: 5074 2063 7279 6f22 290a 2020 2020 2020  Pt cryo").      
-00013380: 2020 7469 6d65 2e73 6c65 6570 2833 290a    time.sleep(3).
-00013390: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000133a0: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-000133b0: 226d 7367 223a 2022 7365 7475 705f 7370  "msg": "setup_sp
-000133c0: 7574 7465 7222 2c20 2270 726f 746f 636f  utter", "protoco
-000133d0: 6c22 3a20 7072 6f74 6f63 6f6c 7d29 0a20  l": protocol}). 
-000133e0: 2020 2020 2020 200a 0a20 2020 2064 6566         ..    def
-000133f0: 2064 7261 775f 7370 7574 7465 725f 7061   draw_sputter_pa
-00013400: 7474 6572 6e28 7365 6c66 2c20 6866 773a  ttern(self, hfw:
-00013410: 2066 6c6f 6174 2c20 6c69 6e65 5f70 6174   float, line_pat
-00013420: 7465 726e 5f6c 656e 6774 683a 2066 6c6f  tern_length: flo
-00013430: 6174 2c20 7370 7574 7465 725f 7469 6d65  at, sputter_time
-00013440: 3a20 666c 6f61 7429 3a0a 2020 2020 2020  : float):.      
-00013450: 2020 2222 220a 2020 2020 2020 2020 4472    """.        Dr
-00013460: 6177 7320 6120 6c69 6e65 2070 6174 7465  aws a line patte
-00013470: 726e 2066 6f72 2073 7075 7474 6572 696e  rn for sputterin
-00013480: 6720 7769 7468 2074 6865 2067 6976 656e  g with the given
-00013490: 2070 6172 616d 6574 6572 732e 0a0a 2020   parameters...  
-000134a0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-000134b0: 2020 2020 2020 2020 6866 7720 2866 6c6f          hfw (flo
-000134c0: 6174 293a 2054 6865 2068 6f72 697a 6f6e  at): The horizon
-000134d0: 7461 6c20 6669 656c 6420 7769 6474 6820  tal field width 
-000134e0: 6f66 2074 6865 2065 6c65 6374 726f 6e20  of the electron 
-000134f0: 6265 616d 2e0a 2020 2020 2020 2020 2020  beam..          
-00013500: 2020 6c69 6e65 5f70 6174 7465 726e 5f6c    line_pattern_l
-00013510: 656e 6774 6820 2866 6c6f 6174 293a 2054  ength (float): T
-00013520: 6865 206c 656e 6774 6820 6f66 2074 6865  he length of the
-00013530: 206c 696e 6520 7061 7474 6572 6e20 746f   line pattern to
-00013540: 2064 7261 772e 0a20 2020 2020 2020 2020   draw..         
-00013550: 2020 2073 7075 7474 6572 5f74 696d 6520     sputter_time 
-00013560: 2866 6c6f 6174 293a 2054 6865 2074 696d  (float): The tim
-00013570: 6520 746f 2073 7075 7474 6572 2074 6865  e to sputter the
-00013580: 206c 696e 6520 7061 7474 6572 6e2e 0a0a   line pattern...
-00013590: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
-000135a0: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-000135b0: 650a 0a20 2020 2020 2020 204e 6f74 6573  e..        Notes
-000135c0: 3a0a 2020 2020 2020 2020 2020 2020 5365  :.            Se
-000135d0: 7473 2074 6865 2068 6f72 697a 6f6e 7461  ts the horizonta
-000135e0: 6c20 6669 656c 6420 7769 6474 6820 6f66  l field width of
-000135f0: 2074 6865 2065 6c65 6374 726f 6e20 6265   the electron be
-00013600: 616d 2074 6f20 7468 6520 6769 7665 6e20  am to the given 
-00013610: 7661 6c75 652e 0a20 2020 2020 2020 2020  value..         
-00013620: 2020 2044 7261 7773 2061 206c 696e 6520     Draws a line 
-00013630: 7061 7474 6572 6e20 666f 7220 7370 7574  pattern for sput
-00013640: 7465 7269 6e67 2077 6974 6820 7468 6520  tering with the 
-00013650: 6769 7665 6e20 6c65 6e67 7468 2061 6e64  given length and
-00013660: 206d 696c 6c69 6e67 2064 6570 7468 2e0a   milling depth..
-00013670: 2020 2020 2020 2020 2020 2020 5365 7473              Sets
-00013680: 2074 6865 2073 7075 7474 6572 2074 696d   the sputter tim
-00013690: 6520 6f66 2074 6865 206c 696e 6520 7061  e of the line pa
-000136a0: 7474 6572 6e20 746f 2074 6865 2067 6976  ttern to the giv
-000136b0: 656e 2076 616c 7565 2e0a 0a20 2020 2020  en value...     
-000136c0: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-000136d0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e62  elf.connection.b
-000136e0: 6561 6d73 2e65 6c65 6374 726f 6e5f 6265  eams.electron_be
-000136f0: 616d 2e68 6f72 697a 6f6e 7461 6c5f 6669  am.horizontal_fi
-00013700: 656c 645f 7769 6474 682e 7661 6c75 6520  eld_width.value 
-00013710: 3d20 6866 770a 2020 2020 2020 2020 7061  = hfw.        pa
-00013720: 7474 6572 6e20 3d20 7365 6c66 2e63 6f6e  ttern = self.con
-00013730: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-00013740: 6e67 2e63 7265 6174 655f 6c69 6e65 280a  ng.create_line(.
-00013750: 2020 2020 2020 2020 2020 2020 2d6c 696e              -lin
-00013760: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
-00013770: 202f 2032 2c20 2023 2078 5f73 7461 7274   / 2,  # x_start
-00013780: 0a20 2020 2020 2020 2020 2020 202b 6c69  .            +li
-00013790: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
-000137a0: 682c 2020 2320 795f 7374 6172 740a 2020  h,  # y_start.  
-000137b0: 2020 2020 2020 2020 2020 2b6c 696e 655f            +line_
-000137c0: 7061 7474 6572 6e5f 6c65 6e67 7468 202f  pattern_length /
-000137d0: 2032 2c20 2023 2078 5f65 6e64 0a20 2020   2,  # x_end.   
-000137e0: 2020 2020 2020 2020 202b 6c69 6e65 5f70           +line_p
-000137f0: 6174 7465 726e 5f6c 656e 6774 682c 2020  attern_length,  
-00013800: 2320 795f 656e 640a 2020 2020 2020 2020  # y_end.        
-00013810: 2020 2020 3265 2d36 2c0a 2020 2020 2020      2e-6,.      
-00013820: 2020 2920 2023 206d 696c 6c69 6e67 2064    )  # milling d
-00013830: 6570 7468 0a20 2020 2020 2020 2070 6174  epth.        pat
-00013840: 7465 726e 2e74 696d 6520 3d20 7370 7574  tern.time = sput
-00013850: 7465 725f 7469 6d65 202b 2030 2e31 0a20  ter_time + 0.1. 
-00013860: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00013870: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
-00013880: 6d73 6722 3a20 2264 7261 775f 7370 7574  msg": "draw_sput
-00013890: 7465 725f 7061 7474 6572 6e22 2c20 2268  ter_pattern", "h
-000138a0: 6677 223a 2068 6677 2c20 226c 696e 655f  fw": hfw, "line_
-000138b0: 7061 7474 6572 6e5f 6c65 6e67 7468 223a  pattern_length":
-000138c0: 206c 696e 655f 7061 7474 6572 6e5f 6c65   line_pattern_le
-000138d0: 6e67 7468 2c20 2273 7075 7474 6572 5f74  ngth, "sputter_t
-000138e0: 696d 6522 3a20 7370 7574 7465 725f 7469  ime": sputter_ti
-000138f0: 6d65 7d29 0a0a 2020 2020 6465 6620 7275  me})..    def ru
-00013900: 6e5f 7370 7574 7465 7228 7365 6c66 2c20  n_sputter(self, 
-00013910: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
-00013920: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
-00013930: 756e 7320 7468 6520 4749 5320 506c 6174  uns the GIS Plat
-00013940: 696e 756d 2053 7075 7474 6572 2e0a 0a20  inum Sputter... 
-00013950: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-00013960: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00013970: 733a 204f 7074 696f 6e61 6c20 6b65 7977  s: Optional keyw
-00013980: 6f72 6420 6172 6775 6d65 6e74 7320 666f  ord arguments fo
-00013990: 7220 7468 6520 7370 7574 7465 7220 6675  r the sputter fu
-000139a0: 6e63 7469 6f6e 2e20 5468 6520 7265 7175  nction. The requ
-000139b0: 6972 6564 2061 7267 756d 656e 7420 666f  ired argument fo
-000139c0: 720a 2020 2020 2020 2020 7468 6520 5468  r.        the Th
-000139d0: 6572 6d6f 2076 6572 7369 6f6e 2069 7320  ermo version is 
-000139e0: 2273 7075 7474 6572 5f74 696d 6522 2028  "sputter_time" (
-000139f0: 696e 7429 2c20 7768 6963 6820 7370 6563  int), which spec
-00013a00: 6966 6965 7320 7468 6520 7469 6d65 2074  ifies the time t
-00013a10: 6f20 7370 7574 7465 7220 696e 2073 6563  o sputter in sec
-00013a20: 6f6e 6473 2e20 0a0a 2020 2020 2020 2020  onds. ..        
-00013a30: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
-00013a40: 2020 2020 204e 6f6e 650a 0a20 2020 2020       None..     
-00013a50: 2020 204e 6f74 6573 3a0a 2020 2020 2020     Notes:.      
-00013a60: 2020 2d20 426c 616e 6b73 2074 6865 2065    - Blanks the e
-00013a70: 6c65 6374 726f 6e20 6265 616d 2e0a 2020  lectron beam..  
-00013a80: 2020 2020 2020 2d20 5374 6172 7473 2073        - Starts s
-00013a90: 7075 7474 6572 696e 6720 7769 7468 2070  puttering with p
-00013aa0: 6c61 7469 6e75 6d20 666f 7220 7468 6520  latinum for the 
-00013ab0: 7370 6563 6966 6965 6420 7370 7574 7465  specified sputte
-00013ac0: 7220 7469 6d65 2c20 616e 6420 7761 6974  r time, and wait
-00013ad0: 7320 756e 7469 6c20 7468 6520 7370 7574  s until the sput
-00013ae0: 7465 7269 6e67 0a20 2020 2020 2020 2069  tering.        i
-00013af0: 7320 636f 6d70 6c65 7465 2062 6566 6f72  s complete befor
-00013b00: 6520 636f 6e74 696e 7569 6e67 2e0a 2020  e continuing..  
-00013b10: 2020 2020 2020 2d20 4966 2074 6865 2070        - If the p
-00013b20: 6174 7465 726e 696e 6720 7374 6174 6520  atterning state 
-00013b30: 6973 206e 6f74 2072 6561 6479 2c20 7261  is not ready, ra
-00013b40: 6973 6573 2061 2052 756e 7469 6d65 4572  ises a RuntimeEr
-00013b50: 726f 722e 0a20 2020 2020 2020 202d 2049  ror..        - I
-00013b60: 6620 7468 6520 7061 7474 6572 6e69 6e67  f the patterning
-00013b70: 2073 7461 7465 2069 7320 7275 6e6e 696e   state is runnin
-00013b80: 672c 2073 746f 7073 2074 6865 2070 6174  g, stops the pat
-00013b90: 7465 726e 696e 672e 0a20 2020 2020 2020  terning..       
-00013ba0: 202d 2049 6620 7468 6520 7061 7474 6572   - If the patter
-00013bb0: 6e69 6e67 2073 7461 7465 2069 7320 6964  ning state is id
-00013bc0: 6c65 2c20 6c6f 6773 2061 2077 6172 6e69  le, logs a warni
-00013bd0: 6e67 206d 6573 7361 6765 2073 7567 6765  ng message sugge
-00013be0: 7374 696e 6720 746f 2061 646a 7573 7420  sting to adjust 
-00013bf0: 7468 6520 7061 7474 6572 6e69 6e67 0a20  the patterning. 
-00013c00: 2020 2020 2020 206c 696e 6520 6465 7074         line dept
-00013c10: 682e 0a20 2020 2020 2020 2022 2222 0a20  h..        """. 
-00013c20: 2020 2020 2020 205f 6368 6563 6b5f 7370         _check_sp
-00013c30: 7574 7465 7228 7365 6c66 2e73 7973 7465  utter(self.syste
-00013c40: 6d29 0a20 2020 2020 2020 2073 7075 7474  m).        sputt
-00013c50: 6572 5f74 696d 6520 3d20 6b77 6172 6773  er_time = kwargs
-00013c60: 5b22 7370 7574 7465 725f 7469 6d65 225d  ["sputter_time"]
-00013c70: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-00013c80: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
-00013c90: 656c 6563 7472 6f6e 5f62 6561 6d2e 626c  electron_beam.bl
-00013ca0: 616e 6b28 290a 2020 2020 2020 2020 6966  ank().        if
-00013cb0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00013cc0: 2e70 6174 7465 726e 696e 672e 7374 6174  .patterning.stat
-00013cd0: 6520 3d3d 2022 4964 6c65 223a 0a20 2020  e == "Idle":.   
-00013ce0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-00013cf0: 2e69 6e66 6f28 2253 7075 7474 6572 696e  .info("Sputterin
-00013d00: 6720 7769 7468 2070 6c61 7469 6e75 6d20  g with platinum 
-00013d10: 666f 7220 7b7d 2073 6563 6f6e 6473 2e2e  for {} seconds..
-00013d20: 2e22 2e66 6f72 6d61 7428 7370 7574 7465  .".format(sputte
-00013d30: 725f 7469 6d65 2929 0a20 2020 2020 2020  r_time)).       
-00013d40: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00013d50: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
-00013d60: 7374 6172 7428 2920 2023 2061 7379 6e63  start()  # async
-00013d70: 6872 6f6e 6f75 7320 7061 7474 6572 6e69  hronous patterni
-00013d80: 6e67 0a20 2020 2020 2020 2020 2020 2074  ng.            t
-00013d90: 696d 652e 736c 6565 7028 7370 7574 7465  ime.sleep(sputte
-00013da0: 725f 7469 6d65 202b 2035 290a 2020 2020  r_time + 5).    
-00013db0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00013dc0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00013dd0: 696d 6545 7272 6f72 2822 4361 6e27 7420  imeError("Can't 
-00013de0: 7370 7574 7465 7220 706c 6174 696e 756d  sputter platinum
-00013df0: 2c20 7061 7474 6572 6e69 6e67 2073 7461  , patterning sta
-00013e00: 7465 2069 7320 6e6f 7420 7265 6164 792e  te is not ready.
-00013e10: 2229 0a20 2020 2020 2020 2069 6620 7365  ").        if se
-00013e20: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
-00013e30: 7474 6572 6e69 6e67 2e73 7461 7465 203d  tterning.state =
-00013e40: 3d20 2252 756e 6e69 6e67 223a 0a20 2020  = "Running":.   
-00013e50: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00013e60: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-00013e70: 696e 672e 7374 6f70 2829 0a20 2020 2020  ing.stop().     
-00013e80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00013e90: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
-00013ea0: 6e69 6e67 2822 5061 7474 6572 6e69 6e67  ning("Patterning
-00013eb0: 2073 7461 7465 2069 7320 7b7d 222e 666f   state is {}".fo
-00013ec0: 726d 6174 2873 656c 662e 636f 6e6e 6563  rmat(self.connec
-00013ed0: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
-00013ee0: 7374 6174 6529 290a 2020 2020 2020 2020  state)).        
-00013ef0: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
-00013f00: 696e 6728 2243 6f6e 7369 6465 7220 6164  ing("Consider ad
-00013f10: 6a75 7374 696e 6720 7468 6520 7061 7474  justing the patt
-00013f20: 6572 6e69 6e67 206c 696e 6520 6465 7074  erning line dept
-00013f30: 682e 2229 0a0a 2020 2020 6465 6620 6669  h.")..    def fi
-00013f40: 6e69 7368 5f73 7075 7474 6572 2873 656c  nish_sputter(sel
-00013f50: 662c 2061 7070 6c69 6361 7469 6f6e 5f66  f, application_f
-00013f60: 696c 653a 2073 7472 2920 2d3e 204e 6f6e  ile: str) -> Non
-00013f70: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-00013f80: 2020 2020 2020 2046 696e 6973 6820 7468         Finish th
-00013f90: 6520 7370 7574 7465 7220 7072 6f63 6573  e sputter proces
-00013fa0: 7320 6279 2063 6c65 6172 696e 6720 7061  s by clearing pa
-00013fb0: 7474 6572 6e73 2061 6e64 2072 6573 6574  tterns and reset
-00013fc0: 7469 6e67 2062 6561 6d20 616e 6420 696d  ting beam and im
-00013fd0: 6167 696e 6720 7365 7474 696e 6773 2e0a  aging settings..
-00013fe0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00013ff0: 2020 2020 2020 2020 2020 2061 7070 6c69             appli
-00014000: 6361 7469 6f6e 5f66 696c 6520 2873 7472  cation_file (str
-00014010: 293a 2054 6865 2070 6174 6820 746f 2074  ): The path to t
-00014020: 6865 2064 6566 6175 6c74 2061 7070 6c69  he default appli
-00014030: 6361 7469 6f6e 2066 696c 6520 746f 2075  cation file to u
-00014040: 7365 2e0a 0a20 2020 2020 2020 2052 6574  se...        Ret
-00014050: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-00014060: 2020 4e6f 6e65 0a0a 2020 2020 2020 2020    None..        
-00014070: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
-00014080: 2020 2020 4e6f 6e65 0a0a 2020 2020 2020      None..      
-00014090: 2020 4e6f 7465 733a 0a20 2020 2020 2020    Notes:.       
-000140a0: 2020 2020 2054 6869 7320 6675 6e63 7469       This functi
-000140b0: 6f6e 2066 696e 6973 6865 7320 7468 6520  on finishes the 
-000140c0: 7370 7574 7465 7220 7072 6f63 6573 7320  sputter process 
-000140d0: 6279 2063 6c65 6172 696e 6720 616e 7920  by clearing any 
-000140e0: 7265 6d61 696e 696e 6720 7061 7474 6572  remaining patter
-000140f0: 6e73 2061 6e64 2072 6573 746f 7269 6e67  ns and restoring
-00014100: 2074 6865 2062 6561 6d20 616e 6420 696d   the beam and im
-00014110: 6167 696e 6720 7365 7474 696e 6773 2074  aging settings t
-00014120: 6f20 7468 6569 720a 2020 2020 2020 2020  o their.        
-00014130: 2020 2020 6f72 6967 696e 616c 2073 7461      original sta
-00014140: 7465 2e20 4974 2073 6574 7320 7468 6520  te. It sets the 
-00014150: 6265 616d 2063 7572 7265 6e74 2062 6163  beam current bac
-00014160: 6b20 746f 2069 6d61 6769 6e67 2063 7572  k to imaging cur
-00014170: 7265 6e74 2061 6e64 2073 6574 7320 7468  rent and sets th
-00014180: 6520 6465 6661 756c 7420 6265 616d 2074  e default beam t
-00014190: 7970 6520 746f 2069 6f6e 2062 6561 6d2e  ype to ion beam.
-000141a0: 0a20 2020 2020 2020 2020 2020 2049 7420  .            It 
-000141b0: 616c 736f 2072 6574 7261 6374 7320 7468  also retracts th
-000141c0: 6520 6d75 6c74 6963 6865 6d20 616e 6420  e multichem and 
-000141d0: 6c6f 6773 2074 6861 7420 7468 6520 7370  logs that the sp
-000141e0: 7574 7465 7269 6e67 2070 726f 6365 7373  uttering process
-000141f0: 2068 6173 2066 696e 6973 6865 642e 0a20   has finished.. 
-00014200: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00014210: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-00014220: 7228 7365 6c66 2e73 7973 7465 6d29 0a20  r(self.system). 
-00014230: 2020 2020 2020 2023 2043 6c65 6172 2061         # Clear a
-00014240: 6e79 2072 656d 6169 6e69 6e67 2070 6174  ny remaining pat
-00014250: 7465 726e 730a 2020 2020 2020 2020 7365  terns.        se
-00014260: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
-00014270: 7474 6572 6e69 6e67 2e63 6c65 6172 5f70  tterning.clear_p
-00014280: 6174 7465 726e 7328 290a 0a20 2020 2020  atterns()..     
-00014290: 2020 2023 2052 6573 746f 7265 2062 6561     # Restore bea
-000142a0: 6d20 616e 6420 696d 6167 696e 6720 7365  m and imaging se
-000142b0: 7474 696e 6773 2074 6f20 7468 6569 7220  ttings to their 
-000142c0: 6f72 6967 696e 616c 2073 7461 7465 0a20  original state. 
-000142d0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000142e0: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
-000142f0: 6374 726f 6e5f 6265 616d 2e75 6e62 6c61  ctron_beam.unbla
-00014300: 6e6b 2829 0a20 2020 2020 2020 2073 656c  nk().        sel
-00014310: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
-00014320: 7465 726e 696e 672e 7365 745f 6465 6661  terning.set_defa
-00014330: 756c 745f 6170 706c 6963 6174 696f 6e5f  ult_application_
-00014340: 6669 6c65 2861 7070 6c69 6361 7469 6f6e  file(application
-00014350: 5f66 696c 6529 0a20 2020 2020 2020 2073  _file).        s
-00014360: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
-00014370: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
-00014380: 655f 7669 6577 2873 656c 662e 6f72 6967  e_view(self.orig
-00014390: 696e 616c 5f61 6374 6976 655f 7669 6577  inal_active_view
-000143a0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-000143b0: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
-000143c0: 6e69 6e67 2e73 6574 5f64 6566 6175 6c74  ning.set_default
-000143d0: 5f62 6561 6d5f 7479 7065 2842 6561 6d54  _beam_type(BeamT
-000143e0: 7970 652e 494f 4e2e 7661 6c75 6529 2020  ype.ION.value)  
-000143f0: 2320 7365 7420 696f 6e20 6265 616d 0a20  # set ion beam. 
-00014400: 2020 2020 2020 2073 656c 662e 6d75 6c74         self.mult
-00014410: 6963 6865 6d2e 7265 7472 6163 7428 290a  ichem.retract().
-00014420: 0a20 2020 2020 2020 2023 204c 6f67 2074  .        # Log t
-00014430: 6861 7420 7468 6520 7370 7574 7465 7269  hat the sputteri
-00014440: 6e67 2070 726f 6365 7373 2068 6173 2066  ng process has f
-00014450: 696e 6973 6865 640a 2020 2020 2020 2020  inished.        
-00014460: 6c6f 6767 696e 672e 696e 666f 2822 506c  logging.info("Pl
-00014470: 6174 696e 756d 2073 7075 7474 6572 696e  atinum sputterin
-00014480: 6720 7072 6f63 6573 7320 636f 6d70 6c65  g process comple
-00014490: 7465 642e 2229 0a0a 2020 2020 2320 6465  ted.")..    # de
-000144a0: 6620 7365 7475 705f 4749 5328 7365 6c66  f setup_GIS(self
-000144b0: 2c70 726f 746f 636f 6c29 3a0a 0a20 2020  ,protocol):..   
-000144c0: 2023 2020 2020 2062 6561 6d74 7970 655f   #     beamtype_
-000144d0: 7661 6c75 6520 3d20 4265 616d 5479 7065  value = BeamType
-000144e0: 2e45 4c45 4354 524f 4e2e 7661 6c75 6520  .ELECTRON.value 
-000144f0: 6966 2070 726f 746f 636f 6c5b 2262 6561  if protocol["bea
-00014500: 6d5f 7479 7065 225d 203d 3d20 2265 6c65  m_type"] == "ele
-00014510: 6374 726f 6e22 2065 6c73 6520 4265 616d  ctron" else Beam
-00014520: 5479 7065 2e49 4f4e 2e76 616c 7565 0a0a  Type.ION.value..
-00014530: 2020 2020 2320 2020 2020 5f63 6865 636b      #     _check
-00014540: 5f73 7075 7474 6572 2873 656c 662e 7379  _sputter(self.sy
-00014550: 7374 656d 290a 2020 2020 2320 2020 2020  stem).    #     
-00014560: 7365 6c66 2e6f 7269 6769 6e61 6c5f 6163  self.original_ac
-00014570: 7469 7665 5f76 6965 7720 3d20 7365 6c66  tive_view = self
-00014580: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
-00014590: 696e 672e 6765 745f 6163 7469 7665 5f76  ing.get_active_v
-000145a0: 6965 7728 290a 2020 2020 2320 2020 2020  iew().    #     
-000145b0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-000145c0: 696d 6167 696e 672e 7365 745f 6163 7469  imaging.set_acti
-000145d0: 7665 5f76 6965 7728 6265 616d 7479 7065  ve_view(beamtype
-000145e0: 5f76 616c 7565 290a 2020 2020 2320 2020  _value).    #   
-000145f0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00014600: 6e2e 7061 7474 6572 6e69 6e67 2e63 6c65  n.patterning.cle
-00014610: 6172 5f70 6174 7465 726e 7328 290a 2020  ar_patterns().  
-00014620: 2020 2320 2020 2020 7365 6c66 2e63 6f6e    #     self.con
-00014630: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-00014640: 6e67 2e73 6574 5f64 6566 6175 6c74 5f61  ng.set_default_a
-00014650: 7070 6c69 6361 7469 6f6e 5f66 696c 6528  pplication_file(
-00014660: 7072 6f74 6f63 6f6c 5b22 6170 706c 6963  protocol["applic
-00014670: 6174 696f 6e5f 6669 6c65 225d 290a 2020  ation_file"]).  
-00014680: 2020 2320 2020 2020 7365 6c66 2e63 6f6e    #     self.con
-00014690: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-000146a0: 6e67 2e73 6574 5f64 6566 6175 6c74 5f62  ng.set_default_b
-000146b0: 6561 6d5f 7479 7065 2862 6561 6d74 7970  eam_type(beamtyp
-000146c0: 655f 7661 6c75 6529 0a0a 2020 2020 2320  e_value)..    # 
-000146d0: 2020 2020 6769 735f 6c69 6e65 203d 2070      gis_line = p
-000146e0: 726f 746f 636f 6c5b 2267 6173 225d 0a20  rotocol["gas"]. 
-000146f0: 2020 2023 2020 2020 2070 6f72 7420 3d20     #     port = 
-00014700: 7365 6c66 2e67 6973 5f6c 696e 6573 5b67  self.gis_lines[g
-00014710: 6973 5f6c 696e 655d 0a20 2020 2023 2020  is_line].    #  
-00014720: 2020 2069 6620 7365 6c66 2e47 4953 5f70     if self.GIS_p
-00014730: 6f73 6974 696f 6e28 6769 735f 6c69 6e65  osition(gis_line
-00014740: 2920 3d3d 2022 5265 7472 6163 7465 6422  ) == "Retracted"
-00014750: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
-00014760: 706f 7274 2e69 6e73 6572 7428 290a 0a20  port.insert().. 
-00014770: 2020 2023 2020 2020 2069 6620 7365 6c66     #     if self
-00014780: 2e47 4953 5f74 656d 705f 7265 6164 7928  .GIS_temp_ready(
-00014790: 6769 735f 6c69 6e65 2920 3d3d 2046 616c  gis_line) == Fal
-000147a0: 7365 3a0a 2020 2020 2320 2020 2020 2020  se:.    #       
-000147b0: 2020 7365 6c66 2e47 4953 5f68 6561 745f    self.GIS_heat_
-000147c0: 7570 2867 6973 5f6c 696e 6529 0a0a 0a20  up(gis_line)... 
-000147d0: 2020 2023 2064 6566 2073 6574 7570 5f47     # def setup_G
-000147e0: 4953 5f70 6174 7465 726e 2873 656c 662c  IS_pattern(self,
-000147f0: 7072 6f74 6f63 6f6c 293a 0a0a 2020 2020  protocol):..    
-00014800: 2320 2020 2020 6866 7720 3d20 7072 6f74  #     hfw = prot
-00014810: 6f63 6f6c 5b22 6866 7722 5d0a 2020 2020  ocol["hfw"].    
-00014820: 2320 2020 2020 6c69 6e65 5f70 6174 7465  #     line_patte
-00014830: 726e 5f6c 656e 6774 6820 3d20 7072 6f74  rn_length = prot
-00014840: 6f63 6f6c 5b22 6c65 6e67 7468 225d 0a20  ocol["length"]. 
-00014850: 2020 2023 2020 2020 2073 7075 7474 6572     #     sputter
-00014860: 5f74 696d 6520 3d20 7072 6f74 6f63 6f6c  _time = protocol
-00014870: 5b22 7370 7574 7465 725f 7469 6d65 225d  ["sputter_time"]
-00014880: 0a0a 2020 2020 2320 2020 2020 7365 6c66  ..    #     self
-00014890: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
-000148a0: 732e 656c 6563 7472 6f6e 5f62 6561 6d2e  s.electron_beam.
-000148b0: 686f 7269 7a6f 6e74 616c 5f66 6965 6c64  horizontal_field
-000148c0: 5f77 6964 7468 2e76 616c 7565 203d 2068  _width.value = h
-000148d0: 6677 0a20 2020 2023 2020 2020 2070 6174  fw.    #     pat
-000148e0: 7465 726e 203d 2073 656c 662e 636f 6e6e  tern = self.conn
-000148f0: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
-00014900: 672e 6372 6561 7465 5f6c 696e 6528 0a20  g.create_line(. 
-00014910: 2020 2023 2020 2020 2020 2020 202d 6c69     #         -li
-00014920: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
-00014930: 6820 2f20 322c 2020 2320 785f 7374 6172  h / 2,  # x_star
-00014940: 740a 2020 2020 2320 2020 2020 2020 2020  t.    #         
-00014950: 2b6c 696e 655f 7061 7474 6572 6e5f 6c65  +line_pattern_le
-00014960: 6e67 7468 2c20 2023 2079 5f73 7461 7274  ngth,  # y_start
-00014970: 0a20 2020 2023 2020 2020 2020 2020 202b  .    #         +
-00014980: 6c69 6e65 5f70 6174 7465 726e 5f6c 656e  line_pattern_len
-00014990: 6774 6820 2f20 322c 2020 2320 785f 656e  gth / 2,  # x_en
-000149a0: 640a 2020 2020 2320 2020 2020 2020 2020  d.    #         
-000149b0: 2b6c 696e 655f 7061 7474 6572 6e5f 6c65  +line_pattern_le
-000149c0: 6e67 7468 2c20 2023 2079 5f65 6e64 0a20  ngth,  # y_end. 
-000149d0: 2020 2023 2020 2020 2020 2020 2032 652d     #         2e-
-000149e0: 362c 0a20 2020 2023 2020 2020 2029 2020  6,.    #     )  
-000149f0: 2320 6d69 6c6c 696e 6720 6465 7074 680a  # milling depth.
-00014a00: 2020 2020 2320 2020 2020 7061 7474 6572      #     patter
-00014a10: 6e2e 7469 6d65 203d 2073 7075 7474 6572  n.time = sputter
-00014a20: 5f74 696d 6520 0a0a 2020 2020 2320 6465  _time ..    # de
-00014a30: 6620 7275 6e5f 4749 5328 7365 6c66 2c70  f run_GIS(self,p
-00014a40: 726f 746f 636f 6c29 3a0a 0a20 2020 2023  rotocol):..    #
-00014a50: 2020 2020 2067 6973 5f6c 696e 6520 3d20       gis_line = 
-00014a60: 7072 6f74 6f63 6f6c 5b22 6761 7322 5d0a  protocol["gas"].
-00014a70: 2020 2020 2320 2020 2020 7370 7574 7465      #     sputte
-00014a80: 725f 7469 6d65 203d 2070 726f 746f 636f  r_time = protoco
-00014a90: 6c5b 2273 7075 7474 6572 5f74 696d 6522  l["sputter_time"
-00014aa0: 5d0a 0a20 2020 2023 2020 2020 2062 6c61  ]..    #     bla
-00014ab0: 6e6b 203d 7072 6f74 6f63 6f6c 5b22 626c  nk =protocol["bl
-00014ac0: 616e 6b5f 6265 616d 225d 0a0a 2020 2020  ank_beam"]..    
-00014ad0: 2320 2020 2020 7072 696e 7428 6622 626c  #     print(f"bl
-00014ae0: 616e 6b20 6265 616d 3a20 7b62 6c61 6e6b  ank beam: {blank
-00014af0: 7d22 2920 0a0a 2020 2020 2320 2020 2020  }") ..    #     
-00014b00: 6966 2070 726f 746f 636f 6c5b 2262 6c61  if protocol["bla
-00014b10: 6e6b 5f62 6561 6d22 5d3a 0a20 2020 2023  nk_beam"]:.    #
-00014b20: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00014b30: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e65  nnection.beams.e
-00014b40: 6c65 6374 726f 6e5f 6265 616d 2e62 6c61  lectron_beam.bla
-00014b50: 6e6b 2829 0a0a 0a20 2020 2023 2020 2020  nk()...    #    
-00014b60: 2069 6620 7365 6c66 2e63 6f6e 6e65 6374   if self.connect
-00014b70: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
-00014b80: 7461 7465 203d 3d20 2249 646c 6522 3a0a  tate == "Idle":.
-00014b90: 2020 2020 2320 2020 2020 2020 2020 6c6f      #         lo
-00014ba0: 6767 696e 672e 696e 666f 2866 2253 7075  gging.info(f"Spu
-00014bb0: 7474 6572 696e 6720 7769 7468 207b 6769  ttering with {gi
-00014bc0: 735f 6c69 6e65 7d20 666f 7220 7b73 7075  s_line} for {spu
-00014bd0: 7474 6572 5f74 696d 657d 2073 6563 6f6e  tter_time} secon
-00014be0: 6473 2e2e 2e22 290a 2020 2020 2320 2020  ds...").    #   
-00014bf0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00014c00: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
-00014c10: 2e73 7461 7274 2829 2020 2320 6173 796e  .start()  # asyn
-00014c20: 6368 726f 6e6f 7573 2070 6174 7465 726e  chronous pattern
-00014c30: 696e 670a 2020 2020 2320 2020 2020 2020  ing.    #       
-00014c40: 2020 7469 6d65 2e73 6c65 6570 2873 7075    time.sleep(spu
-00014c50: 7474 6572 5f74 696d 6520 2b20 3529 0a20  tter_time + 5). 
-00014c60: 2020 2023 2020 2020 2065 6c73 653a 0a20     #     else:. 
-00014c70: 2020 2023 2020 2020 2020 2020 2072 6169     #         rai
-00014c80: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-00014c90: 2243 616e 2774 2073 7075 7474 6572 2c20  "Can't sputter, 
-00014ca0: 7061 7474 6572 6e69 6e67 2073 7461 7465  patterning state
-00014cb0: 2069 7320 6e6f 7420 7265 6164 792e 2229   is not ready.")
-00014cc0: 0a20 2020 2023 2020 2020 2069 6620 7365  .    #     if se
-00014cd0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
-00014ce0: 7474 6572 6e69 6e67 2e73 7461 7465 203d  tterning.state =
-00014cf0: 3d20 2252 756e 6e69 6e67 223a 0a20 2020  = "Running":.   
-00014d00: 2023 2020 2020 2020 2020 2073 656c 662e   #         self.
-00014d10: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-00014d20: 726e 696e 672e 7374 6f70 2829 0a20 2020  rning.stop().   
-00014d30: 2023 2020 2020 2020 2020 206c 6f67 6769   #         loggi
-00014d40: 6e67 2e69 6e66 6f28 6622 4669 6e69 7368  ng.info(f"Finish
-00014d50: 6564 2073 7075 7474 6572 696e 6720 7769  ed sputtering wi
-00014d60: 7468 207b 6769 735f 6c69 6e65 7d22 290a  th {gis_line}").
-00014d70: 2020 2020 2320 2020 2020 656c 7365 3a0a      #     else:.
-00014d80: 2020 2020 2320 2020 2020 2020 2020 6c6f      #         lo
-00014d90: 6767 696e 672e 7761 726e 696e 6728 6622  gging.warning(f"
-00014da0: 5061 7474 6572 6e69 6e67 2073 7461 7465  Patterning state
-00014db0: 2069 7320 7b73 656c 662e 636f 6e6e 6563   is {self.connec
-00014dc0: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
-00014dd0: 7374 6174 657d 2229 0a20 2020 2023 2020  state}").    #  
-00014de0: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
-00014df0: 6172 6e69 6e67 2822 436f 6e73 6964 6572  arning("Consider
-00014e00: 2061 646a 7573 7469 6e67 2074 6865 2070   adjusting the p
-00014e10: 6174 7465 726e 696e 6720 6c69 6e65 2064  atterning line d
-00014e20: 6570 7468 2e22 290a 0a0a 2020 2020 2320  epth.")...    # 
-00014e30: 6465 6620 7275 6e5f 4d75 6c74 6963 6865  def run_Multiche
-00014e40: 6d28 7365 6c66 2c70 726f 746f 636f 6c29  m(self,protocol)
-00014e50: 3a0a 0a20 2020 2023 2020 2020 205f 6368  :..    #     _ch
-00014e60: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
-00014e70: 2e73 7973 7465 6d29 0a20 2020 2023 2020  .system).    #  
-00014e80: 2020 2073 656c 662e 6f72 6967 696e 616c     self.original
-00014e90: 5f61 6374 6976 655f 7669 6577 203d 2073  _active_view = s
-00014ea0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
-00014eb0: 6d61 6769 6e67 2e67 6574 5f61 6374 6976  maging.get_activ
-00014ec0: 655f 7669 6577 2829 0a20 2020 2023 2020  e_view().    #  
-00014ed0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00014ee0: 6f6e 2e69 6d61 6769 6e67 2e73 6574 5f61  on.imaging.set_a
-00014ef0: 6374 6976 655f 7669 6577 2842 6561 6d54  ctive_view(BeamT
-00014f00: 7970 652e 454c 4543 5452 4f4e 2e76 616c  ype.ELECTRON.val
-00014f10: 7565 290a 2020 2020 2320 2020 2020 7365  ue).    #     se
-00014f20: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
-00014f30: 7474 6572 6e69 6e67 2e63 6c65 6172 5f70  tterning.clear_p
-00014f40: 6174 7465 726e 7328 290a 2020 2020 2320  atterns().    # 
-00014f50: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00014f60: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
-00014f70: 6574 5f64 6566 6175 6c74 5f61 7070 6c69  et_default_appli
-00014f80: 6361 7469 6f6e 5f66 696c 6528 7072 6f74  cation_file(prot
-00014f90: 6f63 6f6c 5b22 6170 706c 6963 6174 696f  ocol["applicatio
-00014fa0: 6e5f 6669 6c65 225d 290a 2020 2020 2320  n_file"]).    # 
-00014fb0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00014fc0: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
-00014fd0: 6574 5f64 6566 6175 6c74 5f62 6561 6d5f  et_default_beam_
-00014fe0: 7479 7065 2842 6561 6d54 7970 652e 454c  type(BeamType.EL
-00014ff0: 4543 5452 4f4e 2e76 616c 7565 290a 0a20  ECTRON.value).. 
-00015000: 2020 2023 2020 2020 206d 635f 6c69 6e65     #     mc_line
-00015010: 203d 2070 726f 746f 636f 6c5b 2267 6173   = protocol["gas
-00015020: 225d 0a20 2020 2023 2020 2020 2070 6f72  "].    #     por
-00015030: 7420 3d20 7365 6c66 2e6d 756c 7469 6368  t = self.multich
-00015040: 656d 0a20 2020 2023 2020 2020 2069 6620  em.    #     if 
-00015050: 7365 6c66 2e6d 756c 7469 6368 656d 5f70  self.multichem_p
-00015060: 6f73 6974 696f 6e28 2920 3d3d 2022 5265  osition() == "Re
-00015070: 7472 6163 7465 6422 3a0a 2020 2020 2320  tracted":.    # 
-00015080: 2020 2020 2020 2020 706f 7274 2e69 6e73          port.ins
-00015090: 6572 7428 290a 0a20 2020 2023 2020 2020  ert()..    #    
-000150a0: 2069 6620 7365 6c66 2e6d 756c 7469 6368   if self.multich
-000150b0: 656d 5f74 656d 705f 7265 6164 7928 6d63  em_temp_ready(mc
-000150c0: 5f6c 696e 6529 203d 3d20 4661 6c73 653a  _line) == False:
-000150d0: 0a20 2020 2023 2020 2020 2020 2020 2073  .    #         s
-000150e0: 656c 662e 6d75 6c74 6963 6865 6d5f 6865  elf.multichem_he
-000150f0: 6174 5f75 7028 6d63 5f6c 696e 6529 0a0a  at_up(mc_line)..
-00015100: 2020 2020 2320 2020 2020 6866 7720 3d20      #     hfw = 
-00015110: 7072 6f74 6f63 6f6c 5b22 6866 7722 5d0a  protocol["hfw"].
-00015120: 2020 2020 2320 2020 2020 6c69 6e65 5f70      #     line_p
-00015130: 6174 7465 726e 5f6c 656e 6774 6820 3d20  attern_length = 
-00015140: 7072 6f74 6f63 6f6c 5b22 6c65 6e67 7468  protocol["length
-00015150: 225d 0a20 2020 2023 2020 2020 2073 7075  "].    #     spu
-00015160: 7474 6572 5f74 696d 6520 3d20 7072 6f74  tter_time = prot
-00015170: 6f63 6f6c 5b22 7370 7574 7465 725f 7469  ocol["sputter_ti
-00015180: 6d65 225d 0a0a 2020 2020 2320 2020 2020  me"]..    #     
-00015190: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-000151a0: 6265 616d 732e 656c 6563 7472 6f6e 5f62  beams.electron_b
-000151b0: 6561 6d2e 686f 7269 7a6f 6e74 616c 5f66  eam.horizontal_f
-000151c0: 6965 6c64 5f77 6964 7468 2e76 616c 7565  ield_width.value
-000151d0: 203d 2068 6677 0a20 2020 2023 2020 2020   = hfw.    #    
-000151e0: 2070 6174 7465 726e 203d 2073 656c 662e   pattern = self.
-000151f0: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-00015200: 726e 696e 672e 6372 6561 7465 5f6c 696e  rning.create_lin
-00015210: 6528 0a20 2020 2023 2020 2020 2020 2020  e(.    #        
-00015220: 202d 6c69 6e65 5f70 6174 7465 726e 5f6c   -line_pattern_l
-00015230: 656e 6774 6820 2f20 322c 2020 2320 785f  ength / 2,  # x_
-00015240: 7374 6172 740a 2020 2020 2320 2020 2020  start.    #     
-00015250: 2020 2020 2b6c 696e 655f 7061 7474 6572      +line_patter
-00015260: 6e5f 6c65 6e67 7468 2c20 2023 2079 5f73  n_length,  # y_s
-00015270: 7461 7274 0a20 2020 2023 2020 2020 2020  tart.    #      
-00015280: 2020 202b 6c69 6e65 5f70 6174 7465 726e     +line_pattern
-00015290: 5f6c 656e 6774 6820 2f20 322c 2020 2320  _length / 2,  # 
-000152a0: 785f 656e 640a 2020 2020 2320 2020 2020  x_end.    #     
-000152b0: 2020 2020 2b6c 696e 655f 7061 7474 6572      +line_patter
-000152c0: 6e5f 6c65 6e67 7468 2c20 2023 2079 5f65  n_length,  # y_e
-000152d0: 6e64 0a20 2020 2023 2020 2020 2020 2020  nd.    #        
-000152e0: 2032 652d 362c 0a20 2020 2023 2020 2020   2e-6,.    #    
-000152f0: 2029 2020 2320 6d69 6c6c 696e 6720 6465   )  # milling de
-00015300: 7074 680a 2020 2020 2320 2020 2020 2320  pth.    #     # 
-00015310: 7061 7474 6572 6e2e 7469 6d65 203d 2073  pattern.time = s
-00015320: 7075 7474 6572 5f74 696d 6520 2b20 302e  putter_time + 0.
-00015330: 310a 2020 2020 2320 2020 2020 7061 7474  1.    #     patt
-00015340: 6572 6e2e 7469 6d65 203d 2073 7075 7474  ern.time = sputt
-00015350: 6572 5f74 696d 650a 0a20 2020 2023 2020  er_time..    #  
-00015360: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-00015370: 6f6e 2e62 6561 6d73 2e65 6c65 6374 726f  on.beams.electro
-00015380: 6e5f 6265 616d 2e62 6c61 6e6b 2829 0a20  n_beam.blank(). 
-00015390: 2020 2023 2020 2020 2023 2070 6f72 742e     #     # port.
-000153a0: 6c69 6e65 2e6f 7065 6e28 290a 2020 2020  line.open().    
-000153b0: 2320 2020 2020 6966 2073 656c 662e 636f  #     if self.co
-000153c0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
-000153d0: 696e 672e 7374 6174 6520 3d3d 2022 4964  ing.state == "Id
-000153e0: 6c65 223a 0a20 2020 2023 2020 2020 2020  le":.    #      
-000153f0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00015400: 6622 5370 7574 7465 7269 6e67 2077 6974  f"Sputtering wit
-00015410: 6820 7b6d 635f 6c69 6e65 7d20 666f 7220  h {mc_line} for 
-00015420: 7b73 7075 7474 6572 5f74 696d 657d 2073  {sputter_time} s
-00015430: 6563 6f6e 6473 2e2e 2e22 290a 2020 2020  econds...").    
-00015440: 2320 2020 2020 2020 2020 7365 6c66 2e63  #         self.c
-00015450: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
-00015460: 6e69 6e67 2e73 7461 7274 2829 2020 2320  ning.start()  # 
-00015470: 6173 796e 6368 726f 6e6f 7573 2070 6174  asynchronous pat
-00015480: 7465 726e 696e 670a 2020 2020 2320 2020  terning.    #   
-00015490: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
-000154a0: 2873 7075 7474 6572 5f74 696d 6520 2b20  (sputter_time + 
-000154b0: 3529 0a20 2020 2023 2020 2020 2065 6c73  5).    #     els
-000154c0: 653a 0a20 2020 2023 2020 2020 2020 2020  e:.    #        
-000154d0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-000154e0: 726f 7228 2243 616e 2774 2073 7075 7474  ror("Can't sputt
-000154f0: 6572 2070 6c61 7469 6e75 6d2c 2070 6174  er platinum, pat
-00015500: 7465 726e 696e 6720 7374 6174 6520 6973  terning state is
-00015510: 206e 6f74 2072 6561 6479 2e22 290a 2020   not ready.").  
-00015520: 2020 2320 2020 2020 6966 2073 656c 662e    #     if self.
-00015530: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-00015540: 726e 696e 672e 7374 6174 6520 3d3d 2022  rning.state == "
-00015550: 5275 6e6e 696e 6722 3a0a 2020 2020 2320  Running":.    # 
-00015560: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00015570: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
-00015580: 6e67 2e73 746f 7028 290a 2020 2020 2320  ng.stop().    # 
-00015590: 2020 2020 656c 7365 3a0a 2020 2020 2320      else:.    # 
-000155a0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-000155b0: 7761 726e 696e 6728 6622 5061 7474 6572  warning(f"Patter
-000155c0: 6e69 6e67 2073 7461 7465 2069 7320 7b73  ning state is {s
-000155d0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
-000155e0: 6174 7465 726e 696e 672e 7374 6174 657d  atterning.state}
-000155f0: 2229 0a20 2020 2023 2020 2020 2020 2020  ").    #        
-00015600: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
-00015610: 2822 436f 6e73 6964 6572 2061 646a 7573  ("Consider adjus
-00015620: 7469 6e67 2074 6865 2070 6174 7465 726e  ting the pattern
-00015630: 696e 6720 6c69 6e65 2064 6570 7468 2e22  ing line depth."
-00015640: 290a 2020 2020 2320 2020 2020 2320 706f  ).    #     # po
-00015650: 7274 2e6c 696e 652e 636c 6f73 6528 290a  rt.line.close().
-00015660: 0a20 2020 2023 2020 2020 2073 656c 662e  .    #     self.
-00015670: 6d75 6c74 6963 6865 6d2e 6c69 6e65 2e74  multichem.line.t
-00015680: 7572 6e5f 6865 6174 6572 5f6f 6666 286d  urn_heater_off(m
-00015690: 635f 6c69 6e65 290a 0a0a 0a0a 0a20 2020  c_line)......   
-000156a0: 2023 2064 6566 2047 4953 5f61 7661 696c   # def GIS_avail
-000156b0: 6162 6c65 5f6c 696e 6573 2873 656c 6629  able_lines(self)
-000156c0: 202d 3e20 6c69 7374 5b73 7472 5d3a 0a20   -> list[str]:. 
-000156d0: 2020 2023 2020 2020 2022 2222 0a20 2020     #     """.   
-000156e0: 2023 2020 2020 2052 6574 7572 6e73 2061   #     Returns a
-000156f0: 206c 6973 7420 6f66 2061 7661 696c 6162   list of availab
-00015700: 6c65 2047 4953 206c 696e 6573 2e0a 2020  le GIS lines..  
-00015710: 2020 2320 2020 2020 4172 6773 3a0a 2020    #     Args:.  
-00015720: 2020 2320 2020 2020 2020 2020 4e6f 6e65    #         None
-00015730: 0a20 2020 2023 2020 2020 2052 6574 7572  .    #     Retur
-00015740: 6e73 3a0a 2020 2020 2320 2020 2020 2020  ns:.    #       
-00015750: 2020 4469 6374 696f 6e61 7279 206f 6620    Dictionary of 
-00015760: 6176 6169 6c61 626c 6520 4749 5320 6c69  available GIS li
-00015770: 6e65 732e 0a20 2020 2023 2020 2020 204e  nes..    #     N
-00015780: 6f74 6573 3a0a 2020 2020 2320 2020 2020  otes:.    #     
-00015790: 2020 2020 4e6f 6e65 0a20 2020 2023 2020      None.    #  
-000157a0: 2020 2022 2222 0a20 2020 2023 2020 2020     """.    #    
-000157b0: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
-000157c0: 7365 6c66 2e73 7973 7465 6d29 0a0a 2020  self.system)..  
-000157d0: 2020 2320 2020 2020 6769 735f 6c69 7374    #     gis_list
-000157e0: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-000157f0: 6f6e 2e67 6173 2e6c 6973 745f 616c 6c5f  on.gas.list_all_
-00015800: 6769 735f 706f 7274 7328 290a 0a20 2020  gis_ports()..   
-00015810: 2023 2020 2020 2073 656c 662e 6769 735f   #     self.gis_
-00015820: 6c69 6e65 7320 3d20 7b7d 0a0a 0a20 2020  lines = {}...   
-00015830: 2023 2020 2020 2066 6f72 206c 696e 6520   #     for line 
-00015840: 696e 2067 6973 5f6c 6973 743a 0a0a 2020  in gis_list:..  
-00015850: 2020 2320 2020 2020 2020 2020 6769 735f    #         gis_
-00015860: 706f 7274 203d 2054 6865 726d 6f47 4953  port = ThermoGIS
-00015870: 4c69 6e65 2873 656c 662e 636f 6e6e 6563  Line(self.connec
-00015880: 7469 6f6e 2e67 6173 2e67 6574 5f67 6973  tion.gas.get_gis
-00015890: 5f70 6f72 7428 6c69 6e65 292c 6e61 6d65  _port(line),name
-000158a0: 3d6c 696e 652c 7374 6174 7573 3d22 5265  =line,status="Re
-000158b0: 7472 6163 7465 6422 290a 0a20 2020 2023  tracted")..    #
-000158c0: 2020 2020 2020 2020 2073 656c 662e 6769           self.gi
-000158d0: 735f 6c69 6e65 735b 6c69 6e65 5d20 3d20  s_lines[line] = 
-000158e0: 6769 735f 706f 7274 0a0a 0a0a 2020 2020  gis_port....    
-000158f0: 2320 2020 2020 7265 7475 726e 2067 6973  #     return gis
-00015900: 5f6c 6973 740a 0a20 2020 2023 2064 6566  _list..    # def
-00015910: 2047 4953 5f61 7661 696c 6162 6c65 5f70   GIS_available_p
-00015920: 6f73 6974 696f 6e73 2873 656c 6629 202d  ositions(self) -
-00015930: 3e20 6c69 7374 5b73 7472 5d3a 0a20 2020  > list[str]:.   
-00015940: 2023 2020 2020 2022 2222 5265 7475 726e   #     """Return
-00015950: 7320 6120 6c69 7374 206f 6620 6176 6169  s a list of avai
-00015960: 6c61 626c 6520 706f 7369 7469 6f6e 7320  lable positions 
-00015970: 7468 6520 4749 5320 6361 6e20 6d6f 7665  the GIS can move
-00015980: 2074 6f2e 0a20 2020 2023 2020 2020 2052   to..    #     R
-00015990: 6574 7572 6e73 3a0a 2020 2020 2320 2020  eturns:.    #   
-000159a0: 2020 2020 2020 6c69 7374 5b73 7472 5d3a        list[str]:
-000159b0: 2070 6f73 6974 696f 6e73 0a20 2020 2023   positions.    #
-000159c0: 2020 2020 2022 2222 0a0a 2020 2020 2320       """..    # 
-000159d0: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
-000159e0: 6572 2873 656c 662e 7379 7374 656d 290a  er(self.system).
-000159f0: 0a20 2020 2023 2020 2020 2070 6f73 6974  .    #     posit
-00015a00: 696f 6e73 203d 205b 2249 6e73 6572 7422  ions = ["Insert"
-00015a10: 2c20 2252 6574 7261 6374 225d 0a0a 2020  , "Retract"]..  
-00015a20: 2020 2320 2020 2020 7265 7475 726e 2070    #     return p
-00015a30: 6f73 6974 696f 6e73 0a0a 2020 2020 2320  ositions..    # 
-00015a40: 6465 6620 4749 535f 6d6f 7665 5f74 6f28  def GIS_move_to(
-00015a50: 7365 6c66 2c6c 696e 655f 6e61 6d65 3a73  self,line_name:s
-00015a60: 7472 2c70 6f73 6974 696f 6e3a 7374 7229  tr,position:str)
-00015a70: 202d 3e20 4e6f 6e65 3a0a 0a20 2020 2023   -> None:..    #
-00015a80: 2020 2020 2022 2222 4d6f 7665 7320 7468       """Moves th
-00015a90: 6520 4749 5320 746f 2061 2073 7065 6369  e GIS to a speci
-00015aa0: 6669 6564 2070 6f73 6974 696f 6e2e 0a20  fied position.. 
-00015ab0: 2020 2023 2020 2020 204e 6565 6420 746f     #     Need to
-00015ac0: 2073 7065 6369 6679 2074 6865 206c 696e   specify the lin
-00015ad0: 6520 6e61 6d65 2061 6e64 2070 6f73 6974  e name and posit
-00015ae0: 696f 6e20 746f 206d 6f76 6520 746f 2e20  ion to move to. 
-00015af0: 4561 6368 2047 4953 206c 696e 6520 6973  Each GIS line is
-00015b00: 2061 2073 6570 6572 6174 6520 7079 7468   a seperate pyth
-00015b10: 6f6e 206f 626a 6563 740a 2020 2020 2320  on object.    # 
-00015b20: 2020 2020 2222 220a 0a20 2020 2023 2020      """..    #  
-00015b30: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-00015b40: 7228 7365 6c66 2e73 7973 7465 6d29 0a0a  r(self.system)..
-00015b50: 2020 2020 2320 2020 2020 706f 7274 203d      #     port =
-00015b60: 2073 656c 662e 6769 735f 6c69 6e65 735b   self.gis_lines[
-00015b70: 6c69 6e65 5f6e 616d 655d 0a0a 2020 2020  line_name]..    
-00015b80: 2320 2020 2020 6966 2070 6f73 6974 696f  #     if positio
-00015b90: 6e20 3d3d 2022 496e 7365 7274 223a 0a20  n == "Insert":. 
-00015ba0: 2020 2023 2020 2020 2020 2020 2070 6f72     #         por
-00015bb0: 742e 696e 7365 7274 2829 0a20 2020 2023  t.insert().    #
-00015bc0: 2020 2020 2065 6c69 6620 706f 7369 7469       elif positi
-00015bd0: 6f6e 203d 3d20 2252 6574 7261 6374 223a  on == "Retract":
-00015be0: 0a20 2020 2023 2020 2020 2020 2020 2070  .    #         p
-00015bf0: 6f72 742e 7265 7472 6163 7428 290a 0a20  ort.retract().. 
-00015c00: 2020 2023 2064 6566 2047 4953 5f70 6f73     # def GIS_pos
-00015c10: 6974 696f 6e28 7365 6c66 2c6c 696e 6529  ition(self,line)
-00015c20: 202d 3e20 7374 723a 0a20 2020 2023 2020   -> str:.    #  
-00015c30: 2020 2022 2222 0a20 2020 2023 2020 2020     """.    #    
-00015c40: 2052 6574 7572 6e73 2074 6865 2063 7572   Returns the cur
-00015c50: 7265 6e74 2070 6f73 6974 696f 6e20 6f66  rent position of
-00015c60: 2074 6865 2047 4953 206c 696e 652e 0a20   the GIS line.. 
-00015c70: 2020 2023 2020 2020 2022 2222 0a0a 2020     #     """..  
-00015c80: 2020 2320 2020 2020 5f63 6865 636b 5f73    #     _check_s
-00015c90: 7075 7474 6572 2873 656c 662e 7379 7374  putter(self.syst
-00015ca0: 656d 290a 0a20 2020 2023 2020 2020 2070  em)..    #     p
-00015cb0: 6f72 7420 3d20 7365 6c66 2e67 6973 5f6c  ort = self.gis_l
-00015cc0: 696e 6573 5b6c 696e 655d 0a0a 2020 2020  ines[line]..    
-00015cd0: 2320 2020 2020 7265 7475 726e 2070 6f72  #     return por
-00015ce0: 742e 7374 6174 7573 0a0a 2020 2020 2320  t.status..    # 
-00015cf0: 6465 6620 4749 535f 6865 6174 5f75 7028  def GIS_heat_up(
-00015d00: 7365 6c66 2c6c 696e 6529 3a0a 0a20 2020  self,line):..   
-00015d10: 2023 2020 2020 2022 2222 4865 6174 7320   #     """Heats 
-00015d20: 7570 2074 6865 2073 7065 6369 6669 6564  up the specified
-00015d30: 2047 4953 206c 696e 650a 2020 2020 2320   GIS line.    # 
-00015d40: 2020 2020 446f 6573 2074 6869 7320 6279      Does this by
-00015d50: 2074 7572 6e69 6e67 2074 6865 2068 6561   turning the hea
-00015d60: 7465 7220 6f6e 2066 6f72 2033 2073 6563  ter on for 3 sec
-00015d70: 6f6e 6473 2061 6e64 2074 6865 6e20 6f66  onds and then of
-00015d80: 662e 0a20 2020 2023 2020 2020 2049 6620  f..    #     If 
-00015d90: 7468 6973 2070 726f 6365 6475 7265 2068  this procedure h
-00015da0: 6173 2062 6565 6e20 646f 6e65 206f 6e63  as been done onc
-00015db0: 652c 2069 7420 6973 2063 6f6e 7369 6465  e, it is conside
-00015dc0: 7265 6420 7465 6d70 5f72 6561 6479 0a20  red temp_ready. 
-00015dd0: 2020 2023 2020 2020 2022 2222 0a0a 2020     #     """..  
-00015de0: 2020 2320 2020 2020 5f63 6865 636b 5f73    #     _check_s
-00015df0: 7075 7474 6572 2873 656c 662e 7379 7374  putter(self.syst
-00015e00: 656d 290a 0a20 2020 2023 2020 2020 2070  em)..    #     p
-00015e10: 6f72 7420 3d20 7365 6c66 2e67 6973 5f6c  ort = self.gis_l
-00015e20: 696e 6573 5b6c 696e 655d 0a0a 2020 2020  ines[line]..    
-00015e30: 2320 2020 2020 706f 7274 2e6c 696e 652e  #     port.line.
-00015e40: 7475 726e 5f68 6561 7465 725f 6f6e 2829  turn_heater_on()
-00015e50: 0a0a 2020 2020 2320 2020 2020 7469 6d65  ..    #     time
-00015e60: 2e73 6c65 6570 2833 290a 0a20 2020 2023  .sleep(3)..    #
-00015e70: 2020 2020 2070 6f72 742e 6c69 6e65 2e74       port.line.t
-00015e80: 7572 6e5f 6865 6174 6572 5f6f 6666 2829  urn_heater_off()
-00015e90: 0a0a 2020 2020 2320 2020 2020 706f 7274  ..    #     port
-00015ea0: 2e74 656d 705f 7265 6164 7920 3d20 5472  .temp_ready = Tr
-00015eb0: 7565 0a0a 2020 2020 2320 6465 6620 4749  ue..    # def GI
-00015ec0: 535f 7465 6d70 5f72 6561 6479 2873 656c  S_temp_ready(sel
-00015ed0: 662c 6c69 6e65 2920 2d3e 2062 6f6f 6c3a  f,line) -> bool:
-00015ee0: 0a0a 2020 2020 2320 2020 2020 2222 2252  ..    #     """R
-00015ef0: 6574 7572 6e73 2069 6620 7468 6520 6865  eturns if the he
-00015f00: 6174 2075 7020 7072 6f63 6564 7572 6520  at up procedure 
-00015f10: 6861 7320 6265 656e 2064 6f6e 652e 2049  has been done. I
-00015f20: 6e74 6572 6e61 6c20 6675 6e63 7469 6f6e  nternal function
-00015f30: 2c20 6e6f 7420 706f 6c6c 6564 2069 6e66  , not polled inf
-00015f40: 6f72 6d61 7469 6f6e 0a20 2020 2023 2020  ormation.    #  
-00015f50: 2020 2020 2020 2066 726f 6d20 7468 6520         from the 
-00015f60: 6861 7264 7761 7265 0a20 2020 2023 2020  hardware.    #  
-00015f70: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00015f80: 2320 2020 2020 2020 2020 5472 7565 2069  #         True i
-00015f90: 6620 7468 6520 6865 6174 2075 7020 7072  f the heat up pr
-00015fa0: 6f63 6564 7572 6520 6861 7320 6265 656e  ocedure has been
-00015fb0: 2064 6f6e 652c 2046 616c 7365 2069 6620   done, False if 
-00015fc0: 6e6f 740a 2020 2020 2320 2020 2020 2222  not.    #     ""
-00015fd0: 220a 0a20 2020 2023 2020 2020 205f 6368  "..    #     _ch
-00015fe0: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
-00015ff0: 2e73 7973 7465 6d29 0a0a 2020 2020 2320  .system)..    # 
-00016000: 2020 2020 706f 7274 203d 2073 656c 662e      port = self.
-00016010: 6769 735f 6c69 6e65 735b 6c69 6e65 5d0a  gis_lines[line].
-00016020: 0a20 2020 2023 2020 2020 2072 6574 7572  .    #     retur
-00016030: 6e20 706f 7274 2e74 656d 705f 7265 6164  n port.temp_read
-00016040: 790a 0a0a 2020 2020 2320 6465 6620 6d75  y...    # def mu
-00016050: 6c74 6963 6865 6d5f 6176 6169 6c61 626c  ltichem_availabl
-00016060: 655f 6c69 6e65 7328 7365 6c66 292d 3e20  e_lines(self)-> 
-00016070: 6c69 7374 5b73 7472 5d3a 0a0a 2020 2020  list[str]:..    
-00016080: 2320 2020 2020 2222 220a 2020 2020 2320  #     """.    # 
-00016090: 2020 2020 5265 7475 726e 7320 6120 6c69      Returns a li
-000160a0: 7374 206f 6620 6176 6169 6c61 626c 6520  st of available 
-000160b0: 6d75 6c74 6963 6865 6d20 6c69 6e65 732e  multichem lines.
-000160c0: 0a20 2020 2023 2020 2020 204c 6973 7420  .    #     List 
-000160d0: 6973 2061 2073 7472 206f 6620 6e61 6d65  is a str of name
-000160e0: 7320 6f66 2074 6865 206c 696e 6573 2222  s of the lines""
-000160f0: 220a 0a20 2020 2023 2020 2020 205f 6368  "..    #     _ch
-00016100: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
-00016110: 2e73 7973 7465 6d29 0a0a 2020 2020 2320  .system)..    # 
-00016120: 2020 2020 7365 6c66 2e6d 756c 7469 6368      self.multich
-00016130: 656d 203d 2054 6865 726d 6f4d 756c 7469  em = ThermoMulti
-00016140: 4368 656d 4c69 6e65 2873 656c 662e 636f  ChemLine(self.co
-00016150: 6e6e 6563 7469 6f6e 2e67 6173 2e67 6574  nnection.gas.get
-00016160: 5f6d 756c 7469 6368 656d 2829 290a 0a20  _multichem()).. 
-00016170: 2020 2023 2020 2020 2073 656c 662e 6d63     #     self.mc
-00016180: 5f6c 696e 6573 203d 2073 656c 662e 6d75  _lines = self.mu
-00016190: 6c74 6963 6865 6d2e 6c69 6e65 2e6c 6973  ltichem.line.lis
-000161a0: 745f 616c 6c5f 6761 7365 7328 290a 0a20  t_all_gases().. 
-000161b0: 2020 2023 2020 2020 2073 656c 662e 6d63     #     self.mc
-000161c0: 5f6c 696e 6573 5f74 656d 7020 3d7b 7d0a  _lines_temp ={}.
-000161d0: 0a20 2020 2023 2020 2020 2066 6f72 206c  .    #     for l
-000161e0: 696e 6520 696e 2073 656c 662e 6d63 5f6c  ine in self.mc_l
-000161f0: 696e 6573 3a0a 0a20 2020 2023 2020 2020  ines:..    #    
-00016200: 2020 2020 2073 656c 662e 6d63 5f6c 696e       self.mc_lin
-00016210: 6573 5f74 656d 705b 6c69 6e65 5d20 3d20  es_temp[line] = 
-00016220: 4661 6c73 650a 0a20 2020 2023 2020 2020  False..    #    
-00016230: 2072 6574 7572 6e20 7365 6c66 2e6d 635f   return self.mc_
-00016240: 6c69 6e65 730a 0a20 2020 2023 2064 6566  lines..    # def
-00016250: 206d 756c 7469 6368 656d 5f61 7661 696c   multichem_avail
-00016260: 6162 6c65 5f70 6f73 6974 696f 6e73 2873  able_positions(s
-00016270: 656c 6629 202d 3e20 6c69 7374 5b73 7472  elf) -> list[str
-00016280: 5d3a 0a0a 2020 2020 2320 2020 2020 2222  ]:..    #     ""
-00016290: 2241 7661 696c 6162 6c65 2070 6f73 6974  "Available posit
-000162a0: 696f 6e73 2074 6865 206d 756c 7469 6368  ions the multich
-000162b0: 656d 206f 626a 6563 7420 6361 6e20 6d6f  em object can mo
-000162c0: 7665 2074 6f0a 2020 2020 2320 2020 2020  ve to.    #     
-000162d0: 5265 7475 726e 733a 0a20 2020 2023 2020  Returns:.    #  
-000162e0: 2020 2020 2020 205f 7479 7065 5f3a 206c         _type_: l
-000162f0: 6973 7420 6f66 2073 7472 206f 6620 706f  ist of str of po
-00016300: 7369 7469 6f6e 206e 616d 6573 0a20 2020  sition names.   
-00016310: 2023 2020 2020 2022 2222 0a0a 2020 2020   #     """..    
-00016320: 2320 2020 2020 5f63 6865 636b 5f73 7075  #     _check_spu
-00016330: 7474 6572 2873 656c 662e 7379 7374 656d  tter(self.system
-00016340: 290a 0a20 2020 2023 2020 2020 2070 6f73  )..    #     pos
-00016350: 6974 696f 6e73 5f65 6e75 6d20 3d20 7365  itions_enum = se
-00016360: 6c66 2e6d 756c 7469 6368 656d 2e70 6f73  lf.multichem.pos
-00016370: 6974 696f 6e73 0a0a 2020 2020 2320 2020  itions..    #   
-00016380: 2020 7265 7475 726e 2070 6f73 6974 696f    return positio
-00016390: 6e73 5f65 6e75 6d0a 0a20 2020 2023 2064  ns_enum..    # d
-000163a0: 6566 206d 756c 7469 6368 656d 5f6d 6f76  ef multichem_mov
-000163b0: 655f 746f 2873 656c 662c 706f 7369 7469  e_to(self,positi
-000163c0: 6f6e 3a73 7472 293a 0a0a 2020 2020 2320  on:str):..    # 
-000163d0: 2020 2020 2222 220a 2020 2020 2320 2020      """.    #   
-000163e0: 2020 4d6f 7665 7320 7468 6520 6d75 6c74    Moves the mult
-000163f0: 6963 6865 6d20 6f62 6a65 6374 2074 6f20  ichem object to 
-00016400: 6120 7370 6563 6966 6965 6420 706f 7369  a specified posi
-00016410: 7469 6f6e 2e0a 2020 2020 2320 2020 2020  tion..    #     
-00016420: 2222 220a 0a20 2020 2023 2020 2020 206c  """..    #     l
-00016430: 6f67 6769 6e67 2e69 6e66 6f28 6622 4d6f  ogging.info(f"Mo
-00016440: 7669 6e67 206d 756c 7469 6368 656d 2074  ving multichem t
-00016450: 6f20 706f 7369 7469 6f6e 3a20 7b70 6f73  o position: {pos
-00016460: 6974 696f 6e7d 2220 290a 0a20 2020 2023  ition}" )..    #
-00016470: 2020 2020 205f 6368 6563 6b5f 7370 7574       _check_sput
-00016480: 7465 7228 7365 6c66 2e73 7973 7465 6d29  ter(self.system)
-00016490: 0a0a 2020 2020 2320 2020 2020 6966 2070  ..    #     if p
-000164a0: 6f73 6974 696f 6e20 3d3d 2022 5265 7472  osition == "Retr
-000164b0: 6163 7422 3a0a 2020 2020 2320 2020 2020  act":.    #     
-000164c0: 2020 2020 7365 6c66 2e6d 756c 7469 6368      self.multich
-000164d0: 656d 2e72 6574 7261 6374 2829 0a20 2020  em.retract().   
-000164e0: 2023 2020 2020 2065 6c73 653a 0a20 2020   #     else:.   
-000164f0: 2023 2020 2020 2020 2020 2073 656c 662e   #         self.
-00016500: 6d75 6c74 6963 6865 6d2e 696e 7365 7274  multichem.insert
-00016510: 2870 6f73 6974 696f 6e3d 706f 7369 7469  (position=positi
-00016520: 6f6e 290a 0a20 2020 2020 2020 200a 0a0a  on)..        ...
-00016530: 2020 2020 2320 6465 6620 6d75 6c74 6963      # def multic
-00016540: 6865 6d5f 706f 7369 7469 6f6e 2873 656c  hem_position(sel
-00016550: 6629 202d 3e20 7374 723a 0a0a 2020 2020  f) -> str:..    
-00016560: 2320 2020 2020 2222 2243 7572 7265 6e74  #     """Current
-00016570: 2070 6f73 6974 696f 6e20 6f66 2074 6865   position of the
-00016580: 206d 756c 7469 6368 656d 206f 626a 6563   multichem objec
-00016590: 740a 2020 2020 2320 2020 2020 5265 7475  t.    #     Retu
-000165a0: 726e 733a 0a20 2020 2023 2020 2020 2020  rns:.    #      
-000165b0: 2020 205f 7479 7065 5f3a 2073 7472 206e     _type_: str n
-000165c0: 616d 6520 6f66 2074 6865 2063 7572 7265  ame of the curre
-000165d0: 6e74 2070 6f73 6974 696f 6e0a 2020 2020  nt position.    
-000165e0: 2320 2020 2020 2222 220a 0a20 2020 2023  #     """..    #
-000165f0: 2020 2020 205f 6368 6563 6b5f 7370 7574       _check_sput
-00016600: 7465 7228 7365 6c66 2e73 7973 7465 6d29  ter(self.system)
-00016610: 0a0a 2020 2020 2320 2020 2020 7265 7475  ..    #     retu
-00016620: 726e 2073 656c 662e 6d75 6c74 6963 6865  rn self.multiche
-00016630: 6d2e 6375 7272 656e 745f 706f 7369 7469  m.current_positi
-00016640: 6f6e 0a0a 2020 2020 2320 6465 6620 6d75  on..    # def mu
-00016650: 6c74 6963 6865 6d5f 6865 6174 5f75 7028  ltichem_heat_up(
-00016660: 7365 6c66 2c6c 696e 653a 7374 7229 3a0a  self,line:str):.
-00016670: 0a20 2020 2023 2020 2020 2022 2222 4865  .    #     """He
-00016680: 6174 2075 7020 7072 6f63 6564 7572 6520  at up procedure 
-00016690: 6f66 2074 6865 206d 756c 7469 6368 656d  of the multichem
-000166a0: 206f 626a 6563 742c 2069 6620 7468 6973   object, if this
-000166b0: 2070 726f 6365 6475 7265 2068 6173 2062   procedure has b
-000166c0: 6565 6e20 646f 6e65 206f 6e63 652c 0a20  een done once,. 
-000166d0: 2020 2023 2020 2020 2069 7420 6973 2063     #     it is c
-000166e0: 6f6e 7369 6465 7265 6420 7465 6d70 5f72  onsidered temp_r
-000166f0: 6561 6479 2e20 5072 6f63 6564 7572 6520  eady. Procedure 
-00016700: 6973 2074 7572 6e69 6e67 2074 6865 2068  is turning the h
-00016710: 6561 7465 7220 6f6e 2066 6f72 2033 2073  eater on for 3 s
-00016720: 6563 6f6e 6473 2061 6e64 2074 6865 6e20  econds and then 
-00016730: 6f66 660a 2020 2020 2320 2020 2020 4d75  off.    #     Mu
-00016740: 7374 2073 7065 6369 6679 2074 6865 206c  st specify the l
-00016750: 696e 6520 746f 2068 6561 7420 7570 0a20  ine to heat up. 
-00016760: 2020 2023 2020 2020 2022 2222 0a0a 2020     #     """..  
-00016770: 2020 2320 2020 2020 5f63 6865 636b 5f73    #     _check_s
-00016780: 7075 7474 6572 2873 656c 662e 7379 7374  putter(self.syst
-00016790: 656d 290a 0a20 2020 2023 2020 2020 2061  em)..    #     a
-000167a0: 7373 6572 7420 6c69 6e65 2069 6e20 7365  ssert line in se
-000167b0: 6c66 2e6d 635f 6c69 6e65 732c 2022 4c69  lf.mc_lines, "Li
-000167c0: 6e65 206e 6f74 2061 7661 696c 6162 6c65  ne not available
-000167d0: 220a 0a20 2020 2023 2020 2020 2073 656c  "..    #     sel
-000167e0: 662e 6d75 6c74 6963 6865 6d2e 6c69 6e65  f.multichem.line
-000167f0: 2e74 7572 6e5f 6865 6174 6572 5f6f 6e28  .turn_heater_on(
-00016800: 6c69 6e65 290a 0a20 2020 2023 2020 2020  line)..    #    
-00016810: 2074 696d 652e 736c 6565 7028 3329 0a0a   time.sleep(3)..
-00016820: 2020 2020 2320 2020 2020 2320 7365 6c66      #     # self
-00016830: 2e6d 756c 7469 6368 656d 2e6c 696e 652e  .multichem.line.
-00016840: 7475 726e 5f68 6561 7465 725f 6f66 6628  turn_heater_off(
-00016850: 6c69 6e65 290a 0a20 2020 2023 2020 2020  line)..    #    
-00016860: 2073 656c 662e 6d63 5f6c 696e 6573 5f74   self.mc_lines_t
-00016870: 656d 705b 6c69 6e65 5d20 3d20 5472 7565  emp[line] = True
-00016880: 0a0a 2020 2020 2320 6465 6620 6d75 6c74  ..    # def mult
-00016890: 6963 6865 6d5f 7465 6d70 5f72 6561 6479  ichem_temp_ready
-000168a0: 2873 656c 662c 6c69 6e65 3a73 7472 2920  (self,line:str) 
-000168b0: 2d3e 2062 6f6f 6c3a 0a0a 2020 2020 2320  -> bool:..    # 
-000168c0: 2020 2020 2222 2243 6865 636b 7320 6966      """Checks if
-000168d0: 2074 6865 2068 6561 7420 7570 2070 726f   the heat up pro
-000168e0: 6365 6475 7265 2066 6f72 2061 206c 696e  cedure for a lin
-000168f0: 6520 696e 2074 6865 206d 756c 7469 6368  e in the multich
-00016900: 656d 206f 626a 6563 7420 6861 7320 6265  em object has be
-00016910: 656e 2064 6f6e 652c 0a20 2020 2020 2020  en done,.       
-00016920: 200a 2020 2020 2320 2020 2020 5265 7475   .    #     Retu
-00016930: 726e 733a 0a20 2020 2023 2020 2020 2020  rns:.    #      
-00016940: 2020 205f 7479 7065 5f3a 2052 6574 7572     _type_: Retur
-00016950: 6e73 2074 7275 6520 6966 2064 6f6e 652c  ns true if done,
-00016960: 2066 616c 7365 2069 6620 6e6f 740a 2020   false if not.  
-00016970: 2020 2320 2020 2020 2222 220a 0a20 2020    #     """..   
-00016980: 2023 2020 2020 205f 6368 6563 6b5f 7370   #     _check_sp
-00016990: 7574 7465 7228 7365 6c66 2e73 7973 7465  utter(self.syste
-000169a0: 6d29 0a0a 2020 2020 2320 2020 2020 6173  m)..    #     as
-000169b0: 7365 7274 206c 696e 6520 696e 2073 656c  sert line in sel
-000169c0: 662e 6d63 5f6c 696e 6573 2c20 224c 696e  f.mc_lines, "Lin
-000169d0: 6520 6e6f 7420 6176 6169 6c61 626c 6522  e not available"
-000169e0: 0a0a 2020 2020 2320 2020 2020 7265 7475  ..    #     retu
-000169f0: 726e 2073 656c 662e 6d63 5f6c 696e 6573  rn self.mc_lines
-00016a00: 5f74 656d 705b 6c69 6e65 5d0a 2020 2020  _temp[line].    
-00016a10: 0a20 2020 2064 6566 2067 6574 5f61 7661  .    def get_ava
-00016a20: 696c 6162 6c65 5f76 616c 7565 7328 7365  ilable_values(se
-00016a30: 6c66 2c20 6b65 793a 2073 7472 2c20 6265  lf, key: str, be
-00016a40: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-00016a50: 6520 3d20 4e6f 6e65 292d 3e20 6c69 7374  e = None)-> list
-00016a60: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
-00016a70: 2061 206c 6973 7420 6f66 2061 7661 696c   a list of avail
-00016a80: 6162 6c65 2076 616c 7565 7320 666f 7220  able values for 
-00016a90: 6120 6769 7665 6e20 6b65 792e 0a20 2020  a given key..   
-00016aa0: 2020 2020 204b 6579 733a 2061 7070 6c69       Keys: appli
-00016ab0: 6361 7469 6f6e 5f66 696c 652c 2070 6c61  cation_file, pla
-00016ac0: 736d 615f 6761 732c 2063 7572 7265 6e74  sma_gas, current
-00016ad0: 2c20 6465 7465 6374 6f72 5f74 7970 652c  , detector_type,
-00016ae0: 2064 6574 6563 746f 725f 6d6f 6465 0a20   detector_mode. 
-00016af0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00016b00: 2020 2020 7661 6c75 6573 203d 205b 5d0a      values = [].
-00016b10: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00016b20: 3d20 2261 7070 6c69 6361 7469 6f6e 5f66  = "application_f
-00016b30: 696c 6522 3a0a 2020 2020 2020 2020 2020  ile":.          
-00016b40: 2020 7661 6c75 6573 203d 2073 656c 662e    values = self.
-00016b50: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
-00016b60: 726e 696e 672e 6c69 7374 5f61 6c6c 5f61  rning.list_all_a
-00016b70: 7070 6c69 6361 7469 6f6e 5f66 696c 6573  pplication_files
-00016b80: 2829 0a0a 2020 2020 2020 2020 6966 2062  ()..        if b
-00016b90: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
-00016ba0: 5479 7065 2e49 4f4e 2061 6e64 2073 656c  Type.ION and sel
-00016bb0: 662e 7379 7374 656d 2e69 6f6e 2e70 6c61  f.system.ion.pla
-00016bc0: 736d 613a 0a20 2020 2020 2020 2020 2020  sma:.           
-00016bd0: 2069 6620 6b65 7920 3d3d 2022 706c 6173   if key == "plas
-00016be0: 6d61 5f67 6173 223a 0a20 2020 2020 2020  ma_gas":.       
-00016bf0: 2020 2020 2020 2020 2076 616c 7565 7320           values 
-00016c00: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-00016c10: 6e2e 6265 616d 732e 696f 6e5f 6265 616d  n.beams.ion_beam
-00016c20: 2e73 6f75 7263 652e 706c 6173 6d61 5f67  .source.plasma_g
-00016c30: 6173 2e61 7661 696c 6162 6c65 5f76 616c  as.available_val
-00016c40: 7565 730a 0a20 2020 2020 2020 2069 6620  ues..        if 
-00016c50: 6b65 7920 3d3d 2022 6375 7272 656e 7422  key == "current"
-00016c60: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00016c70: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
-00016c80: 616d 5479 7065 2e49 4f4e 2061 6e64 2073  amType.ION and s
-00016c90: 656c 662e 6973 5f61 7661 696c 6162 6c65  elf.is_available
-00016ca0: 2822 696f 6e5f 6265 616d 2229 3a0a 2020  ("ion_beam"):.  
-00016cb0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-00016cc0: 6c75 6573 203d 2073 656c 662e 636f 6e6e  lues = self.conn
-00016cd0: 6563 7469 6f6e 2e62 6561 6d73 2e69 6f6e  ection.beams.ion
-00016ce0: 5f62 6561 6d2e 6265 616d 5f63 7572 7265  _beam.beam_curre
-00016cf0: 6e74 2e61 7661 696c 6162 6c65 5f76 616c  nt.available_val
-00016d00: 7565 730a 2020 2020 2020 2020 2020 2020  ues.            
-00016d10: 656c 6966 2062 6561 6d5f 7479 7065 2069  elif beam_type i
-00016d20: 7320 4265 616d 5479 7065 2e45 4c45 4354  s BeamType.ELECT
-00016d30: 524f 4e20 616e 6420 7365 6c66 2e69 735f  RON and self.is_
-00016d40: 6176 6169 6c61 626c 6528 2265 6c65 6374  available("elect
-00016d50: 726f 6e5f 6265 616d 2229 3a0a 2020 2020  ron_beam"):.    
-00016d60: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-00016d70: 6573 203d 2073 656c 662e 636f 6e6e 6563  es = self.connec
-00016d80: 7469 6f6e 2e62 6561 6d73 2e65 6c65 6374  tion.beams.elect
-00016d90: 726f 6e5f 6265 616d 2e62 6561 6d5f 6375  ron_beam.beam_cu
-00016da0: 7272 656e 742e 6176 6169 6c61 626c 655f  rrent.available_
-00016db0: 7661 6c75 6573 0a20 2020 2020 2020 200a  values.        .
-00016dc0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00016dd0: 3d20 2264 6574 6563 746f 725f 7479 7065  = "detector_type
-00016de0: 223a 0a20 2020 2020 2020 2020 2020 2076  ":.            v
-00016df0: 616c 7565 7320 3d20 7365 6c66 2e63 6f6e  alues = self.con
-00016e00: 6e65 6374 696f 6e2e 6465 7465 6374 6f72  nection.detector
-00016e10: 2e74 7970 652e 6176 6169 6c61 626c 655f  .type.available_
-00016e20: 7661 6c75 6573 0a20 2020 2020 2020 200a  values.        .
-00016e30: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00016e40: 3d20 2264 6574 6563 746f 725f 6d6f 6465  = "detector_mode
-00016e50: 223a 0a20 2020 2020 2020 2020 2020 2076  ":.            v
-00016e60: 616c 7565 7320 3d20 7365 6c66 2e63 6f6e  alues = self.con
-00016e70: 6e65 6374 696f 6e2e 6465 7465 6374 6f72  nection.detector
-00016e80: 2e6d 6f64 652e 6176 6169 6c61 626c 655f  .mode.available_
-00016e90: 7661 6c75 6573 0a20 2020 2020 2020 200a  values.        .
-00016ea0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00016eb0: 3d20 2273 6361 6e5f 6469 7265 6374 696f  = "scan_directio
-00016ec0: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
-00016ed0: 7661 6c75 6573 203d 205b 2242 6f74 746f  values = ["Botto
-00016ee0: 6d54 6f54 6f70 222c 200a 2020 2020 2020  mToTop", .      
-00016ef0: 2020 2020 2020 2020 2020 2244 796e 616d            "Dynam
-00016f00: 6963 416c 6c44 6972 6563 7469 6f6e 7322  icAllDirections"
-00016f10: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00016f20: 2020 2022 4479 6e61 6d69 6349 6e6e 6572     "DynamicInner
-00016f30: 546f 4f75 7465 7222 2c20 0a20 2020 2020  ToOuter", .     
-00016f40: 2020 2020 2020 2020 2020 2022 4479 6e61             "Dyna
-00016f50: 6d69 634c 6566 7454 6f52 6967 6874 222c  micLeftToRight",
-00016f60: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00016f70: 2020 2244 796e 616d 6963 546f 7054 6f42    "DynamicTopToB
-00016f80: 6f74 746f 6d22 2c20 0a20 2020 2020 2020  ottom", .       
-00016f90: 2020 2020 2020 2020 2022 496e 6e65 7254           "InnerT
-00016fa0: 6f4f 7574 6572 222c 2009 0a20 2020 2020  oOuter", ..     
-00016fb0: 2020 2020 2020 2020 2020 2022 4c65 6674             "Left
-00016fc0: 546f 5269 6768 7422 2c20 090a 2020 2020  ToRight", ..    
-00016fd0: 2020 2020 2020 2020 2020 2020 224f 7574              "Out
-00016fe0: 6572 546f 496e 6e65 7222 2c20 0a20 2020  erToInner", .   
-00016ff0: 2020 2020 2020 2020 2020 2020 2022 5269               "Ri
-00017000: 6768 7454 6f4c 6566 7422 2c20 090a 2020  ghtToLeft", ..  
-00017010: 2020 2020 2020 2020 2020 2020 2020 2254                "T
-00017020: 6f70 546f 426f 7474 6f6d 225d 0a20 2020  opToBottom"].   
-00017030: 2020 2020 200a 2020 2020 2020 2020 6c6f       .        lo
-00017040: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
-00017050: 6722 3a20 2267 6574 5f61 7661 696c 6162  g": "get_availab
-00017060: 6c65 5f76 616c 7565 7322 2c20 226b 6579  le_values", "key
-00017070: 223a 206b 6579 2c20 2276 616c 7565 7322  ": key, "values"
-00017080: 3a20 7661 6c75 6573 7d29 0a0a 2020 2020  : values})..    
-00017090: 2020 2020 7265 7475 726e 2076 616c 7565      return value
-000170a0: 730a 0a0a 2020 2020 6465 6620 5f67 6574  s...    def _get
-000170b0: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
-000170c0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-000170d0: 5479 7065 203d 204e 6f6e 6529 202d 3e20  Type = None) -> 
-000170e0: 556e 696f 6e5b 666c 6f61 742c 2073 7472  Union[float, str
-000170f0: 2c20 6c69 7374 2c20 4e6f 6e65 5d3a 0a20  , list, None]:. 
-00017100: 2020 2020 2020 2022 2222 4765 7420 6120         """Get a 
-00017110: 7072 6f70 6572 7479 206f 6620 7468 6520  property of the 
-00017120: 6d69 6372 6f73 636f 7065 2e22 2222 0a20  microscope.""". 
-00017130: 2020 2020 2020 2023 2054 4f44 4f3a 206d         # TODO: m
-00017140: 616b 6520 7468 6520 6c69 7374 206f 6620  ake the list of 
-00017150: 6765 7420 616e 6420 7365 7420 6b65 7973  get and set keys
-00017160: 2061 7661 696c 6162 6c65 2074 6f20 7468   available to th
-00017170: 6520 7573 6572 0a20 2020 2020 2020 2069  e user.        i
-00017180: 6620 6265 616d 5f74 7970 6520 6973 206e  f beam_type is n
-00017190: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000171a0: 2020 2020 2062 6561 6d20 3d20 7365 6c66       beam = self
-000171b0: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
-000171c0: 732e 656c 6563 7472 6f6e 5f62 6561 6d20  s.electron_beam 
-000171d0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-000171e0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-000171f0: 4e20 656c 7365 2073 656c 662e 636f 6e6e  N else self.conn
-00017200: 6563 7469 6f6e 2e62 6561 6d73 2e69 6f6e  ection.beams.ion
-00017210: 5f62 6561 6d0a 2020 2020 2020 2020 2020  _beam.          
-00017220: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
-00017230: 616d 5f74 7970 652c 2073 656c 662e 7379  am_type, self.sy
-00017240: 7374 656d 290a 0a20 2020 2020 2020 2023  stem)..        #
-00017250: 2062 6561 6d20 7072 6f70 6572 7469 6573   beam properties
-00017260: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-00017270: 3d3d 2022 6f6e 223a 200a 2020 2020 2020  == "on": .      
-00017280: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
-00017290: 6d2e 6973 5f6f 6e0a 2020 2020 2020 2020  m.is_on.        
-000172a0: 6966 206b 6579 203d 3d20 2262 6c61 6e6b  if key == "blank
-000172b0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
-000172c0: 2072 6574 7572 6e20 6265 616d 2e69 735f   return beam.is_
-000172d0: 626c 616e 6b65 640a 2020 2020 2020 2020  blanked.        
-000172e0: 6966 206b 6579 203d 3d20 2277 6f72 6b69  if key == "worki
-000172f0: 6e67 5f64 6973 7461 6e63 6522 3a0a 2020  ng_distance":.  
-00017300: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017310: 2062 6561 6d2e 776f 726b 696e 675f 6469   beam.working_di
-00017320: 7374 616e 6365 2e76 616c 7565 0a20 2020  stance.value.   
-00017330: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00017340: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
-00017350: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
-00017360: 6d2e 6265 616d 5f63 7572 7265 6e74 2e76  m.beam_current.v
-00017370: 616c 7565 0a20 2020 2020 2020 2069 6620  alue.        if 
-00017380: 6b65 7920 3d3d 2022 766f 6c74 6167 6522  key == "voltage"
-00017390: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000173a0: 7475 726e 2062 6561 6d2e 6869 6768 5f76  turn beam.high_v
-000173b0: 6f6c 7461 6765 2e76 616c 7565 0a20 2020  oltage.value.   
-000173c0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-000173d0: 6866 7722 3a0a 2020 2020 2020 2020 2020  hfw":.          
-000173e0: 2020 7265 7475 726e 2062 6561 6d2e 686f    return beam.ho
-000173f0: 7269 7a6f 6e74 616c 5f66 6965 6c64 5f77  rizontal_field_w
-00017400: 6964 7468 2e76 616c 7565 0a20 2020 2020  idth.value.     
-00017410: 2020 2069 6620 6b65 7920 3d3d 2022 6477     if key == "dw
-00017420: 656c 6c5f 7469 6d65 223a 0a20 2020 2020  ell_time":.     
-00017430: 2020 2020 2020 2072 6574 7572 6e20 6265         return be
-00017440: 616d 2e73 6361 6e6e 696e 672e 6477 656c  am.scanning.dwel
-00017450: 6c5f 7469 6d65 2e76 616c 7565 0a20 2020  l_time.value.   
-00017460: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00017470: 7363 616e 5f72 6f74 6174 696f 6e22 3a0a  scan_rotation":.
-00017480: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017490: 726e 2062 6561 6d2e 7363 616e 6e69 6e67  rn beam.scanning
-000174a0: 2e72 6f74 6174 696f 6e2e 7661 6c75 650a  .rotation.value.
-000174b0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-000174c0: 3d20 2276 6f6c 7461 6765 5f6c 696d 6974  = "voltage_limit
-000174d0: 7322 3a0a 2020 2020 2020 2020 2020 2020  s":.            
-000174e0: 7265 7475 726e 2062 6561 6d2e 6869 6768  return beam.high
-000174f0: 5f76 6f6c 7461 6765 2e6c 696d 6974 730a  _voltage.limits.
-00017500: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00017510: 3d20 2276 6f6c 7461 6765 5f63 6f6e 7472  = "voltage_contr
-00017520: 6f6c 6c61 626c 6522 3a0a 2020 2020 2020  ollable":.      
-00017530: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
-00017540: 6d2e 6869 6768 5f76 6f6c 7461 6765 2e69  m.high_voltage.i
-00017550: 735f 636f 6e74 726f 6c6c 6162 6c65 0a20  s_controllable. 
-00017560: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00017570: 2022 7368 6966 7422 3a20 2320 6265 616d   "shift": # beam
-00017580: 2073 6869 6674 0a20 2020 2020 2020 2020   shift.         
-00017590: 2020 2072 6574 7572 6e20 506f 696e 7428     return Point(
-000175a0: 6265 616d 2e62 6561 6d5f 7368 6966 742e  beam.beam_shift.
-000175b0: 7661 6c75 652e 782c 2062 6561 6d2e 6265  value.x, beam.be
-000175c0: 616d 5f73 6869 6674 2e76 616c 7565 2e79  am_shift.value.y
-000175d0: 290a 2020 2020 2020 2020 6966 206b 6579  ).        if key
-000175e0: 203d 3d20 2273 7469 676d 6174 696f 6e22   == "stigmation"
-000175f0: 3a20 0a20 2020 2020 2020 2020 2020 2072  : .            r
-00017600: 6574 7572 6e20 506f 696e 7428 6265 616d  eturn Point(beam
-00017610: 2e73 7469 676d 6174 6f72 2e76 616c 7565  .stigmator.value
-00017620: 2e78 2c20 6265 616d 2e73 7469 676d 6174  .x, beam.stigmat
-00017630: 6f72 2e76 616c 7565 2e79 290a 2020 2020  or.value.y).    
-00017640: 2020 2020 6966 206b 6579 203d 3d20 2272      if key == "r
-00017650: 6573 6f6c 7574 696f 6e22 3a0a 2020 2020  esolution":.    
-00017660: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
-00017670: 6f6e 203d 2062 6561 6d2e 7363 616e 6e69  on = beam.scanni
-00017680: 6e67 2e72 6573 6f6c 7574 696f 6e2e 7661  ng.resolution.va
-00017690: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
-000176a0: 7769 6474 682c 2068 6569 6768 7420 3d20  width, height = 
-000176b0: 696e 7428 7265 736f 6c75 7469 6f6e 2e73  int(resolution.s
-000176c0: 706c 6974 2822 7822 295b 305d 292c 2069  plit("x")[0]), i
-000176d0: 6e74 2872 6573 6f6c 7574 696f 6e2e 7370  nt(resolution.sp
-000176e0: 6c69 7428 2278 2229 5b2d 315d 290a 2020  lit("x")[-1]).  
-000176f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00017700: 205b 7769 6474 682c 2068 6569 6768 745d   [width, height]
-00017710: 0a0a 2020 2020 2020 2020 2320 7379 7374  ..        # syst
-00017720: 656d 2070 726f 7065 7274 6965 730a 2020  em properties.  
-00017730: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-00017740: 2265 7563 656e 7472 6963 5f68 6569 6768  "eucentric_heigh
-00017750: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
-00017760: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-00017770: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-00017780: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
-00017790: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-000177a0: 7973 7465 6d2e 656c 6563 7472 6f6e 2e65  ystem.electron.e
-000177b0: 7563 656e 7472 6963 5f68 6569 6768 740a  ucentric_height.
-000177c0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-000177d0: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
-000177e0: 616d 5479 7065 2e49 4f4e 3a0a 2020 2020  amType.ION:.    
-000177f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00017800: 726e 2073 656c 662e 7379 7374 656d 2e69  rn self.system.i
-00017810: 6f6e 2e65 7563 656e 7472 6963 5f68 6569  on.eucentric_hei
-00017820: 6768 740a 2020 2020 2020 2020 2020 2020  ght.            
-00017830: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00017840: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00017850: 6545 7272 6f72 2866 2255 6e6b 6e6f 776e  eError(f"Unknown
-00017860: 2062 6561 6d20 7479 7065 3a20 7b62 6561   beam type: {bea
-00017870: 6d5f 7479 7065 7d20 666f 7220 7b6b 6579  m_type} for {key
-00017880: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
-00017890: 6b65 7920 3d3d 2022 636f 6c75 6d6e 5f74  key == "column_t
-000178a0: 696c 7422 3a0a 2020 2020 2020 2020 2020  ilt":.          
-000178b0: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
-000178c0: 7320 4265 616d 5479 7065 2e45 4c45 4354  s BeamType.ELECT
-000178d0: 524f 4e3a 0a20 2020 2020 2020 2020 2020  RON:.           
-000178e0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000178f0: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
-00017900: 2e63 6f6c 756d 6e5f 7469 6c74 0a20 2020  .column_tilt.   
-00017910: 2020 2020 2020 2020 2065 6c69 6620 6265           elif be
-00017920: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
-00017930: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
-00017940: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00017950: 7365 6c66 2e73 7973 7465 6d2e 696f 6e2e  self.system.ion.
-00017960: 636f 6c75 6d6e 5f74 696c 740a 2020 2020  column_tilt.    
-00017970: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00017980: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00017990: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-000179a0: 2255 6e6b 6e6f 776e 2062 6561 6d20 7479  "Unknown beam ty
-000179b0: 7065 3a20 7b62 6561 6d5f 7479 7065 7d20  pe: {beam_type} 
-000179c0: 666f 7220 7b6b 6579 7d22 290a 0a20 2020  for {key}")..   
-000179d0: 2020 2020 2023 2065 6c65 6374 726f 6e20       # electron 
-000179e0: 6265 616d 2070 726f 7065 7274 6965 730a  beam properties.
-000179f0: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
-00017a00: 7479 7065 2069 7320 4265 616d 5479 7065  type is BeamType
-00017a10: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
-00017a20: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00017a30: 2022 616e 6775 6c61 725f 636f 7272 6563   "angular_correc
-00017a40: 7469 6f6e 5f61 6e67 6c65 223a 0a20 2020  tion_angle":.   
-00017a50: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00017a60: 7572 6e20 6265 616d 2e61 6e67 756c 6172  urn beam.angular
-00017a70: 5f63 6f72 7265 6374 696f 6e2e 616e 676c  _correction.angl
-00017a80: 652e 7661 6c75 650a 0a20 2020 2020 2020  e.value..       
-00017a90: 2023 2069 6f6e 2062 6561 6d20 7072 6f70   # ion beam prop
-00017aa0: 6572 7469 6573 0a20 2020 2020 2020 2069  erties.        i
-00017ab0: 6620 6b65 7920 3d3d 2022 706c 6173 6d61  f key == "plasma
-00017ac0: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
-00017ad0: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-00017ae0: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
-00017af0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00017b00: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
-00017b10: 696f 6e2e 706c 6173 6d61 0a20 2020 2020  ion.plasma.     
-00017b20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00017b30: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00017b40: 7572 6e20 4661 6c73 650a 0a20 2020 2020  urn False..     
-00017b50: 2020 2069 6620 6b65 7920 3d3d 2022 706c     if key == "pl
-00017b60: 6173 6d61 5f67 6173 223a 0a20 2020 2020  asma_gas":.     
-00017b70: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-00017b80: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00017b90: 494f 4e20 616e 6420 7365 6c66 2e73 7973  ION and self.sys
-00017ba0: 7465 6d2e 696f 6e2e 706c 6173 6d61 3a0a  tem.ion.plasma:.
-00017bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017bc0: 7265 7475 726e 2062 6561 6d2e 736f 7572  return beam.sour
-00017bd0: 6365 2e70 6c61 736d 615f 6761 732e 7661  ce.plasma_gas.va
-00017be0: 6c75 6520 2320 6d69 6768 7420 6e65 6564  lue # might need
-00017bf0: 2074 6f20 6368 6563 6b20 6966 2074 6869   to check if thi
-00017c00: 7320 6973 2061 7661 696c 6162 6c65 3f0a  s is available?.
-00017c10: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00017c20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017c30: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-00017c40: 2020 2020 2020 2023 2073 7461 6765 2070         # stage p
-00017c50: 726f 7065 7274 6965 730a 2020 2020 2020  roperties.      
-00017c60: 2020 6966 206b 6579 203d 3d20 2273 7461    if key == "sta
-00017c70: 6765 5f70 6f73 6974 696f 6e22 3a0a 2020  ge_position":.  
-00017c80: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
-00017c90: 5f73 7461 6765 2873 656c 662e 7379 7374  _stage(self.syst
-00017ca0: 656d 290a 0a20 2020 2020 2020 2020 2020  em)..           
-00017cb0: 2023 2067 6574 2073 7461 6765 2070 6f73   # get stage pos
-00017cc0: 6974 696f 6e20 696e 2072 6177 2063 6f6f  ition in raw coo
-00017cd0: 7264 696e 6174 6573 0a20 2020 2020 2020  rdinates.       
-00017ce0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00017cf0: 7469 6f6e 2e73 7065 6369 6d65 6e2e 7374  tion.specimen.st
-00017d00: 6167 652e 7365 745f 6465 6661 756c 745f  age.set_default_
-00017d10: 636f 6f72 6469 6e61 7465 5f73 7973 7465  coordinate_syste
-00017d20: 6d28 2023 2054 4f44 4f3a 2077 6520 7368  m( # TODO: we sh
-00017d30: 6f75 6c64 2073 6574 2074 6869 7320 6174  ould set this at
-00017d40: 2074 6865 2073 7461 7274 0a20 2020 2020   the start.     
-00017d50: 2020 2020 2020 2043 6f6f 7264 696e 6174         Coordinat
-00017d60: 6553 7973 7465 6d2e 5241 570a 2020 2020  eSystem.RAW.    
-00017d70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00017d80: 2020 2020 2020 7374 6167 655f 706f 7369        stage_posi
-00017d90: 7469 6f6e 203d 2073 656c 662e 636f 6e6e  tion = self.conn
-00017da0: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
-00017db0: 7374 6167 652e 6375 7272 656e 745f 706f  stage.current_po
-00017dc0: 7369 7469 6f6e 2020 0a20 2020 2020 2020  sition  .       
-00017dd0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00017de0: 7469 6f6e 2e73 7065 6369 6d65 6e2e 7374  tion.specimen.st
-00017df0: 6167 652e 7365 745f 6465 6661 756c 745f  age.set_default_
-00017e00: 636f 6f72 6469 6e61 7465 5f73 7973 7465  coordinate_syste
-00017e10: 6d28 0a20 2020 2020 2020 2020 2020 2020  m(.             
-00017e20: 2020 2043 6f6f 7264 696e 6174 6553 7973     CoordinateSys
-00017e30: 7465 6d2e 5350 4543 494d 454e 0a20 2020  tem.SPECIMEN.   
-00017e40: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00017e50: 2020 2020 2020 2073 7461 6765 5f70 6f73         stage_pos
-00017e60: 6974 696f 6e20 3d20 4669 6273 656d 5374  ition = FibsemSt
-00017e70: 6167 6550 6f73 6974 696f 6e2e 6672 6f6d  agePosition.from
-00017e80: 5f61 7574 6f73 6372 6970 745f 706f 7369  _autoscript_posi
-00017e90: 7469 6f6e 2873 7461 6765 5f70 6f73 6974  tion(stage_posit
-00017ea0: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
-00017eb0: 2072 6574 7572 6e20 7374 6167 655f 706f   return stage_po
-00017ec0: 7369 7469 6f6e 0a20 2020 2020 2020 200a  sition.        .
-00017ed0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00017ee0: 3d20 2273 7461 6765 5f68 6f6d 6564 223a  = "stage_homed":
-00017ef0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00017f00: 6563 6b5f 7374 6167 6528 7365 6c66 2e73  eck_stage(self.s
-00017f10: 7973 7465 6d29 0a20 2020 2020 2020 2020  ystem).         
-00017f20: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
-00017f30: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
-00017f40: 656e 2e73 7461 6765 2e69 735f 686f 6d65  en.stage.is_home
-00017f50: 640a 2020 2020 2020 2020 6966 206b 6579  d.        if key
-00017f60: 203d 3d20 2273 7461 6765 5f6c 696e 6b65   == "stage_linke
-00017f70: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-00017f80: 5f63 6865 636b 5f73 7461 6765 2873 656c  _check_stage(sel
-00017f90: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
-00017fa0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00017fb0: 662e 636f 6e6e 6563 7469 6f6e 2e73 7065  f.connection.spe
-00017fc0: 6369 6d65 6e2e 7374 6167 652e 6973 5f6c  cimen.stage.is_l
-00017fd0: 696e 6b65 640a 0a20 2020 2020 2020 2023  inked..        #
-00017fe0: 2063 6861 6d62 6572 2070 726f 7065 7274   chamber propert
-00017ff0: 6965 730a 2020 2020 2020 2020 6966 206b  ies.        if k
-00018000: 6579 203d 3d20 2263 6861 6d62 6572 5f73  ey == "chamber_s
-00018010: 7461 7465 223a 0a20 2020 2020 2020 2020  tate":.         
-00018020: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
-00018030: 6f6e 6e65 6374 696f 6e2e 7661 6375 756d  onnection.vacuum
-00018040: 2e63 6861 6d62 6572 5f73 7461 7465 0a20  .chamber_state. 
-00018050: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00018060: 6966 206b 6579 203d 3d20 2263 6861 6d62  if key == "chamb
-00018070: 6572 5f70 7265 7373 7572 6522 3a0a 2020  er_pressure":.  
-00018080: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00018090: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000180a0: 2e76 6163 7575 6d2e 6368 616d 6265 725f  .vacuum.chamber_
-000180b0: 7072 6573 7375 7265 2e76 616c 7565 0a0a  pressure.value..
-000180c0: 2020 2020 2020 2020 2320 6465 7465 6374          # detect
-000180d0: 6f72 206d 6f64 6520 616e 6420 7479 7065  or mode and type
-000180e0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-000180f0: 696e 205b 2264 6574 6563 746f 725f 6d6f  in ["detector_mo
-00018100: 6465 222c 2022 6465 7465 6374 6f72 5f74  de", "detector_t
-00018110: 7970 6522 2c20 2264 6574 6563 746f 725f  ype", "detector_
-00018120: 6272 6967 6874 6e65 7373 222c 2022 6465  brightness", "de
-00018130: 7465 6374 6f72 5f63 6f6e 7472 6173 7422  tector_contrast"
-00018140: 5d3a 0a20 2020 2020 2020 2020 2020 200a  ]:.            .
-00018150: 2020 2020 2020 2020 2020 2020 2320 7365              # se
-00018160: 7420 6265 616d 2061 6374 6976 6520 7669  t beam active vi
-00018170: 6577 2061 6e64 2064 6576 6963 650a 2020  ew and device.  
-00018180: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00018190: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
-000181a0: 672e 7365 745f 6163 7469 7665 5f76 6965  g.set_active_vie
-000181b0: 7728 6265 616d 5f74 7970 652e 7661 6c75  w(beam_type.valu
-000181c0: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
-000181d0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
-000181e0: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
-000181f0: 655f 6465 7669 6365 2862 6561 6d5f 7479  e_device(beam_ty
-00018200: 7065 2e76 616c 7565 290a 0a20 2020 2020  pe.value)..     
-00018210: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00018220: 2022 6465 7465 6374 6f72 5f74 7970 6522   "detector_type"
-00018230: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018240: 2020 7265 7475 726e 2073 656c 662e 636f    return self.co
-00018250: 6e6e 6563 7469 6f6e 2e64 6574 6563 746f  nnection.detecto
-00018260: 722e 7479 7065 2e76 616c 7565 0a20 2020  r.type.value.   
-00018270: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
-00018280: 3d3d 2022 6465 7465 6374 6f72 5f6d 6f64  == "detector_mod
-00018290: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-000182a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000182b0: 636f 6e6e 6563 7469 6f6e 2e64 6574 6563  connection.detec
-000182c0: 746f 722e 6d6f 6465 2e76 616c 7565 0a20  tor.mode.value. 
-000182d0: 2020 2020 2020 2020 2020 2069 6620 6b65             if ke
-000182e0: 7920 3d3d 2022 6465 7465 6374 6f72 5f62  y == "detector_b
-000182f0: 7269 6768 746e 6573 7322 3a0a 2020 2020  rightness":.    
-00018300: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00018310: 726e 2073 656c 662e 636f 6e6e 6563 7469  rn self.connecti
-00018320: 6f6e 2e64 6574 6563 746f 722e 6272 6967  on.detector.brig
-00018330: 6874 6e65 7373 2e76 616c 7565 0a20 2020  htness.value.   
-00018340: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
-00018350: 3d3d 2022 6465 7465 6374 6f72 5f63 6f6e  == "detector_con
-00018360: 7472 6173 7422 3a0a 2020 2020 2020 2020  trast":.        
-00018370: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00018380: 656c 662e 636f 6e6e 6563 7469 6f6e 2e64  elf.connection.d
-00018390: 6574 6563 746f 722e 636f 6e74 7261 7374  etector.contrast
-000183a0: 2e76 616c 7565 0a0a 2020 2020 2020 2020  .value..        
-000183b0: 2320 6d61 6e69 7075 6c61 746f 7220 7072  # manipulator pr
-000183c0: 6f70 6572 7469 6573 0a20 2020 2020 2020  operties.       
-000183d0: 2069 6620 6b65 7920 3d3d 2022 6d61 6e69   if key == "mani
-000183e0: 7075 6c61 746f 725f 706f 7369 7469 6f6e  pulator_position
-000183f0: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
-00018400: 6368 6563 6b5f 6d61 6e69 7075 6c61 746f  check_manipulato
-00018410: 7228 7365 6c66 2e73 7973 7465 6d29 0a20  r(self.system). 
-00018420: 2020 2020 2020 2020 2020 2070 6f73 6974             posit
-00018430: 696f 6e20 3d20 7365 6c66 2e63 6f6e 6e65  ion = self.conne
-00018440: 6374 696f 6e2e 7370 6563 696d 656e 2e6d  ction.specimen.m
-00018450: 616e 6970 756c 6174 6f72 2e63 7572 7265  anipulator.curre
-00018460: 6e74 5f70 6f73 6974 696f 6e20 2020 0a20  nt_position   . 
-00018470: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00018480: 6e20 4669 6273 656d 4d61 6e69 7075 6c61  n FibsemManipula
-00018490: 746f 7250 6f73 6974 696f 6e2e 6672 6f6d  torPosition.from
-000184a0: 5f61 7574 6f73 6372 6970 745f 706f 7369  _autoscript_posi
-000184b0: 7469 6f6e 2870 6f73 6974 696f 6e29 0a20  tion(position). 
-000184c0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-000184d0: 2022 6d61 6e69 7075 6c61 746f 725f 7374   "manipulator_st
-000184e0: 6174 6522 3a0a 2020 2020 2020 2020 2020  ate":.          
-000184f0: 2020 5f63 6865 636b 5f6d 616e 6970 756c    _check_manipul
-00018500: 6174 6f72 2873 656c 662e 7379 7374 656d  ator(self.system
-00018510: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-00018520: 6174 6520 3d20 7365 6c66 2e63 6f6e 6e65  ate = self.conne
-00018530: 6374 696f 6e2e 7370 6563 696d 656e 2e6d  ction.specimen.m
-00018540: 616e 6970 756c 6174 6f72 2e73 7461 7465  anipulator.state
-00018550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018560: 200a 2020 2020 2020 2020 2020 2020 7265   .            re
-00018570: 7475 726e 2054 7275 6520 6966 2073 7461  turn True if sta
-00018580: 7465 203d 3d20 4d61 6e69 7075 6c61 746f  te == Manipulato
-00018590: 7253 7461 7465 2e49 4e53 4552 5445 4420  rState.INSERTED 
-000185a0: 656c 7365 2046 616c 7365 0a0a 2020 2020  else False..    
-000185b0: 2020 2020 2320 6d61 6e75 6661 6374 7572      # manufactur
-000185c0: 6572 2070 726f 7065 7274 6965 730a 2020  er properties.  
-000185d0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-000185e0: 226d 616e 7566 6163 7475 7265 7222 3a0a  "manufacturer":.
-000185f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00018600: 726e 2073 656c 662e 7379 7374 656d 2e69  rn self.system.i
-00018610: 6e66 6f2e 6d61 6e75 6661 6374 7572 6572  nfo.manufacturer
-00018620: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-00018630: 3d3d 2022 6d6f 6465 6c22 3a0a 2020 2020  == "model":.    
-00018640: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00018650: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
-00018660: 6d6f 6465 6c0a 2020 2020 2020 2020 6966  model.        if
-00018670: 206b 6579 203d 3d20 2273 6572 6961 6c5f   key == "serial_
-00018680: 6e75 6d62 6572 223a 0a20 2020 2020 2020  number":.       
-00018690: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000186a0: 2e73 7973 7465 6d2e 696e 666f 2e73 6572  .system.info.ser
-000186b0: 6961 6c5f 6e75 6d62 6572 0a20 2020 2020  ial_number.     
-000186c0: 2020 2069 6620 6b65 7920 3d3d 2022 736f     if key == "so
-000186d0: 6674 7761 7265 5f76 6572 7369 6f6e 223a  ftware_version":
-000186e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000186f0: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
-00018700: 696e 666f 2e73 6f66 7477 6172 655f 7665  info.software_ve
-00018710: 7273 696f 6e0a 2020 2020 2020 2020 6966  rsion.        if
-00018720: 206b 6579 203d 3d20 2268 6172 6477 6172   key == "hardwar
-00018730: 655f 7665 7273 696f 6e22 3a0a 2020 2020  e_version":.    
-00018740: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00018750: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
-00018760: 6861 7264 7761 7265 5f76 6572 7369 6f6e  hardware_version
-00018770: 0a20 2020 2020 2020 200a 0a20 2020 2020  .        ..     
-00018780: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00018790: 2320 6c6f 6767 696e 672e 7761 726e 696e  # logging.warnin
-000187a0: 6728 6622 556e 6b6e 6f77 6e20 6b65 793a  g(f"Unknown key:
-000187b0: 207b 6b65 797d 2028 7b62 6561 6d5f 7479   {key} ({beam_ty
-000187c0: 7065 7d29 2229 0a20 2020 2020 2020 2072  pe})").        r
-000187d0: 6574 7572 6e20 4e6f 6e65 2020 2020 0a0a  eturn None    ..
-000187e0: 2020 2020 6465 6620 5f73 6574 2873 656c      def _set(sel
-000187f0: 662c 206b 6579 3a20 7374 722c 2076 616c  f, key: str, val
-00018800: 7565 2c20 6265 616d 5f74 7970 653a 2042  ue, beam_type: B
-00018810: 6561 6d54 7970 6520 3d20 4e6f 6e65 2920  eamType = None) 
-00018820: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00018830: 2022 2222 5365 7420 6120 7072 6f70 6572   """Set a proper
-00018840: 7479 206f 6620 7468 6520 6d69 6372 6f73  ty of the micros
-00018850: 636f 7065 2e22 2222 0a20 2020 2020 2020  cope.""".       
-00018860: 2023 2072 6571 7569 7265 6420 666f 7220   # required for 
-00018870: 7365 7474 696e 6720 7368 6966 742c 2073  setting shift, s
-00018880: 7469 676d 6174 696f 6e0a 2020 2020 2020  tigmation.      
-00018890: 2020 6672 6f6d 2061 7574 6f73 6372 6970    from autoscrip
-000188a0: 745f 7364 625f 6d69 6372 6f73 636f 7065  t_sdb_microscope
-000188b0: 5f63 6c69 656e 742e 7374 7275 6374 7572  _client.structur
-000188c0: 6573 2069 6d70 6f72 7420 506f 696e 7420  es import Point 
-000188d0: 6173 2054 6865 726d 6f50 6f69 6e74 0a0a  as ThermoPoint..
-000188e0: 2020 2020 2020 2020 2320 6765 7420 6265          # get be
-000188f0: 616d 0a20 2020 2020 2020 2069 6620 6265  am.        if be
-00018900: 616d 5f74 7970 6520 6973 206e 6f74 204e  am_type is not N
-00018910: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00018920: 2062 6561 6d20 3d20 7365 6c66 2e63 6f6e   beam = self.con
-00018930: 6e65 6374 696f 6e2e 6265 616d 732e 656c  nection.beams.el
-00018940: 6563 7472 6f6e 5f62 6561 6d20 6966 2062  ectron_beam if b
-00018950: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
-00018960: 5479 7065 2e45 4c45 4354 524f 4e20 656c  Type.ELECTRON el
-00018970: 7365 2073 656c 662e 636f 6e6e 6563 7469  se self.connecti
-00018980: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
-00018990: 6d0a 2020 2020 2020 2020 2020 2020 5f63  m.            _c
-000189a0: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
-000189b0: 7970 652c 2073 656c 662e 7379 7374 656d  ype, self.system
-000189c0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-000189d0: 2020 2023 2062 6561 6d20 7072 6f70 6572     # beam proper
-000189e0: 7469 6573 0a20 2020 2020 2020 2069 6620  ties.        if 
-000189f0: 6b65 7920 3d3d 2022 776f 726b 696e 675f  key == "working_
-00018a00: 6469 7374 616e 6365 223a 0a20 2020 2020  distance":.     
-00018a10: 2020 2020 2020 2062 6561 6d2e 776f 726b         beam.work
-00018a20: 696e 675f 6469 7374 616e 6365 2e76 616c  ing_distance.val
-00018a30: 7565 203d 2076 616c 7565 0a20 2020 2020  ue = value.     
-00018a40: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-00018a50: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00018a60: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-00018a70: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00018a80: 6574 2822 7374 6167 655f 6c69 6e6b 222c  et("stage_link",
-00018a90: 2054 7275 6529 2020 2320 6c69 6e6b 2074   True)  # link t
-00018aa0: 6865 2073 7065 6369 6d65 6e20 7374 6167  he specimen stag
-00018ab0: 6520 666f 7220 656c 6563 7472 6f6e 0a20  e for electron. 
-00018ac0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-00018ad0: 6e67 2e69 6e66 6f28 6622 7b62 6561 6d5f  ng.info(f"{beam_
-00018ae0: 7479 7065 2e6e 616d 657d 2077 6f72 6b69  type.name} worki
-00018af0: 6e67 2064 6973 7461 6e63 6520 7365 7420  ng distance set 
-00018b00: 746f 207b 7661 6c75 657d 206d 2e22 290a  to {value} m.").
-00018b10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00018b20: 726e 200a 2020 2020 2020 2020 6966 206b  rn .        if k
-00018b30: 6579 203d 3d20 2263 7572 7265 6e74 223a  ey == "current":
-00018b40: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
-00018b50: 6d2e 6265 616d 5f63 7572 7265 6e74 2e76  m.beam_current.v
-00018b60: 616c 7565 203d 2076 616c 7565 0a20 2020  alue = value.   
-00018b70: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-00018b80: 2e69 6e66 6f28 6622 7b62 6561 6d5f 7479  .info(f"{beam_ty
-00018b90: 7065 2e6e 616d 657d 2063 7572 7265 6e74  pe.name} current
-00018ba0: 2073 6574 2074 6f20 7b76 616c 7565 7d20   set to {value} 
-00018bb0: 412e 2229 0a20 2020 2020 2020 2020 2020  A.").           
-00018bc0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00018bd0: 6966 206b 6579 203d 3d20 2276 6f6c 7461  if key == "volta
-00018be0: 6765 223a 0a20 2020 2020 2020 2020 2020  ge":.           
-00018bf0: 2062 6561 6d2e 6869 6768 5f76 6f6c 7461   beam.high_volta
-00018c00: 6765 2e76 616c 7565 203d 2076 616c 7565  ge.value = value
-00018c10: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00018c20: 6769 6e67 2e69 6e66 6f28 6622 7b62 6561  ging.info(f"{bea
-00018c30: 6d5f 7479 7065 2e6e 616d 657d 2076 6f6c  m_type.name} vol
-00018c40: 7461 6765 2073 6574 2074 6f20 7b76 616c  tage set to {val
-00018c50: 7565 7d20 562e 2229 0a20 2020 2020 2020  ue} V.").       
-00018c60: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00018c70: 2020 2020 6966 206b 6579 203d 3d20 2268      if key == "h
-00018c80: 6677 223a 0a20 2020 2020 2020 2020 2020  fw":.           
-00018c90: 206c 696d 6974 7320 3d20 6265 616d 2e68   limits = beam.h
-00018ca0: 6f72 697a 6f6e 7461 6c5f 6669 656c 645f  orizontal_field_
-00018cb0: 7769 6474 682e 6c69 6d69 7473 0a20 2020  width.limits.   
-00018cc0: 2020 2020 2020 2020 2076 616c 7565 203d           value =
-00018cd0: 206e 702e 636c 6970 2876 616c 7565 2c20   np.clip(value, 
-00018ce0: 6c69 6d69 7473 2e6d 696e 2c20 6c69 6d69  limits.min, limi
-00018cf0: 7473 2e6d 6178 290a 2020 2020 2020 2020  ts.max).        
-00018d00: 2020 2020 6265 616d 2e68 6f72 697a 6f6e      beam.horizon
-00018d10: 7461 6c5f 6669 656c 645f 7769 6474 682e  tal_field_width.
-00018d20: 7661 6c75 6520 3d20 7661 6c75 650a 2020  value = value.  
-00018d30: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00018d40: 672e 696e 666f 2866 227b 6265 616d 5f74  g.info(f"{beam_t
-00018d50: 7970 652e 6e61 6d65 7d20 4846 5720 7365  ype.name} HFW se
-00018d60: 7420 746f 207b 7661 6c75 657d 206d 2e22  t to {value} m."
-00018d70: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00018d80: 7475 726e 200a 2020 2020 2020 2020 6966  turn .        if
-00018d90: 206b 6579 203d 3d20 2264 7765 6c6c 5f74   key == "dwell_t
-00018da0: 696d 6522 3a0a 2020 2020 2020 2020 2020  ime":.          
-00018db0: 2020 6265 616d 2e73 6361 6e6e 696e 672e    beam.scanning.
-00018dc0: 6477 656c 6c5f 7469 6d65 2e76 616c 7565  dwell_time.value
-00018dd0: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
-00018de0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-00018df0: 6f28 6622 7b62 6561 6d5f 7479 7065 2e6e  o(f"{beam_type.n
-00018e00: 616d 657d 2064 7765 6c6c 2074 696d 6520  ame} dwell time 
-00018e10: 7365 7420 746f 207b 7661 6c75 657d 2073  set to {value} s
-00018e20: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-00018e30: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
-00018e40: 6620 6b65 7920 3d3d 2022 7363 616e 5f72  f key == "scan_r
-00018e50: 6f74 6174 696f 6e22 3a0a 2020 2020 2020  otation":.      
-00018e60: 2020 2020 2020 6265 616d 2e73 6361 6e6e        beam.scann
-00018e70: 696e 672e 726f 7461 7469 6f6e 2e76 616c  ing.rotation.val
-00018e80: 7565 203d 2076 616c 7565 0a20 2020 2020  ue = value.     
-00018e90: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00018ea0: 6e66 6f28 6622 7b62 6561 6d5f 7479 7065  nfo(f"{beam_type
-00018eb0: 2e6e 616d 657d 2073 6361 6e20 726f 7461  .name} scan rota
-00018ec0: 7469 6f6e 2073 6574 2074 6f20 7b76 616c  tion set to {val
-00018ed0: 7565 7d20 7261 6469 616e 732e 2229 0a20  ue} radians."). 
-00018ee0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00018ef0: 6e0a 2020 2020 2020 2020 6966 206b 6579  n.        if key
-00018f00: 203d 3d20 2273 6869 6674 223a 0a20 2020   == "shift":.   
-00018f10: 2020 2020 2020 2020 2062 6561 6d2e 6265           beam.be
-00018f20: 616d 5f73 6869 6674 2e76 616c 7565 203d  am_shift.value =
-00018f30: 2054 6865 726d 6f50 6f69 6e74 282d 7661   ThermoPoint(-va
-00018f40: 6c75 652e 782c 2076 616c 7565 2e79 290a  lue.x, value.y).
-00018f50: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00018f60: 696e 672e 696e 666f 2866 227b 6265 616d  ing.info(f"{beam
-00018f70: 5f74 7970 652e 6e61 6d65 7d20 7368 6966  _type.name} shif
-00018f80: 7420 7365 7420 746f 207b 7661 6c75 657d  t set to {value}
-00018f90: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-00018fa0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
-00018fb0: 6620 6b65 7920 3d3d 2022 7374 6967 6d61  f key == "stigma
-00018fc0: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
-00018fd0: 2020 2062 6561 6d2e 7374 6967 6d61 746f     beam.stigmato
-00018fe0: 722e 7661 6c75 6520 3d20 5468 6572 6d6f  r.value = Thermo
-00018ff0: 506f 696e 7428 7661 6c75 652e 782c 2076  Point(value.x, v
-00019000: 616c 7565 2e79 290a 2020 2020 2020 2020  alue.y).        
-00019010: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00019020: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
-00019030: 6d65 7d20 7374 6967 6d61 7469 6f6e 2073  me} stigmation s
-00019040: 6574 2074 6f20 7b76 616c 7565 7d2e 2229  et to {value}.")
-00019050: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00019060: 7572 6e0a 2020 2020 2020 2020 0a20 2020  urn.        .   
-00019070: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00019080: 7265 736f 6c75 7469 6f6e 223a 0a20 2020  resolution":.   
-00019090: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-000190a0: 696f 6e20 3d20 6622 7b76 616c 7565 5b30  ion = f"{value[0
-000190b0: 5d7d 787b 7661 6c75 655b 315d 7d22 2020  ]}x{value[1]}"  
-000190c0: 2320 5769 6474 6878 4865 6967 6874 2065  # WidthxHeight e
-000190d0: 2e67 2e20 3135 3336 7831 3032 340a 2020  .g. 1536x1024.  
-000190e0: 2020 2020 2020 2020 2020 6265 616d 2e73            beam.s
-000190f0: 6361 6e6e 696e 672e 7265 736f 6c75 7469  canning.resoluti
-00019100: 6f6e 2e76 616c 7565 203d 2072 6573 6f6c  on.value = resol
-00019110: 7574 696f 6e0a 2020 2020 2020 2020 2020  ution.          
-00019120: 2020 7265 7475 726e 200a 2020 2020 2020    return .      
-00019130: 2020 0a20 2020 2020 2020 2023 2062 6561    .        # bea
-00019140: 6d20 636f 6e74 726f 6c0a 2020 2020 2020  m control.      
-00019150: 2020 6966 206b 6579 203d 3d20 226f 6e22    if key == "on"
-00019160: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
-00019170: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
-00019180: 7970 652c 2073 656c 662e 7379 7374 656d  ype, self.system
-00019190: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
-000191a0: 616d 2e74 7572 6e5f 6f6e 2829 2069 6620  am.turn_on() if 
-000191b0: 7661 6c75 6520 656c 7365 2062 6561 6d2e  value else beam.
-000191c0: 7475 726e 5f6f 6666 2829 0a20 2020 2020  turn_off().     
-000191d0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-000191e0: 6e66 6f28 6622 7b62 6561 6d5f 7479 7065  nfo(f"{beam_type
-000191f0: 2e6e 616d 657d 2062 6561 6d20 7475 726e  .name} beam turn
-00019200: 6564 207b 276f 6e27 2069 6620 7661 6c75  ed {'on' if valu
-00019210: 6520 656c 7365 2027 6f66 6627 7d2e 2229  e else 'off'}.")
-00019220: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00019230: 7572 6e0a 2020 2020 2020 2020 6966 206b  urn.        if k
-00019240: 6579 203d 3d20 2262 6c61 6e6b 6564 223a  ey == "blanked":
-00019250: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
-00019260: 6563 6b5f 6265 616d 2862 6561 6d5f 7479  eck_beam(beam_ty
-00019270: 7065 2c20 7365 6c66 2e73 7973 7465 6d29  pe, self.system)
-00019280: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
-00019290: 6d2e 626c 616e 6b28 2920 6966 2076 616c  m.blank() if val
-000192a0: 7565 2065 6c73 6520 6265 616d 2e75 6e62  ue else beam.unb
-000192b0: 6c61 6e6b 2829 0a20 2020 2020 2020 2020  lank().         
-000192c0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-000192d0: 6622 7b62 6561 6d5f 7479 7065 2e6e 616d  f"{beam_type.nam
-000192e0: 657d 2062 6561 6d20 7b27 626c 616e 6b65  e} beam {'blanke
-000192f0: 6427 2069 6620 7661 6c75 6520 656c 7365  d' if value else
-00019300: 2027 756e 626c 616e 6b65 6427 7d2e 2229   'unblanked'}.")
-00019310: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00019320: 7572 6e0a 0a20 2020 2020 2020 2023 2064  urn..        # d
-00019330: 6574 6563 746f 7220 7072 6f70 6572 7469  etector properti
-00019340: 6573 0a20 2020 2020 2020 2069 6620 6b65  es.        if ke
-00019350: 7920 696e 205b 2264 6574 6563 746f 725f  y in ["detector_
-00019360: 6d6f 6465 222c 2022 6465 7465 6374 6f72  mode", "detector
-00019370: 5f74 7970 6522 2c20 2264 6574 6563 746f  _type", "detecto
-00019380: 725f 6272 6967 6874 6e65 7373 222c 2022  r_brightness", "
-00019390: 6465 7465 6374 6f72 5f63 6f6e 7472 6173  detector_contras
-000193a0: 7422 5d3a 0a20 2020 2020 2020 2020 2020  t"]:.           
-000193b0: 2023 2073 6574 2062 6561 6d20 6163 7469   # set beam acti
-000193c0: 7665 2076 6965 7720 616e 6420 6465 7669  ve view and devi
-000193d0: 6365 0a20 2020 2020 2020 2020 2020 2073  ce.            s
-000193e0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
-000193f0: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
-00019400: 655f 7669 6577 2862 6561 6d5f 7479 7065  e_view(beam_type
-00019410: 2e76 616c 7565 290a 2020 2020 2020 2020  .value).        
-00019420: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00019430: 696f 6e2e 696d 6167 696e 672e 7365 745f  ion.imaging.set_
-00019440: 6163 7469 7665 5f64 6576 6963 6528 6265  active_device(be
-00019450: 616d 5f74 7970 652e 7661 6c75 6529 0a0a  am_type.value)..
-00019460: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00019470: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-00019480: 6d6f 6465 223a 0a20 2020 2020 2020 2020  mode":.         
-00019490: 2020 2020 2020 2069 6620 7661 6c75 6520         if value 
-000194a0: 696e 2073 656c 662e 636f 6e6e 6563 7469  in self.connecti
-000194b0: 6f6e 2e64 6574 6563 746f 722e 6d6f 6465  on.detector.mode
-000194c0: 2e61 7661 696c 6162 6c65 5f76 616c 7565  .available_value
-000194d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000194e0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000194f0: 6563 7469 6f6e 2e64 6574 6563 746f 722e  ection.detector.
-00019500: 6d6f 6465 2e76 616c 7565 203d 2076 616c  mode.value = val
-00019510: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00019520: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00019530: 6e66 6f28 6622 4465 7465 6374 6f72 206d  nfo(f"Detector m
-00019540: 6f64 6520 7365 7420 746f 207b 7661 6c75  ode set to {valu
-00019550: 657d 2e22 290a 2020 2020 2020 2020 2020  e}.").          
-00019560: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00019570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019580: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-00019590: 6622 4465 7465 6374 6f72 206d 6f64 6520  f"Detector mode 
-000195a0: 7b76 616c 7565 7d20 6e6f 7420 6176 6169  {value} not avai
-000195b0: 6c61 626c 652e 2229 0a20 2020 2020 2020  lable.").       
-000195c0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000195d0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-000195e0: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-000195f0: 7479 7065 223a 0a20 2020 2020 2020 2020  type":.         
-00019600: 2020 2020 2020 2069 6620 7661 6c75 6520         if value 
-00019610: 696e 2073 656c 662e 636f 6e6e 6563 7469  in self.connecti
-00019620: 6f6e 2e64 6574 6563 746f 722e 7479 7065  on.detector.type
-00019630: 2e61 7661 696c 6162 6c65 5f76 616c 7565  .available_value
-00019640: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00019650: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00019660: 6563 7469 6f6e 2e64 6574 6563 746f 722e  ection.detector.
-00019670: 7479 7065 2e76 616c 7565 203d 2076 616c  type.value = val
-00019680: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00019690: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-000196a0: 6e66 6f28 6622 4465 7465 6374 6f72 2074  nfo(f"Detector t
-000196b0: 7970 6520 7365 7420 746f 207b 7661 6c75  ype set to {valu
-000196c0: 657d 2e22 290a 2020 2020 2020 2020 2020  e}.").          
-000196d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000196e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196f0: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-00019700: 6622 4465 7465 6374 6f72 2074 7970 6520  f"Detector type 
-00019710: 7b76 616c 7565 7d20 6e6f 7420 6176 6169  {value} not avai
-00019720: 6c61 626c 652e 2229 0a20 2020 2020 2020  lable.").       
-00019730: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00019740: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-00019750: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-00019760: 6272 6967 6874 6e65 7373 223a 0a20 2020  brightness":.   
-00019770: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00019780: 3020 3c20 7661 6c75 6520 3c3d 2031 203a  0 < value <= 1 :
-00019790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000197a0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-000197b0: 7469 6f6e 2e64 6574 6563 746f 722e 6272  tion.detector.br
-000197c0: 6967 6874 6e65 7373 2e76 616c 7565 203d  ightness.value =
-000197d0: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-000197e0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-000197f0: 6e67 2e69 6e66 6f28 6622 4465 7465 6374  ng.info(f"Detect
-00019800: 6f72 2062 7269 6768 746e 6573 7320 7365  or brightness se
-00019810: 7420 746f 207b 7661 6c75 657d 2e22 290a  t to {value}.").
-00019820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019830: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00019840: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00019850: 672e 7761 726e 696e 6728 6622 4465 7465  g.warning(f"Dete
-00019860: 6374 6f72 2062 7269 6768 746e 6573 7320  ctor brightness 
-00019870: 7b76 616c 7565 7d20 6e6f 7420 6176 6169  {value} not avai
-00019880: 6c61 626c 652c 206d 7573 7420 6265 2062  lable, must be b
-00019890: 6574 7765 656e 2030 2061 6e64 2031 2e22  etween 0 and 1."
-000198a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000198b0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-000198c0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-000198d0: 6465 7465 6374 6f72 5f63 6f6e 7472 6173  detector_contras
-000198e0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
-000198f0: 2020 2020 6966 2030 203c 2076 616c 7565      if 0 < value
-00019900: 203c 3d20 3120 3a0a 2020 2020 2020 2020   <= 1 :.        
-00019910: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019920: 2e63 6f6e 6e65 6374 696f 6e2e 6465 7465  .connection.dete
-00019930: 6374 6f72 2e63 6f6e 7472 6173 742e 7661  ctor.contrast.va
-00019940: 6c75 6520 3d20 7661 6c75 650a 2020 2020  lue = value.    
-00019950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019960: 6c6f 6767 696e 672e 696e 666f 2866 2244  logging.info(f"D
-00019970: 6574 6563 746f 7220 636f 6e74 7261 7374  etector contrast
-00019980: 2073 6574 2074 6f20 7b76 616c 7565 7d2e   set to {value}.
-00019990: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-000199a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000199b0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000199c0: 6769 6e67 2e77 6172 6e69 6e67 2866 2244  ging.warning(f"D
-000199d0: 6574 6563 746f 7220 636f 6e74 7261 7374  etector contrast
-000199e0: 207b 7661 6c75 657d 206e 6f74 2061 7661   {value} not ava
-000199f0: 696c 6162 6c65 2c20 6d75 7420 6265 2062  ilable, mut be b
-00019a00: 6574 7765 656e 2030 2061 6e64 2031 2e22  etween 0 and 1."
-00019a10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00019a20: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00019a30: 2020 2320 7379 7374 656d 2070 726f 7065    # system prope
-00019a40: 7274 6965 730a 2020 2020 2020 2020 6966  rties.        if
-00019a50: 206b 6579 203d 3d20 2262 6561 6d5f 656e   key == "beam_en
-00019a60: 6162 6c65 6422 3a0a 2020 2020 2020 2020  abled":.        
-00019a70: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
-00019a80: 2069 7320 4265 616d 5479 7065 2e45 4c45   is BeamType.ELE
-00019a90: 4354 524f 4e3a 0a20 2020 2020 2020 2020  CTRON:.         
-00019aa0: 2020 2020 2020 2073 656c 662e 7379 7374         self.syst
-00019ab0: 656d 2e65 6c65 6374 726f 6e2e 6265 616d  em.electron.beam
-00019ac0: 2e65 6e61 626c 6564 203d 2076 616c 7565  .enabled = value
-00019ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ae0: 2072 6574 7572 6e20 0a20 2020 2020 2020   return .       
-00019af0: 2020 2020 2065 6c69 6620 6265 616d 5f74       elif beam_t
-00019b00: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00019b10: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
-00019b20: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
-00019b30: 2e69 6f6e 2e62 6561 6d2e 656e 6162 6c65  .ion.beam.enable
-00019b40: 6420 3d20 7661 6c75 650a 2020 2020 2020  d = value.      
-00019b50: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00019b60: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00019b70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00019b80: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00019b90: 726f 7228 6622 556e 6b6e 6f77 6e20 6265  ror(f"Unknown be
-00019ba0: 616d 2074 7970 653a 207b 6265 616d 5f74  am type: {beam_t
-00019bb0: 7970 657d 2066 6f72 207b 6b65 797d 2229  ype} for {key}")
-00019bc0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00019bd0: 7572 6e0a 0a20 2020 2020 2020 2069 6620  urn..        if 
-00019be0: 6b65 7920 3d3d 2022 6575 6365 6e74 7269  key == "eucentri
-00019bf0: 635f 6865 6967 6874 223a 0a20 2020 2020  c_height":.     
-00019c00: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-00019c10: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00019c20: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-00019c30: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00019c40: 7973 7465 6d2e 656c 6563 7472 6f6e 2e65  ystem.electron.e
-00019c50: 7563 656e 7472 6963 5f68 6569 6768 7420  ucentric_height 
-00019c60: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00019c70: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00019c80: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00019c90: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
-00019ca0: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
-00019cb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019cc0: 7379 7374 656d 2e69 6f6e 2e65 7563 656e  system.ion.eucen
-00019cd0: 7472 6963 5f68 6569 6768 7420 3d20 7661  tric_height = va
-00019ce0: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
-00019cf0: 2020 2020 7265 7475 726e 200a 2020 2020      return .    
-00019d00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00019d10: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00019d20: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
-00019d30: 2255 6e6b 6e6f 776e 2062 6561 6d20 7479  "Unknown beam ty
-00019d40: 7065 3a20 7b62 6561 6d5f 7479 7065 7d20  pe: {beam_type} 
-00019d50: 666f 7220 7b6b 6579 7d22 290a 0a20 2020  for {key}")..   
-00019d60: 2020 2020 2069 6620 6b65 7920 3d3d 2263       if key =="c
-00019d70: 6f6c 756d 6e5f 7469 6c74 223a 0a20 2020  olumn_tilt":.   
-00019d80: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
-00019d90: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
-00019da0: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
-00019db0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019dc0: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
-00019dd0: 2e63 6f6c 756d 6e5f 7469 6c74 203d 2076  .column_tilt = v
-00019de0: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-00019df0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00019e00: 2020 2020 2020 2020 656c 6966 2062 6561          elif bea
-00019e10: 6d5f 7479 7065 2069 7320 4265 616d 5479  m_type is BeamTy
-00019e20: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
-00019e30: 2020 2020 2020 2020 7365 6c66 2e73 7973          self.sys
-00019e40: 7465 6d2e 696f 6e2e 636f 6c75 6d6e 5f74  tem.ion.column_t
-00019e50: 696c 7420 3d20 7661 6c75 650a 2020 2020  ilt = value.    
-00019e60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00019e70: 726e 200a 2020 2020 2020 2020 2020 2020  rn .            
-00019e80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00019e90: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00019ea0: 6545 7272 6f72 2866 2255 6e6b 6e6f 776e  eError(f"Unknown
-00019eb0: 2062 6561 6d20 7479 7065 3a20 7b62 6561   beam type: {bea
-00019ec0: 6d5f 7479 7065 7d20 666f 7220 7b6b 6579  m_type} for {key
-00019ed0: 7d22 290a 0a20 2020 2020 2020 2023 2069  }")..        # i
-00019ee0: 6f6e 2062 6561 6d20 7072 6f70 6572 7469  on beam properti
-00019ef0: 6573 0a20 2020 2020 2020 2069 6620 6b65  es.        if ke
-00019f00: 7920 3d3d 2022 706c 6173 6d61 223a 0a20  y == "plasma":. 
-00019f10: 2020 2020 2020 2020 2020 2069 6620 6265             if be
-00019f20: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
-00019f30: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
-00019f40: 2020 2020 2020 2020 2073 656c 662e 7379           self.sy
-00019f50: 7374 656d 2e69 6f6e 2e70 6c61 736d 6120  stem.ion.plasma 
-00019f60: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00019f70: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00019f80: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00019f90: 2020 2020 2320 656c 6563 7472 6f6e 2062      # electron b
-00019fa0: 6561 6d20 7072 6f70 6572 7469 6573 0a20  eam properties. 
-00019fb0: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-00019fc0: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00019fd0: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-00019fe0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-00019ff0: 2261 6e67 756c 6172 5f63 6f72 7265 6374  "angular_correct
-0001a000: 696f 6e5f 616e 676c 6522 3a0a 2020 2020  ion_angle":.    
-0001a010: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-0001a020: 2e61 6e67 756c 6172 5f63 6f72 7265 6374  .angular_correct
-0001a030: 696f 6e2e 616e 676c 652e 7661 6c75 6520  ion.angle.value 
-0001a040: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-0001a050: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0001a060: 696e 666f 2866 2241 6e67 756c 6172 2063  info(f"Angular c
-0001a070: 6f72 7265 6374 696f 6e20 616e 676c 6520  orrection angle 
-0001a080: 7365 7420 746f 207b 7661 6c75 657d 2072  set to {value} r
-0001a090: 6164 6961 6e73 2e22 290a 2020 2020 2020  adians.").      
-0001a0a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001a0b0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0001a0c0: 206b 6579 203d 3d20 2261 6e67 756c 6172   key == "angular
-0001a0d0: 5f63 6f72 7265 6374 696f 6e5f 7469 6c74  _correction_tilt
-0001a0e0: 5f63 6f72 7265 6374 696f 6e22 3a0a 2020  _correction":.  
-0001a0f0: 2020 2020 2020 2020 2020 2020 2020 6265                be
-0001a100: 616d 2e61 6e67 756c 6172 5f63 6f72 7265  am.angular_corre
-0001a110: 6374 696f 6e2e 7469 6c74 5f63 6f72 7265  ction.tilt_corre
-0001a120: 6374 696f 6e2e 7475 726e 5f6f 6e28 2920  ction.turn_on() 
-0001a130: 6966 2076 616c 7565 2065 6c73 6520 6265  if value else be
-0001a140: 616d 2e61 6e67 756c 6172 5f63 6f72 7265  am.angular_corre
-0001a150: 6374 696f 6e2e 7469 6c74 5f63 6f72 7265  ction.tilt_corre
-0001a160: 6374 696f 6e2e 7475 726e 5f6f 6666 2829  ction.turn_off()
-0001a170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a180: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-0001a190: 0a20 2020 2020 2020 2023 2069 6f6e 2062  .        # ion b
-0001a1a0: 6561 6d20 7072 6f70 6572 7469 6573 0a20  eam properties. 
-0001a1b0: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-0001a1c0: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-0001a1d0: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
-0001a1e0: 2069 6620 6b65 7920 3d3d 2022 706c 6173   if key == "plas
-0001a1f0: 6d61 5f67 6173 223a 0a20 2020 2020 2020  ma_gas":.       
-0001a200: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001a210: 7365 6c66 2e73 7973 7465 6d2e 696f 6e2e  self.system.ion.
-0001a220: 706c 6173 6d61 3a0a 2020 2020 2020 2020  plasma:.        
-0001a230: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0001a240: 696e 672e 6465 6275 6728 6622 506c 6173  ing.debug(f"Plas
-0001a250: 6d61 2067 6173 2063 616e 6e6f 7420 6265  ma gas cannot be
-0001a260: 2073 6574 206f 6e20 7468 6973 206d 6963   set on this mic
-0001a270: 726f 7363 6f70 652e 2229 0a20 2020 2020  roscope.").     
-0001a280: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001a290: 6574 7572 6e0a 2020 2020 2020 2020 2020  eturn.          
-0001a2a0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-0001a2b0: 662e 6368 6563 6b5f 6176 6169 6c61 626c  f.check_availabl
-0001a2c0: 655f 7661 6c75 6573 2822 706c 6173 6d61  e_values("plasma
-0001a2d0: 5f67 6173 222c 205b 7661 6c75 655d 2c20  _gas", [value], 
-0001a2e0: 6265 616d 5f74 7970 6529 3a0a 2020 2020  beam_type):.    
-0001a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a300: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-0001a310: 6622 506c 6173 6d61 2067 6173 207b 7661  f"Plasma gas {va
-0001a320: 6c75 657d 206e 6f74 2061 7661 696c 6162  lue} not availab
-0001a330: 6c65 2e20 4176 6169 6c61 626c 6520 7661  le. Available va
-0001a340: 6c75 6573 3a20 7b73 656c 662e 6765 745f  lues: {self.get_
-0001a350: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
-0001a360: 2827 706c 6173 6d61 5f67 6173 272c 2062  ('plasma_gas', b
-0001a370: 6561 6d5f 7479 7065 297d 2229 0a20 2020  eam_type)}").   
-0001a380: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0001a390: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0001a3a0: 6767 696e 672e 696e 666f 2866 2253 6574  gging.info(f"Set
-0001a3b0: 7469 6e67 2070 6c61 736d 6120 6761 7320  ting plasma gas 
-0001a3c0: 746f 207b 7661 6c75 657d 2e2e 2e20 7468  to {value}... th
-0001a3d0: 6973 206d 6179 2074 616b 6520 736f 6d65  is may take some
-0001a3e0: 2074 696d 652e 2e2e 2229 0a20 2020 2020   time...").     
-0001a3f0: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
-0001a400: 736f 7572 6365 2e70 6c61 736d 615f 6761  source.plasma_ga
-0001a410: 732e 7661 6c75 6520 3d20 7661 6c75 650a  s.value = value.
-0001a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a430: 6c6f 6767 696e 672e 696e 666f 2866 2250  logging.info(f"P
-0001a440: 6c61 736d 6120 6761 7320 7365 7420 746f  lasma gas set to
-0001a450: 207b 7661 6c75 657d 2e22 290a 0a20 2020   {value}.")..   
-0001a460: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001a470: 7572 6e0a 2020 2020 2020 2020 0a20 2020  urn.        .   
-0001a480: 2020 2020 2023 2073 7461 6765 2070 726f       # stage pro
-0001a490: 7065 7274 6965 730a 2020 2020 2020 2020  perties.        
-0001a4a0: 6966 206b 6579 203d 3d20 2273 7461 6765  if key == "stage
-0001a4b0: 5f68 6f6d 6522 3a0a 2020 2020 2020 2020  _home":.        
-0001a4c0: 2020 2020 5f63 6865 636b 5f73 7461 6765      _check_stage
-0001a4d0: 2873 656c 662e 7379 7374 656d 290a 2020  (self.system).  
-0001a4e0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-0001a4f0: 672e 696e 666f 2866 2248 6f6d 696e 6720  g.info(f"Homing 
-0001a500: 7374 6167 652e 2e2e 2229 0a20 2020 2020  stage...").     
-0001a510: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0001a520: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
-0001a530: 7374 6167 652e 686f 6d65 2829 0a20 2020  stage.home().   
-0001a540: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-0001a550: 2e69 6e66 6f28 6622 5374 6167 6520 686f  .info(f"Stage ho
-0001a560: 6d65 642e 2229 0a20 2020 2020 2020 2020  med.").         
-0001a570: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0001a580: 2020 0a20 2020 2020 2020 2069 6620 6b65    .        if ke
-0001a590: 7920 3d3d 2022 7374 6167 655f 6c69 6e6b  y == "stage_link
-0001a5a0: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
-0001a5b0: 6368 6563 6b5f 7374 6167 6528 7365 6c66  check_stage(self
-0001a5c0: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
-0001a5d0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0001a5e0: 6f28 6622 4c69 6e6b 696e 6720 7374 6167  o(f"Linking stag
-0001a5f0: 652e 2e2e 2229 0a20 2020 2020 2020 2020  e...").         
-0001a600: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0001a610: 6f6e 2e73 7065 6369 6d65 6e2e 7374 6167  on.specimen.stag
-0001a620: 652e 6c69 6e6b 2829 2069 6620 7661 6c75  e.link() if valu
-0001a630: 6520 656c 7365 2073 656c 662e 636f 6e6e  e else self.conn
-0001a640: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
-0001a650: 7374 6167 652e 756e 6c69 6e6b 2829 0a20  stage.unlink(). 
-0001a660: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-0001a670: 6e67 2e69 6e66 6f28 6622 5374 6167 6520  ng.info(f"Stage 
-0001a680: 7b27 6c69 6e6b 6564 2720 6966 2076 616c  {'linked' if val
-0001a690: 7565 2065 6c73 6520 2775 6e6c 696e 6b65  ue else 'unlinke
-0001a6a0: 6427 7d2e 2229 2020 2020 0a20 2020 2020  d'}.")    .     
-0001a6b0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0001a6c0: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
-0001a6d0: 2063 6861 6d62 6572 2070 726f 7065 7274   chamber propert
-0001a6e0: 6965 730a 2020 2020 2020 2020 6966 206b  ies.        if k
-0001a6f0: 6579 203d 3d20 2270 756d 705f 6368 616d  ey == "pump_cham
-0001a700: 6265 7222 3a0a 2020 2020 2020 2020 2020  ber":.          
-0001a710: 2020 6966 2076 616c 7565 3a0a 2020 2020    if value:.    
-0001a720: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0001a730: 696e 672e 696e 666f 2866 2250 756d 7069  ing.info(f"Pumpi
-0001a740: 6e67 2063 6861 6d62 6572 2e2e 2e22 290a  ng chamber...").
-0001a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a760: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0001a770: 7661 6375 756d 2e70 756d 7028 290a 2020  vacuum.pump().  
-0001a780: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0001a790: 6767 696e 672e 696e 666f 2866 2243 6861  gging.info(f"Cha
-0001a7a0: 6d62 6572 2070 756d 7065 642e 2229 200a  mber pumped.") .
-0001a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7c0: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-0001a7d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001a7e0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-0001a7f0: 2e77 6172 6e69 6e67 2866 2249 6e76 616c  .warning(f"Inval
-0001a800: 6964 2076 616c 7565 2066 6f72 2070 756d  id value for pum
-0001a810: 705f 6368 616d 6265 723a 207b 7661 6c75  p_chamber: {valu
-0001a820: 657d 2e22 290a 2020 2020 2020 2020 2020  e}.").          
-0001a830: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0001a840: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0001a850: 2020 6966 206b 6579 203d 3d20 2276 656e    if key == "ven
-0001a860: 745f 6368 616d 6265 7222 3a0a 2020 2020  t_chamber":.    
-0001a870: 2020 2020 2020 2020 6966 2076 616c 7565          if value
-0001a880: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a890: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0001a8a0: 2256 656e 7469 6e67 2063 6861 6d62 6572  "Venting chamber
-0001a8b0: 2e2e 2e22 290a 2020 2020 2020 2020 2020  ...").          
-0001a8c0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0001a8d0: 6374 696f 6e2e 7661 6375 756d 2e76 656e  ction.vacuum.ven
-0001a8e0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0001a8f0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-0001a900: 2866 2243 6861 6d62 6572 2076 656e 7465  (f"Chamber vente
-0001a910: 642e 2229 200a 2020 2020 2020 2020 2020  d.") .          
-0001a920: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0001a930: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001a940: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001a950: 6f67 6769 6e67 2e77 6172 6e69 6e67 2866  ogging.warning(f
-0001a960: 2249 6e76 616c 6964 2076 616c 7565 2066  "Invalid value f
-0001a970: 6f72 2076 656e 745f 6368 616d 6265 723a  or vent_chamber:
-0001a980: 207b 7661 6c75 657d 2e22 290a 2020 2020   {value}.").    
-0001a990: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001a9a0: 726e 0a20 2020 2020 2020 2020 2020 200a  rn.            .
-0001a9b0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0001a9c0: 7761 726e 696e 6728 6622 556e 6b6e 6f77  warning(f"Unknow
-0001a9d0: 6e20 6b65 793a 207b 6b65 797d 2028 7b62  n key: {key} ({b
-0001a9e0: 6561 6d5f 7479 7065 7d29 2229 0a0a 2020  eam_type})")..  
-0001a9f0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-0001aa00: 200a 2020 2020 6465 6620 6368 6563 6b5f   .    def check_
-0001aa10: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
-0001aa20: 2873 656c 662c 206b 6579 3a73 7472 2c20  (self, key:str, 
-0001aa30: 7661 6c75 6573 3a20 6c69 7374 2c20 6265  values: list, be
-0001aa40: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-0001aa50: 6520 3d20 4e6f 6e65 2920 2d3e 2062 6f6f  e = None) -> boo
-0001aa60: 6c3a 0a0a 2020 2020 2020 2020 6176 6169  l:..        avai
-0001aa70: 6c61 626c 655f 7661 6c75 6573 203d 2073  lable_values = s
-0001aa80: 656c 662e 6765 745f 6176 6169 6c61 626c  elf.get_availabl
-0001aa90: 655f 7661 6c75 6573 286b 6579 2c20 6265  e_values(key, be
-0001aaa0: 616d 5f74 7970 6529 0a0a 2020 2020 2020  am_type)..      
-0001aab0: 2020 6966 2061 7661 696c 6162 6c65 5f76    if available_v
-0001aac0: 616c 7565 7320 6973 204e 6f6e 653a 0a20  alues is None:. 
-0001aad0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001aae0: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-0001aaf0: 0a20 2020 2020 2020 2066 6f72 2076 616c  .        for val
-0001ab00: 7565 2069 6e20 7661 6c75 6573 3a0a 2020  ue in values:.  
-0001ab10: 2020 2020 2020 2020 2020 6966 2076 616c            if val
-0001ab20: 7565 206e 6f74 2069 6e20 6176 6169 6c61  ue not in availa
-0001ab30: 626c 655f 7661 6c75 6573 3a0a 2020 2020  ble_values:.    
-0001ab40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001ab50: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
-0001ab60: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0001ab70: 6e63 6528 7661 6c75 652c 2066 6c6f 6174  nce(value, float
-0001ab80: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001ab90: 2020 2069 6620 7661 6c75 6520 3c20 6d69     if value < mi
-0001aba0: 6e28 6176 6169 6c61 626c 655f 7661 6c75  n(available_valu
-0001abb0: 6573 2920 6f72 2076 616c 7565 203e 206d  es) or value > m
-0001abc0: 6178 2861 7661 696c 6162 6c65 5f76 616c  ax(available_val
-0001abd0: 7565 7329 3a0a 2020 2020 2020 2020 2020  ues):.          
-0001abe0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001abf0: 2046 616c 7365 0a20 2020 2020 2020 2072   False.        r
-0001ac00: 6574 7572 6e20 5472 7565 0a20 2020 200a  eturn True.    .
-0001ac10: 0a63 6c61 7373 2054 6573 6361 6e4d 6963  .class TescanMic
-0001ac20: 726f 7363 6f70 6528 4669 6273 656d 4d69  roscope(FibsemMi
-0001ac30: 6372 6f73 636f 7065 293a 0a20 2020 2022  croscope):.    "
-0001ac40: 2222 0a20 2020 2041 2063 6c61 7373 2072  "".    A class r
-0001ac50: 6570 7265 7365 6e74 696e 6720 6120 5445  epresenting a TE
-0001ac60: 5343 414e 2046 4942 2d53 454d 206d 6963  SCAN FIB-SEM mic
-0001ac70: 726f 7363 6f70 652e 0a0a 2020 2020 5468  roscope...    Th
-0001ac80: 6973 2063 6c61 7373 2069 6e68 6572 6974  is class inherit
-0001ac90: 7320 6672 6f6d 2074 6865 2061 6273 7472  s from the abstr
-0001aca0: 6163 7420 6261 7365 2063 6c61 7373 2060  act base class `
-0001acb0: 4669 6273 656d 4d69 6372 6f73 636f 7065  FibsemMicroscope
-0001acc0: 602c 2077 6869 6368 2064 6566 696e 6573  `, which defines
-0001acd0: 2074 6865 2063 6f72 6520 6675 6e63 7469   the core functi
-0001ace0: 6f6e 616c 6974 7920 6f66 2061 0a20 2020  onality of a.   
-0001acf0: 206d 6963 726f 7363 6f70 652e 2049 6e20   microscope. In 
-0001ad00: 6164 6469 7469 6f6e 2074 6f20 7468 6520  addition to the 
-0001ad10: 6d65 7468 6f64 7320 6465 6669 6e65 6420  methods defined 
-0001ad20: 696e 2074 6865 2062 6173 6520 636c 6173  in the base clas
-0001ad30: 732c 2074 6869 7320 636c 6173 7320 7072  s, this class pr
-0001ad40: 6f76 6964 6573 2061 6464 6974 696f 6e61  ovides additiona
-0001ad50: 6c20 6d65 7468 6f64 7320 7370 6563 6966  l methods specif
-0001ad60: 6963 0a20 2020 2074 6f20 7468 6520 5445  ic.    to the TE
-0001ad70: 5343 414e 2046 4942 2d53 454d 206d 6963  SCAN FIB-SEM mic
-0001ad80: 726f 7363 6f70 652e 0a0a 2020 2020 4174  roscope...    At
-0001ad90: 7472 6962 7574 6573 3a0a 2020 2020 2020  tributes:.      
-0001ada0: 2020 636f 6e6e 6563 7469 6f6e 2028 4175    connection (Au
-0001adb0: 746f 6d61 7469 6f6e 293a 2054 6865 206d  tomation): The m
-0001adc0: 6963 726f 7363 6f70 6520 636c 6965 6e74  icroscope client
-0001add0: 2063 6f6e 6e65 6374 696f 6e2e 0a20 2020   connection..   
-0001ade0: 2020 2020 2069 6f6e 5f64 6574 6563 746f       ion_detecto
-0001adf0: 725f 6163 7469 7665 2028 4175 746f 6d61  r_active (Automa
-0001ae00: 7469 6f6e 2e46 4942 2e44 6574 6563 746f  tion.FIB.Detecto
-0001ae10: 7229 3a20 5468 6520 6163 7469 7665 2069  r): The active i
-0001ae20: 6f6e 2062 6561 6d20 6465 7465 6374 6f72  on beam detector
-0001ae30: 2e0a 2020 2020 2020 2020 6c61 7374 5f69  ..        last_i
-0001ae40: 6d61 6765 5f65 6220 2846 6962 7365 6d49  mage_eb (FibsemI
-0001ae50: 6d61 6765 293a 2041 2073 6176 6564 2063  mage): A saved c
-0001ae60: 6f70 7920 6f66 2074 6865 206d 6f73 7420  opy of the most 
-0001ae70: 7265 6365 6e74 2065 6c65 6374 726f 6e20  recent electron 
-0001ae80: 6265 616d 2069 6d61 6765 2e0a 2020 2020  beam image..    
-0001ae90: 2020 2020 6c61 7374 5f69 6d61 6765 5f69      last_image_i
-0001aea0: 6220 2846 6962 7365 6d49 6d61 6765 293a  b (FibsemImage):
-0001aeb0: 2041 2073 6176 6564 2063 6f70 7920 6f66   A saved copy of
-0001aec0: 2074 6865 206d 6f73 7420 7265 6365 6e74   the most recent
-0001aed0: 2069 6f6e 2062 6561 6d20 696d 6167 652e   ion beam image.
-0001aee0: 0a0a 2020 2020 496e 6865 7269 7465 6420  ..    Inherited 
-0001aef0: 4d65 7468 6f64 733a 0a20 2020 2020 2020  Methods:.       
-0001af00: 2063 6f6e 6e65 6374 5f74 6f5f 6d69 6372   connect_to_micr
-0001af10: 6f73 636f 7065 2873 656c 662c 2069 705f  oscope(self, ip_
-0001af20: 6164 6472 6573 733a 2073 7472 2c20 706f  address: str, po
-0001af30: 7274 3a20 696e 7420 3d20 3735 3230 2920  rt: int = 7520) 
-0001af40: 2d3e 204e 6f6e 653a 200a 2020 2020 2020  -> None: .      
-0001af50: 2020 2020 2020 436f 6e6e 6563 7420 746f        Connect to
-0001af60: 2061 2054 6865 726d 6f20 4669 7368 6572   a Thermo Fisher
-0001af70: 206d 6963 726f 7363 6f70 6520 6174 2074   microscope at t
-0001af80: 6865 2073 7065 6369 6669 6564 2049 5020  he specified IP 
-0001af90: 6164 6472 6573 7320 616e 6420 706f 7274  address and port
-0001afa0: 2e0a 0a20 2020 2020 2020 2064 6973 636f  ...        disco
-0001afb0: 6e6e 6563 7428 7365 6c66 2920 2d3e 204e  nnect(self) -> N
-0001afc0: 6f6e 653a 200a 2020 2020 2020 2020 2020  one: .          
-0001afd0: 2020 4469 7363 6f6e 6e65 6374 7320 7468    Disconnects th
-0001afe0: 6520 6d69 6372 6f73 636f 7065 2063 6c69  e microscope cli
-0001aff0: 656e 7420 636f 6e6e 6563 7469 6f6e 2e0a  ent connection..
-0001b000: 0a20 2020 2020 2020 2061 6371 7569 7265  .        acquire
-0001b010: 5f69 6d61 6765 2873 656c 662c 2069 6d61  _image(self, ima
-0001b020: 6765 5f73 6574 7469 6e67 733a 2049 6d61  ge_settings: Ima
-0001b030: 6765 5365 7474 696e 6773 2920 2d3e 2046  geSettings) -> F
-0001b040: 6962 7365 6d49 6d61 6765 3a20 0a20 2020  ibsemImage: .   
-0001b050: 2020 2020 2020 2020 2041 6371 7569 7265           Acquire
-0001b060: 2061 206e 6577 2069 6d61 6765 2077 6974   a new image wit
-0001b070: 6820 7468 6520 7370 6563 6966 6965 6420  h the specified 
-0001b080: 7365 7474 696e 6773 2e0a 0a20 2020 2020  settings...     
-0001b090: 2020 206c 6173 745f 696d 6167 6528 7365     last_image(se
-0001b0a0: 6c66 2c20 6265 616d 5f74 7970 653a 2042  lf, beam_type: B
-0001b0b0: 6561 6d54 7970 6520 3d20 4265 616d 5479  eamType = BeamTy
-0001b0c0: 7065 2e45 4c45 4354 524f 4e29 202d 3e20  pe.ELECTRON) -> 
-0001b0d0: 4669 6273 656d 496d 6167 653a 200a 2020  FibsemImage: .  
-0001b0e0: 2020 2020 2020 2020 2020 4765 7420 7468            Get th
-0001b0f0: 6520 6c61 7374 2070 7265 7669 6f75 736c  e last previousl
-0001b100: 7920 6163 7175 6972 6564 2069 6d61 6765  y acquired image
-0001b110: 2e0a 0a20 2020 2020 2020 2061 7574 6f63  ...        autoc
-0001b120: 6f6e 7472 6173 7428 7365 6c66 2c20 6265  ontrast(self, be
-0001b130: 616d 5f74 7970 653d 4265 616d 5479 7065  am_type=BeamType
-0001b140: 2e45 4c45 4354 524f 4e29 202d 3e20 4e6f  .ELECTRON) -> No
-0001b150: 6e65 3a20 0a20 2020 2020 2020 2020 2020  ne: .           
-0001b160: 2041 7574 6f6d 6174 6963 616c 6c79 2061   Automatically a
-0001b170: 646a 7573 7420 7468 6520 6d69 6372 6f73  djust the micros
-0001b180: 636f 7065 2069 6d61 6765 2063 6f6e 7472  cope image contr
-0001b190: 6173 7420 666f 7220 7468 6520 7370 6563  ast for the spec
-0001b1a0: 6966 6965 6420 6265 616d 2074 7970 652e  ified beam type.
-0001b1b0: 0a0a 2020 2020 2020 2020 6175 746f 5f66  ..        auto_f
-0001b1c0: 6f63 7573 2873 656c 662c 2062 6561 6d5f  ocus(self, beam_
-0001b1d0: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
-0001b1e0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0001b1f0: 2020 2020 2041 7574 6f6d 6174 6963 616c       Automatical
-0001b200: 6c79 2061 646a 7573 7420 7468 6520 6d69  ly adjust the mi
-0001b210: 6372 6f73 636f 7065 2066 6f63 7573 2066  croscope focus f
-0001b220: 6f72 2074 6865 2073 7065 6369 6669 6564  or the specified
-0001b230: 2062 6561 6d20 7479 7065 2e0a 0a20 2020   beam type...   
-0001b240: 2020 2020 2062 6561 6d5f 7368 6966 7428       beam_shift(
-0001b250: 7365 6c66 2c20 6478 3a20 666c 6f61 742c  self, dx: float,
-0001b260: 2064 793a 2066 6c6f 6174 2c20 2062 6561   dy: float,  bea
-0001b270: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
-0001b280: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001b290: 2020 2020 2020 2041 646a 7573 7473 2074         Adjusts t
-0001b2a0: 6865 2062 6561 6d20 7368 6966 7420 6f66  he beam shift of
-0001b2b0: 2067 6976 656e 2062 6561 6d20 6261 7365   given beam base
-0001b2c0: 6420 6f6e 2072 656c 6174 6976 6520 7661  d on relative va
-0001b2d0: 6c75 6573 2074 6861 7420 6172 6520 7072  lues that are pr
-0001b2e0: 6f76 6964 6564 2e0a 0a20 2020 2020 2020  ovided...       
-0001b2f0: 206d 6f76 655f 7374 6167 655f 6162 736f   move_stage_abso
-0001b300: 6c75 7465 2873 656c 662c 2070 6f73 6974  lute(self, posit
-0001b310: 696f 6e3a 2046 6962 7365 6d53 7461 6765  ion: FibsemStage
-0001b320: 506f 7369 7469 6f6e 293a 0a20 2020 2020  Position):.     
-0001b330: 2020 2020 2020 204d 6f76 6520 7468 6520         Move the 
-0001b340: 7374 6167 6520 746f 2074 6865 2073 7065  stage to the spe
-0001b350: 6369 6669 6564 2063 6f6f 7264 696e 6174  cified coordinat
-0001b360: 6573 2e0a 0a20 2020 2020 2020 206d 6f76  es...        mov
-0001b370: 655f 7374 6167 655f 7265 6c61 7469 7665  e_stage_relative
-0001b380: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
-0001b390: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
-0001b3a0: 7469 6f6e 293a 0a20 2020 2020 2020 2020  tion):.         
-0001b3b0: 2020 204d 6f76 6520 7468 6520 7374 6167     Move the stag
-0001b3c0: 6520 6279 2074 6865 2073 7065 6369 6669  e by the specifi
-0001b3d0: 6564 2072 656c 6174 6976 6520 6d6f 7665  ed relative move
-0001b3e0: 2e0a 0a20 2020 2020 2020 2073 7461 626c  ...        stabl
-0001b3f0: 655f 6d6f 7665 2873 656c 662c 2064 783a  e_move(self, dx:
-0001b400: 2066 6c6f 6174 2c20 6479 3a20 666c 6f61   float, dy: floa
-0001b410: 742c 2062 6561 6d5f 7479 7065 3a20 4265  t, beam_type: Be
-0001b420: 616d 5479 7065 2c29 202d 3e20 4e6f 6e65  amType,) -> None
-0001b430: 3a0a 2020 2020 2020 2020 2020 2020 4361  :.            Ca
-0001b440: 6c63 756c 6174 6520 7468 6520 636f 7272  lculate the corr
-0001b450: 6563 7465 6420 7374 6167 6520 6d6f 7665  ected stage move
-0001b460: 6d65 6e74 7320 6261 7365 6420 6f6e 2074  ments based on t
-0001b470: 6865 2062 6561 6d5f 7479 7065 2c20 616e  he beam_type, an
-0001b480: 6420 7468 656e 206d 6f76 6520 7468 6520  d then move the 
-0001b490: 7374 6167 6520 7265 6c61 7469 7665 6c79  stage relatively
-0001b4a0: 2e0a 0a20 2020 2020 2020 2076 6572 7469  ...        verti
-0001b4b0: 6361 6c5f 6d6f 7665 2873 656c 662c 2064  cal_move(self, d
-0001b4c0: 793a 2066 6c6f 6174 2c20 6478 3a20 666c  y: float, dx: fl
-0001b4d0: 6f61 7420 3d20 302e 302c 2073 7461 7469  oat = 0.0, stati
-0001b4e0: 635f 7764 3a20 626f 6f6c 203d 2054 7275  c_wd: bool = Tru
-0001b4f0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0001b500: 2020 2020 2020 2020 4d6f 7665 2074 6865          Move the
-0001b510: 2073 7461 6765 2076 6572 7469 6361 6c6c   stage verticall
-0001b520: 7920 746f 2063 6f72 7265 6374 2065 7563  y to correct euc
-0001b530: 656e 7472 6963 2070 6f69 6e74 0a20 2020  entric point.   
-0001b540: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0001b550: 2020 2020 2020 696e 7365 7274 5f6d 616e        insert_man
-0001b560: 6970 756c 6174 6f72 2873 656c 662c 206e  ipulator(self, n
-0001b570: 616d 653a 2073 7472 2920 2d3e 204e 6f6e  ame: str) -> Non
-0001b580: 653a 0a20 2020 2020 2020 2020 2020 2049  e:.            I
-0001b590: 6e73 6572 7420 7468 6520 6d61 6e69 7075  nsert the manipu
-0001b5a0: 6c61 746f 7220 696e 746f 2074 6865 2073  lator into the s
-0001b5b0: 616d 706c 652e 0a20 2020 2020 2020 200a  ample..        .
-0001b5c0: 2020 2020 2020 2020 7265 7472 6163 745f          retract_
-0001b5d0: 6d61 6e69 7075 6c61 746f 7228 7365 6c66  manipulator(self
-0001b5e0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001b5f0: 2020 2020 2020 2052 6574 7261 6374 2074         Retract t
-0001b600: 6865 206d 616e 6970 756c 6174 6f72 2066  he manipulator f
-0001b610: 726f 6d20 7468 6520 7361 6d70 6c65 2e0a  rom the sample..
-0001b620: 0a20 2020 2020 2020 206d 6f76 655f 6d61  .        move_ma
-0001b630: 6e69 7075 6c61 746f 725f 7265 6c61 7469  nipulator_relati
-0001b640: 7665 2873 656c 662c 2070 6f73 6974 696f  ve(self, positio
-0001b650: 6e3a 2046 6962 7365 6d4d 616e 6970 756c  n: FibsemManipul
-0001b660: 6174 6f72 506f 7369 7469 6f6e 2920 2d3e  atorPosition) ->
-0001b670: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001b680: 2020 204d 6f76 6520 7468 6520 6d61 6e69     Move the mani
-0001b690: 7075 6c61 746f 7220 6279 2074 6865 2073  pulator by the s
-0001b6a0: 7065 6369 6669 6564 2072 656c 6174 6976  pecified relativ
-0001b6b0: 6520 6d6f 7665 2e0a 2020 2020 2020 2020  e move..        
-0001b6c0: 0a20 2020 2020 2020 206d 6f76 655f 6d61  .        move_ma
-0001b6d0: 6e69 7075 6c61 746f 725f 6162 736f 6c75  nipulator_absolu
-0001b6e0: 7465 2873 656c 662c 2070 6f73 6974 696f  te(self, positio
-0001b6f0: 6e3a 2046 6962 7365 6d4d 616e 6970 756c  n: FibsemManipul
-0001b700: 6174 6f72 506f 7369 7469 6f6e 2920 2d3e  atorPosition) ->
-0001b710: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001b720: 2020 204d 6f76 6520 7468 6520 6d61 6e69     Move the mani
-0001b730: 7075 6c61 746f 7220 746f 2074 6865 2073  pulator to the s
-0001b740: 7065 6369 6669 6564 2063 6f6f 7264 696e  pecified coordin
-0001b750: 6174 6573 2e0a 0a20 2020 2020 2020 206d  ates...        m
-0001b760: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
-0001b770: 636f 7272 6563 7465 6428 7365 6c66 2c20  corrected(self, 
-0001b780: 6478 3a20 666c 6f61 742c 2064 793a 2066  dx: float, dy: f
-0001b790: 6c6f 6174 2c20 6265 616d 5f74 7970 653a  loat, beam_type:
-0001b7a0: 2042 6561 6d54 7970 6529 202d 3e20 4e6f   BeamType) -> No
-0001b7b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001b7c0: 4d6f 7665 2074 6865 206d 616e 6970 756c  Move the manipul
-0001b7d0: 6174 6f72 2062 7920 7468 6520 7370 6563  ator by the spec
-0001b7e0: 6966 6965 6420 7265 6c61 7469 7665 206d  ified relative m
-0001b7f0: 6f76 652c 2063 6f72 7265 6374 696e 6720  ove, correcting 
-0001b800: 666f 7220 7468 6520 6265 616d 2074 7970  for the beam typ
-0001b810: 652e 2020 2020 2020 0a0a 2020 2020 2020  e.      ..      
-0001b820: 2020 6d6f 7665 5f6d 616e 6970 756c 6174    move_manipulat
-0001b830: 6f72 5f74 6f5f 706f 7369 7469 6f6e 5f6f  or_to_position_o
-0001b840: 6666 7365 7428 7365 6c66 2c20 6f66 6673  ffset(self, offs
-0001b850: 6574 3a20 4669 6273 656d 4d61 6e69 7075  et: FibsemManipu
-0001b860: 6c61 746f 7250 6f73 6974 696f 6e2c 206e  latorPosition, n
-0001b870: 616d 653a 2073 7472 2920 2d3e 204e 6f6e  ame: str) -> Non
-0001b880: 653a 0a20 2020 2020 2020 2020 2020 204d  e:.            M
-0001b890: 6f76 6520 7468 6520 6d61 6e69 7075 6c61  ove the manipula
-0001b8a0: 746f 7220 746f 2074 6865 2073 7065 6369  tor to the speci
-0001b8b0: 6669 6564 2070 6f73 6974 696f 6e20 6f66  fied position of
-0001b8c0: 6673 6574 2e0a 0a20 2020 2020 2020 205f  fset...        _
-0001b8d0: 6765 745f 7361 7665 645f 6d61 6e69 7075  get_saved_manipu
-0001b8e0: 6c61 746f 725f 706f 7369 7469 6f6e 2873  lator_position(s
-0001b8f0: 656c 662c 206e 616d 653a 2073 7472 2920  elf, name: str) 
-0001b900: 2d3e 2046 6962 7365 6d4d 616e 6970 756c  -> FibsemManipul
-0001b910: 6174 6f72 506f 7369 7469 6f6e 3a0a 2020  atorPosition:.  
-0001b920: 2020 2020 2020 2020 2020 4765 7420 7468            Get th
-0001b930: 6520 7361 7665 6420 6d61 6e69 7075 6c61  e saved manipula
-0001b940: 746f 7220 706f 7369 7469 6f6e 2077 6974  tor position wit
-0001b950: 6820 7468 6520 7370 6563 6966 6965 6420  h the specified 
-0001b960: 6e61 6d65 2e0a 2020 2020 2020 2020 7365  name..        se
-0001b970: 7475 705f 6d69 6c6c 696e 6728 7365 6c66  tup_milling(self
-0001b980: 2c20 6d69 6c6c 5f73 6574 7469 6e67 733a  , mill_settings:
-0001b990: 2046 6962 7365 6d4d 696c 6c69 6e67 5365   FibsemMillingSe
-0001b9a0: 7474 696e 6773 293a 0a20 2020 2020 2020  ttings):.       
-0001b9b0: 2020 2020 2043 6f6e 6669 6775 7265 2074       Configure t
-0001b9c0: 6865 206d 6963 726f 7363 6f70 6520 666f  he microscope fo
-0001b9d0: 7220 6d69 6c6c 696e 6720 7573 696e 6720  r milling using 
-0001b9e0: 7468 6520 696f 6e20 6265 616d 2e0a 0a20  the ion beam... 
-0001b9f0: 2020 2020 2020 2072 756e 5f6d 696c 6c69         run_milli
-0001ba00: 6e67 2873 656c 662c 206d 696c 6c69 6e67  ng(self, milling
-0001ba10: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
-0001ba20: 2061 7379 6e63 683a 2062 6f6f 6c20 3d20   asynch: bool = 
-0001ba30: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-0001ba40: 2020 2020 5275 6e20 696f 6e20 6265 616d      Run ion beam
-0001ba50: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
-0001ba60: 6865 2073 7065 6369 6669 6564 206d 696c  he specified mil
-0001ba70: 6c69 6e67 2063 7572 7265 6e74 2e0a 0a20  ling current... 
-0001ba80: 2020 2020 2020 2064 6566 2072 756e 5f6d         def run_m
-0001ba90: 696c 6c69 6e67 5f64 7269 6674 5f63 6f72  illing_drift_cor
-0001baa0: 7265 6374 6564 2873 656c 662c 206d 696c  rected(self, mil
-0001bab0: 6c69 6e67 5f63 7572 7265 6e74 3a20 666c  ling_current: fl
-0001bac0: 6f61 742c 2069 6d61 6765 5f73 6574 7469  oat, image_setti
-0001bad0: 6e67 733a 2049 6d61 6765 5365 7474 696e  ngs: ImageSettin
-0001bae0: 6773 2c20 7265 665f 696d 6167 653a 2046  gs, ref_image: F
-0001baf0: 6962 7365 6d49 6d61 6765 2c20 7265 6475  ibsemImage, redu
-0001bb00: 6365 645f 6172 6561 3a20 4669 6273 656d  ced_area: Fibsem
-0001bb10: 5265 6374 616e 676c 6520 3d20 4e6f 6e65  Rectangle = None
-0001bb20: 2c20 6173 796e 6368 3a20 626f 6f6c 203d  , asynch: bool =
-0001bb30: 2046 616c 7365 293a 0a20 2020 2020 2020   False):.       
-0001bb40: 2052 756e 2069 6f6e 2062 6561 6d20 6d69   Run ion beam mi
-0001bb50: 6c6c 696e 6720 7573 696e 6720 7468 6520  lling using the 
-0001bb60: 7370 6563 6966 6965 6420 6d69 6c6c 696e  specified millin
-0001bb70: 6720 6375 7272 656e 742c 2061 6e64 2063  g current, and c
-0001bb80: 6f72 7265 6374 2066 6f72 2064 7269 6674  orrect for drift
-0001bb90: 2075 7369 6e67 2074 6865 2070 726f 7669   using the provi
-0001bba0: 6465 6420 7265 6665 7265 6e63 6520 696d  ded reference im
-0001bbb0: 6167 652e 0a0a 2020 2020 2020 2020 6669  age...        fi
-0001bbc0: 6e69 7368 5f6d 696c 6c69 6e67 2873 656c  nish_milling(sel
-0001bbd0: 662c 2069 6d61 6769 6e67 5f63 7572 7265  f, imaging_curre
-0001bbe0: 6e74 3a20 666c 6f61 7429 3a0a 2020 2020  nt: float):.    
-0001bbf0: 2020 2020 2020 2020 4669 6e61 6c69 7365          Finalise
-0001bc00: 7320 7468 6520 6d69 6c6c 696e 6720 7072  s the milling pr
-0001bc10: 6f63 6573 7320 6279 2063 6c65 6172 696e  ocess by clearin
-0001bc20: 6720 7468 6520 6d69 6372 6f73 636f 7065  g the microscope
-0001bc30: 206f 6620 616e 7920 7061 7474 6572 6e73   of any patterns
-0001bc40: 2061 6e64 2072 6574 7572 6e69 6e67 2074   and returning t
-0001bc50: 6865 2063 7572 7265 6e74 2074 6f20 7468  he current to th
-0001bc60: 6520 696d 6167 696e 6720 6375 7272 656e  e imaging curren
-0001bc70: 742e 0a0a 2020 2020 2020 2020 7365 7475  t...        setu
-0001bc80: 705f 7370 7574 7465 7228 7365 6c66 2c20  p_sputter(self, 
-0001bc90: 7072 6f74 6f63 6f6c 3a20 6469 6374 293a  protocol: dict):
-0001bca0: 0a20 2020 2020 2020 2020 2020 2053 6574  .            Set
-0001bcb0: 2075 7020 7468 6520 7370 7574 7465 7220   up the sputter 
-0001bcc0: 636f 6174 696e 6720 7072 6f63 6573 7320  coating process 
-0001bcd0: 6f6e 2074 6865 206d 6963 726f 7363 6f70  on the microscop
-0001bce0: 652e 0a0a 2020 2020 2020 2020 6472 6177  e...        draw
-0001bcf0: 5f73 7075 7474 6572 5f70 6174 7465 726e  _sputter_pattern
-0001bd00: 2873 656c 662c 2068 6677 3a20 666c 6f61  (self, hfw: floa
-0001bd10: 742c 206c 696e 655f 7061 7474 6572 6e5f  t, line_pattern_
-0001bd20: 6c65 6e67 7468 3a20 666c 6f61 742c 2073  length: float, s
-0001bd30: 7075 7474 6572 5f74 696d 653a 2066 6c6f  putter_time: flo
-0001bd40: 6174 293a 0a20 2020 2020 2020 2020 2020  at):.           
-0001bd50: 2044 7261 7773 2061 206c 696e 6520 7061   Draws a line pa
-0001bd60: 7474 6572 6e20 666f 7220 7370 7574 7465  ttern for sputte
-0001bd70: 7269 6e67 2077 6974 6820 7468 6520 6769  ring with the gi
-0001bd80: 7665 6e20 7061 7261 6d65 7465 7273 2e0a  ven parameters..
-0001bd90: 0a20 2020 2020 2020 2072 756e 5f73 7075  .        run_spu
-0001bda0: 7474 6572 2873 656c 662c 202a 2a6b 7761  tter(self, **kwa
-0001bdb0: 7267 7329 3a0a 2020 2020 2020 2020 2020  rgs):.          
-0001bdc0: 2020 5275 6e73 2074 6865 2047 4953 2050    Runs the GIS P
-0001bdd0: 6c61 7469 6e75 6d20 5370 7574 7465 722e  latinum Sputter.
-0001bde0: 0a0a 2020 2020 2020 2020 6669 6e69 7368  ..        finish
-0001bdf0: 5f73 7075 7474 6572 2873 656c 662c 2061  _sputter(self, a
-0001be00: 7070 6c69 6361 7469 6f6e 5f66 696c 653a  pplication_file:
-0001be10: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-0001be20: 2020 2020 2020 2020 2020 2046 696e 6973             Finis
-0001be30: 6820 7468 6520 7370 7574 7465 7220 7072  h the sputter pr
-0001be40: 6f63 6573 7320 6279 2063 6c65 6172 696e  ocess by clearin
-0001be50: 6720 7061 7474 6572 6e73 2061 6e64 2072  g patterns and r
-0001be60: 6573 6574 7469 6e67 2062 6561 6d20 616e  esetting beam an
-0001be70: 6420 696d 6167 696e 6720 7365 7474 696e  d imaging settin
-0001be80: 6773 2e0a 0a20 2020 2020 2020 2073 6574  gs...        set
-0001be90: 5f6d 6963 726f 7363 6f70 655f 7374 6174  _microscope_stat
-0001bea0: 6528 7365 6c66 2c20 6d69 6372 6f73 636f  e(self, microsco
-0001beb0: 7065 5f73 7461 7465 3a20 4d69 6372 6f73  pe_state: Micros
-0001bec0: 636f 7065 5374 6174 6529 202d 3e20 4e6f  copeState) -> No
-0001bed0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001bee0: 5265 7365 7420 7468 6520 6d69 6372 6f73  Reset the micros
-0001bef0: 636f 7065 2073 7461 7465 2074 6f20 7468  cope state to th
-0001bf00: 6520 7072 6f76 6964 6564 2073 7461 7465  e provided state
-0001bf10: 2e0a 2020 2020 2020 2020 0a20 2020 2020  ..        .     
-0001bf20: 2020 2067 6574 2873 656c 662c 206b 6579     get(self, key
-0001bf30: 3a73 7472 2c20 6265 616d 5f74 7970 653a  :str, beam_type:
-0001bf40: 2042 6561 6d54 7970 6520 3d20 4e6f 6e65   BeamType = None
-0001bf50: 293a 0a20 2020 2020 2020 2020 2020 2052  ):.            R
-0001bf60: 6574 7572 6e73 2074 6865 2076 616c 7565  eturns the value
-0001bf70: 206f 6620 7468 6520 7370 6563 6966 6965   of the specifie
-0001bf80: 6420 6b65 792e 0a0a 2020 2020 2020 2020  d key...        
-0001bf90: 7365 7428 7365 6c66 2c20 6b65 793a 2073  set(self, key: s
-0001bfa0: 7472 2c20 7661 6c75 652c 2062 6561 6d5f  tr, value, beam_
-0001bfb0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-0001bfc0: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
-0001bfd0: 2020 2020 2020 2020 2020 2020 5365 7473              Sets
-0001bfe0: 2074 6865 2076 616c 7565 206f 6620 7468   the value of th
-0001bff0: 6520 7370 6563 6966 6965 6420 6b65 792e  e specified key.
-0001c000: 0a0a 2020 2020 4e65 7720 6d65 7468 6f64  ..    New method
-0001c010: 733a 0a20 2020 2020 2020 205f 5f69 6e69  s:.        __ini
-0001c020: 745f 5f28 7365 6c66 293a 200a 2020 2020  t__(self): .    
-0001c030: 2020 2020 2020 2020 496e 6974 6961 6c69          Initiali
-0001c040: 7a65 7320 6120 6e65 7720 696e 7374 616e  zes a new instan
-0001c050: 6365 206f 6620 7468 6520 636c 6173 732e  ce of the class.
-0001c060: 0a0a 2020 2020 2020 2020 5f67 6574 5f65  ..        _get_e
-0001c070: 625f 696d 6167 6528 7365 6c66 2c20 696d  b_image(self, im
-0001c080: 6167 655f 7365 7474 696e 6773 3d49 6d61  age_settings=Ima
-0001c090: 6765 5365 7474 696e 6773 2920 2d3e 2046  geSettings) -> F
-0001c0a0: 6962 7365 6d49 6d61 6765 3a0a 2020 2020  ibsemImage:.    
-0001c0b0: 2020 2020 2020 2020 4163 7175 6972 6573          Acquires
-0001c0c0: 2061 6e20 656c 6563 7472 6f6e 2062 6561   an electron bea
-0001c0d0: 6d20 2845 4229 2069 6d61 6765 2077 6974  m (EB) image wit
-0001c0e0: 6820 7468 6520 6769 7665 6e20 7365 7474  h the given sett
-0001c0f0: 696e 6773 2061 6e64 2072 6574 7572 6e73  ings and returns
-0001c100: 2061 2046 6962 7365 6d49 6d61 6765 206f   a FibsemImage o
-0001c110: 626a 6563 742e 0a0a 2020 2020 2020 2020  bject...        
-0001c120: 5f67 6574 5f69 625f 696d 6167 6528 7365  _get_ib_image(se
-0001c130: 6c66 2c20 696d 6167 655f 7365 7474 696e  lf, image_settin
-0001c140: 6773 3d49 6d61 6765 5365 7474 696e 6773  gs=ImageSettings
-0001c150: 293a 0a20 2020 2020 2020 2020 2020 2041  ):.            A
-0001c160: 6371 7569 7265 7320 616e 2069 6f6e 2062  cquires an ion b
-0001c170: 6561 6d20 2849 4229 2069 6d61 6765 2077  eam (IB) image w
-0001c180: 6974 6820 7468 6520 6769 7665 6e20 7365  ith the given se
-0001c190: 7474 696e 6773 2061 6e64 2072 6574 7572  ttings and retur
-0001c1a0: 6e73 2061 2046 6962 7365 6d49 6d61 6765  ns a FibsemImage
-0001c1b0: 206f 626a 6563 742e 0a0a 2020 2020 2020   object...      
-0001c1c0: 2020 5f79 5f63 6f72 7265 6374 6564 5f73    _y_corrected_s
-0001c1d0: 7461 6765 5f6d 6f76 656d 656e 7428 7365  tage_movement(se
-0001c1e0: 6c66 2c20 6578 7065 6374 6564 5f79 3a20  lf, expected_y: 
-0001c1f0: 666c 6f61 742c 2062 6561 6d5f 7479 7065  float, beam_type
-0001c200: 3a20 4265 616d 5479 7065 203d 2042 6561  : BeamType = Bea
-0001c210: 6d54 7970 652e 454c 4543 5452 4f4e 2920  mType.ELECTRON) 
-0001c220: 2d3e 2046 6962 7365 6d53 7461 6765 506f  -> FibsemStagePo
-0001c230: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
-0001c240: 2020 2020 4361 6c63 756c 6174 6520 7468      Calculate th
-0001c250: 6520 7920 636f 7272 6563 7465 6420 7374  e y corrected st
-0001c260: 6167 6520 6d6f 7665 6d65 6e74 2c20 636f  age movement, co
-0001c270: 7272 6563 7465 6420 666f 7220 7468 6520  rrected for the 
-0001c280: 6164 6469 7469 6f6e 616c 2074 696c 7420  additional tilt 
-0001c290: 6f66 2074 6865 2073 616d 706c 6520 686f  of the sample ho
-0001c2a0: 6c64 6572 2028 7072 652d 7469 6c74 2061  lder (pre-tilt a
-0001c2b0: 6e67 6c65 292e 0a20 2020 2022 2222 0a0a  ngle)..    """..
-0001c2c0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-0001c2d0: 2873 656c 662c 2073 7973 7465 6d5f 7365  (self, system_se
-0001c2e0: 7474 696e 6773 3a20 5379 7374 656d 5365  ttings: SystemSe
-0001c2f0: 7474 696e 6773 2c20 6970 5f61 6464 7265  ttings, ip_addre
-0001c300: 7373 3a20 7374 7220 3d20 4e6f 6e65 293a  ss: str = None):
-0001c310: 0a20 2020 2020 2020 2069 6620 5f54 4553  .        if _TES
-0001c320: 4341 4e5f 4150 495f 4156 4149 4c41 424c  CAN_API_AVAILABL
-0001c330: 4520 3d3d 2046 616c 7365 3a0a 2020 2020  E == False:.    
-0001c340: 2020 2020 2020 2020 7261 6973 6520 496d          raise Im
-0001c350: 706f 7274 4572 726f 7228 2254 6865 2054  portError("The T
-0001c360: 4553 4341 4e20 4175 746f 6d61 7469 6f6e  ESCAN Automation
-0001c370: 2041 5049 2069 7320 6e6f 7420 6176 6169   API is not avai
-0001c380: 6c61 626c 652e 2050 6c65 6173 6520 7365  lable. Please se
-0001c390: 6520 7468 6520 7573 6572 2067 7569 6465  e the user guide
-0001c3a0: 2066 6f72 2069 6e73 7461 6c6c 6174 696f   for installatio
-0001c3b0: 6e20 696e 7374 7275 6374 696f 6e73 2e22  n instructions."
-0001c3c0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-0001c3d0: 2020 2069 6620 6970 5f61 6464 7265 7373     if ip_address
-0001c3e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001c3f0: 2020 2020 2020 6970 5f61 6464 7265 7373        ip_address
-0001c400: 203d 2073 7973 7465 6d5f 7365 7474 696e   = system_settin
-0001c410: 6773 2e69 6e66 6f2e 6970 5f61 6464 7265  gs.info.ip_addre
-0001c420: 7373 0a20 2020 2020 2020 200a 2020 2020  ss.        .    
-0001c430: 2020 2020 2320 6372 6561 7465 206d 6963      # create mic
-0001c440: 726f 7363 6f70 6520 636c 6965 6e74 0a20  roscope client. 
-0001c450: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0001c460: 6563 7469 6f6e 203d 2041 7574 6f6d 6174  ection = Automat
-0001c470: 696f 6e28 6970 5f61 6464 7265 7373 290a  ion(ip_address).
-0001c480: 0a20 2020 2020 2020 2023 2073 6574 2075  .        # set u
-0001c490: 7020 6465 7465 6374 6f72 7320 2020 2020  p detectors     
-0001c4a0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0001c4b0: 2020 2020 6465 7465 6374 6f72 7320 3d20      detectors = 
-0001c4c0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0001c4d0: 4649 422e 4465 7465 6374 6f72 2e45 6e75  FIB.Detector.Enu
-0001c4e0: 6d28 290a 2020 2020 2020 2020 7365 6c66  m().        self
-0001c4f0: 2e69 6f6e 5f64 6574 6563 746f 725f 6163  .ion_detector_ac
-0001c500: 7469 7665 203d 2064 6574 6563 746f 7273  tive = detectors
-0001c510: 5b30 5d0a 2020 2020 2020 2020 7365 6c66  [0].        self
-0001c520: 2e63 6f6e 6e65 6374 696f 6e2e 4649 422e  .connection.FIB.
-0001c530: 4465 7465 6374 6f72 2e53 6574 2843 6861  Detector.Set(Cha
-0001c540: 6e6e 656c 203d 2030 2c20 4465 7465 6374  nnel = 0, Detect
-0001c550: 6f72 3d20 7365 6c66 2e69 6f6e 5f64 6574  or= self.ion_det
-0001c560: 6563 746f 725f 6163 7469 7665 290a 2020  ector_active).  
-0001c570: 2020 2020 2020 7365 6c66 2e65 6c65 6374        self.elect
-0001c580: 726f 6e5f 6465 7465 6374 6f72 5f61 6374  ron_detector_act
-0001c590: 6976 6520 3d20 7365 6c66 2e63 6f6e 6e65  ive = self.conne
-0001c5a0: 6374 696f 6e2e 5345 4d2e 4465 7465 6374  ction.SEM.Detect
-0001c5b0: 6f72 2e53 4553 7569 7461 626c 6528 290a  or.SESuitable().
-0001c5c0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0001c5d0: 6e65 6374 696f 6e2e 5345 4d2e 4465 7465  nection.SEM.Dete
-0001c5e0: 6374 6f72 2e53 6574 2843 6861 6e6e 656c  ctor.Set(Channel
-0001c5f0: 203d 2030 2c20 4465 7465 6374 6f72 203d   = 0, Detector =
-0001c600: 2073 656c 662e 656c 6563 7472 6f6e 5f64   self.electron_d
-0001c610: 6574 6563 746f 725f 6163 7469 7665 290a  etector_active).
-0001c620: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
-0001c630: 7265 6e61 6d65 2074 6f20 6163 7469 7665  rename to active
-0001c640: 5f64 6574 6563 746f 725f 6265 616d 5f74  _detector_beam_t
-0001c650: 7970 650a 2020 2020 2020 2020 2320 544f  ype.        # TO
-0001c660: 444f 3a20 6d6f 7665 2074 6f20 636f 6e6e  DO: move to conn
-0001c670: 6563 745f 746f 5f6d 6963 726f 7363 6f70  ect_to_microscop
-0001c680: 650a 0a20 2020 2020 2020 2023 2069 6e69  e..        # ini
-0001c690: 7469 616c 6973 6520 7379 7374 656d 2073  tialise system s
-0001c6a0: 6574 7469 6e67 730a 2020 2020 2020 2020  ettings.        
-0001c6b0: 7365 6c66 2e73 7973 7465 6d3a 2053 7973  self.system: Sys
-0001c6c0: 7465 6d53 6574 7469 6e67 7320 3d20 7379  temSettings = sy
-0001c6d0: 7374 656d 5f73 6574 7469 6e67 730a 2020  stem_settings.  
-0001c6e0: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
-0001c6f0: 2075 7365 722c 2065 7870 6572 696d 656e   user, experimen
-0001c700: 7420 6d65 7461 6461 7461 0a20 2020 2020  t metadata.     
-0001c710: 2020 2023 2054 4f44 4f3a 2072 656d 6f76     # TODO: remov
-0001c720: 6520 6f6e 6365 2064 6220 696e 7465 6772  e once db integr
-0001c730: 6174 6564 0a20 2020 2020 2020 2073 656c  ated.        sel
-0001c740: 662e 7573 6572 203d 2046 6962 7365 6d55  f.user = FibsemU
-0001c750: 7365 722e 6672 6f6d 5f65 6e76 6972 6f6e  ser.from_environ
-0001c760: 6d65 6e74 2829 0a20 2020 2020 2020 2073  ment().        s
-0001c770: 656c 662e 6578 7065 7269 6d65 6e74 203d  elf.experiment =
-0001c780: 2046 6962 7365 6d45 7870 6572 696d 656e   FibsemExperimen
-0001c790: 7428 290a 0a20 2020 2020 2020 2023 2069  t()..        # i
-0001c7a0: 6e69 7469 616c 6973 6520 6c61 7374 2069  nitialise last i
-0001c7b0: 6d61 6765 730a 2020 2020 2020 2020 7365  mages.        se
-0001c7c0: 6c66 2e6c 6173 745f 696d 6167 655f 6562  lf.last_image_eb
-0001c7d0: 3a20 4669 6273 656d 496d 6167 6520 3d20  : FibsemImage = 
-0001c7e0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-0001c7f0: 662e 6c61 7374 5f69 6d61 6765 5f69 623a  f.last_image_ib:
-0001c800: 2046 6962 7365 6d49 6d61 6765 203d 204e   FibsemImage = N
-0001c810: 6f6e 650a 0a20 2020 2020 2020 2023 206c  one..        # l
-0001c820: 6f67 6769 6e67 0a20 2020 2020 2020 206c  ogging.        l
-0001c830: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
-0001c840: 7367 223a 2022 6372 6561 7465 5f6d 6963  sg": "create_mic
-0001c850: 726f 7363 6f70 655f 636c 6965 6e74 222c  roscope_client",
-0001c860: 2022 7379 7374 656d 5f73 6574 7469 6e67   "system_setting
-0001c870: 7322 3a20 7379 7374 656d 5f73 6574 7469  s": system_setti
-0001c880: 6e67 732e 746f 5f64 6963 7428 297d 290a  ngs.to_dict()}).
-0001c890: 2020 2020 0a0a 2020 2020 6465 6620 6469      ..    def di
-0001c8a0: 7363 6f6e 6e65 6374 2873 656c 6629 202d  sconnect(self) -
-0001c8b0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0001c8c0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0001c8d0: 4469 7363 6f6e 6e65 6374 2829 0a20 2020  Disconnect().   
-0001c8e0: 2020 2020 2064 656c 2073 656c 662e 636f       del self.co
-0001c8f0: 6e6e 6563 7469 6f6e 0a20 2020 2020 2020  nnection.       
-0001c900: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0001c910: 203d 204e 6f6e 650a 0a20 2020 2023 2040   = None..    # @
-0001c920: 636c 6173 736d 6574 686f 640a 2020 2020  classmethod.    
-0001c930: 6465 6620 636f 6e6e 6563 745f 746f 5f6d  def connect_to_m
-0001c940: 6963 726f 7363 6f70 6528 7365 6c66 2c20  icroscope(self, 
-0001c950: 6970 5f61 6464 7265 7373 3a20 7374 722c  ip_address: str,
-0001c960: 2070 6f72 743a 2069 6e74 203d 2038 3330   port: int = 830
-0001c970: 3029 202d 3e20 4e6f 6e65 3a0a 2020 2020  0) -> None:.    
-0001c980: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001c990: 2020 2020 436f 6e6e 6563 7473 2074 6f20      Connects to 
-0001c9a0: 6120 6d69 6372 6f73 636f 7065 2077 6974  a microscope wit
-0001c9b0: 6820 7468 6520 7370 6563 6966 6965 6420  h the specified 
-0001c9c0: 4950 2061 6464 7265 7373 2061 6e64 2070  IP address and p
-0001c9d0: 6f72 742e 0a0a 2020 2020 2020 2020 2020  ort...          
-0001c9e0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
-0001c9f0: 2020 2020 2020 2020 6970 5f61 6464 7265          ip_addre
-0001ca00: 7373 3a20 4120 7374 7269 6e67 2074 6861  ss: A string tha
-0001ca10: 7420 7265 7072 6573 656e 7473 2074 6865  t represents the
-0001ca20: 2049 5020 6164 6472 6573 7320 6f66 2074   IP address of t
-0001ca30: 6865 206d 6963 726f 7363 6f70 652e 0a20  he microscope.. 
-0001ca40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0001ca50: 6f72 743a 2041 6e20 696e 7465 6765 7220  ort: An integer 
-0001ca60: 7468 6174 2072 6570 7265 7365 6e74 7320  that represents 
-0001ca70: 7468 6520 706f 7274 206e 756d 6265 7220  the port number 
-0001ca80: 746f 2075 7365 2028 6465 6661 756c 7420  to use (default 
-0001ca90: 3833 3030 292e 0a0a 2020 2020 2020 2020  8300)...        
-0001caa0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001cab0: 2020 2020 2020 2020 2020 2020 204e 6f6e               Non
-0001cac0: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-0001cad0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0001cae0: 6e66 6f28 6622 4d69 6372 6f73 636f 7065  nfo(f"Microscope
-0001caf0: 2063 6c69 656e 7420 636f 6e6e 6563 7469   client connecti
-0001cb00: 6e67 2074 6f20 5b7b 6970 5f61 6464 7265  ng to [{ip_addre
-0001cb10: 7373 7d3a 7b70 6f72 747d 5d22 290a 2020  ss}:{port}]").  
-0001cb20: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0001cb30: 6374 696f 6e20 3d20 4175 746f 6d61 7469  ction = Automati
-0001cb40: 6f6e 2869 705f 6164 6472 6573 732c 2070  on(ip_address, p
-0001cb50: 6f72 7429 0a20 2020 2020 2020 206c 6f67  ort).        log
-0001cb60: 6769 6e67 2e69 6e66 6f28 6622 4d69 6372  ging.info(f"Micr
-0001cb70: 6f73 636f 7065 2063 6c69 656e 7420 636f  oscope client co
-0001cb80: 6e6e 6563 7465 6420 746f 205b 7b69 705f  nnected to [{ip_
-0001cb90: 6164 6472 6573 737d 3a7b 706f 7274 7d5d  address}:{port}]
-0001cba0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0001cbb0: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e44  connection.SEM.D
-0001cbc0: 6574 6563 746f 722e 5365 7428 302c 2073  etector.Set(0, s
-0001cbd0: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
-0001cbe0: 6563 746f 725f 6163 7469 7665 2c20 4270  ector_active, Bp
-0001cbf0: 702e 4772 6179 7363 616c 655f 385f 6269  p.Grayscale_8_bi
-0001cc00: 7429 0a20 2020 2020 2020 2069 6d61 6765  t).        image
-0001cc10: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-0001cc20: 6f6e 2e53 454d 2e53 6361 6e2e 4163 7175  on.SEM.Scan.Acqu
-0001cc30: 6972 6549 6d61 6765 4672 6f6d 4368 616e  ireImageFromChan
-0001cc40: 6e65 6c28 302c 2031 2c20 312c 2031 3030  nel(0, 1, 1, 100
-0001cc50: 290a 0a20 2020 2020 2020 2023 2073 7973  )..        # sys
-0001cc60: 7465 6d20 696e 666f 0a20 2020 2020 2020  tem info.       
-0001cc70: 2073 656c 662e 7379 7374 656d 2e69 6e66   self.system.inf
-0001cc80: 6f2e 6d61 6e75 6661 6374 7572 6572 203d  o.manufacturer =
-0001cc90: 2022 5445 5343 414e 220a 2020 2020 2020   "TESCAN".      
-0001cca0: 2020 7365 6c66 2e73 7973 7465 6d2e 696e    self.system.in
-0001ccb0: 666f 2e6d 6f64 656c 203d 2069 6d61 6765  fo.model = image
-0001ccc0: 2e48 6561 6465 725b 224d 4149 4e22 5d5b  .Header["MAIN"][
-0001ccd0: 2244 6576 6963 654d 6f64 656c 225d 0a20  "DeviceModel"]. 
-0001cce0: 2020 2020 2020 2073 656c 662e 7379 7374         self.syst
-0001ccf0: 656d 2e69 6e66 6f2e 7365 7269 616c 5f6e  em.info.serial_n
-0001cd00: 756d 6265 7220 3d20 696d 6167 652e 4865  umber = image.He
-0001cd10: 6164 6572 5b22 4d41 494e 225d 5b22 5365  ader["MAIN"]["Se
-0001cd20: 7269 616c 4e75 6d62 6572 225d 0a20 2020  rialNumber"].   
-0001cd30: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
-0001cd40: 2e69 6e66 6f2e 736f 6674 7761 7265 5f76  .info.software_v
-0001cd50: 6572 7369 6f6e 203d 2069 6d61 6765 2e48  ersion = image.H
-0001cd60: 6561 6465 725b 224d 4149 4e22 5d5b 2253  eader["MAIN"]["S
-0001cd70: 6f66 7477 6172 6556 6572 7369 6f6e 225d  oftwareVersion"]
-0001cd80: 0a0a 2020 2020 2020 2020 696e 666f 203d  ..        info =
-0001cd90: 2073 656c 662e 7379 7374 656d 2e69 6e66   self.system.inf
-0001cda0: 6f0a 2020 2020 2020 2020 6c6f 6767 696e  o.        loggin
-0001cdb0: 672e 696e 666f 2866 224d 6963 726f 7363  g.info(f"Microsc
-0001cdc0: 6f70 6520 636c 6965 6e74 2063 6f6e 6e65  ope client conne
-0001cdd0: 6374 6564 2074 6f20 6d6f 6465 6c20 7b69  cted to model {i
-0001cde0: 6e66 6f2e 6d6f 6465 6c7d 2077 6974 6820  nfo.model} with 
-0001cdf0: 7365 7269 616c 206e 756d 6265 7220 7b69  serial number {i
-0001ce00: 6e66 6f2e 7365 7269 616c 5f6e 756d 6265  nfo.serial_numbe
-0001ce10: 727d 2061 6e64 2073 6f66 7477 6172 6520  r} and software 
-0001ce20: 7665 7273 696f 6e20 7b69 6e66 6f2e 736f  version {info.so
-0001ce30: 6674 7761 7265 5f76 6572 7369 6f6e 7d2e  ftware_version}.
-0001ce40: 2229 0a0a 2020 2020 2020 2020 2320 7265  ")..        # re
-0001ce50: 7365 7420 6265 616d 2073 6869 6674 730a  set beam shifts.
-0001ce60: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-0001ce70: 6574 5f62 6561 6d5f 7368 6966 7473 2829  et_beam_shifts()
-0001ce80: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
-0001ce90: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
-0001cea0: 2263 6f6e 6e65 6374 5f74 6f5f 6d69 6372  "connect_to_micr
-0001ceb0: 6f73 636f 7065 222c 2022 6970 5f61 6464  oscope", "ip_add
-0001cec0: 7265 7373 223a 2069 705f 6164 6472 6573  ress": ip_addres
-0001ced0: 732c 2022 706f 7274 223a 2070 6f72 742c  s, "port": port,
-0001cee0: 2022 7379 7374 656d 5f69 6e66 6f22 3a20   "system_info": 
-0001cef0: 7365 6c66 2e73 7973 7465 6d2e 696e 666f  self.system.info
-0001cf00: 2e74 6f5f 6469 6374 2829 7d29 0a0a 2020  .to_dict()})..  
-0001cf10: 2020 6465 6620 6163 7175 6972 655f 696d    def acquire_im
-0001cf20: 6167 6528 7365 6c66 2c20 696d 6167 655f  age(self, image_
-0001cf30: 7365 7474 696e 6773 3d49 6d61 6765 5365  settings=ImageSe
-0001cf40: 7474 696e 6773 2920 2d3e 2046 6962 7365  ttings) -> Fibse
-0001cf50: 6d49 6d61 6765 3a0a 2020 2020 2020 2020  mImage:.        
-0001cf60: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-0001cf70: 4163 7175 6972 6573 2061 6e20 696d 6167  Acquires an imag
-0001cf80: 6520 7573 696e 6720 7468 6520 7370 6563  e using the spec
-0001cf90: 6966 6965 6420 696d 6167 6520 7365 7474  ified image sett
-0001cfa0: 696e 6773 2e0a 0a20 2020 2020 2020 2020  ings...         
-0001cfb0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-0001cfc0: 2020 2020 2020 2020 2069 6d61 6765 5f73           image_s
-0001cfd0: 6574 7469 6e67 733a 2041 6e20 696e 7374  ettings: An inst
-0001cfe0: 616e 6365 206f 6620 7468 6520 6049 6d61  ance of the `Ima
-0001cff0: 6765 5365 7474 696e 6773 6020 636c 6173  geSettings` clas
-0001d000: 7320 7468 6174 2072 6570 7265 7365 6e74  s that represent
-0001d010: 7320 7468 6520 696d 6167 6520 7365 7474  s the image sett
-0001d020: 696e 6773 2074 6f20 7573 6520 2864 6566  ings to use (def
-0001d030: 6175 6c74 2060 496d 6167 6553 6574 7469  ault `ImageSetti
-0001d040: 6e67 7360 292e 0a0a 2020 2020 2020 2020  ngs`)...        
-0001d050: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0001d060: 2020 2020 2020 2020 2020 2020 2041 2060               A `
-0001d070: 4669 6273 656d 496d 6167 6560 206f 626a  FibsemImage` obj
-0001d080: 6563 7420 7468 6174 2072 6570 7265 7365  ect that represe
-0001d090: 6e74 7320 7468 6520 6163 7175 6972 6564  nts the acquired
-0001d0a0: 2069 6d61 6765 2e0a 2020 2020 2020 2020   image..        
-0001d0b0: 2222 220a 2020 2020 2020 2020 6966 2069  """.        if i
-0001d0c0: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
-0001d0d0: 616d 5f74 7970 652e 6e61 6d65 203d 3d20  am_type.name == 
-0001d0e0: 2245 4c45 4354 524f 4e22 3a0a 2020 2020  "ELECTRON":.    
-0001d0f0: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
-0001d100: 7474 696e 6773 2e68 6677 203d 206e 702e  ttings.hfw = np.
-0001d110: 636c 6970 280a 2020 2020 2020 2020 2020  clip(.          
-0001d120: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-0001d130: 7365 7474 696e 6773 2e68 6677 2c20 312e  settings.hfw, 1.
-0001d140: 3065 2d36 2c20 3235 3830 2e30 652d 360a  0e-6, 2580.0e-6.
-0001d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d160: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001d170: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-0001d180: 655f 7365 7474 696e 6773 2e68 6677 203d  e_settings.hfw =
-0001d190: 206e 702e 636c 6970 280a 2020 2020 2020   np.clip(.      
-0001d1a0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-0001d1b0: 6167 655f 7365 7474 696e 6773 2e68 6677  age_settings.hfw
-0001d1c0: 2c20 312e 3065 2d36 2c20 3435 302e 3065  , 1.0e-6, 450.0e
-0001d1d0: 2d36 0a20 2020 2020 2020 2020 2020 2020  -6.             
-0001d1e0: 2020 2029 0a20 2020 2020 2020 206c 6f67     ).        log
-0001d1f0: 6769 6e67 2e69 6e66 6f28 6622 6163 7175  ging.info(f"acqu
-0001d200: 6972 696e 6720 6e65 7720 7b69 6d61 6765  iring new {image
-0001d210: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-0001d220: 7970 652e 6e61 6d65 7d20 696d 6167 652e  ype.name} image.
-0001d230: 2229 0a20 2020 2020 2020 2069 6620 696d  ").        if im
-0001d240: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
-0001d250: 6d5f 7479 7065 2e6e 616d 6520 3d3d 2022  m_type.name == "
-0001d260: 454c 4543 5452 4f4e 223a 0a20 2020 2020  ELECTRON":.     
-0001d270: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-0001d280: 616d 2842 6561 6d54 7970 652e 454c 4543  am(BeamType.ELEC
-0001d290: 5452 4f4e 2c20 7365 6c66 2e73 7973 7465  TRON, self.syste
-0001d2a0: 6d29 0a20 2020 2020 2020 2020 2020 2069  m).            i
-0001d2b0: 6d61 6765 203d 2073 656c 662e 5f67 6574  mage = self._get
-0001d2c0: 5f65 625f 696d 6167 6528 696d 6167 655f  _eb_image(image_
-0001d2d0: 7365 7474 696e 6773 290a 2020 2020 2020  settings).      
-0001d2e0: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
-0001d2f0: 696d 6167 655f 6562 203d 2069 6d61 6765  image_eb = image
-0001d300: 0a20 2020 2020 2020 2069 6620 696d 6167  .        if imag
-0001d310: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
-0001d320: 7479 7065 2e6e 616d 6520 3d3d 2022 494f  type.name == "IO
-0001d330: 4e22 3a0a 2020 2020 2020 2020 2020 2020  N":.            
-0001d340: 5f63 6865 636b 5f62 6561 6d28 4265 616d  _check_beam(Beam
-0001d350: 5479 7065 2e49 4f4e 2c20 7365 6c66 2e73  Type.ION, self.s
-0001d360: 7973 7465 6d29 0a20 2020 2020 2020 2020  ystem).         
-0001d370: 2020 2069 6d61 6765 203d 2073 656c 662e     image = self.
-0001d380: 5f67 6574 5f69 625f 696d 6167 6528 696d  _get_ib_image(im
-0001d390: 6167 655f 7365 7474 696e 6773 290a 2020  age_settings).  
-0001d3a0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0001d3b0: 6173 745f 696d 6167 655f 6962 203d 2069  ast_image_ib = i
-0001d3c0: 6d61 6765 0a0a 2020 2020 2020 2020 696d  mage..        im
-0001d3d0: 6167 652e 6d65 7461 6461 7461 2e75 7365  age.metadata.use
-0001d3e0: 7220 3d20 7365 6c66 2e75 7365 720a 2020  r = self.user.  
-0001d3f0: 2020 2020 2020 696d 6167 652e 6d65 7461        image.meta
-0001d400: 6461 7461 2e65 7870 6572 696d 656e 7420  data.experiment 
-0001d410: 3d20 7365 6c66 2e65 7870 6572 696d 656e  = self.experimen
-0001d420: 7420 0a20 2020 2020 2020 2069 6d61 6765  t .        image
-0001d430: 2e6d 6574 6164 6174 612e 7379 7374 656d  .metadata.system
-0001d440: 203d 2073 656c 662e 7379 7374 656d 0a0a   = self.system..
-0001d450: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-0001d460: 6d61 6765 0a0a 2020 2020 6465 6620 5f67  mage..    def _g
-0001d470: 6574 5f65 625f 696d 6167 6528 7365 6c66  et_eb_image(self
-0001d480: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
-0001d490: 3a20 496d 6167 6553 6574 7469 6e67 7329  : ImageSettings)
-0001d4a0: 202d 3e20 4669 6273 656d 496d 6167 653a   -> FibsemImage:
-0001d4b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001d4c0: 2020 2020 2041 6371 7569 7265 7320 616e       Acquires an
-0001d4d0: 2065 6c65 6374 726f 6e20 6265 616d 2028   electron beam (
-0001d4e0: 4542 2920 696d 6167 6520 7769 7468 2074  EB) image with t
-0001d4f0: 6865 2067 6976 656e 2073 6574 7469 6e67  he given setting
-0001d500: 7320 616e 6420 7265 7475 726e 7320 6120  s and returns a 
-0001d510: 4669 6273 656d 496d 6167 6520 6f62 6a65  FibsemImage obje
-0001d520: 6374 2e0a 0a20 2020 2020 2020 2041 7267  ct...        Arg
-0001d530: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0001d540: 6d61 6765 5f73 6574 7469 6e67 7320 2849  mage_settings (I
-0001d550: 6d61 6765 5365 7474 696e 6773 293a 2041  mageSettings): A
-0001d560: 6e20 6f62 6a65 6374 2063 6f6e 7461 696e  n object contain
-0001d570: 696e 6720 7468 6520 7365 7474 696e 6773  ing the settings
-0001d580: 2066 6f72 2074 6865 2061 6371 7569 7265   for the acquire
-0001d590: 6420 696d 6167 652e 200a 0a20 2020 2020  d image. ..     
-0001d5a0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-0001d5b0: 2020 2020 2020 2020 4669 6273 656d 496d          FibsemIm
-0001d5c0: 6167 653a 2054 6865 2061 6371 7569 7265  age: The acquire
-0001d5d0: 6420 696d 6167 6520 6173 2061 2046 6962  d image as a Fib
-0001d5e0: 7365 6d49 6d61 6765 206f 626a 6563 742e  semImage object.
-0001d5f0: 0a0a 2020 2020 2020 2020 4e6f 7465 733a  ..        Notes:
-0001d600: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
-0001d610: 7320 6675 6e63 7469 6f6e 2061 6371 7569  s function acqui
-0001d620: 7265 7320 616e 2065 6c65 6374 726f 6e20  res an electron 
-0001d630: 6265 616d 2028 4542 2920 696d 6167 6520  beam (EB) image 
-0001d640: 7769 7468 2074 6865 2067 6976 656e 2073  with the given s
-0001d650: 6574 7469 6e67 7320 616e 6420 7265 7475  ettings and retu
-0001d660: 726e 7320 6974 2061 7320 6120 4669 6273  rns it as a Fibs
-0001d670: 656d 496d 6167 6520 6f62 6a65 6374 2e20  emImage object. 
-0001d680: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-0001d690: 2066 756e 6374 696f 6e20 7365 7473 2075   function sets u
-0001d6a0: 7020 7468 6520 6d69 6372 6f73 636f 7065  p the microscope
-0001d6b0: 2070 6172 616d 6574 6572 732c 2069 6e63   parameters, inc
-0001d6c0: 6c75 6469 6e67 2074 6865 2065 6c65 6374  luding the elect
-0001d6d0: 726f 6e20 6265 616d 2064 7765 6c6c 2074  ron beam dwell t
-0001d6e0: 696d 652c 2069 6d61 6765 2072 6573 6f6c  ime, image resol
-0001d6f0: 7574 696f 6e2c 2061 6e64 200a 2020 2020  ution, and .    
-0001d700: 2020 2020 2020 2020 7265 6769 6f6e 206f          region o
-0001d710: 6620 696e 7465 7265 7374 2028 524f 4929  f interest (ROI)
-0001d720: 2c20 6966 2073 7065 6369 6669 6564 2e20  , if specified. 
-0001d730: 4974 2074 6865 6e20 6163 7175 6972 6573  It then acquires
-0001d740: 2074 6865 2069 6d61 6765 2061 6e64 2063   the image and c
-0001d750: 7265 6174 6573 2061 2046 6962 7365 6d49  reates a FibsemI
-0001d760: 6d61 6765 206f 626a 6563 7420 6672 6f6d  mage object from
-0001d770: 2069 742c 200a 2020 2020 2020 2020 2020   it, .          
-0001d780: 2020 696e 636c 7564 696e 6720 6d65 7461    including meta
-0001d790: 6461 7461 206f 6e20 7468 6520 6d69 6372  data on the micr
-0001d7a0: 6f73 636f 7065 2073 7461 7465 2061 6e64  oscope state and
-0001d7b0: 2074 6865 2062 6561 6d20 616e 6420 696f   the beam and io
-0001d7c0: 6e20 7365 7474 696e 6773 2e0a 0a20 2020  n settings...   
-0001d7d0: 2020 2020 2020 2020 2042 6566 6f72 6520           Before 
-0001d7e0: 6163 7175 6972 696e 6720 7468 6520 696d  acquiring the im
-0001d7f0: 6167 652c 2074 6865 2066 756e 6374 696f  age, the functio
-0001d800: 6e20 656e 7375 7265 7320 7468 6174 2074  n ensures that t
-0001d810: 6865 2065 6c65 6374 726f 6e20 6265 616d  he electron beam
-0001d820: 2069 7320 7475 726e 6564 206f 6e20 616e   is turned on an
-0001d830: 6420 7468 6174 2074 6865 2053 454d 2073  d that the SEM s
-0001d840: 6361 6e20 6973 2073 746f 7070 6564 2e20  can is stopped. 
-0001d850: 0a20 2020 2020 2020 2020 2020 2049 7420  .            It 
-0001d860: 7365 6c65 6374 7320 7468 6520 6d6f 7374  selects the most
-0001d870: 2073 7569 7461 626c 6520 6465 7465 6374   suitable detect
-0001d880: 6f72 2066 6f72 2074 6865 2069 6d61 6765  or for the image
-0001d890: 2c20 6173 7369 676e 7320 6974 2074 6f20  , assigns it to 
-0001d8a0: 6120 6368 616e 6e65 6c2c 2061 6e64 2065  a channel, and e
-0001d8b0: 6e61 626c 6573 2074 6865 2063 6861 6e6e  nables the chann
-0001d8c0: 656c 2066 6f72 2061 6371 7569 7369 7469  el for acquisiti
-0001d8d0: 6f6e 2e20 0a20 2020 2020 2020 2020 2020  on. .           
-0001d8e0: 2054 6865 2066 756e 6374 696f 6e20 7468   The function th
-0001d8f0: 656e 2061 6371 7569 7265 7320 7468 6520  en acquires the 
-0001d900: 696d 6167 6520 6672 6f6d 2074 6865 2063  image from the c
-0001d910: 6861 6e6e 656c 2075 7369 6e67 2074 6865  hannel using the
-0001d920: 2073 7065 6369 6669 6564 2064 7765 6c6c   specified dwell
-0001d930: 2074 696d 6520 616e 6420 7265 736f 6c75   time and resolu
-0001d940: 7469 6f6e 2e0a 0a20 2020 2020 2020 2020  tion...         
-0001d950: 2020 2054 6865 2066 756e 6374 696f 6e20     The function 
-0001d960: 616c 736f 2072 6563 6f72 6473 2074 6865  also records the
-0001d970: 206d 6963 726f 7363 6f70 6520 7374 6174   microscope stat
-0001d980: 6520 6174 2074 6865 2074 696d 6520 6f66  e at the time of
-0001d990: 2069 6d61 6765 2061 6371 7569 7369 7469   image acquisiti
-0001d9a0: 6f6e 2c20 696e 636c 7564 696e 6720 7468  on, including th
-0001d9b0: 6520 7374 6167 6520 706f 7369 7469 6f6e  e stage position
-0001d9c0: 2c20 6265 616d 200a 2020 2020 2020 2020  , beam .        
-0001d9d0: 2020 2020 7365 7474 696e 6773 2c20 616e      settings, an
-0001d9e0: 6420 696f 6e20 6265 616d 2073 6574 7469  d ion beam setti
-0001d9f0: 6e67 732e 2054 6865 2061 6371 7569 7265  ngs. The acquire
-0001da00: 6420 696d 6167 6520 6973 2072 6574 7572  d image is retur
-0001da10: 6e65 6420 6173 2061 2046 6962 7365 6d49  ned as a FibsemI
-0001da20: 6d61 6765 206f 626a 6563 742c 2077 6869  mage object, whi
-0001da30: 6368 2069 6e63 6c75 6465 7320 7468 6520  ch includes the 
-0001da40: 696d 6167 6520 0a20 2020 2020 2020 2020  image .         
-0001da50: 2020 2064 6174 6120 616e 6420 6d65 7461     data and meta
-0001da60: 6461 7461 206f 6e20 7468 6520 6d69 6372  data on the micr
-0001da70: 6f73 636f 7065 2073 7461 7465 2061 6e64  oscope state and
-0001da80: 2074 6865 2069 6d61 6765 2073 6574 7469   the image setti
-0001da90: 6e67 732e 0a20 2020 2020 2020 2022 2222  ngs..        """
-0001daa0: 0a20 2020 2020 2020 2023 2041 7420 6669  .        # At fi
-0001dab0: 7273 7420 6d61 6b65 2073 7572 6520 7468  rst make sure th
-0001dac0: 6520 6265 616d 2069 7320 4f4e 0a20 2020  e beam is ON.   
-0001dad0: 2020 2020 2073 7461 7475 7320 3d20 7365       status = se
-0001dae0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-0001daf0: 4d2e 4265 616d 2e47 6574 5374 6174 7573  M.Beam.GetStatus
-0001db00: 2829 0a20 2020 2020 2020 2069 6620 7374  ().        if st
-0001db10: 6174 7573 2021 3d20 4175 746f 6d61 7469  atus != Automati
-0001db20: 6f6e 2e53 454d 2e42 6561 6d2e 5374 6174  on.SEM.Beam.Stat
-0001db30: 7573 2e42 6561 6d4f 6e3a 0a20 2020 2020  us.BeamOn:.     
-0001db40: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0001db50: 6563 7469 6f6e 2e53 454d 2e42 6561 6d2e  ection.SEM.Beam.
-0001db60: 4f6e 2829 0a20 2020 2020 2020 2023 2069  On().        # i
-0001db70: 6d70 6f72 7461 6e74 3a20 7374 6f70 2074  mportant: stop t
-0001db80: 6865 2073 6361 6e6e 696e 6720 6265 666f  he scanning befo
-0001db90: 7265 2077 6520 7374 6172 7420 7363 616e  re we start scan
-0001dba0: 6e69 6e67 206f 7220 6265 666f 7265 2061  ning or before a
-0001dbb0: 7574 6f6d 6174 6963 2070 726f 6365 6475  utomatic procedu
-0001dbc0: 7265 732c 0a20 2020 2020 2020 2023 2065  res,.        # e
-0001dbd0: 7665 6e20 6265 666f 7265 2077 6520 636f  ven before we co
-0001dbe0: 6e66 6967 7572 6520 7468 6520 6465 7465  nfigure the dete
-0001dbf0: 6374 6f72 730a 2020 2020 2020 2020 7365  ctors.        se
-0001dc00: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-0001dc10: 4d2e 5363 616e 2e53 746f 7028 290a 2020  M.Scan.Stop().  
-0001dc20: 2020 2020 2020 2320 5365 6c65 6374 2074        # Select t
-0001dc30: 6865 2064 6574 6563 746f 7220 666f 7220  he detector for 
-0001dc40: 696d 6167 6520 692e 652e 3a0a 2020 2020  image i.e.:.    
-0001dc50: 2020 2020 2320 312e 2061 7373 6967 6e20      # 1. assign 
-0001dc60: 7468 6520 6465 7465 6374 6f72 2074 6f20  the detector to 
-0001dc70: 6120 6368 616e 6e65 6c0a 2020 2020 2020  a channel.      
-0001dc80: 2020 2320 322e 2065 6e61 626c 6520 7468    # 2. enable th
-0001dc90: 6520 6368 616e 6e65 6c20 666f 7220 6163  e channel for ac
-0001dca0: 7175 6973 6974 696f 6e0a 2020 2020 2020  quisition.      
-0001dcb0: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
-0001dcc0: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e44  connection.SEM.D
-0001dcd0: 6574 6563 746f 722e 5365 7428 302c 2073  etector.Set(0, s
-0001dce0: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
-0001dcf0: 6563 746f 725f 6163 7469 7665 2c20 4270  ector_active, Bp
-0001dd00: 702e 4772 6179 7363 616c 655f 385f 6269  p.Grayscale_8_bi
-0001dd10: 7429 0a0a 2020 2020 2020 2020 6477 656c  t)..        dwel
-0001dd20: 6c5f 7469 6d65 203d 2069 6d61 6765 5f73  l_time = image_s
-0001dd30: 6574 7469 6e67 732e 6477 656c 6c5f 7469  ettings.dwell_ti
-0001dd40: 6d65 202a 2063 6f6e 7374 616e 7473 2e53  me * constants.S
-0001dd50: 495f 544f 5f4e 414e 4f0a 2020 2020 2020  I_TO_NANO.      
-0001dd60: 2020 2320 7265 736f 6c75 7469 6f6e 0a20    # resolution. 
-0001dd70: 2020 2020 2020 2069 6d61 6765 5769 6474         imageWidt
-0001dd80: 6820 3d20 696d 6167 655f 7365 7474 696e  h = image_settin
-0001dd90: 6773 2e72 6573 6f6c 7574 696f 6e5b 305d  gs.resolution[0]
-0001dda0: 0a20 2020 2020 2020 2069 6d61 6765 4865  .        imageHe
-0001ddb0: 6967 6874 203d 2069 6d61 6765 5f73 6574  ight = image_set
-0001ddc0: 7469 6e67 732e 7265 736f 6c75 7469 6f6e  tings.resolution
-0001ddd0: 5b31 5d0a 0a20 2020 2020 2020 2073 656c  [1]..        sel
-0001dde0: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
-0001ddf0: 2e4f 7074 6963 732e 5365 7456 6965 7766  .Optics.SetViewf
-0001de00: 6965 6c64 280a 2020 2020 2020 2020 2020  ield(.          
-0001de10: 2020 696d 6167 655f 7365 7474 696e 6773    image_settings
-0001de20: 2e68 6677 202a 2063 6f6e 7374 616e 7473  .hfw * constants
-0001de30: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
-0001de40: 4554 5245 0a20 2020 2020 2020 2029 0a20  ETRE.        ). 
-0001de50: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
-0001de60: 7365 7474 696e 6773 2e72 6564 7563 6564  settings.reduced
-0001de70: 5f61 7265 6120 6973 206e 6f74 204e 6f6e  _area is not Non
-0001de80: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-0001de90: 6566 7420 3d20 2069 6e74 2869 6d61 6765  eft =  int(image
-0001dea0: 5f73 6574 7469 6e67 732e 7265 6475 6365  _settings.reduce
-0001deb0: 645f 6172 6561 2e6c 6566 7420 2a20 696d  d_area.left * im
-0001dec0: 6167 6557 6964 7468 290a 2020 2020 2020  ageWidth).      
-0001ded0: 2020 2020 2020 746f 7020 3d20 696e 7428        top = int(
-0001dee0: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
-0001def0: 6564 7563 6564 5f61 7265 612e 746f 7020  educed_area.top 
-0001df00: 2a20 696d 6167 6548 6569 6768 7429 200a  * imageHeight) .
-0001df10: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-0001df20: 6820 3d20 696e 7428 696d 6167 655f 7365  h = int(image_se
-0001df30: 7474 696e 6773 2e72 6564 7563 6564 5f61  ttings.reduced_a
-0001df40: 7265 612e 7769 6474 6820 2a20 696d 6167  rea.width * imag
-0001df50: 6557 6964 7468 290a 2020 2020 2020 2020  eWidth).        
-0001df60: 2020 2020 6865 6967 6874 203d 2069 6e74      height = int
-0001df70: 2869 6d61 6765 5f73 6574 7469 6e67 732e  (image_settings.
-0001df80: 7265 6475 6365 645f 6172 6561 2e68 6569  reduced_area.hei
-0001df90: 6768 7420 2a20 696d 6167 6548 6569 6768  ght * imageHeigh
-0001dfa0: 7429 0a20 2020 2020 2020 2020 2020 2069  t).            i
-0001dfb0: 6d61 6765 203d 2073 656c 662e 636f 6e6e  mage = self.conn
-0001dfc0: 6563 7469 6f6e 2e53 454d 2e53 6361 6e2e  ection.SEM.Scan.
-0001dfd0: 4163 7175 6972 6552 4f49 4672 6f6d 4368  AcquireROIFromCh
-0001dfe0: 616e 6e65 6c28 0a20 2020 2020 2020 2020  annel(.         
-0001dff0: 2020 2020 2020 2043 6861 6e6e 656c 3d20         Channel= 
-0001e000: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-0001e010: 2020 2057 6964 7468 3d20 696d 6167 6557     Width= imageW
-0001e020: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-0001e030: 2020 2020 2020 4865 6967 6874 3d20 696d        Height= im
-0001e040: 6167 6548 6569 6768 742c 0a20 2020 2020  ageHeight,.     
-0001e050: 2020 2020 2020 2020 2020 204c 6566 743d             Left=
-0001e060: 206c 6566 742c 0a20 2020 2020 2020 2020   left,.         
-0001e070: 2020 2020 2020 2054 6f70 3d20 746f 702c         Top= top,
-0001e080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e090: 2052 6967 6874 3d20 6c65 6674 202b 2077   Right= left + w
-0001e0a0: 6964 7468 202d 3120 2c0a 2020 2020 2020  idth -1 ,.      
-0001e0b0: 2020 2020 2020 2020 2020 426f 7474 6f6d            Bottom
-0001e0c0: 3d20 746f 7020 2b20 6865 6967 6874 202d  = top + height -
-0001e0d0: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
-0001e0e0: 2020 2020 4477 656c 6c54 696d 653d 2064      DwellTime= d
-0001e0f0: 7765 6c6c 5f74 696d 650a 2020 2020 2020  well_time.      
-0001e100: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001e110: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001e120: 2020 696d 6167 6520 3d20 7365 6c66 2e63    image = self.c
-0001e130: 6f6e 6e65 6374 696f 6e2e 5345 4d2e 5363  onnection.SEM.Sc
-0001e140: 616e 2e41 6371 7569 7265 496d 6167 6546  an.AcquireImageF
-0001e150: 726f 6d43 6861 6e6e 656c 280a 2020 2020  romChannel(.    
-0001e160: 2020 2020 2020 2020 2020 2020 302c 2069              0, i
-0001e170: 6d61 6765 5769 6474 682c 2069 6d61 6765  mageWidth, image
-0001e180: 4865 6967 6874 2c20 6477 656c 6c5f 7469  Height, dwell_ti
-0001e190: 6d65 0a20 2020 2020 2020 2020 2020 2029  me.            )
-0001e1a0: 0a0a 2020 2020 2020 2020 6d69 6372 6f73  ..        micros
-0001e1b0: 636f 7065 5f73 7461 7465 203d 204d 6963  cope_state = Mic
-0001e1c0: 726f 7363 6f70 6553 7461 7465 280a 2020  roscopeState(.  
-0001e1d0: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
-0001e1e0: 616d 703d 6461 7465 7469 6d65 2e64 6174  amp=datetime.dat
-0001e1f0: 6574 696d 652e 7469 6d65 7374 616d 7028  etime.timestamp(
-0001e200: 6461 7465 7469 6d65 2e64 6174 6574 696d  datetime.datetim
-0001e210: 652e 6e6f 7728 2929 2c0a 2020 2020 2020  e.now()),.      
-0001e220: 2020 2020 2020 7374 6167 655f 706f 7369        stage_posi
-0001e230: 7469 6f6e 3d46 6962 7365 6d53 7461 6765  tion=FibsemStage
-0001e240: 506f 7369 7469 6f6e 280a 2020 2020 2020  Position(.      
-0001e250: 2020 2020 2020 2020 2020 783d 666c 6f61            x=floa
-0001e260: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
-0001e270: 5345 4d22 5d5b 2253 7461 6765 5822 5d29  SEM"]["StageX"])
-0001e280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e290: 2020 793d 666c 6f61 7428 696d 6167 652e    y=float(image.
-0001e2a0: 4865 6164 6572 5b22 5345 4d22 5d5b 2253  Header["SEM"]["S
-0001e2b0: 7461 6765 5922 5d29 2c0a 2020 2020 2020  tageY"]),.      
-0001e2c0: 2020 2020 2020 2020 2020 7a3d 666c 6f61            z=floa
-0001e2d0: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
-0001e2e0: 5345 4d22 5d5b 2253 7461 6765 5a22 5d29  SEM"]["StageZ"])
-0001e2f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e300: 2020 723d 666c 6f61 7428 696d 6167 652e    r=float(image.
-0001e310: 4865 6164 6572 5b22 5345 4d22 5d5b 2253  Header["SEM"]["S
-0001e320: 7461 6765 526f 7461 7469 6f6e 225d 292c  tageRotation"]),
-0001e330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e340: 2074 3d66 6c6f 6174 2869 6d61 6765 2e48   t=float(image.H
-0001e350: 6561 6465 725b 2253 454d 225d 5b22 5374  eader["SEM"]["St
-0001e360: 6167 6554 696c 7422 5d29 2c0a 2020 2020  ageTilt"]),.    
-0001e370: 2020 2020 2020 2020 2020 2020 636f 6f72              coor
-0001e380: 6469 6e61 7465 5f73 7973 7465 6d3d 2252  dinate_system="R
-0001e390: 4157 222c 0a20 2020 2020 2020 2020 2020  AW",.           
-0001e3a0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0001e3b0: 656c 6563 7472 6f6e 5f62 6561 6d3d 4265  electron_beam=Be
-0001e3c0: 616d 5365 7474 696e 6773 280a 2020 2020  amSettings(.    
-0001e3d0: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-0001e3e0: 5f74 7970 653d 4265 616d 5479 7065 2e45  _type=BeamType.E
-0001e3f0: 4c45 4354 524f 4e2c 0a20 2020 2020 2020  LECTRON,.       
-0001e400: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
-0001e410: 5f64 6973 7461 6e63 653d 666c 6f61 7428  _distance=float(
-0001e420: 696d 6167 652e 4865 6164 6572 5b22 5345  image.Header["SE
-0001e430: 4d22 5d5b 2257 4422 5d29 2c0a 2020 2020  M"]["WD"]),.    
-0001e440: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-0001e450: 5f63 7572 7265 6e74 3d66 6c6f 6174 2869  _current=float(i
-0001e460: 6d61 6765 2e48 6561 6465 725b 2253 454d  mage.Header["SEM
-0001e470: 225d 5b22 5072 6564 6963 7465 6442 6561  "]["PredictedBea
-0001e480: 6d43 7572 7265 6e74 225d 292c 0a20 2020  mCurrent"]),.   
-0001e490: 2020 2020 2020 2020 2020 2020 2076 6f6c               vol
-0001e4a0: 7461 6765 3d66 6c6f 6174 2873 656c 662e  tage=float(self.
-0001e4b0: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e42  connection.SEM.B
-0001e4c0: 6561 6d2e 4765 7456 6f6c 7461 6765 2829  eam.GetVoltage()
-0001e4d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001e4e0: 2020 2072 6573 6f6c 7574 696f 6e3d 5b69     resolution=[i
-0001e4f0: 6d61 6765 5769 6474 682c 2069 6d61 6765  mageWidth, image
-0001e500: 4865 6967 6874 5d2c 2023 227b 7d78 7b7d  Height], #"{}x{}
-0001e510: 222e 666f 726d 6174 2869 6d61 6765 5769  ".format(imageWi
-0001e520: 6474 682c 2069 6d61 6765 4865 6967 6874  dth, imageHeight
-0001e530: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001e540: 2020 2064 7765 6c6c 5f74 696d 653d 666c     dwell_time=fl
-0001e550: 6f61 7428 696d 6167 652e 4865 6164 6572  oat(image.Header
-0001e560: 5b22 5345 4d22 5d5b 2244 7765 6c6c 5469  ["SEM"]["DwellTi
-0001e570: 6d65 225d 292c 0a20 2020 2020 2020 2020  me"]),.         
-0001e580: 2020 2020 2020 2073 7469 676d 6174 696f         stigmatio
-0001e590: 6e3d 506f 696e 7428 0a20 2020 2020 2020  n=Point(.       
-0001e5a0: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0001e5b0: 6174 2869 6d61 6765 2e48 6561 6465 725b  at(image.Header[
-0001e5c0: 2253 454d 225d 5b22 5374 6967 6d61 746f  "SEM"]["Stigmato
-0001e5d0: 7258 225d 292c 0a20 2020 2020 2020 2020  rX"]),.         
-0001e5e0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0001e5f0: 2869 6d61 6765 2e48 6561 6465 725b 2253  (image.Header["S
-0001e600: 454d 225d 5b22 5374 6967 6d61 746f 7259  EM"]["StigmatorY
-0001e610: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
-0001e620: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0001e630: 2020 2020 2020 2020 7368 6966 743d 506f          shift=Po
-0001e640: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-0001e650: 2020 2020 2020 2020 2066 6c6f 6174 2869           float(i
-0001e660: 6d61 6765 2e48 6561 6465 725b 2253 454d  mage.Header["SEM
-0001e670: 225d 5b22 496d 6167 6553 6869 6674 5822  "]["ImageShiftX"
-0001e680: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001e690: 2020 2020 2020 2020 666c 6f61 7428 696d          float(im
-0001e6a0: 6167 652e 4865 6164 6572 5b22 5345 4d22  age.Header["SEM"
-0001e6b0: 5d5b 2249 6d61 6765 5368 6966 7459 225d  ]["ImageShiftY"]
-0001e6c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0001e6d0: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-0001e6e0: 2020 2020 2020 7363 616e 5f72 6f74 6174        scan_rotat
-0001e6f0: 696f 6e3d 7365 6c66 2e63 6f6e 6e65 6374  ion=self.connect
-0001e700: 696f 6e2e 5345 4d2e 4f70 7469 6373 2e47  ion.SEM.Optics.G
-0001e710: 6574 496d 6167 6552 6f74 6174 696f 6e28  etImageRotation(
-0001e720: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-0001e730: 2c0a 2020 2020 2020 2020 2020 2020 696f  ,.            io
-0001e740: 6e5f 6265 616d 3d42 6561 6d53 6574 7469  n_beam=BeamSetti
-0001e750: 6e67 7328 6265 616d 5f74 7970 653d 4265  ngs(beam_type=Be
-0001e760: 616d 5479 7065 2e49 4f4e 292c 0a20 2020  amType.ION),.   
-0001e770: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001e780: 6465 7465 6374 6f72 203d 2046 6962 7365  detector = Fibse
-0001e790: 6d44 6574 6563 746f 7253 6574 7469 6e67  mDetectorSetting
-0001e7a0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-0001e7b0: 2020 2074 7970 6520 3d20 7365 6c66 2e67     type = self.g
-0001e7c0: 6574 2822 6465 7465 6374 6f72 5f74 7970  et("detector_typ
-0001e7d0: 6522 2c20 696d 6167 655f 7365 7474 696e  e", image_settin
-0001e7e0: 6773 2e62 6561 6d5f 7479 7065 292c 0a20  gs.beam_type),. 
-0001e7f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001e800: 6f64 6520 3d20 224e 2f41 222c 0a20 2020  ode = "N/A",.   
-0001e810: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0001e820: 7472 6173 7420 3d20 7365 6c66 2e67 6574  trast = self.get
-0001e830: 2822 6465 7465 6374 6f72 5f63 6f6e 7472  ("detector_contr
-0001e840: 6173 7422 2c20 696d 6167 655f 7365 7474  ast", image_sett
-0001e850: 696e 6773 2e62 6561 6d5f 7479 7065 292c  ings.beam_type),
-0001e860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e870: 2062 7269 6768 746e 6573 733d 2073 656c   brightness= sel
-0001e880: 662e 6765 7428 2264 6574 6563 746f 725f  f.get("detector_
-0001e890: 6272 6967 6874 6e65 7373 222c 2069 6d61  brightness", ima
-0001e8a0: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
-0001e8b0: 5f74 7970 6529 2c0a 0a20 2020 2020 2020  _type),..       
-0001e8c0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001e8d0: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
-0001e8e0: 6573 6f6c 7574 696f 6e20 3d20 5b69 6d61  esolution = [ima
-0001e8f0: 6765 5769 6474 682c 2069 6d61 6765 4865  geWidth, imageHe
-0001e900: 6967 6874 5d0a 2020 2020 2020 2020 6669  ight].        fi
-0001e910: 6273 656d 5f69 6d61 6765 203d 2046 6962  bsem_image = Fib
-0001e920: 7365 6d49 6d61 6765 2e66 726f 6d54 6573  semImage.fromTes
-0001e930: 6361 6e49 6d61 6765 280a 2020 2020 2020  canImage(.      
-0001e940: 2020 2020 2020 696d 6167 652c 2064 6565        image, dee
-0001e950: 7063 6f70 7928 696d 6167 655f 7365 7474  pcopy(image_sett
-0001e960: 696e 6773 292c 2064 6565 7063 6f70 7928  ings), deepcopy(
-0001e970: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-0001e980: 292c 2064 6574 6563 746f 723d 2064 6574  ), detector= det
-0001e990: 6563 746f 720a 2020 2020 2020 2020 290a  ector.        ).
-0001e9a0: 0a20 2020 2020 2020 2023 6669 6273 656d  .        #fibsem
-0001e9b0: 5f69 6d61 6765 2e6d 6574 6164 6174 612e  _image.metadata.
-0001e9c0: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
-0001e9d0: 6573 6f6c 7574 696f 6e20 3d20 5b69 6d61  esolution = [ima
-0001e9e0: 6765 5769 6474 682c 2069 6d61 6765 4865  geWidth, imageHe
-0001e9f0: 6967 6874 5d0a 0a20 2020 2020 2020 2072  ight]..        r
-0001ea00: 6574 7572 6e20 6669 6273 656d 5f69 6d61  eturn fibsem_ima
-0001ea10: 6765 0a0a 2020 2020 6465 6620 5f67 6574  ge..    def _get
-0001ea20: 5f69 625f 696d 6167 6528 7365 6c66 2c20  _ib_image(self, 
-0001ea30: 696d 6167 655f 7365 7474 696e 6773 3a20  image_settings: 
-0001ea40: 496d 6167 6553 6574 7469 6e67 7329 3a0a  ImageSettings):.
-0001ea50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001ea60: 2020 2020 4163 7175 6972 6573 2061 6e20      Acquires an 
-0001ea70: 696f 6e20 6265 616d 2028 4942 2920 696d  ion beam (IB) im
-0001ea80: 6167 6520 7769 7468 2074 6865 2067 6976  age with the giv
-0001ea90: 656e 2073 6574 7469 6e67 7320 616e 6420  en settings and 
-0001eaa0: 7265 7475 726e 7320 6120 4669 6273 656d  returns a Fibsem
-0001eab0: 496d 6167 6520 6f62 6a65 6374 2e0a 0a20  Image object... 
-0001eac0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
-0001ead0: 2020 2020 2020 2020 2069 6d61 6765 5f73           image_s
-0001eae0: 6574 7469 6e67 7320 2849 6d61 6765 5365  ettings (ImageSe
-0001eaf0: 7474 696e 6773 293a 2054 6865 2073 6574  ttings): The set
-0001eb00: 7469 6e67 7320 666f 7220 7468 6520 6163  tings for the ac
-0001eb10: 7175 6972 6564 2069 6d61 6765 2e0a 0a20  quired image... 
-0001eb20: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-0001eb30: 2020 2020 2020 2020 2020 2020 4669 6273              Fibs
-0001eb40: 656d 496d 6167 653a 2054 6865 2061 6371  emImage: The acq
-0001eb50: 7569 7265 6420 696d 6167 6520 6173 2061  uired image as a
-0001eb60: 2046 6962 7365 6d49 6d61 6765 206f 626a   FibsemImage obj
-0001eb70: 6563 742e 0a0a 2020 2020 2020 2020 4e6f  ect...        No
-0001eb80: 7465 733a 0a20 2020 2020 2020 2020 2020  tes:.           
-0001eb90: 202d 2054 6865 2066 756e 6374 696f 6e20   - The function 
-0001eba0: 6163 7175 6972 6573 2061 6e20 4942 2069  acquires an IB i
-0001ebb0: 6d61 6765 2077 6974 6820 7468 6520 6769  mage with the gi
-0001ebc0: 7665 6e20 7365 7474 696e 6773 2062 7920  ven settings by 
-0001ebd0: 636f 6e66 6967 7572 696e 6720 7468 6520  configuring the 
-0001ebe0: 6465 7465 6374 6f72 732c 2073 6361 6e6e  detectors, scann
-0001ebf0: 696e 672c 2061 6e64 2073 656c 6563 7469  ing, and selecti
-0001ec00: 6e67 2074 6865 2064 7765 6c6c 2074 696d  ng the dwell tim
-0001ec10: 652c 2072 6573 6f6c 7574 696f 6e2c 2061  e, resolution, a
-0001ec20: 6e64 2076 6965 7766 6965 6c64 2e0a 2020  nd viewfield..  
-0001ec30: 2020 2020 2020 2020 2020 2d20 4966 2074            - If t
-0001ec40: 6865 2069 6d61 6765 2073 6574 7469 6e67  he image setting
-0001ec50: 7320 696e 636c 7564 6520 6120 7265 6475  s include a redu
-0001ec60: 6365 6420 6172 6561 2c20 7468 6520 6675  ced area, the fu
-0001ec70: 6e63 7469 6f6e 2077 696c 6c20 6163 7175  nction will acqu
-0001ec80: 6972 6520 616e 2069 6d61 6765 2077 6974  ire an image wit
-0001ec90: 6869 6e20 7468 6520 7265 6475 6365 6420  hin the reduced 
-0001eca0: 6172 6561 2e0a 2020 2020 2020 2020 2020  area..          
-0001ecb0: 2020 2d20 5468 6520 6675 6e63 7469 6f6e    - The function
-0001ecc0: 2061 6c73 6f20 6361 7074 7572 6573 2074   also captures t
-0001ecd0: 6865 206d 6963 726f 7363 6f70 6520 7374  he microscope st
-0001ece0: 6174 6520 6174 2074 6865 2074 696d 6520  ate at the time 
-0001ecf0: 6f66 2061 6371 7569 7369 7469 6f6e 2061  of acquisition a
-0001ed00: 6e64 2069 6e63 6c75 6465 7320 7468 6973  nd includes this
-0001ed10: 2069 6e66 6f72 6d61 7469 6f6e 2069 6e20   information in 
-0001ed20: 7468 6520 6d65 7461 6461 7461 206f 6620  the metadata of 
-0001ed30: 7468 6520 6163 7175 6972 6564 2069 6d61  the acquired ima
-0001ed40: 6765 2e0a 2020 2020 2020 2020 2222 220a  ge..        """.
-0001ed50: 2020 2020 2020 2020 2320 4174 2066 6972          # At fir
-0001ed60: 7374 206d 616b 6520 7375 7265 2074 6865  st make sure the
-0001ed70: 2062 6561 6d20 6973 204f 4e0a 2020 2020   beam is ON.    
-0001ed80: 2020 2020 7374 6174 7573 203d 2073 656c      status = sel
-0001ed90: 662e 636f 6e6e 6563 7469 6f6e 2e46 4942  f.connection.FIB
-0001eda0: 2e42 6561 6d2e 4765 7453 7461 7475 7328  .Beam.GetStatus(
-0001edb0: 290a 2020 2020 2020 2020 6966 2073 7461  ).        if sta
-0001edc0: 7475 7320 213d 2041 7574 6f6d 6174 696f  tus != Automatio
-0001edd0: 6e2e 4649 422e 4265 616d 2e53 7461 7475  n.FIB.Beam.Statu
-0001ede0: 732e 4265 616d 4f6e 3a0a 2020 2020 2020  s.BeamOn:.      
-0001edf0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0001ee00: 6374 696f 6e2e 4649 422e 4265 616d 2e4f  ction.FIB.Beam.O
-0001ee10: 6e28 290a 2020 2020 2020 2020 2320 696d  n().        # im
-0001ee20: 706f 7274 616e 743a 2073 746f 7020 7468  portant: stop th
-0001ee30: 6520 7363 616e 6e69 6e67 2062 6566 6f72  e scanning befor
-0001ee40: 6520 7765 2073 7461 7274 2073 6361 6e6e  e we start scann
-0001ee50: 696e 6720 6f72 2062 6566 6f72 6520 6175  ing or before au
-0001ee60: 746f 6d61 7469 6320 7072 6f63 6564 7572  tomatic procedur
-0001ee70: 6573 2c0a 2020 2020 2020 2020 2320 6576  es,.        # ev
-0001ee80: 656e 2062 6566 6f72 6520 7765 2063 6f6e  en before we con
-0001ee90: 6669 6775 7265 2074 6865 2064 6574 6563  figure the detec
-0001eea0: 746f 7273 0a20 2020 2020 2020 2073 656c  tors.        sel
-0001eeb0: 662e 636f 6e6e 6563 7469 6f6e 2e46 4942  f.connection.FIB
-0001eec0: 2e53 6361 6e2e 5374 6f70 2829 0a20 2020  .Scan.Stop().   
-0001eed0: 2020 2020 2023 2053 656c 6563 7420 7468       # Select th
-0001eee0: 6520 6465 7465 6374 6f72 2066 6f72 2069  e detector for i
-0001eef0: 6d61 6765 2069 2e65 2e3a 0a20 2020 2020  mage i.e.:.     
-0001ef00: 2020 2023 2031 2e20 6173 7369 676e 2074     # 1. assign t
-0001ef10: 6865 2064 6574 6563 746f 7220 746f 2061  he detector to a
-0001ef20: 2063 6861 6e6e 656c 0a20 2020 2020 2020   channel.       
-0001ef30: 2023 2032 2e20 656e 6162 6c65 2074 6865   # 2. enable the
-0001ef40: 2063 6861 6e6e 656c 2066 6f72 2061 6371   channel for acq
-0001ef50: 7569 7369 7469 6f6e 0a20 2020 2020 2020  uisition.       
-0001ef60: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0001ef70: 2e46 4942 2e44 6574 6563 746f 722e 5365  .FIB.Detector.Se
-0001ef80: 7428 0a20 2020 2020 2020 2020 2020 2030  t(.            0
-0001ef90: 2c20 7365 6c66 2e69 6f6e 5f64 6574 6563  , self.ion_detec
-0001efa0: 746f 725f 6163 7469 7665 2c20 4270 702e  tor_active, Bpp.
-0001efb0: 4772 6179 7363 616c 655f 385f 6269 740a  Grayscale_8_bit.
-0001efc0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001efd0: 2020 2064 7765 6c6c 5f74 696d 6520 3d20     dwell_time = 
-0001efe0: 696d 6167 655f 7365 7474 696e 6773 2e64  image_settings.d
-0001eff0: 7765 6c6c 5f74 696d 6520 2a20 636f 6e73  well_time * cons
-0001f000: 7461 6e74 732e 5349 5f54 4f5f 4e41 4e4f  tants.SI_TO_NANO
-0001f010: 0a0a 2020 2020 2020 2020 2320 7265 736f  ..        # reso
-0001f020: 6c75 7469 6f6e 0a20 2020 2020 2020 2069  lution.        i
-0001f030: 6d61 6765 5769 6474 6820 3d20 696d 6167  mageWidth = imag
-0001f040: 655f 7365 7474 696e 6773 2e72 6573 6f6c  e_settings.resol
-0001f050: 7574 696f 6e5b 305d 0a20 2020 2020 2020  ution[0].       
-0001f060: 2069 6d61 6765 4865 6967 6874 203d 2069   imageHeight = i
-0001f070: 6d61 6765 5f73 6574 7469 6e67 732e 7265  mage_settings.re
-0001f080: 736f 6c75 7469 6f6e 5b31 5d0a 0a20 2020  solution[1]..   
-0001f090: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0001f0a0: 7469 6f6e 2e46 4942 2e4f 7074 6963 732e  tion.FIB.Optics.
-0001f0b0: 5365 7456 6965 7766 6965 6c64 280a 2020  SetViewfield(.  
-0001f0c0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-0001f0d0: 7365 7474 696e 6773 2e68 6677 202a 2063  settings.hfw * c
-0001f0e0: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-0001f0f0: 4f5f 4d49 4c4c 494d 4554 5245 0a20 2020  O_MILLIMETRE.   
-0001f100: 2020 2020 2029 0a20 2020 2020 2020 200a       ).        .
-0001f110: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001f120: 2069 6620 696d 6167 655f 7365 7474 696e   if image_settin
-0001f130: 6773 2e72 6564 7563 6564 5f61 7265 6120  gs.reduced_area 
-0001f140: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001f150: 2020 2020 2020 2020 206c 6566 7420 3d20           left = 
-0001f160: 2069 6e74 2869 6d61 6765 5f73 6574 7469   int(image_setti
-0001f170: 6e67 732e 7265 6475 6365 645f 6172 6561  ngs.reduced_area
-0001f180: 2e6c 6566 7420 2a20 696d 6167 6557 6964  .left * imageWid
-0001f190: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-0001f1a0: 746f 7020 3d20 696e 7428 696d 6167 655f  top = int(image_
-0001f1b0: 7365 7474 696e 6773 2e72 6564 7563 6564  settings.reduced
-0001f1c0: 5f61 7265 612e 746f 7020 2a20 696d 6167  _area.top * imag
-0001f1d0: 6548 6569 6768 7429 200a 2020 2020 2020  eHeight) .      
-0001f1e0: 2020 2020 2020 7769 6474 6820 3d20 696e        width = in
-0001f1f0: 7428 696d 6167 655f 7365 7474 696e 6773  t(image_settings
-0001f200: 2e72 6564 7563 6564 5f61 7265 612e 7769  .reduced_area.wi
-0001f210: 6474 6820 2a20 696d 6167 6557 6964 7468  dth * imageWidth
-0001f220: 290a 2020 2020 2020 2020 2020 2020 6865  ).            he
-0001f230: 6967 6874 203d 2069 6e74 2869 6d61 6765  ight = int(image
-0001f240: 5f73 6574 7469 6e67 732e 7265 6475 6365  _settings.reduce
-0001f250: 645f 6172 6561 2e68 6569 6768 7420 2a20  d_area.height * 
-0001f260: 696d 6167 6548 6569 6768 7429 0a20 2020  imageHeight).   
-0001f270: 2020 2020 2020 2020 2069 6d61 6765 203d           image =
-0001f280: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0001f290: 2e46 4942 2e53 6361 6e2e 4163 7175 6972  .FIB.Scan.Acquir
-0001f2a0: 6552 4f49 4672 6f6d 4368 616e 6e65 6c28  eROIFromChannel(
-0001f2b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f2c0: 2043 6861 6e6e 656c 3d20 302c 0a20 2020   Channel= 0,.   
-0001f2d0: 2020 2020 2020 2020 2020 2020 2057 6964               Wid
-0001f2e0: 7468 3d20 696d 6167 6557 6964 7468 2c0a  th= imageWidth,.
-0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f300: 4865 6967 6874 3d20 696d 6167 6548 6569  Height= imageHei
-0001f310: 6768 742c 0a20 2020 2020 2020 2020 2020  ght,.           
-0001f320: 2020 2020 204c 6566 743d 206c 6566 742c       Left= left,
-0001f330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f340: 2054 6f70 3d20 746f 702c 0a20 2020 2020   Top= top,.     
-0001f350: 2020 2020 2020 2020 2020 2052 6967 6874             Right
-0001f360: 3d20 6c65 6674 202b 2077 6964 7468 202d  = left + width -
-0001f370: 3120 2c0a 2020 2020 2020 2020 2020 2020  1 ,.            
-0001f380: 2020 2020 426f 7474 6f6d 3d20 746f 7020      Bottom= top 
-0001f390: 2b20 6865 6967 6874 202d 2031 2c0a 2020  + height - 1,.  
-0001f3a0: 2020 2020 2020 2020 2020 2020 2020 4477                Dw
-0001f3b0: 656c 6c54 696d 653d 2064 7765 6c6c 5f74  ellTime= dwell_t
-0001f3c0: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
-0001f3d0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001f3e0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-0001f3f0: 6520 3d20 7365 6c66 2e63 6f6e 6e65 6374  e = self.connect
-0001f400: 696f 6e2e 4649 422e 5363 616e 2e41 6371  ion.FIB.Scan.Acq
-0001f410: 7569 7265 496d 6167 6546 726f 6d43 6861  uireImageFromCha
-0001f420: 6e6e 656c 280a 2020 2020 2020 2020 2020  nnel(.          
-0001f430: 2020 2020 2020 302c 2069 6d61 6765 5769        0, imageWi
-0001f440: 6474 682c 2069 6d61 6765 4865 6967 6874  dth, imageHeight
-0001f450: 2c20 6477 656c 6c5f 7469 6d65 0a20 2020  , dwell_time.   
-0001f460: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0001f470: 2020 2020 6d69 6372 6f73 636f 7065 5f73      microscope_s
-0001f480: 7461 7465 203d 204d 6963 726f 7363 6f70  tate = Microscop
-0001f490: 6553 7461 7465 280a 2020 2020 2020 2020  eState(.        
-0001f4a0: 2020 2020 7469 6d65 7374 616d 703d 6461      timestamp=da
-0001f4b0: 7465 7469 6d65 2e64 6174 6574 696d 652e  tetime.datetime.
-0001f4c0: 7469 6d65 7374 616d 7028 6461 7465 7469  timestamp(dateti
-0001f4d0: 6d65 2e64 6174 6574 696d 652e 6e6f 7728  me.datetime.now(
-0001f4e0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-0001f4f0: 7374 6167 655f 706f 7369 7469 6f6e 3d46  stage_position=F
-0001f500: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-0001f510: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0001f520: 2020 2020 783d 666c 6f61 7428 696d 6167      x=float(imag
-0001f530: 652e 4865 6164 6572 5b22 4649 4222 5d5b  e.Header["FIB"][
-0001f540: 2253 7461 6765 5822 5d29 2c0a 2020 2020  "StageX"]),.    
-0001f550: 2020 2020 2020 2020 2020 2020 793d 666c              y=fl
-0001f560: 6f61 7428 696d 6167 652e 4865 6164 6572  oat(image.Header
-0001f570: 5b22 4649 4222 5d5b 2253 7461 6765 5922  ["FIB"]["StageY"
-0001f580: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0001f590: 2020 2020 7a3d 666c 6f61 7428 696d 6167      z=float(imag
-0001f5a0: 652e 4865 6164 6572 5b22 4649 4222 5d5b  e.Header["FIB"][
-0001f5b0: 2253 7461 6765 5a22 5d29 2c0a 2020 2020  "StageZ"]),.    
-0001f5c0: 2020 2020 2020 2020 2020 2020 723d 666c              r=fl
-0001f5d0: 6f61 7428 696d 6167 652e 4865 6164 6572  oat(image.Header
-0001f5e0: 5b22 4649 4222 5d5b 2253 7461 6765 526f  ["FIB"]["StageRo
-0001f5f0: 7461 7469 6f6e 225d 292c 0a20 2020 2020  tation"]),.     
-0001f600: 2020 2020 2020 2020 2020 2074 3d66 6c6f             t=flo
-0001f610: 6174 2869 6d61 6765 2e48 6561 6465 725b  at(image.Header[
-0001f620: 2246 4942 225d 5b22 5374 6167 6554 696c  "FIB"]["StageTil
-0001f630: 7422 5d29 2c0a 2020 2020 2020 2020 2020  t"]),.          
-0001f640: 2020 2020 2020 636f 6f72 6469 6e61 7465        coordinate
-0001f650: 5f73 7973 7465 6d3d 2252 4157 222c 0a20  _system="RAW",. 
-0001f660: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-0001f670: 2020 2020 2020 2020 2020 656c 6563 7472            electr
-0001f680: 6f6e 5f62 6561 6d3d 4265 616d 5365 7474  on_beam=BeamSett
-0001f690: 696e 6773 2862 6561 6d5f 7479 7065 3d42  ings(beam_type=B
-0001f6a0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0001f6b0: 292c 0a20 2020 2020 2020 2020 2020 2069  ),.            i
-0001f6c0: 6f6e 5f62 6561 6d3d 4265 616d 5365 7474  on_beam=BeamSett
-0001f6d0: 696e 6773 280a 2020 2020 2020 2020 2020  ings(.          
-0001f6e0: 2020 2020 2020 6265 616d 5f74 7970 653d        beam_type=
-0001f6f0: 4265 616d 5479 7065 2e49 4f4e 2c0a 2020  BeamType.ION,.  
-0001f700: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-0001f710: 726b 696e 675f 6469 7374 616e 6365 3d66  rking_distance=f
-0001f720: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
-0001f730: 725b 2246 4942 225d 5b22 5744 225d 292c  r["FIB"]["WD"]),
-0001f740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f750: 2062 6561 6d5f 6375 7272 656e 743d 666c   beam_current=fl
-0001f760: 6f61 7428 7365 6c66 2e63 6f6e 6e65 6374  oat(self.connect
-0001f770: 696f 6e2e 4649 422e 4265 616d 2e52 6561  ion.FIB.Beam.Rea
-0001f780: 6450 726f 6265 4375 7272 656e 7428 2929  dProbeCurrent())
-0001f790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001f7a0: 2020 766f 6c74 6167 6520 3d20 666c 6f61    voltage = floa
-0001f7b0: 7428 7365 6c66 2e63 6f6e 6e65 6374 696f  t(self.connectio
-0001f7c0: 6e2e 4649 422e 4265 616d 2e47 6574 566f  n.FIB.Beam.GetVo
-0001f7d0: 6c74 6167 6528 2929 2c0a 2020 2020 2020  ltage()),.      
-0001f7e0: 2020 2020 2020 2020 2020 7265 736f 6c75            resolu
-0001f7f0: 7469 6f6e 3d5b 696d 6167 6557 6964 7468  tion=[imageWidth
-0001f800: 2c20 696d 6167 6548 6569 6768 745d 2c20  , imageHeight], 
-0001f810: 2322 7b7d 787b 7d22 2e66 6f72 6d61 7428  #"{}x{}".format(
-0001f820: 696d 6167 6557 6964 7468 2c20 696d 6167  imageWidth, imag
-0001f830: 6548 6569 6768 7429 2c0a 2020 2020 2020  eHeight),.      
-0001f840: 2020 2020 2020 2020 2020 6477 656c 6c5f            dwell_
-0001f850: 7469 6d65 3d66 6c6f 6174 2869 6d61 6765  time=float(image
-0001f860: 2e48 6561 6465 725b 2246 4942 225d 5b22  .Header["FIB"]["
-0001f870: 4477 656c 6c54 696d 6522 5d29 2c0a 2020  DwellTime"]),.  
-0001f880: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001f890: 6967 6d61 7469 6f6e 3d50 6f69 6e74 280a  igmation=Point(.
-0001f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8b0: 2020 2020 666c 6f61 7428 696d 6167 652e      float(image.
-0001f8c0: 4865 6164 6572 5b22 4649 4222 5d5b 2253  Header["FIB"]["S
-0001f8d0: 7469 676d 6174 6f72 5822 5d29 2c0a 2020  tigmatorX"]),.  
-0001f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8f0: 2020 666c 6f61 7428 696d 6167 652e 4865    float(image.He
-0001f900: 6164 6572 5b22 4649 4222 5d5b 2253 7469  ader["FIB"]["Sti
-0001f910: 676d 6174 6f72 5922 5d29 2c0a 2020 2020  gmatorY"]),.    
-0001f920: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-0001f930: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001f940: 6869 6674 3d50 6f69 6e74 280a 2020 2020  hift=Point(.    
-0001f950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f960: 666c 6f61 7428 696d 6167 652e 4865 6164  float(image.Head
-0001f970: 6572 5b22 4649 4222 5d5b 2249 6d61 6765  er["FIB"]["Image
-0001f980: 5368 6966 7458 225d 292c 0a20 2020 2020  ShiftX"]),.     
-0001f990: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001f9a0: 6c6f 6174 2869 6d61 6765 2e48 6561 6465  loat(image.Heade
-0001f9b0: 725b 2246 4942 225d 5b22 496d 6167 6553  r["FIB"]["ImageS
-0001f9c0: 6869 6674 5922 5d29 2c0a 2020 2020 2020  hiftY"]),.      
-0001f9d0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-0001f9e0: 2020 2020 2020 2020 2020 2020 2073 6361               sca
-0001f9f0: 6e5f 726f 7461 7469 6f6e 3d73 656c 662e  n_rotation=self.
-0001fa00: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e4f  connection.FIB.O
-0001fa10: 7074 6963 732e 4765 7449 6d61 6765 526f  ptics.GetImageRo
-0001fa20: 7461 7469 6f6e 2829 2c0a 2020 2020 2020  tation(),.      
-0001fa30: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-0001fa40: 2029 0a0a 2020 2020 2020 2020 6465 7465   )..        dete
-0001fa50: 6374 6f72 203d 2046 6962 7365 6d44 6574  ctor = FibsemDet
-0001fa60: 6563 746f 7253 6574 7469 6e67 7328 0a20  ectorSettings(. 
-0001fa70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001fa80: 7970 6520 3d20 7365 6c66 2e67 6574 2822  ype = self.get("
-0001fa90: 6465 7465 6374 6f72 5f74 7970 6522 2c20  detector_type", 
-0001faa0: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
-0001fab0: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
-0001fac0: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
-0001fad0: 3d20 224e 2f41 222c 0a20 2020 2020 2020  = "N/A",.       
-0001fae0: 2020 2020 2020 2020 2063 6f6e 7472 6173           contras
-0001faf0: 7420 3d20 7365 6c66 2e67 6574 2822 6465  t = self.get("de
-0001fb00: 7465 6374 6f72 5f63 6f6e 7472 6173 7422  tector_contrast"
-0001fb10: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
-0001fb20: 2e62 6561 6d5f 7479 7065 292c 0a20 2020  .beam_type),.   
-0001fb30: 2020 2020 2020 2020 2020 2020 2062 7269               bri
-0001fb40: 6768 746e 6573 733d 2073 656c 662e 6765  ghtness= self.ge
-0001fb50: 7428 2264 6574 6563 746f 725f 6272 6967  t("detector_brig
-0001fb60: 6874 6e65 7373 222c 2069 6d61 6765 5f73  htness", image_s
-0001fb70: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
-0001fb80: 6529 2c0a 0a20 2020 2020 2020 2020 2020  e),..           
-0001fb90: 2029 0a20 2020 2020 2020 2069 6d61 6765   ).        image
-0001fba0: 5f73 6574 7469 6e67 732e 7265 736f 6c75  _settings.resolu
-0001fbb0: 7469 6f6e 203d 205b 696d 6167 6557 6964  tion = [imageWid
-0001fbc0: 7468 2c20 696d 6167 6548 6569 6768 745d  th, imageHeight]
-0001fbd0: 0a20 2020 2020 2020 2066 6962 7365 6d5f  .        fibsem_
-0001fbe0: 696d 6167 6520 3d20 4669 6273 656d 496d  image = FibsemIm
-0001fbf0: 6167 652e 6672 6f6d 5465 7363 616e 496d  age.fromTescanIm
-0001fc00: 6167 6528 0a20 2020 2020 2020 2020 2020  age(.           
-0001fc10: 2069 6d61 6765 2c20 6465 6570 636f 7079   image, deepcopy
-0001fc20: 2869 6d61 6765 5f73 6574 7469 6e67 7329  (image_settings)
-0001fc30: 2c20 6465 6570 636f 7079 286d 6963 726f  , deepcopy(micro
-0001fc40: 7363 6f70 655f 7374 6174 6529 2c20 6465  scope_state), de
-0001fc50: 7465 6374 6f72 3d20 6465 7465 6374 6f72  tector= detector
-0001fc60: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0001fc70: 2020 2020 2320 6669 6273 656d 5f69 6d61      # fibsem_ima
-0001fc80: 6765 2e6d 6574 6164 6174 612e 696d 6167  ge.metadata.imag
-0001fc90: 655f 7365 7474 696e 6773 2e72 6573 6f6c  e_settings.resol
-0001fca0: 7574 696f 6e20 3d20 5b69 6d61 6765 5769  ution = [imageWi
-0001fcb0: 6474 682c 2069 6d61 6765 4865 6967 6874  dth, imageHeight
-0001fcc0: 5d0a 0a20 2020 2020 2020 2072 6574 7572  ]..        retur
-0001fcd0: 6e20 6669 6273 656d 5f69 6d61 6765 0a0a  n fibsem_image..
-0001fce0: 2020 2020 6465 6620 6c61 7374 5f69 6d61      def last_ima
-0001fcf0: 6765 2873 656c 662c 2062 6561 6d5f 7479  ge(self, beam_ty
-0001fd00: 7065 3a20 4265 616d 5479 7065 2e45 4c45  pe: BeamType.ELE
-0001fd10: 4354 524f 4e29 202d 3e20 4669 6273 656d  CTRON) -> Fibsem
-0001fd20: 496d 6167 653a 0a20 2020 2020 2020 2022  Image:.        "
-0001fd30: 2222 2020 2020 0a20 2020 2020 2020 2052  ""    .        R
-0001fd40: 6574 7572 6e73 2074 6865 206c 6173 7420  eturns the last 
-0001fd50: 6163 7175 6972 6564 2069 6d61 6765 2066  acquired image f
-0001fd60: 6f72 2074 6865 2073 7065 6369 6669 6564  or the specified
-0001fd70: 2062 6561 6d20 7479 7065 2e0a 0a20 2020   beam type...   
-0001fd80: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-0001fd90: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
-0001fda0: 2028 4265 616d 5479 7065 2e45 4c45 4354   (BeamType.ELECT
-0001fdb0: 524f 4e20 6f72 2042 6561 6d54 7970 652e  RON or BeamType.
-0001fdc0: 494f 4e29 3a20 5468 6520 7479 7065 206f  ION): The type o
-0001fdd0: 6620 6265 616d 2075 7365 6420 746f 2061  f beam used to a
-0001fde0: 6371 7569 7265 2074 6865 2069 6d61 6765  cquire the image
-0001fdf0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-0001fe00: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0001fe10: 4669 6273 656d 496d 6167 653a 2054 6865  FibsemImage: The
-0001fe20: 206c 6173 7420 6163 7175 6972 6564 2069   last acquired i
-0001fe30: 6d61 6765 206f 6620 7468 6520 7370 6563  mage of the spec
-0001fe40: 6966 6965 6420 6265 616d 2074 7970 652e  ified beam type.
-0001fe50: 0a0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0001fe60: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-0001fe70: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
-0001fe80: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-0001fe90: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-0001fea0: 2842 6561 6d54 7970 652e 454c 4543 5452  (BeamType.ELECTR
-0001feb0: 4f4e 2c20 7365 6c66 2e73 7973 7465 6d29  ON, self.system)
-0001fec0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-0001fed0: 6765 203d 2073 656c 662e 6c61 7374 5f69  ge = self.last_i
-0001fee0: 6d61 6765 5f65 620a 2020 2020 2020 2020  mage_eb.        
-0001fef0: 656c 6966 2062 6561 6d5f 7479 7065 203d  elif beam_type =
-0001ff00: 3d20 4265 616d 5479 7065 2e49 4f4e 3a0a  = BeamType.ION:.
-0001ff10: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-0001ff20: 636b 5f62 6561 6d28 4265 616d 5479 7065  ck_beam(BeamType
-0001ff30: 2e49 4f4e 2c20 7365 6c66 2e73 7973 7465  .ION, self.syste
-0001ff40: 6d29 0a20 2020 2020 2020 2020 2020 2069  m).            i
-0001ff50: 6d61 6765 203d 2073 656c 662e 6c61 7374  mage = self.last
-0001ff60: 5f69 6d61 6765 5f69 620a 2020 2020 2020  _image_ib.      
-0001ff70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001ff80: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-0001ff90: 696f 6e28 2242 6561 6d20 7479 7065 2065  ion("Beam type e
-0001ffa0: 7272 6f72 2229 0a20 2020 2020 2020 2069  rror").        i
-0001ffb0: 6620 696d 6167 6520 6973 206e 6f74 204e  f image is not N
-0001ffc0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001ffd0: 2069 6d61 6765 2e6d 6574 6164 6174 612e   image.metadata.
-0001ffe0: 7573 6572 203d 2073 656c 662e 7573 6572  user = self.user
-0001fff0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-00020000: 6765 2e6d 6574 6164 6174 612e 6578 7065  ge.metadata.expe
-00020010: 7269 6d65 6e74 203d 2073 656c 662e 6578  riment = self.ex
-00020020: 7065 7269 6d65 6e74 200a 2020 2020 2020  periment .      
-00020030: 2020 2020 2020 696d 6167 652e 6d65 7461        image.meta
-00020040: 6461 7461 2e73 7973 7465 6d20 3d20 7365  data.system = se
-00020050: 6c66 2e73 7973 7465 6d0a 2020 2020 2020  lf.system.      
-00020060: 2020 0a20 2020 2020 2020 2072 6574 7572    .        retur
-00020070: 6e20 696d 6167 650a 0a20 2020 2064 6566  n image..    def
-00020080: 205f 6765 745f 7072 6573 6574 7328 7365   _get_presets(se
-00020090: 6c66 293a 0a20 2020 2020 2020 2070 7265  lf):.        pre
-000200a0: 7365 7473 203d 2073 656c 662e 636f 6e6e  sets = self.conn
-000200b0: 6563 7469 6f6e 2e46 4942 2e50 7265 7365  ection.FIB.Prese
-000200c0: 742e 456e 756d 2829 090a 2020 2020 2020  t.Enum()..      
-000200d0: 2020 7265 7475 726e 2070 7265 7365 7473    return presets
-000200e0: 0a0a 2020 2020 6465 6620 6163 7175 6972  ..    def acquir
-000200f0: 655f 6368 616d 6265 725f 696d 6167 6528  e_chamber_image(
-00020100: 7365 6c66 2920 2d3e 2046 6962 7365 6d49  self) -> FibsemI
-00020110: 6d61 6765 3a0a 2020 2020 2020 2020 2222  mage:.        ""
-00020120: 2241 6371 7569 7265 2061 6e20 696d 6167  "Acquire an imag
-00020130: 6520 6f66 2074 6865 2063 6861 6d62 6572  e of the chamber
-00020140: 2069 6e73 6964 652e 2222 220a 2020 2020   inside.""".    
-00020150: 2020 2020 696d 6167 6520 3d20 7365 6c66      image = self
-00020160: 2e63 6f6e 6e65 6374 696f 6e2e 4361 6d65  .connection.Came
-00020170: 7261 2e41 6371 7569 7265 496d 6167 6528  ra.AcquireImage(
-00020180: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
-00020190: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
-000201a0: 2261 6371 7569 7265 5f63 6861 6d62 6572  "acquire_chamber
-000201b0: 5f69 6d61 6765 227d 290a 2020 2020 2020  _image"}).      
-000201c0: 2020 7265 7475 726e 2046 6962 7365 6d49    return FibsemI
-000201d0: 6d61 6765 2864 6174 613d 6e70 2e61 7272  mage(data=np.arr
-000201e0: 6179 2869 6d61 6765 2e49 6d61 6765 292c  ay(image.Image),
-000201f0: 206d 6574 6164 6174 613d 4e6f 6e65 2920   metadata=None) 
-00020200: 2020 0a0a 2020 2020 6465 6620 6c69 7665    ..    def live
-00020210: 5f69 6d61 6769 6e67 2873 656c 662c 2069  _imaging(self, i
-00020220: 6d61 6765 5f73 6574 7469 6e67 733a 2049  mage_settings: I
-00020230: 6d61 6765 5365 7474 696e 6773 2c20 696d  mageSettings, im
-00020240: 6167 655f 7175 6575 653a 2051 7565 7565  age_queue: Queue
-00020250: 2c20 7374 6f70 5f65 7665 6e74 3a20 7468  , stop_event: th
-00020260: 7265 6164 696e 672e 4576 656e 7429 3a0a  reading.Event):.
-00020270: 2020 2020 2020 2020 7365 6c66 2e69 6d61          self.ima
-00020280: 6765 5f71 7565 7565 203d 2069 6d61 6765  ge_queue = image
-00020290: 5f71 7565 7565 0a20 2020 2020 2020 2073  _queue.        s
-000202a0: 656c 662e 7374 6f70 5f65 7665 6e74 203d  elf.stop_event =
-000202b0: 2073 746f 705f 6576 656e 740a 2020 2020   stop_event.    
-000202c0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-000202d0: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
-000202e0: 6561 6d5f 7479 7065 2c20 7365 6c66 2e73  eam_type, self.s
-000202f0: 7973 7465 6d29 0a20 2020 2020 2020 206c  ystem).        l
-00020300: 6f67 6769 6e67 2e69 6e66 6f28 6622 4c69  ogging.info(f"Li
-00020310: 7665 2069 6d61 6769 6e67 3a20 7b69 6d61  ve imaging: {ima
-00020320: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
-00020330: 5f74 7970 657d 2229 0a20 2020 2020 2020  _type}").       
-00020340: 2077 6869 6c65 206e 6f74 2073 656c 662e   while not self.
-00020350: 7374 6f70 5f65 7665 6e74 2e69 735f 7365  stop_event.is_se
-00020360: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
-00020370: 2069 6d61 6765 203d 2073 656c 662e 6163   image = self.ac
-00020380: 7175 6972 655f 696d 6167 6528 6465 6570  quire_image(deep
-00020390: 636f 7079 2869 6d61 6765 5f73 6574 7469  copy(image_setti
-000203a0: 6e67 7329 290a 2020 2020 2020 2020 2020  ngs)).          
-000203b0: 2020 696d 6167 655f 7175 6575 652e 7075    image_queue.pu
-000203c0: 7428 696d 6167 6529 0a0a 0a0a 2020 2020  t(image)....    
-000203d0: 4074 6872 6561 645f 776f 726b 6572 0a20  @thread_worker. 
-000203e0: 2020 2064 6566 2063 6f6e 7375 6d65 5f69     def consume_i
-000203f0: 6d61 6765 5f71 7565 7565 2873 656c 662c  mage_queue(self,
-00020400: 2070 6172 656e 745f 7569 203d 204e 6f6e   parent_ui = Non
-00020410: 652c 2073 6c65 6570 203d 2030 2e31 293a  e, sleep = 0.1):
-00020420: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
-00020430: 672e 696e 666f 2822 436f 6e73 756d 696e  g.info("Consumin
-00020440: 6720 696d 6167 6520 7175 6575 6522 290a  g image queue").
-00020450: 0a20 2020 2020 2020 2077 6869 6c65 206e  .        while n
-00020460: 6f74 2073 656c 662e 7374 6f70 5f65 7665  ot self.stop_eve
-00020470: 6e74 2e69 735f 7365 7428 293a 0a20 2020  nt.is_set():.   
-00020480: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00020490: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-000204a0: 6d65 2e73 6c65 6570 2873 6c65 6570 290a  me.sleep(sleep).
-000204b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000204c0: 6966 206e 6f74 2073 656c 662e 696d 6167  if not self.imag
-000204d0: 655f 7175 6575 652e 656d 7074 7928 293a  e_queue.empty():
-000204e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000204f0: 2020 2020 2069 6d61 6765 203d 2073 656c       image = sel
-00020500: 662e 696d 6167 655f 7175 6575 652e 6765  f.image_queue.ge
-00020510: 7428 7469 6d65 6f75 743d 3129 0a20 2020  t(timeout=1).   
-00020520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020530: 2069 6620 696d 6167 652e 6d65 7461 6461   if image.metada
-00020540: 7461 2e69 6d61 6765 5f73 6574 7469 6e67  ta.image_setting
-00020550: 732e 7361 7665 3a0a 2020 2020 2020 2020  s.save:.        
-00020560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020570: 696d 6167 652e 6d65 7461 6461 7461 2e69  image.metadata.i
-00020580: 6d61 6765 5f73 6574 7469 6e67 732e 6669  mage_settings.fi
-00020590: 6c65 6e61 6d65 203d 2066 227b 696d 6167  lename = f"{imag
-000205a0: 652e 6d65 7461 6461 7461 2e69 6d61 6765  e.metadata.image
-000205b0: 5f73 6574 7469 6e67 732e 6669 6c65 6e61  _settings.filena
-000205c0: 6d65 7d5f 7b75 7469 6c73 2e63 7572 7265  me}_{utils.curre
-000205d0: 6e74 5f74 696d 6573 7461 6d70 2829 7d22  nt_timestamp()}"
-000205e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000205f0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00020600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020610: 2066 696c 656e 616d 6520 3d20 6f73 2e70   filename = os.p
-00020620: 6174 682e 6a6f 696e 2869 6d61 6765 2e6d  ath.join(image.m
-00020630: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
-00020640: 7474 696e 6773 2e70 6174 682c 2069 6d61  ttings.path, ima
-00020650: 6765 2e6d 6574 6164 6174 612e 696d 6167  ge.metadata.imag
-00020660: 655f 7365 7474 696e 6773 2e66 696c 656e  e_settings.filen
-00020670: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00020680: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
-00020690: 6765 2e73 6176 6528 7061 7468 3d66 696c  ge.save(path=fil
-000206a0: 656e 616d 6529 0a20 2020 2020 2020 2020  ename).         
-000206b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000206c0: 6f67 6769 6e67 2e69 6e66 6f28 6622 5361  ogging.info(f"Sa
-000206d0: 7665 6420 696d 6167 6520 746f 207b 6669  ved image to {fi
-000206e0: 6c65 6e61 6d65 7d22 290a 0a20 2020 2020  lename}")..     
-000206f0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00020700: 6f67 6769 6e67 2e69 6e66 6f28 6622 496d  ogging.info(f"Im
-00020710: 6167 653a 207b 696d 6167 652e 6461 7461  age: {image.data
-00020720: 2e73 6861 7065 7d22 290a 2020 2020 2020  .shape}").      
-00020730: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00020740: 6767 696e 672e 696e 666f 2866 222d 2220  gging.info(f"-" 
-00020750: 2a20 3530 290a 0a20 2020 2020 2020 2020  * 50)..         
-00020760: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
-00020770: 7265 6e74 5f75 6920 6973 206e 6f74 204e  rent_ui is not N
-00020780: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00020790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000207a0: 2070 6172 656e 745f 7569 2e6c 6976 655f   parent_ui.live_
-000207b0: 696d 6167 696e 675f 7369 676e 616c 2e65  imaging_signal.e
-000207c0: 6d69 7428 7b22 696d 6167 6522 3a20 696d  mit({"image": im
-000207d0: 6167 657d 290a 0a0a 2020 2020 2020 2020  age})...        
-000207e0: 2020 2020 6578 6365 7074 204b 6579 626f      except Keybo
-000207f0: 6172 6449 6e74 6572 7275 7074 3a0a 2020  ardInterrupt:.  
-00020800: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00020810: 6c66 2e73 746f 705f 6576 656e 740a 2020  lf.stop_event.  
-00020820: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00020830: 6767 696e 672e 696e 666f 2822 4b65 7962  gging.info("Keyb
-00020840: 6f61 7264 2069 6e74 6572 7275 7074 2c20  oard interrupt, 
-00020850: 7374 6f70 7069 6e67 206c 6976 6520 696d  stopping live im
-00020860: 6167 696e 6722 290a 2020 2020 2020 2020  aging").        
-00020870: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00020880: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00020890: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000208a0: 7374 6f70 5f65 7665 6e74 2e73 6574 2829  stop_event.set()
-000208b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000208c0: 2069 6d70 6f72 7420 7472 6163 6562 6163   import tracebac
-000208d0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
-000208e0: 2020 6c6f 6767 696e 672e 6572 726f 7228    logging.error(
-000208f0: 7472 6163 6562 6163 6b2e 666f 726d 6174  traceback.format
-00020900: 5f65 7863 2829 290a 2020 2020 2020 2020  _exc()).        
-00020910: 0a20 2020 2064 6566 2061 7574 6f63 6f6e  .    def autocon
-00020920: 7472 6173 7428 7365 6c66 2c20 6265 616d  trast(self, beam
-00020930: 5f74 7970 653a 2042 6561 6d54 7970 6529  _type: BeamType)
-00020940: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00020950: 2020 2222 2241 7574 6f6d 6174 6963 616c    """Automatical
-00020960: 6c79 2061 646a 7573 7420 7468 6520 6d69  ly adjust the mi
-00020970: 6372 6f73 636f 7065 2069 6d61 6765 2063  croscope image c
-00020980: 6f6e 7472 6173 7420 666f 7220 7468 6520  ontrast for the 
-00020990: 7370 6563 6966 6965 6420 6265 616d 2074  specified beam t
-000209a0: 7970 652e 0a0a 2020 2020 2020 2020 4172  ype...        Ar
-000209b0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-000209c0: 6265 616d 5f74 7970 6520 2842 6561 6d54  beam_type (BeamT
-000209d0: 7970 652c 206f 7074 696f 6e61 6c29 3a20  ype, optional): 
-000209e0: 5468 6520 696d 6167 696e 6720 6265 616d  The imaging beam
-000209f0: 2074 7970 6520 666f 7220 7768 6963 6820   type for which 
-00020a00: 746f 2061 646a 7573 7420 7468 6520 636f  to adjust the co
-00020a10: 6e74 7261 7374 2e0a 2020 2020 2020 2020  ntrast..        
-00020a20: 2020 2020 2020 2020 4465 6661 756c 7473          Defaults
-00020a30: 2074 6f20 4265 616d 5479 7065 2e45 4c45   to BeamType.ELE
-00020a40: 4354 524f 4e2e 0a20 2020 2020 2020 2022  CTRON..        "
-00020a50: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
-00020a60: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-00020a70: 2c20 7365 6c66 2e73 7973 7465 6d29 0a20  , self.system). 
-00020a80: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00020a90: 6e66 6f28 6622 5275 6e6e 696e 6720 6175  nfo(f"Running au
-00020aa0: 746f 636f 6e74 7261 7374 206f 6e20 7b62  tocontrast on {b
-00020ab0: 6561 6d5f 7479 7065 2e6e 616d 657d 2e22  eam_type.name}."
-00020ac0: 290a 2020 2020 2020 2020 6966 2062 6561  ).        if bea
-00020ad0: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
-00020ae0: 7065 2e45 4c45 4354 524f 4e3a 0a20 2020  pe.ELECTRON:.   
-00020af0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00020b00: 6e6e 6563 7469 6f6e 2e53 454d 2e44 6574  nnection.SEM.Det
-00020b10: 6563 746f 722e 4175 746f 5369 676e 616c  ector.AutoSignal
-00020b20: 2844 6574 6563 746f 723d 7365 6c66 2e65  (Detector=self.e
-00020b30: 6c65 6374 726f 6e5f 6465 7465 6374 6f72  lectron_detector
-00020b40: 5f61 6374 6976 6529 0a20 2020 2020 2020  _active).       
-00020b50: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
-00020b60: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
-00020b70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00020b80: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e44  connection.FIB.D
-00020b90: 6574 6563 746f 722e 4175 746f 5369 676e  etector.AutoSign
-00020ba0: 616c 2844 6574 6563 746f 723d 7365 6c66  al(Detector=self
-00020bb0: 2e69 6f6e 5f64 6574 6563 746f 725f 6163  .ion_detector_ac
-00020bc0: 7469 7665 290a 0a20 2020 200a 2020 2020  tive)..    .    
-00020bd0: 6465 6620 6175 746f 5f66 6f63 7573 2873  def auto_focus(s
-00020be0: 656c 662c 2062 6561 6d5f 7479 7065 3a20  elf, beam_type: 
-00020bf0: 4265 616d 5479 7065 2920 2d3e 204e 6f6e  BeamType) -> Non
-00020c00: 653a 0a20 2020 2020 2020 205f 6368 6563  e:.        _chec
-00020c10: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-00020c20: 2c20 7365 6c66 2e73 7973 7465 6d29 0a20  , self.system). 
-00020c30: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-00020c40: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
-00020c50: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-00020c60: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00020c70: 666f 2822 5275 6e6e 696e 6720 6175 746f  fo("Running auto
-00020c80: 666f 6375 7320 6f6e 2065 6c65 6374 726f  focus on electro
-00020c90: 6e20 6265 616d 2e22 290a 2020 2020 2020  n beam.").      
-00020ca0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00020cb0: 6374 696f 6e2e 5345 4d2e 4175 746f 5744  ction.SEM.AutoWD
-00020cc0: 4669 6e65 2873 656c 662e 656c 6563 7472  Fine(self.electr
-00020cd0: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
-00020ce0: 7665 290a 2020 2020 2020 2020 656c 7365  ve).        else
-00020cf0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00020d00: 6767 696e 672e 696e 666f 2822 4175 746f  gging.info("Auto
-00020d10: 2066 6f63 7573 2069 7320 6e6f 7420 7375   focus is not su
-00020d20: 7070 6f72 7465 6420 666f 7220 696f 6e20  pported for ion 
-00020d30: 6265 616d 2074 7970 652e 2229 0a20 2020  beam type.").   
-00020d40: 2020 2020 2072 6574 7572 6e20 0a0a 2020       return ..  
-00020d50: 2020 6465 6620 7265 7365 745f 6265 616d    def reset_beam
-00020d60: 5f73 6869 6674 7328 7365 6c66 293a 0a20  _shifts(self):. 
-00020d70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00020d80: 2020 2053 6574 2074 6865 2062 6561 6d20     Set the beam 
-00020d90: 7368 6966 7420 746f 207a 6572 6f20 666f  shift to zero fo
-00020da0: 7220 7468 6520 656c 6563 7472 6f6e 2061  r the electron a
-00020db0: 6e64 2069 6f6e 2062 6561 6d73 2e0a 0a20  nd ion beams... 
-00020dc0: 2020 2020 2020 2052 6573 6574 7320 7468         Resets th
-00020dd0: 6520 6265 616d 2073 6869 6674 2066 6f72  e beam shift for
-00020de0: 2062 6f74 6820 7468 6520 656c 6563 7472   both the electr
-00020df0: 6f6e 2061 6e64 2069 6f6e 2062 6561 6d73  on and ion beams
-00020e00: 2074 6f20 2830 2c30 292c 2065 6666 6563   to (0,0), effec
-00020e10: 7469 7665 6c79 2063 656e 7465 7269 6e67  tively centering
-00020e20: 2074 6865 2062 6561 6d73 206f 6e20 7468   the beams on th
-00020e30: 6520 7361 6d70 6c65 2e0a 0a20 2020 2020  e sample...     
-00020e40: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00020e50: 2020 2020 2073 656c 6620 2846 6962 7365       self (Fibse
-00020e60: 6d4d 6963 726f 7363 6f70 6529 3a20 696e  mMicroscope): in
-00020e70: 7374 616e 6365 206f 6620 7468 6520 4669  stance of the Fi
-00020e80: 6273 656d 4d69 6372 6f73 636f 7065 206f  bsemMicroscope o
-00020e90: 626a 6563 740a 2020 2020 2020 2020 2222  bject.        ""
-00020ea0: 220a 2020 2020 2020 2020 5f63 6865 636b  ".        _check
-00020eb0: 5f62 6561 6d28 4265 616d 5479 7065 2e45  _beam(BeamType.E
-00020ec0: 4c45 4354 524f 4e2c 2073 656c 662e 7379  LECTRON, self.sy
-00020ed0: 7374 656d 290a 2020 2020 2020 2020 6c6f  stem).        lo
-00020ee0: 6767 696e 672e 6465 6275 6728 0a20 2020  gging.debug(.   
-00020ef0: 2020 2020 2020 2020 2066 2272 6573 6574           f"reset
-00020f00: 696e 6720 6562 6561 6d20 7368 6966 7420  ing ebeam shift 
-00020f10: 746f 2028 302c 2030 2920 6672 6f6d 3a20  to (0, 0) from: 
-00020f20: 7b73 656c 662e 636f 6e6e 6563 7469 6f6e  {self.connection
-00020f30: 2e46 4942 2e4f 7074 6963 732e 4765 7449  .FIB.Optics.GetI
-00020f40: 6d61 6765 5368 6966 7428 297d 2028 6d6d  mageShift()} (mm
-00020f50: 2922 0a20 2020 2020 2020 2029 0a20 2020  )".        ).   
-00020f60: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00020f70: 7469 6f6e 2e46 4942 2e4f 7074 6963 732e  tion.FIB.Optics.
-00020f80: 5365 7449 6d61 6765 5368 6966 7428 302c  SetImageShift(0,
-00020f90: 2030 290a 2020 2020 2020 2020 5f63 6865   0).        _che
-00020fa0: 636b 5f62 6561 6d28 4265 616d 5479 7065  ck_beam(BeamType
-00020fb0: 2e49 4f4e 2c20 7365 6c66 2e73 7973 7465  .ION, self.syste
-00020fc0: 6d29 0a20 2020 2020 2020 206c 6f67 6769  m).        loggi
-00020fd0: 6e67 2e64 6562 7567 280a 2020 2020 2020  ng.debug(.      
-00020fe0: 2020 2020 2020 6622 7265 7365 7469 6e67        f"reseting
-00020ff0: 2065 6265 616d 2073 6869 6674 2074 6f20   ebeam shift to 
-00021000: 2830 2c20 3029 2066 726f 6d3a 207b 7365  (0, 0) from: {se
-00021010: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-00021020: 4d2e 4f70 7469 6373 2e47 6574 496d 6167  M.Optics.GetImag
-00021030: 6553 6869 6674 2829 7d20 286d 6d29 220a  eShift()} (mm)".
-00021040: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00021050: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00021060: 6e2e 5345 4d2e 4f70 7469 6373 2e53 6574  n.SEM.Optics.Set
-00021070: 496d 6167 6553 6869 6674 2830 2c20 3029  ImageShift(0, 0)
-00021080: 0a0a 0a20 2020 2064 6566 2062 6561 6d5f  ...    def beam_
-00021090: 7368 6966 7428 7365 6c66 2c20 6478 3a20  shift(self, dx: 
-000210a0: 666c 6f61 742c 2064 793a 2066 6c6f 6174  float, dy: float
-000210b0: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
-000210c0: 6d54 7970 6520 3d20 4265 616d 5479 7065  mType = BeamType
-000210d0: 2e49 4f4e 293a 0a20 2020 2020 2020 2022  .ION):.        "
-000210e0: 2222 4164 6a75 7374 7320 7468 6520 6265  ""Adjusts the be
-000210f0: 616d 2073 6869 6674 2062 6173 6564 206f  am shift based o
-00021100: 6e20 7265 6c61 7469 7665 2076 616c 7565  n relative value
-00021110: 7320 7468 6174 2061 7265 2070 726f 7669  s that are provi
-00021120: 6465 642e 0a20 2020 2020 2020 200a 2020  ded..        .  
-00021130: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-00021140: 2020 2020 2020 2020 7365 6c66 2028 4669          self (Fi
-00021150: 6273 656d 4d69 6372 6f73 636f 7065 293a  bsemMicroscope):
-00021160: 2046 6962 7365 6d20 6d69 6372 6f73 636f   Fibsem microsco
-00021170: 7065 206f 626a 6563 740a 2020 2020 2020  pe object.      
-00021180: 2020 2020 2020 6478 2028 666c 6f61 7429        dx (float)
-00021190: 3a20 7468 6520 7265 6c61 7469 7665 2078  : the relative x
-000211a0: 2074 6572 6d0a 2020 2020 2020 2020 2020   term.          
-000211b0: 2020 6479 2028 666c 6f61 7429 3a20 7468    dy (float): th
-000211c0: 6520 7265 6c61 7469 7665 2079 2074 6572  e relative y ter
-000211d0: 6d0a 2020 2020 2020 2020 2222 220a 2020  m.        """.  
-000211e0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-000211f0: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
-00021200: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
-00021210: 2020 6966 2062 6561 6d5f 7479 7065 203d    if beam_type =
-00021220: 3d20 4265 616d 5479 7065 2e49 4f4e 3a0a  = BeamType.ION:.
-00021230: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-00021240: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-00021250: 6f6e 2e46 4942 2e4f 7074 6963 730a 2020  on.FIB.Optics.  
-00021260: 2020 2020 2020 656c 6966 2062 6561 6d5f        elif beam_
-00021270: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-00021280: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
-00021290: 2020 2020 2020 2062 6561 6d20 3d20 7365         beam = se
-000212a0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-000212b0: 4d2e 4f70 7469 6373 0a20 2020 2020 2020  M.Optics.       
-000212c0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-000212d0: 7b62 6561 6d5f 7479 7065 2e6e 616d 657d  {beam_type.name}
-000212e0: 2073 6869 6674 696e 6720 6279 2028 7b64   shifting by ({d
-000212f0: 787d 2c20 7b64 797d 2922 290a 2020 2020  x}, {dy})").    
-00021300: 2020 2020 782c 2079 203d 2062 6561 6d2e      x, y = beam.
-00021310: 4765 7449 6d61 6765 5368 6966 7428 290a  GetImageShift().
-00021320: 2020 2020 2020 2020 6478 202a 3d20 2063          dx *=  c
-00021330: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-00021340: 4f5f 4d49 4c4c 494d 4554 5245 2023 2043  O_MILLIMETRE # C
-00021350: 6f6e 7665 7274 2074 6f20 6d6d 2066 726f  onvert to mm fro
-00021360: 6d20 6d2e 0a20 2020 2020 2020 2064 7920  m m..        dy 
-00021370: 2a3d 2020 636f 6e73 7461 6e74 732e 4d45  *=  constants.ME
-00021380: 5452 455f 544f 5f4d 494c 4c49 4d45 5452  TRE_TO_MILLIMETR
-00021390: 450a 2020 2020 2020 2020 7820 2b3d 2064  E.        x += d
-000213a0: 7820 0a20 2020 2020 2020 2079 202b 3d20  x .        y += 
-000213b0: 6479 0a20 2020 2020 2020 2062 6561 6d2e  dy.        beam.
-000213c0: 5365 7449 6d61 6765 5368 6966 7428 782c  SetImageShift(x,
-000213d0: 7929 200a 0a20 2020 2020 2020 206c 6f67  y) ..        log
-000213e0: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
-000213f0: 223a 2022 6265 616d 5f73 6869 6674 222c  ": "beam_shift",
-00021400: 2022 6478 223a 2064 782c 2022 6479 223a   "dx": dx, "dy":
-00021410: 2064 792c 2022 6265 616d 5f74 7970 6522   dy, "beam_type"
-00021420: 3a20 6265 616d 5f74 7970 652e 6e61 6d65  : beam_type.name
-00021430: 7d29 200a 2020 2020 2020 2020 0a20 2020  }) .        .   
-00021440: 2064 6566 2067 6574 5f73 7461 6765 5f70   def get_stage_p
-00021450: 6f73 6974 696f 6e28 7365 6c66 293a 0a20  osition(self):. 
-00021460: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00021470: 2020 2047 6574 2074 6865 2063 7572 7265     Get the curre
-00021480: 6e74 2073 7461 6765 2070 6f73 6974 696f  nt stage positio
-00021490: 6e2e 0a0a 2020 2020 2020 2020 5468 6973  n...        This
-000214a0: 206d 6574 686f 6420 7265 7472 6965 7665   method retrieve
-000214b0: 7320 7468 6520 6375 7272 656e 7420 7374  s the current st
-000214c0: 6167 6520 706f 7369 7469 6f6e 2066 726f  age position fro
-000214d0: 6d20 7468 6520 6d69 6372 6f73 636f 7065  m the microscope
-000214e0: 2061 6e64 2072 6574 7572 6e73 2069 7420   and returns it 
-000214f0: 6173 0a20 2020 2020 2020 2061 2046 6962  as.        a Fib
-00021500: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00021510: 206f 626a 6563 742e 0a0a 2020 2020 2020   object...      
-00021520: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00021530: 2020 2020 2020 2046 6962 7365 6d53 7461         FibsemSta
-00021540: 6765 506f 7369 7469 6f6e 3a20 5468 6520  gePosition: The 
-00021550: 6375 7272 656e 7420 7374 6167 6520 706f  current stage po
-00021560: 7369 7469 6f6e 2e0a 2020 2020 2020 2020  sition..        
-00021570: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-00021580: 656c 662e 7379 7374 656d 2e73 7461 6765  elf.system.stage
-00021590: 5f65 6e61 626c 6564 2069 7320 4661 6c73  _enabled is Fals
-000215a0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-000215b0: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-000215c0: 7465 6445 7272 6f72 2822 5374 6167 6520  tedError("Stage 
-000215d0: 6973 206e 6f74 2065 6e61 626c 6564 2e22  is not enabled."
-000215e0: 290a 2020 2020 2020 2020 782c 2079 2c20  ).        x, y, 
-000215f0: 7a2c 2072 2c20 7420 3d20 7365 6c66 2e63  z, r, t = self.c
-00021600: 6f6e 6e65 6374 696f 6e2e 5374 6167 652e  onnection.Stage.
-00021610: 4765 7450 6f73 6974 696f 6e28 290a 2020  GetPosition().  
-00021620: 2020 2020 2020 7374 6167 655f 706f 7369        stage_posi
-00021630: 7469 6f6e 203d 2046 6962 7365 6d53 7461  tion = FibsemSta
-00021640: 6765 506f 7369 7469 6f6e 280a 2020 2020  gePosition(.    
-00021650: 2020 2020 2020 2020 7820 3d20 7820 2a20          x = x * 
-00021660: 636f 6e73 7461 6e74 732e 4d49 4c4c 494d  constants.MILLIM
-00021670: 4554 5245 5f54 4f5f 4d45 5452 452c 0a20  ETRE_TO_METRE,. 
-00021680: 2020 2020 2020 2020 2020 2079 203d 2079             y = y
-00021690: 202a 2063 6f6e 7374 616e 7473 2e4d 494c   * constants.MIL
-000216a0: 4c49 4d45 5452 455f 544f 5f4d 4554 5245  LIMETRE_TO_METRE
-000216b0: 2c0a 2020 2020 2020 2020 2020 2020 7a20  ,.            z 
-000216c0: 3d20 7a20 2a20 636f 6e73 7461 6e74 732e  = z * constants.
-000216d0: 4d49 4c4c 494d 4554 5245 5f54 4f5f 4d45  MILLIMETRE_TO_ME
-000216e0: 5452 452c 0a20 2020 2020 2020 2020 2020  TRE,.           
-000216f0: 2072 203d 2072 202a 2063 6f6e 7374 616e   r = r * constan
-00021700: 7473 2e44 4547 5245 4553 5f54 4f5f 5241  ts.DEGREES_TO_RA
-00021710: 4449 414e 532c 0a20 2020 2020 2020 2020  DIANS,.         
-00021720: 2020 2074 203d 2074 202a 2063 6f6e 7374     t = t * const
-00021730: 616e 7473 2e44 4547 5245 4553 5f54 4f5f  ants.DEGREES_TO_
-00021740: 5241 4449 414e 532c 0a20 2020 2020 2020  RADIANS,.       
-00021750: 2020 2020 2063 6f6f 7264 696e 6174 655f       coordinate_
-00021760: 7379 7374 656d 3d20 2252 4157 222c 0a20  system= "RAW",. 
-00021770: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00021780: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-00021790: 226d 7367 223a 2022 6765 745f 7374 6167  "msg": "get_stag
-000217a0: 655f 706f 7369 7469 6f6e 222c 2022 706f  e_position", "po
-000217b0: 7322 3a20 7374 6167 655f 706f 7369 7469  s": stage_positi
-000217c0: 6f6e 2e74 6f5f 6469 6374 2829 7d29 0a20  on.to_dict()}). 
-000217d0: 2020 2020 2020 2072 6574 7572 6e20 7374         return st
-000217e0: 6167 655f 706f 7369 7469 6f6e 0a0a 2020  age_position..  
-000217f0: 2020 6465 6620 6765 745f 6d69 6372 6f73    def get_micros
-00021800: 636f 7065 5f73 7461 7465 2873 656c 6629  cope_state(self)
-00021810: 202d 3e20 4d69 6372 6f73 636f 7065 5374   -> MicroscopeSt
-00021820: 6174 653a 0a20 2020 2020 2020 2022 2222  ate:.        """
-00021830: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
-00021840: 2063 7572 7265 6e74 206d 6963 726f 7363   current microsc
-00021850: 6f70 6520 7374 6174 650a 0a20 2020 2020  ope state..     
-00021860: 2020 2054 6869 7320 6d65 7468 6f64 2072     This method r
-00021870: 6574 7269 6576 6573 2074 6865 2063 7572  etrieves the cur
-00021880: 7265 6e74 206d 6963 726f 7363 6f70 6520  rent microscope 
-00021890: 7374 6174 6520 6672 6f6d 2074 6865 206d  state from the m
-000218a0: 6963 726f 7363 6f70 6520 616e 6420 7265  icroscope and re
-000218b0: 7475 726e 7320 6974 2061 730a 2020 2020  turns it as.    
-000218c0: 2020 2020 6120 4d69 6372 6f73 636f 7065      a Microscope
-000218d0: 5374 6174 6520 6f62 6a65 6374 2e0a 0a20  State object... 
-000218e0: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-000218f0: 2020 2020 2020 2020 2020 2020 4d69 6372              Micr
-00021900: 6f73 636f 7065 5374 6174 653a 2063 7572  oscopeState: cur
-00021910: 7265 6e74 206d 6963 726f 7363 6f70 6520  rent microscope 
-00021920: 7374 6174 650a 2020 2020 2020 2020 2222  state.        ""
-00021930: 220a 0a20 2020 2020 2020 2069 6620 7365  "..        if se
-00021940: 6c66 2e73 7973 7465 6d2e 656c 6563 7472  lf.system.electr
-00021950: 6f6e 2069 7320 5472 7565 3a0a 2020 2020  on is True:.    
-00021960: 2020 2020 2020 2020 696d 6167 655f 6562          image_eb
-00021970: 203d 2073 656c 662e 6c61 7374 5f69 6d61   = self.last_ima
-00021980: 6765 2842 6561 6d54 7970 652e 454c 4543  ge(BeamType.ELEC
-00021990: 5452 4f4e 290a 2020 2020 2020 2020 2020  TRON).          
-000219a0: 2020 6966 2069 6d61 6765 5f65 6220 6973    if image_eb is
-000219b0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000219c0: 2020 2020 2020 2020 2020 2065 6c65 6374             elect
-000219d0: 726f 6e5f 6265 616d 203d 2042 6561 6d53  ron_beam = BeamS
-000219e0: 6574 7469 6e67 7328 0a20 2020 2020 2020  ettings(.       
-000219f0: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
-00021a00: 7065 3d42 6561 6d54 7970 652e 454c 4543  pe=BeamType.ELEC
-00021a10: 5452 4f4e 2c0a 2020 2020 2020 2020 2020  TRON,.          
-00021a20: 2020 2020 2020 776f 726b 696e 675f 6469        working_di
-00021a30: 7374 616e 6365 3d73 656c 662e 636f 6e6e  stance=self.conn
-00021a40: 6563 7469 6f6e 2e53 454d 2e4f 7074 6963  ection.SEM.Optic
-00021a50: 732e 4765 7457 4428 2920 2a20 636f 6e73  s.GetWD() * cons
-00021a60: 7461 6e74 732e 4d49 4c4c 494d 4554 5245  tants.MILLIMETRE
-00021a70: 5f54 4f5f 4d45 5452 452c 0a20 2020 2020  _TO_METRE,.     
-00021a80: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-00021a90: 6375 7272 656e 743d 7365 6c66 2e63 6f6e  current=self.con
-00021aa0: 6e65 6374 696f 6e2e 5345 4d2e 4265 616d  nection.SEM.Beam
-00021ab0: 2e47 6574 4375 7272 656e 7428 2920 2a20  .GetCurrent() * 
-00021ac0: 636f 6e73 7461 6e74 732e 5049 434f 5f54  constants.PICO_T
-00021ad0: 4f5f 5349 2c0a 2020 2020 2020 2020 2020  O_SI,.          
-00021ae0: 2020 2020 2020 766f 6c74 6167 653d 7365        voltage=se
-00021af0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-00021b00: 4d2e 4265 616d 2e47 6574 566f 6c74 6167  M.Beam.GetVoltag
-00021b10: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
-00021b20: 2020 2020 2068 6677 3d73 656c 662e 636f       hfw=self.co
-00021b30: 6e6e 6563 7469 6f6e 2e53 454d 2e4f 7074  nnection.SEM.Opt
-00021b40: 6963 732e 4765 7456 6965 7766 6965 6c64  ics.GetViewfield
-00021b50: 2829 202a 2063 6f6e 7374 616e 7473 2e4d  () * constants.M
-00021b60: 494c 4c49 4d45 5452 455f 544f 5f4d 4554  ILLIMETRE_TO_MET
-00021b70: 5245 2c0a 2020 2020 2020 2020 2020 2020  RE,.            
-00021b80: 2020 2020 7265 736f 6c75 7469 6f6e 3d69      resolution=i
-00021b90: 6d61 6765 5f65 622e 6d65 7461 6461 7461  mage_eb.metadata
-00021ba0: 2e69 6d61 6765 5f73 6574 7469 6e67 732e  .image_settings.
-00021bb0: 7265 736f 6c75 7469 6f6e 2c20 2023 2054  resolution,  # T
-00021bc0: 4f44 4f20 6669 7820 7468 6573 6520 656d  ODO fix these em
-00021bd0: 7074 7920 7061 7261 6d65 7465 7273 0a20  pty parameters. 
-00021be0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00021bf0: 7765 6c6c 5f74 696d 653d 696d 6167 655f  well_time=image_
-00021c00: 6562 2e6d 6574 6164 6174 612e 696d 6167  eb.metadata.imag
-00021c10: 655f 7365 7474 696e 6773 2e64 7765 6c6c  e_settings.dwell
-00021c20: 5f74 696d 652c 0a20 2020 2020 2020 2020  _time,.         
-00021c30: 2020 2020 2020 2073 7469 676d 6174 696f         stigmatio
-00021c40: 6e3d 696d 6167 655f 6562 2e6d 6574 6164  n=image_eb.metad
-00021c50: 6174 612e 6d69 6372 6f73 636f 7065 5f73  ata.microscope_s
-00021c60: 7461 7465 2e65 6c65 6374 726f 6e5f 6265  tate.electron_be
-00021c70: 616d 2e73 7469 676d 6174 696f 6e2c 0a20  am.stigmation,. 
-00021c80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00021c90: 6869 6674 3d69 6d61 6765 5f65 622e 6d65  hift=image_eb.me
-00021ca0: 7461 6461 7461 2e6d 6963 726f 7363 6f70  tadata.microscop
-00021cb0: 655f 7374 6174 652e 656c 6563 7472 6f6e  e_state.electron
-00021cc0: 5f62 6561 6d2e 7368 6966 742c 0a20 2020  _beam.shift,.   
-00021cd0: 2020 2020 2020 2020 2020 2020 2073 6361               sca
-00021ce0: 6e5f 726f 7461 7469 6f6e 3d73 656c 662e  n_rotation=self.
-00021cf0: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e4f  connection.SEM.O
-00021d00: 7074 6963 732e 4765 7449 6d61 6765 526f  ptics.GetImageRo
-00021d10: 7461 7469 6f6e 2829 0a20 2020 2020 2020  tation().       
-00021d20: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00021d30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00021d40: 2020 2020 2020 2020 2065 6c65 6374 726f           electro
-00021d50: 6e5f 6265 616d 203d 2042 6561 6d53 6574  n_beam = BeamSet
-00021d60: 7469 6e67 7328 4265 616d 5479 7065 2e45  tings(BeamType.E
-00021d70: 4c45 4354 524f 4e29 0a20 2020 2020 2020  LECTRON).       
-00021d80: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00021d90: 2020 2065 6c65 6374 726f 6e5f 6265 616d     electron_beam
-00021da0: 203d 2042 6561 6d53 6574 7469 6e67 7328   = BeamSettings(
-00021db0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-00021dc0: 4e29 0a20 2020 2020 2020 200a 2020 2020  N).        .    
-00021dd0: 2020 2020 6966 2073 656c 662e 7379 7374      if self.syst
-00021de0: 656d 2e69 6f6e 2069 7320 5472 7565 3a0a  em.ion is True:.
-00021df0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-00021e00: 655f 6962 203d 2073 656c 662e 6c61 7374  e_ib = self.last
-00021e10: 5f69 6d61 6765 2842 6561 6d54 7970 652e  _image(BeamType.
-00021e20: 494f 4e29 0a20 2020 2020 2020 2020 2020  ION).           
-00021e30: 2069 6620 696d 6167 655f 6962 2069 7320   if image_ib is 
-00021e40: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00021e50: 2020 2020 2020 2020 2020 696f 6e5f 6265            ion_be
-00021e60: 616d 203d 2042 6561 6d53 6574 7469 6e67  am = BeamSetting
-00021e70: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00021e80: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-00021e90: 7479 7065 3d42 6561 6d54 7970 652e 494f  type=BeamType.IO
-00021ea0: 4e2c 0a20 2020 2020 2020 2020 2020 2020  N,.             
-00021eb0: 2020 2020 2020 2020 2020 2077 6f72 6b69             worki
-00021ec0: 6e67 5f64 6973 7461 6e63 653d 696d 6167  ng_distance=imag
-00021ed0: 655f 6962 2e6d 6574 6164 6174 612e 6d69  e_ib.metadata.mi
-00021ee0: 6372 6f73 636f 7065 5f73 7461 7465 2e69  croscope_state.i
-00021ef0: 6f6e 5f62 6561 6d2e 776f 726b 696e 675f  on_beam.working_
-00021f00: 6469 7374 616e 6365 2c0a 2020 2020 2020  distance,.      
-00021f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021f20: 2020 6265 616d 5f63 7572 7265 6e74 3d73    beam_current=s
-00021f30: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
-00021f40: 4942 2e42 6561 6d2e 5265 6164 5072 6f62  IB.Beam.ReadProb
-00021f50: 6543 7572 7265 6e74 2829 202a 2063 6f6e  eCurrent() * con
-00021f60: 7374 616e 7473 2e50 4943 4f5f 544f 5f53  stants.PICO_TO_S
-00021f70: 492c 0a20 2020 2020 2020 2020 2020 2020  I,.             
-00021f80: 2020 2020 2020 2020 2020 2076 6f6c 7461             volta
-00021f90: 6765 3d73 656c 662e 636f 6e6e 6563 7469  ge=self.connecti
-00021fa0: 6f6e 2e46 4942 2e42 6561 6d2e 4765 7456  on.FIB.Beam.GetV
-00021fb0: 6f6c 7461 6765 2829 2c0a 2020 2020 2020  oltage(),.      
-00021fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021fd0: 2020 6866 773d 7365 6c66 2e63 6f6e 6e65    hfw=self.conne
-00021fe0: 6374 696f 6e2e 4649 422e 4f70 7469 6373  ction.FIB.Optics
-00021ff0: 2e47 6574 5669 6577 6669 656c 6428 2920  .GetViewfield() 
-00022000: 2a20 636f 6e73 7461 6e74 732e 4d49 4c4c  * constants.MILL
-00022010: 494d 4554 5245 5f54 4f5f 4d45 5452 452c  IMETRE_TO_METRE,
-00022020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022030: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-00022040: 696f 6e3d 696d 6167 655f 6962 2e6d 6574  ion=image_ib.met
-00022050: 6164 6174 612e 696d 6167 655f 7365 7474  adata.image_sett
-00022060: 696e 6773 2e72 6573 6f6c 7574 696f 6e2c  ings.resolution,
-00022070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022080: 2020 2020 2020 2020 2064 7765 6c6c 5f74           dwell_t
-00022090: 696d 653d 696d 6167 655f 6962 2e6d 6574  ime=image_ib.met
-000220a0: 6164 6174 612e 696d 6167 655f 7365 7474  adata.image_sett
-000220b0: 696e 6773 2e64 7765 6c6c 5f74 696d 652c  ings.dwell_time,
-000220c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000220d0: 2020 2020 2020 2020 2073 7469 676d 6174           stigmat
-000220e0: 696f 6e3d 696d 6167 655f 6962 2e6d 6574  ion=image_ib.met
-000220f0: 6164 6174 612e 6d69 6372 6f73 636f 7065  adata.microscope
-00022100: 5f73 7461 7465 2e69 6f6e 5f62 6561 6d2e  _state.ion_beam.
-00022110: 7374 6967 6d61 7469 6f6e 2c0a 2020 2020  stigmation,.    
-00022120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022130: 2020 2020 7368 6966 743d 696d 6167 655f      shift=image_
-00022140: 6962 2e6d 6574 6164 6174 612e 6d69 6372  ib.metadata.micr
-00022150: 6f73 636f 7065 5f73 7461 7465 2e69 6f6e  oscope_state.ion
-00022160: 5f62 6561 6d2e 7368 6966 742c 0a20 2020  _beam.shift,.   
-00022170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022180: 2020 2020 2073 6361 6e5f 726f 7461 7469       scan_rotati
-00022190: 6f6e 3d73 656c 662e 636f 6e6e 6563 7469  on=self.connecti
-000221a0: 6f6e 2e46 4942 2e4f 7074 6963 732e 4765  on.FIB.Optics.Ge
-000221b0: 7449 6d61 6765 526f 7461 7469 6f6e 2829  tImageRotation()
-000221c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000221d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000221e0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-000221f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00022200: 2020 2020 2020 2020 2020 696f 6e5f 6265            ion_be
-00022210: 616d 203d 2042 6561 6d53 6574 7469 6e67  am = BeamSetting
-00022220: 7328 4265 616d 5479 7065 2e49 4f4e 290a  s(BeamType.ION).
-00022230: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00022240: 2020 2020 2020 2020 2020 696f 6e5f 6265            ion_be
-00022250: 616d 203d 2042 6561 6d53 6574 7469 6e67  am = BeamSetting
-00022260: 7328 4265 616d 5479 7065 2e49 4f4e 290a  s(BeamType.ION).
-00022270: 2020 2020 0a20 2020 2020 2020 2065 6c65      .        ele
-00022280: 6374 726f 6e5f 6465 7465 6374 6f72 203d  ctron_detector =
-00022290: 2073 656c 662e 6765 745f 6465 7465 6374   self.get_detect
-000222a0: 6f72 5f73 6574 7469 6e67 7328 4265 616d  or_settings(Beam
-000222b0: 5479 7065 2e45 4c45 4354 524f 4e29 0a20  Type.ELECTRON). 
-000222c0: 2020 2020 2020 2069 6f6e 5f64 6574 6563         ion_detec
-000222d0: 746f 7220 3d20 7365 6c66 2e67 6574 5f64  tor = self.get_d
-000222e0: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
-000222f0: 2842 6561 6d54 7970 652e 494f 4e29 0a0a  (BeamType.ION)..
-00022300: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-00022310: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-00022320: 203d 204d 6963 726f 7363 6f70 6553 7461   = MicroscopeSta
-00022330: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
-00022340: 7469 6d65 7374 616d 703d 6461 7465 7469  timestamp=dateti
-00022350: 6d65 2e64 6174 6574 696d 652e 7469 6d65  me.datetime.time
-00022360: 7374 616d 7028 6461 7465 7469 6d65 2e64  stamp(datetime.d
-00022370: 6174 6574 696d 652e 6e6f 7728 2929 2c0a  atetime.now()),.
-00022380: 2020 2020 2020 2020 2020 2020 2320 6765              # ge
-00022390: 7420 6162 736f 6c75 7465 2073 7461 6765  t absolute stage
-000223a0: 2063 6f6f 7264 696e 6174 6573 2028 5241   coordinates (RA
-000223b0: 5729 0a20 2020 2020 2020 2020 2020 2073  W).            s
-000223c0: 7461 6765 5f70 6f73 6974 696f 6e3d 7365  tage_position=se
-000223d0: 6c66 2e67 6574 5f73 7461 6765 5f70 6f73  lf.get_stage_pos
-000223e0: 6974 696f 6e28 292c 0a20 2020 2020 2020  ition(),.       
-000223f0: 2020 2020 2023 2065 6c65 6374 726f 6e20       # electron 
-00022400: 6265 616d 2073 6574 7469 6e67 730a 2020  beam settings.  
-00022410: 2020 2020 2020 2020 2020 656c 6563 7472            electr
-00022420: 6f6e 5f62 6561 6d3d 656c 6563 7472 6f6e  on_beam=electron
-00022430: 5f62 6561 6d2c 0a20 2020 2020 2020 2020  _beam,.         
-00022440: 2020 2023 2069 6f6e 2062 6561 6d20 7365     # ion beam se
-00022450: 7474 696e 6773 0a20 2020 2020 2020 2020  ttings.         
-00022460: 2020 2069 6f6e 5f62 6561 6d3d 696f 6e5f     ion_beam=ion_
-00022470: 6265 616d 2c0a 2020 2020 2020 2020 2020  beam,.          
-00022480: 2020 2320 656c 6563 7472 6f6e 2064 6574    # electron det
-00022490: 6563 746f 7220 7365 7474 696e 6773 0a20  ector settings. 
-000224a0: 2020 2020 2020 2020 2020 2065 6c65 6374             elect
-000224b0: 726f 6e5f 6465 7465 6374 6f72 3d65 6c65  ron_detector=ele
-000224c0: 6374 726f 6e5f 6465 7465 6374 6f72 2c0a  ctron_detector,.
-000224d0: 2020 2020 2020 2020 2020 2020 2320 696f              # io
-000224e0: 6e20 6465 7465 6374 6f72 2073 6574 7469  n detector setti
-000224f0: 6e67 730a 2020 2020 2020 2020 2020 2020  ngs.            
-00022500: 696f 6e5f 6465 7465 6374 6f72 3d69 6f6e  ion_detector=ion
-00022510: 5f64 6574 6563 746f 722c 0a20 2020 2020  _detector,.     
-00022520: 2020 2029 0a0a 2020 2020 2020 2020 6c6f     )..        lo
-00022530: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
-00022540: 6722 3a20 2267 6574 5f6d 6963 726f 7363  g": "get_microsc
-00022550: 6f70 655f 7374 6174 6522 2c20 2273 7461  ope_state", "sta
-00022560: 7465 223a 2063 7572 7265 6e74 5f6d 6963  te": current_mic
-00022570: 726f 7363 6f70 655f 7374 6174 652e 746f  roscope_state.to
-00022580: 5f64 6963 7428 297d 290a 0a20 2020 2020  _dict()})..     
-00022590: 2020 2072 6574 7572 6e20 6375 7272 656e     return curren
-000225a0: 745f 6d69 6372 6f73 636f 7065 5f73 7461  t_microscope_sta
-000225b0: 7465 0a0a 2020 2020 6465 6620 7361 6665  te..    def safe
-000225c0: 5f61 6273 6f6c 7574 655f 7374 6167 655f  _absolute_stage_
-000225d0: 6d6f 7665 6d65 6e74 2873 656c 662c 2073  movement(self, s
-000225e0: 7461 6765 5f70 6f73 6974 696f 6e3a 2046  tage_position: F
-000225f0: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-00022600: 6f6e 0a20 2020 2020 2020 2029 202d 3e20  on.        ) -> 
-00022610: 4e6f 6e65 3a0a 0a20 2020 2020 2020 2023  None:..        #
-00022620: 2054 4f44 4f3a 2069 6d70 6c65 6d65 6e74   TODO: implement
-00022630: 2069 6620 7265 7175 6972 6564 2e0a 2020   if required..  
-00022640: 2020 2020 2020 7365 6c66 2e6d 6f76 655f        self.move_
-00022650: 7374 6167 655f 6162 736f 6c75 7465 2873  stage_absolute(s
-00022660: 7461 6765 5f70 6f73 6974 696f 6e29 0a20  tage_position). 
-00022670: 2020 200a 2020 2020 6465 6620 7072 6f6a     .    def proj
-00022680: 6563 745f 7374 6162 6c65 5f6d 6f76 6528  ect_stable_move(
-00022690: 7365 6c66 2c20 6478 3a66 6c6f 6174 2c20  self, dx:float, 
-000226a0: 6479 3a66 6c6f 6174 2c20 6265 616d 5f74  dy:float, beam_t
-000226b0: 7970 653a 4265 616d 5479 7065 2c20 6261  ype:BeamType, ba
-000226c0: 7365 5f70 6f73 6974 696f 6e3a 4669 6273  se_position:Fibs
-000226d0: 656d 5374 6167 6550 6f73 6974 696f 6e29  emStagePosition)
-000226e0: 202d 3e20 4669 6273 656d 5374 6167 6550   -> FibsemStageP
-000226f0: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-00022700: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
-00022710: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-00022720: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
-00022730: 696d 6167 655f 726f 7461 7469 6f6e 203d  image_rotation =
-00022740: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00022750: 2e53 454d 2e4f 7074 6963 732e 4765 7449  .SEM.Optics.GetI
-00022760: 6d61 6765 526f 7461 7469 6f6e 2829 0a20  mageRotation(). 
-00022770: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00022780: 2020 2020 2020 2020 2069 6d61 6765 5f72           image_r
-00022790: 6f74 6174 696f 6e20 3d20 7365 6c66 2e63  otation = self.c
-000227a0: 6f6e 6e65 6374 696f 6e2e 4649 422e 4f70  onnection.FIB.Op
-000227b0: 7469 6373 2e47 6574 496d 6167 6552 6f74  tics.GetImageRot
-000227c0: 6174 696f 6e28 290a 0a20 2020 2020 2020  ation()..       
-000227d0: 2069 6620 6e70 2e69 736e 616e 2869 6d61   if np.isnan(ima
-000227e0: 6765 5f72 6f74 6174 696f 6e29 3a0a 2020  ge_rotation):.  
-000227f0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-00022800: 726f 7461 7469 6f6e 203d 2030 2e30 0a0a  rotation = 0.0..
-00022810: 2020 2020 2020 2020 6478 203d 2020 2d28          dx =  -(
-00022820: 6478 2a6e 702e 636f 7328 696d 6167 655f  dx*np.cos(image_
-00022830: 726f 7461 7469 6f6e 2a6e 702e 7069 2f31  rotation*np.pi/1
-00022840: 3830 2920 2b20 6479 2a6e 702e 7369 6e28  80) + dy*np.sin(
-00022850: 696d 6167 655f 726f 7461 7469 6f6e 2a6e  image_rotation*n
-00022860: 702e 7069 2f31 3830 2929 0a20 2020 2020  p.pi/180)).     
-00022870: 2020 2064 7920 3d20 2d28 6479 2a6e 702e     dy = -(dy*np.
-00022880: 636f 7328 696d 6167 655f 726f 7461 7469  cos(image_rotati
-00022890: 6f6e 2a6e 702e 7069 2f31 3830 2920 2d20  on*np.pi/180) - 
-000228a0: 6478 2a6e 702e 7369 6e28 696d 6167 655f  dx*np.sin(image_
-000228b0: 726f 7461 7469 6f6e 2a6e 702e 7069 2f31  rotation*np.pi/1
-000228c0: 3830 2929 0a20 2020 2020 2020 2070 6f69  80)).        poi
-000228d0: 6e74 5f79 7a20 3d20 7365 6c66 2e5f 795f  nt_yz = self._y_
-000228e0: 636f 7272 6563 7465 645f 7374 6167 655f  corrected_stage_
-000228f0: 6d6f 7665 6d65 6e74 2864 792c 2062 6561  movement(dy, bea
-00022900: 6d5f 7479 7065 290a 2020 2020 2020 2020  m_type).        
-00022910: 6479 2c20 647a 203d 2070 6f69 6e74 5f79  dy, dz = point_y
-00022920: 7a2e 792c 2070 6f69 6e74 5f79 7a2e 7a0a  z.y, point_yz.z.
-00022930: 0a20 2020 2020 2020 2023 2063 616c 6375  .        # calcu
-00022940: 6c61 7465 2074 6865 2063 6f72 7265 6374  late the correct
-00022950: 6564 206d 6f76 6520 746f 2072 6561 6368  ed move to reach
-00022960: 2074 6861 7420 706f 696e 7420 6672 6f6d   that point from
-00022970: 2062 6173 652d 7374 6174 653f 0a20 2020   base-state?.   
-00022980: 2020 2020 205f 6e65 775f 706f 7369 7469       _new_positi
-00022990: 6f6e 203d 2064 6565 7063 6f70 7928 6261  on = deepcopy(ba
-000229a0: 7365 5f70 6f73 6974 696f 6e29 0a20 2020  se_position).   
-000229b0: 2020 2020 205f 6e65 775f 706f 7369 7469       _new_positi
-000229c0: 6f6e 2e78 202b 3d20 6478 0a20 2020 2020  on.x += dx.     
-000229d0: 2020 205f 6e65 775f 706f 7369 7469 6f6e     _new_position
-000229e0: 2e79 202b 3d20 6479 0a20 2020 2020 2020  .y += dy.       
-000229f0: 205f 6e65 775f 706f 7369 7469 6f6e 2e7a   _new_position.z
-00022a00: 202b 3d20 647a 0a0a 2020 2020 2020 2020   += dz..        
-00022a10: 7265 7475 726e 205f 6e65 775f 706f 7369  return _new_posi
-00022a20: 7469 6f6e 2023 2054 4f44 4f3a 2069 6d70  tion # TODO: imp
-00022a30: 6c65 6d65 6e74 0a0a 2020 2020 6465 6620  lement..    def 
-00022a40: 6d6f 7665 5f73 7461 6765 5f61 6273 6f6c  move_stage_absol
-00022a50: 7574 6528 7365 6c66 2c20 706f 7369 7469  ute(self, positi
-00022a60: 6f6e 3a20 4669 6273 656d 5374 6167 6550  on: FibsemStageP
-00022a70: 6f73 6974 696f 6e29 3a0a 2020 2020 2020  osition):.      
-00022a80: 2020 2222 220a 2020 2020 2020 2020 4d6f    """.        Mo
-00022a90: 7665 2074 6865 2073 7461 6765 2074 6f20  ve the stage to 
-00022aa0: 7468 6520 7370 6563 6966 6965 6420 636f  the specified co
-00022ab0: 6f72 6469 6e61 7465 732e 0a0a 2020 2020  ordinates...    
-00022ac0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00022ad0: 2020 2020 2020 7820 2866 6c6f 6174 293a        x (float):
-00022ae0: 2054 6865 2078 2d63 6f6f 7264 696e 6174   The x-coordinat
-00022af0: 6520 746f 206d 6f76 6520 746f 2028 696e  e to move to (in
-00022b00: 206d 6574 6572 7329 2e0a 2020 2020 2020   meters)..      
-00022b10: 2020 2020 2020 7920 2866 6c6f 6174 293a        y (float):
-00022b20: 2054 6865 2079 2d63 6f6f 7264 696e 6174   The y-coordinat
-00022b30: 6520 746f 206d 6f76 6520 746f 2028 696e  e to move to (in
-00022b40: 206d 6574 6572 7329 2e0a 2020 2020 2020   meters)..      
-00022b50: 2020 2020 2020 7a20 2866 6c6f 6174 293a        z (float):
-00022b60: 2054 6865 207a 2d63 6f6f 7264 696e 6174   The z-coordinat
-00022b70: 6520 746f 206d 6f76 6520 746f 2028 696e  e to move to (in
-00022b80: 206d 6574 6572 7329 2e0a 2020 2020 2020   meters)..      
-00022b90: 2020 2020 2020 7220 2866 6c6f 6174 293a        r (float):
-00022ba0: 2054 6865 2072 6f74 6174 696f 6e20 746f   The rotation to
-00022bb0: 2061 7070 6c79 2028 696e 2072 6164 6961   apply (in radia
-00022bc0: 6e73 292e 0a20 2020 2020 2020 2020 2020  ns)..           
-00022bd0: 2074 7820 2866 6c6f 6174 293a 2054 6865   tx (float): The
-00022be0: 2078 2d61 7869 7320 7469 6c74 2074 6f20   x-axis tilt to 
-00022bf0: 6170 706c 7920 2869 6e20 7261 6469 616e  apply (in radian
-00022c00: 7329 2e0a 0a20 2020 2020 2020 2052 6574  s)...        Ret
-00022c10: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-00022c20: 2020 4e6f 6e65 0a20 2020 2020 2020 2022    None.        "
-00022c30: 2222 0a20 2020 2020 2020 2069 6620 706f  "".        if po
-00022c40: 7369 7469 6f6e 2e72 2069 7320 6e6f 7420  sition.r is not 
-00022c50: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00022c60: 2020 726f 7461 7469 6f6e 203d 2054 7275    rotation = Tru
-00022c70: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00022c80: 2020 2020 2020 2020 2020 2020 726f 7461              rota
-00022c90: 7469 6f6e 203d 2046 616c 7365 0a20 2020  tion = False.   
-00022ca0: 2020 2020 2069 6620 706f 7369 7469 6f6e       if position
-00022cb0: 2e74 2069 7320 6e6f 7420 4e6f 6e65 3a0a  .t is not None:.
-00022cc0: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
-00022cd0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00022ce0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00022cf0: 2020 7469 6c74 203d 2046 616c 7365 0a20    tilt = False. 
-00022d00: 2020 2020 2020 205f 6368 6563 6b5f 7374         _check_st
-00022d10: 6167 6528 7365 6c66 2e73 7973 7465 6d2c  age(self.system,
-00022d20: 2072 6f74 6174 696f 6e3d 726f 7461 7469   rotation=rotati
-00022d30: 6f6e 2c20 7469 6c74 3d74 696c 7429 0a20  on, tilt=tilt). 
-00022d40: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00022d50: 6e66 6f28 6622 4d6f 7669 6e67 2073 7461  nfo(f"Moving sta
-00022d60: 6765 2074 6f20 7b70 6f73 6974 696f 6e7d  ge to {position}
-00022d70: 2e22 290a 2020 2020 2020 2020 7365 6c66  .").        self
-00022d80: 2e63 6f6e 6e65 6374 696f 6e2e 5374 6167  .connection.Stag
-00022d90: 652e 4d6f 7665 546f 280a 2020 2020 2020  e.MoveTo(.      
-00022da0: 2020 2020 2020 706f 7369 7469 6f6e 2e78        position.x
-00022db0: 202a 2063 6f6e 7374 616e 7473 2e4d 4554   * constants.MET
-00022dc0: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
-00022dd0: 2069 6620 706f 7369 7469 6f6e 2e78 2069   if position.x i
-00022de0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
-00022df0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00022e00: 2020 706f 7369 7469 6f6e 2e79 202a 2063    position.y * c
-00022e10: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-00022e20: 4f5f 4d49 4c4c 494d 4554 5245 2069 6620  O_MILLIMETRE if 
-00022e30: 706f 7369 7469 6f6e 2e79 2069 7320 6e6f  position.y is no
-00022e40: 7420 4e6f 6e65 2065 6c73 6520 4e6f 6e65  t None else None
-00022e50: 2c0a 2020 2020 2020 2020 2020 2020 706f  ,.            po
-00022e60: 7369 7469 6f6e 2e7a 202a 2063 6f6e 7374  sition.z * const
-00022e70: 616e 7473 2e4d 4554 5245 5f54 4f5f 4d49  ants.METRE_TO_MI
-00022e80: 4c4c 494d 4554 5245 2069 6620 706f 7369  LLIMETRE if posi
-00022e90: 7469 6f6e 2e7a 2069 7320 6e6f 7420 4e6f  tion.z is not No
-00022ea0: 6e65 2065 6c73 6520 4e6f 6e65 2c0a 2020  ne else None,.  
-00022eb0: 2020 2020 2020 2020 2020 706f 7369 7469            positi
-00022ec0: 6f6e 2e72 202a 2063 6f6e 7374 616e 7473  on.r * constants
-00022ed0: 2e52 4144 4941 4e53 5f54 4f5f 4445 4752  .RADIANS_TO_DEGR
-00022ee0: 4545 5320 6966 2070 6f73 6974 696f 6e2e  EES if position.
-00022ef0: 7220 6973 206e 6f74 204e 6f6e 6520 656c  r is not None el
-00022f00: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
-00022f10: 2020 2020 2070 6f73 6974 696f 6e2e 7420       position.t 
-00022f20: 2a20 636f 6e73 7461 6e74 732e 5241 4449  * constants.RADI
-00022f30: 414e 535f 544f 5f44 4547 5245 4553 2069  ANS_TO_DEGREES i
-00022f40: 6620 706f 7369 7469 6f6e 2e74 2069 7320  f position.t is 
-00022f50: 6e6f 7420 4e6f 6e65 2065 6c73 6520 4e6f  not None else No
-00022f60: 6e65 2c0a 2020 2020 2020 2020 290a 0a20  ne,.        ).. 
-00022f70: 2020 2064 6566 206d 6f76 655f 7374 6167     def move_stag
-00022f80: 655f 7265 6c61 7469 7665 280a 2020 2020  e_relative(.    
-00022f90: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00022fa0: 2020 706f 7369 7469 6f6e 3a20 4669 6273    position: Fibs
-00022fb0: 656d 5374 6167 6550 6f73 6974 696f 6e2c  emStagePosition,
-00022fc0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-00022fd0: 2222 220a 2020 2020 2020 2020 4d6f 7665  """.        Move
-00022fe0: 2074 6865 2073 7461 6765 2062 7920 7468   the stage by th
-00022ff0: 6520 7370 6563 6966 6965 6420 7265 6c61  e specified rela
-00023000: 7469 7665 206d 6f76 652e 0a0a 2020 2020  tive move...    
-00023010: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-00023020: 2020 2020 2020 7820 2866 6c6f 6174 293a        x (float):
-00023030: 2054 6865 2078 2d63 6f6f 7264 696e 6174   The x-coordinat
-00023040: 6520 746f 206d 6f76 6520 746f 2028 696e  e to move to (in
-00023050: 206d 6574 6572 7329 2e0a 2020 2020 2020   meters)..      
-00023060: 2020 2020 2020 7920 2866 6c6f 6174 293a        y (float):
-00023070: 2054 6865 2079 2d63 6f6f 7264 696e 6174   The y-coordinat
-00023080: 6520 746f 206d 6f76 6520 746f 2028 696e  e to move to (in
-00023090: 206d 6574 6572 7329 2e0a 2020 2020 2020   meters)..      
-000230a0: 2020 2020 2020 7a20 2866 6c6f 6174 293a        z (float):
-000230b0: 2054 6865 207a 2d63 6f6f 7264 696e 6174   The z-coordinat
-000230c0: 6520 746f 206d 6f76 6520 746f 2028 696e  e to move to (in
-000230d0: 206d 6574 6572 7329 2e0a 2020 2020 2020   meters)..      
-000230e0: 2020 2020 2020 7220 2866 6c6f 6174 293a        r (float):
-000230f0: 2054 6865 2072 6f74 6174 696f 6e20 746f   The rotation to
-00023100: 2061 7070 6c79 2028 696e 2064 6567 7265   apply (in degre
-00023110: 6573 292e 0a20 2020 2020 2020 2020 2020  es)..           
-00023120: 2074 7820 2866 6c6f 6174 293a 2054 6865   tx (float): The
-00023130: 2078 2d61 7869 7320 7469 6c74 2074 6f20   x-axis tilt to 
-00023140: 6170 706c 7920 2869 6e20 6465 6772 6565  apply (in degree
-00023150: 7329 2e0a 0a20 2020 2020 2020 2052 6574  s)...        Ret
-00023160: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
-00023170: 2020 4e6f 6e65 0a20 2020 2020 2020 2022    None.        "
-00023180: 2222 0a20 2020 2020 2020 2069 6620 706f  "".        if po
-00023190: 7369 7469 6f6e 2e72 2069 7320 6e6f 7420  sition.r is not 
-000231a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000231b0: 2020 726f 7461 7469 6f6e 203d 2054 7275    rotation = Tru
-000231c0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-000231d0: 2020 2020 2020 2020 2020 2020 726f 7461              rota
-000231e0: 7469 6f6e 203d 2046 616c 7365 0a20 2020  tion = False.   
-000231f0: 2020 2020 2069 6620 706f 7369 7469 6f6e       if position
-00023200: 2e74 2069 7320 6e6f 7420 4e6f 6e65 3a0a  .t is not None:.
-00023210: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
-00023220: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00023230: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00023240: 2020 7469 6c74 203d 2046 616c 7365 0a20    tilt = False. 
-00023250: 2020 2020 2020 205f 6368 6563 6b5f 7374         _check_st
-00023260: 6167 6528 7365 6c66 2e73 7973 7465 6d2c  age(self.system,
-00023270: 2072 6f74 6174 696f 6e3d 726f 7461 7469   rotation=rotati
-00023280: 6f6e 2c20 7469 6c74 3d74 696c 7429 0a20  on, tilt=tilt). 
-00023290: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-000232a0: 6e66 6f28 6622 4d6f 7669 6e67 2073 7461  nfo(f"Moving sta
-000232b0: 6765 2062 7920 7b70 6f73 6974 696f 6e7d  ge by {position}
-000232c0: 2e22 290a 2020 2020 2020 2020 2320 6375  .").        # cu
-000232d0: 7272 656e 745f 706f 7369 7469 6f6e 203d  rrent_position =
-000232e0: 2073 656c 662e 6765 745f 7374 6167 655f   self.get_stage_
-000232f0: 706f 7369 7469 6f6e 2829 0a20 2020 2020  position().     
-00023300: 2020 2023 2078 322c 7932 2c7a 3220 3d20     # x2,y2,z2 = 
-00023310: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00023320: 5374 6167 652e 4b56 462e 436f 6d70 7574  Stage.KVF.Comput
-00023330: 6528 0a20 2020 2020 2020 2023 2020 2020  e(.        #    
-00023340: 2077 643d 2073 656c 662e 6765 7428 2277   wd= self.get("w
-00023350: 6f72 6b69 6e67 5f64 6973 7461 6e63 6522  orking_distance"
-00023360: 2c20 6265 616d 5f74 7970 653d 4265 616d  , beam_type=Beam
-00023370: 5479 7065 2e45 4c45 4354 524f 4e29 2c0a  Type.ELECTRON),.
-00023380: 2020 2020 2020 2020 2320 2020 2020 7831          #     x1
-00023390: 3d20 6375 7272 656e 745f 706f 7369 7469  = current_positi
-000233a0: 6f6e 2e78 202a 2063 6f6e 7374 616e 7473  on.x * constants
-000233b0: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
-000233c0: 4554 5245 2c0a 2020 2020 2020 2020 2320  ETRE,.        # 
-000233d0: 2020 2020 7931 3d20 6375 7272 656e 745f      y1= current_
-000233e0: 706f 7369 7469 6f6e 2e79 202a 2063 6f6e  position.y * con
-000233f0: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
-00023400: 4d49 4c4c 494d 4554 5245 2c0a 2020 2020  MILLIMETRE,.    
-00023410: 2020 2020 2320 2020 2020 7a31 3d20 6375      #     z1= cu
-00023420: 7272 656e 745f 706f 7369 7469 6f6e 2e7a  rrent_position.z
-00023430: 202a 2063 6f6e 7374 616e 7473 2e4d 4554   * constants.MET
-00023440: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
-00023450: 2c0a 2020 2020 2020 2020 2320 2020 2020  ,.        #     
-00023460: 7231 3d20 6375 7272 656e 745f 706f 7369  r1= current_posi
-00023470: 7469 6f6e 2e72 202a 2063 6f6e 7374 616e  tion.r * constan
-00023480: 7473 2e52 4144 4941 4e53 5f54 4f5f 4445  ts.RADIANS_TO_DE
-00023490: 4752 4545 532c 0a20 2020 2020 2020 2023  GREES,.        #
-000234a0: 2020 2020 2074 7831 3d20 6375 7272 656e       tx1= curren
-000234b0: 745f 706f 7369 7469 6f6e 2e74 202a 2063  t_position.t * c
-000234c0: 6f6e 7374 616e 7473 2e52 4144 4941 4e53  onstants.RADIANS
-000234d0: 5f54 4f5f 4445 4752 4545 532c 0a20 2020  _TO_DEGREES,.   
-000234e0: 2020 2020 2023 2020 2020 2074 7931 203d       #     ty1 =
-000234f0: 2030 2c0a 2020 2020 2020 2020 2320 2020   0,.        #   
-00023500: 2020 7232 203d 2070 6f73 6974 696f 6e2e    r2 = position.
-00023510: 7220 2a20 636f 6e73 7461 6e74 732e 5241  r * constants.RA
-00023520: 4449 414e 535f 544f 5f44 4547 5245 4553  DIANS_TO_DEGREES
-00023530: 202b 2063 7572 7265 6e74 5f70 6f73 6974   + current_posit
-00023540: 696f 6e2e 7220 2a20 636f 6e73 7461 6e74  ion.r * constant
-00023550: 732e 5241 4449 414e 535f 544f 5f44 4547  s.RADIANS_TO_DEG
-00023560: 5245 4553 2c0a 2020 2020 2020 2020 2320  REES,.        # 
-00023570: 2020 2020 7478 3220 3d20 706f 7369 7469      tx2 = positi
-00023580: 6f6e 2e74 202a 2063 6f6e 7374 616e 7473  on.t * constants
-00023590: 2e52 4144 4941 4e53 5f54 4f5f 4445 4752  .RADIANS_TO_DEGR
-000235a0: 4545 5320 2b20 6375 7272 656e 745f 706f  EES + current_po
-000235b0: 7369 7469 6f6e 2e74 202a 2063 6f6e 7374  sition.t * const
-000235c0: 616e 7473 2e52 4144 4941 4e53 5f54 4f5f  ants.RADIANS_TO_
-000235d0: 4445 4752 4545 532c 0a20 2020 2020 2020  DEGREES,.       
-000235e0: 2023 2020 2020 2074 7932 203d 2030 2c0a   #     ty2 = 0,.
-000235f0: 2020 2020 2020 2020 2320 290a 2020 2020          # ).    
-00023600: 2020 2020 2320 7365 6c66 2e6d 6f76 655f      # self.move_
-00023610: 7374 6167 655f 6162 736f 6c75 7465 2846  stage_absolute(F
-00023620: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-00023630: 6f6e 2878 322c 7932 2c7a 3229 290a 2020  on(x2,y2,z2)).  
-00023640: 2020 2020 2020 6375 7272 656e 745f 706f        current_po
-00023650: 7369 7469 6f6e 203d 2073 656c 662e 6765  sition = self.ge
-00023660: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
-00023670: 2829 0a20 2020 2020 2020 2078 5f6d 203d  ().        x_m =
-00023680: 2063 7572 7265 6e74 5f70 6f73 6974 696f   current_positio
-00023690: 6e2e 780a 2020 2020 2020 2020 795f 6d20  n.x.        y_m 
-000236a0: 3d20 6375 7272 656e 745f 706f 7369 7469  = current_positi
-000236b0: 6f6e 2e79 0a20 2020 2020 2020 207a 5f6d  on.y.        z_m
-000236c0: 203d 2063 7572 7265 6e74 5f70 6f73 6974   = current_posit
-000236d0: 696f 6e2e 7a0a 2020 2020 2020 2020 6e65  ion.z.        ne
-000236e0: 775f 706f 7369 7469 6f6e 203d 2046 6962  w_position = Fib
-000236f0: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
-00023700: 280a 2020 2020 2020 2020 2020 2020 7820  (.            x 
-00023710: 3d20 2878 5f6d 202b 2070 6f73 6974 696f  = (x_m + positio
-00023720: 6e2e 7829 2069 6620 706f 7369 7469 6f6e  n.x) if position
-00023730: 2e78 2069 7320 6e6f 7420 4e6f 6e65 2065  .x is not None e
-00023740: 6c73 6520 785f 6d2c 0a20 2020 2020 2020  lse x_m,.       
-00023750: 2020 2020 2079 203d 2028 795f 6d20 2b20       y = (y_m + 
-00023760: 706f 7369 7469 6f6e 2e79 2029 6966 2070  position.y )if p
-00023770: 6f73 6974 696f 6e2e 7920 6973 206e 6f74  osition.y is not
-00023780: 204e 6f6e 6520 656c 7365 2079 5f6d 2c0a   None else y_m,.
-00023790: 2020 2020 2020 2020 2020 2020 7a20 3d20              z = 
-000237a0: 287a 5f6d 202b 2070 6f73 6974 696f 6e2e  (z_m + position.
-000237b0: 7a20 2969 6620 706f 7369 7469 6f6e 2e7a  z )if position.z
-000237c0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
-000237d0: 6520 7a5f 6d2c 0a20 2020 2020 2020 2020  e z_m,.         
-000237e0: 2020 2072 203d 2028 6375 7272 656e 745f     r = (current_
-000237f0: 706f 7369 7469 6f6e 2e72 202b 2070 6f73  position.r + pos
-00023800: 6974 696f 6e2e 7229 2069 6620 706f 7369  ition.r) if posi
-00023810: 7469 6f6e 2e72 2069 7320 6e6f 7420 4e6f  tion.r is not No
-00023820: 6e65 2065 6c73 6520 6375 7272 656e 745f  ne else current_
-00023830: 706f 7369 7469 6f6e 2e72 2c0a 2020 2020  position.r,.    
-00023840: 2020 2020 2020 2020 7420 3d20 2863 7572          t = (cur
-00023850: 7265 6e74 5f70 6f73 6974 696f 6e2e 7420  rent_position.t 
-00023860: 2b20 706f 7369 7469 6f6e 2e74 2920 6966  + position.t) if
-00023870: 2070 6f73 6974 696f 6e2e 7420 6973 206e   position.t is n
-00023880: 6f74 204e 6f6e 6520 656c 7365 2063 7572  ot None else cur
-00023890: 7265 6e74 5f70 6f73 6974 696f 6e2e 742c  rent_position.t,
-000238a0: 0a20 2020 2020 2020 2020 2020 2063 6f6f  .            coo
-000238b0: 7264 696e 6174 655f 7379 7374 656d 203d  rdinate_system =
-000238c0: 2020 2252 4157 222c 0a20 2020 2020 2020    "RAW",.       
-000238d0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-000238e0: 6d6f 7665 5f73 7461 6765 5f61 6273 6f6c  move_stage_absol
-000238f0: 7574 6528 6e65 775f 706f 7369 7469 6f6e  ute(new_position
-00023900: 290a 0a20 2020 2064 6566 2073 7461 626c  )..    def stabl
-00023910: 655f 6d6f 7665 280a 2020 2020 2020 2020  e_move(.        
-00023920: 7365 6c66 2c0a 2020 2020 2020 2020 6478  self,.        dx
-00023930: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
-00023940: 2064 793a 2066 6c6f 6174 2c0a 2020 2020   dy: float,.    
-00023950: 2020 2020 6265 616d 5f74 7970 653a 2042      beam_type: B
-00023960: 6561 6d54 7970 652c 0a20 2020 2020 2020  eamType,.       
-00023970: 2073 7461 7469 635f 7764 3a20 626f 6f6c   static_wd: bool
-00023980: 203d 2046 616c 7365 2c0a 2020 2020 2920   = False,.    ) 
-00023990: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-000239a0: 2022 2222 0a20 2020 2020 2020 2043 616c   """.        Cal
-000239b0: 6375 6c61 7465 2074 6865 2063 6f72 7265  culate the corre
-000239c0: 6374 6564 2073 7461 6765 206d 6f76 656d  cted stage movem
-000239d0: 656e 7473 2062 6173 6564 206f 6e20 7468  ents based on th
-000239e0: 6520 6265 616d 5f74 7970 652c 2061 6e64  e beam_type, and
-000239f0: 2074 6865 6e20 6d6f 7665 2074 6865 2073   then move the s
-00023a00: 7461 6765 2072 656c 6174 6976 656c 792e  tage relatively.
-00023a10: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
-00023a20: 2020 2020 2020 2020 2020 2020 6478 2028              dx (
-00023a30: 666c 6f61 7429 3a20 6469 7374 616e 6365  float): distance
-00023a40: 2061 6c6f 6e67 2074 6865 2078 2d61 7869   along the x-axi
-00023a50: 7320 2869 6d61 6765 2063 6f6f 7264 696e  s (image coordin
-00023a60: 6174 6573 290a 2020 2020 2020 2020 2020  ates).          
-00023a70: 2020 6479 2028 666c 6f61 7429 3a20 6469    dy (float): di
-00023a80: 7374 616e 6365 2061 6c6f 6e67 2074 6865  stance along the
-00023a90: 2079 2d61 7869 7320 2869 6d61 6765 2063   y-axis (image c
-00023aa0: 6f6f 7264 696e 6174 6573 290a 2020 2020  oordinates).    
-00023ab0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00023ac0: 5f63 6865 636b 5f73 7461 6765 2873 656c  _check_stage(sel
-00023ad0: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
-00023ae0: 2020 7764 203d 2073 656c 662e 636f 6e6e    wd = self.conn
-00023af0: 6563 7469 6f6e 2e53 454d 2e4f 7074 6963  ection.SEM.Optic
-00023b00: 732e 4765 7457 4428 290a 0a20 2020 2020  s.GetWD()..     
-00023b10: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
-00023b20: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
-00023b30: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
-00023b40: 2020 696d 6167 655f 726f 7461 7469 6f6e    image_rotation
-00023b50: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-00023b60: 6f6e 2e53 454d 2e4f 7074 6963 732e 4765  on.SEM.Optics.Ge
-00023b70: 7449 6d61 6765 526f 7461 7469 6f6e 2829  tImageRotation()
-00023b80: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00023b90: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00023ba0: 5f72 6f74 6174 696f 6e20 3d20 7365 6c66  _rotation = self
-00023bb0: 2e63 6f6e 6e65 6374 696f 6e2e 4649 422e  .connection.FIB.
-00023bc0: 4f70 7469 6373 2e47 6574 496d 6167 6552  Optics.GetImageR
-00023bd0: 6f74 6174 696f 6e28 290a 0a20 2020 2020  otation()..     
-00023be0: 2020 2069 6620 6e70 2e69 736e 616e 2869     if np.isnan(i
-00023bf0: 6d61 6765 5f72 6f74 6174 696f 6e29 3a0a  mage_rotation):.
-00023c00: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-00023c10: 655f 726f 7461 7469 6f6e 203d 2030 2e30  e_rotation = 0.0
-00023c20: 0a20 2020 2020 2020 2023 2069 6620 696d  .        # if im
-00023c30: 6167 655f 726f 7461 7469 6f6e 203d 3d20  age_rotation == 
-00023c40: 303a 0a20 2020 2020 2020 2023 2020 2020  0:.        #    
-00023c50: 2064 785f 6d6f 7665 203d 202d 6478 0a20   dx_move = -dx. 
-00023c60: 2020 2020 2020 2023 2020 2020 2064 795f         #     dy_
-00023c70: 6d6f 7665 203d 2064 790a 2020 2020 2020  move = dy.      
-00023c80: 2020 2320 656c 6966 2069 6d61 6765 5f72    # elif image_r
-00023c90: 6f74 6174 696f 6e20 3d3d 2031 3830 3a0a  otation == 180:.
-00023ca0: 2020 2020 2020 2020 2320 2020 2020 6478          #     dx
-00023cb0: 5f6d 6f76 6520 3d20 6478 0a20 2020 2020  _move = dx.     
-00023cc0: 2020 2023 2020 2020 2064 795f 6d6f 7665     #     dy_move
-00023cd0: 203d 202d 6479 0a0a 2020 2020 2020 2020   = -dy..        
-00023ce0: 6478 5f6d 6f76 6520 3d20 202d 2864 782a  dx_move =  -(dx*
-00023cf0: 6e70 2e63 6f73 2869 6d61 6765 5f72 6f74  np.cos(image_rot
-00023d00: 6174 696f 6e2a 6e70 2e70 692f 3138 3029  ation*np.pi/180)
-00023d10: 202b 2064 792a 6e70 2e73 696e 2869 6d61   + dy*np.sin(ima
-00023d20: 6765 5f72 6f74 6174 696f 6e2a 6e70 2e70  ge_rotation*np.p
-00023d30: 692f 3138 3029 290a 2020 2020 2020 2020  i/180)).        
-00023d40: 6479 5f6d 6f76 6520 3d20 2d28 6479 2a6e  dy_move = -(dy*n
-00023d50: 702e 636f 7328 696d 6167 655f 726f 7461  p.cos(image_rota
-00023d60: 7469 6f6e 2a6e 702e 7069 2f31 3830 2920  tion*np.pi/180) 
-00023d70: 2d20 6478 2a6e 702e 7369 6e28 696d 6167  - dx*np.sin(imag
-00023d80: 655f 726f 7461 7469 6f6e 2a6e 702e 7069  e_rotation*np.pi
-00023d90: 2f31 3830 2929 0a0a 2020 2020 2020 2020  /180))..        
-00023da0: 2320 6361 6c63 756c 6174 6520 7374 6167  # calculate stag
-00023db0: 6520 6d6f 7665 6d65 6e74 0a20 2020 2020  e movement.     
-00023dc0: 2020 2078 5f6d 6f76 6520 3d20 4669 6273     x_move = Fibs
-00023dd0: 656d 5374 6167 6550 6f73 6974 696f 6e28  emStagePosition(
-00023de0: 783d 6478 5f6d 6f76 652c 2079 3d30 2c20  x=dx_move, y=0, 
-00023df0: 7a3d 3029 200a 2020 2020 2020 2020 797a  z=0) .        yz
-00023e00: 5f6d 6f76 6520 3d20 7365 6c66 2e5f 795f  _move = self._y_
-00023e10: 636f 7272 6563 7465 645f 7374 6167 655f  corrected_stage_
-00023e20: 6d6f 7665 6d65 6e74 280a 2020 2020 2020  movement(.      
-00023e30: 2020 2020 2020 6578 7065 6374 6564 5f79        expected_y
-00023e40: 3d64 795f 6d6f 7665 2c0a 2020 2020 2020  =dy_move,.      
-00023e50: 2020 2020 2020 6265 616d 5f74 7970 653d        beam_type=
-00023e60: 6265 616d 5f74 7970 652c 0a20 2020 2020  beam_type,.     
-00023e70: 2020 2029 0a0a 2020 2020 2020 2020 2320     )..        # 
-00023e80: 6d6f 7665 2073 7461 6765 0a20 2020 2020  move stage.     
-00023e90: 2020 2073 7461 6765 5f70 6f73 6974 696f     stage_positio
-00023ea0: 6e20 3d20 4669 6273 656d 5374 6167 6550  n = FibsemStageP
-00023eb0: 6f73 6974 696f 6e28 0a20 2020 2020 2020  osition(.       
-00023ec0: 2020 2020 2078 3d78 5f6d 6f76 652e 782c       x=x_move.x,
-00023ed0: 2079 3d79 7a5f 6d6f 7665 2e79 2c20 7a3d   y=yz_move.y, z=
-00023ee0: 797a 5f6d 6f76 652e 7a2c 2072 3d30 2c20  yz_move.z, r=0, 
-00023ef0: 743d 300a 2020 2020 2020 2020 290a 2020  t=0.        ).  
-00023f00: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00023f10: 666f 2866 226d 6f76 696e 6720 7374 6167  fo(f"moving stag
-00023f20: 6520 287b 6265 616d 5f74 7970 652e 6e61  e ({beam_type.na
-00023f30: 6d65 7d29 3a20 7b73 7461 6765 5f70 6f73  me}): {stage_pos
-00023f40: 6974 696f 6e7d 2229 0a20 2020 2020 2020  ition}").       
-00023f50: 2073 656c 662e 6d6f 7665 5f73 7461 6765   self.move_stage
-00023f60: 5f72 656c 6174 6976 6528 7374 6167 655f  _relative(stage_
-00023f70: 706f 7369 7469 6f6e 290a 0a20 2020 2020  position)..     
-00023f80: 2020 2023 2061 646a 7573 7420 776f 726b     # adjust work
-00023f90: 696e 6720 6469 7374 616e 6365 2074 6f20  ing distance to 
-00023fa0: 636f 6d70 656e 7361 7465 2066 6f72 2073  compensate for s
-00023fb0: 7461 6765 206d 6f76 656d 656e 740a 2020  tage movement.  
-00023fc0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00023fd0: 6374 696f 6e2e 5345 4d2e 4f70 7469 6373  ction.SEM.Optics
-00023fe0: 2e53 6574 5744 2877 6429 0a20 2020 2020  .SetWD(wd).     
-00023ff0: 2020 2023 2073 656c 662e 636f 6e6e 6563     # self.connec
-00024000: 7469 6f6e 2e73 7065 6369 6d65 6e2e 7374  tion.specimen.st
-00024010: 6167 652e 6c69 6e6b 2829 2023 2054 4f44  age.link() # TOD
-00024020: 4f20 686f 7720 746f 206c 696e 6b20 666f  O how to link fo
-00024030: 7220 5445 5343 414e 3f0a 0a20 2020 2020  r TESCAN?..     
-00024040: 2020 2072 6574 7572 6e0a 0a20 2020 2064     return..    d
-00024050: 6566 2076 6572 7469 6361 6c5f 6d6f 7665  ef vertical_move
-00024060: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00024070: 2020 2020 2020 2020 6479 3a20 666c 6f61          dy: floa
-00024080: 742c 0a20 2020 2020 2020 2064 783a 2066  t,.        dx: f
-00024090: 6c6f 6174 203d 2030 2e30 2c0a 2020 2020  loat = 0.0,.    
-000240a0: 2020 2020 7374 6174 6963 5f77 643a 2062      static_wd: b
-000240b0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-000240c0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-000240d0: 2020 2022 2222 0a20 2020 2020 2020 204d     """.        M
-000240e0: 6f76 6520 7468 6520 7374 6167 6520 7665  ove the stage ve
-000240f0: 7274 6963 616c 6c79 2074 6f20 636f 7272  rtically to corr
-00024100: 6563 7420 6575 6365 6e74 7269 6320 706f  ect eucentric po
-00024110: 696e 740a 0a20 2020 2020 2020 2041 7267  int..        Arg
-00024120: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
-00024130: 7920 2866 6c6f 6174 293a 2064 6973 7461  y (float): dista
-00024140: 6e63 6520 696e 2079 2d61 7869 7320 2869  nce in y-axis (i
-00024150: 6d61 6765 2063 6f6f 7264 696e 6174 6573  mage coordinates
-00024160: 290a 2020 2020 2020 2020 2222 220a 2020  ).        """.  
-00024170: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
-00024180: 6765 2873 656c 662e 7379 7374 656d 290a  ge(self.system).
-00024190: 2020 2020 2020 2020 7764 203d 2073 656c          wd = sel
-000241a0: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
-000241b0: 2e4f 7074 6963 732e 4765 7457 4428 290a  .Optics.GetWD().
-000241c0: 2020 2020 2020 2020 696d 6167 655f 726f          image_ro
-000241d0: 7461 7469 6f6e 203d 2073 656c 662e 636f  tation = self.co
-000241e0: 6e6e 6563 7469 6f6e 2e46 4942 2e4f 7074  nnection.FIB.Opt
-000241f0: 6963 732e 4765 7449 6d61 6765 526f 7461  ics.GetImageRota
-00024200: 7469 6f6e 2829 0a20 2020 2020 2020 2020  tion().         
-00024210: 2020 200a 2020 2020 2020 2020 6966 206e     .        if n
-00024220: 702e 6973 636c 6f73 6528 696d 6167 655f  p.isclose(image_
-00024230: 726f 7461 7469 6f6e 2c20 302e 3029 3a0a  rotation, 0.0):.
-00024240: 2020 2020 2020 2020 2020 2020 6479 5f6d              dy_m
-00024250: 6f76 6520 3d20 6479 0a20 2020 2020 2020  ove = dy.       
-00024260: 2065 6c69 6620 6e70 2e69 7363 6c6f 7365   elif np.isclose
-00024270: 2869 6d61 6765 5f72 6f74 6174 696f 6e2c  (image_rotation,
-00024280: 2031 3830 293a 0a20 2020 2020 2020 2020   180):.         
-00024290: 2020 2064 795f 6d6f 7665 203d 202d 6479     dy_move = -dy
-000242a0: 0a0a 0a20 2020 2020 2020 2020 2020 200a  ...            .
-000242b0: 2020 2020 2020 2020 5052 4554 494c 545f          PRETILT_
-000242c0: 5349 474e 203d 2031 2e30 0a20 2020 2020  SIGN = 1.0.     
-000242d0: 2020 2066 726f 6d20 6669 6273 656d 2069     from fibsem i
-000242e0: 6d70 6f72 7420 6d6f 7665 6d65 6e74 0a20  mport movement. 
-000242f0: 2020 2020 2020 2023 2063 7572 7265 6e74         # current
-00024300: 2073 7461 6765 2070 6f73 6974 696f 6e0a   stage position.
-00024310: 2020 2020 2020 2020 6375 7272 656e 745f          current_
-00024320: 7374 6167 655f 706f 7369 7469 6f6e 203d  stage_position =
-00024330: 2073 656c 662e 6765 745f 7374 6167 655f   self.get_stage_
-00024340: 706f 7369 7469 6f6e 2829 0a20 2020 2020  position().     
-00024350: 2020 2073 7461 6765 5f72 6f74 6174 696f     stage_rotatio
-00024360: 6e20 3d20 6375 7272 656e 745f 7374 6167  n = current_stag
-00024370: 655f 706f 7369 7469 6f6e 2e72 2025 2028  e_position.r % (
-00024380: 3220 2a20 6e70 2e70 6929 0a20 2020 2020  2 * np.pi).     
-00024390: 2020 2073 7461 6765 5f74 696c 7420 3d20     stage_tilt = 
-000243a0: 6375 7272 656e 745f 7374 6167 655f 706f  current_stage_po
-000243b0: 7369 7469 6f6e 2e74 0a20 2020 2020 2020  sition.t.       
-000243c0: 2073 7461 6765 5f74 696c 745f 666c 6174   stage_tilt_flat
-000243d0: 5f74 6f5f 656c 6563 7472 6f6e 203d 206e  _to_electron = n
-000243e0: 702e 6465 6732 7261 6428 7365 6c66 2e73  p.deg2rad(self.s
-000243f0: 7973 7465 6d2e 656c 6563 7472 6f6e 2e63  ystem.electron.c
-00024400: 6f6c 756d 6e5f 7469 6c74 290a 2020 2020  olumn_tilt).    
-00024410: 2020 2020 7374 6167 655f 7469 6c74 5f66      stage_tilt_f
-00024420: 6c61 745f 746f 5f69 6f6e 203d 206e 702e  lat_to_ion = np.
-00024430: 6465 6732 7261 6428 7365 6c66 2e73 7973  deg2rad(self.sys
-00024440: 7465 6d2e 696f 6e2e 636f 6c75 6d6e 5f74  tem.ion.column_t
-00024450: 696c 7429 0a0a 2020 2020 2020 2020 7374  ilt)..        st
-00024460: 6167 655f 726f 7461 7469 6f6e 5f66 6c61  age_rotation_fla
-00024470: 745f 746f 5f69 6f6e 203d 206e 702e 6465  t_to_ion = np.de
-00024480: 6732 7261 6428 0a20 2020 2020 2020 2020  g2rad(.         
-00024490: 2020 2073 656c 662e 7379 7374 656d 2e73     self.system.s
-000244a0: 7461 6765 2e72 6f74 6174 696f 6e5f 3138  tage.rotation_18
-000244b0: 300a 2020 2020 2020 2020 2920 2520 2832  0.        ) % (2
-000244c0: 202a 206e 702e 7069 290a 0a20 2020 2020   * np.pi)..     
-000244d0: 2020 2069 6620 6d6f 7665 6d65 6e74 2e72     if movement.r
-000244e0: 6f74 6174 696f 6e5f 616e 676c 655f 6973  otation_angle_is
-000244f0: 5f73 6d61 6c6c 6572 280a 2020 2020 2020  _smaller(.      
-00024500: 2020 2020 2020 7374 6167 655f 726f 7461        stage_rota
-00024510: 7469 6f6e 2c20 7374 6167 655f 726f 7461  tion, stage_rota
-00024520: 7469 6f6e 5f66 6c61 745f 746f 5f69 6f6e  tion_flat_to_ion
-00024530: 2c20 6174 6f6c 3d35 0a20 2020 2020 2020  , atol=5.       
-00024540: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00024550: 5052 4554 494c 545f 5349 474e 203d 202d  PRETILT_SIGN = -
-00024560: 312e 300a 0a20 2020 2020 2020 2023 2054  1.0..        # T
-00024570: 4f44 4f3a 2063 6865 636b 2074 6869 7320  ODO: check this 
-00024580: 7072 652d 7469 6c74 2061 6e67 6c65 2063  pre-tilt angle c
-00024590: 616c 6375 6c61 7469 6f6e 0a20 2020 2020  alculation.     
-000245a0: 2020 2063 6f72 7265 6374 6564 5f70 7265     corrected_pre
-000245b0: 7469 6c74 5f61 6e67 6c65 203d 2050 5245  tilt_angle = PRE
-000245c0: 5449 4c54 5f53 4947 4e20 2a20 2873 7461  TILT_SIGN * (sta
-000245d0: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
-000245e0: 656c 6563 7472 6f6e 202d 2073 656c 662e  electron - self.
-000245f0: 7379 7374 656d 2e73 7461 6765 2e73 6875  system.stage.shu
-00024600: 7474 6c65 5f70 7265 5f74 696c 742a 636f  ttle_pre_tilt*co
-00024610: 6e73 7461 6e74 732e 4445 4752 4545 535f  nstants.DEGREES_
-00024620: 544f 5f52 4144 4941 4e53 290a 2020 2020  TO_RADIANS).    
-00024630: 2020 2020 7065 7273 7065 6374 6976 655f      perspective_
-00024640: 7469 6c74 203d 2028 2d20 636f 7272 6563  tilt = (- correc
-00024650: 7465 645f 7072 6574 696c 745f 616e 676c  ted_pretilt_angl
-00024660: 6520 2d20 7374 6167 655f 7469 6c74 5f66  e - stage_tilt_f
-00024670: 6c61 745f 746f 5f69 6f6e 290a 2020 2020  lat_to_ion).    
-00024680: 2020 2020 7a5f 7065 7273 7065 6374 6976      z_perspectiv
-00024690: 6520 3d20 2d20 6479 5f6d 6f76 652f 6e70  e = - dy_move/np
-000246a0: 2e63 6f73 2828 7374 6167 655f 7469 6c74  .cos((stage_tilt
-000246b0: 202b 2063 6f72 7265 6374 6564 5f70 7265   + corrected_pre
-000246c0: 7469 6c74 5f61 6e67 6c65 202b 2070 6572  tilt_angle + per
-000246d0: 7370 6563 7469 7665 5f74 696c 7429 290a  spective_tilt)).
-000246e0: 2020 2020 2020 2020 7a5f 6d6f 7665 203d          z_move =
-000246f0: 207a 5f70 6572 7370 6563 7469 7665 2a6e   z_perspective*n
-00024700: 702e 7369 6e28 3930 2a63 6f6e 7374 616e  p.sin(90*constan
-00024710: 7473 2e44 4547 5245 4553 5f54 4f5f 5241  ts.DEGREES_TO_RA
-00024720: 4449 414e 5320 2d20 7374 6167 655f 7469  DIANS - stage_ti
-00024730: 6c74 5f66 6c61 745f 746f 5f69 6f6e 2920  lt_flat_to_ion) 
-00024740: 0a20 2020 2020 2020 2023 207a 5f6d 6f76  .        # z_mov
-00024750: 6520 3d20 6479 202f 206e 702e 636f 7328  e = dy / np.cos(
-00024760: 0a20 2020 2020 2020 2023 2020 2020 206e  .        #     n
-00024770: 702e 6465 6732 7261 6428 3930 202d 2073  p.deg2rad(90 - s
-00024780: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
-00024790: 6f5f 696f 6e20 2b20 7373 656c 662e 7379  o_ion + sself.sy
-000247a0: 7374 656d 2e73 7461 6765 2e73 6875 7474  stem.stage.shutt
-000247b0: 6c65 5f70 7265 5f74 696c 7429 0a20 2020  le_pre_tilt).   
-000247c0: 2020 2020 2023 2029 2020 2320 544f 444f       # )  # TODO
-000247d0: 3a20 4d41 4749 4320 4e55 4d42 4552 2c20  : MAGIC NUMBER, 
-000247e0: 3930 202d 2066 6962 2074 696c 740a 2020  90 - fib tilt.  
-000247f0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00024800: 666f 2866 2265 7563 656e 7472 6963 206d  fo(f"eucentric m
-00024810: 6f76 656d 656e 743a 207b 7a5f 6d6f 7665  ovement: {z_move
-00024820: 7d22 290a 2020 2020 2020 2020 7a5f 6d6f  }").        z_mo
-00024830: 7665 203d 2046 6962 7365 6d53 7461 6765  ve = FibsemStage
-00024840: 506f 7369 7469 6f6e 2878 3d64 782c 2079  Position(x=dx, y
-00024850: 3d30 2c20 7a3d 7a5f 6d6f 7665 2c20 723d  =0, z=z_move, r=
-00024860: 302c 2074 3d30 290a 2020 2020 2020 2020  0, t=0).        
-00024870: 7365 6c66 2e6d 6f76 655f 7374 6167 655f  self.move_stage_
-00024880: 7265 6c61 7469 7665 287a 5f6d 6f76 6529  relative(z_move)
-00024890: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-000248a0: 6f6e 6e65 6374 696f 6e2e 5345 4d2e 4f70  onnection.SEM.Op
-000248b0: 7469 6373 2e53 6574 5744 2877 6429 0a0a  tics.SetWD(wd)..
-000248c0: 2020 2020 6465 6620 5f79 5f63 6f72 7265      def _y_corre
-000248d0: 6374 6564 5f73 7461 6765 5f6d 6f76 656d  cted_stage_movem
-000248e0: 656e 7428 0a20 2020 2020 2020 2073 656c  ent(.        sel
-000248f0: 662c 0a20 2020 2020 2020 2065 7870 6563  f,.        expec
-00024900: 7465 645f 793a 2066 6c6f 6174 2c0a 2020  ted_y: float,.  
-00024910: 2020 2020 2020 6265 616d 5f74 7970 653a        beam_type:
-00024920: 2042 6561 6d54 7970 6520 3d20 4265 616d   BeamType = Beam
-00024930: 5479 7065 2e45 4c45 4354 524f 4e2c 0a20  Type.ELECTRON,. 
-00024940: 2020 2029 202d 3e20 4669 6273 656d 5374     ) -> FibsemSt
-00024950: 6167 6550 6f73 6974 696f 6e3a 0a20 2020  agePosition:.   
-00024960: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00024970: 2043 616c 6375 6c61 7465 2074 6865 2079   Calculate the y
-00024980: 2063 6f72 7265 6374 6564 2073 7461 6765   corrected stage
-00024990: 206d 6f76 656d 656e 742c 2063 6f72 7265   movement, corre
-000249a0: 6374 6564 2066 6f72 2074 6865 2061 6464  cted for the add
-000249b0: 6974 696f 6e61 6c20 7469 6c74 206f 6620  itional tilt of 
-000249c0: 7468 6520 7361 6d70 6c65 2068 6f6c 6465  the sample holde
-000249d0: 7220 2870 7265 2d74 696c 7420 616e 676c  r (pre-tilt angl
-000249e0: 6529 2e0a 0a20 2020 2020 2020 2041 7267  e)...        Arg
-000249f0: 733a 0a20 2020 2020 2020 2020 2020 2065  s:.            e
-00024a00: 7870 6563 7465 645f 7920 2866 6c6f 6174  xpected_y (float
-00024a10: 2c20 6f70 7469 6f6e 616c 293a 2064 6973  , optional): dis
-00024a20: 7461 6e63 6520 616c 6f6e 6720 792d 6178  tance along y-ax
-00024a30: 6973 2e0a 2020 2020 2020 2020 2020 2020  is..            
-00024a40: 6265 616d 5f74 7970 6520 2842 6561 6d54  beam_type (BeamT
-00024a50: 7970 652c 206f 7074 696f 6e61 6c29 3a20  ype, optional): 
-00024a60: 6265 616d 5f74 7970 6520 746f 206d 6f76  beam_type to mov
-00024a70: 6520 696e 2e20 4465 6661 756c 7473 2074  e in. Defaults t
-00024a80: 6f20 4265 616d 5479 7065 2e45 4c45 4354  o BeamType.ELECT
-00024a90: 524f 4e2e 0a0a 2020 2020 2020 2020 5265  RON...        Re
-00024aa0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-00024ab0: 2020 2053 7461 6765 506f 7369 7469 6f6e     StagePosition
-00024ac0: 3a20 7920 636f 7272 6563 7465 6420 7374  : y corrected st
-00024ad0: 6167 6520 6d6f 7665 6d65 6e74 2028 7265  age movement (re
-00024ae0: 6c61 7469 7665 2070 6f73 6974 696f 6e29  lative position)
-00024af0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00024b00: 2020 2020 2020 2320 544f 444f 3a20 7265        # TODO: re
-00024b10: 706c 6163 6520 7769 7468 2063 616d 6572  place with camer
-00024b20: 6120 6d61 7472 6978 202a 2069 6e76 6572  a matrix * inver
-00024b30: 7365 206b 696e 656d 6174 6963 730a 2020  se kinematics.  
-00024b40: 2020 2020 2020 2320 544f 444f 3a20 7265        # TODO: re
-00024b50: 706c 6163 6520 7374 6167 655f 7469 6c74  place stage_tilt
-00024b60: 5f66 6c61 745f 746f 5f65 6c65 6374 726f  _flat_to_electro
-00024b70: 6e20 7769 7468 2070 7265 2d74 696c 740a  n with pre-tilt.
-00024b80: 0a20 2020 2020 2020 2023 2061 6c6c 2061  .        # all a
-00024b90: 6e67 6c65 7320 696e 2072 6164 6961 6e73  ngles in radians
-00024ba0: 0a20 2020 2020 2020 2073 7461 6765 5f74  .        stage_t
-00024bb0: 696c 745f 666c 6174 5f74 6f5f 656c 6563  ilt_flat_to_elec
-00024bc0: 7472 6f6e 203d 206e 702e 6465 6732 7261  tron = np.deg2ra
-00024bd0: 6428 7365 6c66 2e73 7973 7465 6d2e 656c  d(self.system.el
-00024be0: 6563 7472 6f6e 2e63 6f6c 756d 6e5f 7469  ectron.column_ti
-00024bf0: 6c74 290a 2020 2020 2020 2020 7374 6167  lt).        stag
-00024c00: 655f 7469 6c74 5f66 6c61 745f 746f 5f69  e_tilt_flat_to_i
-00024c10: 6f6e 203d 206e 702e 6465 6732 7261 6428  on = np.deg2rad(
-00024c20: 7365 6c66 2e73 7973 7465 6d2e 696f 6e2e  self.system.ion.
-00024c30: 636f 6c75 6d6e 5f74 696c 7429 0a0a 2020  column_tilt)..  
-00024c40: 2020 2020 2020 7374 6167 655f 726f 7461        stage_rota
-00024c50: 7469 6f6e 5f66 6c61 745f 746f 5f69 6f6e  tion_flat_to_ion
-00024c60: 203d 206e 702e 6465 6732 7261 6428 0a20   = np.deg2rad(. 
-00024c70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00024c80: 7379 7374 656d 2e73 7461 6765 2e72 6f74  system.stage.rot
-00024c90: 6174 696f 6e5f 3138 300a 2020 2020 2020  ation_180.      
-00024ca0: 2020 2920 2520 2832 202a 206e 702e 7069    ) % (2 * np.pi
-00024cb0: 290a 0a20 2020 2020 2020 2023 2063 7572  )..        # cur
-00024cc0: 7265 6e74 2073 7461 6765 2070 6f73 6974  rent stage posit
-00024cd0: 696f 6e0a 2020 2020 2020 2020 6375 7272  ion.        curr
-00024ce0: 656e 745f 7374 6167 655f 706f 7369 7469  ent_stage_positi
-00024cf0: 6f6e 203d 2073 656c 662e 6765 745f 7374  on = self.get_st
-00024d00: 6167 655f 706f 7369 7469 6f6e 2829 0a20  age_position(). 
-00024d10: 2020 2020 2020 2073 7461 6765 5f72 6f74         stage_rot
-00024d20: 6174 696f 6e20 3d20 6375 7272 656e 745f  ation = current_
-00024d30: 7374 6167 655f 706f 7369 7469 6f6e 2e72  stage_position.r
-00024d40: 2025 2028 3220 2a20 6e70 2e70 6929 0a20   % (2 * np.pi). 
-00024d50: 2020 2020 2020 2073 7461 6765 5f74 696c         stage_til
-00024d60: 7420 3d20 6375 7272 656e 745f 7374 6167  t = current_stag
-00024d70: 655f 706f 7369 7469 6f6e 2e74 0a0a 2020  e_position.t..  
-00024d80: 2020 2020 2020 5052 4554 494c 545f 5349        PRETILT_SI
-00024d90: 474e 203d 2031 2e30 0a20 2020 2020 2020  GN = 1.0.       
-00024da0: 2066 726f 6d20 6669 6273 656d 2069 6d70   from fibsem imp
-00024db0: 6f72 7420 6d6f 7665 6d65 6e74 0a0a 2020  ort movement..  
-00024dc0: 2020 2020 2020 6966 206d 6f76 656d 656e        if movemen
-00024dd0: 742e 726f 7461 7469 6f6e 5f61 6e67 6c65  t.rotation_angle
-00024de0: 5f69 735f 736d 616c 6c65 7228 0a20 2020  _is_smaller(.   
-00024df0: 2020 2020 2020 2020 2073 7461 6765 5f72           stage_r
-00024e00: 6f74 6174 696f 6e2c 2073 7461 6765 5f72  otation, stage_r
-00024e10: 6f74 6174 696f 6e5f 666c 6174 5f74 6f5f  otation_flat_to_
-00024e20: 696f 6e2c 2061 746f 6c3d 350a 2020 2020  ion, atol=5.    
-00024e30: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00024e40: 2020 2050 5245 5449 4c54 5f53 4947 4e20     PRETILT_SIGN 
-00024e50: 3d20 2d31 2e30 0a0a 2020 2020 2020 2020  = -1.0..        
-00024e60: 636f 7272 6563 7465 645f 7072 6574 696c  corrected_pretil
-00024e70: 745f 616e 676c 6520 3d20 5052 4554 494c  t_angle = PRETIL
-00024e80: 545f 5349 474e 202a 2028 7374 6167 655f  T_SIGN * (stage_
-00024e90: 7469 6c74 5f66 6c61 745f 746f 5f65 6c65  tilt_flat_to_ele
-00024ea0: 6374 726f 6e20 2d20 7365 6c66 2e73 7973  ctron - self.sys
-00024eb0: 7465 6d2e 7374 6167 652e 7368 7574 746c  tem.stage.shuttl
-00024ec0: 655f 7072 655f 7469 6c74 2a63 6f6e 7374  e_pre_tilt*const
-00024ed0: 616e 7473 2e44 4547 5245 4553 5f54 4f5f  ants.DEGREES_TO_
-00024ee0: 5241 4449 414e 5329 0a20 2020 2020 2020  RADIANS).       
-00024ef0: 200a 2020 2020 2020 2020 7065 7273 7065   .        perspe
-00024f00: 6374 6976 655f 7469 6c74 203d 202d 2063  ctive_tilt = - c
-00024f10: 6f72 7265 6374 6564 5f70 7265 7469 6c74  orrected_pretilt
-00024f20: 5f61 6e67 6c65 2069 6620 6265 616d 5f74  _angle if beam_t
-00024f30: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00024f40: 454c 4543 5452 4f4e 2065 6c73 6520 282d  ELECTRON else (-
-00024f50: 2063 6f72 7265 6374 6564 5f70 7265 7469   corrected_preti
-00024f60: 6c74 5f61 6e67 6c65 202d 2073 7461 6765  lt_angle - stage
-00024f70: 5f74 696c 745f 666c 6174 5f74 6f5f 696f  _tilt_flat_to_io
-00024f80: 6e29 0a0a 2020 2020 2020 2020 795f 6d6f  n)..        y_mo
-00024f90: 7665 203d 2065 7870 6563 7465 645f 792f  ve = expected_y/
-00024fa0: 6e70 2e63 6f73 2828 7374 6167 655f 7469  np.cos((stage_ti
-00024fb0: 6c74 202b 2063 6f72 7265 6374 6564 5f70  lt + corrected_p
-00024fc0: 7265 7469 6c74 5f61 6e67 6c65 202b 2070  retilt_angle + p
-00024fd0: 6572 7370 6563 7469 7665 5f74 696c 7429  erspective_tilt)
-00024fe0: 290a 2020 2020 2020 2020 200a 2020 2020  ).         .    
-00024ff0: 2020 2020 7a5f 6d6f 7665 203d 2079 5f6d      z_move = y_m
-00025000: 6f76 652a 6e70 2e73 696e 2828 636f 7272  ove*np.sin((corr
-00025010: 6563 7465 645f 7072 6574 696c 745f 616e  ected_pretilt_an
-00025020: 676c 6529 2920 0a20 2020 2020 2020 2070  gle)) .        p
-00025030: 7269 6e74 2866 2753 7461 6765 2074 696c  rint(f'Stage til
-00025040: 743a 207b 7374 6167 655f 7469 6c74 7d2c  t: {stage_tilt},
-00025050: 2063 6f72 7265 6374 6564 2070 7265 7469   corrected preti
-00025060: 6c74 3a20 7b63 6f72 7265 6374 6564 5f70  lt: {corrected_p
-00025070: 7265 7469 6c74 5f61 6e67 6c65 7d2c 2079  retilt_angle}, y
-00025080: 5f6d 6f76 653a 207b 795f 6d6f 7665 7d20  _move: {y_move} 
-00025090: 7a5f 6d6f 7665 3a20 7b7a 5f6d 6f76 657d  z_move: {z_move}
-000250a0: 2729 0a0a 2020 2020 2020 2020 7265 7475  ')..        retu
-000250b0: 726e 2046 6962 7365 6d53 7461 6765 506f  rn FibsemStagePo
-000250c0: 7369 7469 6f6e 2878 3d30 2c20 793d 795f  sition(x=0, y=y_
-000250d0: 6d6f 7665 2c20 7a3d 7a5f 6d6f 7665 290a  move, z=z_move).
-000250e0: 0a20 2020 2064 6566 206d 6f76 655f 666c  .    def move_fl
-000250f0: 6174 5f74 6f5f 6265 616d 280a 2020 2020  at_to_beam(.    
-00025100: 2020 2020 7365 6c66 2c20 6265 616d 5f74      self, beam_t
-00025110: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
-00025120: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-00025130: 4e2c 205f 7361 6665 3a20 626f 6f6c 203d  N, _safe: bool =
-00025140: 2054 7275 650a 2020 2020 293a 0a20 2020   True.    ):.   
-00025150: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00025160: 204d 6f76 6573 2074 6865 206d 6963 726f   Moves the micro
-00025170: 7363 6f70 6520 7374 6167 6520 746f 2074  scope stage to t
-00025180: 6865 2074 696c 7420 616e 676c 6520 636f  he tilt angle co
-00025190: 7272 6573 706f 6e64 696e 6720 746f 2074  rresponding to t
-000251a0: 6865 2067 6976 656e 2062 6561 6d20 7479  he given beam ty
-000251b0: 7065 2c0a 2020 2020 2020 2020 736f 2074  pe,.        so t
-000251c0: 6861 7420 7468 6520 7374 6167 6520 6973  hat the stage is
-000251d0: 2066 6c61 7420 7769 7468 2072 6573 7065   flat with respe
-000251e0: 6374 2074 6f20 7468 6520 6265 616d 2e0a  ct to the beam..
-000251f0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00025200: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-00025210: 7479 7065 2028 4265 616d 5479 7065 293a  type (BeamType):
-00025220: 2054 6865 2074 7970 6520 6f66 2062 6561   The type of bea
-00025230: 6d20 746f 2077 6869 6368 2074 6865 2073  m to which the s
-00025240: 7461 6765 2073 686f 756c 6420 6265 206d  tage should be m
-00025250: 6164 6520 666c 6174 2e0a 2020 2020 2020  ade flat..      
-00025260: 2020 2020 2020 2020 2020 4d75 7374 2062            Must b
-00025270: 6520 6f6e 6520 6f66 2042 6561 6d54 7970  e one of BeamTyp
-00025280: 652e 454c 4543 5452 4f4e 206f 7220 4265  e.ELECTRON or Be
-00025290: 616d 5479 7065 2e49 4f4e 2e0a 0a20 2020  amType.ION...   
-000252a0: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-000252b0: 2020 2020 2020 2020 2020 4e6f 6e65 2e0a            None..
-000252c0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000252d0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-000252e0: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-000252f0: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
-00025300: 2320 4255 4720 6966 2049 2073 6574 206f  # BUG if I set o
-00025310: 7220 7061 7373 2042 6561 6d54 7970 652e  r pass BeamType.
-00025320: 494f 4e20 6974 2073 7469 6c6c 2073 6565  ION it still see
-00025330: 7320 6265 616d 5f74 7970 6520 6173 2042  s beam_type as B
-00025340: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-00025350: 0a20 2020 200a 2020 2020 2020 2020 6966  .    .        if
-00025360: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
-00025370: 616d 5479 7065 2e49 4f4e 3a0a 2020 2020  amType.ION:.    
-00025380: 2020 2020 2020 2020 7469 6c74 203d 2073          tilt = s
-00025390: 656c 662e 7379 7374 656d 2e69 6f6e 2e63  elf.system.ion.c
-000253a0: 6f6c 756d 6e5f 7469 6c74 0a20 2020 2020  olumn_tilt.     
-000253b0: 2020 2065 6c69 6620 6265 616d 5f74 7970     elif beam_typ
-000253c0: 6520 6973 2042 6561 6d54 7970 652e 454c  e is BeamType.EL
-000253d0: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
-000253e0: 2020 2020 7469 6c74 203d 2073 656c 662e      tilt = self.
-000253f0: 7379 7374 656d 2e65 6c65 6374 726f 6e2e  system.electron.
-00025400: 636f 6c75 6d6e 5f74 696c 7420 0a20 2020  column_tilt .   
-00025410: 2020 2020 2023 544f 444f 3a20 6e6f 2070       #TODO: no p
-00025420: 7265 2d74 696c 7420 6669 7820 7468 6973  re-tilt fix this
-00025430: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
-00025440: 672e 696e 666f 2866 224d 6f76 696e 6720  g.info(f"Moving 
-00025450: 5374 6167 6520 466c 6174 2074 6f20 7b62  Stage Flat to {b
-00025460: 6561 6d5f 7479 7065 2e6e 616d 657d 2042  eam_type.name} B
-00025470: 6561 6d22 290a 2020 2020 2020 2020 7365  eam").        se
-00025480: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5374  lf.connection.St
-00025490: 6167 652e 4d6f 7665 546f 2874 696c 7478  age.MoveTo(tiltx
-000254a0: 3d74 696c 7429 0a0a 0a20 2020 2064 6566  =tilt)...    def
-000254b0: 2067 6574 5f6d 616e 6970 756c 6174 6f72   get_manipulator
-000254c0: 5f73 7461 7465 2873 656c 6629 202d 3e20  _state(self) -> 
-000254d0: 626f 6f6c 3a0a 0a20 2020 2020 2020 2022  bool:..        "
-000254e0: 2222 7265 7475 726e 7320 7472 7565 2069  ""returns true i
-000254f0: 6620 6e61 6e6f 6d61 6e69 7075 6c61 746f  f nanomanipulato
-00025500: 7220 6973 2069 6e73 6572 7465 642e 204d  r is inserted. M
-00025510: 616e 6970 756c 6174 6f72 2070 6f73 6974  anipulator posit
-00025520: 696f 6e73 206d 7573 7420 6265 2063 616c  ions must be cal
-00025530: 6962 7261 7465 6420 616e 6420 7374 6f72  ibrated and stor
-00025540: 6564 2069 6e20 7379 7374 656d 2e79 616d  ed in system.yam
-00025550: 6c20 6669 6c65 2069 6620 6e6f 7420 646f  l file if not do
-00025560: 6e65 2073 6f0a 0a20 2020 2020 2020 2052  ne so..        R
-00025570: 6169 7365 733a 0a20 2020 2020 2020 2020  aises:.         
-00025580: 2020 2056 616c 7565 4572 726f 723a 205f     ValueError: _
-00025590: 6465 7363 7269 7074 696f 6e5f 0a0a 2020  description_..  
-000255a0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-000255b0: 2020 2020 2020 2020 2020 205f 7479 7065             _type
-000255c0: 5f3a 2054 7275 6520 6966 2049 6e73 6572  _: True if Inser
-000255d0: 7465 642c 2046 616c 7365 2069 6620 7265  ted, False if re
-000255e0: 7472 6163 7465 640a 2020 2020 2020 2020  tracted.        
-000255f0: 2222 220a 0a20 2020 2020 2020 206d 616e  """..        man
-00025600: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
-00025610: 6e73 203d 2063 6667 2e6c 6f61 645f 7465  ns = cfg.load_te
-00025620: 7363 616e 5f6d 616e 6970 756c 6174 6f72  scan_manipulator
-00025630: 5f63 616c 6962 7261 7469 6f6e 2829 0a0a  _calibration()..
-00025640: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
-00025650: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
-00025660: 696f 6e73 5b22 6361 6c69 6272 6174 6564  ions["calibrated
-00025670: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-00025680: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
-00025690: 224d 616e 6970 756c 6174 6f72 2070 6f73  "Manipulator pos
-000256a0: 6974 696f 6e73 206e 6f74 2063 616c 6962  itions not calib
-000256b0: 7261 7465 642c 2063 616e 6e6f 7420 6765  rated, cannot ge
-000256c0: 7420 7374 6174 6522 290a 2020 2020 2020  t state").      
-000256d0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-000256e0: 7365 0a0a 2020 2020 2020 2020 7265 7472  se..        retr
-000256f0: 6163 7465 645f 706f 7369 7469 6f6e 5f78  acted_position_x
-00025700: 203d 206d 616e 6970 756c 6174 6f72 5f70   = manipulator_p
-00025710: 6f73 6974 696f 6e73 5b22 7061 726b 696e  ositions["parkin
-00025720: 6722 5d5b 2278 225d 2a63 6f6e 7374 616e  g"]["x"]*constan
-00025730: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
-00025740: 494d 4554 5245 0a20 2020 2020 2020 2072  IMETRE.        r
-00025750: 6574 7261 6374 6564 5f70 6f73 6974 696f  etracted_positio
-00025760: 6e5f 7920 3d20 6d61 6e69 7075 6c61 746f  n_y = manipulato
-00025770: 725f 706f 7369 7469 6f6e 735b 2270 6172  r_positions["par
-00025780: 6b69 6e67 225d 5b22 7922 5d2a 636f 6e73  king"]["y"]*cons
-00025790: 7461 6e74 732e 4d45 5452 455f 544f 5f4d  tants.METRE_TO_M
-000257a0: 494c 4c49 4d45 5452 450a 2020 2020 2020  ILLIMETRE.      
-000257b0: 2020 7265 7472 6163 7465 645f 706f 7369    retracted_posi
-000257c0: 7469 6f6e 5f7a 203d 206d 616e 6970 756c  tion_z = manipul
-000257d0: 6174 6f72 5f70 6f73 6974 696f 6e73 5b22  ator_positions["
-000257e0: 7061 726b 696e 6722 5d5b 227a 225d 2a63  parking"]["z"]*c
-000257f0: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-00025800: 4f5f 4d49 4c4c 494d 4554 5245 0a0a 2020  O_MILLIMETRE..  
-00025810: 2020 2020 2020 6375 7272 656e 745f 706f        current_po
-00025820: 7369 7469 6f6e 203d 2073 656c 662e 6765  sition = self.ge
-00025830: 745f 6d61 6e69 7075 6c61 746f 725f 706f  t_manipulator_po
-00025840: 7369 7469 6f6e 2829 0a0a 2020 2020 2020  sition()..      
-00025850: 2020 6375 7272 656e 745f 706f 7369 7469    current_positi
-00025860: 6f6e 5f61 7272 6179 203d 205b 6375 7272  on_array = [curr
-00025870: 656e 745f 706f 7369 7469 6f6e 2e78 2a63  ent_position.x*c
-00025880: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-00025890: 4f5f 4d49 4c4c 494d 4554 5245 2c20 6375  O_MILLIMETRE, cu
-000258a0: 7272 656e 745f 706f 7369 7469 6f6e 2e79  rrent_position.y
-000258b0: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
-000258c0: 5f54 4f5f 4d49 4c4c 494d 4554 5245 2c20  _TO_MILLIMETRE, 
-000258d0: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
-000258e0: 2e7a 2a63 6f6e 7374 616e 7473 2e4d 4554  .z*constants.MET
-000258f0: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
-00025900: 5d0a 0a20 2020 2020 2020 2063 6865 636b  ]..        check
-00025910: 5f63 6f6d 7061 7265 203d 206e 702e 6973  _compare = np.is
-00025920: 636c 6f73 6528 6375 7272 656e 745f 706f  close(current_po
-00025930: 7369 7469 6f6e 5f61 7272 6179 2c20 5b72  sition_array, [r
-00025940: 6574 7261 6374 6564 5f70 6f73 6974 696f  etracted_positio
-00025950: 6e5f 782c 2072 6574 7261 6374 6564 5f70  n_x, retracted_p
-00025960: 6f73 6974 696f 6e5f 792c 2072 6574 7261  osition_y, retra
-00025970: 6374 6564 5f70 6f73 6974 696f 6e5f 7a5d  cted_position_z]
-00025980: 2c20 6174 6f6c 3d30 2e31 290a 0a20 2020  , atol=0.1)..   
-00025990: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-000259a0: 2069 6620 4661 6c73 6520 696e 2063 6865   if False in che
-000259b0: 636b 5f63 6f6d 7061 7265 2065 6c73 6520  ck_compare else 
-000259c0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-000259d0: 2020 0a0a 2020 2020 6465 6620 6765 745f    ..    def get_
-000259e0: 6d61 6e69 7075 6c61 746f 725f 706f 7369  manipulator_posi
-000259f0: 7469 6f6e 2873 656c 6629 202d 3e20 4669  tion(self) -> Fi
-00025a00: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-00025a10: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
-00025a20: 2023 2070 6173 730a 2020 2020 2020 2020   # pass.        
-00025a30: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
-00025a40: 6f72 2873 656c 662e 7379 7374 656d 290a  or(self.system).
-00025a50: 2020 2020 2020 2020 696e 6465 7820 3d20          index = 
-00025a60: 300a 2020 2020 2020 2020 6f75 7470 7574  0.        output
-00025a70: 5f70 6f73 6974 696f 6e20 3d20 7365 6c66  _position = self
-00025a80: 2e63 6f6e 6e65 6374 696f 6e2e 4e61 6e6f  .connection.Nano
-00025a90: 6d61 6e69 7075 6c61 746f 722e 4765 7450  manipulator.GetP
-00025aa0: 6f73 6974 696f 6e28 496e 6465 783d 696e  osition(Index=in
-00025ab0: 6465 7829 0a0a 2020 2020 2020 2020 2320  dex)..        # 
-00025ac0: 4765 7450 6f73 6974 696f 6e20 7265 7475  GetPosition retu
-00025ad0: 726e 7320 7475 706c 6520 696e 2074 6865  rns tuple in the
-00025ae0: 2066 6f72 6d20 2878 2c20 792c 207a 2c20   form (x, y, z, 
-00025af0: 7229 0a20 2020 2020 2020 2023 2078 2c79  r).        # x,y
-00025b00: 2c7a 2069 6e20 6d6d 2061 6e64 2072 2069  ,z in mm and r i
-00025b10: 6e20 6465 6772 6565 732c 206e 6f20 7469  n degrees, no ti
-00025b20: 6c74 2069 6e66 6f72 6d61 7469 6f6e 0a0a  lt information..
-00025b30: 2020 2020 2020 2020 7820 3d20 6f75 7470          x = outp
-00025b40: 7574 5f70 6f73 6974 696f 6e5b 305d 2a63  ut_position[0]*c
-00025b50: 6f6e 7374 616e 7473 2e4d 494c 4c49 4d45  onstants.MILLIME
-00025b60: 5452 455f 544f 5f4d 4554 5245 0a20 2020  TRE_TO_METRE.   
-00025b70: 2020 2020 2079 203d 206f 7574 7075 745f       y = output_
-00025b80: 706f 7369 7469 6f6e 5b31 5d2a 636f 6e73  position[1]*cons
-00025b90: 7461 6e74 732e 4d49 4c4c 494d 4554 5245  tants.MILLIMETRE
-00025ba0: 5f54 4f5f 4d45 5452 450a 2020 2020 2020  _TO_METRE.      
-00025bb0: 2020 7a20 3d20 6f75 7470 7574 5f70 6f73    z = output_pos
-00025bc0: 6974 696f 6e5b 325d 2a63 6f6e 7374 616e  ition[2]*constan
-00025bd0: 7473 2e4d 494c 4c49 4d45 5452 455f 544f  ts.MILLIMETRE_TO
-00025be0: 5f4d 4554 5245 0a20 2020 2020 2020 2072  _METRE.        r
-00025bf0: 203d 206f 7574 7075 745f 706f 7369 7469   = output_positi
-00025c00: 6f6e 5b33 5d2a 636f 6e73 7461 6e74 732e  on[3]*constants.
-00025c10: 4445 4752 4545 535f 544f 5f52 4144 4941  DEGREES_TO_RADIA
-00025c20: 4e53 0a0a 2020 2020 2020 2020 7265 7475  NS..        retu
-00025c30: 726e 2046 6962 7365 6d4d 616e 6970 756c  rn FibsemManipul
-00025c40: 6174 6f72 506f 7369 7469 6f6e 2878 3d78  atorPosition(x=x
-00025c50: 2c20 793d 792c 207a 3d7a 2c20 723d 7229  , y=y, z=z, r=r)
-00025c60: 0a0a 0a0a 2020 2020 6465 6620 696e 7365  ....    def inse
-00025c70: 7274 5f6d 616e 6970 756c 6174 6f72 2873  rt_manipulator(s
-00025c80: 656c 662c 206e 616d 653a 2073 7472 203d  elf, name: str =
-00025c90: 2022 5374 616e 6462 7922 293a 0a20 2020   "Standby"):.   
-00025ca0: 2020 2020 205f 6368 6563 6b5f 6d61 6e69       _check_mani
-00025cb0: 7075 6c61 746f 7228 7365 6c66 2e73 7973  pulator(self.sys
-00025cc0: 7465 6d29 0a20 2020 2020 2020 2070 7265  tem).        pre
-00025cd0: 7365 745f 706f 7369 7469 6f6e 7320 3d20  set_positions = 
-00025ce0: 5b22 5061 726b 696e 6722 2c22 5374 616e  ["Parking","Stan
-00025cf0: 6462 7922 2c22 576f 726b 696e 6722 2c5d  dby","Working",]
-00025d00: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
-00025d10: 6520 3d3d 2022 5041 524b 223a 0a20 2020  e == "PARK":.   
-00025d20: 2020 2020 2020 2020 206e 616d 6520 3d20           name = 
-00025d30: 2250 6172 6b69 6e67 220a 0a20 2020 2020  "Parking"..     
-00025d40: 2020 2066 6f72 2070 6f73 6974 696f 6e20     for position 
-00025d50: 696e 2070 7265 7365 745f 706f 7369 7469  in preset_positi
-00025d60: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-00025d70: 2069 6620 6e61 6d65 2e6c 6f77 6572 2829   if name.lower()
-00025d80: 203d 3d20 706f 7369 7469 6f6e 2e6c 6f77   == position.low
-00025d90: 6572 2829 3a0a 2020 2020 2020 2020 2020  er():.          
-00025da0: 2020 2020 2020 6e61 6d65 203d 2070 6f73        name = pos
-00025db0: 6974 696f 6e0a 2020 2020 0a0a 2020 2020  ition.    ..    
-00025dc0: 2020 2020 6966 206e 616d 6520 6e6f 7420      if name not 
-00025dd0: 696e 2070 7265 7365 745f 706f 7369 7469  in preset_positi
-00025de0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-00025df0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00025e00: 7228 6622 506f 7369 7469 6f6e 207b 6e61  r(f"Position {na
-00025e10: 6d65 7d20 6973 206e 6f74 2061 2076 616c  me} is not a val
-00025e20: 6964 2070 7265 7365 7420 706f 7369 7469  id preset positi
-00025e30: 6f6e 2e20 5661 6c69 6420 706f 7369 7469  on. Valid positi
-00025e40: 6f6e 7320 6172 6520 7b70 7265 7365 745f  ons are {preset_
-00025e50: 706f 7369 7469 6f6e 737d 2e22 290a 0a0a  positions}.")...
-00025e60: 2020 2020 2020 2020 696e 7365 7274 5f70          insert_p
-00025e70: 6f73 6974 696f 6e20 3d20 6765 7461 7474  osition = getatt
-00025e80: 7228 7365 6c66 2e63 6f6e 6e65 6374 696f  r(self.connectio
-00025e90: 6e2e 4e61 6e6f 6d61 6e69 7075 6c61 746f  n.Nanomanipulato
-00025ea0: 722e 506f 7369 7469 6f6e 2c6e 616d 6529  r.Position,name)
-00025eb0: 0a0a 2020 2020 2020 2020 696e 6465 7820  ..        index 
-00025ec0: 3d20 300a 2020 2020 2020 2020 6c6f 6767  = 0.        logg
-00025ed0: 696e 672e 696e 666f 2866 2249 6e73 6572  ing.info(f"Inser
-00025ee0: 7469 6e67 204e 616e 6f6d 616e 6970 756c  ting Nanomanipul
-00025ef0: 6174 6f72 2074 6f20 7b6e 616d 657d 2070  ator to {name} p
-00025f00: 6f73 6974 696f 6e22 290a 2020 2020 2020  osition").      
-00025f10: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00025f20: 6e2e 4e61 6e6f 6d61 6e69 7075 6c61 746f  n.Nanomanipulato
-00025f30: 722e 4d6f 7665 546f 506f 7369 7469 6f6e  r.MoveToPosition
-00025f40: 2849 6e64 6578 3d69 6e64 6578 2c50 6f73  (Index=index,Pos
-00025f50: 6974 696f 6e3d 696e 7365 7274 5f70 6f73  ition=insert_pos
-00025f60: 6974 696f 6e29 0a0a 2020 2020 6465 6620  ition)..    def 
-00025f70: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
-00025f80: 6f72 5f6c 696d 6974 7328 7365 6c66 2c78  or_limits(self,x
-00025f90: 2c79 2c7a 2c72 293a 0a0a 2020 2020 2020  ,y,z,r):..      
-00025fa0: 2020 6c69 6d69 7473 203d 2073 656c 662e    limits = self.
-00025fb0: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
-00025fc0: 616e 6970 756c 6174 6f72 2e47 6574 4c69  anipulator.GetLi
-00025fd0: 6d69 7473 2849 6e64 6578 3d30 2c54 7970  mits(Index=0,Typ
-00025fe0: 653d 3029 0a0a 2020 2020 2020 2020 786d  e=0)..        xm
-00025ff0: 696e 203d 206c 696d 6974 735b 305d 0a20  in = limits[0]. 
-00026000: 2020 2020 2020 2078 6d61 7820 3d20 6c69         xmax = li
-00026010: 6d69 7473 5b31 5d0a 2020 2020 2020 2020  mits[1].        
-00026020: 796d 696e 203d 206c 696d 6974 735b 325d  ymin = limits[2]
-00026030: 0a20 2020 2020 2020 2079 6d61 7820 3d20  .        ymax = 
-00026040: 6c69 6d69 7473 5b33 5d0a 2020 2020 2020  limits[3].      
-00026050: 2020 7a6d 696e 203d 206c 696d 6974 735b    zmin = limits[
-00026060: 345d 0a20 2020 2020 2020 207a 6d61 7820  4].        zmax 
-00026070: 3d20 6c69 6d69 7473 5b35 5d0a 2020 2020  = limits[5].    
-00026080: 2020 2020 726d 696e 203d 206c 696d 6974      rmin = limit
-00026090: 735b 365d 0a20 2020 2020 2020 2072 6d61  s[6].        rma
-000260a0: 7820 3d20 6c69 6d69 7473 5b37 5d0a 0a20  x = limits[7].. 
-000260b0: 2020 2020 2020 2061 7373 6572 7420 7820         assert x 
-000260c0: 3e3d 2078 6d69 6e20 616e 6420 7820 3c3d  >= xmin and x <=
-000260d0: 2078 6d61 782c 2066 2258 2070 6f73 6974   xmax, f"X posit
-000260e0: 696f 6e20 7b78 7d20 6973 206f 7574 7369  ion {x} is outsi
-000260f0: 6465 206f 6620 6d61 6e69 7075 6c61 746f  de of manipulato
-00026100: 7220 6c69 6d69 7473 207b 786d 696e 7d20  r limits {xmin} 
-00026110: 746f 207b 786d 6178 7d22 0a20 2020 2020  to {xmax}".     
-00026120: 2020 2061 7373 6572 7420 7920 3e3d 2079     assert y >= y
-00026130: 6d69 6e20 616e 6420 7920 3c3d 2079 6d61  min and y <= yma
-00026140: 782c 2066 2259 2070 6f73 6974 696f 6e20  x, f"Y position 
-00026150: 7b79 7d20 6973 206f 7574 7369 6465 206f  {y} is outside o
-00026160: 6620 6d61 6e69 7075 6c61 746f 7220 6c69  f manipulator li
-00026170: 6d69 7473 207b 796d 696e 7d20 746f 207b  mits {ymin} to {
-00026180: 796d 6178 7d22 0a20 2020 2020 2020 2061  ymax}".        a
-00026190: 7373 6572 7420 7a20 3e3d 207a 6d69 6e20  ssert z >= zmin 
-000261a0: 616e 6420 7a20 3c3d 207a 6d61 782c 2066  and z <= zmax, f
-000261b0: 225a 2070 6f73 6974 696f 6e20 7b7a 7d20  "Z position {z} 
-000261c0: 6973 206f 7574 7369 6465 206f 6620 6d61  is outside of ma
-000261d0: 6e69 7075 6c61 746f 7220 6c69 6d69 7473  nipulator limits
-000261e0: 207b 7a6d 696e 7d20 746f 207b 7a6d 6178   {zmin} to {zmax
-000261f0: 7d22 0a20 2020 2020 2020 2061 7373 6572  }".        asser
-00026200: 7420 7220 3e3d 2072 6d69 6e20 616e 6420  t r >= rmin and 
-00026210: 7220 3c3d 2072 6d61 782c 2066 2252 2070  r <= rmax, f"R p
-00026220: 6f73 6974 696f 6e20 7b72 7d20 6973 206f  osition {r} is o
-00026230: 7574 7369 6465 206f 6620 6d61 6e69 7075  utside of manipu
-00026240: 6c61 746f 7220 6c69 6d69 7473 207b 726d  lator limits {rm
-00026250: 696e 7d20 746f 207b 726d 6178 7d22 0a20  in} to {rmax}". 
-00026260: 2020 200a 2020 2020 6465 6620 7265 7472     .    def retr
-00026270: 6163 745f 6d61 6e69 7075 6c61 746f 7228  act_manipulator(
-00026280: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-00026290: 6574 7261 6374 5f70 6f73 6974 696f 6e20  etract_position 
-000262a0: 3d20 6765 7461 7474 7228 7365 6c66 2e63  = getattr(self.c
-000262b0: 6f6e 6e65 6374 696f 6e2e 4e61 6e6f 6d61  onnection.Nanoma
-000262c0: 6e69 7075 6c61 746f 722e 506f 7369 7469  nipulator.Positi
-000262d0: 6f6e 2c22 5061 726b 696e 6722 290a 2020  on,"Parking").  
-000262e0: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
-000262f0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-00026300: 6e65 6374 696f 6e2e 4e61 6e6f 6d61 6e69  nection.Nanomani
-00026310: 7075 6c61 746f 722e 4d6f 7665 546f 506f  pulator.MoveToPo
-00026320: 7369 7469 6f6e 2849 6e64 6578 3d69 6e64  sition(Index=ind
-00026330: 6578 2c50 6f73 6974 696f 6e3d 7265 7472  ex,Position=retr
-00026340: 6163 745f 706f 7369 7469 6f6e 290a 2020  act_position).  
-00026350: 2020 2020 2020 0a0a 2020 2020 0a20 2020        ..    .   
-00026360: 2064 6566 206d 6f76 655f 6d61 6e69 7075   def move_manipu
-00026370: 6c61 746f 725f 7265 6c61 7469 7665 2873  lator_relative(s
-00026380: 656c 662c 706f 7369 7469 6f6e 3a20 4669  elf,position: Fi
-00026390: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
-000263a0: 6f73 6974 696f 6e2c 206e 616d 653a 2073  osition, name: s
-000263b0: 7472 203d 204e 6f6e 6529 3a0a 2020 2020  tr = None):.    
-000263c0: 2020 2020 6966 206e 6f74 206e 702e 6973      if not np.is
-000263d0: 636c 6f73 6528 706f 7369 7469 6f6e 2e72  close(position.r
-000263e0: 2c20 302e 3029 3a0a 2020 2020 2020 2020  , 0.0):.        
-000263f0: 2020 2020 726f 7461 7469 6f6e 203d 2054      rotation = T
-00026400: 7275 650a 2020 2020 2020 2020 656c 7365  rue.        else
-00026410: 3a0a 2020 2020 2020 2020 2020 2020 726f  :.            ro
-00026420: 7461 7469 6f6e 203d 2046 616c 7365 0a20  tation = False. 
-00026430: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
-00026440: 2e69 7363 6c6f 7365 2870 6f73 6974 696f  .isclose(positio
-00026450: 6e2e 742c 2030 2e30 293a 0a20 2020 2020  n.t, 0.0):.     
-00026460: 2020 2020 2020 2074 696c 7420 3d20 5472         tilt = Tr
-00026470: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
-00026480: 0a20 2020 2020 2020 2020 2020 2074 696c  .            til
-00026490: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
-000264a0: 2020 5f63 6865 636b 5f6d 616e 6970 756c    _check_manipul
-000264b0: 6174 6f72 2873 656c 662e 7379 7374 656d  ator(self.system
-000264c0: 2c20 726f 7461 7469 6f6e 2c20 7469 6c74  , rotation, tilt
-000264d0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-000264e0: 662e 636f 6e6e 6563 7469 6f6e 2e4e 616e  f.connection.Nan
-000264f0: 6f6d 616e 6970 756c 6174 6f72 2e49 7343  omanipulator.IsC
-00026500: 616c 6962 7261 7465 6428 3029 203d 3d20  alibrated(0) == 
-00026510: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-00026520: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00026530: 2243 616c 6962 7261 7469 6e67 206d 616e  "Calibrating man
-00026540: 6970 756c 6174 6f72 2229 0a20 2020 2020  ipulator").     
-00026550: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00026560: 6563 7469 6f6e 2e4e 616e 6f6d 616e 6970  ection.Nanomanip
-00026570: 756c 6174 6f72 2e43 616c 6962 7261 7465  ulator.Calibrate
-00026580: 2830 290a 0a20 2020 2020 2020 2063 7572  (0)..        cur
-00026590: 7265 6e74 5f70 6f73 6974 696f 6e20 3d20  rent_position = 
-000265a0: 7365 6c66 2e67 6574 5f6d 616e 6970 756c  self.get_manipul
-000265b0: 6174 6f72 5f70 6f73 6974 696f 6e28 290a  ator_position().
-000265c0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000265d0: 2078 203d 2028 6375 7272 656e 745f 706f   x = (current_po
-000265e0: 7369 7469 6f6e 2e78 202b 2070 6f73 6974  sition.x + posit
-000265f0: 696f 6e2e 7829 2a63 6f6e 7374 616e 7473  ion.x)*constants
-00026600: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
-00026610: 4554 5245 0a20 2020 2020 2020 2079 203d  ETRE.        y =
-00026620: 2028 6375 7272 656e 745f 706f 7369 7469   (current_positi
-00026630: 6f6e 2e79 202b 2070 6f73 6974 696f 6e2e  on.y + position.
-00026640: 7929 2a63 6f6e 7374 616e 7473 2e4d 4554  y)*constants.MET
-00026650: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
-00026660: 0a20 2020 2020 2020 207a 203d 2028 6375  .        z = (cu
-00026670: 7272 656e 745f 706f 7369 7469 6f6e 2e7a  rrent_position.z
-00026680: 202b 2070 6f73 6974 696f 6e2e 7a29 2a63   + position.z)*c
-00026690: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-000266a0: 4f5f 4d49 4c4c 494d 4554 5245 0a20 2020  O_MILLIMETRE.   
-000266b0: 2020 2020 2072 203d 2028 6375 7272 656e       r = (curren
-000266c0: 745f 706f 7369 7469 6f6e 2e72 202b 2070  t_position.r + p
-000266d0: 6f73 6974 696f 6e2e 7229 2a63 6f6e 7374  osition.r)*const
-000266e0: 616e 7473 2e52 4144 4941 4e53 5f54 4f5f  ants.RADIANS_TO_
-000266f0: 4445 4752 4545 530a 2020 2020 2020 2020  DEGREES.        
-00026700: 696e 6465 7820 3d20 300a 0a20 2020 2020  index = 0..     
-00026710: 2020 2023 2073 656c 662e 5f63 6865 636b     # self._check
-00026720: 5f6d 616e 6970 756c 6174 6f72 5f6c 696d  _manipulator_lim
-00026730: 6974 7328 782c 792c 7a2c 7229 0a0a 2020  its(x,y,z,r)..  
-00026740: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00026750: 666f 2866 226d 6f76 696e 6720 6d61 6e69  fo(f"moving mani
-00026760: 7075 6c61 746f 7220 6279 207b 706f 7369  pulator by {posi
-00026770: 7469 6f6e 7d22 290a 2020 2020 2020 2020  tion}").        
-00026780: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00026790: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-000267a0: 2e4e 616e 6f6d 616e 6970 756c 6174 6f72  .Nanomanipulator
-000267b0: 2e4d 6f76 6554 6f28 496e 6465 783d 696e  .MoveTo(Index=in
-000267c0: 6465 782c 583d 782c 2059 3d79 2c20 5a3d  dex,X=x, Y=y, Z=
-000267d0: 7a2c 2052 6f74 3d72 290a 2020 2020 2020  z, Rot=r).      
-000267e0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-000267f0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00026800: 2020 2020 206c 6f67 6769 6e67 2e65 7272       logging.err
-00026810: 6f72 2865 290a 2020 2020 2020 2020 2020  or(e).          
-00026820: 2020 7265 7475 726e 2065 0a0a 2020 2020    return e..    
-00026830: 0a20 2020 2064 6566 206d 6f76 655f 6d61  .    def move_ma
-00026840: 6e69 7075 6c61 746f 725f 6162 736f 6c75  nipulator_absolu
-00026850: 7465 2873 656c 662c 2070 6f73 6974 696f  te(self, positio
-00026860: 6e3a 2046 6962 7365 6d4d 616e 6970 756c  n: FibsemManipul
-00026870: 6174 6f72 506f 7369 7469 6f6e 2c20 6e61  atorPosition, na
-00026880: 6d65 3a20 7374 7220 3d20 4e6f 6e65 293a  me: str = None):
-00026890: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000268a0: 6e70 2e69 7363 6c6f 7365 2870 6f73 6974  np.isclose(posit
-000268b0: 696f 6e2e 722c 2030 2e30 293a 0a20 2020  ion.r, 0.0):.   
-000268c0: 2020 2020 2020 2020 2072 6f74 6174 696f           rotatio
-000268d0: 6e20 3d20 5472 7565 0a20 2020 2020 2020  n = True.       
-000268e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000268f0: 2020 2072 6f74 6174 696f 6e20 3d20 4661     rotation = Fa
-00026900: 6c73 650a 2020 2020 2020 2020 6966 206e  lse.        if n
-00026910: 6f74 206e 702e 6973 636c 6f73 6528 706f  ot np.isclose(po
-00026920: 7369 7469 6f6e 2e74 2c20 302e 3029 3a0a  sition.t, 0.0):.
-00026930: 2020 2020 2020 2020 2020 2020 7469 6c74              tilt
-00026940: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00026950: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00026960: 2020 7469 6c74 203d 2046 616c 7365 0a20    tilt = False. 
-00026970: 2020 2020 2020 205f 6368 6563 6b5f 6d61         _check_ma
-00026980: 6e69 7075 6c61 746f 7228 7365 6c66 2e73  nipulator(self.s
-00026990: 7973 7465 6d2c 2072 6f74 6174 696f 6e2c  ystem, rotation,
-000269a0: 2074 696c 7429 0a20 2020 2020 2020 2069   tilt).        i
-000269b0: 6620 7365 6c66 2e63 6f6e 6e65 6374 696f  f self.connectio
-000269c0: 6e2e 4e61 6e6f 6d61 6e69 7075 6c61 746f  n.Nanomanipulato
-000269d0: 722e 4973 4361 6c69 6272 6174 6564 2830  r.IsCalibrated(0
-000269e0: 2920 3d3d 2046 616c 7365 3a0a 2020 2020  ) == False:.    
-000269f0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00026a00: 696e 666f 2822 4361 6c69 6272 6174 696e  info("Calibratin
-00026a10: 6720 6d61 6e69 7075 6c61 746f 7222 290a  g manipulator").
-00026a20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00026a30: 2e63 6f6e 6e65 6374 696f 6e2e 4e61 6e6f  .connection.Nano
-00026a40: 6d61 6e69 7075 6c61 746f 722e 4361 6c69  manipulator.Cali
-00026a50: 6272 6174 6528 3029 0a20 2020 2020 2020  brate(0).       
-00026a60: 200a 2020 2020 2020 2020 7820 3d20 706f   .        x = po
-00026a70: 7369 7469 6f6e 2e78 2a63 6f6e 7374 616e  sition.x*constan
-00026a80: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
-00026a90: 494d 4554 5245 0a20 2020 2020 2020 2079  IMETRE.        y
-00026aa0: 203d 2070 6f73 6974 696f 6e2e 792a 636f   = position.y*co
-00026ab0: 6e73 7461 6e74 732e 4d45 5452 455f 544f  nstants.METRE_TO
-00026ac0: 5f4d 494c 4c49 4d45 5452 450a 2020 2020  _MILLIMETRE.    
-00026ad0: 2020 2020 7a20 3d20 706f 7369 7469 6f6e      z = position
-00026ae0: 2e7a 2a63 6f6e 7374 616e 7473 2e4d 4554  .z*constants.MET
-00026af0: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
-00026b00: 0a20 2020 2020 2020 2072 203d 2070 6f73  .        r = pos
-00026b10: 6974 696f 6e2e 722a 636f 6e73 7461 6e74  ition.r*constant
-00026b20: 732e 5241 4449 414e 535f 544f 5f44 4547  s.RADIANS_TO_DEG
-00026b30: 5245 4553 0a20 2020 2020 2020 2069 6e64  REES.        ind
-00026b40: 6578 203d 2030 0a0a 2020 2020 2020 2020  ex = 0..        
-00026b50: 2320 7365 6c66 2e5f 6368 6563 6b5f 6d61  # self._check_ma
-00026b60: 6e69 7075 6c61 746f 725f 6c69 6d69 7473  nipulator_limits
-00026b70: 2878 2c79 2c7a 2c72 290a 0a20 2020 2020  (x,y,z,r)..     
-00026b80: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00026b90: 6622 6d6f 7669 6e67 206d 616e 6970 756c  f"moving manipul
-00026ba0: 6174 6f72 2074 6f20 7b70 6f73 6974 696f  ator to {positio
-00026bb0: 6e7d 2229 0a0a 2020 2020 2020 2020 7365  n}")..        se
-00026bc0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4e61  lf.connection.Na
-00026bd0: 6e6f 6d61 6e69 7075 6c61 746f 722e 4d6f  nomanipulator.Mo
-00026be0: 7665 546f 2849 6e64 6578 3d69 6e64 6578  veTo(Index=index
-00026bf0: 2c20 583d 782c 2059 3d79 2c20 5a3d 7a2c  , X=x, Y=y, Z=z,
-00026c00: 2052 6f74 3d72 290a 0a20 2020 2064 6566   Rot=r)..    def
-00026c10: 2063 616c 6962 7261 7465 5f6d 616e 6970   calibrate_manip
-00026c20: 756c 6174 6f72 2873 656c 6629 3a0a 2020  ulator(self):.  
-00026c30: 2020 2020 2020 5f63 6865 636b 5f6d 616e        _check_man
-00026c40: 6970 756c 6174 6f72 2873 656c 662e 7379  ipulator(self.sy
-00026c50: 7374 656d 290a 2020 2020 2020 2020 6c6f  stem).        lo
-00026c60: 6767 696e 672e 696e 666f 2822 4361 6c69  gging.info("Cali
-00026c70: 6272 6174 696e 6720 6d61 6e69 7075 6c61  brating manipula
-00026c80: 746f 7222 290a 2020 2020 2020 2020 7365  tor").        se
-00026c90: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4e61  lf.connection.Na
-00026ca0: 6e6f 6d61 6e69 7075 6c61 746f 722e 4361  nomanipulator.Ca
-00026cb0: 6c69 6272 6174 6528 3029 0a0a 2020 2020  librate(0)..    
-00026cc0: 6465 6620 5f78 5f63 6f72 7265 6374 6564  def _x_corrected
-00026cd0: 5f6e 6565 646c 655f 6d6f 7665 6d65 6e74  _needle_movement
-00026ce0: 2873 656c 662c 2065 7870 6563 7465 645f  (self, expected_
-00026cf0: 783a 2066 6c6f 6174 2920 2d3e 2046 6962  x: float) -> Fib
-00026d00: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
-00026d10: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
-00026d20: 2222 2243 616c 6375 6c61 7465 2074 6865  """Calculate the
-00026d30: 2063 6f72 7265 6374 6564 206e 6565 646c   corrected needl
-00026d40: 6520 6d6f 7665 6d65 6e74 2074 6f20 6d6f  e movement to mo
-00026d50: 7665 2069 6e20 7468 6520 782d 6178 6973  ve in the x-axis
-00026d60: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
-00026d70: 0a20 2020 2020 2020 2020 2020 2065 7870  .            exp
-00026d80: 6563 7465 645f 7820 2866 6c6f 6174 293a  ected_x (float):
-00026d90: 2064 6973 7461 6e63 6520 616c 6f6e 6720   distance along 
-00026da0: 7468 6520 782d 6178 6973 2028 696d 6167  the x-axis (imag
-00026db0: 6520 636f 6f72 6469 6e61 7465 7329 0a20  e coordinates). 
-00026dc0: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
-00026dd0: 2020 2020 2020 2020 2020 2020 4669 6273              Fibs
-00026de0: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
-00026df0: 6974 696f 6e3a 2078 2d63 6f72 7265 6374  ition: x-correct
-00026e00: 6564 206e 6565 646c 6520 6d6f 7665 6d65  ed needle moveme
-00026e10: 6e74 2028 7265 6c61 7469 7665 2070 6f73  nt (relative pos
-00026e20: 6974 696f 6e29 0a20 2020 2020 2020 2022  ition).        "
-00026e30: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-00026e40: 6e20 4669 6273 656d 4d61 6e69 7075 6c61  n FibsemManipula
-00026e50: 746f 7250 6f73 6974 696f 6e28 783d 6578  torPosition(x=ex
-00026e60: 7065 6374 6564 5f78 2c20 793d 302c 207a  pected_x, y=0, z
-00026e70: 3d30 2920 2023 206e 6f20 6164 6a75 7374  =0)  # no adjust
-00026e80: 6d65 6e74 206e 6565 6465 640a 0a0a 2020  ment needed...  
-00026e90: 2020 6465 6620 5f79 5f63 6f72 7265 6374    def _y_correct
-00026ea0: 6564 5f6e 6565 646c 655f 6d6f 7665 6d65  ed_needle_moveme
-00026eb0: 6e74 2873 656c 662c 200a 2020 2020 2020  nt(self, .      
-00026ec0: 2020 6578 7065 6374 6564 5f79 3a20 666c    expected_y: fl
-00026ed0: 6f61 742c 2073 7461 6765 5f74 696c 743a  oat, stage_tilt:
-00026ee0: 2066 6c6f 6174 0a20 2020 2029 202d 3e20   float.    ) -> 
-00026ef0: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
-00026f00: 7250 6f73 6974 696f 6e3a 0a20 2020 2020  rPosition:.     
-00026f10: 2020 2022 2222 4361 6c63 756c 6174 6520     """Calculate 
-00026f20: 7468 6520 636f 7272 6563 7465 6420 6e65  the corrected ne
-00026f30: 6564 6c65 206d 6f76 656d 656e 7420 746f  edle movement to
-00026f40: 206d 6f76 6520 696e 2074 6865 2079 2d61   move in the y-a
-00026f50: 7869 732e 0a0a 2020 2020 2020 2020 4172  xis...        Ar
-00026f60: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00026f70: 6578 7065 6374 6564 5f79 2028 666c 6f61  expected_y (floa
-00026f80: 7429 3a20 6469 7374 616e 6365 2061 6c6f  t): distance alo
-00026f90: 6e67 2074 6865 2079 2d61 7869 7320 2869  ng the y-axis (i
-00026fa0: 6d61 6765 2063 6f6f 7264 696e 6174 6573  mage coordinates
-00026fb0: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-00026fc0: 6167 655f 7469 6c74 2028 666c 6f61 742c  age_tilt (float,
-00026fd0: 206f 7074 696f 6e61 6c29 3a20 7374 6167   optional): stag
-00026fe0: 6520 7469 6c74 2e0a 0a20 2020 2020 2020  e tilt...       
-00026ff0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00027000: 2020 2020 2020 4669 6273 656d 4d61 6e69        FibsemMani
-00027010: 7075 6c61 746f 7250 6f73 6974 696f 6e3a  pulatorPosition:
-00027020: 2079 2d63 6f72 7265 6374 6564 206e 6565   y-corrected nee
-00027030: 646c 6520 6d6f 7665 6d65 6e74 2028 7265  dle movement (re
-00027040: 6c61 7469 7665 2070 6f73 6974 696f 6e29  lative position)
-00027050: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00027060: 2020 2020 2079 5f6d 6f76 6520 3d20 2b6e       y_move = +n
-00027070: 702e 636f 7328 7374 6167 655f 7469 6c74  p.cos(stage_tilt
-00027080: 2920 2a20 6578 7065 6374 6564 5f79 0a20  ) * expected_y. 
-00027090: 2020 2020 2020 207a 5f6d 6f76 6520 3d20         z_move = 
-000270a0: 2b6e 702e 7369 6e28 7374 6167 655f 7469  +np.sin(stage_ti
-000270b0: 6c74 2920 2a20 6578 7065 6374 6564 5f79  lt) * expected_y
-000270c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000270d0: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
-000270e0: 7250 6f73 6974 696f 6e28 783d 302c 2079  rPosition(x=0, y
-000270f0: 3d79 5f6d 6f76 652c 207a 3d7a 5f6d 6f76  =y_move, z=z_mov
-00027100: 6529 0a0a 0a20 2020 2064 6566 205f 7a5f  e)...    def _z_
-00027110: 636f 7272 6563 7465 645f 6e65 6564 6c65  corrected_needle
-00027120: 5f6d 6f76 656d 656e 7428 7365 6c66 2c20  _movement(self, 
-00027130: 0a20 2020 2020 2020 2065 7870 6563 7465  .        expecte
-00027140: 645f 7a3a 2066 6c6f 6174 2c20 7374 6167  d_z: float, stag
-00027150: 655f 7469 6c74 3a20 666c 6f61 740a 2020  e_tilt: float.  
-00027160: 2020 2920 2d3e 2046 6962 7365 6d4d 616e    ) -> FibsemMan
-00027170: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
-00027180: 3a0a 2020 2020 2020 2020 2222 2243 616c  :.        """Cal
-00027190: 6375 6c61 7465 2074 6865 2063 6f72 7265  culate the corre
-000271a0: 6374 6564 206e 6565 646c 6520 6d6f 7665  cted needle move
-000271b0: 6d65 6e74 2074 6f20 6d6f 7665 2069 6e20  ment to move in 
-000271c0: 7468 6520 7a2d 6178 6973 2e0a 0a20 2020  the z-axis...   
-000271d0: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-000271e0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-000271f0: 7a20 2866 6c6f 6174 293a 2064 6973 7461  z (float): dista
-00027200: 6e63 6520 616c 6f6e 6720 7468 6520 7a2d  nce along the z-
-00027210: 6178 6973 2028 696d 6167 6520 636f 6f72  axis (image coor
-00027220: 6469 6e61 7465 7329 0a20 2020 2020 2020  dinates).       
-00027230: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
-00027240: 2866 6c6f 6174 2c20 6f70 7469 6f6e 616c  (float, optional
-00027250: 293a 2073 7461 6765 2074 696c 742e 0a0a  ): stage tilt...
-00027260: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
-00027270: 0a20 2020 2020 2020 2020 2020 2046 6962  .            Fib
-00027280: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
-00027290: 7369 7469 6f6e 3a20 7a2d 636f 7272 6563  sition: z-correc
-000272a0: 7465 6420 6e65 6564 6c65 206d 6f76 656d  ted needle movem
-000272b0: 656e 7420 2872 656c 6174 6976 6520 706f  ent (relative po
-000272c0: 7369 7469 6f6e 290a 2020 2020 2020 2020  sition).        
-000272d0: 2222 220a 2020 2020 2020 2020 795f 6d6f  """.        y_mo
-000272e0: 7665 203d 202d 6e70 2e73 696e 2873 7461  ve = -np.sin(sta
-000272f0: 6765 5f74 696c 7429 202a 2065 7870 6563  ge_tilt) * expec
-00027300: 7465 645f 7a0a 2020 2020 2020 2020 7a5f  ted_z.        z_
-00027310: 6d6f 7665 203d 202b 6e70 2e63 6f73 2873  move = +np.cos(s
-00027320: 7461 6765 5f74 696c 7429 202a 2065 7870  tage_tilt) * exp
-00027330: 6563 7465 645f 7a0a 2020 2020 2020 2020  ected_z.        
-00027340: 7265 7475 726e 2046 6962 7365 6d4d 616e  return FibsemMan
-00027350: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
-00027360: 2878 3d30 2c20 793d 795f 6d6f 7665 2c20  (x=0, y=y_move, 
-00027370: 7a3d 7a5f 6d6f 7665 290a 0a20 2020 2064  z=z_move)..    d
-00027380: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
-00027390: 746f 725f 636f 7272 6563 7465 6428 7365  tor_corrected(se
-000273a0: 6c66 2c20 0a20 2020 2020 2020 2064 783a  lf, .        dx:
-000273b0: 2066 6c6f 6174 203d 2030 2c0a 2020 2020   float = 0,.    
-000273c0: 2020 2020 6479 3a20 666c 6f61 7420 3d20      dy: float = 
-000273d0: 302c 0a20 2020 2020 2020 2062 6561 6d5f  0,.        beam_
-000273e0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-000273f0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-00027400: 4f4e 2c0a 2020 2020 2920 2d3e 204e 6f6e  ON,.    ) -> Non
-00027410: 653a 0a20 2020 2020 2020 2022 2222 4361  e:.        """Ca
-00027420: 6c63 756c 6174 6520 7468 6520 7265 7175  lculate the requ
-00027430: 6972 6564 2063 6f72 7265 6374 6564 206e  ired corrected n
-00027440: 6565 646c 6520 6d6f 7665 6d65 6e74 7320  eedle movements 
-00027450: 6261 7365 6420 6f6e 2074 6865 2042 6561  based on the Bea
-00027460: 6d54 7970 6520 746f 206d 6f76 6520 696e  mType to move in
-00027470: 2074 6865 2064 6573 6972 6564 2069 6d61   the desired ima
-00027480: 6765 2063 6f6f 7264 696e 6174 6573 2e0a  ge coordinates..
-00027490: 2020 2020 2020 2020 5468 656e 206d 6f76          Then mov
-000274a0: 6520 7468 6520 6e65 6564 6c65 2072 656c  e the needle rel
-000274b0: 6174 6976 656c 792e 0a0a 2020 2020 2020  atively...      
-000274c0: 2020 4265 616d 5479 7065 2e45 4c45 4354    BeamType.ELECT
-000274d0: 524f 4e3a 2020 6d6f 7665 2069 6e20 782c  RON:  move in x,
-000274e0: 2079 2028 7261 7720 636f 6f72 6469 6e61   y (raw coordina
-000274f0: 7465 7329 0a20 2020 2020 2020 2042 6561  tes).        Bea
-00027500: 6d54 7970 652e 494f 4e3a 2020 2020 2020  mType.ION:      
-00027510: 206d 6f76 6520 696e 2078 2c20 7a20 2872   move in x, z (r
-00027520: 6177 2063 6f6f 7264 696e 6174 6573 290a  aw coordinates).
-00027530: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-00027540: 2020 2020 2020 2020 2020 206d 6963 726f             micro
-00027550: 7363 6f70 6520 2853 6462 4d69 6372 6f73  scope (SdbMicros
-00027560: 636f 7065 436c 6965 6e74 293a 2061 7574  copeClient): aut
-00027570: 6f53 6372 6970 7420 6d69 6372 6f73 636f  oScript microsco
-00027580: 7065 2069 6e73 7461 6e63 650a 2020 2020  pe instance.    
-00027590: 2020 2020 2020 2020 6478 2028 666c 6f61          dx (floa
-000275a0: 7429 3a20 6469 7374 616e 6365 2061 6c6f  t): distance alo
-000275b0: 6e67 2074 6865 2078 2d61 7869 7320 2869  ng the x-axis (i
-000275c0: 6d61 6765 2063 6f6f 7264 696e 6174 6573  mage coordinates
-000275d0: 290a 2020 2020 2020 2020 2020 2020 6479  ).            dy
-000275e0: 2028 666c 6f61 7429 3a20 6469 7374 616e   (float): distan
-000275f0: 6365 2061 6c6f 6e67 2074 6865 2079 2d61  ce along the y-a
-00027600: 7869 7320 2869 6d61 6765 2063 6f72 6f64  xis (image corod
-00027610: 696e 6174 6573 290a 2020 2020 2020 2020  inates).        
-00027620: 2020 2020 6265 616d 5f74 7970 6520 2842      beam_type (B
-00027630: 6561 6d54 7970 652c 206f 7074 696f 6e61  eamType, optiona
-00027640: 6c29 3a20 7468 6520 6265 616d 2074 7970  l): the beam typ
-00027650: 6520 746f 206d 6f76 6520 696e 2e20 4465  e to move in. De
-00027660: 6661 756c 7473 2074 6f20 4265 616d 5479  faults to BeamTy
-00027670: 7065 2e45 4c45 4354 524f 4e2e 0a20 2020  pe.ELECTRON..   
-00027680: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00027690: 205f 6368 6563 6b5f 6d61 6e69 7075 6c61   _check_manipula
-000276a0: 746f 7228 7365 6c66 2e73 7973 7465 6d29  tor(self.system)
-000276b0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-000276c0: 662e 636f 6e6e 6563 7469 6f6e 2e4e 616e  f.connection.Nan
-000276d0: 6f6d 616e 6970 756c 6174 6f72 2e49 7343  omanipulator.IsC
-000276e0: 616c 6962 7261 7465 6428 3029 203d 3d20  alibrated(0) == 
-000276f0: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
-00027700: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00027710: 2243 616c 6962 7261 7469 6e67 206d 616e  "Calibrating man
-00027720: 6970 756c 6174 6f72 2229 0a20 2020 2020  ipulator").     
-00027730: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00027740: 6563 7469 6f6e 2e4e 616e 6f6d 616e 6970  ection.Nanomanip
-00027750: 756c 6174 6f72 2e43 616c 6962 7261 7465  ulator.Calibrate
-00027760: 2830 290a 2020 2020 2020 2020 7374 6167  (0).        stag
-00027770: 655f 7469 6c74 203d 2073 656c 662e 6765  e_tilt = self.ge
-00027780: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
-00027790: 2829 2e74 0a0a 0a20 2020 2020 2020 2023  ().t...        #
-000277a0: 2023 2078 790a 2020 2020 2020 2020 2320   # xy.        # 
-000277b0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-000277c0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
-000277d0: 4e3a 0a20 2020 2020 2020 2023 2020 2020  N:.        #    
-000277e0: 2078 5f6d 6f76 6520 3d20 7365 6c66 2e5f   x_move = self._
-000277f0: 785f 636f 7272 6563 7465 645f 6e65 6564  x_corrected_need
-00027800: 6c65 5f6d 6f76 656d 656e 7428 6578 7065  le_movement(expe
-00027810: 6374 6564 5f78 3d64 7829 0a20 2020 2020  cted_x=dx).     
-00027820: 2020 2023 2020 2020 2079 7a5f 6d6f 7665     #     yz_move
-00027830: 203d 2073 656c 662e 5f79 5f63 6f72 7265   = self._y_corre
-00027840: 6374 6564 5f6e 6565 646c 655f 6d6f 7665  cted_needle_move
-00027850: 6d65 6e74 2864 792c 2073 7461 6765 5f74  ment(dy, stage_t
-00027860: 696c 743d 7374 6167 655f 7469 6c74 290a  ilt=stage_tilt).
-00027870: 0a20 2020 2020 2020 2023 2023 2078 7a2c  .        # # xz,
-00027880: 0a20 2020 2020 2020 2023 2069 6620 6265  .        # if be
-00027890: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
-000278a0: 7970 652e 494f 4e3a 0a0a 2020 2020 2020  ype.ION:..      
-000278b0: 2020 2320 2020 2020 785f 6d6f 7665 203d    #     x_move =
-000278c0: 2073 656c 662e 5f78 5f63 6f72 7265 6374   self._x_correct
-000278d0: 6564 5f6e 6565 646c 655f 6d6f 7665 6d65  ed_needle_moveme
-000278e0: 6e74 2865 7870 6563 7465 645f 783d 6478  nt(expected_x=dx
-000278f0: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-00027900: 797a 5f6d 6f76 6520 3d20 7365 6c66 2e5f  yz_move = self._
-00027910: 7a5f 636f 7272 6563 7465 645f 6e65 6564  z_corrected_need
-00027920: 6c65 5f6d 6f76 656d 656e 7428 6578 7065  le_movement(expe
-00027930: 6374 6564 5f7a 3d64 792c 2073 7461 6765  cted_z=dy, stage
-00027940: 5f74 696c 743d 7374 6167 655f 7469 6c74  _tilt=stage_tilt
-00027950: 290a 0a20 2020 2020 2020 2023 206d 6f76  )..        # mov
-00027960: 6520 6e65 6564 6c65 2028 7265 6c61 7469  e needle (relati
-00027970: 7665 290a 2020 2020 2020 2020 2373 656c  ve).        #sel
-00027980: 662e 636f 6e6e 6563 7469 6f6e 2e4e 616e  f.connection.Nan
-00027990: 6f6d 616e 6970 756c 6174 6f72 2e4d 6f76  omanipulator.Mov
-000279a0: 6554 6f28 496e 6465 783d 302c 2058 3d78  eTo(Index=0, X=x
-000279b0: 5f6d 6f76 652e 782c 2059 3d79 7a5f 6d6f  _move.x, Y=yz_mo
-000279c0: 7665 2e79 2c20 5a3d 797a 5f6d 6f76 652e  ve.y, Z=yz_move.
-000279d0: 7a29 0a20 2020 2020 2020 2073 656c 662e  z).        self.
-000279e0: 6d6f 7665 5f6d 616e 6970 756c 6174 6f72  move_manipulator
-000279f0: 5f72 656c 6174 6976 6528 4669 6273 656d  _relative(Fibsem
-00027a00: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
-00027a10: 696f 6e28 783d 6478 2c20 793d 6479 2c20  ion(x=dx, y=dy, 
-00027a20: 7a3d 3029 290a 0a20 2020 2020 2020 2072  z=0))..        r
-00027a30: 6574 7572 6e0a 0a20 2020 2064 6566 206d  eturn..    def m
-00027a40: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
-00027a50: 746f 5f70 6f73 6974 696f 6e5f 6f66 6673  to_position_offs
-00027a60: 6574 2873 656c 662c 206f 6666 7365 743a  et(self, offset:
-00027a70: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
-00027a80: 6f72 506f 7369 7469 6f6e 2c20 6e61 6d65  orPosition, name
-00027a90: 3a20 7374 7220 3d20 4e6f 6e65 2920 2d3e  : str = None) ->
-00027aa0: 204e 6f6e 653a 0a20 2020 2020 2020 206c   None:.        l
-00027ab0: 6f67 6769 6e67 2e77 6172 6e69 6e67 2822  ogging.warning("
-00027ac0: 4e6f 7420 7375 7070 6f72 7465 6420 6279  Not supported by
-00027ad0: 2054 4553 4341 4e20 4150 4922 290a 2020   TESCAN API").  
-00027ae0: 2020 2020 2020 2320 7261 6973 6520 4e6f        # raise No
-00027af0: 7449 6d70 6c65 6d65 6e74 6564 4572 726f  tImplementedErro
-00027b00: 7228 224e 6f74 2073 7570 706f 7274 6564  r("Not supported
-00027b10: 2062 7920 5445 5343 414e 2041 5049 2229   by TESCAN API")
-00027b20: 0a20 2020 2020 2020 2023 205f 6368 6563  .        # _chec
-00027b30: 6b5f 6d61 6e69 7075 6c61 746f 725f 6d6f  k_manipulator_mo
-00027b40: 7665 6d65 6e74 2873 656c 662e 7379 7374  vement(self.syst
-00027b50: 656d 2c20 6f66 6673 6574 290a 2020 2020  em, offset).    
-00027b60: 2020 2020 7061 7373 0a0a 2020 2020 6465      pass..    de
-00027b70: 6620 5f67 6574 5f73 6176 6564 5f6d 616e  f _get_saved_man
-00027b80: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
-00027b90: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-00027ba0: 205f 6368 6563 6b5f 6d61 6e69 7075 6c61   _check_manipula
-00027bb0: 746f 7228 7365 6c66 2e73 7973 7465 6d29  tor(self.system)
-00027bc0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00027bd0: 2e77 6172 6e69 6e67 2822 4e6f 7420 7375  .warning("Not su
-00027be0: 7070 6f72 7465 6420 6279 2054 4553 4341  pported by TESCA
-00027bf0: 4e20 4150 4922 290a 2020 2020 2020 2020  N API").        
-00027c00: 7061 7373 0a0a 2020 2020 6465 6620 7365  pass..    def se
-00027c10: 7475 705f 6d69 6c6c 696e 6728 0a20 2020  tup_milling(.   
-00027c20: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00027c30: 2020 206d 696c 6c5f 7365 7474 696e 6773     mill_settings
-00027c40: 3a20 4669 6273 656d 4d69 6c6c 696e 6753  : FibsemMillingS
-00027c50: 6574 7469 6e67 732c 0a20 2020 2029 3a0a  ettings,.    ):.
-00027c60: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00027c70: 2020 2020 436f 6e66 6967 7572 6520 7468      Configure th
-00027c80: 6520 6d69 6372 6f73 636f 7065 2066 6f72  e microscope for
-00027c90: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
-00027ca0: 6865 2069 6f6e 2062 6561 6d2e 0a0a 2020  he ion beam...  
-00027cb0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-00027cc0: 2020 2020 2020 2020 6170 706c 6963 6174          applicat
-00027cd0: 696f 6e5f 6669 6c65 2028 7374 7229 3a20  ion_file (str): 
-00027ce0: 5061 7468 2074 6f20 7468 6520 6d69 6c6c  Path to the mill
-00027cf0: 696e 6720 6170 706c 6963 6174 696f 6e20  ing application 
-00027d00: 6669 6c65 2e0a 2020 2020 2020 2020 2020  file..          
-00027d10: 2020 7061 7474 6572 6e69 6e67 5f6d 6f64    patterning_mod
-00027d20: 6520 2873 7472 293a 2050 6174 7465 726e  e (str): Pattern
-00027d30: 696e 6720 6d6f 6465 2074 6f20 7573 652e  ing mode to use.
-00027d40: 0a20 2020 2020 2020 2020 2020 2068 6677  .            hfw
-00027d50: 2028 666c 6f61 7429 3a20 4465 7369 7265   (float): Desire
-00027d60: 6420 686f 7269 7a6f 6e74 616c 2066 6965  d horizontal fie
-00027d70: 6c64 2077 6964 7468 2069 6e20 6d65 7465  ld width in mete
-00027d80: 7273 2e0a 2020 2020 2020 2020 2020 2020  rs..            
-00027d90: 6d69 6c6c 5f73 6574 7469 6e67 7320 2846  mill_settings (F
-00027da0: 6962 7365 6d4d 696c 6c69 6e67 5365 7474  ibsemMillingSett
-00027db0: 696e 6773 293a 204d 696c 6c69 6e67 2073  ings): Milling s
-00027dc0: 6574 7469 6e67 732e 0a0a 2020 2020 2020  ettings...      
-00027dd0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
-00027de0: 2020 2020 2020 204e 6f6e 652e 0a0a 2020         None...  
-00027df0: 2020 2020 2020 5261 6973 6573 3a0a 2020        Raises:.  
-00027e00: 2020 2020 2020 2020 2020 4e6f 7449 6d70            NotImp
-00027e10: 6c65 6d65 6e74 6564 4572 726f 723a 2049  lementedError: I
-00027e20: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
-00027e30: 7061 7474 6572 6e69 6e67 206d 6f64 6520  patterning mode 
-00027e40: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
-00027e50: 2e0a 0a20 2020 2020 2020 204e 6f74 653a  ...        Note:
-00027e60: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
-00027e70: 7320 6d65 7468 6f64 2073 6574 7320 7570  s method sets up
-00027e80: 2074 6865 206d 6963 726f 7363 6f70 6520   the microscope 
-00027e90: 696d 6167 696e 6720 616e 6420 7061 7474  imaging and patt
-00027ea0: 6572 6e69 6e67 2066 6f72 206d 696c 6c69  erning for milli
-00027eb0: 6e67 2075 7369 6e67 2074 6865 2069 6f6e  ng using the ion
-00027ec0: 2062 6561 6d2e 0a20 2020 2020 2020 2020   beam..         
-00027ed0: 2020 2049 7420 7365 7473 2074 6865 2061     It sets the a
-00027ee0: 6374 6976 6520 7669 6577 2061 6e64 2064  ctive view and d
-00027ef0: 6576 6963 6520 746f 2074 6865 2069 6f6e  evice to the ion
-00027f00: 2062 6561 6d2c 2074 6865 2064 6566 6175   beam, the defau
-00027f10: 6c74 2062 6561 6d20 7479 7065 2074 6f20  lt beam type to 
-00027f20: 7468 6520 696f 6e20 6265 616d 2c0a 2020  the ion beam,.  
-00027f30: 2020 2020 2020 2020 2020 7468 6520 7370            the sp
-00027f40: 6563 6966 6965 6420 6170 706c 6963 6174  ecified applicat
-00027f50: 696f 6e20 6669 6c65 2c20 616e 6420 7468  ion file, and th
-00027f60: 6520 7370 6563 6966 6965 6420 7061 7474  e specified patt
-00027f70: 6572 6e69 6e67 206d 6f64 652e 0a20 2020  erning mode..   
-00027f80: 2020 2020 2020 2020 2049 7420 616c 736f           It also
-00027f90: 2063 6c65 6172 7320 616e 7920 6578 6973   clears any exis
-00027fa0: 7469 6e67 2070 6174 7465 726e 7320 616e  ting patterns an
-00027fb0: 6420 7365 7473 2074 6865 2068 6f72 697a  d sets the horiz
-00027fc0: 6f6e 7461 6c20 6669 656c 6420 7769 6474  ontal field widt
-00027fd0: 6820 746f 2074 6865 2064 6573 6972 6564  h to the desired
-00027fe0: 2076 616c 7565 2e0a 2020 2020 2020 2020   value..        
-00027ff0: 2020 2020 5468 6520 6d65 7468 6f64 2064      The method d
-00028000: 6f65 7320 6e6f 7420 7374 6172 7420 7468  oes not start th
-00028010: 6520 6d69 6c6c 696e 6720 7072 6f63 6573  e milling proces
-00028020: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-00028030: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
-00028040: 616d 2842 6561 6d54 7970 652e 494f 4e2c  am(BeamType.ION,
-00028050: 2073 656c 662e 7379 7374 656d 290a 0a20   self.system).. 
-00028060: 2020 2020 2020 2073 706f 745f 7369 7a65         spot_size
-00028070: 203d 206d 696c 6c5f 7365 7474 696e 6773   = mill_settings
-00028080: 2e73 706f 745f 7369 7a65 2020 2320 6170  .spot_size  # ap
-00028090: 706c 6963 6174 696f 6e5f 6669 6c65 0a20  plication_file. 
-000280a0: 2020 2020 2020 2072 6174 6520 3d20 6d69         rate = mi
-000280b0: 6c6c 5f73 6574 7469 6e67 732e 7261 7465  ll_settings.rate
-000280c0: 2020 2323 2069 6e20 6170 706c 6963 6174    ## in applicat
-000280d0: 696f 6e20 6669 6c65 2063 616c 6c65 6420  ion file called 
-000280e0: 566f 6c75 6d65 2070 6572 2044 6f73 6520  Volume per Dose 
-000280f0: 286d 332f 4329 0a20 2020 2020 2020 2064  (m3/C).        d
-00028100: 7765 6c6c 5f74 696d 6520 3d20 6d69 6c6c  well_time = mill
-00028110: 5f73 6574 7469 6e67 732e 6477 656c 6c5f  _settings.dwell_
-00028120: 7469 6d65 2020 2320 696e 2073 6563 6f6e  time  # in secon
-00028130: 6473 2023 2320 696e 2061 7070 6c69 6361  ds ## in applica
-00028140: 7469 6f6e 2066 696c 650a 0a20 2020 2020  tion file..     
-00028150: 2020 2069 6620 6d69 6c6c 5f73 6574 7469     if mill_setti
-00028160: 6e67 732e 7061 7474 6572 6e69 6e67 5f6d  ngs.patterning_m
-00028170: 6f64 6520 3d3d 2022 5365 7269 616c 223a  ode == "Serial":
-00028180: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-00028190: 616c 6c65 6c5f 6d6f 6465 203d 2046 616c  allel_mode = Fal
-000281a0: 7365 0a20 2020 2020 2020 2065 6c73 653a  se.        else:
-000281b0: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
-000281c0: 616c 6c65 6c5f 6d6f 6465 203d 2054 7275  allel_mode = Tru
-000281d0: 650a 0a20 2020 2020 2020 2070 7269 6e74  e..        print
-000281e0: 2866 2273 7061 6369 6e67 3a20 7b6d 696c  (f"spacing: {mil
-000281f0: 6c5f 7365 7474 696e 6773 2e73 7061 6369  l_settings.spaci
-00028200: 6e67 7d22 290a 0a20 2020 2020 2020 2073  ng}")..        s
-00028210: 656c 662e 7365 7428 2270 7265 7365 7422  elf.set("preset"
-00028220: 2c20 6d69 6c6c 5f73 6574 7469 6e67 732e  , mill_settings.
-00028230: 7072 6573 6574 2c20 4265 616d 5479 7065  preset, BeamType
-00028240: 2e49 4f4e 290a 2020 2020 2020 2020 6265  .ION).        be
-00028250: 616d 5f63 7572 7265 6e74 203d 2073 656c  am_current = sel
-00028260: 662e 636f 6e6e 6563 7469 6f6e 2e46 4942  f.connection.FIB
-00028270: 2e42 6561 6d2e 5265 6164 5072 6f62 6543  .Beam.ReadProbeC
-00028280: 7572 7265 6e74 2829 2a63 6f6e 7374 616e  urrent()*constan
-00028290: 7473 2e50 4943 4f5f 544f 5f53 490a 2020  ts.PICO_TO_SI.  
-000282a0: 2020 2020 2020 7072 696e 7428 6622 6265        print(f"be
-000282b0: 616d 5f63 7572 7265 6e74 3a20 7b62 6561  am_current: {bea
-000282c0: 6d5f 6375 7272 656e 747d 2229 0a20 2020  m_current}").   
-000282d0: 2020 2020 206c 6179 6572 5f73 6574 7469       layer_setti
-000282e0: 6e67 7320 3d20 4945 7463 6869 6e67 280a  ngs = IEtching(.
-000282f0: 2020 2020 2020 2020 2020 2020 7379 6e63              sync
-00028300: 5772 6974 6546 6965 6c64 3d46 616c 7365  WriteField=False
-00028310: 2c0a 2020 2020 2020 2020 2020 2020 7772  ,.            wr
-00028320: 6974 6546 6965 6c64 5369 7a65 3d6d 696c  iteFieldSize=mil
-00028330: 6c5f 7365 7474 696e 6773 2e68 6677 2c0a  l_settings.hfw,.
-00028340: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-00028350: 4375 7272 656e 743d 6265 616d 5f63 7572  Current=beam_cur
-00028360: 7265 6e74 2c0a 2020 2020 2020 2020 2020  rent,.          
-00028370: 2020 7370 6f74 5369 7a65 3d73 706f 745f    spotSize=spot_
-00028380: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
-00028390: 2020 7261 7465 3d72 6174 652c 0a20 2020    rate=rate,.   
-000283a0: 2020 2020 2020 2020 2064 7765 6c6c 5469           dwellTi
-000283b0: 6d65 3d64 7765 6c6c 5f74 696d 652c 0a20  me=dwell_time,. 
-000283c0: 2020 2020 2020 2020 2020 2070 6172 616c             paral
-000283d0: 6c65 6c3d 7061 7261 6c6c 656c 5f6d 6f64  lel=parallel_mod
-000283e0: 652c 0a20 2020 2020 2020 2020 2020 2070  e,.            p
-000283f0: 7265 7365 7420 3d20 6d69 6c6c 5f73 6574  reset = mill_set
-00028400: 7469 6e67 732e 7072 6573 6574 2c0a 2020  tings.preset,.  
-00028410: 2020 2020 2020 2020 2020 7370 6163 696e            spacin
-00028420: 6720 3d20 6d69 6c6c 5f73 6574 7469 6e67  g = mill_setting
-00028430: 732e 7370 6163 696e 672c 0a20 2020 2020  s.spacing,.     
-00028440: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00028450: 6c66 2e6c 6179 6572 203d 2073 656c 662e  lf.layer = self.
-00028460: 636f 6e6e 6563 7469 6f6e 2e44 7261 7742  connection.DrawB
-00028470: 6561 6d2e 4c61 7965 7228 224c 6179 6572  eam.Layer("Layer
-00028480: 3122 2c20 6c61 7965 725f 7365 7474 696e  1", layer_settin
-00028490: 6773 290a 2020 2020 2020 2020 0a0a 2020  gs).        ..  
-000284a0: 2020 6465 6620 7275 6e5f 6d69 6c6c 696e    def run_millin
-000284b0: 6728 7365 6c66 2c20 6d69 6c6c 696e 675f  g(self, milling_
-000284c0: 6375 7272 656e 743a 2066 6c6f 6174 2c20  current: float, 
-000284d0: 6d69 6c6c 696e 675f 766f 6c74 6167 653a  milling_voltage:
-000284e0: 2066 6c6f 6174 2c20 6173 796e 6368 3a20   float, asynch: 
-000284f0: 626f 6f6c 203d 2046 616c 7365 293a 0a20  bool = False):. 
-00028500: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00028510: 2020 2052 756e 7320 7468 6520 696f 6e20     Runs the ion 
-00028520: 6265 616d 206d 696c 6c69 6e67 2070 726f  beam milling pro
-00028530: 6365 7373 2075 7369 6e67 2074 6865 2073  cess using the s
-00028540: 7065 6369 6669 6564 206d 696c 6c69 6e67  pecified milling
-00028550: 2063 7572 7265 6e74 2e0a 0a20 2020 2020   current...     
-00028560: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00028570: 2020 2020 206d 696c 6c69 6e67 5f63 7572       milling_cur
-00028580: 7265 6e74 2028 666c 6f61 7429 3a20 5468  rent (float): Th
-00028590: 6520 6d69 6c6c 696e 6720 6375 7272 656e  e milling curren
-000285a0: 7420 746f 2075 7365 2c20 696e 2061 6d70  t to use, in amp
-000285b0: 732e 0a20 2020 2020 2020 2020 2020 2061  s..            a
-000285c0: 7379 6e63 6820 2862 6f6f 6c2c 206f 7074  synch (bool, opt
-000285d0: 696f 6e61 6c29 3a20 5768 6574 6865 7220  ional): Whether 
-000285e0: 746f 2072 756e 2074 6865 206d 696c 6c69  to run the milli
-000285f0: 6e67 2061 7379 6e63 6872 6f6e 6f75 736c  ng asynchronousl
-00028600: 792e 2044 6566 6175 6c74 7320 746f 2046  y. Defaults to F
-00028610: 616c 7365 2e0a 0a20 2020 2020 2020 2052  alse...        R
-00028620: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00028630: 2020 2020 4e6f 6e65 0a20 2020 2020 2020      None.       
-00028640: 2022 2222 0a20 2020 2020 2020 205f 6368   """.        _ch
-00028650: 6563 6b5f 6265 616d 2842 6561 6d54 7970  eck_beam(BeamTyp
-00028660: 652e 494f 4e2c 2073 656c 662e 7379 7374  e.ION, self.syst
-00028670: 656d 290a 2020 2020 2020 2020 7374 6174  em).        stat
-00028680: 7573 203d 2073 656c 662e 636f 6e6e 6563  us = self.connec
-00028690: 7469 6f6e 2e46 4942 2e42 6561 6d2e 4765  tion.FIB.Beam.Ge
-000286a0: 7453 7461 7475 7328 290a 2020 2020 2020  tStatus().      
-000286b0: 2020 6966 2073 7461 7475 7320 213d 2041    if status != A
-000286c0: 7574 6f6d 6174 696f 6e2e 4649 422e 4265  utomation.FIB.Be
-000286d0: 616d 2e53 7461 7475 732e 4265 616d 4f6e  am.Status.BeamOn
-000286e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000286f0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
-00028700: 422e 4265 616d 2e4f 6e28 290a 2020 2020  B.Beam.On().    
-00028710: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00028720: 696f 6e2e 4472 6177 4265 616d 2e4c 6f61  ion.DrawBeam.Loa
-00028730: 644c 6179 6572 2873 656c 662e 6c61 7965  dLayer(self.laye
-00028740: 7229 0a20 2020 2020 2020 206c 6f67 6769  r).        loggi
-00028750: 6e67 2e69 6e66 6f28 6622 7275 6e6e 696e  ng.info(f"runnin
-00028760: 6720 696f 6e20 6265 616d 206d 696c 6c69  g ion beam milli
-00028770: 6e67 206e 6f77 2e2e 2e22 290a 2020 2020  ng now...").    
-00028780: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-00028790: 696f 6e2e 4472 6177 4265 616d 2e53 7461  ion.DrawBeam.Sta
-000287a0: 7274 2829 0a20 2020 2020 2020 2073 656c  rt().        sel
-000287b0: 662e 636f 6e6e 6563 7469 6f6e 2e50 726f  f.connection.Pro
-000287c0: 6772 6573 732e 5368 6f77 280a 2020 2020  gress.Show(.    
-000287d0: 2020 2020 2020 2020 2244 7261 7742 6561          "DrawBea
-000287e0: 6d22 2c20 224c 6179 6572 2031 2069 6e20  m", "Layer 1 in 
-000287f0: 7072 6f67 7265 7373 222c 2046 616c 7365  progress", False
-00028800: 2c20 4661 6c73 652c 2030 2c20 3130 300a  , False, 0, 100.
-00028810: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00028820: 2020 7768 696c 6520 5472 7565 3a0a 2020    while True:.  
-00028830: 2020 2020 2020 2020 2020 7374 6174 7573            status
-00028840: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-00028850: 6f6e 2e44 7261 7742 6561 6d2e 4765 7453  on.DrawBeam.GetS
-00028860: 7461 7475 7328 290a 2020 2020 2020 2020  tatus().        
-00028870: 2020 2020 7275 6e6e 696e 6720 3d20 7374      running = st
-00028880: 6174 7573 5b30 5d20 3d3d 2044 4253 7461  atus[0] == DBSta
-00028890: 7475 732e 5072 6f6a 6563 744c 6f61 6465  tus.ProjectLoade
-000288a0: 6445 7870 6f73 6974 696f 6e49 6e50 726f  dExpositionInPro
-000288b0: 6772 6573 730a 2020 2020 2020 2020 2020  gress.          
-000288c0: 2020 6966 2072 756e 6e69 6e67 3a0a 2020    if running:.  
-000288d0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000288e0: 6f67 7265 7373 203d 2030 0a20 2020 2020  ogress = 0.     
-000288f0: 2020 2020 2020 2020 2020 2069 6620 7374             if st
-00028900: 6174 7573 5b31 5d20 3e20 303a 0a20 2020  atus[1] > 0:.   
-00028910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028920: 2070 726f 6772 6573 7320 3d20 6d69 6e28   progress = min(
-00028930: 3130 302c 2073 7461 7475 735b 325d 202f  100, status[2] /
-00028940: 2073 7461 7475 735b 315d 202a 2031 3030   status[1] * 100
-00028950: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028960: 2020 7072 696e 7450 726f 6772 6573 7342    printProgressB
-00028970: 6172 2870 726f 6772 6573 732c 2031 3030  ar(progress, 100
-00028980: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028990: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-000289a0: 6e2e 5072 6f67 7265 7373 2e53 6574 5065  n.Progress.SetPe
-000289b0: 7263 656e 7473 2870 726f 6772 6573 7329  rcents(progress)
-000289c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000289d0: 2074 696d 652e 736c 6565 7028 3129 0a20   time.sleep(1). 
-000289e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000289f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028a00: 2069 6620 7374 6174 7573 5b30 5d20 3d3d   if status[0] ==
-00028a10: 2044 4253 7461 7475 732e 5072 6f6a 6563   DBStatus.Projec
-00028a20: 744c 6f61 6465 6445 7870 6f73 6974 696f  tLoadedExpositio
-00028a30: 6e49 646c 653a 0a20 2020 2020 2020 2020  nIdle:.         
-00028a40: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00028a50: 5072 6f67 7265 7373 4261 7228 3130 302c  ProgressBar(100,
-00028a60: 2031 3030 2c20 7375 6666 6978 3d22 4669   100, suffix="Fi
-00028a70: 6e69 7368 6564 2229 0a20 2020 2020 2020  nished").       
-00028a80: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-00028a90: 2020 2020 2020 2020 7072 696e 7428 2920          print() 
-00028aa0: 2023 206e 6577 206c 696e 6520 6f6e 2063   # new line on c
-00028ab0: 6f6d 706c 6574 650a 2020 2020 2020 2020  omplete.        
-00028ac0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00028ad0: 5072 6f67 7265 7373 2e48 6964 6528 290a  Progress.Hide().
-00028ae0: 0a20 2020 2064 6566 2072 756e 5f6d 696c  .    def run_mil
-00028af0: 6c69 6e67 5f64 7269 6674 5f63 6f72 7265  ling_drift_corre
-00028b00: 6374 6564 2873 656c 662c 206d 696c 6c69  cted(self, milli
-00028b10: 6e67 5f63 7572 7265 6e74 3a20 666c 6f61  ng_current: floa
-00028b20: 742c 2020 0a20 2020 2020 2020 2069 6d61  t,  .        ima
-00028b30: 6765 5f73 6574 7469 6e67 733a 2049 6d61  ge_settings: Ima
-00028b40: 6765 5365 7474 696e 6773 2c20 0a20 2020  geSettings, .   
-00028b50: 2020 2020 2072 6566 5f69 6d61 6765 3a20       ref_image: 
-00028b60: 4669 6273 656d 496d 6167 652c 200a 2020  FibsemImage, .  
-00028b70: 2020 2020 2020 7265 6475 6365 645f 6172        reduced_ar
-00028b80: 6561 3a20 4669 6273 656d 5265 6374 616e  ea: FibsemRectan
-00028b90: 676c 6520 3d20 4e6f 6e65 2c0a 2020 2020  gle = None,.    
-00028ba0: 2020 2020 6173 796e 6368 3a20 626f 6f6c      asynch: bool
-00028bb0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-00028bc0: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
-00028bd0: 2020 2020 2020 2020 5275 6e20 696f 6e20          Run ion 
-00028be0: 6265 616d 206d 696c 6c69 6e67 2075 7369  beam milling usi
-00028bf0: 6e67 2074 6865 2073 7065 6369 6669 6564  ng the specified
-00028c00: 206d 696c 6c69 6e67 2063 7572 7265 6e74   milling current
-00028c10: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
-00028c20: 0a20 2020 2020 2020 2020 2020 206d 696c  .            mil
-00028c30: 6c69 6e67 5f63 7572 7265 6e74 2028 666c  ling_current (fl
-00028c40: 6f61 7429 3a20 5468 6520 6375 7272 656e  oat): The curren
-00028c50: 7420 746f 2075 7365 2066 6f72 206d 696c  t to use for mil
-00028c60: 6c69 6e67 2069 6e20 616d 7073 2e0a 2020  ling in amps..  
-00028c70: 2020 2020 2020 2020 2020 6173 796e 6368            asynch
-00028c80: 2028 626f 6f6c 2c20 6f70 7469 6f6e 616c   (bool, optional
-00028c90: 293a 2049 6620 5472 7565 2c20 7468 6520  ): If True, the 
-00028ca0: 6d69 6c6c 696e 6720 7769 6c6c 2062 6520  milling will be 
-00028cb0: 7275 6e20 6173 796e 6368 726f 6e6f 7573  run asynchronous
-00028cc0: 6c79 2e20 0a20 2020 2020 2020 2020 2020  ly. .           
-00028cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ce0: 2020 2020 2020 2020 2020 4465 6661 756c            Defaul
-00028cf0: 7473 2074 6f20 4661 6c73 652c 2069 6e20  ts to False, in 
-00028d00: 7768 6963 6820 6361 7365 2069 7420 7769  which case it wi
-00028d10: 6c6c 2072 756e 2073 796e 6368 726f 6e6f  ll run synchrono
-00028d20: 7573 6c79 2e0a 0a20 2020 2020 2020 2052  usly...        R
-00028d30: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-00028d40: 2020 2020 4e6f 6e65 0a0a 2020 2020 2020      None..      
-00028d50: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
-00028d60: 2020 2020 2020 4e6f 6e65 0a20 2020 2020        None.     
-00028d70: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
-00028d80: 6368 6563 6b5f 6265 616d 2842 6561 6d54  check_beam(BeamT
-00028d90: 7970 652e 494f 4e2c 2073 656c 662e 7379  ype.ION, self.sy
-00028da0: 7374 656d 290a 2020 2020 2020 2020 7374  stem).        st
-00028db0: 6174 7573 203d 2073 656c 662e 636f 6e6e  atus = self.conn
-00028dc0: 6563 7469 6f6e 2e46 4942 2e42 6561 6d2e  ection.FIB.Beam.
-00028dd0: 4765 7453 7461 7475 7328 290a 2020 2020  GetStatus().    
-00028de0: 2020 2020 6966 2073 7461 7475 7320 213d      if status !=
-00028df0: 2041 7574 6f6d 6174 696f 6e2e 4649 422e   Automation.FIB.
-00028e00: 4265 616d 2e53 7461 7475 732e 4265 616d  Beam.Status.Beam
-00028e10: 4f6e 3a0a 2020 2020 2020 2020 2020 2020  On:.            
-00028e20: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00028e30: 4649 422e 4265 616d 2e4f 6e28 290a 2020  FIB.Beam.On().  
-00028e40: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00028e50: 6374 696f 6e2e 4472 6177 4265 616d 2e4c  ction.DrawBeam.L
-00028e60: 6f61 644c 6179 6572 2873 656c 662e 6c61  oadLayer(self.la
-00028e70: 7965 7229 0a20 2020 2020 2020 206c 6f67  yer).        log
-00028e80: 6769 6e67 2e69 6e66 6f28 6622 7275 6e6e  ging.info(f"runn
-00028e90: 696e 6720 696f 6e20 6265 616d 206d 696c  ing ion beam mil
-00028ea0: 6c69 6e67 206e 6f77 2e2e 2e22 290a 2020  ling now...").  
-00028eb0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-00028ec0: 6374 696f 6e2e 4472 6177 4265 616d 2e53  ction.DrawBeam.S
-00028ed0: 7461 7274 2829 0a20 2020 2020 2020 2073  tart().        s
-00028ee0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e50  elf.connection.P
-00028ef0: 726f 6772 6573 732e 5368 6f77 280a 2020  rogress.Show(.  
-00028f00: 2020 2020 2020 2020 2020 2244 7261 7742            "DrawB
-00028f10: 6561 6d22 2c20 224c 6179 6572 2031 2069  eam", "Layer 1 i
-00028f20: 6e20 7072 6f67 7265 7373 222c 2046 616c  n progress", Fal
-00028f30: 7365 2c20 4661 6c73 652c 2030 2c20 3130  se, False, 0, 10
-00028f40: 300a 2020 2020 2020 2020 290a 2020 2020  0.        ).    
-00028f50: 2020 2020 6672 6f6d 2066 6962 7365 6d20      from fibsem 
-00028f60: 696d 706f 7274 2061 6c69 676e 6d65 6e74  import alignment
-00028f70: 0a20 2020 2020 2020 2077 6869 6c65 2054  .        while T
-00028f80: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-00028f90: 2073 7461 7475 7320 3d20 7365 6c66 2e63   status = self.c
-00028fa0: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
-00028fb0: 616d 2e47 6574 5374 6174 7573 2829 0a20  am.GetStatus(). 
-00028fc0: 2020 2020 2020 2020 2020 2072 756e 6e69             runni
-00028fd0: 6e67 203d 2073 7461 7475 735b 305d 203d  ng = status[0] =
-00028fe0: 3d20 4442 5374 6174 7573 2e50 726f 6a65  = DBStatus.Proje
-00028ff0: 6374 4c6f 6164 6564 4578 706f 7369 7469  ctLoadedExpositi
-00029000: 6f6e 496e 5072 6f67 7265 7373 0a20 2020  onInProgress.   
-00029010: 2020 2020 2020 2020 2069 6620 7275 6e6e           if runn
-00029020: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00029030: 2020 2020 2070 726f 6772 6573 7320 3d20       progress = 
-00029040: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00029050: 2020 6966 2073 7461 7475 735b 315d 203e    if status[1] >
-00029060: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00029070: 2020 2020 2020 2020 7072 6f67 7265 7373          progress
-00029080: 203d 206d 696e 2831 3030 2c20 7374 6174   = min(100, stat
-00029090: 7573 5b32 5d20 2f20 7374 6174 7573 5b31  us[2] / status[1
-000290a0: 5d20 2a20 3130 3029 0a20 2020 2020 2020  ] * 100).       
-000290b0: 2020 2020 2020 2020 2070 7269 6e74 5072           printPr
-000290c0: 6f67 7265 7373 4261 7228 7072 6f67 7265  ogressBar(progre
-000290d0: 7373 2c20 3130 3029 0a20 2020 2020 2020  ss, 100).       
-000290e0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-000290f0: 6e6e 6563 7469 6f6e 2e50 726f 6772 6573  nnection.Progres
-00029100: 732e 5365 7450 6572 6365 6e74 7328 7072  s.SetPercents(pr
-00029110: 6f67 7265 7373 290a 2020 2020 2020 2020  ogress).        
-00029120: 2020 2020 2020 2020 7374 6174 7573 203d          status =
-00029130: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-00029140: 2e44 7261 7742 6561 6d2e 4765 7453 7461  .DrawBeam.GetSta
-00029150: 7475 7328 290a 2020 2020 2020 2020 2020  tus().          
-00029160: 2020 2020 2020 6966 2073 7461 7475 735b        if status[
-00029170: 305d 203d 3d20 4442 5374 6174 7573 2e50  0] == DBStatus.P
-00029180: 726f 6a65 6374 4c6f 6164 6564 4578 706f  rojectLoadedExpo
-00029190: 7369 7469 6f6e 496e 5072 6f67 7265 7373  sitionInProgress
-000291a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000291b0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-000291c0: 6374 696f 6e2e 4472 6177 4265 616d 2e50  ction.DrawBeam.P
-000291d0: 6175 7365 2829 0a20 2020 2020 2020 2020  ause().         
-000291e0: 2020 2020 2020 2065 6c69 6620 7374 6174         elif stat
-000291f0: 7573 5b30 5d20 3d3d 2044 4253 7461 7475  us[0] == DBStatu
-00029200: 732e 5072 6f6a 6563 744c 6f61 6465 6445  s.ProjectLoadedE
-00029210: 7870 6f73 6974 696f 6e49 646c 653a 0a20  xpositionIdle:. 
-00029220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029230: 2020 2070 7269 6e74 5072 6f67 7265 7373     printProgress
-00029240: 4261 7228 3130 302c 2031 3030 2c20 7375  Bar(100, 100, su
-00029250: 6666 6978 3d22 4669 6e69 7368 6564 2229  ffix="Finished")
-00029260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029270: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00029280: 7469 6f6e 2e44 7261 7742 6561 6d2e 5374  tion.DrawBeam.St
-00029290: 6f70 2829 0a20 2020 2020 2020 2020 2020  op().           
-000292a0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-000292b0: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
-000292c0: 6d2e 556e 6c6f 6164 4c61 7965 7228 290a  m.UnloadLayer().
-000292d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292e0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-000292f0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00029300: 672e 696e 666f 2822 4472 6966 7420 636f  g.info("Drift co
-00029310: 7272 6563 7469 6f6e 2069 6e20 7072 6f67  rrection in prog
-00029320: 7265 7373 2e2e 2e22 290a 2020 2020 2020  ress...").      
-00029330: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-00029340: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
-00029350: 7065 203d 2042 6561 6d54 7970 652e 494f  pe = BeamType.IO
-00029360: 4e0a 2020 2020 2020 2020 2020 2020 2020  N.              
-00029370: 2020 616c 6967 6e6d 656e 742e 6265 616d    alignment.beam
-00029380: 5f73 6869 6674 5f61 6c69 676e 6d65 6e74  _shift_alignment
-00029390: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000293a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000293b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293c0: 696d 6167 655f 7365 7474 696e 6773 2c0a  image_settings,.
-000293d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293e0: 2020 2020 7265 665f 696d 6167 652c 0a20      ref_image,. 
-000293f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029400: 2020 2072 6564 7563 6564 5f61 7265 612c     reduced_area,
-00029410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029420: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00029430: 2020 2074 696d 652e 736c 6565 7028 3129     time.sleep(1)
-00029440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029450: 2073 7461 7475 7320 3d20 7365 6c66 2e63   status = self.c
-00029460: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
-00029470: 616d 2e47 6574 5374 6174 7573 2829 0a20  am.GetStatus(). 
-00029480: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00029490: 6620 7374 6174 7573 5b30 5d20 3d3d 2044  f status[0] == D
-000294a0: 4253 7461 7475 732e 5072 6f6a 6563 744c  BStatus.ProjectL
-000294b0: 6f61 6465 6445 7870 6f73 6974 696f 6e50  oadedExpositionP
-000294c0: 6175 7365 6420 3a0a 2020 2020 2020 2020  aused :.        
-000294d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000294e0: 2e63 6f6e 6e65 6374 696f 6e2e 4472 6177  .connection.Draw
-000294f0: 4265 616d 2e52 6573 756d 6528 290a 2020  Beam.Resume().  
-00029500: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00029510: 6767 696e 672e 696e 666f 2822 4472 6966  gging.info("Drif
-00029520: 7420 636f 7272 6563 7469 6f6e 2063 6f6d  t correction com
-00029530: 706c 6574 652e 2229 0a20 2020 2020 2020  plete.").       
-00029540: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
-00029550: 6565 7028 3529 0a20 2020 2020 2020 2020  eep(5).         
-00029560: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00029570: 2020 2020 2020 2020 2069 6620 7374 6174           if stat
-00029580: 7573 5b30 5d20 3d3d 2044 4253 7461 7475  us[0] == DBStatu
-00029590: 732e 5072 6f6a 6563 744c 6f61 6465 6445  s.ProjectLoadedE
-000295a0: 7870 6f73 6974 696f 6e49 646c 653a 0a20  xpositionIdle:. 
-000295b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295c0: 2020 2070 7269 6e74 5072 6f67 7265 7373     printProgress
-000295d0: 4261 7228 3130 302c 2031 3030 2c20 7375  Bar(100, 100, su
-000295e0: 6666 6978 3d22 4669 6e69 7368 6564 2229  ffix="Finished")
-000295f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029600: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-00029610: 7469 6f6e 2e44 7261 7742 6561 6d2e 5374  tion.DrawBeam.St
-00029620: 6f70 2829 0a20 2020 2020 2020 2020 2020  op().           
-00029630: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-00029640: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
-00029650: 6d2e 556e 6c6f 6164 4c61 7965 7228 290a  m.UnloadLayer().
-00029660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029670: 6272 6561 6b0a 0a20 2020 2020 2020 2070  break..        p
-00029680: 7269 6e74 2829 2020 2320 6e65 7720 6c69  rint()  # new li
-00029690: 6e65 206f 6e20 636f 6d70 6c65 7465 0a20  ne on complete. 
-000296a0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-000296b0: 6563 7469 6f6e 2e50 726f 6772 6573 732e  ection.Progress.
-000296c0: 4869 6465 2829 0a0a 2020 2020 6465 6620  Hide()..    def 
-000296d0: 6669 6e69 7368 5f6d 696c 6c69 6e67 2873  finish_milling(s
-000296e0: 656c 662c 2069 6d61 6769 6e67 5f63 7572  elf, imaging_cur
-000296f0: 7265 6e74 3a20 666c 6f61 7429 3a0a 2020  rent: float):.  
-00029700: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00029710: 2020 4669 6e61 6c69 7365 7320 7468 6520    Finalises the 
-00029720: 6d69 6c6c 696e 6720 7072 6f63 6573 7320  milling process 
-00029730: 6279 2063 6c65 6172 696e 6720 7468 6520  by clearing the 
-00029740: 6d69 6372 6f73 636f 7065 206f 6620 616e  microscope of an
-00029750: 7920 7061 7474 6572 6e73 2061 6e64 2072  y patterns and r
-00029760: 6574 7572 6e69 6e67 2074 6865 2063 7572  eturning the cur
-00029770: 7265 6e74 2074 6f20 7468 6520 696d 6167  rent to the imag
-00029780: 696e 6720 6375 7272 656e 742e 0a0a 2020  ing current...  
-00029790: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-000297a0: 2020 2020 2020 2020 696d 6167 696e 675f          imaging_
-000297b0: 6375 7272 656e 7420 2866 6c6f 6174 293a  current (float):
-000297c0: 2054 6865 2063 7572 7265 6e74 2074 6f20   The current to 
-000297d0: 7573 6520 666f 7220 696d 6167 696e 6720  use for imaging 
-000297e0: 696e 2061 6d70 732e 0a20 2020 2020 2020  in amps..       
-000297f0: 2023 2022 2222 0a20 2020 2020 2020 2074   # """.        t
-00029800: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00029810: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00029820: 4649 422e 5072 6573 6574 2e41 6374 6976  FIB.Preset.Activ
-00029830: 6174 6528 2233 3020 6b65 563b 2031 3530  ate("30 keV; 150
-00029840: 2070 4122 290a 2020 2020 2020 2020 2020   pA").          
-00029850: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00029860: 6e2e 4472 6177 4265 616d 2e55 6e6c 6f61  n.DrawBeam.Unloa
-00029870: 644c 6179 6572 2829 0a20 2020 2020 2020  dLayer().       
-00029880: 2020 2020 2070 7269 6e74 2822 6865 6c6c       print("hell
-00029890: 6f22 290a 2020 2020 2020 2020 6578 6365  o").        exce
-000298a0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-000298b0: 7061 7373 0a20 2020 200a 2020 2020 6465  pass.    .    de
-000298c0: 6620 6573 7469 6d61 7465 5f6d 696c 6c69  f estimate_milli
-000298d0: 6e67 5f74 696d 6528 7365 6c66 2c70 6174  ng_time(self,pat
-000298e0: 7465 726e 7329 3a0a 2020 2020 2020 2020  terns):.        
-000298f0: 0a20 2020 2020 2020 2023 206c 6f61 6420  .        # load 
-00029900: 616e 6420 756e 6c6f 6164 206c 6179 6572  and unload layer
-00029910: 2074 6f20 6368 6563 6b20 7469 6d65 0a20   to check time. 
-00029920: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-00029930: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
-00029940: 4c6f 6164 4c61 7965 7228 7365 6c66 2e6c  LoadLayer(self.l
-00029950: 6179 6572 290a 2020 2020 2020 2020 6573  ayer).        es
-00029960: 745f 7469 6d65 203d 2073 656c 662e 636f  t_time = self.co
-00029970: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
-00029980: 6d2e 4573 7469 6d61 7465 5469 6d65 2829  m.EstimateTime()
-00029990: 200a 2020 2020 2020 2020 7365 6c66 2e63   .        self.c
-000299a0: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
-000299b0: 616d 2e55 6e6c 6f61 644c 6179 6572 2829  am.UnloadLayer()
-000299c0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000299d0: 2065 7374 5f74 696d 650a 0a20 2020 2064   est_time..    d
-000299e0: 6566 2064 7261 775f 7265 6374 616e 676c  ef draw_rectangl
-000299f0: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-00029a00: 0a20 2020 2020 2020 2070 6174 7465 726e  .        pattern
-00029a10: 5f73 6574 7469 6e67 733a 2046 6962 7365  _settings: Fibse
-00029a20: 6d52 6563 7461 6e67 6c65 5365 7474 696e  mRectangleSettin
-00029a30: 6773 2c0a 2020 2020 293a 0a20 2020 2020  gs,.    ):.     
-00029a40: 2020 2022 2222 0a20 2020 2020 2020 2044     """.        D
-00029a50: 7261 7773 2061 2072 6563 7461 6e67 6c65  raws a rectangle
-00029a60: 2070 6174 7465 726e 2075 7369 6e67 2074   pattern using t
-00029a70: 6865 2063 7572 7265 6e74 2069 6f6e 2062  he current ion b
-00029a80: 6561 6d2e 0a0a 2020 2020 2020 2020 4172  eam...        Ar
-00029a90: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00029aa0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-00029ab0: 2028 4669 6273 656d 5265 6374 616e 676c   (FibsemRectangl
-00029ac0: 6553 6574 7469 6e67 7329 3a20 7468 6520  eSettings): the 
-00029ad0: 7365 7474 696e 6773 2066 6f72 2074 6865  settings for the
-00029ae0: 2070 6174 7465 726e 2074 6f20 6472 6177   pattern to draw
-00029af0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-00029b00: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00029b10: 5061 7474 6572 6e3a 2074 6865 2063 7265  Pattern: the cre
-00029b20: 6174 6564 2070 6174 7465 726e 2e0a 0a20  ated pattern... 
-00029b30: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
-00029b40: 2020 2020 2020 2020 2020 2041 7574 6f6d             Autom
-00029b50: 6174 696f 6e45 7272 6f72 3a20 6966 2061  ationError: if a
-00029b60: 6e20 6572 726f 7220 6f63 6375 7273 2077  n error occurs w
-00029b70: 6869 6c65 2063 7265 6174 696e 6720 7468  hile creating th
-00029b80: 6520 7061 7474 6572 6e2e 0a0a 2020 2020  e pattern...    
-00029b90: 2020 2020 4e6f 7465 733a 0a20 2020 2020      Notes:.     
-00029ba0: 2020 2020 2020 2054 6865 2072 6563 7461         The recta
-00029bb0: 6e67 6c65 2070 6174 7465 726e 2077 696c  ngle pattern wil
-00029bc0: 6c20 6265 2063 656e 7465 7265 6420 6174  l be centered at
-00029bd0: 2074 6865 2073 7065 6369 6669 6564 2063   the specified c
-00029be0: 6f6f 7264 696e 6174 6573 2028 6365 6e74  oordinates (cent
-00029bf0: 7265 5f78 2c20 6365 6e74 7265 5f79 2920  re_x, centre_y) 
-00029c00: 7769 7468 2074 6865 2073 7065 6369 6669  with the specifi
-00029c10: 6564 0a20 2020 2020 2020 2020 2020 2077  ed.            w
-00029c20: 6964 7468 2c20 6865 6967 6874 2061 6e64  idth, height and
-00029c30: 2064 6570 7468 2028 696e 206e 6d29 2e20   depth (in nm). 
-00029c40: 4966 2074 6865 2063 6c65 616e 696e 675f  If the cleaning_
-00029c50: 6372 6f73 735f 7365 6374 696f 6e20 6174  cross_section at
-00029c60: 7472 6962 7574 6520 6f66 2070 6174 7465  tribute of patte
-00029c70: 726e 5f73 6574 7469 6e67 7320 6973 2054  rn_settings is T
-00029c80: 7275 652c 2061 0a20 2020 2020 2020 2020  rue, a.         
-00029c90: 2020 2063 6c65 616e 696e 6720 6372 6f73     cleaning cros
-00029ca0: 7320 7365 6374 696f 6e20 7061 7474 6572  s section patter
-00029cb0: 6e20 7769 6c6c 2062 6520 6372 6561 7465  n will be create
-00029cc0: 6420 696e 7374 6561 6420 6f66 2061 2072  d instead of a r
-00029cd0: 6563 7461 6e67 6c65 2070 6174 7465 726e  ectangle pattern
-00029ce0: 2e0a 0a20 2020 2020 2020 2020 2020 2054  ...            T
-00029cf0: 6865 2070 6174 7465 726e 2077 696c 6c20  he pattern will 
-00029d00: 6265 2072 6f74 6174 6564 2062 7920 7468  be rotated by th
-00029d10: 6520 616e 676c 6520 7370 6563 6966 6965  e angle specifie
-00029d20: 6420 696e 2074 6865 2072 6f74 6174 696f  d in the rotatio
-00029d30: 6e20 6174 7472 6962 7574 6520 6f66 2070  n attribute of p
-00029d40: 6174 7465 726e 5f73 6574 7469 6e67 7320  attern_settings 
-00029d50: 2869 6e20 6465 6772 6565 7329 0a20 2020  (in degrees).   
-00029d60: 2020 2020 2020 2020 2061 6e64 2073 6361           and sca
-00029d70: 6e6e 6564 2069 6e20 7468 6520 6469 7265  nned in the dire
-00029d80: 6374 696f 6e20 7370 6563 6966 6965 6420  ction specified 
-00029d90: 696e 2074 6865 2073 6361 6e5f 6469 7265  in the scan_dire
-00029da0: 6374 696f 6e20 6174 7472 6962 7574 6520  ction attribute 
-00029db0: 6f66 2070 6174 7465 726e 5f73 6574 7469  of pattern_setti
-00029dc0: 6e67 7320 2827 686f 7269 7a6f 6e74 616c  ngs ('horizontal
-00029dd0: 2720 6f72 0a20 2020 2020 2020 2020 2020  ' or.           
-00029de0: 2027 7665 7274 6963 616c 2729 2e0a 0a20   'vertical')... 
-00029df0: 2020 2020 2020 2020 2020 2054 6865 2063             The c
-00029e00: 7265 6174 6564 2070 6174 7465 726e 2063  reated pattern c
-00029e10: 616e 2062 6520 6164 6465 6420 746f 2074  an be added to t
-00029e20: 6865 2070 6174 7465 726e 696e 6720 7175  he patterning qu
-00029e30: 6575 6520 616e 6420 6578 6563 7574 6564  eue and executed
-00029e40: 2075 7369 6e67 2074 6865 206c 6179 6572   using the layer
-00029e50: 206d 6574 686f 6473 2069 6e20 4175 746f   methods in Auto
-00029e60: 6d61 7469 6f6e 2e0a 2020 2020 2020 2020  mation..        
-00029e70: 2222 220a 2020 2020 2020 2020 6365 6e74  """.        cent
-00029e80: 7265 5f78 203d 2070 6174 7465 726e 5f73  re_x = pattern_s
-00029e90: 6574 7469 6e67 732e 6365 6e74 7265 5f78  ettings.centre_x
-00029ea0: 0a20 2020 2020 2020 2063 656e 7472 655f  .        centre_
-00029eb0: 7920 3d20 7061 7474 6572 6e5f 7365 7474  y = pattern_sett
-00029ec0: 696e 6773 2e63 656e 7472 655f 790a 2020  ings.centre_y.  
-00029ed0: 2020 2020 2020 6465 7074 6820 3d20 7061        depth = pa
-00029ee0: 7474 6572 6e5f 7365 7474 696e 6773 2e64  ttern_settings.d
-00029ef0: 6570 7468 0a20 2020 2020 2020 2077 6964  epth.        wid
-00029f00: 7468 203d 2070 6174 7465 726e 5f73 6574  th = pattern_set
-00029f10: 7469 6e67 732e 7769 6474 680a 2020 2020  tings.width.    
-00029f20: 2020 2020 6865 6967 6874 203d 2070 6174      height = pat
-00029f30: 7465 726e 5f73 6574 7469 6e67 732e 6865  tern_settings.he
-00029f40: 6967 6874 0a20 2020 2020 2020 2072 6f74  ight.        rot
-00029f50: 6174 696f 6e20 3d20 7061 7474 6572 6e5f  ation = pattern_
-00029f60: 7365 7474 696e 6773 2e72 6f74 6174 696f  settings.rotatio
-00029f70: 6e20 2a20 636f 6e73 7461 6e74 732e 5241  n * constants.RA
-00029f80: 4449 414e 535f 544f 5f44 4547 5245 4553  DIANS_TO_DEGREES
-00029f90: 2023 2043 4845 434b 2055 4e49 5453 2028   # CHECK UNITS (
-00029fa0: 5445 5343 414e 2054 616b 6573 2044 6567  TESCAN Takes Deg
-00029fb0: 7265 6573 290a 2020 2020 2020 2020 7061  rees).        pa
-00029fc0: 7468 7320 3d20 7365 6c66 2e67 6574 5f61  ths = self.get_a
-00029fd0: 7661 696c 6162 6c65 5f76 616c 7565 7328  vailable_values(
-00029fe0: 6b65 793d 2273 6361 6e5f 6469 7265 6374  key="scan_direct
-00029ff0: 696f 6e22 290a 2020 2020 2020 2020 7061  ion").        pa
-0002a000: 7373 6573 203d 2070 6174 7465 726e 5f73  sses = pattern_s
-0002a010: 6574 7469 6e67 732e 7061 7373 6573 2069  ettings.passes i
-0002a020: 6620 7061 7474 6572 6e5f 7365 7474 696e  f pattern_settin
-0002a030: 6773 2e70 6173 7365 7320 6973 206e 6f74  gs.passes is not
-0002a040: 204e 6f6e 6520 656c 7365 2031 2e30 0a20   None else 1.0. 
-0002a050: 2020 2020 2020 2069 6620 7061 7474 6572         if patter
-0002a060: 6e5f 7365 7474 696e 6773 2e73 6361 6e5f  n_settings.scan_
-0002a070: 6469 7265 6374 696f 6e20 696e 2070 6174  direction in pat
-0002a080: 6873 3a0a 2020 2020 2020 2020 2020 2020  hs:.            
-0002a090: 7061 7468 203d 2070 6174 7465 726e 5f73  path = pattern_s
-0002a0a0: 6574 7469 6e67 732e 7363 616e 5f64 6972  ettings.scan_dir
-0002a0b0: 6563 7469 6f6e 0a20 2020 2020 2020 2065  ection.        e
-0002a0c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002a0d0: 2070 6174 6820 3d20 2246 6c79 6261 636b   path = "Flyback
-0002a0e0: 220a 2020 2020 2020 2020 2020 2020 6c6f  ".            lo
-0002a0f0: 6767 696e 672e 696e 666f 2866 2253 6361  gging.info(f"Sca
-0002a100: 6e20 6469 7265 6374 696f 6e20 7b70 6174  n direction {pat
-0002a110: 7465 726e 5f73 6574 7469 6e67 732e 7363  tern_settings.sc
-0002a120: 616e 5f64 6972 6563 7469 6f6e 7d20 6e6f  an_direction} no
-0002a130: 7420 7375 7070 6f72 7465 642e 2055 7369  t supported. Usi
-0002a140: 6e67 2046 6c79 6261 636b 2069 6e73 7465  ng Flyback inste
-0002a150: 6164 2e22 290a 2020 2020 2020 2020 2020  ad.").          
-0002a160: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0002a170: 2253 7570 706f 7274 6564 2073 6361 6e20  "Supported scan 
-0002a180: 6469 7265 6374 696f 6e73 2061 7265 3a20  directions are: 
-0002a190: 466c 7962 6163 6b2c 2052 4c45 2c20 5370  Flyback, RLE, Sp
-0002a1a0: 6972 616c 496e 7369 6465 4f75 742c 2053  iralInsideOut, S
-0002a1b0: 7069 7261 6c4f 7574 7369 6465 496e 2c20  piralOutsideIn, 
-0002a1c0: 5a69 675a 6167 2229 0a20 2020 2020 2020  ZigZag").       
-0002a1d0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002a1e0: 2e44 7261 7742 6561 6d2e 5363 616e 6e69  .DrawBeam.Scanni
-0002a1f0: 6e67 5061 7468 203d 2070 6174 7465 726e  ngPath = pattern
-0002a200: 5f73 6574 7469 6e67 732e 7363 616e 5f64  _settings.scan_d
-0002a210: 6972 6563 7469 6f6e 0a0a 2020 2020 2020  irection..      
-0002a220: 2020 6966 2070 6174 7465 726e 5f73 6574    if pattern_set
-0002a230: 7469 6e67 732e 636c 6561 6e69 6e67 5f63  tings.cleaning_c
-0002a240: 726f 7373 5f73 6563 7469 6f6e 3a0a 2020  ross_section:.  
-0002a250: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0002a260: 6179 6572 2e61 6464 5265 6374 616e 676c  ayer.addRectangl
-0002a270: 6550 6f6c 6973 6828 0a20 2020 2020 2020  ePolish(.       
-0002a280: 2020 2020 2020 2020 2043 656e 7465 7258           CenterX
-0002a290: 3d63 656e 7472 655f 782c 0a20 2020 2020  =centre_x,.     
-0002a2a0: 2020 2020 2020 2020 2020 2043 656e 7465             Cente
-0002a2b0: 7259 3d63 656e 7472 655f 792c 0a20 2020  rY=centre_y,.   
-0002a2c0: 2020 2020 2020 2020 2020 2020 2044 6570               Dep
-0002a2d0: 7468 3d64 6570 7468 2c0a 2020 2020 2020  th=depth,.      
-0002a2e0: 2020 2020 2020 2020 2020 4465 7074 6855            DepthU
-0002a2f0: 6e69 743d 276d 272c 0a20 2020 2020 2020  nit='m',.       
-0002a300: 2020 2020 2020 2020 2057 6964 7468 3d77           Width=w
-0002a310: 6964 7468 2c0a 2020 2020 2020 2020 2020  idth,.          
-0002a320: 2020 2020 2020 4865 6967 6874 3d68 6569        Height=hei
-0002a330: 6768 742c 0a20 2020 2020 2020 2020 2020  ght,.           
-0002a340: 2020 2020 2041 6e67 6c65 3d72 6f74 6174       Angle=rotat
-0002a350: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-0002a360: 2020 2020 2053 6361 6e6e 696e 6750 6174       ScanningPat
-0002a370: 683d 7061 7468 2c0a 2020 2020 2020 2020  h=path,.        
-0002a380: 2020 2020 2020 2020 4578 706f 7369 7469          Expositi
-0002a390: 6f6e 4661 6374 6f72 3d70 6173 7365 730a  onFactor=passes.
-0002a3a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002a3b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002a3c0: 2020 2020 2020 2020 7365 6c66 2e6c 6179          self.lay
-0002a3d0: 6572 2e61 6464 5265 6374 616e 676c 6546  er.addRectangleF
-0002a3e0: 696c 6c65 6428 0a20 2020 2020 2020 2020  illed(.         
-0002a3f0: 2020 2020 2020 2043 656e 7465 7258 3d63         CenterX=c
-0002a400: 656e 7472 655f 782c 0a20 2020 2020 2020  entre_x,.       
-0002a410: 2020 2020 2020 2020 2043 656e 7465 7259           CenterY
-0002a420: 3d63 656e 7472 655f 792c 0a20 2020 2020  =centre_y,.     
-0002a430: 2020 2020 2020 2020 2020 2044 6570 7468             Depth
-0002a440: 3d64 6570 7468 2c0a 2020 2020 2020 2020  =depth,.        
-0002a450: 2020 2020 2020 2020 4465 7074 6855 6e69          DepthUni
-0002a460: 743d 276d 272c 0a20 2020 2020 2020 2020  t='m',.         
-0002a470: 2020 2020 2020 2057 6964 7468 3d77 6964         Width=wid
-0002a480: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-0002a490: 2020 2020 4865 6967 6874 3d68 6569 6768      Height=heigh
-0002a4a0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0002a4b0: 2020 2041 6e67 6c65 3d72 6f74 6174 696f     Angle=rotatio
-0002a4c0: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0002a4d0: 2020 2053 6361 6e6e 696e 6750 6174 683d     ScanningPath=
-0002a4e0: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0002a4f0: 2020 2020 2020 4578 706f 7369 7469 6f6e        Exposition
-0002a500: 4661 6374 6f72 3d70 6173 7365 730a 2020  Factor=passes.  
-0002a510: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0002a520: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
-0002a530: 656c 662e 6c61 7965 720a 2020 2020 2020  elf.layer.      
-0002a540: 2020 0a20 2020 2020 2020 2072 6574 7572    .        retur
-0002a550: 6e20 7061 7474 6572 6e0a 0a20 2020 2064  n pattern..    d
-0002a560: 6566 2064 7261 775f 6c69 6e65 2873 656c  ef draw_line(sel
-0002a570: 662c 2070 6174 7465 726e 5f73 6574 7469  f, pattern_setti
-0002a580: 6e67 733a 2046 6962 7365 6d4c 696e 6553  ngs: FibsemLineS
-0002a590: 6574 7469 6e67 7329 3a0a 2020 2020 2020  ettings):.      
-0002a5a0: 2020 2222 220a 2020 2020 2020 2020 4472    """.        Dr
-0002a5b0: 6177 7320 6120 6c69 6e65 2070 6174 7465  aws a line patte
-0002a5c0: 726e 206f 6e20 7468 6520 6375 7272 656e  rn on the curren
-0002a5d0: 7420 696d 6167 696e 6720 7669 6577 206f  t imaging view o
-0002a5e0: 6620 7468 6520 6d69 6372 6f73 636f 7065  f the microscope
-0002a5f0: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
-0002a600: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-0002a610: 7465 726e 5f73 6574 7469 6e67 7320 2846  tern_settings (F
-0002a620: 6962 7365 6d4c 696e 6553 6574 7469 6e67  ibsemLineSetting
-0002a630: 7329 3a20 4120 6461 7461 2063 6c61 7373  s): A data class
-0002a640: 206f 626a 6563 7420 7370 6563 6966 7969   object specifyi
-0002a650: 6e67 2074 6865 2070 6174 7465 726e 2070  ng the pattern p
-0002a660: 6172 616d 6574 6572 732c 0a20 2020 2020  arameters,.     
-0002a670: 2020 2020 2020 2020 2020 2069 6e63 6c75             inclu
-0002a680: 6469 6e67 2074 6865 2073 7461 7274 2061  ding the start a
-0002a690: 6e64 2065 6e64 2070 6f69 6e74 732c 2061  nd end points, a
-0002a6a0: 6e64 2074 6865 2064 6570 7468 206f 6620  nd the depth of 
-0002a6b0: 7468 6520 7061 7474 6572 6e2e 0a0a 2020  the pattern...  
-0002a6c0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
-0002a6d0: 2020 2020 2020 2020 2020 204c 696e 6550             LineP
-0002a6e0: 6174 7465 726e 3a20 4120 6c69 6e65 2070  attern: A line p
-0002a6f0: 6174 7465 726e 206f 626a 6563 742c 2077  attern object, w
-0002a700: 6869 6368 2063 616e 2062 6520 7573 6564  hich can be used
-0002a710: 2074 6f20 636f 6e66 6967 7572 6520 6675   to configure fu
-0002a720: 7274 6865 7220 7072 6f70 6572 7469 6573  rther properties
-0002a730: 206f 7220 746f 2061 6464 2074 6865 0a20   or to add the. 
-0002a740: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002a750: 6174 7465 726e 2074 6f20 7468 6520 6d69  attern to the mi
-0002a760: 6c6c 696e 6720 6c69 7374 2e0a 2020 2020  lling list..    
-0002a770: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002a780: 7374 6172 745f 7820 3d20 7061 7474 6572  start_x = patter
-0002a790: 6e5f 7365 7474 696e 6773 2e73 7461 7274  n_settings.start
-0002a7a0: 5f78 0a20 2020 2020 2020 2073 7461 7274  _x.        start
-0002a7b0: 5f79 203d 2070 6174 7465 726e 5f73 6574  _y = pattern_set
-0002a7c0: 7469 6e67 732e 7374 6172 745f 790a 2020  tings.start_y.  
-0002a7d0: 2020 2020 2020 656e 645f 7820 3d20 7061        end_x = pa
-0002a7e0: 7474 6572 6e5f 7365 7474 696e 6773 2e65  ttern_settings.e
-0002a7f0: 6e64 5f78 0a20 2020 2020 2020 2065 6e64  nd_x.        end
-0002a800: 5f79 203d 2070 6174 7465 726e 5f73 6574  _y = pattern_set
-0002a810: 7469 6e67 732e 656e 645f 790a 2020 2020  tings.end_y.    
-0002a820: 2020 2020 6465 7074 6820 3d20 7061 7474      depth = patt
-0002a830: 6572 6e5f 7365 7474 696e 6773 2e64 6570  ern_settings.dep
-0002a840: 7468 0a0a 2020 2020 2020 2020 7365 6c66  th..        self
-0002a850: 2e6c 6179 6572 2e61 6464 4c69 6e65 280a  .layer.addLine(.
-0002a860: 2020 2020 2020 2020 2020 2020 4265 6769              Begi
-0002a870: 6e58 3d73 7461 7274 5f78 2c20 4265 6769  nX=start_x, Begi
-0002a880: 6e59 3d73 7461 7274 5f79 2c20 456e 6458  nY=start_y, EndX
-0002a890: 3d65 6e64 5f78 2c20 456e 6459 3d65 6e64  =end_x, EndY=end
-0002a8a0: 5f79 2c20 4465 7074 683d 6465 7074 682c  _y, Depth=depth,
-0002a8b0: 2044 6570 7468 556e 6974 3d27 6d27 2c0a   DepthUnit='m',.
-0002a8c0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0002a8d0: 2020 2070 6174 7465 726e 203d 2073 656c     pattern = sel
-0002a8e0: 662e 6c61 7965 720a 2020 2020 2020 2020  f.layer.        
-0002a8f0: 7265 7475 726e 2070 6174 7465 726e 0a0a  return pattern..
-0002a900: 2020 2020 6465 6620 6472 6177 5f63 6972      def draw_cir
-0002a910: 636c 6528 7365 6c66 2c20 7061 7474 6572  cle(self, patter
-0002a920: 6e5f 7365 7474 696e 6773 3a20 4669 6273  n_settings: Fibs
-0002a930: 656d 4369 7263 6c65 5365 7474 696e 6773  emCircleSettings
-0002a940: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-0002a950: 2020 2020 2020 2044 7261 7773 2061 2063         Draws a c
-0002a960: 6972 636c 6520 7061 7474 6572 6e20 6f6e  ircle pattern on
-0002a970: 2074 6865 2063 7572 7265 6e74 2069 6d61   the current ima
-0002a980: 6769 6e67 2076 6965 7720 6f66 2074 6865  ging view of the
-0002a990: 206d 6963 726f 7363 6f70 652e 0a0a 2020   microscope...  
-0002a9a0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-0002a9b0: 2020 2020 2020 2020 7061 7474 6572 6e5f          pattern_
-0002a9c0: 7365 7474 696e 6773 2028 4669 6273 656d  settings (Fibsem
-0002a9d0: 4369 7263 6c65 5365 7474 696e 6773 293a  CircleSettings):
-0002a9e0: 2041 2064 6174 6120 636c 6173 7320 6f62   A data class ob
-0002a9f0: 6a65 6374 2073 7065 6369 6679 696e 6720  ject specifying 
-0002aa00: 7468 6520 7061 7474 6572 6e20 7061 7261  the pattern para
-0002aa10: 6d65 7465 7273 2c0a 2020 2020 2020 2020  meters,.        
-0002aa20: 2020 2020 2020 2020 696e 636c 7564 696e          includin
-0002aa30: 6720 7468 6520 6365 6e74 7265 2070 6f69  g the centre poi
-0002aa40: 6e74 2c20 7261 6469 7573 2061 6e64 2064  nt, radius and d
-0002aa50: 6570 7468 206f 6620 7468 6520 7061 7474  epth of the patt
-0002aa60: 6572 6e2e 0a0a 2020 2020 2020 2020 5265  ern...        Re
-0002aa70: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
-0002aa80: 2020 2043 6972 636c 6550 6174 7465 726e     CirclePattern
-0002aa90: 3a20 4120 6369 7263 6c65 2070 6174 7465  : A circle patte
-0002aaa0: 726e 206f 626a 6563 742c 2077 6869 6368  rn object, which
-0002aab0: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
-0002aac0: 636f 6e66 6967 7572 6520 6675 7274 6865  configure furthe
-0002aad0: 7220 7072 6f70 6572 7469 6573 206f 7220  r properties or 
-0002aae0: 746f 2061 6464 2074 6865 0a20 2020 2020  to add the.     
-0002aaf0: 2020 2020 2020 2020 2020 2070 6174 7465             patte
-0002ab00: 726e 2074 6f20 7468 6520 6d69 6c6c 696e  rn to the millin
-0002ab10: 6720 6c69 7374 2e0a 0a20 2020 2020 2020  g list...       
-0002ab20: 2020 2020 200a 2020 2020 2020 2020 2222       .        ""
-0002ab30: 220a 2020 2020 2020 2020 6966 2070 6174  ".        if pat
-0002ab40: 7465 726e 5f73 6574 7469 6e67 732e 636c  tern_settings.cl
-0002ab50: 6561 6e69 6e67 5f63 726f 7373 5f73 6563  eaning_cross_sec
-0002ab60: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-0002ab70: 2020 7365 6c66 2e6c 6179 6572 2e61 6464    self.layer.add
-0002ab80: 416e 6e75 6c75 7350 6f6c 6973 6828 0a20  AnnulusPolish(. 
-0002ab90: 2020 2020 2020 2020 2020 2020 2020 2043                 C
-0002aba0: 656e 7465 7258 3d70 6174 7465 726e 5f73  enterX=pattern_s
-0002abb0: 6574 7469 6e67 732e 6365 6e74 7265 5f78  ettings.centre_x
-0002abc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002abd0: 2020 4365 6e74 6572 593d 7061 7474 6572    CenterY=patter
-0002abe0: 6e5f 7365 7474 696e 6773 2e63 656e 7472  n_settings.centr
-0002abf0: 655f 792c 0a20 2020 2020 2020 2020 2020  e_y,.           
-0002ac00: 2020 2020 2052 6164 6975 7341 3d70 6174       RadiusA=pat
-0002ac10: 7465 726e 5f73 6574 7469 6e67 732e 7261  tern_settings.ra
-0002ac20: 6469 7573 2c0a 2020 2020 2020 2020 2020  dius,.          
-0002ac30: 2020 2020 2020 5261 6469 7573 423d 302c        RadiusB=0,
-0002ac40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ac50: 2044 6570 7468 3d70 6174 7465 726e 5f73   Depth=pattern_s
-0002ac60: 6574 7469 6e67 732e 6465 7074 682c 0a20  ettings.depth,. 
-0002ac70: 2020 2020 2020 2020 2020 2020 2020 2044                 D
-0002ac80: 6570 7468 556e 6974 3d27 6d27 2c0a 2020  epthUnit='m',.  
-0002ac90: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0002aca0: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
-0002acb0: 656c 662e 6c61 7965 722e 6164 6441 6e6e  elf.layer.addAnn
-0002acc0: 756c 7573 4669 6c6c 6564 280a 2020 2020  ulusFilled(.    
-0002acd0: 2020 2020 2020 2020 4365 6e74 6572 583d          CenterX=
-0002ace0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-0002acf0: 2e63 656e 7472 655f 782c 0a20 2020 2020  .centre_x,.     
-0002ad00: 2020 2020 2020 2043 656e 7465 7259 3d70         CenterY=p
-0002ad10: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
-0002ad20: 6365 6e74 7265 5f79 2c0a 2020 2020 2020  centre_y,.      
-0002ad30: 2020 2020 2020 5261 6469 7573 413d 7061        RadiusA=pa
-0002ad40: 7474 6572 6e5f 7365 7474 696e 6773 2e72  ttern_settings.r
-0002ad50: 6164 6975 732c 0a20 2020 2020 2020 2020  adius,.         
-0002ad60: 2020 2052 6164 6975 7342 3d30 2c0a 2020     RadiusB=0,.  
-0002ad70: 2020 2020 2020 2020 2020 4465 7074 683d            Depth=
-0002ad80: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-0002ad90: 2e64 6570 7468 2c0a 2020 2020 2020 2020  .depth,.        
-0002ada0: 2020 2020 4465 7074 6855 6e69 743d 276d      DepthUnit='m
-0002adb0: 272c 0a20 2020 2020 2020 2029 0a0a 2020  ',.        )..  
-0002adc0: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
-0002add0: 7465 726e 0a20 2020 200a 2020 2020 6465  tern.    .    de
-0002ade0: 6620 6472 6177 5f61 6e6e 756c 7573 2873  f draw_annulus(s
-0002adf0: 656c 662c 7061 7474 6572 6e5f 7365 7474  elf,pattern_sett
-0002ae00: 696e 6773 3a20 4669 6273 656d 4369 7263  ings: FibsemCirc
-0002ae10: 6c65 5365 7474 696e 6773 293a 0a0a 2020  leSettings):..  
-0002ae20: 2020 2020 2020 2222 2244 7261 7773 2061        """Draws a
-0002ae30: 6e20 616e 6e75 6c75 7320 2864 6f6e 7574  n annulus (donut
-0002ae40: 2920 7061 7474 6572 6e20 6f6e 2074 6865  ) pattern on the
-0002ae50: 2063 7572 7265 6e74 2069 6d61 6769 6e67   current imaging
-0002ae60: 2076 6965 7720 6f66 2074 6865 206d 6963   view of the mic
-0002ae70: 726f 7363 6f70 652e 0a0a 2020 2020 2020  roscope...      
-0002ae80: 2020 4172 6773 3a20 0a20 2020 2020 2020    Args: .       
-0002ae90: 2020 2020 2070 6174 7465 726e 5f73 6574       pattern_set
-0002aea0: 7469 6e67 7320 2846 6962 7365 6d43 6972  tings (FibsemCir
-0002aeb0: 636c 6553 6574 7469 6e67 7329 3a20 4120  cleSettings): A 
-0002aec0: 6461 7461 2063 6c61 7373 206f 626a 6563  data class objec
-0002aed0: 7420 7370 6563 6966 7969 6e67 2074 6865  t specifying the
-0002aee0: 2070 6174 7465 726e 2070 6172 616d 6574   pattern paramet
-0002aef0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-0002af00: 2069 6e63 6c75 6469 6e67 2074 6865 2063   including the c
-0002af10: 656e 7472 6520 706f 696e 742c 206f 7574  entre point, out
-0002af20: 6572 2072 6164 6975 7320 616e 6420 7468  er radius and th
-0002af30: 6963 6b6e 6573 7320 6f66 2074 6865 2061  ickness of the a
-0002af40: 6e6e 756c 7573 2c20 616e 6420 7468 6520  nnulus, and the 
-0002af50: 6465 7074 6820 6f66 2074 6865 2070 6174  depth of the pat
-0002af60: 7465 726e 2e0a 0a20 2020 2020 2020 2052  tern...        R
-0002af70: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
-0002af80: 2020 2020 616e 6e75 6c75 7320 7061 7474      annulus patt
-0002af90: 6572 6e20 6f62 6a65 6374 0a20 2020 2020  ern object.     
-0002afa0: 2020 2022 2222 0a20 2020 2020 2020 206f     """.        o
-0002afb0: 7574 6572 5f72 6164 6975 7320 3d20 7061  uter_radius = pa
-0002afc0: 7474 6572 6e5f 7365 7474 696e 6773 2e72  ttern_settings.r
-0002afd0: 6164 6975 730a 2020 2020 2020 2020 696e  adius.        in
-0002afe0: 6e65 725f 7261 6469 7573 203d 2070 6174  ner_radius = pat
-0002aff0: 7465 726e 5f73 6574 7469 6e67 732e 7261  tern_settings.ra
-0002b000: 6469 7573 202d 2070 6174 7465 726e 5f73  dius - pattern_s
-0002b010: 6574 7469 6e67 732e 7468 6963 6b6e 6573  ettings.thicknes
-0002b020: 730a 0a0a 2020 2020 2020 2020 7061 7474  s...        patt
-0002b030: 6572 6e20 3d20 7365 6c66 2e6c 6179 6572  ern = self.layer
-0002b040: 2e61 6464 416e 6e75 6c75 7346 696c 6c65  .addAnnulusFille
-0002b050: 6428 0a20 2020 2020 2020 2020 2020 2043  d(.            C
-0002b060: 656e 7465 7258 3d70 6174 7465 726e 5f73  enterX=pattern_s
-0002b070: 6574 7469 6e67 732e 6365 6e74 7265 5f78  ettings.centre_x
-0002b080: 2c0a 2020 2020 2020 2020 2020 2020 4365  ,.            Ce
-0002b090: 6e74 6572 593d 7061 7474 6572 6e5f 7365  nterY=pattern_se
-0002b0a0: 7474 696e 6773 2e63 656e 7472 655f 792c  ttings.centre_y,
-0002b0b0: 0a20 2020 2020 2020 2020 2020 2052 6164  .            Rad
-0002b0c0: 6975 7341 3d6f 7574 6572 5f72 6164 6975  iusA=outer_radiu
-0002b0d0: 732c 0a20 2020 2020 2020 2020 2020 2052  s,.            R
-0002b0e0: 6164 6975 7342 3d69 6e6e 6572 5f72 6164  adiusB=inner_rad
-0002b0f0: 6975 732c 0a20 2020 2020 2020 2020 2020  ius,.           
-0002b100: 2044 6570 7468 3d70 6174 7465 726e 5f73   Depth=pattern_s
-0002b110: 6574 7469 6e67 732e 6465 7074 682c 0a20  ettings.depth,. 
-0002b120: 2020 2020 2020 2020 2020 2044 6570 7468             Depth
-0002b130: 556e 6974 3d27 6d27 2c0a 2020 2020 2020  Unit='m',.      
-0002b140: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-0002b150: 7572 6e20 7061 7474 6572 6e0a 2020 2020  urn pattern.    
-0002b160: 0a20 2020 2064 6566 2064 7261 775f 6269  .    def draw_bi
-0002b170: 746d 6170 5f70 6174 7465 726e 280a 2020  tmap_pattern(.  
-0002b180: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-0002b190: 2020 2020 7061 7474 6572 6e5f 7365 7474      pattern_sett
-0002b1a0: 696e 6773 3a20 4669 6273 656d 4269 746d  ings: FibsemBitm
-0002b1b0: 6170 5365 7474 696e 6773 2c0a 2020 2020  apSettings,.    
-0002b1c0: 2020 2020 7061 7468 3a20 7374 722c 0a20      path: str,. 
-0002b1d0: 2020 2029 3a0a 2020 2020 2020 2020 7265     ):.        re
-0002b1e0: 7475 726e 204e 6f74 496d 706c 656d 656e  turn NotImplemen
-0002b1f0: 7465 640a 0a20 2020 2064 6566 2073 6574  ted..    def set
-0002b200: 7570 5f73 7075 7474 6572 2873 656c 662c  up_sputter(self,
-0002b210: 2070 726f 746f 636f 6c3a 2064 6963 7429   protocol: dict)
-0002b220: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0002b230: 2020 2020 2020 5365 7420 7570 2074 6865        Set up the
-0002b240: 2073 7075 7474 6572 2063 6f61 7469 6e67   sputter coating
-0002b250: 2070 726f 6365 7373 206f 6e20 7468 6520   process on the 
-0002b260: 6d69 6372 6f73 636f 7065 2e0a 0a20 2020  microscope...   
-0002b270: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-0002b280: 2020 2020 2020 2070 726f 746f 636f 6c20         protocol 
-0002b290: 2864 6963 7429 3a20 436f 6e74 6169 6e73  (dict): Contains
-0002b2a0: 2061 6c6c 206f 6620 7468 6520 6e65 6365   all of the nece
-0002b2b0: 7373 6172 7920 7661 6c75 6573 2074 6f20  ssary values to 
-0002b2c0: 7365 7475 7020 7570 2070 6c61 7469 6e75  setup up platinu
-0002b2d0: 6d20 7370 7574 7465 7269 6e67 2e0a 2020  m sputtering..  
-0002b2e0: 2020 2020 2020 2020 2020 2020 2020 466f                Fo
-0002b2f0: 7220 5445 5343 414e 3a0a 2020 2020 2020  r TESCAN:.      
-0002b300: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
-0002b310: 6866 773a 2048 6f72 697a 6f6e 7461 6c20  hfw: Horizontal 
-0002b320: 6669 656c 6420 7769 6474 6820 286d 292e  field width (m).
-0002b330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b340: 2020 2020 202d 2062 6561 6d5f 6375 7272       - beam_curr
-0002b350: 656e 743a 2049 6f6e 2062 6561 6d20 6375  ent: Ion beam cu
-0002b360: 7272 656e 7420 696e 205b 415d 2e0a 2020  rrent in [A]..  
-0002b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b380: 2020 2d20 7370 6f74 5f73 697a 653a 2049    - spot_size: I
-0002b390: 6f6e 2062 6561 6d20 7370 6f74 2073 697a  on beam spot siz
-0002b3a0: 6520 696e 205b 6d5d 2e0a 2020 2020 2020  e in [m]..      
-0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
-0002b3c0: 7261 7465 3a20 496f 6e2f 656c 6563 7472  rate: Ion/electr
-0002b3d0: 6f6e 2065 7463 6869 6e67 2072 6174 6520  on etching rate 
-0002b3e0: 2864 6570 6f73 6974 696f 6e20 7261 7465  (deposition rate
-0002b3f0: 2920 696e 205b 6d33 2f41 2f73 5d2e 2045  ) in [m3/A/s]. E
-0002b400: 2e67 2e20 666f 7220 7369 6c69 636f 6e65  .g. for silicone
-0002b410: 2034 2e37 652d 3130 206d 332f 412f 732e   4.7e-10 m3/A/s.
-0002b420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b430: 2020 2020 202d 2064 7765 6c6c 2074 696d       - dwell tim
-0002b440: 653a 2050 6978 656c 2064 7765 6c6c 2074  e: Pixel dwell t
-0002b450: 696d 6520 696e 205b 735d 2e0a 0a20 2020  ime in [s]...   
-0002b460: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-0002b470: 2020 2020 2020 2020 2020 4e6f 6e65 0a0a            None..
-0002b480: 2020 2020 2020 2020 5261 6973 6573 3a0a          Raises:.
-0002b490: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
-0002b4a0: 0a0a 2020 2020 2020 2020 4e6f 7465 733a  ..        Notes:
-0002b4b0: 0a20 2020 2020 2020 2020 2020 2054 6869  .            Thi
-0002b4c0: 7320 6675 6e63 7469 6f6e 2073 6574 7320  s function sets 
-0002b4d0: 7570 2074 6865 2073 7075 7474 6572 2063  up the sputter c
-0002b4e0: 6f61 7469 6e67 2070 726f 6365 7373 206f  oating process o
-0002b4f0: 6e20 7468 6520 6d69 6372 6f73 636f 7065  n the microscope
-0002b500: 2e20 0a20 2020 2020 2020 2020 2020 2049  . .            I
-0002b510: 7420 7365 7473 2074 6865 2061 6374 6976  t sets the activ
-0002b520: 6520 7669 6577 2074 6f20 7468 6520 656c  e view to the el
-0002b530: 6563 7472 6f6e 2062 6561 6d2c 2063 6c65  ectron beam, cle
-0002b540: 6172 7320 616e 7920 6578 6973 7469 6e67  ars any existing
-0002b550: 2070 6174 7465 726e 732c 2061 6e64 2073   patterns, and s
-0002b560: 6574 7320 7468 6520 6465 6661 756c 7420  ets the default 
-0002b570: 6265 616d 2074 7970 6520 746f 2074 6865  beam type to the
-0002b580: 2065 6c65 6374 726f 6e20 6265 616d 2e20   electron beam. 
-0002b590: 0a20 2020 2020 2020 2020 2020 2049 7420  .            It 
-0002b5a0: 7468 656e 2069 6e73 6572 7473 2074 6865  then inserts the
-0002b5b0: 206d 756c 7469 6368 656d 2061 6e64 2074   multichem and t
-0002b5c0: 7572 6e73 206f 6e20 7468 6520 6865 6174  urns on the heat
-0002b5d0: 6572 2066 6f72 2074 6865 2073 7065 6369  er for the speci
-0002b5e0: 6669 6564 2067 6173 2061 6363 6f72 6469  fied gas accordi
-0002b5f0: 6e67 2074 6f20 7468 6520 6769 7665 6e20  ng to the given 
-0002b600: 7072 6f74 6f63 6f6c 2e20 0a20 2020 2020  protocol. .     
-0002b610: 2020 2020 2020 2054 6869 7320 6675 6e63         This func
-0002b620: 7469 6f6e 2061 6c73 6f20 7761 6974 7320  tion also waits 
-0002b630: 666f 7220 3320 7365 636f 6e64 7320 746f  for 3 seconds to
-0002b640: 2061 6c6c 6f77 2074 6865 2068 6561 7465   allow the heate
-0002b650: 7220 746f 2077 6172 6d20 7570 2e0a 2020  r to warm up..  
-0002b660: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0002b670: 2020 5f63 6865 636b 5f73 7075 7474 6572    _check_sputter
-0002b680: 2873 656c 662e 7379 7374 656d 290a 2020  (self.system).  
-0002b690: 2020 2020 2020 6761 7320 3d20 7072 6f74        gas = prot
-0002b6a0: 6f63 6f6c 5b22 6761 7322 5d0a 2020 2020  ocol["gas"].    
-0002b6b0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0002b6c0: 696f 6e2e 4649 422e 4265 616d 2e4f 6e28  ion.FIB.Beam.On(
-0002b6d0: 290a 2020 2020 2020 2020 6c69 6e65 7320  ).        lines 
-0002b6e0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-0002b6f0: 6e2e 4749 532e 456e 756d 2829 0a20 2020  n.GIS.Enum().   
-0002b700: 2020 2020 2066 6f72 206c 696e 6520 696e       for line in
-0002b710: 206c 696e 6573 3a0a 2020 2020 2020 2020   lines:.        
-0002b720: 2020 2020 6966 206c 696e 652e 6e61 6d65      if line.name
-0002b730: 203d 3d20 6761 733a 0a20 2020 2020 2020   == gas:.       
-0002b740: 2020 2020 2020 2020 2073 656c 662e 6c69           self.li
-0002b750: 6e65 203d 206c 696e 650a 0a20 2020 2020  ne = line..     
-0002b760: 2020 2020 2020 2020 2020 2023 2053 7461             # Sta
-0002b770: 7274 2047 4953 2068 6561 7469 6e67 0a20  rt GIS heating. 
-0002b780: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002b790: 656c 662e 636f 6e6e 6563 7469 6f6e 2e47  elf.connection.G
-0002b7a0: 4953 2e50 7265 7061 7265 5465 6d70 6572  IS.PrepareTemper
-0002b7b0: 6174 7572 6528 6c69 6e65 2c20 5472 7565  ature(line, True
-0002b7c0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0002b7d0: 2020 2023 2049 6e73 6572 7420 4749 5320     # Insert GIS 
-0002b7e0: 696e 746f 2077 6f72 6b69 6e67 2070 6f73  into working pos
-0002b7f0: 6974 696f 6e0a 2020 2020 2020 2020 2020  ition.          
-0002b800: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0002b810: 6374 696f 6e2e 4749 532e 4d6f 7665 546f  ction.GIS.MoveTo
-0002b820: 286c 696e 652c 2041 7574 6f6d 6174 696f  (line, Automatio
-0002b830: 6e2e 4749 532e 506f 7369 7469 6f6e 2e57  n.GIS.Position.W
-0002b840: 6f72 6b69 6e67 290a 0a20 2020 2020 2020  orking)..       
-0002b850: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
-0002b860: 666f 7220 4749 5320 6865 6174 6564 0a20  for GIS heated. 
-0002b870: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002b880: 656c 662e 636f 6e6e 6563 7469 6f6e 2e47  elf.connection.G
-0002b890: 4953 2e57 6169 7446 6f72 5465 6d70 6572  IS.WaitForTemper
-0002b8a0: 6174 7572 6552 6561 6479 286c 696e 6529  atureReady(line)
-0002b8b0: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-0002b8c0: 2020 2020 2020 2020 2020 206c 6179 6572             layer
-0002b8d0: 5365 7474 696e 6773 203d 2073 656c 662e  Settings = self.
-0002b8e0: 636f 6e6e 6563 7469 6f6e 2e44 7261 7742  connection.DrawB
-0002b8f0: 6561 6d2e 4c61 7965 7253 6574 7469 6e67  eam.LayerSetting
-0002b900: 732e 4944 6570 6f73 6974 696f 6e28 0a20  s.IDeposition(. 
-0002b910: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002b920: 796e 6357 7269 7465 4669 656c 643d 5472  yncWriteField=Tr
-0002b930: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0002b940: 2020 2020 7772 6974 6546 6965 6c64 5369      writeFieldSi
-0002b950: 7a65 3d70 726f 746f 636f 6c5b 2268 6677  ze=protocol["hfw
-0002b960: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-0002b970: 2020 2020 6265 616d 4375 7272 656e 743d      beamCurrent=
-0002b980: 7072 6f74 6f63 6f6c 5b22 6265 616d 5f63  protocol["beam_c
-0002b990: 7572 7265 6e74 225d 2c0a 2020 2020 2020  urrent"],.      
-0002b9a0: 2020 2020 2020 2020 2020 7370 6f74 5369            spotSi
-0002b9b0: 7a65 3d70 726f 746f 636f 6c5b 2273 706f  ze=protocol["spo
-0002b9c0: 745f 7369 7a65 225d 2c0a 2020 2020 2020  t_size"],.      
-0002b9d0: 2020 2020 2020 2020 2020 7261 7465 3d33            rate=3
-0002b9e0: 652d 3130 2c20 2320 5661 6c75 6520 666f  e-10, # Value fo
-0002b9f0: 7220 706c 6174 696e 756d 0a20 2020 2020  r platinum.     
-0002ba00: 2020 2020 2020 2020 2020 2064 7765 6c6c             dwell
-0002ba10: 5469 6d65 3d70 726f 746f 636f 6c5b 2264  Time=protocol["d
-0002ba20: 7765 6c6c 5f74 696d 6522 5d2c 0a20 2020  well_time"],.   
-0002ba30: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002ba40: 2020 2020 2020 2073 656c 662e 6c61 7965         self.laye
-0002ba50: 7220 3d20 7365 6c66 2e63 6f6e 6e65 6374  r = self.connect
-0002ba60: 696f 6e2e 4472 6177 4265 616d 2e4c 6179  ion.DrawBeam.Lay
-0002ba70: 6572 2822 4c61 7965 7231 222c 206c 6179  er("Layer1", lay
-0002ba80: 6572 5365 7474 696e 6773 290a 2020 2020  erSettings).    
-0002ba90: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0002baa0: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
-0002bab0: 2e4c 6f61 644c 6179 6572 2873 656c 662e  .LoadLayer(self.
-0002bac0: 6c61 7965 7229 0a0a 2020 2020 2020 2020  layer)..        
-0002bad0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-0002bae0: 2020 2020 696d 706f 7274 2066 6962 7365      import fibse
-0002baf0: 6d0a 2020 2020 2020 2020 2020 2020 6261  m.            ba
-0002bb00: 7365 5f70 6174 6820 3d20 6f73 2e70 6174  se_path = os.pat
-0002bb10: 682e 6469 726e 616d 6528 6669 6273 656d  h.dirname(fibsem
-0002bb20: 2e5f 5f70 6174 685f 5f5b 305d 290a 2020  .__path__[0]).  
-0002bb30: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
-0002bb40: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-0002bb50: 6f69 6e28 6261 7365 5f70 6174 682c 2266  oin(base_path,"f
-0002bb60: 6962 7365 6d22 2c20 2263 6f6e 6669 6722  ibsem", "config"
-0002bb70: 2c20 2264 6570 6f73 6974 696f 6e2e 6462  , "deposition.db
-0002bb80: 7022 290a 2020 2020 2020 2020 2020 2020  p").            
-0002bb90: 7365 6c66 2e6c 6179 6572 203d 2073 656c  self.layer = sel
-0002bba0: 662e 636f 6e6e 6563 7469 6f6e 2e44 7261  f.connection.Dra
-0002bbb0: 7742 6561 6d2e 4c61 7965 722e 6672 6f6d  wBeam.Layer.from
-0002bbc0: 4462 7028 6c61 7965 725f 7061 7468 295b  Dbp(layer_path)[
-0002bbd0: 305d 0a20 2020 2020 2020 2020 2020 2023  0].            #
-0002bbe0: 2073 656c 662e 6c61 7965 7220 3d20 7365   self.layer = se
-0002bbf0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4472  lf.connection.Dr
-0002bc00: 6177 4265 616d 2e4c 6f61 644c 6179 6572  awBeam.LoadLayer
-0002bc10: 2864 6566 6175 6c74 4c61 7965 7253 6574  (defaultLayerSet
-0002bc20: 7469 6e67 735b 305d 290a 0a20 2020 2064  tings[0])..    d
-0002bc30: 6566 2064 7261 775f 7370 7574 7465 725f  ef draw_sputter_
-0002bc40: 7061 7474 6572 6e28 7365 6c66 2c20 6866  pattern(self, hf
-0002bc50: 772c 206c 696e 655f 7061 7474 6572 6e5f  w, line_pattern_
-0002bc60: 6c65 6e67 7468 2c20 2a61 7267 732c 202a  length, *args, *
-0002bc70: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
-0002bc80: 2020 2222 220a 2020 2020 2020 2020 4472    """.        Dr
-0002bc90: 6177 7320 6120 6c69 6e65 2070 6174 7465  aws a line patte
-0002bca0: 726e 2066 6f72 2073 7075 7474 6572 696e  rn for sputterin
-0002bcb0: 6720 7769 7468 2074 6865 2067 6976 656e  g with the given
-0002bcc0: 2070 6172 616d 6574 6572 732e 0a0a 2020   parameters...  
-0002bcd0: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
-0002bce0: 2020 2020 2020 2020 6866 7720 2866 6c6f          hfw (flo
-0002bcf0: 6174 293a 2054 6865 2068 6f72 697a 6f6e  at): The horizon
-0002bd00: 7461 6c20 6669 656c 6420 7769 6474 6820  tal field width 
-0002bd10: 6f66 2074 6865 2065 6c65 6374 726f 6e20  of the electron 
-0002bd20: 6265 616d 2e0a 2020 2020 2020 2020 2020  beam..          
-0002bd30: 2020 6c69 6e65 5f70 6174 7465 726e 5f6c    line_pattern_l
-0002bd40: 656e 6774 6820 2866 6c6f 6174 293a 2054  ength (float): T
-0002bd50: 6865 206c 656e 6774 6820 6f66 2074 6865  he length of the
-0002bd60: 206c 696e 6520 7061 7474 6572 6e20 746f   line pattern to
-0002bd70: 2064 7261 772e 0a20 2020 2020 2020 2020   draw..         
-0002bd80: 2020 202a 6172 6773 2c20 2a2a 6b77 6172     *args, **kwar
-0002bd90: 6773 3a20 5468 6973 2072 6570 7265 7365  gs: This represe
-0002bda0: 6e74 7320 7468 6520 6172 6775 6d65 6e74  nts the argument
-0002bdb0: 7320 7573 6564 2062 7920 5468 6572 6d6f  s used by Thermo
-0002bdc0: 4d69 6372 6f73 636f 7065 2074 6861 7420  Microscope that 
-0002bdd0: 6172 6520 6e6f 7420 7265 7175 6972 6564  are not required
-0002bde0: 2066 6f72 2074 6865 2054 6573 6361 6e4d   for the TescanM
-0002bdf0: 6963 726f 7363 6f70 652e 0a0a 2020 2020  icroscope...    
-0002be00: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
-0002be10: 2020 2020 2020 2020 204e 6f6e 650a 0a20           None.. 
-0002be20: 2020 2020 2020 204e 6f74 6573 3a0a 2020         Notes:.  
-0002be30: 2020 2020 2020 2020 2020 5365 7473 2074            Sets t
-0002be40: 6865 2068 6f72 697a 6f6e 7461 6c20 6669  he horizontal fi
-0002be50: 656c 6420 7769 6474 6820 6f66 2074 6865  eld width of the
-0002be60: 2065 6c65 6374 726f 6e20 6265 616d 2074   electron beam t
-0002be70: 6f20 7468 6520 6769 7665 6e20 7661 6c75  o the given valu
-0002be80: 652e 0a20 2020 2020 2020 2020 2020 2044  e..            D
-0002be90: 7261 7773 2061 206c 696e 6520 7061 7474  raws a line patt
-0002bea0: 6572 6e20 666f 7220 7370 7574 7465 7269  ern for sputteri
-0002beb0: 6e67 2077 6974 6820 7468 6520 6769 7665  ng with the give
-0002bec0: 6e20 6c65 6e67 7468 2061 6e64 206d 696c  n length and mil
-0002bed0: 6c69 6e67 2064 6570 7468 2e0a 2020 2020  ling depth..    
-0002bee0: 2020 2020 2020 2020 5365 7473 2074 6865          Sets the
-0002bef0: 2073 7075 7474 6572 2074 696d 6520 6f66   sputter time of
-0002bf00: 2074 6865 206c 696e 6520 7061 7474 6572   the line patter
-0002bf10: 6e20 746f 2074 6865 2067 6976 656e 2076  n to the given v
-0002bf20: 616c 7565 2e0a 0a20 2020 2020 2020 2022  alue...        "
-0002bf30: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
-0002bf40: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e4f  connection.FIB.O
-0002bf50: 7074 6963 732e 5365 7456 6965 7766 6965  ptics.SetViewfie
-0002bf60: 6c64 280a 2020 2020 2020 2020 2020 2020  ld(.            
-0002bf70: 6866 7720 2a20 636f 6e73 7461 6e74 732e  hfw * constants.
-0002bf80: 4d45 5452 455f 544f 5f4d 494c 4c49 4d45  METRE_TO_MILLIME
-0002bf90: 5452 450a 2020 2020 2020 2020 290a 0a20  TRE.        ).. 
-0002bfa0: 2020 2020 2020 2073 7461 7274 5f78 3d2d         start_x=-
-0002bfb0: 6c69 6e65 5f70 6174 7465 726e 5f6c 656e  line_pattern_len
-0002bfc0: 6774 682f 322c 200a 2020 2020 2020 2020  gth/2, .        
-0002bfd0: 7374 6172 745f 793d 2b6c 696e 655f 7061  start_y=+line_pa
-0002bfe0: 7474 6572 6e5f 6c65 6e67 7468 2c0a 2020  ttern_length,.  
-0002bff0: 2020 2020 2020 656e 645f 783d 2b6c 696e        end_x=+lin
-0002c000: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
-0002c010: 2f32 2c0a 2020 2020 2020 2020 656e 645f  /2,.        end_
-0002c020: 793d 2b6c 696e 655f 7061 7474 6572 6e5f  y=+line_pattern_
-0002c030: 6c65 6e67 7468 2c0a 2020 2020 2020 2020  length,.        
-0002c040: 6465 7074 683d 3265 2d36 0a20 2020 2020  depth=2e-6.     
-0002c050: 2020 200a 2020 2020 2020 2020 7061 7474     .        patt
-0002c060: 6572 6e20 3d20 7365 6c66 2e6c 6179 6572  ern = self.layer
-0002c070: 2e61 6464 4c69 6e65 280a 2020 2020 2020  .addLine(.      
-0002c080: 2020 2020 2020 4265 6769 6e58 3d73 7461        BeginX=sta
-0002c090: 7274 5f78 2c20 4265 6769 6e59 3d73 7461  rt_x, BeginY=sta
-0002c0a0: 7274 5f79 2c20 456e 6458 3d65 6e64 5f78  rt_y, EndX=end_x
-0002c0b0: 2c20 456e 6459 3d65 6e64 5f79 2c20 4465  , EndY=end_y, De
-0002c0c0: 7074 683d 6465 7074 680a 2020 2020 2020  pth=depth.      
-0002c0d0: 2020 290a 2020 2020 2020 2020 0a20 2020    ).        .   
-0002c0e0: 2020 2020 2072 6574 7572 6e20 7061 7474       return patt
-0002c0f0: 6572 6e0a 0a20 2020 2064 6566 2072 756e  ern..    def run
-0002c100: 5f73 7075 7474 6572 2873 656c 662c 202a  _sputter(self, *
-0002c110: 6172 6773 2c20 2a2a 6b77 6172 6773 293a  args, **kwargs):
-0002c120: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0002c130: 2020 2020 2052 756e 7320 7468 6520 4749       Runs the GI
-0002c140: 5320 506c 6174 696e 756d 2053 7075 7474  S Platinum Sputt
-0002c150: 6572 2e0a 0a20 2020 2020 2020 2041 7267  er...        Arg
-0002c160: 733a 0a20 2020 2020 2020 2020 2020 202a  s:.            *
-0002c170: 6172 6773 2c20 2a2a 6b77 6172 6773 3a20  args, **kwargs: 
-0002c180: 5573 6564 2074 6f20 6d61 696e 7461 696e  Used to maintain
-0002c190: 2066 756e 6374 696f 6e61 6c69 7479 2061   functionality a
-0002c1a0: 6e64 2063 6f6d 7061 7461 6269 6c69 7479  nd compatability
-0002c1b0: 2062 6574 7765 656e 206d 6963 726f 7363   between microsc
-0002c1c0: 6f70 6573 2e20 4e6f 2061 7267 756d 656e  opes. No argumen
-0002c1d0: 7473 2072 6571 7569 7265 642e 0a20 2020  ts required..   
-0002c1e0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0002c1f0: 2020 5275 6e73 2074 6865 2047 4953 2050    Runs the GIS P
-0002c200: 6c61 7469 6e75 6d20 5370 7574 7465 722e  latinum Sputter.
-0002c210: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
-0002c220: 733a 0a20 2020 2020 2020 2020 2020 204e  s:.            N
-0002c230: 6f6e 650a 2020 2020 2020 2020 2222 220a  one.        """.
-0002c240: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
-0002c250: 7075 7474 6572 2873 656c 662e 7379 7374  putter(self.syst
-0002c260: 656d 290a 2020 2020 2020 2020 2320 4f70  em).        # Op
-0002c270: 656e 2047 4953 2076 616c 7665 2074 6f20  en GIS valve to 
-0002c280: 6c65 7420 7468 6520 6761 7320 666c 6f77  let the gas flow
-0002c290: 206f 6e74 6f20 7468 6520 7361 6d70 6c65   onto the sample
-0002c2a0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-0002c2b0: 6e6e 6563 7469 6f6e 2e47 4953 2e4f 7065  nnection.GIS.Ope
-0002c2c0: 6e56 616c 7665 2873 656c 662e 6c69 6e65  nValve(self.line
-0002c2d0: 290a 0a20 2020 2020 2020 2074 7279 3a0a  )..        try:.
-0002c2e0: 2020 2020 2020 2020 2020 2020 2320 5275              # Ru
-0002c2f0: 6e20 7072 6564 6566 696e 6564 2064 6570  n predefined dep
-0002c300: 6f73 6974 696f 6e20 7072 6f63 6573 730a  osition process.
-0002c310: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002c320: 2e63 6f6e 6e65 6374 696f 6e2e 4472 6177  .connection.Draw
-0002c330: 4265 616d 2e53 7461 7274 2829 0a20 2020  Beam.Start().   
-0002c340: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
-0002c350: 6e6e 6563 7469 6f6e 2e50 726f 6772 6573  nnection.Progres
-0002c360: 732e 5368 6f77 2822 4472 6177 4265 616d  s.Show("DrawBeam
-0002c370: 222c 2022 4c61 7965 7220 3120 696e 2070  ", "Layer 1 in p
-0002c380: 726f 6772 6573 7322 2c20 4661 6c73 652c  rogress", False,
-0002c390: 2046 616c 7365 2c20 302c 2031 3030 290a   False, 0, 100).
-0002c3a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002c3b0: 696e 672e 696e 666f 2822 5370 7574 7465  ing.info("Sputte
-0002c3c0: 7269 6e67 2077 6974 6820 706c 6174 696e  ring with platin
-0002c3d0: 756d 2073 7461 7274 6564 2e22 290a 2020  um started.").  
-0002c3e0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-0002c3f0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-0002c400: 2020 2020 2020 7374 6174 7573 203d 2073        status = s
-0002c410: 656c 662e 636f 6e6e 6563 7469 6f6e 2e44  elf.connection.D
-0002c420: 7261 7742 6561 6d2e 4765 7453 7461 7475  rawBeam.GetStatu
-0002c430: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0002c440: 2020 2020 7275 6e6e 696e 6720 3d20 7374      running = st
-0002c450: 6174 7573 5b30 5d20 3d3d 2073 656c 662e  atus[0] == self.
-0002c460: 636f 6e6e 6563 7469 6f6e 2e44 7261 7742  connection.DrawB
-0002c470: 6561 6d2e 5374 6174 7573 2e50 726f 6a65  eam.Status.Proje
-0002c480: 6374 4c6f 6164 6564 4578 706f 7369 7469  ctLoadedExpositi
-0002c490: 6f6e 496e 5072 6f67 7265 7373 0a20 2020  onInProgress.   
-0002c4a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002c4b0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-0002c4c0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0002c4d0: 6772 6573 7320 3d20 300a 2020 2020 2020  gress = 0.      
-0002c4e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002c4f0: 2073 7461 7475 735b 315d 203e 2030 3a0a   status[1] > 0:.
-0002c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c510: 2020 2020 2020 2020 7072 6f67 7265 7373          progress
-0002c520: 203d 206d 696e 2831 3030 2c20 7374 6174   = min(100, stat
-0002c530: 7573 5b32 5d20 2f20 7374 6174 7573 5b31  us[2] / status[1
-0002c540: 5d20 2a20 3130 3029 0a20 2020 2020 2020  ] * 100).       
-0002c550: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0002c560: 6e74 5072 6f67 7265 7373 4261 7228 7072  ntProgressBar(pr
-0002c570: 6f67 7265 7373 2c20 3130 3029 0a20 2020  ogress, 100).   
-0002c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c590: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002c5a0: 2e50 726f 6772 6573 732e 5365 7450 6572  .Progress.SetPer
-0002c5b0: 6365 6e74 7328 7072 6f67 7265 7373 290a  cents(progress).
-0002c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c5d0: 2020 2020 7469 6d65 2e73 6c65 6570 2831      time.sleep(1
-0002c5e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002c5f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002c600: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0002c610: 7461 7475 735b 305d 203d 3d20 7365 6c66  tatus[0] == self
-0002c620: 2e63 6f6e 6e65 6374 696f 6e2e 4472 6177  .connection.Draw
-0002c630: 4265 616d 2e53 7461 7475 732e 5072 6f6a  Beam.Status.Proj
-0002c640: 6563 744c 6f61 6465 6445 7870 6f73 6974  ectLoadedExposit
-0002c650: 696f 6e49 646c 653a 0a20 2020 2020 2020  ionIdle:.       
-0002c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c670: 2070 7269 6e74 5072 6f67 7265 7373 4261   printProgressBa
-0002c680: 7228 3130 302c 2031 3030 2c20 7375 6666  r(100, 100, suff
-0002c690: 6978 3d27 4669 6e69 7368 6564 2729 0a20  ix='Finished'). 
-0002c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c6b0: 2020 2020 2020 2070 7269 6e74 2827 2729         print('')
-0002c6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c6d0: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
-0002c6e0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
-0002c6f0: 2020 2020 2020 2020 2320 436c 6f73 6520          # Close 
-0002c700: 4749 5320 5661 6c76 6520 696e 2062 6f74  GIS Valve in bot
-0002c710: 6820 2d20 7375 6363 6573 7320 616e 6420  h - success and 
-0002c720: 6661 696c 7572 650a 2020 2020 2020 2020  failure.        
-0002c730: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
-0002c740: 696f 6e2e 4749 532e 436c 6f73 6556 616c  ion.GIS.CloseVal
-0002c750: 7665 2873 656c 662e 6c69 6e65 290a 2020  ve(self.line).  
-0002c760: 2020 2020 2020 0a20 2020 2064 6566 2066        .    def f
-0002c770: 696e 6973 685f 7370 7574 7465 7228 7365  inish_sputter(se
-0002c780: 6c66 2c20 2a61 7267 732c 202a 2a6b 7761  lf, *args, **kwa
-0002c790: 7267 7329 3a0a 2020 2020 2020 2020 2222  rgs):.        ""
-0002c7a0: 220a 2020 2020 2020 2020 4669 6e69 7368  ".        Finish
-0002c7b0: 2074 6865 2073 7075 7474 6572 2070 726f   the sputter pro
-0002c7c0: 6365 7373 2062 7920 7265 7472 6163 7469  cess by retracti
-0002c7d0: 6e67 2074 6865 2047 4953 2063 6861 6d62  ng the GIS chamb
-0002c7e0: 6572 2061 6e64 2074 7572 6e69 6e67 206f  er and turning o
-0002c7f0: 6666 2074 6865 2068 6561 7469 6e67 2e0a  ff the heating..
-0002c800: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
-0002c810: 2020 2020 2020 2020 2020 202a 6172 6773             *args
-0002c820: 2c20 2a2a 6b77 6172 6773 3a20 5468 6973  , **kwargs: This
-0002c830: 2072 6570 7265 7365 6e74 7320 7468 6520   represents the 
-0002c840: 6172 6775 6d65 6e74 7320 7573 6564 2062  arguments used b
-0002c850: 7920 5468 6572 6d6f 4d69 6372 6f73 636f  y ThermoMicrosco
-0002c860: 7065 2074 6861 7420 6172 6520 6e6f 7420  pe that are not 
-0002c870: 7265 7175 6972 6564 2066 6f72 2074 6865  required for the
-0002c880: 2054 6573 6361 6e4d 6963 726f 7363 6f70   TescanMicroscop
-0002c890: 652e 0a0a 2020 2020 2020 2020 5265 7475  e...        Retu
-0002c8a0: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
-0002c8b0: 204e 6f6e 650a 0a20 2020 2020 2020 2052   None..        R
-0002c8c0: 6169 7365 733a 0a20 2020 2020 2020 2020  aises:.         
-0002c8d0: 2020 204e 6f6e 650a 2020 2020 2020 2020     None.        
-0002c8e0: 2222 220a 2020 2020 2020 2020 5f63 6865  """.        _che
-0002c8f0: 636b 5f73 7075 7474 6572 2873 656c 662e  ck_sputter(self.
-0002c900: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
-0002c910: 2320 4d6f 7665 2047 4953 206f 7574 2066  # Move GIS out f
-0002c920: 726f 6d20 6368 616d 6265 7220 616e 6420  rom chamber and 
-0002c930: 7475 726e 206f 6666 2068 6561 7469 6e67  turn off heating
-0002c940: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-0002c950: 6e6e 6563 7469 6f6e 2e47 4953 2e4d 6f76  nnection.GIS.Mov
-0002c960: 6554 6f28 7365 6c66 2e6c 696e 652c 2041  eTo(self.line, A
-0002c970: 7574 6f6d 6174 696f 6e2e 4749 532e 506f  utomation.GIS.Po
-0002c980: 7369 7469 6f6e 2e48 6f6d 6529 0a20 2020  sition.Home).   
-0002c990: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0002c9a0: 7469 6f6e 2e47 4953 2e50 7265 7061 7265  tion.GIS.Prepare
-0002c9b0: 5465 6d70 6572 6174 7572 6528 7365 6c66  Temperature(self
-0002c9c0: 2e6c 696e 652c 2046 616c 7365 290a 2020  .line, False).  
-0002c9d0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0002c9e0: 6374 696f 6e2e 4472 6177 4265 616d 2e55  ction.DrawBeam.U
-0002c9f0: 6e6c 6f61 644c 6179 6572 2829 0a20 2020  nloadLayer().   
-0002ca00: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0002ca10: 6f28 2250 6c61 7469 6e75 6d20 7370 7574  o("Platinum sput
-0002ca20: 7465 7269 6e67 2070 726f 6365 7373 2063  tering process c
-0002ca30: 6f6d 706c 6574 6564 2e22 290a 0a20 2020  ompleted.")..   
-0002ca40: 2023 2064 6566 2073 6574 7570 5f47 4953   # def setup_GIS
-0002ca50: 2873 656c 662c 7072 6f74 6f63 6f6c 2920  (self,protocol) 
-0002ca60: 2d3e 204e 6f6e 653a 0a0a 2020 2020 2320  -> None:..    # 
-0002ca70: 2020 2020 6265 616d 5f74 7970 6520 3d20      beam_type = 
-0002ca80: 7072 6f74 6f63 6f6c 5b22 6265 616d 5f74  protocol["beam_t
-0002ca90: 7970 6522 5d0a 0a20 2020 2023 2020 2020  ype"]..    #    
-0002caa0: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
-0002cab0: 2022 494f 4e22 3a0a 0a0a 2020 2020 2320   "ION":...    # 
-0002cac0: 2020 2020 2020 2020 6c61 7965 7253 6574          layerSet
-0002cad0: 7469 6e67 7320 3d20 7365 6c66 2e63 6f6e  tings = self.con
-0002cae0: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
-0002caf0: 2e4c 6179 6572 5365 7474 696e 6773 2e49  .LayerSettings.I
-0002cb00: 4465 706f 7369 7469 6f6e 280a 2020 2020  Deposition(.    
-0002cb10: 2320 2020 2020 2020 2020 2020 2020 7379  #             sy
-0002cb20: 6e63 5772 6974 6546 6965 6c64 3d54 7275  ncWriteField=Tru
-0002cb30: 652c 0a20 2020 2023 2020 2020 2020 2020  e,.    #        
-0002cb40: 2020 2020 2077 7269 7465 4669 656c 6453       writeFieldS
-0002cb50: 697a 653d 7072 6f74 6f63 6f6c 2e67 6574  ize=protocol.get
-0002cb60: 2822 6866 7722 2c30 2e30 3030 3529 2c0a  ("hfw",0.0005),.
-0002cb70: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-0002cb80: 2020 6265 616d 4375 7272 656e 743d 7072    beamCurrent=pr
-0002cb90: 6f74 6f63 6f6c 2e67 6574 2822 6265 616d  otocol.get("beam
-0002cba0: 5f63 7572 7265 6e74 222c 3565 2d31 3029  _current",5e-10)
-0002cbb0: 2c0a 2020 2020 2320 2020 2020 2020 2020  ,.    #         
-0002cbc0: 2020 2020 7370 6f74 5369 7a65 3d70 726f      spotSize=pro
-0002cbd0: 746f 636f 6c2e 6765 7428 2273 706f 745f  tocol.get("spot_
-0002cbe0: 7369 7a65 222c 352e 3065 2d38 292c 0a20  size",5.0e-8),. 
-0002cbf0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-0002cc00: 2073 7061 6369 6e67 3d31 2e30 2c0a 2020   spacing=1.0,.  
-0002cc10: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-0002cc20: 7261 7465 3d33 652d 3130 2c20 2320 5661  rate=3e-10, # Va
-0002cc30: 6c75 6520 666f 7220 706c 6174 696e 756d  lue for platinum
-0002cc40: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0002cc50: 2020 2064 7765 6c6c 5469 6d65 3d70 726f     dwellTime=pro
-0002cc60: 746f 636f 6c2e 6765 7428 2264 7765 6c6c  tocol.get("dwell
-0002cc70: 5f74 696d 6522 2c31 2e30 652d 3629 2c0a  _time",1.0e-6),.
-0002cc80: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-0002cc90: 2020 7072 6573 6574 3d4e 6f6e 652c 0a20    preset=None,. 
-0002cca0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-0002ccb0: 2070 6172 616c 6c65 6c3d 4661 6c73 652c   parallel=False,
-0002ccc0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0002ccd0: 2020 206d 6174 6572 6961 6c3d 2744 6566     material='Def
-0002cce0: 6175 6c74 204d 6174 6572 6961 6c27 2c0a  ault Material',.
-0002ccf0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-0002cd00: 2020 6769 7350 7265 6375 7273 6f72 3d4e    gisPrecursor=N
-0002cd10: 6f6e 652c 0a0a 2020 2020 2320 2020 2020  one,..    #     
-0002cd20: 2020 2020 290a 0a20 2020 2023 2020 2020      )..    #    
-0002cd30: 2065 6c73 653a 0a0a 0a20 2020 2023 2020   else:...    #  
-0002cd40: 2020 2020 2020 206c 6179 6572 5365 7474         layerSett
-0002cd50: 696e 6773 203d 2073 656c 662e 636f 6e6e  ings = self.conn
-0002cd60: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
-0002cd70: 4c61 7965 7253 6574 7469 6e67 732e 4544  LayerSettings.ED
-0002cd80: 6570 6f73 6974 696f 6e28 0a20 2020 2023  eposition(.    #
-0002cd90: 2020 2020 2020 2020 2020 2020 2073 796e               syn
-0002cda0: 6357 7269 7465 4669 656c 643d 5472 7565  cWriteField=True
-0002cdb0: 2c0a 2020 2020 2320 2020 2020 2020 2020  ,.    #         
-0002cdc0: 2020 2020 7772 6974 6546 6965 6c64 5369      writeFieldSi
-0002cdd0: 7a65 3d70 726f 746f 636f 6c2e 6765 7428  ze=protocol.get(
-0002cde0: 2268 6677 222c 302e 3030 3035 292c 0a20  "hfw",0.0005),. 
-0002cdf0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-0002ce00: 2062 6561 6d43 7572 7265 6e74 3d70 726f   beamCurrent=pro
-0002ce10: 746f 636f 6c2e 6765 7428 2262 6561 6d5f  tocol.get("beam_
-0002ce20: 6375 7272 656e 7422 2c35 652d 3130 292c  current",5e-10),
-0002ce30: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0002ce40: 2020 2073 706f 7453 697a 653d 7072 6f74     spotSize=prot
-0002ce50: 6f63 6f6c 2e67 6574 2822 7370 6f74 5f73  ocol.get("spot_s
-0002ce60: 697a 6522 2c35 2e30 652d 3829 2c0a 2020  ize",5.0e-8),.  
-0002ce70: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-0002ce80: 7261 7465 3d33 652d 3130 2c20 2320 5661  rate=3e-10, # Va
-0002ce90: 6c75 6520 666f 7220 706c 6174 696e 756d  lue for platinum
-0002cea0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0002ceb0: 2020 2073 7061 6369 6e67 3d31 2e30 2c0a     spacing=1.0,.
-0002cec0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-0002ced0: 2020 6477 656c 6c54 696d 653d 7072 6f74    dwellTime=prot
-0002cee0: 6f63 6f6c 2e67 6574 2822 6477 656c 6c5f  ocol.get("dwell_
-0002cef0: 7469 6d65 222c 312e 3065 2d36 292c 0a20  time",1.0e-6),. 
-0002cf00: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-0002cf10: 2070 7265 7365 743d 4e6f 6e65 2c0a 2020   preset=None,.  
-0002cf20: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-0002cf30: 7061 7261 6c6c 656c 3d46 616c 7365 2c0a  parallel=False,.
-0002cf40: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-0002cf50: 2020 6d61 7465 7269 616c 3d27 4465 6661    material='Defa
-0002cf60: 756c 7420 4d61 7465 7269 616c 272c 0a20  ult Material',. 
-0002cf70: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-0002cf80: 2067 6973 5072 6563 7572 736f 723d 4e6f   gisPrecursor=No
-0002cf90: 6e65 2c0a 2020 2020 2320 2020 2020 2020  ne,.    #       
-0002cfa0: 2020 290a 2020 2020 2320 2020 2020 7365    ).    #     se
-0002cfb0: 6c66 2e67 6973 5f6c 6179 6572 203d 2073  lf.gis_layer = s
-0002cfc0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e44  elf.connection.D
-0002cfd0: 7261 7742 6561 6d2e 4c61 7965 7228 224c  rawBeam.Layer("L
-0002cfe0: 6179 6572 5f47 4953 222c 206c 6179 6572  ayer_GIS", layer
-0002cff0: 5365 7474 696e 6773 290a 0a0a 2020 2020  Settings)...    
-0002d000: 2320 2020 2020 6c6f 6767 696e 672e 696e  #     logging.in
-0002d010: 666f 2866 2247 4953 2053 6574 7570 2043  fo(f"GIS Setup C
-0002d020: 6f6d 706c 6574 652c 207b 6265 616d 5f74  omplete, {beam_t
-0002d030: 7970 657d 206c 6179 6572 2073 6574 7469  ype} layer setti
-0002d040: 6e67 7320 6c6f 6164 6564 2229 0a0a 2020  ngs loaded")..  
-0002d050: 2020 2320 6465 6620 7365 7475 705f 4749    # def setup_GI
-0002d060: 535f 7061 7474 6572 6e28 7365 6c66 2c70  S_pattern(self,p
-0002d070: 726f 746f 636f 6c29 3a0a 0a20 2020 2023  rotocol):..    #
-0002d080: 2020 2020 2068 6677 203d 2070 726f 746f       hfw = proto
-0002d090: 636f 6c5b 2268 6677 225d 0a20 2020 2023  col["hfw"].    #
-0002d0a0: 2020 2020 206c 696e 655f 7061 7474 6572       line_patter
-0002d0b0: 6e5f 6c65 6e67 7468 203d 2070 726f 746f  n_length = proto
-0002d0c0: 636f 6c5b 226c 656e 6774 6822 5d0a 0a0a  col["length"]...
-0002d0d0: 2020 2020 2320 2020 2020 7374 6172 745f      #     start_
-0002d0e0: 783d 2d6c 696e 655f 7061 7474 6572 6e5f  x=-line_pattern_
-0002d0f0: 6c65 6e67 7468 2f32 200a 2020 2020 2320  length/2 .    # 
-0002d100: 2020 2020 7374 6172 745f 793d 2b6c 696e      start_y=+lin
-0002d110: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
-0002d120: 0a20 2020 2023 2020 2020 2065 6e64 5f78  .    #     end_x
-0002d130: 3d2b 6c69 6e65 5f70 6174 7465 726e 5f6c  =+line_pattern_l
-0002d140: 656e 6774 682f 320a 2020 2020 2320 2020  ength/2.    #   
-0002d150: 2020 656e 645f 793d 2b6c 696e 655f 7061    end_y=+line_pa
-0002d160: 7474 6572 6e5f 6c65 6e67 7468 0a20 2020  ttern_length.   
-0002d170: 2023 2020 2020 2064 6570 7468 3d32 652d   #     depth=2e-
-0002d180: 360a 0a20 2020 2023 2020 2020 2073 656c  6..    #     sel
-0002d190: 662e 6769 735f 6c61 7965 722e 6164 644c  f.gis_layer.addL
-0002d1a0: 696e 6528 0a20 2020 2023 2020 2020 2020  ine(.    #      
-0002d1b0: 2020 2042 6567 696e 583d 7374 6172 745f     BeginX=start_
-0002d1c0: 782c 0a20 2020 2023 2020 2020 2020 2020  x,.    #        
-0002d1d0: 2042 6567 696e 593d 7374 6172 745f 792c   BeginY=start_y,
-0002d1e0: 0a20 2020 2023 2020 2020 2020 2020 2045  .    #         E
-0002d1f0: 6e64 583d 656e 645f 782c 0a20 2020 2023  ndX=end_x,.    #
-0002d200: 2020 2020 2020 2020 2045 6e64 593d 656e           EndY=en
-0002d210: 645f 792c 0a20 2020 2023 2020 2020 2020  d_y,.    #      
-0002d220: 2020 2044 6570 7468 3d33 652d 3036 2c0a     Depth=3e-06,.
-0002d230: 0a20 2020 2023 2020 2020 2029 0a0a 2020  .    #     )..  
-0002d240: 2020 2320 2020 2020 7365 6c66 2e63 6f6e    #     self.con
-0002d250: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
-0002d260: 2e4c 6f61 644c 6179 6572 2873 656c 662e  .LoadLayer(self.
-0002d270: 6769 735f 6c61 7965 7229 0a20 2020 2023  gis_layer).    #
-0002d280: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0002d290: 6f28 6622 4749 5320 5061 7474 6572 6e20  o(f"GIS Pattern 
-0002d2a0: 5365 7475 7020 436f 6d70 6c65 7465 2229  Setup Complete")
-0002d2b0: 0a0a 2020 2020 2320 6465 6620 7275 6e5f  ..    # def run_
-0002d2c0: 4749 5328 7365 6c66 2c70 726f 746f 636f  GIS(self,protoco
-0002d2d0: 6c29 202d 3e20 4e6f 6e65 3a0a 0a0a 2020  l) -> None:...  
-0002d2e0: 2020 2320 2020 2020 6761 735f 6c69 6e65    #     gas_line
-0002d2f0: 203d 2073 656c 662e 6c69 6e65 735b 7072   = self.lines[pr
-0002d300: 6f74 6f63 6f6c 5b27 6761 7327 5d5d 0a0a  otocol['gas']]..
-0002d310: 2020 2020 2320 2020 2020 7472 793a 0a0a      #     try:..
-0002d320: 2020 2020 2320 2020 2020 2020 2020 7365      #         se
-0002d330: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4749  lf.connection.GI
-0002d340: 532e 4f70 656e 5661 6c76 6528 6761 735f  S.OpenValve(gas_
-0002d350: 6c69 6e65 290a 0a20 2020 2023 2020 2020  line)..    #    
-0002d360: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-0002d370: 6e20 6173 2065 3a0a 2020 2020 2320 2020  n as e:.    #   
-0002d380: 2020 2020 2020 6966 2065 2e61 7267 735b        if e.args[
-0002d390: 305d 203d 3d20 2745 7272 6f72 2e4f 7574  0] == 'Error.Out
-0002d3a0: 6761 7352 6571 7569 7265 6427 3a0a 2020  gasRequired':.  
-0002d3b0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-0002d3c0: 6c6f 6767 696e 672e 696e 666f 2822 4f75  logging.info("Ou
-0002d3d0: 7467 6173 7369 6e67 2072 6571 7569 7265  tgassing require
-0002d3e0: 642e 2229 0a20 2020 2023 2020 2020 2020  d.").    #      
-0002d3f0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-0002d400: 6e66 6f28 6622 4f75 7467 6173 7369 6e67  nfo(f"Outgassing
-0002d410: 207b 7072 6f74 6f63 6f6c 5b27 6761 7327   {protocol['gas'
-0002d420: 5d7d 204c 696e 6522 290a 2020 2020 2320  ]} Line").    # 
-0002d430: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002d440: 2e63 6f6e 6e65 6374 696f 6e2e 4749 532e  .connection.GIS.
-0002d450: 4f75 7467 6173 2867 6173 5f6c 696e 6529  Outgas(gas_line)
-0002d460: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0002d470: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0002d480: 6f6e 2e47 4953 2e4f 7065 6e56 616c 7665  on.GIS.OpenValve
-0002d490: 2867 6173 5f6c 696e 6529 0a0a 2020 2020  (gas_line)..    
-0002d4a0: 2320 2020 2020 7661 6c76 655f 6f70 656e  #     valve_open
-0002d4b0: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
-0002d4c0: 6f6e 2e47 4953 2e47 6574 5661 6c76 6553  on.GIS.GetValveS
-0002d4d0: 7461 7475 7328 6761 735f 6c69 6e65 290a  tatus(gas_line).
-0002d4e0: 0a20 2020 2023 2020 2020 2074 7279 3a0a  .    #     try:.
-0002d4f0: 2020 2020 2320 2020 2020 2020 2020 2320      #         # 
-0002d500: 5275 6e20 7072 6564 6566 696e 6564 2064  Run predefined d
-0002d510: 6570 6f73 6974 696f 6e20 7072 6f63 6573  eposition proces
-0002d520: 730a 2020 2020 2320 2020 2020 2020 2020  s.    #         
-0002d530: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0002d540: 4472 6177 4265 616d 2e53 7461 7274 2829  DrawBeam.Start()
-0002d550: 0a20 2020 2023 2020 2020 2020 2020 2073  .    #         s
-0002d560: 656c 662e 636f 6e6e 6563 7469 6f6e 2e50  elf.connection.P
-0002d570: 726f 6772 6573 732e 5368 6f77 2822 4472  rogress.Show("Dr
-0002d580: 6177 4265 616d 222c 2022 4c61 7965 7220  awBeam", "Layer 
-0002d590: 3120 696e 2070 726f 6772 6573 7322 2c20  1 in progress", 
-0002d5a0: 4661 6c73 652c 2046 616c 7365 2c20 302c  False, False, 0,
-0002d5b0: 2031 3030 290a 2020 2020 2320 2020 2020   100).    #     
-0002d5c0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-0002d5d0: 2822 5370 7574 7465 7269 6e67 2073 7461  ("Sputtering sta
-0002d5e0: 7274 6564 2e22 290a 2020 2020 2320 2020  rted.").    #   
-0002d5f0: 2020 2020 2020 7768 696c 6520 5472 7565        while True
-0002d600: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
-0002d610: 2020 2020 7374 6174 7573 203d 2073 656c      status = sel
-0002d620: 662e 636f 6e6e 6563 7469 6f6e 2e44 7261  f.connection.Dra
-0002d630: 7742 6561 6d2e 4765 7453 7461 7475 7328  wBeam.GetStatus(
-0002d640: 290a 2020 2020 2320 2020 2020 2020 2020  ).    #         
-0002d650: 2020 2020 7275 6e6e 696e 6720 3d20 7374      running = st
-0002d660: 6174 7573 5b30 5d20 3d3d 2073 656c 662e  atus[0] == self.
-0002d670: 636f 6e6e 6563 7469 6f6e 2e44 7261 7742  connection.DrawB
-0002d680: 6561 6d2e 5374 6174 7573 2e50 726f 6a65  eam.Status.Proje
-0002d690: 6374 4c6f 6164 6564 4578 706f 7369 7469  ctLoadedExpositi
-0002d6a0: 6f6e 496e 5072 6f67 7265 7373 0a20 2020  onInProgress.   
-0002d6b0: 2023 2020 2020 2020 2020 2020 2020 2069   #             i
-0002d6c0: 6620 7275 6e6e 696e 673a 0a20 2020 2023  f running:.    #
-0002d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d6e0: 2070 726f 6772 6573 7320 3d20 300a 2020   progress = 0.  
-0002d6f0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-0002d700: 2020 2020 6966 2073 7461 7475 735b 315d      if status[1]
-0002d710: 203e 2030 3a0a 2020 2020 2320 2020 2020   > 0:.    #     
-0002d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d730: 7072 6f67 7265 7373 203d 206d 696e 2831  progress = min(1
-0002d740: 3030 2c20 7374 6174 7573 5b32 5d20 2f20  00, status[2] / 
-0002d750: 7374 6174 7573 5b31 5d20 2a20 3130 3029  status[1] * 100)
-0002d760: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0002d770: 2020 2020 2020 2070 7269 6e74 5072 6f67         printProg
-0002d780: 7265 7373 4261 7228 7072 6f67 7265 7373  ressBar(progress
-0002d790: 2c20 3130 3029 0a20 2020 2023 2020 2020  , 100).    #    
-0002d7a0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0002d7b0: 662e 636f 6e6e 6563 7469 6f6e 2e50 726f  f.connection.Pro
-0002d7c0: 6772 6573 732e 5365 7450 6572 6365 6e74  gress.SetPercent
-0002d7d0: 7328 7072 6f67 7265 7373 290a 2020 2020  s(progress).    
-0002d7e0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-0002d7f0: 2020 7469 6d65 2e73 6c65 6570 2831 290a    time.sleep(1).
-0002d800: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-0002d810: 2020 656c 7365 3a0a 2020 2020 2320 2020    else:.    #   
-0002d820: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002d830: 2073 7461 7475 735b 305d 203d 3d20 7365   status[0] == se
-0002d840: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4472  lf.connection.Dr
-0002d850: 6177 4265 616d 2e53 7461 7475 732e 5072  awBeam.Status.Pr
-0002d860: 6f6a 6563 744c 6f61 6465 6445 7870 6f73  ojectLoadedExpos
-0002d870: 6974 696f 6e49 646c 653a 0a20 2020 2023  itionIdle:.    #
-0002d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d890: 2020 2020 2070 7269 6e74 5072 6f67 7265       printProgre
-0002d8a0: 7373 4261 7228 3130 302c 2031 3030 2c20  ssBar(100, 100, 
-0002d8b0: 7375 6666 6978 3d27 4669 6e69 7368 6564  suffix='Finished
-0002d8c0: 2729 0a20 2020 2023 2020 2020 2020 2020  ').    #        
-0002d8d0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0002d8e0: 6e74 2827 2729 0a20 2020 2023 2020 2020  nt('').    #    
-0002d8f0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0002d900: 616b 0a20 2020 2023 2020 2020 2066 696e  ak.    #     fin
-0002d910: 616c 6c79 3a0a 2020 2020 2320 2020 2020  ally:.    #     
-0002d920: 2020 2020 2320 436c 6f73 6520 4749 5320      # Close GIS 
-0002d930: 5661 6c76 6520 696e 2062 6f74 6820 2d20  Valve in both - 
-0002d940: 7375 6363 6573 7320 616e 6420 6661 696c  success and fail
-0002d950: 7572 650a 2020 2020 2320 2020 2020 2020  ure.    #       
-0002d960: 2020 6966 2076 616c 7665 5f6f 7065 6e3a    if valve_open:
-0002d970: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
-0002d980: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
-0002d990: 6f6e 2e47 4953 2e43 6c6f 7365 5661 6c76  on.GIS.CloseValv
-0002d9a0: 6528 6761 735f 6c69 6e65 290a 0a20 2020  e(gas_line)..   
-0002d9b0: 2023 2020 2020 2073 656c 662e 636f 6e6e   #     self.conn
-0002d9c0: 6563 7469 6f6e 2e47 4953 2e4d 6f76 6554  ection.GIS.MoveT
-0002d9d0: 6f28 6761 735f 6c69 6e65 2c20 4175 746f  o(gas_line, Auto
-0002d9e0: 6d61 7469 6f6e 2e47 4953 2e50 6f73 6974  mation.GIS.Posit
-0002d9f0: 696f 6e2e 486f 6d65 290a 2020 2020 2320  ion.Home).    # 
-0002da00: 2020 2020 2320 7365 6c66 2e63 6f6e 6e65      # self.conne
-0002da10: 6374 696f 6e2e 4749 532e 5072 6570 6172  ction.GIS.Prepar
-0002da20: 6554 656d 7065 7261 7475 7265 2867 6173  eTemperature(gas
-0002da30: 5f6c 696e 652c 2046 616c 7365 290a 2020  _line, False).  
-0002da40: 2020 2320 2020 2020 7365 6c66 2e63 6f6e    #     self.con
-0002da50: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
-0002da60: 2e55 6e6c 6f61 644c 6179 6572 2829 0a20  .UnloadLayer(). 
-0002da70: 2020 2023 2020 2020 206c 6f67 6769 6e67     #     logging
-0002da80: 2e69 6e66 6f28 2270 726f 6365 7373 2063  .info("process c
-0002da90: 6f6d 706c 6574 6564 2e22 290a 0a0a 2020  ompleted.")...  
-0002daa0: 2020 2320 6465 6620 4749 535f 6176 6169    # def GIS_avai
-0002dab0: 6c61 626c 655f 6c69 6e65 7328 7365 6c66  lable_lines(self
-0002dac0: 2920 2d3e 206c 6973 745b 7374 725d 3a0a  ) -> list[str]:.
-0002dad0: 2020 2020 2320 2020 2020 2222 220a 2020      #     """.  
-0002dae0: 2020 2320 2020 2020 5265 7475 726e 7320    #     Returns 
-0002daf0: 6120 6c69 7374 206f 6620 6176 6169 6c61  a list of availa
-0002db00: 626c 6520 4749 5320 6c69 6e65 732e 0a20  ble GIS lines.. 
-0002db10: 2020 2023 2020 2020 2041 7267 733a 0a20     #     Args:. 
-0002db20: 2020 2023 2020 2020 2020 2020 204e 6f6e     #         Non
-0002db30: 650a 2020 2020 2320 2020 2020 5265 7475  e.    #     Retu
-0002db40: 726e 733a 0a20 2020 2023 2020 2020 2020  rns:.    #      
-0002db50: 2020 2041 2064 6963 7469 6f6e 6172 7920     A dictionary 
-0002db60: 6f66 2061 7661 696c 6162 6c65 2047 4953  of available GIS
-0002db70: 206c 696e 6573 2e0a 2020 2020 2320 2020   lines..    #   
-0002db80: 2020 2222 220a 2020 2020 2320 2020 2020    """.    #     
-0002db90: 5f63 6865 636b 5f73 7075 7474 6572 2873  _check_sputter(s
-0002dba0: 656c 662e 7379 7374 656d 290a 2020 2020  elf.system).    
-0002dbb0: 2320 2020 2020 4749 535f 6c69 6e65 7320  #     GIS_lines 
-0002dbc0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
-0002dbd0: 6e2e 4749 532e 456e 756d 2829 0a20 2020  n.GIS.Enum().   
-0002dbe0: 2023 2020 2020 2073 656c 662e 6c69 6e65   #     self.line
-0002dbf0: 7320 3d20 7b7d 0a20 2020 2023 2020 2020  s = {}.    #    
-0002dc00: 206c 696e 655f 6e61 6d65 7320 3d20 5b5d   line_names = []
-0002dc10: 0a20 2020 2023 2020 2020 2066 6f72 206c  .    #     for l
-0002dc20: 696e 6520 696e 2047 4953 5f6c 696e 6573  ine in GIS_lines
-0002dc30: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
-0002dc40: 7365 6c66 2e6c 696e 6573 5b6c 696e 652e  self.lines[line.
-0002dc50: 6e61 6d65 5d20 3d20 6c69 6e65 0a20 2020  name] = line.   
-0002dc60: 2023 2020 2020 2020 2020 206c 696e 655f   #         line_
-0002dc70: 6e61 6d65 732e 6170 7065 6e64 286c 696e  names.append(lin
-0002dc80: 652e 6e61 6d65 290a 0a20 2020 2023 2020  e.name)..    #  
-0002dc90: 2020 2072 6574 7572 6e20 6c69 6e65 5f6e     return line_n
-0002dca0: 616d 6573 0a0a 2020 2020 2320 6465 6620  ames..    # def 
-0002dcb0: 4749 535f 706f 7369 7469 6f6e 2873 656c  GIS_position(sel
-0002dcc0: 662c 6c69 6e65 5f6e 616d 653a 7374 7229  f,line_name:str)
-0002dcd0: 202d 3e20 7374 723a 0a20 2020 2023 2020   -> str:.    #  
-0002dce0: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
-0002dcf0: 7228 7365 6c66 2e73 7973 7465 6d29 0a0a  r(self.system)..
-0002dd00: 2020 2020 2320 2020 2020 6c69 6e65 203d      #     line =
-0002dd10: 2073 656c 662e 6c69 6e65 735b 6c69 6e65   self.lines[line
-0002dd20: 5f6e 616d 655d 0a0a 2020 2020 2320 2020  _name]..    #   
-0002dd30: 2020 706f 7369 7469 6f6e 203d 2073 656c    position = sel
-0002dd40: 662e 636f 6e6e 6563 7469 6f6e 2e47 4953  f.connection.GIS
-0002dd50: 2e47 6574 506f 7369 7469 6f6e 286c 696e  .GetPosition(lin
-0002dd60: 6529 0a0a 2020 2020 2320 2020 2020 7265  e)..    #     re
-0002dd70: 7475 726e 2070 6f73 6974 696f 6e2e 6e61  turn position.na
-0002dd80: 6d65 0a0a 2020 2020 2320 6465 6620 4749  me..    # def GI
-0002dd90: 535f 6176 6169 6c61 626c 655f 706f 7369  S_available_posi
-0002dda0: 7469 6f6e 7328 7365 6c66 2920 2d3e 206c  tions(self) -> l
-0002ddb0: 6973 745b 7374 725d 3a0a 0a20 2020 2023  ist[str]:..    #
-0002ddc0: 2020 2020 205f 6368 6563 6b5f 7370 7574       _check_sput
-0002ddd0: 7465 7228 7365 6c66 2e73 7973 7465 6d29  ter(self.system)
-0002dde0: 0a20 2020 2023 2020 2020 2073 656c 662e  .    #     self.
-0002ddf0: 4749 535f 706f 7369 7469 6f6e 7320 3d20  GIS_positions = 
-0002de00: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0002de10: 4749 532e 506f 7369 7469 6f6e 0a0a 2020  GIS.Position..  
-0002de20: 2020 2320 2020 2020 7265 7475 726e 2073    #     return s
-0002de30: 656c 662e 4749 535f 706f 7369 7469 6f6e  elf.GIS_position
-0002de40: 732e 5f5f 6d65 6d62 6572 735f 5f2e 6b65  s.__members__.ke
-0002de50: 7973 2829 0a0a 2020 2020 2320 6465 6620  ys()..    # def 
-0002de60: 4749 535f 6d6f 7665 5f74 6f28 7365 6c66  GIS_move_to(self
-0002de70: 2c6c 696e 655f 6e61 6d65 2c70 6f73 6974  ,line_name,posit
-0002de80: 696f 6e29 202d 3e20 4e6f 6e65 3a0a 0a20  ion) -> None:.. 
-0002de90: 2020 2023 2020 2020 205f 6368 6563 6b5f     #     _check_
-0002dea0: 7370 7574 7465 7228 7365 6c66 2e73 7973  sputter(self.sys
-0002deb0: 7465 6d29 0a0a 2020 2020 2320 2020 2020  tem)..    #     
-0002dec0: 6c69 6e65 203d 2073 656c 662e 6c69 6e65  line = self.line
-0002ded0: 735b 6c69 6e65 5f6e 616d 655d 0a0a 2020  s[line_name]..  
-0002dee0: 2020 2320 2020 2020 7365 6c66 2e63 6f6e    #     self.con
-0002def0: 6e65 6374 696f 6e2e 4749 532e 4d6f 7665  nection.GIS.Move
-0002df00: 546f 286c 696e 652c 7365 6c66 2e47 4953  To(line,self.GIS
-0002df10: 5f70 6f73 6974 696f 6e73 5b70 6f73 6974  _positions[posit
-0002df20: 696f 6e5d 290a 0a20 2020 2023 2064 6566  ion])..    # def
-0002df30: 2047 4953 5f68 6561 745f 7570 2873 656c   GIS_heat_up(sel
-0002df40: 662c 6c69 6e65 5f6e 616d 6529 3a0a 0a20  f,line_name):.. 
-0002df50: 2020 2023 2020 2020 205f 6368 6563 6b5f     #     _check_
-0002df60: 7370 7574 7465 7228 7365 6c66 2e73 7973  sputter(self.sys
-0002df70: 7465 6d29 0a0a 2020 2020 2320 2020 2020  tem)..    #     
-0002df80: 6c69 6e65 203d 2073 656c 662e 6c69 6e65  line = self.line
-0002df90: 735b 6c69 6e65 5f6e 616d 655d 0a0a 2020  s[line_name]..  
-0002dfa0: 2020 2320 2020 2020 7365 6c66 2e63 6f6e    #     self.con
-0002dfb0: 6e65 6374 696f 6e2e 4749 532e 5072 6570  nection.GIS.Prep
-0002dfc0: 6172 6554 656d 7065 7261 7475 7265 286c  areTemperature(l
-0002dfd0: 696e 652c 5472 7565 290a 0a20 2020 2023  ine,True)..    #
-0002dfe0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0002dff0: 7469 6f6e 2e47 4953 2e57 6169 7446 6f72  tion.GIS.WaitFor
-0002e000: 5465 6d70 6572 6174 7572 6552 6561 6479  TemperatureReady
-0002e010: 286c 696e 6529 0a0a 2020 2020 2320 2020  (line)..    #   
-0002e020: 2020 7469 6d65 2e73 6c65 6570 2835 290a    time.sleep(5).
-0002e030: 0a20 2020 2023 2064 6566 2047 4953 5f74  .    # def GIS_t
-0002e040: 656d 705f 7265 6164 7928 7365 6c66 2c6c  emp_ready(self,l
-0002e050: 696e 655f 6e61 6d65 293a 0a0a 2020 2020  ine_name):..    
-0002e060: 2320 2020 2020 5f63 6865 636b 5f73 7075  #     _check_spu
-0002e070: 7474 6572 2873 656c 662e 7379 7374 656d  tter(self.system
-0002e080: 290a 0a20 2020 2023 2020 2020 206c 696e  )..    #     lin
-0002e090: 6520 3d20 7365 6c66 2e6c 696e 6573 5b6c  e = self.lines[l
-0002e0a0: 696e 655f 6e61 6d65 5d0a 0a20 2020 2023  ine_name]..    #
-0002e0b0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002e0c0: 2e63 6f6e 6e65 6374 696f 6e2e 4749 532e  .connection.GIS.
-0002e0d0: 4765 7454 656d 7065 7261 7475 7265 5265  GetTemperatureRe
-0002e0e0: 6164 7928 6c69 6e65 290a 0a20 2020 2064  ady(line)..    d
-0002e0f0: 6566 2073 6574 5f6d 6963 726f 7363 6f70  ef set_microscop
-0002e100: 655f 7374 6174 6528 7365 6c66 2c20 6d69  e_state(self, mi
-0002e110: 6372 6f73 636f 7065 5f73 7461 7465 3a20  croscope_state: 
-0002e120: 4d69 6372 6f73 636f 7065 5374 6174 6529  MicroscopeState)
-0002e130: 3a0a 2020 2020 2020 2020 2222 2252 6573  :.        """Res
-0002e140: 6574 2074 6865 206d 6963 726f 7363 6f70  et the microscop
-0002e150: 6520 7374 6174 6520 746f 2074 6865 2070  e state to the p
-0002e160: 726f 7669 6465 6420 7374 6174 652e 0a0a  rovided state...
-0002e170: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
-0002e180: 2020 2020 2020 2020 2020 6d69 6372 6f73            micros
-0002e190: 636f 7065 5f73 7461 7465 2028 4d69 6372  cope_state (Micr
-0002e1a0: 6f73 636f 7065 5374 6174 6529 3a20 4120  oscopeState): A 
-0002e1b0: 604d 6963 726f 7363 6f70 6553 7461 7465  `MicroscopeState
-0002e1c0: 6020 6f62 6a65 6374 2074 6861 7420 636f  ` object that co
-0002e1d0: 6e74 6169 6e73 2074 6865 2064 6573 6972  ntains the desir
-0002e1e0: 6564 2073 7461 7465 206f 6620 7468 6520  ed state of the 
-0002e1f0: 6d69 6372 6f73 636f 7065 2e0a 0a20 2020  microscope...   
-0002e200: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
-0002e210: 2020 2020 2020 2020 2020 4e6f 6e65 2e0a            None..
-0002e220: 0a20 2020 2020 2020 2052 6169 7365 733a  .        Raises:
-0002e230: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
-0002e240: 652e 0a0a 2020 2020 2020 2020 4e6f 7465  e...        Note
-0002e250: 733a 0a20 2020 2020 2020 2020 2020 2054  s:.            T
-0002e260: 6869 7320 6675 6e63 7469 6f6e 2072 6573  his function res
-0002e270: 746f 7265 7320 7468 6520 6d69 6372 6f73  tores the micros
-0002e280: 636f 7065 2073 7461 7465 2074 6f20 7468  cope state to th
-0002e290: 6520 7072 6f76 6964 6564 2073 7461 7465  e provided state
-0002e2a0: 2e20 5468 6973 2066 756e 6374 696f 6e20  . This function 
-0002e2b0: 6361 6e6e 6f74 2062 6520 6675 6c6c 7920  cannot be fully 
-0002e2c0: 696d 706c 656d 656e 7465 6420 6173 2074  implemented as t
-0002e2d0: 6865 6972 2061 7265 2063 6572 7461 696e  heir are certain
-0002e2e0: 2061 7370 6563 7473 206f 660a 2020 2020   aspects of.    
-0002e2f0: 2020 2020 2020 2020 7468 6520 7374 6174          the stat
-0002e300: 6520 7468 6174 2063 616e 6e6f 7420 6265  e that cannot be
-0002e310: 2073 6574 2066 6f72 2074 6865 2054 4553   set for the TES
-0002e320: 4341 4e20 6d69 6372 6f73 636f 7065 2062  CAN microscope b
-0002e330: 7920 7468 6520 5445 5343 414e 2041 7574  y the TESCAN Aut
-0002e340: 6f6d 6174 696f 6e20 4150 492e 0a20 2020  omation API..   
-0002e350: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-0002e360: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-0002e370: 2272 6573 746f 7269 6e67 206d 6963 726f  "restoring micro
-0002e380: 7363 6f70 6520 7374 6174 652e 2e2e 2229  scope state...")
-0002e390: 0a0a 2020 2020 2020 2020 2320 7265 7374  ..        # rest
-0002e3a0: 6f72 6520 656c 6563 7472 6f6e 2062 6561  ore electron bea
-0002e3b0: 6d0a 2020 2020 2020 2020 5f63 6865 636b  m.        _check
-0002e3c0: 5f62 6561 6d28 4265 616d 5479 7065 2e45  _beam(BeamType.E
-0002e3d0: 4c45 4354 524f 4e2c 2073 656c 662e 7379  LECTRON, self.sy
-0002e3e0: 7374 656d 290a 2020 2020 2020 2020 6c6f  stem).        lo
-0002e3f0: 6767 696e 672e 696e 666f 2866 2272 6573  gging.info(f"res
-0002e400: 746f 7269 6e67 2065 6c65 6374 726f 6e20  toring electron 
-0002e410: 6265 616d 2073 6574 7469 6e67 732e 2e2e  beam settings...
-0002e420: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0002e430: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e4f  connection.SEM.O
-0002e440: 7074 6963 732e 5365 7457 4428 0a20 2020  ptics.SetWD(.   
-0002e450: 2020 2020 2020 2020 206d 6963 726f 7363           microsc
-0002e460: 6f70 655f 7374 6174 652e 656c 6563 7472  ope_state.electr
-0002e470: 6f6e 5f62 6561 6d2e 776f 726b 696e 675f  on_beam.working_
-0002e480: 6469 7374 616e 6365 0a20 2020 2020 2020  distance.       
-0002e490: 2020 2020 202a 2063 6f6e 7374 616e 7473       * constants
-0002e4a0: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
-0002e4b0: 4554 5245 0a20 2020 2020 2020 2029 0a0a  ETRE.        )..
-0002e4c0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0002e4d0: 6e65 6374 696f 6e2e 5345 4d2e 4265 616d  nection.SEM.Beam
-0002e4e0: 2e53 6574 4375 7272 656e 7428 0a20 2020  .SetCurrent(.   
-0002e4f0: 2020 2020 2020 2020 206d 6963 726f 7363           microsc
-0002e500: 6f70 655f 7374 6174 652e 656c 6563 7472  ope_state.electr
-0002e510: 6f6e 5f62 6561 6d2e 6265 616d 5f63 7572  on_beam.beam_cur
-0002e520: 7265 6e74 202a 2063 6f6e 7374 616e 7473  rent * constants
-0002e530: 2e53 495f 544f 5f50 4943 4f0a 2020 2020  .SI_TO_PICO.    
-0002e540: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-0002e550: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
-0002e560: 454d 2e4f 7074 6963 732e 5365 7456 6965  EM.Optics.SetVie
-0002e570: 7766 6965 6c64 280a 2020 2020 2020 2020  wfield(.        
-0002e580: 2020 2020 6d69 6372 6f73 636f 7065 5f73      microscope_s
-0002e590: 7461 7465 2e65 6c65 6374 726f 6e5f 6265  tate.electron_be
-0002e5a0: 616d 2e68 6677 202a 2063 6f6e 7374 616e  am.hfw * constan
-0002e5b0: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
-0002e5c0: 494d 4554 5245 0a20 2020 2020 2020 2029  IMETRE.        )
-0002e5d0: 0a0a 2020 2020 2020 2020 6966 206d 6963  ..        if mic
-0002e5e0: 726f 7363 6f70 655f 7374 6174 652e 656c  roscope_state.el
-0002e5f0: 6563 7472 6f6e 5f62 6561 6d2e 7368 6966  ectron_beam.shif
-0002e600: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-0002e610: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0002e620: 286d 6963 726f 7363 6f70 655f 7374 6174  (microscope_stat
-0002e630: 652e 656c 6563 7472 6f6e 5f62 6561 6d2e  e.electron_beam.
-0002e640: 7368 6966 742e 782c 206d 6963 726f 7363  shift.x, microsc
-0002e650: 6f70 655f 7374 6174 652e 656c 6563 7472  ope_state.electr
-0002e660: 6f6e 5f62 6561 6d2e 7368 6966 742e 7929  on_beam.shift.y)
-0002e670: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002e680: 662e 636f 6e6e 6563 7469 6f6e 2e53 454d  f.connection.SEM
-0002e690: 2e4f 7074 6963 732e 5365 7449 6d61 6765  .Optics.SetImage
-0002e6a0: 5368 6966 7428 6d69 6372 6f73 636f 7065  Shift(microscope
-0002e6b0: 5f73 7461 7465 2e65 6c65 6374 726f 6e5f  _state.electron_
-0002e6c0: 6265 616d 2e73 6869 6674 2e78 2c20 6d69  beam.shift.x, mi
-0002e6d0: 6372 6f73 636f 7065 5f73 7461 7465 2e65  croscope_state.e
-0002e6e0: 6c65 6374 726f 6e5f 6265 616d 2e73 6869  lectron_beam.shi
-0002e6f0: 6674 2e79 290a 2020 2020 2020 2020 2020  ft.y).          
-0002e700: 2020 7469 6d65 2e73 6c65 6570 2831 290a    time.sleep(1).
-0002e710: 2020 2020 2020 2020 6966 206d 6963 726f          if micro
-0002e720: 7363 6f70 655f 7374 6174 652e 656c 6563  scope_state.elec
-0002e730: 7472 6f6e 5f62 6561 6d2e 7363 616e 5f72  tron_beam.scan_r
-0002e740: 6f74 6174 696f 6e20 6973 206e 6f74 204e  otation is not N
-0002e750: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002e760: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002e770: 2e53 454d 2e4f 7074 6963 732e 5365 7449  .SEM.Optics.SetI
-0002e780: 6d61 6765 526f 7461 7469 6f6e 286d 6963  mageRotation(mic
-0002e790: 726f 7363 6f70 655f 7374 6174 652e 656c  roscope_state.el
-0002e7a0: 6563 7472 6f6e 5f62 6561 6d2e 7363 616e  ectron_beam.scan
-0002e7b0: 5f72 6f74 6174 696f 6e29 0a20 2020 2020  _rotation).     
-0002e7c0: 2020 2023 206d 6963 726f 7363 6f70 652e     # microscope.
-0002e7d0: 6265 616d 732e 656c 6563 7472 6f6e 5f62  beams.electron_b
-0002e7e0: 6561 6d2e 7374 6967 6d61 746f 722e 7661  eam.stigmator.va
-0002e7f0: 6c75 6520 3d20 280a 2020 2020 2020 2020  lue = (.        
-0002e800: 2320 2020 2020 6d69 6372 6f73 636f 7065  #     microscope
-0002e810: 5f73 7461 7465 2e65 6c65 6374 726f 6e5f  _state.electron_
-0002e820: 6265 616d 2e73 7469 676d 6174 696f 6e0a  beam.stigmation.
-0002e830: 2020 2020 2020 2020 2320 290a 2020 2020          # ).    
-0002e840: 2020 2020 7365 6c66 2e73 6574 5f64 6574      self.set_det
-0002e850: 6563 746f 725f 7365 7474 696e 6773 286d  ector_settings(m
-0002e860: 6963 726f 7363 6f70 655f 7374 6174 652e  icroscope_state.
-0002e870: 656c 6563 7472 6f6e 5f64 6574 6563 746f  electron_detecto
-0002e880: 722c 2042 6561 6d54 7970 652e 454c 4543  r, BeamType.ELEC
-0002e890: 5452 4f4e 290a 2020 2020 2020 2020 2320  TRON).        # 
-0002e8a0: 7265 7374 6f72 6520 696f 6e20 6265 616d  restore ion beam
-0002e8b0: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
-0002e8c0: 6265 616d 2842 6561 6d54 7970 652e 494f  beam(BeamType.IO
-0002e8d0: 4e2c 2073 656c 662e 7379 7374 656d 290a  N, self.system).
-0002e8e0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0002e8f0: 696e 666f 2866 2272 6573 746f 7269 6e67  info(f"restoring
-0002e900: 2069 6f6e 2062 6561 6d20 7365 7474 696e   ion beam settin
-0002e910: 6773 2e2e 2e22 290a 0a20 2020 2020 2020  gs...")..       
-0002e920: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002e930: 2e46 4942 2e4f 7074 6963 732e 5365 7456  .FIB.Optics.SetV
-0002e940: 6965 7766 6965 6c64 280a 2020 2020 2020  iewfield(.      
-0002e950: 2020 2020 2020 6d69 6372 6f73 636f 7065        microscope
-0002e960: 5f73 7461 7465 2e69 6f6e 5f62 6561 6d2e  _state.ion_beam.
-0002e970: 6866 7720 2a20 636f 6e73 7461 6e74 732e  hfw * constants.
-0002e980: 4d45 5452 455f 544f 5f4d 494c 4c49 4d45  METRE_TO_MILLIME
-0002e990: 5452 450a 2020 2020 2020 2020 290a 2020  TRE.        ).  
-0002e9a0: 2020 2020 2020 6966 206d 6963 726f 7363        if microsc
-0002e9b0: 6f70 655f 7374 6174 652e 696f 6e5f 6265  ope_state.ion_be
-0002e9c0: 616d 2e73 6869 6674 2069 7320 6e6f 7420  am.shift is not 
-0002e9d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002e9e0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-0002e9f0: 6e2e 4649 422e 4f70 7469 6373 2e53 6574  n.FIB.Optics.Set
-0002ea00: 496d 6167 6553 6869 6674 286d 6963 726f  ImageShift(micro
-0002ea10: 7363 6f70 655f 7374 6174 652e 656c 6563  scope_state.elec
-0002ea20: 7472 6f6e 5f62 6561 6d2e 7368 6966 742e  tron_beam.shift.
-0002ea30: 782c 206d 6963 726f 7363 6f70 655f 7374  x, microscope_st
-0002ea40: 6174 652e 656c 6563 7472 6f6e 5f62 6561  ate.electron_bea
-0002ea50: 6d2e 7368 6966 742e 7929 0a20 2020 2020  m.shift.y).     
-0002ea60: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-0002ea70: 7028 3129 0a20 2020 2020 2020 2069 6620  p(1).        if 
-0002ea80: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-0002ea90: 2e65 6c65 6374 726f 6e5f 6265 616d 2e73  .electron_beam.s
-0002eaa0: 6361 6e5f 726f 7461 7469 6f6e 2069 7320  can_rotation is 
-0002eab0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0002eac0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
-0002ead0: 6374 696f 6e2e 4649 422e 4f70 7469 6373  ction.FIB.Optics
-0002eae0: 2e53 6574 496d 6167 6552 6f74 6174 696f  .SetImageRotatio
-0002eaf0: 6e28 6d69 6372 6f73 636f 7065 5f73 7461  n(microscope_sta
-0002eb00: 7465 2e65 6c65 6374 726f 6e5f 6265 616d  te.electron_beam
-0002eb10: 2e73 6361 6e5f 726f 7461 7469 6f6e 290a  .scan_rotation).
-0002eb20: 2020 2020 2020 2020 2320 6d69 6372 6f73          # micros
-0002eb30: 636f 7065 2e62 6561 6d73 2e69 6f6e 5f62  cope.beams.ion_b
-0002eb40: 6561 6d2e 7374 6967 6d61 746f 722e 7661  eam.stigmator.va
-0002eb50: 6c75 6520 3d20 6d69 6372 6f73 636f 7065  lue = microscope
-0002eb60: 5f73 7461 7465 2e69 6f6e 5f62 6561 6d2e  _state.ion_beam.
-0002eb70: 7374 6967 6d61 7469 6f6e 0a20 2020 2020  stigmation.     
-0002eb80: 2020 2073 656c 662e 7365 745f 6465 7465     self.set_dete
-0002eb90: 6374 6f72 5f73 6574 7469 6e67 7328 6d69  ctor_settings(mi
-0002eba0: 6372 6f73 636f 7065 5f73 7461 7465 2e69  croscope_state.i
-0002ebb0: 6f6e 5f64 6574 6563 746f 722c 2042 6561  on_detector, Bea
-0002ebc0: 6d54 7970 652e 494f 4e29 0a0a 2020 2020  mType.ION)..    
-0002ebd0: 2020 2020 7365 6c66 2e6d 6f76 655f 7374      self.move_st
-0002ebe0: 6167 655f 6162 736f 6c75 7465 286d 6963  age_absolute(mic
-0002ebf0: 726f 7363 6f70 655f 7374 6174 652e 7374  roscope_state.st
-0002ec00: 6167 655f 706f 7369 7469 6f6e 290a 2020  age_position).  
-0002ec10: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-0002ec20: 666f 2866 226d 6963 726f 7363 6f70 6520  fo(f"microscope 
-0002ec30: 7374 6174 6520 7265 7374 6f72 6564 2229  state restored")
-0002ec40: 0a20 2020 2020 2020 2072 6574 7572 6e0a  .        return.
-0002ec50: 0a20 2020 2064 6566 2067 6574 5f61 7661  .    def get_ava
-0002ec60: 696c 6162 6c65 5f76 616c 7565 7328 7365  ilable_values(se
-0002ec70: 6c66 2c20 6b65 793a 2073 7472 2c20 6265  lf, key: str, be
-0002ec80: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-0002ec90: 6520 3d20 4e6f 6e65 292d 3e20 6c69 7374  e = None)-> list
-0002eca0: 3a0a 2020 2020 2020 2020 2222 2247 6574  :.        """Get
-0002ecb0: 2061 206c 6973 7420 6f66 2061 7661 696c   a list of avail
-0002ecc0: 6162 6c65 2076 616c 7565 7320 666f 7220  able values for 
-0002ecd0: 6120 6769 7665 6e20 6b65 792e 0a20 2020  a given key..   
-0002ece0: 2020 2020 204b 6579 733a 2070 6c61 736d       Keys: plasm
-0002ecf0: 615f 6761 732c 2063 7572 7265 6e74 2c20  a_gas, current, 
-0002ed00: 6465 7465 6374 6f72 5f74 7970 650a 2020  detector_type.  
-0002ed10: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0002ed20: 2020 7661 6c75 6573 203d 205b 5d0a 2020    values = [].  
-0002ed30: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-0002ed40: 7065 2069 7320 4265 616d 5479 7065 2e49  pe is BeamType.I
-0002ed50: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
-0002ed60: 6966 206b 6579 203d 3d20 2270 6c61 736d  if key == "plasm
-0002ed70: 615f 6761 7322 3a0a 2020 2020 2020 2020  a_gas":.        
-0002ed80: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
-0002ed90: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002eda0: 2e47 4953 2e45 6e75 6d28 290a 0a20 2020  .GIS.Enum()..   
-0002edb0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-0002edc0: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
-0002edd0: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-0002ede0: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
-0002edf0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-0002ee00: 2020 2020 2020 2020 2076 616c 7565 7320           values 
-0002ee10: 3d20 5b31 2e30 652d 3132 5d0a 2020 2020  = [1.0e-12].    
-0002ee20: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
-0002ee30: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
-0002ee40: 2e49 4f4e 3a0a 2020 2020 2020 2020 2020  .ION:.          
-0002ee50: 2020 2020 2020 7661 6c75 6573 203d 205b        values = [
-0002ee60: 3230 652d 3132 2c20 3630 652d 3132 2c20  20e-12, 60e-12, 
-0002ee70: 302e 3265 2d39 2c20 302e 3734 652d 392c  0.2e-9, 0.74e-9,
-0002ee80: 2032 2e30 652d 392c 2037 2e36 652d 392c   2.0e-9, 7.6e-9,
-0002ee90: 2032 382e 3065 2d39 2c20 3132 3065 2d39   28.0e-9, 120e-9
-0002eea0: 5d0a 0a20 2020 2020 2020 2069 6620 6b65  ]..        if ke
-0002eeb0: 7920 3d3d 2022 6465 7465 6374 6f72 5f74  y == "detector_t
-0002eec0: 7970 6522 2061 6e64 2062 6561 6d5f 7479  ype" and beam_ty
-0002eed0: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
-0002eee0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-0002eef0: 2020 2020 2076 616c 7565 7320 3d20 7365       values = se
-0002ef00: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5345  lf.connection.SE
-0002ef10: 4d2e 4465 7465 6374 6f72 2e45 6e75 6d28  M.Detector.Enum(
-0002ef20: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-0002ef30: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-0002ef40: 2876 616c 7565 7329 293a 0a20 2020 2020  (values)):.     
-0002ef50: 2020 2020 2020 2020 2020 2076 616c 7565             value
-0002ef60: 735b 692d 315d 203d 2076 616c 7565 735b  s[i-1] = values[
-0002ef70: 692d 315d 2e6e 616d 6520 0a20 2020 2020  i-1].name .     
-0002ef80: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
-0002ef90: 7465 6374 6f72 5f74 7970 6522 2061 6e64  tector_type" and
-0002efa0: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
-0002efb0: 616d 5479 7065 2e49 4f4e 3a0a 2020 2020  amType.ION:.    
-0002efc0: 2020 2020 2020 2020 7661 6c75 6573 203d          values =
-0002efd0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002efe0: 2e46 4942 2e44 6574 6563 746f 722e 456e  .FIB.Detector.En
-0002eff0: 756d 2829 0a20 2020 2020 2020 2020 2020  um().           
-0002f000: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0002f010: 6c65 6e28 7661 6c75 6573 2929 3a0a 2020  len(values)):.  
-0002f020: 2020 2020 2020 2020 2020 2020 2020 7661                va
-0002f030: 6c75 6573 5b69 2d31 5d20 3d20 7661 6c75  lues[i-1] = valu
-0002f040: 6573 5b69 2d31 5d2e 6e61 6d65 0a20 2020  es[i-1].name.   
-0002f050: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-0002f060: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
-0002f070: 725f 6d6f 6465 223a 200a 2020 2020 2020  r_mode": .      
-0002f080: 2020 2020 2020 7661 6c75 6573 203d 204e        values = N
-0002f090: 6f6e 6520 0a0a 2020 2020 2020 2020 6966  one ..        if
-0002f0a0: 206b 6579 203d 3d20 2270 7265 7365 7473   key == "presets
-0002f0b0: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-0002f0c0: 6574 7572 6e20 7365 6c66 2e5f 6765 745f  eturn self._get_
-0002f0d0: 7072 6573 6574 7328 290a 0a20 2020 2020  presets()..     
-0002f0e0: 2020 2069 6620 6b65 7920 3d3d 2022 7363     if key == "sc
-0002f0f0: 616e 5f64 6972 6563 7469 6f6e 223a 0a20  an_direction":. 
-0002f100: 2020 2020 2020 2020 2020 2076 616c 7565             value
-0002f110: 7320 3d20 5b22 466c 7962 6163 6b22 2c20  s = ["Flyback", 
-0002f120: 2252 4c45 222c 2022 5370 6972 616c 496e  "RLE", "SpiralIn
-0002f130: 7369 6465 4f75 7422 2c20 2253 7069 7261  sideOut", "Spira
-0002f140: 6c4f 7574 7369 6465 496e 222c 2022 5a69  lOutsideIn", "Zi
-0002f150: 675a 6167 225d 0a20 2020 2020 2020 2020  gZag"].         
-0002f160: 2020 200a 0a20 2020 2020 2020 2072 6574     ..        ret
-0002f170: 7572 6e20 7661 6c75 6573 0a0a 2020 200a  urn values..   .
-0002f180: 2020 2020 6465 6620 5f67 6574 2873 656c      def _get(sel
-0002f190: 662c 206b 6579 3a20 7374 722c 2062 6561  f, key: str, bea
-0002f1a0: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
-0002f1b0: 203d 204e 6f6e 6529 202d 3e20 556e 696f   = None) -> Unio
-0002f1c0: 6e5b 666c 6f61 742c 2073 7472 2c20 4e6f  n[float, str, No
-0002f1d0: 6e65 5d3a 0a20 2020 2020 2020 2022 2222  ne]:.        """
-0002f1e0: 4765 7420 6120 7072 6f70 6572 7479 206f  Get a property o
-0002f1f0: 6620 7468 6520 6d69 6372 6f73 636f 7065  f the microscope
-0002f200: 2e22 2222 0a20 2020 2020 2020 2069 6620  .""".        if 
-0002f210: 6265 616d 5f74 7970 6520 6973 204e 6f6e  beam_type is Non
-0002f220: 653a 0a20 2020 2020 2020 2020 2020 2062  e:.            b
-0002f230: 6561 6d20 3d20 7365 6c66 2e63 6f6e 6e65  eam = self.conne
-0002f240: 6374 696f 6e2e 5345 4d20 6966 2062 6561  ction.SEM if bea
-0002f250: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
-0002f260: 7065 2e45 4c45 4354 524f 4e20 656c 7365  pe.ELECTRON else
-0002f270: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
-0002f280: 2e46 4942 0a20 2020 2020 2020 2020 2020  .FIB.           
-0002f290: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-0002f2a0: 6d5f 7479 7065 2c20 7365 6c66 2e73 7973  m_type, self.sys
-0002f2b0: 7465 6d29 0a20 2020 2020 2020 200a 2020  tem).        .  
-0002f2c0: 2020 2020 2020 2320 6265 616d 2070 726f        # beam pro
-0002f2d0: 7065 7274 6965 7320 0a20 2020 2020 2020  perties .       
-0002f2e0: 2069 6620 6b65 7920 3d3d 2022 6f6e 223a   if key == "on":
-0002f2f0: 200a 2020 2020 2020 2020 2020 2020 7265   .            re
-0002f300: 7475 726e 2062 6561 6d2e 4265 616d 2e47  turn beam.Beam.G
-0002f310: 6574 5374 6174 7573 2829 0a20 2020 2020  etStatus().     
-0002f320: 2020 2069 6620 6b65 7920 3d3d 2022 776f     if key == "wo
-0002f330: 726b 696e 675f 6469 7374 616e 6365 2220  rking_distance" 
-0002f340: 616e 6420 6265 616d 5f74 7970 6520 3d3d  and beam_type ==
-0002f350: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-0002f360: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
-0002f370: 7265 7475 726e 2062 6561 6d2e 4f70 7469  return beam.Opti
-0002f380: 6373 2e47 6574 5744 2829 202a 2063 6f6e  cs.GetWD() * con
-0002f390: 7374 616e 7473 2e4d 494c 4c49 4d45 5452  stants.MILLIMETR
-0002f3a0: 455f 544f 5f4d 4554 5245 0a20 2020 2020  E_TO_METRE.     
-0002f3b0: 2020 2069 6620 6b65 7920 3d3d 2022 6375     if key == "cu
-0002f3c0: 7272 656e 7422 3a0a 2020 2020 2020 2020  rrent":.        
-0002f3d0: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
-0002f3e0: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
-0002f3f0: 4354 524f 4e3a 0a20 2020 2020 2020 2020  CTRON:.         
-0002f400: 2020 2020 2020 2072 6574 7572 6e20 6265         return be
-0002f410: 616d 2e42 6561 6d2e 4765 7443 7572 7265  am.Beam.GetCurre
-0002f420: 6e74 2829 202a 2063 6f6e 7374 616e 7473  nt() * constants
-0002f430: 2e50 4943 4f5f 544f 5f53 490a 2020 2020  .PICO_TO_SI.    
-0002f440: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002f450: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002f460: 7475 726e 2062 6561 6d2e 4265 616d 2e52  turn beam.Beam.R
-0002f470: 6561 6450 726f 6265 4375 7272 656e 7428  eadProbeCurrent(
-0002f480: 2920 2a20 636f 6e73 7461 6e74 732e 5049  ) * constants.PI
-0002f490: 434f 5f54 4f5f 5349 0a20 2020 2020 2020  CO_TO_SI.       
-0002f4a0: 2069 6620 6b65 7920 3d3d 2022 766f 6c74   if key == "volt
-0002f4b0: 6167 6522 3a0a 2020 2020 2020 2020 2020  age":.          
-0002f4c0: 2020 7265 7475 726e 2062 6561 6d2e 4265    return beam.Be
-0002f4d0: 616d 2e47 6574 566f 6c74 6167 6528 2920  am.GetVoltage() 
-0002f4e0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-0002f4f0: 3d3d 2022 6866 7722 3a0a 2020 2020 2020  == "hfw":.      
-0002f500: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
-0002f510: 6d2e 4f70 7469 6373 2e47 6574 5669 6577  m.Optics.GetView
-0002f520: 6669 656c 6428 2920 2a20 636f 6e73 7461  field() * consta
-0002f530: 6e74 732e 4d49 4c4c 494d 4554 5245 5f54  nts.MILLIMETRE_T
-0002f540: 4f5f 4d45 5452 450a 2020 2020 2020 2020  O_METRE.        
-0002f550: 6966 206b 6579 203d 3d20 2272 6573 6f6c  if key == "resol
-0002f560: 7574 696f 6e22 3a0a 2020 2020 2020 2020  ution":.        
-0002f570: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
-0002f580: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
-0002f590: 4354 524f 4e20 616e 6420 7365 6c66 2e6c  CTRON and self.l
-0002f5a0: 6173 745f 696d 6167 655f 6562 2069 7320  ast_image_eb is 
-0002f5b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0002f5c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002f5d0: 2073 656c 662e 6c61 7374 5f69 6d61 6765   self.last_image
-0002f5e0: 5f65 622e 6d65 7461 6461 7461 2e69 6d61  _eb.metadata.ima
-0002f5f0: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
-0002f600: 6c75 7469 6f6e 0a20 2020 2020 2020 2020  lution.         
-0002f610: 2020 2065 6c69 6620 6265 616d 5f74 7970     elif beam_typ
-0002f620: 6520 3d3d 2042 6561 6d54 7970 652e 494f  e == BeamType.IO
-0002f630: 4e20 616e 6420 7365 6c66 2e6c 6173 745f  N and self.last_
-0002f640: 696d 6167 655f 6962 2069 7320 6e6f 7420  image_ib is not 
-0002f650: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002f660: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0002f670: 662e 6c61 7374 5f69 6d61 6765 5f69 622e  f.last_image_ib.
-0002f680: 6d65 7461 6461 7461 2e69 6d61 6765 5f73  metadata.image_s
-0002f690: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
-0002f6a0: 6f6e 0a20 2020 2020 2020 2069 6620 6b65  on.        if ke
-0002f6b0: 7920 3d3d 2022 6477 656c 6c5f 7469 6d65  y == "dwell_time
-0002f6c0: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
-0002f6d0: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
-0002f6e0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-0002f6f0: 2061 6e64 2073 656c 662e 6c61 7374 5f69   and self.last_i
-0002f700: 6d61 6765 5f65 6220 6973 206e 6f74 204e  mage_eb is not N
-0002f710: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002f720: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002f730: 2e6c 6173 745f 696d 6167 655f 6562 2e6d  .last_image_eb.m
-0002f740: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
-0002f750: 7474 696e 6773 2e64 7765 6c6c 5f74 696d  ttings.dwell_tim
-0002f760: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-0002f770: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-0002f780: 4265 616d 5479 7065 2e49 4f4e 2061 6e64  BeamType.ION and
-0002f790: 2073 656c 662e 6c61 7374 5f69 6d61 6765   self.last_image
-0002f7a0: 5f69 6220 6973 206e 6f74 204e 6f6e 653a  _ib is not None:
-0002f7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f7c0: 2072 6574 7572 6e20 7365 6c66 2e6c 6173   return self.las
-0002f7d0: 745f 696d 6167 655f 6962 2e6d 6574 6164  t_image_ib.metad
-0002f7e0: 6174 612e 696d 6167 655f 7365 7474 696e  ata.image_settin
-0002f7f0: 6773 2e64 7765 6c6c 5f74 696d 6520 2020  gs.dwell_time   
-0002f800: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-0002f810: 3d3d 2273 6361 6e5f 726f 7461 7469 6f6e  =="scan_rotation
-0002f820: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-0002f830: 6574 7572 6e20 6265 616d 2e4f 7074 6963  eturn beam.Optic
-0002f840: 732e 4765 7449 6d61 6765 526f 7461 7469  s.GetImageRotati
-0002f850: 6f6e 2829 2020 200a 2020 2020 2020 2020  on()   .        
-0002f860: 6966 206b 6579 203d 3d20 2273 6869 6674  if key == "shift
-0002f870: 223a 0a20 2020 2020 2020 2020 2020 2076  ":.            v
-0002f880: 616c 7565 7320 3d20 6265 616d 2e4f 7074  alues = beam.Opt
-0002f890: 6963 732e 4765 7449 6d61 6765 5368 6966  ics.GetImageShif
-0002f8a0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0002f8b0: 7368 6966 7420 3d20 506f 696e 7428 7661  shift = Point(va
-0002f8c0: 6c75 6573 5b30 5d2a 636f 6e73 7461 6e74  lues[0]*constant
-0002f8d0: 732e 4d49 4c4c 494d 4554 5245 5f54 4f5f  s.MILLIMETRE_TO_
-0002f8e0: 4d45 5452 452c 2076 616c 7565 735b 315d  METRE, values[1]
-0002f8f0: 2a63 6f6e 7374 616e 7473 2e4d 494c 4c49  *constants.MILLI
-0002f900: 4d45 5452 455f 544f 5f4d 4554 5245 290a  METRE_TO_METRE).
-0002f910: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002f920: 726e 2073 6869 6674 0a20 2020 2020 2020  rn shift.       
-0002f930: 200a 0a0a 2020 2020 2020 2020 2320 7379   ...        # sy
-0002f940: 7374 656d 2070 726f 7065 7274 6965 730a  stem properties.
-0002f950: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-0002f960: 3d20 2265 7563 656e 7472 6963 5f68 6569  = "eucentric_hei
-0002f970: 6768 7422 3a0a 2020 2020 2020 2020 2020  ght":.          
-0002f980: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
-0002f990: 7320 4265 616d 5479 7065 2e45 4c45 4354  s BeamType.ELECT
-0002f9a0: 524f 4e3a 0a20 2020 2020 2020 2020 2020  RON:.           
-0002f9b0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002f9c0: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
-0002f9d0: 2e65 7563 656e 7472 6963 5f68 6569 6768  .eucentric_heigh
-0002f9e0: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
-0002f9f0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-0002fa00: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
-0002fa10: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002fa20: 7475 726e 2073 656c 662e 7379 7374 656d  turn self.system
-0002fa30: 2e69 6f6e 2e65 7563 656e 7472 6963 5f68  .ion.eucentric_h
-0002fa40: 6569 6768 740a 2020 2020 2020 2020 2020  eight.          
-0002fa50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002fa60: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0002fa70: 6c75 6545 7272 6f72 2866 2255 6e6b 6e6f  lueError(f"Unkno
-0002fa80: 776e 2062 6561 6d20 7479 7065 3a20 7b62  wn beam type: {b
-0002fa90: 6561 6d5f 7479 7065 7d20 666f 7220 7b6b  eam_type} for {k
-0002faa0: 6579 7d22 290a 0a20 2020 2020 2020 2069  ey}")..        i
-0002fab0: 6620 6b65 7920 3d3d 2022 636f 6c75 6d6e  f key == "column
-0002fac0: 5f74 696c 7422 3a0a 2020 2020 2020 2020  _tilt":.        
-0002fad0: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
-0002fae0: 2069 7320 4265 616d 5479 7065 2e45 4c45   is BeamType.ELE
-0002faf0: 4354 524f 4e3a 0a20 2020 2020 2020 2020  CTRON:.         
-0002fb00: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0002fb10: 6c66 2e73 7973 7465 6d2e 656c 6563 7472  lf.system.electr
-0002fb20: 6f6e 2e63 6f6c 756d 6e5f 7469 6c74 0a20  on.column_tilt. 
-0002fb30: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0002fb40: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
-0002fb50: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
-0002fb60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002fb70: 6e20 7365 6c66 2e73 7973 7465 6d2e 696f  n self.system.io
-0002fb80: 6e2e 636f 6c75 6d6e 5f74 696c 740a 2020  n.column_tilt.  
-0002fb90: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0002fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fbb0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-0002fbc0: 2866 2255 6e6b 6e6f 776e 2062 6561 6d20  (f"Unknown beam 
-0002fbd0: 7479 7065 3a20 7b62 6561 6d5f 7479 7065  type: {beam_type
-0002fbe0: 7d20 666f 7220 7b6b 6579 7d22 290a 0a20  } for {key}").. 
-0002fbf0: 2020 2020 2020 2023 2069 6f6e 2062 6561         # ion bea
-0002fc00: 6d20 7072 6f70 6572 7469 6573 0a20 2020  m properties.   
-0002fc10: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-0002fc20: 706c 6173 6d61 223a 0a20 2020 2020 2020  plasma":.       
-0002fc30: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-0002fc40: 6520 6973 2042 6561 6d54 7970 652e 494f  e is BeamType.IO
-0002fc50: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
-0002fc60: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-0002fc70: 7973 7465 6d2e 696f 6e2e 706c 6173 6d61  ystem.ion.plasma
-0002fc80: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002fc90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002fca0: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
-0002fcb0: 0a20 2020 2020 2020 2023 2073 7461 6765  .        # stage
-0002fcc0: 2070 726f 7065 7274 6965 730a 2020 2020   properties.    
-0002fcd0: 2020 2020 6966 206b 6579 203d 3d20 2273      if key == "s
-0002fce0: 7461 6765 5f70 6f73 6974 696f 6e22 3a0a  tage_position":.
-0002fcf0: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-0002fd00: 636b 5f73 7461 6765 2873 656c 662e 7379  ck_stage(self.sy
-0002fd10: 7374 656d 290a 2020 2020 2020 2020 2020  stem).          
-0002fd20: 2020 7265 7475 726e 2073 656c 662e 6765    return self.ge
-0002fd30: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
-0002fd40: 2829 0a20 2020 2020 2020 2069 6620 6b65  ().        if ke
-0002fd50: 7920 3d3d 2022 7374 6167 655f 6361 6c69  y == "stage_cali
-0002fd60: 6272 6174 6564 223a 0a20 2020 2020 2020  brated":.       
-0002fd70: 2020 2020 205f 6368 6563 6b5f 7374 6167       _check_stag
-0002fd80: 6528 7365 6c66 2e73 7973 7465 6d29 0a20  e(self.system). 
-0002fd90: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002fda0: 6e20 7365 6c66 2e63 6f6e 6e65 6374 696f  n self.connectio
-0002fdb0: 6e2e 5374 6167 652e 4973 4361 6c69 6272  n.Stage.IsCalibr
-0002fdc0: 6174 6564 2829 0a20 2020 2020 2020 200a  ated().        .
-0002fdd0: 2020 2020 2020 2020 2320 6368 616d 6265          # chambe
-0002fde0: 7220 7072 6f70 6572 7469 6573 0a20 2020  r properties.   
-0002fdf0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-0002fe00: 6368 616d 6265 725f 7374 6174 6522 3a0a  chamber_state":.
-0002fe10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002fe20: 726e 2073 656c 662e 636f 6e6e 6563 7469  rn self.connecti
-0002fe30: 6f6e 2e43 6861 6d62 6572 2e47 6574 5374  on.Chamber.GetSt
-0002fe40: 6174 7573 2829 0a20 2020 2020 2020 2069  atus().        i
-0002fe50: 6620 6b65 7920 3d3d 2022 6368 616d 6265  f key == "chambe
-0002fe60: 725f 7072 6573 7375 7265 223a 0a20 2020  r_pressure":.   
-0002fe70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002fe80: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-0002fe90: 4368 616d 6265 722e 4765 7450 7265 7373  Chamber.GetPress
-0002fea0: 7572 6528 3029 0a20 2020 2020 2020 200a  ure(0).        .
-0002feb0: 2020 2020 2020 2020 2320 6465 7465 6374          # detect
-0002fec0: 6f72 2070 726f 7065 7274 6965 730a 2020  or properties.  
-0002fed0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-0002fee0: 2264 6574 6563 746f 725f 7479 7065 223a  "detector_type":
-0002fef0: 0a20 2020 2020 2020 2020 2020 2064 6574  .            det
-0002ff00: 6563 746f 7220 3d20 6265 616d 2e44 6574  ector = beam.Det
-0002ff10: 6563 746f 722e 4765 7428 4368 616e 6e65  ector.Get(Channe
-0002ff20: 6c20 3d20 3029 200a 2020 2020 2020 2020  l = 0) .        
-0002ff30: 2020 2020 6966 2064 6574 6563 746f 7220      if detector 
-0002ff40: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0002ff50: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0002ff60: 7572 6e20 6465 7465 6374 6f72 2e6e 616d  urn detector.nam
-0002ff70: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-0002ff80: 7365 3a20 0a20 2020 2020 2020 2020 2020  se: .           
-0002ff90: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-0002ffa0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-0002ffb0: 3d3d 2022 6465 7465 6374 6f72 5f63 6f6e  == "detector_con
-0002ffc0: 7472 6173 7422 3a0a 2020 2020 2020 2020  trast":.        
-0002ffd0: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
-0002ffe0: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
-0002fff0: 4354 524f 4e3a 0a20 2020 2020 2020 2020  CTRON:.         
-00030000: 2020 2020 2020 2063 6f6e 7472 6173 742c         contrast,
-00030010: 2062 7269 6768 746e 6573 7320 3d20 6265   brightness = be
-00030020: 616d 2e44 6574 6563 746f 722e 4765 7447  am.Detector.GetG
-00030030: 6169 6e42 6c61 636b 2844 6574 6563 746f  ainBlack(Detecto
-00030040: 723d 2073 656c 662e 656c 6563 7472 6f6e  r= self.electron
-00030050: 5f64 6574 6563 746f 725f 6163 7469 7665  _detector_active
-00030060: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00030070: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
-00030080: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
-00030090: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000300a0: 6e74 7261 7374 2c20 6272 6967 6874 6e65  ntrast, brightne
-000300b0: 7373 203d 2062 6561 6d2e 4465 7465 6374  ss = beam.Detect
-000300c0: 6f72 2e47 6574 4761 696e 426c 6163 6b28  or.GetGainBlack(
-000300d0: 4465 7465 6374 6f72 3d20 7365 6c66 2e69  Detector= self.i
-000300e0: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
-000300f0: 7665 290a 2020 2020 2020 2020 2020 2020  ve).            
-00030100: 7265 7475 726e 2063 6f6e 7472 6173 742f  return contrast/
-00030110: 3130 300a 2020 2020 2020 2020 6966 206b  100.        if k
-00030120: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-00030130: 6272 6967 6874 6e65 7373 223a 0a20 2020  brightness":.   
-00030140: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
-00030150: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
-00030160: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
-00030170: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00030180: 7261 7374 2c20 6272 6967 6874 6e65 7373  rast, brightness
-00030190: 203d 2062 6561 6d2e 4465 7465 6374 6f72   = beam.Detector
-000301a0: 2e47 6574 4761 696e 426c 6163 6b28 4465  .GetGainBlack(De
-000301b0: 7465 6374 6f72 3d20 7365 6c66 2e65 6c65  tector= self.ele
-000301c0: 6374 726f 6e5f 6465 7465 6374 6f72 5f61  ctron_detector_a
-000301d0: 6374 6976 6529 0a20 2020 2020 2020 2020  ctive).         
-000301e0: 2020 2065 6c69 6620 6265 616d 5f74 7970     elif beam_typ
-000301f0: 6520 3d3d 2042 6561 6d54 7970 652e 494f  e == BeamType.IO
-00030200: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
-00030210: 2020 2063 6f6e 7472 6173 742c 2062 7269     contrast, bri
-00030220: 6768 746e 6573 7320 3d20 6265 616d 2e44  ghtness = beam.D
-00030230: 6574 6563 746f 722e 4765 7447 6169 6e42  etector.GetGainB
-00030240: 6c61 636b 2844 6574 6563 746f 723d 2073  lack(Detector= s
-00030250: 656c 662e 696f 6e5f 6465 7465 6374 6f72  elf.ion_detector
-00030260: 5f61 6374 6976 6529 0a20 2020 2020 2020  _active).       
-00030270: 2020 2020 2072 6574 7572 6e20 6272 6967       return brig
-00030280: 6874 6e65 7373 2f31 3030 0a20 2020 2020  htness/100.     
-00030290: 2020 200a 2020 2020 2020 2020 2320 6d61     .        # ma
-000302a0: 6e69 7075 6c61 746f 7220 7072 6f70 6572  nipulator proper
-000302b0: 7469 6573 0a20 2020 2020 2020 2069 6620  ties.        if 
-000302c0: 6b65 7920 3d3d 2022 6d61 6e69 7075 6c61  key == "manipula
-000302d0: 746f 725f 706f 7369 7469 6f6e 223a 0a20  tor_position":. 
-000302e0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-000302f0: 6b5f 6d61 6e69 7075 6c61 746f 7228 7365  k_manipulator(se
-00030300: 6c66 2e73 7973 7465 6d29 0a20 2020 2020  lf.system).     
-00030310: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00030320: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4e61  lf.connection.Na
-00030330: 6e6f 6d61 6e69 7075 6c61 746f 722e 4765  nomanipulator.Ge
-00030340: 7450 6f73 6974 696f 6e28 3029 0a20 2020  tPosition(0).   
-00030350: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00030360: 6d61 6e69 7075 6c61 746f 725f 6361 6c69  manipulator_cali
-00030370: 6272 6174 6564 223a 0a20 2020 2020 2020  brated":.       
-00030380: 2020 2020 205f 6368 6563 6b5f 6d61 6e69       _check_mani
-00030390: 7075 6c61 746f 7228 7365 6c66 2e73 7973  pulator(self.sys
-000303a0: 7465 6d29 0a20 2020 2020 2020 2020 2020  tem).           
-000303b0: 2072 6574 7572 6e20 7365 6c66 2e63 6f6e   return self.con
-000303c0: 6e65 6374 696f 6e2e 4e61 6e6f 6d61 6e69  nection.Nanomani
-000303d0: 7075 6c61 746f 722e 4973 4361 6c69 6272  pulator.IsCalibr
-000303e0: 6174 6564 2830 290a 2020 2020 2020 2020  ated(0).        
-000303f0: 6966 206b 6579 203d 3d20 226d 616e 6970  if key == "manip
-00030400: 756c 6174 6f72 5f73 7461 7465 223a 0a20  ulator_state":. 
-00030410: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00030420: 6b5f 6d61 6e69 7075 6c61 746f 7228 7365  k_manipulator(se
-00030430: 6c66 2e73 7973 7465 6d29 0a20 2020 2020  lf.system).     
-00030440: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00030450: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4e61  lf.connection.Na
-00030460: 6e6f 6d61 6e69 7075 6c61 746f 722e 4765  nomanipulator.Ge
-00030470: 7453 7461 7475 7328 3029 0a0a 2020 2020  tStatus(0)..    
-00030480: 2020 2020 6966 206b 6579 203d 3d20 2270      if key == "p
-00030490: 7265 7365 7473 223a 0a20 2020 2020 2020  resets":.       
-000304a0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000304b0: 2e5f 6765 745f 7072 6573 6574 7328 290a  ._get_presets().
-000304c0: 0a0a 2020 2020 2020 2020 2320 6d61 6e75  ..        # manu
-000304d0: 6661 6374 7572 6572 2070 726f 7065 7274  facturer propert
-000304e0: 6965 730a 2020 2020 2020 2020 6966 206b  ies.        if k
-000304f0: 6579 203d 3d20 226d 616e 7566 6163 7475  ey == "manufactu
-00030500: 7265 7222 3a0a 2020 2020 2020 2020 2020  rer":.          
-00030510: 2020 7265 7475 726e 2073 656c 662e 7379    return self.sy
-00030520: 7374 656d 2e69 6e66 6f2e 6d61 6e75 6661  stem.info.manufa
-00030530: 6374 7572 6572 0a20 2020 2020 2020 2069  cturer.        i
-00030540: 6620 6b65 7920 3d3d 2022 6d6f 6465 6c22  f key == "model"
-00030550: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00030560: 7475 726e 2073 656c 662e 7379 7374 656d  turn self.system
-00030570: 2e69 6e66 6f2e 6d6f 6465 6c0a 2020 2020  .info.model.    
-00030580: 2020 2020 6966 206b 6579 203d 3d20 2273      if key == "s
-00030590: 6f66 7477 6172 655f 7665 7273 696f 6e22  oftware_version"
-000305a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000305b0: 7475 726e 2073 656c 662e 7379 7374 656d  turn self.system
-000305c0: 2e69 6e66 6f2e 736f 6674 7761 7265 5f76  .info.software_v
-000305d0: 6572 7369 6f6e 0a20 2020 2020 2020 2069  ersion.        i
-000305e0: 6620 6b65 7920 3d3d 2022 7365 7269 616c  f key == "serial
-000305f0: 5f6e 756d 6265 7222 3a0a 2020 2020 2020  _number":.      
-00030600: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00030610: 662e 7379 7374 656d 2e69 6e66 6f2e 7365  f.system.info.se
-00030620: 7269 616c 5f6e 756d 6265 720a 2020 2020  rial_number.    
-00030630: 2020 2020 6966 206b 6579 203d 3d20 2268      if key == "h
-00030640: 6172 6477 6172 655f 7665 7273 696f 6e22  ardware_version"
-00030650: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00030660: 7475 726e 2073 656c 662e 7379 7374 656d  turn self.system
-00030670: 2e69 6e66 6f2e 6861 7264 7761 7265 5f76  .info.hardware_v
-00030680: 6572 7369 6f6e 0a20 2020 2020 2020 200a  ersion.        .
-00030690: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-000306a0: 3d20 2263 6f6c 756d 6e5f 7469 6c74 223a  = "column_tilt":
-000306b0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000306c0: 4f44 4f3a 2063 6865 636b 2069 6620 7468  ODO: check if th
-000306d0: 6973 2069 7320 6176 6169 6c61 626c 650a  is is available.
-000306e0: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-000306f0: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
-00030700: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
-00030710: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00030720: 6574 7572 6e20 7365 6c66 2e73 7973 7465  eturn self.syste
-00030730: 6d2e 656c 6563 7472 6f6e 2e63 6f6c 756d  m.electron.colum
-00030740: 6e5f 7469 6c74 0a20 2020 2020 2020 2020  n_tilt.         
-00030750: 2020 2065 6c69 6620 6265 616d 5f74 7970     elif beam_typ
-00030760: 6520 6973 2042 6561 6d54 7970 652e 494f  e is BeamType.IO
-00030770: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
-00030780: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-00030790: 7973 7465 6d2e 696f 6e2e 636f 6c75 6d6e  ystem.ion.column
-000307a0: 5f74 696c 740a 2020 2020 2020 2020 2020  _tilt.          
-000307b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000307c0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-000307d0: 6c75 6545 7272 6f72 2866 2255 6e6b 6e6f  lueError(f"Unkno
-000307e0: 776e 2062 6561 6d20 7479 7065 3a20 7b62  wn beam type: {b
-000307f0: 6561 6d5f 7479 7065 7d20 666f 7220 7b6b  eam_type} for {k
-00030800: 6579 7d22 290a 2020 2020 2020 2020 0a20  ey}").        . 
-00030810: 2020 2020 2020 2023 206c 6f67 6769 6e67         # logging
-00030820: 2e77 6172 6e69 6e67 2866 2255 6e6b 6e6f  .warning(f"Unkno
-00030830: 776e 206b 6579 3a20 7b6b 6579 7d20 287b  wn key: {key} ({
-00030840: 6265 616d 5f74 7970 657d 2922 290a 2020  beam_type})").  
-00030850: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00030860: 6520 2020 0a0a 2020 2020 6465 6620 5f73  e   ..    def _s
-00030870: 6574 2873 656c 662c 206b 6579 3a20 7374  et(self, key: st
-00030880: 722c 2076 616c 7565 2c20 6265 616d 5f74  r, value, beam_t
-00030890: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
-000308a0: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
-000308b0: 2020 2020 2020 2022 2222 5365 7420 6120         """Set a 
-000308c0: 7072 6f70 6572 7479 206f 6620 7468 6520  property of the 
-000308d0: 6d69 6372 6f73 636f 7065 2e22 2222 0a20  microscope.""". 
-000308e0: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-000308f0: 7970 6520 6973 204e 6f6e 653a 0a20 2020  ype is None:.   
-00030900: 2020 2020 2020 2020 2062 6561 6d20 3d20           beam = 
-00030910: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-00030920: 5345 4d20 6966 2062 6561 6d5f 7479 7065  SEM if beam_type
-00030930: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
-00030940: 4354 524f 4e20 656c 7365 2073 656c 662e  CTRON else self.
-00030950: 636f 6e6e 6563 7469 6f6e 2e46 4942 0a20  connection.FIB. 
-00030960: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
-00030970: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
-00030980: 2c20 7365 6c66 2e73 7973 7465 6d29 0a0a  , self.system)..
-00030990: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-000309a0: 3d20 2277 6f72 6b69 6e67 5f64 6973 7461  = "working_dista
-000309b0: 6e63 6522 3a0a 2020 2020 2020 2020 2020  nce":.          
-000309c0: 2020 6966 2062 6561 6d5f 7479 7065 203d    if beam_type =
-000309d0: 3d20 4265 616d 5479 7065 2e45 4c45 4354  = BeamType.ELECT
-000309e0: 524f 4e3a 0a20 2020 2020 2020 2020 2020  RON:.           
-000309f0: 2020 2020 2062 6561 6d2e 4f70 7469 6373       beam.Optics
-00030a00: 2e53 6574 5744 2876 616c 7565 202a 2063  .SetWD(value * c
-00030a10: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
-00030a20: 4f5f 4d49 4c4c 494d 4554 5245 290a 2020  O_MILLIMETRE).  
-00030a30: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00030a40: 6767 696e 672e 696e 666f 2866 2245 6c65  gging.info(f"Ele
-00030a50: 6374 726f 6e20 6265 616d 2077 6f72 6b69  ctron beam worki
-00030a60: 6e67 2064 6973 7461 6e63 6520 7365 7420  ng distance set 
-00030a70: 746f 207b 7661 6c75 657d 206d 2e22 290a  to {value} m.").
-00030a80: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00030a90: 3a20 0a20 2020 2020 2020 2020 2020 2020  : .             
-00030aa0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00030ab0: 6622 5365 7474 696e 6720 776f 726b 696e  f"Setting workin
-00030ac0: 6720 6469 7374 616e 6365 2066 6f72 2069  g distance for i
-00030ad0: 6f6e 2062 6561 6d20 6973 206e 6f74 2073  on beam is not s
-00030ae0: 7570 706f 7274 6564 2062 7920 5465 7363  upported by Tesc
-00030af0: 616e 2041 5049 2e22 290a 2020 2020 2020  an API.").      
-00030b00: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-00030b10: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00030b20: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
-00030b30: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-00030b40: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
-00030b50: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-00030b60: 2020 2020 2020 2020 2062 6561 6d2e 4265           beam.Be
-00030b70: 616d 2e53 6574 4375 7272 656e 7428 7661  am.SetCurrent(va
-00030b80: 6c75 6520 2a20 636f 6e73 7461 6e74 732e  lue * constants.
-00030b90: 5349 5f54 4f5f 5049 434f 290a 2020 2020  SI_TO_PICO).    
-00030ba0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00030bb0: 696e 672e 696e 666f 2866 2245 6c65 6374  ing.info(f"Elect
-00030bc0: 726f 6e20 6265 616d 2063 7572 7265 6e74  ron beam current
-00030bd0: 2073 6574 2074 6f20 7b76 616c 7565 7d20   set to {value} 
-00030be0: 412e 2229 0a20 2020 2020 2020 2020 2020  A.").           
-00030bf0: 2065 6c73 653a 200a 2020 2020 2020 2020   else: .        
-00030c00: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00030c10: 7761 726e 696e 6728 6622 5365 7474 696e  warning(f"Settin
-00030c20: 6720 6375 7272 656e 7420 666f 7220 696f  g current for io
-00030c30: 6e20 6265 616d 2069 7320 6e6f 7420 7375  n beam is not su
-00030c40: 7070 6f72 7465 6420 6279 2054 6573 6361  pported by Tesca
-00030c50: 6e20 4150 492c 2070 6c65 6173 6520 7573  n API, please us
-00030c60: 6520 7468 6520 6e61 7469 7665 206d 6963  e the native mic
-00030c70: 726f 7363 6f70 6520 696e 7465 7266 6163  roscope interfac
-00030c80: 652e 2229 0a20 2020 2020 2020 2020 2020  e.").           
-00030c90: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00030ca0: 6966 206b 6579 203d 3d20 2276 6f6c 7461  if key == "volta
-00030cb0: 6765 223a 0a20 2020 2020 2020 2020 2020  ge":.           
-00030cc0: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
-00030cd0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-00030ce0: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
-00030cf0: 2020 2020 6265 616d 2e42 6561 6d2e 5365      beam.Beam.Se
-00030d00: 7456 6f6c 7461 6765 2876 616c 7565 290a  tVoltage(value).
-00030d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d20: 6c6f 6767 696e 672e 696e 666f 2866 2245  logging.info(f"E
-00030d30: 6c65 6374 726f 6e20 6265 616d 2076 6f6c  lectron beam vol
-00030d40: 7461 6765 2073 6574 2074 6f20 7b76 616c  tage set to {val
-00030d50: 7565 7d20 562e 2229 0a20 2020 2020 2020  ue} V.").       
-00030d60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00030d70: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-00030d80: 6e67 2e77 6172 6e69 6e67 2866 2253 6574  ng.warning(f"Set
-00030d90: 7469 6e67 2076 6f6c 7461 6765 2066 6f72  ting voltage for
-00030da0: 2069 6f6e 2062 6561 6d20 6973 206e 6f74   ion beam is not
-00030db0: 2073 7570 706f 7274 6564 2062 7920 5465   supported by Te
-00030dc0: 7363 616e 2041 5049 2c20 706c 6561 7365  scan API, please
-00030dd0: 2075 7365 2074 6865 206e 6174 6976 6520   use the native 
-00030de0: 6d69 6372 6f73 636f 7065 2069 6e74 6572  microscope inter
-00030df0: 6661 6365 2e22 290a 2020 2020 2020 2020  face.").        
-00030e00: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-00030e10: 2020 2069 6620 6b65 7920 3d3d 2022 6866     if key == "hf
-00030e20: 7722 3a0a 2020 2020 2020 2020 2020 2020  w":.            
-00030e30: 6265 616d 2e4f 7074 6963 732e 5365 7456  beam.Optics.SetV
-00030e40: 6965 7766 6965 6c64 2876 616c 7565 202a  iewfield(value *
-00030e50: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
-00030e60: 5f54 4f5f 4d49 4c4c 494d 4554 5245 290a  _TO_MILLIMETRE).
-00030e70: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00030e80: 696e 672e 696e 666f 2866 227b 6265 616d  ing.info(f"{beam
-00030e90: 5f74 7970 652e 6e61 6d65 7d20 4846 5720  _type.name} HFW 
-00030ea0: 7365 7420 746f 207b 7661 6c75 657d 206d  set to {value} m
-00030eb0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
-00030ec0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
-00030ed0: 6620 6b65 7920 3d3d 2022 7363 616e 5f72  f key == "scan_r
-00030ee0: 6f74 6174 696f 6e22 3a0a 2020 2020 2020  otation":.      
-00030ef0: 2020 2020 2020 6265 616d 2e4f 7074 6963        beam.Optic
-00030f00: 732e 5365 7449 6d61 6765 526f 7461 7469  s.SetImageRotati
-00030f10: 6f6e 2876 616c 7565 290a 2020 2020 2020  on(value).      
-00030f20: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00030f30: 666f 2866 227b 6265 616d 5f74 7970 652e  fo(f"{beam_type.
-00030f40: 6e61 6d65 7d20 7363 616e 2072 6f74 6174  name} scan rotat
-00030f50: 696f 6e20 7365 7420 746f 207b 7661 6c75  ion set to {valu
-00030f60: 657d 2064 6567 7265 6573 2e22 290a 2020  e} degrees.").  
-00030f70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00030f80: 0a0a 2020 2020 2020 2020 2320 6265 616d  ..        # beam
-00030f90: 2063 6f6e 7472 6f6c 0a20 2020 2020 2020   control.       
-00030fa0: 2069 6620 6b65 7920 3d3d 2022 6f6e 223a   if key == "on":
-00030fb0: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
-00030fc0: 6d2e 4265 616d 2e4f 6e28 2920 6966 2076  m.Beam.On() if v
-00030fd0: 616c 7565 2065 6c73 6520 6265 616d 2e42  alue else beam.B
-00030fe0: 6561 6d2e 4f66 6628 290a 2020 2020 2020  eam.Off().      
-00030ff0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00031000: 666f 2866 227b 6265 616d 5f74 7970 652e  fo(f"{beam_type.
-00031010: 6e61 6d65 7d20 6265 616d 2074 7572 6e65  name} beam turne
-00031020: 6420 7b27 6f6e 2720 6966 2076 616c 7565  d {'on' if value
-00031030: 2065 6c73 6520 276f 6666 277d 2e22 290a   else 'off'}.").
-00031040: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00031050: 726e 0a20 2020 2020 2020 2069 6620 6b65  rn.        if ke
-00031060: 7920 3d3d 2022 7368 6966 7422 3a0a 2020  y == "shift":.  
-00031070: 2020 2020 2020 2020 2020 706f 696e 7420            point 
-00031080: 3d20 506f 696e 7428 7661 6c75 652e 782a  = Point(value.x*
-00031090: 636f 6e73 7461 6e74 732e 4d45 5452 455f  constants.METRE_
-000310a0: 544f 5f4d 494c 4c49 4d45 5452 452c 2076  TO_MILLIMETRE, v
-000310b0: 616c 7565 2e79 2a63 6f6e 7374 616e 7473  alue.y*constants
-000310c0: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
-000310d0: 4554 5245 290a 2020 2020 2020 2020 2020  ETRE).          
-000310e0: 2020 6265 616d 2e4f 7074 6963 732e 5365    beam.Optics.Se
-000310f0: 7449 6d61 6765 5368 6966 7428 706f 696e  tImageShift(poin
-00031100: 742e 782c 2070 6f69 6e74 2e79 290a 2020  t.x, point.y).  
-00031110: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00031120: 672e 696e 666f 2866 227b 6265 616d 5f74  g.info(f"{beam_t
-00031130: 7970 652e 6e61 6d65 7d20 6265 616d 2073  ype.name} beam s
-00031140: 6869 6674 2073 6574 2074 6f20 7b76 616c  hift set to {val
-00031150: 7565 7d2e 2229 0a20 2020 2020 2020 2020  ue}.").         
-00031160: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00031170: 2020 0a20 2020 2020 2020 2023 2064 6574    .        # det
-00031180: 6563 746f 7220 636f 6e74 726f 6c0a 2020  ector control.  
-00031190: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-000311a0: 2264 6574 6563 746f 725f 7479 7065 223a  "detector_type":
-000311b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000311c0: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
-000311d0: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
-000311e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311f0: 7365 6c66 2e65 6c65 6374 726f 6e5f 6465  self.electron_de
-00031200: 7465 6374 6f72 5f61 6374 6976 6520 3d20  tector_active = 
-00031210: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00031220: 2020 2020 2020 6265 616d 2e44 6574 6563        beam.Detec
-00031230: 746f 722e 5365 7428 4368 616e 6e65 6c20  tor.Set(Channel 
-00031240: 3d20 302c 2044 6574 6563 746f 7220 3d20  = 0, Detector = 
-00031250: 7661 6c75 6529 0a20 2020 2020 2020 2020  value).         
-00031260: 2020 2020 2020 2073 656c 662e 656c 6563         self.elec
-00031270: 7472 6f6e 5f64 6574 6563 746f 725f 6163  tron_detector_ac
-00031280: 7469 7665 203d 2062 6561 6d2e 4465 7465  tive = beam.Dete
-00031290: 6374 6f72 2e47 6574 2843 6861 6e6e 656c  ctor.Get(Channel
-000312a0: 203d 2030 290a 2020 2020 2020 2020 2020   = 0).          
-000312b0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-000312c0: 666f 2866 227b 6265 616d 5f74 7970 657d  fo(f"{beam_type}
-000312d0: 2064 6574 6563 746f 7220 7479 7065 2073   detector type s
-000312e0: 6574 2074 6f20 7b76 616c 7565 7d2e 2229  et to {value}.")
-000312f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031300: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00031310: 2020 2020 656c 6966 2062 6561 6d5f 7479      elif beam_ty
-00031320: 7065 203d 3d20 4265 616d 5479 7065 2e49  pe == BeamType.I
-00031330: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
-00031340: 2020 2020 7365 6c66 2e69 6f6e 5f64 6574      self.ion_det
-00031350: 6563 746f 725f 6163 7469 7665 203d 2076  ector_active = v
-00031360: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
-00031370: 2020 2020 2062 6561 6d2e 4465 7465 6374       beam.Detect
-00031380: 6f72 2e53 6574 2843 6861 6e6e 656c 203d  or.Set(Channel =
-00031390: 2030 2c20 4465 7465 6374 6f72 203d 2076   0, Detector = v
-000313a0: 616c 7565 290a 2020 2020 2020 2020 2020  alue).          
-000313b0: 2020 2020 2020 7365 6c66 2e69 6f6e 5f64        self.ion_d
-000313c0: 6574 6563 746f 725f 6163 7469 7665 203d  etector_active =
-000313d0: 2062 6561 6d2e 4465 7465 6374 6f72 2e47   beam.Detector.G
-000313e0: 6574 2843 6861 6e6e 656c 203d 2030 290a  et(Channel = 0).
-000313f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031400: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
-00031410: 6265 616d 5f74 7970 657d 2064 6574 6563  beam_type} detec
-00031420: 746f 7220 7479 7065 2073 6574 2074 6f20  tor type set to 
-00031430: 7b76 616c 7565 7d2e 2229 0a20 2020 2020  {value}.").     
-00031440: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00031450: 6e0a 2020 2020 2020 2020 6966 206b 6579  n.        if key
-00031460: 2069 6e20 5b22 6465 7465 6374 6f72 5f62   in ["detector_b
-00031470: 7269 6768 746e 6573 7322 2c20 2264 6574  rightness", "det
-00031480: 6563 746f 725f 636f 6e74 7261 7374 225d  ector_contrast"]
-00031490: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
-000314a0: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
-000314b0: 7970 652c 2073 656c 662e 7379 7374 656d  ype, self.system
-000314c0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000314d0: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
-000314e0: 725f 6272 6967 6874 6e65 7373 223a 0a20  r_brightness":. 
-000314f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00031500: 6620 3020 3c3d 2076 616c 7565 203c 3d20  f 0 <= value <= 
-00031510: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00031520: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-00031530: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
-00031540: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
-00031550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031560: 2020 6f67 5f63 6f6e 7472 6173 742c 206f    og_contrast, o
-00031570: 675f 6272 6967 6874 6e65 7373 203d 2062  g_brightness = b
-00031580: 6561 6d2e 4465 7465 6374 6f72 2e47 6574  eam.Detector.Get
-00031590: 4761 696e 426c 6163 6b28 4465 7465 6374  GainBlack(Detect
-000315a0: 6f72 3d20 7365 6c66 2e65 6c65 6374 726f  or= self.electro
-000315b0: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
-000315c0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000315d0: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
-000315e0: 4465 7465 6374 6f72 2e53 6574 4761 696e  Detector.SetGain
-000315f0: 426c 6163 6b28 4465 7465 6374 6f72 3d20  Black(Detector= 
-00031600: 7365 6c66 2e65 6c65 6374 726f 6e5f 6465  self.electron_de
-00031610: 7465 6374 6f72 5f61 6374 6976 652c 2047  tector_active, G
-00031620: 6169 6e20 3d20 6f67 5f63 6f6e 7472 6173  ain = og_contras
-00031630: 742c 2042 6c61 636b 203d 2076 616c 7565  t, Black = value
-00031640: 2a31 3030 290a 2020 2020 2020 2020 2020  *100).          
-00031650: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00031660: 6767 696e 672e 696e 666f 2866 227b 6265  gging.info(f"{be
-00031670: 616d 5f74 7970 657d 2064 6574 6563 746f  am_type} detecto
-00031680: 7220 6272 6967 6874 6e65 7373 2073 6574  r brightness set
-00031690: 2074 6f20 7b76 616c 7565 7d2e 2229 0a20   to {value}."). 
-000316a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000316b0: 2020 2065 6c69 6620 6265 616d 5f74 7970     elif beam_typ
-000316c0: 6520 3d3d 2042 6561 6d54 7970 652e 494f  e == BeamType.IO
-000316d0: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
-000316e0: 2020 2020 2020 2020 2020 206f 675f 636f             og_co
-000316f0: 6e74 7261 7374 2c20 6f67 5f62 7269 6768  ntrast, og_brigh
-00031700: 746e 6573 7320 3d20 6265 616d 2e44 6574  tness = beam.Det
-00031710: 6563 746f 722e 4765 7447 6169 6e42 6c61  ector.GetGainBla
-00031720: 636b 2844 6574 6563 746f 723d 2073 656c  ck(Detector= sel
-00031730: 662e 696f 6e5f 6465 7465 6374 6f72 5f61  f.ion_detector_a
-00031740: 6374 6976 6529 0a20 2020 2020 2020 2020  ctive).         
-00031750: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00031760: 6561 6d2e 4465 7465 6374 6f72 2e53 6574  eam.Detector.Set
-00031770: 4761 696e 426c 6163 6b28 4465 7465 6374  GainBlack(Detect
-00031780: 6f72 3d20 7365 6c66 2e69 6f6e 5f64 6574  or= self.ion_det
-00031790: 6563 746f 725f 6163 7469 7665 2c20 4761  ector_active, Ga
-000317a0: 696e 203d 206f 675f 636f 6e74 7261 7374  in = og_contrast
-000317b0: 2c20 426c 6163 6b20 3d20 7661 6c75 652a  , Black = value*
-000317c0: 3130 3029 0a20 2020 2020 2020 2020 2020  100).           
-000317d0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000317e0: 6769 6e67 2e69 6e66 6f28 6622 7b62 6561  ging.info(f"{bea
-000317f0: 6d5f 7479 7065 7d20 6465 7465 6374 6f72  m_type} detector
-00031800: 2062 7269 6768 746e 6573 7320 7365 7420   brightness set 
-00031810: 746f 207b 7661 6c75 657d 2e22 290a 2020  to {value}.").  
-00031820: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00031830: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00031840: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00031850: 7761 726e 696e 6728 6622 496e 7661 6c69  warning(f"Invali
-00031860: 6420 6272 6967 6874 6e65 7373 2076 616c  d brightness val
-00031870: 7565 3a20 7b76 616c 7565 7d2c 206d 7573  ue: {value}, mus
-00031880: 7420 6265 2062 6574 7765 656e 2030 2061  t be between 0 a
-00031890: 6e64 2031 2e22 290a 2020 2020 2020 2020  nd 1.").        
-000318a0: 2020 2020 2020 2020 7265 7475 726e 200a          return .
-000318b0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
-000318c0: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-000318d0: 636f 6e74 7261 7374 223a 0a20 2020 2020  contrast":.     
-000318e0: 2020 2020 2020 2020 2020 2069 6620 3020             if 0 
-000318f0: 3c3d 2076 616c 7565 203c 3d20 313a 0a20  <= value <= 1:. 
-00031900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031910: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
-00031920: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
-00031930: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
-00031940: 2020 2020 2020 2020 2020 2020 2020 6f67                og
-00031950: 5f63 6f6e 7472 6173 742c 206f 675f 6272  _contrast, og_br
-00031960: 6967 6874 6e65 7373 203d 2062 6561 6d2e  ightness = beam.
-00031970: 4465 7465 6374 6f72 2e47 6574 4761 696e  Detector.GetGain
-00031980: 426c 6163 6b28 4465 7465 6374 6f72 3d20  Black(Detector= 
-00031990: 7365 6c66 2e65 6c65 6374 726f 6e5f 6465  self.electron_de
-000319a0: 7465 6374 6f72 5f61 6374 6976 6529 0a20  tector_active). 
-000319b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319c0: 2020 2020 2020 2062 6561 6d2e 4465 7465         beam.Dete
-000319d0: 6374 6f72 2e53 6574 4761 696e 426c 6163  ctor.SetGainBlac
-000319e0: 6b28 4465 7465 6374 6f72 3d20 7365 6c66  k(Detector= self
-000319f0: 2e65 6c65 6374 726f 6e5f 6465 7465 6374  .electron_detect
-00031a00: 6f72 5f61 6374 6976 652c 2047 6169 6e20  or_active, Gain 
-00031a10: 3d20 7661 6c75 652a 3130 302c 2042 6c61  = value*100, Bla
-00031a20: 636b 203d 206f 675f 6272 6967 6874 6e65  ck = og_brightne
-00031a30: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
-00031a40: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00031a50: 696e 672e 696e 666f 2866 227b 6265 616d  ing.info(f"{beam
-00031a60: 5f74 7970 657d 2064 6574 6563 746f 7220  _type} detector 
-00031a70: 636f 6e74 7261 7374 2073 6574 2074 6f20  contrast set to 
-00031a80: 7b76 616c 7565 7d2e 2229 0a20 2020 2020  {value}.").     
-00031a90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00031aa0: 6c69 6620 6265 616d 5f74 7970 6520 3d3d  lif beam_type ==
-00031ab0: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
-00031ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ad0: 2020 2020 2020 206f 675f 636f 6e74 7261         og_contra
-00031ae0: 7374 2c20 6f67 5f62 7269 6768 746e 6573  st, og_brightnes
-00031af0: 7320 3d20 6265 616d 2e44 6574 6563 746f  s = beam.Detecto
-00031b00: 722e 4765 7447 6169 6e42 6c61 636b 2844  r.GetGainBlack(D
-00031b10: 6574 6563 746f 723d 2073 656c 662e 696f  etector= self.io
-00031b20: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
-00031b30: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00031b40: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
-00031b50: 4465 7465 6374 6f72 2e53 6574 4761 696e  Detector.SetGain
-00031b60: 426c 6163 6b28 4465 7465 6374 6f72 3d20  Black(Detector= 
-00031b70: 7365 6c66 2e69 6f6e 5f64 6574 6563 746f  self.ion_detecto
-00031b80: 725f 6163 7469 7665 2c20 4761 696e 203d  r_active, Gain =
-00031b90: 2076 616c 7565 2a31 3030 2c20 426c 6163   value*100, Blac
-00031ba0: 6b20 3d20 6f67 5f62 7269 6768 746e 6573  k = og_brightnes
-00031bb0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00031bc0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-00031bd0: 6e67 2e69 6e66 6f28 6622 7b62 6561 6d5f  ng.info(f"{beam_
-00031be0: 7479 7065 7d20 6465 7465 6374 6f72 2063  type} detector c
-00031bf0: 6f6e 7472 6173 7420 7365 7420 746f 207b  ontrast set to {
-00031c00: 7661 6c75 657d 2e22 290a 2020 2020 2020  value}.").      
-00031c10: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00031c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031c30: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
-00031c40: 696e 6728 6622 496e 7661 6c69 6420 636f  ing(f"Invalid co
-00031c50: 6e74 7261 7374 2076 616c 7565 3a20 7b76  ntrast value: {v
-00031c60: 616c 7565 7d2c 206d 7573 7420 6265 2062  alue}, must be b
-00031c70: 6574 7765 656e 2030 2061 6e64 2031 2e22  etween 0 and 1."
-00031c80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00031c90: 2020 7265 7475 726e 200a 0a20 2020 2020    return ..     
-00031ca0: 2020 2069 6620 6b65 7920 3d3d 2022 7072     if key == "pr
-00031cb0: 6573 6574 223a 0a20 2020 2020 2020 2020  eset":.         
-00031cc0: 2020 2062 6561 6d2e 5072 6573 6574 2e41     beam.Preset.A
-00031cd0: 6374 6976 6174 6528 7661 6c75 6529 0a20  ctivate(value). 
-00031ce0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-00031cf0: 6e67 2e69 6e66 6f28 6622 5072 6573 6574  ng.info(f"Preset
-00031d00: 207b 7661 6c75 657d 2061 6374 6976 6174   {value} activat
-00031d10: 6564 2066 6f72 207b 6265 616d 5f74 7970  ed for {beam_typ
-00031d20: 657d 2e22 290a 2020 2020 2020 2020 2020  e}.").          
-00031d30: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00031d40: 2020 2020 2020 2020 2020 2020 200a 0a20               .. 
-00031d50: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
-00031d60: 6172 6e69 6e67 2866 2255 6e6b 6e6f 776e  arning(f"Unknown
-00031d70: 206b 6579 3a20 7b6b 6579 7d2c 2076 616c   key: {key}, val
-00031d80: 7565 3a20 7b76 616c 7565 7d20 287b 6265  ue: {value} ({be
-00031d90: 616d 5f74 7970 657d 2922 290a 2020 2020  am_type})").    
-00031da0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00031db0: 6465 6620 6368 6563 6b5f 6176 6169 6c61  def check_availa
-00031dc0: 626c 655f 7661 6c75 6573 2873 656c 662c  ble_values(self,
-00031dd0: 206b 6579 3a20 7374 722c 2062 6561 6d5f   key: str, beam_
-00031de0: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
-00031df0: 204e 6f6e 6529 202d 3e20 626f 6f6c 3a0a   None) -> bool:.
-00031e00: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00031e10: 616c 7365 0a20 2020 200a 2020 2020 6465  alse.    .    de
-00031e20: 6620 686f 6d65 2873 656c 6629 202d 3e20  f home(self) -> 
-00031e30: 4e6f 6e65 3a0a 2020 2020 2020 2020 6c6f  None:.        lo
-00031e40: 6767 696e 672e 7761 726e 696e 6728 6622  gging.warning(f"
-00031e50: 4e6f 2068 6f6d 696e 6720 6176 6169 6c61  No homing availa
-00031e60: 626c 652c 2070 6c65 6173 6520 7573 6520  ble, please use 
-00031e70: 6e61 7469 7665 2055 492e 2229 0a20 2020  native UI.").   
-00031e80: 2020 2020 2072 6574 7572 6e0a 0a23 2323       return..###
-00031e90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00031ea0: 2323 2323 230a 636c 6173 7320 4465 6d6f  #####.class Demo
-00031eb0: 4d69 6372 6f73 636f 7065 2846 6962 7365  Microscope(Fibse
-00031ec0: 6d4d 6963 726f 7363 6f70 6529 3a0a 0a20  mMicroscope):.. 
-00031ed0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00031ee0: 7365 6c66 2c20 7379 7374 656d 5f73 6574  self, system_set
-00031ef0: 7469 6e67 733a 2053 7973 7465 6d53 6574  tings: SystemSet
-00031f00: 7469 6e67 7329 3a20 2020 2020 2020 2020  tings):         
-00031f10: 2020 200a 2020 2020 2020 2020 0a20 2020     .        .   
-00031f20: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
-00031f30: 6861 636b 2c20 646f 2074 6869 7320 7072  hack, do this pr
-00031f40: 6f70 6572 6c79 2040 7061 7472 6963 6b0a  operly @patrick.
-00031f50: 2020 2020 2020 2020 6672 6f6d 2064 6174          from dat
-00031f60: 6163 6c61 7373 6573 2069 6d70 6f72 7420  aclasses import 
-00031f70: 6461 7461 636c 6173 730a 0a20 2020 2020  dataclass..     
-00031f80: 2020 2040 6461 7461 636c 6173 730a 2020     @dataclass.  
-00031f90: 2020 2020 2020 636c 6173 7320 4465 6d6f        class Demo
-00031fa0: 4d69 6372 6f73 636f 7065 436c 6965 6e74  MicroscopeClient
-00031fb0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00031fc0: 6c66 2e63 6f6e 6e65 6374 6564 3a20 626f  lf.connected: bo
-00031fd0: 6f6c 203d 2046 616c 7365 0a0a 2020 2020  ol = False..    
-00031fe0: 2020 2020 2020 2020 6465 6620 636f 6e6e          def conn
-00031ff0: 6563 7428 7365 6c66 2c20 6970 5f61 6464  ect(self, ip_add
-00032000: 7265 7373 3a20 7374 722c 2070 6f72 743a  ress: str, port:
-00032010: 2069 6e74 203d 2038 3038 3029 3a0a 2020   int = 8080):.  
-00032020: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00032030: 6767 696e 672e 6465 6275 6728 6622 436f  gging.debug(f"Co
-00032040: 6e6e 6563 7469 6e67 2074 6f20 6d69 6372  nnecting to micr
-00032050: 6f73 636f 7065 2061 7420 7b69 705f 6164  oscope at {ip_ad
-00032060: 6472 6573 737d 3a7b 706f 7274 7d22 290a  dress}:{port}").
-00032070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032080: 7365 6c66 2e63 6f6e 6e65 6374 6564 203d  self.connected =
-00032090: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-000320a0: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
-000320b0: 6275 6728 6622 436f 6e6e 6563 7465 6420  bug(f"Connected 
-000320c0: 746f 206d 6963 726f 7363 6f70 6520 6174  to microscope at
-000320d0: 207b 6970 5f61 6464 7265 7373 7d3a 7b70   {ip_address}:{p
-000320e0: 6f72 747d 2229 0a0a 2020 2020 2020 2020  ort}")..        
-000320f0: 2020 2020 6465 6620 6469 7363 6f6e 6e65      def disconne
-00032100: 6374 2873 656c 6629 3a0a 2020 2020 2020  ct(self):.      
-00032110: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-00032120: 6f6e 6e65 6374 6564 203d 2046 616c 7365  onnected = False
-00032130: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
-00032140: 6f6e 6e65 6374 696f 6e20 3d20 4465 6d6f  onnection = Demo
-00032150: 4d69 6372 6f73 636f 7065 436c 6965 6e74  MicroscopeClient
-00032160: 2829 0a0a 2020 2020 2020 2020 4064 6174  ()..        @dat
-00032170: 6163 6c61 7373 0a20 2020 2020 2020 2063  aclass.        c
-00032180: 6c61 7373 2042 6561 6d53 7973 7465 6d3a  lass BeamSystem:
-00032190: 0a20 2020 2020 2020 2020 2020 206f 6e3a  .            on:
-000321a0: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
-000321b0: 2020 626c 616e 6b65 643a 2062 6f6f 6c0a    blanked: bool.
-000321c0: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-000321d0: 3a20 4265 616d 5365 7474 696e 6773 0a20  : BeamSettings. 
-000321e0: 2020 2020 2020 2020 2020 2064 6574 6563             detec
-000321f0: 746f 723a 2046 6962 7365 6d44 6574 6563  tor: FibsemDetec
-00032200: 746f 7253 6574 7469 6e67 7320 2020 200a  torSettings    .
-00032210: 0a20 2020 2020 2020 2040 6461 7461 636c  .        @datacl
-00032220: 6173 730a 2020 2020 2020 2020 636c 6173  ass.        clas
-00032230: 7320 4368 616d 6265 7253 7973 7465 6d3a  s ChamberSystem:
-00032240: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00032250: 7465 3a20 7374 720a 2020 2020 2020 2020  te: str.        
-00032260: 2020 2020 7072 6573 7375 7265 3a20 666c      pressure: fl
-00032270: 6f61 740a 0a20 2020 2020 2020 2040 6461  oat..        @da
-00032280: 7461 636c 6173 730a 2020 2020 2020 2020  taclass.        
-00032290: 636c 6173 7320 5374 6167 6553 7973 7465  class StageSyste
-000322a0: 6d3a 0a20 2020 2020 2020 2020 2020 2069  m:.            i
-000322b0: 735f 686f 6d65 643a 2062 6f6f 6c0a 2020  s_homed: bool.  
-000322c0: 2020 2020 2020 2020 2020 6973 5f6c 696e            is_lin
-000322d0: 6b65 643a 2062 6f6f 6c0a 2020 2020 2020  ked: bool.      
-000322e0: 2020 2020 2020 706f 7369 7469 6f6e 3a20        position: 
-000322f0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-00032300: 696f 6e0a 2020 2020 2020 2020 0a20 2020  ion.        .   
-00032310: 2020 2020 2040 6461 7461 636c 6173 730a       @dataclass.
-00032320: 2020 2020 2020 2020 636c 6173 7320 4d61          class Ma
-00032330: 6e69 7075 6c61 746f 7253 7973 7465 6d3a  nipulatorSystem:
-00032340: 0a20 2020 2020 2020 2020 2020 2069 6e73  .            ins
-00032350: 6572 7465 643a 2062 6f6f 6c0a 2020 2020  erted: bool.    
-00032360: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
-00032370: 3a20 4669 6273 656d 4d61 6e69 7075 6c61  : FibsemManipula
-00032380: 746f 7250 6f73 6974 696f 6e0a 0a0a 2020  torPosition...  
-00032390: 2020 2020 2020 2320 696e 6974 6961 6c69        # initiali
-000323a0: 7365 2073 7973 7465 6d0a 2020 2020 2020  se system.      
-000323b0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-000323c0: 6e20 3d20 4465 6d6f 4d69 6372 6f73 636f  n = DemoMicrosco
-000323d0: 7065 436c 6965 6e74 2829 0a20 2020 2020  peClient().     
-000323e0: 2020 2073 656c 662e 7379 7374 656d 203d     self.system =
-000323f0: 2073 7973 7465 6d5f 7365 7474 696e 6773   system_settings
-00032400: 2020 2020 0a0a 2020 2020 2020 2020 7365      ..        se
-00032410: 6c66 2e63 6861 6d62 6572 203d 2043 6861  lf.chamber = Cha
-00032420: 6d62 6572 5379 7374 656d 2873 7461 7465  mberSystem(state
-00032430: 3d22 5075 6d70 6564 222c 200a 2020 2020  ="Pumped", .    
-00032440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032460: 2020 2020 7072 6573 7375 7265 3d31 652d      pressure=1e-
-00032470: 3629 0a20 2020 2020 2020 2073 656c 662e  6).        self.
-00032480: 7374 6167 655f 7379 7374 656d 203d 2053  stage_system = S
-00032490: 7461 6765 5379 7374 656d 2869 735f 686f  tageSystem(is_ho
-000324a0: 6d65 6420 3d20 5472 7565 2c20 0a20 2020  med = True, .   
-000324b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000324c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000324d0: 2020 2020 2069 735f 6c69 6e6b 6564 3d20       is_linked= 
-000324e0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-000324f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032500: 2020 2020 2020 2020 2020 2020 2020 706f                po
-00032510: 7369 7469 6f6e 3d46 6962 7365 6d53 7461  sition=FibsemSta
-00032520: 6765 506f 7369 7469 6f6e 2878 3d30 2c20  gePosition(x=0, 
-00032530: 793d 302c 207a 3d30 2c20 723d 302c 2074  y=0, z=0, r=0, t
-00032540: 3d30 2c20 636f 6f72 6469 6e61 7465 5f73  =0, coordinate_s
-00032550: 7973 7465 6d3d 2252 4157 2229 290a 2020  ystem="RAW")).  
-00032560: 2020 2020 2020 0a20 2020 2020 2020 2073        .        s
-00032570: 656c 662e 6d61 6e69 7075 6c61 746f 725f  elf.manipulator_
-00032580: 7379 7374 656d 203d 204d 616e 6970 756c  system = Manipul
-00032590: 6174 6f72 5379 7374 656d 280a 2020 2020  atorSystem(.    
-000325a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325b0: 2020 2020 2020 2020 696e 7365 7274 6564          inserted
-000325c0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-000325d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325e0: 2020 2020 2070 6f73 6974 696f 6e20 3d20       position = 
-000325f0: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
-00032600: 7250 6f73 6974 696f 6e28 783d 302c 2079  rPosition(x=0, y
-00032610: 3d30 2c20 7a3d 302c 2072 3d30 2c20 743d  =0, z=0, r=0, t=
-00032620: 302c 2063 6f6f 7264 696e 6174 655f 7379  0, coordinate_sy
-00032630: 7374 656d 3d22 5241 5722 290a 2020 2020  stem="RAW").    
-00032640: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00032650: 2020 2073 656c 662e 656c 6563 7472 6f6e     self.electron
-00032660: 5f73 7973 7465 6d20 3d20 4265 616d 5379  _system = BeamSy
-00032670: 7374 656d 280a 2020 2020 2020 2020 2020  stem(.          
-00032680: 2020 6f6e 3d46 616c 7365 2c0a 2020 2020    on=False,.    
-00032690: 2020 2020 2020 2020 626c 616e 6b65 643d          blanked=
-000326a0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-000326b0: 2020 6265 616d 3d42 6561 6d53 6574 7469    beam=BeamSetti
-000326c0: 6e67 7328 0a20 2020 2020 2020 2020 2020  ngs(.           
-000326d0: 2020 2020 2062 6561 6d5f 7479 7065 3d42       beam_type=B
-000326e0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-000326f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032700: 2020 776f 726b 696e 675f 6469 7374 616e    working_distan
-00032710: 6365 3d34 2e30 652d 332c 0a20 2020 2020  ce=4.0e-3,.     
-00032720: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-00032730: 6375 7272 656e 743d 3165 2d31 322c 0a20  current=1e-12,. 
-00032740: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00032750: 6f6c 7461 6765 3d32 3030 302c 0a20 2020  oltage=2000,.   
-00032760: 2020 2020 2020 2020 2020 2020 2068 6677               hfw
-00032770: 3d31 3530 652d 362c 0a20 2020 2020 2020  =150e-6,.       
-00032780: 2020 2020 2020 2020 2072 6573 6f6c 7574           resolut
-00032790: 696f 6e3d 5b31 3533 362c 2031 3032 345d  ion=[1536, 1024]
-000327a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000327b0: 2020 6477 656c 6c5f 7469 6d65 3d31 652d    dwell_time=1e-
-000327c0: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
-000327d0: 2020 2073 7469 676d 6174 696f 6e3d 506f     stigmation=Po
-000327e0: 696e 7428 302c 2030 292c 0a20 2020 2020  int(0, 0),.     
-000327f0: 2020 2020 2020 2020 2020 2073 6869 6674             shift
-00032800: 3d50 6f69 6e74 2830 2c20 3029 2c0a 2020  =Point(0, 0),.  
-00032810: 2020 2020 2020 2020 2020 2020 2020 7363                sc
-00032820: 616e 5f72 6f74 6174 696f 6e3d 302c 0a20  an_rotation=0,. 
-00032830: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00032840: 2020 2020 2020 2020 2020 6465 7465 6374            detect
-00032850: 6f72 3d46 6962 7365 6d44 6574 6563 746f  or=FibsemDetecto
-00032860: 7253 6574 7469 6e67 7328 0a20 2020 2020  rSettings(.     
-00032870: 2020 2020 2020 2020 2020 2074 7970 653d             type=
-00032880: 2245 5444 222c 0a20 2020 2020 2020 2020  "ETD",.         
-00032890: 2020 2020 2020 206d 6f64 653d 2253 6563         mode="Sec
-000328a0: 6f6e 6461 7279 456c 6563 7472 6f6e 7322  ondaryElectrons"
-000328b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000328c0: 2020 6272 6967 6874 6e65 7373 3d30 2e35    brightness=0.5
-000328d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000328e0: 2020 636f 6e74 7261 7374 3d30 2e35 2c0a    contrast=0.5,.
-000328f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00032900: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00032910: 2020 2020 0a20 2020 2020 2020 2073 656c      .        sel
-00032920: 662e 696f 6e5f 7379 7374 656d 203d 2042  f.ion_system = B
-00032930: 6561 6d53 7973 7465 6d28 0a20 2020 2020  eamSystem(.     
-00032940: 2020 2020 2020 206f 6e3d 4661 6c73 652c         on=False,
-00032950: 0a20 2020 2020 2020 2020 2020 2062 6c61  .            bla
-00032960: 6e6b 6564 3d54 7275 652c 0a20 2020 2020  nked=True,.     
-00032970: 2020 2020 2020 2062 6561 6d3d 4265 616d         beam=Beam
-00032980: 5365 7474 696e 6773 280a 2020 2020 2020  Settings(.      
-00032990: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
-000329a0: 7970 653d 4265 616d 5479 7065 2e49 4f4e  ype=BeamType.ION
-000329b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000329c0: 2020 776f 726b 696e 675f 6469 7374 616e    working_distan
-000329d0: 6365 3d31 362e 3565 2d33 2c0a 2020 2020  ce=16.5e-3,.    
-000329e0: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-000329f0: 5f63 7572 7265 6e74 3d32 3065 2d31 322c  _current=20e-12,
-00032a00: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-00032a10: 2020 766f 6c74 6167 653d 3330 3030 302c    voltage=30000,
-00032a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032a30: 2068 6677 3d31 3530 652d 362c 0a20 2020   hfw=150e-6,.   
-00032a40: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00032a50: 6f6c 7574 696f 6e3d 5b31 3533 362c 2031  olution=[1536, 1
-00032a60: 3032 345d 2c0a 2020 2020 2020 2020 2020  024],.          
-00032a70: 2020 2020 2020 6477 656c 6c5f 7469 6d65        dwell_time
-00032a80: 3d31 652d 362c 0a20 2020 2020 2020 2020  =1e-6,.         
-00032a90: 2020 2020 2020 2073 7469 676d 6174 696f         stigmatio
-00032aa0: 6e3d 506f 696e 7428 302c 2030 292c 0a20  n=Point(0, 0),. 
-00032ab0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00032ac0: 6869 6674 3d50 6f69 6e74 2830 2c20 3029  hift=Point(0, 0)
-00032ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032ae0: 2020 7363 616e 5f72 6f74 6174 696f 6e3d    scan_rotation=
-00032af0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00032b00: 2020 2029 2c20 0a20 2020 2020 2020 2020     ), .         
-00032b10: 2020 2064 6574 6563 746f 723d 4669 6273     detector=Fibs
-00032b20: 656d 4465 7465 6374 6f72 5365 7474 696e  emDetectorSettin
-00032b30: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
-00032b40: 2020 2020 7479 7065 3d22 4554 4422 2c0a      type="ETD",.
-00032b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032b60: 6d6f 6465 3d22 5365 636f 6e64 6172 7945  mode="SecondaryE
-00032b70: 6c65 6374 726f 6e73 222c 0a20 2020 2020  lectrons",.     
-00032b80: 2020 2020 2020 2020 2020 2062 7269 6768             brigh
-00032b90: 746e 6573 733d 302e 352c 0a20 2020 2020  tness=0.5,.     
-00032ba0: 2020 2020 2020 2020 2020 2063 6f6e 7472             contr
-00032bb0: 6173 743d 302e 352c 0a20 2020 2020 2020  ast=0.5,.       
-00032bc0: 2020 2020 2029 0a20 2020 2020 2020 2029       ).        )
-00032bd0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-00032be0: 2020 2020 2020 2320 7573 6572 2c20 6578        # user, ex
-00032bf0: 7065 7269 6d65 6e74 206d 6574 6164 6174  periment metadat
-00032c00: 610a 2020 2020 2020 2020 2320 544f 444f  a.        # TODO
-00032c10: 3a20 7265 6d6f 7665 206f 6e63 6520 6462  : remove once db
-00032c20: 2069 6e74 6567 7261 7465 640a 2020 2020   integrated.    
-00032c30: 2020 2020 7365 6c66 2e75 7365 7220 3d20      self.user = 
-00032c40: 4669 6273 656d 5573 6572 2e66 726f 6d5f  FibsemUser.from_
-00032c50: 656e 7669 726f 6e6d 656e 7428 290a 2020  environment().  
-00032c60: 2020 2020 2020 7365 6c66 2e65 7870 6572        self.exper
-00032c70: 696d 656e 7420 3d20 4669 6273 656d 4578  iment = FibsemEx
-00032c80: 7065 7269 6d65 6e74 2829 0a0a 2020 2020  periment()..    
-00032c90: 2020 2020 2320 6c6f 6767 696e 670a 2020      # logging.  
-00032ca0: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
-00032cb0: 6275 6728 7b22 6d73 6722 3a20 2263 7265  bug({"msg": "cre
-00032cc0: 6174 655f 6d69 6372 6f73 636f 7065 5f63  ate_microscope_c
-00032cd0: 6c69 656e 7422 2c20 2273 7973 7465 6d5f  lient", "system_
-00032ce0: 7365 7474 696e 6773 223a 2073 7973 7465  settings": syste
-00032cf0: 6d5f 7365 7474 696e 6773 2e74 6f5f 6469  m_settings.to_di
-00032d00: 6374 2829 7d29 0a0a 0a20 2020 2064 6566  ct()})...    def
-00032d10: 2063 6f6e 6e65 6374 5f74 6f5f 6d69 6372   connect_to_micr
-00032d20: 6f73 636f 7065 2873 656c 662c 2069 705f  oscope(self, ip_
-00032d30: 6164 6472 6573 733a 2073 7472 2c20 706f  address: str, po
-00032d40: 7274 3a20 696e 7420 3d20 3830 3830 293a  rt: int = 8080):
-00032d50: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00032d60: 2020 2320 636f 6e6e 6563 7420 746f 206d    # connect to m
-00032d70: 6963 726f 7363 6f70 650a 2020 2020 2020  icroscope.      
-00032d80: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-00032d90: 6e2e 636f 6e6e 6563 7428 6970 5f61 6464  n.connect(ip_add
-00032da0: 7265 7373 3d69 705f 6164 6472 6573 732c  ress=ip_address,
-00032db0: 2070 6f72 743d 706f 7274 290a 0a20 2020   port=port)..   
-00032dc0: 2020 2020 2023 2073 7973 7465 6d20 696e       # system in
-00032dd0: 666f 726d 6174 696f 6e0a 2020 2020 2020  formation.      
-00032de0: 2020 7365 6c66 2e73 7973 7465 6d2e 696e    self.system.in
-00032df0: 666f 2e6d 6f64 656c 3d22 4465 6d6f 4d69  fo.model="DemoMi
-00032e00: 6372 6f73 636f 7065 220a 2020 2020 2020  croscope".      
-00032e10: 2020 7365 6c66 2e73 7973 7465 6d2e 696e    self.system.in
-00032e20: 666f 2e73 6572 6961 6c5f 6e75 6d62 6572  fo.serial_number
-00032e30: 3d22 3132 3334 3536 220a 2020 2020 2020  ="123456".      
-00032e40: 2020 7365 6c66 2e73 7973 7465 6d2e 696e    self.system.in
-00032e50: 666f 2e73 6f66 7477 6172 655f 7665 7273  fo.software_vers
-00032e60: 696f 6e3d 2230 2e31 220a 2020 2020 2020  ion="0.1".      
-00032e70: 2020 7365 6c66 2e73 7973 7465 6d2e 696e    self.system.in
-00032e80: 666f 2e68 6172 6477 6172 655f 7665 7273  fo.hardware_vers
-00032e90: 696f 6e3d 2276 302e 3233 220a 2020 2020  ion="v0.23".    
-00032ea0: 2020 2020 7365 6c66 2e73 7973 7465 6d2e      self.system.
-00032eb0: 696e 666f 2e69 705f 6164 6472 6573 733d  info.ip_address=
-00032ec0: 6970 5f61 6464 7265 7373 0a20 2020 2020  ip_address.     
-00032ed0: 2020 200a 2020 2020 2020 2020 2320 7265     .        # re
-00032ee0: 7365 7420 6265 616d 2073 6869 6674 730a  set beam shifts.
-00032ef0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
-00032f00: 6574 5f62 6561 6d5f 7368 6966 7473 2829  et_beam_shifts()
-00032f10: 0a0a 2020 2020 2020 2020 2320 7573 6572  ..        # user
-00032f20: 206c 6f67 6769 6e67 0a20 2020 2020 2020   logging.       
-00032f30: 2069 6e66 6f20 3d20 7365 6c66 2e73 7973   info = self.sys
-00032f40: 7465 6d2e 696e 666f 0a20 2020 2020 2020  tem.info.       
-00032f50: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00032f60: 4d69 6372 6f73 636f 7065 2063 6c69 656e  Microscope clien
-00032f70: 7420 636f 6e6e 6563 7465 6420 746f 207b  t connected to {
-00032f80: 696e 666f 2e6d 6f64 656c 7d20 7769 7468  info.model} with
-00032f90: 2073 6572 6961 6c20 6e75 6d62 6572 207b   serial number {
-00032fa0: 696e 666f 2e73 6572 6961 6c5f 6e75 6d62  info.serial_numb
-00032fb0: 6572 7d20 616e 6420 736f 6674 7761 7265  er} and software
-00032fc0: 2076 6572 7369 6f6e 207b 696e 666f 2e73   version {info.s
-00032fd0: 6f66 7477 6172 655f 7665 7273 696f 6e7d  oftware_version}
-00032fe0: 2229 2020 2020 2020 200a 0a20 2020 2020  ")       ..     
-00032ff0: 2020 2023 206c 6f67 6769 6e67 0a20 2020     # logging.   
-00033000: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
-00033010: 7567 287b 226d 7367 223a 2022 636f 6e6e  ug({"msg": "conn
-00033020: 6563 745f 746f 5f6d 6963 726f 7363 6f70  ect_to_microscop
-00033030: 6522 2c20 2269 705f 6164 6472 6573 7322  e", "ip_address"
-00033040: 3a20 6970 5f61 6464 7265 7373 2c20 2270  : ip_address, "p
-00033050: 6f72 7422 3a20 706f 7274 2c20 2273 7973  ort": port, "sys
-00033060: 7465 6d5f 696e 666f 223a 2069 6e66 6f2e  tem_info": info.
-00033070: 746f 5f64 6963 7428 2920 7d29 0a0a 2020  to_dict() })..  
-00033080: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00033090: 2020 6465 6620 6469 7363 6f6e 6e65 6374    def disconnect
-000330a0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-000330b0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
-000330c0: 6469 7363 6f6e 6e65 6374 2829 0a20 2020  disconnect().   
-000330d0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-000330e0: 6f28 6622 4469 7363 6f6e 6e65 6374 6564  o(f"Disconnected
-000330f0: 2066 726f 6d20 4465 6d6f 204d 6963 726f   from Demo Micro
-00033100: 7363 6f70 6522 290a 0a20 2020 2064 6566  scope")..    def
-00033110: 2061 6371 7569 7265 5f69 6d61 6765 2873   acquire_image(s
-00033120: 656c 662c 2069 6d61 6765 5f73 6574 7469  elf, image_setti
-00033130: 6e67 733a 2049 6d61 6765 5365 7474 696e  ngs: ImageSettin
-00033140: 6773 2920 2d3e 2046 6962 7365 6d49 6d61  gs) -> FibsemIma
-00033150: 6765 3a0a 2020 2020 2020 2020 5f63 6865  ge:.        _che
-00033160: 636b 5f62 6561 6d28 696d 6167 655f 7365  ck_beam(image_se
-00033170: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
-00033180: 2c20 7365 6c66 2e73 7973 7465 6d29 0a20  , self.system). 
-00033190: 2020 2020 2020 2076 6677 203d 2069 6d61         vfw = ima
-000331a0: 6765 5f73 6574 7469 6e67 732e 6866 7720  ge_settings.hfw 
-000331b0: 2a20 696d 6167 655f 7365 7474 696e 6773  * image_settings
-000331c0: 2e72 6573 6f6c 7574 696f 6e5b 315d 202f  .resolution[1] /
-000331d0: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
-000331e0: 7265 736f 6c75 7469 6f6e 5b30 5d0a 2020  resolution[0].  
-000331f0: 2020 2020 2020 7069 7865 6c73 697a 6520        pixelsize 
-00033200: 3d20 506f 696e 7428 696d 6167 655f 7365  = Point(image_se
-00033210: 7474 696e 6773 2e68 6677 202f 2069 6d61  ttings.hfw / ima
-00033220: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
-00033230: 6c75 7469 6f6e 5b30 5d2c 200a 2020 2020  lution[0], .    
-00033240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033250: 2020 2020 2020 7666 7720 2f20 696d 6167        vfw / imag
-00033260: 655f 7365 7474 696e 6773 2e72 6573 6f6c  e_settings.resol
-00033270: 7574 696f 6e5b 315d 290a 2020 2020 2020  ution[1]).      
-00033280: 2020 0a20 2020 2020 2020 206c 6f67 6769    .        loggi
-00033290: 6e67 2e69 6e66 6f28 6622 6163 7175 6972  ng.info(f"acquir
-000332a0: 696e 6720 6e65 7720 7b69 6d61 6765 5f73  ing new {image_s
-000332b0: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
-000332c0: 652e 6e61 6d65 7d20 696d 6167 652e 2229  e.name} image.")
-000332d0: 0a20 2020 2020 2020 2069 6d61 6765 203d  .        image =
-000332e0: 2046 6962 7365 6d49 6d61 6765 280a 2020   FibsemImage(.  
-000332f0: 2020 2020 2020 2020 2020 6461 7461 3d6e            data=n
-00033300: 702e 7261 6e64 6f6d 2e72 616e 6469 6e74  p.random.randint
-00033310: 286c 6f77 3d30 2c20 6869 6768 3d32 3536  (low=0, high=256
-00033320: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
-00033330: 2020 2073 697a 653d 2869 6d61 6765 5f73     size=(image_s
-00033340: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
-00033350: 6f6e 5b31 5d2c 696d 6167 655f 7365 7474  on[1],image_sett
-00033360: 696e 6773 2e72 6573 6f6c 7574 696f 6e5b  ings.resolution[
-00033370: 305d 292c 200a 2020 2020 2020 2020 2020  0]), .          
-00033380: 2020 2020 2020 6474 7970 653d 6e70 2e75        dtype=np.u
-00033390: 696e 7438 292c 0a20 2020 2020 2020 2020  int8),.         
-000333a0: 2020 206d 6574 6164 6174 613d 4669 6273     metadata=Fibs
-000333b0: 656d 496d 6167 654d 6574 6164 6174 6128  emImageMetadata(
-000333c0: 696d 6167 655f 7365 7474 696e 6773 3d69  image_settings=i
-000333d0: 6d61 6765 5f73 6574 7469 6e67 732c 200a  mage_settings, .
-000333e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000333f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033400: 2020 2020 2020 2020 7069 7865 6c5f 7369          pixel_si
-00033410: 7a65 3d70 6978 656c 7369 7a65 2c0a 2020  ze=pixelsize,.  
-00033420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033440: 2020 2020 2020 6d69 6372 6f73 636f 7065        microscope
-00033450: 5f73 7461 7465 3d73 656c 662e 6765 745f  _state=self.get_
-00033460: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
-00033470: 2862 6561 6d5f 7479 7065 3d69 6d61 6765  (beam_type=image
-00033480: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-00033490: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
-000334a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000334b0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
-000334c0: 7374 656d 3d73 656c 662e 7379 7374 656d  stem=self.system
-000334d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000334e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000334f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00033500: 2020 2029 0a0a 2020 2020 2020 2020 696d     )..        im
-00033510: 6167 652e 6d65 7461 6461 7461 2e75 7365  age.metadata.use
-00033520: 7220 3d20 7365 6c66 2e75 7365 720a 2020  r = self.user.  
-00033530: 2020 2020 2020 696d 6167 652e 6d65 7461        image.meta
-00033540: 6461 7461 2e65 7870 6572 696d 656e 7420  data.experiment 
-00033550: 3d20 7365 6c66 2e65 7870 6572 696d 656e  = self.experimen
-00033560: 740a 2020 2020 2020 2020 696d 6167 652e  t.        image.
-00033570: 6d65 7461 6461 7461 2e73 7973 7465 6d20  metadata.system 
-00033580: 3d20 7365 6c66 2e73 7973 7465 6d0a 0a20  = self.system.. 
-00033590: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
-000335a0: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
-000335b0: 7065 2069 7320 4265 616d 5479 7065 2e45  pe is BeamType.E
-000335c0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-000335d0: 2020 2020 2073 656c 662e 5f65 625f 696d       self._eb_im
-000335e0: 6167 6520 3d20 696d 6167 650a 2020 2020  age = image.    
-000335f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00033600: 2020 2020 2020 7365 6c66 2e5f 6962 5f69        self._ib_i
-00033610: 6d61 6765 203d 2069 6d61 6765 0a0a 2020  mage = image..  
-00033620: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
-00033630: 6275 6728 7b22 6d73 6722 3a20 2261 6371  bug({"msg": "acq
-00033640: 7569 7265 5f69 6d61 6765 222c 2022 6d65  uire_image", "me
-00033650: 7461 6461 7461 223a 2069 6d61 6765 2e6d  tadata": image.m
-00033660: 6574 6164 6174 612e 746f 5f64 6963 7428  etadata.to_dict(
-00033670: 297d 290a 0a20 2020 2020 2020 2072 6574  )})..        ret
-00033680: 7572 6e20 696d 6167 650a 0a20 2020 2064  urn image..    d
-00033690: 6566 206c 6173 745f 696d 6167 6528 7365  ef last_image(se
-000336a0: 6c66 2c20 6265 616d 5f74 7970 653a 2042  lf, beam_type: B
-000336b0: 6561 6d54 7970 6529 202d 3e20 4669 6273  eamType) -> Fibs
-000336c0: 656d 496d 6167 653a 0a20 2020 2020 2020  emImage:.       
-000336d0: 205f 6368 6563 6b5f 6265 616d 2862 6561   _check_beam(bea
-000336e0: 6d5f 7479 7065 2c20 7365 6c66 2e73 7973  m_type, self.sys
-000336f0: 7465 6d29 0a0a 2020 2020 2020 2020 696d  tem)..        im
-00033700: 6167 6520 3d20 7365 6c66 2e5f 6562 5f69  age = self._eb_i
-00033710: 6d61 6765 2069 6620 6265 616d 5f74 7970  mage if beam_typ
-00033720: 6520 6973 2042 6561 6d54 7970 652e 454c  e is BeamType.EL
-00033730: 4543 5452 4f4e 2065 6c73 6520 7365 6c66  ECTRON else self
-00033740: 2e5f 6962 5f69 6d61 6765 0a20 2020 2020  ._ib_image.     
-00033750: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
-00033760: 287b 226d 7367 223a 2022 6c61 7374 5f69  ({"msg": "last_i
-00033770: 6d61 6765 222c 2022 6265 616d 5f74 7970  mage", "beam_typ
-00033780: 6522 3a20 6265 616d 5f74 7970 652e 6e61  e": beam_type.na
-00033790: 6d65 2c20 226d 6574 6164 6174 6122 3a20  me, "metadata": 
-000337a0: 696d 6167 652e 6d65 7461 6461 7461 2e74  image.metadata.t
-000337b0: 6f5f 6469 6374 2829 7d29 0a20 2020 2020  o_dict()}).     
-000337c0: 2020 2072 6574 7572 6e20 696d 6167 650a     return image.
-000337d0: 2020 2020 0a20 2020 2064 6566 2061 6371      .    def acq
-000337e0: 7569 7265 5f63 6861 6d62 6572 5f69 6d61  uire_chamber_ima
-000337f0: 6765 2873 656c 6629 202d 3e20 4669 6273  ge(self) -> Fibs
-00033800: 656d 496d 6167 653a 0a20 2020 2020 2020  emImage:.       
-00033810: 2022 2222 4163 7175 6972 6520 616e 2069   """Acquire an i
-00033820: 6d61 6765 206f 6620 7468 6520 6368 616d  mage of the cham
-00033830: 6265 7220 696e 7369 6465 2e22 2222 0a20  ber inside.""". 
-00033840: 2020 2020 2020 2069 6d61 6765 203d 2046         image = F
-00033850: 6962 7365 6d49 6d61 6765 280a 2020 2020  ibsemImage(.    
-00033860: 2020 2020 2020 2020 6461 7461 3d6e 702e          data=np.
-00033870: 7261 6e64 6f6d 2e72 616e 6469 6e74 286c  random.randint(l
-00033880: 6f77 3d30 2c20 6869 6768 3d32 3536 2c20  ow=0, high=256, 
-00033890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000338a0: 2073 697a 653d 2831 3032 342c 3135 3336   size=(1024,1536
-000338b0: 292c 200a 2020 2020 2020 2020 2020 2020  ), .            
-000338c0: 2020 2020 6474 7970 653d 6e70 2e75 696e      dtype=np.uin
-000338d0: 7438 292c 0a20 2020 2020 2020 2020 2020  t8),.           
-000338e0: 2020 2020 206d 6574 6164 6174 613d 4e6f       metadata=No
-000338f0: 6e65 290a 2020 2020 2020 2020 6c6f 6767  ne).        logg
-00033900: 696e 672e 6465 6275 6728 7b22 6d73 6722  ing.debug({"msg"
-00033910: 3a20 2261 6371 7569 7265 5f63 6861 6d62  : "acquire_chamb
-00033920: 6572 5f69 6d61 6765 227d 290a 2020 2020  er_image"}).    
-00033930: 2020 2020 7265 7475 726e 2069 6d61 6765      return image
-00033940: 0a0a 2020 2020 6465 6620 6c69 7665 5f69  ..    def live_i
-00033950: 6d61 6769 6e67 2873 656c 662c 2069 6d61  maging(self, ima
-00033960: 6765 5f73 6574 7469 6e67 733a 2049 6d61  ge_settings: Ima
-00033970: 6765 5365 7474 696e 6773 2c20 696d 6167  geSettings, imag
-00033980: 655f 7175 6575 653a 2051 7565 7565 2c20  e_queue: Queue, 
-00033990: 7374 6f70 5f65 7665 6e74 3a20 7468 7265  stop_event: thre
-000339a0: 6164 696e 672e 4576 656e 7429 3a0a 2020  ading.Event):.  
-000339b0: 2020 2020 2020 7365 6c66 2e69 6d61 6765        self.image
-000339c0: 5f71 7565 7565 203d 2069 6d61 6765 5f71  _queue = image_q
-000339d0: 7565 7565 0a20 2020 2020 2020 2073 656c  ueue.        sel
-000339e0: 662e 7374 6f70 5f65 7665 6e74 203d 2073  f.stop_event = s
-000339f0: 746f 705f 6576 656e 740a 2020 2020 2020  top_event.      
-00033a00: 2020 5f63 6865 636b 5f62 6561 6d28 696d    _check_beam(im
-00033a10: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
-00033a20: 6d5f 7479 7065 2c20 7365 6c66 2e73 7973  m_type, self.sys
-00033a30: 7465 6d29 0a20 2020 2020 2020 206c 6f67  tem).        log
-00033a40: 6769 6e67 2e69 6e66 6f28 6622 4c69 7665  ging.info(f"Live
-00033a50: 2069 6d61 6769 6e67 3a20 7b69 6d61 6765   imaging: {image
-00033a60: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
-00033a70: 7970 657d 2229 0a20 2020 2020 2020 2077  ype}").        w
-00033a80: 6869 6c65 206e 6f74 2073 746f 705f 6576  hile not stop_ev
-00033a90: 656e 742e 6973 5f73 6574 2829 3a0a 2020  ent.is_set():.  
-00033aa0: 2020 2020 2020 2020 2020 696d 6167 6520            image 
-00033ab0: 3d20 7365 6c66 2e61 6371 7569 7265 5f69  = self.acquire_i
-00033ac0: 6d61 6765 2869 6d61 6765 5f73 6574 7469  mage(image_setti
-00033ad0: 6e67 7329 0a20 2020 2020 2020 2020 2020  ngs).           
-00033ae0: 2069 6d61 6765 5f71 7565 7565 2e70 7574   image_queue.put
-00033af0: 2869 6d61 6765 290a 2020 2020 2020 2020  (image).        
-00033b00: 2020 2020 7365 6c66 2e73 6c65 6570 5f74      self.sleep_t
-00033b10: 696d 6520 3d20 696d 6167 655f 7365 7474  ime = image_sett
-00033b20: 696e 6773 2e64 7765 6c6c 5f74 696d 652a  ings.dwell_time*
-00033b30: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
-00033b40: 6573 6f6c 7574 696f 6e5b 305d 2a69 6d61  esolution[0]*ima
-00033b50: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
-00033b60: 6c75 7469 6f6e 5b31 5d0a 2020 2020 2020  lution[1].      
-00033b70: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
-00033b80: 2873 656c 662e 736c 6565 705f 7469 6d65  (self.sleep_time
-00033b90: 290a 0a20 2020 2040 7468 7265 6164 5f77  )..    @thread_w
-00033ba0: 6f72 6b65 720a 2020 2020 6465 6620 636f  orker.    def co
-00033bb0: 6e73 756d 655f 696d 6167 655f 7175 6575  nsume_image_queu
-00033bc0: 6528 7365 6c66 2c20 7061 7265 6e74 5f75  e(self, parent_u
-00033bd0: 6920 3d20 4e6f 6e65 2c20 736c 6565 7020  i = None, sleep 
-00033be0: 3d20 302e 3129 3a0a 0a20 2020 2020 2020  = 0.1):..       
-00033bf0: 206c 6f67 6769 6e67 2e69 6e66 6f28 2243   logging.info("C
-00033c00: 6f6e 7375 6d69 6e67 2069 6d61 6765 2071  onsuming image q
-00033c10: 7565 7565 2229 0a0a 2020 2020 2020 2020  ueue")..        
-00033c20: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00033c30: 2077 6869 6c65 206e 6f74 2073 656c 662e   while not self.
-00033c40: 7374 6f70 5f65 7665 6e74 2e69 735f 7365  stop_event.is_se
-00033c50: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
-00033c60: 2020 2020 2069 6d61 6765 203d 2073 656c       image = sel
-00033c70: 662e 696d 6167 655f 7175 6575 652e 6765  f.image_queue.ge
-00033c80: 7428 7469 6d65 6f75 743d 3129 0a20 2020  t(timeout=1).   
-00033c90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00033ca0: 696d 6167 652e 6d65 7461 6461 7461 2e69  image.metadata.i
-00033cb0: 6d61 6765 5f73 6574 7469 6e67 732e 7361  mage_settings.sa
-00033cc0: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
-00033cd0: 2020 2020 2020 2020 696d 6167 652e 6d65          image.me
-00033ce0: 7461 6461 7461 2e69 6d61 6765 5f73 6574  tadata.image_set
-00033cf0: 7469 6e67 732e 6669 6c65 6e61 6d65 203d  tings.filename =
-00033d00: 2066 227b 696d 6167 652e 6d65 7461 6461   f"{image.metada
-00033d10: 7461 2e69 6d61 6765 5f73 6574 7469 6e67  ta.image_setting
-00033d20: 732e 6669 6c65 6e61 6d65 7d5f 7b75 7469  s.filename}_{uti
-00033d30: 6c73 2e63 7572 7265 6e74 5f74 696d 6573  ls.current_times
-00033d40: 7461 6d70 2829 7d22 0a20 2020 2020 2020  tamp()}".       
-00033d50: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-00033d60: 656e 616d 6520 3d20 6f73 2e70 6174 682e  ename = os.path.
-00033d70: 6a6f 696e 2869 6d61 6765 2e6d 6574 6164  join(image.metad
-00033d80: 6174 612e 696d 6167 655f 7365 7474 696e  ata.image_settin
-00033d90: 6773 2e70 6174 682c 2069 6d61 6765 2e6d  gs.path, image.m
-00033da0: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
-00033db0: 7474 696e 6773 2e66 696c 656e 616d 6529  ttings.filename)
-00033dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033dd0: 2020 2020 2069 6d61 6765 2e73 6176 6528       image.save(
-00033de0: 7061 7468 3d66 696c 656e 616d 6529 0a20  path=filename). 
-00033df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033e00: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
-00033e10: 6622 5361 7665 6420 696d 6167 6520 746f  f"Saved image to
-00033e20: 207b 6669 6c65 6e61 6d65 7d22 290a 0a20   {filename}").. 
-00033e30: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00033e40: 6f67 6769 6e67 2e69 6e66 6f28 6622 496d  ogging.info(f"Im
-00033e50: 6167 653a 207b 696d 6167 652e 6461 7461  age: {image.data
-00033e60: 2e73 6861 7065 7d22 290a 2020 2020 2020  .shape}").      
-00033e70: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00033e80: 672e 696e 666f 2866 222d 2220 2a20 3530  g.info(f"-" * 50
-00033e90: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00033ea0: 2020 2069 6620 7061 7265 6e74 5f75 6920     if parent_ui 
-00033eb0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00033ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ed0: 2020 2020 2070 6172 656e 745f 7569 2e6c       parent_ui.l
-00033ee0: 6976 655f 696d 6167 696e 675f 7369 676e  ive_imaging_sign
-00033ef0: 616c 2e65 6d69 7428 7b22 696d 6167 6522  al.emit({"image"
-00033f00: 3a20 696d 6167 657d 290a 2020 2020 2020  : image}).      
-00033f10: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
-00033f20: 6c65 6570 2873 6c65 6570 290a 2020 2020  leep(sleep).    
-00033f30: 2020 2020 6578 6365 7074 204b 6579 626f      except Keybo
-00033f40: 6172 6449 6e74 6572 7275 7074 3a0a 2020  ardInterrupt:.  
-00033f50: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00033f60: 746f 705f 6576 656e 740a 2020 2020 2020  top_event.      
-00033f70: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00033f80: 666f 2822 4b65 7962 6f61 7264 2069 6e74  fo("Keyboard int
-00033f90: 6572 7275 7074 2c20 7374 6f70 7069 6e67  errupt, stopping
-00033fa0: 206c 6976 6520 696d 6167 696e 6722 290a   live imaging").
-00033fb0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00033fc0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-00033fd0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00033fe0: 7374 6f70 5f65 7665 6e74 2e73 6574 2829  stop_event.set()
-00033ff0: 0a20 2020 2020 2020 2020 2020 2069 6d70  .            imp
-00034000: 6f72 7420 7472 6163 6562 6163 6b0a 2020  ort traceback.  
-00034010: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00034020: 672e 6572 726f 7228 7472 6163 6562 6163  g.error(tracebac
-00034030: 6b2e 666f 726d 6174 5f65 7863 2829 290a  k.format_exc()).
-00034040: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-00034050: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00034060: 6769 6e67 2e69 6e66 6f28 2253 746f 7070  ging.info("Stopp
-00034070: 6564 2074 6872 6561 6420 696d 6167 6520  ed thread image 
-00034080: 636f 6e73 756d 7074 696f 6e22 290a 2020  consumption").  
-00034090: 2020 0a20 2020 2064 6566 2061 7574 6f63    .    def autoc
-000340a0: 6f6e 7472 6173 7428 7365 6c66 2c20 6265  ontrast(self, be
-000340b0: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-000340c0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-000340d0: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-000340e0: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-000340f0: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
-00034100: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
-00034110: 6d73 6722 3a20 2261 7574 6f63 6f6e 7472  msg": "autocontr
-00034120: 6173 7422 2c20 2262 6561 6d5f 7479 7065  ast", "beam_type
-00034130: 223a 2062 6561 6d5f 7479 7065 2e6e 616d  ": beam_type.nam
-00034140: 657d 290a 0a20 2020 2064 6566 2061 7574  e})..    def aut
-00034150: 6f5f 666f 6375 7328 7365 6c66 2c20 6265  o_focus(self, be
-00034160: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
-00034170: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-00034180: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
-00034190: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
-000341a0: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
-000341b0: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
-000341c0: 6d73 6722 3a20 2261 7574 6f5f 666f 6375  msg": "auto_focu
-000341d0: 7322 2c20 2262 6561 6d5f 7479 7065 223a  s", "beam_type":
-000341e0: 2062 6561 6d5f 7479 7065 2e6e 616d 657d   beam_type.name}
-000341f0: 290a 2020 2020 2020 2020 0a20 2020 2064  ).        .    d
-00034200: 6566 2062 6561 6d5f 7368 6966 7428 7365  ef beam_shift(se
-00034210: 6c66 2c20 6478 3a20 666c 6f61 742c 2064  lf, dx: float, d
-00034220: 793a 2066 6c6f 6174 2c20 6265 616d 5f74  y: float, beam_t
-00034230: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
-00034240: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00034250: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
-00034260: 5f74 7970 652c 2073 656c 662e 7379 7374  _type, self.syst
-00034270: 656d 290a 0a20 2020 2020 2020 206c 6f67  em)..        log
-00034280: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
-00034290: 223a 2022 6265 616d 5f73 6869 6674 222c  ": "beam_shift",
-000342a0: 2022 6478 223a 2064 782c 2022 6479 223a   "dx": dx, "dy":
-000342b0: 2064 792c 2022 6265 616d 5f74 7970 6522   dy, "beam_type"
-000342c0: 3a20 6265 616d 5f74 7970 652e 6e61 6d65  : beam_type.name
-000342d0: 7d29 2020 2020 2020 2020 200a 0a20 2020  })         ..   
-000342e0: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
-000342f0: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
-00034300: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
-00034310: 2020 2020 7365 6c66 2e65 6c65 6374 726f      self.electro
-00034320: 6e5f 7379 7374 656d 2e62 6561 6d2e 7368  n_system.beam.sh
-00034330: 6966 7420 2b3d 2050 6f69 6e74 2866 6c6f  ift += Point(flo
-00034340: 6174 2864 7829 2c20 666c 6f61 7428 6479  at(dx), float(dy
-00034350: 2929 0a20 2020 2020 2020 2065 6c69 6620  )).        elif 
-00034360: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
-00034370: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
-00034380: 2020 2020 2020 2073 656c 662e 696f 6e5f         self.ion_
-00034390: 7379 7374 656d 2e62 6561 6d2e 7368 6966  system.beam.shif
-000343a0: 7420 2b3d 2050 6f69 6e74 2866 6c6f 6174  t += Point(float
-000343b0: 2864 7829 2c20 666c 6f61 7428 6479 2929  (dx), float(dy))
-000343c0: 0a0a 2020 200a 2020 2020 6465 6620 7361  ..   .    def sa
-000343d0: 6665 5f61 6273 6f6c 7574 655f 7374 6167  fe_absolute_stag
-000343e0: 655f 6d6f 7665 6d65 6e74 2873 656c 662c  e_movement(self,
-000343f0: 2073 7461 6765 5f70 6f73 6974 696f 6e3a   stage_position:
-00034400: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
-00034410: 7469 6f6e 2920 2d3e 204e 6f6e 653a 0a20  tion) -> None:. 
-00034420: 2020 2020 2020 2022 2222 4d6f 7665 2074         """Move t
-00034430: 6865 2073 7461 6765 2074 6f20 7468 6520  he stage to the 
-00034440: 7370 6563 6966 6965 6420 706f 7369 7469  specified positi
-00034450: 6f6e 2075 7369 6e67 2073 6166 6520 7374  on using safe st
-00034460: 7261 7465 6779 2222 220a 2020 2020 2020  rategy""".      
-00034470: 2020 7365 6c66 2e6d 6f76 655f 7374 6167    self.move_stag
-00034480: 655f 6162 736f 6c75 7465 2873 7461 6765  e_absolute(stage
-00034490: 5f70 6f73 6974 696f 6e29 0a0a 2020 2020  _position)..    
-000344a0: 6465 6620 7072 6f6a 6563 745f 7374 6162  def project_stab
-000344b0: 6c65 5f6d 6f76 6528 7365 6c66 2c20 6478  le_move(self, dx
-000344c0: 3a66 6c6f 6174 2c20 6479 3a66 6c6f 6174  :float, dy:float
-000344d0: 2c20 6265 616d 5f74 7970 653a 4265 616d  , beam_type:Beam
-000344e0: 5479 7065 2c20 6261 7365 5f70 6f73 6974  Type, base_posit
-000344f0: 696f 6e3a 4669 6273 656d 5374 6167 6550  ion:FibsemStageP
-00034500: 6f73 6974 696f 6e29 202d 3e20 4669 6273  osition) -> Fibs
-00034510: 656d 5374 6167 6550 6f73 6974 696f 6e3a  emStagePosition:
-00034520: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00034530: 2062 6173 655f 706f 7369 7469 6f6e 202b   base_position +
-00034540: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
-00034550: 7469 6f6e 2878 3d64 782c 2079 3d64 7929  tion(x=dx, y=dy)
-00034560: 2023 2054 4f44 4f3a 2069 6d70 6c65 6d65   # TODO: impleme
-00034570: 6e74 0a0a 2020 2020 6465 6620 6d6f 7665  nt..    def move
-00034580: 5f73 7461 6765 5f61 6273 6f6c 7574 6528  _stage_absolute(
-00034590: 7365 6c66 2c20 706f 7369 7469 6f6e 3a20  self, position: 
-000345a0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-000345b0: 696f 6e29 202d 3e20 4e6f 6e65 3a0a 2020  ion) -> None:.  
-000345c0: 2020 2020 2020 2222 224d 6f76 6520 7468        """Move th
-000345d0: 6520 7374 6167 6520 746f 2074 6865 2073  e stage to the s
-000345e0: 7065 6369 6669 6564 2070 6f73 6974 696f  pecified positio
-000345f0: 6e2e 2222 220a 2020 2020 2020 2020 5f63  n.""".        _c
-00034600: 6865 636b 5f73 7461 6765 5f6d 6f76 656d  heck_stage_movem
-00034610: 656e 7428 7365 6c66 2e73 7973 7465 6d2c  ent(self.system,
-00034620: 2070 6f73 6974 696f 6e29 0a20 2020 2020   position).     
-00034630: 2020 200a 2020 2020 2020 2020 2320 6f6e     .        # on
-00034640: 6c79 2061 7373 6967 6e20 6966 206e 6f74  ly assign if not
-00034650: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-00034660: 2070 6f73 6974 696f 6e2e 7820 6973 206e   position.x is n
-00034670: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00034680: 2020 2020 2073 656c 662e 7374 6167 655f       self.stage_
-00034690: 7379 7374 656d 2e70 6f73 6974 696f 6e2e  system.position.
-000346a0: 7820 3d20 706f 7369 7469 6f6e 2e78 0a20  x = position.x. 
-000346b0: 2020 2020 2020 2069 6620 706f 7369 7469         if positi
-000346c0: 6f6e 2e79 2069 7320 6e6f 7420 4e6f 6e65  on.y is not None
-000346d0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000346e0: 6c66 2e73 7461 6765 5f73 7973 7465 6d2e  lf.stage_system.
-000346f0: 706f 7369 7469 6f6e 2e79 203d 2070 6f73  position.y = pos
-00034700: 6974 696f 6e2e 790a 2020 2020 2020 2020  ition.y.        
-00034710: 6966 2070 6f73 6974 696f 6e2e 7a20 6973  if position.z is
-00034720: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00034730: 2020 2020 2020 2073 656c 662e 7374 6167         self.stag
-00034740: 655f 7379 7374 656d 2e70 6f73 6974 696f  e_system.positio
-00034750: 6e2e 7a20 3d20 706f 7369 7469 6f6e 2e7a  n.z = position.z
-00034760: 0a20 2020 2020 2020 2069 6620 706f 7369  .        if posi
-00034770: 7469 6f6e 2e72 2069 7320 6e6f 7420 4e6f  tion.r is not No
-00034780: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00034790: 7365 6c66 2e73 7461 6765 5f73 7973 7465  self.stage_syste
-000347a0: 6d2e 706f 7369 7469 6f6e 2e72 203d 2070  m.position.r = p
-000347b0: 6f73 6974 696f 6e2e 720a 2020 2020 2020  osition.r.      
-000347c0: 2020 6966 2070 6f73 6974 696f 6e2e 7420    if position.t 
-000347d0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000347e0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-000347f0: 6167 655f 7379 7374 656d 2e70 6f73 6974  age_system.posit
-00034800: 696f 6e2e 7420 3d20 706f 7369 7469 6f6e  ion.t = position
-00034810: 2e74 0a20 2020 2020 2020 200a 2020 2020  .t.        .    
-00034820: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
-00034830: 6728 7b22 6d73 6722 3a20 226d 6f76 655f  g({"msg": "move_
-00034840: 7374 6167 655f 6162 736f 6c75 7465 222c  stage_absolute",
-00034850: 2022 706f 7369 7469 6f6e 223a 2070 6f73   "position": pos
-00034860: 6974 696f 6e2e 746f 5f64 6963 7428 297d  ition.to_dict()}
-00034870: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00034880: 6e20 7365 6c66 2e67 6574 5f73 7461 6765  n self.get_stage
-00034890: 5f70 6f73 6974 696f 6e28 290a 0a20 2020  _position()..   
-000348a0: 2064 6566 206d 6f76 655f 7374 6167 655f   def move_stage_
-000348b0: 7265 6c61 7469 7665 2873 656c 662c 2070  relative(self, p
-000348c0: 6f73 6974 696f 6e3a 2046 6962 7365 6d53  osition: FibsemS
-000348d0: 7461 6765 506f 7369 7469 6f6e 2920 2d3e  tagePosition) ->
-000348e0: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
-000348f0: 7469 6f6e 3a0a 2020 2020 2020 2020 2222  tion:.        ""
-00034900: 224d 6f76 6520 7468 6520 7374 6167 6520  "Move the stage 
-00034910: 6279 2074 6865 2073 7065 6369 6669 6564  by the specified
-00034920: 2061 6d6f 756e 742e 2222 220a 2020 2020   amount.""".    
-00034930: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-00034940: 6167 655f 7379 7374 656d 2e70 6f73 6974  age_system.posit
-00034950: 696f 6e20 2b3d 2070 6f73 6974 696f 6e0a  ion += position.
-00034960: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-00034970: 2e64 6562 7567 287b 226d 7367 223a 2022  .debug({"msg": "
-00034980: 6d6f 7665 5f73 7461 6765 5f72 656c 6174  move_stage_relat
-00034990: 6976 6522 2c20 2270 6f73 6974 696f 6e22  ive", "position"
-000349a0: 3a20 706f 7369 7469 6f6e 2e74 6f5f 6469  : position.to_di
-000349b0: 6374 2829 7d29 0a0a 2020 2020 2020 2020  ct()})..        
-000349c0: 7265 7475 726e 2073 656c 662e 6765 745f  return self.get_
-000349d0: 7374 6167 655f 706f 7369 7469 6f6e 2829  stage_position()
-000349e0: 0a0a 2020 2020 6465 6620 7374 6162 6c65  ..    def stable
-000349f0: 5f6d 6f76 6528 7365 6c66 2c20 6478 3a20  _move(self, dx: 
-00034a00: 666c 6f61 742c 2064 793a 666c 6f61 742c  float, dy:float,
-00034a10: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
-00034a20: 5479 7065 2c20 7374 6174 6963 5f77 643a  Type, static_wd:
-00034a30: 2062 6f6f 6c3d 4661 6c73 6529 202d 3e20   bool=False) -> 
-00034a40: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
-00034a50: 696f 6e3a 0a20 2020 2020 2020 200a 2020  ion:.        .  
-00034a60: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
-00034a70: 6765 5f6d 6f76 656d 656e 7428 7365 6c66  ge_movement(self
-00034a80: 2e73 7973 7465 6d2c 2046 6962 7365 6d53  .system, FibsemS
-00034a90: 7461 6765 506f 7369 7469 6f6e 2878 3d64  tagePosition(x=d
-00034aa0: 782c 2079 3d64 7929 290a 0a20 2020 2020  x, y=dy))..     
-00034ab0: 2020 2077 6420 3d20 7365 6c66 2e67 6574     wd = self.get
-00034ac0: 2822 776f 726b 696e 675f 6469 7374 616e  ("working_distan
-00034ad0: 6365 222c 2042 6561 6d54 7970 652e 454c  ce", BeamType.EL
-00034ae0: 4543 5452 4f4e 2920 0a0a 2020 2020 2020  ECTRON) ..      
-00034af0: 2020 7363 616e 5f72 6f74 6174 696f 6e20    scan_rotation 
-00034b00: 3d20 7365 6c66 2e67 6574 2822 7363 616e  = self.get("scan
-00034b10: 5f72 6f74 6174 696f 6e22 2c20 6265 616d  _rotation", beam
-00034b20: 5f74 7970 6529 0a20 2020 2020 2020 2069  _type).        i
-00034b30: 6620 6e70 2e69 7363 6c6f 7365 2873 6361  f np.isclose(sca
-00034b40: 6e5f 726f 7461 7469 6f6e 2c20 6e70 2e70  n_rotation, np.p
-00034b50: 6929 3a0a 2020 2020 2020 2020 2020 2020  i):.            
-00034b60: 6478 202a 3d20 2d31 2e30 0a20 2020 2020  dx *= -1.0.     
-00034b70: 2020 2020 2020 2064 7920 2a3d 202d 312e         dy *= -1.
-00034b80: 300a 2020 2020 2020 2020 0a20 2020 2020  0.        .     
-00034b90: 2020 2023 2063 616c 6375 6c61 7465 2073     # calculate s
-00034ba0: 7461 626c 6520 6d6f 7665 6d65 6e74 0a20  table movement. 
-00034bb0: 2020 2020 2020 2079 7a5f 6d6f 7665 203d         yz_move =
-00034bc0: 2073 656c 662e 5f79 5f63 6f72 7265 6374   self._y_correct
-00034bd0: 6564 5f73 7461 6765 5f6d 6f76 656d 656e  ed_stage_movemen
-00034be0: 7428 0a20 2020 2020 2020 2020 2020 2065  t(.            e
-00034bf0: 7870 6563 7465 645f 793d 6479 2c0a 2020  xpected_y=dy,.  
-00034c00: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
-00034c10: 7970 653d 6265 616d 5f74 7970 652c 0a20  ype=beam_type,. 
-00034c20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00034c30: 2073 7461 6765 5f70 6f73 6974 696f 6e20   stage_position 
-00034c40: 3d20 4669 6273 656d 5374 6167 6550 6f73  = FibsemStagePos
-00034c50: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
-00034c60: 2020 2078 3d64 782c 2079 3d79 7a5f 6d6f     x=dx, y=yz_mo
-00034c70: 7665 2e79 2c20 7a3d 797a 5f6d 6f76 652e  ve.y, z=yz_move.
-00034c80: 7a2c 0a20 2020 2020 2020 2020 2020 2072  z,.            r
-00034c90: 3d30 2c20 743d 302c 2063 6f6f 7264 696e  =0, t=0, coordin
-00034ca0: 6174 655f 7379 7374 656d 3d22 5241 5722  ate_system="RAW"
-00034cb0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00034cc0: 2020 2020 2023 206d 6f76 6520 7374 6167       # move stag
-00034cd0: 6520 2020 2020 2020 200a 2020 2020 2020  e        .      
-00034ce0: 2020 7365 6c66 2e6d 6f76 655f 7374 6167    self.move_stag
-00034cf0: 655f 7265 6c61 7469 7665 2873 7461 6765  e_relative(stage
-00034d00: 5f70 6f73 6974 696f 6e29 0a0a 2020 2020  _position)..    
-00034d10: 2020 2020 2320 6164 6a75 7374 2077 6f72      # adjust wor
-00034d20: 6b69 6e67 2064 6973 7461 6e63 6520 746f  king distance to
-00034d30: 2063 6f6d 7065 6e73 6174 6520 666f 7220   compensate for 
-00034d40: 7374 6167 6520 6d6f 7665 6d65 6e74 0a20  stage movement. 
-00034d50: 2020 2020 2020 2069 6620 7374 6174 6963         if static
-00034d60: 5f77 643a 0a20 2020 2020 2020 2020 2020  _wd:.           
-00034d70: 2077 6420 3d20 7365 6c66 2e73 7973 7465   wd = self.syste
-00034d80: 6d2e 656c 6563 7472 6f6e 2e65 7563 656e  m.electron.eucen
-00034d90: 7472 6963 5f68 6569 6768 740a 2020 2020  tric_height.    
-00034da0: 2020 2020 0a20 2020 2020 2020 2073 656c      .        sel
-00034db0: 662e 7365 7428 2277 6f72 6b69 6e67 5f64  f.set("working_d
-00034dc0: 6973 7461 6e63 6522 2c20 7764 2c20 4265  istance", wd, Be
-00034dd0: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
-00034de0: 0a0a 2020 2020 2020 2020 2320 6c6f 6767  ..        # logg
-00034df0: 696e 670a 2020 2020 2020 2020 6c6f 6767  ing.        logg
-00034e00: 696e 672e 6465 6275 6728 7b22 6d73 6722  ing.debug({"msg"
-00034e10: 3a20 2273 7461 626c 655f 6d6f 7665 222c  : "stable_move",
-00034e20: 2022 6478 223a 2064 782c 2022 6479 223a   "dx": dx, "dy":
-00034e30: 2064 792c 200a 2020 2020 2020 2020 2020   dy, .          
-00034e40: 2020 2020 2020 2262 6561 6d5f 7479 7065        "beam_type
-00034e50: 223a 2062 6561 6d5f 7479 7065 2e6e 616d  ": beam_type.nam
-00034e60: 652c 2022 7374 6174 6963 5f77 6422 3a20  e, "static_wd": 
-00034e70: 7374 6174 6963 5f77 642c 200a 2020 2020  static_wd, .    
-00034e80: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-00034e90: 6b69 6e67 5f64 6973 7461 6e63 6522 3a20  king_distance": 
-00034ea0: 7764 2c20 2273 6361 6e5f 726f 7461 7469  wd, "scan_rotati
-00034eb0: 6f6e 223a 2073 6361 6e5f 726f 7461 7469  on": scan_rotati
-00034ec0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00034ed0: 2020 2020 2270 6f73 6974 696f 6e22 3a20      "position": 
-00034ee0: 7374 6167 655f 706f 7369 7469 6f6e 2e74  stage_position.t
-00034ef0: 6f5f 6469 6374 2829 7d29 0a0a 2020 2020  o_dict()})..    
-00034f00: 2020 2020 7265 7475 726e 2073 7461 6765      return stage
-00034f10: 5f70 6f73 6974 696f 6e0a 0a0a 2020 2020  _position...    
-00034f20: 6465 6620 7665 7274 6963 616c 5f6d 6f76  def vertical_mov
-00034f30: 6528 7365 6c66 2c20 6479 3a20 666c 6f61  e(self, dy: floa
-00034f40: 742c 2064 783a 666c 6f61 7420 3d20 302e  t, dx:float = 0.
-00034f50: 302c 2073 7461 7469 635f 7764 3a20 626f  0, static_wd: bo
-00034f60: 6f6c 3d54 7275 6529 202d 3e20 4669 6273  ol=True) -> Fibs
-00034f70: 656d 5374 6167 6550 6f73 6974 696f 6e3a  emStagePosition:
-00034f80: 0a20 2020 2020 2020 2022 2222 4d6f 7665  .        """Move
-00034f90: 2074 6865 2073 7461 6765 2076 6572 7469   the stage verti
-00034fa0: 6361 6c6c 7920 6279 2074 6865 2073 7065  cally by the spe
-00034fb0: 6369 6669 6564 2061 6d6f 756e 742e 2222  cified amount.""
-00034fc0: 220a 2020 2020 2020 2020 2320 636f 6e66  ".        # conf
-00034fd0: 6972 6d20 7374 6167 6520 6973 2065 6e61  irm stage is ena
-00034fe0: 626c 6564 0a20 2020 2020 2020 205f 6368  bled.        _ch
-00034ff0: 6563 6b5f 7374 6167 6528 7365 6c66 2e73  eck_stage(self.s
-00035000: 7973 7465 6d29 0a0a 2020 2020 2020 2020  ystem)..        
-00035010: 2320 6765 7420 6375 7272 656e 7420 776f  # get current wo
-00035020: 726b 696e 6720 6469 7374 616e 6365 2c20  rking distance, 
-00035030: 746f 2062 6520 7265 7374 6f72 6564 206c  to be restored l
-00035040: 6174 6572 0a20 2020 2020 2020 2077 6420  ater.        wd 
-00035050: 3d20 7365 6c66 2e67 6574 2822 776f 726b  = self.get("work
-00035060: 696e 675f 6469 7374 616e 6365 222c 2042  ing_distance", B
-00035070: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-00035080: 290a 0a20 2020 2020 2020 2023 2061 646a  )..        # adj
-00035090: 7573 7420 666f 7220 7363 616e 2072 6f74  ust for scan rot
-000350a0: 6174 696f 6e0a 2020 2020 2020 2020 7363  ation.        sc
-000350b0: 616e 5f72 6f74 6174 696f 6e20 3d20 7365  an_rotation = se
-000350c0: 6c66 2e67 6574 2822 7363 616e 5f72 6f74  lf.get("scan_rot
-000350d0: 6174 696f 6e22 2c20 4265 616d 5479 7065  ation", BeamType
-000350e0: 2e49 4f4e 290a 2020 2020 2020 2020 6966  .ION).        if
-000350f0: 206e 702e 6973 636c 6f73 6528 7363 616e   np.isclose(scan
-00035100: 5f72 6f74 6174 696f 6e2c 206e 702e 7069  _rotation, np.pi
-00035110: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
-00035120: 7820 2a3d 202d 312e 300a 2020 2020 2020  x *= -1.0.      
-00035130: 2020 2020 2020 6479 202a 3d20 2d31 2e30        dy *= -1.0
-00035140: 0a0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
-00035150: 3a20 696d 706c 656d 656e 7420 7065 7273  : implement pers
-00035160: 7065 6374 6976 6520 636f 7272 6563 7469  pective correcti
-00035170: 6f6e 0a20 2020 2020 2020 2050 4552 5350  on.        PERSP
-00035180: 4543 5449 5645 5f43 4f52 5245 4354 494f  ECTIVE_CORRECTIO
-00035190: 4e20 3d20 302e 390a 2020 2020 2020 2020  N = 0.9.        
-000351a0: 7a5f 6d6f 7665 203d 2064 7920 2f20 6e70  z_move = dy / np
-000351b0: 2e63 6f73 286e 702e 6465 6732 7261 6428  .cos(np.deg2rad(
-000351c0: 3930 202d 2073 656c 662e 7379 7374 656d  90 - self.system
-000351d0: 2e69 6f6e 2e63 6f6c 756d 6e5f 7469 6c74  .ion.column_tilt
-000351e0: 2929 202a 2050 4552 5350 4543 5449 5645  )) * PERSPECTIVE
-000351f0: 5f43 4f52 5245 4354 494f 4e20 2023 2054  _CORRECTION  # T
-00035200: 4f44 4f3a 204d 4147 4943 204e 554d 4245  ODO: MAGIC NUMBE
-00035210: 522c 2039 3020 2d20 6669 6220 7469 6c74  R, 90 - fib tilt
-00035220: 0a0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
-00035230: 3a20 646f 2074 6869 7320 6d61 6e75 616c  : do this manual
-00035240: 6c79 2077 6974 686f 7574 2061 7574 6f73  ly without autos
-00035250: 6372 6970 7420 696e 2072 6177 2063 6f6f  cript in raw coo
-00035260: 7264 696e 6174 6573 0a20 2020 2020 2020  rdinates.       
-00035270: 2073 7461 6765 5f70 6f73 6974 696f 6e20   stage_position 
-00035280: 3d20 4669 6273 656d 5374 6167 6550 6f73  = FibsemStagePos
-00035290: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
-000352a0: 2020 2078 3d64 782c 0a20 2020 2020 2020     x=dx,.       
-000352b0: 2020 2020 207a 3d7a 5f6d 6f76 652c 200a       z=z_move, .
-000352c0: 2020 2020 2020 2020 2020 2020 636f 6f72              coor
-000352d0: 6469 6e61 7465 5f73 7973 7465 6d3d 2253  dinate_system="S
-000352e0: 7065 6369 6d65 6e22 0a20 2020 2020 2020  pecimen".       
-000352f0: 2029 0a0a 2020 2020 2020 2020 2320 6d6f   )..        # mo
-00035300: 7665 2073 7461 6765 0a20 2020 2020 2020  ve stage.       
-00035310: 2073 656c 662e 6d6f 7665 5f73 7461 6765   self.move_stage
-00035320: 5f72 656c 6174 6976 6528 7374 6167 655f  _relative(stage_
-00035330: 706f 7369 7469 6f6e 290a 0a20 2020 2020  position)..     
-00035340: 2020 2069 6620 7374 6174 6963 5f77 643a     if static_wd:
-00035350: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00035360: 662e 7365 7428 2277 6f72 6b69 6e67 5f64  f.set("working_d
-00035370: 6973 7461 6e63 6522 2c20 7365 6c66 2e73  istance", self.s
-00035380: 7973 7465 6d2e 656c 6563 7472 6f6e 2e65  ystem.electron.e
-00035390: 7563 656e 7472 6963 5f68 6569 6768 742c  ucentric_height,
-000353a0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
-000353b0: 4f4e 290a 2020 2020 2020 2020 2020 2020  ON).            
-000353c0: 7365 6c66 2e73 6574 2822 776f 726b 696e  self.set("workin
-000353d0: 675f 6469 7374 616e 6365 222c 2073 656c  g_distance", sel
-000353e0: 662e 7379 7374 656d 2e69 6f6e 2e65 7563  f.system.ion.euc
-000353f0: 656e 7472 6963 5f68 6569 6768 742c 2042  entric_height, B
-00035400: 6561 6d54 7970 652e 494f 4e29 0a20 2020  eamType.ION).   
-00035410: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00035420: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
-00035430: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
-00035440: 6522 2c20 7764 2c20 4265 616d 5479 7065  e", wd, BeamType
-00035450: 2e45 4c45 4354 524f 4e29 0a20 2020 200a  .ELECTRON).    .
-00035460: 2020 2020 2020 2020 2320 6c6f 6767 696e          # loggin
-00035470: 670a 2020 2020 2020 2020 6c6f 6767 696e  g.        loggin
-00035480: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
-00035490: 2276 6572 7469 6361 6c5f 6d6f 7665 222c  "vertical_move",
-000354a0: 2022 6479 223a 2064 792c 2022 6478 223a   "dy": dy, "dx":
-000354b0: 2064 782c 200a 2020 2020 2020 2020 2020   dx, .          
-000354c0: 2020 2020 2020 2273 7461 7469 635f 7764        "static_wd
-000354d0: 223a 2073 7461 7469 635f 7764 2c20 2277  ": static_wd, "w
-000354e0: 6f72 6b69 6e67 5f64 6973 7461 6e63 6522  orking_distance"
-000354f0: 3a20 7764 2c20 0a20 2020 2020 2020 2020  : wd, .         
-00035500: 2020 2020 2020 2022 7363 616e 5f72 6f74         "scan_rot
-00035510: 6174 696f 6e22 3a20 7363 616e 5f72 6f74  ation": scan_rot
-00035520: 6174 696f 6e2c 200a 2020 2020 2020 2020  ation, .        
-00035530: 2020 2020 2020 2020 2270 6f73 6974 696f          "positio
-00035540: 6e22 3a20 7374 6167 655f 706f 7369 7469  n": stage_positi
-00035550: 6f6e 2e74 6f5f 6469 6374 2829 7d29 0a0a  on.to_dict()})..
-00035560: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00035570: 656c 662e 6765 745f 7374 6167 655f 706f  elf.get_stage_po
-00035580: 7369 7469 6f6e 2829 0a0a 2020 2020 6465  sition()..    de
-00035590: 6620 5f79 5f63 6f72 7265 6374 6564 5f73  f _y_corrected_s
-000355a0: 7461 6765 5f6d 6f76 656d 656e 7428 7365  tage_movement(se
-000355b0: 6c66 2c20 6578 7065 6374 6564 5f79 3a20  lf, expected_y: 
-000355c0: 666c 6f61 742c 2062 6561 6d5f 7479 7065  float, beam_type
-000355d0: 3a20 4265 616d 5479 7065 2920 2d3e 2046  : BeamType) -> F
-000355e0: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
-000355f0: 6f6e 3a0a 2020 2020 2020 2020 2222 220a  on:.        """.
-00035600: 2020 2020 2020 2020 4361 6c63 756c 6174          Calculat
-00035610: 6520 7468 6520 636f 7272 6563 7465 6420  e the corrected 
-00035620: 7374 6167 6520 6d6f 7665 6d65 6e74 7320  stage movements 
-00035630: 6261 7365 6420 6f6e 2074 6865 2062 6561  based on the bea
-00035640: 6d5f 7479 7065 2c20 616e 6420 7468 656e  m_type, and then
-00035650: 206d 6f76 6520 7468 6520 7374 6167 6520   move the stage 
-00035660: 7265 6c61 7469 7665 6c79 2e0a 0a20 2020  relatively...   
-00035670: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
-00035680: 2020 2020 2020 2064 7820 2866 6c6f 6174         dx (float
-00035690: 293a 2064 6973 7461 6e63 6520 616c 6f6e  ): distance alon
-000356a0: 6720 7468 6520 782d 6178 6973 2028 696d  g the x-axis (im
-000356b0: 6167 6520 636f 6f72 6469 6e61 7465 7329  age coordinates)
-000356c0: 0a20 2020 2020 2020 2020 2020 2064 7920  .            dy 
-000356d0: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
-000356e0: 6520 616c 6f6e 6720 7468 6520 792d 6178  e along the y-ax
-000356f0: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
-00035700: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
-00035710: 2020 2062 6561 6d5f 7479 7065 2028 4265     beam_type (Be
-00035720: 616d 5479 7065 293a 2062 6561 6d20 7479  amType): beam ty
-00035730: 7065 2074 6f20 6d6f 7665 2069 6e0a 2020  pe to move in.  
-00035740: 2020 2020 2020 2020 2020 7374 6174 6963            static
-00035750: 5f77 6420 2862 6f6f 6c2c 206f 7074 696f  _wd (bool, optio
-00035760: 6e61 6c29 3a20 7768 6574 6865 7220 746f  nal): whether to
-00035770: 2066 6978 2074 6865 2077 6f72 6b69 6e67   fix the working
-00035780: 2064 6973 7461 6e63 652e 2044 6566 6175   distance. Defau
-00035790: 6c74 7320 746f 2046 616c 7365 2e0a 2020  lts to False..  
-000357a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000357b0: 2020 0a20 2020 2020 2020 2023 2061 6c6c    .        # all
-000357c0: 2061 6e67 6c65 7320 696e 2072 6164 6961   angles in radia
-000357d0: 6e73 0a20 2020 2020 2020 2073 7461 6765  ns.        stage
-000357e0: 5f74 696c 745f 666c 6174 5f74 6f5f 656c  _tilt_flat_to_el
-000357f0: 6563 7472 6f6e 203d 206e 702e 6465 6732  ectron = np.deg2
-00035800: 7261 6428 7365 6c66 2e73 7973 7465 6d2e  rad(self.system.
-00035810: 656c 6563 7472 6f6e 2e63 6f6c 756d 6e5f  electron.column_
-00035820: 7469 6c74 290a 2020 2020 2020 2020 7374  tilt).        st
-00035830: 6167 655f 7469 6c74 5f66 6c61 745f 746f  age_tilt_flat_to
-00035840: 5f69 6f6e 203d 206e 702e 6465 6732 7261  _ion = np.deg2ra
-00035850: 6428 7365 6c66 2e73 7973 7465 6d2e 696f  d(self.system.io
-00035860: 6e2e 636f 6c75 6d6e 5f74 696c 7429 0a0a  n.column_tilt)..
-00035870: 2020 2020 2020 2020 7374 6167 655f 7072          stage_pr
-00035880: 6574 696c 7420 3d20 6e70 2e64 6567 3272  etilt = np.deg2r
-00035890: 6164 2873 656c 662e 7379 7374 656d 2e73  ad(self.system.s
-000358a0: 7461 6765 2e73 6875 7474 6c65 5f70 7265  tage.shuttle_pre
-000358b0: 5f74 696c 7429 0a0a 2020 2020 2020 2020  _tilt)..        
-000358c0: 7374 6167 655f 726f 7461 7469 6f6e 5f66  stage_rotation_f
-000358d0: 6c61 745f 746f 5f65 6220 3d20 6e70 2e64  lat_to_eb = np.d
-000358e0: 6567 3272 6164 280a 2020 2020 2020 2020  eg2rad(.        
-000358f0: 2020 2020 7365 6c66 2e73 7973 7465 6d2e      self.system.
-00035900: 7374 6167 652e 726f 7461 7469 6f6e 5f72  stage.rotation_r
-00035910: 6566 6572 656e 6365 0a20 2020 2020 2020  eference.       
-00035920: 2029 2025 2028 3220 2a20 6e70 2e70 6929   ) % (2 * np.pi)
-00035930: 0a20 2020 2020 2020 2073 7461 6765 5f72  .        stage_r
-00035940: 6f74 6174 696f 6e5f 666c 6174 5f74 6f5f  otation_flat_to_
-00035950: 696f 6e20 3d20 6e70 2e64 6567 3272 6164  ion = np.deg2rad
-00035960: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00035970: 6c66 2e73 7973 7465 6d2e 7374 6167 652e  lf.system.stage.
-00035980: 726f 7461 7469 6f6e 5f31 3830 0a20 2020  rotation_180.   
-00035990: 2020 2020 2029 2025 2028 3220 2a20 6e70       ) % (2 * np
-000359a0: 2e70 6929 0a0a 2020 2020 2020 2020 2320  .pi)..        # 
-000359b0: 6375 7272 656e 7420 7374 6167 6520 706f  current stage po
-000359c0: 7369 7469 6f6e 0a20 2020 2020 2020 2063  sition.        c
-000359d0: 7572 7265 6e74 5f73 7461 6765 5f70 6f73  urrent_stage_pos
-000359e0: 6974 696f 6e20 3d20 7365 6c66 2e67 6574  ition = self.get
-000359f0: 5f73 7461 6765 5f70 6f73 6974 696f 6e28  _stage_position(
-00035a00: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
-00035a10: 726f 7461 7469 6f6e 203d 2063 7572 7265  rotation = curre
-00035a20: 6e74 5f73 7461 6765 5f70 6f73 6974 696f  nt_stage_positio
-00035a30: 6e2e 7220 2520 2832 202a 206e 702e 7069  n.r % (2 * np.pi
-00035a40: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
-00035a50: 7469 6c74 203d 2063 7572 7265 6e74 5f73  tilt = current_s
-00035a60: 7461 6765 5f70 6f73 6974 696f 6e2e 740a  tage_position.t.
-00035a70: 0a20 2020 2020 2020 2050 5245 5449 4c54  .        PRETILT
-00035a80: 5f53 4947 4e20 3d20 312e 300a 2020 2020  _SIGN = 1.0.    
-00035a90: 2020 2020 2320 7072 6574 696c 7420 616e      # pretilt an
-00035aa0: 676c 6520 6465 7065 6e64 7320 6f6e 2072  gle depends on r
-00035ab0: 6f74 6174 696f 6e0a 2020 2020 2020 2020  otation.        
-00035ac0: 6672 6f6d 2066 6962 7365 6d20 696d 706f  from fibsem impo
-00035ad0: 7274 206d 6f76 656d 656e 740a 2020 2020  rt movement.    
-00035ae0: 2020 2020 6966 206d 6f76 656d 656e 742e      if movement.
-00035af0: 726f 7461 7469 6f6e 5f61 6e67 6c65 5f69  rotation_angle_i
-00035b00: 735f 736d 616c 6c65 7228 7374 6167 655f  s_smaller(stage_
-00035b10: 726f 7461 7469 6f6e 2c20 7374 6167 655f  rotation, stage_
-00035b20: 726f 7461 7469 6f6e 5f66 6c61 745f 746f  rotation_flat_to
-00035b30: 5f65 622c 2061 746f 6c3d 3529 3a0a 2020  _eb, atol=5):.  
-00035b40: 2020 2020 2020 2020 2020 5052 4554 494c            PRETIL
-00035b50: 545f 5349 474e 203d 2031 2e30 0a20 2020  T_SIGN = 1.0.   
-00035b60: 2020 2020 2069 6620 6d6f 7665 6d65 6e74       if movement
-00035b70: 2e72 6f74 6174 696f 6e5f 616e 676c 655f  .rotation_angle_
-00035b80: 6973 5f73 6d61 6c6c 6572 280a 2020 2020  is_smaller(.    
-00035b90: 2020 2020 2020 2020 7374 6167 655f 726f          stage_ro
-00035ba0: 7461 7469 6f6e 2c20 7374 6167 655f 726f  tation, stage_ro
-00035bb0: 7461 7469 6f6e 5f66 6c61 745f 746f 5f69  tation_flat_to_i
-00035bc0: 6f6e 2c20 6174 6f6c 3d35 0a20 2020 2020  on, atol=5.     
-00035bd0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-00035be0: 2020 5052 4554 494c 545f 5349 474e 203d    PRETILT_SIGN =
-00035bf0: 202d 312e 300a 0a20 2020 2020 2020 2023   -1.0..        #
-00035c00: 2063 6f72 7265 6374 6564 5f70 7265 7469   corrected_preti
-00035c10: 6c74 5f61 6e67 6c65 203d 2050 5245 5449  lt_angle = PRETI
-00035c20: 4c54 5f53 4947 4e20 2a20 7374 6167 655f  LT_SIGN * stage_
-00035c30: 7469 6c74 5f66 6c61 745f 746f 5f65 6c65  tilt_flat_to_ele
-00035c40: 6374 726f 6e0a 2020 2020 2020 2020 636f  ctron.        co
-00035c50: 7272 6563 7465 645f 7072 6574 696c 745f  rrected_pretilt_
-00035c60: 616e 676c 6520 3d20 5052 4554 494c 545f  angle = PRETILT_
-00035c70: 5349 474e 202a 2028 7374 6167 655f 7072  SIGN * (stage_pr
-00035c80: 6574 696c 7420 2b20 7374 6167 655f 7469  etilt + stage_ti
-00035c90: 6c74 5f66 6c61 745f 746f 5f65 6c65 6374  lt_flat_to_elect
-00035ca0: 726f 6e29 2023 2065 6c65 6374 726f 6e20  ron) # electron 
-00035cb0: 616e 676c 6520 3d20 302c 2069 6f6e 203d  angle = 0, ion =
-00035cc0: 2035 320a 0a20 2020 2020 2020 2023 2070   52..        # p
-00035cd0: 6572 7370 6563 7469 7665 2074 696c 7420  erspective tilt 
-00035ce0: 6164 6a75 7374 6d65 6e74 2028 6469 6666  adjustment (diff
-00035cf0: 6572 656e 6365 2062 6574 7765 656e 2070  erence between p
-00035d00: 6572 7370 6563 7469 7665 2076 6965 7720  erspective view 
-00035d10: 616e 6420 7361 6d70 6c65 2063 6f6f 7264  and sample coord
-00035d20: 696e 6174 6520 7379 7374 656d 290a 2020  inate system).  
-00035d30: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-00035d40: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
-00035d50: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-00035d60: 2020 2020 2070 6572 7370 6563 7469 7665       perspective
-00035d70: 5f74 696c 745f 6164 6a75 7374 6d65 6e74  _tilt_adjustment
-00035d80: 203d 202d 636f 7272 6563 7465 645f 7072   = -corrected_pr
-00035d90: 6574 696c 745f 616e 676c 650a 2020 2020  etilt_angle.    
-00035da0: 2020 2020 2020 2020 5343 414c 455f 4641          SCALE_FA
-00035db0: 4354 4f52 203d 2031 2e30 2020 2320 302e  CTOR = 1.0  # 0.
-00035dc0: 3738 3334 3220 2023 2070 6174 656e 7465  78342  # patente
-00035dd0: 6420 7465 6368 6e6f 6c6f 6779 0a20 2020  d technology.   
-00035de0: 2020 2020 2065 6c69 6620 6265 616d 5f74       elif beam_t
-00035df0: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
-00035e00: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
-00035e10: 2070 6572 7370 6563 7469 7665 5f74 696c   perspective_til
-00035e20: 745f 6164 6a75 7374 6d65 6e74 203d 2028  t_adjustment = (
-00035e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035e40: 202d 636f 7272 6563 7465 645f 7072 6574   -corrected_pret
-00035e50: 696c 745f 616e 676c 6520 2d20 7374 6167  ilt_angle - stag
-00035e60: 655f 7469 6c74 5f66 6c61 745f 746f 5f69  e_tilt_flat_to_i
-00035e70: 6f6e 0a20 2020 2020 2020 2020 2020 2029  on.            )
-00035e80: 0a20 2020 2020 2020 2020 2020 2053 4341  .            SCA
-00035e90: 4c45 5f46 4143 544f 5220 3d20 312e 300a  LE_FACTOR = 1.0.
-00035ea0: 0a20 2020 2020 2020 2023 2074 6865 2061  .        # the a
-00035eb0: 6d6f 756e 7420 7468 6520 7361 6d70 6c65  mount the sample
-00035ec0: 2068 6173 2074 6f20 6d6f 7665 2069 6e20   has to move in 
-00035ed0: 7468 6520 792d 6178 6973 0a20 2020 2020  the y-axis.     
-00035ee0: 2020 2079 5f73 616d 706c 655f 6d6f 7665     y_sample_move
-00035ef0: 203d 2028 6578 7065 6374 6564 5f79 202a   = (expected_y *
-00035f00: 2053 4341 4c45 5f46 4143 544f 5229 202f   SCALE_FACTOR) /
-00035f10: 206e 702e 636f 7328 0a20 2020 2020 2020   np.cos(.       
-00035f20: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
-00035f30: 2b20 7065 7273 7065 6374 6976 655f 7469  + perspective_ti
-00035f40: 6c74 5f61 646a 7573 746d 656e 740a 2020  lt_adjustment.  
-00035f50: 2020 2020 2020 290a 2020 2020 2020 200a        ).       .
-00035f60: 2020 2020 2020 2020 2320 7468 6520 616d          # the am
-00035f70: 6f75 6e74 2074 6865 2073 7461 6765 2068  ount the stage h
-00035f80: 6173 2074 6f20 6d6f 7665 2069 6e20 6561  as to move in ea
-00035f90: 6368 2061 7869 730a 2020 2020 2020 2020  ch axis.        
-00035fa0: 795f 6d6f 7665 203d 2079 5f73 616d 706c  y_move = y_sampl
-00035fb0: 655f 6d6f 7665 202a 206e 702e 636f 7328  e_move * np.cos(
-00035fc0: 636f 7272 6563 7465 645f 7072 6574 696c  corrected_pretil
-00035fd0: 745f 616e 676c 6529 0a20 2020 2020 2020  t_angle).       
-00035fe0: 207a 5f6d 6f76 6520 3d20 2d79 5f73 616d   z_move = -y_sam
-00035ff0: 706c 655f 6d6f 7665 202a 206e 702e 7369  ple_move * np.si
-00036000: 6e28 636f 7272 6563 7465 645f 7072 6574  n(corrected_pret
-00036010: 696c 745f 616e 676c 6529 2023 544f 444f  ilt_angle) #TODO
-00036020: 3a20 696e 7665 7374 6967 6174 6520 7468  : investigate th
-00036030: 6973 0a0a 2020 2020 2020 2020 7265 7475  is..        retu
-00036040: 726e 2046 6962 7365 6d53 7461 6765 506f  rn FibsemStagePo
-00036050: 7369 7469 6f6e 2878 3d30 2c20 793d 795f  sition(x=0, y=y_
-00036060: 6d6f 7665 2c20 7a3d 7a5f 6d6f 7665 290a  move, z=z_move).
-00036070: 0a20 2020 2064 6566 2069 6e73 6572 745f  .    def insert_
-00036080: 6d61 6e69 7075 6c61 746f 7228 7365 6c66  manipulator(self
-00036090: 2c20 6e61 6d65 3a20 7374 7220 3d20 2250  , name: str = "P
-000360a0: 4152 4b22 2920 2d3e 2046 6962 7365 6d4d  ARK") -> FibsemM
-000360b0: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-000360c0: 6f6e 3a0a 2020 2020 2020 2020 2222 2249  on:.        """I
-000360d0: 6e73 6572 7420 7468 6520 6d61 6e69 7075  nsert the manipu
-000360e0: 6c61 746f 7220 746f 2074 6865 2073 7065  lator to the spe
-000360f0: 6369 6669 6564 2070 6f73 6974 696f 6e2e  cified position.
-00036100: 2222 220a 2020 2020 2020 2020 5f63 6865  """.        _che
-00036110: 636b 5f6d 616e 6970 756c 6174 6f72 2873  ck_manipulator(s
-00036120: 656c 662e 7379 7374 656d 290a 0a20 2020  elf.system)..   
-00036130: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-00036140: 6f28 6622 496e 7365 7274 696e 6720 6d61  o(f"Inserting ma
-00036150: 6e69 7075 6c61 746f 7220 746f 207b 6e61  nipulator to {na
-00036160: 6d65 7d2e 2e2e 2229 0a20 2020 2020 2020  me}...").       
-00036170: 2073 656c 662e 6d6f 7665 5f6d 616e 6970   self.move_manip
-00036180: 756c 6174 6f72 5f61 6273 6f6c 7574 6528  ulator_absolute(
-00036190: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
-000361a0: 7250 6f73 6974 696f 6e28 783d 302c 2079  rPosition(x=0, y
-000361b0: 3d30 2c20 7a3d 3138 3065 2d36 2c20 723d  =0, z=180e-6, r=
-000361c0: 302c 2074 3d30 2929 0a20 2020 2020 2020  0, t=0)).       
-000361d0: 2073 656c 662e 6d61 6e69 7075 6c61 746f   self.manipulato
-000361e0: 725f 7379 7374 656d 2e69 6e73 6572 7465  r_system.inserte
-000361f0: 6420 3d20 5472 7565 0a20 2020 2020 2020  d = True.       
-00036200: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-00036210: 226d 7367 223a 2022 696e 7365 7274 5f6d  "msg": "insert_m
-00036220: 616e 6970 756c 6174 6f72 222c 2022 6e61  anipulator", "na
-00036230: 6d65 223a 206e 616d 657d 290a 0a20 2020  me": name})..   
-00036240: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00036250: 2e67 6574 5f6d 616e 6970 756c 6174 6f72  .get_manipulator
-00036260: 5f70 6f73 6974 696f 6e28 290a 2020 2020  _position().    
-00036270: 0a20 2020 2064 6566 2072 6574 7261 6374  .    def retract
-00036280: 5f6d 616e 6970 756c 6174 6f72 2873 656c  _manipulator(sel
-00036290: 6629 3a0a 2020 2020 2020 2020 2222 2252  f):.        """R
-000362a0: 6574 7261 6374 2074 6865 206d 616e 6970  etract the manip
-000362b0: 756c 6174 6f72 2e22 2222 0a20 2020 2020  ulator.""".     
-000362c0: 2020 205f 6368 6563 6b5f 6d61 6e69 7075     _check_manipu
-000362d0: 6c61 746f 7228 7365 6c66 2e73 7973 7465  lator(self.syste
-000362e0: 6d29 0a20 2020 2020 2020 206c 6f67 6769  m).        loggi
-000362f0: 6e67 2e69 6e66 6f28 6622 5265 7472 6163  ng.info(f"Retrac
-00036300: 7469 6e67 206d 616e 6970 756c 6174 6f72  ting manipulator
-00036310: 2e2e 2e22 290a 2020 2020 2020 2020 7365  ...").        se
-00036320: 6c66 2e6d 6f76 655f 6d61 6e69 7075 6c61  lf.move_manipula
-00036330: 746f 725f 6162 736f 6c75 7465 2846 6962  tor_absolute(Fib
-00036340: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
-00036350: 7369 7469 6f6e 2878 3d30 2c20 793d 302c  sition(x=0, y=0,
-00036360: 207a 3d30 2c20 723d 302c 2074 3d30 2929   z=0, r=0, t=0))
-00036370: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
-00036380: 6e69 7075 6c61 746f 725f 7379 7374 656d  nipulator_system
-00036390: 2e69 6e73 6572 7465 6420 3d20 4661 6c73  .inserted = Fals
-000363a0: 650a 2020 2020 2020 2020 6c6f 6767 696e  e.        loggin
-000363b0: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
-000363c0: 2272 6574 7261 6374 5f6d 616e 6970 756c  "retract_manipul
-000363d0: 6174 6f72 227d 290a 0a20 2020 2064 6566  ator"})..    def
-000363e0: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
-000363f0: 725f 7265 6c61 7469 7665 2873 656c 662c  r_relative(self,
-00036400: 2070 6f73 6974 696f 6e3a 2046 6962 7365   position: Fibse
-00036410: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
-00036420: 7469 6f6e 2920 2d3e 2046 6962 7365 6d4d  tion) -> FibsemM
-00036430: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-00036440: 6f6e 3a0a 2020 2020 2020 2020 5f63 6865  on:.        _che
-00036450: 636b 5f6d 616e 6970 756c 6174 6f72 5f6d  ck_manipulator_m
-00036460: 6f76 656d 656e 7428 7365 6c66 2e73 7973  ovement(self.sys
-00036470: 7465 6d2c 2070 6f73 6974 696f 6e29 0a20  tem, position). 
-00036480: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00036490: 6e66 6f28 6622 4d6f 7669 6e67 206d 616e  nfo(f"Moving man
-000364a0: 6970 756c 6174 6f72 3a20 7b70 6f73 6974  ipulator: {posit
-000364b0: 696f 6e7d 2028 5265 6c61 7469 7665 2922  ion} (Relative)"
-000364c0: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
-000364d0: 616e 6970 756c 6174 6f72 5f73 7973 7465  anipulator_syste
-000364e0: 6d2e 706f 7369 7469 6f6e 202b 3d20 706f  m.position += po
-000364f0: 7369 7469 6f6e 0a20 2020 2020 2020 206c  sition.        l
-00036500: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
-00036510: 7367 223a 2022 6d6f 7665 5f6d 616e 6970  sg": "move_manip
-00036520: 756c 6174 6f72 5f72 656c 6174 6976 6522  ulator_relative"
-00036530: 2c20 2270 6f73 6974 696f 6e22 3a20 706f  , "position": po
-00036540: 7369 7469 6f6e 2e74 6f5f 6469 6374 2829  sition.to_dict()
-00036550: 7d29 0a20 2020 2020 2020 2072 6574 7572  }).        retur
-00036560: 6e20 7365 6c66 2e67 6574 5f6d 616e 6970  n self.get_manip
-00036570: 756c 6174 6f72 5f70 6f73 6974 696f 6e28  ulator_position(
-00036580: 290a 2020 2020 0a20 2020 2064 6566 206d  ).    .    def m
-00036590: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
-000365a0: 6162 736f 6c75 7465 2873 656c 662c 2070  absolute(self, p
-000365b0: 6f73 6974 696f 6e3a 2046 6962 7365 6d4d  osition: FibsemM
-000365c0: 616e 6970 756c 6174 6f72 506f 7369 7469  anipulatorPositi
-000365d0: 6f6e 2920 2d3e 2046 6962 7365 6d4d 616e  on) -> FibsemMan
-000365e0: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
-000365f0: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
-00036600: 5f6d 616e 6970 756c 6174 6f72 2873 656c  _manipulator(sel
-00036610: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
-00036620: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
-00036630: 224d 6f76 696e 6720 6d61 6e69 7075 6c61  "Moving manipula
-00036640: 746f 723a 207b 706f 7369 7469 6f6e 7d20  tor: {position} 
-00036650: 2841 6273 6f6c 7574 6529 2229 0a20 2020  (Absolute)").   
-00036660: 2020 2020 2073 656c 662e 6d61 6e69 7075       self.manipu
-00036670: 6c61 746f 725f 7379 7374 656d 2e70 6f73  lator_system.pos
-00036680: 6974 696f 6e20 3d20 706f 7369 7469 6f6e  ition = position
-00036690: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-000366a0: 2e64 6562 7567 287b 226d 7367 223a 2022  .debug({"msg": "
-000366b0: 6d6f 7665 5f6d 616e 6970 756c 6174 6f72  move_manipulator
-000366c0: 5f61 6273 6f6c 7574 6522 2c20 2270 6f73  _absolute", "pos
-000366d0: 6974 696f 6e22 3a20 706f 7369 7469 6f6e  ition": position
-000366e0: 2e74 6f5f 6469 6374 2829 7d29 0a20 2020  .to_dict()}).   
-000366f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00036700: 2e67 6574 5f6d 616e 6970 756c 6174 6f72  .get_manipulator
-00036710: 5f70 6f73 6974 696f 6e28 290a 2020 2020  _position().    
-00036720: 2020 2020 2020 2020 2020 0a20 2020 2064            .    d
-00036730: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
-00036740: 746f 725f 636f 7272 6563 7465 6428 7365  tor_corrected(se
-00036750: 6c66 2c20 6478 3a20 666c 6f61 742c 2064  lf, dx: float, d
-00036760: 793a 2066 6c6f 6174 2c20 6265 616d 5f74  y: float, beam_t
-00036770: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
-00036780: 3e20 4669 6273 656d 4d61 6e69 7075 6c61  > FibsemManipula
-00036790: 746f 7250 6f73 6974 696f 6e3a 0a20 2020  torPosition:.   
-000367a0: 2020 2020 205f 6368 6563 6b5f 6d61 6e69       _check_mani
-000367b0: 7075 6c61 746f 7228 7365 6c66 2e73 7973  pulator(self.sys
-000367c0: 7465 6d29 0a20 2020 2020 2020 206c 6f67  tem).        log
-000367d0: 6769 6e67 2e69 6e66 6f28 6622 4d6f 7669  ging.info(f"Movi
-000367e0: 6e67 206d 616e 6970 756c 6174 6f72 3a20  ng manipulator: 
-000367f0: 6478 3d7b 6478 3a2e 3265 7d2c 2064 793d  dx={dx:.2e}, dy=
-00036800: 7b64 793a 2e32 657d 2c20 6265 616d 5f74  {dy:.2e}, beam_t
-00036810: 7970 6520 3d20 7b62 6561 6d5f 7479 7065  ype = {beam_type
-00036820: 2e6e 616d 657d 2028 436f 7272 6563 7465  .name} (Correcte
-00036830: 6429 2229 0a20 2020 2020 2020 2073 656c  d)").        sel
-00036840: 662e 6d61 6e69 7075 6c61 746f 725f 7379  f.manipulator_sy
-00036850: 7374 656d 2e70 6f73 6974 696f 6e2e 7820  stem.position.x 
-00036860: 2b3d 2064 780a 2020 2020 2020 2020 7365  += dx.        se
-00036870: 6c66 2e6d 616e 6970 756c 6174 6f72 5f73  lf.manipulator_s
-00036880: 7973 7465 6d2e 706f 7369 7469 6f6e 2e79  ystem.position.y
-00036890: 202b 3d20 6479 0a20 2020 2020 2020 206c   += dy.        l
-000368a0: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
-000368b0: 7367 223a 2022 6d6f 7665 5f6d 616e 6970  sg": "move_manip
-000368c0: 756c 6174 6f72 5f63 6f72 7265 6374 6564  ulator_corrected
-000368d0: 222c 2022 6478 223a 2064 782c 2022 6479  ", "dx": dx, "dy
-000368e0: 223a 2064 792c 2022 6265 616d 5f74 7970  ": dy, "beam_typ
-000368f0: 6522 3a20 6265 616d 5f74 7970 652e 6e61  e": beam_type.na
-00036900: 6d65 7d29 0a20 2020 2020 2020 2072 6574  me}).        ret
-00036910: 7572 6e20 7365 6c66 2e67 6574 5f6d 616e  urn self.get_man
-00036920: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
-00036930: 6e28 290a 0a20 2020 2064 6566 206d 6f76  n()..    def mov
-00036940: 655f 6d61 6e69 7075 6c61 746f 725f 746f  e_manipulator_to
-00036950: 5f70 6f73 6974 696f 6e5f 6f66 6673 6574  _position_offset
-00036960: 2873 656c 662c 206f 6666 7365 743a 2046  (self, offset: F
-00036970: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-00036980: 506f 7369 7469 6f6e 2c20 6e61 6d65 3a20  Position, name: 
-00036990: 7374 7220 3d20 4e6f 6e65 2920 2d3e 2046  str = None) -> F
-000369a0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-000369b0: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
-000369c0: 2020 5f63 6865 636b 5f6d 616e 6970 756c    _check_manipul
-000369d0: 6174 6f72 2873 656c 662e 7379 7374 656d  ator(self.system
-000369e0: 290a 2020 2020 2020 2020 6966 206e 616d  ).        if nam
-000369f0: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
-00036a00: 2020 2020 2020 206e 616d 6520 3d20 2245         name = "E
-00036a10: 5543 454e 5452 4943 220a 0a20 2020 2020  UCENTRIC"..     
-00036a20: 2020 2070 6f73 6974 696f 6e20 3d20 7365     position = se
-00036a30: 6c66 2e5f 6765 745f 7361 7665 645f 6d61  lf._get_saved_ma
-00036a40: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
-00036a50: 6f6e 286e 616d 6529 0a20 2020 2020 2020  on(name).       
-00036a60: 200a 2020 2020 2020 2020 6c6f 6767 696e   .        loggin
-00036a70: 672e 696e 666f 2866 224d 6f76 696e 6720  g.info(f"Moving 
-00036a80: 6d61 6e69 7075 6c61 746f 723a 207b 6f66  manipulator: {of
-00036a90: 6673 6574 7d20 746f 207b 6e61 6d65 7d22  fset} to {name}"
-00036aa0: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
-00036ab0: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
-00036ac0: 6162 736f 6c75 7465 2870 6f73 6974 696f  absolute(positio
-00036ad0: 6e20 2b20 6f66 6673 6574 290a 2020 2020  n + offset).    
-00036ae0: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
-00036af0: 6728 7b22 6d73 6722 3a20 226d 6f76 655f  g({"msg": "move_
-00036b00: 6d61 6e69 7075 6c61 746f 725f 746f 5f70  manipulator_to_p
-00036b10: 6f73 6974 696f 6e5f 6f66 6673 6574 222c  osition_offset",
-00036b20: 2022 6f66 6673 6574 223a 206f 6666 7365   "offset": offse
-00036b30: 742e 746f 5f64 6963 7428 292c 2022 6e61  t.to_dict(), "na
-00036b40: 6d65 223a 206e 616d 657d 290a 2020 2020  me": name}).    
-00036b50: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00036b60: 6765 745f 6d61 6e69 7075 6c61 746f 725f  get_manipulator_
-00036b70: 706f 7369 7469 6f6e 2829 0a0a 2020 2020  position()..    
-00036b80: 6465 6620 5f67 6574 5f73 6176 6564 5f6d  def _get_saved_m
-00036b90: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
-00036ba0: 696f 6e28 7365 6c66 2c20 6e61 6d65 3a20  ion(self, name: 
-00036bb0: 7374 7220 3d20 2250 4152 4b22 2920 2d3e  str = "PARK") ->
-00036bc0: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
-00036bd0: 6f72 506f 7369 7469 6f6e 3a0a 2020 2020  orPosition:.    
-00036be0: 2020 2020 5f63 6865 636b 5f6d 616e 6970      _check_manip
-00036bf0: 756c 6174 6f72 2873 656c 662e 7379 7374  ulator(self.syst
-00036c00: 656d 290a 0a20 2020 2020 2020 2069 6620  em)..        if 
-00036c10: 6e61 6d65 206e 6f74 2069 6e20 5b22 5041  name not in ["PA
-00036c20: 524b 222c 2022 4555 4345 4e54 5249 4322  RK", "EUCENTRIC"
-00036c30: 5d3a 0a20 2020 2020 2020 2020 2020 2072  ]:.            r
-00036c40: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00036c50: 6622 556e 6b6e 6f77 6e20 6d61 6e69 7075  f"Unknown manipu
-00036c60: 6c61 746f 7220 706f 7369 7469 6f6e 3a20  lator position: 
-00036c70: 7b6e 616d 657d 2229 0a20 2020 2020 2020  {name}").       
-00036c80: 2069 6620 6e61 6d65 203d 3d20 2250 4152   if name == "PAR
-00036c90: 4b22 3a0a 2020 2020 2020 2020 2020 2020  K":.            
-00036ca0: 7265 7475 726e 2046 6962 7365 6d4d 616e  return FibsemMan
-00036cb0: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
-00036cc0: 2878 3d30 2c20 793d 302c 207a 3d31 3830  (x=0, y=0, z=180
-00036cd0: 652d 362c 2072 3d30 2c20 743d 3029 0a20  e-6, r=0, t=0). 
-00036ce0: 2020 2020 2020 2069 6620 6e61 6d65 203d         if name =
-00036cf0: 3d20 2245 5543 454e 5452 4943 223a 0a20  = "EUCENTRIC":. 
-00036d00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00036d10: 6e20 4669 6273 656d 4d61 6e69 7075 6c61  n FibsemManipula
-00036d20: 746f 7250 6f73 6974 696f 6e28 783d 302c  torPosition(x=0,
-00036d30: 2079 3d30 2c20 7a3d 302c 2072 3d30 2c20   y=0, z=0, r=0, 
-00036d40: 743d 3029 0a0a 2020 2020 6465 6620 7365  t=0)..    def se
-00036d50: 7475 705f 6d69 6c6c 696e 6728 7365 6c66  tup_milling(self
-00036d60: 2c20 6d69 6c6c 5f73 6574 7469 6e67 733a  , mill_settings:
-00036d70: 2046 6962 7365 6d4d 696c 6c69 6e67 5365   FibsemMillingSe
-00036d80: 7474 696e 6773 293a 0a20 2020 2020 2020  ttings):.       
-00036d90: 2022 2222 5365 7475 7020 7468 6520 6d69   """Setup the mi
-00036da0: 6c6c 696e 6720 7061 7261 6d65 7465 7273  lling parameters
-00036db0: 2e22 2222 0a20 2020 2020 2020 205f 6368  .""".        _ch
-00036dc0: 6563 6b5f 6265 616d 2842 6561 6d54 7970  eck_beam(BeamTyp
-00036dd0: 652e 494f 4e2c 2073 656c 662e 7379 7374  e.ION, self.syst
-00036de0: 656d 290a 2020 2020 2020 2020 7365 6c66  em).        self
-00036df0: 2e73 6574 2822 6375 7272 656e 7422 2c20  .set("current", 
-00036e00: 6d69 6c6c 5f73 6574 7469 6e67 732e 6d69  mill_settings.mi
-00036e10: 6c6c 696e 675f 6375 7272 656e 742c 2042  lling_current, B
-00036e20: 6561 6d54 7970 652e 494f 4e29 0a20 2020  eamType.ION).   
-00036e30: 2020 2020 2073 656c 662e 7365 7428 2276       self.set("v
-00036e40: 6f6c 7461 6765 222c 206d 696c 6c5f 7365  oltage", mill_se
-00036e50: 7474 696e 6773 2e6d 696c 6c69 6e67 5f76  ttings.milling_v
-00036e60: 6f6c 7461 6765 2c20 4265 616d 5479 7065  oltage, BeamType
-00036e70: 2e49 4f4e 290a 2020 2020 0a20 2020 2020  .ION).    .     
-00036e80: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
-00036e90: 287b 226d 7367 223a 2022 7365 7475 705f  ({"msg": "setup_
-00036ea0: 6d69 6c6c 696e 6722 2c20 226d 696c 6c5f  milling", "mill_
-00036eb0: 7365 7474 696e 6773 223a 206d 696c 6c5f  settings": mill_
-00036ec0: 7365 7474 696e 6773 2e74 6f5f 6469 6374  settings.to_dict
-00036ed0: 2829 7d29 0a0a 2020 2020 6465 6620 7275  ()})..    def ru
-00036ee0: 6e5f 6d69 6c6c 696e 6728 7365 6c66 2c20  n_milling(self, 
-00036ef0: 6d69 6c6c 696e 675f 6375 7272 656e 743a  milling_current:
-00036f00: 2066 6c6f 6174 2c20 6d69 6c6c 696e 675f   float, milling_
-00036f10: 766f 6c74 6167 653a 2066 6c6f 6174 2c20  voltage: float, 
-00036f20: 6173 796e 6368 3a20 626f 6f6c 203d 2046  asynch: bool = F
-00036f30: 616c 7365 2920 2d3e 204e 6f6e 653a 0a20  alse) -> None:. 
-00036f40: 2020 2020 2020 2022 2222 5275 6e20 6d69         """Run mi
-00036f50: 6c6c 696e 6720 7769 7468 2074 6865 2073  lling with the s
-00036f60: 7065 6369 6669 6564 2063 7572 7265 6e74  pecified current
-00036f70: 2061 6e64 2076 6f6c 7461 6765 2e22 2222   and voltage."""
-00036f80: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
-00036f90: 6265 616d 2842 6561 6d54 7970 652e 494f  beam(BeamType.IO
-00036fa0: 4e2c 2073 656c 662e 7379 7374 656d 290a  N, self.system).
-00036fb0: 2020 2020 2020 2020 2320 696d 706f 7274          # import
-00036fc0: 2072 616e 646f 6d0a 2020 2020 2020 2020   random.        
-00036fd0: 2320 7469 6d65 2e73 6c65 6570 2872 616e  # time.sleep(ran
-00036fe0: 646f 6d2e 7261 6e64 696e 7428 312c 2035  dom.randint(1, 5
-00036ff0: 2929 0a20 2020 2020 2020 2074 696d 652e  )).        time.
-00037000: 736c 6565 7028 3529 0a20 2020 2020 2020  sleep(5).       
-00037010: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-00037020: 226d 7367 223a 2022 7275 6e5f 6d69 6c6c  "msg": "run_mill
-00037030: 696e 6722 2c20 226d 696c 6c69 6e67 5f63  ing", "milling_c
-00037040: 7572 7265 6e74 223a 206d 696c 6c69 6e67  urrent": milling
-00037050: 5f63 7572 7265 6e74 2c20 226d 696c 6c69  _current, "milli
-00037060: 6e67 5f76 6f6c 7461 6765 223a 206d 696c  ng_voltage": mil
-00037070: 6c69 6e67 5f76 6f6c 7461 6765 2c20 2261  ling_voltage, "a
-00037080: 7379 6e63 6822 3a20 6173 796e 6368 7d29  synch": asynch})
-00037090: 0a0a 2020 2020 6465 6620 6669 6e69 7368  ..    def finish
-000370a0: 5f6d 696c 6c69 6e67 2873 656c 662c 2069  _milling(self, i
-000370b0: 6d61 6769 6e67 5f63 7572 7265 6e74 3a20  maging_current: 
-000370c0: 666c 6f61 742c 2069 6d61 6769 6e67 5f76  float, imaging_v
-000370d0: 6f6c 7461 6765 3a20 666c 6f61 7429 202d  oltage: float) -
-000370e0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000370f0: 2222 2246 696e 6973 6820 6d69 6c6c 696e  """Finish millin
-00037100: 6720 6279 2072 6573 746f 7269 6e67 2074  g by restoring t
-00037110: 6865 2069 6d61 6769 6e67 2063 7572 7265  he imaging curre
-00037120: 6e74 2061 6e64 2076 6f6c 7461 6765 2e22  nt and voltage."
-00037130: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
-00037140: 6b5f 6265 616d 2842 6561 6d54 7970 652e  k_beam(BeamType.
-00037150: 494f 4e2c 2073 656c 662e 7379 7374 656d  ION, self.system
-00037160: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
-00037170: 672e 696e 666f 2866 2246 696e 6973 6869  g.info(f"Finishi
-00037180: 6e67 206d 696c 6c69 6e67 3a20 7b69 6d61  ng milling: {ima
-00037190: 6769 6e67 5f63 7572 7265 6e74 3a2e 3265  ging_current:.2e
-000371a0: 7d22 290a 2020 2020 2020 2020 7365 6c66  }").        self
-000371b0: 2e73 6574 2822 6375 7272 656e 7422 2c20  .set("current", 
-000371c0: 696d 6167 696e 675f 6375 7272 656e 742c  imaging_current,
-000371d0: 2042 6561 6d54 7970 652e 494f 4e29 0a20   BeamType.ION). 
-000371e0: 2020 2020 2020 2073 656c 662e 7365 7428         self.set(
-000371f0: 2276 6f6c 7461 6765 222c 2069 6d61 6769  "voltage", imagi
-00037200: 6e67 5f76 6f6c 7461 6765 2c20 4265 616d  ng_voltage, Beam
-00037210: 5479 7065 2e49 4f4e 290a 0a0a 2020 2020  Type.ION)...    
-00037220: 6465 6620 6573 7469 6d61 7465 5f6d 696c  def estimate_mil
-00037230: 6c69 6e67 5f74 696d 6528 7365 6c66 2c20  ling_time(self, 
-00037240: 7061 7474 6572 6e73 3a20 6c69 7374 2920  patterns: list) 
-00037250: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-00037260: 2020 2222 2245 7374 696d 6174 6520 7468    """Estimate th
-00037270: 6520 6d69 6c6c 696e 6720 7469 6d65 2066  e milling time f
-00037280: 6f72 2074 6865 2073 7065 6369 6669 6564  or the specified
-00037290: 2070 6174 7465 726e 732e 2222 220a 2020   patterns.""".  
-000372a0: 2020 2020 2020 746f 7461 6c5f 7469 6d65        total_time
-000372b0: 203d 2030 0a20 2020 2020 2020 2066 6f72   = 0.        for
-000372c0: 2070 6174 7465 726e 2069 6e20 7061 7474   pattern in patt
-000372d0: 6572 6e73 3a0a 2020 2020 2020 2020 2020  erns:.          
-000372e0: 2020 746f 7461 6c5f 7469 6d65 202b 3d20    total_time += 
-000372f0: 350a 2020 2020 2020 2020 0a20 2020 2020  5.        .     
-00037300: 2020 2072 6574 7572 6e20 746f 7461 6c5f     return total_
-00037310: 7469 6d65 0a20 2020 2020 2020 200a 0a20  time.        .. 
-00037320: 2020 2064 6566 2064 7261 775f 7265 6374     def draw_rect
-00037330: 616e 676c 6528 7365 6c66 2c20 7061 7474  angle(self, patt
-00037340: 6572 6e5f 7365 7474 696e 6773 3a20 4669  ern_settings: Fi
-00037350: 6273 656d 5265 6374 616e 676c 6553 6574  bsemRectangleSet
-00037360: 7469 6e67 7329 202d 3e20 4e6f 6e65 3a0a  tings) -> None:.
-00037370: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00037380: 6465 6275 6728 7b22 6d73 6722 3a20 2264  debug({"msg": "d
-00037390: 7261 775f 7265 6374 616e 676c 6522 2c20  raw_rectangle", 
-000373a0: 2270 6174 7465 726e 5f73 6574 7469 6e67  "pattern_setting
-000373b0: 7322 3a20 7061 7474 6572 6e5f 7365 7474  s": pattern_sett
-000373c0: 696e 6773 2e74 6f5f 6469 6374 2829 7d29  ings.to_dict()})
-000373d0: 0a0a 2020 2020 6465 6620 6472 6177 5f6c  ..    def draw_l
-000373e0: 696e 6528 7365 6c66 2c20 7061 7474 6572  ine(self, patter
-000373f0: 6e5f 7365 7474 696e 6773 3a20 4669 6273  n_settings: Fibs
-00037400: 656d 4c69 6e65 5365 7474 696e 6773 2920  emLineSettings) 
-00037410: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00037420: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
-00037430: 226d 7367 223a 2022 6472 6177 5f6c 696e  "msg": "draw_lin
-00037440: 6522 2c20 2270 6174 7465 726e 5f73 6574  e", "pattern_set
-00037450: 7469 6e67 7322 3a20 7061 7474 6572 6e5f  tings": pattern_
-00037460: 7365 7474 696e 6773 2e74 6f5f 6469 6374  settings.to_dict
-00037470: 2829 7d29 0a0a 2020 2020 6465 6620 6472  ()})..    def dr
-00037480: 6177 5f63 6972 636c 6528 7365 6c66 2c20  aw_circle(self, 
-00037490: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
-000374a0: 3a20 4669 6273 656d 4369 7263 6c65 5365  : FibsemCircleSe
-000374b0: 7474 696e 6773 2920 2d3e 204e 6f6e 653a  ttings) -> None:
-000374c0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
-000374d0: 2e64 6562 7567 287b 226d 7367 223a 2022  .debug({"msg": "
-000374e0: 6472 6177 5f63 6972 636c 6522 2c20 2270  draw_circle", "p
-000374f0: 6174 7465 726e 5f73 6574 7469 6e67 7322  attern_settings"
-00037500: 3a20 7061 7474 6572 6e5f 7365 7474 696e  : pattern_settin
-00037510: 6773 2e74 6f5f 6469 6374 2829 7d29 0a20  gs.to_dict()}). 
-00037520: 2020 200a 2020 2020 6465 6620 6472 6177     .    def draw
-00037530: 5f61 6e6e 756c 7573 2873 656c 662c 2070  _annulus(self, p
-00037540: 6174 7465 726e 5f73 6574 7469 6e67 733a  attern_settings:
-00037550: 2046 6962 7365 6d43 6972 636c 6553 6574   FibsemCircleSet
-00037560: 7469 6e67 7329 202d 3e20 4e6f 6e65 3a0a  tings) -> None:.
-00037570: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00037580: 6465 6275 6728 7b22 6d73 6722 3a20 2264  debug({"msg": "d
-00037590: 7261 775f 616e 6e75 6c75 7322 2c20 2270  raw_annulus", "p
-000375a0: 6174 7465 726e 5f73 6574 7469 6e67 7322  attern_settings"
-000375b0: 3a20 7061 7474 6572 6e5f 7365 7474 696e  : pattern_settin
-000375c0: 6773 2e74 6f5f 6469 6374 2829 7d29 0a0a  gs.to_dict()})..
-000375d0: 0a20 2020 2064 6566 2064 7261 775f 6269  .    def draw_bi
-000375e0: 746d 6170 5f70 6174 7465 726e 2873 656c  tmap_pattern(sel
-000375f0: 662c 2070 6174 7465 726e 5f73 6574 7469  f, pattern_setti
-00037600: 6e67 733a 2046 6962 7365 6d42 6974 6d61  ngs: FibsemBitma
-00037610: 7053 6574 7469 6e67 732c 0a20 2020 2020  pSettings,.     
-00037620: 2020 2070 6174 683a 2073 7472 293a 0a20     path: str):. 
-00037630: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
-00037640: 6562 7567 287b 226d 7367 223a 2022 6472  ebug({"msg": "dr
-00037650: 6177 5f62 6974 6d61 705f 7061 7474 6572  aw_bitmap_patter
-00037660: 6e22 2c20 2270 6174 7465 726e 5f73 6574  n", "pattern_set
-00037670: 7469 6e67 7322 3a20 7061 7474 6572 6e5f  tings": pattern_
-00037680: 7365 7474 696e 6773 2e74 6f5f 6469 6374  settings.to_dict
-00037690: 2829 2c20 2270 6174 6822 3a20 7061 7468  (), "path": path
-000376a0: 7d29 0a20 2020 2020 2020 2072 6574 7572  }).        retur
-000376b0: 6e20 0a20 2020 2064 6566 2072 756e 5f6d  n .    def run_m
-000376c0: 696c 6c69 6e67 5f64 7269 6674 5f63 6f72  illing_drift_cor
-000376d0: 7265 6374 6564 2873 656c 6629 3a0a 2020  rected(self):.  
-000376e0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-000376f0: 6d28 4265 616d 5479 7065 2e49 4f4e 2c20  m(BeamType.ION, 
-00037700: 7365 6c66 2e73 7973 7465 6d29 0a20 2020  self.system).   
-00037710: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00037720: 2064 6566 2073 6574 7570 5f73 7075 7474   def setup_sputt
-00037730: 6572 2873 656c 662c 2070 726f 746f 636f  er(self, protoco
-00037740: 6c3a 2064 6963 7429 202d 3e20 4e6f 6e65  l: dict) -> None
-00037750: 3a0a 2020 2020 2020 2020 5f63 6865 636b  :.        _check
-00037760: 5f73 7075 7474 6572 2873 656c 662e 7379  _sputter(self.sy
-00037770: 7374 656d 290a 2020 2020 2020 2020 6c6f  stem).        lo
-00037780: 6767 696e 672e 696e 666f 2866 2253 6574  gging.info(f"Set
-00037790: 7469 6e67 2075 7020 7370 7574 7465 723a  ting up sputter:
-000377a0: 207b 7072 6f74 6f63 6f6c 7d22 290a 0a20   {protocol}").. 
-000377b0: 2020 2064 6566 2064 7261 775f 7370 7574     def draw_sput
-000377c0: 7465 725f 7061 7474 6572 6e28 7365 6c66  ter_pattern(self
-000377d0: 2c20 6866 773a 2066 6c6f 6174 2c20 6c69  , hfw: float, li
-000377e0: 6e65 5f70 6174 7465 726e 5f6c 656e 6774  ne_pattern_lengt
-000377f0: 683a 2066 6c6f 6174 2c20 7370 7574 7465  h: float, sputte
-00037800: 725f 7469 6d65 3a20 666c 6f61 7429 3a0a  r_time: float):.
-00037810: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00037820: 6465 6275 6728 7b22 6d73 6722 3a20 2264  debug({"msg": "d
-00037830: 7261 775f 7370 7574 7465 725f 7061 7474  raw_sputter_patt
-00037840: 6572 6e22 2c20 2268 6677 223a 2068 6677  ern", "hfw": hfw
-00037850: 2c20 226c 696e 655f 7061 7474 6572 6e5f  , "line_pattern_
-00037860: 6c65 6e67 7468 223a 206c 696e 655f 7061  length": line_pa
-00037870: 7474 6572 6e5f 6c65 6e67 7468 2c20 2273  ttern_length, "s
-00037880: 7075 7474 6572 5f74 696d 6522 3a20 7370  putter_time": sp
-00037890: 7574 7465 725f 7469 6d65 7d29 0a0a 2020  utter_time})..  
-000378a0: 2020 6465 6620 7275 6e5f 7370 7574 7465    def run_sputte
-000378b0: 7228 7365 6c66 2c20 2a2a 6b77 6172 6773  r(self, **kwargs
-000378c0: 293a 0a20 2020 2020 2020 205f 6368 6563  ):.        _chec
-000378d0: 6b5f 7370 7574 7465 7228 7365 6c66 2e73  k_sputter(self.s
-000378e0: 7973 7465 6d29 0a20 2020 2020 2020 206c  ystem).        l
-000378f0: 6f67 6769 6e67 2e69 6e66 6f28 6622 5275  ogging.info(f"Ru
-00037900: 6e6e 696e 6720 7370 7574 7465 723a 207b  nning sputter: {
-00037910: 6b77 6172 6773 7d22 290a 0a20 2020 2064  kwargs}")..    d
-00037920: 6566 2066 696e 6973 685f 7370 7574 7465  ef finish_sputte
-00037930: 7228 7365 6c66 2c20 2a2a 6b77 6172 6773  r(self, **kwargs
-00037940: 293a 0a20 2020 2020 2020 205f 6368 6563  ):.        _chec
-00037950: 6b5f 7370 7574 7465 7228 7365 6c66 2e73  k_sputter(self.s
-00037960: 7973 7465 6d29 0a20 2020 2020 2020 206c  ystem).        l
-00037970: 6f67 6769 6e67 2e69 6e66 6f28 6622 4669  ogging.info(f"Fi
-00037980: 6e69 7368 696e 6720 7370 7574 7465 723a  nishing sputter:
-00037990: 207b 6b77 6172 6773 7d22 290a 0a20 2020   {kwargs}")..   
-000379a0: 2064 6566 2067 6574 5f61 7661 696c 6162   def get_availab
-000379b0: 6c65 5f76 616c 7565 7328 7365 6c66 2c20  le_values(self, 
-000379c0: 6b65 793a 2073 7472 2c20 6265 616d 5f74  key: str, beam_t
-000379d0: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
-000379e0: 4e6f 6e65 2920 2d3e 206c 6973 745b 666c  None) -> list[fl
-000379f0: 6f61 745d 3a0a 2020 2020 2020 2020 0a20  oat]:.        . 
-00037a00: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
-00037a10: 5b5d 0a20 2020 2020 2020 2069 6620 6b65  [].        if ke
-00037a20: 7920 3d3d 2022 6375 7272 656e 7422 3a0a  y == "current":.
-00037a30: 2020 2020 2020 2020 2020 2020 5f63 6865              _che
-00037a40: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
-00037a50: 652c 2073 656c 662e 7379 7374 656d 290a  e, self.system).
-00037a60: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-00037a70: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
-00037a80: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
-00037a90: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00037aa0: 616c 7565 7320 3d20 5b31 2e30 652d 3132  alues = [1.0e-12
-00037ab0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
-00037ac0: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
-00037ad0: 616d 5479 7065 2e49 4f4e 3a0a 2020 2020  amType.ION:.    
-00037ae0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-00037af0: 6573 203d 205b 3230 652d 3132 2c20 3630  es = [20e-12, 60
-00037b00: 652d 3132 2c20 302e 3265 2d39 2c20 302e  e-12, 0.2e-9, 0.
-00037b10: 3734 652d 392c 2032 2e30 652d 392c 2037  74e-9, 2.0e-9, 7
-00037b20: 2e36 652d 392c 2032 382e 3065 2d39 2c20  .6e-9, 28.0e-9, 
-00037b30: 3132 3065 2d39 5d0a 2020 2020 2020 2020  120e-9].        
-00037b40: 0a0a 2020 2020 2020 2020 6966 206b 6579  ..        if key
-00037b50: 203d 3d20 2261 7070 6c69 6361 7469 6f6e   == "application
-00037b60: 5f66 696c 6522 3a0a 2020 2020 2020 2020  _file":.        
-00037b70: 2020 2020 7661 6c75 6573 203d 205b 2253      values = ["S
-00037b80: 6922 2c20 2261 7574 6f6c 616d 656c 6c61  i", "autolamella
-00037b90: 222c 2022 6372 796f 5f50 745f 6465 7022  ", "cryo_Pt_dep"
-00037ba0: 5d0a 0a20 2020 2020 2020 2069 6620 6b65  ]..        if ke
-00037bb0: 7920 3d3d 2022 6465 7465 6374 6f72 5f74  y == "detector_t
-00037bc0: 7970 6522 3a0a 2020 2020 2020 2020 2020  ype":.          
-00037bd0: 2020 7661 6c75 6573 203d 205b 2245 5444    values = ["ETD
-00037be0: 222c 2022 544c 4422 2c20 2245 4453 225d  ", "TLD", "EDS"]
-00037bf0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-00037c00: 3d3d 2022 6465 7465 6374 6f72 5f6d 6f64  == "detector_mod
-00037c10: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-00037c20: 7661 6c75 6573 203d 205b 2253 6563 6f6e  values = ["Secon
-00037c30: 6461 7279 456c 6563 7472 6f6e 7322 2c20  daryElectrons", 
-00037c40: 2242 6163 6b73 6361 7474 6572 6564 456c  "BackscatteredEl
-00037c50: 6563 7472 6f6e 7322 2c20 2245 4453 225d  ectrons", "EDS"]
-00037c60: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00037c70: 2020 6966 206b 6579 203d 3d20 2273 6361    if key == "sca
-00037c80: 6e5f 6469 7265 6374 696f 6e22 3a0a 2020  n_direction":.  
-00037c90: 2020 2020 2020 2020 2020 7661 6c75 6573            values
-00037ca0: 203d 205b 2242 6f74 746f 6d54 6f54 6f70   = ["BottomToTop
-00037cb0: 222c 200a 2020 2020 2020 2020 2020 2020  ", .            
-00037cc0: 2020 2020 224c 6566 7454 6f52 6967 6874      "LeftToRight
-00037cd0: 222c 2009 0a20 2020 2020 2020 2020 2020  ", ..           
-00037ce0: 2020 2020 2022 5269 6768 7454 6f4c 6566       "RightToLef
-00037cf0: 7422 2c20 090a 2020 2020 2020 2020 2020  t", ..          
-00037d00: 2020 2020 2020 2254 6f70 546f 426f 7474        "TopToBott
-00037d10: 6f6d 225d 0a20 2020 2020 2020 2020 2020  om"].           
-00037d20: 200a 2020 2020 2020 2020 6966 206b 6579   .        if key
-00037d30: 203d 3d20 2270 6c61 736d 615f 6761 7322   == "plasma_gas"
-00037d40: 3a0a 2020 2020 2020 2020 2020 2020 7661  :.            va
-00037d50: 6c75 6573 203d 205b 224f 7879 6765 6e22  lues = ["Oxygen"
-00037d60: 2c20 2241 7267 6f6e 222c 2022 4e69 7472  , "Argon", "Nitr
-00037d70: 6f67 656e 222c 2022 5865 6e6f 6e22 5d0a  ogen", "Xenon"].
-00037d80: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00037d90: 2020 7265 7475 726e 2076 616c 7565 730a    return values.
-00037da0: 0a20 2020 2064 6566 205f 6765 7428 7365  .    def _get(se
-00037db0: 6c66 2c20 6b65 792c 2062 6561 6d5f 7479  lf, key, beam_ty
-00037dc0: 7065 3a20 4265 616d 5479 7065 203d 204e  pe: BeamType = N
-00037dd0: 6f6e 6529 202d 3e20 556e 696f 6e5b 666c  one) -> Union[fl
-00037de0: 6f61 742c 2069 6e74 2c20 626f 6f6c 2c20  oat, int, bool, 
-00037df0: 7374 722c 206c 6973 745d 3a0a 2020 2020  str, list]:.    
-00037e00: 2020 2020 2222 2247 6574 2061 2076 616c      """Get a val
-00037e10: 7565 2066 726f 6d20 7468 6520 6d69 6372  ue from the micr
-00037e20: 6f73 636f 7065 2e22 2222 0a20 2020 2020  oscope.""".     
-00037e30: 2020 2023 2067 6574 2062 6561 6d0a 2020     # get beam.  
-00037e40: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-00037e50: 7065 2069 7320 6e6f 7420 4e6f 6e65 3a0a  pe is not None:.
-00037e60: 2020 2020 2020 2020 2020 2020 6265 616d              beam
-00037e70: 5f73 7973 7465 6d20 3d20 7365 6c66 2e65  _system = self.e
-00037e80: 6c65 6374 726f 6e5f 7379 7374 656d 2069  lectron_system i
-00037e90: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-00037ea0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
-00037eb0: 2065 6c73 6520 7365 6c66 2e69 6f6e 5f73   else self.ion_s
-00037ec0: 7973 7465 6d0a 2020 2020 2020 2020 2020  ystem.          
-00037ed0: 2020 6265 616d 2c20 6465 7465 6374 6f72    beam, detector
-00037ee0: 203d 2062 6561 6d5f 7379 7374 656d 2e62   = beam_system.b
-00037ef0: 6561 6d2c 2062 6561 6d5f 7379 7374 656d  eam, beam_system
-00037f00: 2e64 6574 6563 746f 720a 2020 2020 2020  .detector.      
-00037f10: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
-00037f20: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
-00037f30: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
-00037f40: 2020 0a20 2020 2020 2020 2023 2054 4f44    .        # TOD
-00037f50: 4f3a 2063 6861 6e67 6520 7468 6973 2073  O: change this s
-00037f60: 6f20 7661 6c75 6520 6973 2072 6574 7572  o value is retur
-00037f70: 6e65 642c 2073 6f20 7765 2063 616e 206c  ned, so we can l
-00037f80: 6f67 2074 6865 2072 6574 7572 6e20 7661  og the return va
-00037f90: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
-00037fa0: 0a20 2020 2020 2020 2023 2062 6561 6d20  .        # beam 
-00037fb0: 7072 6f70 6572 7469 6573 0a20 2020 2020  properties.     
-00037fc0: 2020 2069 6620 6b65 7920 3d3d 2022 6f6e     if key == "on
-00037fd0: 223a 200a 2020 2020 2020 2020 2020 2020  ": .            
-00037fe0: 7265 7475 726e 2062 6561 6d5f 7379 7374  return beam_syst
-00037ff0: 656d 2e6f 6e0a 2020 2020 2020 2020 6966  em.on.        if
-00038000: 206b 6579 203d 3d20 2262 6c61 6e6b 6564   key == "blanked
-00038010: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-00038020: 6574 7572 6e20 6265 616d 5f73 7973 7465  eturn beam_syste
-00038030: 6d2e 626c 616e 6b65 640a 2020 2020 2020  m.blanked.      
-00038040: 2020 6966 206b 6579 203d 3d20 2276 6f6c    if key == "vol
-00038050: 7461 6765 223a 0a20 2020 2020 2020 2020  tage":.         
-00038060: 2020 2072 6574 7572 6e20 6265 616d 2e76     return beam.v
-00038070: 6f6c 7461 6765 0a20 2020 2020 2020 2069  oltage.        i
-00038080: 6620 6b65 7920 3d3d 2022 6375 7272 656e  f key == "curren
-00038090: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
-000380a0: 7265 7475 726e 2062 6561 6d2e 6265 616d  return beam.beam
-000380b0: 5f63 7572 7265 6e74 0a20 2020 2020 2020  _current.       
-000380c0: 2069 6620 6b65 7920 3d3d 2022 776f 726b   if key == "work
-000380d0: 696e 675f 6469 7374 616e 6365 223a 0a20  ing_distance":. 
-000380e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000380f0: 6e20 6265 616d 2e77 6f72 6b69 6e67 5f64  n beam.working_d
-00038100: 6973 7461 6e63 650a 2020 2020 2020 2020  istance.        
-00038110: 6966 206b 6579 203d 3d20 2268 6677 223a  if key == "hfw":
-00038120: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00038130: 7572 6e20 6265 616d 2e68 6677 0a20 2020  urn beam.hfw.   
-00038140: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00038150: 7265 736f 6c75 7469 6f6e 223a 0a20 2020  resolution":.   
-00038160: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00038170: 6265 616d 2e72 6573 6f6c 7574 696f 6e0a  beam.resolution.
-00038180: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-00038190: 3d20 2264 7765 6c6c 5f74 696d 6522 3a0a  = "dwell_time":.
-000381a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000381b0: 726e 2062 6561 6d2e 6477 656c 6c5f 7469  rn beam.dwell_ti
-000381c0: 6d65 0a20 2020 2020 2020 2069 6620 6b65  me.        if ke
-000381d0: 7920 3d3d 2022 7374 6967 6d61 7469 6f6e  y == "stigmation
-000381e0: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-000381f0: 6574 7572 6e20 506f 696e 7428 6265 616d  eturn Point(beam
-00038200: 2e73 7469 676d 6174 696f 6e2e 782c 2062  .stigmation.x, b
-00038210: 6561 6d2e 7374 6967 6d61 7469 6f6e 2e79  eam.stigmation.y
-00038220: 290a 2020 2020 2020 2020 6966 206b 6579  ).        if key
-00038230: 203d 3d20 2273 6869 6674 223a 0a20 2020   == "shift":.   
-00038240: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00038250: 506f 696e 7428 6265 616d 2e73 6869 6674  Point(beam.shift
-00038260: 2e78 2c20 6265 616d 2e73 6869 6674 2e79  .x, beam.shift.y
-00038270: 290a 2020 2020 2020 2020 6966 206b 6579  ).        if key
-00038280: 203d 3d20 2273 6361 6e5f 726f 7461 7469   == "scan_rotati
-00038290: 6f6e 223a 0a20 2020 2020 2020 2020 2020  on":.           
-000382a0: 2072 6574 7572 6e20 6265 616d 2e73 6361   return beam.sca
-000382b0: 6e5f 726f 7461 7469 6f6e 0a20 2020 2020  n_rotation.     
-000382c0: 2020 200a 2020 2020 2020 2020 2320 7379     .        # sy
-000382d0: 7374 656d 2070 726f 7065 7274 6965 730a  stem properties.
-000382e0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-000382f0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00038300: 6265 616d 5f65 6e61 626c 6564 223a 0a20  beam_enabled":. 
-00038310: 2020 2020 2020 2020 2020 2069 6620 6265             if be
-00038320: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
-00038330: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
-00038340: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00038350: 7475 726e 2073 656c 662e 7379 7374 656d  turn self.system
-00038360: 2e65 6c65 6374 726f 6e2e 656e 6162 6c65  .electron.enable
-00038370: 640a 2020 2020 2020 2020 2020 2020 656c  d.            el
-00038380: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
-00038390: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
-000383a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000383b0: 7475 726e 2073 656c 662e 7379 7374 656d  turn self.system
-000383c0: 2e69 6f6e 2e65 6e61 626c 6564 0a20 2020  .ion.enabled.   
-000383d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000383e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000383f0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00038400: 6622 556e 6b6e 6f77 6e20 6265 616d 2074  f"Unknown beam t
-00038410: 7970 653a 207b 6265 616d 5f74 7970 657d  ype: {beam_type}
-00038420: 2066 6f72 207b 6b65 797d 2229 0a20 2020   for {key}").   
-00038430: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00038440: 2020 6966 206b 6579 203d 3d20 2265 7563    if key == "euc
-00038450: 656e 7472 6963 5f68 6569 6768 7422 3a0a  entric_height":.
-00038460: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-00038470: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
-00038480: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
-00038490: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000384a0: 6574 7572 6e20 7365 6c66 2e73 7973 7465  eturn self.syste
-000384b0: 6d2e 656c 6563 7472 6f6e 2e65 7563 656e  m.electron.eucen
-000384c0: 7472 6963 5f68 6569 6768 740a 2020 2020  tric_height.    
-000384d0: 2020 2020 2020 2020 656c 6966 2062 6561          elif bea
-000384e0: 6d5f 7479 7065 2069 7320 4265 616d 5479  m_type is BeamTy
-000384f0: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
-00038500: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00038510: 656c 662e 7379 7374 656d 2e69 6f6e 2e65  elf.system.ion.e
-00038520: 7563 656e 7472 6963 5f68 6569 6768 740a  ucentric_height.
-00038530: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00038540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00038550: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00038560: 6f72 2866 2255 6e6b 6e6f 776e 2062 6561  or(f"Unknown bea
-00038570: 6d20 7479 7065 3a20 7b62 6561 6d5f 7479  m type: {beam_ty
-00038580: 7065 7d20 666f 7220 7b6b 6579 7d22 290a  pe} for {key}").
-00038590: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-000385a0: 3d3d 2022 636f 6c75 6d6e 5f74 696c 7422  == "column_tilt"
-000385b0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000385c0: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
-000385d0: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
-000385e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000385f0: 2072 6574 7572 6e20 7365 6c66 2e73 7973   return self.sys
-00038600: 7465 6d2e 656c 6563 7472 6f6e 2e63 6f6c  tem.electron.col
-00038610: 756d 6e5f 7469 6c74 0a20 2020 2020 2020  umn_tilt.       
-00038620: 2020 2020 2065 6c69 6620 6265 616d 5f74       elif beam_t
-00038630: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-00038640: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
-00038650: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00038660: 2e73 7973 7465 6d2e 696f 6e2e 636f 6c75  .system.ion.colu
-00038670: 6d6e 5f74 696c 740a 2020 2020 2020 2020  mn_tilt.        
-00038680: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00038690: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000386a0: 5661 6c75 6545 7272 6f72 2866 2255 6e6b  ValueError(f"Unk
-000386b0: 6e6f 776e 2062 6561 6d20 7479 7065 3a20  nown beam type: 
-000386c0: 7b62 6561 6d5f 7479 7065 7d20 666f 7220  {beam_type} for 
-000386d0: 7b6b 6579 7d22 290a 0a20 2020 2020 2020  {key}")..       
-000386e0: 2023 2069 6f6e 2062 6561 6d20 7072 6f70   # ion beam prop
-000386f0: 6572 7469 6573 0a20 2020 2020 2020 2069  erties.        i
-00038700: 6620 6b65 7920 3d3d 2022 706c 6173 6d61  f key == "plasma
-00038710: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
-00038720: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-00038730: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
-00038740: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00038750: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
-00038760: 696f 6e2e 706c 6173 6d61 0a20 2020 2020  ion.plasma.     
-00038770: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00038780: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00038790: 7572 6e20 4661 6c73 650a 0a20 2020 2020  urn False..     
-000387a0: 2020 2069 6620 6b65 7920 3d3d 2022 706c     if key == "pl
-000387b0: 6173 6d61 5f67 6173 223a 0a20 2020 2020  asma_gas":.     
-000387c0: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
-000387d0: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
-000387e0: 494f 4e20 616e 6420 7365 6c66 2e73 7973  ION and self.sys
-000387f0: 7465 6d2e 696f 6e2e 706c 6173 6d61 3a0a  tem.ion.plasma:.
-00038800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038810: 7265 7475 726e 2073 656c 662e 7379 7374  return self.syst
-00038820: 656d 2e69 6f6e 2e70 6c61 736d 615f 6761  em.ion.plasma_ga
-00038830: 7320 2320 6d69 6768 7420 6e65 6564 2074  s # might need t
-00038840: 6f20 6368 6563 6b20 6966 2074 6869 7320  o check if this 
-00038850: 6973 2061 7661 696c 6162 6c65 3f0a 2020  is available?.  
-00038860: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00038870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038880: 7265 7475 726e 204e 6f6e 6520 2020 2020  return None     
-00038890: 0a20 2020 200a 2020 2020 2020 2020 2320  .    .        # 
-000388a0: 7374 6167 6520 0a20 2020 2020 2020 2069  stage .        i
-000388b0: 6620 6b65 7920 3d3d 2022 7374 6167 655f  f key == "stage_
-000388c0: 706f 7369 7469 6f6e 223a 0a20 2020 2020  position":.     
-000388d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000388e0: 6c66 2e73 7461 6765 5f73 7973 7465 6d2e  lf.stage_system.
-000388f0: 706f 7369 7469 6f6e 0a20 2020 2020 2020  position.       
-00038900: 2069 6620 6b65 7920 3d3d 2022 7374 6167   if key == "stag
-00038910: 655f 686f 6d65 6422 3a0a 2020 2020 2020  e_homed":.      
-00038920: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00038930: 662e 7374 6167 655f 7379 7374 656d 2e69  f.stage_system.i
-00038940: 735f 686f 6d65 640a 2020 2020 2020 2020  s_homed.        
-00038950: 6966 206b 6579 203d 3d20 2273 7461 6765  if key == "stage
-00038960: 5f6c 696e 6b65 6422 3a0a 2020 2020 2020  _linked":.      
-00038970: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00038980: 662e 7374 6167 655f 7379 7374 656d 2e69  f.stage_system.i
-00038990: 735f 6c69 6e6b 6564 0a20 2020 2020 2020  s_linked.       
-000389a0: 200a 2020 2020 2020 2020 2320 6465 7465   .        # dete
-000389b0: 6374 6f72 2070 726f 7065 7274 6965 730a  ctor properties.
-000389c0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-000389d0: 3d20 2264 6574 6563 746f 725f 7479 7065  = "detector_type
-000389e0: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-000389f0: 6574 7572 6e20 6465 7465 6374 6f72 2e74  eturn detector.t
-00038a00: 7970 650a 2020 2020 2020 2020 6966 206b  ype.        if k
-00038a10: 6579 203d 3d20 2264 6574 6563 746f 725f  ey == "detector_
-00038a20: 6d6f 6465 223a 0a20 2020 2020 2020 2020  mode":.         
-00038a30: 2020 2072 6574 7572 6e20 6465 7465 6374     return detect
-00038a40: 6f72 2e6d 6f64 650a 2020 2020 2020 2020  or.mode.        
-00038a50: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
-00038a60: 746f 725f 6272 6967 6874 6e65 7373 223a  tor_brightness":
-00038a70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00038a80: 7572 6e20 6465 7465 6374 6f72 2e62 7269  urn detector.bri
-00038a90: 6768 746e 6573 730a 2020 2020 2020 2020  ghtness.        
-00038aa0: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
-00038ab0: 746f 725f 636f 6e74 7261 7374 223a 0a20  tor_contrast":. 
-00038ac0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00038ad0: 6e20 6465 7465 6374 6f72 2e63 6f6e 7472  n detector.contr
-00038ae0: 6173 740a 0a20 2020 2020 2020 2023 206d  ast..        # m
-00038af0: 616e 6970 756c 6174 6f72 2070 726f 7065  anipulator prope
-00038b00: 7274 6965 730a 2020 2020 2020 2020 6966  rties.        if
-00038b10: 206b 6579 203d 3d20 226d 616e 6970 756c   key == "manipul
-00038b20: 6174 6f72 5f70 6f73 6974 696f 6e22 3a0a  ator_position":.
-00038b30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00038b40: 726e 2073 656c 662e 6d61 6e69 7075 6c61  rn self.manipula
-00038b50: 746f 725f 7379 7374 656d 2e70 6f73 6974  tor_system.posit
-00038b60: 696f 6e0a 2020 2020 2020 2020 6966 206b  ion.        if k
-00038b70: 6579 203d 3d20 226d 616e 6970 756c 6174  ey == "manipulat
-00038b80: 6f72 5f73 7461 7465 223a 2020 0a20 2020  or_state":  .   
-00038b90: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00038ba0: 7365 6c66 2e6d 616e 6970 756c 6174 6f72  self.manipulator
-00038bb0: 5f73 7973 7465 6d2e 696e 7365 7274 6564  _system.inserted
-00038bc0: 2020 2020 200a 2020 2020 2020 2020 0a20       .        . 
-00038bd0: 2020 2020 2020 2023 206d 616e 7566 6163         # manufac
-00038be0: 7475 7265 7220 7072 6f70 6572 7469 6573  turer properties
-00038bf0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
-00038c00: 3d3d 2022 6d61 6e75 6661 6374 7572 6572  == "manufacturer
-00038c10: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
-00038c20: 6574 7572 6e20 7365 6c66 2e73 7973 7465  eturn self.syste
-00038c30: 6d2e 696e 666f 2e6d 616e 7566 6163 7475  m.info.manufactu
-00038c40: 7265 720a 2020 2020 2020 2020 6966 206b  rer.        if k
-00038c50: 6579 203d 3d20 226d 6f64 656c 223a 0a20  ey == "model":. 
-00038c60: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00038c70: 6e20 7365 6c66 2e73 7973 7465 6d2e 696e  n self.system.in
-00038c80: 666f 2e6d 6f64 656c 0a20 2020 2020 2020  fo.model.       
-00038c90: 2069 6620 6b65 7920 3d3d 2022 736f 6674   if key == "soft
-00038ca0: 7761 7265 5f76 6572 7369 6f6e 223a 0a20  ware_version":. 
-00038cb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00038cc0: 6e20 7365 6c66 2e73 7973 7465 6d2e 696e  n self.system.in
-00038cd0: 666f 2e73 6f66 7477 6172 655f 7665 7273  fo.software_vers
-00038ce0: 696f 6e0a 2020 2020 2020 2020 6966 206b  ion.        if k
-00038cf0: 6579 203d 3d20 2273 6572 6961 6c5f 6e75  ey == "serial_nu
-00038d00: 6d62 6572 223a 0a20 2020 2020 2020 2020  mber":.         
-00038d10: 2020 2072 6574 7572 6e20 2255 6e6b 6e6f     return "Unkno
-00038d20: 776e 220a 2020 2020 2020 2020 6966 206b  wn".        if k
-00038d30: 6579 203d 3d20 2268 6172 6477 6172 655f  ey == "hardware_
-00038d40: 7665 7273 696f 6e22 3a0a 2020 2020 2020  version":.      
-00038d50: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00038d60: 662e 7379 7374 656d 2e69 6e66 6f2e 6861  f.system.info.ha
-00038d70: 7264 7761 7265 5f76 6572 7369 6f6e 0a0a  rdware_version..
-00038d80: 2020 2020 2020 2020 2320 6368 616d 6265          # chambe
-00038d90: 7220 7072 6f70 6572 7469 6573 0a20 2020  r properties.   
-00038da0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00038db0: 6368 616d 6265 725f 7374 6174 6522 3a0a  chamber_state":.
-00038dc0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00038dd0: 726e 2073 656c 662e 6368 616d 6265 722e  rn self.chamber.
-00038de0: 7374 6174 650a 2020 2020 2020 2020 6966  state.        if
-00038df0: 206b 6579 203d 3d20 2263 6861 6d62 6572   key == "chamber
-00038e00: 5f70 7265 7373 7572 6522 3a0a 2020 2020  _pressure":.    
-00038e10: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00038e20: 656c 662e 6368 616d 6265 722e 7072 6573  elf.chamber.pres
-00038e30: 7375 7265 0a20 2020 2020 2020 200a 2020  sure.        .  
-00038e40: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
-00038e50: 726e 696e 6728 6622 556e 6b6e 6f77 6e20  rning(f"Unknown 
-00038e60: 6b65 793a 207b 6b65 797d 2028 7b62 6561  key: {key} ({bea
-00038e70: 6d5f 7479 7065 7d29 2229 0a20 2020 2020  m_type})").     
-00038e80: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00038e90: 2020 2020 6465 6620 5f73 6574 2873 656c      def _set(sel
-00038ea0: 662c 206b 6579 3a20 7374 722c 2076 616c  f, key: str, val
-00038eb0: 7565 2c20 6265 616d 5f74 7970 653a 2042  ue, beam_type: B
-00038ec0: 6561 6d54 7970 6520 3d20 4e6f 6e65 2920  eamType = None) 
-00038ed0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00038ee0: 2022 2222 5365 7420 6120 7072 6f70 6572   """Set a proper
-00038ef0: 7479 206f 6620 7468 6520 6d69 6372 6f73  ty of the micros
-00038f00: 636f 7065 2e22 2222 0a20 2020 2020 2020  cope.""".       
-00038f10: 200a 2020 2020 2020 2020 2320 6765 7420   .        # get 
-00038f20: 6265 616d 0a20 2020 2020 2020 2069 6620  beam.        if 
-00038f30: 6265 616d 5f74 7970 6520 6973 206e 6f74  beam_type is not
-00038f40: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00038f50: 2020 2062 6561 6d5f 7379 7374 656d 203d     beam_system =
-00038f60: 2073 656c 662e 656c 6563 7472 6f6e 5f73   self.electron_s
-00038f70: 7973 7465 6d20 6966 2062 6561 6d5f 7479  ystem if beam_ty
-00038f80: 7065 2069 7320 4265 616d 5479 7065 2e45  pe is BeamType.E
-00038f90: 4c45 4354 524f 4e20 656c 7365 2073 656c  LECTRON else sel
-00038fa0: 662e 696f 6e5f 7379 7374 656d 2020 2020  f.ion_system    
-00038fb0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00038fc0: 2020 2020 2062 6561 6d20 3d20 6265 616d       beam = beam
-00038fd0: 5f73 7973 7465 6d2e 6265 616d 0a20 2020  _system.beam.   
-00038fe0: 2020 2020 2020 2020 2064 6574 6563 746f           detecto
-00038ff0: 7220 3d20 6265 616d 5f73 7973 7465 6d2e  r = beam_system.
-00039000: 6465 7465 6374 6f72 0a20 2020 2020 2020  detector.       
-00039010: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
-00039020: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
-00039030: 2e73 7973 7465 6d29 0a0a 0a20 2020 2020  .system)...     
-00039040: 2020 2023 2076 6f6c 7461 6765 0a20 2020     # voltage.   
-00039050: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-00039060: 766f 6c74 6167 6522 3a0a 2020 2020 2020  voltage":.      
-00039070: 2020 2020 2020 6265 616d 2e76 6f6c 7461        beam.volta
-00039080: 6765 203d 2076 616c 7565 0a20 2020 2020  ge = value.     
-00039090: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-000390a0: 2020 2020 2020 2320 6375 7272 656e 740a        # current.
-000390b0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
-000390c0: 3d20 2263 7572 7265 6e74 223a 0a20 2020  = "current":.   
-000390d0: 2020 2020 2020 2020 2062 6561 6d2e 6265           beam.be
-000390e0: 616d 5f63 7572 7265 6e74 203d 2076 616c  am_current = val
-000390f0: 7565 0a20 2020 2020 2020 2020 2020 2072  ue.            r
-00039100: 6574 7572 6e20 2020 2020 2020 200a 2020  eturn        .  
-00039110: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-00039120: 6620 6b65 7920 3d3d 2022 776f 726b 696e  f key == "workin
-00039130: 675f 6469 7374 616e 6365 223a 0a20 2020  g_distance":.   
-00039140: 2020 2020 2020 2020 2062 6561 6d2e 776f           beam.wo
-00039150: 726b 696e 675f 6469 7374 616e 6365 203d  rking_distance =
-00039160: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-00039170: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00039180: 2020 0a20 2020 2020 2020 2069 6620 6b65    .        if ke
-00039190: 7920 3d3d 2022 7374 6967 6d61 7469 6f6e  y == "stigmation
-000391a0: 223a 0a20 2020 2020 2020 2020 2020 2062  ":.            b
-000391b0: 6561 6d2e 7374 6967 6d61 7469 6f6e 203d  eam.stigmation =
-000391c0: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-000391d0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-000391e0: 2020 6966 206b 6579 203d 3d20 2273 6869    if key == "shi
-000391f0: 6674 223a 0a20 2020 2020 2020 2020 2020  ft":.           
-00039200: 2062 6561 6d2e 7368 6966 7420 3d20 7661   beam.shift = va
-00039210: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
-00039220: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
-00039230: 6620 6b65 7920 3d3d 2022 7363 616e 5f72  f key == "scan_r
-00039240: 6f74 6174 696f 6e22 3a0a 2020 2020 2020  otation":.      
-00039250: 2020 2020 2020 6265 616d 2e73 6361 6e5f        beam.scan_
-00039260: 726f 7461 7469 6f6e 203d 2076 616c 7565  rotation = value
-00039270: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00039280: 7572 6e0a 2020 2020 2020 2020 6966 206b  urn.        if k
-00039290: 6579 203d 3d20 2268 6677 223a 0a20 2020  ey == "hfw":.   
-000392a0: 2020 2020 2020 2020 2062 6561 6d2e 6866           beam.hf
-000392b0: 7720 3d20 7661 6c75 650a 2020 2020 2020  w = value.      
-000392c0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000392d0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
-000392e0: 7265 736f 6c75 7469 6f6e 223a 0a20 2020  resolution":.   
-000392f0: 2020 2020 2020 2020 2062 6561 6d2e 7265           beam.re
-00039300: 736f 6c75 7469 6f6e 203d 2076 616c 7565  solution = value
-00039310: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00039320: 7572 6e0a 2020 2020 2020 2020 6966 206b  urn.        if k
-00039330: 6579 203d 3d20 2264 7765 6c6c 5f74 696d  ey == "dwell_tim
-00039340: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
-00039350: 6265 616d 2e64 7765 6c6c 5f74 696d 6520  beam.dwell_time 
-00039360: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-00039370: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00039380: 2020 2020 2320 6265 616d 2063 6f6e 7472      # beam contr
-00039390: 6f6c 0a20 2020 2020 2020 2069 6620 6b65  ol.        if ke
-000393a0: 7920 3d3d 2022 6f6e 223a 0a20 2020 2020  y == "on":.     
-000393b0: 2020 2020 2020 2062 6561 6d5f 7379 7374         beam_syst
-000393c0: 656d 2e6f 6e20 3d20 7661 6c75 650a 2020  em.on = value.  
-000393d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000393e0: 0a0a 2020 2020 2020 2020 6966 206b 6579  ..        if key
-000393f0: 203d 3d20 2262 6c61 6e6b 6564 223a 0a20   == "blanked":. 
-00039400: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
-00039410: 7379 7374 656d 2e62 6c61 6e6b 6564 203d  system.blanked =
-00039420: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-00039430: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00039440: 2020 2023 2064 6574 6563 746f 720a 2020     # detector.  
-00039450: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
-00039460: 2264 6574 6563 746f 725f 7479 7065 223a  "detector_type":
-00039470: 0a20 2020 2020 2020 2020 2020 2064 6574  .            det
-00039480: 6563 746f 722e 7479 7065 203d 2076 616c  ector.type = val
-00039490: 7565 0a20 2020 2020 2020 2020 2020 2072  ue.            r
-000394a0: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
-000394b0: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
-000394c0: 725f 6d6f 6465 223a 0a20 2020 2020 2020  r_mode":.       
-000394d0: 2020 2020 2064 6574 6563 746f 722e 6d6f       detector.mo
-000394e0: 6465 203d 2076 616c 7565 0a20 2020 2020  de = value.     
-000394f0: 2020 2020 2020 2072 6574 7572 6e20 0a20         return . 
-00039500: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00039510: 2022 6465 7465 6374 6f72 5f63 6f6e 7472   "detector_contr
-00039520: 6173 7422 3a0a 2020 2020 2020 2020 2020  ast":.          
-00039530: 2020 6465 7465 6374 6f72 2e63 6f6e 7472    detector.contr
-00039540: 6173 7420 3d20 7661 6c75 650a 2020 2020  ast = value.    
-00039550: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-00039560: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00039570: 2022 6465 7465 6374 6f72 5f62 7269 6768   "detector_brigh
-00039580: 746e 6573 7322 3a0a 2020 2020 2020 2020  tness":.        
-00039590: 2020 2020 6465 7465 6374 6f72 2e62 7269      detector.bri
-000395a0: 6768 746e 6573 7320 3d20 7661 6c75 650a  ghtness = value.
-000395b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000395c0: 726e 0a20 2020 2020 2020 200a 2020 2020  rn.        .    
-000395d0: 2020 2020 2320 7379 7374 656d 2070 726f      # system pro
-000395e0: 7065 7274 6965 730a 2020 2020 2020 2020  perties.        
-000395f0: 6966 206b 6579 203d 3d20 2262 6561 6d5f  if key == "beam_
-00039600: 656e 6162 6c65 6422 3a0a 2020 2020 2020  enabled":.      
-00039610: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
-00039620: 7065 2069 7320 4265 616d 5479 7065 2e45  pe is BeamType.E
-00039630: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
-00039640: 2020 2020 2020 2020 2073 656c 662e 7379           self.sy
-00039650: 7374 656d 2e65 6c65 6374 726f 6e2e 6265  stem.electron.be
-00039660: 616d 2e65 6e61 626c 6564 203d 2076 616c  am.enabled = val
-00039670: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00039680: 2020 2072 6574 7572 6e20 0a20 2020 2020     return .     
-00039690: 2020 2020 2020 2065 6c69 6620 6265 616d         elif beam
-000396a0: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
-000396b0: 652e 494f 4e3a 0a20 2020 2020 2020 2020  e.ION:.         
-000396c0: 2020 2020 2020 2073 656c 662e 7379 7374         self.syst
-000396d0: 656d 2e69 6f6e 2e62 6561 6d2e 656e 6162  em.ion.beam.enab
-000396e0: 6c65 6420 3d20 7661 6c75 650a 2020 2020  led = value.    
-000396f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00039700: 726e 0a20 2020 2020 2020 2020 2020 2065  rn.            e
-00039710: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00039720: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00039730: 4572 726f 7228 6622 556e 6b6e 6f77 6e20  Error(f"Unknown 
-00039740: 6265 616d 2074 7970 653a 207b 6265 616d  beam type: {beam
-00039750: 5f74 7970 657d 2066 6f72 207b 6b65 797d  _type} for {key}
-00039760: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00039770: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
-00039780: 6620 6b65 7920 3d3d 2022 6575 6365 6e74  f key == "eucent
-00039790: 7269 635f 6865 6967 6874 223a 0a20 2020  ric_height":.   
-000397a0: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
-000397b0: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
-000397c0: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
-000397d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000397e0: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
-000397f0: 2e65 7563 656e 7472 6963 5f68 6569 6768  .eucentric_heigh
-00039800: 7420 3d20 7661 6c75 650a 2020 2020 2020  t = value.      
-00039810: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00039820: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00039830: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
-00039840: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
-00039850: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00039860: 662e 7379 7374 656d 2e69 6f6e 2e65 7563  f.system.ion.euc
-00039870: 656e 7472 6963 5f68 6569 6768 7420 3d20  entric_height = 
-00039880: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00039890: 2020 2020 2020 7265 7475 726e 200a 2020        return .  
-000398a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000398b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398c0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000398d0: 2866 2255 6e6b 6e6f 776e 2062 6561 6d20  (f"Unknown beam 
-000398e0: 7479 7065 3a20 7b62 6561 6d5f 7479 7065  type: {beam_type
-000398f0: 7d20 666f 7220 7b6b 6579 7d22 290a 0a20  } for {key}").. 
-00039900: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
-00039910: 2263 6f6c 756d 6e5f 7469 6c74 223a 0a20  "column_tilt":. 
-00039920: 2020 2020 2020 2020 2020 2069 6620 6265             if be
-00039930: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
-00039940: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
-00039950: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00039960: 6c66 2e73 7973 7465 6d2e 656c 6563 7472  lf.system.electr
-00039970: 6f6e 2e63 6f6c 756d 6e5f 7469 6c74 203d  on.column_tilt =
-00039980: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-00039990: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-000399a0: 2020 2020 2020 2020 2020 656c 6966 2062            elif b
-000399b0: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
-000399c0: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
-000399d0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-000399e0: 7973 7465 6d2e 696f 6e2e 636f 6c75 6d6e  ystem.ion.column
-000399f0: 5f74 696c 7420 3d20 7661 6c75 650a 2020  _tilt = value.  
-00039a00: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00039a10: 7475 726e 200a 2020 2020 2020 2020 2020  turn .          
-00039a20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00039a30: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-00039a40: 6c75 6545 7272 6f72 2866 2255 6e6b 6e6f  lueError(f"Unkno
-00039a50: 776e 2062 6561 6d20 7479 7065 3a20 7b62  wn beam type: {b
-00039a60: 6561 6d5f 7479 7065 7d20 666f 7220 7b6b  eam_type} for {k
-00039a70: 6579 7d22 290a 0a20 2020 2020 2020 2023  ey}")..        #
-00039a80: 2069 6f6e 2062 6561 6d20 7072 6f70 6572   ion beam proper
-00039a90: 7469 6573 0a20 2020 2020 2020 2069 6620  ties.        if 
-00039aa0: 6b65 7920 3d3d 2022 706c 6173 6d61 223a  key == "plasma":
-00039ab0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00039ac0: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
-00039ad0: 6d54 7970 652e 494f 4e3a 0a20 2020 2020  mType.ION:.     
-00039ae0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00039af0: 7379 7374 656d 2e69 6f6e 2e70 6c61 736d  system.ion.plasm
-00039b00: 6120 3d20 7661 6c75 650a 2020 2020 2020  a = value.      
-00039b10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00039b20: 0a0a 2020 2020 2020 2020 6966 2062 6561  ..        if bea
-00039b30: 6d5f 7479 7065 2069 7320 4265 616d 5479  m_type is BeamTy
-00039b40: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
-00039b50: 2020 2020 6966 206b 6579 203d 3d20 2270      if key == "p
-00039b60: 6c61 736d 615f 6761 7322 3a0a 2020 2020  lasma_gas":.    
-00039b70: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00039b80: 6f74 2073 656c 662e 7379 7374 656d 2e69  ot self.system.i
-00039b90: 6f6e 2e70 6c61 736d 613a 0a20 2020 2020  on.plasma:.     
-00039ba0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00039bb0: 6f67 6769 6e67 2e64 6562 7567 2866 2250  ogging.debug(f"P
-00039bc0: 6c61 736d 6120 6761 7320 6361 6e6e 6f74  lasma gas cannot
-00039bd0: 2062 6520 7365 7420 6f6e 2074 6869 7320   be set on this 
-00039be0: 6d69 6372 6f73 636f 7065 2e22 290a 2020  microscope.").  
-00039bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c00: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00039c10: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00039c20: 7365 6c66 2e63 6865 636b 5f61 7661 696c  self.check_avail
-00039c30: 6162 6c65 5f76 616c 7565 7328 2270 6c61  able_values("pla
-00039c40: 736d 615f 6761 7322 2c20 7661 6c75 652c  sma_gas", value,
-00039c50: 2062 6561 6d5f 7479 7065 293a 0a20 2020   beam_type):.   
-00039c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c70: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
-00039c80: 2866 2250 6c61 736d 6120 6761 7320 7b76  (f"Plasma gas {v
-00039c90: 616c 7565 7d20 6e6f 7420 6176 6169 6c61  alue} not availa
-00039ca0: 626c 652e 2041 7661 696c 6162 6c65 2076  ble. Available v
-00039cb0: 616c 7565 733a 207b 7365 6c66 2e67 6574  alues: {self.get
-00039cc0: 5f61 7661 696c 6162 6c65 5f76 616c 7565  _available_value
-00039cd0: 7328 2770 6c61 736d 615f 6761 7327 2c20  s('plasma_gas', 
-00039ce0: 6265 616d 5f74 7970 6529 7d22 290a 2020  beam_type)}").  
-00039cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039d00: 2020 7265 7475 726e 200a 2020 2020 2020    return .      
-00039d10: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00039d20: 672e 696e 666f 2866 2253 6574 7469 6e67  g.info(f"Setting
-00039d30: 2070 6c61 736d 6120 6761 7320 746f 207b   plasma gas to {
-00039d40: 7661 6c75 657d 2e2e 2e20 7468 6973 206d  value}... this m
-00039d50: 6179 2074 616b 6520 736f 6d65 2074 696d  ay take some tim
-00039d60: 652e 2e2e 2229 0a20 2020 2020 2020 2020  e...").         
-00039d70: 2020 2020 2020 2073 656c 662e 7379 7374         self.syst
-00039d80: 656d 2e69 6f6e 2e70 6c61 736d 615f 6761  em.ion.plasma_ga
-00039d90: 7320 3d20 7661 6c75 650a 2020 2020 2020  s = value.      
-00039da0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00039db0: 672e 696e 666f 2866 2250 6c61 736d 6120  g.info(f"Plasma 
-00039dc0: 6761 7320 7365 7420 746f 207b 7661 6c75  gas set to {valu
-00039dd0: 657d 2e22 290a 0a20 2020 2020 2020 2020  e}.")..         
-00039de0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00039df0: 2020 2020 2020 2023 2073 7461 6765 2070         # stage p
-00039e00: 726f 7065 7274 6965 730a 2020 2020 2020  roperties.      
-00039e10: 2020 6966 206b 6579 203d 3d20 2273 7461    if key == "sta
-00039e20: 6765 5f68 6f6d 6522 3a0a 2020 2020 2020  ge_home":.      
-00039e30: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
-00039e40: 666f 2866 2248 6f6d 696e 6720 7374 6167  fo(f"Homing stag
-00039e50: 652e 2e2e 2229 0a20 2020 2020 2020 2020  e...").         
-00039e60: 2020 2073 656c 662e 7374 6167 655f 7379     self.stage_sy
-00039e70: 7374 656d 2e69 735f 686f 6d65 6420 3d20  stem.is_homed = 
-00039e80: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-00039e90: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
-00039ea0: 5374 6167 6520 686f 6d65 642e 2229 0a20  Stage homed."). 
-00039eb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00039ec0: 6e0a 2020 2020 2020 2020 0a20 2020 2020  n.        .     
-00039ed0: 2020 2069 6620 6b65 7920 3d3d 2022 7374     if key == "st
-00039ee0: 6167 655f 6c69 6e6b 223a 0a20 2020 2020  age_link":.     
-00039ef0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
-00039f00: 6e66 6f28 6622 4c69 6e6b 696e 6720 7374  nfo(f"Linking st
-00039f10: 6167 652e 2e2e 2229 0a20 2020 2020 2020  age...").       
-00039f20: 2020 2020 2073 656c 662e 7374 6167 655f       self.stage_
-00039f30: 7379 7374 656d 2e69 735f 6c69 6e6b 6564  system.is_linked
-00039f40: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00039f50: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
-00039f60: 2866 2253 7461 6765 206c 696e 6b65 642e  (f"Stage linked.
-00039f70: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00039f80: 6574 7572 6e0a 0a20 2020 2020 2020 2023  eturn..        #
-00039f90: 2063 6861 6d62 6572 2070 726f 7065 7274   chamber propert
-00039fa0: 6965 730a 2020 2020 2020 2020 6966 206b  ies.        if k
-00039fb0: 6579 203d 3d20 2270 756d 705f 6368 616d  ey == "pump_cham
-00039fc0: 6265 7222 3a0a 2020 2020 2020 2020 2020  ber":.          
-00039fd0: 2020 6966 2076 616c 7565 3a0a 2020 2020    if value:.    
-00039fe0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00039ff0: 696e 672e 696e 666f 2866 2250 756d 7069  ing.info(f"Pumpi
-0003a000: 6e67 2063 6861 6d62 6572 2e2e 2e22 290a  ng chamber...").
-0003a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a020: 7365 6c66 2e63 6861 6d62 6572 2e73 7461  self.chamber.sta
-0003a030: 7465 203d 2022 5075 6d70 6564 220a 2020  te = "Pumped".  
-0003a040: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003a050: 6c66 2e63 6861 6d62 6572 2e70 7265 7373  lf.chamber.press
-0003a060: 7572 6520 3d20 3165 2d36 2023 2031 2075  ure = 1e-6 # 1 u
-0003a070: 546f 7272 0a20 2020 2020 2020 2020 2020  Torr.           
-0003a080: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
-0003a090: 6f28 6622 4368 616d 6265 7220 7075 6d70  o(f"Chamber pump
-0003a0a0: 6564 2e22 290a 2020 2020 2020 2020 2020  ed.").          
-0003a0b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0003a0c0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0003a0d0: 696e 666f 2866 2249 6e76 616c 6964 2076  info(f"Invalid v
-0003a0e0: 616c 7565 2066 6f72 2070 756d 705f 6368  alue for pump_ch
-0003a0f0: 616d 6265 723a 207b 7661 6c75 657d 2229  amber: {value}")
-0003a100: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003a110: 7572 6e0a 2020 2020 2020 2020 6966 206b  urn.        if k
-0003a120: 6579 203d 3d20 2276 656e 745f 6368 616d  ey == "vent_cham
-0003a130: 6265 7222 3a0a 2020 2020 2020 2020 2020  ber":.          
-0003a140: 2020 6966 2076 616c 7565 3a0a 2020 2020    if value:.    
-0003a150: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0003a160: 696e 672e 696e 666f 2866 2256 656e 7469  ing.info(f"Venti
-0003a170: 6e67 2063 6861 6d62 6572 2e2e 2e22 290a  ng chamber...").
-0003a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a190: 7365 6c66 2e63 6861 6d62 6572 2e73 7461  self.chamber.sta
-0003a1a0: 7465 203d 2022 5665 6e74 6564 220a 2020  te = "Vented".  
-0003a1b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003a1c0: 6c66 2e63 6861 6d62 6572 2e70 7265 7373  lf.chamber.press
-0003a1d0: 7572 6520 3d20 3165 350a 2020 2020 2020  ure = 1e5.      
-0003a1e0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-0003a1f0: 672e 696e 666f 2866 2243 6861 6d62 6572  g.info(f"Chamber
-0003a200: 2076 656e 7465 642e 2229 0a20 2020 2020   vented.").     
-0003a210: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003a220: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0003a230: 6769 6e67 2e69 6e66 6f28 6622 496e 7661  ging.info(f"Inva
-0003a240: 6c69 6420 7661 6c75 6520 666f 7220 7665  lid value for ve
-0003a250: 6e74 5f63 6861 6d62 6572 3a20 7b76 616c  nt_chamber: {val
-0003a260: 7565 7d22 290a 2020 2020 2020 2020 2020  ue}").          
-0003a270: 2020 7265 7475 726e 0a0a 0a20 2020 2020    return...     
-0003a280: 2020 206c 6f67 6769 6e67 2e77 6172 6e69     logging.warni
-0003a290: 6e67 2866 2255 6e6b 6e6f 776e 206b 6579  ng(f"Unknown key
-0003a2a0: 3a20 7b6b 6579 7d20 287b 6265 616d 5f74  : {key} ({beam_t
-0003a2b0: 7970 657d 2922 290a 2020 2020 2020 2020  ype})").        
-0003a2c0: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-0003a2d0: 2064 6566 2063 6865 636b 5f61 7661 696c   def check_avail
-0003a2e0: 6162 6c65 5f76 616c 7565 7328 7365 6c66  able_values(self
-0003a2f0: 2c20 6b65 793a 2073 7472 2c20 7661 6c75  , key: str, valu
-0003a300: 652c 2062 6561 6d5f 7479 7065 3a20 4265  e, beam_type: Be
-0003a310: 616d 5479 7065 203d 204e 6f6e 6529 202d  amType = None) -
-0003a320: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-0003a330: 6c6f 6767 696e 672e 696e 666f 2866 2243  logging.info(f"C
-0003a340: 6865 636b 696e 6720 6966 207b 6b65 797d  hecking if {key}
-0003a350: 3d7b 7661 6c75 657d 2069 7320 6176 6169  ={value} is avai
-0003a360: 6c61 626c 6520 287b 6265 616d 5f74 7970  lable ({beam_typ
-0003a370: 657d 2922 290a 0a20 2020 2020 2020 2069  e})")..        i
-0003a380: 6620 6b65 7920 3d3d 2022 706c 6173 6d61  f key == "plasma
-0003a390: 5f67 6173 223a 0a20 2020 2020 2020 2020  _gas":.         
-0003a3a0: 2020 2072 6574 7572 6e20 7661 6c75 6520     return value 
-0003a3b0: 696e 2073 656c 662e 6765 745f 6176 6169  in self.get_avai
-0003a3c0: 6c61 626c 655f 7661 6c75 6573 286b 6579  lable_values(key
-0003a3d0: 2c20 6265 616d 5f74 7970 6529 0a20 2020  , beam_type).   
-0003a3e0: 2020 2020 200a 0a20 2020 2020 2020 2072       ..        r
-0003a3f0: 6574 7572 6e20 4661 6c73 650a 2020 2020  eturn False.    
-0003a400: 0a20 2020 2064 6566 2068 6f6d 6528 7365  .    def home(se
-0003a410: 6c66 293a 0a20 2020 2020 2020 205f 6368  lf):.        _ch
-0003a420: 6563 6b5f 7374 6167 6528 7365 6c66 2e73  eck_stage(self.s
-0003a430: 7973 7465 6d29 0a20 2020 2020 2020 206c  ystem).        l
-0003a440: 6f67 6769 6e67 2e69 6e66 6f28 2248 6f6d  ogging.info("Hom
-0003a450: 696e 6720 5374 6167 6522 290a 2020 2020  ing Stage").    
-0003a460: 2020 2020 7365 6c66 2e73 7461 6765 5f73      self.stage_s
-0003a470: 7973 7465 6d2e 6973 5f68 6f6d 6564 203d  ystem.is_homed =
-0003a480: 2054 7275 650a 2020 2020 2020 2020 6c6f   True.        lo
-0003a490: 6767 696e 672e 696e 666f 2866 2253 7461  gging.info(f"Sta
-0003a4a0: 6765 2068 6f6d 6564 2e22 290a 2020 2020  ge homed.").    
-0003a4b0: 2020 2020 7265 7475 726e 0a0a 0a23 2323      return...###
-0003a4c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0003a4d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0003a4e0: 2323 2323 2320 4865 6c70 6572 2066 756e  ##### Helper fun
-0003a4f0: 6374 696f 6e73 2023 2323 2323 2323 2323  ctions #########
-0003a500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0003a510: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0003a520: 0a0a 0a64 6566 2070 7269 6e74 5072 6f67  ...def printProg
-0003a530: 7265 7373 4261 7228 0a20 2020 2076 616c  ressBar(.    val
-0003a540: 7565 2c20 746f 7461 6c2c 2070 7265 6669  ue, total, prefi
-0003a550: 783d 2222 2c20 7375 6666 6978 3d22 222c  x="", suffix="",
-0003a560: 2064 6563 696d 616c 733d 302c 206c 656e   decimals=0, len
-0003a570: 6774 683d 3130 302c 2066 696c 6c3d 22e2  gth=100, fill=".
-0003a580: 9688 220a 293a 0a20 2020 2022 2222 0a20  ..".):.    """. 
-0003a590: 2020 2074 6572 6d69 6e61 6c20 7072 6f67     terminal prog
-0003a5a0: 7265 7373 2062 6172 0a20 2020 2022 2222  ress bar.    """
-0003a5b0: 0a20 2020 2070 6572 6365 6e74 203d 2028  .    percent = (
-0003a5c0: 227b 303a 2e22 202b 2073 7472 2864 6563  "{0:." + str(dec
-0003a5d0: 696d 616c 7329 202b 2022 667d 2229 2e66  imals) + "f}").f
-0003a5e0: 6f72 6d61 7428 3130 3020 2a20 2876 616c  ormat(100 * (val
-0003a5f0: 7565 202f 2066 6c6f 6174 2874 6f74 616c  ue / float(total
-0003a600: 2929 290a 2020 2020 6669 6c6c 6564 5f6c  ))).    filled_l
-0003a610: 656e 6774 6820 3d20 696e 7428 6c65 6e67  ength = int(leng
-0003a620: 7468 202a 2076 616c 7565 202f 2f20 746f  th * value // to
-0003a630: 7461 6c29 0a20 2020 2062 6172 203d 2066  tal).    bar = f
-0003a640: 696c 6c20 2a20 6669 6c6c 6564 5f6c 656e  ill * filled_len
-0003a650: 6774 6820 2b20 222d 2220 2a20 286c 656e  gth + "-" * (len
-0003a660: 6774 6820 2d20 6669 6c6c 6564 5f6c 656e  gth - filled_len
-0003a670: 6774 6829 0a20 2020 2070 7269 6e74 2866  gth).    print(f
-0003a680: 225c 727b 7072 6566 6978 7d20 7c7b 6261  "\r{prefix} |{ba
-0003a690: 727d 7c20 7b70 6572 6365 6e74 7d25 207b  r}| {percent}% {
-0003a6a0: 7375 6666 6978 7d22 2c20 656e 643d 225c  suffix}", end="\
-0003a6b0: 7222 290a 0a69 6d70 6f72 7420 7761 726e  r")..import warn
-0003a6c0: 696e 6773 0a0a 6465 6620 5f63 6865 636b  ings..def _check
-0003a6d0: 5f62 6561 6d28 6265 616d 5f74 7970 653a  _beam(beam_type:
-0003a6e0: 2042 6561 6d54 7970 652c 2073 6574 7469   BeamType, setti
-0003a6f0: 6e67 733a 2053 7973 7465 6d53 6574 7469  ngs: SystemSetti
-0003a700: 6e67 7329 3a0a 2020 2020 2222 220a 2020  ngs):.    """.  
-0003a710: 2020 4368 6563 6b73 2069 6620 6265 616d    Checks if beam
-0003a720: 2069 7320 6176 6169 6c61 626c 652e 0a20   is available.. 
-0003a730: 2020 2022 2222 0a20 2020 2069 6620 6265     """.    if be
-0003a740: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
-0003a750: 7970 652e 454c 4543 5452 4f4e 2061 6e64  ype.ELECTRON and
-0003a760: 2073 6574 7469 6e67 732e 656c 6563 7472   settings.electr
-0003a770: 6f6e 2e65 6e61 626c 6564 203d 3d20 4661  on.enabled == Fa
-0003a780: 6c73 653a 0a20 2020 2020 2020 2077 6172  lse:.        war
-0003a790: 6e69 6e67 732e 7761 726e 2822 5468 6520  nings.warn("The 
-0003a7a0: 6d69 6372 6f73 636f 7065 2064 6f65 7320  microscope does 
-0003a7b0: 6e6f 7420 6861 7665 2061 6e20 656c 6563  not have an elec
-0003a7c0: 7472 6f6e 2062 6561 6d2e 2229 0a20 2020  tron beam.").   
-0003a7d0: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
-0003a7e0: 2042 6561 6d54 7970 652e 494f 4e20 616e   BeamType.ION an
-0003a7f0: 6420 7365 7474 696e 6773 2e69 6f6e 2e65  d settings.ion.e
-0003a800: 6e61 626c 6564 2020 3d3d 2046 616c 7365  nabled  == False
-0003a810: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
-0003a820: 6773 2e77 6172 6e28 2254 6865 206d 6963  gs.warn("The mic
-0003a830: 726f 7363 6f70 6520 646f 6573 206e 6f74  roscope does not
-0003a840: 2068 6176 6520 616e 2069 6f6e 2062 6561   have an ion bea
-0003a850: 6d2e 2229 0a0a 6465 6620 5f63 6865 636b  m.")..def _check
-0003a860: 5f73 7461 6765 2873 6574 7469 6e67 732c  _stage(settings,
-0003a870: 2072 6f74 6174 696f 6e3a 2062 6f6f 6c20   rotation: bool 
-0003a880: 3d20 4661 6c73 652c 2074 696c 743a 2062  = False, tilt: b
-0003a890: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
-0003a8a0: 2020 2222 220a 2020 2020 4368 6563 6b73    """.    Checks
-0003a8b0: 2069 6620 7468 6520 7374 6167 6520 6973   if the stage is
-0003a8c0: 2066 756c 6c79 206d 6f76 6162 6c65 2e0a   fully movable..
-0003a8d0: 2020 2020 2222 220a 2020 2020 6966 2073      """.    if s
-0003a8e0: 6574 7469 6e67 732e 7374 6167 652e 656e  ettings.stage.en
-0003a8f0: 6162 6c65 6420 3d3d 2046 616c 7365 3a0a  abled == False:.
-0003a900: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
-0003a910: 2e77 6172 6e28 2254 6865 206d 6963 726f  .warn("The micro
-0003a920: 7363 6f70 6520 646f 6573 206e 6f74 2068  scope does not h
-0003a930: 6176 6520 6120 6d6f 7669 6e67 2073 7461  ave a moving sta
-0003a940: 6765 2e22 290a 2020 2020 6966 2073 6574  ge.").    if set
-0003a950: 7469 6e67 732e 7374 6167 652e 726f 7461  tings.stage.rota
-0003a960: 7469 6f6e 203d 3d20 4661 6c73 6520 616e  tion == False an
-0003a970: 6420 726f 7461 7469 6f6e 203d 3d20 5472  d rotation == Tr
-0003a980: 7565 3a0a 2020 2020 2020 2020 7761 726e  ue:.        warn
-0003a990: 696e 6773 2e77 6172 6e28 2254 6865 206d  ings.warn("The m
-0003a9a0: 6963 726f 7363 6f70 6520 7374 6167 6520  icroscope stage 
-0003a9b0: 646f 6573 206e 6f74 2072 6f74 6174 652e  does not rotate.
-0003a9c0: 2229 0a20 2020 2069 6620 7365 7474 696e  ").    if settin
-0003a9d0: 6773 2e73 7461 6765 2e74 696c 7420 3d3d  gs.stage.tilt ==
-0003a9e0: 2046 616c 7365 2061 6e64 2074 696c 7420   False and tilt 
-0003a9f0: 3d3d 2054 7275 653a 0a20 2020 2020 2020  == True:.       
-0003aa00: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
-0003aa10: 5468 6520 6d69 6372 6f73 636f 7065 2073  The microscope s
-0003aa20: 7461 6765 2064 6f65 7320 6e6f 7420 7469  tage does not ti
-0003aa30: 6c74 2e22 290a 0a64 6566 205f 6368 6563  lt.")..def _chec
-0003aa40: 6b5f 6d61 6e69 7075 6c61 746f 7228 7365  k_manipulator(se
-0003aa50: 7474 696e 6773 2c20 726f 7461 7469 6f6e  ttings, rotation
-0003aa60: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
-0003aa70: 7469 6c74 3a20 626f 6f6c 203d 2046 616c  tilt: bool = Fal
-0003aa80: 7365 293a 0a20 2020 2022 2222 0a20 2020  se):.    """.   
-0003aa90: 2043 6865 636b 7320 6966 2074 6865 206e   Checks if the n
-0003aaa0: 6565 646c 6520 6973 2061 7661 696c 6162  eedle is availab
-0003aab0: 6c65 2e0a 2020 2020 2222 220a 2020 2020  le..    """.    
-0003aac0: 6966 2073 6574 7469 6e67 732e 6d61 6e69  if settings.mani
-0003aad0: 7075 6c61 746f 722e 656e 6162 6c65 6420  pulator.enabled 
-0003aae0: 3d3d 2046 616c 7365 3a0a 2020 2020 2020  == False:.      
-0003aaf0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-0003ab00: 2254 6865 206d 6963 726f 7363 6f70 6520  "The microscope 
-0003ab10: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
-0003ab20: 6e65 6564 6c65 2e22 290a 2020 2020 6966  needle.").    if
-0003ab30: 2073 6574 7469 6e67 732e 6d61 6e69 7075   settings.manipu
-0003ab40: 6c61 746f 722e 726f 7461 7469 6f6e 203d  lator.rotation =
-0003ab50: 3d20 4661 6c73 6520 616e 6420 726f 7461  = False and rota
-0003ab60: 7469 6f6e 203d 3d20 5472 7565 3a0a 2020  tion == True:.  
-0003ab70: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
-0003ab80: 6172 6e28 2254 6865 206d 6963 726f 7363  arn("The microsc
-0003ab90: 6f70 6520 6e65 6564 6c65 2064 6f65 7320  ope needle does 
-0003aba0: 6e6f 7420 726f 7461 7465 2e22 290a 2020  not rotate.").  
-0003abb0: 2020 6966 2073 6574 7469 6e67 732e 6d61    if settings.ma
-0003abc0: 6e69 7075 6c61 746f 722e 7469 6c74 203d  nipulator.tilt =
-0003abd0: 3d20 4661 6c73 6520 616e 6420 7469 6c74  = False and tilt
-0003abe0: 203d 3d20 5472 7565 3a0a 2020 2020 2020   == True:.      
-0003abf0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-0003ac00: 2254 6865 206d 6963 726f 7363 6f70 6520  "The microscope 
-0003ac10: 6e65 6564 6c65 2064 6f65 7320 6e6f 7420  needle does not 
-0003ac20: 7469 6c74 2e22 290a 0a64 6566 205f 6368  tilt.")..def _ch
-0003ac30: 6563 6b5f 7370 7574 7465 7228 7365 7474  eck_sputter(sett
-0003ac40: 696e 6773 3a20 5379 7374 656d 5365 7474  ings: SystemSett
-0003ac50: 696e 6773 293a 0a20 2020 2022 2222 0a20  ings):.    """. 
-0003ac60: 2020 2043 6865 636b 7320 6966 2074 6865     Checks if the
-0003ac70: 2073 7075 7474 6572 2069 7320 6176 6169   sputter is avai
-0003ac80: 6c61 626c 652e 0a20 2020 2022 2222 0a20  lable..    """. 
-0003ac90: 2020 2069 6620 7365 7474 696e 6773 2e67     if settings.g
-0003aca0: 6973 2e65 6e61 626c 6564 203d 3d20 4661  is.enabled == Fa
-0003acb0: 6c73 653a 0a20 2020 2020 2020 2077 6172  lse:.        war
-0003acc0: 6e69 6e67 732e 7761 726e 2822 5468 6520  nings.warn("The 
-0003acd0: 6d69 6372 6f73 636f 7065 2064 6f65 7320  microscope does 
-0003ace0: 6e6f 7420 6861 7665 2061 2047 4953 2073  not have a GIS s
-0003acf0: 7973 7465 6d2e 2229 0a20 2020 2069 6620  ystem.").    if 
-0003ad00: 7365 7474 696e 6773 2e67 6973 2e6d 756c  settings.gis.mul
-0003ad10: 7469 6368 656d 203d 3d20 4661 6c73 653a  tichem == False:
-0003ad20: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
-0003ad30: 732e 7761 726e 2822 5468 6520 6d69 6372  s.warn("The micr
-0003ad40: 6f73 636f 7065 2064 6f65 7320 6e6f 7420  oscope does not 
-0003ad50: 6861 7665 2061 206d 756c 7469 6368 656d  have a multichem
-0003ad60: 2073 7973 7465 6d2e 2229 0a20 2020 200a   system.").    .
-0003ad70: 6465 6620 5f63 6865 636b 5f73 7461 6765  def _check_stage
-0003ad80: 5f6d 6f76 656d 656e 7428 7365 7474 696e  _movement(settin
-0003ad90: 6773 3a20 5379 7374 656d 5365 7474 696e  gs: SystemSettin
-0003ada0: 6773 2c20 706f 7369 7469 6f6e 3a20 4669  gs, position: Fi
-0003adb0: 6273 656d 5374 6167 6550 6f73 6974 696f  bsemStagePositio
-0003adc0: 6e29 3a0a 2020 2020 7265 715f 726f 7461  n):.    req_rota
-0003add0: 7469 6f6e 203d 2070 6f73 6974 696f 6e2e  tion = position.
-0003ade0: 7220 6973 206e 6f74 204e 6f6e 6520 0a20  r is not None . 
-0003adf0: 2020 2072 6571 5f74 696c 7420 3d20 706f     req_tilt = po
-0003ae00: 7369 7469 6f6e 2e74 2069 7320 6e6f 7420  sition.t is not 
-0003ae10: 4e6f 6e65 0a20 2020 205f 6368 6563 6b5f  None.    _check_
-0003ae20: 7374 6167 6528 7365 7474 696e 6773 2c20  stage(settings, 
-0003ae30: 726f 7461 7469 6f6e 3d72 6571 5f72 6f74  rotation=req_rot
-0003ae40: 6174 696f 6e2c 2074 696c 743d 7265 715f  ation, tilt=req_
-0003ae50: 7469 6c74 2920 2020 200a 0a64 6566 205f  tilt)    ..def _
-0003ae60: 6368 6563 6b5f 6d61 6e69 7075 6c61 746f  check_manipulato
-0003ae70: 725f 6d6f 7665 6d65 6e74 2873 6574 7469  r_movement(setti
-0003ae80: 6e67 733a 2053 7973 7465 6d53 6574 7469  ngs: SystemSetti
-0003ae90: 6e67 732c 2070 6f73 6974 696f 6e3a 2046  ngs, position: F
-0003aea0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
-0003aeb0: 506f 7369 7469 6f6e 293a 0a20 2020 2072  Position):.    r
-0003aec0: 6571 5f72 6f74 6174 696f 6e20 3d20 706f  eq_rotation = po
-0003aed0: 7369 7469 6f6e 2e72 2069 7320 6e6f 7420  sition.r is not 
-0003aee0: 4e6f 6e65 0a20 2020 2072 6571 5f74 696c  None.    req_til
-0003aef0: 7420 3d20 706f 7369 7469 6f6e 2e74 2069  t = position.t i
-0003af00: 7320 6e6f 7420 4e6f 6e65 0a0a 2020 2020  s not None..    
-0003af10: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
-0003af20: 6f72 2873 6574 7469 6e67 732c 2072 6f74  or(settings, rot
-0003af30: 6174 696f 6e3d 7265 715f 726f 7461 7469  ation=req_rotati
-0003af40: 6f6e 2c20 7469 6c74 3d72 6571 5f74 696c  on, tilt=req_til
-0003af50: 7429 0a                                  t).
+000048f0: 746f 5f64 6963 7428 292c 2022 6265 616d  to_dict(), "beam
+00004900: 5f74 7970 6522 3a20 6265 616d 5f74 7970  _type": beam_typ
+00004910: 652e 6e61 6d65 7d29 0a20 2020 2020 2020  e.name}).       
+00004920: 2072 6574 7572 6e20 6465 7465 6374 6f72   return detector
+00004930: 5f73 6574 7469 6e67 730a 2020 2020 0a20  _settings.    . 
+00004940: 2020 2064 6566 2073 6574 5f64 6574 6563     def set_detec
+00004950: 746f 725f 7365 7474 696e 6773 2873 656c  tor_settings(sel
+00004960: 662c 2064 6574 6563 746f 725f 7365 7474  f, detector_sett
+00004970: 696e 6773 3a20 4669 6273 656d 4465 7465  ings: FibsemDete
+00004980: 6374 6f72 5365 7474 696e 6773 2c20 6265  ctorSettings, be
+00004990: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
+000049a0: 6520 3d20 4265 616d 5479 7065 2e45 4c45  e = BeamType.ELE
+000049b0: 4354 524f 4e29 202d 3e20 4e6f 6e65 3a0a  CTRON) -> None:.
+000049c0: 2020 2020 2020 2020 2222 2253 6574 2074          """Set t
+000049d0: 6865 2064 6574 6563 746f 7220 7365 7474  he detector sett
+000049e0: 696e 6773 2066 6f72 2074 6865 2073 7065  ings for the spe
+000049f0: 6369 6669 6564 2062 6561 6d20 7479 7065  cified beam type
+00004a00: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
+00004a10: 696e 672e 6465 6275 6728 6622 5365 7474  ing.debug(f"Sett
+00004a20: 696e 6720 7b62 6561 6d5f 7479 7065 2e6e  ing {beam_type.n
+00004a30: 616d 657d 2064 6574 6563 746f 7220 7365  ame} detector se
+00004a40: 7474 696e 6773 2e2e 2e22 290a 2020 2020  ttings...").    
+00004a50: 2020 2020 7365 6c66 2e73 6574 2822 6465      self.set("de
+00004a60: 7465 6374 6f72 5f74 7970 6522 2c20 6465  tector_type", de
+00004a70: 7465 6374 6f72 5f73 6574 7469 6e67 732e  tector_settings.
+00004a80: 7479 7065 2c20 6265 616d 5f74 7970 6529  type, beam_type)
+00004a90: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00004aa0: 7428 2264 6574 6563 746f 725f 6d6f 6465  t("detector_mode
+00004ab0: 222c 2064 6574 6563 746f 725f 7365 7474  ", detector_sett
+00004ac0: 696e 6773 2e6d 6f64 652c 2062 6561 6d5f  ings.mode, beam_
+00004ad0: 7479 7065 290a 2020 2020 2020 2020 7365  type).        se
+00004ae0: 6c66 2e73 6574 2822 6465 7465 6374 6f72  lf.set("detector
+00004af0: 5f62 7269 6768 746e 6573 7322 2c20 6465  _brightness", de
+00004b00: 7465 6374 6f72 5f73 6574 7469 6e67 732e  tector_settings.
+00004b10: 6272 6967 6874 6e65 7373 2c20 6265 616d  brightness, beam
+00004b20: 5f74 7970 6529 0a20 2020 2020 2020 2073  _type).        s
+00004b30: 656c 662e 7365 7428 2264 6574 6563 746f  elf.set("detecto
+00004b40: 725f 636f 6e74 7261 7374 222c 2064 6574  r_contrast", det
+00004b50: 6563 746f 725f 7365 7474 696e 6773 2e63  ector_settings.c
+00004b60: 6f6e 7472 6173 742c 2062 6561 6d5f 7479  ontrast, beam_ty
+00004b70: 7065 290a 2020 2020 2020 2020 6c6f 6767  pe).        logg
+00004b80: 696e 672e 6465 6275 6728 7b22 6d73 6722  ing.debug({"msg"
+00004b90: 3a20 2273 6574 5f64 6574 6563 746f 725f  : "set_detector_
+00004ba0: 7365 7474 696e 6773 222c 2022 6465 7465  settings", "dete
+00004bb0: 6374 6f72 5f73 6574 7469 6e67 7322 3a20  ctor_settings": 
+00004bc0: 6465 7465 6374 6f72 5f73 6574 7469 6e67  detector_setting
+00004bd0: 732e 746f 5f64 6963 7428 292c 2022 6265  s.to_dict(), "be
+00004be0: 616d 5f74 7970 6522 3a20 6265 616d 5f74  am_type": beam_t
+00004bf0: 7970 652e 6e61 6d65 7d29 0a20 2020 200a  ype.name}).    .
+00004c00: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00004c10: 2020 2020 6465 6620 6765 745f 6d69 6372      def get_micr
+00004c20: 6f73 636f 7065 5f73 7461 7465 2873 656c  oscope_state(sel
+00004c30: 662c 2062 6561 6d5f 7479 7065 3a20 4265  f, beam_type: Be
+00004c40: 616d 5479 7065 203d 204e 6f6e 6529 202d  amType = None) -
+00004c50: 3e20 4d69 6372 6f73 636f 7065 5374 6174  > MicroscopeStat
+00004c60: 653a 0a20 2020 2020 2020 2022 2222 4765  e:.        """Ge
+00004c70: 7420 7468 6520 6375 7272 656e 7420 6d69  t the current mi
+00004c80: 6372 6f73 636f 7065 2073 7461 7465 2e22  croscope state."
+00004c90: 2222 0a0a 2020 2020 2020 2020 2320 6465  ""..        # de
+00004ca0: 6661 756c 7420 7661 6c75 6573 0a20 2020  fault values.   
+00004cb0: 2020 2020 2065 6c65 6374 726f 6e5f 6265       electron_be
+00004cc0: 616d 2c20 656c 6563 7472 6f6e 5f64 6574  am, electron_det
+00004cd0: 6563 746f 7220 3d20 4e6f 6e65 2c20 4e6f  ector = None, No
+00004ce0: 6e65 0a20 2020 2020 2020 2069 6f6e 5f62  ne.        ion_b
+00004cf0: 6561 6d2c 2069 6f6e 5f64 6574 6563 746f  eam, ion_detecto
+00004d00: 7220 3d20 4e6f 6e65 2c20 4e6f 6e65 0a20  r = None, None. 
+00004d10: 2020 2020 2020 2073 7461 6765 5f70 6f73         stage_pos
+00004d20: 6974 696f 6e20 3d20 4e6f 6e65 0a20 2020  ition = None.   
+00004d30: 2020 2020 2067 6574 5f65 6c65 6374 726f       get_electro
+00004d40: 6e5f 7374 6174 6520 3d20 6265 616d 5f74  n_state = beam_t
+00004d50: 7970 6520 696e 205b 4265 616d 5479 7065  ype in [BeamType
+00004d60: 2e45 4c45 4354 524f 4e2c 204e 6f6e 655d  .ELECTRON, None]
+00004d70: 0a20 2020 2020 2020 2067 6574 5f69 6f6e  .        get_ion
+00004d80: 5f73 7461 7465 203d 2062 6561 6d5f 7479  _state = beam_ty
+00004d90: 7065 2069 6e20 5b42 6561 6d54 7970 652e  pe in [BeamType.
+00004da0: 494f 4e2c 204e 6f6e 655d 0a0a 2020 2020  ION, None]..    
+00004db0: 2020 2020 2320 6765 7420 7468 6520 7374      # get the st
+00004dc0: 6174 6520 6f66 2074 6865 2065 6c65 6374  ate of the elect
+00004dd0: 726f 6e20 6265 616d 0a20 2020 2020 2020  ron beam.       
+00004de0: 2069 6620 7365 6c66 2e69 735f 6176 6169   if self.is_avai
+00004df0: 6c61 626c 6528 2265 6c65 6374 726f 6e5f  lable("electron_
+00004e00: 6265 616d 2229 2061 6e64 2067 6574 5f65  beam") and get_e
+00004e10: 6c65 6374 726f 6e5f 7374 6174 653a 0a20  lectron_state:. 
+00004e20: 2020 2020 2020 2020 2020 2065 6c65 6374             elect
+00004e30: 726f 6e5f 6265 616d 203d 2073 656c 662e  ron_beam = self.
+00004e40: 6765 745f 6265 616d 5f73 6574 7469 6e67  get_beam_setting
+00004e50: 7328 6265 616d 5f74 7970 653d 4265 616d  s(beam_type=Beam
+00004e60: 5479 7065 2e45 4c45 4354 524f 4e29 0a20  Type.ELECTRON). 
+00004e70: 2020 2020 2020 2020 2020 2065 6c65 6374             elect
+00004e80: 726f 6e5f 6465 7465 6374 6f72 203d 2073  ron_detector = s
+00004e90: 656c 662e 6765 745f 6465 7465 6374 6f72  elf.get_detector
+00004ea0: 5f73 6574 7469 6e67 7328 6265 616d 5f74  _settings(beam_t
+00004eb0: 7970 653d 4265 616d 5479 7065 2e45 4c45  ype=BeamType.ELE
+00004ec0: 4354 524f 4e29 0a20 0a20 2020 2020 2020  CTRON). .       
+00004ed0: 2023 2067 6574 2074 6865 2073 7461 7465   # get the state
+00004ee0: 206f 6620 7468 6520 696f 6e20 6265 616d   of the ion beam
+00004ef0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00004f00: 2069 6620 7365 6c66 2e69 735f 6176 6169   if self.is_avai
+00004f10: 6c61 626c 6528 2269 6f6e 5f62 6561 6d22  lable("ion_beam"
+00004f20: 2920 616e 6420 6765 745f 696f 6e5f 7374  ) and get_ion_st
+00004f30: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00004f40: 2069 6f6e 5f62 6561 6d20 3d20 7365 6c66   ion_beam = self
+00004f50: 2e67 6574 5f62 6561 6d5f 7365 7474 696e  .get_beam_settin
+00004f60: 6773 2862 6561 6d5f 7479 7065 3d42 6561  gs(beam_type=Bea
+00004f70: 6d54 7970 652e 494f 4e29 0a20 2020 2020  mType.ION).     
+00004f80: 2020 2020 2020 2069 6f6e 5f64 6574 6563         ion_detec
+00004f90: 746f 7220 3d20 7365 6c66 2e67 6574 5f64  tor = self.get_d
+00004fa0: 6574 6563 746f 725f 7365 7474 696e 6773  etector_settings
+00004fb0: 2862 6561 6d5f 7479 7065 3d42 6561 6d54  (beam_type=BeamT
+00004fc0: 7970 652e 494f 4e29 0a0a 2020 2020 2020  ype.ION)..      
+00004fd0: 2020 2320 6765 7420 7468 6520 7374 6174    # get the stat
+00004fe0: 6520 6f66 2074 6865 2073 7461 6765 0a20  e of the stage. 
+00004ff0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00005000: 735f 6176 6169 6c61 626c 6528 2273 7461  s_available("sta
+00005010: 6765 2229 3a0a 2020 2020 2020 2020 2020  ge"):.          
+00005020: 2020 7374 6167 655f 706f 7369 7469 6f6e    stage_position
+00005030: 203d 2073 656c 662e 6765 745f 7374 6167   = self.get_stag
+00005040: 655f 706f 7369 7469 6f6e 2829 2020 2020  e_position()    
+00005050: 2020 200a 0a20 2020 2020 2020 2063 7572     ..        cur
+00005060: 7265 6e74 5f6d 6963 726f 7363 6f70 655f  rent_microscope_
+00005070: 7374 6174 6520 3d20 4d69 6372 6f73 636f  state = Microsco
+00005080: 7065 5374 6174 6528 0a20 2020 2020 2020  peState(.       
+00005090: 2020 2020 2074 696d 6573 7461 6d70 3d64       timestamp=d
+000050a0: 6174 6574 696d 652e 6461 7465 7469 6d65  atetime.datetime
+000050b0: 2e74 696d 6573 7461 6d70 2864 6174 6574  .timestamp(datet
+000050c0: 696d 652e 6461 7465 7469 6d65 2e6e 6f77  ime.datetime.now
+000050d0: 2829 292c 0a20 2020 2020 2020 2020 2020  ()),.           
+000050e0: 2073 7461 6765 5f70 6f73 6974 696f 6e3d   stage_position=
+000050f0: 7374 6167 655f 706f 7369 7469 6f6e 2c20  stage_position, 
+00005100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005120: 2023 2067 6574 2061 6273 6f6c 7574 6520   # get absolute 
+00005130: 7374 6167 6520 636f 6f72 6469 6e61 7465  stage coordinate
+00005140: 7320 2852 4157 290a 2020 2020 2020 2020  s (RAW).        
+00005150: 2020 2020 656c 6563 7472 6f6e 5f62 6561      electron_bea
+00005160: 6d3d 656c 6563 7472 6f6e 5f62 6561 6d2c  m=electron_beam,
+00005170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005190: 2020 2020 2320 656c 6563 7472 6f6e 2062      # electron b
+000051a0: 6561 6d20 7374 6174 650a 2020 2020 2020  eam state.      
+000051b0: 2020 2020 2020 696f 6e5f 6265 616d 3d69        ion_beam=i
+000051c0: 6f6e 5f62 6561 6d2c 2020 2020 2020 2020  on_beam,        
+000051d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051f0: 2020 2020 2020 2320 696f 6e20 6265 616d        # ion beam
+00005200: 2073 7461 7465 0a20 2020 2020 2020 2020   state.         
+00005210: 2020 2065 6c65 6374 726f 6e5f 6465 7465     electron_dete
+00005220: 6374 6f72 3d65 6c65 6374 726f 6e5f 6465  ctor=electron_de
+00005230: 7465 6374 6f72 2c20 2020 2020 2020 2020  tector,         
+00005240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005250: 2020 2023 2065 6c65 6374 726f 6e20 6265     # electron be
+00005260: 616d 2064 6574 6563 746f 7220 7374 6174  am detector stat
+00005270: 650a 2020 2020 2020 2020 2020 2020 696f  e.            io
+00005280: 6e5f 6465 7465 6374 6f72 3d69 6f6e 5f64  n_detector=ion_d
+00005290: 6574 6563 746f 722c 2020 2020 2020 2020  etector,        
+000052a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000052c0: 696f 6e20 6265 616d 2064 6574 6563 746f  ion beam detecto
+000052d0: 7220 7374 6174 650a 2020 2020 2020 2020  r state.        
+000052e0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+000052f0: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+00005300: 287b 226d 7367 223a 2022 6765 745f 6d69  ({"msg": "get_mi
+00005310: 6372 6f73 636f 7065 5f73 7461 7465 222c  croscope_state",
+00005320: 2022 7374 6174 6522 3a20 6375 7272 656e   "state": curren
+00005330: 745f 6d69 6372 6f73 636f 7065 5f73 7461  t_microscope_sta
+00005340: 7465 2e74 6f5f 6469 6374 2829 7d29 0a0a  te.to_dict()})..
+00005350: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00005360: 7572 7265 6e74 5f6d 6963 726f 7363 6f70  urrent_microscop
+00005370: 655f 7374 6174 650a 0a20 2020 2064 6566  e_state..    def
+00005380: 2073 6574 5f6d 6963 726f 7363 6f70 655f   set_microscope_
+00005390: 7374 6174 6528 7365 6c66 2c20 6d69 6372  state(self, micr
+000053a0: 6f73 636f 7065 5f73 7461 7465 3a20 4d69  oscope_state: Mi
+000053b0: 6372 6f73 636f 7065 5374 6174 6529 202d  croscopeState) -
+000053c0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000053d0: 2222 2252 6573 6574 2074 6865 206d 6963  """Reset the mic
+000053e0: 726f 7363 6f70 6520 7374 6174 6520 746f  roscope state to
+000053f0: 2074 6865 2070 726f 7669 6465 6420 7374   the provided st
+00005400: 6174 652e 2222 220a 2020 2020 2020 2020  ate.""".        
+00005410: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
+00005420: 7365 6c66 2e69 735f 6176 6169 6c61 626c  self.is_availabl
+00005430: 6528 2265 6c65 6374 726f 6e5f 6265 616d  e("electron_beam
+00005440: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00005450: 6966 206d 6963 726f 7363 6f70 655f 7374  if microscope_st
+00005460: 6174 652e 656c 6563 7472 6f6e 5f62 6561  ate.electron_bea
+00005470: 6d20 6973 206e 6f74 204e 6f6e 653a 0a20  m is not None:. 
+00005480: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00005490: 656c 662e 7365 745f 6265 616d 5f73 6574  elf.set_beam_set
+000054a0: 7469 6e67 7328 6d69 6372 6f73 636f 7065  tings(microscope
+000054b0: 5f73 7461 7465 2e65 6c65 6374 726f 6e5f  _state.electron_
+000054c0: 6265 616d 290a 2020 2020 2020 2020 2020  beam).          
+000054d0: 2020 6966 206d 6963 726f 7363 6f70 655f    if microscope_
+000054e0: 7374 6174 652e 656c 6563 7472 6f6e 5f64  state.electron_d
+000054f0: 6574 6563 746f 7220 6973 206e 6f74 204e  etector is not N
+00005500: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00005510: 2020 2020 2073 656c 662e 7365 745f 6465       self.set_de
+00005520: 7465 6374 6f72 5f73 6574 7469 6e67 7328  tector_settings(
+00005530: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+00005540: 2e65 6c65 6374 726f 6e5f 6465 7465 6374  .electron_detect
+00005550: 6f72 2c20 4265 616d 5479 7065 2e45 4c45  or, BeamType.ELE
+00005560: 4354 524f 4e29 0a20 2020 2020 2020 2069  CTRON).        i
+00005570: 6620 7365 6c66 2e69 735f 6176 6169 6c61  f self.is_availa
+00005580: 626c 6528 2269 6f6e 5f62 6561 6d22 293a  ble("ion_beam"):
+00005590: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000055a0: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+000055b0: 2e69 6f6e 5f62 6561 6d20 6973 206e 6f74  .ion_beam is not
+000055c0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000055d0: 2020 2020 2020 2073 656c 662e 7365 745f         self.set_
+000055e0: 6265 616d 5f73 6574 7469 6e67 7328 6d69  beam_settings(mi
+000055f0: 6372 6f73 636f 7065 5f73 7461 7465 2e69  croscope_state.i
+00005600: 6f6e 5f62 6561 6d29 0a20 2020 2020 2020  on_beam).       
+00005610: 2020 2020 2069 6620 6d69 6372 6f73 636f       if microsco
+00005620: 7065 5f73 7461 7465 2e69 6f6e 5f64 6574  pe_state.ion_det
+00005630: 6563 746f 7220 6973 206e 6f74 204e 6f6e  ector is not Non
+00005640: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00005650: 2020 2073 656c 662e 7365 745f 6465 7465     self.set_dete
+00005660: 6374 6f72 5f73 6574 7469 6e67 7328 6d69  ctor_settings(mi
+00005670: 6372 6f73 636f 7065 5f73 7461 7465 2e69  croscope_state.i
+00005680: 6f6e 5f64 6574 6563 746f 722c 2042 6561  on_detector, Bea
+00005690: 6d54 7970 652e 494f 4e29 0a20 2020 2020  mType.ION).     
+000056a0: 2020 2069 6620 7365 6c66 2e69 735f 6176     if self.is_av
+000056b0: 6169 6c61 626c 6528 2273 7461 6765 2229  ailable("stage")
+000056c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000056d0: 6c66 2e73 6166 655f 6162 736f 6c75 7465  lf.safe_absolute
+000056e0: 5f73 7461 6765 5f6d 6f76 656d 656e 7428  _stage_movement(
+000056f0: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+00005700: 2e73 7461 6765 5f70 6f73 6974 696f 6e29  .stage_position)
+00005710: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+00005720: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00005730: 6275 6728 7b22 6d73 6722 3a20 2273 6574  bug({"msg": "set
+00005740: 5f6d 6963 726f 7363 6f70 655f 7374 6174  _microscope_stat
+00005750: 6522 2c20 2273 7461 7465 223a 206d 6963  e", "state": mic
+00005760: 726f 7363 6f70 655f 7374 6174 652e 746f  roscope_state.to
+00005770: 5f64 6963 7428 297d 290a 0a20 2020 2020  _dict()})..     
+00005780: 2020 2072 6574 7572 6e20 2020 2020 2020     return       
+00005790: 2020 2020 2020 0a20 2020 2020 2020 200a        .        .
+000057a0: 2020 2020 6465 6620 6973 5f61 7661 696c      def is_avail
+000057b0: 6162 6c65 2873 656c 662c 2073 7973 7465  able(self, syste
+000057c0: 6d3a 2073 7472 2920 2d3e 2062 6f6f 6c3a  m: str) -> bool:
+000057d0: 0a0a 2020 2020 2020 2020 6966 2073 7973  ..        if sys
+000057e0: 7465 6d20 3d3d 2022 656c 6563 7472 6f6e  tem == "electron
+000057f0: 5f62 6561 6d22 3a0a 2020 2020 2020 2020  _beam":.        
+00005800: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00005810: 7379 7374 656d 2e65 6c65 6374 726f 6e2e  system.electron.
+00005820: 656e 6162 6c65 640a 2020 2020 2020 2020  enabled.        
+00005830: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
+00005840: 696f 6e5f 6265 616d 223a 0a20 2020 2020  ion_beam":.     
+00005850: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00005860: 6c66 2e73 7973 7465 6d2e 696f 6e2e 656e  lf.system.ion.en
+00005870: 6162 6c65 640a 2020 2020 2020 2020 656c  abled.        el
+00005880: 6966 2073 7973 7465 6d20 3d3d 2022 696f  if system == "io
+00005890: 6e5f 706c 6173 6d61 223a 0a20 2020 2020  n_plasma":.     
+000058a0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000058b0: 6c66 2e73 7973 7465 6d2e 696f 6e2e 706c  lf.system.ion.pl
+000058c0: 6173 6d61 0a20 2020 2020 2020 2065 6c69  asma.        eli
+000058d0: 6620 7379 7374 656d 203d 3d20 2273 7461  f system == "sta
+000058e0: 6765 223a 0a20 2020 2020 2020 2020 2020  ge":.           
+000058f0: 2072 6574 7572 6e20 7365 6c66 2e73 7973   return self.sys
+00005900: 7465 6d2e 7374 6167 652e 656e 6162 6c65  tem.stage.enable
+00005910: 640a 2020 2020 2020 2020 656c 6966 2073  d.        elif s
+00005920: 7973 7465 6d20 3d3d 2022 7374 6167 655f  ystem == "stage_
+00005930: 726f 7461 7469 6f6e 223a 0a20 2020 2020  rotation":.     
+00005940: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00005950: 6c66 2e73 7973 7465 6d2e 7374 6167 652e  lf.system.stage.
+00005960: 726f 7461 7469 6f6e 0a20 2020 2020 2020  rotation.       
+00005970: 2065 6c69 6620 7379 7374 656d 203d 3d20   elif system == 
+00005980: 2273 7461 6765 5f74 696c 7422 3a0a 2020  "stage_tilt":.  
+00005990: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000059a0: 2073 656c 662e 7379 7374 656d 2e73 7461   self.system.sta
+000059b0: 6765 2e74 696c 740a 2020 2020 2020 2020  ge.tilt.        
+000059c0: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
+000059d0: 6d61 6e69 7075 6c61 746f 7222 3a0a 2020  manipulator":.  
+000059e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000059f0: 2073 656c 662e 7379 7374 656d 2e6d 616e   self.system.man
+00005a00: 6970 756c 6174 6f72 2e65 6e61 626c 6564  ipulator.enabled
+00005a10: 0a20 2020 2020 2020 2065 6c69 6620 7379  .        elif sy
+00005a20: 7374 656d 203d 3d20 226d 616e 6970 756c  stem == "manipul
+00005a30: 6174 6f72 5f72 6f74 6174 696f 6e22 3a0a  ator_rotation":.
+00005a40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00005a50: 726e 2073 656c 662e 7379 7374 656d 2e6d  rn self.system.m
+00005a60: 616e 6970 756c 6174 6f72 2e72 6f74 6174  anipulator.rotat
+00005a70: 696f 6e0a 2020 2020 2020 2020 656c 6966  ion.        elif
+00005a80: 2073 7973 7465 6d20 3d3d 2022 6d61 6e69   system == "mani
+00005a90: 7075 6c61 746f 725f 7469 6c74 223a 0a20  pulator_tilt":. 
+00005aa0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00005ab0: 6e20 7365 6c66 2e73 7973 7465 6d2e 6d61  n self.system.ma
+00005ac0: 6e69 7075 6c61 746f 722e 7469 6c74 0a20  nipulator.tilt. 
+00005ad0: 2020 2020 2020 2065 6c69 6620 7379 7374         elif syst
+00005ae0: 656d 203d 3d20 2267 6973 223a 0a20 2020  em == "gis":.   
+00005af0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00005b00: 7365 6c66 2e73 7973 7465 6d2e 6769 732e  self.system.gis.
+00005b10: 656e 6162 6c65 640a 2020 2020 2020 2020  enabled.        
+00005b20: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
+00005b30: 6769 735f 6d75 6c74 6963 6865 6d22 3a0a  gis_multichem":.
+00005b40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00005b50: 726e 2073 656c 662e 7379 7374 656d 2e67  rn self.system.g
+00005b60: 6973 2e6d 756c 7469 6368 656d 0a20 2020  is.multichem.   
+00005b70: 2020 2020 2065 6c69 6620 7379 7374 656d       elif system
+00005b80: 203d 3d20 2267 6973 5f73 7075 7474 6572   == "gis_sputter
+00005b90: 5f63 6f61 7465 7222 3a0a 2020 2020 2020  _coater":.      
+00005ba0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00005bb0: 662e 7379 7374 656d 2e67 6973 2e73 7075  f.system.gis.spu
+00005bc0: 7474 6572 5f63 6f61 7465 720a 2020 2020  tter_coater.    
+00005bd0: 0a20 2020 2064 6566 2073 6574 5f61 7661  .    def set_ava
+00005be0: 696c 6162 6c65 2873 656c 662c 2073 7973  ilable(self, sys
+00005bf0: 7465 6d3a 2073 7472 2c20 7661 6c75 653a  tem: str, value:
+00005c00: 2062 6f6f 6c29 202d 3e20 4e6f 6e65 3a0a   bool) -> None:.
+00005c10: 0a20 2020 2020 2020 2069 6620 7379 7374  .        if syst
+00005c20: 656d 203d 3d20 2265 6c65 6374 726f 6e5f  em == "electron_
+00005c30: 6265 616d 223a 0a20 2020 2020 2020 2020  beam":.         
+00005c40: 2020 2073 656c 662e 7379 7374 656d 2e65     self.system.e
+00005c50: 6c65 6374 726f 6e2e 656e 6162 6c65 6420  lectron.enabled 
+00005c60: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
+00005c70: 656c 6966 2073 7973 7465 6d20 3d3d 2022  elif system == "
+00005c80: 696f 6e5f 6265 616d 223a 0a20 2020 2020  ion_beam":.     
+00005c90: 2020 2020 2020 2073 656c 662e 7379 7374         self.syst
+00005ca0: 656d 2e69 6f6e 2e65 6e61 626c 6564 203d  em.ion.enabled =
+00005cb0: 2076 616c 7565 0a20 2020 2020 2020 2065   value.        e
+00005cc0: 6c69 6620 7379 7374 656d 203d 3d20 2269  lif system == "i
+00005cd0: 6f6e 5f70 6c61 736d 6122 3a0a 2020 2020  on_plasma":.    
+00005ce0: 2020 2020 2020 2020 7365 6c66 2e73 7973          self.sys
+00005cf0: 7465 6d2e 696f 6e2e 706c 6173 6d61 203d  tem.ion.plasma =
+00005d00: 2076 616c 7565 0a20 2020 2020 2020 2065   value.        e
+00005d10: 6c69 6620 7379 7374 656d 203d 3d20 2273  lif system == "s
+00005d20: 7461 6765 223a 0a20 2020 2020 2020 2020  tage":.         
+00005d30: 2020 2073 656c 662e 7379 7374 656d 2e73     self.system.s
+00005d40: 7461 6765 2e65 6e61 626c 6564 203d 2076  tage.enabled = v
+00005d50: 616c 7565 0a20 2020 2020 2020 2065 6c69  alue.        eli
+00005d60: 6620 7379 7374 656d 203d 3d20 2273 7461  f system == "sta
+00005d70: 6765 5f72 6f74 6174 696f 6e22 3a0a 2020  ge_rotation":.  
+00005d80: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+00005d90: 7973 7465 6d2e 7374 6167 652e 726f 7461  ystem.stage.rota
+00005da0: 7469 6f6e 203d 2076 616c 7565 0a20 2020  tion = value.   
+00005db0: 2020 2020 2065 6c69 6620 7379 7374 656d       elif system
+00005dc0: 203d 3d20 2273 7461 6765 5f74 696c 7422   == "stage_tilt"
+00005dd0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00005de0: 6c66 2e73 7973 7465 6d2e 7374 6167 652e  lf.system.stage.
+00005df0: 7469 6c74 203d 2076 616c 7565 0a20 2020  tilt = value.   
+00005e00: 2020 2020 2065 6c69 6620 7379 7374 656d       elif system
+00005e10: 203d 3d20 226d 616e 6970 756c 6174 6f72   == "manipulator
+00005e20: 223a 0a20 2020 2020 2020 2020 2020 2073  ":.            s
+00005e30: 656c 662e 7379 7374 656d 2e6d 616e 6970  elf.system.manip
+00005e40: 756c 6174 6f72 2e65 6e61 626c 6564 203d  ulator.enabled =
+00005e50: 2076 616c 7565 0a20 2020 2020 2020 2065   value.        e
+00005e60: 6c69 6620 7379 7374 656d 203d 3d20 226d  lif system == "m
+00005e70: 616e 6970 756c 6174 6f72 5f72 6f74 6174  anipulator_rotat
+00005e80: 696f 6e22 3a0a 2020 2020 2020 2020 2020  ion":.          
+00005e90: 2020 7365 6c66 2e73 7973 7465 6d2e 6d61    self.system.ma
+00005ea0: 6e69 7075 6c61 746f 722e 726f 7461 7469  nipulator.rotati
+00005eb0: 6f6e 203d 2076 616c 7565 0a20 2020 2020  on = value.     
+00005ec0: 2020 2065 6c69 6620 7379 7374 656d 203d     elif system =
+00005ed0: 3d20 226d 616e 6970 756c 6174 6f72 5f74  = "manipulator_t
+00005ee0: 696c 7422 3a0a 2020 2020 2020 2020 2020  ilt":.          
+00005ef0: 2020 7365 6c66 2e73 7973 7465 6d2e 6d61    self.system.ma
+00005f00: 6e69 7075 6c61 746f 722e 7469 6c74 203d  nipulator.tilt =
+00005f10: 2076 616c 7565 0a20 2020 2020 2020 2065   value.        e
+00005f20: 6c69 6620 7379 7374 656d 203d 3d20 2267  lif system == "g
+00005f30: 6973 223a 0a20 2020 2020 2020 2020 2020  is":.           
+00005f40: 2073 656c 662e 7379 7374 656d 2e67 6973   self.system.gis
+00005f50: 2e65 6e61 626c 6564 203d 2076 616c 7565  .enabled = value
+00005f60: 0a20 2020 2020 2020 2065 6c69 6620 7379  .        elif sy
+00005f70: 7374 656d 203d 3d20 2267 6973 5f6d 756c  stem == "gis_mul
+00005f80: 7469 6368 656d 223a 0a20 2020 2020 2020  tichem":.       
+00005f90: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
+00005fa0: 2e67 6973 2e6d 756c 7469 6368 656d 203d  .gis.multichem =
+00005fb0: 2076 616c 7565 0a20 2020 2020 2020 2065   value.        e
+00005fc0: 6c69 6620 7379 7374 656d 203d 3d20 2267  lif system == "g
+00005fd0: 6973 5f73 7075 7474 6572 5f63 6f61 7465  is_sputter_coate
+00005fe0: 7222 3a0a 2020 2020 2020 2020 2020 2020  r":.            
+00005ff0: 7365 6c66 2e73 7973 7465 6d2e 6769 732e  self.system.gis.
+00006000: 7370 7574 7465 725f 636f 6174 6572 203d  sputter_coater =
+00006010: 2076 616c 7565 0a0a 2020 2020 0a20 2020   value..    .   
+00006020: 2064 6566 2061 7070 6c79 5f63 6f6e 6669   def apply_confi
+00006030: 6775 7261 7469 6f6e 2873 656c 662c 2073  guration(self, s
+00006040: 7973 7465 6d5f 7365 7474 696e 6773 3a20  ystem_settings: 
+00006050: 5379 7374 656d 5365 7474 696e 6773 203d  SystemSettings =
+00006060: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
+00006070: 2020 2020 2020 2020 2222 2241 7070 6c79          """Apply
+00006080: 2074 6865 2073 7973 7465 6d20 7365 7474   the system sett
+00006090: 696e 6773 2074 6f20 7468 6520 6d69 6372  ings to the micr
+000060a0: 6f73 636f 7065 2e22 2222 0a20 2020 2020  oscope.""".     
+000060b0: 2020 200a 2020 2020 2020 2020 6c6f 6767     .        logg
+000060c0: 696e 672e 696e 666f 2866 2241 7070 6c79  ing.info(f"Apply
+000060d0: 696e 6720 4d69 6372 6f73 636f 7065 2043  ing Microscope C
+000060e0: 6f6e 6669 6775 7261 7469 6f6e 2e2e 2e22  onfiguration..."
+000060f0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+00006100: 2020 2069 6620 7379 7374 656d 5f73 6574     if system_set
+00006110: 7469 6e67 7320 6973 204e 6f6e 653a 0a20  tings is None:. 
+00006120: 2020 2020 2020 2020 2020 2073 7973 7465             syste
+00006130: 6d5f 7365 7474 696e 6773 203d 2073 656c  m_settings = sel
+00006140: 662e 7379 7374 656d 0a20 2020 2020 2020  f.system.       
+00006150: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00006160: 6f28 6622 5573 696e 6720 6375 7272 656e  o(f"Using curren
+00006170: 7420 7379 7374 656d 2073 6574 7469 6e67  t system setting
+00006180: 732e 2229 0a20 2020 2020 2020 200a 2020  s.").        .  
+00006190: 2020 2020 2020 2320 6170 706c 7920 7468        # apply th
+000061a0: 6520 7379 7374 656d 2073 6574 7469 6e67  e system setting
+000061b0: 730a 2020 2020 2020 2020 6966 2073 656c  s.        if sel
+000061c0: 662e 6973 5f61 7661 696c 6162 6c65 2822  f.is_available("
+000061d0: 656c 6563 7472 6f6e 5f62 6561 6d22 293a  electron_beam"):
+000061e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000061f0: 662e 7365 745f 6265 616d 5f73 7973 7465  f.set_beam_syste
+00006200: 6d5f 7365 7474 696e 6773 2873 7973 7465  m_settings(syste
+00006210: 6d5f 7365 7474 696e 6773 2e65 6c65 6374  m_settings.elect
+00006220: 726f 6e29 0a20 2020 2020 2020 2069 6620  ron).        if 
+00006230: 7365 6c66 2e69 735f 6176 6169 6c61 626c  self.is_availabl
+00006240: 6528 2269 6f6e 5f62 6561 6d22 293a 0a20  e("ion_beam"):. 
+00006250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00006260: 7365 745f 6265 616d 5f73 7973 7465 6d5f  set_beam_system_
+00006270: 7365 7474 696e 6773 2873 7973 7465 6d5f  settings(system_
+00006280: 7365 7474 696e 6773 2e69 6f6e 290a 0a20  settings.ion).. 
+00006290: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+000062a0: 735f 6176 6169 6c61 626c 6528 2273 7461  s_available("sta
+000062b0: 6765 2229 3a0a 2020 2020 2020 2020 2020  ge"):.          
+000062c0: 2020 7365 6c66 2e73 7973 7465 6d2e 7374    self.system.st
+000062d0: 6167 6520 3d20 7379 7374 656d 5f73 6574  age = system_set
+000062e0: 7469 6e67 732e 7374 6167 650a 0a20 2020  tings.stage..   
+000062f0: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
+00006300: 6176 6169 6c61 626c 6528 226d 616e 6970  available("manip
+00006310: 756c 6174 6f72 2229 3a0a 2020 2020 2020  ulator"):.      
+00006320: 2020 2020 2020 7365 6c66 2e73 7973 7465        self.syste
+00006330: 6d2e 6d61 6e69 7075 6c61 746f 7220 3d20  m.manipulator = 
+00006340: 7379 7374 656d 5f73 6574 7469 6e67 732e  system_settings.
+00006350: 6d61 6e69 7075 6c61 746f 720a 0a20 2020  manipulator..   
+00006360: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
+00006370: 6176 6169 6c61 626c 6528 2267 6973 2229  available("gis")
+00006380: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00006390: 6c66 2e73 7973 7465 6d2e 6769 7320 3d20  lf.system.gis = 
+000063a0: 7379 7374 656d 5f73 6574 7469 6e67 732e  system_settings.
+000063b0: 6769 730a 2020 2020 2020 2020 0a20 2020  gis.        .   
+000063c0: 2020 2020 2023 2064 6f6e 7420 7570 6461       # dont upda
+000063d0: 7465 2069 6e66 6f20 2d3e 2072 6561 6420  te info -> read 
+000063e0: 6f6e 6c79 0a20 2020 2020 2020 206c 6f67  only.        log
+000063f0: 6769 6e67 2e69 6e66 6f28 6622 4d69 6372  ging.info(f"Micr
+00006400: 6f73 636f 7065 2063 6f6e 6669 6775 7261  oscope configura
+00006410: 7469 6f6e 2061 7070 6c69 6564 2e22 290a  tion applied.").
+00006420: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00006430: 6465 6275 6728 7b22 6d73 6722 3a20 2261  debug({"msg": "a
+00006440: 7070 6c79 5f63 6f6e 6669 6775 7261 7469  pply_configurati
+00006450: 6f6e 222c 2022 7379 7374 656d 5f73 6574  on", "system_set
+00006460: 7469 6e67 7322 3a20 7379 7374 656d 5f73  tings": system_s
+00006470: 6574 7469 6e67 732e 746f 5f64 6963 7428  ettings.to_dict(
+00006480: 297d 290a 0a20 2020 2040 6162 7374 7261  )})..    @abstra
+00006490: 6374 6d65 7468 6f64 0a20 2020 2064 6566  ctmethod.    def
+000064a0: 2063 6865 636b 5f61 7661 696c 6162 6c65   check_available
+000064b0: 5f76 616c 7565 7328 7365 6c66 2c20 6b65  _values(self, ke
+000064c0: 793a 7374 722c 2076 616c 7565 732c 2062  y:str, values, b
+000064d0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
+000064e0: 7065 203d 204e 6f6e 6529 202d 3e20 626f  pe = None) -> bo
+000064f0: 6f6c 3a0a 2020 2020 2020 2020 7061 7373  ol:.        pass
+00006500: 0a0a 2020 2020 6465 6620 686f 6d65 2873  ..    def home(s
+00006510: 656c 6629 202d 3e20 626f 6f6c 3a0a 2020  elf) -> bool:.  
+00006520: 2020 2020 2020 2222 2248 6f6d 6520 7468        """Home th
+00006530: 6520 7374 6167 652e 2222 220a 2020 2020  e stage.""".    
+00006540: 2020 2020 7365 6c66 2e73 6574 2822 7374      self.set("st
+00006550: 6167 655f 686f 6d65 222c 2054 7275 6529  age_home", True)
+00006560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00006570: 7365 6c66 2e67 6574 2822 7374 6167 655f  self.get("stage_
+00006580: 686f 6d65 6422 290a 0a20 2020 2064 6566  homed")..    def
+00006590: 206c 696e 6b5f 7374 6167 6528 7365 6c66   link_stage(self
+000065a0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+000065b0: 2020 2022 2222 4c69 6e6b 2074 6865 2073     """Link the s
+000065c0: 7461 6765 2074 6f20 7468 6520 776f 726b  tage to the work
+000065d0: 696e 6720 6469 7374 616e 6365 2222 220a  ing distance""".
+000065e0: 2020 2020 2020 2020 7365 6c66 2e73 6574          self.set
+000065f0: 2822 7374 6167 655f 6c69 6e6b 222c 2054  ("stage_link", T
+00006600: 7275 6529 0a20 2020 2020 2020 2072 6574  rue).        ret
+00006610: 7572 6e20 7365 6c66 2e67 6574 2822 7374  urn self.get("st
+00006620: 6167 655f 6c69 6e6b 6564 2229 0a0a 2020  age_linked")..  
+00006630: 2020 6465 6620 7075 6d70 2873 656c 6629    def pump(self)
+00006640: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00006650: 2022 2222 2250 756d 7020 7468 6520 6368   """"Pump the ch
+00006660: 616d 6265 722e 2222 220a 2020 2020 2020  amber.""".      
+00006670: 2020 7365 6c66 2e73 6574 2822 7075 6d70    self.set("pump
+00006680: 5f63 6861 6d62 6572 222c 2054 7275 6529  _chamber", True)
+00006690: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000066a0: 7365 6c66 2e67 6574 2822 6368 616d 6265  self.get("chambe
+000066b0: 725f 7374 6174 6522 290a 0a20 2020 2064  r_state")..    d
+000066c0: 6566 2076 656e 7428 7365 6c66 2920 2d3e  ef vent(self) ->
+000066d0: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
+000066e0: 2256 656e 7420 7468 6520 6368 616d 6265  "Vent the chambe
+000066f0: 722e 2222 220a 2020 2020 2020 2020 7365  r.""".        se
+00006700: 6c66 2e73 6574 2822 7665 6e74 5f63 6861  lf.set("vent_cha
+00006710: 6d62 6572 222c 2054 7275 6529 0a20 2020  mber", True).   
+00006720: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00006730: 2e67 6574 2822 6368 616d 6265 725f 7374  .get("chamber_st
+00006740: 6174 6522 290a 2020 2020 0a20 2020 2064  ate").    .    d
+00006750: 6566 2074 7572 6e5f 6f6e 2873 656c 662c  ef turn_on(self,
+00006760: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00006770: 5479 7065 2920 2d3e 2062 6f6f 6c3a 0a20  Type) -> bool:. 
+00006780: 2020 2020 2020 2022 2222 5475 726e 206f         """Turn o
+00006790: 6e20 7468 6520 7370 6563 6966 6965 6420  n the specified 
+000067a0: 6265 616d 2074 7970 652e 2222 220a 2020  beam type.""".  
+000067b0: 2020 2020 2020 7365 6c66 2e73 6574 2822        self.set("
+000067c0: 6f6e 222c 2054 7275 652c 2062 6561 6d5f  on", True, beam_
+000067d0: 7479 7065 290a 2020 2020 2020 2020 7265  type).        re
+000067e0: 7475 726e 2073 656c 662e 6765 7428 226f  turn self.get("o
+000067f0: 6e22 2c20 6265 616d 5f74 7970 6529 0a0a  n", beam_type)..
+00006800: 2020 2020 6465 6620 7475 726e 5f6f 6666      def turn_off
+00006810: 2873 656c 662c 2062 6561 6d5f 7479 7065  (self, beam_type
+00006820: 3a20 4265 616d 5479 7065 2920 2d3e 2062  : BeamType) -> b
+00006830: 6f6f 6c3a 0a20 2020 2020 2020 2022 5475  ool:.        "Tu
+00006840: 726e 206f 6666 2074 6865 2073 7065 6369  rn off the speci
+00006850: 6669 6564 2062 6561 6d20 7479 7065 2e22  fied beam type."
+00006860: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00006870: 7428 226f 6e22 2c20 4661 6c73 652c 2062  t("on", False, b
+00006880: 6561 6d5f 7479 7065 290a 2020 2020 2020  eam_type).      
+00006890: 2020 7265 7475 726e 2073 656c 662e 6765    return self.ge
+000068a0: 7428 226f 6e22 2c20 6265 616d 5f74 7970  t("on", beam_typ
+000068b0: 6529 0a0a 636c 6173 7320 5468 6572 6d6f  e)..class Thermo
+000068c0: 4d69 6372 6f73 636f 7065 2846 6962 7365  Microscope(Fibse
+000068d0: 6d4d 6963 726f 7363 6f70 6529 3a0a 2020  mMicroscope):.  
+000068e0: 2020 2222 220a 2020 2020 4120 636c 6173    """.    A clas
+000068f0: 7320 7265 7072 6573 656e 7469 6e67 2061  s representing a
+00006900: 2054 6865 726d 6f20 4669 7368 6572 2046   Thermo Fisher F
+00006910: 4942 2d53 454d 206d 6963 726f 7363 6f70  IB-SEM microscop
+00006920: 652e 0a0a 2020 2020 5468 6973 2063 6c61  e...    This cla
+00006930: 7373 2069 6e68 6572 6974 7320 6672 6f6d  ss inherits from
+00006940: 2074 6865 2061 6273 7472 6163 7420 6261   the abstract ba
+00006950: 7365 2063 6c61 7373 2060 4669 6273 656d  se class `Fibsem
+00006960: 4d69 6372 6f73 636f 7065 602c 2077 6869  Microscope`, whi
+00006970: 6368 2064 6566 696e 6573 2074 6865 2063  ch defines the c
+00006980: 6f72 6520 6675 6e63 7469 6f6e 616c 6974  ore functionalit
+00006990: 7920 6f66 2061 0a20 2020 206d 6963 726f  y of a.    micro
+000069a0: 7363 6f70 652e 2049 6e20 6164 6469 7469  scope. In additi
+000069b0: 6f6e 2074 6f20 7468 6520 6d65 7468 6f64  on to the method
+000069c0: 7320 6465 6669 6e65 6420 696e 2074 6865  s defined in the
+000069d0: 2062 6173 6520 636c 6173 732c 2074 6869   base class, thi
+000069e0: 7320 636c 6173 7320 7072 6f76 6964 6573  s class provides
+000069f0: 2061 6464 6974 696f 6e61 6c20 6d65 7468   additional meth
+00006a00: 6f64 7320 7370 6563 6966 6963 0a20 2020  ods specific.   
+00006a10: 2074 6f20 7468 6520 5468 6572 6d6f 2046   to the Thermo F
+00006a20: 6973 6865 7220 4649 422d 5345 4d20 6d69  isher FIB-SEM mi
+00006a30: 6372 6f73 636f 7065 2e0a 0a20 2020 2041  croscope...    A
+00006a40: 7474 7269 6275 7465 733a 0a20 2020 2020  ttributes:.     
+00006a50: 2020 2063 6f6e 6e65 6374 696f 6e20 2853     connection (S
+00006a60: 6462 4d69 6372 6f73 636f 7065 436c 6965  dbMicroscopeClie
+00006a70: 6e74 293a 2054 6865 206d 6963 726f 7363  nt): The microsc
+00006a80: 6f70 6520 636c 6965 6e74 2063 6f6e 6e65  ope client conne
+00006a90: 6374 696f 6e2e 0a0a 2020 2020 496e 6865  ction...    Inhe
+00006aa0: 7269 7465 6420 4d65 7468 6f64 733a 0a20  rited Methods:. 
+00006ab0: 2020 2020 2020 2063 6f6e 6e65 6374 5f74         connect_t
+00006ac0: 6f5f 6d69 6372 6f73 636f 7065 2873 656c  o_microscope(sel
+00006ad0: 662c 2069 705f 6164 6472 6573 733a 2073  f, ip_address: s
+00006ae0: 7472 2c20 706f 7274 3a20 696e 7420 3d20  tr, port: int = 
+00006af0: 3735 3230 2920 2d3e 204e 6f6e 653a 200a  7520) -> None: .
+00006b00: 2020 2020 2020 2020 2020 2020 436f 6e6e              Conn
+00006b10: 6563 7420 746f 2061 2054 6865 726d 6f20  ect to a Thermo 
+00006b20: 4669 7368 6572 206d 6963 726f 7363 6f70  Fisher microscop
+00006b30: 6520 6174 2074 6865 2073 7065 6369 6669  e at the specifi
+00006b40: 6564 2049 5020 6164 6472 6573 7320 616e  ed IP address an
+00006b50: 6420 706f 7274 2e0a 0a20 2020 2020 2020  d port...       
+00006b60: 2064 6973 636f 6e6e 6563 7428 7365 6c66   disconnect(self
+00006b70: 2920 2d3e 204e 6f6e 653a 200a 2020 2020  ) -> None: .    
+00006b80: 2020 2020 2020 2020 4469 7363 6f6e 6e65          Disconne
+00006b90: 6374 7320 7468 6520 6d69 6372 6f73 636f  cts the microsco
+00006ba0: 7065 2063 6c69 656e 7420 636f 6e6e 6563  pe client connec
+00006bb0: 7469 6f6e 2e0a 0a20 2020 2020 2020 2061  tion...        a
+00006bc0: 6371 7569 7265 5f69 6d61 6765 2873 656c  cquire_image(sel
+00006bd0: 662c 2069 6d61 6765 5f73 6574 7469 6e67  f, image_setting
+00006be0: 733a 2049 6d61 6765 5365 7474 696e 6773  s: ImageSettings
+00006bf0: 2920 2d3e 2046 6962 7365 6d49 6d61 6765  ) -> FibsemImage
+00006c00: 3a20 0a20 2020 2020 2020 2020 2020 2041  : .            A
+00006c10: 6371 7569 7265 2061 206e 6577 2069 6d61  cquire a new ima
+00006c20: 6765 2077 6974 6820 7468 6520 7370 6563  ge with the spec
+00006c30: 6966 6965 6420 7365 7474 696e 6773 2e0a  ified settings..
+00006c40: 0a20 2020 2020 2020 206c 6173 745f 696d  .        last_im
+00006c50: 6167 6528 7365 6c66 2c20 6265 616d 5f74  age(self, beam_t
+00006c60: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
+00006c70: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00006c80: 4e29 202d 3e20 4669 6273 656d 496d 6167  N) -> FibsemImag
+00006c90: 653a 200a 2020 2020 2020 2020 2020 2020  e: .            
+00006ca0: 4765 7420 7468 6520 6c61 7374 2070 7265  Get the last pre
+00006cb0: 7669 6f75 736c 7920 6163 7175 6972 6564  viously acquired
+00006cc0: 2069 6d61 6765 2e0a 0a20 2020 2020 2020   image...       
+00006cd0: 2061 7574 6f63 6f6e 7472 6173 7428 7365   autocontrast(se
+00006ce0: 6c66 2c20 6265 616d 5f74 7970 653a 2042  lf, beam_type: B
+00006cf0: 6561 6d54 7970 6529 202d 3e20 4e6f 6e65  eamType) -> None
+00006d00: 3a20 0a20 2020 2020 2020 2020 2020 2041  : .            A
+00006d10: 7574 6f6d 6174 6963 616c 6c79 2061 646a  utomatically adj
+00006d20: 7573 7420 7468 6520 6d69 6372 6f73 636f  ust the microsco
+00006d30: 7065 2069 6d61 6765 2063 6f6e 7472 6173  pe image contras
+00006d40: 7420 666f 7220 7468 6520 7370 6563 6966  t for the specif
+00006d50: 6965 6420 6265 616d 2074 7970 652e 0a0a  ied beam type...
+00006d60: 2020 2020 2020 2020 6175 746f 5f66 6f63          auto_foc
+00006d70: 7573 2873 656c 662c 2062 6561 6d5f 7479  us(self, beam_ty
+00006d80: 7065 3a20 4265 616d 5479 7065 2920 2d3e  pe: BeamType) ->
+00006d90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00006da0: 2020 2041 7574 6f6d 6174 6963 616c 6c79     Automatically
+00006db0: 2061 646a 7573 7420 7468 6520 6d69 6372   adjust the micr
+00006dc0: 6f73 636f 7065 2066 6f63 7573 2066 6f72  oscope focus for
+00006dd0: 2074 6865 2073 7065 6369 6669 6564 2062   the specified b
+00006de0: 6561 6d20 7479 7065 2e0a 0a20 2020 2020  eam type...     
+00006df0: 2020 200a 2020 2020 2020 2020 6265 616d     .        beam
+00006e00: 5f73 6869 6674 2873 656c 662c 2064 783a  _shift(self, dx:
+00006e10: 2066 6c6f 6174 2c20 6479 3a20 666c 6f61   float, dy: floa
+00006e20: 742c 2020 6265 616d 5f74 7970 653a 2042  t,  beam_type: B
+00006e30: 6561 6d54 7970 6529 202d 3e20 4e6f 6e65  eamType) -> None
+00006e40: 3a0a 2020 2020 2020 2020 2020 2020 4164  :.            Ad
+00006e50: 6a75 7374 7320 7468 6520 6265 616d 2073  justs the beam s
+00006e60: 6869 6674 206f 6620 6769 7665 6e20 6265  hift of given be
+00006e70: 616d 2062 6173 6564 206f 6e20 7265 6c61  am based on rela
+00006e80: 7469 7665 2076 616c 7565 7320 7468 6174  tive values that
+00006e90: 2061 7265 2070 726f 7669 6465 642e 0a0a   are provided...
+00006ea0: 2020 2020 2020 2020 6d6f 7665 5f73 7461          move_sta
+00006eb0: 6765 5f61 6273 6f6c 7574 6528 7365 6c66  ge_absolute(self
+00006ec0: 2c20 706f 7369 7469 6f6e 3a20 4669 6273  , position: Fibs
+00006ed0: 656d 5374 6167 6550 6f73 6974 696f 6e29  emStagePosition)
+00006ee0: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
+00006ef0: 7665 2074 6865 2073 7461 6765 2074 6f20  ve the stage to 
+00006f00: 7468 6520 7370 6563 6966 6965 6420 636f  the specified co
+00006f10: 6f72 6469 6e61 7465 732e 0a0a 2020 2020  ordinates...    
+00006f20: 2020 2020 6d6f 7665 5f73 7461 6765 5f72      move_stage_r
+00006f30: 656c 6174 6976 6528 7365 6c66 2c20 706f  elative(self, po
+00006f40: 7369 7469 6f6e 3a20 4669 6273 656d 5374  sition: FibsemSt
+00006f50: 6167 6550 6f73 6974 696f 6e29 3a0a 2020  agePosition):.  
+00006f60: 2020 2020 2020 2020 2020 4d6f 7665 2074            Move t
+00006f70: 6865 2073 7461 6765 2062 7920 7468 6520  he stage by the 
+00006f80: 7370 6563 6966 6965 6420 7265 6c61 7469  specified relati
+00006f90: 7665 206d 6f76 652e 0a0a 2020 2020 2020  ve move...      
+00006fa0: 2020 7374 6162 6c65 5f6d 6f76 6528 7365    stable_move(se
+00006fb0: 6c66 2c20 6478 3a20 666c 6f61 742c 2064  lf, dx: float, d
+00006fc0: 793a 2066 6c6f 6174 2c20 6265 616d 5f74  y: float, beam_t
+00006fd0: 7970 653a 2042 6561 6d54 7970 652c 2920  ype: BeamType,) 
+00006fe0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00006ff0: 2020 2020 2043 616c 6375 6c61 7465 2074       Calculate t
+00007000: 6865 2063 6f72 7265 6374 6564 2073 7461  he corrected sta
+00007010: 6765 206d 6f76 656d 656e 7473 2062 6173  ge movements bas
+00007020: 6564 206f 6e20 7468 6520 6265 616d 5f74  ed on the beam_t
+00007030: 7970 652c 2061 6e64 2074 6865 6e20 6d6f  ype, and then mo
+00007040: 7665 2074 6865 2073 7461 6765 2072 656c  ve the stage rel
+00007050: 6174 6976 656c 792e 0a0a 2020 2020 2020  atively...      
+00007060: 2020 7665 7274 6963 616c 5f6d 6f76 6528    vertical_move(
+00007070: 7365 6c66 2c20 2064 793a 2066 6c6f 6174  self,  dy: float
+00007080: 2c20 6478 3a20 666c 6f61 7420 3d20 302c  , dx: float = 0,
+00007090: 2073 7461 7469 635f 7764 3a20 626f 6f6c   static_wd: bool
+000070a0: 203d 2054 7275 6529 202d 3e20 4e6f 6e65   = True) -> None
+000070b0: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
+000070c0: 7665 2074 6865 2073 7461 6765 2076 6572  ve the stage ver
+000070d0: 7469 6361 6c6c 7920 746f 2063 6f72 7265  tically to corre
+000070e0: 6374 2065 7563 656e 7472 6963 2070 6f69  ct eucentric poi
+000070f0: 6e74 0a20 2020 2020 2020 200a 2020 2020  nt.        .    
+00007100: 2020 2020 6765 745f 6d61 6e69 7075 6c61      get_manipula
+00007110: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
+00007120: 6629 202d 3e20 4669 6273 656d 4d61 6e69  f) -> FibsemMani
+00007130: 7075 6c61 746f 7250 6f73 6974 696f 6e3a  pulatorPosition:
+00007140: 0a20 2020 2020 2020 2020 2020 2047 6574  .            Get
+00007150: 2074 6865 2063 7572 7265 6e74 206d 616e   the current man
+00007160: 6970 756c 6174 6f72 2070 6f73 6974 696f  ipulator positio
+00007170: 6e2e 0a20 2020 2020 2020 200a 2020 2020  n..        .    
+00007180: 2020 2020 696e 7365 7274 5f6d 616e 6970      insert_manip
+00007190: 756c 6174 6f72 2873 656c 662c 206e 616d  ulator(self, nam
+000071a0: 653a 2073 7472 2920 2d3e 204e 6f6e 653a  e: str) -> None:
+000071b0: 0a20 2020 2020 2020 2020 2020 2049 6e73  .            Ins
+000071c0: 6572 7420 7468 6520 6d61 6e69 7075 6c61  ert the manipula
+000071d0: 746f 7220 696e 746f 2074 6865 2073 616d  tor into the sam
+000071e0: 706c 652e 0a20 2020 2020 2020 200a 2020  ple..        .  
+000071f0: 2020 2020 2020 7265 7472 6163 745f 6d61        retract_ma
+00007200: 6e69 7075 6c61 746f 7228 7365 6c66 2920  nipulator(self) 
+00007210: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00007220: 2020 2020 2052 6574 7261 6374 2074 6865       Retract the
+00007230: 206d 616e 6970 756c 6174 6f72 2066 726f   manipulator fro
+00007240: 6d20 7468 6520 7361 6d70 6c65 2e0a 0a20  m the sample... 
+00007250: 2020 2020 2020 206d 6f76 655f 6d61 6e69         move_mani
+00007260: 7075 6c61 746f 725f 7265 6c61 7469 7665  pulator_relative
+00007270: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
+00007280: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+00007290: 6f72 506f 7369 7469 6f6e 2920 2d3e 204e  orPosition) -> N
+000072a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000072b0: 204d 6f76 6520 7468 6520 6d61 6e69 7075   Move the manipu
+000072c0: 6c61 746f 7220 6279 2074 6865 2073 7065  lator by the spe
+000072d0: 6369 6669 6564 2072 656c 6174 6976 6520  cified relative 
+000072e0: 6d6f 7665 2e0a 2020 2020 2020 2020 0a20  move..        . 
+000072f0: 2020 2020 2020 206d 6f76 655f 6d61 6e69         move_mani
+00007300: 7075 6c61 746f 725f 6162 736f 6c75 7465  pulator_absolute
+00007310: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
+00007320: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+00007330: 6f72 506f 7369 7469 6f6e 2920 2d3e 204e  orPosition) -> N
+00007340: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00007350: 204d 6f76 6520 7468 6520 6d61 6e69 7075   Move the manipu
+00007360: 6c61 746f 7220 746f 2074 6865 2073 7065  lator to the spe
+00007370: 6369 6669 6564 2063 6f6f 7264 696e 6174  cified coordinat
+00007380: 6573 2e0a 0a20 2020 2020 2020 206d 6f76  es...        mov
+00007390: 655f 6d61 6e69 7075 6c61 746f 725f 636f  e_manipulator_co
+000073a0: 7272 6563 7465 6428 7365 6c66 2c20 6478  rrected(self, dx
+000073b0: 3a20 666c 6f61 742c 2064 793a 2066 6c6f  : float, dy: flo
+000073c0: 6174 2c20 6265 616d 5f74 7970 653a 2042  at, beam_type: B
+000073d0: 6561 6d54 7970 6529 202d 3e20 4e6f 6e65  eamType) -> None
+000073e0: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
+000073f0: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
+00007400: 6f72 2062 7920 7468 6520 7370 6563 6966  or by the specif
+00007410: 6965 6420 7265 6c61 7469 7665 206d 6f76  ied relative mov
+00007420: 652c 2063 6f72 7265 6374 696e 6720 666f  e, correcting fo
+00007430: 7220 7468 6520 6265 616d 2074 7970 652e  r the beam type.
+00007440: 2020 2020 2020 0a0a 2020 2020 2020 2020        ..        
+00007450: 6d6f 7665 5f6d 616e 6970 756c 6174 6f72  move_manipulator
+00007460: 5f74 6f5f 706f 7369 7469 6f6e 5f6f 6666  _to_position_off
+00007470: 7365 7428 7365 6c66 2c20 6f66 6673 6574  set(self, offset
+00007480: 3a20 4669 6273 656d 4d61 6e69 7075 6c61  : FibsemManipula
+00007490: 746f 7250 6f73 6974 696f 6e2c 206e 616d  torPosition, nam
+000074a0: 653a 2073 7472 2920 2d3e 204e 6f6e 653a  e: str) -> None:
+000074b0: 0a20 2020 2020 2020 2020 2020 204d 6f76  .            Mov
+000074c0: 6520 7468 6520 6d61 6e69 7075 6c61 746f  e the manipulato
+000074d0: 7220 746f 2074 6865 2073 7065 6369 6669  r to the specifi
+000074e0: 6564 2070 6f73 6974 696f 6e20 6f66 6673  ed position offs
+000074f0: 6574 2e0a 0a20 2020 2020 2020 205f 6765  et...        _ge
+00007500: 745f 7361 7665 645f 6d61 6e69 7075 6c61  t_saved_manipula
+00007510: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
+00007520: 662c 206e 616d 653a 2073 7472 2920 2d3e  f, name: str) ->
+00007530: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+00007540: 6f72 506f 7369 7469 6f6e 3a0a 2020 2020  orPosition:.    
+00007550: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
+00007560: 7361 7665 6420 6d61 6e69 7075 6c61 746f  saved manipulato
+00007570: 7220 706f 7369 7469 6f6e 2077 6974 6820  r position with 
+00007580: 7468 6520 7370 6563 6966 6965 6420 6e61  the specified na
+00007590: 6d65 2e0a 0a20 2020 2020 2020 2073 6574  me...        set
+000075a0: 7570 5f6d 696c 6c69 6e67 2873 656c 662c  up_milling(self,
+000075b0: 206d 696c 6c5f 7365 7474 696e 6773 3a20   mill_settings: 
+000075c0: 4669 6273 656d 4d69 6c6c 696e 6753 6574  FibsemMillingSet
+000075d0: 7469 6e67 7329 3a0a 2020 2020 2020 2020  tings):.        
+000075e0: 2020 2020 436f 6e66 6967 7572 6520 7468      Configure th
+000075f0: 6520 6d69 6372 6f73 636f 7065 2066 6f72  e microscope for
+00007600: 206d 696c 6c69 6e67 2075 7369 6e67 2074   milling using t
+00007610: 6865 2069 6f6e 2062 6561 6d2e 0a0a 2020  he ion beam...  
+00007620: 2020 2020 2020 7275 6e5f 6d69 6c6c 696e        run_millin
+00007630: 6728 7365 6c66 2c20 6d69 6c6c 696e 675f  g(self, milling_
+00007640: 6375 7272 656e 743a 2066 6c6f 6174 2c20  current: float, 
+00007650: 6173 796e 6368 3a20 626f 6f6c 203d 2046  asynch: bool = F
+00007660: 616c 7365 293a 0a20 2020 2020 2020 2020  alse):.         
+00007670: 2020 2052 756e 2069 6f6e 2062 6561 6d20     Run ion beam 
+00007680: 6d69 6c6c 696e 6720 7573 696e 6720 7468  milling using th
+00007690: 6520 7370 6563 6966 6965 6420 6d69 6c6c  e specified mill
+000076a0: 696e 6720 6375 7272 656e 742e 0a0a 2020  ing current...  
+000076b0: 2020 2020 2020 7275 6e5f 6d69 6c6c 696e        run_millin
+000076c0: 675f 6472 6966 745f 636f 7272 6563 7465  g_drift_correcte
+000076d0: 6428 7365 6c66 2c20 6d69 6c6c 696e 675f  d(self, milling_
+000076e0: 6375 7272 656e 743a 2066 6c6f 6174 2c20  current: float, 
+000076f0: 6d69 6c6c 696e 675f 766f 6c74 6167 653a  milling_voltage:
+00007700: 2066 6c6f 6174 2c20 7265 665f 696d 6167   float, ref_imag
+00007710: 653a 2046 6962 7365 6d49 6d61 6765 293a  e: FibsemImage):
+00007720: 0a20 2020 2020 2020 2020 2020 2052 756e  .            Run
+00007730: 2069 6f6e 2062 6561 6d20 6d69 6c6c 696e   ion beam millin
+00007740: 6720 7573 696e 6720 7468 6520 7370 6563  g using the spec
+00007750: 6966 6965 6420 6d69 6c6c 696e 6720 6375  ified milling cu
+00007760: 7272 656e 742c 2061 6e64 2063 6f72 7265  rrent, and corre
+00007770: 6374 2066 6f72 2064 7269 6674 2075 7369  ct for drift usi
+00007780: 6e67 2074 6865 2070 726f 7669 6465 6420  ng the provided 
+00007790: 7265 6665 7265 6e63 6520 696d 6167 652e  reference image.
+000077a0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+000077b0: 2020 6669 6e69 7368 5f6d 696c 6c69 6e67    finish_milling
+000077c0: 2873 656c 662c 2069 6d61 6769 6e67 5f63  (self, imaging_c
+000077d0: 7572 7265 6e74 3a20 666c 6f61 7429 3a0a  urrent: float):.
+000077e0: 2020 2020 2020 2020 2020 2020 4669 6e61              Fina
+000077f0: 6c69 7365 7320 7468 6520 6d69 6c6c 696e  lises the millin
+00007800: 6720 7072 6f63 6573 7320 6279 2063 6c65  g process by cle
+00007810: 6172 696e 6720 7468 6520 6d69 6372 6f73  aring the micros
+00007820: 636f 7065 206f 6620 616e 7920 7061 7474  cope of any patt
+00007830: 6572 6e73 2061 6e64 2072 6574 7572 6e69  erns and returni
+00007840: 6e67 2074 6865 2063 7572 7265 6e74 2074  ng the current t
+00007850: 6f20 7468 6520 696d 6167 696e 6720 6375  o the imaging cu
+00007860: 7272 656e 742e 0a0a 2020 2020 2020 2020  rrent...        
+00007870: 7365 7475 705f 7370 7574 7465 7228 7365  setup_sputter(se
+00007880: 6c66 2c20 7072 6f74 6f63 6f6c 3a20 6469  lf, protocol: di
+00007890: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
+000078a0: 2053 6574 2075 7020 7468 6520 7370 7574   Set up the sput
+000078b0: 7465 7220 636f 6174 696e 6720 7072 6f63  ter coating proc
+000078c0: 6573 7320 6f6e 2074 6865 206d 6963 726f  ess on the micro
+000078d0: 7363 6f70 652e 0a0a 2020 2020 2020 2020  scope...        
+000078e0: 6472 6177 5f73 7075 7474 6572 5f70 6174  draw_sputter_pat
+000078f0: 7465 726e 2873 656c 662c 2068 6677 3a20  tern(self, hfw: 
+00007900: 666c 6f61 742c 206c 696e 655f 7061 7474  float, line_patt
+00007910: 6572 6e5f 6c65 6e67 7468 3a20 666c 6f61  ern_length: floa
+00007920: 742c 2073 7075 7474 6572 5f74 696d 653a  t, sputter_time:
+00007930: 2066 6c6f 6174 293a 0a20 2020 2020 2020   float):.       
+00007940: 2020 2020 2044 7261 7773 2061 206c 696e       Draws a lin
+00007950: 6520 7061 7474 6572 6e20 666f 7220 7370  e pattern for sp
+00007960: 7574 7465 7269 6e67 2077 6974 6820 7468  uttering with th
+00007970: 6520 6769 7665 6e20 7061 7261 6d65 7465  e given paramete
+00007980: 7273 2e0a 0a20 2020 2020 2020 2072 756e  rs...        run
+00007990: 5f73 7075 7474 6572 2873 656c 662c 202a  _sputter(self, *
+000079a0: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+000079b0: 2020 2020 2020 5275 6e73 2074 6865 2047        Runs the G
+000079c0: 4953 2050 6c61 7469 6e75 6d20 5370 7574  IS Platinum Sput
+000079d0: 7465 722e 0a0a 2020 2020 2020 2020 6669  ter...        fi
+000079e0: 6e69 7368 5f73 7075 7474 6572 2873 656c  nish_sputter(sel
+000079f0: 662c 2061 7070 6c69 6361 7469 6f6e 5f66  f, application_f
+00007a00: 696c 653a 2073 7472 2920 2d3e 204e 6f6e  ile: str) -> Non
+00007a10: 653a 0a20 2020 2020 2020 2020 2020 2046  e:.            F
+00007a20: 696e 6973 6820 7468 6520 7370 7574 7465  inish the sputte
+00007a30: 7220 7072 6f63 6573 7320 6279 2063 6c65  r process by cle
+00007a40: 6172 696e 6720 7061 7474 6572 6e73 2061  aring patterns a
+00007a50: 6e64 2072 6573 6574 7469 6e67 2062 6561  nd resetting bea
+00007a60: 6d20 616e 6420 696d 6167 696e 6720 7365  m and imaging se
+00007a70: 7474 696e 6773 2e0a 0a20 2020 2020 2020  ttings...       
+00007a80: 2073 6574 5f6d 6963 726f 7363 6f70 655f   set_microscope_
+00007a90: 7374 6174 6528 7365 6c66 2c20 6d69 6372  state(self, micr
+00007aa0: 6f73 636f 7065 5f73 7461 7465 3a20 4d69  oscope_state: Mi
+00007ab0: 6372 6f73 636f 7065 5374 6174 6529 202d  croscopeState) -
+00007ac0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00007ad0: 2020 2020 5265 7365 7420 7468 6520 6d69      Reset the mi
+00007ae0: 6372 6f73 636f 7065 2073 7461 7465 2074  croscope state t
+00007af0: 6f20 7468 6520 7072 6f76 6964 6564 2073  o the provided s
+00007b00: 7461 7465 2e0a 2020 2020 2020 2020 0a20  tate..        . 
+00007b10: 2020 2020 2020 2067 6574 2873 656c 662c         get(self,
+00007b20: 206b 6579 3a73 7472 2c20 6265 616d 5f74   key:str, beam_t
+00007b30: 7970 653a 2042 6561 6d54 7970 6520 3d20  ype: BeamType = 
+00007b40: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
+00007b50: 2020 2052 6574 7572 6e73 2074 6865 2076     Returns the v
+00007b60: 616c 7565 206f 6620 7468 6520 7370 6563  alue of the spec
+00007b70: 6966 6965 6420 6b65 792e 0a0a 2020 2020  ified key...    
+00007b80: 2020 2020 7365 7428 7365 6c66 2c20 6b65      set(self, ke
+00007b90: 793a 2073 7472 2c20 7661 6c75 652c 2062  y: str, value, b
+00007ba0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
+00007bb0: 7065 203d 204e 6f6e 6529 202d 3e20 4e6f  pe = None) -> No
+00007bc0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00007bd0: 5365 7473 2074 6865 2076 616c 7565 206f  Sets the value o
+00007be0: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
+00007bf0: 6b65 792e 0a0a 2020 2020 4e65 7720 6d65  key...    New me
+00007c00: 7468 6f64 733a 0a20 2020 2020 2020 205f  thods:.        _
+00007c10: 5f69 6e69 745f 5f28 7365 6c66 293a 200a  _init__(self): .
+00007c20: 2020 2020 2020 2020 2020 2020 496e 6974              Init
+00007c30: 6961 6c69 7a65 7320 6120 6e65 7720 696e  ializes a new in
+00007c40: 7374 616e 6365 206f 6620 7468 6520 636c  stance of the cl
+00007c50: 6173 732e 0a0a 2020 2020 2020 2020 5f79  ass...        _y
+00007c60: 5f63 6f72 7265 6374 6564 5f73 7461 6765  _corrected_stage
+00007c70: 5f6d 6f76 656d 656e 7428 7365 6c66 2c20  _movement(self, 
+00007c80: 6578 7065 6374 6564 5f79 3a20 666c 6f61  expected_y: floa
+00007c90: 742c 2062 6561 6d5f 7479 7065 3a20 4265  t, beam_type: Be
+00007ca0: 616d 5479 7065 203d 2042 6561 6d54 7970  amType = BeamTyp
+00007cb0: 652e 454c 4543 5452 4f4e 2920 2d3e 2046  e.ELECTRON) -> F
+00007cc0: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
+00007cd0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00007ce0: 4361 6c63 756c 6174 6520 7468 6520 7920  Calculate the y 
+00007cf0: 636f 7272 6563 7465 6420 7374 6167 6520  corrected stage 
+00007d00: 6d6f 7665 6d65 6e74 2c20 636f 7272 6563  movement, correc
+00007d10: 7465 6420 666f 7220 7468 6520 6164 6469  ted for the addi
+00007d20: 7469 6f6e 616c 2074 696c 7420 6f66 2074  tional tilt of t
+00007d30: 6865 2073 616d 706c 6520 686f 6c64 6572  he sample holder
+00007d40: 2028 7072 652d 7469 6c74 2061 6e67 6c65   (pre-tilt angle
+00007d50: 292e 0a20 2020 2022 2222 0a0a 2020 2020  )..    """..    
+00007d60: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00007d70: 662c 2073 7973 7465 6d5f 7365 7474 696e  f, system_settin
+00007d80: 6773 3a20 5379 7374 656d 5365 7474 696e  gs: SystemSettin
+00007d90: 6773 203d 204e 6f6e 6529 3a0a 2020 2020  gs = None):.    
+00007da0: 2020 2020 6966 205f 5448 4552 4d4f 5f41      if _THERMO_A
+00007db0: 5049 5f41 5641 494c 4142 4c45 203d 3d20  PI_AVAILABLE == 
+00007dc0: 4661 6c73 653a 0a20 2020 2020 2020 2020  False:.         
+00007dd0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+00007de0: 6f6e 2822 4175 746f 7363 7269 7074 2028  on("Autoscript (
+00007df0: 5468 6572 6d6f 4669 7368 6572 2920 6e6f  ThermoFisher) no
+00007e00: 7420 696e 7374 616c 6c65 642e 2050 6c65  t installed. Ple
+00007e10: 6173 6520 7365 6520 7468 6520 7573 6572  ase see the user
+00007e20: 2067 7569 6465 2066 6f72 2069 6e73 7461   guide for insta
+00007e30: 6c6c 6174 696f 6e20 696e 7374 7275 6374  llation instruct
+00007e40: 696f 6e73 2e22 2920 2020 2020 2020 2020  ions.")         
+00007e50: 2020 200a 2020 2020 2020 2020 0a20 2020     .        .   
+00007e60: 2020 2020 2023 2063 7265 6174 6520 6d69       # create mi
+00007e70: 6372 6f73 636f 7065 2063 6c69 656e 7420  croscope client 
+00007e80: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00007e90: 6e6e 6563 7469 6f6e 203d 2053 6462 4d69  nnection = SdbMi
+00007ea0: 6372 6f73 636f 7065 436c 6965 6e74 2829  croscopeClient()
+00007eb0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00007ec0: 2020 2320 696e 6974 6961 6c69 7365 2073    # initialise s
+00007ed0: 7973 7465 6d20 7365 7474 696e 6773 0a20  ystem settings. 
+00007ee0: 2020 2020 2020 2073 656c 662e 7379 7374         self.syst
+00007ef0: 656d 3a20 5379 7374 656d 5365 7474 696e  em: SystemSettin
+00007f00: 6773 203d 2073 7973 7465 6d5f 7365 7474  gs = system_sett
+00007f10: 696e 6773 0a0a 2020 2020 2020 2020 2320  ings..        # 
+00007f20: 7573 6572 2c20 6578 7065 7269 6d65 6e74  user, experiment
+00007f30: 206d 6574 6164 6174 610a 2020 2020 2020   metadata.      
+00007f40: 2020 2320 544f 444f 3a20 7265 6d6f 7665    # TODO: remove
+00007f50: 206f 6e63 6520 6462 2069 6e74 6567 7261   once db integra
+00007f60: 7465 640a 2020 2020 2020 2020 7365 6c66  ted.        self
+00007f70: 2e75 7365 7220 3d20 4669 6273 656d 5573  .user = FibsemUs
+00007f80: 6572 2e66 726f 6d5f 656e 7669 726f 6e6d  er.from_environm
+00007f90: 656e 7428 290a 2020 2020 2020 2020 7365  ent().        se
+00007fa0: 6c66 2e65 7870 6572 696d 656e 7420 3d20  lf.experiment = 
+00007fb0: 4669 6273 656d 4578 7065 7269 6d65 6e74  FibsemExperiment
+00007fc0: 2829 0a0a 2020 2020 2020 2020 2320 6c6f  ()..        # lo
+00007fd0: 6767 696e 670a 2020 2020 2020 2020 6c6f  gging.        lo
+00007fe0: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00007ff0: 6722 3a20 2263 7265 6174 655f 6d69 6372  g": "create_micr
+00008000: 6f73 636f 7065 5f63 6c69 656e 7422 2c20  oscope_client", 
+00008010: 2273 7973 7465 6d5f 7365 7474 696e 6773  "system_settings
+00008020: 223a 2073 7973 7465 6d5f 7365 7474 696e  ": system_settin
+00008030: 6773 2e74 6f5f 6469 6374 2829 7d29 0a0a  gs.to_dict()})..
+00008040: 2020 2020 6465 6620 7265 636f 6e6e 6563      def reconnec
+00008050: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
+00008060: 2069 6620 6e6f 7420 6861 7361 7474 7228   if not hasattr(
+00008070: 7365 6c66 2c20 2273 7973 7465 6d22 293a  self, "system"):
+00008080: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00008090: 7365 2045 7863 6570 7469 6f6e 2822 506c  se Exception("Pl
+000080a0: 6561 7365 2063 6f6e 6e65 6374 2074 6f20  ease connect to 
+000080b0: 7468 6520 6d69 6372 6f73 636f 7065 2066  the microscope f
+000080c0: 6972 7374 2229 0a20 2020 2020 2020 200a  irst").        .
+000080d0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+000080e0: 636f 6e6e 6563 7428 290a 2020 2020 2020  connect().      
+000080f0: 2020 7365 6c66 2e63 6f6e 6e65 6374 5f74    self.connect_t
+00008100: 6f5f 6d69 6372 6f73 636f 7065 2873 656c  o_microscope(sel
+00008110: 662e 7379 7374 656d 2e69 6e66 6f2e 6970  f.system.info.ip
+00008120: 5f61 6464 7265 7373 290a 0a20 2020 2064  _address)..    d
+00008130: 6566 2064 6973 636f 6e6e 6563 7428 7365  ef disconnect(se
+00008140: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
+00008150: 662e 636f 6e6e 6563 7469 6f6e 2e64 6973  f.connection.dis
+00008160: 636f 6e6e 6563 7428 290a 2020 2020 2020  connect().      
+00008170: 2020 6465 6c20 7365 6c66 2e63 6f6e 6e65    del self.conne
+00008180: 6374 696f 6e0a 2020 2020 2020 2020 7365  ction.        se
+00008190: 6c66 2e63 6f6e 6e65 6374 696f 6e20 3d20  lf.connection = 
+000081a0: 4e6f 6e65 0a0a 2020 2020 6465 6620 636f  None..    def co
+000081b0: 6e6e 6563 745f 746f 5f6d 6963 726f 7363  nnect_to_microsc
+000081c0: 6f70 6528 7365 6c66 2c20 6970 5f61 6464  ope(self, ip_add
+000081d0: 7265 7373 3a20 7374 722c 2070 6f72 743a  ress: str, port:
+000081e0: 2069 6e74 203d 2037 3532 3029 202d 3e20   int = 7520) -> 
+000081f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+00008200: 220a 2020 2020 2020 2020 436f 6e6e 6563  ".        Connec
+00008210: 7420 746f 2061 2054 6865 726d 6f20 4669  t to a Thermo Fi
+00008220: 7368 6572 206d 6963 726f 7363 6f70 6520  sher microscope 
+00008230: 6174 2074 6865 2073 7065 6369 6669 6564  at the specified
+00008240: 2049 5020 6164 6472 6573 7320 616e 6420   IP address and 
+00008250: 706f 7274 2e0a 0a20 2020 2020 2020 2041  port...        A
+00008260: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00008270: 2069 705f 6164 6472 6573 7320 2873 7472   ip_address (str
+00008280: 293a 2054 6865 2049 5020 6164 6472 6573  ): The IP addres
+00008290: 7320 6f66 2074 6865 206d 6963 726f 7363  s of the microsc
+000082a0: 6f70 6520 746f 2063 6f6e 6e65 6374 2074  ope to connect t
+000082b0: 6f2e 0a20 2020 2020 2020 2020 2020 2070  o..            p
+000082c0: 6f72 7420 2869 6e74 293a 2054 6865 2070  ort (int): The p
+000082d0: 6f72 7420 6e75 6d62 6572 206f 6620 7468  ort number of th
+000082e0: 6520 6d69 6372 6f73 636f 7065 2028 6465  e microscope (de
+000082f0: 6661 756c 743a 2037 3532 3029 2e0a 0a20  fault: 7520)... 
+00008300: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00008310: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
+00008320: 3a20 5468 6973 2066 756e 6374 696f 6e20  : This function 
+00008330: 646f 6573 6e27 7420 7265 7475 726e 2061  doesn't return a
+00008340: 6e79 7468 696e 672e 0a0a 2020 2020 2020  nything...      
+00008350: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+00008360: 2020 2020 2020 4578 6365 7074 696f 6e3a        Exception:
+00008370: 2049 6620 7468 6572 6527 7320 616e 2065   If there's an e
+00008380: 7272 6f72 2077 6869 6c65 2063 6f6e 6e65  rror while conne
+00008390: 6374 696e 6720 746f 2074 6865 206d 6963  cting to the mic
+000083a0: 726f 7363 6f70 652e 0a0a 2020 2020 2020  roscope...      
+000083b0: 2020 4578 616d 706c 653a 0a20 2020 2020    Example:.     
+000083c0: 2020 2020 2020 2054 6f20 636f 6e6e 6563         To connec
+000083d0: 7420 746f 2061 206d 6963 726f 7363 6f70  t to a microscop
+000083e0: 6520 7769 7468 2049 5020 6164 6472 6573  e with IP addres
+000083f0: 7320 3139 322e 3136 382e 302e 3130 2061  s 192.168.0.10 a
+00008400: 6e64 2070 6f72 7420 3735 3230 3a0a 0a20  nd port 7520:.. 
+00008410: 2020 2020 2020 2020 2020 203e 3e3e 206d             >>> m
+00008420: 6963 726f 7363 6f70 6520 3d20 5468 6572  icroscope = Ther
+00008430: 6d6f 4d69 6372 6f73 636f 7065 2829 0a20  moMicroscope(). 
+00008440: 2020 2020 2020 2020 2020 203e 3e3e 206d             >>> m
+00008450: 6963 726f 7363 6f70 652e 636f 6e6e 6563  icroscope.connec
+00008460: 745f 746f 5f6d 6963 726f 7363 6f70 6528  t_to_microscope(
+00008470: 2231 3932 2e31 3638 2e30 2e31 3022 2c20  "192.168.0.10", 
+00008480: 3735 3230 290a 0a20 2020 2020 2020 2022  7520)..        "
+00008490: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
+000084a0: 6c66 2e63 6f6e 6e65 6374 696f 6e20 6973  lf.connection is
+000084b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000084c0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+000084d0: 6f6e 203d 2053 6462 4d69 6372 6f73 636f  on = SdbMicrosco
+000084e0: 7065 436c 6965 6e74 2829 0a0a 2020 2020  peClient()..    
+000084f0: 2020 2020 2320 544f 444f 3a20 6765 7420      # TODO: get 
+00008500: 7468 6520 706f 7274 0a20 2020 2020 2020  the port.       
+00008510: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+00008520: 4d69 6372 6f73 636f 7065 2063 6c69 656e  Microscope clien
+00008530: 7420 636f 6e6e 6563 7469 6e67 2074 6f20  t connecting to 
+00008540: 5b7b 6970 5f61 6464 7265 7373 7d3a 7b70  [{ip_address}:{p
+00008550: 6f72 747d 5d22 290a 2020 2020 2020 2020  ort}]").        
+00008560: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00008570: 636f 6e6e 6563 7428 686f 7374 3d69 705f  connect(host=ip_
+00008580: 6164 6472 6573 732c 2070 6f72 743d 706f  address, port=po
+00008590: 7274 290a 2020 2020 2020 2020 6c6f 6767  rt).        logg
+000085a0: 696e 672e 696e 666f 2866 224d 6963 726f  ing.info(f"Micro
+000085b0: 7363 6f70 6520 636c 6965 6e74 2063 6f6e  scope client con
+000085c0: 6e65 6374 6564 2074 6f20 5b7b 6970 5f61  nected to [{ip_a
+000085d0: 6464 7265 7373 7d3a 7b70 6f72 747d 5d22  ddress}:{port}]"
+000085e0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+000085f0: 2020 2023 2073 7973 7465 6d20 696e 666f     # system info
+00008600: 726d 6174 696f 6e0a 2020 2020 2020 2020  rmation.        
+00008610: 7365 6c66 2e73 7973 7465 6d2e 696e 666f  self.system.info
+00008620: 2e6d 6f64 656c 203d 2073 656c 662e 636f  .model = self.co
+00008630: 6e6e 6563 7469 6f6e 2e73 6572 7669 6365  nnection.service
+00008640: 2e73 7973 7465 6d2e 6e61 6d65 0a20 2020  .system.name.   
+00008650: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
+00008660: 2e69 6e66 6f2e 7365 7269 616c 5f6e 756d  .info.serial_num
+00008670: 6265 7220 3d20 7365 6c66 2e63 6f6e 6e65  ber = self.conne
+00008680: 6374 696f 6e2e 7365 7276 6963 652e 7379  ction.service.sy
+00008690: 7374 656d 2e73 6572 6961 6c5f 6e75 6d62  stem.serial_numb
+000086a0: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+000086b0: 7379 7374 656d 2e69 6e66 6f2e 6861 7264  system.info.hard
+000086c0: 7761 7265 5f76 6572 7369 6f6e 203d 2073  ware_version = s
+000086d0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
+000086e0: 6572 7669 6365 2e73 7973 7465 6d2e 7665  ervice.system.ve
+000086f0: 7273 696f 6e0a 2020 2020 2020 2020 7365  rsion.        se
+00008700: 6c66 2e73 7973 7465 6d2e 696e 666f 2e73  lf.system.info.s
+00008710: 6f66 7477 6172 655f 7665 7273 696f 6e20  oftware_version 
+00008720: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+00008730: 6e2e 7365 7276 6963 652e 6175 746f 7363  n.service.autosc
+00008740: 7269 7074 2e63 6c69 656e 742e 7665 7273  ript.client.vers
+00008750: 696f 6e0a 2020 2020 2020 2020 696e 666f  ion.        info
+00008760: 203d 2073 656c 662e 7379 7374 656d 2e69   = self.system.i
+00008770: 6e66 6f0a 2020 2020 2020 2020 6c6f 6767  nfo.        logg
+00008780: 696e 672e 696e 666f 2866 224d 6963 726f  ing.info(f"Micro
+00008790: 7363 6f70 6520 636c 6965 6e74 2063 6f6e  scope client con
+000087a0: 6e65 6374 6564 2074 6f20 6d6f 6465 6c20  nected to model 
+000087b0: 7b69 6e66 6f2e 6d6f 6465 6c7d 2077 6974  {info.model} wit
+000087c0: 6820 7365 7269 616c 206e 756d 6265 7220  h serial number 
+000087d0: 7b69 6e66 6f2e 7365 7269 616c 5f6e 756d  {info.serial_num
+000087e0: 6265 727d 2061 6e64 2073 6f66 7477 6172  ber} and softwar
+000087f0: 6520 7665 7273 696f 6e20 7b69 6e66 6f2e  e version {info.
+00008800: 736f 6674 7761 7265 5f76 6572 7369 6f6e  software_version
+00008810: 7d2e 2229 0a20 2020 2020 2020 200a 2020  }.").        .  
+00008820: 2020 2020 2020 2320 6175 746f 7363 7269        # autoscri
+00008830: 7074 2069 6e66 6f72 6d61 7469 6f6e 0a20  pt information. 
+00008840: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00008850: 6e66 6f28 6622 4175 746f 7363 7269 7074  nfo(f"Autoscript
+00008860: 2043 6c69 656e 743a 207b 7365 6c66 2e63   Client: {self.c
+00008870: 6f6e 6e65 6374 696f 6e2e 7365 7276 6963  onnection.servic
+00008880: 652e 6175 746f 7363 7269 7074 2e63 6c69  e.autoscript.cli
+00008890: 656e 742e 7665 7273 696f 6e7d 2229 0a20  ent.version}"). 
+000088a0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+000088b0: 6e66 6f28 6622 4175 746f 7363 7269 7074  nfo(f"Autoscript
+000088c0: 2053 6572 7665 723a 207b 7365 6c66 2e63   Server: {self.c
+000088d0: 6f6e 6e65 6374 696f 6e2e 7365 7276 6963  onnection.servic
+000088e0: 652e 6175 746f 7363 7269 7074 2e73 6572  e.autoscript.ser
+000088f0: 7665 722e 7665 7273 696f 6e7d 2229 0a0a  ver.version}")..
+00008900: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+00008910: 6574 5f62 6561 6d5f 7368 6966 7473 2829  et_beam_shifts()
+00008920: 0a0a 2020 2020 2020 2020 2320 6173 7369  ..        # assi
+00008930: 676e 2073 7461 6765 0a20 2020 2020 2020  gn stage.       
+00008940: 2069 6620 7365 6c66 2e63 6f6e 6e65 6374   if self.connect
+00008950: 696f 6e2e 7370 6563 696d 656e 2e63 6f6d  ion.specimen.com
+00008960: 7075 7374 6167 652e 6973 5f69 6e73 7461  pustage.is_insta
+00008970: 6c6c 6564 3a0a 2020 2020 2020 2020 2020  lled:.          
+00008980: 2020 7365 6c66 2e73 7461 6765 203d 2073    self.stage = s
+00008990: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
+000089a0: 7065 6369 6d65 6e2e 636f 6d70 7573 7461  pecimen.compusta
+000089b0: 6765 0a20 2020 2020 2020 2020 2020 2073  ge.            s
+000089c0: 656c 662e 7374 6167 655f 6973 5f63 6f6d  elf.stage_is_com
+000089d0: 7075 7374 6167 6520 3d20 5472 7565 0a20  pustage = True. 
+000089e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000089f0: 5f64 6566 6175 6c74 5f73 7461 6765 5f63  _default_stage_c
+00008a00: 6f6f 7264 696e 6174 655f 7379 7374 656d  oordinate_system
+00008a10: 203d 2043 6f6f 7264 696e 6174 6553 7973   = CoordinateSys
+00008a20: 7465 6d2e 5350 4543 494d 454e 0a20 2020  tem.SPECIMEN.   
+00008a30: 2020 2020 2065 6c69 6620 7365 6c66 2e63       elif self.c
+00008a40: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
+00008a50: 656e 2e73 7461 6765 2e69 735f 696e 7374  en.stage.is_inst
+00008a60: 616c 6c65 643a 2020 2020 2020 2020 2020  alled:          
+00008a70: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00008a80: 662e 7374 6167 6520 3d20 7365 6c66 2e63  f.stage = self.c
+00008a90: 6f6e 6e65 6374 696f 6e2e 7370 6563 696d  onnection.specim
+00008aa0: 656e 2e73 7461 6765 0a20 2020 2020 2020  en.stage.       
+00008ab0: 2020 2020 2073 656c 662e 7374 6167 655f       self.stage_
+00008ac0: 6973 5f63 6f6d 7075 7374 6167 6520 3d20  is_compustage = 
+00008ad0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00008ae0: 2020 7365 6c66 2e5f 6465 6661 756c 745f    self._default_
+00008af0: 7374 6167 655f 636f 6f72 6469 6e61 7465  stage_coordinate
+00008b00: 5f73 7973 7465 6d20 3d20 436f 6f72 6469  _system = Coordi
+00008b10: 6e61 7465 5379 7374 656d 2e52 4157 0a20  nateSystem.RAW. 
+00008b20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00008b30: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+00008b40: 6167 6520 3d20 4e6f 6e65 0a20 2020 2020  age = None.     
+00008b50: 2020 2020 2020 2073 656c 662e 7374 6167         self.stag
+00008b60: 655f 6973 5f63 6f6d 7075 7374 6167 6520  e_is_compustage 
+00008b70: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00008b80: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+00008b90: 696e 6728 6622 4e6f 2073 7461 6765 2069  ing(f"No stage i
+00008ba0: 7320 696e 7374 616c 6c65 6420 6f6e 2074  s installed on t
+00008bb0: 6865 206d 6963 726f 7363 6f70 652e 2229  he microscope.")
+00008bc0: 0a0a 2020 2020 2020 2020 2320 7365 7420  ..        # set 
+00008bd0: 6465 6661 756c 7420 636f 6f72 6469 6e61  default coordina
+00008be0: 7465 2073 7973 7465 6d0a 2020 2020 2020  te system.      
+00008bf0: 2020 7365 6c66 2e73 7461 6765 2e73 6574    self.stage.set
+00008c00: 5f64 6566 6175 6c74 5f63 6f6f 7264 696e  _default_coordin
+00008c10: 6174 655f 7379 7374 656d 2873 656c 662e  ate_system(self.
+00008c20: 5f64 6566 6175 6c74 5f73 7461 6765 5f63  _default_stage_c
+00008c30: 6f6f 7264 696e 6174 655f 7379 7374 656d  oordinate_system
+00008c40: 290a 2020 2020 2020 2020 2320 544f 444f  ).        # TODO
+00008c50: 3a20 7365 7420 6465 6661 756c 7420 6d6f  : set default mo
+00008c60: 7665 2073 6574 7469 6e67 732c 2069 7320  ve settings, is 
+00008c70: 7468 6973 2064 6570 656e 6465 6e74 206f  this dependent o
+00008c80: 6e20 7468 6520 7374 6167 6520 7479 7065  n the stage type
+00008c90: 3f0a 0a20 2020 2020 2020 200a 2020 2020  ?..        .    
+00008ca0: 6465 6620 6163 7175 6972 655f 696d 6167  def acquire_imag
+00008cb0: 6528 7365 6c66 2c20 696d 6167 655f 7365  e(self, image_se
+00008cc0: 7474 696e 6773 3a49 6d61 6765 5365 7474  ttings:ImageSett
+00008cd0: 696e 6773 2920 2d3e 2046 6962 7365 6d49  ings) -> FibsemI
+00008ce0: 6d61 6765 3a0a 2020 2020 2020 2020 2222  mage:.        ""
+00008cf0: 220a 2020 2020 2020 2020 4163 7175 6972  ".        Acquir
+00008d00: 6520 6120 6e65 7720 696d 6167 6520 7769  e a new image wi
+00008d10: 7468 2074 6865 2073 7065 6369 6669 6564  th the specified
+00008d20: 2073 6574 7469 6e67 732e 0a0a 2020 2020   settings...    
+00008d30: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00008d40: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+00008d50: 7365 7474 696e 6773 2028 496d 6167 6553  settings (ImageS
+00008d60: 6574 7469 6e67 7329 3a20 5468 6520 7365  ettings): The se
+00008d70: 7474 696e 6773 2066 6f72 2074 6865 206e  ttings for the n
+00008d80: 6577 2069 6d61 6765 2e0a 0a20 2020 2020  ew image...     
+00008d90: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00008da0: 2020 2020 2020 2020 4669 6273 656d 496d          FibsemIm
+00008db0: 6167 653a 2041 206e 6577 2046 6962 7365  age: A new Fibse
+00008dc0: 6d49 6d61 6765 206f 626a 6563 7420 7265  mImage object re
+00008dd0: 7072 6573 656e 7469 6e67 2074 6865 2061  presenting the a
+00008de0: 6371 7569 7265 6420 696d 6167 652e 0a20  cquired image.. 
+00008df0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00008e00: 2020 2020 2320 6368 6563 6b20 6265 616d      # check beam
+00008e10: 2065 6e61 626c 650a 2020 2020 2020 2020   enable.        
+00008e20: 5f63 6865 636b 5f62 6561 6d28 696d 6167  _check_beam(imag
+00008e30: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
+00008e40: 7479 7065 2c20 7365 6c66 2e73 7973 7465  type, self.syste
+00008e50: 6d29 0a20 2020 2020 2020 200a 2020 2020  m).        .    
+00008e60: 2020 2020 2320 6765 7420 7468 6520 6265      # get the be
+00008e70: 616d 2061 7069 0a20 2020 2020 2020 2062  am api.        b
+00008e80: 6561 6d20 3d20 2873 656c 662e 636f 6e6e  eam = (self.conn
+00008e90: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
+00008ea0: 6374 726f 6e5f 6265 616d 200a 2020 2020  ctron_beam .    
+00008eb0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00008ec0: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+00008ed0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+00008ee0: 7970 652e 454c 4543 5452 4f4e 200a 2020  ype.ELECTRON .  
+00008ef0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00008f00: 7365 2073 656c 662e 636f 6e6e 6563 7469  se self.connecti
+00008f10: 6f6e 2e62 6561 6d73 2e69 6f6e 5f62 6561  on.beams.ion_bea
+00008f20: 6d29 0a20 2020 2020 2020 2020 2020 200a  m).            .
+00008f30: 2020 2020 2020 2020 2320 7365 7420 7265          # set re
+00008f40: 6475 6365 6420 6172 6561 2073 6574 7469  duced area setti
+00008f50: 6e67 730a 2020 2020 2020 2020 6966 2069  ngs.        if i
+00008f60: 6d61 6765 5f73 6574 7469 6e67 732e 7265  mage_settings.re
+00008f70: 6475 6365 645f 6172 6561 2069 7320 6e6f  duced_area is no
+00008f80: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00008f90: 2020 2020 7265 6475 6365 645f 6172 6561      reduced_area
+00008fa0: 203d 2069 6d61 6765 5f73 6574 7469 6e67   = image_setting
+00008fb0: 732e 7265 6475 6365 645f 6172 6561 2e5f  s.reduced_area._
+00008fc0: 5f74 6f5f 4645 495f 5f28 290a 2020 2020  _to_FEI__().    
+00008fd0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00008fe0: 7761 726e 696e 6728 6622 2d2d 2d2d 2d2d  warning(f"------
+00008ff0: 2d2d 2d2d 2d20 5245 4455 4345 4420 4152  ----- REDUCED AR
+00009000: 4541 3a20 7b72 6564 7563 6564 5f61 7265  EA: {reduced_are
+00009010: 617d 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2229  a} -----------")
+00009020: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00009030: 6769 6e67 2e77 6172 6e69 6e67 2866 222d  ging.warning(f"-
+00009040: 2d2d 2d2d 2d2d 2d2d 2d2d 2042 4541 4d5f  ---------- BEAM_
+00009050: 5459 5045 207b 696d 6167 655f 7365 7474  TYPE {image_sett
+00009060: 696e 6773 2e62 6561 6d5f 7479 7065 7d20  ings.beam_type} 
+00009070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d22 290a 2020  -----------").  
+00009080: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009090: 2020 2020 2020 2020 7265 6475 6365 645f          reduced_
+000090a0: 6172 6561 203d 204e 6f6e 650a 2020 2020  area = None.    
+000090b0: 2020 2020 2020 2020 6265 616d 2e73 6361          beam.sca
+000090c0: 6e6e 696e 672e 6d6f 6465 2e73 6574 5f66  nning.mode.set_f
+000090d0: 756c 6c5f 6672 616d 6528 290a 0a20 2020  ull_frame()..   
+000090e0: 2020 2020 2023 2073 6574 2074 6865 2069       # set the i
+000090f0: 6d61 6769 6e67 2068 6677 0a20 2020 2020  maging hfw.     
+00009100: 2020 2073 656c 662e 7365 7428 2268 6677     self.set("hfw
+00009110: 222c 2069 6d61 6765 5f73 6574 7469 6e67  ", image_setting
+00009120: 732e 6866 772c 2069 6d61 6765 5f73 6574  s.hfw, image_set
+00009130: 7469 6e67 732e 6265 616d 5f74 7970 6529  tings.beam_type)
+00009140: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
+00009150: 672e 696e 666f 2866 2261 6371 7569 7269  g.info(f"acquiri
+00009160: 6e67 206e 6577 207b 696d 6167 655f 7365  ng new {image_se
+00009170: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
+00009180: 2e6e 616d 657d 2069 6d61 6765 2e22 290a  .name} image.").
+00009190: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+000091a0: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
+000091b0: 7365 745f 6163 7469 7665 5f76 6965 7728  set_active_view(
+000091c0: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
+000091d0: 6561 6d5f 7479 7065 2e76 616c 7565 290a  eam_type.value).
+000091e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+000091f0: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
+00009200: 7365 745f 6163 7469 7665 5f64 6576 6963  set_active_devic
+00009210: 6528 696d 6167 655f 7365 7474 696e 6773  e(image_settings
+00009220: 2e62 6561 6d5f 7479 7065 2e76 616c 7565  .beam_type.value
+00009230: 290a 0a20 2020 2020 2020 2023 2073 6574  )..        # set
+00009240: 2074 6865 2069 6d61 6769 6e67 2066 7261   the imaging fra
+00009250: 6d65 2073 6574 7469 6e67 730a 2020 2020  me settings.    
+00009260: 2020 2020 6672 616d 655f 7365 7474 696e      frame_settin
+00009270: 6773 203d 2047 7261 6246 7261 6d65 5365  gs = GrabFrameSe
+00009280: 7474 696e 6773 280a 2020 2020 2020 2020  ttings(.        
+00009290: 2020 2020 7265 736f 6c75 7469 6f6e 3d66      resolution=f
+000092a0: 227b 696d 6167 655f 7365 7474 696e 6773  "{image_settings
+000092b0: 2e72 6573 6f6c 7574 696f 6e5b 305d 7d78  .resolution[0]}x
+000092c0: 7b69 6d61 6765 5f73 6574 7469 6e67 732e  {image_settings.
+000092d0: 7265 736f 6c75 7469 6f6e 5b31 5d7d 222c  resolution[1]}",
+000092e0: 0a20 2020 2020 2020 2020 2020 2064 7765  .            dwe
+000092f0: 6c6c 5f74 696d 653d 696d 6167 655f 7365  ll_time=image_se
+00009300: 7474 696e 6773 2e64 7765 6c6c 5f74 696d  ttings.dwell_tim
+00009310: 652c 0a20 2020 2020 2020 2020 2020 2072  e,.            r
+00009320: 6564 7563 6564 5f61 7265 613d 7265 6475  educed_area=redu
+00009330: 6365 645f 6172 6561 2c0a 2020 2020 2020  ced_area,.      
+00009340: 2020 2020 2020 6c69 6e65 5f69 6e74 6567        line_integ
+00009350: 7261 7469 6f6e 3d69 6d61 6765 5f73 6574  ration=image_set
+00009360: 7469 6e67 732e 6c69 6e65 5f69 6e74 6567  tings.line_integ
+00009370: 7261 7469 6f6e 2c0a 2020 2020 2020 2020  ration,.        
+00009380: 2020 2020 7363 616e 5f69 6e74 6572 6c61      scan_interla
+00009390: 6369 6e67 3d69 6d61 6765 5f73 6574 7469  cing=image_setti
+000093a0: 6e67 732e 7363 616e 5f69 6e74 6572 6c61  ngs.scan_interla
+000093b0: 6369 6e67 2c0a 2020 2020 2020 2020 2020  cing,.          
+000093c0: 2020 6672 616d 655f 696e 7465 6772 6174    frame_integrat
+000093d0: 696f 6e3d 696d 6167 655f 7365 7474 696e  ion=image_settin
+000093e0: 6773 2e66 7261 6d65 5f69 6e74 6567 7261  gs.frame_integra
+000093f0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00009400: 2020 6472 6966 745f 636f 7272 6563 7469    drift_correcti
+00009410: 6f6e 3d69 6d61 6765 5f73 6574 7469 6e67  on=image_setting
+00009420: 732e 6472 6966 745f 636f 7272 6563 7469  s.drift_correcti
+00009430: 6f6e 2c0a 2020 2020 2020 2020 290a 0a20  on,.        ).. 
+00009440: 2020 2020 2020 2069 6d61 6765 203d 2073         image = s
+00009450: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
+00009460: 6d61 6769 6e67 2e67 7261 625f 6672 616d  maging.grab_fram
+00009470: 6528 6672 616d 655f 7365 7474 696e 6773  e(frame_settings
+00009480: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+00009490: 2020 2023 2072 6573 746f 7265 2074 6f20     # restore to 
+000094a0: 6675 6c6c 2066 7261 6d65 2069 6d61 6769  full frame imagi
+000094b0: 6e67 0a20 2020 2020 2020 2069 6620 696d  ng.        if im
+000094c0: 6167 655f 7365 7474 696e 6773 2e72 6564  age_settings.red
+000094d0: 7563 6564 5f61 7265 6120 6973 206e 6f74  uced_area is not
+000094e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000094f0: 2020 2062 6561 6d2e 7363 616e 6e69 6e67     beam.scanning
+00009500: 2e6d 6f64 652e 7365 745f 6675 6c6c 5f66  .mode.set_full_f
+00009510: 7261 6d65 2829 200a 0a20 2020 2020 2020  rame() ..       
+00009520: 2023 2067 6574 2074 6865 206d 6963 726f   # get the micro
+00009530: 7363 6f70 6520 7374 6174 6520 2866 6f72  scope state (for
+00009540: 206d 6574 6164 6174 6129 0a20 2020 2020   metadata).     
+00009550: 2020 2023 2054 4f44 4f3a 2063 6f6e 7665     # TODO: conve
+00009560: 7274 2074 6f20 7573 696e 6720 6672 6f6d  rt to using from
+00009570: 4164 6f72 6e65 6449 6d61 6765 2c20 7765  AdornedImage, we
+00009580: 2064 6f6e 7420 6e65 6564 2074 6f20 6675   dont need to fu
+00009590: 6c6c 2073 7461 7465 0a20 2020 2020 2020  ll state.       
+000095a0: 2023 2077 6520 7368 6f75 6c64 206a 7573   # we should jus
+000095b0: 7420 6765 7420 7468 6520 2773 7461 7465  t get the 'state
+000095c0: 2720 6f66 2074 6865 2069 6d61 6765 2062  ' of the image b
+000095d0: 6561 6d2c 2065 2e67 2e20 7374 6167 652c  eam, e.g. stage,
+000095e0: 2062 6561 6d2c 2064 6574 6563 746f 7220   beam, detector 
+000095f0: 666f 7220 656c 6563 7472 6f6e 0a20 2020  for electron.   
+00009600: 2020 2020 2023 2074 6865 7265 666f 7265       # therefore
+00009610: 2077 6520 646f 6e27 7420 7472 6967 6765   we don't trigge
+00009620: 7220 7468 6520 7669 6577 2074 6f20 7377  r the view to sw
+00009630: 6974 6368 0a20 2020 2020 2020 2073 7461  itch.        sta
+00009640: 7465 203d 2073 656c 662e 6765 745f 6d69  te = self.get_mi
+00009650: 6372 6f73 636f 7065 5f73 7461 7465 2862  croscope_state(b
+00009660: 6561 6d5f 7479 7065 3d69 6d61 6765 5f73  eam_type=image_s
+00009670: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
+00009680: 6529 0a0a 2020 2020 2020 2020 6669 6273  e)..        fibs
+00009690: 656d 5f69 6d61 6765 203d 2046 6962 7365  em_image = Fibse
+000096a0: 6d49 6d61 6765 2e66 726f 6d41 646f 726e  mImage.fromAdorn
+000096b0: 6564 496d 6167 6528 0a20 2020 2020 2020  edImage(.       
+000096c0: 2020 2020 2063 6f70 792e 6465 6570 636f       copy.deepco
+000096d0: 7079 2869 6d61 6765 292c 200a 2020 2020  py(image), .    
+000096e0: 2020 2020 2020 2020 636f 7079 2e64 6565          copy.dee
+000096f0: 7063 6f70 7928 696d 6167 655f 7365 7474  pcopy(image_sett
+00009700: 696e 6773 292c 200a 2020 2020 2020 2020  ings), .        
+00009710: 2020 2020 636f 7079 2e64 6565 7063 6f70      copy.deepcop
+00009720: 7928 7374 6174 6529 2c0a 2020 2020 2020  y(state),.      
+00009730: 2020 290a 0a20 2020 2020 2020 2023 2073    )..        # s
+00009740: 6574 2061 6464 6974 696f 6e61 6c20 6d65  et additional me
+00009750: 7461 6461 7461 0a20 2020 2020 2020 2066  tadata.        f
+00009760: 6962 7365 6d5f 696d 6167 652e 6d65 7461  ibsem_image.meta
+00009770: 6461 7461 2e75 7365 7220 3d20 7365 6c66  data.user = self
+00009780: 2e75 7365 720a 2020 2020 2020 2020 6669  .user.        fi
+00009790: 6273 656d 5f69 6d61 6765 2e6d 6574 6164  bsem_image.metad
+000097a0: 6174 612e 6578 7065 7269 6d65 6e74 203d  ata.experiment =
+000097b0: 2073 656c 662e 6578 7065 7269 6d65 6e74   self.experiment
+000097c0: 0a20 2020 2020 2020 2066 6962 7365 6d5f  .        fibsem_
+000097d0: 696d 6167 652e 6d65 7461 6461 7461 2e73  image.metadata.s
+000097e0: 7973 7465 6d20 3d20 7365 6c66 2e73 7973  ystem = self.sys
+000097f0: 7465 6d0a 0a20 2020 2020 2020 206c 6f67  tem..        log
+00009800: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
+00009810: 223a 2022 6163 7175 6972 655f 696d 6167  ": "acquire_imag
+00009820: 6522 2c20 226d 6574 6164 6174 6122 3a20  e", "metadata": 
+00009830: 6669 6273 656d 5f69 6d61 6765 2e6d 6574  fibsem_image.met
+00009840: 6164 6174 612e 746f 5f64 6963 7428 297d  adata.to_dict()}
+00009850: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00009860: 6e20 6669 6273 656d 5f69 6d61 6765 0a0a  n fibsem_image..
+00009870: 2020 2020 6465 6620 6c61 7374 5f69 6d61      def last_ima
+00009880: 6765 2873 656c 662c 2062 6561 6d5f 7479  ge(self, beam_ty
+00009890: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
+000098a0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+000098b0: 2920 2d3e 2046 6962 7365 6d49 6d61 6765  ) -> FibsemImage
+000098c0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+000098d0: 2020 2020 2020 4765 7420 7468 6520 6c61        Get the la
+000098e0: 7374 2070 7265 7669 6f75 736c 7920 6163  st previously ac
+000098f0: 7175 6972 6564 2069 6d61 6765 2e0a 0a20  quired image... 
+00009900: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00009910: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
+00009920: 7065 2028 4265 616d 5479 7065 2c20 6f70  pe (BeamType, op
+00009930: 7469 6f6e 616c 293a 2054 6865 2069 6d61  tional): The ima
+00009940: 6769 6e67 2062 6561 6d20 7479 7065 206f  ging beam type o
+00009950: 6620 7468 6520 6c61 7374 2069 6d61 6765  f the last image
+00009960: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009970: 2020 4465 6661 756c 7473 2074 6f20 4265    Defaults to Be
+00009980: 616d 5479 7065 2e45 4c45 4354 524f 4e2e  amType.ELECTRON.
+00009990: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+000099a0: 733a 0a20 2020 2020 2020 2020 2020 2046  s:.            F
+000099b0: 6962 7365 6d49 6d61 6765 3a20 4120 6e65  ibsemImage: A ne
+000099c0: 7720 4669 6273 656d 496d 6167 6520 6f62  w FibsemImage ob
+000099d0: 6a65 6374 2072 6570 7265 7365 6e74 696e  ject representin
+000099e0: 6720 7468 6520 6c61 7374 2061 6371 7569  g the last acqui
+000099f0: 7265 6420 696d 6167 652e 0a0a 2020 2020  red image...    
+00009a00: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00009a10: 2020 2020 2020 2020 4578 6365 7074 696f          Exceptio
+00009a20: 6e3a 2049 6620 7468 6572 6527 7320 616e  n: If there's an
+00009a30: 2065 7272 6f72 2077 6869 6c65 2067 6574   error while get
+00009a40: 7469 6e67 2074 6865 206c 6173 7420 696d  ting the last im
+00009a50: 6167 652e 0a20 2020 2020 2020 2022 2222  age..        """
+00009a60: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+00009a70: 6265 616d 2862 6561 6d5f 7479 7065 203d  beam(beam_type =
+00009a80: 2062 6561 6d5f 7479 7065 2c20 7365 7474   beam_type, sett
+00009a90: 696e 6773 203d 2073 656c 662e 7379 7374  ings = self.syst
+00009aa0: 656d 2920 2020 2020 2020 200a 2020 2020  em)        .    
+00009ab0: 2020 2020 0a20 2020 2020 2020 2023 2073      .        # s
+00009ac0: 6574 2061 6374 6976 6520 7669 6577 2061  et active view a
+00009ad0: 6e64 2064 6576 6963 650a 2020 2020 2020  nd device.      
+00009ae0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00009af0: 6e2e 696d 6167 696e 672e 7365 745f 6163  n.imaging.set_ac
+00009b00: 7469 7665 5f76 6965 7728 6265 616d 5f74  tive_view(beam_t
+00009b10: 7970 652e 7661 6c75 6529 0a20 2020 2020  ype.value).     
+00009b20: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00009b30: 6f6e 2e69 6d61 6769 6e67 2e73 6574 5f61  on.imaging.set_a
+00009b40: 6374 6976 655f 6465 7669 6365 2862 6561  ctive_device(bea
+00009b50: 6d5f 7479 7065 2e76 616c 7565 290a 0a20  m_type.value).. 
+00009b60: 2020 2020 2020 2023 2067 6574 2074 6865         # get the
+00009b70: 206c 6173 7420 696d 6167 650a 2020 2020   last image.    
+00009b80: 2020 2020 696d 6167 6520 3d20 7365 6c66      image = self
+00009b90: 2e63 6f6e 6e65 6374 696f 6e2e 696d 6167  .connection.imag
+00009ba0: 696e 672e 6765 745f 696d 6167 6528 290a  ing.get_image().
+00009bb0: 2020 2020 2020 2020 696d 6167 6520 3d20          image = 
+00009bc0: 4164 6f72 6e65 6449 6d61 6765 2864 6174  AdornedImage(dat
+00009bd0: 613d 696d 6167 652e 6461 7461 2e61 7374  a=image.data.ast
+00009be0: 7970 6528 6e70 2e75 696e 7438 292c 206d  ype(np.uint8), m
+00009bf0: 6574 6164 6174 613d 696d 6167 652e 6d65  etadata=image.me
+00009c00: 7461 6461 7461 290a 0a20 2020 2020 2020  tadata)..       
+00009c10: 2023 2067 6574 2074 6865 206d 6963 726f   # get the micro
+00009c20: 7363 6f70 6520 7374 6174 6520 2866 6f72  scope state (for
+00009c30: 206d 6574 6164 6174 6129 0a20 2020 2020   metadata).     
+00009c40: 2020 2073 7461 7465 203d 2073 656c 662e     state = self.
+00009c50: 6765 745f 6d69 6372 6f73 636f 7065 5f73  get_microscope_s
+00009c60: 7461 7465 2862 6561 6d5f 7479 7065 3d62  tate(beam_type=b
+00009c70: 6561 6d5f 7479 7065 290a 0a20 2020 2020  eam_type)..     
+00009c80: 2020 2023 2067 6574 2074 6865 2069 6d61     # get the ima
+00009c90: 6765 2073 6574 7469 6e67 7320 6672 6f6d  ge settings from
+00009ca0: 2074 6865 2069 6d61 6765 0a20 2020 2020   the image.     
+00009cb0: 2020 2069 6d61 6765 5f73 6574 7469 6e67     image_setting
+00009cc0: 7320 3d20 4669 6273 656d 496d 6167 654d  s = FibsemImageM
+00009cd0: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
+00009ce0: 7474 696e 6773 5f66 726f 6d5f 6164 6f72  ttings_from_ador
+00009cf0: 6e65 6428 0a20 2020 2020 2020 2020 2020  ned(.           
+00009d00: 2069 6d61 6765 2c20 6265 616d 5f74 7970   image, beam_typ
+00009d10: 650a 2020 2020 2020 2020 290a 0a20 2020  e.        )..   
+00009d20: 2020 2020 2023 2063 7265 6174 6520 7468       # create th
+00009d30: 6520 6669 6273 656d 2069 6d61 6765 0a20  e fibsem image. 
+00009d40: 2020 2020 2020 2066 6962 7365 6d5f 696d         fibsem_im
+00009d50: 6167 6520 3d20 4669 6273 656d 496d 6167  age = FibsemImag
+00009d60: 652e 6672 6f6d 4164 6f72 6e65 6449 6d61  e.fromAdornedIma
+00009d70: 6765 2869 6d61 6765 2c20 696d 6167 655f  ge(image, image_
+00009d80: 7365 7474 696e 6773 2c20 7374 6174 6529  settings, state)
+00009d90: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00009da0: 2020 2320 7365 7420 6164 6469 7469 6f6e    # set addition
+00009db0: 616c 206d 6574 6164 6174 610a 2020 2020  al metadata.    
+00009dc0: 2020 2020 6669 6273 656d 5f69 6d61 6765      fibsem_image
+00009dd0: 2e6d 6574 6164 6174 612e 7573 6572 203d  .metadata.user =
+00009de0: 2073 656c 662e 7573 6572 0a20 2020 2020   self.user.     
+00009df0: 2020 2066 6962 7365 6d5f 696d 6167 652e     fibsem_image.
+00009e00: 6d65 7461 6461 7461 2e65 7870 6572 696d  metadata.experim
+00009e10: 656e 7420 3d20 7365 6c66 2e65 7870 6572  ent = self.exper
+00009e20: 696d 656e 740a 2020 2020 2020 2020 6669  iment.        fi
+00009e30: 6273 656d 5f69 6d61 6765 2e6d 6574 6164  bsem_image.metad
+00009e40: 6174 612e 7379 7374 656d 203d 2073 656c  ata.system = sel
+00009e50: 662e 7379 7374 656d 0a0a 2020 2020 2020  f.system..      
+00009e60: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
+00009e70: 7b22 6d73 6722 3a20 2261 6371 7569 7265  {"msg": "acquire
+00009e80: 5f69 6d61 6765 222c 2022 6d65 7461 6461  _image", "metada
+00009e90: 7461 223a 2066 6962 7365 6d5f 696d 6167  ta": fibsem_imag
+00009ea0: 652e 6d65 7461 6461 7461 2e74 6f5f 6469  e.metadata.to_di
+00009eb0: 6374 2829 7d29 0a20 2020 200a 2020 2020  ct()}).    .    
+00009ec0: 2020 2020 7265 7475 726e 2066 6962 7365      return fibse
+00009ed0: 6d5f 696d 6167 650a 0a20 2020 2064 6566  m_image..    def
+00009ee0: 2061 6371 7569 7265 5f63 6861 6d62 6572   acquire_chamber
+00009ef0: 5f69 6d61 6765 2873 656c 6629 202d 3e20  _image(self) -> 
+00009f00: 4669 6273 656d 496d 6167 653a 0a20 2020  FibsemImage:.   
+00009f10: 2020 2020 2022 2222 4163 7175 6972 6520       """Acquire 
+00009f20: 616e 2069 6d61 6765 206f 6620 7468 6520  an image of the 
+00009f30: 6368 616d 6265 7220 696e 7369 6465 2e22  chamber inside."
+00009f40: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
+00009f50: 636f 6e6e 6563 7469 6f6e 2e69 6d61 6769  connection.imagi
+00009f60: 6e67 2e73 6574 5f61 6374 6976 655f 7669  ng.set_active_vi
+00009f70: 6577 2834 290a 2020 2020 2020 2020 7365  ew(4).        se
+00009f80: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 696d  lf.connection.im
+00009f90: 6167 696e 672e 7365 745f 6163 7469 7665  aging.set_active
+00009fa0: 5f64 6576 6963 6528 3329 0a20 2020 2020  _device(3).     
+00009fb0: 2020 2069 6d61 6765 203d 2073 656c 662e     image = self.
+00009fc0: 636f 6e6e 6563 7469 6f6e 2e69 6d61 6769  connection.imagi
+00009fd0: 6e67 2e67 6574 5f69 6d61 6765 2829 0a20  ng.get_image(). 
+00009fe0: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00009ff0: 6562 7567 287b 226d 7367 223a 2022 6163  ebug({"msg": "ac
+0000a000: 7175 6972 655f 6368 616d 6265 725f 696d  quire_chamber_im
+0000a010: 6167 6522 7d29 0a20 2020 2020 2020 2072  age"}).        r
+0000a020: 6574 7572 6e20 4669 6273 656d 496d 6167  eturn FibsemImag
+0000a030: 6528 6461 7461 3d69 6d61 6765 2e64 6174  e(data=image.dat
+0000a040: 612c 206d 6574 6164 6174 613d 4e6f 6e65  a, metadata=None
+0000a050: 2920 2020 0a20 2020 200a 2020 2020 6465  )   .    .    de
+0000a060: 6620 6c69 7665 5f69 6d61 6769 6e67 2873  f live_imaging(s
+0000a070: 656c 662c 2069 6d61 6765 5f73 6574 7469  elf, image_setti
+0000a080: 6e67 733a 2049 6d61 6765 5365 7474 696e  ngs: ImageSettin
+0000a090: 6773 2c20 696d 6167 655f 7175 6575 653a  gs, image_queue:
+0000a0a0: 2051 7565 7565 2c20 7374 6f70 5f65 7665   Queue, stop_eve
+0000a0b0: 6e74 3a20 7468 7265 6164 696e 672e 4576  nt: threading.Ev
+0000a0c0: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+0000a0d0: 2020 7365 6c66 2e69 6d61 6765 5f71 7565    self.image_que
+0000a0e0: 7565 203d 2069 6d61 6765 5f71 7565 7565  ue = image_queue
+0000a0f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000a100: 662e 7374 6f70 5f65 7665 6e74 203d 2073  f.stop_event = s
+0000a110: 746f 705f 6576 656e 740a 2020 2020 2020  top_event.      
+0000a120: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+0000a130: 6d28 696d 6167 655f 7365 7474 696e 6773  m(image_settings
+0000a140: 2e62 6561 6d5f 7479 7065 2c20 7365 6c66  .beam_type, self
+0000a150: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
+0000a160: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0000a170: 6f28 6622 4c69 7665 2069 6d61 6769 6e67  o(f"Live imaging
+0000a180: 3a20 7b69 6d61 6765 5f73 6574 7469 6e67  : {image_setting
+0000a190: 732e 6265 616d 5f74 7970 657d 2229 0a20  s.beam_type}"). 
+0000a1a0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+0000a1b0: 206e 6f74 2073 656c 662e 7374 6f70 5f65   not self.stop_e
+0000a1c0: 7665 6e74 2e69 735f 7365 7428 293a 0a20  vent.is_set():. 
+0000a1d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000a1e0: 6d61 6765 203d 2073 656c 662e 6163 7175  mage = self.acqu
+0000a1f0: 6972 655f 696d 6167 6528 6465 6570 636f  ire_image(deepco
+0000a200: 7079 2869 6d61 6765 5f73 6574 7469 6e67  py(image_setting
+0000a210: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0000a220: 2020 2020 696d 6167 655f 7175 6575 652e      image_queue.
+0000a230: 7075 7428 696d 6167 6529 0a0a 0a0a 2020  put(image)....  
+0000a240: 2020 4074 6872 6561 645f 776f 726b 6572    @thread_worker
+0000a250: 0a20 2020 2064 6566 2063 6f6e 7375 6d65  .    def consume
+0000a260: 5f69 6d61 6765 5f71 7565 7565 2873 656c  _image_queue(sel
+0000a270: 662c 2070 6172 656e 745f 7569 203d 204e  f, parent_ui = N
+0000a280: 6f6e 652c 2073 6c65 6570 203d 2030 2e31  one, sleep = 0.1
+0000a290: 293a 0a0a 2020 2020 2020 2020 6c6f 6767  ):..        logg
+0000a2a0: 696e 672e 696e 666f 2822 436f 6e73 756d  ing.info("Consum
+0000a2b0: 696e 6720 696d 6167 6520 7175 6575 6522  ing image queue"
+0000a2c0: 290a 0a20 2020 2020 2020 2077 6869 6c65  )..        while
+0000a2d0: 206e 6f74 2073 656c 662e 7374 6f70 5f65   not self.stop_e
+0000a2e0: 7665 6e74 2e69 735f 7365 7428 293a 0a20  vent.is_set():. 
+0000a2f0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a310: 7469 6d65 2e73 6c65 6570 2873 6c65 6570  time.sleep(sleep
+0000a320: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000a330: 2020 6966 206e 6f74 2073 656c 662e 696d    if not self.im
+0000a340: 6167 655f 7175 6575 652e 656d 7074 7928  age_queue.empty(
+0000a350: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000a360: 2020 2020 2020 2069 6d61 6765 203d 2073         image = s
+0000a370: 656c 662e 696d 6167 655f 7175 6575 652e  elf.image_queue.
+0000a380: 6765 7428 7469 6d65 6f75 743d 3129 0a20  get(timeout=1). 
+0000a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3a0: 2020 2069 6620 696d 6167 652e 6d65 7461     if image.meta
+0000a3b0: 6461 7461 2e69 6d61 6765 5f73 6574 7469  data.image_setti
+0000a3c0: 6e67 732e 7361 7665 3a0a 2020 2020 2020  ngs.save:.      
+0000a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a3e0: 2020 696d 6167 652e 6d65 7461 6461 7461    image.metadata
+0000a3f0: 2e69 6d61 6765 5f73 6574 7469 6e67 732e  .image_settings.
+0000a400: 6669 6c65 6e61 6d65 203d 2066 227b 696d  filename = f"{im
+0000a410: 6167 652e 6d65 7461 6461 7461 2e69 6d61  age.metadata.ima
+0000a420: 6765 5f73 6574 7469 6e67 732e 6669 6c65  ge_settings.file
+0000a430: 6e61 6d65 7d5f 7b75 7469 6c73 2e63 7572  name}_{utils.cur
+0000a440: 7265 6e74 5f74 696d 6573 7461 6d70 2829  rent_timestamp()
+0000a450: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+0000a460: 2020 2020 2020 2020 2020 2066 696c 656e             filen
+0000a470: 616d 6520 3d20 6f73 2e70 6174 682e 6a6f  ame = os.path.jo
+0000a480: 696e 2869 6d61 6765 2e6d 6574 6164 6174  in(image.metadat
+0000a490: 612e 696d 6167 655f 7365 7474 696e 6773  a.image_settings
+0000a4a0: 2e70 6174 682c 2069 6d61 6765 2e6d 6574  .path, image.met
+0000a4b0: 6164 6174 612e 696d 6167 655f 7365 7474  adata.image_sett
+0000a4c0: 696e 6773 2e66 696c 656e 616d 6529 0a20  ings.filename). 
+0000a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4e0: 2020 2020 2020 2069 6d61 6765 2e73 6176         image.sav
+0000a4f0: 6528 7061 7468 3d66 696c 656e 616d 6529  e(path=filename)
+0000a500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a510: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0000a520: 2e69 6e66 6f28 6622 5361 7665 6420 696d  .info(f"Saved im
+0000a530: 6167 6520 746f 207b 6669 6c65 6e61 6d65  age to {filename
+0000a540: 7d22 290a 0a20 2020 2020 2020 2020 2020  }")..           
+0000a550: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0000a560: 2e69 6e66 6f28 6622 496d 6167 653a 207b  .info(f"Image: {
+0000a570: 696d 6167 652e 6461 7461 2e73 6861 7065  image.data.shape
+0000a580: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
+0000a590: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000a5a0: 696e 666f 2866 222d 2220 2a20 3530 290a  info(f"-" * 50).
+0000a5b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a5c0: 2020 2020 2069 6620 7061 7265 6e74 5f75       if parent_u
+0000a5d0: 6920 6973 206e 6f74 204e 6f6e 653a 0a20  i is not None:. 
+0000a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5f0: 2020 2020 2020 2020 2020 2070 6172 656e             paren
+0000a600: 745f 7569 2e6c 6976 655f 696d 6167 696e  t_ui.live_imagin
+0000a610: 675f 7369 676e 616c 2e65 6d69 7428 7b22  g_signal.emit({"
+0000a620: 696d 6167 6522 3a20 696d 6167 657d 290a  image": image}).
+0000a630: 0a0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
+0000a640: 6365 7074 204b 6579 626f 6172 6449 6e74  cept KeyboardInt
+0000a650: 6572 7275 7074 3a0a 2020 2020 2020 2020  errupt:.        
+0000a660: 2020 2020 2020 2020 7365 6c66 2e73 746f          self.sto
+0000a670: 705f 6576 656e 740a 2020 2020 2020 2020  p_event.        
+0000a680: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000a690: 696e 666f 2822 4b65 7962 6f61 7264 2069  info("Keyboard i
+0000a6a0: 6e74 6572 7275 7074 2c20 7374 6f70 7069  nterrupt, stoppi
+0000a6b0: 6e67 206c 6976 6520 696d 6167 696e 6722  ng live imaging"
+0000a6c0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0000a6d0: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0000a6e0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0000a6f0: 2020 2020 2073 656c 662e 7374 6f70 5f65       self.stop_e
+0000a700: 7665 6e74 2e73 6574 2829 0a20 2020 2020  vent.set().     
+0000a710: 2020 2020 2020 2020 2020 2069 6d70 6f72             impor
+0000a720: 7420 7472 6163 6562 6163 6b0a 2020 2020  t traceback.    
+0000a730: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000a740: 696e 672e 6572 726f 7228 7472 6163 6562  ing.error(traceb
+0000a750: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
+0000a760: 290a 0a20 2020 2064 6566 2061 7574 6f63  )..    def autoc
+0000a770: 6f6e 7472 6173 7428 7365 6c66 2c20 6265  ontrast(self, be
+0000a780: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
+0000a790: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+0000a7a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000a7b0: 4175 746f 6d61 7469 6361 6c6c 7920 6164  Automatically ad
+0000a7c0: 6a75 7374 2074 6865 206d 6963 726f 7363  just the microsc
+0000a7d0: 6f70 6520 696d 6167 6520 636f 6e74 7261  ope image contra
+0000a7e0: 7374 2066 6f72 2074 6865 2073 7065 6369  st for the speci
+0000a7f0: 6669 6564 2062 6561 6d20 7479 7065 2e0a  fied beam type..
+0000a800: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+0000a810: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
+0000a820: 7479 7065 2028 4265 616d 5479 7065 2920  type (BeamType) 
+0000a830: 5468 6520 696d 6167 696e 6720 6265 616d  The imaging beam
+0000a840: 2074 7970 6520 666f 7220 7768 6963 6820   type for which 
+0000a850: 746f 2061 646a 7573 7420 7468 6520 636f  to adjust the co
+0000a860: 6e74 7261 7374 2e0a 2020 2020 2020 2020  ntrast..        
+0000a870: 2222 220a 2020 2020 2020 2020 5f63 6865  """.        _che
+0000a880: 636b 5f62 6561 6d28 6265 616d 5f74 7970  ck_beam(beam_typ
+0000a890: 6520 3d20 6265 616d 5f74 7970 652c 2073  e = beam_type, s
+0000a8a0: 6574 7469 6e67 7320 3d20 7365 6c66 2e73  ettings = self.s
+0000a8b0: 7973 7465 6d29 0a20 2020 2020 2020 206c  ystem).        l
+0000a8c0: 6f67 6769 6e67 2e64 6562 7567 2866 2252  ogging.debug(f"R
+0000a8d0: 756e 6e69 6e67 2061 7574 6f63 6f6e 7472  unning autocontr
+0000a8e0: 6173 7420 6f6e 207b 6265 616d 5f74 7970  ast on {beam_typ
+0000a8f0: 652e 6e61 6d65 7d2e 2229 0a20 2020 2020  e.name}.").     
+0000a900: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0000a910: 6f6e 2e69 6d61 6769 6e67 2e73 6574 5f61  on.imaging.set_a
+0000a920: 6374 6976 655f 7669 6577 2862 6561 6d5f  ctive_view(beam_
+0000a930: 7479 7065 2e76 616c 7565 290a 2020 2020  type.value).    
+0000a940: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0000a950: 696f 6e2e 696d 6167 696e 672e 7365 745f  ion.imaging.set_
+0000a960: 6163 7469 7665 5f64 6576 6963 6528 6265  active_device(be
+0000a970: 616d 5f74 7970 652e 7661 6c75 6529 0a20  am_type.value). 
+0000a980: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0000a990: 6563 7469 6f6e 2e61 7574 6f5f 6675 6e63  ection.auto_func
+0000a9a0: 7469 6f6e 732e 7275 6e5f 6175 746f 5f63  tions.run_auto_c
+0000a9b0: 6228 290a 2020 2020 2020 2020 6c6f 6767  b().        logg
+0000a9c0: 696e 672e 6465 6275 6728 7b66 226d 7367  ing.debug({f"msg
+0000a9d0: 223a 2022 6175 746f 636f 6e74 7261 7374  ": "autocontrast
+0000a9e0: 222c 2022 6265 616d 5f74 7970 6522 3a20  ", "beam_type": 
+0000a9f0: 6265 616d 5f74 7970 652e 6e61 6d65 7d29  beam_type.name})
+0000aa00: 0a0a 2020 2020 6465 6620 6175 746f 5f66  ..    def auto_f
+0000aa10: 6f63 7573 2873 656c 662c 2062 6561 6d5f  ocus(self, beam_
+0000aa20: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+0000aa30: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000aa40: 2022 2222 4175 746f 6d61 7469 6361 6c6c   """Automaticall
+0000aa50: 7920 666f 6375 7320 7468 6520 7370 6563  y focus the spec
+0000aa60: 6966 6965 6420 6265 616d 2074 7970 652e  ified beam type.
+0000aa70: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+0000aa80: 2020 2020 2020 2020 2020 2020 6265 616d              beam
+0000aa90: 5f74 7970 6520 2842 6561 6d54 7970 6529  _type (BeamType)
+0000aaa0: 3a20 5468 6520 696d 6167 696e 6720 6265  : The imaging be
+0000aab0: 616d 2074 7970 6520 666f 7220 7768 6963  am type for whic
+0000aac0: 6820 746f 2066 6f63 7573 2e0a 2020 2020  h to focus..    
+0000aad0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000aae0: 5f63 6865 636b 5f62 6561 6d28 6265 616d  _check_beam(beam
+0000aaf0: 5f74 7970 6520 3d20 6265 616d 5f74 7970  _type = beam_typ
+0000ab00: 652c 2073 6574 7469 6e67 7320 3d20 7365  e, settings = se
+0000ab10: 6c66 2e73 7973 7465 6d29 0a20 2020 2020  lf.system).     
+0000ab20: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+0000ab30: 2866 2252 756e 6e69 6e67 2061 7574 6f2d  (f"Running auto-
+0000ab40: 666f 6375 7320 6f6e 207b 6265 616d 5f74  focus on {beam_t
+0000ab50: 7970 652e 6e61 6d65 7d2e 2229 0a20 2020  ype.name}.").   
+0000ab60: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0000ab70: 7469 6f6e 2e69 6d61 6769 6e67 2e73 6574  tion.imaging.set
+0000ab80: 5f61 6374 6976 655f 7669 6577 2862 6561  _active_view(bea
+0000ab90: 6d5f 7479 7065 2e76 616c 7565 2920 200a  m_type.value)  .
+0000aba0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0000abb0: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
+0000abc0: 7365 745f 6163 7469 7665 5f64 6576 6963  set_active_devic
+0000abd0: 6528 6265 616d 5f74 7970 652e 7661 6c75  e(beam_type.valu
+0000abe0: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+0000abf0: 636f 6e6e 6563 7469 6f6e 2e61 7574 6f5f  connection.auto_
+0000ac00: 6675 6e63 7469 6f6e 732e 7275 6e5f 6175  functions.run_au
+0000ac10: 746f 5f66 6f63 7573 2829 0a20 2020 2020  to_focus().     
+0000ac20: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+0000ac30: 287b 226d 7367 223a 2022 6175 746f 5f66  ({"msg": "auto_f
+0000ac40: 6f63 7573 222c 2022 6265 616d 5f74 7970  ocus", "beam_typ
+0000ac50: 6522 3a20 6265 616d 5f74 7970 652e 6e61  e": beam_type.na
+0000ac60: 6d65 7d29 2020 2020 2020 200a 0a20 2020  me})       ..   
+0000ac70: 2064 6566 2062 6561 6d5f 7368 6966 7428   def beam_shift(
+0000ac80: 7365 6c66 2c20 6478 3a20 666c 6f61 742c  self, dx: float,
+0000ac90: 2064 793a 2066 6c6f 6174 2c20 6265 616d   dy: float, beam
+0000aca0: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
+0000acb0: 3d20 4265 616d 5479 7065 2e49 4f4e 2920  = BeamType.ION) 
+0000acc0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000acd0: 2022 2222 0a20 2020 2020 2020 2041 646a   """.        Adj
+0000ace0: 7573 7473 2074 6865 2062 6561 6d20 7368  usts the beam sh
+0000acf0: 6966 7420 6261 7365 6420 6f6e 2072 656c  ift based on rel
+0000ad00: 6174 6976 6520 7661 6c75 6573 2074 6861  ative values tha
+0000ad10: 7420 6172 6520 7072 6f76 6964 6564 2e0a  t are provided..
+0000ad20: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0000ad30: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+0000ad40: 2020 2073 656c 6620 2846 6962 7365 6d4d     self (FibsemM
+0000ad50: 6963 726f 7363 6f70 6529 3a20 4669 6273  icroscope): Fibs
+0000ad60: 656d 206d 6963 726f 7363 6f70 6520 6f62  em microscope ob
+0000ad70: 6a65 6374 0a20 2020 2020 2020 2020 2020  ject.           
+0000ad80: 2064 7820 2866 6c6f 6174 293a 2074 6865   dx (float): the
+0000ad90: 2072 656c 6174 6976 6520 7820 7465 726d   relative x term
+0000ada0: 0a20 2020 2020 2020 2020 2020 2064 7920  .            dy 
+0000adb0: 2866 6c6f 6174 293a 2074 6865 2072 656c  (float): the rel
+0000adc0: 6174 6976 6520 7920 7465 726d 0a20 2020  ative y term.   
+0000add0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000ade0: 2023 2054 4f44 4f3a 2063 6861 6e67 6520   # TODO: change 
+0000adf0: 7468 6973 2074 6f20 7573 6520 7468 6520  this to use the 
+0000ae00: 7365 7420 6170 6920 2020 200a 2020 2020  set api    .    
+0000ae10: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+0000ae20: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
+0000ae30: 7379 7374 656d 290a 0a20 2020 2020 2020  system)..       
+0000ae40: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0000ae50: 7b62 6561 6d5f 7479 7065 2e6e 616d 657d  {beam_type.name}
+0000ae60: 2073 6869 6674 696e 6720 6279 2028 7b64   shifting by ({d
+0000ae70: 787d 2c20 7b64 797d 2922 290a 2020 2020  x}, {dy})").    
+0000ae80: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
+0000ae90: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
+0000aea0: 4354 524f 4e3a 0a20 2020 2020 2020 2020  CTRON:.         
+0000aeb0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0000aec0: 6f6e 2e62 6561 6d73 2e65 6c65 6374 726f  on.beams.electro
+0000aed0: 6e5f 6265 616d 2e62 6561 6d5f 7368 6966  n_beam.beam_shif
+0000aee0: 742e 7661 6c75 6520 2b3d 2028 6478 2c20  t.value += (dx, 
+0000aef0: 6479 290a 2020 2020 2020 2020 656c 7365  dy).        else
+0000af00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0000af10: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+0000af20: 616d 732e 696f 6e5f 6265 616d 2e62 6561  ams.ion_beam.bea
+0000af30: 6d5f 7368 6966 742e 7661 6c75 6520 2b3d  m_shift.value +=
+0000af40: 2028 6478 2c20 6479 290a 2020 2020 0a20   (dx, dy).    . 
+0000af50: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+0000af60: 6562 7567 287b 226d 7367 223a 2022 6265  ebug({"msg": "be
+0000af70: 616d 5f73 6869 6674 222c 2022 6478 223a  am_shift", "dx":
+0000af80: 2064 782c 2022 6479 223a 2064 792c 2022   dx, "dy": dy, "
+0000af90: 6265 616d 5f74 7970 6522 3a20 6265 616d  beam_type": beam
+0000afa0: 5f74 7970 652e 6e61 6d65 7d29 200a 0a20  _type.name}) .. 
+0000afb0: 2020 200a 2020 2020 6465 6620 6d6f 7665     .    def move
+0000afc0: 5f73 7461 6765 5f61 6273 6f6c 7574 6528  _stage_absolute(
+0000afd0: 7365 6c66 2c20 706f 7369 7469 6f6e 3a20  self, position: 
+0000afe0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+0000aff0: 696f 6e29 202d 3e20 4669 6273 656d 5374  ion) -> FibsemSt
+0000b000: 6167 6550 6f73 6974 696f 6e3a 0a20 2020  agePosition:.   
+0000b010: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000b020: 204d 6f76 6520 7468 6520 7374 6167 6520   Move the stage 
+0000b030: 746f 2074 6865 2073 7065 6369 6669 6564  to the specified
+0000b040: 2063 6f6f 7264 696e 6174 6573 2e0a 0a20   coordinates... 
+0000b050: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+0000b060: 2020 2020 2020 2020 2070 6f73 6974 696f           positio
+0000b070: 6e3a 2054 6865 2072 6177 2073 7461 6765  n: The raw stage
+0000b080: 2070 6f73 6974 696f 6e20 746f 206d 6f76   position to mov
+0000b090: 6520 746f 2e0a 0a20 2020 2020 2020 2052  e to...        R
+0000b0a0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000b0b0: 2020 2020 4669 6273 656d 5374 6167 6550      FibsemStageP
+0000b0c0: 6f73 6974 696f 6e3a 2054 6865 2073 7461  osition: The sta
+0000b0d0: 6765 2070 6f73 6974 696f 6e20 6166 7465  ge position afte
+0000b0e0: 7220 6d6f 7665 6d65 6e74 2e0a 2020 2020  r movement..    
+0000b0f0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0000b100: 2022 2222 0a20 2020 2020 2020 205f 6368   """.        _ch
+0000b110: 6563 6b5f 7374 6167 655f 6d6f 7665 6d65  eck_stage_moveme
+0000b120: 6e74 2873 656c 662e 7379 7374 656d 2c20  nt(self.system, 
+0000b130: 706f 7369 7469 6f6e 290a 0a20 2020 2020  position)..     
+0000b140: 2020 2023 2067 6574 2063 7572 7265 6e74     # get current
+0000b150: 2077 6f72 6b69 6e67 2064 6973 7461 6e63   working distanc
+0000b160: 652c 2074 6f20 6265 2072 6573 746f 7265  e, to be restore
+0000b170: 6420 6c61 7465 7220 2020 2020 2020 2020  d later         
+0000b180: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0000b190: 2020 2077 6420 3d20 7365 6c66 2e67 6574     wd = self.get
+0000b1a0: 2822 776f 726b 696e 675f 6469 7374 616e  ("working_distan
+0000b1b0: 6365 222c 2042 6561 6d54 7970 652e 454c  ce", BeamType.EL
+0000b1c0: 4543 5452 4f4e 290a 2020 2020 2020 2020  ECTRON).        
+0000b1d0: 0a20 2020 2020 2020 2023 2063 6f6e 7665  .        # conve
+0000b1e0: 7274 2074 6f20 6175 746f 7363 7269 7074  rt to autoscript
+0000b1f0: 2070 6f73 6974 696f 6e0a 2020 2020 2020   position.      
+0000b200: 2020 6175 746f 7363 7269 7074 5f70 6f73    autoscript_pos
+0000b210: 6974 696f 6e20 3d20 706f 7369 7469 6f6e  ition = position
+0000b220: 2e74 6f5f 6175 746f 7363 7269 7074 5f70  .to_autoscript_p
+0000b230: 6f73 6974 696f 6e28 636f 6d70 7573 7461  osition(compusta
+0000b240: 6765 3d73 656c 662e 7374 6167 655f 6973  ge=self.stage_is
+0000b250: 5f63 6f6d 7075 7374 6167 6529 0a20 2020  _compustage).   
+0000b260: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0000b270: 2e73 7461 6765 5f69 735f 636f 6d70 7573  .stage_is_compus
+0000b280: 7461 6765 3a0a 2020 2020 2020 2020 2020  tage:.          
+0000b290: 2020 6175 746f 7363 7269 7074 5f70 6f73    autoscript_pos
+0000b2a0: 6974 696f 6e2e 636f 6f72 6469 6e61 7465  ition.coordinate
+0000b2b0: 5f73 7973 7465 6d20 3d20 436f 6f72 6469  _system = Coordi
+0000b2c0: 6e61 7465 5379 7374 656d 2e52 4157 2023  nateSystem.RAW #
+0000b2d0: 2054 4f44 4f3a 2063 6865 636b 2069 6620   TODO: check if 
+0000b2e0: 7468 6973 2069 7320 6e65 6365 7373 6172  this is necessar
+0000b2f0: 790a 2020 2020 2020 2020 0a20 2020 2020  y.        .     
+0000b300: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0000b310: 6622 4d6f 7669 6e67 2073 7461 6765 2074  f"Moving stage t
+0000b320: 6f20 7b70 6f73 6974 696f 6e7d 2e22 290a  o {position}.").
+0000b330: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+0000b340: 6765 2e61 6273 6f6c 7574 655f 6d6f 7665  ge.absolute_move
+0000b350: 2861 7574 6f73 6372 6970 745f 706f 7369  (autoscript_posi
+0000b360: 7469 6f6e 2c20 4d6f 7665 5365 7474 696e  tion, MoveSettin
+0000b370: 6773 2872 6f74 6174 655f 636f 6d70 7563  gs(rotate_compuc
+0000b380: 656e 7472 6963 3d54 7275 6529 2920 2320  entric=True)) # 
+0000b390: 544f 444f 3a20 5468 6973 206e 6565 6473  TODO: This needs
+0000b3a0: 2061 7420 6c65 6173 7420 616e 206f 7074   at least an opt
+0000b3b0: 696f 6e61 6c20 7361 6665 206d 6f76 6520  ional safe move 
+0000b3c0: 746f 2070 7265 7665 6e74 2063 6f6c 6c69  to prevent colli
+0000b3d0: 7369 6f6e 3f0a 2020 2020 2020 2020 2020  sion?.          
+0000b3e0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0000b3f0: 2020 2320 7265 7374 6f72 6520 776f 726b    # restore work
+0000b400: 696e 6720 6469 7374 616e 6365 2074 6f20  ing distance to 
+0000b410: 6164 6a75 7374 2066 6f72 206d 6963 726f  adjust for micro
+0000b420: 7363 6f70 6520 636f 6d70 656e 7374 6174  scope compenstat
+0000b430: 696f 6e0a 2020 2020 2020 2020 7365 6c66  ion.        self
+0000b440: 2e73 6574 2822 776f 726b 696e 675f 6469  .set("working_di
+0000b450: 7374 616e 6365 222c 2077 642c 2042 6561  stance", wd, Bea
+0000b460: 6d54 7970 652e 454c 4543 5452 4f4e 290a  mType.ELECTRON).
+0000b470: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0000b480: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
+0000b490: 7567 287b 226d 7367 223a 2022 6d6f 7665  ug({"msg": "move
+0000b4a0: 5f73 7461 6765 5f61 6273 6f6c 7574 6522  _stage_absolute"
+0000b4b0: 2c20 2270 6f73 6974 696f 6e22 3a20 706f  , "position": po
+0000b4c0: 7369 7469 6f6e 2e74 6f5f 6469 6374 2829  sition.to_dict()
+0000b4d0: 7d29 0a20 2020 2020 2020 200a 2020 2020  }).        .    
+0000b4e0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000b4f0: 6765 745f 7374 6167 655f 706f 7369 7469  get_stage_positi
+0000b500: 6f6e 2829 0a20 2020 2020 2020 200a 2020  on().        .  
+0000b510: 2020 6465 6620 6d6f 7665 5f73 7461 6765    def move_stage
+0000b520: 5f72 656c 6174 6976 6528 7365 6c66 2c20  _relative(self, 
+0000b530: 706f 7369 7469 6f6e 3a20 4669 6273 656d  position: Fibsem
+0000b540: 5374 6167 6550 6f73 6974 696f 6e29 202d  StagePosition) -
+0000b550: 3e20 4669 6273 656d 5374 6167 6550 6f73  > FibsemStagePos
+0000b560: 6974 696f 6e3a 0a20 2020 2020 2020 2022  ition:.        "
+0000b570: 2222 0a20 2020 2020 2020 204d 6f76 6520  "".        Move 
+0000b580: 7468 6520 7374 6167 6520 6279 2074 6865  the stage by the
+0000b590: 2073 7065 6369 6669 6564 2072 656c 6174   specified relat
+0000b5a0: 6976 6520 6d6f 7665 2e0a 0a20 2020 2020  ive move...     
+0000b5b0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000b5c0: 2020 2020 2070 6f73 6974 696f 6e3a 2074       position: t
+0000b5d0: 6865 2072 656c 6174 6976 6520 7374 6167  he relative stag
+0000b5e0: 6520 706f 7369 7469 6f6e 2074 6f20 6d6f  e position to mo
+0000b5f0: 7665 2062 792e 0a0a 2020 2020 2020 2020  ve by...        
+0000b600: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0000b610: 2020 2020 204e 6f6e 650a 2020 2020 2020       None.      
+0000b620: 2020 2222 220a 0a20 2020 2020 2020 205f    """..        _
+0000b630: 6368 6563 6b5f 7374 6167 655f 6d6f 7665  check_stage_move
+0000b640: 6d65 6e74 2873 656c 662e 7379 7374 656d  ment(self.system
+0000b650: 2c20 706f 7369 7469 6f6e 290a 0a20 2020  , position)..   
+0000b660: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0000b670: 6f28 6622 4d6f 7669 6e67 2073 7461 6765  o(f"Moving stage
+0000b680: 2062 7920 7b70 6f73 6974 696f 6e7d 2e22   by {position}."
+0000b690: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+0000b6a0: 2020 2023 2063 6f6e 7665 7274 2074 6f20     # convert to 
+0000b6b0: 6175 746f 7363 7269 7074 2070 6f73 6974  autoscript posit
+0000b6c0: 696f 6e0a 2020 2020 2020 2020 7468 6572  ion.        ther
+0000b6d0: 6d6f 5f70 6f73 6974 696f 6e20 3d20 706f  mo_position = po
+0000b6e0: 7369 7469 6f6e 2e74 6f5f 6175 746f 7363  sition.to_autosc
+0000b6f0: 7269 7074 5f70 6f73 6974 696f 6e28 7365  ript_position(se
+0000b700: 6c66 2e73 7461 6765 5f69 735f 636f 6d70  lf.stage_is_comp
+0000b710: 7573 7461 6765 290a 2020 2020 2020 2020  ustage).        
+0000b720: 6966 206e 6f74 2073 656c 662e 7374 6167  if not self.stag
+0000b730: 655f 6973 5f63 6f6d 7075 7374 6167 653a  e_is_compustage:
+0000b740: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
+0000b750: 726d 6f5f 706f 7369 7469 6f6e 2e63 6f6f  rmo_position.coo
+0000b760: 7264 696e 6174 655f 7379 7374 656d 203d  rdinate_system =
+0000b770: 2043 6f6f 7264 696e 6174 6553 7973 7465   CoordinateSyste
+0000b780: 6d2e 5241 5720 2320 544f 444f 3a20 6368  m.RAW # TODO: ch
+0000b790: 6563 6b20 6966 2074 6869 7320 6973 206e  eck if this is n
+0000b7a0: 6563 6573 7361 7279 0a0a 2020 2020 2020  ecessary..      
+0000b7b0: 2020 2320 6d6f 7665 2073 7461 6765 0a20    # move stage. 
+0000b7c0: 2020 2020 2020 2073 656c 662e 7374 6167         self.stag
+0000b7d0: 652e 7265 6c61 7469 7665 5f6d 6f76 6528  e.relative_move(
+0000b7e0: 7468 6572 6d6f 5f70 6f73 6974 696f 6e29  thermo_position)
+0000b7f0: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
+0000b800: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
+0000b810: 226d 6f76 655f 7374 6167 655f 7265 6c61  "move_stage_rela
+0000b820: 7469 7665 222c 2022 706f 7369 7469 6f6e  tive", "position
+0000b830: 223a 2070 6f73 6974 696f 6e2e 746f 5f64  ": position.to_d
+0000b840: 6963 7428 297d 290a 0a20 2020 2020 2020  ict()})..       
+0000b850: 2072 6574 7572 6e20 7365 6c66 2e67 6574   return self.get
+0000b860: 5f73 7461 6765 5f70 6f73 6974 696f 6e28  _stage_position(
+0000b870: 290a 0a20 2020 2064 6566 2073 7461 626c  )..    def stabl
+0000b880: 655f 6d6f 7665 2873 656c 662c 2064 783a  e_move(self, dx:
+0000b890: 2066 6c6f 6174 2c20 6479 3a20 666c 6f61   float, dy: floa
+0000b8a0: 742c 2062 6561 6d5f 7479 7065 3a20 4265  t, beam_type: Be
+0000b8b0: 616d 5479 7065 2c20 7374 6174 6963 5f77  amType, static_w
+0000b8c0: 643a 2062 6f6f 6c20 3d20 4661 6c73 6529  d: bool = False)
+0000b8d0: 202d 3e20 4669 6273 656d 5374 6167 6550   -> FibsemStageP
+0000b8e0: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
+0000b8f0: 2022 2222 0a20 2020 2020 2020 2043 616c   """.        Cal
+0000b900: 6375 6c61 7465 2074 6865 2063 6f72 7265  culate the corre
+0000b910: 6374 6564 2073 7461 6765 206d 6f76 656d  cted stage movem
+0000b920: 656e 7473 2062 6173 6564 206f 6e20 7468  ents based on th
+0000b930: 6520 6265 616d 5f74 7970 6520 7374 6167  e beam_type stag
+0000b940: 6520 7469 6c74 2c20 7368 7574 746c 6520  e tilt, shuttle 
+0000b950: 7072 652d 7469 6c74 2c20 0a20 2020 2020  pre-tilt, .     
+0000b960: 2020 2061 6e64 2074 6865 6e20 6d6f 7665     and then move
+0000b970: 2074 6865 2073 7461 6765 2072 656c 6174   the stage relat
+0000b980: 6976 656c 792e 0a0a 2020 2020 2020 2020  ively...        
+0000b990: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+0000b9a0: 2020 6478 2028 666c 6f61 7429 3a20 6469    dx (float): di
+0000b9b0: 7374 616e 6365 2061 6c6f 6e67 2074 6865  stance along the
+0000b9c0: 2078 2d61 7869 7320 2869 6d61 6765 2063   x-axis (image c
+0000b9d0: 6f6f 7264 696e 6174 6573 290a 2020 2020  oordinates).    
+0000b9e0: 2020 2020 2020 2020 6479 2028 666c 6f61          dy (floa
+0000b9f0: 7429 3a20 6469 7374 616e 6365 2061 6c6f  t): distance alo
+0000ba00: 6e67 2074 6865 2079 2d61 7869 7320 2869  ng the y-axis (i
+0000ba10: 6d61 6765 2063 6f6f 7264 696e 6174 6573  mage coordinates
+0000ba20: 290a 2020 2020 2020 2020 2020 2020 6265  ).            be
+0000ba30: 616d 5f74 7970 6520 2842 6561 6d54 7970  am_type (BeamTyp
+0000ba40: 6529 3a20 6265 616d 2074 7970 6520 746f  e): beam type to
+0000ba50: 206d 6f76 6520 696e 0a20 2020 2020 2020   move in.       
+0000ba60: 2020 2020 2073 7461 7469 635f 7764 2028       static_wd (
+0000ba70: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
+0000ba80: 2077 6865 7468 6572 2074 6f20 6669 7820   whether to fix 
+0000ba90: 7468 6520 776f 726b 696e 6720 6469 7374  the working dist
+0000baa0: 616e 6365 2074 6f20 7468 6520 6575 6365  ance to the euce
+0000bab0: 6e74 7269 6320 6865 6967 6874 732e 2044  ntric heights. D
+0000bac0: 6566 6175 6c74 7320 746f 2046 616c 7365  efaults to False
+0000bad0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0000bae0: 2020 2020 2020 0a20 2020 2020 2020 205f        .        _
+0000baf0: 6368 6563 6b5f 7374 6167 6528 7365 6c66  check_stage(self
+0000bb00: 2e73 7973 7465 6d29 0a0a 2020 2020 2020  .system)..      
+0000bb10: 2020 7764 203d 2073 656c 662e 6765 7428    wd = self.get(
+0000bb20: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
+0000bb30: 6522 2c20 4265 616d 5479 7065 2e45 4c45  e", BeamType.ELE
+0000bb40: 4354 524f 4e29 0a0a 2020 2020 2020 2020  CTRON)..        
+0000bb50: 7363 616e 5f72 6f74 6174 696f 6e20 3d20  scan_rotation = 
+0000bb60: 7365 6c66 2e67 6574 2822 7363 616e 5f72  self.get("scan_r
+0000bb70: 6f74 6174 696f 6e22 2c20 6265 616d 5f74  otation", beam_t
+0000bb80: 7970 6529 0a20 2020 2020 2020 2069 6620  ype).        if 
+0000bb90: 6e70 2e69 7363 6c6f 7365 2873 6361 6e5f  np.isclose(scan_
+0000bba0: 726f 7461 7469 6f6e 2c20 6e70 2e70 6929  rotation, np.pi)
+0000bbb0: 3a0a 2020 2020 2020 2020 2020 2020 6478  :.            dx
+0000bbc0: 202a 3d20 2d31 2e30 0a20 2020 2020 2020   *= -1.0.       
+0000bbd0: 2020 2020 2064 7920 2a3d 202d 312e 300a       dy *= -1.0.
+0000bbe0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0000bbf0: 2023 2063 616c 6375 6c61 7465 2073 7461   # calculate sta
+0000bc00: 626c 6520 6d6f 7665 6d65 6e74 0a20 2020  ble movement.   
+0000bc10: 2020 2020 2079 7a5f 6d6f 7665 203d 2073       yz_move = s
+0000bc20: 656c 662e 5f79 5f63 6f72 7265 6374 6564  elf._y_corrected
+0000bc30: 5f73 7461 6765 5f6d 6f76 656d 656e 7428  _stage_movement(
+0000bc40: 0a20 2020 2020 2020 2020 2020 2065 7870  .            exp
+0000bc50: 6563 7465 645f 793d 6479 2c0a 2020 2020  ected_y=dy,.    
+0000bc60: 2020 2020 2020 2020 6265 616d 5f74 7970          beam_typ
+0000bc70: 653d 6265 616d 5f74 7970 652c 0a20 2020  e=beam_type,.   
+0000bc80: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+0000bc90: 7461 6765 5f70 6f73 6974 696f 6e20 3d20  tage_position = 
+0000bca0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+0000bcb0: 696f 6e28 783d 6478 2c20 793d 797a 5f6d  ion(x=dx, y=yz_m
+0000bcc0: 6f76 652e 792c 207a 3d79 7a5f 6d6f 7665  ove.y, z=yz_move
+0000bcd0: 2e7a 2c20 0a20 2020 2020 2020 2020 2020  .z, .           
+0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd00: 2020 723d 302c 2074 3d30 2c20 636f 6f72    r=0, t=0, coor
+0000bd10: 6469 6e61 7465 5f73 7973 7465 6d3d 2252  dinate_system="R
+0000bd20: 4157 2229 0a20 2020 2020 2020 200a 2020  AW").        .  
+0000bd30: 2020 2020 2020 2320 6d6f 7665 2073 7461        # move sta
+0000bd40: 6765 0a20 2020 2020 2020 2073 656c 662e  ge.        self.
+0000bd50: 6d6f 7665 5f73 7461 6765 5f72 656c 6174  move_stage_relat
+0000bd60: 6976 6528 7374 6167 655f 706f 7369 7469  ive(stage_positi
+0000bd70: 6f6e 290a 0a20 2020 2020 2020 2023 2061  on)..        # a
+0000bd80: 646a 7573 7420 776f 726b 696e 6720 6469  djust working di
+0000bd90: 7374 616e 6365 2074 6f20 636f 6d70 656e  stance to compen
+0000bda0: 7361 7465 2066 6f72 2073 7461 6765 206d  sate for stage m
+0000bdb0: 6f76 656d 656e 740a 2020 2020 2020 2020  ovement.        
+0000bdc0: 6966 2073 7461 7469 635f 7764 3a0a 2020  if static_wd:.  
+0000bdd0: 2020 2020 2020 2020 2020 7764 203d 2073            wd = s
+0000bde0: 656c 662e 7379 7374 656d 2e65 6c65 6374  elf.system.elect
+0000bdf0: 726f 6e2e 6575 6365 6e74 7269 635f 6865  ron.eucentric_he
+0000be00: 6967 6874 0a20 2020 2020 2020 200a 2020  ight.        .  
+0000be10: 2020 2020 2020 7365 6c66 2e73 6574 2822        self.set("
+0000be20: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
+0000be30: 222c 2077 642c 2042 6561 6d54 7970 652e  ", wd, BeamType.
+0000be40: 454c 4543 5452 4f4e 290a 0a20 2020 2020  ELECTRON)..     
+0000be50: 2020 2023 206c 6f67 6769 6e67 0a20 2020     # logging.   
+0000be60: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
+0000be70: 7567 287b 226d 7367 223a 2022 7374 6162  ug({"msg": "stab
+0000be80: 6c65 5f6d 6f76 6522 2c20 2264 7822 3a20  le_move", "dx": 
+0000be90: 6478 2c20 2264 7922 3a20 6479 2c20 0a20  dx, "dy": dy, . 
+0000bea0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000beb0: 6265 616d 5f74 7970 6522 3a20 6265 616d  beam_type": beam
+0000bec0: 5f74 7970 652e 6e61 6d65 2c20 2273 7461  _type.name, "sta
+0000bed0: 7469 635f 7764 223a 2073 7461 7469 635f  tic_wd": static_
+0000bee0: 7764 2c0a 2020 2020 2020 2020 2020 2020  wd,.            
+0000bef0: 2020 2020 2277 6f72 6b69 6e67 5f64 6973      "working_dis
+0000bf00: 7461 6e63 6522 3a20 7764 2c20 2273 6361  tance": wd, "sca
+0000bf10: 6e5f 726f 7461 7469 6f6e 223a 2073 6361  n_rotation": sca
+0000bf20: 6e5f 726f 7461 7469 6f6e 2c20 0a20 2020  n_rotation, .   
+0000bf30: 2020 2020 2020 2020 2020 2020 2022 706f               "po
+0000bf40: 7369 7469 6f6e 223a 2073 7461 6765 5f70  sition": stage_p
+0000bf50: 6f73 6974 696f 6e2e 746f 5f64 6963 7428  osition.to_dict(
+0000bf60: 297d 290a 0a20 2020 2020 2020 2072 6574  )})..        ret
+0000bf70: 7572 6e20 7365 6c66 2e67 6574 5f73 7461  urn self.get_sta
+0000bf80: 6765 5f70 6f73 6974 696f 6e28 290a 0a20  ge_position().. 
+0000bf90: 2020 2064 6566 2076 6572 7469 6361 6c5f     def vertical_
+0000bfa0: 6d6f 7665 280a 2020 2020 2020 2020 7365  move(.        se
+0000bfb0: 6c66 2c0a 2020 2020 2020 2020 6479 3a20  lf,.        dy: 
+0000bfc0: 666c 6f61 742c 0a20 2020 2020 2020 2064  float,.        d
+0000bfd0: 783a 2066 6c6f 6174 203d 2030 2e30 2c0a  x: float = 0.0,.
+0000bfe0: 2020 2020 2020 2020 7374 6174 6963 5f77          static_w
+0000bff0: 643a 2062 6f6f 6c20 3d20 5472 7565 2c0a  d: bool = True,.
+0000c000: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+0000c010: 2020 2020 2020 2022 2222 204d 6f76 6520         """ Move 
+0000c020: 7468 6520 7374 6167 6520 7665 7274 6963  the stage vertic
+0000c030: 616c 6c79 2074 6f20 636f 7272 6563 7420  ally to correct 
+0000c040: 636f 696e 6369 6465 6e63 6520 706f 696e  coincidence poin
+0000c050: 740a 0a20 2020 2020 2020 2041 7267 733a  t..        Args:
+0000c060: 0a20 2020 2020 2020 2020 2020 2064 7920  .            dy 
+0000c070: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
+0000c080: 6520 616c 6f6e 6720 7468 6520 792d 6178  e along the y-ax
+0000c090: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
+0000c0a0: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
+0000c0b0: 2020 2064 7820 2866 6c6f 6174 2c20 6f70     dx (float, op
+0000c0c0: 7469 6f6e 616c 293a 2064 6973 7461 6e63  tional): distanc
+0000c0d0: 6520 616c 6f6e 6720 7468 6520 782d 6178  e along the x-ax
+0000c0e0: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
+0000c0f0: 6e61 7465 7329 2e20 4465 6661 756c 7473  nates). Defaults
+0000c100: 2074 6f20 302e 302e 0a20 2020 2020 2020   to 0.0..       
+0000c110: 2020 2020 2073 7461 7469 635f 7764 2028       static_wd (
+0000c120: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
+0000c130: 2077 6865 7468 6572 2074 6f20 6669 7820   whether to fix 
+0000c140: 7468 6520 776f 726b 696e 6720 6469 7374  the working dist
+0000c150: 616e 6365 2e20 4465 6661 756c 7473 2074  ance. Defaults t
+0000c160: 6f20 5472 7565 2e0a 0a20 2020 2020 2020  o True...       
+0000c170: 2022 2222 0a20 2020 2020 2020 2023 2063   """.        # c
+0000c180: 6f6e 6669 726d 2073 7461 6765 2069 7320  onfirm stage is 
+0000c190: 656e 6162 6c65 640a 2020 2020 2020 2020  enabled.        
+0000c1a0: 5f63 6865 636b 5f73 7461 6765 2873 656c  _check_stage(sel
+0000c1b0: 662e 7379 7374 656d 290a 0a20 2020 2020  f.system)..     
+0000c1c0: 2020 2023 2067 6574 2063 7572 7265 6e74     # get current
+0000c1d0: 2077 6f72 6b69 6e67 2064 6973 7461 6e63   working distanc
+0000c1e0: 652c 2074 6f20 6265 2072 6573 746f 7265  e, to be restore
+0000c1f0: 6420 6c61 7465 720a 2020 2020 2020 2020  d later.        
+0000c200: 7764 203d 2073 656c 662e 6765 7428 2277  wd = self.get("w
+0000c210: 6f72 6b69 6e67 5f64 6973 7461 6e63 6522  orking_distance"
+0000c220: 2c20 4265 616d 5479 7065 2e45 4c45 4354  , BeamType.ELECT
+0000c230: 524f 4e29 0a0a 2020 2020 2020 2020 2320  RON)..        # 
+0000c240: 6164 6a75 7374 2066 6f72 2073 6361 6e20  adjust for scan 
+0000c250: 726f 7461 7469 6f6e 0a20 2020 2020 2020  rotation.       
+0000c260: 2073 6361 6e5f 726f 7461 7469 6f6e 203d   scan_rotation =
+0000c270: 2073 656c 662e 6765 7428 2273 6361 6e5f   self.get("scan_
+0000c280: 726f 7461 7469 6f6e 222c 2042 6561 6d54  rotation", BeamT
+0000c290: 7970 652e 494f 4e29 0a20 2020 2020 2020  ype.ION).       
+0000c2a0: 2069 6620 6e70 2e69 7363 6c6f 7365 2873   if np.isclose(s
+0000c2b0: 6361 6e5f 726f 7461 7469 6f6e 2c20 6e70  can_rotation, np
+0000c2c0: 2e70 6929 3a0a 2020 2020 2020 2020 2020  .pi):.          
+0000c2d0: 2020 6478 202a 3d20 2d31 2e30 0a20 2020    dx *= -1.0.   
+0000c2e0: 2020 2020 2020 2020 2064 7920 2a3d 202d           dy *= -
+0000c2f0: 312e 300a 0a20 2020 2020 2020 2023 2054  1.0..        # T
+0000c300: 4f44 4f3a 2041 5243 5449 5320 446f 2077  ODO: ARCTIS Do w
+0000c310: 6520 6e65 6564 2074 6f20 7265 7665 7273  e need to revers
+0000c320: 6520 7468 6520 6469 7265 6374 696f 6e20  e the direction 
+0000c330: 6f66 2074 6865 206d 6f76 656d 656e 7420  of the movement 
+0000c340: 6265 6361 7573 6520 6f66 2074 6865 2069  because of the i
+0000c350: 6e76 6572 7465 6420 7374 6167 6520 7469  nverted stage ti
+0000c360: 6c74 3f0a 2020 2020 2020 2020 6966 2073  lt?.        if s
+0000c370: 656c 662e 7374 6167 655f 6973 5f63 6f6d  elf.stage_is_com
+0000c380: 7075 7374 6167 653a 0a20 2020 2020 2020  pustage:.       
+0000c390: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
+0000c3a0: 3d20 7365 6c66 2e67 6574 5f73 7461 6765  = self.get_stage
+0000c3b0: 5f70 6f73 6974 696f 6e28 292e 740a 2020  _position().t.  
+0000c3c0: 2020 2020 2020 2020 2020 6966 2073 7461            if sta
+0000c3d0: 6765 5f74 696c 7420 3e3d 206e 702e 6465  ge_tilt >= np.de
+0000c3e0: 6732 7261 6428 2d39 3029 3a0a 2020 2020  g2rad(-90):.    
+0000c3f0: 2020 2020 2020 2020 2020 2020 6479 202a              dy *
+0000c400: 3d20 2d31 2e30 0a0a 2020 2020 2020 2020  = -1.0..        
+0000c410: 2320 544f 444f 3a20 696d 706c 656d 656e  # TODO: implemen
+0000c420: 7420 7065 7273 7065 6374 6976 6520 636f  t perspective co
+0000c430: 7272 6563 7469 6f6e 0a20 2020 2020 2020  rrection.       
+0000c440: 2050 4552 5350 4543 5449 5645 5f43 4f52   PERSPECTIVE_COR
+0000c450: 5245 4354 494f 4e20 3d20 302e 390a 2020  RECTION = 0.9.  
+0000c460: 2020 2020 2020 7a5f 6d6f 7665 203d 2064        z_move = d
+0000c470: 7920 2f20 6e70 2e63 6f73 286e 702e 6465  y / np.cos(np.de
+0000c480: 6732 7261 6428 3930 202d 2073 656c 662e  g2rad(90 - self.
+0000c490: 7379 7374 656d 2e69 6f6e 2e63 6f6c 756d  system.ion.colum
+0000c4a0: 6e5f 7469 6c74 2929 202a 2050 4552 5350  n_tilt)) * PERSP
+0000c4b0: 4543 5449 5645 5f43 4f52 5245 4354 494f  ECTIVE_CORRECTIO
+0000c4c0: 4e20 2023 2054 4f44 4f3a 204d 4147 4943  N  # TODO: MAGIC
+0000c4d0: 204e 554d 4245 522c 2039 3020 2d20 6669   NUMBER, 90 - fi
+0000c4e0: 6220 7469 6c74 0a0a 2020 2020 2020 2020  b tilt..        
+0000c4f0: 2320 544f 444f 3a20 646f 2074 6869 7320  # TODO: do this 
+0000c500: 6d61 6e75 616c 6c79 2077 6974 686f 7574  manually without
+0000c510: 2061 7574 6f73 6372 6970 7420 696e 2072   autoscript in r
+0000c520: 6177 2063 6f6f 7264 696e 6174 6573 0a20  aw coordinates. 
+0000c530: 2020 2020 2020 2073 7461 6765 5f70 6f73         stage_pos
+0000c540: 6974 696f 6e20 3d20 4669 6273 656d 5374  ition = FibsemSt
+0000c550: 6167 6550 6f73 6974 696f 6e28 0a20 2020  agePosition(.   
+0000c560: 2020 2020 2020 2020 2078 3d64 782c 0a20           x=dx,. 
+0000c570: 2020 2020 2020 2020 2020 207a 3d7a 5f6d             z=z_m
+0000c580: 6f76 652c 200a 2020 2020 2020 2020 2020  ove, .          
+0000c590: 2020 636f 6f72 6469 6e61 7465 5f73 7973    coordinate_sys
+0000c5a0: 7465 6d3d 2253 7065 6369 6d65 6e22 0a20  tem="Specimen". 
+0000c5b0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000c5c0: 2020 2320 6d6f 7665 2073 7461 6765 0a20    # move stage. 
+0000c5d0: 2020 2020 2020 206d 6f76 655f 7365 7474         move_sett
+0000c5e0: 696e 6773 203d 204d 6f76 6553 6574 7469  ings = MoveSetti
+0000c5f0: 6e67 7328 6c69 6e6b 5f7a 5f79 3d54 7275  ngs(link_z_y=Tru
+0000c600: 6529 0a20 2020 2020 2020 2061 7574 6f73  e).        autos
+0000c610: 6372 6970 745f 706f 7369 7469 6f6e 203d  cript_position =
+0000c620: 2073 7461 6765 5f70 6f73 6974 696f 6e2e   stage_position.
+0000c630: 746f 5f61 7574 6f73 6372 6970 745f 706f  to_autoscript_po
+0000c640: 7369 7469 6f6e 2873 656c 662e 7374 6167  sition(self.stag
+0000c650: 655f 6973 5f63 6f6d 7075 7374 6167 6529  e_is_compustage)
+0000c660: 0a20 2020 2020 2020 2061 7574 6f73 6372  .        autoscr
+0000c670: 6970 745f 706f 7369 7469 6f6e 2e63 6f6f  ipt_position.coo
+0000c680: 7264 696e 6174 655f 7379 7374 656d 203d  rdinate_system =
+0000c690: 2043 6f6f 7264 696e 6174 6553 7973 7465   CoordinateSyste
+0000c6a0: 6d2e 5350 4543 494d 454e 200a 2020 2020  m.SPECIMEN .    
+0000c6b0: 2020 2020 7365 6c66 2e73 7461 6765 2e72      self.stage.r
+0000c6c0: 656c 6174 6976 655f 6d6f 7665 2861 7574  elative_move(aut
+0000c6d0: 6f73 6372 6970 745f 706f 7369 7469 6f6e  oscript_position
+0000c6e0: 2c20 6d6f 7665 5f73 6574 7469 6e67 7329  , move_settings)
+0000c6f0: 0a0a 2020 2020 2020 2020 2320 7265 7374  ..        # rest
+0000c700: 6f72 6520 776f 726b 696e 6720 6469 7374  ore working dist
+0000c710: 616e 6365 2074 6f20 6164 6a75 7374 2066  ance to adjust f
+0000c720: 6f72 206d 6963 726f 7363 6f70 6520 636f  or microscope co
+0000c730: 6d70 656e 7374 6174 696f 6e0a 2020 2020  mpenstation.    
+0000c740: 2020 2020 6966 2073 7461 7469 635f 7764      if static_wd
+0000c750: 2061 6e64 206e 6f74 2073 656c 662e 7374   and not self.st
+0000c760: 6167 655f 6973 5f63 6f6d 7075 7374 6167  age_is_compustag
+0000c770: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0000c780: 656c 662e 7365 7428 2277 6f72 6b69 6e67  elf.set("working
+0000c790: 5f64 6973 7461 6e63 6522 2c20 7365 6c66  _distance", self
+0000c7a0: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
+0000c7b0: 2e65 7563 656e 7472 6963 5f68 6569 6768  .eucentric_heigh
+0000c7c0: 742c 2042 6561 6d54 7970 652e 454c 4543  t, BeamType.ELEC
+0000c7d0: 5452 4f4e 290a 2020 2020 2020 2020 2020  TRON).          
+0000c7e0: 2020 7365 6c66 2e73 6574 2822 776f 726b    self.set("work
+0000c7f0: 696e 675f 6469 7374 616e 6365 222c 2073  ing_distance", s
+0000c800: 656c 662e 7379 7374 656d 2e69 6f6e 2e65  elf.system.ion.e
+0000c810: 7563 656e 7472 6963 5f68 6569 6768 742c  ucentric_height,
+0000c820: 2042 6561 6d54 7970 652e 494f 4e29 0a20   BeamType.ION). 
+0000c830: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000c840: 2020 2020 2020 2020 2073 656c 662e 7365           self.se
+0000c850: 7428 2277 6f72 6b69 6e67 5f64 6973 7461  t("working_dista
+0000c860: 6e63 6522 2c20 7764 2c20 4265 616d 5479  nce", wd, BeamTy
+0000c870: 7065 2e45 4c45 4354 524f 4e29 0a0a 2020  pe.ELECTRON)..  
+0000c880: 2020 2020 2020 2320 6c6f 6767 696e 670a        # logging.
+0000c890: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000c8a0: 6465 6275 6728 7b22 6d73 6722 3a20 2276  debug({"msg": "v
+0000c8b0: 6572 7469 6361 6c5f 6d6f 7665 222c 2022  ertical_move", "
+0000c8c0: 6479 223a 2064 792c 2022 6478 223a 2064  dy": dy, "dx": d
+0000c8d0: 782c 200a 2020 2020 2020 2020 2020 2020  x, .            
+0000c8e0: 2020 2020 2273 7461 7469 635f 7764 223a      "static_wd":
+0000c8f0: 2073 7461 7469 635f 7764 2c20 2277 6422   static_wd, "wd"
+0000c900: 3a20 7764 2c20 0a20 2020 2020 2020 2020  : wd, .         
+0000c910: 2020 2020 2020 2022 7363 616e 5f72 6f74         "scan_rot
+0000c920: 6174 696f 6e22 3a20 7363 616e 5f72 6f74  ation": scan_rot
+0000c930: 6174 696f 6e2c 200a 2020 2020 2020 2020  ation, .        
+0000c940: 2020 2020 2020 2020 2270 6f73 6974 696f          "positio
+0000c950: 6e22 3a20 7374 6167 655f 706f 7369 7469  n": stage_positi
+0000c960: 6f6e 2e74 6f5f 6469 6374 2829 7d29 0a0a  on.to_dict()})..
+0000c970: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000c980: 7365 6c66 2e67 6574 5f73 7461 6765 5f70  self.get_stage_p
+0000c990: 6f73 6974 696f 6e28 290a 0a20 2020 2064  osition()..    d
+0000c9a0: 6566 205f 795f 636f 7272 6563 7465 645f  ef _y_corrected_
+0000c9b0: 7374 6167 655f 6d6f 7665 6d65 6e74 280a  stage_movement(.
+0000c9c0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000c9d0: 2020 2020 2020 6578 7065 6374 6564 5f79        expected_y
+0000c9e0: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
+0000c9f0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+0000ca00: 5479 7065 203d 2042 6561 6d54 7970 652e  Type = BeamType.
+0000ca10: 454c 4543 5452 4f4e 2c0a 2020 2020 2920  ELECTRON,.    ) 
+0000ca20: 2d3e 2046 6962 7365 6d53 7461 6765 506f  -> FibsemStagePo
+0000ca30: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
+0000ca40: 2222 220a 2020 2020 2020 2020 4361 6c63  """.        Calc
+0000ca50: 756c 6174 6520 7468 6520 7920 636f 7272  ulate the y corr
+0000ca60: 6563 7465 6420 7374 6167 6520 6d6f 7665  ected stage move
+0000ca70: 6d65 6e74 2c20 636f 7272 6563 7465 6420  ment, corrected 
+0000ca80: 666f 7220 7468 6520 6164 6469 7469 6f6e  for the addition
+0000ca90: 616c 2074 696c 7420 6f66 2074 6865 2073  al tilt of the s
+0000caa0: 616d 706c 6520 686f 6c64 6572 2028 7072  ample holder (pr
+0000cab0: 652d 7469 6c74 2061 6e67 6c65 292e 0a0a  e-tilt angle)...
+0000cac0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+0000cad0: 2020 2020 2020 2020 2020 6578 7065 6374            expect
+0000cae0: 6564 5f79 2028 666c 6f61 742c 206f 7074  ed_y (float, opt
+0000caf0: 696f 6e61 6c29 3a20 6469 7374 616e 6365  ional): distance
+0000cb00: 2061 6c6f 6e67 2079 2d61 7869 732e 0a20   along y-axis.. 
+0000cb10: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
+0000cb20: 7479 7065 2028 4265 616d 5479 7065 2c20  type (BeamType, 
+0000cb30: 6f70 7469 6f6e 616c 293a 2062 6561 6d5f  optional): beam_
+0000cb40: 7479 7065 2074 6f20 6d6f 7665 2069 6e2e  type to move in.
+0000cb50: 2044 6566 6175 6c74 7320 746f 2042 6561   Defaults to Bea
+0000cb60: 6d54 7970 652e 454c 4543 5452 4f4e 2e0a  mType.ELECTRON..
+0000cb70: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0000cb80: 3a0a 2020 2020 2020 2020 2020 2020 5374  :.            St
+0000cb90: 6167 6550 6f73 6974 696f 6e3a 2079 2063  agePosition: y c
+0000cba0: 6f72 7265 6374 6564 2073 7461 6765 206d  orrected stage m
+0000cbb0: 6f76 656d 656e 7420 2872 656c 6174 6976  ovement (relativ
+0000cbc0: 6520 706f 7369 7469 6f6e 290a 2020 2020  e position).    
+0000cbd0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+0000cbe0: 2023 2054 4f44 4f3a 2072 6570 6c61 6365   # TODO: replace
+0000cbf0: 2077 6974 6820 6361 6d65 7261 206d 6174   with camera mat
+0000cc00: 7269 7820 2a20 696e 7665 7273 6520 6b69  rix * inverse ki
+0000cc10: 6e65 6d61 7469 6373 0a0a 2020 2020 2020  nematics..      
+0000cc20: 2020 2320 616c 6c20 616e 676c 6573 2069    # all angles i
+0000cc30: 6e20 7261 6469 616e 730a 2020 2020 2020  n radians.      
+0000cc40: 2020 7374 6167 655f 7469 6c74 5f66 6c61    stage_tilt_fla
+0000cc50: 745f 746f 5f65 6c65 6374 726f 6e20 3d20  t_to_electron = 
+0000cc60: 6e70 2e64 6567 3272 6164 2873 656c 662e  np.deg2rad(self.
+0000cc70: 7379 7374 656d 2e65 6c65 6374 726f 6e2e  system.electron.
+0000cc80: 636f 6c75 6d6e 5f74 696c 7429 0a20 2020  column_tilt).   
+0000cc90: 2020 2020 2073 7461 6765 5f74 696c 745f       stage_tilt_
+0000cca0: 666c 6174 5f74 6f5f 696f 6e20 3d20 6e70  flat_to_ion = np
+0000ccb0: 2e64 6567 3272 6164 2873 656c 662e 7379  .deg2rad(self.sy
+0000ccc0: 7374 656d 2e69 6f6e 2e63 6f6c 756d 6e5f  stem.ion.column_
+0000ccd0: 7469 6c74 290a 0a20 2020 2020 2020 2073  tilt)..        s
+0000cce0: 7461 6765 5f70 7265 7469 6c74 203d 206e  tage_pretilt = n
+0000ccf0: 702e 6465 6732 7261 6428 7365 6c66 2e73  p.deg2rad(self.s
+0000cd00: 7973 7465 6d2e 7374 6167 652e 7368 7574  ystem.stage.shut
+0000cd10: 746c 655f 7072 655f 7469 6c74 290a 0a20  tle_pre_tilt).. 
+0000cd20: 2020 2020 2020 2073 7461 6765 5f72 6f74         stage_rot
+0000cd30: 6174 696f 6e5f 666c 6174 5f74 6f5f 6562  ation_flat_to_eb
+0000cd40: 203d 206e 702e 6465 6732 7261 6428 0a20   = np.deg2rad(. 
+0000cd50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000cd60: 7379 7374 656d 2e73 7461 6765 2e72 6f74  system.stage.rot
+0000cd70: 6174 696f 6e5f 7265 6665 7265 6e63 650a  ation_reference.
+0000cd80: 2020 2020 2020 2020 2920 2520 2832 202a          ) % (2 *
+0000cd90: 206e 702e 7069 290a 2020 2020 2020 2020   np.pi).        
+0000cda0: 7374 6167 655f 726f 7461 7469 6f6e 5f66  stage_rotation_f
+0000cdb0: 6c61 745f 746f 5f69 6f6e 203d 206e 702e  lat_to_ion = np.
+0000cdc0: 6465 6732 7261 6428 0a20 2020 2020 2020  deg2rad(.       
+0000cdd0: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
+0000cde0: 2e73 7461 6765 2e72 6f74 6174 696f 6e5f  .stage.rotation_
+0000cdf0: 3138 300a 2020 2020 2020 2020 2920 2520  180.        ) % 
+0000ce00: 2832 202a 206e 702e 7069 290a 0a20 2020  (2 * np.pi)..   
+0000ce10: 2020 2020 2023 2063 7572 7265 6e74 2073       # current s
+0000ce20: 7461 6765 2070 6f73 6974 696f 6e0a 2020  tage position.  
+0000ce30: 2020 2020 2020 6375 7272 656e 745f 7374        current_st
+0000ce40: 6167 655f 706f 7369 7469 6f6e 203d 2073  age_position = s
+0000ce50: 656c 662e 6765 745f 7374 6167 655f 706f  elf.get_stage_po
+0000ce60: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
+0000ce70: 2073 7461 6765 5f72 6f74 6174 696f 6e20   stage_rotation 
+0000ce80: 3d20 6375 7272 656e 745f 7374 6167 655f  = current_stage_
+0000ce90: 706f 7369 7469 6f6e 2e72 2025 2028 3220  position.r % (2 
+0000cea0: 2a20 6e70 2e70 6929 0a20 2020 2020 2020  * np.pi).       
+0000ceb0: 2073 7461 6765 5f74 696c 7420 3d20 6375   stage_tilt = cu
+0000cec0: 7272 656e 745f 7374 6167 655f 706f 7369  rrent_stage_posi
+0000ced0: 7469 6f6e 2e74 0a0a 2020 2020 2020 2020  tion.t..        
+0000cee0: 2320 544f 444f 3a20 4070 6174 7269 636b  # TODO: @patrick
+0000cef0: 2069 6e76 6573 7469 6761 7465 2069 6620   investigate if 
+0000cf00: 7468 6573 6520 6361 6c63 756c 6174 696f  these calculatio
+0000cf10: 6e73 206e 6565 6420 746f 2062 6520 6164  ns need to be ad
+0000cf20: 6a75 7374 6564 2066 6f72 2063 6f6d 7075  justed for compu
+0000cf30: 7374 6167 652e 2e2e 0a20 2020 2020 2020  stage....       
+0000cf40: 2023 2074 6865 2063 6f6d 7075 7374 6167   # the compustag
+0000cf50: 6520 646f 6573 206e 6f74 2068 6176 6520  e does not have 
+0000cf60: 7072 652d 7469 6c74 2c20 6361 6e6e 6f74  pre-tilt, cannot
+0000cf70: 2072 6f74 6174 652c 2062 7574 2074 696c   rotate, but til
+0000cf80: 7473 2031 3830 2064 6567 2e20 0a20 2020  ts 180 deg. .   
+0000cf90: 2020 2020 2023 2054 6865 7265 666f 7265       # Therefore
+0000cfa0: 2c20 7468 6520 726f 7461 7469 6f6e 2077  , the rotation w
+0000cfb0: 696c 6c20 616c 7761 7973 2062 6520 302c  ill always be 0,
+0000cfc0: 2070 7265 2d74 696c 7420 7769 6c6c 2061   pre-tilt will a
+0000cfd0: 6c77 6179 7320 6265 2030 0a20 2020 2020  lways be 0.     
+0000cfe0: 2020 2023 2074 6865 7265 666f 7265 2c20     # therefore, 
+0000cff0: 4920 7468 696e 6b20 6974 2073 686f 756c  I think it shoul
+0000d000: 6420 616c 7761 7973 2062 6520 7472 6561  d always be trea
+0000d010: 7465 6420 6173 2061 2066 6c61 7420 7374  ted as a flat st
+0000d020: 6167 652c 2074 6861 7420 6973 206f 7269  age, that is ori
+0000d030: 656e 7465 6420 746f 7761 7264 7320 7468  ented towards th
+0000d040: 6520 696f 6e20 6265 616d 2028 696e 2072  e ion beam (in r
+0000d050: 6f74 6174 696f 6e29 3f0a 2020 2020 2020  otation)?.      
+0000d060: 2020 2320 6e65 6564 2068 6172 6477 6172    # need hardwar
+0000d070: 6520 746f 2063 6f6e 6669 726d 2074 6869  e to confirm thi
+0000d080: 730a 2020 2020 2020 2020 2320 5155 4553  s.        # QUES
+0000d090: 5449 4f4e 3a20 6973 2074 6865 2063 6f6d  TION: is the com
+0000d0a0: 7075 7374 6167 6520 616c 7761 7973 2066  pustage always f
+0000d0b0: 6c61 7420 746f 2074 6865 2069 6f6e 2062  lat to the ion b
+0000d0c0: 6561 6d3f 206f 7220 6973 2069 7420 666c  eam? or is it fl
+0000d0d0: 6174 2074 6f20 7468 6520 656c 6563 7472  at to the electr
+0000d0e0: 6f6e 2062 6561 6d3f 0a20 2020 2020 2020  on beam?.       
+0000d0f0: 2023 2051 5545 5354 494f 4e3a 2077 6861   # QUESTION: wha
+0000d100: 7420 6973 2074 6865 2074 696c 7420 636f  t is the tilt co
+0000d110: 6f72 6469 6e61 7465 2073 7973 7465 6d20  ordinate system 
+0000d120: 2877 6865 7265 2069 7320 3020 6465 6772  (where is 0 degr
+0000d130: 6565 732c 2077 6865 7265 2069 7320 3930  ees, where is 90
+0000d140: 2064 6567 7265 6573 2c20 7768 6572 6520   degrees, where 
+0000d150: 6973 2031 3830 2064 6567 7265 6573 293f  is 180 degrees)?
+0000d160: 0a20 2020 2020 2020 2023 2051 5545 5354  .        # QUEST
+0000d170: 494f 4e3a 2077 6861 7420 646f 6573 2066  ION: what does f
+0000d180: 6c69 7020 646f 3f20 4973 2069 7420 3138  lip do? Is it 18
+0000d190: 3020 6465 6772 6565 7320 726f 7461 7469  0 degrees rotati
+0000d1a0: 6f6e 206f 7220 7469 6c74 3f20 5468 6973  on or tilt? This
+0000d1b0: 2077 696c 6c20 6166 6665 6374 206d 6f76   will affect mov
+0000d1c0: 655f 666c 6174 5f74 6f5f 6265 616d 2020  e_flat_to_beam  
+0000d1d0: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
+0000d1e0: 2041 5353 554d 5054 494f 4e3a 2028 6e61   ASSUMPTION: (na
+0000d1f0: 6976 6529 2074 696c 743d 3020 2d3e 2066  ive) tilt=0 -> f
+0000d200: 6c61 7420 746f 2065 6c65 6374 726f 6e20  lat to electron 
+0000d210: 6265 616d 2c20 7469 6c74 3d35 3220 2d3e  beam, tilt=52 ->
+0000d220: 2066 6c61 7420 746f 2069 6f6e 0a0a 2020   flat to ion..  
+0000d230: 2020 2020 2020 2320 6e65 7720 696e 666f        # new info
+0000d240: 3a0a 2020 2020 2020 2020 2320 726f 7461  :.        # rota
+0000d250: 7469 6f6e 2061 6c77 6179 7320 7769 6c6c  tion always will
+0000d260: 2062 6520 7a65 726f 202d 3e20 5052 4554   be zero -> PRET
+0000d270: 494c 545f 5349 474e 203d 2031 0a20 2020  ILT_SIGN = 1.   
+0000d280: 2020 2020 2023 2062 6563 6175 7365 2077       # because w
+0000d290: 6520 7761 6e74 2074 6f20 696d 6167 6520  e want to image 
+0000d2a0: 7468 6520 6261 636b 206f 6620 7468 6520  the back of the 
+0000d2b0: 6772 6964 2c20 7765 206e 6565 6420 746f  grid, we need to
+0000d2c0: 2066 6c69 7020 7468 6520 7374 6167 6520   flip the stage 
+0000d2d0: 6279 2031 3830 2064 6567 7265 6573 0a20  by 180 degrees. 
+0000d2e0: 2020 2020 2020 2023 2066 6c61 7420 746f         # flat to
+0000d2f0: 2065 6c65 6374 726f 6e2c 2074 696c 7420   electron, tilt 
+0000d300: 3d20 2d31 3830 0a20 2020 2020 2020 2023  = -180.        #
+0000d310: 2066 6c61 7420 746f 2069 6f6e 2c20 7469   flat to ion, ti
+0000d320: 6c74 203d 202d 3132 380a 2020 2020 2020  lt = -128.      
+0000d330: 2020 2320 7765 206d 6179 2061 6c73 6f20    # we may also 
+0000d340: 6e65 6564 2074 6f20 666c 6970 2074 6865  need to flip the
+0000d350: 2050 5245 5449 4c54 5f53 4947 4e3f 0a0a   PRETILT_SIGN?..
+0000d360: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000d370: 7374 6167 655f 6973 5f63 6f6d 7075 7374  stage_is_compust
+0000d380: 6167 653a 0a0a 2020 2020 2020 2020 2020  age:..          
+0000d390: 2020 6966 2073 7461 6765 5f74 696c 7420    if stage_tilt 
+0000d3a0: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
+0000d3b0: 2020 2020 2065 7870 6563 7465 645f 7920       expected_y 
+0000d3c0: 2a3d 202d 312e 300a 0a20 2020 2020 2020  *= -1.0..       
+0000d3d0: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
+0000d3e0: 2b3d 206e 702e 7069 0a0a 2020 2020 2020  += np.pi..      
+0000d3f0: 2020 5052 4554 494c 545f 5349 474e 203d    PRETILT_SIGN =
+0000d400: 2031 2e30 0a20 2020 2020 2020 2023 2070   1.0.        # p
+0000d410: 7265 7469 6c74 2061 6e67 6c65 2064 6570  retilt angle dep
+0000d420: 656e 6473 206f 6e20 726f 7461 7469 6f6e  ends on rotation
+0000d430: 0a20 2020 2020 2020 2066 726f 6d20 6669  .        from fi
+0000d440: 6273 656d 2069 6d70 6f72 7420 6d6f 7665  bsem import move
+0000d450: 6d65 6e74 0a20 2020 2020 2020 2069 6620  ment.        if 
+0000d460: 6d6f 7665 6d65 6e74 2e72 6f74 6174 696f  movement.rotatio
+0000d470: 6e5f 616e 676c 655f 6973 5f73 6d61 6c6c  n_angle_is_small
+0000d480: 6572 2873 7461 6765 5f72 6f74 6174 696f  er(stage_rotatio
+0000d490: 6e2c 2073 7461 6765 5f72 6f74 6174 696f  n, stage_rotatio
+0000d4a0: 6e5f 666c 6174 5f74 6f5f 6562 2c20 6174  n_flat_to_eb, at
+0000d4b0: 6f6c 3d35 293a 0a20 2020 2020 2020 2020  ol=5):.         
+0000d4c0: 2020 2050 5245 5449 4c54 5f53 4947 4e20     PRETILT_SIGN 
+0000d4d0: 3d20 312e 300a 2020 2020 2020 2020 6966  = 1.0.        if
+0000d4e0: 206d 6f76 656d 656e 742e 726f 7461 7469   movement.rotati
+0000d4f0: 6f6e 5f61 6e67 6c65 5f69 735f 736d 616c  on_angle_is_smal
+0000d500: 6c65 7228 0a20 2020 2020 2020 2020 2020  ler(.           
+0000d510: 2073 7461 6765 5f72 6f74 6174 696f 6e2c   stage_rotation,
+0000d520: 2073 7461 6765 5f72 6f74 6174 696f 6e5f   stage_rotation_
+0000d530: 666c 6174 5f74 6f5f 696f 6e2c 2061 746f  flat_to_ion, ato
+0000d540: 6c3d 350a 2020 2020 2020 2020 293a 0a20  l=5.        ):. 
+0000d550: 2020 2020 2020 2020 2020 2050 5245 5449             PRETI
+0000d560: 4c54 5f53 4947 4e20 3d20 2d31 2e30 0a0a  LT_SIGN = -1.0..
+0000d570: 2020 2020 2020 2020 2320 636f 7272 6563          # correc
+0000d580: 7465 645f 7072 6574 696c 745f 616e 676c  ted_pretilt_angl
+0000d590: 6520 3d20 5052 4554 494c 545f 5349 474e  e = PRETILT_SIGN
+0000d5a0: 202a 2073 7461 6765 5f74 696c 745f 666c   * stage_tilt_fl
+0000d5b0: 6174 5f74 6f5f 656c 6563 7472 6f6e 0a20  at_to_electron. 
+0000d5c0: 2020 2020 2020 2063 6f72 7265 6374 6564         corrected
+0000d5d0: 5f70 7265 7469 6c74 5f61 6e67 6c65 203d  _pretilt_angle =
+0000d5e0: 2050 5245 5449 4c54 5f53 4947 4e20 2a20   PRETILT_SIGN * 
+0000d5f0: 2873 7461 6765 5f70 7265 7469 6c74 202b  (stage_pretilt +
+0000d600: 2073 7461 6765 5f74 696c 745f 666c 6174   stage_tilt_flat
+0000d610: 5f74 6f5f 656c 6563 7472 6f6e 2920 2320  _to_electron) # 
+0000d620: 656c 6563 7472 6f6e 2061 6e67 6c65 203d  electron angle =
+0000d630: 2030 2c20 696f 6e20 3d20 3532 0a0a 2020   0, ion = 52..  
+0000d640: 2020 2020 2020 2320 7065 7273 7065 6374        # perspect
+0000d650: 6976 6520 7469 6c74 2061 646a 7573 746d  ive tilt adjustm
+0000d660: 656e 7420 2864 6966 6665 7265 6e63 6520  ent (difference 
+0000d670: 6265 7477 6565 6e20 7065 7273 7065 6374  between perspect
+0000d680: 6976 6520 7669 6577 2061 6e64 2073 616d  ive view and sam
+0000d690: 706c 6520 636f 6f72 6469 6e61 7465 2073  ple coordinate s
+0000d6a0: 7973 7465 6d29 0a20 2020 2020 2020 2069  ystem).        i
+0000d6b0: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
+0000d6c0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+0000d6d0: 3a0a 2020 2020 2020 2020 2020 2020 7065  :.            pe
+0000d6e0: 7273 7065 6374 6976 655f 7469 6c74 5f61  rspective_tilt_a
+0000d6f0: 646a 7573 746d 656e 7420 3d20 2d63 6f72  djustment = -cor
+0000d700: 7265 6374 6564 5f70 7265 7469 6c74 5f61  rected_pretilt_a
+0000d710: 6e67 6c65 0a20 2020 2020 2020 2020 2020  ngle.           
+0000d720: 2053 4341 4c45 5f46 4143 544f 5220 3d20   SCALE_FACTOR = 
+0000d730: 312e 3020 2023 2030 2e37 3833 3432 2020  1.0  # 0.78342  
+0000d740: 2320 7061 7465 6e74 6564 2074 6563 686e  # patented techn
+0000d750: 6f6c 6f67 790a 2020 2020 2020 2020 656c  ology.        el
+0000d760: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+0000d770: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+0000d780: 2020 2020 2020 2020 2020 7065 7273 7065            perspe
+0000d790: 6374 6976 655f 7469 6c74 5f61 646a 7573  ctive_tilt_adjus
+0000d7a0: 746d 656e 7420 3d20 280a 2020 2020 2020  tment = (.      
+0000d7b0: 2020 2020 2020 2020 2020 2d63 6f72 7265            -corre
+0000d7c0: 6374 6564 5f70 7265 7469 6c74 5f61 6e67  cted_pretilt_ang
+0000d7d0: 6c65 202d 2073 7461 6765 5f74 696c 745f  le - stage_tilt_
+0000d7e0: 666c 6174 5f74 6f5f 696f 6e0a 2020 2020  flat_to_ion.    
+0000d7f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000d800: 2020 2020 2020 5343 414c 455f 4641 4354        SCALE_FACT
+0000d810: 4f52 203d 2031 2e30 0a0a 2020 2020 2020  OR = 1.0..      
+0000d820: 2020 2320 7468 6520 616d 6f75 6e74 2074    # the amount t
+0000d830: 6865 2073 616d 706c 6520 6861 7320 746f  he sample has to
+0000d840: 206d 6f76 6520 696e 2074 6865 2079 2d61   move in the y-a
+0000d850: 7869 730a 2020 2020 2020 2020 795f 7361  xis.        y_sa
+0000d860: 6d70 6c65 5f6d 6f76 6520 3d20 2865 7870  mple_move = (exp
+0000d870: 6563 7465 645f 7920 2a20 5343 414c 455f  ected_y * SCALE_
+0000d880: 4641 4354 4f52 2920 2f20 6e70 2e63 6f73  FACTOR) / np.cos
+0000d890: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+0000d8a0: 6167 655f 7469 6c74 202b 2070 6572 7370  age_tilt + persp
+0000d8b0: 6563 7469 7665 5f74 696c 745f 6164 6a75  ective_tilt_adju
+0000d8c0: 7374 6d65 6e74 0a20 2020 2020 2020 2029  stment.        )
+0000d8d0: 0a20 2020 2020 2020 0a20 2020 2020 2020  .       .       
+0000d8e0: 2023 2074 6865 2061 6d6f 756e 7420 7468   # the amount th
+0000d8f0: 6520 7374 6167 6520 6861 7320 746f 206d  e stage has to m
+0000d900: 6f76 6520 696e 2065 6163 6820 6178 6973  ove in each axis
+0000d910: 0a20 2020 2020 2020 2079 5f6d 6f76 6520  .        y_move 
+0000d920: 3d20 795f 7361 6d70 6c65 5f6d 6f76 6520  = y_sample_move 
+0000d930: 2a20 6e70 2e63 6f73 2863 6f72 7265 6374  * np.cos(correct
+0000d940: 6564 5f70 7265 7469 6c74 5f61 6e67 6c65  ed_pretilt_angle
+0000d950: 290a 2020 2020 2020 2020 7a5f 6d6f 7665  ).        z_move
+0000d960: 203d 202d 795f 7361 6d70 6c65 5f6d 6f76   = -y_sample_mov
+0000d970: 6520 2a20 6e70 2e73 696e 2863 6f72 7265  e * np.sin(corre
+0000d980: 6374 6564 5f70 7265 7469 6c74 5f61 6e67  cted_pretilt_ang
+0000d990: 6c65 2920 2354 4f44 4f3a 2069 6e76 6573  le) #TODO: inves
+0000d9a0: 7469 6761 7465 2074 6869 730a 0a20 2020  tigate this..   
+0000d9b0: 2020 2020 2072 6574 7572 6e20 4669 6273       return Fibs
+0000d9c0: 656d 5374 6167 6550 6f73 6974 696f 6e28  emStagePosition(
+0000d9d0: 783d 302c 2079 3d79 5f6d 6f76 652c 207a  x=0, y=y_move, z
+0000d9e0: 3d7a 5f6d 6f76 6529 0a20 2020 200a 2020  =z_move).    .  
+0000d9f0: 2020 6465 6620 5f73 6166 655f 726f 7461    def _safe_rota
+0000da00: 7469 6f6e 5f6d 6f76 656d 656e 7428 0a20  tion_movement(. 
+0000da10: 2020 2020 2020 2073 656c 662c 2073 7461         self, sta
+0000da20: 6765 5f70 6f73 6974 696f 6e3a 2046 6962  ge_position: Fib
+0000da30: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+0000da40: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0000da50: 2222 2254 696c 7420 7468 6520 7374 6167  """Tilt the stag
+0000da60: 6520 666c 6174 2077 6865 6e20 7065 7266  e flat when perf
+0000da70: 6f72 6d69 6e67 2061 206c 6172 6765 2072  orming a large r
+0000da80: 6f74 6174 696f 6e20 746f 2070 7265 7665  otation to preve
+0000da90: 6e74 2063 6f6c 6c69 7369 6f6e 2e0a 0a20  nt collision... 
+0000daa0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+0000dab0: 2020 2020 2020 2020 2073 7461 6765 5f70           stage_p
+0000dac0: 6f73 6974 696f 6e20 2853 7461 6765 506f  osition (StagePo
+0000dad0: 7369 7469 6f6e 293a 2064 6573 6972 6564  sition): desired
+0000dae0: 2073 7461 6765 2070 6f73 6974 696f 6e2e   stage position.
+0000daf0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000db00: 2020 2020 2063 7572 7265 6e74 5f70 6f73       current_pos
+0000db10: 6974 696f 6e20 3d20 7365 6c66 2e67 6574  ition = self.get
+0000db20: 5f73 7461 6765 5f70 6f73 6974 696f 6e28  _stage_position(
+0000db30: 290a 0a20 2020 2020 2020 2023 2074 696c  )..        # til
+0000db40: 7420 666c 6174 2066 6f72 206c 6172 6765  t flat for large
+0000db50: 2072 6f74 6174 696f 6e73 2074 6f20 7072   rotations to pr
+0000db60: 6576 656e 7420 636f 6c6c 6973 696f 6e73  event collisions
+0000db70: 0a20 2020 2020 2020 2066 726f 6d20 6669  .        from fi
+0000db80: 6273 656d 2069 6d70 6f72 7420 6d6f 7665  bsem import move
+0000db90: 6d65 6e74 0a20 2020 2020 2020 2069 6620  ment.        if 
+0000dba0: 6d6f 7665 6d65 6e74 2e72 6f74 6174 696f  movement.rotatio
+0000dbb0: 6e5f 616e 676c 655f 6973 5f6c 6172 6765  n_angle_is_large
+0000dbc0: 7228 7374 6167 655f 706f 7369 7469 6f6e  r(stage_position
+0000dbd0: 2e72 2c20 6375 7272 656e 745f 706f 7369  .r, current_posi
+0000dbe0: 7469 6f6e 2e72 293a 0a0a 2020 2020 2020  tion.r):..      
+0000dbf0: 2020 2020 2020 7365 6c66 2e6d 6f76 655f        self.move_
+0000dc00: 7374 6167 655f 6162 736f 6c75 7465 2846  stage_absolute(F
+0000dc10: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
+0000dc20: 6f6e 2874 3d30 2929 0a20 2020 2020 2020  on(t=0)).       
+0000dc30: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0000dc40: 6f28 6622 7469 6c74 696e 6720 746f 2066  o(f"tilting to f
+0000dc50: 6c61 7420 666f 7220 6c61 7267 6520 726f  lat for large ro
+0000dc60: 7461 7469 6f6e 2e22 290a 0a20 2020 2020  tation.")..     
+0000dc70: 2020 2072 6574 7572 6e0a 0a0a 2020 2020     return...    
+0000dc80: 6465 6620 7361 6665 5f61 6273 6f6c 7574  def safe_absolut
+0000dc90: 655f 7374 6167 655f 6d6f 7665 6d65 6e74  e_stage_movement
+0000dca0: 2873 656c 662c 2073 7461 6765 5f70 6f73  (self, stage_pos
+0000dcb0: 6974 696f 6e3a 2046 6962 7365 6d53 7461  ition: FibsemSta
+0000dcc0: 6765 506f 7369 7469 6f6e 0a20 2020 2029  gePosition.    )
+0000dcd0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000dce0: 2020 2222 224d 6f76 6520 7468 6520 7374    """Move the st
+0000dcf0: 6167 6520 746f 2074 6865 2064 6573 6972  age to the desir
+0000dd00: 6564 2070 6f73 6974 696f 6e20 696e 2061  ed position in a
+0000dd10: 2073 6166 6520 6d61 6e6e 6572 2c20 7573   safe manner, us
+0000dd20: 696e 6720 636f 6d70 7563 656e 7472 6963  ing compucentric
+0000dd30: 2072 6f74 6174 696f 6e2e 0a20 2020 2020   rotation..     
+0000dd40: 2020 2053 7570 706f 7274 7320 6d6f 7665     Supports move
+0000dd50: 6d65 6e74 7320 696e 2074 6865 2073 7461  ments in the sta
+0000dd60: 6765 5f70 6f73 6974 696f 6e20 636f 6f72  ge_position coor
+0000dd70: 6469 6e61 7465 2073 7973 7465 6d0a 0a20  dinate system.. 
+0000dd80: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000dd90: 2020 2023 2073 6166 6520 6d6f 7665 6d65     # safe moveme
+0000dda0: 6e74 7320 6172 6520 6e6f 7420 7265 7175  nts are not requ
+0000ddb0: 6972 6564 206f 6e20 7468 6520 636f 6d70  ired on the comp
+0000ddc0: 7573 7461 6765 2c20 6265 6361 7573 6520  ustage, because 
+0000ddd0: 6974 2064 6f65 736e 2774 2072 6f74 6174  it doesn't rotat
+0000dde0: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
+0000ddf0: 2073 656c 662e 7374 6167 655f 6973 5f63   self.stage_is_c
+0000de00: 6f6d 7075 7374 6167 653a 0a0a 2020 2020  ompustage:..    
+0000de10: 2020 2020 2020 2020 2320 7469 6c74 2066          # tilt f
+0000de20: 6c61 7420 666f 7220 6c61 7267 6520 726f  lat for large ro
+0000de30: 7461 7469 6f6e 7320 746f 2070 7265 7665  tations to preve
+0000de40: 6e74 2063 6f6c 6c69 7369 6f6e 730a 2020  nt collisions.  
+0000de50: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0000de60: 7361 6665 5f72 6f74 6174 696f 6e5f 6d6f  safe_rotation_mo
+0000de70: 7665 6d65 6e74 2873 7461 6765 5f70 6f73  vement(stage_pos
+0000de80: 6974 696f 6e29 0a0a 2020 2020 2020 2020  ition)..        
+0000de90: 2020 2020 2320 6d6f 7665 2074 6f20 636f      # move to co
+0000dea0: 6d70 7563 656e 7472 6963 2072 6f74 6174  mpucentric rotat
+0000deb0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0000dec0: 7365 6c66 2e6d 6f76 655f 7374 6167 655f  self.move_stage_
+0000ded0: 6162 736f 6c75 7465 2846 6962 7365 6d53  absolute(FibsemS
+0000dee0: 7461 6765 506f 7369 7469 6f6e 2872 3d73  tagePosition(r=s
+0000def0: 7461 6765 5f70 6f73 6974 696f 6e2e 722c  tage_position.r,
+0000df00: 2063 6f6f 7264 696e 6174 655f 7379 7374   coordinate_syst
+0000df10: 656d 3d22 5241 5722 2929 0a0a 2020 2020  em="RAW"))..    
+0000df20: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+0000df30: 6728 6622 7361 6665 206d 6f76 696e 6720  g(f"safe moving 
+0000df40: 746f 207b 7374 6167 655f 706f 7369 7469  to {stage_positi
+0000df50: 6f6e 7d22 290a 2020 2020 2020 2020 7365  on}").        se
+0000df60: 6c66 2e6d 6f76 655f 7374 6167 655f 6162  lf.move_stage_ab
+0000df70: 736f 6c75 7465 2873 7461 6765 5f70 6f73  solute(stage_pos
+0000df80: 6974 696f 6e29 0a0a 2020 2020 2020 2020  ition)..        
+0000df90: 6c6f 6767 696e 672e 6465 6275 6728 6622  logging.debug(f"
+0000dfa0: 7361 6665 206d 6f76 656d 656e 7420 636f  safe movement co
+0000dfb0: 6d70 6c65 7465 2e22 290a 0a20 2020 2020  mplete.")..     
+0000dfc0: 2020 2072 6574 7572 6e0a 0a20 2020 2064     return..    d
+0000dfd0: 6566 2070 726f 6a65 6374 5f73 7461 626c  ef project_stabl
+0000dfe0: 655f 6d6f 7665 2873 656c 662c 200a 2020  e_move(self, .  
+0000dff0: 2020 2020 2020 6478 3a66 6c6f 6174 2c20        dx:float, 
+0000e000: 6479 3a66 6c6f 6174 2c20 0a20 2020 2020  dy:float, .     
+0000e010: 2020 2062 6561 6d5f 7479 7065 3a42 6561     beam_type:Bea
+0000e020: 6d54 7970 652c 200a 2020 2020 2020 2020  mType, .        
+0000e030: 6261 7365 5f70 6f73 6974 696f 6e3a 4669  base_position:Fi
+0000e040: 6273 656d 5374 6167 6550 6f73 6974 696f  bsemStagePositio
+0000e050: 6e29 202d 3e20 4669 6273 656d 5374 6167  n) -> FibsemStag
+0000e060: 6550 6f73 6974 696f 6e3a 0a20 2020 2020  ePosition:.     
+0000e070: 2020 200a 2020 2020 2020 2020 7363 616e     .        scan
+0000e080: 5f72 6f74 6174 696f 6e20 3d20 7365 6c66  _rotation = self
+0000e090: 2e67 6574 2822 7363 616e 5f72 6f74 6174  .get("scan_rotat
+0000e0a0: 696f 6e22 2c20 6265 616d 5f74 7970 6529  ion", beam_type)
+0000e0b0: 0a20 2020 2020 2020 2069 6620 6e70 2e69  .        if np.i
+0000e0c0: 7363 6c6f 7365 2873 6361 6e5f 726f 7461  sclose(scan_rota
+0000e0d0: 7469 6f6e 2c20 6e70 2e70 6929 3a0a 2020  tion, np.pi):.  
+0000e0e0: 2020 2020 2020 2020 2020 6478 202a 3d20            dx *= 
+0000e0f0: 2d31 2e30 0a20 2020 2020 2020 2020 2020  -1.0.           
+0000e100: 2064 7920 2a3d 202d 312e 300a 2020 2020   dy *= -1.0.    
+0000e110: 2020 2020 0a20 2020 2020 2020 2023 2073      .        # s
+0000e120: 7461 626c 652d 6d6f 7665 2d70 726f 6a65  table-move-proje
+0000e130: 6374 696f 6e0a 2020 2020 2020 2020 706f  ction.        po
+0000e140: 696e 745f 797a 203d 2073 656c 662e 5f79  int_yz = self._y
+0000e150: 5f63 6f72 7265 6374 6564 5f73 7461 6765  _corrected_stage
+0000e160: 5f6d 6f76 656d 656e 7428 6479 2c20 6265  _movement(dy, be
+0000e170: 616d 5f74 7970 6529 0a20 2020 2020 2020  am_type).       
+0000e180: 2064 792c 2064 7a20 3d20 706f 696e 745f   dy, dz = point_
+0000e190: 797a 2e79 2c20 706f 696e 745f 797a 2e7a  yz.y, point_yz.z
+0000e1a0: 0a0a 2020 2020 2020 2020 2320 6361 6c63  ..        # calc
+0000e1b0: 756c 6174 6520 7468 6520 636f 7272 6563  ulate the correc
+0000e1c0: 7465 6420 6d6f 7665 2074 6f20 7265 6163  ted move to reac
+0000e1d0: 6820 7468 6174 2070 6f69 6e74 2066 726f  h that point fro
+0000e1e0: 6d20 6261 7365 2d73 7461 7465 3f0a 2020  m base-state?.  
+0000e1f0: 2020 2020 2020 5f6e 6577 5f70 6f73 6974        _new_posit
+0000e200: 696f 6e20 3d20 6465 6570 636f 7079 2862  ion = deepcopy(b
+0000e210: 6173 655f 706f 7369 7469 6f6e 290a 2020  ase_position).  
+0000e220: 2020 2020 2020 5f6e 6577 5f70 6f73 6974        _new_posit
+0000e230: 696f 6e2e 7820 2b3d 2064 780a 2020 2020  ion.x += dx.    
+0000e240: 2020 2020 5f6e 6577 5f70 6f73 6974 696f      _new_positio
+0000e250: 6e2e 7920 2b3d 2064 790a 2020 2020 2020  n.y += dy.      
+0000e260: 2020 5f6e 6577 5f70 6f73 6974 696f 6e2e    _new_position.
+0000e270: 7a20 2b3d 2064 7a0a 0a20 2020 2020 2020  z += dz..       
+0000e280: 2072 6574 7572 6e20 5f6e 6577 5f70 6f73   return _new_pos
+0000e290: 6974 696f 6e0a 2020 2020 0a20 2020 2064  ition.    .    d
+0000e2a0: 6566 2069 6e73 6572 745f 6d61 6e69 7075  ef insert_manipu
+0000e2b0: 6c61 746f 7228 7365 6c66 2c20 6e61 6d65  lator(self, name
+0000e2c0: 3a20 7374 7220 3d20 2250 4152 4b22 293a  : str = "PARK"):
+0000e2d0: 0a20 2020 2020 2020 2022 2222 496e 7365  .        """Inse
+0000e2e0: 7274 2074 6865 206d 616e 6970 756c 6174  rt the manipulat
+0000e2f0: 6f72 2074 6f20 7468 6520 7370 6563 6966  or to the specif
+0000e300: 6965 6420 706f 7369 7469 6f6e 2222 220a  ied position""".
+0000e310: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000e320: 7365 6c66 2e69 735f 6176 6169 6c61 626c  self.is_availabl
+0000e330: 6528 226d 616e 6970 756c 6174 6f72 2229  e("manipulator")
+0000e340: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000e350: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+0000e360: 4d61 6e69 7075 6c61 746f 7220 6e6f 7420  Manipulator not 
+0000e370: 6176 6169 6c61 626c 652e 2229 0a20 2020  available.").   
+0000e380: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+0000e390: 6620 6e61 6d65 206e 6f74 2069 6e20 5b22  f name not in ["
+0000e3a0: 5041 524b 222c 2022 4555 4345 4e54 5249  PARK", "EUCENTRI
+0000e3b0: 4322 5d3a 0a20 2020 2020 2020 2020 2020  C"]:.           
+0000e3c0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0000e3d0: 7228 6622 696e 7365 7274 2070 6f73 6974  r(f"insert posit
+0000e3e0: 696f 6e20 7b6e 616d 657d 206e 6f74 2073  ion {name} not s
+0000e3f0: 7570 706f 7274 6564 2e22 290a 2020 2020  upported.").    
+0000e400: 2020 2020 6966 2056 4552 5349 4f4e 203c      if VERSION <
+0000e410: 2034 2e37 3a0a 2020 2020 2020 2020 2020   4.7:.          
+0000e420: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+0000e430: 6d65 6e74 6564 4572 726f 7228 224d 616e  mentedError("Man
+0000e440: 6970 756c 6174 6f72 2073 6176 6564 2070  ipulator saved p
+0000e450: 6f73 6974 696f 6e73 206e 6f74 2073 7570  ositions not sup
+0000e460: 706f 7274 6564 2069 6e20 7468 6973 2076  ported in this v
+0000e470: 6572 7369 6f6e 2e20 506c 6561 7365 2075  ersion. Please u
+0000e480: 7067 7261 6465 2074 6f20 342e 3720 6f72  pgrade to 4.7 or
+0000e490: 2068 6967 6865 7222 290a 2020 2020 2020   higher").      
+0000e4a0: 2020 0a20 2020 2020 2020 2023 2067 6574    .        # get
+0000e4b0: 2074 6865 2073 6176 6564 2070 6f73 6974   the saved posit
+0000e4c0: 696f 6e20 6e61 6d65 0a20 2020 2020 2020  ion name.       
+0000e4d0: 2073 6176 6564 5f70 6f73 6974 696f 6e20   saved_position 
+0000e4e0: 3d20 4d61 6e69 7075 6c61 746f 7253 6176  = ManipulatorSav
+0000e4f0: 6564 506f 7369 7469 6f6e 2e50 4152 4b20  edPosition.PARK 
+0000e500: 6966 206e 616d 6520 3d3d 2022 5041 524b  if name == "PARK
+0000e510: 2220 656c 7365 204d 616e 6970 756c 6174  " else Manipulat
+0000e520: 6f72 5361 7665 6450 6f73 6974 696f 6e2e  orSavedPosition.
+0000e530: 4555 4345 4e54 5249 430a 0a20 2020 2020  EUCENTRIC..     
+0000e540: 2020 2023 2067 6574 2074 6865 2069 6e73     # get the ins
+0000e550: 6572 7420 706f 7369 7469 6f6e 0a20 2020  ert position.   
+0000e560: 2020 2020 2069 6e73 6572 745f 706f 7369       insert_posi
+0000e570: 7469 6f6e 203d 2073 656c 662e 636f 6e6e  tion = self.conn
+0000e580: 6563 7469 6f6e 2e73 7065 6369 6d65 6e2e  ection.specimen.
+0000e590: 6d61 6e69 7075 6c61 746f 722e 6765 745f  manipulator.get_
+0000e5a0: 7361 7665 645f 706f 7369 7469 6f6e 280a  saved_position(.
+0000e5b0: 2020 2020 2020 2020 2020 2020 7361 7665              save
+0000e5c0: 645f 706f 7369 7469 6f6e 2c20 4d61 6e69  d_position, Mani
+0000e5d0: 7075 6c61 746f 7243 6f6f 7264 696e 6174  pulatorCoordinat
+0000e5e0: 6553 7973 7465 6d2e 5241 570a 2020 2020  eSystem.RAW.    
+0000e5f0: 2020 2020 290a 2020 2020 2020 2020 2320      ).        # 
+0000e600: 696e 7365 7274 2074 6865 206d 616e 6970  insert the manip
+0000e610: 756c 6174 6f72 0a20 2020 2020 2020 206c  ulator.        l
+0000e620: 6f67 6769 6e67 2e69 6e66 6f28 6622 696e  ogging.info(f"in
+0000e630: 7365 7274 696e 6720 6d61 6e69 7075 6c61  serting manipula
+0000e640: 746f 7220 746f 207b 7361 7665 645f 706f  tor to {saved_po
+0000e650: 7369 7469 6f6e 7d3a 207b 696e 7365 7274  sition}: {insert
+0000e660: 5f70 6f73 6974 696f 6e7d 2e22 290a 2020  _position}.").  
+0000e670: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+0000e680: 6374 696f 6e2e 7370 6563 696d 656e 2e6d  ction.specimen.m
+0000e690: 616e 6970 756c 6174 6f72 2e69 6e73 6572  anipulator.inser
+0000e6a0: 7428 696e 7365 7274 5f70 6f73 6974 696f  t(insert_positio
+0000e6b0: 6e29 0a20 2020 2020 2020 206c 6f67 6769  n).        loggi
+0000e6c0: 6e67 2e69 6e66 6f28 6622 696e 7365 7274  ng.info(f"insert
+0000e6d0: 206d 616e 6970 756c 6174 6f72 2063 6f6d   manipulator com
+0000e6e0: 706c 6574 652e 2229 0a0a 2020 2020 2020  plete.")..      
+0000e6f0: 2020 2320 7265 7475 726e 2074 6865 206d    # return the m
+0000e700: 616e 6970 756c 6174 6f72 2070 6f73 6974  anipulator posit
+0000e710: 696f 6e0a 2020 2020 2020 2020 6d61 6e69  ion.        mani
+0000e720: 7075 6c61 746f 725f 706f 7369 7469 6f6e  pulator_position
+0000e730: 203d 2073 656c 662e 6765 745f 6d61 6e69   = self.get_mani
+0000e740: 7075 6c61 746f 725f 706f 7369 7469 6f6e  pulator_position
+0000e750: 2829 0a20 2020 2020 2020 206c 6f67 6769  ().        loggi
+0000e760: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
+0000e770: 2022 696e 7365 7274 5f6d 616e 6970 756c   "insert_manipul
+0000e780: 6174 6f72 222c 2022 6e61 6d65 223a 206e  ator", "name": n
+0000e790: 616d 652c 2022 706f 7369 7469 6f6e 223a  ame, "position":
+0000e7a0: 206d 616e 6970 756c 6174 6f72 5f70 6f73   manipulator_pos
+0000e7b0: 6974 696f 6e2e 746f 5f64 6963 7428 297d  ition.to_dict()}
+0000e7c0: 2920 2020 2020 2020 2020 2020 2020 2020  )               
+0000e7d0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0000e7e0: 7265 7475 726e 206d 616e 6970 756c 6174  return manipulat
+0000e7f0: 6f72 5f70 6f73 6974 696f 6e0a 0a20 2020  or_position..   
+0000e800: 2064 6566 2072 6574 7261 6374 5f6d 616e   def retract_man
+0000e810: 6970 756c 6174 6f72 2873 656c 6629 3a0a  ipulator(self):.
+0000e820: 2020 2020 2020 2020 2222 2252 6574 7261          """Retra
+0000e830: 6374 2074 6865 206d 616e 6970 756c 6174  ct the manipulat
+0000e840: 6f72 2222 2220 2020 2020 2020 200a 0a20  or"""        .. 
+0000e850: 2020 2020 2020 2069 6620 5645 5253 494f         if VERSIO
+0000e860: 4e20 3c20 342e 373a 0a20 2020 2020 2020  N < 4.7:.       
+0000e870: 2020 2020 2072 6169 7365 204e 6f74 496d       raise NotIm
+0000e880: 706c 656d 656e 7465 6445 7272 6f72 2822  plementedError("
+0000e890: 4d61 6e69 7075 6c61 746f 7220 7361 7665  Manipulator save
+0000e8a0: 6420 706f 7369 7469 6f6e 7320 6e6f 7420  d positions not 
+0000e8b0: 7375 7070 6f72 7465 6420 696e 2074 6869  supported in thi
+0000e8c0: 7320 7665 7273 696f 6e2e 2050 6c65 6173  s version. Pleas
+0000e8d0: 6520 7570 6772 6164 6520 746f 2034 2e37  e upgrade to 4.7
+0000e8e0: 206f 7220 6869 6768 6572 2229 0a0a 2020   or higher")..  
+0000e8f0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+0000e900: 662e 6973 5f61 7661 696c 6162 6c65 2822  f.is_available("
+0000e910: 6d61 6e69 7075 6c61 746f 7222 293a 0a20  manipulator"):. 
+0000e920: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0000e930: 204e 6f74 496d 706c 656d 656e 7465 6445   NotImplementedE
+0000e940: 7272 6f72 2822 4d61 6e69 7075 6c61 746f  rror("Manipulato
+0000e950: 7220 6e6f 7420 6176 6169 6c61 626c 652e  r not available.
+0000e960: 2229 0a0a 2020 2020 2020 2020 2320 5265  ")..        # Re
+0000e970: 7472 6163 7420 7468 6520 6e65 6564 6c65  tract the needle
+0000e980: 2c20 7072 6573 6572 7669 6e67 2074 6865  , preserving the
+0000e990: 2063 6f72 7265 6374 2070 6172 6b69 6e67   correct parking
+0000e9a0: 2070 6f73 7469 696f 6e0a 2020 2020 2020   postiion.      
+0000e9b0: 2020 6e65 6564 6c65 203d 2073 656c 662e    needle = self.
+0000e9c0: 636f 6e6e 6563 7469 6f6e 2e73 7065 6369  connection.speci
+0000e9d0: 6d65 6e2e 6d61 6e69 7075 6c61 746f 720a  men.manipulator.
+0000e9e0: 2020 2020 2020 2020 7061 726b 5f70 6f73          park_pos
+0000e9f0: 6974 696f 6e20 3d20 6e65 6564 6c65 2e67  ition = needle.g
+0000ea00: 6574 5f73 6176 6564 5f70 6f73 6974 696f  et_saved_positio
+0000ea10: 6e28 0a20 2020 2020 2020 2020 2020 204d  n(.            M
+0000ea20: 616e 6970 756c 6174 6f72 5361 7665 6450  anipulatorSavedP
+0000ea30: 6f73 6974 696f 6e2e 5041 524b 2c20 4d61  osition.PARK, Ma
+0000ea40: 6e69 7075 6c61 746f 7243 6f6f 7264 696e  nipulatorCoordin
+0000ea50: 6174 6553 7973 7465 6d2e 5241 570a 2020  ateSystem.RAW.  
+0000ea60: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000ea70: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0000ea80: 7265 7472 6163 7469 6e67 206e 6565 646c  retracting needl
+0000ea90: 6520 746f 207b 7061 726b 5f70 6f73 6974  e to {park_posit
+0000eaa0: 696f 6e7d 2229 0a20 2020 2020 2020 206e  ion}").        n
+0000eab0: 6565 646c 652e 6162 736f 6c75 7465 5f6d  eedle.absolute_m
+0000eac0: 6f76 6528 7061 726b 5f70 6f73 6974 696f  ove(park_positio
+0000ead0: 6e29 0a20 2020 2020 2020 2074 696d 652e  n).        time.
+0000eae0: 736c 6565 7028 3129 2020 2320 4175 746f  sleep(1)  # Auto
+0000eaf0: 5363 7269 7074 2073 6f6d 6574 696d 6573  Script sometimes
+0000eb00: 2074 6872 6f77 7320 6572 726f 7273 2069   throws errors i
+0000eb10: 6620 796f 7520 7265 7472 6163 7420 746f  f you retract to
+0000eb20: 6f20 7175 6963 6b3f 0a20 2020 2020 2020  o quick?.       
+0000eb30: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0000eb40: 7265 7472 6163 7469 6e67 206e 6565 646c  retracting needl
+0000eb50: 652e 2e2e 2229 0a20 2020 2020 2020 206e  e...").        n
+0000eb60: 6565 646c 652e 7265 7472 6163 7428 290a  eedle.retract().
+0000eb70: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000eb80: 696e 666f 2866 2272 6574 7261 6374 206e  info(f"retract n
+0000eb90: 6565 646c 6520 636f 6d70 6c65 7465 2229  eedle complete")
+0000eba0: 0a20 2020 200a 2020 2020 6465 6620 6d6f  .    .    def mo
+0000ebb0: 7665 5f6d 616e 6970 756c 6174 6f72 5f72  ve_manipulator_r
+0000ebc0: 656c 6174 6976 6528 7365 6c66 2c20 706f  elative(self, po
+0000ebd0: 7369 7469 6f6e 3a20 4669 6273 656d 4d61  sition: FibsemMa
+0000ebe0: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+0000ebf0: 6e29 3a0a 2020 2020 2020 2020 5f63 6865  n):.        _che
+0000ec00: 636b 5f6d 616e 6970 756c 6174 6f72 5f6d  ck_manipulator_m
+0000ec10: 6f76 656d 656e 7428 7365 6c66 2e73 7973  ovement(self.sys
+0000ec20: 7465 6d2c 2070 6f73 6974 696f 6e29 0a0a  tem, position)..
+0000ec30: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000ec40: 696e 666f 2866 226d 6f76 696e 6720 6d61  info(f"moving ma
+0000ec50: 6e69 7075 6c61 746f 7220 6279 207b 706f  nipulator by {po
+0000ec60: 7369 7469 6f6e 7d22 290a 0a20 2020 2020  sition}")..     
+0000ec70: 2020 2023 2063 6f6e 7665 7274 2074 6f20     # convert to 
+0000ec80: 6175 746f 7363 7269 7074 2070 6f73 6974  autoscript posit
+0000ec90: 696f 6e0a 2020 2020 2020 2020 6175 746f  ion.        auto
+0000eca0: 7363 7269 7074 5f70 6f73 6974 696f 6e20  script_position 
+0000ecb0: 3d20 706f 7369 7469 6f6e 2e74 6f5f 6175  = position.to_au
+0000ecc0: 746f 7363 7269 7074 5f70 6f73 6974 696f  toscript_positio
+0000ecd0: 6e28 290a 2020 2020 2020 2020 2320 6d6f  n().        # mo
+0000ece0: 7665 206d 616e 6970 756c 6174 6f72 2072  ve manipulator r
+0000ecf0: 656c 6174 6976 650a 2020 2020 2020 2020  elative.        
+0000ed00: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0000ed10: 7370 6563 696d 656e 2e6d 616e 6970 756c  specimen.manipul
+0000ed20: 6174 6f72 2e72 656c 6174 6976 655f 6d6f  ator.relative_mo
+0000ed30: 7665 2861 7574 6f73 6372 6970 745f 706f  ve(autoscript_po
+0000ed40: 7369 7469 6f6e 290a 2020 2020 2020 2020  sition).        
+0000ed50: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
+0000ed60: 6d73 6722 3a20 226d 6f76 655f 6d61 6e69  msg": "move_mani
+0000ed70: 7075 6c61 746f 725f 7265 6c61 7469 7665  pulator_relative
+0000ed80: 222c 2022 706f 7369 7469 6f6e 223a 2070  ", "position": p
+0000ed90: 6f73 6974 696f 6e2e 746f 5f64 6963 7428  osition.to_dict(
+0000eda0: 297d 290a 0a20 2020 2064 6566 206d 6f76  )})..    def mov
+0000edb0: 655f 6d61 6e69 7075 6c61 746f 725f 6162  e_manipulator_ab
+0000edc0: 736f 6c75 7465 2873 656c 662c 2070 6f73  solute(self, pos
+0000edd0: 6974 696f 6e3a 2046 6962 7365 6d4d 616e  ition: FibsemMan
+0000ede0: 6970 756c 6174 6f72 506f 7369 7469 6f6e  ipulatorPosition
+0000edf0: 293a 0a20 2020 2020 2020 2022 2222 4d6f  ):.        """Mo
+0000ee00: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
+0000ee10: 6f72 2074 6f20 7468 6520 7370 6563 6966  or to the specif
+0000ee20: 6965 6420 636f 6f72 6469 6e61 7465 732e  ied coordinates.
+0000ee30: 2222 220a 0a20 2020 2020 2020 205f 6368  """..        _ch
+0000ee40: 6563 6b5f 6d61 6e69 7075 6c61 746f 725f  eck_manipulator_
+0000ee50: 6d6f 7665 6d65 6e74 2873 656c 662e 7379  movement(self.sy
+0000ee60: 7374 656d 2c20 706f 7369 7469 6f6e 290a  stem, position).
+0000ee70: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0000ee80: 696e 666f 2866 226d 6f76 696e 6720 6d61  info(f"moving ma
+0000ee90: 6e69 7075 6c61 746f 7220 746f 207b 706f  nipulator to {po
+0000eea0: 7369 7469 6f6e 7d22 290a 2020 2020 2020  sition}").      
+0000eeb0: 2020 0a20 2020 2020 2020 2023 2063 6f6e    .        # con
+0000eec0: 7665 7274 2074 6f20 6175 746f 7363 7269  vert to autoscri
+0000eed0: 7074 0a20 2020 2020 2020 2061 7574 6f73  pt.        autos
+0000eee0: 6372 6970 745f 706f 7369 7469 6f6e 203d  cript_position =
+0000eef0: 2070 6f73 6974 696f 6e2e 746f 5f61 7574   position.to_aut
+0000ef00: 6f73 6372 6970 745f 706f 7369 7469 6f6e  oscript_position
+0000ef10: 2829 0a20 2020 2020 2020 200a 2020 2020  ().        .    
+0000ef20: 2020 2020 2320 6d6f 7665 206d 616e 6970      # move manip
+0000ef30: 756c 6174 6f72 0a20 2020 2020 2020 2073  ulator.        s
+0000ef40: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
+0000ef50: 7065 6369 6d65 6e2e 6d61 6e69 7075 6c61  pecimen.manipula
+0000ef60: 746f 722e 6162 736f 6c75 7465 5f6d 6f76  tor.absolute_mov
+0000ef70: 6528 6175 746f 7363 7269 7074 5f70 6f73  e(autoscript_pos
+0000ef80: 6974 696f 6e29 0a20 2020 2020 2020 206c  ition).        l
+0000ef90: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
+0000efa0: 7367 223a 2022 6d6f 7665 5f6d 616e 6970  sg": "move_manip
+0000efb0: 756c 6174 6f72 5f61 6273 6f6c 7574 6522  ulator_absolute"
+0000efc0: 2c20 2270 6f73 6974 696f 6e22 3a20 706f  , "position": po
+0000efd0: 7369 7469 6f6e 2e74 6f5f 6469 6374 2829  sition.to_dict()
+0000efe0: 7d29 0a0a 2020 2020 6465 6620 5f78 5f63  })..    def _x_c
+0000eff0: 6f72 7265 6374 6564 5f6e 6565 646c 655f  orrected_needle_
+0000f000: 6d6f 7665 6d65 6e74 2873 656c 662c 2065  movement(self, e
+0000f010: 7870 6563 7465 645f 783a 2066 6c6f 6174  xpected_x: float
+0000f020: 2920 2d3e 2046 6962 7365 6d4d 616e 6970  ) -> FibsemManip
+0000f030: 756c 6174 6f72 506f 7369 7469 6f6e 3a0a  ulatorPosition:.
+0000f040: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
+0000f050: 6c61 7465 2074 6865 2063 6f72 7265 6374  late the correct
+0000f060: 6564 206e 6565 646c 6520 6d6f 7665 6d65  ed needle moveme
+0000f070: 6e74 2074 6f20 6d6f 7665 2069 6e20 7468  nt to move in th
+0000f080: 6520 782d 6178 6973 2e0a 0a20 2020 2020  e x-axis...     
+0000f090: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0000f0a0: 2020 2020 2065 7870 6563 7465 645f 7820       expected_x 
+0000f0b0: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
+0000f0c0: 6520 616c 6f6e 6720 7468 6520 782d 6178  e along the x-ax
+0000f0d0: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
+0000f0e0: 6e61 7465 7329 0a20 2020 2020 2020 2052  nates).        R
+0000f0f0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0000f100: 2020 2020 4669 6273 656d 4d61 6e69 7075      FibsemManipu
+0000f110: 6c61 746f 7250 6f73 6974 696f 6e3a 2078  latorPosition: x
+0000f120: 2d63 6f72 7265 6374 6564 206e 6565 646c  -corrected needl
+0000f130: 6520 6d6f 7665 6d65 6e74 2028 7265 6c61  e movement (rela
+0000f140: 7469 7665 2070 6f73 6974 696f 6e29 0a20  tive position). 
+0000f150: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000f160: 2020 2072 6574 7572 6e20 4669 6273 656d     return Fibsem
+0000f170: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
+0000f180: 696f 6e28 783d 6578 7065 6374 6564 5f78  ion(x=expected_x
+0000f190: 2c20 793d 302c 207a 3d30 2920 2023 206e  , y=0, z=0)  # n
+0000f1a0: 6f20 6164 6a75 7374 6d65 6e74 206e 6565  o adjustment nee
+0000f1b0: 6465 640a 0a0a 2020 2020 6465 6620 5f79  ded...    def _y
+0000f1c0: 5f63 6f72 7265 6374 6564 5f6e 6565 646c  _corrected_needl
+0000f1d0: 655f 6d6f 7665 6d65 6e74 2873 656c 662c  e_movement(self,
+0000f1e0: 200a 2020 2020 2020 2020 6578 7065 6374   .        expect
+0000f1f0: 6564 5f79 3a20 666c 6f61 742c 2073 7461  ed_y: float, sta
+0000f200: 6765 5f74 696c 743a 2066 6c6f 6174 0a20  ge_tilt: float. 
+0000f210: 2020 2029 202d 3e20 4669 6273 656d 4d61     ) -> FibsemMa
+0000f220: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+0000f230: 6e3a 0a20 2020 2020 2020 2022 2222 4361  n:.        """Ca
+0000f240: 6c63 756c 6174 6520 7468 6520 636f 7272  lculate the corr
+0000f250: 6563 7465 6420 6e65 6564 6c65 206d 6f76  ected needle mov
+0000f260: 656d 656e 7420 746f 206d 6f76 6520 696e  ement to move in
+0000f270: 2074 6865 2079 2d61 7869 732e 0a0a 2020   the y-axis...  
+0000f280: 2020 2020 2020 4172 6773 3a0a 2020 2020        Args:.    
+0000f290: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+0000f2a0: 5f79 2028 666c 6f61 7429 3a20 6469 7374  _y (float): dist
+0000f2b0: 616e 6365 2061 6c6f 6e67 2074 6865 2079  ance along the y
+0000f2c0: 2d61 7869 7320 2869 6d61 6765 2063 6f6f  -axis (image coo
+0000f2d0: 7264 696e 6174 6573 290a 2020 2020 2020  rdinates).      
+0000f2e0: 2020 2020 2020 7374 6167 655f 7469 6c74        stage_tilt
+0000f2f0: 2028 666c 6f61 742c 206f 7074 696f 6e61   (float, optiona
+0000f300: 6c29 3a20 7374 6167 6520 7469 6c74 2e0a  l): stage tilt..
+0000f310: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0000f320: 3a0a 2020 2020 2020 2020 2020 2020 4669  :.            Fi
+0000f330: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
+0000f340: 6f73 6974 696f 6e3a 2079 2d63 6f72 7265  osition: y-corre
+0000f350: 6374 6564 206e 6565 646c 6520 6d6f 7665  cted needle move
+0000f360: 6d65 6e74 2028 7265 6c61 7469 7665 2070  ment (relative p
+0000f370: 6f73 6974 696f 6e29 0a20 2020 2020 2020  osition).       
+0000f380: 2022 2222 0a20 2020 2020 2020 2079 5f6d   """.        y_m
+0000f390: 6f76 6520 3d20 2b6e 702e 636f 7328 7374  ove = +np.cos(st
+0000f3a0: 6167 655f 7469 6c74 2920 2a20 6578 7065  age_tilt) * expe
+0000f3b0: 6374 6564 5f79 0a20 2020 2020 2020 207a  cted_y.        z
+0000f3c0: 5f6d 6f76 6520 3d20 2b6e 702e 7369 6e28  _move = +np.sin(
+0000f3d0: 7374 6167 655f 7469 6c74 2920 2a20 6578  stage_tilt) * ex
+0000f3e0: 7065 6374 6564 5f79 0a20 2020 2020 2020  pected_y.       
+0000f3f0: 2072 6574 7572 6e20 4669 6273 656d 4d61   return FibsemMa
+0000f400: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+0000f410: 6e28 783d 302c 2079 3d79 5f6d 6f76 652c  n(x=0, y=y_move,
+0000f420: 207a 3d7a 5f6d 6f76 6529 0a0a 0a20 2020   z=z_move)...   
+0000f430: 2064 6566 205f 7a5f 636f 7272 6563 7465   def _z_correcte
+0000f440: 645f 6e65 6564 6c65 5f6d 6f76 656d 656e  d_needle_movemen
+0000f450: 7428 7365 6c66 2c20 0a20 2020 2020 2020  t(self, .       
+0000f460: 2065 7870 6563 7465 645f 7a3a 2066 6c6f   expected_z: flo
+0000f470: 6174 2c20 7374 6167 655f 7469 6c74 3a20  at, stage_tilt: 
+0000f480: 666c 6f61 740a 2020 2020 2920 2d3e 2046  float.    ) -> F
+0000f490: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+0000f4a0: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
+0000f4b0: 2020 2222 2243 616c 6375 6c61 7465 2074    """Calculate t
+0000f4c0: 6865 2063 6f72 7265 6374 6564 206e 6565  he corrected nee
+0000f4d0: 646c 6520 6d6f 7665 6d65 6e74 2074 6f20  dle movement to 
+0000f4e0: 6d6f 7665 2069 6e20 7468 6520 7a2d 6178  move in the z-ax
+0000f4f0: 6973 2e0a 0a20 2020 2020 2020 2041 7267  is...        Arg
+0000f500: 733a 0a20 2020 2020 2020 2020 2020 2065  s:.            e
+0000f510: 7870 6563 7465 645f 7a20 2866 6c6f 6174  xpected_z (float
+0000f520: 293a 2064 6973 7461 6e63 6520 616c 6f6e  ): distance alon
+0000f530: 6720 7468 6520 7a2d 6178 6973 2028 696d  g the z-axis (im
+0000f540: 6167 6520 636f 6f72 6469 6e61 7465 7329  age coordinates)
+0000f550: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+0000f560: 6765 5f74 696c 7420 2866 6c6f 6174 2c20  ge_tilt (float, 
+0000f570: 6f70 7469 6f6e 616c 293a 2073 7461 6765  optional): stage
+0000f580: 2074 696c 742e 0a0a 2020 2020 2020 2020   tilt...        
+0000f590: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0000f5a0: 2020 2020 2046 6962 7365 6d4d 616e 6970       FibsemManip
+0000f5b0: 756c 6174 6f72 506f 7369 7469 6f6e 3a20  ulatorPosition: 
+0000f5c0: 7a2d 636f 7272 6563 7465 6420 6e65 6564  z-corrected need
+0000f5d0: 6c65 206d 6f76 656d 656e 7420 2872 656c  le movement (rel
+0000f5e0: 6174 6976 6520 706f 7369 7469 6f6e 290a  ative position).
+0000f5f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000f600: 2020 2020 795f 6d6f 7665 203d 202d 6e70      y_move = -np
+0000f610: 2e73 696e 2873 7461 6765 5f74 696c 7429  .sin(stage_tilt)
+0000f620: 202a 2065 7870 6563 7465 645f 7a0a 2020   * expected_z.  
+0000f630: 2020 2020 2020 7a5f 6d6f 7665 203d 202b        z_move = +
+0000f640: 6e70 2e63 6f73 2873 7461 6765 5f74 696c  np.cos(stage_til
+0000f650: 7429 202a 2065 7870 6563 7465 645f 7a0a  t) * expected_z.
+0000f660: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+0000f670: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+0000f680: 506f 7369 7469 6f6e 2878 3d30 2c20 793d  Position(x=0, y=
+0000f690: 795f 6d6f 7665 2c20 7a3d 7a5f 6d6f 7665  y_move, z=z_move
+0000f6a0: 290a 0a20 2020 2064 6566 206d 6f76 655f  )..    def move_
+0000f6b0: 6d61 6e69 7075 6c61 746f 725f 636f 7272  manipulator_corr
+0000f6c0: 6563 7465 6428 7365 6c66 2c20 0a20 2020  ected(self, .   
+0000f6d0: 2020 2020 2064 783a 2066 6c6f 6174 203d       dx: float =
+0000f6e0: 2030 2c0a 2020 2020 2020 2020 6479 3a20   0,.        dy: 
+0000f6f0: 666c 6f61 7420 3d20 302c 0a20 2020 2020  float = 0,.     
+0000f700: 2020 2062 6561 6d5f 7479 7065 3a20 4265     beam_type: Be
+0000f710: 616d 5479 7065 203d 2042 6561 6d54 7970  amType = BeamTyp
+0000f720: 652e 454c 4543 5452 4f4e 2c0a 2020 2020  e.ELECTRON,.    
+0000f730: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0000f740: 2020 2022 2222 4361 6c63 756c 6174 6520     """Calculate 
+0000f750: 7468 6520 7265 7175 6972 6564 2063 6f72  the required cor
+0000f760: 7265 6374 6564 206e 6565 646c 6520 6d6f  rected needle mo
+0000f770: 7665 6d65 6e74 7320 6261 7365 6420 6f6e  vements based on
+0000f780: 2074 6865 2042 6561 6d54 7970 6520 746f   the BeamType to
+0000f790: 206d 6f76 6520 696e 2074 6865 2064 6573   move in the des
+0000f7a0: 6972 6564 2069 6d61 6765 2063 6f6f 7264  ired image coord
+0000f7b0: 696e 6174 6573 2e0a 2020 2020 2020 2020  inates..        
+0000f7c0: 5468 656e 206d 6f76 6520 7468 6520 6e65  Then move the ne
+0000f7d0: 6564 6c65 2072 656c 6174 6976 656c 792e  edle relatively.
+0000f7e0: 204d 616e 6970 756c 6174 6f72 206d 6f76   Manipulator mov
+0000f7f0: 656d 656e 7420 6178 6973 2069 7320 6261  ement axis is ba
+0000f800: 7365 6420 6f6e 2073 7461 6765 2074 696c  sed on stage til
+0000f810: 742c 2073 6f20 7765 206e 6565 6420 746f  t, so we need to
+0000f820: 2061 646a 7573 7420 666f 7220 7468 6174   adjust for that
+0000f830: 200a 2020 2020 2020 2020 7769 7468 2063   .        with c
+0000f840: 6f72 7265 6374 6564 206d 6f76 656d 656e  orrected movemen
+0000f850: 7473 2c20 6465 7065 6e64 696e 6720 6f6e  ts, depending on
+0000f860: 2074 6865 2073 7461 6765 2074 696c 7420   the stage tilt 
+0000f870: 616e 6420 696d 6167 696e 6720 7065 7273  and imaging pers
+0000f880: 7065 6374 6976 652e 0a0a 2020 2020 2020  pective...      
+0000f890: 2020 4265 616d 5479 7065 2e45 4c45 4354    BeamType.ELECT
+0000f8a0: 524f 4e3a 2020 6d6f 7665 2069 6e20 782c  RON:  move in x,
+0000f8b0: 2079 2028 7261 7720 636f 6f72 6469 6e61   y (raw coordina
+0000f8c0: 7465 7329 0a20 2020 2020 2020 2042 6561  tes).        Bea
+0000f8d0: 6d54 7970 652e 494f 4e3a 2020 2020 2020  mType.ION:      
+0000f8e0: 206d 6f76 6520 696e 2078 2c20 7a20 2872   move in x, z (r
+0000f8f0: 6177 2063 6f6f 7264 696e 6174 6573 290a  aw coordinates).
+0000f900: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+0000f910: 2020 2020 2020 2020 2020 206d 6963 726f             micro
+0000f920: 7363 6f70 6520 2846 6962 7365 6d4d 6963  scope (FibsemMic
+0000f930: 726f 7363 6f70 6529 200a 2020 2020 2020  roscope) .      
+0000f940: 2020 2020 2020 6478 2028 666c 6f61 7429        dx (float)
+0000f950: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
+0000f960: 2074 6865 2078 2d61 7869 7320 2869 6d61   the x-axis (ima
+0000f970: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
+0000f980: 2020 2020 2020 2020 2020 2020 6479 2028              dy (
+0000f990: 666c 6f61 7429 3a20 6469 7374 616e 6365  float): distance
+0000f9a0: 2061 6c6f 6e67 2074 6865 2079 2d61 7869   along the y-axi
+0000f9b0: 7320 2869 6d61 6765 2063 6f72 6f64 696e  s (image corodin
+0000f9c0: 6174 6573 290a 2020 2020 2020 2020 2020  ates).          
+0000f9d0: 2020 6265 616d 5f74 7970 6520 2842 6561    beam_type (Bea
+0000f9e0: 6d54 7970 652c 206f 7074 696f 6e61 6c29  mType, optional)
+0000f9f0: 3a20 7468 6520 6265 616d 2074 7970 6520  : the beam type 
+0000fa00: 746f 206d 6f76 6520 696e 2e20 4465 6661  to move in. Defa
+0000fa10: 756c 7473 2074 6f20 4265 616d 5479 7065  ults to BeamType
+0000fa20: 2e45 4c45 4354 524f 4e2e 0a20 2020 2020  .ELECTRON..     
+0000fa30: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
+0000fa40: 6368 6563 6b5f 6d61 6e69 7075 6c61 746f  check_manipulato
+0000fa50: 7228 7365 6c66 2e73 7973 7465 6d29 0a20  r(self.system). 
+0000fa60: 2020 2020 2020 2073 7461 6765 5f74 696c         stage_til
+0000fa70: 7420 3d20 7365 6c66 2e67 6574 5f73 7461  t = self.get_sta
+0000fa80: 6765 5f70 6f73 6974 696f 6e28 292e 740a  ge_position().t.
+0000fa90: 0a20 2020 2020 2020 2023 2078 790a 2020  .        # xy.  
+0000faa0: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
+0000fab0: 7065 2069 7320 4265 616d 5479 7065 2e45  pe is BeamType.E
+0000fac0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
+0000fad0: 2020 2020 2078 5f6d 6f76 6520 3d20 7365       x_move = se
+0000fae0: 6c66 2e5f 785f 636f 7272 6563 7465 645f  lf._x_corrected_
+0000faf0: 6e65 6564 6c65 5f6d 6f76 656d 656e 7428  needle_movement(
+0000fb00: 6578 7065 6374 6564 5f78 3d64 7829 0a20  expected_x=dx). 
+0000fb10: 2020 2020 2020 2020 2020 2079 7a5f 6d6f             yz_mo
+0000fb20: 7665 203d 2073 656c 662e 5f79 5f63 6f72  ve = self._y_cor
+0000fb30: 7265 6374 6564 5f6e 6565 646c 655f 6d6f  rected_needle_mo
+0000fb40: 7665 6d65 6e74 2864 792c 2073 7461 6765  vement(dy, stage
+0000fb50: 5f74 696c 743d 7374 6167 655f 7469 6c74  _tilt=stage_tilt
+0000fb60: 290a 0a20 2020 2020 2020 2023 2078 7a2c  )..        # xz,
+0000fb70: 0a20 2020 2020 2020 2069 6620 6265 616d  .        if beam
+0000fb80: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
+0000fb90: 652e 494f 4e3a 0a0a 2020 2020 2020 2020  e.ION:..        
+0000fba0: 2020 2020 785f 6d6f 7665 203d 2073 656c      x_move = sel
+0000fbb0: 662e 5f78 5f63 6f72 7265 6374 6564 5f6e  f._x_corrected_n
+0000fbc0: 6565 646c 655f 6d6f 7665 6d65 6e74 2865  eedle_movement(e
+0000fbd0: 7870 6563 7465 645f 783d 6478 290a 2020  xpected_x=dx).  
+0000fbe0: 2020 2020 2020 2020 2020 797a 5f6d 6f76            yz_mov
+0000fbf0: 6520 3d20 7365 6c66 2e5f 7a5f 636f 7272  e = self._z_corr
+0000fc00: 6563 7465 645f 6e65 6564 6c65 5f6d 6f76  ected_needle_mov
+0000fc10: 656d 656e 7428 6578 7065 6374 6564 5f7a  ement(expected_z
+0000fc20: 3d64 792c 2073 7461 6765 5f74 696c 743d  =dy, stage_tilt=
+0000fc30: 7374 6167 655f 7469 6c74 290a 0a20 2020  stage_tilt)..   
+0000fc40: 2020 2020 2023 2065 7870 6c69 6369 746c       # explicitl
+0000fc50: 7920 7365 7420 7468 6520 636f 6f72 6469  y set the coordi
+0000fc60: 6e61 7465 2073 7973 7465 6d0a 2020 2020  nate system.    
+0000fc70: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0000fc80: 696f 6e2e 7370 6563 696d 656e 2e6d 616e  ion.specimen.man
+0000fc90: 6970 756c 6174 6f72 2e73 6574 5f64 6566  ipulator.set_def
+0000fca0: 6175 6c74 5f63 6f6f 7264 696e 6174 655f  ault_coordinate_
+0000fcb0: 7379 7374 656d 280a 2020 2020 2020 2020  system(.        
+0000fcc0: 2020 2020 4d61 6e69 7075 6c61 746f 7243      ManipulatorC
+0000fcd0: 6f6f 7264 696e 6174 6553 7973 7465 6d2e  oordinateSystem.
+0000fce0: 5354 4147 450a 2020 2020 2020 2020 290a  STAGE.        ).
+0000fcf0: 2020 2020 2020 2020 6d61 6e69 7075 6c61          manipula
+0000fd00: 746f 725f 706f 7369 7469 6f6e 203d 2046  tor_position = F
+0000fd10: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+0000fd20: 506f 7369 7469 6f6e 2878 3d78 5f6d 6f76  Position(x=x_mov
+0000fd30: 652e 782c 2079 3d79 7a5f 6d6f 7665 2e79  e.x, y=yz_move.y
+0000fd40: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+0000fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd70: 2020 2020 2020 207a 3d79 7a5f 6d6f 7665         z=yz_move
+0000fd80: 2e7a 2c20 0a20 2020 2020 2020 2020 2020  .z, .           
+0000fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdb0: 2020 2020 2020 2020 2072 203d 2030 2e30           r = 0.0
+0000fdc0: 202c 636f 6f72 6469 6e61 7465 5f73 7973   ,coordinate_sys
+0000fdd0: 7465 6d3d 2253 5441 4745 2229 0a20 2020  tem="STAGE").   
+0000fde0: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
+0000fdf0: 6d6f 7665 206d 616e 6970 756c 6174 6f72  move manipulator
+0000fe00: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
+0000fe10: 7665 5f6d 616e 6970 756c 6174 6f72 5f72  ve_manipulator_r
+0000fe20: 656c 6174 6976 6528 6d61 6e69 7075 6c61  elative(manipula
+0000fe30: 746f 725f 706f 7369 7469 6f6e 290a 0a20  tor_position).. 
+0000fe40: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000fe50: 6c66 2e67 6574 5f6d 616e 6970 756c 6174  lf.get_manipulat
+0000fe60: 6f72 5f70 6f73 6974 696f 6e28 290a 2020  or_position().  
+0000fe70: 2020 0a20 2020 2064 6566 206d 6f76 655f    .    def move_
+0000fe80: 6d61 6e69 7075 6c61 746f 725f 746f 5f70  manipulator_to_p
+0000fe90: 6f73 6974 696f 6e5f 6f66 6673 6574 2873  osition_offset(s
+0000fea0: 656c 662c 206f 6666 7365 743a 2046 6962  elf, offset: Fib
+0000feb0: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+0000fec0: 7369 7469 6f6e 2c20 6e61 6d65 3a20 7374  sition, name: st
+0000fed0: 7220 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  r = None) -> Non
+0000fee0: 653a 0a20 2020 2020 2020 2022 2222 4d6f  e:.        """Mo
+0000fef0: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
+0000ff00: 6f72 2074 6f20 7468 6520 7370 6563 6966  or to the specif
+0000ff10: 6965 6420 636f 6f72 6469 6e61 7465 732c  ied coordinates,
+0000ff20: 206f 6666 7365 7420 6279 2074 6865 2070   offset by the p
+0000ff30: 726f 7669 6465 6420 6f66 6673 6574 2e22  rovided offset."
+0000ff40: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
+0000ff50: 6b5f 6d61 6e69 7075 6c61 746f 725f 6d6f  k_manipulator_mo
+0000ff60: 7665 6d65 6e74 2873 656c 662e 7379 7374  vement(self.syst
+0000ff70: 656d 2c20 6f66 6673 6574 290a 2020 2020  em, offset).    
+0000ff80: 2020 2020 0a20 2020 2020 2020 2073 6176      .        sav
+0000ff90: 6564 5f70 6f73 6974 696f 6e20 3d20 7365  ed_position = se
+0000ffa0: 6c66 2e5f 6765 745f 7361 7665 645f 6d61  lf._get_saved_ma
+0000ffb0: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
+0000ffc0: 6f6e 286e 616d 6529 0a0a 2020 2020 2020  on(name)..      
+0000ffd0: 2020 2320 6361 6c63 756c 6174 6520 636f    # calculate co
+0000ffe0: 7272 6563 7465 6420 6d61 6e69 7075 6c61  rrected manipula
+0000fff0: 746f 7220 6d6f 7665 6d65 6e74 0a20 2020  tor movement.   
+00010000: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
+00010010: 3d20 7365 6c66 2e67 6574 5f73 7461 6765  = self.get_stage
+00010020: 5f70 6f73 6974 696f 6e28 292e 740a 2020  _position().t.  
+00010030: 2020 2020 2020 797a 5f6d 6f76 6520 3d20        yz_move = 
+00010040: 7365 6c66 2e5f 7a5f 636f 7272 6563 7465  self._z_correcte
+00010050: 645f 6e65 6564 6c65 5f6d 6f76 656d 656e  d_needle_movemen
+00010060: 7428 6f66 6673 6574 2e7a 2c20 7374 6167  t(offset.z, stag
+00010070: 655f 7469 6c74 290a 0a20 2020 2020 2020  e_tilt)..       
+00010080: 2023 2061 646a 7573 7420 666f 7220 6f66   # adjust for of
+00010090: 6673 6574 0a20 2020 2020 2020 2073 6176  fset.        sav
+000100a0: 6564 5f70 6f73 6974 696f 6e2e 7820 2b3d  ed_position.x +=
+000100b0: 206f 6666 7365 742e 780a 2020 2020 2020   offset.x.      
+000100c0: 2020 7361 7665 645f 706f 7369 7469 6f6e    saved_position
+000100d0: 2e79 202b 3d20 797a 5f6d 6f76 652e 7920  .y += yz_move.y 
+000100e0: 2b20 6f66 6673 6574 2e79 0a20 2020 2020  + offset.y.     
+000100f0: 2020 2073 6176 6564 5f70 6f73 6974 696f     saved_positio
+00010100: 6e2e 7a20 2b3d 2079 7a5f 6d6f 7665 2e7a  n.z += yz_move.z
+00010110: 2020 2320 5241 572c 2075 7020 3d20 6e65    # RAW, up = ne
+00010120: 6761 7469 7665 2c20 5354 4147 453a 2064  gative, STAGE: d
+00010130: 6f77 6e20 3d20 6e65 6761 7469 7665 0a20  own = negative. 
+00010140: 2020 2020 2020 2073 6176 6564 5f70 6f73         saved_pos
+00010150: 6974 696f 6e2e 7220 3d20 4e6f 6e65 2020  ition.r = None  
+00010160: 2320 726f 7461 7469 6f6e 2069 7320 6e6f  # rotation is no
+00010170: 7420 7375 7070 6f72 7465 640a 0a20 2020  t supported..   
+00010180: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
+00010190: 7567 287b 226d 7367 223a 2022 6d6f 7665  ug({"msg": "move
+000101a0: 5f6d 616e 6970 756c 6174 6f72 5f74 6f5f  _manipulator_to_
+000101b0: 706f 7369 7469 6f6e 5f6f 6666 7365 7422  position_offset"
+000101c0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+000101d0: 2020 2020 2020 2020 2020 226e 616d 6522            "name"
+000101e0: 3a20 6e61 6d65 2c20 226f 6666 7365 7422  : name, "offset"
+000101f0: 3a20 6f66 6673 6574 2e74 6f5f 6469 6374  : offset.to_dict
+00010200: 2829 2c20 0a20 2020 2020 2020 2020 2020  (), .           
+00010210: 2020 2020 2020 2020 2020 2020 2273 6176              "sav
+00010220: 6564 5f70 6f73 6974 696f 6e22 3a20 7361  ed_position": sa
+00010230: 7665 645f 706f 7369 7469 6f6e 2e74 6f5f  ved_position.to_
+00010240: 6469 6374 2829 7d29 0a0a 2020 2020 2020  dict()})..      
+00010250: 2020 2320 6d6f 7665 206d 616e 6970 756c    # move manipul
+00010260: 6174 6f72 2061 6273 6f6c 7574 650a 2020  ator absolute.  
+00010270: 2020 2020 2020 7365 6c66 2e6d 6f76 655f        self.move_
+00010280: 6d61 6e69 7075 6c61 746f 725f 6162 736f  manipulator_abso
+00010290: 6c75 7465 2873 6176 6564 5f70 6f73 6974  lute(saved_posit
+000102a0: 696f 6e29 0a20 2020 2020 2020 200a 0a20  ion).        .. 
+000102b0: 2020 2064 6566 205f 6765 745f 7361 7665     def _get_save
+000102c0: 645f 6d61 6e69 7075 6c61 746f 725f 706f  d_manipulator_po
+000102d0: 7369 7469 6f6e 2873 656c 662c 206e 616d  sition(self, nam
+000102e0: 653a 2073 7472 203d 2022 5041 524b 2229  e: str = "PARK")
+000102f0: 202d 3e20 4669 6273 656d 4d61 6e69 7075   -> FibsemManipu
+00010300: 6c61 746f 7250 6f73 6974 696f 6e3a 0a20  latorPosition:. 
+00010310: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00010320: 6966 206e 616d 6520 6e6f 7420 696e 205b  if name not in [
+00010330: 2250 4152 4b22 2c20 2245 5543 454e 5452  "PARK", "EUCENTR
+00010340: 4943 225d 3a0a 2020 2020 2020 2020 2020  IC"]:.          
+00010350: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00010360: 6f72 2866 2273 6176 6564 2070 6f73 6974  or(f"saved posit
+00010370: 696f 6e20 7b6e 616d 657d 206e 6f74 2073  ion {name} not s
+00010380: 7570 706f 7274 6564 2e22 290a 2020 2020  upported.").    
+00010390: 2020 2020 6966 2056 4552 5349 4f4e 203c      if VERSION <
+000103a0: 2034 2e37 3a0a 2020 2020 2020 2020 2020   4.7:.          
+000103b0: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+000103c0: 6d65 6e74 6564 4572 726f 7228 224d 616e  mentedError("Man
+000103d0: 6970 756c 6174 6f72 2073 6176 6564 2070  ipulator saved p
+000103e0: 6f73 6974 696f 6e73 206e 6f74 2073 7570  ositions not sup
+000103f0: 706f 7274 6564 2069 6e20 7468 6973 2076  ported in this v
+00010400: 6572 7369 6f6e 2e20 506c 6561 7365 2075  ersion. Please u
+00010410: 7067 7261 6465 2074 6f20 342e 3720 6f72  pgrade to 4.7 or
+00010420: 2068 6967 6865 7222 290a 2020 2020 2020   higher").      
+00010430: 2020 0a20 2020 2020 2020 206e 616d 6564    .        named
+00010440: 5f70 6f73 6974 696f 6e20 3d20 4d61 6e69  _position = Mani
+00010450: 7075 6c61 746f 7253 6176 6564 506f 7369  pulatorSavedPosi
+00010460: 7469 6f6e 2e50 4152 4b20 6966 206e 616d  tion.PARK if nam
+00010470: 6520 3d3d 2022 5041 524b 2220 656c 7365  e == "PARK" else
+00010480: 204d 616e 6970 756c 6174 6f72 5361 7665   ManipulatorSave
+00010490: 6450 6f73 6974 696f 6e2e 4555 4345 4e54  dPosition.EUCENT
+000104a0: 5249 430a 2020 2020 2020 2020 6175 746f  RIC.        auto
+000104b0: 7363 7269 7074 5f70 6f73 6974 696f 6e20  script_position 
+000104c0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+000104d0: 6e2e 7370 6563 696d 656e 2e6d 616e 6970  n.specimen.manip
+000104e0: 756c 6174 6f72 2e67 6574 5f73 6176 6564  ulator.get_saved
+000104f0: 5f70 6f73 6974 696f 6e28 0a20 2020 2020  _position(.     
+00010500: 2020 2020 2020 2020 2020 206e 616d 6564             named
+00010510: 5f70 6f73 6974 696f 6e2c 204d 616e 6970  _position, Manip
+00010520: 756c 6174 6f72 436f 6f72 6469 6e61 7465  ulatorCoordinate
+00010530: 5379 7374 656d 2e53 5441 4745 2023 2054  System.STAGE # T
+00010540: 4f44 4f3a 2077 6879 2069 7320 7468 6973  ODO: why is this
+00010550: 2053 5441 4745 206e 6f74 2052 4157 3f0a   STAGE not RAW?.
+00010560: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00010570: 2020 2020 2020 2023 2063 6f6e 7665 7274         # convert
+00010580: 2074 6f20 4669 6273 656d 4d61 6e69 7075   to FibsemManipu
+00010590: 6c61 746f 7250 6f73 6974 696f 6e0a 2020  latorPosition.  
+000105a0: 2020 2020 2020 6d61 6e69 7075 6c61 746f        manipulato
+000105b0: 725f 706f 7369 7469 6f6e 203d 2046 6962  r_position = Fib
+000105c0: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+000105d0: 7369 7469 6f6e 2e66 726f 6d5f 6175 746f  sition.from_auto
+000105e0: 7363 7269 7074 5f70 6f73 6974 696f 6e28  script_position(
+000105f0: 6175 746f 7363 7269 7074 5f70 6f73 6974  autoscript_posit
+00010600: 696f 6e29 2020 2020 2020 2020 0a20 2020  ion)        .   
+00010610: 2020 2020 200a 2020 2020 2020 2020 6c6f       .        lo
+00010620: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00010630: 6722 3a20 2267 6574 5f73 6176 6564 5f6d  g": "get_saved_m
+00010640: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
+00010650: 696f 6e22 2c20 226e 616d 6522 3a20 6e61  ion", "name": na
+00010660: 6d65 2c20 2270 6f73 6974 696f 6e22 3a20  me, "position": 
+00010670: 6d61 6e69 7075 6c61 746f 725f 706f 7369  manipulator_posi
+00010680: 7469 6f6e 2e74 6f5f 6469 6374 2829 7d29  tion.to_dict()})
+00010690: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000106a0: 206d 616e 6970 756c 6174 6f72 5f70 6f73   manipulator_pos
+000106b0: 6974 696f 6e20 0a0a 2020 2020 6465 6620  ition ..    def 
+000106c0: 7365 7475 705f 6d69 6c6c 696e 6728 0a20  setup_milling(. 
+000106d0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000106e0: 2020 2020 206d 696c 6c5f 7365 7474 696e       mill_settin
+000106f0: 6773 3a20 4669 6273 656d 4d69 6c6c 696e  gs: FibsemMillin
+00010700: 6753 6574 7469 6e67 732c 0a20 2020 2029  gSettings,.    )
+00010710: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00010720: 2020 2020 2020 436f 6e66 6967 7572 6520        Configure 
+00010730: 7468 6520 6d69 6372 6f73 636f 7065 2066  the microscope f
+00010740: 6f72 206d 696c 6c69 6e67 2075 7369 6e67  or milling using
+00010750: 2074 6865 2069 6f6e 2062 6561 6d2e 0a0a   the ion beam...
+00010760: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00010770: 2020 2020 2020 2020 2020 6d69 6c6c 5f73            mill_s
+00010780: 6574 7469 6e67 7320 2846 6962 7365 6d4d  ettings (FibsemM
+00010790: 696c 6c69 6e67 5365 7474 696e 6773 293a  illingSettings):
+000107a0: 204d 696c 6c69 6e67 2073 6574 7469 6e67   Milling setting
+000107b0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+000107c0: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+000107d0: 616d 2842 6561 6d54 7970 652e 494f 4e2c  am(BeamType.ION,
+000107e0: 2073 656c 662e 7379 7374 656d 290a 2020   self.system).  
+000107f0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00010800: 6374 696f 6e2e 696d 6167 696e 672e 7365  ction.imaging.se
+00010810: 745f 6163 7469 7665 5f76 6965 7728 4265  t_active_view(Be
+00010820: 616d 5479 7065 2e49 4f4e 2e76 616c 7565  amType.ION.value
+00010830: 2920 2023 2074 6865 2069 6f6e 2062 6561  )  # the ion bea
+00010840: 6d20 7669 6577 0a20 2020 2020 2020 2073  m view.        s
+00010850: 656c 662e 636f 6e6e 6563 7469 6f6e 2e69  elf.connection.i
+00010860: 6d61 6769 6e67 2e73 6574 5f61 6374 6976  maging.set_activ
+00010870: 655f 6465 7669 6365 2842 6561 6d54 7970  e_device(BeamTyp
+00010880: 652e 494f 4e2e 7661 6c75 6529 0a20 2020  e.ION.value).   
+00010890: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+000108a0: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
+000108b0: 7365 745f 6465 6661 756c 745f 6265 616d  set_default_beam
+000108c0: 5f74 7970 6528 4265 616d 5479 7065 2e49  _type(BeamType.I
+000108d0: 4f4e 2e76 616c 7565 290a 2020 2020 2020  ON.value).      
+000108e0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+000108f0: 6e2e 7061 7474 6572 6e69 6e67 2e73 6574  n.patterning.set
+00010900: 5f64 6566 6175 6c74 5f61 7070 6c69 6361  _default_applica
+00010910: 7469 6f6e 5f66 696c 6528 6d69 6c6c 5f73  tion_file(mill_s
+00010920: 6574 7469 6e67 732e 6170 706c 6963 6174  ettings.applicat
+00010930: 696f 6e5f 6669 6c65 290a 2020 2020 2020  ion_file).      
+00010940: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00010950: 6e2e 7061 7474 6572 6e69 6e67 2e6d 6f64  n.patterning.mod
+00010960: 6520 3d20 6d69 6c6c 5f73 6574 7469 6e67  e = mill_setting
+00010970: 732e 7061 7474 6572 6e69 6e67 5f6d 6f64  s.patterning_mod
+00010980: 650a 2020 2020 2020 2020 7365 6c66 2e63  e.        self.c
+00010990: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
+000109a0: 6e69 6e67 2e63 6c65 6172 5f70 6174 7465  ning.clear_patte
+000109b0: 726e 7328 2920 2023 2063 6c65 6172 2061  rns()  # clear a
+000109c0: 6e79 2065 7869 7374 696e 6720 7061 7474  ny existing patt
+000109d0: 6572 6e73 0a20 2020 2020 2020 2073 656c  erns.        sel
+000109e0: 662e 636f 6e6e 6563 7469 6f6e 2e62 6561  f.connection.bea
+000109f0: 6d73 2e69 6f6e 5f62 6561 6d2e 686f 7269  ms.ion_beam.hori
+00010a00: 7a6f 6e74 616c 5f66 6965 6c64 5f77 6964  zontal_field_wid
+00010a10: 7468 2e76 616c 7565 203d 206d 696c 6c5f  th.value = mill_
+00010a20: 7365 7474 696e 6773 2e68 6677 0a0a 2020  settings.hfw..  
+00010a30: 2020 2020 2020 2320 7365 6c66 2e73 6574        # self.set
+00010a40: 2822 6866 7722 2c20 6d69 6c6c 5f73 6574  ("hfw", mill_set
+00010a50: 7469 6e67 732e 6866 772c 2042 6561 6d54  tings.hfw, BeamT
+00010a60: 7970 652e 494f 4e29 2023 2054 4f44 4f3a  ype.ION) # TODO:
+00010a70: 2072 6570 6c61 6365 0a20 2020 2020 2020   replace.       
+00010a80: 2073 656c 662e 7365 7428 2263 7572 7265   self.set("curre
+00010a90: 6e74 222c 206d 696c 6c5f 7365 7474 696e  nt", mill_settin
+00010aa0: 6773 2e6d 696c 6c69 6e67 5f63 7572 7265  gs.milling_curre
+00010ab0: 6e74 2c20 4265 616d 5479 7065 2e49 4f4e  nt, BeamType.ION
+00010ac0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
+00010ad0: 6574 2822 766f 6c74 6167 6522 2c20 6d69  et("voltage", mi
+00010ae0: 6c6c 5f73 6574 7469 6e67 732e 6d69 6c6c  ll_settings.mill
+00010af0: 696e 675f 766f 6c74 6167 652c 2042 6561  ing_voltage, Bea
+00010b00: 6d54 7970 652e 494f 4e29 0a20 2020 200a  mType.ION).    .
+00010b10: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00010b20: 6465 6275 6728 7b22 6d73 6722 3a20 2273  debug({"msg": "s
+00010b30: 6574 7570 5f6d 696c 6c69 6e67 222c 2022  etup_milling", "
+00010b40: 6d69 6c6c 5f73 6574 7469 6e67 7322 3a20  mill_settings": 
+00010b50: 6d69 6c6c 5f73 6574 7469 6e67 732e 746f  mill_settings.to
+00010b60: 5f64 6963 7428 297d 290a 0a20 2020 2064  _dict()})..    d
+00010b70: 6566 2072 756e 5f6d 696c 6c69 6e67 2873  ef run_milling(s
+00010b80: 656c 662c 206d 696c 6c69 6e67 5f63 7572  elf, milling_cur
+00010b90: 7265 6e74 3a20 666c 6f61 742c 206d 696c  rent: float, mil
+00010ba0: 6c69 6e67 5f76 6f6c 7461 6765 3a20 666c  ling_voltage: fl
+00010bb0: 6f61 742c 2061 7379 6e63 683a 2062 6f6f  oat, asynch: boo
+00010bc0: 6c20 3d20 4661 6c73 6529 3a0a 2020 2020  l = False):.    
+00010bd0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00010be0: 5275 6e20 696f 6e20 6265 616d 206d 696c  Run ion beam mil
+00010bf0: 6c69 6e67 2075 7369 6e67 2074 6865 2073  ling using the s
+00010c00: 7065 6369 6669 6564 206d 696c 6c69 6e67  pecified milling
+00010c10: 2063 7572 7265 6e74 2e0a 0a20 2020 2020   current...     
+00010c20: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00010c30: 2020 2020 206d 696c 6c69 6e67 5f63 7572       milling_cur
+00010c40: 7265 6e74 2028 666c 6f61 7429 3a20 5468  rent (float): Th
+00010c50: 6520 6375 7272 656e 7420 746f 2075 7365  e current to use
+00010c60: 2066 6f72 206d 696c 6c69 6e67 2069 6e20   for milling in 
+00010c70: 616d 7073 2e0a 2020 2020 2020 2020 2020  amps..          
+00010c80: 2020 6173 796e 6368 2028 626f 6f6c 2c20    asynch (bool, 
+00010c90: 6f70 7469 6f6e 616c 293a 2049 6620 5472  optional): If Tr
+00010ca0: 7565 2c20 7468 6520 6d69 6c6c 696e 6720  ue, the milling 
+00010cb0: 7769 6c6c 2062 6520 7275 6e20 6173 796e  will be run asyn
+00010cc0: 6368 726f 6e6f 7573 6c79 2e20 0a20 2020  chronously. .   
+00010cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cf0: 2020 4465 6661 756c 7473 2074 6f20 4661    Defaults to Fa
+00010d00: 6c73 652c 2069 6e20 7768 6963 6820 6361  lse, in which ca
+00010d10: 7365 2069 7420 7769 6c6c 2072 756e 2073  se it will run s
+00010d20: 796e 6368 726f 6e6f 7573 6c79 2e0a 0a20  ynchronously... 
+00010d30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00010d40: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+00010d50: 735f 6176 6169 6c61 626c 6528 2269 6f6e  s_available("ion
+00010d60: 5f62 6561 6d22 293a 0a20 2020 2020 2020  _beam"):.       
+00010d70: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00010d80: 4572 726f 7228 2249 6f6e 2062 6561 6d20  Error("Ion beam 
+00010d90: 6e6f 7420 6176 6169 6c61 626c 652e 2229  not available.")
+00010da0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00010db0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00010dc0: 2020 2023 2063 6861 6e67 6520 746f 206d     # change to m
+00010dd0: 696c 6c69 6e67 2063 7572 7265 6e74 2c20  illing current, 
+00010de0: 766f 6c74 6167 650a 2020 2020 2020 2020  voltage.        
+00010df0: 2020 2020 6966 2073 656c 662e 6765 7428      if self.get(
+00010e00: 2276 6f6c 7461 6765 222c 2042 6561 6d54  "voltage", BeamT
+00010e10: 7970 652e 494f 4e29 2021 3d20 6d69 6c6c  ype.ION) != mill
+00010e20: 696e 675f 766f 6c74 6167 653a 0a20 2020  ing_voltage:.   
+00010e30: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00010e40: 662e 7365 7428 2276 6f6c 7461 6765 222c  f.set("voltage",
+00010e50: 206d 696c 6c69 6e67 5f76 6f6c 7461 6765   milling_voltage
+00010e60: 2c20 4265 616d 5479 7065 2e49 4f4e 290a  , BeamType.ION).
+00010e70: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00010e80: 656c 662e 6765 7428 2263 7572 7265 6e74  elf.get("current
+00010e90: 222c 2042 6561 6d54 7970 652e 494f 4e29  ", BeamType.ION)
+00010ea0: 2021 3d20 6d69 6c6c 696e 675f 6375 7272   != milling_curr
+00010eb0: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+00010ec0: 2020 2020 2073 656c 662e 7365 7428 2263       self.set("c
+00010ed0: 7572 7265 6e74 222c 206d 696c 6c69 6e67  urrent", milling
+00010ee0: 5f63 7572 7265 6e74 2c20 4265 616d 5479  _current, BeamTy
+00010ef0: 7065 2e49 4f4e 290a 2020 2020 2020 2020  pe.ION).        
+00010f00: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00010f10: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00010f20: 2020 206c 6f67 6769 6e67 2e77 6172 6e69     logging.warni
+00010f30: 6e67 2866 2246 6169 6c65 6420 746f 2073  ng(f"Failed to s
+00010f40: 6574 2076 6f6c 7461 6765 206f 7220 6375  et voltage or cu
+00010f50: 7272 656e 743a 207b 657d 2c20 766f 6c74  rrent: {e}, volt
+00010f60: 6167 653d 7b6d 696c 6c69 6e67 5f76 6f6c  age={milling_vol
+00010f70: 7461 6765 7d2c 2063 7572 7265 6e74 3d7b  tage}, current={
+00010f80: 6d69 6c6c 696e 675f 6375 7272 656e 747d  milling_current}
+00010f90: 2229 0a0a 2020 2020 2020 2020 2320 7275  ")..        # ru
+00010fa0: 6e20 6d69 6c6c 696e 6720 2861 7379 6e63  n milling (async
+00010fb0: 6872 6f6e 6f75 736c 7929 0a20 2020 2020  hronously).     
+00010fc0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00010fd0: 6f6e 2e69 6d61 6769 6e67 2e73 6574 5f61  on.imaging.set_a
+00010fe0: 6374 6976 655f 7669 6577 2842 6561 6d54  ctive_view(BeamT
+00010ff0: 7970 652e 494f 4e2e 7661 6c75 6529 2020  ype.ION.value)  
+00011000: 2320 7468 6520 696f 6e20 6265 616d 2076  # the ion beam v
+00011010: 6965 770a 2020 2020 2020 2020 6c6f 6767  iew.        logg
+00011020: 696e 672e 696e 666f 2866 2272 756e 6e69  ing.info(f"runni
+00011030: 6e67 2069 6f6e 2062 6561 6d20 6d69 6c6c  ng ion beam mill
+00011040: 696e 6720 6e6f 772e 2e2e 2061 7379 6e63  ing now... async
+00011050: 6872 6f6e 6f75 733d 7b61 7379 6e63 687d  hronous={asynch}
+00011060: 2229 0a20 2020 2020 2020 2069 6620 6173  ").        if as
+00011070: 796e 6368 3a0a 2020 2020 2020 2020 2020  ynch:.          
+00011080: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00011090: 6e2e 7061 7474 6572 6e69 6e67 2e73 7461  n.patterning.sta
+000110a0: 7274 2829 0a20 2020 2020 2020 2065 6c73  rt().        els
+000110b0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000110c0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+000110d0: 6174 7465 726e 696e 672e 7374 6172 7428  atterning.start(
+000110e0: 290a 2020 2020 2020 2020 2020 2020 7768  ).            wh
+000110f0: 696c 6520 7365 6c66 2e63 6f6e 6e65 6374  ile self.connect
+00011100: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
+00011110: 7461 7465 203d 3d20 5061 7474 6572 6e69  tate == Patterni
+00011120: 6e67 5374 6174 652e 4944 4c45 3a20 2320  ngState.IDLE: # 
+00011130: 6769 7669 6e67 2074 696d 6520 746f 2073  giving time to s
+00011140: 7461 7274 200a 2020 2020 2020 2020 2020  tart .          
+00011150: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
+00011160: 2830 2e35 290a 2020 2020 2020 2020 2020  (0.5).          
+00011170: 2020 7768 696c 6520 7365 6c66 2e63 6f6e    while self.con
+00011180: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+00011190: 6e67 2e73 7461 7465 203d 3d20 5061 7474  ng.state == Patt
+000111a0: 6572 6e69 6e67 5374 6174 652e 5255 4e4e  erningState.RUNN
+000111b0: 494e 473a 0a20 2020 2020 2020 2020 2020  ING:.           
+000111c0: 2020 2020 2023 206c 6f67 6769 6e67 2e69       # logging.i
+000111d0: 6e66 6f28 6622 5061 7474 6572 6e69 6e67  nfo(f"Patterning
+000111e0: 2053 7461 7465 3a20 7b73 656c 662e 636f   State: {self.co
+000111f0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
+00011200: 696e 672e 7374 6174 657d 2229 0a20 2020  ing.state}").   
+00011210: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+00011220: 652e 736c 6565 7028 3129 2020 2020 2020  e.sleep(1)      
+00011230: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00011240: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
+00011250: 7465 726e 696e 672e 636c 6561 725f 7061  terning.clear_pa
+00011260: 7474 6572 6e73 2829 0a20 2020 2020 2020  tterns().       
+00011270: 2023 204e 4f54 453a 204d 616b 6520 7465   # NOTE: Make te
+00011280: 7363 616e 206c 6f67 7320 7468 6520 7361  scan logs the sa
+00011290: 6d65 3f3f 0a20 2020 2020 2020 2020 2020  me??.           
+000112a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112b0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+000112c0: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
+000112d0: 7b22 6d73 6722 3a20 2272 756e 5f6d 696c  {"msg": "run_mil
+000112e0: 6c69 6e67 222c 2022 6d69 6c6c 696e 675f  ling", "milling_
+000112f0: 6375 7272 656e 7422 3a20 6d69 6c6c 696e  current": millin
+00011300: 675f 6375 7272 656e 742c 2022 6d69 6c6c  g_current, "mill
+00011310: 696e 675f 766f 6c74 6167 6522 3a20 6d69  ing_voltage": mi
+00011320: 6c6c 696e 675f 766f 6c74 6167 652c 2022  lling_voltage, "
+00011330: 6173 796e 6368 223a 2061 7379 6e63 687d  asynch": asynch}
+00011340: 290a 0a20 2020 2064 6566 2072 756e 5f6d  )..    def run_m
+00011350: 696c 6c69 6e67 5f64 7269 6674 5f63 6f72  illing_drift_cor
+00011360: 7265 6374 6564 2873 656c 662c 206d 696c  rected(self, mil
+00011370: 6c69 6e67 5f63 7572 7265 6e74 3a20 666c  ling_current: fl
+00011380: 6f61 742c 200a 2020 2020 2020 2020 2020  oat, .          
+00011390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113a0: 2020 2020 2020 2020 2020 6d69 6c6c 696e            millin
+000113b0: 675f 766f 6c74 6167 653a 2066 6c6f 6174  g_voltage: float
+000113c0: 2c20 200a 2020 2020 2020 2020 2020 2020  ,  .            
+000113d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113e0: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
+000113f0: 7474 696e 6773 3a20 496d 6167 6553 6574  ttings: ImageSet
+00011400: 7469 6e67 732c 200a 2020 2020 2020 2020  tings, .        
+00011410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011420: 2020 2020 2020 2020 2020 2020 7265 665f              ref_
+00011430: 696d 6167 653a 2046 6962 7365 6d49 6d61  image: FibsemIma
+00011440: 6765 2c20 0a20 2020 2020 2020 2020 2020  ge, .           
+00011450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011460: 2020 2020 2020 2020 2072 6564 7563 6564           reduced
+00011470: 5f61 7265 613a 2046 6962 7365 6d52 6563  _area: FibsemRec
+00011480: 7461 6e67 6c65 203d 204e 6f6e 652c 0a20  tangle = None,. 
+00011490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114b0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+000114c0: 220a 2020 2020 2020 2020 5275 6e20 696f  ".        Run io
+000114d0: 6e20 6265 616d 206d 696c 6c69 6e67 2075  n beam milling u
+000114e0: 7369 6e67 2074 6865 2073 7065 6369 6669  sing the specifi
+000114f0: 6564 206d 696c 6c69 6e67 2063 7572 7265  ed milling curre
+00011500: 6e74 2e0a 0a20 2020 2020 2020 2041 7267  nt...        Arg
+00011510: 733a 0a20 2020 2020 2020 2020 2020 206d  s:.            m
+00011520: 696c 6c69 6e67 5f63 7572 7265 6e74 2028  illing_current (
+00011530: 666c 6f61 7429 3a20 5468 6520 6375 7272  float): The curr
+00011540: 656e 7420 746f 2075 7365 2066 6f72 206d  ent to use for m
+00011550: 696c 6c69 6e67 2069 6e20 616d 7073 2e0a  illing in amps..
+00011560: 2020 2020 2020 2020 2020 2020 6173 796e              asyn
+00011570: 6368 2028 626f 6f6c 2c20 6f70 7469 6f6e  ch (bool, option
+00011580: 616c 293a 2049 6620 5472 7565 2c20 7468  al): If True, th
+00011590: 6520 6d69 6c6c 696e 6720 7769 6c6c 2062  e milling will b
+000115a0: 6520 7275 6e20 6173 796e 6368 726f 6e6f  e run asynchrono
+000115b0: 7573 6c79 2e20 0a20 2020 2020 2020 2020  usly. .         
+000115c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000115d0: 2020 2020 2020 2020 2020 2020 4465 6661              Defa
+000115e0: 756c 7473 2074 6f20 4661 6c73 652c 2069  ults to False, i
+000115f0: 6e20 7768 6963 6820 6361 7365 2069 7420  n which case it 
+00011600: 7769 6c6c 2072 756e 2073 796e 6368 726f  will run synchro
+00011610: 6e6f 7573 6c79 2e0a 0a20 2020 2020 2020  nously...       
+00011620: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00011630: 2020 2020 2020 4e6f 6e65 0a0a 2020 2020        None..    
+00011640: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00011650: 2020 2020 2020 2020 4e6f 6e65 0a20 2020          None.   
+00011660: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00011670: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
+00011680: 6d54 7970 652e 494f 4e2c 2073 656c 662e  mType.ION, self.
+00011690: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+000116a0: 2320 6368 616e 6765 2074 6f20 6d69 6c6c  # change to mill
+000116b0: 696e 6720 6375 7272 656e 740a 2020 2020  ing current.    
+000116c0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+000116d0: 696f 6e2e 696d 6167 696e 672e 7365 745f  ion.imaging.set_
+000116e0: 6163 7469 7665 5f76 6965 7728 4265 616d  active_view(Beam
+000116f0: 5479 7065 2e49 4f4e 2e76 616c 7565 2920  Type.ION.value) 
+00011700: 2023 2074 6865 2069 6f6e 2062 6561 6d20   # the ion beam 
+00011710: 7669 6577 0a20 2020 2020 2020 2069 6620  view.        if 
+00011720: 7365 6c66 2e67 6574 2822 766f 6c74 6167  self.get("voltag
+00011730: 6522 2c20 4265 616d 5479 7065 2e49 4f4e  e", BeamType.ION
+00011740: 2920 213d 206d 696c 6c69 6e67 5f76 6f6c  ) != milling_vol
+00011750: 7461 6765 3a0a 2020 2020 2020 2020 2020  tage:.          
+00011760: 2020 7365 6c66 2e73 6574 2822 766f 6c74    self.set("volt
+00011770: 6167 6522 2c20 6d69 6c6c 696e 675f 766f  age", milling_vo
+00011780: 6c74 6167 652c 2042 6561 6d54 7970 652e  ltage, BeamType.
+00011790: 494f 4e29 0a20 2020 2020 2020 2069 6620  ION).        if 
+000117a0: 7365 6c66 2e67 6574 2822 6375 7272 656e  self.get("curren
+000117b0: 7422 2c20 4265 616d 5479 7065 2e49 4f4e  t", BeamType.ION
+000117c0: 2920 213d 206d 696c 6c69 6e67 5f63 7572  ) != milling_cur
+000117d0: 7265 6e74 3a0a 2020 2020 2020 2020 2020  rent:.          
+000117e0: 2020 7365 6c66 2e73 6574 2822 6375 7272    self.set("curr
+000117f0: 656e 7422 2c20 6d69 6c6c 696e 675f 6375  ent", milling_cu
+00011800: 7272 656e 742c 2042 6561 6d54 7970 652e  rrent, BeamType.
+00011810: 494f 4e29 0a0a 0a20 2020 2020 2020 2023  ION)...        #
+00011820: 2072 756e 206d 696c 6c69 6e67 2028 6173   run milling (as
+00011830: 796e 6368 726f 6e6f 7573 6c79 290a 2020  ynchronously).  
+00011840: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00011850: 666f 2866 2272 756e 6e69 6e67 2069 6f6e  fo(f"running ion
+00011860: 2062 6561 6d20 6d69 6c6c 696e 6720 6e6f   beam milling no
+00011870: 772e 2229 0a0a 2020 2020 2020 2020 7365  w.")..        se
+00011880: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+00011890: 7474 6572 6e69 6e67 2e73 7461 7274 2829  tterning.start()
+000118a0: 0a20 2020 2020 2020 2023 204e 4f54 453a  .        # NOTE:
+000118b0: 204d 616b 6520 7465 7363 616e 206c 6f67   Make tescan log
+000118c0: 7320 7468 6520 7361 6d65 3f3f 0a20 2020  s the same??.   
+000118d0: 2020 2020 2066 726f 6d20 6669 6273 656d       from fibsem
+000118e0: 2069 6d70 6f72 7420 616c 6967 6e6d 656e   import alignmen
+000118f0: 740a 2020 2020 2020 2020 7768 696c 6520  t.        while 
+00011900: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00011910: 7061 7474 6572 6e69 6e67 2e73 7461 7465  patterning.state
+00011920: 203d 3d20 5061 7474 6572 6e69 6e67 5374   == PatterningSt
+00011930: 6174 652e 4944 4c45 3a20 2320 6769 7669  ate.IDLE: # givi
+00011940: 6e67 2074 696d 6520 746f 2073 7461 7274  ng time to start
+00011950: 200a 2020 2020 2020 2020 2020 2020 7469   .            ti
+00011960: 6d65 2e73 6c65 6570 2830 2e35 290a 2020  me.sleep(0.5).  
+00011970: 2020 2020 2020 7768 696c 6520 7365 6c66        while self
+00011980: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
+00011990: 6572 6e69 6e67 2e73 7461 7465 203d 3d20  erning.state == 
+000119a0: 5061 7474 6572 6e69 6e67 5374 6174 652e  PatterningState.
+000119b0: 5255 4e4e 494e 473a 0a0a 2020 2020 2020  RUNNING:..      
+000119c0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+000119d0: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
+000119e0: 2e70 6175 7365 2829 0a20 2020 2020 2020  .pause().       
+000119f0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00011a00: 6f28 2244 7269 6674 2063 6f72 7265 6374  o("Drift correct
+00011a10: 696f 6e22 290a 2020 2020 2020 2020 2020  ion").          
+00011a20: 2020 616c 6967 6e6d 656e 742e 6265 616d    alignment.beam
+00011a30: 5f73 6869 6674 5f61 6c69 676e 6d65 6e74  _shift_alignment
+00011a40: 5f76 3228 6d69 6372 6f73 636f 7065 203d  _v2(microscope =
+00011a50: 2073 656c 662c 2072 6566 5f69 6d61 6765   self, ref_image
+00011a60: 3d72 6566 5f69 6d61 6765 290a 2020 2020  =ref_image).    
+00011a70: 2020 2020 2020 2020 7469 6d65 2e73 6c65          time.sle
+00011a80: 6570 2831 2920 2320 6e65 6564 2064 656c  ep(1) # need del
+00011a90: 6179 2074 6f20 7377 6974 6368 2062 6163  ay to switch bac
+00011aa0: 6b20 746f 2070 6174 7465 726e 696e 6720  k to patterning 
+00011ab0: 6d6f 6465 200a 2020 2020 2020 2020 2020  mode .          
+00011ac0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00011ad0: 6e2e 696d 6167 696e 672e 7365 745f 6163  n.imaging.set_ac
+00011ae0: 7469 7665 5f76 6965 7728 4265 616d 5479  tive_view(BeamTy
+00011af0: 7065 2e49 4f4e 2e76 616c 7565 290a 2020  pe.ION.value).  
+00011b00: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00011b10: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
+00011b20: 7465 726e 696e 672e 7374 6174 6520 3d3d  terning.state ==
+00011b30: 2050 6174 7465 726e 696e 6753 7461 7465   PatterningState
+00011b40: 2e50 4155 5345 443a 2023 2063 6865 636b  .PAUSED: # check
+00011b50: 2069 6620 6669 6e69 7368 6564 200a 2020   if finished .  
+00011b60: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00011b70: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+00011b80: 7474 6572 6e69 6e67 2e72 6573 756d 6528  tterning.resume(
+00011b90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011ba0: 2020 7469 6d65 2e73 6c65 6570 2835 290a    time.sleep(5).
+00011bb0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00011bc0: 696e 672e 696e 666f 2866 2250 6174 7465  ing.info(f"Patte
+00011bd0: 726e 696e 6720 5374 6174 653a 207b 7365  rning State: {se
+00011be0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+00011bf0: 7474 6572 6e69 6e67 2e73 7461 7465 7d22  tterning.state}"
+00011c00: 290a 0a0a 2020 2020 6465 6620 6669 6e69  )...    def fini
+00011c10: 7368 5f6d 696c 6c69 6e67 2873 656c 662c  sh_milling(self,
+00011c20: 2069 6d61 6769 6e67 5f63 7572 7265 6e74   imaging_current
+00011c30: 3a20 666c 6f61 742c 2069 6d61 6769 6e67  : float, imaging
+00011c40: 5f76 6f6c 7461 6765 3a20 666c 6f61 7429  _voltage: float)
+00011c50: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00011c60: 2020 2020 2020 4669 6e61 6c69 7365 7320        Finalises 
+00011c70: 7468 6520 6d69 6c6c 696e 6720 7072 6f63  the milling proc
+00011c80: 6573 7320 6279 2063 6c65 6172 696e 6720  ess by clearing 
+00011c90: 7468 6520 6d69 6372 6f73 636f 7065 206f  the microscope o
+00011ca0: 6620 616e 7920 7061 7474 6572 6e73 2061  f any patterns a
+00011cb0: 6e64 2072 6574 7572 6e69 6e67 2074 6865  nd returning the
+00011cc0: 2063 7572 7265 6e74 2074 6f20 7468 6520   current to the 
+00011cd0: 696d 6167 696e 6720 6375 7272 656e 742e  imaging current.
+00011ce0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00011cf0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00011d00: 696e 675f 6375 7272 656e 7420 2866 6c6f  ing_current (flo
+00011d10: 6174 293a 2054 6865 2063 7572 7265 6e74  at): The current
+00011d20: 2074 6f20 7573 6520 666f 7220 696d 6167   to use for imag
+00011d30: 696e 6720 696e 2061 6d70 732e 0a20 2020  ing in amps..   
+00011d40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00011d50: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
+00011d60: 6d54 7970 652e 494f 4e2c 2073 656c 662e  mType.ION, self.
+00011d70: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+00011d80: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00011d90: 7061 7474 6572 6e69 6e67 2e63 6c65 6172  patterning.clear
+00011da0: 5f70 6174 7465 726e 7328 290a 2020 2020  _patterns().    
+00011db0: 2020 2020 7365 6c66 2e73 6574 2822 6375      self.set("cu
+00011dc0: 7272 656e 7422 2c20 696d 6167 696e 675f  rrent", imaging_
+00011dd0: 6375 7272 656e 742c 2042 6561 6d54 7970  current, BeamTyp
+00011de0: 652e 494f 4e29 0a20 2020 2020 2020 2073  e.ION).        s
+00011df0: 656c 662e 7365 7428 2276 6f6c 7461 6765  elf.set("voltage
+00011e00: 222c 2069 6d61 6769 6e67 5f76 6f6c 7461  ", imaging_volta
+00011e10: 6765 2c20 4265 616d 5479 7065 2e49 4f4e  ge, BeamType.ION
+00011e20: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+00011e30: 6f6e 6e65 6374 696f 6e2e 7061 7474 6572  onnection.patter
+00011e40: 6e69 6e67 2e6d 6f64 6520 3d20 2253 6572  ning.mode = "Ser
+00011e50: 6961 6c22 0a0a 2020 2020 2020 2020 6c6f  ial"..        lo
+00011e60: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00011e70: 6722 3a20 2266 696e 6973 685f 6d69 6c6c  g": "finish_mill
+00011e80: 696e 6722 2c20 2269 6d61 6769 6e67 5f63  ing", "imaging_c
+00011e90: 7572 7265 6e74 223a 2069 6d61 6769 6e67  urrent": imaging
+00011ea0: 5f63 7572 7265 6e74 2c20 2269 6d61 6769  _current, "imagi
+00011eb0: 6e67 5f76 6f6c 7461 6765 223a 2069 6d61  ng_voltage": ima
+00011ec0: 6769 6e67 5f76 6f6c 7461 6765 7d29 0a0a  ging_voltage})..
+00011ed0: 2020 2020 6465 6620 7374 6f70 5f6d 696c      def stop_mil
+00011ee0: 6c69 6e67 2873 656c 6629 202d 3e20 4e6f  ling(self) -> No
+00011ef0: 6e65 3a0a 2020 2020 2020 2020 2222 2253  ne:.        """S
+00011f00: 746f 7020 7468 6520 6d69 6c6c 696e 6720  top the milling 
+00011f10: 7072 6f63 6573 732e 2222 220a 2020 2020  process.""".    
+00011f20: 2020 2020 6966 2073 656c 662e 636f 6e6e      if self.conn
+00011f30: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+00011f40: 672e 7374 6174 6520 3d3d 2050 6174 7465  g.state == Patte
+00011f50: 726e 696e 6753 7461 7465 2e52 554e 4e49  rningState.RUNNI
+00011f60: 4e47 3a0a 2020 2020 2020 2020 2020 2020  NG:.            
+00011f70: 6c6f 6767 696e 672e 696e 666f 2866 2253  logging.info(f"S
+00011f80: 746f 7070 696e 6720 6d69 6c6c 696e 672e  topping milling.
+00011f90: 2e2e 2229 0a20 2020 2020 2020 2020 2020  ..").           
+00011fa0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00011fb0: 2e70 6174 7465 726e 696e 672e 7374 6f70  .patterning.stop
+00011fc0: 2829 0a20 2020 2020 2020 2020 2020 206c  ().            l
+00011fd0: 6f67 6769 6e67 2e69 6e66 6f28 6622 4d69  ogging.info(f"Mi
+00011fe0: 6c6c 696e 6720 7374 6f70 7065 642e 2229  lling stopped.")
+00011ff0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00012000: 2020 0a20 2020 2064 6566 2065 7374 696d    .    def estim
+00012010: 6174 655f 6d69 6c6c 696e 675f 7469 6d65  ate_milling_time
+00012020: 2873 656c 662c 2070 6174 7465 726e 733a  (self, patterns:
+00012030: 206c 6973 7420 2920 2d3e 2066 6c6f 6174   list ) -> float
+00012040: 3a0a 2020 2020 2020 2020 2222 2243 616c  :.        """Cal
+00012050: 6375 6c61 7465 7320 7468 6520 6573 7469  culates the esti
+00012060: 6d61 7465 6420 6d69 6c6c 696e 6720 7469  mated milling ti
+00012070: 6d65 2066 6f72 2061 206c 6973 7420 6f66  me for a list of
+00012080: 2070 6174 7465 726e 732e 2222 220a 0a20   patterns.""".. 
+00012090: 2020 2020 2020 2074 6f74 616c 5f74 696d         total_tim
+000120a0: 6520 3d20 300a 2020 2020 2020 2020 666f  e = 0.        fo
+000120b0: 7220 7061 7474 6572 6e20 696e 2070 6174  r pattern in pat
+000120c0: 7465 726e 733a 0a20 2020 2020 2020 2020  terns:.         
+000120d0: 2020 2074 6f74 616c 5f74 696d 6520 2b3d     total_time +=
+000120e0: 2070 6174 7465 726e 2e74 696d 650a 0a20   pattern.time.. 
+000120f0: 2020 2020 2020 2072 6574 7572 6e20 746f         return to
+00012100: 7461 6c5f 7469 6d65 0a0a 2020 2020 6465  tal_time..    de
+00012110: 6620 6472 6177 5f72 6563 7461 6e67 6c65  f draw_rectangle
+00012120: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00012130: 2020 2020 2020 2020 7061 7474 6572 6e5f          pattern_
+00012140: 7365 7474 696e 6773 3a20 4669 6273 656d  settings: Fibsem
+00012150: 5265 6374 616e 676c 6553 6574 7469 6e67  RectangleSetting
+00012160: 732c 0a20 2020 2029 3a0a 2020 2020 2020  s,.    ):.      
+00012170: 2020 2222 220a 2020 2020 2020 2020 4472    """.        Dr
+00012180: 6177 7320 6120 7265 6374 616e 676c 6520  aws a rectangle 
+00012190: 7061 7474 6572 6e20 7573 696e 6720 7468  pattern using th
+000121a0: 6520 6375 7272 656e 7420 696f 6e20 6265  e current ion be
+000121b0: 616d 2e0a 0a20 2020 2020 2020 2041 7267  am...        Arg
+000121c0: 733a 0a20 2020 2020 2020 2020 2020 2070  s:.            p
+000121d0: 6174 7465 726e 5f73 6574 7469 6e67 7320  attern_settings 
+000121e0: 2846 6962 7365 6d52 6563 7461 6e67 6c65  (FibsemRectangle
+000121f0: 5365 7474 696e 6773 293a 2074 6865 2073  Settings): the s
+00012200: 6574 7469 6e67 7320 666f 7220 7468 6520  ettings for the 
+00012210: 7061 7474 6572 6e20 746f 2064 7261 772e  pattern to draw.
+00012220: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00012230: 733a 0a20 2020 2020 2020 2020 2020 2050  s:.            P
+00012240: 6174 7465 726e 3a20 7468 6520 6372 6561  attern: the crea
+00012250: 7465 6420 7061 7474 6572 6e2e 0a0a 2020  ted pattern...  
+00012260: 2020 2020 2020 5261 6973 6573 3a0a 2020        Raises:.  
+00012270: 2020 2020 2020 2020 2020 4175 746f 7363            Autosc
+00012280: 7269 7074 4572 726f 723a 2069 6620 616e  riptError: if an
+00012290: 2065 7272 6f72 206f 6363 7572 7320 7768   error occurs wh
+000122a0: 696c 6520 6372 6561 7469 6e67 2074 6865  ile creating the
+000122b0: 2070 6174 7465 726e 2e0a 2020 2020 2020   pattern..      
+000122c0: 2020 2222 220a 2020 2020 2020 2020 0a20    """.        . 
+000122d0: 2020 2020 2020 2023 2067 6574 2070 6174         # get pat
+000122e0: 7465 726e 696e 6720 6170 690a 2020 2020  terning api.    
+000122f0: 2020 2020 7061 7474 6572 6e69 6e67 5f61      patterning_a
+00012300: 7069 203d 2073 656c 662e 636f 6e6e 6563  pi = self.connec
+00012310: 7469 6f6e 2e70 6174 7465 726e 696e 670a  tion.patterning.
+00012320: 2020 2020 2020 2020 6966 2070 6174 7465          if patte
+00012330: 726e 5f73 6574 7469 6e67 732e 6372 6f73  rn_settings.cros
+00012340: 735f 7365 6374 696f 6e20 6973 2043 726f  s_section is Cro
+00012350: 7373 5365 6374 696f 6e50 6174 7465 726e  ssSectionPattern
+00012360: 2e52 6567 756c 6172 4372 6f73 7353 6563  .RegularCrossSec
+00012370: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00012380: 2020 6372 6561 7465 5f70 6174 7465 726e    create_pattern
+00012390: 5f66 756e 6374 696f 6e20 3d20 7061 7474  _function = patt
+000123a0: 6572 6e69 6e67 5f61 7069 2e63 7265 6174  erning_api.creat
+000123b0: 655f 7265 6775 6c61 725f 6372 6f73 735f  e_regular_cross_
+000123c0: 7365 6374 696f 6e0a 2020 2020 2020 2020  section.        
+000123d0: 656c 6966 2070 6174 7465 726e 5f73 6574  elif pattern_set
+000123e0: 7469 6e67 732e 6372 6f73 735f 7365 6374  tings.cross_sect
+000123f0: 696f 6e20 6973 2043 726f 7373 5365 6374  ion is CrossSect
+00012400: 696f 6e50 6174 7465 726e 2e43 6c65 616e  ionPattern.Clean
+00012410: 696e 6743 726f 7373 5365 6374 696f 6e3a  ingCrossSection:
+00012420: 0a20 2020 2020 2020 2020 2020 2063 7265  .            cre
+00012430: 6174 655f 7061 7474 6572 6e5f 6675 6e63  ate_pattern_func
+00012440: 7469 6f6e 203d 2070 6174 7465 726e 696e  tion = patternin
+00012450: 675f 6170 692e 6372 6561 7465 5f63 6c65  g_api.create_cle
+00012460: 616e 696e 675f 6372 6f73 735f 7365 6374  aning_cross_sect
+00012470: 696f 6e0a 2020 2020 2020 2020 656c 7365  ion.        else
+00012480: 3a0a 2020 2020 2020 2020 2020 2020 6372  :.            cr
+00012490: 6561 7465 5f70 6174 7465 726e 5f66 756e  eate_pattern_fun
+000124a0: 6374 696f 6e20 3d20 7061 7474 6572 6e69  ction = patterni
+000124b0: 6e67 5f61 7069 2e63 7265 6174 655f 7265  ng_api.create_re
+000124c0: 6374 616e 676c 650a 2020 2020 2020 2020  ctangle.        
+000124d0: 0a20 2020 2020 2020 2023 2069 6620 7061  .        # if pa
+000124e0: 7474 6572 6e5f 7365 7474 696e 6773 2e63  ttern_settings.c
+000124f0: 6c65 616e 696e 675f 6372 6f73 735f 7365  leaning_cross_se
+00012500: 6374 696f 6e3a 0a20 2020 2020 2020 2023  ction:.        #
+00012510: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
+00012520: 6e69 6e67 2866 2244 6570 7265 6361 7465  ning(f"Deprecate
+00012530: 643a 2063 6c65 616e 696e 675f 6372 6f73  d: cleaning_cros
+00012540: 735f 7365 6374 696f 6e20 6973 2064 6570  s_section is dep
+00012550: 7265 6361 7465 642e 2055 7365 2063 726f  recated. Use cro
+00012560: 7373 5f73 6563 7469 6f6e 2069 6e73 7465  ss_section inste
+00012570: 6164 2e20 5468 6973 2077 696c 6c20 6265  ad. This will be
+00012580: 2072 656d 6f76 6564 2069 6e20 6120 6675   removed in a fu
+00012590: 7475 7265 2072 656c 6561 7365 2e22 2920  ture release.") 
+000125a0: 2020 200a 2020 2020 2020 2020 2320 2020     .        #   
+000125b0: 2020 6372 6561 7465 5f70 6174 7465 726e    create_pattern
+000125c0: 5f66 756e 6374 696f 6e20 3d20 7061 7474  _function = patt
+000125d0: 6572 6e69 6e67 5f61 7069 2e63 7265 6174  erning_api.creat
+000125e0: 655f 636c 6561 6e69 6e67 5f63 726f 7373  e_cleaning_cross
+000125f0: 5f73 6563 7469 6f6e 0a0a 2020 2020 2020  _section..      
+00012600: 2020 0a20 2020 2020 2020 2020 2020 200a    .            .
+00012610: 2020 2020 2020 2020 2320 6372 6561 7465          # create
+00012620: 2070 6174 7465 726e 0a20 2020 2020 2020   pattern.       
+00012630: 2070 6174 7465 726e 203d 2063 7265 6174   pattern = creat
+00012640: 655f 7061 7474 6572 6e5f 6675 6e63 7469  e_pattern_functi
+00012650: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00012660: 6365 6e74 6572 5f78 3d70 6174 7465 726e  center_x=pattern
+00012670: 5f73 6574 7469 6e67 732e 6365 6e74 7265  _settings.centre
+00012680: 5f78 2c0a 2020 2020 2020 2020 2020 2020  _x,.            
+00012690: 6365 6e74 6572 5f79 3d70 6174 7465 726e  center_y=pattern
+000126a0: 5f73 6574 7469 6e67 732e 6365 6e74 7265  _settings.centre
+000126b0: 5f79 2c0a 2020 2020 2020 2020 2020 2020  _y,.            
+000126c0: 7769 6474 683d 7061 7474 6572 6e5f 7365  width=pattern_se
+000126d0: 7474 696e 6773 2e77 6964 7468 2c0a 2020  ttings.width,.  
+000126e0: 2020 2020 2020 2020 2020 6865 6967 6874            height
+000126f0: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
+00012700: 732e 6865 6967 6874 2c0a 2020 2020 2020  s.height,.      
+00012710: 2020 2020 2020 6465 7074 683d 7061 7474        depth=patt
+00012720: 6572 6e5f 7365 7474 696e 6773 2e64 6570  ern_settings.dep
+00012730: 7468 2c0a 2020 2020 2020 2020 290a 0a20  th,.        ).. 
+00012740: 2020 2020 2020 2023 2073 6574 2070 6174         # set pat
+00012750: 7465 726e 2072 6f74 6174 696f 6e0a 2020  tern rotation.  
+00012760: 2020 2020 2020 7061 7474 6572 6e2e 726f        pattern.ro
+00012770: 7461 7469 6f6e 203d 2070 6174 7465 726e  tation = pattern
+00012780: 5f73 6574 7469 6e67 732e 726f 7461 7469  _settings.rotati
+00012790: 6f6e 0a0a 2020 2020 2020 2020 2320 7365  on..        # se
+000127a0: 7420 7363 616e 2064 6972 6563 7469 6f6e  t scan direction
+000127b0: 0a20 2020 2020 2020 2061 7661 696c 6162  .        availab
+000127c0: 6c65 5f73 6361 6e5f 6469 7265 6374 696f  le_scan_directio
+000127d0: 6e73 203d 2073 656c 662e 6765 745f 6176  ns = self.get_av
+000127e0: 6169 6c61 626c 655f 7661 6c75 6573 2822  ailable_values("
+000127f0: 7363 616e 5f64 6972 6563 7469 6f6e 2229  scan_direction")
+00012800: 2020 2020 2020 2020 0a20 2020 200a 2020          .    .  
+00012810: 2020 2020 2020 6966 2070 6174 7465 726e        if pattern
+00012820: 5f73 6574 7469 6e67 732e 7363 616e 5f64  _settings.scan_d
+00012830: 6972 6563 7469 6f6e 2069 6e20 6176 6169  irection in avai
+00012840: 6c61 626c 655f 7363 616e 5f64 6972 6563  lable_scan_direc
+00012850: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00012860: 2020 2070 6174 7465 726e 2e73 6361 6e5f     pattern.scan_
+00012870: 6469 7265 6374 696f 6e20 3d20 7061 7474  direction = patt
+00012880: 6572 6e5f 7365 7474 696e 6773 2e73 6361  ern_settings.sca
+00012890: 6e5f 6469 7265 6374 696f 6e0a 2020 2020  n_direction.    
+000128a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000128b0: 2020 2020 2020 7061 7474 6572 6e2e 7363        pattern.sc
+000128c0: 616e 5f64 6972 6563 7469 6f6e 203d 2022  an_direction = "
+000128d0: 546f 7054 6f42 6f74 746f 6d22 0a20 2020  TopToBottom".   
+000128e0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+000128f0: 2e77 6172 6e69 6e67 2866 2253 6361 6e20  .warning(f"Scan 
+00012900: 6469 7265 6374 696f 6e20 7b70 6174 7465  direction {patte
+00012910: 726e 5f73 6574 7469 6e67 732e 7363 616e  rn_settings.scan
+00012920: 5f64 6972 6563 7469 6f6e 7d20 6e6f 7420  _direction} not 
+00012930: 7375 7070 6f72 7465 642e 2055 7369 6e67  supported. Using
+00012940: 2054 6f70 546f 426f 7474 6f6d 2069 6e73   TopToBottom ins
+00012950: 7465 6164 2e22 290a 2020 2020 2020 2020  tead.").        
+00012960: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
+00012970: 696e 6728 6622 5375 7070 6f72 7465 6420  ing(f"Supported 
+00012980: 7363 616e 2064 6972 6563 7469 6f6e 7320  scan directions 
+00012990: 6172 653a 207b 6176 6169 6c61 626c 655f  are: {available_
+000129a0: 7363 616e 5f64 6972 6563 7469 6f6e 737d  scan_directions}
+000129b0: 2229 2020 2020 2020 2020 0a20 2020 2020  ")        .     
+000129c0: 2020 200a 2020 2020 2020 2020 2320 7365     .        # se
+000129d0: 7420 7061 7373 6573 2020 2020 2020 200a  t passes       .
+000129e0: 2020 2020 2020 2020 6966 2070 6174 7465          if patte
+000129f0: 726e 5f73 6574 7469 6e67 732e 7061 7373  rn_settings.pass
+00012a00: 6573 3a20 2320 6e6f 7420 7a65 726f 0a20  es: # not zero. 
+00012a10: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00012a20: 696e 7374 616e 6365 2870 6174 7465 726e  instance(pattern
+00012a30: 2c20 5265 6775 6c61 7243 726f 7373 5365  , RegularCrossSe
+00012a40: 6374 696f 6e50 6174 7465 726e 293a 0a20  ctionPattern):. 
+00012a50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00012a60: 6174 7465 726e 2e6d 756c 7469 5f73 6361  attern.multi_sca
+00012a70: 6e5f 7061 7373 5f63 6f75 6e74 203d 2070  n_pass_count = p
+00012a80: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+00012a90: 7061 7373 6573 0a20 2020 2020 2020 2020  passes.         
+00012aa0: 2020 2020 2020 2070 6174 7465 726e 2e73         pattern.s
+00012ab0: 6361 6e5f 6d65 7468 6f64 203d 2031 2023  can_method = 1 #
+00012ac0: 206d 756c 7469 2073 6361 6e0a 2020 2020   multi scan.    
+00012ad0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00012ae0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00012af0: 7474 6572 6e2e 6477 656c 6c5f 7469 6d65  ttern.dwell_time
+00012b00: 203d 2070 6174 7465 726e 2e64 7765 6c6c   = pattern.dwell
+00012b10: 5f74 696d 6520 2a20 2870 6174 7465 726e  _time * (pattern
+00012b20: 2e70 6173 735f 636f 756e 7420 2f20 7061  .pass_count / pa
+00012b30: 7474 6572 6e5f 7365 7474 696e 6773 2e70  ttern_settings.p
+00012b40: 6173 7365 7329 0a20 2020 2020 2020 2020  asses).         
+00012b50: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00012b60: 2020 2020 2020 2020 2320 4e42 3a20 7061          # NB: pa
+00012b70: 7373 6573 2c20 7469 6d65 2c20 6477 656c  sses, time, dwel
+00012b80: 6c20 7469 6d65 2061 7265 2061 6c6c 2069  l time are all i
+00012b90: 6e74 6572 6c69 6e6b 6564 2c20 7468 6572  nterlinked, ther
+00012ba0: 6566 6f72 6520 6361 6e20 6f6e 6c79 2061  efore can only a
+00012bb0: 646a 7573 7420 7061 7373 6573 2069 6e64  djust passes ind
+00012bc0: 6972 6563 746c 790a 2020 2020 2020 2020  irectly.        
+00012bd0: 2020 2020 2020 2020 2320 6966 2077 6520          # if we 
+00012be0: 6164 6a75 7374 2070 6173 7365 7320 6469  adjust passes di
+00012bf0: 7265 6374 6c79 2c20 6974 206a 7573 7420  rectly, it just 
+00012c00: 7265 6475 6365 7320 7468 6520 746f 7461  reduces the tota
+00012c10: 6c20 7469 6d65 2074 6f20 636f 6d70 656e  l time to compen
+00012c20: 7361 7465 2c20 7261 7468 6572 2074 6861  sate, rather tha
+00012c30: 6e20 696e 6372 6561 7369 6e67 2074 6865  n increasing the
+00012c40: 2064 7765 6c6c 5f74 696d 650a 2020 2020   dwell_time.    
+00012c50: 2020 2020 2020 2020 2020 2020 2320 4e42              # NB
+00012c60: 3a20 7468 6520 6375 7272 656e 7420 6d75  : the current mu
+00012c70: 7374 2062 6520 7365 7420 6265 666f 7265  st be set before
+00012c80: 2064 6f69 6e67 2074 6869 732c 206f 7468   doing this, oth
+00012c90: 6572 7769 7365 2069 7420 7769 6c6c 2062  erwise it will b
+00012ca0: 6520 6f75 7420 6f66 2072 616e 6765 0a0a  e out of range..
+00012cb0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00012cc0: 6465 6275 6728 7b22 6d73 6722 3a20 2264  debug({"msg": "d
+00012cd0: 7261 775f 7265 6374 616e 676c 6522 2c20  raw_rectangle", 
+00012ce0: 2270 6174 7465 726e 5f73 6574 7469 6e67  "pattern_setting
+00012cf0: 7322 3a20 7061 7474 6572 6e5f 7365 7474  s": pattern_sett
+00012d00: 696e 6773 2e74 6f5f 6469 6374 2829 7d29  ings.to_dict()})
+00012d10: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00012d20: 2070 6174 7465 726e 0a0a 2020 2020 6465   pattern..    de
+00012d30: 6620 6472 6177 5f6c 696e 6528 7365 6c66  f draw_line(self
+00012d40: 2c20 7061 7474 6572 6e5f 7365 7474 696e  , pattern_settin
+00012d50: 6773 3a20 4669 6273 656d 4c69 6e65 5365  gs: FibsemLineSe
+00012d60: 7474 696e 6773 293a 0a20 2020 2020 2020  ttings):.       
+00012d70: 2022 2222 0a20 2020 2020 2020 2044 7261   """.        Dra
+00012d80: 7773 2061 206c 696e 6520 7061 7474 6572  ws a line patter
+00012d90: 6e20 6f6e 2074 6865 2063 7572 7265 6e74  n on the current
+00012da0: 2069 6d61 6769 6e67 2076 6965 7720 6f66   imaging view of
+00012db0: 2074 6865 206d 6963 726f 7363 6f70 652e   the microscope.
+00012dc0: 0a0a 2020 2020 2020 2020 4172 6773 3a0a  ..        Args:.
+00012dd0: 2020 2020 2020 2020 2020 2020 7061 7474              patt
+00012de0: 6572 6e5f 7365 7474 696e 6773 2028 4669  ern_settings (Fi
+00012df0: 6273 656d 4c69 6e65 5365 7474 696e 6773  bsemLineSettings
+00012e00: 293a 2041 2064 6174 6120 636c 6173 7320  ): A data class 
+00012e10: 6f62 6a65 6374 2073 7065 6369 6679 696e  object specifyin
+00012e20: 6720 7468 6520 7061 7474 6572 6e20 7061  g the pattern pa
+00012e30: 7261 6d65 7465 7273 2c0a 2020 2020 2020  rameters,.      
+00012e40: 2020 2020 2020 2020 2020 696e 636c 7564            includ
+00012e50: 696e 6720 7468 6520 7374 6172 7420 616e  ing the start an
+00012e60: 6420 656e 6420 706f 696e 7473 2c20 616e  d end points, an
+00012e70: 6420 7468 6520 6465 7074 6820 6f66 2074  d the depth of t
+00012e80: 6865 2070 6174 7465 726e 2e0a 0a20 2020  he pattern...   
+00012e90: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+00012ea0: 2020 2020 2020 2020 2020 4c69 6e65 5061            LinePa
+00012eb0: 7474 6572 6e3a 2041 206c 696e 6520 7061  ttern: A line pa
+00012ec0: 7474 6572 6e20 6f62 6a65 6374 2c20 7768  ttern object, wh
+00012ed0: 6963 6820 6361 6e20 6265 2075 7365 6420  ich can be used 
+00012ee0: 746f 2063 6f6e 6669 6775 7265 2066 7572  to configure fur
+00012ef0: 7468 6572 2070 726f 7065 7274 6965 7320  ther properties 
+00012f00: 6f72 2074 6f20 6164 6420 7468 650a 2020  or to add the.  
+00012f10: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00012f20: 7474 6572 6e20 746f 2074 6865 206d 696c  ttern to the mil
+00012f30: 6c69 6e67 206c 6973 742e 0a0a 2020 2020  ling list...    
+00012f40: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00012f50: 2020 2020 2020 2020 6175 746f 7363 7269          autoscri
+00012f60: 7074 2e65 7863 6570 7469 6f6e 732e 496e  pt.exceptions.In
+00012f70: 7661 6c69 6441 7267 756d 656e 7445 7863  validArgumentExc
+00012f80: 6570 7469 6f6e 3a20 6966 2061 6e79 206f  eption: if any o
+00012f90: 6620 7468 6520 7061 7474 6572 6e20 7061  f the pattern pa
+00012fa0: 7261 6d65 7465 7273 2061 7265 2069 6e76  rameters are inv
+00012fb0: 616c 6964 2e0a 2020 2020 2020 2020 2222  alid..        ""
+00012fc0: 220a 2020 2020 2020 2020 7061 7474 6572  ".        patter
+00012fd0: 6e20 3d20 7365 6c66 2e63 6f6e 6e65 6374  n = self.connect
+00012fe0: 696f 6e2e 7061 7474 6572 6e69 6e67 2e63  ion.patterning.c
+00012ff0: 7265 6174 655f 6c69 6e65 280a 2020 2020  reate_line(.    
+00013000: 2020 2020 2020 2020 7374 6172 745f 783d          start_x=
+00013010: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+00013020: 2e73 7461 7274 5f78 2c0a 2020 2020 2020  .start_x,.      
+00013030: 2020 2020 2020 7374 6172 745f 793d 7061        start_y=pa
+00013040: 7474 6572 6e5f 7365 7474 696e 6773 2e73  ttern_settings.s
+00013050: 7461 7274 5f79 2c0a 2020 2020 2020 2020  tart_y,.        
+00013060: 2020 2020 656e 645f 783d 7061 7474 6572      end_x=patter
+00013070: 6e5f 7365 7474 696e 6773 2e65 6e64 5f78  n_settings.end_x
+00013080: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+00013090: 645f 793d 7061 7474 6572 6e5f 7365 7474  d_y=pattern_sett
+000130a0: 696e 6773 2e65 6e64 5f79 2c0a 2020 2020  ings.end_y,.    
+000130b0: 2020 2020 2020 2020 6465 7074 683d 7061          depth=pa
+000130c0: 7474 6572 6e5f 7365 7474 696e 6773 2e64  ttern_settings.d
+000130d0: 6570 7468 2c0a 2020 2020 2020 2020 290a  epth,.        ).
+000130e0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000130f0: 6465 6275 6728 7b22 6d73 6722 3a20 2264  debug({"msg": "d
+00013100: 7261 775f 6c69 6e65 222c 2022 7061 7474  raw_line", "patt
+00013110: 6572 6e5f 7365 7474 696e 6773 223a 2070  ern_settings": p
+00013120: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+00013130: 746f 5f64 6963 7428 297d 290a 2020 2020  to_dict()}).    
+00013140: 2020 2020 7265 7475 726e 2070 6174 7465      return patte
+00013150: 726e 0a20 2020 200a 2020 2020 6465 6620  rn.    .    def 
+00013160: 6472 6177 5f63 6972 636c 6528 7365 6c66  draw_circle(self
+00013170: 2c20 7061 7474 6572 6e5f 7365 7474 696e  , pattern_settin
+00013180: 6773 3a20 4669 6273 656d 4369 7263 6c65  gs: FibsemCircle
+00013190: 5365 7474 696e 6773 293a 0a20 2020 2020  Settings):.     
+000131a0: 2020 2022 2222 0a20 2020 2020 2020 2044     """.        D
+000131b0: 7261 7773 2061 2063 6972 636c 6520 7061  raws a circle pa
+000131c0: 7474 6572 6e20 6f6e 2074 6865 2063 7572  ttern on the cur
+000131d0: 7265 6e74 2069 6d61 6769 6e67 2076 6965  rent imaging vie
+000131e0: 7720 6f66 2074 6865 206d 6963 726f 7363  w of the microsc
+000131f0: 6f70 652e 0a0a 2020 2020 2020 2020 4172  ope...        Ar
+00013200: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+00013210: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+00013220: 2028 4669 6273 656d 4369 7263 6c65 5365   (FibsemCircleSe
+00013230: 7474 696e 6773 293a 2041 2064 6174 6120  ttings): A data 
+00013240: 636c 6173 7320 6f62 6a65 6374 2073 7065  class object spe
+00013250: 6369 6679 696e 6720 7468 6520 7061 7474  cifying the patt
+00013260: 6572 6e20 7061 7261 6d65 7465 7273 2c0a  ern parameters,.
+00013270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013280: 696e 636c 7564 696e 6720 7468 6520 6365  including the ce
+00013290: 6e74 7265 2070 6f69 6e74 2c20 7261 6469  ntre point, radi
+000132a0: 7573 2061 6e64 2064 6570 7468 206f 6620  us and depth of 
+000132b0: 7468 6520 7061 7474 6572 6e2e 0a0a 2020  the pattern...  
+000132c0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+000132d0: 2020 2020 2020 2020 2020 2043 6972 636c             Circl
+000132e0: 6550 6174 7465 726e 3a20 4120 6369 7263  ePattern: A circ
+000132f0: 6c65 2070 6174 7465 726e 206f 626a 6563  le pattern objec
+00013300: 742c 2077 6869 6368 2063 616e 2062 6520  t, which can be 
+00013310: 7573 6564 2074 6f20 636f 6e66 6967 7572  used to configur
+00013320: 6520 6675 7274 6865 7220 7072 6f70 6572  e further proper
+00013330: 7469 6573 206f 7220 746f 2061 6464 2074  ties or to add t
+00013340: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
+00013350: 2020 2070 6174 7465 726e 2074 6f20 7468     pattern to th
+00013360: 6520 6d69 6c6c 696e 6720 6c69 7374 2e0a  e milling list..
+00013370: 0a20 2020 2020 2020 2052 6169 7365 733a  .        Raises:
+00013380: 0a20 2020 2020 2020 2020 2020 2061 7574  .            aut
+00013390: 6f73 6372 6970 742e 6578 6365 7074 696f  oscript.exceptio
+000133a0: 6e73 2e49 6e76 616c 6964 4172 6775 6d65  ns.InvalidArgume
+000133b0: 6e74 4578 6365 7074 696f 6e3a 2069 6620  ntException: if 
+000133c0: 616e 7920 6f66 2074 6865 2070 6174 7465  any of the patte
+000133d0: 726e 2070 6172 616d 6574 6572 7320 6172  rn parameters ar
+000133e0: 6520 696e 7661 6c69 642e 0a20 2020 2020  e invalid..     
+000133f0: 2020 2022 2222 0a20 2020 2020 2020 2070     """.        p
+00013400: 6174 7465 726e 203d 2073 656c 662e 636f  attern = self.co
+00013410: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
+00013420: 696e 672e 6372 6561 7465 5f63 6972 636c  ing.create_circl
+00013430: 6528 0a20 2020 2020 2020 2020 2020 2063  e(.            c
+00013440: 656e 7465 725f 783d 7061 7474 6572 6e5f  enter_x=pattern_
+00013450: 7365 7474 696e 6773 2e63 656e 7472 655f  settings.centre_
+00013460: 782c 0a20 2020 2020 2020 2020 2020 2063  x,.            c
+00013470: 656e 7465 725f 793d 7061 7474 6572 6e5f  enter_y=pattern_
+00013480: 7365 7474 696e 6773 2e63 656e 7472 655f  settings.centre_
+00013490: 792c 0a20 2020 2020 2020 2020 2020 206f  y,.            o
+000134a0: 7574 6572 5f64 6961 6d65 7465 723d 322a  uter_diameter=2*
+000134b0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+000134c0: 2e72 6164 6975 732c 0a20 2020 2020 2020  .radius,.       
+000134d0: 2020 2020 2069 6e6e 6572 5f64 6961 6d65       inner_diame
+000134e0: 7465 7220 3d20 302c 0a20 2020 2020 2020  ter = 0,.       
+000134f0: 2020 2020 2064 6570 7468 3d70 6174 7465       depth=patte
+00013500: 726e 5f73 6574 7469 6e67 732e 6465 7074  rn_settings.dept
+00013510: 682c 0a20 2020 2020 2020 2029 0a0a 2020  h,.        )..  
+00013520: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00013530: 6275 6728 7b22 6d73 6722 3a20 2264 7261  bug({"msg": "dra
+00013540: 775f 6369 7263 6c65 222c 2022 7061 7474  w_circle", "patt
+00013550: 6572 6e5f 7365 7474 696e 6773 223a 2070  ern_settings": p
+00013560: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+00013570: 746f 5f64 6963 7428 297d 290a 0a20 2020  to_dict()})..   
+00013580: 2020 2020 2072 6574 7572 6e20 7061 7474       return patt
+00013590: 6572 6e0a 0a20 2020 2064 6566 2064 7261  ern..    def dra
+000135a0: 775f 616e 6e75 6c75 7328 7365 6c66 2c20  w_annulus(self, 
+000135b0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+000135c0: 3a20 4669 6273 656d 4369 7263 6c65 5365  : FibsemCircleSe
+000135d0: 7474 696e 6773 293a 0a0a 2020 2020 2020  ttings):..      
+000135e0: 2020 6f75 7465 725f 6469 616d 6574 6572    outer_diameter
+000135f0: 203d 2032 2a70 6174 7465 726e 5f73 6574   = 2*pattern_set
+00013600: 7469 6e67 732e 7261 6469 7573 0a20 2020  tings.radius.   
+00013610: 2020 2020 2069 6e6e 6572 5f64 6961 6d65       inner_diame
+00013620: 7465 7220 3d20 6f75 7465 725f 6469 616d  ter = outer_diam
+00013630: 6574 6572 202d 2032 2a70 6174 7465 726e  eter - 2*pattern
+00013640: 5f73 6574 7469 6e67 732e 7468 6963 6b6e  _settings.thickn
+00013650: 6573 730a 0a20 2020 2020 2020 2070 6174  ess..        pat
+00013660: 7465 726e 203d 2073 656c 662e 636f 6e6e  tern = self.conn
+00013670: 6563 7469 6f6e 2e70 6174 7465 726e 696e  ection.patternin
+00013680: 672e 6372 6561 7465 5f63 6972 636c 6528  g.create_circle(
+00013690: 0a20 2020 2020 2020 2020 2020 2063 656e  .            cen
+000136a0: 7465 725f 783d 7061 7474 6572 6e5f 7365  ter_x=pattern_se
+000136b0: 7474 696e 6773 2e63 656e 7472 655f 782c  ttings.centre_x,
+000136c0: 0a20 2020 2020 2020 2020 2020 2063 656e  .            cen
+000136d0: 7465 725f 793d 7061 7474 6572 6e5f 7365  ter_y=pattern_se
+000136e0: 7474 696e 6773 2e63 656e 7472 655f 792c  ttings.centre_y,
+000136f0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00013700: 6572 5f64 6961 6d65 7465 723d 6f75 7465  er_diameter=oute
+00013710: 725f 6469 616d 6574 6572 2c0a 2020 2020  r_diameter,.    
+00013720: 2020 2020 2020 2020 696e 6e65 725f 6469          inner_di
+00013730: 616d 6574 6572 203d 2069 6e6e 6572 5f64  ameter = inner_d
+00013740: 6961 6d65 7465 722c 0a20 2020 2020 2020  iameter,.       
+00013750: 2020 2020 2064 6570 7468 3d70 6174 7465       depth=patte
+00013760: 726e 5f73 6574 7469 6e67 732e 6465 7074  rn_settings.dept
+00013770: 682c 0a20 2020 2020 2020 2029 0a0a 2020  h,.        )..  
+00013780: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+00013790: 6275 6728 7b22 6d73 6722 3a20 2264 7261  bug({"msg": "dra
+000137a0: 775f 616e 6e75 6c75 7322 2c20 2270 6174  w_annulus", "pat
+000137b0: 7465 726e 5f73 6574 7469 6e67 7322 3a20  tern_settings": 
+000137c0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+000137d0: 2e74 6f5f 6469 6374 2829 7d29 0a0a 2020  .to_dict()})..  
+000137e0: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
+000137f0: 7465 726e 0a20 2020 200a 2020 2020 0a20  tern.    .    . 
+00013800: 2020 2064 6566 2064 7261 775f 6269 746d     def draw_bitm
+00013810: 6170 5f70 6174 7465 726e 280a 2020 2020  ap_pattern(.    
+00013820: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00013830: 2020 7061 7474 6572 6e5f 7365 7474 696e    pattern_settin
+00013840: 6773 3a20 4669 6273 656d 4269 746d 6170  gs: FibsemBitmap
+00013850: 5365 7474 696e 6773 2c0a 2020 2020 2020  Settings,.      
+00013860: 2020 7061 7468 3a20 7374 722c 0a20 2020    path: str,.   
+00013870: 2029 3a0a 0a20 2020 2020 2020 2062 6974   ):..        bit
+00013880: 6d61 705f 7061 7474 6572 6e20 3d20 4269  map_pattern = Bi
+00013890: 746d 6170 5061 7474 6572 6e44 6566 696e  tmapPatternDefin
+000138a0: 6974 696f 6e2e 6c6f 6164 2870 6174 6829  ition.load(path)
+000138b0: 0a0a 2020 2020 2020 2020 7061 7474 6572  ..        patter
+000138c0: 6e20 3d20 7365 6c66 2e63 6f6e 6e65 6374  n = self.connect
+000138d0: 696f 6e2e 7061 7474 6572 6e69 6e67 2e63  ion.patterning.c
+000138e0: 7265 6174 655f 6269 746d 6170 280a 2020  reate_bitmap(.  
+000138f0: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+00013900: 5f78 3d70 6174 7465 726e 5f73 6574 7469  _x=pattern_setti
+00013910: 6e67 732e 6365 6e74 7265 5f78 2c0a 2020  ngs.centre_x,.  
+00013920: 2020 2020 2020 2020 2020 6365 6e74 6572            center
+00013930: 5f79 3d70 6174 7465 726e 5f73 6574 7469  _y=pattern_setti
+00013940: 6e67 732e 6365 6e74 7265 5f79 2c0a 2020  ngs.centre_y,.  
+00013950: 2020 2020 2020 2020 2020 7769 6474 683d            width=
+00013960: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+00013970: 2e77 6964 7468 2c0a 2020 2020 2020 2020  .width,.        
+00013980: 2020 2020 6865 6967 6874 3d70 6174 7465      height=patte
+00013990: 726e 5f73 6574 7469 6e67 732e 6865 6967  rn_settings.heig
+000139a0: 6874 2c0a 2020 2020 2020 2020 2020 2020  ht,.            
+000139b0: 6465 7074 683d 7061 7474 6572 6e5f 7365  depth=pattern_se
+000139c0: 7474 696e 6773 2e64 6570 7468 2c0a 2020  ttings.depth,.  
+000139d0: 2020 2020 2020 2020 2020 6269 746d 6170            bitmap
+000139e0: 5f70 6174 7465 726e 5f64 6566 696e 6974  _pattern_definit
+000139f0: 696f 6e3d 6269 746d 6170 5f70 6174 7465  ion=bitmap_patte
+00013a00: 726e 2c0a 2020 2020 2020 2020 290a 0a20  rn,.        ).. 
+00013a10: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00013a20: 6562 7567 287b 226d 7367 223a 2022 6472  ebug({"msg": "dr
+00013a30: 6177 5f62 6974 6d61 705f 7061 7474 6572  aw_bitmap_patter
+00013a40: 6e22 2c20 2270 6174 7465 726e 5f73 6574  n", "pattern_set
+00013a50: 7469 6e67 7322 3a20 7061 7474 6572 6e5f  tings": pattern_
+00013a60: 7365 7474 696e 6773 2e74 6f5f 6469 6374  settings.to_dict
+00013a70: 2829 2c20 2270 6174 6822 3a20 7061 7468  (), "path": path
+00013a80: 7d29 0a0a 2020 2020 2020 2020 7265 7475  })..        retu
+00013a90: 726e 2070 6174 7465 726e 0a0a 2020 2020  rn pattern..    
+00013aa0: 6465 6620 6765 745f 7363 616e 5f64 6972  def get_scan_dir
+00013ab0: 6563 7469 6f6e 7328 7365 6c66 2920 2d3e  ections(self) ->
+00013ac0: 206c 6973 743a 0a20 2020 2020 2020 2022   list:.        "
+00013ad0: 2222 0a20 2020 2020 2020 2052 6574 7572  "".        Retur
+00013ae0: 6e73 2074 6865 2061 7661 696c 6162 6c65  ns the available
+00013af0: 2073 6361 6e20 6469 7265 6374 696f 6e73   scan directions
+00013b00: 206f 6620 7468 6520 6d69 6372 6f73 636f   of the microsco
+00013b10: 7065 2e0a 0a20 2020 2020 2020 2052 6574  pe...        Ret
+00013b20: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00013b30: 2020 6c69 7374 3a20 5468 6520 7363 616e    list: The scan
+00013b40: 2064 6972 6563 7469 6f6e 206f 6620 7468   direction of th
+00013b50: 6520 6d69 6372 6f73 636f 7065 2e0a 0a20  e microscope... 
+00013b60: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
+00013b70: 2020 2020 2020 2020 2020 204e 6f6e 650a             None.
+00013b80: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00013b90: 2020 2020 6c69 7374 203d 205b 2242 6f74      list = ["Bot
+00013ba0: 746f 6d54 6f54 6f70 222c 200a 2020 2020  tomToTop", .    
+00013bb0: 2020 2020 2020 2020 2020 2020 2244 796e              "Dyn
+00013bc0: 616d 6963 416c 6c44 6972 6563 7469 6f6e  amicAllDirection
+00013bd0: 7322 2c20 0a20 2020 2020 2020 2020 2020  s", .           
+00013be0: 2020 2020 2022 4479 6e61 6d69 6349 6e6e       "DynamicInn
+00013bf0: 6572 546f 4f75 7465 7222 2c20 0a20 2020  erToOuter", .   
+00013c00: 2020 2020 2020 2020 2020 2020 2022 4479               "Dy
+00013c10: 6e61 6d69 634c 6566 7454 6f52 6967 6874  namicLeftToRight
+00013c20: 222c 200a 2020 2020 2020 2020 2020 2020  ", .            
+00013c30: 2020 2020 2244 796e 616d 6963 546f 7054      "DynamicTopT
+00013c40: 6f42 6f74 746f 6d22 2c20 0a20 2020 2020  oBottom", .     
+00013c50: 2020 2020 2020 2020 2020 2022 496e 6e65             "Inne
+00013c60: 7254 6f4f 7574 6572 222c 2009 0a20 2020  rToOuter", ..   
+00013c70: 2020 2020 2020 2020 2020 2020 2022 4c65               "Le
+00013c80: 6674 546f 5269 6768 7422 2c20 090a 2020  ftToRight", ..  
+00013c90: 2020 2020 2020 2020 2020 2020 2020 224f                "O
+00013ca0: 7574 6572 546f 496e 6e65 7222 2c20 0a20  uterToInner", . 
+00013cb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00013cc0: 5269 6768 7454 6f4c 6566 7422 2c20 090a  RightToLeft", ..
+00013cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ce0: 2254 6f70 546f 426f 7474 6f6d 225d 0a20  "TopToBottom"]. 
+00013cf0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00013d00: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
+00013d10: 6d73 6722 3a20 2267 6574 5f73 6361 6e5f  msg": "get_scan_
+00013d20: 6469 7265 6374 696f 6e73 222c 2022 7363  directions", "sc
+00013d30: 616e 5f64 6972 6563 7469 6f6e 7322 3a20  an_directions": 
+00013d40: 6c69 7374 7d29 0a0a 2020 2020 2020 2020  list})..        
+00013d50: 7265 7475 726e 206c 6973 7420 0a0a 2020  return list ..  
+00013d60: 2020 6465 6620 6765 745f 6769 7328 7365    def get_gis(se
+00013d70: 6c66 2c20 706f 7274 3a20 7374 7220 3d20  lf, port: str = 
+00013d80: 4e6f 6e65 293a 0a20 2020 2020 2020 2075  None):.        u
+00013d90: 7365 5f6d 756c 7469 6368 656d 203d 2073  se_multichem = s
+00013da0: 656c 662e 6973 5f61 7661 696c 6162 6c65  elf.is_available
+00013db0: 2822 6769 735f 6d75 6c74 6963 6865 6d22  ("gis_multichem"
+00013dc0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+00013dd0: 2020 2069 6620 7573 655f 6d75 6c74 6963     if use_multic
+00013de0: 6865 6d3a 0a20 2020 2020 2020 2020 2020  hem:.           
+00013df0: 2067 6973 203d 2073 656c 662e 636f 6e6e   gis = self.conn
+00013e00: 6563 7469 6f6e 2e67 6173 2e67 6574 5f6d  ection.gas.get_m
+00013e10: 756c 7469 6368 656d 2829 0a20 2020 2020  ultichem().     
+00013e20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00013e30: 2020 2020 2067 6973 203d 2073 656c 662e       gis = self.
+00013e40: 636f 6e6e 6563 7469 6f6e 2e67 6173 2e67  connection.gas.g
+00013e50: 6574 5f67 6973 5f70 6f72 7428 706f 7274  et_gis_port(port
+00013e60: 290a 2020 2020 2020 2020 6c6f 6767 696e  ).        loggin
+00013e70: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
+00013e80: 2267 6574 5f67 6973 222c 2022 7573 655f  "get_gis", "use_
+00013e90: 6d75 6c74 6963 6865 6d22 3a20 7573 655f  multichem": use_
+00013ea0: 6d75 6c74 6963 6865 6d2c 2022 706f 7274  multichem, "port
+00013eb0: 223a 2070 6f72 747d 290a 2020 2020 2020  ": port}).      
+00013ec0: 2020 7365 6c66 2e67 6973 203d 2067 6973    self.gis = gis
+00013ed0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00013ee0: 7365 6c66 2e67 6973 0a0a 2020 2020 6465  self.gis..    de
+00013ef0: 6620 696e 7365 7274 5f67 6973 2873 656c  f insert_gis(sel
+00013f00: 662c 2069 6e73 6572 745f 706f 7369 7469  f, insert_positi
+00013f10: 6f6e 3a20 7374 7220 3d20 4e6f 6e65 2920  on: str = None) 
+00013f20: 2d3e 204e 6f6e 653a 0a0a 2020 2020 2020  -> None:..      
+00013f30: 2020 6966 2069 6e73 6572 745f 706f 7369    if insert_posi
+00013f40: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00013f50: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00013f60: 2249 6e73 6572 7469 6e67 204d 756c 7469  "Inserting Multi
+00013f70: 6368 656d 2047 4953 2074 6f20 7b69 6e73  chem GIS to {ins
+00013f80: 6572 745f 706f 7369 7469 6f6e 7d22 290a  ert_position}").
+00013f90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00013fa0: 2e67 6973 2e69 6e73 6572 7428 696e 7365  .gis.insert(inse
+00013fb0: 7274 5f70 6f73 6974 696f 6e29 0a20 2020  rt_position).   
+00013fc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00013fd0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00013fe0: 6e66 6f28 6622 496e 7365 7274 696e 6720  nfo(f"Inserting 
+00013ff0: 4761 7320 496e 6a65 6374 696f 6e20 5379  Gas Injection Sy
+00014000: 7374 656d 2229 0a20 2020 2020 2020 2020  stem").         
+00014010: 2020 2073 656c 662e 6769 732e 696e 7365     self.gis.inse
+00014020: 7274 2829 0a0a 2020 2020 2020 2020 6c6f  rt()..        lo
+00014030: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00014040: 6722 3a20 2269 6e73 6572 745f 6769 7322  g": "insert_gis"
+00014050: 2c20 2269 6e73 6572 745f 706f 7369 7469  , "insert_positi
+00014060: 6f6e 223a 2069 6e73 6572 745f 706f 7369  on": insert_posi
+00014070: 7469 6f6e 7d29 0a0a 0a20 2020 2064 6566  tion})...    def
+00014080: 2072 6574 7261 6374 5f67 6973 2873 656c   retract_gis(sel
+00014090: 6629 3a0a 2020 2020 2020 2020 2222 2252  f):.        """R
+000140a0: 6574 7261 6374 2074 6865 2067 6973 2222  etract the gis""
+000140b0: 220a 2020 2020 2020 2020 7365 6c66 2e67  ".        self.g
+000140c0: 6973 2e72 6574 7261 6374 2829 0a20 2020  is.retract().   
+000140d0: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
+000140e0: 7567 287b 226d 7367 223a 2022 7265 7472  ug({"msg": "retr
+000140f0: 6163 745f 6769 7322 2c20 2275 7365 5f6d  act_gis", "use_m
+00014100: 756c 7469 6368 656d 223a 2073 656c 662e  ultichem": self.
+00014110: 6973 5f61 7661 696c 6162 6c65 2822 6769  is_available("gi
+00014120: 735f 6d75 6c74 6963 6865 6d22 297d 290a  s_multichem")}).
+00014130: 0a20 2020 2064 6566 2067 6973 5f74 7572  .    def gis_tur
+00014140: 6e5f 6865 6174 6572 5f6f 6e28 7365 6c66  n_heater_on(self
+00014150: 2c20 6761 733a 2073 7472 203d 204e 6f6e  , gas: str = Non
+00014160: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+00014170: 2020 2020 2222 2254 7572 6e20 7468 6520      """Turn the 
+00014180: 6865 6174 6572 206f 6e20 616e 6420 7761  heater on and wa
+00014190: 6974 2066 6f72 2069 7420 746f 2067 6574  it for it to get
+000141a0: 2074 6f20 7465 6d70 6572 6174 7572 6522   to temperature"
+000141b0: 2222 0a20 2020 2020 2020 206c 6f67 6769  "".        loggi
+000141c0: 6e67 2e69 6e66 6f28 6622 5475 726e 696e  ng.info(f"Turnin
+000141d0: 6720 6f6e 2068 6561 7465 7220 666f 7220  g on heater for 
+000141e0: 7b67 6173 7d22 290a 2020 2020 2020 2020  {gas}").        
+000141f0: 6966 2067 6173 2069 7320 6e6f 7420 4e6f  if gas is not No
+00014200: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00014210: 7365 6c66 2e67 6973 2e74 7572 6e5f 6865  self.gis.turn_he
+00014220: 6174 6572 5f6f 6e28 6761 7329 0a20 2020  ater_on(gas).   
+00014230: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00014240: 2020 2020 2020 2073 656c 662e 6769 732e         self.gis.
+00014250: 7475 726e 5f68 6561 7465 725f 6f6e 2829  turn_heater_on()
+00014260: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00014270: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00014280: 2257 6169 7469 6e67 2066 6f72 2068 6561  "Waiting for hea
+00014290: 7465 7220 746f 2067 6574 2074 6f20 7465  ter to get to te
+000142a0: 6d70 6572 6174 7572 652e 2e2e 2229 0a20  mperature..."). 
+000142b0: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+000142c0: 7028 3329 2023 2077 6520 6e65 6564 2074  p(3) # we need t
+000142d0: 6f20 7761 6974 2061 2062 6974 0a0a 2020  o wait a bit..  
+000142e0: 2020 2020 2020 7761 6974 5f74 696d 6520        wait_time 
+000142f0: 3d20 300a 2020 2020 2020 2020 6d61 785f  = 0.        max_
+00014300: 7761 6974 5f74 696d 6520 3d20 3135 0a20  wait_time = 15. 
+00014310: 2020 2020 2020 2074 6172 6765 745f 7465         target_te
+00014320: 6d70 203d 2033 3030 2023 2076 616c 6964  mp = 300 # valid
+00014330: 6174 6520 7468 6973 2073 6f6d 6568 6f77  ate this somehow
+00014340: 3f0a 2020 2020 2020 2020 7768 696c 6520  ?.        while 
+00014350: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
+00014360: 2020 6966 2067 6173 2069 7320 6e6f 7420    if gas is not 
+00014370: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00014380: 2020 2020 2020 7465 6d70 203d 2073 656c        temp = sel
+00014390: 662e 6769 732e 6765 745f 7465 6d70 6572  f.gis.get_temper
+000143a0: 6174 7572 6528 6761 7329 2023 206d 756c  ature(gas) # mul
+000143b0: 7469 2d63 6865 6d20 7265 7175 6972 6573  ti-chem requires
+000143c0: 2067 6173 206e 616d 650a 2020 2020 2020   gas name.      
+000143d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000143e0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+000143f0: 203d 2073 656c 662e 6769 732e 6765 745f   = self.gis.get_
+00014400: 7465 6d70 6572 6174 7572 6528 290a 2020  temperature().  
+00014410: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+00014420: 672e 696e 666f 2866 2257 6169 7469 6e67  g.info(f"Waiting
+00014430: 2066 6f72 2068 6561 7465 723a 207b 7465   for heater: {te
+00014440: 6d70 7d4b 2c20 7461 7267 6574 3d7b 7461  mp}K, target={ta
+00014450: 7267 6574 5f74 656d 707d 2c20 7761 6974  rget_temp}, wait
+00014460: 5f74 696d 653d 7b77 6169 745f 7469 6d65  _time={wait_time
+00014470: 7d2f 7b6d 6178 5f77 6169 745f 7469 6d65  }/{max_wait_time
+00014480: 7d20 7365 6322 290a 0a20 2020 2020 2020  } sec")..       
+00014490: 2020 2020 2069 6620 7465 6d70 203e 3d20       if temp >= 
+000144a0: 7461 7267 6574 5f74 656d 703a 0a20 2020  target_temp:.   
+000144b0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+000144c0: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
+000144d0: 7469 6d65 2e73 6c65 6570 2831 2920 2320  time.sleep(1) # 
+000144e0: 7761 6974 2066 6f72 2074 6865 2068 6561  wait for the hea
+000144f0: 740a 0a20 2020 2020 2020 2020 2020 2077  t..            w
+00014500: 6169 745f 7469 6d65 202b 3d20 310a 2020  ait_time += 1.  
+00014510: 2020 2020 2020 2020 2020 6966 2077 6169            if wai
+00014520: 745f 7469 6d65 203e 206d 6178 5f77 6169  t_time > max_wai
+00014530: 745f 7469 6d65 3a0a 2020 2020 2020 2020  t_time:.        
+00014540: 2020 2020 2020 2020 7261 6973 6520 5469          raise Ti
+00014550: 6d65 6f75 7445 7272 6f72 2866 2247 6173  meoutError(f"Gas
+00014560: 2049 6e6a 6563 7469 6f6e 2046 6169 6c65   Injection Faile
+00014570: 6420 746f 2068 6561 7420 7769 7468 696e  d to heat within
+00014580: 2074 696d 652e 2e2e 2229 0a20 2020 2020   time...").     
+00014590: 2020 200a 2020 2020 2020 2020 6c6f 6767     .        logg
+000145a0: 696e 672e 6465 6275 6728 7b22 6d73 6722  ing.debug({"msg"
+000145b0: 3a20 2267 6973 5f74 7572 6e5f 6865 6174  : "gis_turn_heat
+000145c0: 6572 5f6f 6e22 2c20 2274 656d 7022 3a20  er_on", "temp": 
+000145d0: 7465 6d70 2c20 2274 6172 6765 745f 7465  temp, "target_te
+000145e0: 6d70 223a 2074 6172 6765 745f 7465 6d70  mp": target_temp
+000145f0: 2c20 0a20 2020 2020 2020 2020 2020 2020  , .             
+00014600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014610: 2020 2022 7761 6974 5f74 696d 6522 3a20     "wait_time": 
+00014620: 7761 6974 5f74 696d 652c 2022 6d61 785f  wait_time, "max_
+00014630: 7761 6974 5f74 696d 6522 3a20 6d61 785f  wait_time": max_
+00014640: 7761 6974 5f74 696d 657d 290a 0a20 2020  wait_time})..   
+00014650: 2020 2020 2072 6574 7572 6e20 0a0a 0a20       return ... 
+00014660: 2020 2064 6566 2063 7279 6f5f 6465 706f     def cryo_depo
+00014670: 7369 7469 6f6e 5f76 3228 7365 6c66 2c20  sition_v2(self, 
+00014680: 6769 735f 7365 7474 696e 6773 3a20 4669  gis_settings: Fi
+00014690: 6273 656d 4761 7349 6e6a 6563 7469 6f6e  bsemGasInjection
+000146a0: 5365 7474 696e 6773 2920 2d3e 204e 6f6e  Settings) -> Non
+000146b0: 653a 0a20 2020 2020 2020 2022 2222 5275  e:.        """Ru
+000146c0: 6e20 6e6f 6e2d 7370 6563 6966 6963 2063  n non-specific c
+000146d0: 7279 6f20 6465 706f 7369 7469 6f6e 2070  ryo deposition p
+000146e0: 726f 746f 636f 6c2e 0a0a 2020 2020 2020  rotocol...      
+000146f0: 2020 2320 544f 444f 3a20 756e 6976 6572    # TODO: univer
+00014700: 7361 6c69 7365 2074 6869 7320 666f 7220  salise this for 
+00014710: 6465 6d6f 2c20 7465 7363 616e 0a20 2020  demo, tescan.   
+00014720: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00014730: 2020 7573 655f 6d75 6c74 6963 6865 6d20    use_multichem 
+00014740: 3d20 7365 6c66 2e69 735f 6176 6169 6c61  = self.is_availa
+00014750: 626c 6528 2267 6973 5f6d 756c 7469 6368  ble("gis_multich
+00014760: 656d 2229 0a20 2020 2020 2020 2070 6f72  em").        por
+00014770: 7420 3d20 6769 735f 7365 7474 696e 6773  t = gis_settings
+00014780: 2e70 6f72 740a 2020 2020 2020 2020 6761  .port.        ga
+00014790: 7320 3d20 6769 735f 7365 7474 696e 6773  s = gis_settings
+000147a0: 2e67 6173 0a20 2020 2020 2020 2064 7572  .gas.        dur
+000147b0: 6174 696f 6e20 3d20 6769 735f 7365 7474  ation = gis_sett
+000147c0: 696e 6773 2e64 7572 6174 696f 6e0a 2020  ings.duration.  
+000147d0: 2020 2020 2020 696e 7365 7274 5f70 6f73        insert_pos
+000147e0: 6974 696f 6e20 3d20 6769 735f 7365 7474  ition = gis_sett
+000147f0: 696e 6773 2e69 6e73 6572 745f 706f 7369  ings.insert_posi
+00014800: 7469 6f6e 0a0a 2020 2020 2020 2020 6c6f  tion..        lo
+00014810: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00014820: 6722 3a20 2263 7279 6f5f 6465 706f 7369  g": "cryo_deposi
+00014830: 746f 6e5f 7632 222c 2022 7365 7474 696e  ton_v2", "settin
+00014840: 6773 223a 2067 6973 5f73 6574 7469 6e67  gs": gis_setting
+00014850: 732e 746f 5f64 6963 7428 297d 290a 2020  s.to_dict()}).  
+00014860: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
+00014870: 2067 6574 2067 6973 2073 7562 7379 7374   get gis subsyst
+00014880: 656d 0a20 2020 2020 2020 2073 656c 662e  em.        self.
+00014890: 6765 745f 6769 7328 706f 7274 290a 0a20  get_gis(port).. 
+000148a0: 2020 2020 2020 2023 2069 6e73 6572 7420         # insert 
+000148b0: 6769 7320 2f20 6d75 6c74 6963 6865 6d0a  gis / multichem.
+000148c0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000148d0: 696e 666f 2866 2249 6e73 6572 7469 6e67  info(f"Inserting
+000148e0: 2047 6173 2049 6e6a 6563 7469 6f6e 2053   Gas Injection S
+000148f0: 7973 7465 6d20 6174 207b 696e 7365 7274  ystem at {insert
+00014900: 5f70 6f73 6974 696f 6e7d 2229 0a20 2020  _position}").   
+00014910: 2020 2020 2069 6620 7573 655f 6d75 6c74       if use_mult
+00014920: 6963 6865 6d20 6973 2046 616c 7365 3a0a  ichem is False:.
+00014930: 2020 2020 2020 2020 2020 2020 696e 7365              inse
+00014940: 7274 5f70 6f73 6974 696f 6e20 3d20 4e6f  rt_position = No
+00014950: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+00014960: 696e 7365 7274 5f67 6973 2869 6e73 6572  insert_gis(inser
+00014970: 745f 706f 7369 7469 6f6e 290a 0a20 2020  t_position)..   
+00014980: 2020 2020 2023 2074 7572 6e20 6865 6174       # turn heat
+00014990: 6572 206f 6e0a 2020 2020 2020 2020 6761  er on.        ga
+000149a0: 7320 3d20 6761 7320 6966 2075 7365 5f6d  s = gas if use_m
+000149b0: 756c 7469 6368 656d 2065 6c73 6520 4e6f  ultichem else No
+000149c0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+000149d0: 6769 735f 7475 726e 5f68 6561 7465 725f  gis_turn_heater_
+000149e0: 6f6e 2867 6173 290a 2020 2020 2020 2020  on(gas).        
+000149f0: 0a20 2020 2020 2020 2023 2072 756e 2064  .        # run d
+00014a00: 6570 6f73 6974 696f 6e0a 2020 2020 2020  eposition.      
+00014a10: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00014a20: 2252 756e 6e69 6e67 2064 6570 6f73 6974  "Running deposit
+00014a30: 696f 6e20 666f 7220 7b64 7572 6174 696f  ion for {duratio
+00014a40: 6e7d 2073 6563 6f6e 6473 2229 0a20 2020  n} seconds").   
+00014a50: 2020 2020 2073 656c 662e 6769 732e 6f70       self.gis.op
+00014a60: 656e 2829 0a20 2020 2020 2020 2074 696d  en().        tim
+00014a70: 652e 736c 6565 7028 6475 7261 7469 6f6e  e.sleep(duration
+00014a80: 2920 0a20 2020 2020 2020 2023 2054 4f44  ) .        # TOD
+00014a90: 4f3a 2070 726f 7669 6465 206d 6f72 6520  O: provide more 
+00014aa0: 6665 6564 6261 636b 2074 6f20 7573 6572  feedback to user
+00014ab0: 0a20 2020 2020 2020 2073 656c 662e 6769  .        self.gi
+00014ac0: 732e 636c 6f73 6528 290a 0a20 2020 2020  s.close()..     
+00014ad0: 2020 2023 2074 7572 6e20 6f66 6620 6865     # turn off he
+00014ae0: 6174 6572 0a20 2020 2020 2020 206c 6f67  ater.        log
+00014af0: 6769 6e67 2e69 6e66 6f28 6622 5475 726e  ging.info(f"Turn
+00014b00: 696e 6720 6f66 6620 6865 6174 6572 2066  ing off heater f
+00014b10: 6f72 207b 6761 737d 2229 0a20 2020 2020  or {gas}").     
+00014b20: 2020 2073 656c 662e 6769 732e 7475 726e     self.gis.turn
+00014b30: 5f68 6561 7465 725f 6f66 6628 290a 0a20  _heater_off().. 
+00014b40: 2020 2020 2020 2023 2072 6574 7261 6374         # retract
+00014b50: 2067 6973 202f 206d 756c 7469 6368 656d   gis / multichem
+00014b60: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00014b70: 2e69 6e66 6f28 6622 5265 7472 6163 7469  .info(f"Retracti
+00014b80: 6e67 2047 6173 2049 6e6a 6563 7469 6f6e  ng Gas Injection
+00014b90: 2053 7973 7465 6d22 290a 2020 2020 2020   System").      
+00014ba0: 2020 7365 6c66 2e72 6574 7261 6374 5f67    self.retract_g
+00014bb0: 6973 2829 0a20 2020 2020 2020 2020 2020  is().           
+00014bc0: 200a 2020 2020 2020 2020 7265 7475 726e   .        return
+00014bd0: 0a20 2020 2020 2020 200a 0a20 2020 2064  .        ..    d
+00014be0: 6566 2073 6574 7570 5f73 7075 7474 6572  ef setup_sputter
+00014bf0: 2873 656c 662c 2070 726f 746f 636f 6c3a  (self, protocol:
+00014c00: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+00014c10: 2222 220a 2020 2020 2020 2020 5365 7420  """.        Set 
+00014c20: 7570 2074 6865 2073 7075 7474 6572 2063  up the sputter c
+00014c30: 6f61 7469 6e67 2070 726f 6365 7373 206f  oating process o
+00014c40: 6e20 7468 6520 6d69 6372 6f73 636f 7065  n the microscope
+00014c50: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00014c60: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+00014c70: 746f 636f 6c20 2864 6963 7429 3a20 4469  tocol (dict): Di
+00014c80: 6374 696f 6e61 7279 2063 6f6e 7461 696e  ctionary contain
+00014c90: 696e 6720 7468 6520 7072 6f74 6f63 6f6c  ing the protocol
+00014ca0: 2064 6574 6169 6c73 2066 6f72 2073 7075   details for spu
+00014cb0: 7474 6572 2063 6f61 7469 6e67 2e0a 0a20  tter coating... 
+00014cc0: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00014cd0: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
+00014ce0: 0a0a 2020 2020 2020 2020 5261 6973 6573  ..        Raises
+00014cf0: 3a0a 2020 2020 2020 2020 2020 2020 4e6f  :.            No
+00014d00: 6e65 0a0a 2020 2020 2020 2020 4e6f 7465  ne..        Note
+00014d10: 733a 0a20 2020 2020 2020 2020 2020 2054  s:.            T
+00014d20: 6869 7320 6675 6e63 7469 6f6e 2073 6574  his function set
+00014d30: 7320 7570 2074 6865 2073 7075 7474 6572  s up the sputter
+00014d40: 2063 6f61 7469 6e67 2070 726f 6365 7373   coating process
+00014d50: 206f 6e20 7468 6520 6d69 6372 6f73 636f   on the microsco
+00014d60: 7065 2e20 0a20 2020 2020 2020 2020 2020  pe. .           
+00014d70: 2049 7420 7365 7473 2074 6865 2061 6374   It sets the act
+00014d80: 6976 6520 7669 6577 2074 6f20 7468 6520  ive view to the 
+00014d90: 656c 6563 7472 6f6e 2062 6561 6d2c 2063  electron beam, c
+00014da0: 6c65 6172 7320 616e 7920 6578 6973 7469  lears any existi
+00014db0: 6e67 2070 6174 7465 726e 732c 2061 6e64  ng patterns, and
+00014dc0: 2073 6574 7320 7468 6520 6465 6661 756c   sets the defaul
+00014dd0: 7420 6265 616d 2074 7970 6520 746f 2074  t beam type to t
+00014de0: 6865 2065 6c65 6374 726f 6e20 6265 616d  he electron beam
+00014df0: 2e20 0a20 2020 2020 2020 2020 2020 2049  . .            I
+00014e00: 7420 7468 656e 2069 6e73 6572 7473 2074  t then inserts t
+00014e10: 6865 206d 756c 7469 6368 656d 2061 6e64  he multichem and
+00014e20: 2074 7572 6e73 206f 6e20 7468 6520 6865   turns on the he
+00014e30: 6174 6572 2066 6f72 2074 6865 2073 7065  ater for the spe
+00014e40: 6369 6669 6564 2067 6173 2061 6363 6f72  cified gas accor
+00014e50: 6469 6e67 2074 6f20 7468 6520 6769 7665  ding to the give
+00014e60: 6e20 7072 6f74 6f63 6f6c 2e20 0a20 2020  n protocol. .   
+00014e70: 2020 2020 2020 2020 2054 6869 7320 6675           This fu
+00014e80: 6e63 7469 6f6e 2061 6c73 6f20 7761 6974  nction also wait
+00014e90: 7320 666f 7220 3320 7365 636f 6e64 7320  s for 3 seconds 
+00014ea0: 746f 2061 6c6c 6f77 2074 6865 2068 6561  to allow the hea
+00014eb0: 7465 7220 746f 2077 6172 6d20 7570 2e0a  ter to warm up..
+00014ec0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00014ed0: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
+00014ee0: 6572 2873 656c 662e 7379 7374 656d 290a  er(self.system).
+00014ef0: 2020 2020 2020 2020 7365 6c66 2e6f 7269          self.ori
+00014f00: 6769 6e61 6c5f 6163 7469 7665 5f76 6965  ginal_active_vie
+00014f10: 7720 3d20 7365 6c66 2e63 6f6e 6e65 6374  w = self.connect
+00014f20: 696f 6e2e 696d 6167 696e 672e 6765 745f  ion.imaging.get_
+00014f30: 6163 7469 7665 5f76 6965 7728 290a 2020  active_view().  
+00014f40: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00014f50: 6374 696f 6e2e 696d 6167 696e 672e 7365  ction.imaging.se
+00014f60: 745f 6163 7469 7665 5f76 6965 7728 4265  t_active_view(Be
+00014f70: 616d 5479 7065 2e45 4c45 4354 524f 4e2e  amType.ELECTRON.
+00014f80: 7661 6c75 6529 0a20 2020 2020 2020 2073  value).        s
+00014f90: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+00014fa0: 6174 7465 726e 696e 672e 636c 6561 725f  atterning.clear_
+00014fb0: 7061 7474 6572 6e73 2829 0a20 2020 2020  patterns().     
+00014fc0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00014fd0: 6f6e 2e70 6174 7465 726e 696e 672e 7365  on.patterning.se
+00014fe0: 745f 6465 6661 756c 745f 6170 706c 6963  t_default_applic
+00014ff0: 6174 696f 6e5f 6669 6c65 2870 726f 746f  ation_file(proto
+00015000: 636f 6c5b 2261 7070 6c69 6361 7469 6f6e  col["application
+00015010: 5f66 696c 6522 5d29 0a20 2020 2020 2020  _file"]).       
+00015020: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00015030: 2e70 6174 7465 726e 696e 672e 7365 745f  .patterning.set_
+00015040: 6465 6661 756c 745f 6265 616d 5f74 7970  default_beam_typ
+00015050: 6528 4265 616d 5479 7065 2e45 4c45 4354  e(BeamType.ELECT
+00015060: 524f 4e2e 7661 6c75 6529 0a20 2020 2020  RON.value).     
+00015070: 2020 2073 656c 662e 6d75 6c74 6963 6865     self.multiche
+00015080: 6d20 3d20 7365 6c66 2e63 6f6e 6e65 6374  m = self.connect
+00015090: 696f 6e2e 6761 732e 6765 745f 6d75 6c74  ion.gas.get_mult
+000150a0: 6963 6865 6d28 290a 2020 2020 2020 2020  ichem().        
+000150b0: 7365 6c66 2e6d 756c 7469 6368 656d 2e69  self.multichem.i
+000150c0: 6e73 6572 7428 7072 6f74 6f63 6f6c 5b22  nsert(protocol["
+000150d0: 706f 7369 7469 6f6e 225d 290a 2020 2020  position"]).    
+000150e0: 2020 2020 7365 6c66 2e6d 756c 7469 6368      self.multich
+000150f0: 656d 2e74 7572 6e5f 6865 6174 6572 5f6f  em.turn_heater_o
+00015100: 6e28 7072 6f74 6f63 6f6c 5b22 6761 7322  n(protocol["gas"
+00015110: 5d29 2020 2320 2250 7420 6372 796f 2229  ])  # "Pt cryo")
+00015120: 0a20 2020 2020 2020 2074 696d 652e 736c  .        time.sl
+00015130: 6565 7028 3329 0a20 2020 2020 2020 200a  eep(3).        .
+00015140: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00015150: 6465 6275 6728 7b22 6d73 6722 3a20 2273  debug({"msg": "s
+00015160: 6574 7570 5f73 7075 7474 6572 222c 2022  etup_sputter", "
+00015170: 7072 6f74 6f63 6f6c 223a 2070 726f 746f  protocol": proto
+00015180: 636f 6c7d 290a 2020 2020 2020 2020 0a0a  col}).        ..
+00015190: 2020 2020 6465 6620 6472 6177 5f73 7075      def draw_spu
+000151a0: 7474 6572 5f70 6174 7465 726e 2873 656c  tter_pattern(sel
+000151b0: 662c 2068 6677 3a20 666c 6f61 742c 206c  f, hfw: float, l
+000151c0: 696e 655f 7061 7474 6572 6e5f 6c65 6e67  ine_pattern_leng
+000151d0: 7468 3a20 666c 6f61 742c 2073 7075 7474  th: float, sputt
+000151e0: 6572 5f74 696d 653a 2066 6c6f 6174 293a  er_time: float):
+000151f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00015200: 2020 2020 2044 7261 7773 2061 206c 696e       Draws a lin
+00015210: 6520 7061 7474 6572 6e20 666f 7220 7370  e pattern for sp
+00015220: 7574 7465 7269 6e67 2077 6974 6820 7468  uttering with th
+00015230: 6520 6769 7665 6e20 7061 7261 6d65 7465  e given paramete
+00015240: 7273 2e0a 0a20 2020 2020 2020 2041 7267  rs...        Arg
+00015250: 733a 0a20 2020 2020 2020 2020 2020 2068  s:.            h
+00015260: 6677 2028 666c 6f61 7429 3a20 5468 6520  fw (float): The 
+00015270: 686f 7269 7a6f 6e74 616c 2066 6965 6c64  horizontal field
+00015280: 2077 6964 7468 206f 6620 7468 6520 656c   width of the el
+00015290: 6563 7472 6f6e 2062 6561 6d2e 0a20 2020  ectron beam..   
+000152a0: 2020 2020 2020 2020 206c 696e 655f 7061           line_pa
+000152b0: 7474 6572 6e5f 6c65 6e67 7468 2028 666c  ttern_length (fl
+000152c0: 6f61 7429 3a20 5468 6520 6c65 6e67 7468  oat): The length
+000152d0: 206f 6620 7468 6520 6c69 6e65 2070 6174   of the line pat
+000152e0: 7465 726e 2074 6f20 6472 6177 2e0a 2020  tern to draw..  
+000152f0: 2020 2020 2020 2020 2020 7370 7574 7465            sputte
+00015300: 725f 7469 6d65 2028 666c 6f61 7429 3a20  r_time (float): 
+00015310: 5468 6520 7469 6d65 2074 6f20 7370 7574  The time to sput
+00015320: 7465 7220 7468 6520 6c69 6e65 2070 6174  ter the line pat
+00015330: 7465 726e 2e0a 0a20 2020 2020 2020 2052  tern...        R
+00015340: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00015350: 2020 2020 4e6f 6e65 0a0a 2020 2020 2020      None..      
+00015360: 2020 4e6f 7465 733a 0a20 2020 2020 2020    Notes:.       
+00015370: 2020 2020 2053 6574 7320 7468 6520 686f       Sets the ho
+00015380: 7269 7a6f 6e74 616c 2066 6965 6c64 2077  rizontal field w
+00015390: 6964 7468 206f 6620 7468 6520 656c 6563  idth of the elec
+000153a0: 7472 6f6e 2062 6561 6d20 746f 2074 6865  tron beam to the
+000153b0: 2067 6976 656e 2076 616c 7565 2e0a 2020   given value..  
+000153c0: 2020 2020 2020 2020 2020 4472 6177 7320            Draws 
+000153d0: 6120 6c69 6e65 2070 6174 7465 726e 2066  a line pattern f
+000153e0: 6f72 2073 7075 7474 6572 696e 6720 7769  or sputtering wi
+000153f0: 7468 2074 6865 2067 6976 656e 206c 656e  th the given len
+00015400: 6774 6820 616e 6420 6d69 6c6c 696e 6720  gth and milling 
+00015410: 6465 7074 682e 0a20 2020 2020 2020 2020  depth..         
+00015420: 2020 2053 6574 7320 7468 6520 7370 7574     Sets the sput
+00015430: 7465 7220 7469 6d65 206f 6620 7468 6520  ter time of the 
+00015440: 6c69 6e65 2070 6174 7465 726e 2074 6f20  line pattern to 
+00015450: 7468 6520 6769 7665 6e20 7661 6c75 652e  the given value.
+00015460: 0a0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00015470: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00015480: 6374 696f 6e2e 6265 616d 732e 656c 6563  ction.beams.elec
+00015490: 7472 6f6e 5f62 6561 6d2e 686f 7269 7a6f  tron_beam.horizo
+000154a0: 6e74 616c 5f66 6965 6c64 5f77 6964 7468  ntal_field_width
+000154b0: 2e76 616c 7565 203d 2068 6677 0a20 2020  .value = hfw.   
+000154c0: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
+000154d0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+000154e0: 6174 7465 726e 696e 672e 6372 6561 7465  atterning.create
+000154f0: 5f6c 696e 6528 0a20 2020 2020 2020 2020  _line(.         
+00015500: 2020 202d 6c69 6e65 5f70 6174 7465 726e     -line_pattern
+00015510: 5f6c 656e 6774 6820 2f20 322c 2020 2320  _length / 2,  # 
+00015520: 785f 7374 6172 740a 2020 2020 2020 2020  x_start.        
+00015530: 2020 2020 2b6c 696e 655f 7061 7474 6572      +line_patter
+00015540: 6e5f 6c65 6e67 7468 2c20 2023 2079 5f73  n_length,  # y_s
+00015550: 7461 7274 0a20 2020 2020 2020 2020 2020  tart.           
+00015560: 202b 6c69 6e65 5f70 6174 7465 726e 5f6c   +line_pattern_l
+00015570: 656e 6774 6820 2f20 322c 2020 2320 785f  ength / 2,  # x_
+00015580: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
+00015590: 2b6c 696e 655f 7061 7474 6572 6e5f 6c65  +line_pattern_le
+000155a0: 6e67 7468 2c20 2023 2079 5f65 6e64 0a20  ngth,  # y_end. 
+000155b0: 2020 2020 2020 2020 2020 2032 652d 362c             2e-6,
+000155c0: 0a20 2020 2020 2020 2029 2020 2320 6d69  .        )  # mi
+000155d0: 6c6c 696e 6720 6465 7074 680a 2020 2020  lling depth.    
+000155e0: 2020 2020 7061 7474 6572 6e2e 7469 6d65      pattern.time
+000155f0: 203d 2073 7075 7474 6572 5f74 696d 6520   = sputter_time 
+00015600: 2b20 302e 310a 2020 2020 2020 2020 0a20  + 0.1.        . 
+00015610: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00015620: 6562 7567 287b 226d 7367 223a 2022 6472  ebug({"msg": "dr
+00015630: 6177 5f73 7075 7474 6572 5f70 6174 7465  aw_sputter_patte
+00015640: 726e 222c 2022 6866 7722 3a20 6866 772c  rn", "hfw": hfw,
+00015650: 2022 6c69 6e65 5f70 6174 7465 726e 5f6c   "line_pattern_l
+00015660: 656e 6774 6822 3a20 6c69 6e65 5f70 6174  ength": line_pat
+00015670: 7465 726e 5f6c 656e 6774 682c 2022 7370  tern_length, "sp
+00015680: 7574 7465 725f 7469 6d65 223a 2073 7075  utter_time": spu
+00015690: 7474 6572 5f74 696d 657d 290a 0a20 2020  tter_time})..   
+000156a0: 2064 6566 2072 756e 5f73 7075 7474 6572   def run_sputter
+000156b0: 2873 656c 662c 202a 2a6b 7761 7267 7329  (self, **kwargs)
+000156c0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+000156d0: 2020 2020 2020 5275 6e73 2074 6865 2047        Runs the G
+000156e0: 4953 2050 6c61 7469 6e75 6d20 5370 7574  IS Platinum Sput
+000156f0: 7465 722e 0a0a 2020 2020 2020 2020 4172  ter...        Ar
+00015700: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+00015710: 2a2a 6b77 6172 6773 3a20 4f70 7469 6f6e  **kwargs: Option
+00015720: 616c 206b 6579 776f 7264 2061 7267 756d  al keyword argum
+00015730: 656e 7473 2066 6f72 2074 6865 2073 7075  ents for the spu
+00015740: 7474 6572 2066 756e 6374 696f 6e2e 2054  tter function. T
+00015750: 6865 2072 6571 7569 7265 6420 6172 6775  he required argu
+00015760: 6d65 6e74 2066 6f72 0a20 2020 2020 2020  ment for.       
+00015770: 2074 6865 2054 6865 726d 6f20 7665 7273   the Thermo vers
+00015780: 696f 6e20 6973 2022 7370 7574 7465 725f  ion is "sputter_
+00015790: 7469 6d65 2220 2869 6e74 292c 2077 6869  time" (int), whi
+000157a0: 6368 2073 7065 6369 6669 6573 2074 6865  ch specifies the
+000157b0: 2074 696d 6520 746f 2073 7075 7474 6572   time to sputter
+000157c0: 2069 6e20 7365 636f 6e64 732e 200a 0a20   in seconds. .. 
+000157d0: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+000157e0: 2020 2020 2020 2020 2020 2020 4e6f 6e65              None
+000157f0: 0a0a 2020 2020 2020 2020 4e6f 7465 733a  ..        Notes:
+00015800: 0a20 2020 2020 2020 202d 2042 6c61 6e6b  .        - Blank
+00015810: 7320 7468 6520 656c 6563 7472 6f6e 2062  s the electron b
+00015820: 6561 6d2e 0a20 2020 2020 2020 202d 2053  eam..        - S
+00015830: 7461 7274 7320 7370 7574 7465 7269 6e67  tarts sputtering
+00015840: 2077 6974 6820 706c 6174 696e 756d 2066   with platinum f
+00015850: 6f72 2074 6865 2073 7065 6369 6669 6564  or the specified
+00015860: 2073 7075 7474 6572 2074 696d 652c 2061   sputter time, a
+00015870: 6e64 2077 6169 7473 2075 6e74 696c 2074  nd waits until t
+00015880: 6865 2073 7075 7474 6572 696e 670a 2020  he sputtering.  
+00015890: 2020 2020 2020 6973 2063 6f6d 706c 6574        is complet
+000158a0: 6520 6265 666f 7265 2063 6f6e 7469 6e75  e before continu
+000158b0: 696e 672e 0a20 2020 2020 2020 202d 2049  ing..        - I
+000158c0: 6620 7468 6520 7061 7474 6572 6e69 6e67  f the patterning
+000158d0: 2073 7461 7465 2069 7320 6e6f 7420 7265   state is not re
+000158e0: 6164 792c 2072 6169 7365 7320 6120 5275  ady, raises a Ru
+000158f0: 6e74 696d 6545 7272 6f72 2e0a 2020 2020  ntimeError..    
+00015900: 2020 2020 2d20 4966 2074 6865 2070 6174      - If the pat
+00015910: 7465 726e 696e 6720 7374 6174 6520 6973  terning state is
+00015920: 2072 756e 6e69 6e67 2c20 7374 6f70 7320   running, stops 
+00015930: 7468 6520 7061 7474 6572 6e69 6e67 2e0a  the patterning..
+00015940: 2020 2020 2020 2020 2d20 4966 2074 6865          - If the
+00015950: 2070 6174 7465 726e 696e 6720 7374 6174   patterning stat
+00015960: 6520 6973 2069 646c 652c 206c 6f67 7320  e is idle, logs 
+00015970: 6120 7761 726e 696e 6720 6d65 7373 6167  a warning messag
+00015980: 6520 7375 6767 6573 7469 6e67 2074 6f20  e suggesting to 
+00015990: 6164 6a75 7374 2074 6865 2070 6174 7465  adjust the patte
+000159a0: 726e 696e 670a 2020 2020 2020 2020 6c69  rning.        li
+000159b0: 6e65 2064 6570 7468 2e0a 2020 2020 2020  ne depth..      
+000159c0: 2020 2222 220a 2020 2020 2020 2020 5f63    """.        _c
+000159d0: 6865 636b 5f73 7075 7474 6572 2873 656c  heck_sputter(sel
+000159e0: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
+000159f0: 2020 7370 7574 7465 725f 7469 6d65 203d    sputter_time =
+00015a00: 206b 7761 7267 735b 2273 7075 7474 6572   kwargs["sputter
+00015a10: 5f74 696d 6522 5d0a 0a20 2020 2020 2020  _time"]..       
+00015a20: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00015a30: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
+00015a40: 6265 616d 2e62 6c61 6e6b 2829 0a20 2020  beam.blank().   
+00015a50: 2020 2020 2069 6620 7365 6c66 2e63 6f6e       if self.con
+00015a60: 6e65 6374 696f 6e2e 7061 7474 6572 6e69  nection.patterni
+00015a70: 6e67 2e73 7461 7465 203d 3d20 2249 646c  ng.state == "Idl
+00015a80: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00015a90: 6c6f 6767 696e 672e 696e 666f 2822 5370  logging.info("Sp
+00015aa0: 7574 7465 7269 6e67 2077 6974 6820 706c  uttering with pl
+00015ab0: 6174 696e 756d 2066 6f72 207b 7d20 7365  atinum for {} se
+00015ac0: 636f 6e64 732e 2e2e 222e 666f 726d 6174  conds...".format
+00015ad0: 2873 7075 7474 6572 5f74 696d 6529 290a  (sputter_time)).
+00015ae0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00015af0: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
+00015b00: 6572 6e69 6e67 2e73 7461 7274 2829 2020  erning.start()  
+00015b10: 2320 6173 796e 6368 726f 6e6f 7573 2070  # asynchronous p
+00015b20: 6174 7465 726e 696e 670a 2020 2020 2020  atterning.      
+00015b30: 2020 2020 2020 7469 6d65 2e73 6c65 6570        time.sleep
+00015b40: 2873 7075 7474 6572 5f74 696d 6520 2b20  (sputter_time + 
+00015b50: 3529 0a20 2020 2020 2020 2065 6c73 653a  5).        else:
+00015b60: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00015b70: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00015b80: 2243 616e 2774 2073 7075 7474 6572 2070  "Can't sputter p
+00015b90: 6c61 7469 6e75 6d2c 2070 6174 7465 726e  latinum, pattern
+00015ba0: 696e 6720 7374 6174 6520 6973 206e 6f74  ing state is not
+00015bb0: 2072 6561 6479 2e22 290a 2020 2020 2020   ready.").      
+00015bc0: 2020 6966 2073 656c 662e 636f 6e6e 6563    if self.connec
+00015bd0: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
+00015be0: 7374 6174 6520 3d3d 2022 5275 6e6e 696e  state == "Runnin
+00015bf0: 6722 3a0a 2020 2020 2020 2020 2020 2020  g":.            
+00015c00: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00015c10: 7061 7474 6572 6e69 6e67 2e73 746f 7028  patterning.stop(
+00015c20: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00015c30: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00015c40: 696e 672e 7761 726e 696e 6728 2250 6174  ing.warning("Pat
+00015c50: 7465 726e 696e 6720 7374 6174 6520 6973  terning state is
+00015c60: 207b 7d22 2e66 6f72 6d61 7428 7365 6c66   {}".format(self
+00015c70: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
+00015c80: 6572 6e69 6e67 2e73 7461 7465 2929 0a20  erning.state)). 
+00015c90: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00015ca0: 6e67 2e77 6172 6e69 6e67 2822 436f 6e73  ng.warning("Cons
+00015cb0: 6964 6572 2061 646a 7573 7469 6e67 2074  ider adjusting t
+00015cc0: 6865 2070 6174 7465 726e 696e 6720 6c69  he patterning li
+00015cd0: 6e65 2064 6570 7468 2e22 290a 0a20 2020  ne depth.")..   
+00015ce0: 2064 6566 2066 696e 6973 685f 7370 7574   def finish_sput
+00015cf0: 7465 7228 7365 6c66 2c20 6170 706c 6963  ter(self, applic
+00015d00: 6174 696f 6e5f 6669 6c65 3a20 7374 7229  ation_file: str)
+00015d10: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00015d20: 2020 2222 220a 2020 2020 2020 2020 4669    """.        Fi
+00015d30: 6e69 7368 2074 6865 2073 7075 7474 6572  nish the sputter
+00015d40: 2070 726f 6365 7373 2062 7920 636c 6561   process by clea
+00015d50: 7269 6e67 2070 6174 7465 726e 7320 616e  ring patterns an
+00015d60: 6420 7265 7365 7474 696e 6720 6265 616d  d resetting beam
+00015d70: 2061 6e64 2069 6d61 6769 6e67 2073 6574   and imaging set
+00015d80: 7469 6e67 732e 0a0a 2020 2020 2020 2020  tings...        
+00015d90: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+00015da0: 2020 6170 706c 6963 6174 696f 6e5f 6669    application_fi
+00015db0: 6c65 2028 7374 7229 3a20 5468 6520 7061  le (str): The pa
+00015dc0: 7468 2074 6f20 7468 6520 6465 6661 756c  th to the defaul
+00015dd0: 7420 6170 706c 6963 6174 696f 6e20 6669  t application fi
+00015de0: 6c65 2074 6f20 7573 652e 0a0a 2020 2020  le to use...    
+00015df0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00015e00: 2020 2020 2020 2020 204e 6f6e 650a 0a20           None.. 
+00015e10: 2020 2020 2020 2052 6169 7365 733a 0a20         Raises:. 
+00015e20: 2020 2020 2020 2020 2020 204e 6f6e 650a             None.
+00015e30: 0a20 2020 2020 2020 204e 6f74 6573 3a0a  .        Notes:.
+00015e40: 2020 2020 2020 2020 2020 2020 5468 6973              This
+00015e50: 2066 756e 6374 696f 6e20 6669 6e69 7368   function finish
+00015e60: 6573 2074 6865 2073 7075 7474 6572 2070  es the sputter p
+00015e70: 726f 6365 7373 2062 7920 636c 6561 7269  rocess by cleari
+00015e80: 6e67 2061 6e79 2072 656d 6169 6e69 6e67  ng any remaining
+00015e90: 2070 6174 7465 726e 7320 616e 6420 7265   patterns and re
+00015ea0: 7374 6f72 696e 6720 7468 6520 6265 616d  storing the beam
+00015eb0: 2061 6e64 2069 6d61 6769 6e67 2073 6574   and imaging set
+00015ec0: 7469 6e67 7320 746f 2074 6865 6972 0a20  tings to their. 
+00015ed0: 2020 2020 2020 2020 2020 206f 7269 6769             origi
+00015ee0: 6e61 6c20 7374 6174 652e 2049 7420 7365  nal state. It se
+00015ef0: 7473 2074 6865 2062 6561 6d20 6375 7272  ts the beam curr
+00015f00: 656e 7420 6261 636b 2074 6f20 696d 6167  ent back to imag
+00015f10: 696e 6720 6375 7272 656e 7420 616e 6420  ing current and 
+00015f20: 7365 7473 2074 6865 2064 6566 6175 6c74  sets the default
+00015f30: 2062 6561 6d20 7479 7065 2074 6f20 696f   beam type to io
+00015f40: 6e20 6265 616d 2e0a 2020 2020 2020 2020  n beam..        
+00015f50: 2020 2020 4974 2061 6c73 6f20 7265 7472      It also retr
+00015f60: 6163 7473 2074 6865 206d 756c 7469 6368  acts the multich
+00015f70: 656d 2061 6e64 206c 6f67 7320 7468 6174  em and logs that
+00015f80: 2074 6865 2073 7075 7474 6572 696e 6720   the sputtering 
+00015f90: 7072 6f63 6573 7320 6861 7320 6669 6e69  process has fini
+00015fa0: 7368 6564 2e0a 2020 2020 2020 2020 2222  shed..        ""
+00015fb0: 220a 2020 2020 2020 2020 5f63 6865 636b  ".        _check
+00015fc0: 5f73 7075 7474 6572 2873 656c 662e 7379  _sputter(self.sy
+00015fd0: 7374 656d 290a 2020 2020 2020 2020 2320  stem).        # 
+00015fe0: 436c 6561 7220 616e 7920 7265 6d61 696e  Clear any remain
+00015ff0: 696e 6720 7061 7474 6572 6e73 0a20 2020  ing patterns.   
+00016000: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00016010: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
+00016020: 636c 6561 725f 7061 7474 6572 6e73 2829  clear_patterns()
+00016030: 0a0a 2020 2020 2020 2020 2320 5265 7374  ..        # Rest
+00016040: 6f72 6520 6265 616d 2061 6e64 2069 6d61  ore beam and ima
+00016050: 6769 6e67 2073 6574 7469 6e67 7320 746f  ging settings to
+00016060: 2074 6865 6972 206f 7269 6769 6e61 6c20   their original 
+00016070: 7374 6174 650a 2020 2020 2020 2020 7365  state.        se
+00016080: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+00016090: 616d 732e 656c 6563 7472 6f6e 5f62 6561  ams.electron_bea
+000160a0: 6d2e 756e 626c 616e 6b28 290a 2020 2020  m.unblank().    
+000160b0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+000160c0: 696f 6e2e 7061 7474 6572 6e69 6e67 2e73  ion.patterning.s
+000160d0: 6574 5f64 6566 6175 6c74 5f61 7070 6c69  et_default_appli
+000160e0: 6361 7469 6f6e 5f66 696c 6528 6170 706c  cation_file(appl
+000160f0: 6963 6174 696f 6e5f 6669 6c65 290a 2020  ication_file).  
+00016100: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00016110: 6374 696f 6e2e 696d 6167 696e 672e 7365  ction.imaging.se
+00016120: 745f 6163 7469 7665 5f76 6965 7728 7365  t_active_view(se
+00016130: 6c66 2e6f 7269 6769 6e61 6c5f 6163 7469  lf.original_acti
+00016140: 7665 5f76 6965 7729 0a20 2020 2020 2020  ve_view).       
+00016150: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00016160: 2e70 6174 7465 726e 696e 672e 7365 745f  .patterning.set_
+00016170: 6465 6661 756c 745f 6265 616d 5f74 7970  default_beam_typ
+00016180: 6528 4265 616d 5479 7065 2e49 4f4e 2e76  e(BeamType.ION.v
+00016190: 616c 7565 2920 2023 2073 6574 2069 6f6e  alue)  # set ion
+000161a0: 2062 6561 6d0a 2020 2020 2020 2020 7365   beam.        se
+000161b0: 6c66 2e6d 756c 7469 6368 656d 2e72 6574  lf.multichem.ret
+000161c0: 7261 6374 2829 0a0a 2020 2020 2020 2020  ract()..        
+000161d0: 2320 4c6f 6720 7468 6174 2074 6865 2073  # Log that the s
+000161e0: 7075 7474 6572 696e 6720 7072 6f63 6573  puttering proces
+000161f0: 7320 6861 7320 6669 6e69 7368 6564 0a20  s has finished. 
+00016200: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+00016210: 6e66 6f28 2250 6c61 7469 6e75 6d20 7370  nfo("Platinum sp
+00016220: 7574 7465 7269 6e67 2070 726f 6365 7373  uttering process
+00016230: 2063 6f6d 706c 6574 6564 2e22 290a 0a20   completed.").. 
+00016240: 2020 2023 2064 6566 2073 6574 7570 5f47     # def setup_G
+00016250: 4953 2873 656c 662c 7072 6f74 6f63 6f6c  IS(self,protocol
+00016260: 293a 0a0a 2020 2020 2320 2020 2020 6265  ):..    #     be
+00016270: 616d 7479 7065 5f76 616c 7565 203d 2042  amtype_value = B
+00016280: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00016290: 2e76 616c 7565 2069 6620 7072 6f74 6f63  .value if protoc
+000162a0: 6f6c 5b22 6265 616d 5f74 7970 6522 5d20  ol["beam_type"] 
+000162b0: 3d3d 2022 656c 6563 7472 6f6e 2220 656c  == "electron" el
+000162c0: 7365 2042 6561 6d54 7970 652e 494f 4e2e  se BeamType.ION.
+000162d0: 7661 6c75 650a 0a20 2020 2023 2020 2020  value..    #    
+000162e0: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
+000162f0: 7365 6c66 2e73 7973 7465 6d29 0a20 2020  self.system).   
+00016300: 2023 2020 2020 2073 656c 662e 6f72 6967   #     self.orig
+00016310: 696e 616c 5f61 6374 6976 655f 7669 6577  inal_active_view
+00016320: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
+00016330: 6f6e 2e69 6d61 6769 6e67 2e67 6574 5f61  on.imaging.get_a
+00016340: 6374 6976 655f 7669 6577 2829 0a20 2020  ctive_view().   
+00016350: 2023 2020 2020 2073 656c 662e 636f 6e6e   #     self.conn
+00016360: 6563 7469 6f6e 2e69 6d61 6769 6e67 2e73  ection.imaging.s
+00016370: 6574 5f61 6374 6976 655f 7669 6577 2862  et_active_view(b
+00016380: 6561 6d74 7970 655f 7661 6c75 6529 0a20  eamtype_value). 
+00016390: 2020 2023 2020 2020 2073 656c 662e 636f     #     self.co
+000163a0: 6e6e 6563 7469 6f6e 2e70 6174 7465 726e  nnection.pattern
+000163b0: 696e 672e 636c 6561 725f 7061 7474 6572  ing.clear_patter
+000163c0: 6e73 2829 0a20 2020 2023 2020 2020 2073  ns().    #     s
+000163d0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+000163e0: 6174 7465 726e 696e 672e 7365 745f 6465  atterning.set_de
+000163f0: 6661 756c 745f 6170 706c 6963 6174 696f  fault_applicatio
+00016400: 6e5f 6669 6c65 2870 726f 746f 636f 6c5b  n_file(protocol[
+00016410: 2261 7070 6c69 6361 7469 6f6e 5f66 696c  "application_fil
+00016420: 6522 5d29 0a20 2020 2023 2020 2020 2073  e"]).    #     s
+00016430: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+00016440: 6174 7465 726e 696e 672e 7365 745f 6465  atterning.set_de
+00016450: 6661 756c 745f 6265 616d 5f74 7970 6528  fault_beam_type(
+00016460: 6265 616d 7479 7065 5f76 616c 7565 290a  beamtype_value).
+00016470: 0a20 2020 2023 2020 2020 2067 6973 5f6c  .    #     gis_l
+00016480: 696e 6520 3d20 7072 6f74 6f63 6f6c 5b22  ine = protocol["
+00016490: 6761 7322 5d0a 2020 2020 2320 2020 2020  gas"].    #     
+000164a0: 706f 7274 203d 2073 656c 662e 6769 735f  port = self.gis_
+000164b0: 6c69 6e65 735b 6769 735f 6c69 6e65 5d0a  lines[gis_line].
+000164c0: 2020 2020 2320 2020 2020 6966 2073 656c      #     if sel
+000164d0: 662e 4749 535f 706f 7369 7469 6f6e 2867  f.GIS_position(g
+000164e0: 6973 5f6c 696e 6529 203d 3d20 2252 6574  is_line) == "Ret
+000164f0: 7261 6374 6564 223a 0a20 2020 2023 2020  racted":.    #  
+00016500: 2020 2020 2020 2070 6f72 742e 696e 7365         port.inse
+00016510: 7274 2829 0a0a 2020 2020 2320 2020 2020  rt()..    #     
+00016520: 6966 2073 656c 662e 4749 535f 7465 6d70  if self.GIS_temp
+00016530: 5f72 6561 6479 2867 6973 5f6c 696e 6529  _ready(gis_line)
+00016540: 203d 3d20 4661 6c73 653a 0a20 2020 2023   == False:.    #
+00016550: 2020 2020 2020 2020 2073 656c 662e 4749           self.GI
+00016560: 535f 6865 6174 5f75 7028 6769 735f 6c69  S_heat_up(gis_li
+00016570: 6e65 290a 0a0a 2020 2020 2320 6465 6620  ne)...    # def 
+00016580: 7365 7475 705f 4749 535f 7061 7474 6572  setup_GIS_patter
+00016590: 6e28 7365 6c66 2c70 726f 746f 636f 6c29  n(self,protocol)
+000165a0: 3a0a 0a20 2020 2023 2020 2020 2068 6677  :..    #     hfw
+000165b0: 203d 2070 726f 746f 636f 6c5b 2268 6677   = protocol["hfw
+000165c0: 225d 0a20 2020 2023 2020 2020 206c 696e  "].    #     lin
+000165d0: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+000165e0: 203d 2070 726f 746f 636f 6c5b 226c 656e   = protocol["len
+000165f0: 6774 6822 5d0a 2020 2020 2320 2020 2020  gth"].    #     
+00016600: 7370 7574 7465 725f 7469 6d65 203d 2070  sputter_time = p
+00016610: 726f 746f 636f 6c5b 2273 7075 7474 6572  rotocol["sputter
+00016620: 5f74 696d 6522 5d0a 0a20 2020 2023 2020  _time"]..    #  
+00016630: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00016640: 6f6e 2e62 6561 6d73 2e65 6c65 6374 726f  on.beams.electro
+00016650: 6e5f 6265 616d 2e68 6f72 697a 6f6e 7461  n_beam.horizonta
+00016660: 6c5f 6669 656c 645f 7769 6474 682e 7661  l_field_width.va
+00016670: 6c75 6520 3d20 6866 770a 2020 2020 2320  lue = hfw.    # 
+00016680: 2020 2020 7061 7474 6572 6e20 3d20 7365      pattern = se
+00016690: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7061  lf.connection.pa
+000166a0: 7474 6572 6e69 6e67 2e63 7265 6174 655f  tterning.create_
+000166b0: 6c69 6e65 280a 2020 2020 2320 2020 2020  line(.    #     
+000166c0: 2020 2020 2d6c 696e 655f 7061 7474 6572      -line_patter
+000166d0: 6e5f 6c65 6e67 7468 202f 2032 2c20 2023  n_length / 2,  #
+000166e0: 2078 5f73 7461 7274 0a20 2020 2023 2020   x_start.    #  
+000166f0: 2020 2020 2020 202b 6c69 6e65 5f70 6174         +line_pat
+00016700: 7465 726e 5f6c 656e 6774 682c 2020 2320  tern_length,  # 
+00016710: 795f 7374 6172 740a 2020 2020 2320 2020  y_start.    #   
+00016720: 2020 2020 2020 2b6c 696e 655f 7061 7474        +line_patt
+00016730: 6572 6e5f 6c65 6e67 7468 202f 2032 2c20  ern_length / 2, 
+00016740: 2023 2078 5f65 6e64 0a20 2020 2023 2020   # x_end.    #  
+00016750: 2020 2020 2020 202b 6c69 6e65 5f70 6174         +line_pat
+00016760: 7465 726e 5f6c 656e 6774 682c 2020 2320  tern_length,  # 
+00016770: 795f 656e 640a 2020 2020 2320 2020 2020  y_end.    #     
+00016780: 2020 2020 3265 2d36 2c0a 2020 2020 2320      2e-6,.    # 
+00016790: 2020 2020 2920 2023 206d 696c 6c69 6e67      )  # milling
+000167a0: 2064 6570 7468 0a20 2020 2023 2020 2020   depth.    #    
+000167b0: 2070 6174 7465 726e 2e74 696d 6520 3d20   pattern.time = 
+000167c0: 7370 7574 7465 725f 7469 6d65 200a 0a20  sputter_time .. 
+000167d0: 2020 2023 2064 6566 2072 756e 5f47 4953     # def run_GIS
+000167e0: 2873 656c 662c 7072 6f74 6f63 6f6c 293a  (self,protocol):
+000167f0: 0a0a 2020 2020 2320 2020 2020 6769 735f  ..    #     gis_
+00016800: 6c69 6e65 203d 2070 726f 746f 636f 6c5b  line = protocol[
+00016810: 2267 6173 225d 0a20 2020 2023 2020 2020  "gas"].    #    
+00016820: 2073 7075 7474 6572 5f74 696d 6520 3d20   sputter_time = 
+00016830: 7072 6f74 6f63 6f6c 5b22 7370 7574 7465  protocol["sputte
+00016840: 725f 7469 6d65 225d 0a0a 2020 2020 2320  r_time"]..    # 
+00016850: 2020 2020 626c 616e 6b20 3d70 726f 746f      blank =proto
+00016860: 636f 6c5b 2262 6c61 6e6b 5f62 6561 6d22  col["blank_beam"
+00016870: 5d0a 0a20 2020 2023 2020 2020 2070 7269  ]..    #     pri
+00016880: 6e74 2866 2262 6c61 6e6b 2062 6561 6d3a  nt(f"blank beam:
+00016890: 207b 626c 616e 6b7d 2229 200a 0a20 2020   {blank}") ..   
+000168a0: 2023 2020 2020 2069 6620 7072 6f74 6f63   #     if protoc
+000168b0: 6f6c 5b22 626c 616e 6b5f 6265 616d 225d  ol["blank_beam"]
+000168c0: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
+000168d0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+000168e0: 6265 616d 732e 656c 6563 7472 6f6e 5f62  beams.electron_b
+000168f0: 6561 6d2e 626c 616e 6b28 290a 0a0a 2020  eam.blank()...  
+00016900: 2020 2320 2020 2020 6966 2073 656c 662e    #     if self.
+00016910: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
+00016920: 726e 696e 672e 7374 6174 6520 3d3d 2022  rning.state == "
+00016930: 4964 6c65 223a 0a20 2020 2023 2020 2020  Idle":.    #    
+00016940: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00016950: 6f28 6622 5370 7574 7465 7269 6e67 2077  o(f"Sputtering w
+00016960: 6974 6820 7b67 6973 5f6c 696e 657d 2066  ith {gis_line} f
+00016970: 6f72 207b 7370 7574 7465 725f 7469 6d65  or {sputter_time
+00016980: 7d20 7365 636f 6e64 732e 2e2e 2229 0a20  } seconds..."). 
+00016990: 2020 2023 2020 2020 2020 2020 2073 656c     #         sel
+000169a0: 662e 636f 6e6e 6563 7469 6f6e 2e70 6174  f.connection.pat
+000169b0: 7465 726e 696e 672e 7374 6172 7428 2920  terning.start() 
+000169c0: 2023 2061 7379 6e63 6872 6f6e 6f75 7320   # asynchronous 
+000169d0: 7061 7474 6572 6e69 6e67 0a20 2020 2023  patterning.    #
+000169e0: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+000169f0: 6565 7028 7370 7574 7465 725f 7469 6d65  eep(sputter_time
+00016a00: 202b 2035 290a 2020 2020 2320 2020 2020   + 5).    #     
+00016a10: 656c 7365 3a0a 2020 2020 2320 2020 2020  else:.    #     
+00016a20: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00016a30: 6545 7272 6f72 2822 4361 6e27 7420 7370  eError("Can't sp
+00016a40: 7574 7465 722c 2070 6174 7465 726e 696e  utter, patternin
+00016a50: 6720 7374 6174 6520 6973 206e 6f74 2072  g state is not r
+00016a60: 6561 6479 2e22 290a 2020 2020 2320 2020  eady.").    #   
+00016a70: 2020 6966 2073 656c 662e 636f 6e6e 6563    if self.connec
+00016a80: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
+00016a90: 7374 6174 6520 3d3d 2022 5275 6e6e 696e  state == "Runnin
+00016aa0: 6722 3a0a 2020 2020 2320 2020 2020 2020  g":.    #       
+00016ab0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00016ac0: 6e2e 7061 7474 6572 6e69 6e67 2e73 746f  n.patterning.sto
+00016ad0: 7028 290a 2020 2020 2320 2020 2020 2020  p().    #       
+00016ae0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+00016af0: 2246 696e 6973 6865 6420 7370 7574 7465  "Finished sputte
+00016b00: 7269 6e67 2077 6974 6820 7b67 6973 5f6c  ring with {gis_l
+00016b10: 696e 657d 2229 0a20 2020 2023 2020 2020  ine}").    #    
+00016b20: 2065 6c73 653a 0a20 2020 2023 2020 2020   else:.    #    
+00016b30: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
+00016b40: 6e69 6e67 2866 2250 6174 7465 726e 696e  ning(f"Patternin
+00016b50: 6720 7374 6174 6520 6973 207b 7365 6c66  g state is {self
+00016b60: 2e63 6f6e 6e65 6374 696f 6e2e 7061 7474  .connection.patt
+00016b70: 6572 6e69 6e67 2e73 7461 7465 7d22 290a  erning.state}").
+00016b80: 2020 2020 2320 2020 2020 2020 2020 6c6f      #         lo
+00016b90: 6767 696e 672e 7761 726e 696e 6728 2243  gging.warning("C
+00016ba0: 6f6e 7369 6465 7220 6164 6a75 7374 696e  onsider adjustin
+00016bb0: 6720 7468 6520 7061 7474 6572 6e69 6e67  g the patterning
+00016bc0: 206c 696e 6520 6465 7074 682e 2229 0a0a   line depth.")..
+00016bd0: 0a20 2020 2023 2064 6566 2072 756e 5f4d  .    # def run_M
+00016be0: 756c 7469 6368 656d 2873 656c 662c 7072  ultichem(self,pr
+00016bf0: 6f74 6f63 6f6c 293a 0a0a 2020 2020 2320  otocol):..    # 
+00016c00: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
+00016c10: 6572 2873 656c 662e 7379 7374 656d 290a  er(self.system).
+00016c20: 2020 2020 2320 2020 2020 7365 6c66 2e6f      #     self.o
+00016c30: 7269 6769 6e61 6c5f 6163 7469 7665 5f76  riginal_active_v
+00016c40: 6965 7720 3d20 7365 6c66 2e63 6f6e 6e65  iew = self.conne
+00016c50: 6374 696f 6e2e 696d 6167 696e 672e 6765  ction.imaging.ge
+00016c60: 745f 6163 7469 7665 5f76 6965 7728 290a  t_active_view().
+00016c70: 2020 2020 2320 2020 2020 7365 6c66 2e63      #     self.c
+00016c80: 6f6e 6e65 6374 696f 6e2e 696d 6167 696e  onnection.imagin
+00016c90: 672e 7365 745f 6163 7469 7665 5f76 6965  g.set_active_vie
+00016ca0: 7728 4265 616d 5479 7065 2e45 4c45 4354  w(BeamType.ELECT
+00016cb0: 524f 4e2e 7661 6c75 6529 0a20 2020 2023  RON.value).    #
+00016cc0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00016cd0: 7469 6f6e 2e70 6174 7465 726e 696e 672e  tion.patterning.
+00016ce0: 636c 6561 725f 7061 7474 6572 6e73 2829  clear_patterns()
+00016cf0: 0a20 2020 2023 2020 2020 2073 656c 662e  .    #     self.
+00016d00: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
+00016d10: 726e 696e 672e 7365 745f 6465 6661 756c  rning.set_defaul
+00016d20: 745f 6170 706c 6963 6174 696f 6e5f 6669  t_application_fi
+00016d30: 6c65 2870 726f 746f 636f 6c5b 2261 7070  le(protocol["app
+00016d40: 6c69 6361 7469 6f6e 5f66 696c 6522 5d29  lication_file"])
+00016d50: 0a20 2020 2023 2020 2020 2073 656c 662e  .    #     self.
+00016d60: 636f 6e6e 6563 7469 6f6e 2e70 6174 7465  connection.patte
+00016d70: 726e 696e 672e 7365 745f 6465 6661 756c  rning.set_defaul
+00016d80: 745f 6265 616d 5f74 7970 6528 4265 616d  t_beam_type(Beam
+00016d90: 5479 7065 2e45 4c45 4354 524f 4e2e 7661  Type.ELECTRON.va
+00016da0: 6c75 6529 0a0a 2020 2020 2320 2020 2020  lue)..    #     
+00016db0: 6d63 5f6c 696e 6520 3d20 7072 6f74 6f63  mc_line = protoc
+00016dc0: 6f6c 5b22 6761 7322 5d0a 2020 2020 2320  ol["gas"].    # 
+00016dd0: 2020 2020 706f 7274 203d 2073 656c 662e      port = self.
+00016de0: 6d75 6c74 6963 6865 6d0a 2020 2020 2320  multichem.    # 
+00016df0: 2020 2020 6966 2073 656c 662e 6d75 6c74      if self.mult
+00016e00: 6963 6865 6d5f 706f 7369 7469 6f6e 2829  ichem_position()
+00016e10: 203d 3d20 2252 6574 7261 6374 6564 223a   == "Retracted":
+00016e20: 0a20 2020 2023 2020 2020 2020 2020 2070  .    #         p
+00016e30: 6f72 742e 696e 7365 7274 2829 0a0a 2020  ort.insert()..  
+00016e40: 2020 2320 2020 2020 6966 2073 656c 662e    #     if self.
+00016e50: 6d75 6c74 6963 6865 6d5f 7465 6d70 5f72  multichem_temp_r
+00016e60: 6561 6479 286d 635f 6c69 6e65 2920 3d3d  eady(mc_line) ==
+00016e70: 2046 616c 7365 3a0a 2020 2020 2320 2020   False:.    #   
+00016e80: 2020 2020 2020 7365 6c66 2e6d 756c 7469        self.multi
+00016e90: 6368 656d 5f68 6561 745f 7570 286d 635f  chem_heat_up(mc_
+00016ea0: 6c69 6e65 290a 0a20 2020 2023 2020 2020  line)..    #    
+00016eb0: 2068 6677 203d 2070 726f 746f 636f 6c5b   hfw = protocol[
+00016ec0: 2268 6677 225d 0a20 2020 2023 2020 2020  "hfw"].    #    
+00016ed0: 206c 696e 655f 7061 7474 6572 6e5f 6c65   line_pattern_le
+00016ee0: 6e67 7468 203d 2070 726f 746f 636f 6c5b  ngth = protocol[
+00016ef0: 226c 656e 6774 6822 5d0a 2020 2020 2320  "length"].    # 
+00016f00: 2020 2020 7370 7574 7465 725f 7469 6d65      sputter_time
+00016f10: 203d 2070 726f 746f 636f 6c5b 2273 7075   = protocol["spu
+00016f20: 7474 6572 5f74 696d 6522 5d0a 0a20 2020  tter_time"]..   
+00016f30: 2023 2020 2020 2073 656c 662e 636f 6e6e   #     self.conn
+00016f40: 6563 7469 6f6e 2e62 6561 6d73 2e65 6c65  ection.beams.ele
+00016f50: 6374 726f 6e5f 6265 616d 2e68 6f72 697a  ctron_beam.horiz
+00016f60: 6f6e 7461 6c5f 6669 656c 645f 7769 6474  ontal_field_widt
+00016f70: 682e 7661 6c75 6520 3d20 6866 770a 2020  h.value = hfw.  
+00016f80: 2020 2320 2020 2020 7061 7474 6572 6e20    #     pattern 
+00016f90: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+00016fa0: 6e2e 7061 7474 6572 6e69 6e67 2e63 7265  n.patterning.cre
+00016fb0: 6174 655f 6c69 6e65 280a 2020 2020 2320  ate_line(.    # 
+00016fc0: 2020 2020 2020 2020 2d6c 696e 655f 7061          -line_pa
+00016fd0: 7474 6572 6e5f 6c65 6e67 7468 202f 2032  ttern_length / 2
+00016fe0: 2c20 2023 2078 5f73 7461 7274 0a20 2020  ,  # x_start.   
+00016ff0: 2023 2020 2020 2020 2020 202b 6c69 6e65   #         +line
+00017000: 5f70 6174 7465 726e 5f6c 656e 6774 682c  _pattern_length,
+00017010: 2020 2320 795f 7374 6172 740a 2020 2020    # y_start.    
+00017020: 2320 2020 2020 2020 2020 2b6c 696e 655f  #         +line_
+00017030: 7061 7474 6572 6e5f 6c65 6e67 7468 202f  pattern_length /
+00017040: 2032 2c20 2023 2078 5f65 6e64 0a20 2020   2,  # x_end.   
+00017050: 2023 2020 2020 2020 2020 202b 6c69 6e65   #         +line
+00017060: 5f70 6174 7465 726e 5f6c 656e 6774 682c  _pattern_length,
+00017070: 2020 2320 795f 656e 640a 2020 2020 2320    # y_end.    # 
+00017080: 2020 2020 2020 2020 3265 2d36 2c0a 2020          2e-6,.  
+00017090: 2020 2320 2020 2020 2920 2023 206d 696c    #     )  # mil
+000170a0: 6c69 6e67 2064 6570 7468 0a20 2020 2023  ling depth.    #
+000170b0: 2020 2020 2023 2070 6174 7465 726e 2e74       # pattern.t
+000170c0: 696d 6520 3d20 7370 7574 7465 725f 7469  ime = sputter_ti
+000170d0: 6d65 202b 2030 2e31 0a20 2020 2023 2020  me + 0.1.    #  
+000170e0: 2020 2070 6174 7465 726e 2e74 696d 6520     pattern.time 
+000170f0: 3d20 7370 7574 7465 725f 7469 6d65 0a0a  = sputter_time..
+00017100: 2020 2020 2320 2020 2020 7365 6c66 2e63      #     self.c
+00017110: 6f6e 6e65 6374 696f 6e2e 6265 616d 732e  onnection.beams.
+00017120: 656c 6563 7472 6f6e 5f62 6561 6d2e 626c  electron_beam.bl
+00017130: 616e 6b28 290a 2020 2020 2320 2020 2020  ank().    #     
+00017140: 2320 706f 7274 2e6c 696e 652e 6f70 656e  # port.line.open
+00017150: 2829 0a20 2020 2023 2020 2020 2069 6620  ().    #     if 
+00017160: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00017170: 7061 7474 6572 6e69 6e67 2e73 7461 7465  patterning.state
+00017180: 203d 3d20 2249 646c 6522 3a0a 2020 2020   == "Idle":.    
+00017190: 2320 2020 2020 2020 2020 6c6f 6767 696e  #         loggin
+000171a0: 672e 696e 666f 2866 2253 7075 7474 6572  g.info(f"Sputter
+000171b0: 696e 6720 7769 7468 207b 6d63 5f6c 696e  ing with {mc_lin
+000171c0: 657d 2066 6f72 207b 7370 7574 7465 725f  e} for {sputter_
+000171d0: 7469 6d65 7d20 7365 636f 6e64 732e 2e2e  time} seconds...
+000171e0: 2229 0a20 2020 2023 2020 2020 2020 2020  ").    #        
+000171f0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+00017200: 2e70 6174 7465 726e 696e 672e 7374 6172  .patterning.star
+00017210: 7428 2920 2023 2061 7379 6e63 6872 6f6e  t()  # asynchron
+00017220: 6f75 7320 7061 7474 6572 6e69 6e67 0a20  ous patterning. 
+00017230: 2020 2023 2020 2020 2020 2020 2074 696d     #         tim
+00017240: 652e 736c 6565 7028 7370 7574 7465 725f  e.sleep(sputter_
+00017250: 7469 6d65 202b 2035 290a 2020 2020 2320  time + 5).    # 
+00017260: 2020 2020 656c 7365 3a0a 2020 2020 2320      else:.    # 
+00017270: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+00017280: 6e74 696d 6545 7272 6f72 2822 4361 6e27  ntimeError("Can'
+00017290: 7420 7370 7574 7465 7220 706c 6174 696e  t sputter platin
+000172a0: 756d 2c20 7061 7474 6572 6e69 6e67 2073  um, patterning s
+000172b0: 7461 7465 2069 7320 6e6f 7420 7265 6164  tate is not read
+000172c0: 792e 2229 0a20 2020 2023 2020 2020 2069  y.").    #     i
+000172d0: 6620 7365 6c66 2e63 6f6e 6e65 6374 696f  f self.connectio
+000172e0: 6e2e 7061 7474 6572 6e69 6e67 2e73 7461  n.patterning.sta
+000172f0: 7465 203d 3d20 2252 756e 6e69 6e67 223a  te == "Running":
+00017300: 0a20 2020 2023 2020 2020 2020 2020 2073  .    #         s
+00017310: 656c 662e 636f 6e6e 6563 7469 6f6e 2e70  elf.connection.p
+00017320: 6174 7465 726e 696e 672e 7374 6f70 2829  atterning.stop()
+00017330: 0a20 2020 2023 2020 2020 2065 6c73 653a  .    #     else:
+00017340: 0a20 2020 2023 2020 2020 2020 2020 206c  .    #         l
+00017350: 6f67 6769 6e67 2e77 6172 6e69 6e67 2866  ogging.warning(f
+00017360: 2250 6174 7465 726e 696e 6720 7374 6174  "Patterning stat
+00017370: 6520 6973 207b 7365 6c66 2e63 6f6e 6e65  e is {self.conne
+00017380: 6374 696f 6e2e 7061 7474 6572 6e69 6e67  ction.patterning
+00017390: 2e73 7461 7465 7d22 290a 2020 2020 2320  .state}").    # 
+000173a0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000173b0: 7761 726e 696e 6728 2243 6f6e 7369 6465  warning("Conside
+000173c0: 7220 6164 6a75 7374 696e 6720 7468 6520  r adjusting the 
+000173d0: 7061 7474 6572 6e69 6e67 206c 696e 6520  patterning line 
+000173e0: 6465 7074 682e 2229 0a20 2020 2023 2020  depth.").    #  
+000173f0: 2020 2023 2070 6f72 742e 6c69 6e65 2e63     # port.line.c
+00017400: 6c6f 7365 2829 0a0a 2020 2020 2320 2020  lose()..    #   
+00017410: 2020 7365 6c66 2e6d 756c 7469 6368 656d    self.multichem
+00017420: 2e6c 696e 652e 7475 726e 5f68 6561 7465  .line.turn_heate
+00017430: 725f 6f66 6628 6d63 5f6c 696e 6529 0a0a  r_off(mc_line)..
+00017440: 0a0a 0a0a 2020 2020 2320 6465 6620 4749  ....    # def GI
+00017450: 535f 6176 6169 6c61 626c 655f 6c69 6e65  S_available_line
+00017460: 7328 7365 6c66 2920 2d3e 206c 6973 745b  s(self) -> list[
+00017470: 7374 725d 3a0a 2020 2020 2320 2020 2020  str]:.    #     
+00017480: 2222 220a 2020 2020 2320 2020 2020 5265  """.    #     Re
+00017490: 7475 726e 7320 6120 6c69 7374 206f 6620  turns a list of 
+000174a0: 6176 6169 6c61 626c 6520 4749 5320 6c69  available GIS li
+000174b0: 6e65 732e 0a20 2020 2023 2020 2020 2041  nes..    #     A
+000174c0: 7267 733a 0a20 2020 2023 2020 2020 2020  rgs:.    #      
+000174d0: 2020 204e 6f6e 650a 2020 2020 2320 2020     None.    #   
+000174e0: 2020 5265 7475 726e 733a 0a20 2020 2023    Returns:.    #
+000174f0: 2020 2020 2020 2020 2044 6963 7469 6f6e           Diction
+00017500: 6172 7920 6f66 2061 7661 696c 6162 6c65  ary of available
+00017510: 2047 4953 206c 696e 6573 2e0a 2020 2020   GIS lines..    
+00017520: 2320 2020 2020 4e6f 7465 733a 0a20 2020  #     Notes:.   
+00017530: 2023 2020 2020 2020 2020 204e 6f6e 650a   #         None.
+00017540: 2020 2020 2320 2020 2020 2222 220a 2020      #     """.  
+00017550: 2020 2320 2020 2020 5f63 6865 636b 5f73    #     _check_s
+00017560: 7075 7474 6572 2873 656c 662e 7379 7374  putter(self.syst
+00017570: 656d 290a 0a20 2020 2023 2020 2020 2067  em)..    #     g
+00017580: 6973 5f6c 6973 7420 3d20 7365 6c66 2e63  is_list = self.c
+00017590: 6f6e 6e65 6374 696f 6e2e 6761 732e 6c69  onnection.gas.li
+000175a0: 7374 5f61 6c6c 5f67 6973 5f70 6f72 7473  st_all_gis_ports
+000175b0: 2829 0a0a 2020 2020 2320 2020 2020 7365  ()..    #     se
+000175c0: 6c66 2e67 6973 5f6c 696e 6573 203d 207b  lf.gis_lines = {
+000175d0: 7d0a 0a0a 2020 2020 2320 2020 2020 666f  }...    #     fo
+000175e0: 7220 6c69 6e65 2069 6e20 6769 735f 6c69  r line in gis_li
+000175f0: 7374 3a0a 0a20 2020 2023 2020 2020 2020  st:..    #      
+00017600: 2020 2067 6973 5f70 6f72 7420 3d20 5468     gis_port = Th
+00017610: 6572 6d6f 4749 534c 696e 6528 7365 6c66  ermoGISLine(self
+00017620: 2e63 6f6e 6e65 6374 696f 6e2e 6761 732e  .connection.gas.
+00017630: 6765 745f 6769 735f 706f 7274 286c 696e  get_gis_port(lin
+00017640: 6529 2c6e 616d 653d 6c69 6e65 2c73 7461  e),name=line,sta
+00017650: 7475 733d 2252 6574 7261 6374 6564 2229  tus="Retracted")
+00017660: 0a0a 2020 2020 2320 2020 2020 2020 2020  ..    #         
+00017670: 7365 6c66 2e67 6973 5f6c 696e 6573 5b6c  self.gis_lines[l
+00017680: 696e 655d 203d 2067 6973 5f70 6f72 740a  ine] = gis_port.
+00017690: 0a0a 0a20 2020 2023 2020 2020 2072 6574  ...    #     ret
+000176a0: 7572 6e20 6769 735f 6c69 7374 0a0a 2020  urn gis_list..  
+000176b0: 2020 2320 6465 6620 4749 535f 6176 6169    # def GIS_avai
+000176c0: 6c61 626c 655f 706f 7369 7469 6f6e 7328  lable_positions(
+000176d0: 7365 6c66 2920 2d3e 206c 6973 745b 7374  self) -> list[st
+000176e0: 725d 3a0a 2020 2020 2320 2020 2020 2222  r]:.    #     ""
+000176f0: 2252 6574 7572 6e73 2061 206c 6973 7420  "Returns a list 
+00017700: 6f66 2061 7661 696c 6162 6c65 2070 6f73  of available pos
+00017710: 6974 696f 6e73 2074 6865 2047 4953 2063  itions the GIS c
+00017720: 616e 206d 6f76 6520 746f 2e0a 2020 2020  an move to..    
+00017730: 2320 2020 2020 5265 7475 726e 733a 0a20  #     Returns:. 
+00017740: 2020 2023 2020 2020 2020 2020 206c 6973     #         lis
+00017750: 745b 7374 725d 3a20 706f 7369 7469 6f6e  t[str]: position
+00017760: 730a 2020 2020 2320 2020 2020 2222 220a  s.    #     """.
+00017770: 0a20 2020 2023 2020 2020 205f 6368 6563  .    #     _chec
+00017780: 6b5f 7370 7574 7465 7228 7365 6c66 2e73  k_sputter(self.s
+00017790: 7973 7465 6d29 0a0a 2020 2020 2320 2020  ystem)..    #   
+000177a0: 2020 706f 7369 7469 6f6e 7320 3d20 5b22    positions = ["
+000177b0: 496e 7365 7274 222c 2022 5265 7472 6163  Insert", "Retrac
+000177c0: 7422 5d0a 0a20 2020 2023 2020 2020 2072  t"]..    #     r
+000177d0: 6574 7572 6e20 706f 7369 7469 6f6e 730a  eturn positions.
+000177e0: 0a20 2020 2023 2064 6566 2047 4953 5f6d  .    # def GIS_m
+000177f0: 6f76 655f 746f 2873 656c 662c 6c69 6e65  ove_to(self,line
+00017800: 5f6e 616d 653a 7374 722c 706f 7369 7469  _name:str,positi
+00017810: 6f6e 3a73 7472 2920 2d3e 204e 6f6e 653a  on:str) -> None:
+00017820: 0a0a 2020 2020 2320 2020 2020 2222 224d  ..    #     """M
+00017830: 6f76 6573 2074 6865 2047 4953 2074 6f20  oves the GIS to 
+00017840: 6120 7370 6563 6966 6965 6420 706f 7369  a specified posi
+00017850: 7469 6f6e 2e0a 2020 2020 2320 2020 2020  tion..    #     
+00017860: 4e65 6564 2074 6f20 7370 6563 6966 7920  Need to specify 
+00017870: 7468 6520 6c69 6e65 206e 616d 6520 616e  the line name an
+00017880: 6420 706f 7369 7469 6f6e 2074 6f20 6d6f  d position to mo
+00017890: 7665 2074 6f2e 2045 6163 6820 4749 5320  ve to. Each GIS 
+000178a0: 6c69 6e65 2069 7320 6120 7365 7065 7261  line is a sepera
+000178b0: 7465 2070 7974 686f 6e20 6f62 6a65 6374  te python object
+000178c0: 0a20 2020 2023 2020 2020 2022 2222 0a0a  .    #     """..
+000178d0: 2020 2020 2320 2020 2020 5f63 6865 636b      #     _check
+000178e0: 5f73 7075 7474 6572 2873 656c 662e 7379  _sputter(self.sy
+000178f0: 7374 656d 290a 0a20 2020 2023 2020 2020  stem)..    #    
+00017900: 2070 6f72 7420 3d20 7365 6c66 2e67 6973   port = self.gis
+00017910: 5f6c 696e 6573 5b6c 696e 655f 6e61 6d65  _lines[line_name
+00017920: 5d0a 0a20 2020 2023 2020 2020 2069 6620  ]..    #     if 
+00017930: 706f 7369 7469 6f6e 203d 3d20 2249 6e73  position == "Ins
+00017940: 6572 7422 3a0a 2020 2020 2320 2020 2020  ert":.    #     
+00017950: 2020 2020 706f 7274 2e69 6e73 6572 7428      port.insert(
+00017960: 290a 2020 2020 2320 2020 2020 656c 6966  ).    #     elif
+00017970: 2070 6f73 6974 696f 6e20 3d3d 2022 5265   position == "Re
+00017980: 7472 6163 7422 3a0a 2020 2020 2320 2020  tract":.    #   
+00017990: 2020 2020 2020 706f 7274 2e72 6574 7261        port.retra
+000179a0: 6374 2829 0a0a 2020 2020 2320 6465 6620  ct()..    # def 
+000179b0: 4749 535f 706f 7369 7469 6f6e 2873 656c  GIS_position(sel
+000179c0: 662c 6c69 6e65 2920 2d3e 2073 7472 3a0a  f,line) -> str:.
+000179d0: 2020 2020 2320 2020 2020 2222 220a 2020      #     """.  
+000179e0: 2020 2320 2020 2020 5265 7475 726e 7320    #     Returns 
+000179f0: 7468 6520 6375 7272 656e 7420 706f 7369  the current posi
+00017a00: 7469 6f6e 206f 6620 7468 6520 4749 5320  tion of the GIS 
+00017a10: 6c69 6e65 2e0a 2020 2020 2320 2020 2020  line..    #     
+00017a20: 2222 220a 0a20 2020 2023 2020 2020 205f  """..    #     _
+00017a30: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
+00017a40: 6c66 2e73 7973 7465 6d29 0a0a 2020 2020  lf.system)..    
+00017a50: 2320 2020 2020 706f 7274 203d 2073 656c  #     port = sel
+00017a60: 662e 6769 735f 6c69 6e65 735b 6c69 6e65  f.gis_lines[line
+00017a70: 5d0a 0a20 2020 2023 2020 2020 2072 6574  ]..    #     ret
+00017a80: 7572 6e20 706f 7274 2e73 7461 7475 730a  urn port.status.
+00017a90: 0a20 2020 2023 2064 6566 2047 4953 5f68  .    # def GIS_h
+00017aa0: 6561 745f 7570 2873 656c 662c 6c69 6e65  eat_up(self,line
+00017ab0: 293a 0a0a 2020 2020 2320 2020 2020 2222  ):..    #     ""
+00017ac0: 2248 6561 7473 2075 7020 7468 6520 7370  "Heats up the sp
+00017ad0: 6563 6966 6965 6420 4749 5320 6c69 6e65  ecified GIS line
+00017ae0: 0a20 2020 2023 2020 2020 2044 6f65 7320  .    #     Does 
+00017af0: 7468 6973 2062 7920 7475 726e 696e 6720  this by turning 
+00017b00: 7468 6520 6865 6174 6572 206f 6e20 666f  the heater on fo
+00017b10: 7220 3320 7365 636f 6e64 7320 616e 6420  r 3 seconds and 
+00017b20: 7468 656e 206f 6666 2e0a 2020 2020 2320  then off..    # 
+00017b30: 2020 2020 4966 2074 6869 7320 7072 6f63      If this proc
+00017b40: 6564 7572 6520 6861 7320 6265 656e 2064  edure has been d
+00017b50: 6f6e 6520 6f6e 6365 2c20 6974 2069 7320  one once, it is 
+00017b60: 636f 6e73 6964 6572 6564 2074 656d 705f  considered temp_
+00017b70: 7265 6164 790a 2020 2020 2320 2020 2020  ready.    #     
+00017b80: 2222 220a 0a20 2020 2023 2020 2020 205f  """..    #     _
+00017b90: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
+00017ba0: 6c66 2e73 7973 7465 6d29 0a0a 2020 2020  lf.system)..    
+00017bb0: 2320 2020 2020 706f 7274 203d 2073 656c  #     port = sel
+00017bc0: 662e 6769 735f 6c69 6e65 735b 6c69 6e65  f.gis_lines[line
+00017bd0: 5d0a 0a20 2020 2023 2020 2020 2070 6f72  ]..    #     por
+00017be0: 742e 6c69 6e65 2e74 7572 6e5f 6865 6174  t.line.turn_heat
+00017bf0: 6572 5f6f 6e28 290a 0a20 2020 2023 2020  er_on()..    #  
+00017c00: 2020 2074 696d 652e 736c 6565 7028 3329     time.sleep(3)
+00017c10: 0a0a 2020 2020 2320 2020 2020 706f 7274  ..    #     port
+00017c20: 2e6c 696e 652e 7475 726e 5f68 6561 7465  .line.turn_heate
+00017c30: 725f 6f66 6628 290a 0a20 2020 2023 2020  r_off()..    #  
+00017c40: 2020 2070 6f72 742e 7465 6d70 5f72 6561     port.temp_rea
+00017c50: 6479 203d 2054 7275 650a 0a20 2020 2023  dy = True..    #
+00017c60: 2064 6566 2047 4953 5f74 656d 705f 7265   def GIS_temp_re
+00017c70: 6164 7928 7365 6c66 2c6c 696e 6529 202d  ady(self,line) -
+00017c80: 3e20 626f 6f6c 3a0a 0a20 2020 2023 2020  > bool:..    #  
+00017c90: 2020 2022 2222 5265 7475 726e 7320 6966     """Returns if
+00017ca0: 2074 6865 2068 6561 7420 7570 2070 726f   the heat up pro
+00017cb0: 6365 6475 7265 2068 6173 2062 6565 6e20  cedure has been 
+00017cc0: 646f 6e65 2e20 496e 7465 726e 616c 2066  done. Internal f
+00017cd0: 756e 6374 696f 6e2c 206e 6f74 2070 6f6c  unction, not pol
+00017ce0: 6c65 6420 696e 666f 726d 6174 696f 6e0a  led information.
+00017cf0: 2020 2020 2320 2020 2020 2020 2020 6672      #         fr
+00017d00: 6f6d 2074 6865 2068 6172 6477 6172 650a  om the hardware.
+00017d10: 2020 2020 2320 2020 2020 5265 7475 726e      #     Return
+00017d20: 733a 0a20 2020 2023 2020 2020 2020 2020  s:.    #        
+00017d30: 2054 7275 6520 6966 2074 6865 2068 6561   True if the hea
+00017d40: 7420 7570 2070 726f 6365 6475 7265 2068  t up procedure h
+00017d50: 6173 2062 6565 6e20 646f 6e65 2c20 4661  as been done, Fa
+00017d60: 6c73 6520 6966 206e 6f74 0a20 2020 2023  lse if not.    #
+00017d70: 2020 2020 2022 2222 0a0a 2020 2020 2320       """..    # 
+00017d80: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
+00017d90: 6572 2873 656c 662e 7379 7374 656d 290a  er(self.system).
+00017da0: 0a20 2020 2023 2020 2020 2070 6f72 7420  .    #     port 
+00017db0: 3d20 7365 6c66 2e67 6973 5f6c 696e 6573  = self.gis_lines
+00017dc0: 5b6c 696e 655d 0a0a 2020 2020 2320 2020  [line]..    #   
+00017dd0: 2020 7265 7475 726e 2070 6f72 742e 7465    return port.te
+00017de0: 6d70 5f72 6561 6479 0a0a 0a20 2020 2023  mp_ready...    #
+00017df0: 2064 6566 206d 756c 7469 6368 656d 5f61   def multichem_a
+00017e00: 7661 696c 6162 6c65 5f6c 696e 6573 2873  vailable_lines(s
+00017e10: 656c 6629 2d3e 206c 6973 745b 7374 725d  elf)-> list[str]
+00017e20: 3a0a 0a20 2020 2023 2020 2020 2022 2222  :..    #     """
+00017e30: 0a20 2020 2023 2020 2020 2052 6574 7572  .    #     Retur
+00017e40: 6e73 2061 206c 6973 7420 6f66 2061 7661  ns a list of ava
+00017e50: 696c 6162 6c65 206d 756c 7469 6368 656d  ilable multichem
+00017e60: 206c 696e 6573 2e0a 2020 2020 2320 2020   lines..    #   
+00017e70: 2020 4c69 7374 2069 7320 6120 7374 7220    List is a str 
+00017e80: 6f66 206e 616d 6573 206f 6620 7468 6520  of names of the 
+00017e90: 6c69 6e65 7322 2222 0a0a 2020 2020 2320  lines"""..    # 
+00017ea0: 2020 2020 5f63 6865 636b 5f73 7075 7474      _check_sputt
+00017eb0: 6572 2873 656c 662e 7379 7374 656d 290a  er(self.system).
+00017ec0: 0a20 2020 2023 2020 2020 2073 656c 662e  .    #     self.
+00017ed0: 6d75 6c74 6963 6865 6d20 3d20 5468 6572  multichem = Ther
+00017ee0: 6d6f 4d75 6c74 6943 6865 6d4c 696e 6528  moMultiChemLine(
+00017ef0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00017f00: 6761 732e 6765 745f 6d75 6c74 6963 6865  gas.get_multiche
+00017f10: 6d28 2929 0a0a 2020 2020 2320 2020 2020  m())..    #     
+00017f20: 7365 6c66 2e6d 635f 6c69 6e65 7320 3d20  self.mc_lines = 
+00017f30: 7365 6c66 2e6d 756c 7469 6368 656d 2e6c  self.multichem.l
+00017f40: 696e 652e 6c69 7374 5f61 6c6c 5f67 6173  ine.list_all_gas
+00017f50: 6573 2829 0a0a 2020 2020 2320 2020 2020  es()..    #     
+00017f60: 7365 6c66 2e6d 635f 6c69 6e65 735f 7465  self.mc_lines_te
+00017f70: 6d70 203d 7b7d 0a0a 2020 2020 2320 2020  mp ={}..    #   
+00017f80: 2020 666f 7220 6c69 6e65 2069 6e20 7365    for line in se
+00017f90: 6c66 2e6d 635f 6c69 6e65 733a 0a0a 2020  lf.mc_lines:..  
+00017fa0: 2020 2320 2020 2020 2020 2020 7365 6c66    #         self
+00017fb0: 2e6d 635f 6c69 6e65 735f 7465 6d70 5b6c  .mc_lines_temp[l
+00017fc0: 696e 655d 203d 2046 616c 7365 0a0a 2020  ine] = False..  
+00017fd0: 2020 2320 2020 2020 7265 7475 726e 2073    #     return s
+00017fe0: 656c 662e 6d63 5f6c 696e 6573 0a0a 2020  elf.mc_lines..  
+00017ff0: 2020 2320 6465 6620 6d75 6c74 6963 6865    # def multiche
+00018000: 6d5f 6176 6169 6c61 626c 655f 706f 7369  m_available_posi
+00018010: 7469 6f6e 7328 7365 6c66 2920 2d3e 206c  tions(self) -> l
+00018020: 6973 745b 7374 725d 3a0a 0a20 2020 2023  ist[str]:..    #
+00018030: 2020 2020 2022 2222 4176 6169 6c61 626c       """Availabl
+00018040: 6520 706f 7369 7469 6f6e 7320 7468 6520  e positions the 
+00018050: 6d75 6c74 6963 6865 6d20 6f62 6a65 6374  multichem object
+00018060: 2063 616e 206d 6f76 6520 746f 0a20 2020   can move to.   
+00018070: 2023 2020 2020 2052 6574 7572 6e73 3a0a   #     Returns:.
+00018080: 2020 2020 2320 2020 2020 2020 2020 5f74      #         _t
+00018090: 7970 655f 3a20 6c69 7374 206f 6620 7374  ype_: list of st
+000180a0: 7220 6f66 2070 6f73 6974 696f 6e20 6e61  r of position na
+000180b0: 6d65 730a 2020 2020 2320 2020 2020 2222  mes.    #     ""
+000180c0: 220a 0a20 2020 2023 2020 2020 205f 6368  "..    #     _ch
+000180d0: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+000180e0: 2e73 7973 7465 6d29 0a0a 2020 2020 2320  .system)..    # 
+000180f0: 2020 2020 706f 7369 7469 6f6e 735f 656e      positions_en
+00018100: 756d 203d 2073 656c 662e 6d75 6c74 6963  um = self.multic
+00018110: 6865 6d2e 706f 7369 7469 6f6e 730a 0a20  hem.positions.. 
+00018120: 2020 2023 2020 2020 2072 6574 7572 6e20     #     return 
+00018130: 706f 7369 7469 6f6e 735f 656e 756d 0a0a  positions_enum..
+00018140: 2020 2020 2320 6465 6620 6d75 6c74 6963      # def multic
+00018150: 6865 6d5f 6d6f 7665 5f74 6f28 7365 6c66  hem_move_to(self
+00018160: 2c70 6f73 6974 696f 6e3a 7374 7229 3a0a  ,position:str):.
+00018170: 0a20 2020 2023 2020 2020 2022 2222 0a20  .    #     """. 
+00018180: 2020 2023 2020 2020 204d 6f76 6573 2074     #     Moves t
+00018190: 6865 206d 756c 7469 6368 656d 206f 626a  he multichem obj
+000181a0: 6563 7420 746f 2061 2073 7065 6369 6669  ect to a specifi
+000181b0: 6564 2070 6f73 6974 696f 6e2e 0a20 2020  ed position..   
+000181c0: 2023 2020 2020 2022 2222 0a0a 2020 2020   #     """..    
+000181d0: 2320 2020 2020 6c6f 6767 696e 672e 696e  #     logging.in
+000181e0: 666f 2866 224d 6f76 696e 6720 6d75 6c74  fo(f"Moving mult
+000181f0: 6963 6865 6d20 746f 2070 6f73 6974 696f  ichem to positio
+00018200: 6e3a 207b 706f 7369 7469 6f6e 7d22 2029  n: {position}" )
+00018210: 0a0a 2020 2020 2320 2020 2020 5f63 6865  ..    #     _che
+00018220: 636b 5f73 7075 7474 6572 2873 656c 662e  ck_sputter(self.
+00018230: 7379 7374 656d 290a 0a20 2020 2023 2020  system)..    #  
+00018240: 2020 2069 6620 706f 7369 7469 6f6e 203d     if position =
+00018250: 3d20 2252 6574 7261 6374 223a 0a20 2020  = "Retract":.   
+00018260: 2023 2020 2020 2020 2020 2073 656c 662e   #         self.
+00018270: 6d75 6c74 6963 6865 6d2e 7265 7472 6163  multichem.retrac
+00018280: 7428 290a 2020 2020 2320 2020 2020 656c  t().    #     el
+00018290: 7365 3a0a 2020 2020 2320 2020 2020 2020  se:.    #       
+000182a0: 2020 7365 6c66 2e6d 756c 7469 6368 656d    self.multichem
+000182b0: 2e69 6e73 6572 7428 706f 7369 7469 6f6e  .insert(position
+000182c0: 3d70 6f73 6974 696f 6e29 0a0a 2020 2020  =position)..    
+000182d0: 2020 2020 0a0a 0a20 2020 2023 2064 6566      ...    # def
+000182e0: 206d 756c 7469 6368 656d 5f70 6f73 6974   multichem_posit
+000182f0: 696f 6e28 7365 6c66 2920 2d3e 2073 7472  ion(self) -> str
+00018300: 3a0a 0a20 2020 2023 2020 2020 2022 2222  :..    #     """
+00018310: 4375 7272 656e 7420 706f 7369 7469 6f6e  Current position
+00018320: 206f 6620 7468 6520 6d75 6c74 6963 6865   of the multiche
+00018330: 6d20 6f62 6a65 6374 0a20 2020 2023 2020  m object.    #  
+00018340: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00018350: 2320 2020 2020 2020 2020 5f74 7970 655f  #         _type_
+00018360: 3a20 7374 7220 6e61 6d65 206f 6620 7468  : str name of th
+00018370: 6520 6375 7272 656e 7420 706f 7369 7469  e current positi
+00018380: 6f6e 0a20 2020 2023 2020 2020 2022 2222  on.    #     """
+00018390: 0a0a 2020 2020 2320 2020 2020 5f63 6865  ..    #     _che
+000183a0: 636b 5f73 7075 7474 6572 2873 656c 662e  ck_sputter(self.
+000183b0: 7379 7374 656d 290a 0a20 2020 2023 2020  system)..    #  
+000183c0: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
+000183d0: 756c 7469 6368 656d 2e63 7572 7265 6e74  ultichem.current
+000183e0: 5f70 6f73 6974 696f 6e0a 0a20 2020 2023  _position..    #
+000183f0: 2064 6566 206d 756c 7469 6368 656d 5f68   def multichem_h
+00018400: 6561 745f 7570 2873 656c 662c 6c69 6e65  eat_up(self,line
+00018410: 3a73 7472 293a 0a0a 2020 2020 2320 2020  :str):..    #   
+00018420: 2020 2222 2248 6561 7420 7570 2070 726f    """Heat up pro
+00018430: 6365 6475 7265 206f 6620 7468 6520 6d75  cedure of the mu
+00018440: 6c74 6963 6865 6d20 6f62 6a65 6374 2c20  ltichem object, 
+00018450: 6966 2074 6869 7320 7072 6f63 6564 7572  if this procedur
+00018460: 6520 6861 7320 6265 656e 2064 6f6e 6520  e has been done 
+00018470: 6f6e 6365 2c0a 2020 2020 2320 2020 2020  once,.    #     
+00018480: 6974 2069 7320 636f 6e73 6964 6572 6564  it is considered
+00018490: 2074 656d 705f 7265 6164 792e 2050 726f   temp_ready. Pro
+000184a0: 6365 6475 7265 2069 7320 7475 726e 696e  cedure is turnin
+000184b0: 6720 7468 6520 6865 6174 6572 206f 6e20  g the heater on 
+000184c0: 666f 7220 3320 7365 636f 6e64 7320 616e  for 3 seconds an
+000184d0: 6420 7468 656e 206f 6666 0a20 2020 2023  d then off.    #
+000184e0: 2020 2020 204d 7573 7420 7370 6563 6966       Must specif
+000184f0: 7920 7468 6520 6c69 6e65 2074 6f20 6865  y the line to he
+00018500: 6174 2075 700a 2020 2020 2320 2020 2020  at up.    #     
+00018510: 2222 220a 0a20 2020 2023 2020 2020 205f  """..    #     _
+00018520: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
+00018530: 6c66 2e73 7973 7465 6d29 0a0a 2020 2020  lf.system)..    
+00018540: 2320 2020 2020 6173 7365 7274 206c 696e  #     assert lin
+00018550: 6520 696e 2073 656c 662e 6d63 5f6c 696e  e in self.mc_lin
+00018560: 6573 2c20 224c 696e 6520 6e6f 7420 6176  es, "Line not av
+00018570: 6169 6c61 626c 6522 0a0a 2020 2020 2320  ailable"..    # 
+00018580: 2020 2020 7365 6c66 2e6d 756c 7469 6368      self.multich
+00018590: 656d 2e6c 696e 652e 7475 726e 5f68 6561  em.line.turn_hea
+000185a0: 7465 725f 6f6e 286c 696e 6529 0a0a 2020  ter_on(line)..  
+000185b0: 2020 2320 2020 2020 7469 6d65 2e73 6c65    #     time.sle
+000185c0: 6570 2833 290a 0a20 2020 2023 2020 2020  ep(3)..    #    
+000185d0: 2023 2073 656c 662e 6d75 6c74 6963 6865   # self.multiche
+000185e0: 6d2e 6c69 6e65 2e74 7572 6e5f 6865 6174  m.line.turn_heat
+000185f0: 6572 5f6f 6666 286c 696e 6529 0a0a 2020  er_off(line)..  
+00018600: 2020 2320 2020 2020 7365 6c66 2e6d 635f    #     self.mc_
+00018610: 6c69 6e65 735f 7465 6d70 5b6c 696e 655d  lines_temp[line]
+00018620: 203d 2054 7275 650a 0a20 2020 2023 2064   = True..    # d
+00018630: 6566 206d 756c 7469 6368 656d 5f74 656d  ef multichem_tem
+00018640: 705f 7265 6164 7928 7365 6c66 2c6c 696e  p_ready(self,lin
+00018650: 653a 7374 7229 202d 3e20 626f 6f6c 3a0a  e:str) -> bool:.
+00018660: 0a20 2020 2023 2020 2020 2022 2222 4368  .    #     """Ch
+00018670: 6563 6b73 2069 6620 7468 6520 6865 6174  ecks if the heat
+00018680: 2075 7020 7072 6f63 6564 7572 6520 666f   up procedure fo
+00018690: 7220 6120 6c69 6e65 2069 6e20 7468 6520  r a line in the 
+000186a0: 6d75 6c74 6963 6865 6d20 6f62 6a65 6374  multichem object
+000186b0: 2068 6173 2062 6565 6e20 646f 6e65 2c0a   has been done,.
+000186c0: 2020 2020 2020 2020 0a20 2020 2023 2020          .    #  
+000186d0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+000186e0: 2320 2020 2020 2020 2020 5f74 7970 655f  #         _type_
+000186f0: 3a20 5265 7475 726e 7320 7472 7565 2069  : Returns true i
+00018700: 6620 646f 6e65 2c20 6661 6c73 6520 6966  f done, false if
+00018710: 206e 6f74 0a20 2020 2023 2020 2020 2022   not.    #     "
+00018720: 2222 0a0a 2020 2020 2320 2020 2020 5f63  ""..    #     _c
+00018730: 6865 636b 5f73 7075 7474 6572 2873 656c  heck_sputter(sel
+00018740: 662e 7379 7374 656d 290a 0a20 2020 2023  f.system)..    #
+00018750: 2020 2020 2061 7373 6572 7420 6c69 6e65       assert line
+00018760: 2069 6e20 7365 6c66 2e6d 635f 6c69 6e65   in self.mc_line
+00018770: 732c 2022 4c69 6e65 206e 6f74 2061 7661  s, "Line not ava
+00018780: 696c 6162 6c65 220a 0a20 2020 2023 2020  ilable"..    #  
+00018790: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
+000187a0: 635f 6c69 6e65 735f 7465 6d70 5b6c 696e  c_lines_temp[lin
+000187b0: 655d 0a20 2020 200a 2020 2020 6465 6620  e].    .    def 
+000187c0: 6765 745f 6176 6169 6c61 626c 655f 7661  get_available_va
+000187d0: 6c75 6573 2873 656c 662c 206b 6579 3a20  lues(self, key: 
+000187e0: 7374 722c 2062 6561 6d5f 7479 7065 3a20  str, beam_type: 
+000187f0: 4265 616d 5479 7065 203d 204e 6f6e 6529  BeamType = None)
+00018800: 2d3e 206c 6973 743a 0a20 2020 2020 2020  -> list:.       
+00018810: 2022 2222 4765 7420 6120 6c69 7374 206f   """Get a list o
+00018820: 6620 6176 6169 6c61 626c 6520 7661 6c75  f available valu
+00018830: 6573 2066 6f72 2061 2067 6976 656e 206b  es for a given k
+00018840: 6579 2e0a 2020 2020 2020 2020 4b65 7973  ey..        Keys
+00018850: 3a20 6170 706c 6963 6174 696f 6e5f 6669  : application_fi
+00018860: 6c65 2c20 706c 6173 6d61 5f67 6173 2c20  le, plasma_gas, 
+00018870: 6375 7272 656e 742c 2064 6574 6563 746f  current, detecto
+00018880: 725f 7479 7065 2c20 6465 7465 6374 6f72  r_type, detector
+00018890: 5f6d 6f64 650a 2020 2020 2020 2020 2222  _mode.        ""
+000188a0: 220a 0a20 2020 2020 2020 2076 616c 7565  "..        value
+000188b0: 7320 3d20 5b5d 0a20 2020 2020 2020 2069  s = [].        i
+000188c0: 6620 6b65 7920 3d3d 2022 6170 706c 6963  f key == "applic
+000188d0: 6174 696f 6e5f 6669 6c65 223a 0a20 2020  ation_file":.   
+000188e0: 2020 2020 2020 2020 2076 616c 7565 7320           values 
+000188f0: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+00018900: 6e2e 7061 7474 6572 6e69 6e67 2e6c 6973  n.patterning.lis
+00018910: 745f 616c 6c5f 6170 706c 6963 6174 696f  t_all_applicatio
+00018920: 6e5f 6669 6c65 7328 290a 0a20 2020 2020  n_files()..     
+00018930: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
+00018940: 6973 2042 6561 6d54 7970 652e 494f 4e20  is BeamType.ION 
+00018950: 616e 6420 7365 6c66 2e73 7973 7465 6d2e  and self.system.
+00018960: 696f 6e2e 706c 6173 6d61 3a0a 2020 2020  ion.plasma:.    
+00018970: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+00018980: 3d20 2270 6c61 736d 615f 6761 7322 3a0a  = "plasma_gas":.
+00018990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189a0: 7661 6c75 6573 203d 2073 656c 662e 636f  values = self.co
+000189b0: 6e6e 6563 7469 6f6e 2e62 6561 6d73 2e69  nnection.beams.i
+000189c0: 6f6e 5f62 6561 6d2e 736f 7572 6365 2e70  on_beam.source.p
+000189d0: 6c61 736d 615f 6761 732e 6176 6169 6c61  lasma_gas.availa
+000189e0: 626c 655f 7661 6c75 6573 0a0a 2020 2020  ble_values..    
+000189f0: 2020 2020 6966 206b 6579 203d 3d20 2263      if key == "c
+00018a00: 7572 7265 6e74 223a 0a20 2020 2020 2020  urrent":.       
+00018a10: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
+00018a20: 6520 6973 2042 6561 6d54 7970 652e 494f  e is BeamType.IO
+00018a30: 4e20 616e 6420 7365 6c66 2e69 735f 6176  N and self.is_av
+00018a40: 6169 6c61 626c 6528 2269 6f6e 5f62 6561  ailable("ion_bea
+00018a50: 6d22 293a 0a20 2020 2020 2020 2020 2020  m"):.           
+00018a60: 2020 2020 2076 616c 7565 7320 3d20 7365       values = se
+00018a70: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6265  lf.connection.be
+00018a80: 616d 732e 696f 6e5f 6265 616d 2e62 6561  ams.ion_beam.bea
+00018a90: 6d5f 6375 7272 656e 742e 6176 6169 6c61  m_current.availa
+00018aa0: 626c 655f 7661 6c75 6573 0a20 2020 2020  ble_values.     
+00018ab0: 2020 2020 2020 2065 6c69 6620 6265 616d         elif beam
+00018ac0: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
+00018ad0: 652e 454c 4543 5452 4f4e 2061 6e64 2073  e.ELECTRON and s
+00018ae0: 656c 662e 6973 5f61 7661 696c 6162 6c65  elf.is_available
+00018af0: 2822 656c 6563 7472 6f6e 5f62 6561 6d22  ("electron_beam"
+00018b00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00018b10: 2020 2076 616c 7565 7320 3d20 7365 6c66     values = self
+00018b20: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
+00018b30: 732e 656c 6563 7472 6f6e 5f62 6561 6d2e  s.electron_beam.
+00018b40: 6265 616d 5f63 7572 7265 6e74 2e61 7661  beam_current.ava
+00018b50: 696c 6162 6c65 5f76 616c 7565 730a 2020  ilable_values.  
+00018b60: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+00018b70: 6620 6b65 7920 3d3d 2022 6465 7465 6374  f key == "detect
+00018b80: 6f72 5f74 7970 6522 3a0a 2020 2020 2020  or_type":.      
+00018b90: 2020 2020 2020 7661 6c75 6573 203d 2073        values = s
+00018ba0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e64  elf.connection.d
+00018bb0: 6574 6563 746f 722e 7479 7065 2e61 7661  etector.type.ava
+00018bc0: 696c 6162 6c65 5f76 616c 7565 730a 2020  ilable_values.  
+00018bd0: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+00018be0: 6620 6b65 7920 3d3d 2022 6465 7465 6374  f key == "detect
+00018bf0: 6f72 5f6d 6f64 6522 3a0a 2020 2020 2020  or_mode":.      
+00018c00: 2020 2020 2020 7661 6c75 6573 203d 2073        values = s
+00018c10: 656c 662e 636f 6e6e 6563 7469 6f6e 2e64  elf.connection.d
+00018c20: 6574 6563 746f 722e 6d6f 6465 2e61 7661  etector.mode.ava
+00018c30: 696c 6162 6c65 5f76 616c 7565 730a 2020  ilable_values.  
+00018c40: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+00018c50: 6620 6b65 7920 3d3d 2022 7363 616e 5f64  f key == "scan_d
+00018c60: 6972 6563 7469 6f6e 223a 0a20 2020 2020  irection":.     
+00018c70: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
+00018c80: 5b22 426f 7474 6f6d 546f 546f 7022 2c20  ["BottomToTop", 
+00018c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018ca0: 2022 4479 6e61 6d69 6341 6c6c 4469 7265   "DynamicAllDire
+00018cb0: 6374 696f 6e73 222c 200a 2020 2020 2020  ctions", .      
+00018cc0: 2020 2020 2020 2020 2020 2244 796e 616d            "Dynam
+00018cd0: 6963 496e 6e65 7254 6f4f 7574 6572 222c  icInnerToOuter",
+00018ce0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00018cf0: 2020 2244 796e 616d 6963 4c65 6674 546f    "DynamicLeftTo
+00018d00: 5269 6768 7422 2c20 0a20 2020 2020 2020  Right", .       
+00018d10: 2020 2020 2020 2020 2022 4479 6e61 6d69           "Dynami
+00018d20: 6354 6f70 546f 426f 7474 6f6d 222c 200a  cTopToBottom", .
+00018d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d40: 2249 6e6e 6572 546f 4f75 7465 7222 2c20  "InnerToOuter", 
+00018d50: 090a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018d60: 2020 224c 6566 7454 6f52 6967 6874 222c    "LeftToRight",
+00018d70: 2009 0a20 2020 2020 2020 2020 2020 2020   ..             
+00018d80: 2020 2022 4f75 7465 7254 6f49 6e6e 6572     "OuterToInner
+00018d90: 222c 200a 2020 2020 2020 2020 2020 2020  ", .            
+00018da0: 2020 2020 2252 6967 6874 546f 4c65 6674      "RightToLeft
+00018db0: 222c 2009 0a20 2020 2020 2020 2020 2020  ", ..           
+00018dc0: 2020 2020 2022 546f 7054 6f42 6f74 746f       "TopToBotto
+00018dd0: 6d22 5d0a 2020 2020 2020 2020 0a20 2020  m"].        .   
+00018de0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00018df0: 6769 735f 706f 7274 7322 3a0a 2020 2020  gis_ports":.    
+00018e00: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00018e10: 6973 5f61 7661 696c 6162 6c65 2822 6769  is_available("gi
+00018e20: 7322 293a 0a20 2020 2020 2020 2020 2020  s"):.           
+00018e30: 2020 2020 2076 616c 7565 7320 3d20 7365       values = se
+00018e40: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6761  lf.connection.ga
+00018e50: 732e 6c69 7374 5f61 6c6c 5f67 6973 5f70  s.list_all_gis_p
+00018e60: 6f72 7473 2829 0a20 2020 2020 2020 2020  orts().         
+00018e70: 2020 2065 6c69 6620 7365 6c66 2e69 735f     elif self.is_
+00018e80: 6176 6169 6c62 6c65 2822 6d75 6c74 6963  availble("multic
+00018e90: 6865 6d22 293a 0a20 2020 2020 2020 2020  hem"):.         
+00018ea0: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
+00018eb0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00018ec0: 6761 732e 6c69 7374 5f61 6c6c 5f6d 756c  gas.list_all_mul
+00018ed0: 7469 6368 656d 5f70 6f72 7473 2829 0a20  tichem_ports(). 
+00018ee0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00018ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018f00: 2076 616c 7565 7320 3d20 5b5d 0a20 2020   values = [].   
+00018f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f20: 2020 2020 200a 2020 2020 2020 2020 6c6f       .        lo
+00018f30: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00018f40: 6722 3a20 2267 6574 5f61 7661 696c 6162  g": "get_availab
+00018f50: 6c65 5f76 616c 7565 7322 2c20 226b 6579  le_values", "key
+00018f60: 223a 206b 6579 2c20 2276 616c 7565 7322  ": key, "values"
+00018f70: 3a20 7661 6c75 6573 7d29 0a0a 2020 2020  : values})..    
+00018f80: 2020 2020 7265 7475 726e 2076 616c 7565      return value
+00018f90: 730a 0a0a 2020 2020 6465 6620 5f67 6574  s...    def _get
+00018fa0: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
+00018fb0: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+00018fc0: 5479 7065 203d 204e 6f6e 6529 202d 3e20  Type = None) -> 
+00018fd0: 556e 696f 6e5b 666c 6f61 742c 2073 7472  Union[float, str
+00018fe0: 2c20 6c69 7374 2c20 4e6f 6e65 5d3a 0a20  , list, None]:. 
+00018ff0: 2020 2020 2020 2022 2222 4765 7420 6120         """Get a 
+00019000: 7072 6f70 6572 7479 206f 6620 7468 6520  property of the 
+00019010: 6d69 6372 6f73 636f 7065 2e22 2222 0a20  microscope.""". 
+00019020: 2020 2020 2020 2023 2054 4f44 4f3a 206d         # TODO: m
+00019030: 616b 6520 7468 6520 6c69 7374 206f 6620  ake the list of 
+00019040: 6765 7420 616e 6420 7365 7420 6b65 7973  get and set keys
+00019050: 2061 7661 696c 6162 6c65 2074 6f20 7468   available to th
+00019060: 6520 7573 6572 0a20 2020 2020 2020 2069  e user.        i
+00019070: 6620 6265 616d 5f74 7970 6520 6973 206e  f beam_type is n
+00019080: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00019090: 2020 2020 2062 6561 6d20 3d20 7365 6c66       beam = self
+000190a0: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
+000190b0: 732e 656c 6563 7472 6f6e 5f62 6561 6d20  s.electron_beam 
+000190c0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+000190d0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+000190e0: 4e20 656c 7365 2073 656c 662e 636f 6e6e  N else self.conn
+000190f0: 6563 7469 6f6e 2e62 6561 6d73 2e69 6f6e  ection.beams.ion
+00019100: 5f62 6561 6d0a 2020 2020 2020 2020 2020  _beam.          
+00019110: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
+00019120: 616d 5f74 7970 652c 2073 656c 662e 7379  am_type, self.sy
+00019130: 7374 656d 290a 0a20 2020 2020 2020 2023  stem)..        #
+00019140: 2062 6561 6d20 7072 6f70 6572 7469 6573   beam properties
+00019150: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00019160: 3d3d 2022 6f6e 223a 200a 2020 2020 2020  == "on": .      
+00019170: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
+00019180: 6d2e 6973 5f6f 6e0a 2020 2020 2020 2020  m.is_on.        
+00019190: 6966 206b 6579 203d 3d20 2262 6c61 6e6b  if key == "blank
+000191a0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
+000191b0: 2072 6574 7572 6e20 6265 616d 2e69 735f   return beam.is_
+000191c0: 626c 616e 6b65 640a 2020 2020 2020 2020  blanked.        
+000191d0: 6966 206b 6579 203d 3d20 2277 6f72 6b69  if key == "worki
+000191e0: 6e67 5f64 6973 7461 6e63 6522 3a0a 2020  ng_distance":.  
+000191f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00019200: 2062 6561 6d2e 776f 726b 696e 675f 6469   beam.working_di
+00019210: 7374 616e 6365 2e76 616c 7565 0a20 2020  stance.value.   
+00019220: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00019230: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
+00019240: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
+00019250: 6d2e 6265 616d 5f63 7572 7265 6e74 2e76  m.beam_current.v
+00019260: 616c 7565 0a20 2020 2020 2020 2069 6620  alue.        if 
+00019270: 6b65 7920 3d3d 2022 766f 6c74 6167 6522  key == "voltage"
+00019280: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00019290: 7475 726e 2062 6561 6d2e 6869 6768 5f76  turn beam.high_v
+000192a0: 6f6c 7461 6765 2e76 616c 7565 0a20 2020  oltage.value.   
+000192b0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+000192c0: 6866 7722 3a0a 2020 2020 2020 2020 2020  hfw":.          
+000192d0: 2020 7265 7475 726e 2062 6561 6d2e 686f    return beam.ho
+000192e0: 7269 7a6f 6e74 616c 5f66 6965 6c64 5f77  rizontal_field_w
+000192f0: 6964 7468 2e76 616c 7565 0a20 2020 2020  idth.value.     
+00019300: 2020 2069 6620 6b65 7920 3d3d 2022 6477     if key == "dw
+00019310: 656c 6c5f 7469 6d65 223a 0a20 2020 2020  ell_time":.     
+00019320: 2020 2020 2020 2072 6574 7572 6e20 6265         return be
+00019330: 616d 2e73 6361 6e6e 696e 672e 6477 656c  am.scanning.dwel
+00019340: 6c5f 7469 6d65 2e76 616c 7565 0a20 2020  l_time.value.   
+00019350: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00019360: 7363 616e 5f72 6f74 6174 696f 6e22 3a0a  scan_rotation":.
+00019370: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00019380: 726e 2062 6561 6d2e 7363 616e 6e69 6e67  rn beam.scanning
+00019390: 2e72 6f74 6174 696f 6e2e 7661 6c75 650a  .rotation.value.
+000193a0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+000193b0: 3d20 2276 6f6c 7461 6765 5f6c 696d 6974  = "voltage_limit
+000193c0: 7322 3a0a 2020 2020 2020 2020 2020 2020  s":.            
+000193d0: 7265 7475 726e 2062 6561 6d2e 6869 6768  return beam.high
+000193e0: 5f76 6f6c 7461 6765 2e6c 696d 6974 730a  _voltage.limits.
+000193f0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+00019400: 3d20 2276 6f6c 7461 6765 5f63 6f6e 7472  = "voltage_contr
+00019410: 6f6c 6c61 626c 6522 3a0a 2020 2020 2020  ollable":.      
+00019420: 2020 2020 2020 7265 7475 726e 2062 6561        return bea
+00019430: 6d2e 6869 6768 5f76 6f6c 7461 6765 2e69  m.high_voltage.i
+00019440: 735f 636f 6e74 726f 6c6c 6162 6c65 0a20  s_controllable. 
+00019450: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00019460: 2022 7368 6966 7422 3a20 2320 6265 616d   "shift": # beam
+00019470: 2073 6869 6674 0a20 2020 2020 2020 2020   shift.         
+00019480: 2020 2072 6574 7572 6e20 506f 696e 7428     return Point(
+00019490: 6265 616d 2e62 6561 6d5f 7368 6966 742e  beam.beam_shift.
+000194a0: 7661 6c75 652e 782c 2062 6561 6d2e 6265  value.x, beam.be
+000194b0: 616d 5f73 6869 6674 2e76 616c 7565 2e79  am_shift.value.y
+000194c0: 290a 2020 2020 2020 2020 6966 206b 6579  ).        if key
+000194d0: 203d 3d20 2273 7469 676d 6174 696f 6e22   == "stigmation"
+000194e0: 3a20 0a20 2020 2020 2020 2020 2020 2072  : .            r
+000194f0: 6574 7572 6e20 506f 696e 7428 6265 616d  eturn Point(beam
+00019500: 2e73 7469 676d 6174 6f72 2e76 616c 7565  .stigmator.value
+00019510: 2e78 2c20 6265 616d 2e73 7469 676d 6174  .x, beam.stigmat
+00019520: 6f72 2e76 616c 7565 2e79 290a 2020 2020  or.value.y).    
+00019530: 2020 2020 6966 206b 6579 203d 3d20 2272      if key == "r
+00019540: 6573 6f6c 7574 696f 6e22 3a0a 2020 2020  esolution":.    
+00019550: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
+00019560: 6f6e 203d 2062 6561 6d2e 7363 616e 6e69  on = beam.scanni
+00019570: 6e67 2e72 6573 6f6c 7574 696f 6e2e 7661  ng.resolution.va
+00019580: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+00019590: 7769 6474 682c 2068 6569 6768 7420 3d20  width, height = 
+000195a0: 696e 7428 7265 736f 6c75 7469 6f6e 2e73  int(resolution.s
+000195b0: 706c 6974 2822 7822 295b 305d 292c 2069  plit("x")[0]), i
+000195c0: 6e74 2872 6573 6f6c 7574 696f 6e2e 7370  nt(resolution.sp
+000195d0: 6c69 7428 2278 2229 5b2d 315d 290a 2020  lit("x")[-1]).  
+000195e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000195f0: 205b 7769 6474 682c 2068 6569 6768 745d   [width, height]
+00019600: 0a0a 2020 2020 2020 2020 2320 7379 7374  ..        # syst
+00019610: 656d 2070 726f 7065 7274 6965 730a 2020  em properties.  
+00019620: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00019630: 2265 7563 656e 7472 6963 5f68 6569 6768  "eucentric_heigh
+00019640: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+00019650: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+00019660: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00019670: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+00019680: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+00019690: 7973 7465 6d2e 656c 6563 7472 6f6e 2e65  ystem.electron.e
+000196a0: 7563 656e 7472 6963 5f68 6569 6768 740a  ucentric_height.
+000196b0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+000196c0: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
+000196d0: 616d 5479 7065 2e49 4f4e 3a0a 2020 2020  amType.ION:.    
+000196e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000196f0: 726e 2073 656c 662e 7379 7374 656d 2e69  rn self.system.i
+00019700: 6f6e 2e65 7563 656e 7472 6963 5f68 6569  on.eucentric_hei
+00019710: 6768 740a 2020 2020 2020 2020 2020 2020  ght.            
+00019720: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00019730: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00019740: 6545 7272 6f72 2866 2255 6e6b 6e6f 776e  eError(f"Unknown
+00019750: 2062 6561 6d20 7479 7065 3a20 7b62 6561   beam type: {bea
+00019760: 6d5f 7479 7065 7d20 666f 7220 7b6b 6579  m_type} for {key
+00019770: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
+00019780: 6b65 7920 3d3d 2022 636f 6c75 6d6e 5f74  key == "column_t
+00019790: 696c 7422 3a0a 2020 2020 2020 2020 2020  ilt":.          
+000197a0: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
+000197b0: 7320 4265 616d 5479 7065 2e45 4c45 4354  s BeamType.ELECT
+000197c0: 524f 4e3a 0a20 2020 2020 2020 2020 2020  RON:.           
+000197d0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000197e0: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
+000197f0: 2e63 6f6c 756d 6e5f 7469 6c74 0a20 2020  .column_tilt.   
+00019800: 2020 2020 2020 2020 2065 6c69 6620 6265           elif be
+00019810: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
+00019820: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
+00019830: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00019840: 7365 6c66 2e73 7973 7465 6d2e 696f 6e2e  self.system.ion.
+00019850: 636f 6c75 6d6e 5f74 696c 740a 2020 2020  column_tilt.    
+00019860: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00019870: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00019880: 6973 6520 5661 6c75 6545 7272 6f72 2866  ise ValueError(f
+00019890: 2255 6e6b 6e6f 776e 2062 6561 6d20 7479  "Unknown beam ty
+000198a0: 7065 3a20 7b62 6561 6d5f 7479 7065 7d20  pe: {beam_type} 
+000198b0: 666f 7220 7b6b 6579 7d22 290a 0a20 2020  for {key}")..   
+000198c0: 2020 2020 2023 2065 6c65 6374 726f 6e20       # electron 
+000198d0: 6265 616d 2070 726f 7065 7274 6965 730a  beam properties.
+000198e0: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+000198f0: 7479 7065 2069 7320 4265 616d 5479 7065  type is BeamType
+00019900: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+00019910: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00019920: 2022 616e 6775 6c61 725f 636f 7272 6563   "angular_correc
+00019930: 7469 6f6e 5f61 6e67 6c65 223a 0a20 2020  tion_angle":.   
+00019940: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00019950: 7572 6e20 6265 616d 2e61 6e67 756c 6172  urn beam.angular
+00019960: 5f63 6f72 7265 6374 696f 6e2e 616e 676c  _correction.angl
+00019970: 652e 7661 6c75 650a 0a20 2020 2020 2020  e.value..       
+00019980: 2023 2069 6f6e 2062 6561 6d20 7072 6f70   # ion beam prop
+00019990: 6572 7469 6573 0a20 2020 2020 2020 2069  erties.        i
+000199a0: 6620 6b65 7920 3d3d 2022 706c 6173 6d61  f key == "plasma
+000199b0: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
+000199c0: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
+000199d0: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+000199e0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+000199f0: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
+00019a00: 696f 6e2e 706c 6173 6d61 0a20 2020 2020  ion.plasma.     
+00019a10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00019a20: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00019a30: 7572 6e20 4661 6c73 650a 0a20 2020 2020  urn False..     
+00019a40: 2020 2069 6620 6b65 7920 3d3d 2022 706c     if key == "pl
+00019a50: 6173 6d61 5f67 6173 223a 0a20 2020 2020  asma_gas":.     
+00019a60: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
+00019a70: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
+00019a80: 494f 4e20 616e 6420 7365 6c66 2e73 7973  ION and self.sys
+00019a90: 7465 6d2e 696f 6e2e 706c 6173 6d61 3a0a  tem.ion.plasma:.
+00019aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ab0: 7265 7475 726e 2062 6561 6d2e 736f 7572  return beam.sour
+00019ac0: 6365 2e70 6c61 736d 615f 6761 732e 7661  ce.plasma_gas.va
+00019ad0: 6c75 6520 2320 6d69 6768 7420 6e65 6564  lue # might need
+00019ae0: 2074 6f20 6368 6563 6b20 6966 2074 6869   to check if thi
+00019af0: 7320 6973 2061 7661 696c 6162 6c65 3f0a  s is available?.
+00019b00: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00019b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019b20: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+00019b30: 2020 2020 2020 2023 2073 7461 6765 2070         # stage p
+00019b40: 726f 7065 7274 6965 730a 2020 2020 2020  roperties.      
+00019b50: 2020 6966 206b 6579 203d 3d20 2273 7461    if key == "sta
+00019b60: 6765 5f70 6f73 6974 696f 6e22 3a0a 2020  ge_position":.  
+00019b70: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00019b80: 5f73 7461 6765 2873 656c 662e 7379 7374  _stage(self.syst
+00019b90: 656d 290a 0a20 2020 2020 2020 2020 2020  em)..           
+00019ba0: 2023 2067 6574 2073 7461 6765 2070 6f73   # get stage pos
+00019bb0: 6974 696f 6e20 696e 2072 6177 2063 6f6f  ition in raw coo
+00019bc0: 7264 696e 6174 6573 200a 2020 2020 2020  rdinates .      
+00019bd0: 2020 2020 2020 7365 6c66 2e73 7461 6765        self.stage
+00019be0: 2e73 6574 5f64 6566 6175 6c74 5f63 6f6f  .set_default_coo
+00019bf0: 7264 696e 6174 655f 7379 7374 656d 2873  rdinate_system(s
+00019c00: 656c 662e 5f64 6566 6175 6c74 5f73 7461  elf._default_sta
+00019c10: 6765 5f63 6f6f 7264 696e 6174 655f 7379  ge_coordinate_sy
+00019c20: 7374 656d 2920 2320 544f 444f 3a20 7265  stem) # TODO: re
+00019c30: 6d6f 7665 2074 6869 7320 6f6e 6365 2074  move this once t
+00019c40: 6573 7469 6e67 2069 7320 646f 6e65 0a20  esting is done. 
+00019c50: 2020 2020 2020 2020 2020 2073 7461 6765             stage
+00019c60: 5f70 6f73 6974 696f 6e20 3d20 4669 6273  _position = Fibs
+00019c70: 656d 5374 6167 6550 6f73 6974 696f 6e2e  emStagePosition.
+00019c80: 6672 6f6d 5f61 7574 6f73 6372 6970 745f  from_autoscript_
+00019c90: 706f 7369 7469 6f6e 2873 656c 662e 7374  position(self.st
+00019ca0: 6167 652e 6375 7272 656e 745f 706f 7369  age.current_posi
+00019cb0: 7469 6f6e 290a 2020 2020 2020 2020 2020  tion).          
+00019cc0: 2020 7265 7475 726e 2073 7461 6765 5f70    return stage_p
+00019cd0: 6f73 6974 696f 6e0a 2020 2020 2020 2020  osition.        
+00019ce0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00019cf0: 3d3d 2022 7374 6167 655f 686f 6d65 6422  == "stage_homed"
+00019d00: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
+00019d10: 6865 636b 5f73 7461 6765 2873 656c 662e  heck_stage(self.
+00019d20: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+00019d30: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00019d40: 7374 6167 652e 6973 5f68 6f6d 6564 0a20  stage.is_homed. 
+00019d50: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00019d60: 2022 7374 6167 655f 6c69 6e6b 6564 223a   "stage_linked":
+00019d70: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00019d80: 6563 6b5f 7374 6167 6528 7365 6c66 2e73  eck_stage(self.s
+00019d90: 7973 7465 6d29 0a20 2020 2020 2020 2020  ystem).         
+00019da0: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+00019db0: 7461 6765 2e69 735f 6c69 6e6b 6564 0a0a  tage.is_linked..
+00019dc0: 2020 2020 2020 2020 2320 6368 616d 6265          # chambe
+00019dd0: 7220 7072 6f70 6572 7469 6573 0a20 2020  r properties.   
+00019de0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00019df0: 6368 616d 6265 725f 7374 6174 6522 3a0a  chamber_state":.
+00019e00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00019e10: 726e 2073 656c 662e 636f 6e6e 6563 7469  rn self.connecti
+00019e20: 6f6e 2e76 6163 7575 6d2e 6368 616d 6265  on.vacuum.chambe
+00019e30: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
+00019e40: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00019e50: 3d3d 2022 6368 616d 6265 725f 7072 6573  == "chamber_pres
+00019e60: 7375 7265 223a 0a20 2020 2020 2020 2020  sure":.         
+00019e70: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00019e80: 6f6e 6e65 6374 696f 6e2e 7661 6375 756d  onnection.vacuum
+00019e90: 2e63 6861 6d62 6572 5f70 7265 7373 7572  .chamber_pressur
+00019ea0: 652e 7661 6c75 650a 0a20 2020 2020 2020  e.value..       
+00019eb0: 2023 2064 6574 6563 746f 7220 6d6f 6465   # detector mode
+00019ec0: 2061 6e64 2074 7970 650a 2020 2020 2020   and type.      
+00019ed0: 2020 6966 206b 6579 2069 6e20 5b22 6465    if key in ["de
+00019ee0: 7465 6374 6f72 5f6d 6f64 6522 2c20 2264  tector_mode", "d
+00019ef0: 6574 6563 746f 725f 7479 7065 222c 2022  etector_type", "
+00019f00: 6465 7465 6374 6f72 5f62 7269 6768 746e  detector_brightn
+00019f10: 6573 7322 2c20 2264 6574 6563 746f 725f  ess", "detector_
+00019f20: 636f 6e74 7261 7374 225d 3a0a 2020 2020  contrast"]:.    
+00019f30: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00019f40: 2020 2020 2023 2073 6574 2062 6561 6d20       # set beam 
+00019f50: 6163 7469 7665 2076 6965 7720 616e 6420  active view and 
+00019f60: 6465 7669 6365 0a20 2020 2020 2020 2020  device.         
+00019f70: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00019f80: 6f6e 2e69 6d61 6769 6e67 2e73 6574 5f61  on.imaging.set_a
+00019f90: 6374 6976 655f 7669 6577 2862 6561 6d5f  ctive_view(beam_
+00019fa0: 7479 7065 2e76 616c 7565 290a 2020 2020  type.value).    
+00019fb0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00019fc0: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
+00019fd0: 7365 745f 6163 7469 7665 5f64 6576 6963  set_active_devic
+00019fe0: 6528 6265 616d 5f74 7970 652e 7661 6c75  e(beam_type.valu
+00019ff0: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+0001a000: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
+0001a010: 746f 725f 7479 7065 223a 0a20 2020 2020  tor_type":.     
+0001a020: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001a030: 6e20 7365 6c66 2e63 6f6e 6e65 6374 696f  n self.connectio
+0001a040: 6e2e 6465 7465 6374 6f72 2e74 7970 652e  n.detector.type.
+0001a050: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0001a060: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
+0001a070: 6563 746f 725f 6d6f 6465 223a 0a20 2020  ector_mode":.   
+0001a080: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001a090: 7572 6e20 7365 6c66 2e63 6f6e 6e65 6374  urn self.connect
+0001a0a0: 696f 6e2e 6465 7465 6374 6f72 2e6d 6f64  ion.detector.mod
+0001a0b0: 652e 7661 6c75 650a 2020 2020 2020 2020  e.value.        
+0001a0c0: 2020 2020 6966 206b 6579 203d 3d20 2264      if key == "d
+0001a0d0: 6574 6563 746f 725f 6272 6967 6874 6e65  etector_brightne
+0001a0e0: 7373 223a 0a20 2020 2020 2020 2020 2020  ss":.           
+0001a0f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0001a100: 2e63 6f6e 6e65 6374 696f 6e2e 6465 7465  .connection.dete
+0001a110: 6374 6f72 2e62 7269 6768 746e 6573 732e  ctor.brightness.
+0001a120: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0001a130: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
+0001a140: 6563 746f 725f 636f 6e74 7261 7374 223a  ector_contrast":
+0001a150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a160: 2072 6574 7572 6e20 7365 6c66 2e63 6f6e   return self.con
+0001a170: 6e65 6374 696f 6e2e 6465 7465 6374 6f72  nection.detector
+0001a180: 2e63 6f6e 7472 6173 742e 7661 6c75 650a  .contrast.value.
+0001a190: 0a20 2020 2020 2020 2023 206d 616e 6970  .        # manip
+0001a1a0: 756c 6174 6f72 2070 726f 7065 7274 6965  ulator propertie
+0001a1b0: 730a 2020 2020 2020 2020 6966 206b 6579  s.        if key
+0001a1c0: 203d 3d20 226d 616e 6970 756c 6174 6f72   == "manipulator
+0001a1d0: 5f70 6f73 6974 696f 6e22 3a0a 2020 2020  _position":.    
+0001a1e0: 2020 2020 2020 2020 5f63 6865 636b 5f6d          _check_m
+0001a1f0: 616e 6970 756c 6174 6f72 2873 656c 662e  anipulator(self.
+0001a200: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+0001a210: 2020 2020 706f 7369 7469 6f6e 203d 2073      position = s
+0001a220: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
+0001a230: 7065 6369 6d65 6e2e 6d61 6e69 7075 6c61  pecimen.manipula
+0001a240: 746f 722e 6375 7272 656e 745f 706f 7369  tor.current_posi
+0001a250: 7469 6f6e 2020 200a 2020 2020 2020 2020  tion   .        
+0001a260: 2020 2020 7265 7475 726e 2046 6962 7365      return Fibse
+0001a270: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+0001a280: 7469 6f6e 2e66 726f 6d5f 6175 746f 7363  tion.from_autosc
+0001a290: 7269 7074 5f70 6f73 6974 696f 6e28 706f  ript_position(po
+0001a2a0: 7369 7469 6f6e 290a 2020 2020 2020 2020  sition).        
+0001a2b0: 6966 206b 6579 203d 3d20 226d 616e 6970  if key == "manip
+0001a2c0: 756c 6174 6f72 5f73 7461 7465 223a 0a20  ulator_state":. 
+0001a2d0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+0001a2e0: 6b5f 6d61 6e69 7075 6c61 746f 7228 7365  k_manipulator(se
+0001a2f0: 6c66 2e73 7973 7465 6d29 0a20 2020 2020  lf.system).     
+0001a300: 2020 2020 2020 2073 7461 7465 203d 2073         state = s
+0001a310: 656c 662e 636f 6e6e 6563 7469 6f6e 2e73  elf.connection.s
+0001a320: 7065 6369 6d65 6e2e 6d61 6e69 7075 6c61  pecimen.manipula
+0001a330: 746f 722e 7374 6174 6520 2020 2020 2020  tor.state       
+0001a340: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0001a350: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+0001a360: 7565 2069 6620 7374 6174 6520 3d3d 204d  ue if state == M
+0001a370: 616e 6970 756c 6174 6f72 5374 6174 652e  anipulatorState.
+0001a380: 494e 5345 5254 4544 2065 6c73 6520 4661  INSERTED else Fa
+0001a390: 6c73 650a 0a20 2020 2020 2020 2023 206d  lse..        # m
+0001a3a0: 616e 7566 6163 7475 7265 7220 7072 6f70  anufacturer prop
+0001a3b0: 6572 7469 6573 0a20 2020 2020 2020 2069  erties.        i
+0001a3c0: 6620 6b65 7920 3d3d 2022 6d61 6e75 6661  f key == "manufa
+0001a3d0: 6374 7572 6572 223a 0a20 2020 2020 2020  cturer":.       
+0001a3e0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0001a3f0: 2e73 7973 7465 6d2e 696e 666f 2e6d 616e  .system.info.man
+0001a400: 7566 6163 7475 7265 720a 2020 2020 2020  ufacturer.      
+0001a410: 2020 6966 206b 6579 203d 3d20 226d 6f64    if key == "mod
+0001a420: 656c 223a 0a20 2020 2020 2020 2020 2020  el":.           
+0001a430: 2072 6574 7572 6e20 7365 6c66 2e73 7973   return self.sys
+0001a440: 7465 6d2e 696e 666f 2e6d 6f64 656c 0a20  tem.info.model. 
+0001a450: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0001a460: 2022 7365 7269 616c 5f6e 756d 6265 7222   "serial_number"
+0001a470: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001a480: 7475 726e 2073 656c 662e 7379 7374 656d  turn self.system
+0001a490: 2e69 6e66 6f2e 7365 7269 616c 5f6e 756d  .info.serial_num
+0001a4a0: 6265 720a 2020 2020 2020 2020 6966 206b  ber.        if k
+0001a4b0: 6579 203d 3d20 2273 6f66 7477 6172 655f  ey == "software_
+0001a4c0: 7665 7273 696f 6e22 3a0a 2020 2020 2020  version":.      
+0001a4d0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001a4e0: 662e 7379 7374 656d 2e69 6e66 6f2e 736f  f.system.info.so
+0001a4f0: 6674 7761 7265 5f76 6572 7369 6f6e 0a20  ftware_version. 
+0001a500: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0001a510: 2022 6861 7264 7761 7265 5f76 6572 7369   "hardware_versi
+0001a520: 6f6e 223a 0a20 2020 2020 2020 2020 2020  on":.           
+0001a530: 2072 6574 7572 6e20 7365 6c66 2e73 7973   return self.sys
+0001a540: 7465 6d2e 696e 666f 2e68 6172 6477 6172  tem.info.hardwar
+0001a550: 655f 7665 7273 696f 6e0a 2020 2020 2020  e_version.      
+0001a560: 2020 0a0a 2020 2020 2020 2020 2020 2020    ..            
+0001a570: 0a20 2020 2020 2020 2023 206c 6f67 6769  .        # loggi
+0001a580: 6e67 2e77 6172 6e69 6e67 2866 2255 6e6b  ng.warning(f"Unk
+0001a590: 6e6f 776e 206b 6579 3a20 7b6b 6579 7d20  nown key: {key} 
+0001a5a0: 287b 6265 616d 5f74 7970 657d 2922 290a  ({beam_type})").
+0001a5b0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0001a5c0: 6f6e 6520 2020 200a 0a20 2020 2064 6566  one    ..    def
+0001a5d0: 205f 7365 7428 7365 6c66 2c20 6b65 793a   _set(self, key:
+0001a5e0: 2073 7472 2c20 7661 6c75 652c 2062 6561   str, value, bea
+0001a5f0: 6d5f 7479 7065 3a20 4265 616d 5479 7065  m_type: BeamType
+0001a600: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
+0001a610: 3a0a 2020 2020 2020 2020 2222 2253 6574  :.        """Set
+0001a620: 2061 2070 726f 7065 7274 7920 6f66 2074   a property of t
+0001a630: 6865 206d 6963 726f 7363 6f70 652e 2222  he microscope.""
+0001a640: 220a 2020 2020 2020 2020 2320 7265 7175  ".        # requ
+0001a650: 6972 6564 2066 6f72 2073 6574 7469 6e67  ired for setting
+0001a660: 2073 6869 6674 2c20 7374 6967 6d61 7469   shift, stigmati
+0001a670: 6f6e 0a20 2020 2020 2020 2066 726f 6d20  on.        from 
+0001a680: 6175 746f 7363 7269 7074 5f73 6462 5f6d  autoscript_sdb_m
+0001a690: 6963 726f 7363 6f70 655f 636c 6965 6e74  icroscope_client
+0001a6a0: 2e73 7472 7563 7475 7265 7320 696d 706f  .structures impo
+0001a6b0: 7274 2050 6f69 6e74 2061 7320 5468 6572  rt Point as Ther
+0001a6c0: 6d6f 506f 696e 740a 0a20 2020 2020 2020  moPoint..       
+0001a6d0: 2023 2067 6574 2062 6561 6d0a 2020 2020   # get beam.    
+0001a6e0: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
+0001a6f0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001a700: 2020 2020 2020 2020 2020 6265 616d 203d            beam =
+0001a710: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0001a720: 2e62 6561 6d73 2e65 6c65 6374 726f 6e5f  .beams.electron_
+0001a730: 6265 616d 2069 6620 6265 616d 5f74 7970  beam if beam_typ
+0001a740: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
+0001a750: 4543 5452 4f4e 2065 6c73 6520 7365 6c66  ECTRON else self
+0001a760: 2e63 6f6e 6e65 6374 696f 6e2e 6265 616d  .connection.beam
+0001a770: 732e 696f 6e5f 6265 616d 0a20 2020 2020  s.ion_beam.     
+0001a780: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+0001a790: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+0001a7a0: 6c66 2e73 7973 7465 6d29 0a20 2020 2020  lf.system).     
+0001a7b0: 2020 200a 2020 2020 2020 2020 2320 6265     .        # be
+0001a7c0: 616d 2070 726f 7065 7274 6965 730a 2020  am properties.  
+0001a7d0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+0001a7e0: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
+0001a7f0: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+0001a800: 6265 616d 2e77 6f72 6b69 6e67 5f64 6973  beam.working_dis
+0001a810: 7461 6e63 652e 7661 6c75 6520 3d20 7661  tance.value = va
+0001a820: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+0001a830: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+0001a840: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0001a850: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+0001a860: 2020 2073 656c 662e 7365 7428 2273 7461     self.set("sta
+0001a870: 6765 5f6c 696e 6b22 2c20 5472 7565 2920  ge_link", True) 
+0001a880: 2023 206c 696e 6b20 7468 6520 7370 6563   # link the spec
+0001a890: 696d 656e 2073 7461 6765 2066 6f72 2065  imen stage for e
+0001a8a0: 6c65 6374 726f 6e0a 2020 2020 2020 2020  lectron.        
+0001a8b0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+0001a8c0: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
+0001a8d0: 6d65 7d20 776f 726b 696e 6720 6469 7374  me} working dist
+0001a8e0: 616e 6365 2073 6574 2074 6f20 7b76 616c  ance set to {val
+0001a8f0: 7565 7d20 6d2e 2229 0a20 2020 2020 2020  ue} m.").       
+0001a900: 2020 2020 2072 6574 7572 6e20 0a20 2020       return .   
+0001a910: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0001a920: 6375 7272 656e 7422 3a0a 2020 2020 2020  current":.      
+0001a930: 2020 2020 2020 6265 616d 2e62 6561 6d5f        beam.beam_
+0001a940: 6375 7272 656e 742e 7661 6c75 6520 3d20  current.value = 
+0001a950: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0001a960: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+0001a970: 227b 6265 616d 5f74 7970 652e 6e61 6d65  "{beam_type.name
+0001a980: 7d20 6375 7272 656e 7420 7365 7420 746f  } current set to
+0001a990: 207b 7661 6c75 657d 2041 2e22 290a 2020   {value} A.").  
+0001a9a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001a9b0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+0001a9c0: 3d3d 2022 766f 6c74 6167 6522 3a0a 2020  == "voltage":.  
+0001a9d0: 2020 2020 2020 2020 2020 6265 616d 2e68            beam.h
+0001a9e0: 6967 685f 766f 6c74 6167 652e 7661 6c75  igh_voltage.valu
+0001a9f0: 6520 3d20 7661 6c75 650a 2020 2020 2020  e = value.      
+0001aa00: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0001aa10: 666f 2866 227b 6265 616d 5f74 7970 652e  fo(f"{beam_type.
+0001aa20: 6e61 6d65 7d20 766f 6c74 6167 6520 7365  name} voltage se
+0001aa30: 7420 746f 207b 7661 6c75 657d 2056 2e22  t to {value} V."
+0001aa40: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0001aa50: 7475 726e 0a20 2020 2020 2020 2069 6620  turn.        if 
+0001aa60: 6b65 7920 3d3d 2022 6866 7722 3a0a 2020  key == "hfw":.  
+0001aa70: 2020 2020 2020 2020 2020 6c69 6d69 7473            limits
+0001aa80: 203d 2062 6561 6d2e 686f 7269 7a6f 6e74   = beam.horizont
+0001aa90: 616c 5f66 6965 6c64 5f77 6964 7468 2e6c  al_field_width.l
+0001aaa0: 696d 6974 730a 2020 2020 2020 2020 2020  imits.          
+0001aab0: 2020 7661 6c75 6520 3d20 6e70 2e63 6c69    value = np.cli
+0001aac0: 7028 7661 6c75 652c 206c 696d 6974 732e  p(value, limits.
+0001aad0: 6d69 6e2c 206c 696d 6974 732e 6d61 7829  min, limits.max)
+0001aae0: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+0001aaf0: 6d2e 686f 7269 7a6f 6e74 616c 5f66 6965  m.horizontal_fie
+0001ab00: 6c64 5f77 6964 7468 2e76 616c 7565 203d  ld_width.value =
+0001ab10: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
+0001ab20: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0001ab30: 6622 7b62 6561 6d5f 7479 7065 2e6e 616d  f"{beam_type.nam
+0001ab40: 657d 2048 4657 2073 6574 2074 6f20 7b76  e} HFW set to {v
+0001ab50: 616c 7565 7d20 6d2e 2229 0a20 2020 2020  alue} m.").     
+0001ab60: 2020 2020 2020 2072 6574 7572 6e20 0a20         return . 
+0001ab70: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0001ab80: 2022 6477 656c 6c5f 7469 6d65 223a 0a20   "dwell_time":. 
+0001ab90: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0001aba0: 7363 616e 6e69 6e67 2e64 7765 6c6c 5f74  scanning.dwell_t
+0001abb0: 696d 652e 7661 6c75 6520 3d20 7661 6c75  ime.value = valu
+0001abc0: 650a 2020 2020 2020 2020 2020 2020 6c6f  e.            lo
+0001abd0: 6767 696e 672e 696e 666f 2866 227b 6265  gging.info(f"{be
+0001abe0: 616d 5f74 7970 652e 6e61 6d65 7d20 6477  am_type.name} dw
+0001abf0: 656c 6c20 7469 6d65 2073 6574 2074 6f20  ell time set to 
+0001ac00: 7b76 616c 7565 7d20 732e 2229 0a20 2020  {value} s.").   
+0001ac10: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0001ac20: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+0001ac30: 3d20 2273 6361 6e5f 726f 7461 7469 6f6e  = "scan_rotation
+0001ac40: 223a 0a20 2020 2020 2020 2020 2020 2062  ":.            b
+0001ac50: 6561 6d2e 7363 616e 6e69 6e67 2e72 6f74  eam.scanning.rot
+0001ac60: 6174 696f 6e2e 7661 6c75 6520 3d20 7661  ation.value = va
+0001ac70: 6c75 650a 2020 2020 2020 2020 2020 2020  lue.            
+0001ac80: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
+0001ac90: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
+0001aca0: 7363 616e 2072 6f74 6174 696f 6e20 7365  scan rotation se
+0001acb0: 7420 746f 207b 7661 6c75 657d 2072 6164  t to {value} rad
+0001acc0: 6961 6e73 2e22 290a 2020 2020 2020 2020  ians.").        
+0001acd0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+0001ace0: 2020 2069 6620 6b65 7920 3d3d 2022 7368     if key == "sh
+0001acf0: 6966 7422 3a0a 2020 2020 2020 2020 2020  ift":.          
+0001ad00: 2020 6265 616d 2e62 6561 6d5f 7368 6966    beam.beam_shif
+0001ad10: 742e 7661 6c75 6520 3d20 5468 6572 6d6f  t.value = Thermo
+0001ad20: 506f 696e 7428 2d76 616c 7565 2e78 2c20  Point(-value.x, 
+0001ad30: 7661 6c75 652e 7929 0a20 2020 2020 2020  value.y).       
+0001ad40: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0001ad50: 6f28 6622 7b62 6561 6d5f 7479 7065 2e6e  o(f"{beam_type.n
+0001ad60: 616d 657d 2073 6869 6674 2073 6574 2074  ame} shift set t
+0001ad70: 6f20 7b76 616c 7565 7d2e 2229 0a20 2020  o {value}.").   
+0001ad80: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0001ad90: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+0001ada0: 3d20 2273 7469 676d 6174 696f 6e22 3a0a  = "stigmation":.
+0001adb0: 2020 2020 2020 2020 2020 2020 6265 616d              beam
+0001adc0: 2e73 7469 676d 6174 6f72 2e76 616c 7565  .stigmator.value
+0001add0: 203d 2054 6865 726d 6f50 6f69 6e74 2876   = ThermoPoint(v
+0001ade0: 616c 7565 2e78 2c20 7661 6c75 652e 7929  alue.x, value.y)
+0001adf0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001ae00: 6769 6e67 2e69 6e66 6f28 6622 7b62 6561  ging.info(f"{bea
+0001ae10: 6d5f 7479 7065 2e6e 616d 657d 2073 7469  m_type.name} sti
+0001ae20: 676d 6174 696f 6e20 7365 7420 746f 207b  gmation set to {
+0001ae30: 7661 6c75 657d 2e22 290a 2020 2020 2020  value}.").      
+0001ae40: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0001ae50: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
+0001ae60: 206b 6579 203d 3d20 2272 6573 6f6c 7574   key == "resolut
+0001ae70: 696f 6e22 3a0a 2020 2020 2020 2020 2020  ion":.          
+0001ae80: 2020 7265 736f 6c75 7469 6f6e 203d 2066    resolution = f
+0001ae90: 227b 7661 6c75 655b 305d 7d78 7b76 616c  "{value[0]}x{val
+0001aea0: 7565 5b31 5d7d 2220 2023 2057 6964 7468  ue[1]}"  # Width
+0001aeb0: 7848 6569 6768 7420 652e 672e 2031 3533  xHeight e.g. 153
+0001aec0: 3678 3130 3234 0a20 2020 2020 2020 2020  6x1024.         
+0001aed0: 2020 2062 6561 6d2e 7363 616e 6e69 6e67     beam.scanning
+0001aee0: 2e72 6573 6f6c 7574 696f 6e2e 7661 6c75  .resolution.valu
+0001aef0: 6520 3d20 7265 736f 6c75 7469 6f6e 0a20  e = resolution. 
+0001af00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001af10: 6e20 0a20 2020 2020 2020 200a 2020 2020  n .        .    
+0001af20: 2020 2020 2320 6265 616d 2063 6f6e 7472      # beam contr
+0001af30: 6f6c 0a20 2020 2020 2020 2069 6620 6b65  ol.        if ke
+0001af40: 7920 3d3d 2022 6f6e 223a 0a20 2020 2020  y == "on":.     
+0001af50: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+0001af60: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+0001af70: 6c66 2e73 7973 7465 6d29 0a20 2020 2020  lf.system).     
+0001af80: 2020 2020 2020 2062 6561 6d2e 7475 726e         beam.turn
+0001af90: 5f6f 6e28 2920 6966 2076 616c 7565 2065  _on() if value e
+0001afa0: 6c73 6520 6265 616d 2e74 7572 6e5f 6f66  lse beam.turn_of
+0001afb0: 6628 290a 2020 2020 2020 2020 2020 2020  f().            
+0001afc0: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
+0001afd0: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
+0001afe0: 6265 616d 2074 7572 6e65 6420 7b27 6f6e  beam turned {'on
+0001aff0: 2720 6966 2076 616c 7565 2065 6c73 6520  ' if value else 
+0001b000: 276f 6666 277d 2e22 290a 2020 2020 2020  'off'}.").      
+0001b010: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0001b020: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0001b030: 626c 616e 6b65 6422 3a0a 2020 2020 2020  blanked":.      
+0001b040: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+0001b050: 6d28 6265 616d 5f74 7970 652c 2073 656c  m(beam_type, sel
+0001b060: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
+0001b070: 2020 2020 2020 6265 616d 2e62 6c61 6e6b        beam.blank
+0001b080: 2829 2069 6620 7661 6c75 6520 656c 7365  () if value else
+0001b090: 2062 6561 6d2e 756e 626c 616e 6b28 290a   beam.unblank().
+0001b0a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001b0b0: 696e 672e 696e 666f 2866 227b 6265 616d  ing.info(f"{beam
+0001b0c0: 5f74 7970 652e 6e61 6d65 7d20 6265 616d  _type.name} beam
+0001b0d0: 207b 2762 6c61 6e6b 6564 2720 6966 2076   {'blanked' if v
+0001b0e0: 616c 7565 2065 6c73 6520 2775 6e62 6c61  alue else 'unbla
+0001b0f0: 6e6b 6564 277d 2e22 290a 2020 2020 2020  nked'}.").      
+0001b100: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0001b110: 2020 2020 2020 2320 6465 7465 6374 6f72        # detector
+0001b120: 2070 726f 7065 7274 6965 730a 2020 2020   properties.    
+0001b130: 2020 2020 6966 206b 6579 2069 6e20 5b22      if key in ["
+0001b140: 6465 7465 6374 6f72 5f6d 6f64 6522 2c20  detector_mode", 
+0001b150: 2264 6574 6563 746f 725f 7479 7065 222c  "detector_type",
+0001b160: 2022 6465 7465 6374 6f72 5f62 7269 6768   "detector_brigh
+0001b170: 746e 6573 7322 2c20 2264 6574 6563 746f  tness", "detecto
+0001b180: 725f 636f 6e74 7261 7374 225d 3a0a 2020  r_contrast"]:.  
+0001b190: 2020 2020 2020 2020 2020 2320 7365 7420            # set 
+0001b1a0: 6265 616d 2061 6374 6976 6520 7669 6577  beam active view
+0001b1b0: 2061 6e64 2064 6576 6963 650a 2020 2020   and device.    
+0001b1c0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0001b1d0: 6e65 6374 696f 6e2e 696d 6167 696e 672e  nection.imaging.
+0001b1e0: 7365 745f 6163 7469 7665 5f76 6965 7728  set_active_view(
+0001b1f0: 6265 616d 5f74 7970 652e 7661 6c75 6529  beam_type.value)
+0001b200: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001b210: 662e 636f 6e6e 6563 7469 6f6e 2e69 6d61  f.connection.ima
+0001b220: 6769 6e67 2e73 6574 5f61 6374 6976 655f  ging.set_active_
+0001b230: 6465 7669 6365 2862 6561 6d5f 7479 7065  device(beam_type
+0001b240: 2e76 616c 7565 290a 0a20 2020 2020 2020  .value)..       
+0001b250: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0001b260: 6465 7465 6374 6f72 5f6d 6f64 6522 3a0a  detector_mode":.
+0001b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b280: 6966 2076 616c 7565 2069 6e20 7365 6c66  if value in self
+0001b290: 2e63 6f6e 6e65 6374 696f 6e2e 6465 7465  .connection.dete
+0001b2a0: 6374 6f72 2e6d 6f64 652e 6176 6169 6c61  ctor.mode.availa
+0001b2b0: 626c 655f 7661 6c75 6573 3a0a 2020 2020  ble_values:.    
+0001b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2d0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0001b2e0: 6465 7465 6374 6f72 2e6d 6f64 652e 7661  detector.mode.va
+0001b2f0: 6c75 6520 3d20 7661 6c75 650a 2020 2020  lue = value.    
+0001b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b310: 6c6f 6767 696e 672e 696e 666f 2866 2244  logging.info(f"D
+0001b320: 6574 6563 746f 7220 6d6f 6465 2073 6574  etector mode set
+0001b330: 2074 6f20 7b76 616c 7565 7d2e 2229 0a20   to {value}."). 
+0001b340: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001b350: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001b360: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0001b370: 2e77 6172 6e69 6e67 2866 2244 6574 6563  .warning(f"Detec
+0001b380: 746f 7220 6d6f 6465 207b 7661 6c75 657d  tor mode {value}
+0001b390: 206e 6f74 2061 7661 696c 6162 6c65 2e22   not available."
+0001b3a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001b3b0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+0001b3c0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0001b3d0: 6465 7465 6374 6f72 5f74 7970 6522 3a0a  detector_type":.
+0001b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b3f0: 6966 2076 616c 7565 2069 6e20 7365 6c66  if value in self
+0001b400: 2e63 6f6e 6e65 6374 696f 6e2e 6465 7465  .connection.dete
+0001b410: 6374 6f72 2e74 7970 652e 6176 6169 6c61  ctor.type.availa
+0001b420: 626c 655f 7661 6c75 6573 3a0a 2020 2020  ble_values:.    
+0001b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b440: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0001b450: 6465 7465 6374 6f72 2e74 7970 652e 7661  detector.type.va
+0001b460: 6c75 6520 3d20 7661 6c75 650a 2020 2020  lue = value.    
+0001b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b480: 6c6f 6767 696e 672e 696e 666f 2866 2244  logging.info(f"D
+0001b490: 6574 6563 746f 7220 7479 7065 2073 6574  etector type set
+0001b4a0: 2074 6f20 7b76 616c 7565 7d2e 2229 0a20   to {value}."). 
+0001b4b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001b4c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001b4d0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0001b4e0: 2e77 6172 6e69 6e67 2866 2244 6574 6563  .warning(f"Detec
+0001b4f0: 746f 7220 7479 7065 207b 7661 6c75 657d  tor type {value}
+0001b500: 206e 6f74 2061 7661 696c 6162 6c65 2e22   not available."
+0001b510: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001b520: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+0001b530: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0001b540: 6465 7465 6374 6f72 5f62 7269 6768 746e  detector_brightn
+0001b550: 6573 7322 3a0a 2020 2020 2020 2020 2020  ess":.          
+0001b560: 2020 2020 2020 6966 2030 203c 2076 616c        if 0 < val
+0001b570: 7565 203c 3d20 3120 3a0a 2020 2020 2020  ue <= 1 :.      
+0001b580: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001b590: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 6465  lf.connection.de
+0001b5a0: 7465 6374 6f72 2e62 7269 6768 746e 6573  tector.brightnes
+0001b5b0: 732e 7661 6c75 6520 3d20 7661 6c75 650a  s.value = value.
+0001b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5d0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+0001b5e0: 2866 2244 6574 6563 746f 7220 6272 6967  (f"Detector brig
+0001b5f0: 6874 6e65 7373 2073 6574 2074 6f20 7b76  htness set to {v
+0001b600: 616c 7565 7d2e 2229 0a20 2020 2020 2020  alue}.").       
+0001b610: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001b620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b630: 2020 206c 6f67 6769 6e67 2e77 6172 6e69     logging.warni
+0001b640: 6e67 2866 2244 6574 6563 746f 7220 6272  ng(f"Detector br
+0001b650: 6967 6874 6e65 7373 207b 7661 6c75 657d  ightness {value}
+0001b660: 206e 6f74 2061 7661 696c 6162 6c65 2c20   not available, 
+0001b670: 6d75 7374 2062 6520 6265 7477 6565 6e20  must be between 
+0001b680: 3020 616e 6420 312e 2229 0a20 2020 2020  0 and 1.").     
+0001b690: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b6a0: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+0001b6b0: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
+0001b6c0: 725f 636f 6e74 7261 7374 223a 0a20 2020  r_contrast":.   
+0001b6d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001b6e0: 3020 3c20 7661 6c75 6520 3c3d 2031 203a  0 < value <= 1 :
+0001b6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b700: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0001b710: 7469 6f6e 2e64 6574 6563 746f 722e 636f  tion.detector.co
+0001b720: 6e74 7261 7374 2e76 616c 7565 203d 2076  ntrast.value = v
+0001b730: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+0001b740: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0001b750: 2e69 6e66 6f28 6622 4465 7465 6374 6f72  .info(f"Detector
+0001b760: 2063 6f6e 7472 6173 7420 7365 7420 746f   contrast set to
+0001b770: 207b 7661 6c75 657d 2e22 290a 2020 2020   {value}.").    
+0001b780: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001b790: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b7a0: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
+0001b7b0: 726e 696e 6728 6622 4465 7465 6374 6f72  rning(f"Detector
+0001b7c0: 2063 6f6e 7472 6173 7420 7b76 616c 7565   contrast {value
+0001b7d0: 7d20 6e6f 7420 6176 6169 6c61 626c 652c  } not available,
+0001b7e0: 206d 7574 2062 6520 6265 7477 6565 6e20   mut be between 
+0001b7f0: 3020 616e 6420 312e 2229 0a20 2020 2020  0 and 1.").     
+0001b800: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b810: 6e0a 0a20 2020 2020 2020 2023 2073 7973  n..        # sys
+0001b820: 7465 6d20 7072 6f70 6572 7469 6573 0a20  tem properties. 
+0001b830: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0001b840: 2022 6265 616d 5f65 6e61 626c 6564 223a   "beam_enabled":
+0001b850: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001b860: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
+0001b870: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
+0001b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b890: 7365 6c66 2e73 7973 7465 6d2e 656c 6563  self.system.elec
+0001b8a0: 7472 6f6e 2e62 6561 6d2e 656e 6162 6c65  tron.beam.enable
+0001b8b0: 6420 3d20 7661 6c75 650a 2020 2020 2020  d = value.      
+0001b8c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001b8d0: 200a 2020 2020 2020 2020 2020 2020 656c   .            el
+0001b8e0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+0001b8f0: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+0001b900: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001b910: 6c66 2e73 7973 7465 6d2e 696f 6e2e 6265  lf.system.ion.be
+0001b920: 616d 2e65 6e61 626c 6564 203d 2076 616c  am.enabled = val
+0001b930: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0001b940: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0001b950: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001b960: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001b970: 6520 5661 6c75 6545 7272 6f72 2866 2255  e ValueError(f"U
+0001b980: 6e6b 6e6f 776e 2062 6561 6d20 7479 7065  nknown beam type
+0001b990: 3a20 7b62 6561 6d5f 7479 7065 7d20 666f  : {beam_type} fo
+0001b9a0: 7220 7b6b 6579 7d22 290a 2020 2020 2020  r {key}").      
+0001b9b0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0001b9c0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+0001b9d0: 2265 7563 656e 7472 6963 5f68 6569 6768  "eucentric_heigh
+0001b9e0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+0001b9f0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+0001ba00: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0001ba10: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+0001ba20: 2020 2073 656c 662e 7379 7374 656d 2e65     self.system.e
+0001ba30: 6c65 6374 726f 6e2e 6575 6365 6e74 7269  lectron.eucentri
+0001ba40: 635f 6865 6967 6874 203d 2076 616c 7565  c_height = value
+0001ba50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ba60: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0001ba70: 2020 2020 656c 6966 2062 6561 6d5f 7479      elif beam_ty
+0001ba80: 7065 2069 7320 4265 616d 5479 7065 2e49  pe is BeamType.I
+0001ba90: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+0001baa0: 2020 2020 7365 6c66 2e73 7973 7465 6d2e      self.system.
+0001bab0: 696f 6e2e 6575 6365 6e74 7269 635f 6865  ion.eucentric_he
+0001bac0: 6967 6874 203d 2076 616c 7565 0a20 2020  ight = value.   
+0001bad0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0001bae0: 7572 6e20 0a20 2020 2020 2020 2020 2020  urn .           
+0001baf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001bb00: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0001bb10: 7565 4572 726f 7228 6622 556e 6b6e 6f77  ueError(f"Unknow
+0001bb20: 6e20 6265 616d 2074 7970 653a 207b 6265  n beam type: {be
+0001bb30: 616d 5f74 7970 657d 2066 6f72 207b 6b65  am_type} for {ke
+0001bb40: 797d 2229 0a0a 2020 2020 2020 2020 6966  y}")..        if
+0001bb50: 206b 6579 203d 3d22 636f 6c75 6d6e 5f74   key =="column_t
+0001bb60: 696c 7422 3a0a 2020 2020 2020 2020 2020  ilt":.          
+0001bb70: 2020 6966 2062 6561 6d5f 7479 7065 2069    if beam_type i
+0001bb80: 7320 4265 616d 5479 7065 2e45 4c45 4354  s BeamType.ELECT
+0001bb90: 524f 4e3a 0a20 2020 2020 2020 2020 2020  RON:.           
+0001bba0: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
+0001bbb0: 2e65 6c65 6374 726f 6e2e 636f 6c75 6d6e  .electron.column
+0001bbc0: 5f74 696c 7420 3d20 7661 6c75 650a 2020  _tilt = value.  
+0001bbd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001bbe0: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0001bbf0: 2065 6c69 6620 6265 616d 5f74 7970 6520   elif beam_type 
+0001bc00: 6973 2042 6561 6d54 7970 652e 494f 4e3a  is BeamType.ION:
+0001bc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bc20: 2073 656c 662e 7379 7374 656d 2e69 6f6e   self.system.ion
+0001bc30: 2e63 6f6c 756d 6e5f 7469 6c74 203d 2076  .column_tilt = v
+0001bc40: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+0001bc50: 2020 2020 2072 6574 7572 6e20 0a20 2020       return .   
+0001bc60: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001bc70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001bc80: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0001bc90: 6622 556e 6b6e 6f77 6e20 6265 616d 2074  f"Unknown beam t
+0001bca0: 7970 653a 207b 6265 616d 5f74 7970 657d  ype: {beam_type}
+0001bcb0: 2066 6f72 207b 6b65 797d 2229 0a0a 2020   for {key}")..  
+0001bcc0: 2020 2020 2020 2320 696f 6e20 6265 616d        # ion beam
+0001bcd0: 2070 726f 7065 7274 6965 730a 2020 2020   properties.    
+0001bce0: 2020 2020 6966 206b 6579 203d 3d20 2270      if key == "p
+0001bcf0: 6c61 736d 6122 3a0a 2020 2020 2020 2020  lasma":.        
+0001bd00: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
+0001bd10: 2069 7320 4265 616d 5479 7065 2e49 4f4e   is BeamType.ION
+0001bd20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bd30: 2020 7365 6c66 2e73 7973 7465 6d2e 696f    self.system.io
+0001bd40: 6e2e 706c 6173 6d61 203d 2076 616c 7565  n.plasma = value
+0001bd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bd60: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0001bd70: 2020 2020 0a20 2020 2020 2020 2023 2065      .        # e
+0001bd80: 6c65 6374 726f 6e20 6265 616d 2070 726f  lectron beam pro
+0001bd90: 7065 7274 6965 730a 2020 2020 2020 2020  perties.        
+0001bda0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+0001bdb0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0001bdc0: 4e3a 0a20 2020 2020 2020 2020 2020 2069  N:.            i
+0001bdd0: 6620 6b65 7920 3d3d 2022 616e 6775 6c61  f key == "angula
+0001bde0: 725f 636f 7272 6563 7469 6f6e 5f61 6e67  r_correction_ang
+0001bdf0: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
+0001be00: 2020 2020 2062 6561 6d2e 616e 6775 6c61       beam.angula
+0001be10: 725f 636f 7272 6563 7469 6f6e 2e61 6e67  r_correction.ang
+0001be20: 6c65 2e76 616c 7565 203d 2076 616c 7565  le.value = value
+0001be30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001be40: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0001be50: 416e 6775 6c61 7220 636f 7272 6563 7469  Angular correcti
+0001be60: 6f6e 2061 6e67 6c65 2073 6574 2074 6f20  on angle set to 
+0001be70: 7b76 616c 7565 7d20 7261 6469 616e 732e  {value} radians.
+0001be80: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0001be90: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+0001bea0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0001beb0: 2022 616e 6775 6c61 725f 636f 7272 6563   "angular_correc
+0001bec0: 7469 6f6e 5f74 696c 745f 636f 7272 6563  tion_tilt_correc
+0001bed0: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
+0001bee0: 2020 2020 2020 2062 6561 6d2e 616e 6775         beam.angu
+0001bef0: 6c61 725f 636f 7272 6563 7469 6f6e 2e74  lar_correction.t
+0001bf00: 696c 745f 636f 7272 6563 7469 6f6e 2e74  ilt_correction.t
+0001bf10: 7572 6e5f 6f6e 2829 2069 6620 7661 6c75  urn_on() if valu
+0001bf20: 6520 656c 7365 2062 6561 6d2e 616e 6775  e else beam.angu
+0001bf30: 6c61 725f 636f 7272 6563 7469 6f6e 2e74  lar_correction.t
+0001bf40: 696c 745f 636f 7272 6563 7469 6f6e 2e74  ilt_correction.t
+0001bf50: 7572 6e5f 6f66 6628 290a 2020 2020 2020  urn_off().      
+0001bf60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001bf70: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+0001bf80: 2020 2320 696f 6e20 6265 616d 2070 726f    # ion beam pro
+0001bf90: 7065 7274 6965 730a 2020 2020 2020 2020  perties.        
+0001bfa0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+0001bfb0: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+0001bfc0: 2020 2020 2020 2020 2020 6966 206b 6579            if key
+0001bfd0: 203d 3d20 2270 6c61 736d 615f 6761 7322   == "plasma_gas"
+0001bfe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bff0: 2020 6966 206e 6f74 2073 656c 662e 7379    if not self.sy
+0001c000: 7374 656d 2e69 6f6e 2e70 6c61 736d 613a  stem.ion.plasma:
+0001c010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c020: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
+0001c030: 7567 2866 2250 6c61 736d 6120 6761 7320  ug(f"Plasma gas 
+0001c040: 6361 6e6e 6f74 2062 6520 7365 7420 6f6e  cannot be set on
+0001c050: 2074 6869 7320 6d69 6372 6f73 636f 7065   this microscope
+0001c060: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0001c070: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0001c080: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001c090: 6620 6e6f 7420 7365 6c66 2e63 6865 636b  f not self.check
+0001c0a0: 5f61 7661 696c 6162 6c65 5f76 616c 7565  _available_value
+0001c0b0: 7328 2270 6c61 736d 615f 6761 7322 2c20  s("plasma_gas", 
+0001c0c0: 5b76 616c 7565 5d2c 2062 6561 6d5f 7479  [value], beam_ty
+0001c0d0: 7065 293a 0a20 2020 2020 2020 2020 2020  pe):.           
+0001c0e0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0001c0f0: 2e77 6172 6e69 6e67 2866 2250 6c61 736d  .warning(f"Plasm
+0001c100: 6120 6761 7320 7b76 616c 7565 7d20 6e6f  a gas {value} no
+0001c110: 7420 6176 6169 6c61 626c 652e 2041 7661  t available. Ava
+0001c120: 696c 6162 6c65 2076 616c 7565 733a 207b  ilable values: {
+0001c130: 7365 6c66 2e67 6574 5f61 7661 696c 6162  self.get_availab
+0001c140: 6c65 5f76 616c 7565 7328 2770 6c61 736d  le_values('plasm
+0001c150: 615f 6761 7327 2c20 6265 616d 5f74 7970  a_gas', beam_typ
+0001c160: 6529 7d22 290a 2020 2020 2020 2020 2020  e)}").          
+0001c170: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0001c180: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+0001c190: 6e66 6f28 6622 5365 7474 696e 6720 706c  nfo(f"Setting pl
+0001c1a0: 6173 6d61 2067 6173 2074 6f20 7b76 616c  asma gas to {val
+0001c1b0: 7565 7d2e 2e2e 2074 6869 7320 6d61 7920  ue}... this may 
+0001c1c0: 7461 6b65 2073 6f6d 6520 7469 6d65 2e2e  take some time..
+0001c1d0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0001c1e0: 2020 2020 6265 616d 2e73 6f75 7263 652e      beam.source.
+0001c1f0: 706c 6173 6d61 5f67 6173 2e76 616c 7565  plasma_gas.value
+0001c200: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+0001c210: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0001c220: 2e69 6e66 6f28 6622 506c 6173 6d61 2067  .info(f"Plasma g
+0001c230: 6173 2073 6574 2074 6f20 7b76 616c 7565  as set to {value
+0001c240: 7d2e 2229 0a0a 2020 2020 2020 2020 2020  }.")..          
+0001c250: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0001c260: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
+0001c270: 7374 6167 6520 7072 6f70 6572 7469 6573  stage properties
+0001c280: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+0001c290: 3d3d 2022 7374 6167 655f 686f 6d65 223a  == "stage_home":
+0001c2a0: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+0001c2b0: 6563 6b5f 7374 6167 6528 7365 6c66 2e73  eck_stage(self.s
+0001c2c0: 7973 7465 6d29 0a20 2020 2020 2020 2020  ystem).         
+0001c2d0: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0001c2e0: 6622 486f 6d69 6e67 2073 7461 6765 2e2e  f"Homing stage..
+0001c2f0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0001c300: 7365 6c66 2e73 7461 6765 2e68 6f6d 6528  self.stage.home(
+0001c310: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+0001c320: 6767 696e 672e 696e 666f 2866 2253 7461  gging.info(f"Sta
+0001c330: 6765 2068 6f6d 6564 2e22 290a 2020 2020  ge homed.").    
+0001c340: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0001c350: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001c360: 6966 206b 6579 203d 3d20 2273 7461 6765  if key == "stage
+0001c370: 5f6c 696e 6b22 3a0a 2020 2020 2020 2020  _link":.        
+0001c380: 2020 2020 5f63 6865 636b 5f73 7461 6765      _check_stage
+0001c390: 2873 656c 662e 7379 7374 656d 290a 2020  (self.system).  
+0001c3a0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0001c3b0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+0001c3c0: 7461 6765 5f69 735f 636f 6d70 7573 7461  tage_is_compusta
+0001c3d0: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+0001c3e0: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+0001c3f0: 6728 6622 436f 6d70 7573 7461 6765 2064  g(f"Compustage d
+0001c400: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001c410: 6c69 6e6b 696e 672e 2229 0a20 2020 2020  linking.").     
+0001c420: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001c430: 6e0a 2020 2020 2020 2020 2020 2020 0a20  n.            . 
+0001c440: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0001c450: 6e67 2e69 6e66 6f28 6622 4c69 6e6b 696e  ng.info(f"Linkin
+0001c460: 6720 7374 6167 652e 2e2e 2229 0a20 2020  g stage...").   
+0001c470: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+0001c480: 6167 652e 6c69 6e6b 2829 2069 6620 7661  age.link() if va
+0001c490: 6c75 6520 656c 7365 2073 656c 662e 7374  lue else self.st
+0001c4a0: 6167 652e 756e 6c69 6e6b 2829 0a20 2020  age.unlink().   
+0001c4b0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0001c4c0: 2e69 6e66 6f28 6622 5374 6167 6520 7b27  .info(f"Stage {'
+0001c4d0: 6c69 6e6b 6564 2720 6966 2076 616c 7565  linked' if value
+0001c4e0: 2065 6c73 6520 2775 6e6c 696e 6b65 6427   else 'unlinked'
+0001c4f0: 7d2e 2229 2020 2020 0a20 2020 2020 2020  }.")    .       
+0001c500: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0001c510: 2020 2020 0a20 2020 2020 2020 2023 2063      .        # c
+0001c520: 6861 6d62 6572 2070 726f 7065 7274 6965  hamber propertie
+0001c530: 730a 2020 2020 2020 2020 6966 206b 6579  s.        if key
+0001c540: 203d 3d20 2270 756d 705f 6368 616d 6265   == "pump_chambe
+0001c550: 7222 3a0a 2020 2020 2020 2020 2020 2020  r":.            
+0001c560: 6966 2076 616c 7565 3a0a 2020 2020 2020  if value:.      
+0001c570: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+0001c580: 672e 696e 666f 2866 2250 756d 7069 6e67  g.info(f"Pumping
+0001c590: 2063 6861 6d62 6572 2e2e 2e22 290a 2020   chamber...").  
+0001c5a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001c5b0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 7661  lf.connection.va
+0001c5c0: 6375 756d 2e70 756d 7028 290a 2020 2020  cuum.pump().    
+0001c5d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0001c5e0: 696e 672e 696e 666f 2866 2243 6861 6d62  ing.info(f"Chamb
+0001c5f0: 6572 2070 756d 7065 642e 2229 200a 2020  er pumped.") .  
+0001c600: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001c610: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0001c620: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001c630: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
+0001c640: 6172 6e69 6e67 2866 2249 6e76 616c 6964  arning(f"Invalid
+0001c650: 2076 616c 7565 2066 6f72 2070 756d 705f   value for pump_
+0001c660: 6368 616d 6265 723a 207b 7661 6c75 657d  chamber: {value}
+0001c670: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0001c680: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+0001c690: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001c6a0: 6966 206b 6579 203d 3d20 2276 656e 745f  if key == "vent_
+0001c6b0: 6368 616d 6265 7222 3a0a 2020 2020 2020  chamber":.      
+0001c6c0: 2020 2020 2020 6966 2076 616c 7565 3a0a        if value:.
+0001c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6e0: 6c6f 6767 696e 672e 696e 666f 2866 2256  logging.info(f"V
+0001c6f0: 656e 7469 6e67 2063 6861 6d62 6572 2e2e  enting chamber..
+0001c700: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0001c710: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0001c720: 696f 6e2e 7661 6375 756d 2e76 656e 7428  ion.vacuum.vent(
+0001c730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001c740: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+0001c750: 2243 6861 6d62 6572 2076 656e 7465 642e  "Chamber vented.
+0001c760: 2229 200a 2020 2020 2020 2020 2020 2020  ") .            
+0001c770: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+0001c780: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001c790: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0001c7a0: 6769 6e67 2e77 6172 6e69 6e67 2866 2249  ging.warning(f"I
+0001c7b0: 6e76 616c 6964 2076 616c 7565 2066 6f72  nvalid value for
+0001c7c0: 2076 656e 745f 6368 616d 6265 723a 207b   vent_chamber: {
+0001c7d0: 7661 6c75 657d 2e22 290a 2020 2020 2020  value}.").      
+0001c7e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001c7f0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+0001c800: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
+0001c810: 726e 696e 6728 6622 556e 6b6e 6f77 6e20  rning(f"Unknown 
+0001c820: 6b65 793a 207b 6b65 797d 2028 7b62 6561  key: {key} ({bea
+0001c830: 6d5f 7479 7065 7d29 2229 0a0a 2020 2020  m_type})")..    
+0001c840: 2020 2020 7265 7475 726e 0a20 2020 200a      return.    .
+0001c850: 2020 2020 6465 6620 6368 6563 6b5f 6176      def check_av
+0001c860: 6169 6c61 626c 655f 7661 6c75 6573 2873  ailable_values(s
+0001c870: 656c 662c 206b 6579 3a73 7472 2c20 7661  elf, key:str, va
+0001c880: 6c75 6573 3a20 6c69 7374 2c20 6265 616d  lues: list, beam
+0001c890: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
+0001c8a0: 3d20 4e6f 6e65 2920 2d3e 2062 6f6f 6c3a  = None) -> bool:
+0001c8b0: 0a0a 2020 2020 2020 2020 6176 6169 6c61  ..        availa
+0001c8c0: 626c 655f 7661 6c75 6573 203d 2073 656c  ble_values = sel
+0001c8d0: 662e 6765 745f 6176 6169 6c61 626c 655f  f.get_available_
+0001c8e0: 7661 6c75 6573 286b 6579 2c20 6265 616d  values(key, beam
+0001c8f0: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
+0001c900: 6966 2061 7661 696c 6162 6c65 5f76 616c  if available_val
+0001c910: 7565 7320 6973 204e 6f6e 653a 0a20 2020  ues is None:.   
+0001c920: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001c930: 4661 6c73 650a 2020 2020 2020 2020 0a20  False.        . 
+0001c940: 2020 2020 2020 2066 6f72 2076 616c 7565         for value
+0001c950: 2069 6e20 7661 6c75 6573 3a0a 2020 2020   in values:.    
+0001c960: 2020 2020 2020 2020 6966 2076 616c 7565          if value
+0001c970: 206e 6f74 2069 6e20 6176 6169 6c61 626c   not in availabl
+0001c980: 655f 7661 6c75 6573 3a0a 2020 2020 2020  e_values:.      
+0001c990: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001c9a0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+0001c9b0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0001c9c0: 6528 7661 6c75 652c 2066 6c6f 6174 293a  e(value, float):
+0001c9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c9e0: 2069 6620 7661 6c75 6520 3c20 6d69 6e28   if value < min(
+0001c9f0: 6176 6169 6c61 626c 655f 7661 6c75 6573  available_values
+0001ca00: 2920 6f72 2076 616c 7565 203e 206d 6178  ) or value > max
+0001ca10: 2861 7661 696c 6162 6c65 5f76 616c 7565  (available_value
+0001ca20: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0001ca30: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+0001ca40: 616c 7365 0a20 2020 2020 2020 2072 6574  alse.        ret
+0001ca50: 7572 6e20 5472 7565 0a20 2020 200a 0a63  urn True.    ..c
+0001ca60: 6c61 7373 2054 6573 6361 6e4d 6963 726f  lass TescanMicro
+0001ca70: 7363 6f70 6528 4669 6273 656d 4d69 6372  scope(FibsemMicr
+0001ca80: 6f73 636f 7065 293a 0a20 2020 2022 2222  oscope):.    """
+0001ca90: 0a20 2020 2041 2063 6c61 7373 2072 6570  .    A class rep
+0001caa0: 7265 7365 6e74 696e 6720 6120 5445 5343  resenting a TESC
+0001cab0: 414e 2046 4942 2d53 454d 206d 6963 726f  AN FIB-SEM micro
+0001cac0: 7363 6f70 652e 0a0a 2020 2020 5468 6973  scope...    This
+0001cad0: 2063 6c61 7373 2069 6e68 6572 6974 7320   class inherits 
+0001cae0: 6672 6f6d 2074 6865 2061 6273 7472 6163  from the abstrac
+0001caf0: 7420 6261 7365 2063 6c61 7373 2060 4669  t base class `Fi
+0001cb00: 6273 656d 4d69 6372 6f73 636f 7065 602c  bsemMicroscope`,
+0001cb10: 2077 6869 6368 2064 6566 696e 6573 2074   which defines t
+0001cb20: 6865 2063 6f72 6520 6675 6e63 7469 6f6e  he core function
+0001cb30: 616c 6974 7920 6f66 2061 0a20 2020 206d  ality of a.    m
+0001cb40: 6963 726f 7363 6f70 652e 2049 6e20 6164  icroscope. In ad
+0001cb50: 6469 7469 6f6e 2074 6f20 7468 6520 6d65  dition to the me
+0001cb60: 7468 6f64 7320 6465 6669 6e65 6420 696e  thods defined in
+0001cb70: 2074 6865 2062 6173 6520 636c 6173 732c   the base class,
+0001cb80: 2074 6869 7320 636c 6173 7320 7072 6f76   this class prov
+0001cb90: 6964 6573 2061 6464 6974 696f 6e61 6c20  ides additional 
+0001cba0: 6d65 7468 6f64 7320 7370 6563 6966 6963  methods specific
+0001cbb0: 0a20 2020 2074 6f20 7468 6520 5445 5343  .    to the TESC
+0001cbc0: 414e 2046 4942 2d53 454d 206d 6963 726f  AN FIB-SEM micro
+0001cbd0: 7363 6f70 652e 0a0a 2020 2020 4174 7472  scope...    Attr
+0001cbe0: 6962 7574 6573 3a0a 2020 2020 2020 2020  ibutes:.        
+0001cbf0: 636f 6e6e 6563 7469 6f6e 2028 4175 746f  connection (Auto
+0001cc00: 6d61 7469 6f6e 293a 2054 6865 206d 6963  mation): The mic
+0001cc10: 726f 7363 6f70 6520 636c 6965 6e74 2063  roscope client c
+0001cc20: 6f6e 6e65 6374 696f 6e2e 0a20 2020 2020  onnection..     
+0001cc30: 2020 2069 6f6e 5f64 6574 6563 746f 725f     ion_detector_
+0001cc40: 6163 7469 7665 2028 4175 746f 6d61 7469  active (Automati
+0001cc50: 6f6e 2e46 4942 2e44 6574 6563 746f 7229  on.FIB.Detector)
+0001cc60: 3a20 5468 6520 6163 7469 7665 2069 6f6e  : The active ion
+0001cc70: 2062 6561 6d20 6465 7465 6374 6f72 2e0a   beam detector..
+0001cc80: 2020 2020 2020 2020 6c61 7374 5f69 6d61          last_ima
+0001cc90: 6765 5f65 6220 2846 6962 7365 6d49 6d61  ge_eb (FibsemIma
+0001cca0: 6765 293a 2041 2073 6176 6564 2063 6f70  ge): A saved cop
+0001ccb0: 7920 6f66 2074 6865 206d 6f73 7420 7265  y of the most re
+0001ccc0: 6365 6e74 2065 6c65 6374 726f 6e20 6265  cent electron be
+0001ccd0: 616d 2069 6d61 6765 2e0a 2020 2020 2020  am image..      
+0001cce0: 2020 6c61 7374 5f69 6d61 6765 5f69 6220    last_image_ib 
+0001ccf0: 2846 6962 7365 6d49 6d61 6765 293a 2041  (FibsemImage): A
+0001cd00: 2073 6176 6564 2063 6f70 7920 6f66 2074   saved copy of t
+0001cd10: 6865 206d 6f73 7420 7265 6365 6e74 2069  he most recent i
+0001cd20: 6f6e 2062 6561 6d20 696d 6167 652e 0a0a  on beam image...
+0001cd30: 2020 2020 496e 6865 7269 7465 6420 4d65      Inherited Me
+0001cd40: 7468 6f64 733a 0a20 2020 2020 2020 2063  thods:.        c
+0001cd50: 6f6e 6e65 6374 5f74 6f5f 6d69 6372 6f73  onnect_to_micros
+0001cd60: 636f 7065 2873 656c 662c 2069 705f 6164  cope(self, ip_ad
+0001cd70: 6472 6573 733a 2073 7472 2c20 706f 7274  dress: str, port
+0001cd80: 3a20 696e 7420 3d20 3735 3230 2920 2d3e  : int = 7520) ->
+0001cd90: 204e 6f6e 653a 200a 2020 2020 2020 2020   None: .        
+0001cda0: 2020 2020 436f 6e6e 6563 7420 746f 2061      Connect to a
+0001cdb0: 2054 6865 726d 6f20 4669 7368 6572 206d   Thermo Fisher m
+0001cdc0: 6963 726f 7363 6f70 6520 6174 2074 6865  icroscope at the
+0001cdd0: 2073 7065 6369 6669 6564 2049 5020 6164   specified IP ad
+0001cde0: 6472 6573 7320 616e 6420 706f 7274 2e0a  dress and port..
+0001cdf0: 0a20 2020 2020 2020 2064 6973 636f 6e6e  .        disconn
+0001ce00: 6563 7428 7365 6c66 2920 2d3e 204e 6f6e  ect(self) -> Non
+0001ce10: 653a 200a 2020 2020 2020 2020 2020 2020  e: .            
+0001ce20: 4469 7363 6f6e 6e65 6374 7320 7468 6520  Disconnects the 
+0001ce30: 6d69 6372 6f73 636f 7065 2063 6c69 656e  microscope clien
+0001ce40: 7420 636f 6e6e 6563 7469 6f6e 2e0a 0a20  t connection... 
+0001ce50: 2020 2020 2020 2061 6371 7569 7265 5f69         acquire_i
+0001ce60: 6d61 6765 2873 656c 662c 2069 6d61 6765  mage(self, image
+0001ce70: 5f73 6574 7469 6e67 733a 2049 6d61 6765  _settings: Image
+0001ce80: 5365 7474 696e 6773 2920 2d3e 2046 6962  Settings) -> Fib
+0001ce90: 7365 6d49 6d61 6765 3a20 0a20 2020 2020  semImage: .     
+0001cea0: 2020 2020 2020 2041 6371 7569 7265 2061         Acquire a
+0001ceb0: 206e 6577 2069 6d61 6765 2077 6974 6820   new image with 
+0001cec0: 7468 6520 7370 6563 6966 6965 6420 7365  the specified se
+0001ced0: 7474 696e 6773 2e0a 0a20 2020 2020 2020  ttings...       
+0001cee0: 206c 6173 745f 696d 6167 6528 7365 6c66   last_image(self
+0001cef0: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+0001cf00: 6d54 7970 6520 3d20 4265 616d 5479 7065  mType = BeamType
+0001cf10: 2e45 4c45 4354 524f 4e29 202d 3e20 4669  .ELECTRON) -> Fi
+0001cf20: 6273 656d 496d 6167 653a 200a 2020 2020  bsemImage: .    
+0001cf30: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
+0001cf40: 6c61 7374 2070 7265 7669 6f75 736c 7920  last previously 
+0001cf50: 6163 7175 6972 6564 2069 6d61 6765 2e0a  acquired image..
+0001cf60: 0a20 2020 2020 2020 2061 7574 6f63 6f6e  .        autocon
+0001cf70: 7472 6173 7428 7365 6c66 2c20 6265 616d  trast(self, beam
+0001cf80: 5f74 7970 653d 4265 616d 5479 7065 2e45  _type=BeamType.E
+0001cf90: 4c45 4354 524f 4e29 202d 3e20 4e6f 6e65  LECTRON) -> None
+0001cfa0: 3a20 0a20 2020 2020 2020 2020 2020 2041  : .            A
+0001cfb0: 7574 6f6d 6174 6963 616c 6c79 2061 646a  utomatically adj
+0001cfc0: 7573 7420 7468 6520 6d69 6372 6f73 636f  ust the microsco
+0001cfd0: 7065 2069 6d61 6765 2063 6f6e 7472 6173  pe image contras
+0001cfe0: 7420 666f 7220 7468 6520 7370 6563 6966  t for the specif
+0001cff0: 6965 6420 6265 616d 2074 7970 652e 0a0a  ied beam type...
+0001d000: 2020 2020 2020 2020 6175 746f 5f66 6f63          auto_foc
+0001d010: 7573 2873 656c 662c 2062 6561 6d5f 7479  us(self, beam_ty
+0001d020: 7065 3a20 4265 616d 5479 7065 2920 2d3e  pe: BeamType) ->
+0001d030: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001d040: 2020 2041 7574 6f6d 6174 6963 616c 6c79     Automatically
+0001d050: 2061 646a 7573 7420 7468 6520 6d69 6372   adjust the micr
+0001d060: 6f73 636f 7065 2066 6f63 7573 2066 6f72  oscope focus for
+0001d070: 2074 6865 2073 7065 6369 6669 6564 2062   the specified b
+0001d080: 6561 6d20 7479 7065 2e0a 0a20 2020 2020  eam type...     
+0001d090: 2020 2062 6561 6d5f 7368 6966 7428 7365     beam_shift(se
+0001d0a0: 6c66 2c20 6478 3a20 666c 6f61 742c 2064  lf, dx: float, d
+0001d0b0: 793a 2066 6c6f 6174 2c20 2062 6561 6d5f  y: float,  beam_
+0001d0c0: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+0001d0d0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0001d0e0: 2020 2020 2041 646a 7573 7473 2074 6865       Adjusts the
+0001d0f0: 2062 6561 6d20 7368 6966 7420 6f66 2067   beam shift of g
+0001d100: 6976 656e 2062 6561 6d20 6261 7365 6420  iven beam based 
+0001d110: 6f6e 2072 656c 6174 6976 6520 7661 6c75  on relative valu
+0001d120: 6573 2074 6861 7420 6172 6520 7072 6f76  es that are prov
+0001d130: 6964 6564 2e0a 0a20 2020 2020 2020 206d  ided...        m
+0001d140: 6f76 655f 7374 6167 655f 6162 736f 6c75  ove_stage_absolu
+0001d150: 7465 2873 656c 662c 2070 6f73 6974 696f  te(self, positio
+0001d160: 6e3a 2046 6962 7365 6d53 7461 6765 506f  n: FibsemStagePo
+0001d170: 7369 7469 6f6e 293a 0a20 2020 2020 2020  sition):.       
+0001d180: 2020 2020 204d 6f76 6520 7468 6520 7374       Move the st
+0001d190: 6167 6520 746f 2074 6865 2073 7065 6369  age to the speci
+0001d1a0: 6669 6564 2063 6f6f 7264 696e 6174 6573  fied coordinates
+0001d1b0: 2e0a 0a20 2020 2020 2020 206d 6f76 655f  ...        move_
+0001d1c0: 7374 6167 655f 7265 6c61 7469 7665 2873  stage_relative(s
+0001d1d0: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
+0001d1e0: 6962 7365 6d53 7461 6765 506f 7369 7469  ibsemStagePositi
+0001d1f0: 6f6e 293a 0a20 2020 2020 2020 2020 2020  on):.           
+0001d200: 204d 6f76 6520 7468 6520 7374 6167 6520   Move the stage 
+0001d210: 6279 2074 6865 2073 7065 6369 6669 6564  by the specified
+0001d220: 2072 656c 6174 6976 6520 6d6f 7665 2e0a   relative move..
+0001d230: 0a20 2020 2020 2020 2073 7461 626c 655f  .        stable_
+0001d240: 6d6f 7665 2873 656c 662c 2064 783a 2066  move(self, dx: f
+0001d250: 6c6f 6174 2c20 6479 3a20 666c 6f61 742c  loat, dy: float,
+0001d260: 2062 6561 6d5f 7479 7065 3a20 4265 616d   beam_type: Beam
+0001d270: 5479 7065 2c29 202d 3e20 4e6f 6e65 3a0a  Type,) -> None:.
+0001d280: 2020 2020 2020 2020 2020 2020 4361 6c63              Calc
+0001d290: 756c 6174 6520 7468 6520 636f 7272 6563  ulate the correc
+0001d2a0: 7465 6420 7374 6167 6520 6d6f 7665 6d65  ted stage moveme
+0001d2b0: 6e74 7320 6261 7365 6420 6f6e 2074 6865  nts based on the
+0001d2c0: 2062 6561 6d5f 7479 7065 2c20 616e 6420   beam_type, and 
+0001d2d0: 7468 656e 206d 6f76 6520 7468 6520 7374  then move the st
+0001d2e0: 6167 6520 7265 6c61 7469 7665 6c79 2e0a  age relatively..
+0001d2f0: 0a20 2020 2020 2020 2076 6572 7469 6361  .        vertica
+0001d300: 6c5f 6d6f 7665 2873 656c 662c 2064 793a  l_move(self, dy:
+0001d310: 2066 6c6f 6174 2c20 6478 3a20 666c 6f61   float, dx: floa
+0001d320: 7420 3d20 302e 302c 2073 7461 7469 635f  t = 0.0, static_
+0001d330: 7764 3a20 626f 6f6c 203d 2054 7275 6529  wd: bool = True)
+0001d340: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001d350: 2020 2020 2020 4d6f 7665 2074 6865 2073        Move the s
+0001d360: 7461 6765 2076 6572 7469 6361 6c6c 7920  tage vertically 
+0001d370: 746f 2063 6f72 7265 6374 2065 7563 656e  to correct eucen
+0001d380: 7472 6963 2070 6f69 6e74 0a20 2020 2020  tric point.     
+0001d390: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0001d3a0: 2020 2020 696e 7365 7274 5f6d 616e 6970      insert_manip
+0001d3b0: 756c 6174 6f72 2873 656c 662c 206e 616d  ulator(self, nam
+0001d3c0: 653a 2073 7472 2920 2d3e 204e 6f6e 653a  e: str) -> None:
+0001d3d0: 0a20 2020 2020 2020 2020 2020 2049 6e73  .            Ins
+0001d3e0: 6572 7420 7468 6520 6d61 6e69 7075 6c61  ert the manipula
+0001d3f0: 746f 7220 696e 746f 2074 6865 2073 616d  tor into the sam
+0001d400: 706c 652e 0a20 2020 2020 2020 200a 2020  ple..        .  
+0001d410: 2020 2020 2020 7265 7472 6163 745f 6d61        retract_ma
+0001d420: 6e69 7075 6c61 746f 7228 7365 6c66 2920  nipulator(self) 
+0001d430: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0001d440: 2020 2020 2052 6574 7261 6374 2074 6865       Retract the
+0001d450: 206d 616e 6970 756c 6174 6f72 2066 726f   manipulator fro
+0001d460: 6d20 7468 6520 7361 6d70 6c65 2e0a 0a20  m the sample... 
+0001d470: 2020 2020 2020 206d 6f76 655f 6d61 6e69         move_mani
+0001d480: 7075 6c61 746f 725f 7265 6c61 7469 7665  pulator_relative
+0001d490: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
+0001d4a0: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+0001d4b0: 6f72 506f 7369 7469 6f6e 2920 2d3e 204e  orPosition) -> N
+0001d4c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001d4d0: 204d 6f76 6520 7468 6520 6d61 6e69 7075   Move the manipu
+0001d4e0: 6c61 746f 7220 6279 2074 6865 2073 7065  lator by the spe
+0001d4f0: 6369 6669 6564 2072 656c 6174 6976 6520  cified relative 
+0001d500: 6d6f 7665 2e0a 2020 2020 2020 2020 0a20  move..        . 
+0001d510: 2020 2020 2020 206d 6f76 655f 6d61 6e69         move_mani
+0001d520: 7075 6c61 746f 725f 6162 736f 6c75 7465  pulator_absolute
+0001d530: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
+0001d540: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+0001d550: 6f72 506f 7369 7469 6f6e 2920 2d3e 204e  orPosition) -> N
+0001d560: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001d570: 204d 6f76 6520 7468 6520 6d61 6e69 7075   Move the manipu
+0001d580: 6c61 746f 7220 746f 2074 6865 2073 7065  lator to the spe
+0001d590: 6369 6669 6564 2063 6f6f 7264 696e 6174  cified coordinat
+0001d5a0: 6573 2e0a 0a20 2020 2020 2020 206d 6f76  es...        mov
+0001d5b0: 655f 6d61 6e69 7075 6c61 746f 725f 636f  e_manipulator_co
+0001d5c0: 7272 6563 7465 6428 7365 6c66 2c20 6478  rrected(self, dx
+0001d5d0: 3a20 666c 6f61 742c 2064 793a 2066 6c6f  : float, dy: flo
+0001d5e0: 6174 2c20 6265 616d 5f74 7970 653a 2042  at, beam_type: B
+0001d5f0: 6561 6d54 7970 6529 202d 3e20 4e6f 6e65  eamType) -> None
+0001d600: 3a0a 2020 2020 2020 2020 2020 2020 4d6f  :.            Mo
+0001d610: 7665 2074 6865 206d 616e 6970 756c 6174  ve the manipulat
+0001d620: 6f72 2062 7920 7468 6520 7370 6563 6966  or by the specif
+0001d630: 6965 6420 7265 6c61 7469 7665 206d 6f76  ied relative mov
+0001d640: 652c 2063 6f72 7265 6374 696e 6720 666f  e, correcting fo
+0001d650: 7220 7468 6520 6265 616d 2074 7970 652e  r the beam type.
+0001d660: 2020 2020 2020 0a0a 2020 2020 2020 2020        ..        
+0001d670: 6d6f 7665 5f6d 616e 6970 756c 6174 6f72  move_manipulator
+0001d680: 5f74 6f5f 706f 7369 7469 6f6e 5f6f 6666  _to_position_off
+0001d690: 7365 7428 7365 6c66 2c20 6f66 6673 6574  set(self, offset
+0001d6a0: 3a20 4669 6273 656d 4d61 6e69 7075 6c61  : FibsemManipula
+0001d6b0: 746f 7250 6f73 6974 696f 6e2c 206e 616d  torPosition, nam
+0001d6c0: 653a 2073 7472 2920 2d3e 204e 6f6e 653a  e: str) -> None:
+0001d6d0: 0a20 2020 2020 2020 2020 2020 204d 6f76  .            Mov
+0001d6e0: 6520 7468 6520 6d61 6e69 7075 6c61 746f  e the manipulato
+0001d6f0: 7220 746f 2074 6865 2073 7065 6369 6669  r to the specifi
+0001d700: 6564 2070 6f73 6974 696f 6e20 6f66 6673  ed position offs
+0001d710: 6574 2e0a 0a20 2020 2020 2020 205f 6765  et...        _ge
+0001d720: 745f 7361 7665 645f 6d61 6e69 7075 6c61  t_saved_manipula
+0001d730: 746f 725f 706f 7369 7469 6f6e 2873 656c  tor_position(sel
+0001d740: 662c 206e 616d 653a 2073 7472 2920 2d3e  f, name: str) ->
+0001d750: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+0001d760: 6f72 506f 7369 7469 6f6e 3a0a 2020 2020  orPosition:.    
+0001d770: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
+0001d780: 7361 7665 6420 6d61 6e69 7075 6c61 746f  saved manipulato
+0001d790: 7220 706f 7369 7469 6f6e 2077 6974 6820  r position with 
+0001d7a0: 7468 6520 7370 6563 6966 6965 6420 6e61  the specified na
+0001d7b0: 6d65 2e0a 2020 2020 2020 2020 7365 7475  me..        setu
+0001d7c0: 705f 6d69 6c6c 696e 6728 7365 6c66 2c20  p_milling(self, 
+0001d7d0: 6d69 6c6c 5f73 6574 7469 6e67 733a 2046  mill_settings: F
+0001d7e0: 6962 7365 6d4d 696c 6c69 6e67 5365 7474  ibsemMillingSett
+0001d7f0: 696e 6773 293a 0a20 2020 2020 2020 2020  ings):.         
+0001d800: 2020 2043 6f6e 6669 6775 7265 2074 6865     Configure the
+0001d810: 206d 6963 726f 7363 6f70 6520 666f 7220   microscope for 
+0001d820: 6d69 6c6c 696e 6720 7573 696e 6720 7468  milling using th
+0001d830: 6520 696f 6e20 6265 616d 2e0a 0a20 2020  e ion beam...   
+0001d840: 2020 2020 2072 756e 5f6d 696c 6c69 6e67       run_milling
+0001d850: 2873 656c 662c 206d 696c 6c69 6e67 5f63  (self, milling_c
+0001d860: 7572 7265 6e74 3a20 666c 6f61 742c 2061  urrent: float, a
+0001d870: 7379 6e63 683a 2062 6f6f 6c20 3d20 4661  synch: bool = Fa
+0001d880: 6c73 6529 3a0a 2020 2020 2020 2020 2020  lse):.          
+0001d890: 2020 5275 6e20 696f 6e20 6265 616d 206d    Run ion beam m
+0001d8a0: 696c 6c69 6e67 2075 7369 6e67 2074 6865  illing using the
+0001d8b0: 2073 7065 6369 6669 6564 206d 696c 6c69   specified milli
+0001d8c0: 6e67 2063 7572 7265 6e74 2e0a 0a20 2020  ng current...   
+0001d8d0: 2020 2020 2064 6566 2072 756e 5f6d 696c       def run_mil
+0001d8e0: 6c69 6e67 5f64 7269 6674 5f63 6f72 7265  ling_drift_corre
+0001d8f0: 6374 6564 2873 656c 662c 206d 696c 6c69  cted(self, milli
+0001d900: 6e67 5f63 7572 7265 6e74 3a20 666c 6f61  ng_current: floa
+0001d910: 742c 2069 6d61 6765 5f73 6574 7469 6e67  t, image_setting
+0001d920: 733a 2049 6d61 6765 5365 7474 696e 6773  s: ImageSettings
+0001d930: 2c20 7265 665f 696d 6167 653a 2046 6962  , ref_image: Fib
+0001d940: 7365 6d49 6d61 6765 2c20 7265 6475 6365  semImage, reduce
+0001d950: 645f 6172 6561 3a20 4669 6273 656d 5265  d_area: FibsemRe
+0001d960: 6374 616e 676c 6520 3d20 4e6f 6e65 2c20  ctangle = None, 
+0001d970: 6173 796e 6368 3a20 626f 6f6c 203d 2046  asynch: bool = F
+0001d980: 616c 7365 293a 0a20 2020 2020 2020 2052  alse):.        R
+0001d990: 756e 2069 6f6e 2062 6561 6d20 6d69 6c6c  un ion beam mill
+0001d9a0: 696e 6720 7573 696e 6720 7468 6520 7370  ing using the sp
+0001d9b0: 6563 6966 6965 6420 6d69 6c6c 696e 6720  ecified milling 
+0001d9c0: 6375 7272 656e 742c 2061 6e64 2063 6f72  current, and cor
+0001d9d0: 7265 6374 2066 6f72 2064 7269 6674 2075  rect for drift u
+0001d9e0: 7369 6e67 2074 6865 2070 726f 7669 6465  sing the provide
+0001d9f0: 6420 7265 6665 7265 6e63 6520 696d 6167  d reference imag
+0001da00: 652e 0a0a 2020 2020 2020 2020 6669 6e69  e...        fini
+0001da10: 7368 5f6d 696c 6c69 6e67 2873 656c 662c  sh_milling(self,
+0001da20: 2069 6d61 6769 6e67 5f63 7572 7265 6e74   imaging_current
+0001da30: 3a20 666c 6f61 7429 3a0a 2020 2020 2020  : float):.      
+0001da40: 2020 2020 2020 4669 6e61 6c69 7365 7320        Finalises 
+0001da50: 7468 6520 6d69 6c6c 696e 6720 7072 6f63  the milling proc
+0001da60: 6573 7320 6279 2063 6c65 6172 696e 6720  ess by clearing 
+0001da70: 7468 6520 6d69 6372 6f73 636f 7065 206f  the microscope o
+0001da80: 6620 616e 7920 7061 7474 6572 6e73 2061  f any patterns a
+0001da90: 6e64 2072 6574 7572 6e69 6e67 2074 6865  nd returning the
+0001daa0: 2063 7572 7265 6e74 2074 6f20 7468 6520   current to the 
+0001dab0: 696d 6167 696e 6720 6375 7272 656e 742e  imaging current.
+0001dac0: 0a0a 2020 2020 2020 2020 7365 7475 705f  ..        setup_
+0001dad0: 7370 7574 7465 7228 7365 6c66 2c20 7072  sputter(self, pr
+0001dae0: 6f74 6f63 6f6c 3a20 6469 6374 293a 0a20  otocol: dict):. 
+0001daf0: 2020 2020 2020 2020 2020 2053 6574 2075             Set u
+0001db00: 7020 7468 6520 7370 7574 7465 7220 636f  p the sputter co
+0001db10: 6174 696e 6720 7072 6f63 6573 7320 6f6e  ating process on
+0001db20: 2074 6865 206d 6963 726f 7363 6f70 652e   the microscope.
+0001db30: 0a0a 2020 2020 2020 2020 6472 6177 5f73  ..        draw_s
+0001db40: 7075 7474 6572 5f70 6174 7465 726e 2873  putter_pattern(s
+0001db50: 656c 662c 2068 6677 3a20 666c 6f61 742c  elf, hfw: float,
+0001db60: 206c 696e 655f 7061 7474 6572 6e5f 6c65   line_pattern_le
+0001db70: 6e67 7468 3a20 666c 6f61 742c 2073 7075  ngth: float, spu
+0001db80: 7474 6572 5f74 696d 653a 2066 6c6f 6174  tter_time: float
+0001db90: 293a 0a20 2020 2020 2020 2020 2020 2044  ):.            D
+0001dba0: 7261 7773 2061 206c 696e 6520 7061 7474  raws a line patt
+0001dbb0: 6572 6e20 666f 7220 7370 7574 7465 7269  ern for sputteri
+0001dbc0: 6e67 2077 6974 6820 7468 6520 6769 7665  ng with the give
+0001dbd0: 6e20 7061 7261 6d65 7465 7273 2e0a 0a20  n parameters... 
+0001dbe0: 2020 2020 2020 2072 756e 5f73 7075 7474         run_sputt
+0001dbf0: 6572 2873 656c 662c 202a 2a6b 7761 7267  er(self, **kwarg
+0001dc00: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0001dc10: 5275 6e73 2074 6865 2047 4953 2050 6c61  Runs the GIS Pla
+0001dc20: 7469 6e75 6d20 5370 7574 7465 722e 0a0a  tinum Sputter...
+0001dc30: 2020 2020 2020 2020 6669 6e69 7368 5f73          finish_s
+0001dc40: 7075 7474 6572 2873 656c 662c 2061 7070  putter(self, app
+0001dc50: 6c69 6361 7469 6f6e 5f66 696c 653a 2073  lication_file: s
+0001dc60: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+0001dc70: 2020 2020 2020 2020 2046 696e 6973 6820           Finish 
+0001dc80: 7468 6520 7370 7574 7465 7220 7072 6f63  the sputter proc
+0001dc90: 6573 7320 6279 2063 6c65 6172 696e 6720  ess by clearing 
+0001dca0: 7061 7474 6572 6e73 2061 6e64 2072 6573  patterns and res
+0001dcb0: 6574 7469 6e67 2062 6561 6d20 616e 6420  etting beam and 
+0001dcc0: 696d 6167 696e 6720 7365 7474 696e 6773  imaging settings
+0001dcd0: 2e0a 0a20 2020 2020 2020 2073 6574 5f6d  ...        set_m
+0001dce0: 6963 726f 7363 6f70 655f 7374 6174 6528  icroscope_state(
+0001dcf0: 7365 6c66 2c20 6d69 6372 6f73 636f 7065  self, microscope
+0001dd00: 5f73 7461 7465 3a20 4d69 6372 6f73 636f  _state: Microsco
+0001dd10: 7065 5374 6174 6529 202d 3e20 4e6f 6e65  peState) -> None
+0001dd20: 3a0a 2020 2020 2020 2020 2020 2020 5265  :.            Re
+0001dd30: 7365 7420 7468 6520 6d69 6372 6f73 636f  set the microsco
+0001dd40: 7065 2073 7461 7465 2074 6f20 7468 6520  pe state to the 
+0001dd50: 7072 6f76 6964 6564 2073 7461 7465 2e0a  provided state..
+0001dd60: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0001dd70: 2067 6574 2873 656c 662c 206b 6579 3a73   get(self, key:s
+0001dd80: 7472 2c20 6265 616d 5f74 7970 653a 2042  tr, beam_type: B
+0001dd90: 6561 6d54 7970 6520 3d20 4e6f 6e65 293a  eamType = None):
+0001dda0: 0a20 2020 2020 2020 2020 2020 2052 6574  .            Ret
+0001ddb0: 7572 6e73 2074 6865 2076 616c 7565 206f  urns the value o
+0001ddc0: 6620 7468 6520 7370 6563 6966 6965 6420  f the specified 
+0001ddd0: 6b65 792e 0a0a 2020 2020 2020 2020 7365  key...        se
+0001dde0: 7428 7365 6c66 2c20 6b65 793a 2073 7472  t(self, key: str
+0001ddf0: 2c20 7661 6c75 652c 2062 6561 6d5f 7479  , value, beam_ty
+0001de00: 7065 3a20 4265 616d 5479 7065 203d 204e  pe: BeamType = N
+0001de10: 6f6e 6529 202d 3e20 4e6f 6e65 3a0a 2020  one) -> None:.  
+0001de20: 2020 2020 2020 2020 2020 5365 7473 2074            Sets t
+0001de30: 6865 2076 616c 7565 206f 6620 7468 6520  he value of the 
+0001de40: 7370 6563 6966 6965 6420 6b65 792e 0a0a  specified key...
+0001de50: 2020 2020 4e65 7720 6d65 7468 6f64 733a      New methods:
+0001de60: 0a20 2020 2020 2020 205f 5f69 6e69 745f  .        __init_
+0001de70: 5f28 7365 6c66 293a 200a 2020 2020 2020  _(self): .      
+0001de80: 2020 2020 2020 496e 6974 6961 6c69 7a65        Initialize
+0001de90: 7320 6120 6e65 7720 696e 7374 616e 6365  s a new instance
+0001dea0: 206f 6620 7468 6520 636c 6173 732e 0a0a   of the class...
+0001deb0: 2020 2020 2020 2020 5f67 6574 5f65 625f          _get_eb_
+0001dec0: 696d 6167 6528 7365 6c66 2c20 696d 6167  image(self, imag
+0001ded0: 655f 7365 7474 696e 6773 3d49 6d61 6765  e_settings=Image
+0001dee0: 5365 7474 696e 6773 2920 2d3e 2046 6962  Settings) -> Fib
+0001def0: 7365 6d49 6d61 6765 3a0a 2020 2020 2020  semImage:.      
+0001df00: 2020 2020 2020 4163 7175 6972 6573 2061        Acquires a
+0001df10: 6e20 656c 6563 7472 6f6e 2062 6561 6d20  n electron beam 
+0001df20: 2845 4229 2069 6d61 6765 2077 6974 6820  (EB) image with 
+0001df30: 7468 6520 6769 7665 6e20 7365 7474 696e  the given settin
+0001df40: 6773 2061 6e64 2072 6574 7572 6e73 2061  gs and returns a
+0001df50: 2046 6962 7365 6d49 6d61 6765 206f 626a   FibsemImage obj
+0001df60: 6563 742e 0a0a 2020 2020 2020 2020 5f67  ect...        _g
+0001df70: 6574 5f69 625f 696d 6167 6528 7365 6c66  et_ib_image(self
+0001df80: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
+0001df90: 3d49 6d61 6765 5365 7474 696e 6773 293a  =ImageSettings):
+0001dfa0: 0a20 2020 2020 2020 2020 2020 2041 6371  .            Acq
+0001dfb0: 7569 7265 7320 616e 2069 6f6e 2062 6561  uires an ion bea
+0001dfc0: 6d20 2849 4229 2069 6d61 6765 2077 6974  m (IB) image wit
+0001dfd0: 6820 7468 6520 6769 7665 6e20 7365 7474  h the given sett
+0001dfe0: 696e 6773 2061 6e64 2072 6574 7572 6e73  ings and returns
+0001dff0: 2061 2046 6962 7365 6d49 6d61 6765 206f   a FibsemImage o
+0001e000: 626a 6563 742e 0a0a 2020 2020 2020 2020  bject...        
+0001e010: 5f79 5f63 6f72 7265 6374 6564 5f73 7461  _y_corrected_sta
+0001e020: 6765 5f6d 6f76 656d 656e 7428 7365 6c66  ge_movement(self
+0001e030: 2c20 6578 7065 6374 6564 5f79 3a20 666c  , expected_y: fl
+0001e040: 6f61 742c 2062 6561 6d5f 7479 7065 3a20  oat, beam_type: 
+0001e050: 4265 616d 5479 7065 203d 2042 6561 6d54  BeamType = BeamT
+0001e060: 7970 652e 454c 4543 5452 4f4e 2920 2d3e  ype.ELECTRON) ->
+0001e070: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
+0001e080: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+0001e090: 2020 4361 6c63 756c 6174 6520 7468 6520    Calculate the 
+0001e0a0: 7920 636f 7272 6563 7465 6420 7374 6167  y corrected stag
+0001e0b0: 6520 6d6f 7665 6d65 6e74 2c20 636f 7272  e movement, corr
+0001e0c0: 6563 7465 6420 666f 7220 7468 6520 6164  ected for the ad
+0001e0d0: 6469 7469 6f6e 616c 2074 696c 7420 6f66  ditional tilt of
+0001e0e0: 2074 6865 2073 616d 706c 6520 686f 6c64   the sample hold
+0001e0f0: 6572 2028 7072 652d 7469 6c74 2061 6e67  er (pre-tilt ang
+0001e100: 6c65 292e 0a20 2020 2022 2222 0a0a 2020  le)..    """..  
+0001e110: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+0001e120: 656c 662c 2073 7973 7465 6d5f 7365 7474  elf, system_sett
+0001e130: 696e 6773 3a20 5379 7374 656d 5365 7474  ings: SystemSett
+0001e140: 696e 6773 2c20 6970 5f61 6464 7265 7373  ings, ip_address
+0001e150: 3a20 7374 7220 3d20 4e6f 6e65 293a 0a20  : str = None):. 
+0001e160: 2020 2020 2020 2069 6620 5f54 4553 4341         if _TESCA
+0001e170: 4e5f 4150 495f 4156 4149 4c41 424c 4520  N_API_AVAILABLE 
+0001e180: 3d3d 2046 616c 7365 3a0a 2020 2020 2020  == False:.      
+0001e190: 2020 2020 2020 7261 6973 6520 496d 706f        raise Impo
+0001e1a0: 7274 4572 726f 7228 2254 6865 2054 4553  rtError("The TES
+0001e1b0: 4341 4e20 4175 746f 6d61 7469 6f6e 2041  CAN Automation A
+0001e1c0: 5049 2069 7320 6e6f 7420 6176 6169 6c61  PI is not availa
+0001e1d0: 626c 652e 2050 6c65 6173 6520 7365 6520  ble. Please see 
+0001e1e0: 7468 6520 7573 6572 2067 7569 6465 2066  the user guide f
+0001e1f0: 6f72 2069 6e73 7461 6c6c 6174 696f 6e20  or installation 
+0001e200: 696e 7374 7275 6374 696f 6e73 2e22 290a  instructions.").
+0001e210: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0001e220: 2069 6620 6970 5f61 6464 7265 7373 2069   if ip_address i
+0001e230: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001e240: 2020 2020 6970 5f61 6464 7265 7373 203d      ip_address =
+0001e250: 2073 7973 7465 6d5f 7365 7474 696e 6773   system_settings
+0001e260: 2e69 6e66 6f2e 6970 5f61 6464 7265 7373  .info.ip_address
+0001e270: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+0001e280: 2020 2320 6372 6561 7465 206d 6963 726f    # create micro
+0001e290: 7363 6f70 6520 636c 6965 6e74 0a20 2020  scope client.   
+0001e2a0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0001e2b0: 7469 6f6e 203d 2041 7574 6f6d 6174 696f  tion = Automatio
+0001e2c0: 6e28 6970 5f61 6464 7265 7373 290a 0a20  n(ip_address).. 
+0001e2d0: 2020 2020 2020 2023 2073 6574 2075 7020         # set up 
+0001e2e0: 6465 7465 6374 6f72 7320 2020 2020 2020  detectors       
+0001e2f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0001e300: 2020 6465 7465 6374 6f72 7320 3d20 7365    detectors = se
+0001e310: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0001e320: 422e 4465 7465 6374 6f72 2e45 6e75 6d28  B.Detector.Enum(
+0001e330: 290a 2020 2020 2020 2020 7365 6c66 2e69  ).        self.i
+0001e340: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
+0001e350: 7665 203d 2064 6574 6563 746f 7273 5b30  ve = detectors[0
+0001e360: 5d0a 2020 2020 2020 2020 7365 6c66 2e63  ].        self.c
+0001e370: 6f6e 6e65 6374 696f 6e2e 4649 422e 4465  onnection.FIB.De
+0001e380: 7465 6374 6f72 2e53 6574 2843 6861 6e6e  tector.Set(Chann
+0001e390: 656c 203d 2030 2c20 4465 7465 6374 6f72  el = 0, Detector
+0001e3a0: 3d20 7365 6c66 2e69 6f6e 5f64 6574 6563  = self.ion_detec
+0001e3b0: 746f 725f 6163 7469 7665 290a 2020 2020  tor_active).    
+0001e3c0: 2020 2020 7365 6c66 2e65 6c65 6374 726f      self.electro
+0001e3d0: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
+0001e3e0: 6520 3d20 7365 6c66 2e63 6f6e 6e65 6374  e = self.connect
+0001e3f0: 696f 6e2e 5345 4d2e 4465 7465 6374 6f72  ion.SEM.Detector
+0001e400: 2e53 4553 7569 7461 626c 6528 290a 2020  .SESuitable().  
+0001e410: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+0001e420: 6374 696f 6e2e 5345 4d2e 4465 7465 6374  ction.SEM.Detect
+0001e430: 6f72 2e53 6574 2843 6861 6e6e 656c 203d  or.Set(Channel =
+0001e440: 2030 2c20 4465 7465 6374 6f72 203d 2073   0, Detector = s
+0001e450: 656c 662e 656c 6563 7472 6f6e 5f64 6574  elf.electron_det
+0001e460: 6563 746f 725f 6163 7469 7665 290a 2020  ector_active).  
+0001e470: 2020 2020 2020 2320 544f 444f 3a20 7265        # TODO: re
+0001e480: 6e61 6d65 2074 6f20 6163 7469 7665 5f64  name to active_d
+0001e490: 6574 6563 746f 725f 6265 616d 5f74 7970  etector_beam_typ
+0001e4a0: 650a 2020 2020 2020 2020 2320 544f 444f  e.        # TODO
+0001e4b0: 3a20 6d6f 7665 2074 6f20 636f 6e6e 6563  : move to connec
+0001e4c0: 745f 746f 5f6d 6963 726f 7363 6f70 650a  t_to_microscope.
+0001e4d0: 0a20 2020 2020 2020 2023 2069 6e69 7469  .        # initi
+0001e4e0: 616c 6973 6520 7379 7374 656d 2073 6574  alise system set
+0001e4f0: 7469 6e67 730a 2020 2020 2020 2020 7365  tings.        se
+0001e500: 6c66 2e73 7973 7465 6d3a 2053 7973 7465  lf.system: Syste
+0001e510: 6d53 6574 7469 6e67 7320 3d20 7379 7374  mSettings = syst
+0001e520: 656d 5f73 6574 7469 6e67 730a 2020 2020  em_settings.    
+0001e530: 2020 2020 0a20 2020 2020 2020 2023 2075      .        # u
+0001e540: 7365 722c 2065 7870 6572 696d 656e 7420  ser, experiment 
+0001e550: 6d65 7461 6461 7461 0a20 2020 2020 2020  metadata.       
+0001e560: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
+0001e570: 6f6e 6365 2064 6220 696e 7465 6772 6174  once db integrat
+0001e580: 6564 0a20 2020 2020 2020 2073 656c 662e  ed.        self.
+0001e590: 7573 6572 203d 2046 6962 7365 6d55 7365  user = FibsemUse
+0001e5a0: 722e 6672 6f6d 5f65 6e76 6972 6f6e 6d65  r.from_environme
+0001e5b0: 6e74 2829 0a20 2020 2020 2020 2073 656c  nt().        sel
+0001e5c0: 662e 6578 7065 7269 6d65 6e74 203d 2046  f.experiment = F
+0001e5d0: 6962 7365 6d45 7870 6572 696d 656e 7428  ibsemExperiment(
+0001e5e0: 290a 0a20 2020 2020 2020 2023 2069 6e69  )..        # ini
+0001e5f0: 7469 616c 6973 6520 6c61 7374 2069 6d61  tialise last ima
+0001e600: 6765 730a 2020 2020 2020 2020 7365 6c66  ges.        self
+0001e610: 2e6c 6173 745f 696d 6167 655f 6562 3a20  .last_image_eb: 
+0001e620: 4669 6273 656d 496d 6167 6520 3d20 4e6f  FibsemImage = No
+0001e630: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+0001e640: 6c61 7374 5f69 6d61 6765 5f69 623a 2046  last_image_ib: F
+0001e650: 6962 7365 6d49 6d61 6765 203d 204e 6f6e  ibsemImage = Non
+0001e660: 650a 0a20 2020 2020 2020 2023 206c 6f67  e..        # log
+0001e670: 6769 6e67 0a20 2020 2020 2020 206c 6f67  ging.        log
+0001e680: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
+0001e690: 223a 2022 6372 6561 7465 5f6d 6963 726f  ": "create_micro
+0001e6a0: 7363 6f70 655f 636c 6965 6e74 222c 2022  scope_client", "
+0001e6b0: 7379 7374 656d 5f73 6574 7469 6e67 7322  system_settings"
+0001e6c0: 3a20 7379 7374 656d 5f73 6574 7469 6e67  : system_setting
+0001e6d0: 732e 746f 5f64 6963 7428 297d 290a 2020  s.to_dict()}).  
+0001e6e0: 2020 0a0a 2020 2020 6465 6620 6469 7363    ..    def disc
+0001e6f0: 6f6e 6e65 6374 2873 656c 6629 202d 3e20  onnect(self) -> 
+0001e700: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+0001e710: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4469  lf.connection.Di
+0001e720: 7363 6f6e 6e65 6374 2829 0a20 2020 2020  sconnect().     
+0001e730: 2020 2064 656c 2073 656c 662e 636f 6e6e     del self.conn
+0001e740: 6563 7469 6f6e 0a20 2020 2020 2020 2073  ection.        s
+0001e750: 656c 662e 636f 6e6e 6563 7469 6f6e 203d  elf.connection =
+0001e760: 204e 6f6e 650a 0a20 2020 2023 2040 636c   None..    # @cl
+0001e770: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+0001e780: 6620 636f 6e6e 6563 745f 746f 5f6d 6963  f connect_to_mic
+0001e790: 726f 7363 6f70 6528 7365 6c66 2c20 6970  roscope(self, ip
+0001e7a0: 5f61 6464 7265 7373 3a20 7374 722c 2070  _address: str, p
+0001e7b0: 6f72 743a 2069 6e74 203d 2038 3330 3029  ort: int = 8300)
+0001e7c0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001e7d0: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
+0001e7e0: 2020 436f 6e6e 6563 7473 2074 6f20 6120    Connects to a 
+0001e7f0: 6d69 6372 6f73 636f 7065 2077 6974 6820  microscope with 
+0001e800: 7468 6520 7370 6563 6966 6965 6420 4950  the specified IP
+0001e810: 2061 6464 7265 7373 2061 6e64 2070 6f72   address and por
+0001e820: 742e 0a0a 2020 2020 2020 2020 2020 2020  t...            
+0001e830: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+0001e840: 2020 2020 2020 6970 5f61 6464 7265 7373        ip_address
+0001e850: 3a20 4120 7374 7269 6e67 2074 6861 7420  : A string that 
+0001e860: 7265 7072 6573 656e 7473 2074 6865 2049  represents the I
+0001e870: 5020 6164 6472 6573 7320 6f66 2074 6865  P address of the
+0001e880: 206d 6963 726f 7363 6f70 652e 0a20 2020   microscope..   
+0001e890: 2020 2020 2020 2020 2020 2020 2070 6f72               por
+0001e8a0: 743a 2041 6e20 696e 7465 6765 7220 7468  t: An integer th
+0001e8b0: 6174 2072 6570 7265 7365 6e74 7320 7468  at represents th
+0001e8c0: 6520 706f 7274 206e 756d 6265 7220 746f  e port number to
+0001e8d0: 2075 7365 2028 6465 6661 756c 7420 3833   use (default 83
+0001e8e0: 3030 292e 0a0a 2020 2020 2020 2020 2020  00)...          
+0001e8f0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0001e900: 2020 2020 2020 2020 2020 204e 6f6e 652e             None.
+0001e910: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001e920: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0001e930: 6f28 6622 4d69 6372 6f73 636f 7065 2063  o(f"Microscope c
+0001e940: 6c69 656e 7420 636f 6e6e 6563 7469 6e67  lient connecting
+0001e950: 2074 6f20 5b7b 6970 5f61 6464 7265 7373   to [{ip_address
+0001e960: 7d3a 7b70 6f72 747d 5d22 290a 2020 2020  }:{port}]").    
+0001e970: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0001e980: 696f 6e20 3d20 4175 746f 6d61 7469 6f6e  ion = Automation
+0001e990: 2869 705f 6164 6472 6573 732c 2070 6f72  (ip_address, por
+0001e9a0: 7429 0a20 2020 2020 2020 206c 6f67 6769  t).        loggi
+0001e9b0: 6e67 2e69 6e66 6f28 6622 4d69 6372 6f73  ng.info(f"Micros
+0001e9c0: 636f 7065 2063 6c69 656e 7420 636f 6e6e  cope client conn
+0001e9d0: 6563 7465 6420 746f 205b 7b69 705f 6164  ected to [{ip_ad
+0001e9e0: 6472 6573 737d 3a7b 706f 7274 7d5d 2229  dress}:{port}]")
+0001e9f0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0001ea00: 6e6e 6563 7469 6f6e 2e53 454d 2e44 6574  nnection.SEM.Det
+0001ea10: 6563 746f 722e 5365 7428 302c 2073 656c  ector.Set(0, sel
+0001ea20: 662e 656c 6563 7472 6f6e 5f64 6574 6563  f.electron_detec
+0001ea30: 746f 725f 6163 7469 7665 2c20 4270 702e  tor_active, Bpp.
+0001ea40: 4772 6179 7363 616c 655f 385f 6269 7429  Grayscale_8_bit)
+0001ea50: 0a20 2020 2020 2020 2069 6d61 6765 203d  .        image =
+0001ea60: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0001ea70: 2e53 454d 2e53 6361 6e2e 4163 7175 6972  .SEM.Scan.Acquir
+0001ea80: 6549 6d61 6765 4672 6f6d 4368 616e 6e65  eImageFromChanne
+0001ea90: 6c28 302c 2031 2c20 312c 2031 3030 290a  l(0, 1, 1, 100).
+0001eaa0: 0a20 2020 2020 2020 2023 2073 7973 7465  .        # syste
+0001eab0: 6d20 696e 666f 0a20 2020 2020 2020 2073  m info.        s
+0001eac0: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
+0001ead0: 6d61 6e75 6661 6374 7572 6572 203d 2022  manufacturer = "
+0001eae0: 5445 5343 414e 220a 2020 2020 2020 2020  TESCAN".        
+0001eaf0: 7365 6c66 2e73 7973 7465 6d2e 696e 666f  self.system.info
+0001eb00: 2e6d 6f64 656c 203d 2069 6d61 6765 2e48  .model = image.H
+0001eb10: 6561 6465 725b 224d 4149 4e22 5d5b 2244  eader["MAIN"]["D
+0001eb20: 6576 6963 654d 6f64 656c 225d 0a20 2020  eviceModel"].   
+0001eb30: 2020 2020 2073 656c 662e 7379 7374 656d       self.system
+0001eb40: 2e69 6e66 6f2e 7365 7269 616c 5f6e 756d  .info.serial_num
+0001eb50: 6265 7220 3d20 696d 6167 652e 4865 6164  ber = image.Head
+0001eb60: 6572 5b22 4d41 494e 225d 5b22 5365 7269  er["MAIN"]["Seri
+0001eb70: 616c 4e75 6d62 6572 225d 0a20 2020 2020  alNumber"].     
+0001eb80: 2020 2073 656c 662e 7379 7374 656d 2e69     self.system.i
+0001eb90: 6e66 6f2e 736f 6674 7761 7265 5f76 6572  nfo.software_ver
+0001eba0: 7369 6f6e 203d 2069 6d61 6765 2e48 6561  sion = image.Hea
+0001ebb0: 6465 725b 224d 4149 4e22 5d5b 2253 6f66  der["MAIN"]["Sof
+0001ebc0: 7477 6172 6556 6572 7369 6f6e 225d 0a0a  twareVersion"]..
+0001ebd0: 2020 2020 2020 2020 696e 666f 203d 2073          info = s
+0001ebe0: 656c 662e 7379 7374 656d 2e69 6e66 6f0a  elf.system.info.
+0001ebf0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0001ec00: 696e 666f 2866 224d 6963 726f 7363 6f70  info(f"Microscop
+0001ec10: 6520 636c 6965 6e74 2063 6f6e 6e65 6374  e client connect
+0001ec20: 6564 2074 6f20 6d6f 6465 6c20 7b69 6e66  ed to model {inf
+0001ec30: 6f2e 6d6f 6465 6c7d 2077 6974 6820 7365  o.model} with se
+0001ec40: 7269 616c 206e 756d 6265 7220 7b69 6e66  rial number {inf
+0001ec50: 6f2e 7365 7269 616c 5f6e 756d 6265 727d  o.serial_number}
+0001ec60: 2061 6e64 2073 6f66 7477 6172 6520 7665   and software ve
+0001ec70: 7273 696f 6e20 7b69 6e66 6f2e 736f 6674  rsion {info.soft
+0001ec80: 7761 7265 5f76 6572 7369 6f6e 7d2e 2229  ware_version}.")
+0001ec90: 0a0a 2020 2020 2020 2020 2320 7265 7365  ..        # rese
+0001eca0: 7420 6265 616d 2073 6869 6674 730a 2020  t beam shifts.  
+0001ecb0: 2020 2020 2020 7365 6c66 2e72 6573 6574        self.reset
+0001ecc0: 5f62 6561 6d5f 7368 6966 7473 2829 0a0a  _beam_shifts()..
+0001ecd0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0001ece0: 6465 6275 6728 7b22 6d73 6722 3a20 2263  debug({"msg": "c
+0001ecf0: 6f6e 6e65 6374 5f74 6f5f 6d69 6372 6f73  onnect_to_micros
+0001ed00: 636f 7065 222c 2022 6970 5f61 6464 7265  cope", "ip_addre
+0001ed10: 7373 223a 2069 705f 6164 6472 6573 732c  ss": ip_address,
+0001ed20: 2022 706f 7274 223a 2070 6f72 742c 2022   "port": port, "
+0001ed30: 7379 7374 656d 5f69 6e66 6f22 3a20 7365  system_info": se
+0001ed40: 6c66 2e73 7973 7465 6d2e 696e 666f 2e74  lf.system.info.t
+0001ed50: 6f5f 6469 6374 2829 7d29 0a0a 2020 2020  o_dict()})..    
+0001ed60: 6465 6620 6163 7175 6972 655f 696d 6167  def acquire_imag
+0001ed70: 6528 7365 6c66 2c20 696d 6167 655f 7365  e(self, image_se
+0001ed80: 7474 696e 6773 3d49 6d61 6765 5365 7474  ttings=ImageSett
+0001ed90: 696e 6773 2920 2d3e 2046 6962 7365 6d49  ings) -> FibsemI
+0001eda0: 6d61 6765 3a0a 2020 2020 2020 2020 2222  mage:.        ""
+0001edb0: 220a 2020 2020 2020 2020 2020 2020 4163  ".            Ac
+0001edc0: 7175 6972 6573 2061 6e20 696d 6167 6520  quires an image 
+0001edd0: 7573 696e 6720 7468 6520 7370 6563 6966  using the specif
+0001ede0: 6965 6420 696d 6167 6520 7365 7474 696e  ied image settin
+0001edf0: 6773 2e0a 0a20 2020 2020 2020 2020 2020  gs...           
+0001ee00: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+0001ee10: 2020 2020 2020 2069 6d61 6765 5f73 6574         image_set
+0001ee20: 7469 6e67 733a 2041 6e20 696e 7374 616e  tings: An instan
+0001ee30: 6365 206f 6620 7468 6520 6049 6d61 6765  ce of the `Image
+0001ee40: 5365 7474 696e 6773 6020 636c 6173 7320  Settings` class 
+0001ee50: 7468 6174 2072 6570 7265 7365 6e74 7320  that represents 
+0001ee60: 7468 6520 696d 6167 6520 7365 7474 696e  the image settin
+0001ee70: 6773 2074 6f20 7573 6520 2864 6566 6175  gs to use (defau
+0001ee80: 6c74 2060 496d 6167 6553 6574 7469 6e67  lt `ImageSetting
+0001ee90: 7360 292e 0a0a 2020 2020 2020 2020 2020  s`)...          
+0001eea0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+0001eeb0: 2020 2020 2020 2020 2020 2041 2060 4669             A `Fi
+0001eec0: 6273 656d 496d 6167 6560 206f 626a 6563  bsemImage` objec
+0001eed0: 7420 7468 6174 2072 6570 7265 7365 6e74  t that represent
+0001eee0: 7320 7468 6520 6163 7175 6972 6564 2069  s the acquired i
+0001eef0: 6d61 6765 2e0a 2020 2020 2020 2020 2222  mage..        ""
+0001ef00: 220a 2020 2020 2020 2020 6966 2069 6d61  ".        if ima
+0001ef10: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
+0001ef20: 5f74 7970 652e 6e61 6d65 203d 3d20 2245  _type.name == "E
+0001ef30: 4c45 4354 524f 4e22 3a0a 2020 2020 2020  LECTRON":.      
+0001ef40: 2020 2020 2020 696d 6167 655f 7365 7474        image_sett
+0001ef50: 696e 6773 2e68 6677 203d 206e 702e 636c  ings.hfw = np.cl
+0001ef60: 6970 280a 2020 2020 2020 2020 2020 2020  ip(.            
+0001ef70: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
+0001ef80: 7474 696e 6773 2e68 6677 2c20 312e 3065  ttings.hfw, 1.0e
+0001ef90: 2d36 2c20 3235 3830 2e30 652d 360a 2020  -6, 2580.0e-6.  
+0001efa0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001efb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001efc0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+0001efd0: 7365 7474 696e 6773 2e68 6677 203d 206e  settings.hfw = n
+0001efe0: 702e 636c 6970 280a 2020 2020 2020 2020  p.clip(.        
+0001eff0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+0001f000: 655f 7365 7474 696e 6773 2e68 6677 2c20  e_settings.hfw, 
+0001f010: 312e 3065 2d36 2c20 3435 302e 3065 2d36  1.0e-6, 450.0e-6
+0001f020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f030: 2029 0a20 2020 2020 2020 206c 6f67 6769   ).        loggi
+0001f040: 6e67 2e69 6e66 6f28 6622 6163 7175 6972  ng.info(f"acquir
+0001f050: 696e 6720 6e65 7720 7b69 6d61 6765 5f73  ing new {image_s
+0001f060: 6574 7469 6e67 732e 6265 616d 5f74 7970  ettings.beam_typ
+0001f070: 652e 6e61 6d65 7d20 696d 6167 652e 2229  e.name} image.")
+0001f080: 0a20 2020 2020 2020 2069 6620 696d 6167  .        if imag
+0001f090: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
+0001f0a0: 7479 7065 2e6e 616d 6520 3d3d 2022 454c  type.name == "EL
+0001f0b0: 4543 5452 4f4e 223a 0a20 2020 2020 2020  ECTRON":.       
+0001f0c0: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
+0001f0d0: 2842 6561 6d54 7970 652e 454c 4543 5452  (BeamType.ELECTR
+0001f0e0: 4f4e 2c20 7365 6c66 2e73 7973 7465 6d29  ON, self.system)
+0001f0f0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+0001f100: 6765 203d 2073 656c 662e 5f67 6574 5f65  ge = self._get_e
+0001f110: 625f 696d 6167 6528 696d 6167 655f 7365  b_image(image_se
+0001f120: 7474 696e 6773 290a 2020 2020 2020 2020  ttings).        
+0001f130: 2020 2020 7365 6c66 2e6c 6173 745f 696d      self.last_im
+0001f140: 6167 655f 6562 203d 2069 6d61 6765 0a20  age_eb = image. 
+0001f150: 2020 2020 2020 2069 6620 696d 6167 655f         if image_
+0001f160: 7365 7474 696e 6773 2e62 6561 6d5f 7479  settings.beam_ty
+0001f170: 7065 2e6e 616d 6520 3d3d 2022 494f 4e22  pe.name == "ION"
+0001f180: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
+0001f190: 6865 636b 5f62 6561 6d28 4265 616d 5479  heck_beam(BeamTy
+0001f1a0: 7065 2e49 4f4e 2c20 7365 6c66 2e73 7973  pe.ION, self.sys
+0001f1b0: 7465 6d29 0a20 2020 2020 2020 2020 2020  tem).           
+0001f1c0: 2069 6d61 6765 203d 2073 656c 662e 5f67   image = self._g
+0001f1d0: 6574 5f69 625f 696d 6167 6528 696d 6167  et_ib_image(imag
+0001f1e0: 655f 7365 7474 696e 6773 290a 2020 2020  e_settings).    
+0001f1f0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
+0001f200: 745f 696d 6167 655f 6962 203d 2069 6d61  t_image_ib = ima
+0001f210: 6765 0a0a 2020 2020 2020 2020 696d 6167  ge..        imag
+0001f220: 652e 6d65 7461 6461 7461 2e75 7365 7220  e.metadata.user 
+0001f230: 3d20 7365 6c66 2e75 7365 720a 2020 2020  = self.user.    
+0001f240: 2020 2020 696d 6167 652e 6d65 7461 6461      image.metada
+0001f250: 7461 2e65 7870 6572 696d 656e 7420 3d20  ta.experiment = 
+0001f260: 7365 6c66 2e65 7870 6572 696d 656e 7420  self.experiment 
+0001f270: 0a20 2020 2020 2020 2069 6d61 6765 2e6d  .        image.m
+0001f280: 6574 6164 6174 612e 7379 7374 656d 203d  etadata.system =
+0001f290: 2073 656c 662e 7379 7374 656d 0a0a 2020   self.system..  
+0001f2a0: 2020 2020 2020 7265 7475 726e 2069 6d61        return ima
+0001f2b0: 6765 0a0a 2020 2020 6465 6620 5f67 6574  ge..    def _get
+0001f2c0: 5f65 625f 696d 6167 6528 7365 6c66 2c20  _eb_image(self, 
+0001f2d0: 696d 6167 655f 7365 7474 696e 6773 3a20  image_settings: 
+0001f2e0: 496d 6167 6553 6574 7469 6e67 7329 202d  ImageSettings) -
+0001f2f0: 3e20 4669 6273 656d 496d 6167 653a 0a20  > FibsemImage:. 
+0001f300: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001f310: 2020 2041 6371 7569 7265 7320 616e 2065     Acquires an e
+0001f320: 6c65 6374 726f 6e20 6265 616d 2028 4542  lectron beam (EB
+0001f330: 2920 696d 6167 6520 7769 7468 2074 6865  ) image with the
+0001f340: 2067 6976 656e 2073 6574 7469 6e67 7320   given settings 
+0001f350: 616e 6420 7265 7475 726e 7320 6120 4669  and returns a Fi
+0001f360: 6273 656d 496d 6167 6520 6f62 6a65 6374  bsemImage object
+0001f370: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+0001f380: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+0001f390: 6765 5f73 6574 7469 6e67 7320 2849 6d61  ge_settings (Ima
+0001f3a0: 6765 5365 7474 696e 6773 293a 2041 6e20  geSettings): An 
+0001f3b0: 6f62 6a65 6374 2063 6f6e 7461 696e 696e  object containin
+0001f3c0: 6720 7468 6520 7365 7474 696e 6773 2066  g the settings f
+0001f3d0: 6f72 2074 6865 2061 6371 7569 7265 6420  or the acquired 
+0001f3e0: 696d 6167 652e 200a 0a20 2020 2020 2020  image. ..       
+0001f3f0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0001f400: 2020 2020 2020 4669 6273 656d 496d 6167        FibsemImag
+0001f410: 653a 2054 6865 2061 6371 7569 7265 6420  e: The acquired 
+0001f420: 696d 6167 6520 6173 2061 2046 6962 7365  image as a Fibse
+0001f430: 6d49 6d61 6765 206f 626a 6563 742e 0a0a  mImage object...
+0001f440: 2020 2020 2020 2020 4e6f 7465 733a 0a20          Notes:. 
+0001f450: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+0001f460: 6675 6e63 7469 6f6e 2061 6371 7569 7265  function acquire
+0001f470: 7320 616e 2065 6c65 6374 726f 6e20 6265  s an electron be
+0001f480: 616d 2028 4542 2920 696d 6167 6520 7769  am (EB) image wi
+0001f490: 7468 2074 6865 2067 6976 656e 2073 6574  th the given set
+0001f4a0: 7469 6e67 7320 616e 6420 7265 7475 726e  tings and return
+0001f4b0: 7320 6974 2061 7320 6120 4669 6273 656d  s it as a Fibsem
+0001f4c0: 496d 6167 6520 6f62 6a65 6374 2e20 0a20  Image object. . 
+0001f4d0: 2020 2020 2020 2020 2020 2054 6865 2066             The f
+0001f4e0: 756e 6374 696f 6e20 7365 7473 2075 7020  unction sets up 
+0001f4f0: 7468 6520 6d69 6372 6f73 636f 7065 2070  the microscope p
+0001f500: 6172 616d 6574 6572 732c 2069 6e63 6c75  arameters, inclu
+0001f510: 6469 6e67 2074 6865 2065 6c65 6374 726f  ding the electro
+0001f520: 6e20 6265 616d 2064 7765 6c6c 2074 696d  n beam dwell tim
+0001f530: 652c 2069 6d61 6765 2072 6573 6f6c 7574  e, image resolut
+0001f540: 696f 6e2c 2061 6e64 200a 2020 2020 2020  ion, and .      
+0001f550: 2020 2020 2020 7265 6769 6f6e 206f 6620        region of 
+0001f560: 696e 7465 7265 7374 2028 524f 4929 2c20  interest (ROI), 
+0001f570: 6966 2073 7065 6369 6669 6564 2e20 4974  if specified. It
+0001f580: 2074 6865 6e20 6163 7175 6972 6573 2074   then acquires t
+0001f590: 6865 2069 6d61 6765 2061 6e64 2063 7265  he image and cre
+0001f5a0: 6174 6573 2061 2046 6962 7365 6d49 6d61  ates a FibsemIma
+0001f5b0: 6765 206f 626a 6563 7420 6672 6f6d 2069  ge object from i
+0001f5c0: 742c 200a 2020 2020 2020 2020 2020 2020  t, .            
+0001f5d0: 696e 636c 7564 696e 6720 6d65 7461 6461  including metada
+0001f5e0: 7461 206f 6e20 7468 6520 6d69 6372 6f73  ta on the micros
+0001f5f0: 636f 7065 2073 7461 7465 2061 6e64 2074  cope state and t
+0001f600: 6865 2062 6561 6d20 616e 6420 696f 6e20  he beam and ion 
+0001f610: 7365 7474 696e 6773 2e0a 0a20 2020 2020  settings...     
+0001f620: 2020 2020 2020 2042 6566 6f72 6520 6163         Before ac
+0001f630: 7175 6972 696e 6720 7468 6520 696d 6167  quiring the imag
+0001f640: 652c 2074 6865 2066 756e 6374 696f 6e20  e, the function 
+0001f650: 656e 7375 7265 7320 7468 6174 2074 6865  ensures that the
+0001f660: 2065 6c65 6374 726f 6e20 6265 616d 2069   electron beam i
+0001f670: 7320 7475 726e 6564 206f 6e20 616e 6420  s turned on and 
+0001f680: 7468 6174 2074 6865 2053 454d 2073 6361  that the SEM sca
+0001f690: 6e20 6973 2073 746f 7070 6564 2e20 0a20  n is stopped. . 
+0001f6a0: 2020 2020 2020 2020 2020 2049 7420 7365             It se
+0001f6b0: 6c65 6374 7320 7468 6520 6d6f 7374 2073  lects the most s
+0001f6c0: 7569 7461 626c 6520 6465 7465 6374 6f72  uitable detector
+0001f6d0: 2066 6f72 2074 6865 2069 6d61 6765 2c20   for the image, 
+0001f6e0: 6173 7369 676e 7320 6974 2074 6f20 6120  assigns it to a 
+0001f6f0: 6368 616e 6e65 6c2c 2061 6e64 2065 6e61  channel, and ena
+0001f700: 626c 6573 2074 6865 2063 6861 6e6e 656c  bles the channel
+0001f710: 2066 6f72 2061 6371 7569 7369 7469 6f6e   for acquisition
+0001f720: 2e20 0a20 2020 2020 2020 2020 2020 2054  . .            T
+0001f730: 6865 2066 756e 6374 696f 6e20 7468 656e  he function then
+0001f740: 2061 6371 7569 7265 7320 7468 6520 696d   acquires the im
+0001f750: 6167 6520 6672 6f6d 2074 6865 2063 6861  age from the cha
+0001f760: 6e6e 656c 2075 7369 6e67 2074 6865 2073  nnel using the s
+0001f770: 7065 6369 6669 6564 2064 7765 6c6c 2074  pecified dwell t
+0001f780: 696d 6520 616e 6420 7265 736f 6c75 7469  ime and resoluti
+0001f790: 6f6e 2e0a 0a20 2020 2020 2020 2020 2020  on...           
+0001f7a0: 2054 6865 2066 756e 6374 696f 6e20 616c   The function al
+0001f7b0: 736f 2072 6563 6f72 6473 2074 6865 206d  so records the m
+0001f7c0: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
+0001f7d0: 6174 2074 6865 2074 696d 6520 6f66 2069  at the time of i
+0001f7e0: 6d61 6765 2061 6371 7569 7369 7469 6f6e  mage acquisition
+0001f7f0: 2c20 696e 636c 7564 696e 6720 7468 6520  , including the 
+0001f800: 7374 6167 6520 706f 7369 7469 6f6e 2c20  stage position, 
+0001f810: 6265 616d 200a 2020 2020 2020 2020 2020  beam .          
+0001f820: 2020 7365 7474 696e 6773 2c20 616e 6420    settings, and 
+0001f830: 696f 6e20 6265 616d 2073 6574 7469 6e67  ion beam setting
+0001f840: 732e 2054 6865 2061 6371 7569 7265 6420  s. The acquired 
+0001f850: 696d 6167 6520 6973 2072 6574 7572 6e65  image is returne
+0001f860: 6420 6173 2061 2046 6962 7365 6d49 6d61  d as a FibsemIma
+0001f870: 6765 206f 626a 6563 742c 2077 6869 6368  ge object, which
+0001f880: 2069 6e63 6c75 6465 7320 7468 6520 696d   includes the im
+0001f890: 6167 6520 0a20 2020 2020 2020 2020 2020  age .           
+0001f8a0: 2064 6174 6120 616e 6420 6d65 7461 6461   data and metada
+0001f8b0: 7461 206f 6e20 7468 6520 6d69 6372 6f73  ta on the micros
+0001f8c0: 636f 7065 2073 7461 7465 2061 6e64 2074  cope state and t
+0001f8d0: 6865 2069 6d61 6765 2073 6574 7469 6e67  he image setting
+0001f8e0: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+0001f8f0: 2020 2020 2020 2023 2041 7420 6669 7273         # At firs
+0001f900: 7420 6d61 6b65 2073 7572 6520 7468 6520  t make sure the 
+0001f910: 6265 616d 2069 7320 4f4e 0a20 2020 2020  beam is ON.     
+0001f920: 2020 2073 7461 7475 7320 3d20 7365 6c66     status = self
+0001f930: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d2e  .connection.SEM.
+0001f940: 4265 616d 2e47 6574 5374 6174 7573 2829  Beam.GetStatus()
+0001f950: 0a20 2020 2020 2020 2069 6620 7374 6174  .        if stat
+0001f960: 7573 2021 3d20 4175 746f 6d61 7469 6f6e  us != Automation
+0001f970: 2e53 454d 2e42 6561 6d2e 5374 6174 7573  .SEM.Beam.Status
+0001f980: 2e42 6561 6d4f 6e3a 0a20 2020 2020 2020  .BeamOn:.       
+0001f990: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0001f9a0: 7469 6f6e 2e53 454d 2e42 6561 6d2e 4f6e  tion.SEM.Beam.On
+0001f9b0: 2829 0a20 2020 2020 2020 2023 2069 6d70  ().        # imp
+0001f9c0: 6f72 7461 6e74 3a20 7374 6f70 2074 6865  ortant: stop the
+0001f9d0: 2073 6361 6e6e 696e 6720 6265 666f 7265   scanning before
+0001f9e0: 2077 6520 7374 6172 7420 7363 616e 6e69   we start scanni
+0001f9f0: 6e67 206f 7220 6265 666f 7265 2061 7574  ng or before aut
+0001fa00: 6f6d 6174 6963 2070 726f 6365 6475 7265  omatic procedure
+0001fa10: 732c 0a20 2020 2020 2020 2023 2065 7665  s,.        # eve
+0001fa20: 6e20 6265 666f 7265 2077 6520 636f 6e66  n before we conf
+0001fa30: 6967 7572 6520 7468 6520 6465 7465 6374  igure the detect
+0001fa40: 6f72 730a 2020 2020 2020 2020 7365 6c66  ors.        self
+0001fa50: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d2e  .connection.SEM.
+0001fa60: 5363 616e 2e53 746f 7028 290a 2020 2020  Scan.Stop().    
+0001fa70: 2020 2020 2320 5365 6c65 6374 2074 6865      # Select the
+0001fa80: 2064 6574 6563 746f 7220 666f 7220 696d   detector for im
+0001fa90: 6167 6520 692e 652e 3a0a 2020 2020 2020  age i.e.:.      
+0001faa0: 2020 2320 312e 2061 7373 6967 6e20 7468    # 1. assign th
+0001fab0: 6520 6465 7465 6374 6f72 2074 6f20 6120  e detector to a 
+0001fac0: 6368 616e 6e65 6c0a 2020 2020 2020 2020  channel.        
+0001fad0: 2320 322e 2065 6e61 626c 6520 7468 6520  # 2. enable the 
+0001fae0: 6368 616e 6e65 6c20 666f 7220 6163 7175  channel for acqu
+0001faf0: 6973 6974 696f 6e0a 2020 2020 2020 2020  isition.        
+0001fb00: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0001fb10: 6e6e 6563 7469 6f6e 2e53 454d 2e44 6574  nnection.SEM.Det
+0001fb20: 6563 746f 722e 5365 7428 302c 2073 656c  ector.Set(0, sel
+0001fb30: 662e 656c 6563 7472 6f6e 5f64 6574 6563  f.electron_detec
+0001fb40: 746f 725f 6163 7469 7665 2c20 4270 702e  tor_active, Bpp.
+0001fb50: 4772 6179 7363 616c 655f 385f 6269 7429  Grayscale_8_bit)
+0001fb60: 0a0a 2020 2020 2020 2020 6477 656c 6c5f  ..        dwell_
+0001fb70: 7469 6d65 203d 2069 6d61 6765 5f73 6574  time = image_set
+0001fb80: 7469 6e67 732e 6477 656c 6c5f 7469 6d65  tings.dwell_time
+0001fb90: 202a 2063 6f6e 7374 616e 7473 2e53 495f   * constants.SI_
+0001fba0: 544f 5f4e 414e 4f0a 2020 2020 2020 2020  TO_NANO.        
+0001fbb0: 2320 7265 736f 6c75 7469 6f6e 0a20 2020  # resolution.   
+0001fbc0: 2020 2020 2069 6d61 6765 5769 6474 6820       imageWidth 
+0001fbd0: 3d20 696d 6167 655f 7365 7474 696e 6773  = image_settings
+0001fbe0: 2e72 6573 6f6c 7574 696f 6e5b 305d 0a20  .resolution[0]. 
+0001fbf0: 2020 2020 2020 2069 6d61 6765 4865 6967         imageHeig
+0001fc00: 6874 203d 2069 6d61 6765 5f73 6574 7469  ht = image_setti
+0001fc10: 6e67 732e 7265 736f 6c75 7469 6f6e 5b31  ngs.resolution[1
+0001fc20: 5d0a 0a20 2020 2020 2020 2073 656c 662e  ]..        self.
+0001fc30: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e4f  connection.SEM.O
+0001fc40: 7074 6963 732e 5365 7456 6965 7766 6965  ptics.SetViewfie
+0001fc50: 6c64 280a 2020 2020 2020 2020 2020 2020  ld(.            
+0001fc60: 696d 6167 655f 7365 7474 696e 6773 2e68  image_settings.h
+0001fc70: 6677 202a 2063 6f6e 7374 616e 7473 2e4d  fw * constants.M
+0001fc80: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
+0001fc90: 5245 0a20 2020 2020 2020 2029 0a20 2020  RE.        ).   
+0001fca0: 2020 2020 2069 6620 696d 6167 655f 7365       if image_se
+0001fcb0: 7474 696e 6773 2e72 6564 7563 6564 5f61  ttings.reduced_a
+0001fcc0: 7265 6120 6973 206e 6f74 204e 6f6e 653a  rea is not None:
+0001fcd0: 0a20 2020 2020 2020 2020 2020 206c 6566  .            lef
+0001fce0: 7420 3d20 2069 6e74 2869 6d61 6765 5f73  t =  int(image_s
+0001fcf0: 6574 7469 6e67 732e 7265 6475 6365 645f  ettings.reduced_
+0001fd00: 6172 6561 2e6c 6566 7420 2a20 696d 6167  area.left * imag
+0001fd10: 6557 6964 7468 290a 2020 2020 2020 2020  eWidth).        
+0001fd20: 2020 2020 746f 7020 3d20 696e 7428 696d      top = int(im
+0001fd30: 6167 655f 7365 7474 696e 6773 2e72 6564  age_settings.red
+0001fd40: 7563 6564 5f61 7265 612e 746f 7020 2a20  uced_area.top * 
+0001fd50: 696d 6167 6548 6569 6768 7429 200a 2020  imageHeight) .  
+0001fd60: 2020 2020 2020 2020 2020 7769 6474 6820            width 
+0001fd70: 3d20 696e 7428 696d 6167 655f 7365 7474  = int(image_sett
+0001fd80: 696e 6773 2e72 6564 7563 6564 5f61 7265  ings.reduced_are
+0001fd90: 612e 7769 6474 6820 2a20 696d 6167 6557  a.width * imageW
+0001fda0: 6964 7468 290a 2020 2020 2020 2020 2020  idth).          
+0001fdb0: 2020 6865 6967 6874 203d 2069 6e74 2869    height = int(i
+0001fdc0: 6d61 6765 5f73 6574 7469 6e67 732e 7265  mage_settings.re
+0001fdd0: 6475 6365 645f 6172 6561 2e68 6569 6768  duced_area.heigh
+0001fde0: 7420 2a20 696d 6167 6548 6569 6768 7429  t * imageHeight)
+0001fdf0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+0001fe00: 6765 203d 2073 656c 662e 636f 6e6e 6563  ge = self.connec
+0001fe10: 7469 6f6e 2e53 454d 2e53 6361 6e2e 4163  tion.SEM.Scan.Ac
+0001fe20: 7175 6972 6552 4f49 4672 6f6d 4368 616e  quireROIFromChan
+0001fe30: 6e65 6c28 0a20 2020 2020 2020 2020 2020  nel(.           
+0001fe40: 2020 2020 2043 6861 6e6e 656c 3d20 302c       Channel= 0,
+0001fe50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fe60: 2057 6964 7468 3d20 696d 6167 6557 6964   Width= imageWid
+0001fe70: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0001fe80: 2020 2020 4865 6967 6874 3d20 696d 6167      Height= imag
+0001fe90: 6548 6569 6768 742c 0a20 2020 2020 2020  eHeight,.       
+0001fea0: 2020 2020 2020 2020 204c 6566 743d 206c           Left= l
+0001feb0: 6566 742c 0a20 2020 2020 2020 2020 2020  eft,.           
+0001fec0: 2020 2020 2054 6f70 3d20 746f 702c 0a20       Top= top,. 
+0001fed0: 2020 2020 2020 2020 2020 2020 2020 2052                 R
+0001fee0: 6967 6874 3d20 6c65 6674 202b 2077 6964  ight= left + wid
+0001fef0: 7468 202d 3120 2c0a 2020 2020 2020 2020  th -1 ,.        
+0001ff00: 2020 2020 2020 2020 426f 7474 6f6d 3d20          Bottom= 
+0001ff10: 746f 7020 2b20 6865 6967 6874 202d 2031  top + height - 1
+0001ff20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ff30: 2020 4477 656c 6c54 696d 653d 2064 7765    DwellTime= dwe
+0001ff40: 6c6c 5f74 696d 650a 2020 2020 2020 2020  ll_time.        
+0001ff50: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+0001ff60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001ff70: 696d 6167 6520 3d20 7365 6c66 2e63 6f6e  image = self.con
+0001ff80: 6e65 6374 696f 6e2e 5345 4d2e 5363 616e  nection.SEM.Scan
+0001ff90: 2e41 6371 7569 7265 496d 6167 6546 726f  .AcquireImageFro
+0001ffa0: 6d43 6861 6e6e 656c 280a 2020 2020 2020  mChannel(.      
+0001ffb0: 2020 2020 2020 2020 2020 302c 2069 6d61            0, ima
+0001ffc0: 6765 5769 6474 682c 2069 6d61 6765 4865  geWidth, imageHe
+0001ffd0: 6967 6874 2c20 6477 656c 6c5f 7469 6d65  ight, dwell_time
+0001ffe0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0001fff0: 2020 2020 2020 2020 6d69 6372 6f73 636f          microsco
+00020000: 7065 5f73 7461 7465 203d 204d 6963 726f  pe_state = Micro
+00020010: 7363 6f70 6553 7461 7465 280a 2020 2020  scopeState(.    
+00020020: 2020 2020 2020 2020 7469 6d65 7374 616d          timestam
+00020030: 703d 6461 7465 7469 6d65 2e64 6174 6574  p=datetime.datet
+00020040: 696d 652e 7469 6d65 7374 616d 7028 6461  ime.timestamp(da
+00020050: 7465 7469 6d65 2e64 6174 6574 696d 652e  tetime.datetime.
+00020060: 6e6f 7728 2929 2c0a 2020 2020 2020 2020  now()),.        
+00020070: 2020 2020 7374 6167 655f 706f 7369 7469      stage_positi
+00020080: 6f6e 3d46 6962 7365 6d53 7461 6765 506f  on=FibsemStagePo
+00020090: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
+000200a0: 2020 2020 2020 2020 783d 666c 6f61 7428          x=float(
+000200b0: 696d 6167 652e 4865 6164 6572 5b22 5345  image.Header["SE
+000200c0: 4d22 5d5b 2253 7461 6765 5822 5d29 2c0a  M"]["StageX"]),.
+000200d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000200e0: 793d 666c 6f61 7428 696d 6167 652e 4865  y=float(image.He
+000200f0: 6164 6572 5b22 5345 4d22 5d5b 2253 7461  ader["SEM"]["Sta
+00020100: 6765 5922 5d29 2c0a 2020 2020 2020 2020  geY"]),.        
+00020110: 2020 2020 2020 2020 7a3d 666c 6f61 7428          z=float(
+00020120: 696d 6167 652e 4865 6164 6572 5b22 5345  image.Header["SE
+00020130: 4d22 5d5b 2253 7461 6765 5a22 5d29 2c0a  M"]["StageZ"]),.
+00020140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020150: 723d 666c 6f61 7428 696d 6167 652e 4865  r=float(image.He
+00020160: 6164 6572 5b22 5345 4d22 5d5b 2253 7461  ader["SEM"]["Sta
+00020170: 6765 526f 7461 7469 6f6e 225d 292c 0a20  geRotation"]),. 
+00020180: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00020190: 3d66 6c6f 6174 2869 6d61 6765 2e48 6561  =float(image.Hea
+000201a0: 6465 725b 2253 454d 225d 5b22 5374 6167  der["SEM"]["Stag
+000201b0: 6554 696c 7422 5d29 2c0a 2020 2020 2020  eTilt"]),.      
+000201c0: 2020 2020 2020 2020 2020 636f 6f72 6469            coordi
+000201d0: 6e61 7465 5f73 7973 7465 6d3d 2252 4157  nate_system="RAW
+000201e0: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+000201f0: 2c0a 2020 2020 2020 2020 2020 2020 656c  ,.            el
+00020200: 6563 7472 6f6e 5f62 6561 6d3d 4265 616d  ectron_beam=Beam
+00020210: 5365 7474 696e 6773 280a 2020 2020 2020  Settings(.      
+00020220: 2020 2020 2020 2020 2020 6265 616d 5f74            beam_t
+00020230: 7970 653d 4265 616d 5479 7065 2e45 4c45  ype=BeamType.ELE
+00020240: 4354 524f 4e2c 0a20 2020 2020 2020 2020  CTRON,.         
+00020250: 2020 2020 2020 2077 6f72 6b69 6e67 5f64         working_d
+00020260: 6973 7461 6e63 653d 666c 6f61 7428 696d  istance=float(im
+00020270: 6167 652e 4865 6164 6572 5b22 5345 4d22  age.Header["SEM"
+00020280: 5d5b 2257 4422 5d29 2c0a 2020 2020 2020  ]["WD"]),.      
+00020290: 2020 2020 2020 2020 2020 6265 616d 5f63            beam_c
+000202a0: 7572 7265 6e74 3d66 6c6f 6174 2869 6d61  urrent=float(ima
+000202b0: 6765 2e48 6561 6465 725b 2253 454d 225d  ge.Header["SEM"]
+000202c0: 5b22 5072 6564 6963 7465 6442 6561 6d43  ["PredictedBeamC
+000202d0: 7572 7265 6e74 225d 292c 0a20 2020 2020  urrent"]),.     
+000202e0: 2020 2020 2020 2020 2020 2076 6f6c 7461             volta
+000202f0: 6765 3d66 6c6f 6174 2873 656c 662e 636f  ge=float(self.co
+00020300: 6e6e 6563 7469 6f6e 2e53 454d 2e42 6561  nnection.SEM.Bea
+00020310: 6d2e 4765 7456 6f6c 7461 6765 2829 292c  m.GetVoltage()),
+00020320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020330: 2072 6573 6f6c 7574 696f 6e3d 5b69 6d61   resolution=[ima
+00020340: 6765 5769 6474 682c 2069 6d61 6765 4865  geWidth, imageHe
+00020350: 6967 6874 5d2c 2023 227b 7d78 7b7d 222e  ight], #"{}x{}".
+00020360: 666f 726d 6174 2869 6d61 6765 5769 6474  format(imageWidt
+00020370: 682c 2069 6d61 6765 4865 6967 6874 292c  h, imageHeight),
+00020380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020390: 2064 7765 6c6c 5f74 696d 653d 666c 6f61   dwell_time=floa
+000203a0: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
+000203b0: 5345 4d22 5d5b 2244 7765 6c6c 5469 6d65  SEM"]["DwellTime
+000203c0: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
+000203d0: 2020 2020 2073 7469 676d 6174 696f 6e3d       stigmation=
+000203e0: 506f 696e 7428 0a20 2020 2020 2020 2020  Point(.         
+000203f0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+00020400: 2869 6d61 6765 2e48 6561 6465 725b 2253  (image.Header["S
+00020410: 454d 225d 5b22 5374 6967 6d61 746f 7258  EM"]["StigmatorX
+00020420: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
+00020430: 2020 2020 2020 2020 2066 6c6f 6174 2869           float(i
+00020440: 6d61 6765 2e48 6561 6465 725b 2253 454d  mage.Header["SEM
+00020450: 225d 5b22 5374 6967 6d61 746f 7259 225d  "]["StigmatorY"]
+00020460: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00020470: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00020480: 2020 2020 2020 7368 6966 743d 506f 696e        shift=Poin
+00020490: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000204a0: 2020 2020 2020 2066 6c6f 6174 2869 6d61         float(ima
+000204b0: 6765 2e48 6561 6465 725b 2253 454d 225d  ge.Header["SEM"]
+000204c0: 5b22 496d 6167 6553 6869 6674 5822 5d29  ["ImageShiftX"])
+000204d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000204e0: 2020 2020 2020 666c 6f61 7428 696d 6167        float(imag
+000204f0: 652e 4865 6164 6572 5b22 5345 4d22 5d5b  e.Header["SEM"][
+00020500: 2249 6d61 6765 5368 6966 7459 225d 292c  "ImageShiftY"]),
+00020510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020520: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00020530: 2020 2020 7363 616e 5f72 6f74 6174 696f      scan_rotatio
+00020540: 6e3d 7365 6c66 2e63 6f6e 6e65 6374 696f  n=self.connectio
+00020550: 6e2e 5345 4d2e 4f70 7469 6373 2e47 6574  n.SEM.Optics.Get
+00020560: 496d 6167 6552 6f74 6174 696f 6e28 292c  ImageRotation(),
+00020570: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00020580: 2020 2020 2020 2020 2020 2020 696f 6e5f              ion_
+00020590: 6265 616d 3d42 6561 6d53 6574 7469 6e67  beam=BeamSetting
+000205a0: 7328 6265 616d 5f74 7970 653d 4265 616d  s(beam_type=Beam
+000205b0: 5479 7065 2e49 4f4e 292c 0a20 2020 2020  Type.ION),.     
+000205c0: 2020 2029 0a0a 2020 2020 2020 2020 6465     )..        de
+000205d0: 7465 6374 6f72 203d 2046 6962 7365 6d44  tector = FibsemD
+000205e0: 6574 6563 746f 7253 6574 7469 6e67 7328  etectorSettings(
+000205f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020600: 2074 7970 6520 3d20 7365 6c66 2e67 6574   type = self.get
+00020610: 2822 6465 7465 6374 6f72 5f74 7970 6522  ("detector_type"
+00020620: 2c20 696d 6167 655f 7365 7474 696e 6773  , image_settings
+00020630: 2e62 6561 6d5f 7479 7065 292c 0a20 2020  .beam_type),.   
+00020640: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00020650: 6520 3d20 224e 2f41 222c 0a20 2020 2020  e = "N/A",.     
+00020660: 2020 2020 2020 2020 2020 2063 6f6e 7472             contr
+00020670: 6173 7420 3d20 7365 6c66 2e67 6574 2822  ast = self.get("
+00020680: 6465 7465 6374 6f72 5f63 6f6e 7472 6173  detector_contras
+00020690: 7422 2c20 696d 6167 655f 7365 7474 696e  t", image_settin
+000206a0: 6773 2e62 6561 6d5f 7479 7065 292c 0a20  gs.beam_type),. 
+000206b0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000206c0: 7269 6768 746e 6573 733d 2073 656c 662e  rightness= self.
+000206d0: 6765 7428 2264 6574 6563 746f 725f 6272  get("detector_br
+000206e0: 6967 6874 6e65 7373 222c 2069 6d61 6765  ightness", image
+000206f0: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
+00020700: 7970 6529 2c0a 0a20 2020 2020 2020 2020  ype),..         
+00020710: 2020 2029 0a0a 2020 2020 2020 2020 696d     )..        im
+00020720: 6167 655f 7365 7474 696e 6773 2e72 6573  age_settings.res
+00020730: 6f6c 7574 696f 6e20 3d20 5b69 6d61 6765  olution = [image
+00020740: 5769 6474 682c 2069 6d61 6765 4865 6967  Width, imageHeig
+00020750: 6874 5d0a 2020 2020 2020 2020 6669 6273  ht].        fibs
+00020760: 656d 5f69 6d61 6765 203d 2046 6962 7365  em_image = Fibse
+00020770: 6d49 6d61 6765 2e66 726f 6d54 6573 6361  mImage.fromTesca
+00020780: 6e49 6d61 6765 280a 2020 2020 2020 2020  nImage(.        
+00020790: 2020 2020 696d 6167 652c 2064 6565 7063      image, deepc
+000207a0: 6f70 7928 696d 6167 655f 7365 7474 696e  opy(image_settin
+000207b0: 6773 292c 2064 6565 7063 6f70 7928 6d69  gs), deepcopy(mi
+000207c0: 6372 6f73 636f 7065 5f73 7461 7465 292c  croscope_state),
+000207d0: 2064 6574 6563 746f 723d 2064 6574 6563   detector= detec
+000207e0: 746f 720a 2020 2020 2020 2020 290a 0a20  tor.        ).. 
+000207f0: 2020 2020 2020 2023 6669 6273 656d 5f69         #fibsem_i
+00020800: 6d61 6765 2e6d 6574 6164 6174 612e 696d  mage.metadata.im
+00020810: 6167 655f 7365 7474 696e 6773 2e72 6573  age_settings.res
+00020820: 6f6c 7574 696f 6e20 3d20 5b69 6d61 6765  olution = [image
+00020830: 5769 6474 682c 2069 6d61 6765 4865 6967  Width, imageHeig
+00020840: 6874 5d0a 0a20 2020 2020 2020 2072 6574  ht]..        ret
+00020850: 7572 6e20 6669 6273 656d 5f69 6d61 6765  urn fibsem_image
+00020860: 0a0a 2020 2020 6465 6620 5f67 6574 5f69  ..    def _get_i
+00020870: 625f 696d 6167 6528 7365 6c66 2c20 696d  b_image(self, im
+00020880: 6167 655f 7365 7474 696e 6773 3a20 496d  age_settings: Im
+00020890: 6167 6553 6574 7469 6e67 7329 3a0a 2020  ageSettings):.  
+000208a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000208b0: 2020 4163 7175 6972 6573 2061 6e20 696f    Acquires an io
+000208c0: 6e20 6265 616d 2028 4942 2920 696d 6167  n beam (IB) imag
+000208d0: 6520 7769 7468 2074 6865 2067 6976 656e  e with the given
+000208e0: 2073 6574 7469 6e67 7320 616e 6420 7265   settings and re
+000208f0: 7475 726e 7320 6120 4669 6273 656d 496d  turns a FibsemIm
+00020900: 6167 6520 6f62 6a65 6374 2e0a 0a20 2020  age object...   
+00020910: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+00020920: 2020 2020 2020 2069 6d61 6765 5f73 6574         image_set
+00020930: 7469 6e67 7320 2849 6d61 6765 5365 7474  tings (ImageSett
+00020940: 696e 6773 293a 2054 6865 2073 6574 7469  ings): The setti
+00020950: 6e67 7320 666f 7220 7468 6520 6163 7175  ngs for the acqu
+00020960: 6972 6564 2069 6d61 6765 2e0a 0a20 2020  ired image...   
+00020970: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+00020980: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
+00020990: 496d 6167 653a 2054 6865 2061 6371 7569  Image: The acqui
+000209a0: 7265 6420 696d 6167 6520 6173 2061 2046  red image as a F
+000209b0: 6962 7365 6d49 6d61 6765 206f 626a 6563  ibsemImage objec
+000209c0: 742e 0a0a 2020 2020 2020 2020 4e6f 7465  t...        Note
+000209d0: 733a 0a20 2020 2020 2020 2020 2020 202d  s:.            -
+000209e0: 2054 6865 2066 756e 6374 696f 6e20 6163   The function ac
+000209f0: 7175 6972 6573 2061 6e20 4942 2069 6d61  quires an IB ima
+00020a00: 6765 2077 6974 6820 7468 6520 6769 7665  ge with the give
+00020a10: 6e20 7365 7474 696e 6773 2062 7920 636f  n settings by co
+00020a20: 6e66 6967 7572 696e 6720 7468 6520 6465  nfiguring the de
+00020a30: 7465 6374 6f72 732c 2073 6361 6e6e 696e  tectors, scannin
+00020a40: 672c 2061 6e64 2073 656c 6563 7469 6e67  g, and selecting
+00020a50: 2074 6865 2064 7765 6c6c 2074 696d 652c   the dwell time,
+00020a60: 2072 6573 6f6c 7574 696f 6e2c 2061 6e64   resolution, and
+00020a70: 2076 6965 7766 6965 6c64 2e0a 2020 2020   viewfield..    
+00020a80: 2020 2020 2020 2020 2d20 4966 2074 6865          - If the
+00020a90: 2069 6d61 6765 2073 6574 7469 6e67 7320   image settings 
+00020aa0: 696e 636c 7564 6520 6120 7265 6475 6365  include a reduce
+00020ab0: 6420 6172 6561 2c20 7468 6520 6675 6e63  d area, the func
+00020ac0: 7469 6f6e 2077 696c 6c20 6163 7175 6972  tion will acquir
+00020ad0: 6520 616e 2069 6d61 6765 2077 6974 6869  e an image withi
+00020ae0: 6e20 7468 6520 7265 6475 6365 6420 6172  n the reduced ar
+00020af0: 6561 2e0a 2020 2020 2020 2020 2020 2020  ea..            
+00020b00: 2d20 5468 6520 6675 6e63 7469 6f6e 2061  - The function a
+00020b10: 6c73 6f20 6361 7074 7572 6573 2074 6865  lso captures the
+00020b20: 206d 6963 726f 7363 6f70 6520 7374 6174   microscope stat
+00020b30: 6520 6174 2074 6865 2074 696d 6520 6f66  e at the time of
+00020b40: 2061 6371 7569 7369 7469 6f6e 2061 6e64   acquisition and
+00020b50: 2069 6e63 6c75 6465 7320 7468 6973 2069   includes this i
+00020b60: 6e66 6f72 6d61 7469 6f6e 2069 6e20 7468  nformation in th
+00020b70: 6520 6d65 7461 6461 7461 206f 6620 7468  e metadata of th
+00020b80: 6520 6163 7175 6972 6564 2069 6d61 6765  e acquired image
+00020b90: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00020ba0: 2020 2020 2020 2320 4174 2066 6972 7374        # At first
+00020bb0: 206d 616b 6520 7375 7265 2074 6865 2062   make sure the b
+00020bc0: 6561 6d20 6973 204f 4e0a 2020 2020 2020  eam is ON.      
+00020bd0: 2020 7374 6174 7573 203d 2073 656c 662e    status = self.
+00020be0: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e42  connection.FIB.B
+00020bf0: 6561 6d2e 4765 7453 7461 7475 7328 290a  eam.GetStatus().
+00020c00: 2020 2020 2020 2020 6966 2073 7461 7475          if statu
+00020c10: 7320 213d 2041 7574 6f6d 6174 696f 6e2e  s != Automation.
+00020c20: 4649 422e 4265 616d 2e53 7461 7475 732e  FIB.Beam.Status.
+00020c30: 4265 616d 4f6e 3a0a 2020 2020 2020 2020  BeamOn:.        
+00020c40: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00020c50: 696f 6e2e 4649 422e 4265 616d 2e4f 6e28  ion.FIB.Beam.On(
+00020c60: 290a 2020 2020 2020 2020 2320 696d 706f  ).        # impo
+00020c70: 7274 616e 743a 2073 746f 7020 7468 6520  rtant: stop the 
+00020c80: 7363 616e 6e69 6e67 2062 6566 6f72 6520  scanning before 
+00020c90: 7765 2073 7461 7274 2073 6361 6e6e 696e  we start scannin
+00020ca0: 6720 6f72 2062 6566 6f72 6520 6175 746f  g or before auto
+00020cb0: 6d61 7469 6320 7072 6f63 6564 7572 6573  matic procedures
+00020cc0: 2c0a 2020 2020 2020 2020 2320 6576 656e  ,.        # even
+00020cd0: 2062 6566 6f72 6520 7765 2063 6f6e 6669   before we confi
+00020ce0: 6775 7265 2074 6865 2064 6574 6563 746f  gure the detecto
+00020cf0: 7273 0a20 2020 2020 2020 2073 656c 662e  rs.        self.
+00020d00: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e53  connection.FIB.S
+00020d10: 6361 6e2e 5374 6f70 2829 0a20 2020 2020  can.Stop().     
+00020d20: 2020 2023 2053 656c 6563 7420 7468 6520     # Select the 
+00020d30: 6465 7465 6374 6f72 2066 6f72 2069 6d61  detector for ima
+00020d40: 6765 2069 2e65 2e3a 0a20 2020 2020 2020  ge i.e.:.       
+00020d50: 2023 2031 2e20 6173 7369 676e 2074 6865   # 1. assign the
+00020d60: 2064 6574 6563 746f 7220 746f 2061 2063   detector to a c
+00020d70: 6861 6e6e 656c 0a20 2020 2020 2020 2023  hannel.        #
+00020d80: 2032 2e20 656e 6162 6c65 2074 6865 2063   2. enable the c
+00020d90: 6861 6e6e 656c 2066 6f72 2061 6371 7569  hannel for acqui
+00020da0: 7369 7469 6f6e 0a20 2020 2020 2020 2073  sition.        s
+00020db0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
+00020dc0: 4942 2e44 6574 6563 746f 722e 5365 7428  IB.Detector.Set(
+00020dd0: 0a20 2020 2020 2020 2020 2020 2030 2c20  .            0, 
+00020de0: 7365 6c66 2e69 6f6e 5f64 6574 6563 746f  self.ion_detecto
+00020df0: 725f 6163 7469 7665 2c20 4270 702e 4772  r_active, Bpp.Gr
+00020e00: 6179 7363 616c 655f 385f 6269 740a 2020  ayscale_8_bit.  
+00020e10: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00020e20: 2064 7765 6c6c 5f74 696d 6520 3d20 696d   dwell_time = im
+00020e30: 6167 655f 7365 7474 696e 6773 2e64 7765  age_settings.dwe
+00020e40: 6c6c 5f74 696d 6520 2a20 636f 6e73 7461  ll_time * consta
+00020e50: 6e74 732e 5349 5f54 4f5f 4e41 4e4f 0a0a  nts.SI_TO_NANO..
+00020e60: 2020 2020 2020 2020 2320 7265 736f 6c75          # resolu
+00020e70: 7469 6f6e 0a20 2020 2020 2020 2069 6d61  tion.        ima
+00020e80: 6765 5769 6474 6820 3d20 696d 6167 655f  geWidth = image_
+00020e90: 7365 7474 696e 6773 2e72 6573 6f6c 7574  settings.resolut
+00020ea0: 696f 6e5b 305d 0a20 2020 2020 2020 2069  ion[0].        i
+00020eb0: 6d61 6765 4865 6967 6874 203d 2069 6d61  mageHeight = ima
+00020ec0: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
+00020ed0: 6c75 7469 6f6e 5b31 5d0a 0a20 2020 2020  lution[1]..     
+00020ee0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00020ef0: 6f6e 2e46 4942 2e4f 7074 6963 732e 5365  on.FIB.Optics.Se
+00020f00: 7456 6965 7766 6965 6c64 280a 2020 2020  tViewfield(.    
+00020f10: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
+00020f20: 7474 696e 6773 2e68 6677 202a 2063 6f6e  ttings.hfw * con
+00020f30: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+00020f40: 4d49 4c4c 494d 4554 5245 0a20 2020 2020  MILLIMETRE.     
+00020f50: 2020 2029 0a20 2020 2020 2020 200a 2020     ).        .  
+00020f60: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
+00020f70: 6620 696d 6167 655f 7365 7474 696e 6773  f image_settings
+00020f80: 2e72 6564 7563 6564 5f61 7265 6120 6973  .reduced_area is
+00020f90: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00020fa0: 2020 2020 2020 206c 6566 7420 3d20 2069         left =  i
+00020fb0: 6e74 2869 6d61 6765 5f73 6574 7469 6e67  nt(image_setting
+00020fc0: 732e 7265 6475 6365 645f 6172 6561 2e6c  s.reduced_area.l
+00020fd0: 6566 7420 2a20 696d 6167 6557 6964 7468  eft * imageWidth
+00020fe0: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
+00020ff0: 7020 3d20 696e 7428 696d 6167 655f 7365  p = int(image_se
+00021000: 7474 696e 6773 2e72 6564 7563 6564 5f61  ttings.reduced_a
+00021010: 7265 612e 746f 7020 2a20 696d 6167 6548  rea.top * imageH
+00021020: 6569 6768 7429 200a 2020 2020 2020 2020  eight) .        
+00021030: 2020 2020 7769 6474 6820 3d20 696e 7428      width = int(
+00021040: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
+00021050: 6564 7563 6564 5f61 7265 612e 7769 6474  educed_area.widt
+00021060: 6820 2a20 696d 6167 6557 6964 7468 290a  h * imageWidth).
+00021070: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+00021080: 6874 203d 2069 6e74 2869 6d61 6765 5f73  ht = int(image_s
+00021090: 6574 7469 6e67 732e 7265 6475 6365 645f  ettings.reduced_
+000210a0: 6172 6561 2e68 6569 6768 7420 2a20 696d  area.height * im
+000210b0: 6167 6548 6569 6768 7429 0a20 2020 2020  ageHeight).     
+000210c0: 2020 2020 2020 2069 6d61 6765 203d 2073         image = s
+000210d0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
+000210e0: 4942 2e53 6361 6e2e 4163 7175 6972 6552  IB.Scan.AcquireR
+000210f0: 4f49 4672 6f6d 4368 616e 6e65 6c28 0a20  OIFromChannel(. 
+00021100: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+00021110: 6861 6e6e 656c 3d20 302c 0a20 2020 2020  hannel= 0,.     
+00021120: 2020 2020 2020 2020 2020 2057 6964 7468             Width
+00021130: 3d20 696d 6167 6557 6964 7468 2c0a 2020  = imageWidth,.  
+00021140: 2020 2020 2020 2020 2020 2020 2020 4865                He
+00021150: 6967 6874 3d20 696d 6167 6548 6569 6768  ight= imageHeigh
+00021160: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00021170: 2020 204c 6566 743d 206c 6566 742c 0a20     Left= left,. 
+00021180: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+00021190: 6f70 3d20 746f 702c 0a20 2020 2020 2020  op= top,.       
+000211a0: 2020 2020 2020 2020 2052 6967 6874 3d20           Right= 
+000211b0: 6c65 6674 202b 2077 6964 7468 202d 3120  left + width -1 
+000211c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000211d0: 2020 426f 7474 6f6d 3d20 746f 7020 2b20    Bottom= top + 
+000211e0: 6865 6967 6874 202d 2031 2c0a 2020 2020  height - 1,.    
+000211f0: 2020 2020 2020 2020 2020 2020 4477 656c              Dwel
+00021200: 6c54 696d 653d 2064 7765 6c6c 5f74 696d  lTime= dwell_tim
+00021210: 650a 2020 2020 2020 2020 2020 2020 290a  e.            ).
+00021220: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00021230: 2020 2020 2020 2020 2020 696d 6167 6520            image 
+00021240: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+00021250: 6e2e 4649 422e 5363 616e 2e41 6371 7569  n.FIB.Scan.Acqui
+00021260: 7265 496d 6167 6546 726f 6d43 6861 6e6e  reImageFromChann
+00021270: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+00021280: 2020 2020 302c 2069 6d61 6765 5769 6474      0, imageWidt
+00021290: 682c 2069 6d61 6765 4865 6967 6874 2c20  h, imageHeight, 
+000212a0: 6477 656c 6c5f 7469 6d65 0a20 2020 2020  dwell_time.     
+000212b0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000212c0: 2020 6d69 6372 6f73 636f 7065 5f73 7461    microscope_sta
+000212d0: 7465 203d 204d 6963 726f 7363 6f70 6553  te = MicroscopeS
+000212e0: 7461 7465 280a 2020 2020 2020 2020 2020  tate(.          
+000212f0: 2020 7469 6d65 7374 616d 703d 6461 7465    timestamp=date
+00021300: 7469 6d65 2e64 6174 6574 696d 652e 7469  time.datetime.ti
+00021310: 6d65 7374 616d 7028 6461 7465 7469 6d65  mestamp(datetime
+00021320: 2e64 6174 6574 696d 652e 6e6f 7728 2929  .datetime.now())
+00021330: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00021340: 6167 655f 706f 7369 7469 6f6e 3d46 6962  age_position=Fib
+00021350: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00021360: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00021370: 2020 783d 666c 6f61 7428 696d 6167 652e    x=float(image.
+00021380: 4865 6164 6572 5b22 4649 4222 5d5b 2253  Header["FIB"]["S
+00021390: 7461 6765 5822 5d29 2c0a 2020 2020 2020  tageX"]),.      
+000213a0: 2020 2020 2020 2020 2020 793d 666c 6f61            y=floa
+000213b0: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
+000213c0: 4649 4222 5d5b 2253 7461 6765 5922 5d29  FIB"]["StageY"])
+000213d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000213e0: 2020 7a3d 666c 6f61 7428 696d 6167 652e    z=float(image.
+000213f0: 4865 6164 6572 5b22 4649 4222 5d5b 2253  Header["FIB"]["S
+00021400: 7461 6765 5a22 5d29 2c0a 2020 2020 2020  tageZ"]),.      
+00021410: 2020 2020 2020 2020 2020 723d 666c 6f61            r=floa
+00021420: 7428 696d 6167 652e 4865 6164 6572 5b22  t(image.Header["
+00021430: 4649 4222 5d5b 2253 7461 6765 526f 7461  FIB"]["StageRota
+00021440: 7469 6f6e 225d 292c 0a20 2020 2020 2020  tion"]),.       
+00021450: 2020 2020 2020 2020 2074 3d66 6c6f 6174           t=float
+00021460: 2869 6d61 6765 2e48 6561 6465 725b 2246  (image.Header["F
+00021470: 4942 225d 5b22 5374 6167 6554 696c 7422  IB"]["StageTilt"
+00021480: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+00021490: 2020 2020 636f 6f72 6469 6e61 7465 5f73      coordinate_s
+000214a0: 7973 7465 6d3d 2252 4157 222c 0a20 2020  ystem="RAW",.   
+000214b0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+000214c0: 2020 2020 2020 2020 656c 6563 7472 6f6e          electron
+000214d0: 5f62 6561 6d3d 4265 616d 5365 7474 696e  _beam=BeamSettin
+000214e0: 6773 2862 6561 6d5f 7479 7065 3d42 6561  gs(beam_type=Bea
+000214f0: 6d54 7970 652e 454c 4543 5452 4f4e 292c  mType.ELECTRON),
+00021500: 0a20 2020 2020 2020 2020 2020 2069 6f6e  .            ion
+00021510: 5f62 6561 6d3d 4265 616d 5365 7474 696e  _beam=BeamSettin
+00021520: 6773 280a 2020 2020 2020 2020 2020 2020  gs(.            
+00021530: 2020 2020 6265 616d 5f74 7970 653d 4265      beam_type=Be
+00021540: 616d 5479 7065 2e49 4f4e 2c0a 2020 2020  amType.ION,.    
+00021550: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00021560: 696e 675f 6469 7374 616e 6365 3d66 6c6f  ing_distance=flo
+00021570: 6174 2869 6d61 6765 2e48 6561 6465 725b  at(image.Header[
+00021580: 2246 4942 225d 5b22 5744 225d 292c 0a20  "FIB"]["WD"]),. 
+00021590: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000215a0: 6561 6d5f 6375 7272 656e 743d 666c 6f61  eam_current=floa
+000215b0: 7428 7365 6c66 2e63 6f6e 6e65 6374 696f  t(self.connectio
+000215c0: 6e2e 4649 422e 4265 616d 2e52 6561 6450  n.FIB.Beam.ReadP
+000215d0: 726f 6265 4375 7272 656e 7428 2929 2c0a  robeCurrent()),.
+000215e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215f0: 766f 6c74 6167 6520 3d20 666c 6f61 7428  voltage = float(
+00021600: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00021610: 4649 422e 4265 616d 2e47 6574 566f 6c74  FIB.Beam.GetVolt
+00021620: 6167 6528 2929 2c0a 2020 2020 2020 2020  age()),.        
+00021630: 2020 2020 2020 2020 7265 736f 6c75 7469          resoluti
+00021640: 6f6e 3d5b 696d 6167 6557 6964 7468 2c20  on=[imageWidth, 
+00021650: 696d 6167 6548 6569 6768 745d 2c20 2322  imageHeight], #"
+00021660: 7b7d 787b 7d22 2e66 6f72 6d61 7428 696d  {}x{}".format(im
+00021670: 6167 6557 6964 7468 2c20 696d 6167 6548  ageWidth, imageH
+00021680: 6569 6768 7429 2c0a 2020 2020 2020 2020  eight),.        
+00021690: 2020 2020 2020 2020 6477 656c 6c5f 7469          dwell_ti
+000216a0: 6d65 3d66 6c6f 6174 2869 6d61 6765 2e48  me=float(image.H
+000216b0: 6561 6465 725b 2246 4942 225d 5b22 4477  eader["FIB"]["Dw
+000216c0: 656c 6c54 696d 6522 5d29 2c0a 2020 2020  ellTime"]),.    
+000216d0: 2020 2020 2020 2020 2020 2020 7374 6967              stig
+000216e0: 6d61 7469 6f6e 3d50 6f69 6e74 280a 2020  mation=Point(.  
+000216f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021700: 2020 666c 6f61 7428 696d 6167 652e 4865    float(image.He
+00021710: 6164 6572 5b22 4649 4222 5d5b 2253 7469  ader["FIB"]["Sti
+00021720: 676d 6174 6f72 5822 5d29 2c0a 2020 2020  gmatorX"]),.    
+00021730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021740: 666c 6f61 7428 696d 6167 652e 4865 6164  float(image.Head
+00021750: 6572 5b22 4649 4222 5d5b 2253 7469 676d  er["FIB"]["Stigm
+00021760: 6174 6f72 5922 5d29 2c0a 2020 2020 2020  atorY"]),.      
+00021770: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00021780: 2020 2020 2020 2020 2020 2020 2073 6869               shi
+00021790: 6674 3d50 6f69 6e74 280a 2020 2020 2020  ft=Point(.      
+000217a0: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+000217b0: 6f61 7428 696d 6167 652e 4865 6164 6572  oat(image.Header
+000217c0: 5b22 4649 4222 5d5b 2249 6d61 6765 5368  ["FIB"]["ImageSh
+000217d0: 6966 7458 225d 292c 0a20 2020 2020 2020  iftX"]),.       
+000217e0: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+000217f0: 6174 2869 6d61 6765 2e48 6561 6465 725b  at(image.Header[
+00021800: 2246 4942 225d 5b22 496d 6167 6553 6869  "FIB"]["ImageShi
+00021810: 6674 5922 5d29 2c0a 2020 2020 2020 2020  ftY"]),.        
+00021820: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+00021830: 2020 2020 2020 2020 2020 2073 6361 6e5f             scan_
+00021840: 726f 7461 7469 6f6e 3d73 656c 662e 636f  rotation=self.co
+00021850: 6e6e 6563 7469 6f6e 2e46 4942 2e4f 7074  nnection.FIB.Opt
+00021860: 6963 732e 4765 7449 6d61 6765 526f 7461  ics.GetImageRota
+00021870: 7469 6f6e 2829 2c0a 2020 2020 2020 2020  tion(),.        
+00021880: 2020 2020 292c 0a20 2020 2020 2020 2029      ),.        )
+00021890: 0a0a 2020 2020 2020 2020 6465 7465 6374  ..        detect
+000218a0: 6f72 203d 2046 6962 7365 6d44 6574 6563  or = FibsemDetec
+000218b0: 746f 7253 6574 7469 6e67 7328 0a20 2020  torSettings(.   
+000218c0: 2020 2020 2020 2020 2020 2020 2074 7970               typ
+000218d0: 6520 3d20 7365 6c66 2e67 6574 2822 6465  e = self.get("de
+000218e0: 7465 6374 6f72 5f74 7970 6522 2c20 696d  tector_type", im
+000218f0: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+00021900: 6d5f 7479 7065 292c 0a20 2020 2020 2020  m_type),.       
+00021910: 2020 2020 2020 2020 206d 6f64 6520 3d20           mode = 
+00021920: 224e 2f41 222c 0a20 2020 2020 2020 2020  "N/A",.         
+00021930: 2020 2020 2020 2063 6f6e 7472 6173 7420         contrast 
+00021940: 3d20 7365 6c66 2e67 6574 2822 6465 7465  = self.get("dete
+00021950: 6374 6f72 5f63 6f6e 7472 6173 7422 2c20  ctor_contrast", 
+00021960: 696d 6167 655f 7365 7474 696e 6773 2e62  image_settings.b
+00021970: 6561 6d5f 7479 7065 292c 0a20 2020 2020  eam_type),.     
+00021980: 2020 2020 2020 2020 2020 2062 7269 6768             brigh
+00021990: 746e 6573 733d 2073 656c 662e 6765 7428  tness= self.get(
+000219a0: 2264 6574 6563 746f 725f 6272 6967 6874  "detector_bright
+000219b0: 6e65 7373 222c 2069 6d61 6765 5f73 6574  ness", image_set
+000219c0: 7469 6e67 732e 6265 616d 5f74 7970 6529  tings.beam_type)
+000219d0: 2c0a 0a20 2020 2020 2020 2020 2020 2029  ,..            )
+000219e0: 0a20 2020 2020 2020 2069 6d61 6765 5f73  .        image_s
+000219f0: 6574 7469 6e67 732e 7265 736f 6c75 7469  ettings.resoluti
+00021a00: 6f6e 203d 205b 696d 6167 6557 6964 7468  on = [imageWidth
+00021a10: 2c20 696d 6167 6548 6569 6768 745d 0a20  , imageHeight]. 
+00021a20: 2020 2020 2020 2066 6962 7365 6d5f 696d         fibsem_im
+00021a30: 6167 6520 3d20 4669 6273 656d 496d 6167  age = FibsemImag
+00021a40: 652e 6672 6f6d 5465 7363 616e 496d 6167  e.fromTescanImag
+00021a50: 6528 0a20 2020 2020 2020 2020 2020 2069  e(.            i
+00021a60: 6d61 6765 2c20 6465 6570 636f 7079 2869  mage, deepcopy(i
+00021a70: 6d61 6765 5f73 6574 7469 6e67 7329 2c20  mage_settings), 
+00021a80: 6465 6570 636f 7079 286d 6963 726f 7363  deepcopy(microsc
+00021a90: 6f70 655f 7374 6174 6529 2c20 6465 7465  ope_state), dete
+00021aa0: 6374 6f72 3d20 6465 7465 6374 6f72 0a20  ctor= detector. 
+00021ab0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00021ac0: 2020 2320 6669 6273 656d 5f69 6d61 6765    # fibsem_image
+00021ad0: 2e6d 6574 6164 6174 612e 696d 6167 655f  .metadata.image_
+00021ae0: 7365 7474 696e 6773 2e72 6573 6f6c 7574  settings.resolut
+00021af0: 696f 6e20 3d20 5b69 6d61 6765 5769 6474  ion = [imageWidt
+00021b00: 682c 2069 6d61 6765 4865 6967 6874 5d0a  h, imageHeight].
+00021b10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00021b20: 6669 6273 656d 5f69 6d61 6765 0a0a 2020  fibsem_image..  
+00021b30: 2020 6465 6620 6c61 7374 5f69 6d61 6765    def last_image
+00021b40: 2873 656c 662c 2062 6561 6d5f 7479 7065  (self, beam_type
+00021b50: 3a20 4265 616d 5479 7065 2e45 4c45 4354  : BeamType.ELECT
+00021b60: 524f 4e29 202d 3e20 4669 6273 656d 496d  RON) -> FibsemIm
+00021b70: 6167 653a 0a20 2020 2020 2020 2022 2222  age:.        """
+00021b80: 2020 2020 0a20 2020 2020 2020 2052 6574      .        Ret
+00021b90: 7572 6e73 2074 6865 206c 6173 7420 6163  urns the last ac
+00021ba0: 7175 6972 6564 2069 6d61 6765 2066 6f72  quired image for
+00021bb0: 2074 6865 2073 7065 6369 6669 6564 2062   the specified b
+00021bc0: 6561 6d20 7479 7065 2e0a 0a20 2020 2020  eam type...     
+00021bd0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00021be0: 2020 2020 2062 6561 6d5f 7479 7065 2028       beam_type (
+00021bf0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00021c00: 4e20 6f72 2042 6561 6d54 7970 652e 494f  N or BeamType.IO
+00021c10: 4e29 3a20 5468 6520 7479 7065 206f 6620  N): The type of 
+00021c20: 6265 616d 2075 7365 6420 746f 2061 6371  beam used to acq
+00021c30: 7569 7265 2074 6865 2069 6d61 6765 2e0a  uire the image..
+00021c40: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00021c50: 3a0a 2020 2020 2020 2020 2020 2020 4669  :.            Fi
+00021c60: 6273 656d 496d 6167 653a 2054 6865 206c  bsemImage: The l
+00021c70: 6173 7420 6163 7175 6972 6564 2069 6d61  ast acquired ima
+00021c80: 6765 206f 6620 7468 6520 7370 6563 6966  ge of the specif
+00021c90: 6965 6420 6265 616d 2074 7970 652e 0a0a  ied beam type...
+00021ca0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00021cb0: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
+00021cc0: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
+00021cd0: 4354 524f 4e3a 0a20 2020 2020 2020 2020  CTRON:.         
+00021ce0: 2020 205f 6368 6563 6b5f 6265 616d 2842     _check_beam(B
+00021cf0: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00021d00: 2c20 7365 6c66 2e73 7973 7465 6d29 0a20  , self.system). 
+00021d10: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00021d20: 203d 2073 656c 662e 6c61 7374 5f69 6d61   = self.last_ima
+00021d30: 6765 5f65 620a 2020 2020 2020 2020 656c  ge_eb.        el
+00021d40: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+00021d50: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+00021d60: 2020 2020 2020 2020 2020 5f63 6865 636b            _check
+00021d70: 5f62 6561 6d28 4265 616d 5479 7065 2e49  _beam(BeamType.I
+00021d80: 4f4e 2c20 7365 6c66 2e73 7973 7465 6d29  ON, self.system)
+00021d90: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+00021da0: 6765 203d 2073 656c 662e 6c61 7374 5f69  ge = self.last_i
+00021db0: 6d61 6765 5f69 620a 2020 2020 2020 2020  mage_ib.        
+00021dc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00021dd0: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+00021de0: 6e28 2242 6561 6d20 7479 7065 2065 7272  n("Beam type err
+00021df0: 6f72 2229 0a20 2020 2020 2020 2069 6620  or").        if 
+00021e00: 696d 6167 6520 6973 206e 6f74 204e 6f6e  image is not Non
+00021e10: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00021e20: 6d61 6765 2e6d 6574 6164 6174 612e 7573  mage.metadata.us
+00021e30: 6572 203d 2073 656c 662e 7573 6572 0a20  er = self.user. 
+00021e40: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00021e50: 2e6d 6574 6164 6174 612e 6578 7065 7269  .metadata.experi
+00021e60: 6d65 6e74 203d 2073 656c 662e 6578 7065  ment = self.expe
+00021e70: 7269 6d65 6e74 200a 2020 2020 2020 2020  riment .        
+00021e80: 2020 2020 696d 6167 652e 6d65 7461 6461      image.metada
+00021e90: 7461 2e73 7973 7465 6d20 3d20 7365 6c66  ta.system = self
+00021ea0: 2e73 7973 7465 6d0a 2020 2020 2020 2020  .system.        
+00021eb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00021ec0: 696d 6167 650a 0a20 2020 2064 6566 205f  image..    def _
+00021ed0: 6765 745f 7072 6573 6574 7328 7365 6c66  get_presets(self
+00021ee0: 293a 0a20 2020 2020 2020 2070 7265 7365  ):.        prese
+00021ef0: 7473 203d 2073 656c 662e 636f 6e6e 6563  ts = self.connec
+00021f00: 7469 6f6e 2e46 4942 2e50 7265 7365 742e  tion.FIB.Preset.
+00021f10: 456e 756d 2829 090a 2020 2020 2020 2020  Enum()..        
+00021f20: 7265 7475 726e 2070 7265 7365 7473 0a0a  return presets..
+00021f30: 2020 2020 6465 6620 6163 7175 6972 655f      def acquire_
+00021f40: 6368 616d 6265 725f 696d 6167 6528 7365  chamber_image(se
+00021f50: 6c66 2920 2d3e 2046 6962 7365 6d49 6d61  lf) -> FibsemIma
+00021f60: 6765 3a0a 2020 2020 2020 2020 2222 2241  ge:.        """A
+00021f70: 6371 7569 7265 2061 6e20 696d 6167 6520  cquire an image 
+00021f80: 6f66 2074 6865 2063 6861 6d62 6572 2069  of the chamber i
+00021f90: 6e73 6964 652e 2222 220a 2020 2020 2020  nside.""".      
+00021fa0: 2020 696d 6167 6520 3d20 7365 6c66 2e63    image = self.c
+00021fb0: 6f6e 6e65 6374 696f 6e2e 4361 6d65 7261  onnection.Camera
+00021fc0: 2e41 6371 7569 7265 496d 6167 6528 290a  .AcquireImage().
+00021fd0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00021fe0: 6465 6275 6728 7b22 6d73 6722 3a20 2261  debug({"msg": "a
+00021ff0: 6371 7569 7265 5f63 6861 6d62 6572 5f69  cquire_chamber_i
+00022000: 6d61 6765 227d 290a 2020 2020 2020 2020  mage"}).        
+00022010: 7265 7475 726e 2046 6962 7365 6d49 6d61  return FibsemIma
+00022020: 6765 2864 6174 613d 6e70 2e61 7272 6179  ge(data=np.array
+00022030: 2869 6d61 6765 2e49 6d61 6765 292c 206d  (image.Image), m
+00022040: 6574 6164 6174 613d 4e6f 6e65 2920 2020  etadata=None)   
+00022050: 0a0a 2020 2020 6465 6620 6c69 7665 5f69  ..    def live_i
+00022060: 6d61 6769 6e67 2873 656c 662c 2069 6d61  maging(self, ima
+00022070: 6765 5f73 6574 7469 6e67 733a 2049 6d61  ge_settings: Ima
+00022080: 6765 5365 7474 696e 6773 2c20 696d 6167  geSettings, imag
+00022090: 655f 7175 6575 653a 2051 7565 7565 2c20  e_queue: Queue, 
+000220a0: 7374 6f70 5f65 7665 6e74 3a20 7468 7265  stop_event: thre
+000220b0: 6164 696e 672e 4576 656e 7429 3a0a 2020  ading.Event):.  
+000220c0: 2020 2020 2020 7365 6c66 2e69 6d61 6765        self.image
+000220d0: 5f71 7565 7565 203d 2069 6d61 6765 5f71  _queue = image_q
+000220e0: 7565 7565 0a20 2020 2020 2020 2073 656c  ueue.        sel
+000220f0: 662e 7374 6f70 5f65 7665 6e74 203d 2073  f.stop_event = s
+00022100: 746f 705f 6576 656e 740a 2020 2020 2020  top_event.      
+00022110: 2020 5f63 6865 636b 5f62 6561 6d28 696d    _check_beam(im
+00022120: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+00022130: 6d5f 7479 7065 2c20 7365 6c66 2e73 7973  m_type, self.sys
+00022140: 7465 6d29 0a20 2020 2020 2020 206c 6f67  tem).        log
+00022150: 6769 6e67 2e69 6e66 6f28 6622 4c69 7665  ging.info(f"Live
+00022160: 2069 6d61 6769 6e67 3a20 7b69 6d61 6765   imaging: {image
+00022170: 5f73 6574 7469 6e67 732e 6265 616d 5f74  _settings.beam_t
+00022180: 7970 657d 2229 0a20 2020 2020 2020 2077  ype}").        w
+00022190: 6869 6c65 206e 6f74 2073 656c 662e 7374  hile not self.st
+000221a0: 6f70 5f65 7665 6e74 2e69 735f 7365 7428  op_event.is_set(
+000221b0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+000221c0: 6d61 6765 203d 2073 656c 662e 6163 7175  mage = self.acqu
+000221d0: 6972 655f 696d 6167 6528 6465 6570 636f  ire_image(deepco
+000221e0: 7079 2869 6d61 6765 5f73 6574 7469 6e67  py(image_setting
+000221f0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+00022200: 696d 6167 655f 7175 6575 652e 7075 7428  image_queue.put(
+00022210: 696d 6167 6529 0a0a 0a0a 2020 2020 4074  image)....    @t
+00022220: 6872 6561 645f 776f 726b 6572 0a20 2020  hread_worker.   
+00022230: 2064 6566 2063 6f6e 7375 6d65 5f69 6d61   def consume_ima
+00022240: 6765 5f71 7565 7565 2873 656c 662c 2070  ge_queue(self, p
+00022250: 6172 656e 745f 7569 203d 204e 6f6e 652c  arent_ui = None,
+00022260: 2073 6c65 6570 203d 2030 2e31 293a 0a0a   sleep = 0.1):..
+00022270: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00022280: 696e 666f 2822 436f 6e73 756d 696e 6720  info("Consuming 
+00022290: 696d 6167 6520 7175 6575 6522 290a 0a20  image queue").. 
+000222a0: 2020 2020 2020 2077 6869 6c65 206e 6f74         while not
+000222b0: 2073 656c 662e 7374 6f70 5f65 7665 6e74   self.stop_event
+000222c0: 2e69 735f 7365 7428 293a 0a20 2020 2020  .is_set():.     
+000222d0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000222e0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+000222f0: 2e73 6c65 6570 2873 6c65 6570 290a 2020  .sleep(sleep).  
+00022300: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00022310: 206e 6f74 2073 656c 662e 696d 6167 655f   not self.image_
+00022320: 7175 6575 652e 656d 7074 7928 293a 0a20  queue.empty():. 
+00022330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022340: 2020 2069 6d61 6765 203d 2073 656c 662e     image = self.
+00022350: 696d 6167 655f 7175 6575 652e 6765 7428  image_queue.get(
+00022360: 7469 6d65 6f75 743d 3129 0a20 2020 2020  timeout=1).     
+00022370: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00022380: 6620 696d 6167 652e 6d65 7461 6461 7461  f image.metadata
+00022390: 2e69 6d61 6765 5f73 6574 7469 6e67 732e  .image_settings.
+000223a0: 7361 7665 3a0a 2020 2020 2020 2020 2020  save:.          
+000223b0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+000223c0: 6167 652e 6d65 7461 6461 7461 2e69 6d61  age.metadata.ima
+000223d0: 6765 5f73 6574 7469 6e67 732e 6669 6c65  ge_settings.file
+000223e0: 6e61 6d65 203d 2066 227b 696d 6167 652e  name = f"{image.
+000223f0: 6d65 7461 6461 7461 2e69 6d61 6765 5f73  metadata.image_s
+00022400: 6574 7469 6e67 732e 6669 6c65 6e61 6d65  ettings.filename
+00022410: 7d5f 7b75 7469 6c73 2e63 7572 7265 6e74  }_{utils.current
+00022420: 5f74 696d 6573 7461 6d70 2829 7d22 2020  _timestamp()}"  
+00022430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022440: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00022450: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00022460: 696c 656e 616d 6520 3d20 6f73 2e70 6174  ilename = os.pat
+00022470: 682e 6a6f 696e 2869 6d61 6765 2e6d 6574  h.join(image.met
+00022480: 6164 6174 612e 696d 6167 655f 7365 7474  adata.image_sett
+00022490: 696e 6773 2e70 6174 682c 2069 6d61 6765  ings.path, image
+000224a0: 2e6d 6574 6164 6174 612e 696d 6167 655f  .metadata.image_
+000224b0: 7365 7474 696e 6773 2e66 696c 656e 616d  settings.filenam
+000224c0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000224d0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+000224e0: 2e73 6176 6528 7061 7468 3d66 696c 656e  .save(path=filen
+000224f0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+00022500: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00022510: 6769 6e67 2e69 6e66 6f28 6622 5361 7665  ging.info(f"Save
+00022520: 6420 696d 6167 6520 746f 207b 6669 6c65  d image to {file
+00022530: 6e61 6d65 7d22 290a 0a20 2020 2020 2020  name}")..       
+00022540: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00022550: 6769 6e67 2e69 6e66 6f28 6622 496d 6167  ging.info(f"Imag
+00022560: 653a 207b 696d 6167 652e 6461 7461 2e73  e: {image.data.s
+00022570: 6861 7065 7d22 290a 2020 2020 2020 2020  hape}").        
+00022580: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00022590: 696e 672e 696e 666f 2866 222d 2220 2a20  ing.info(f"-" * 
+000225a0: 3530 290a 0a20 2020 2020 2020 2020 2020  50)..           
+000225b0: 2020 2020 2020 2020 2069 6620 7061 7265           if pare
+000225c0: 6e74 5f75 6920 6973 206e 6f74 204e 6f6e  nt_ui is not Non
+000225d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000225e0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000225f0: 6172 656e 745f 7569 2e6c 6976 655f 696d  arent_ui.live_im
+00022600: 6167 696e 675f 7369 676e 616c 2e65 6d69  aging_signal.emi
+00022610: 7428 7b22 696d 6167 6522 3a20 696d 6167  t({"image": imag
+00022620: 657d 290a 0a0a 2020 2020 2020 2020 2020  e})...          
+00022630: 2020 6578 6365 7074 204b 6579 626f 6172    except Keyboar
+00022640: 6449 6e74 6572 7275 7074 3a0a 2020 2020  dInterrupt:.    
+00022650: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00022660: 2e73 746f 705f 6576 656e 740a 2020 2020  .stop_event.    
+00022670: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00022680: 696e 672e 696e 666f 2822 4b65 7962 6f61  ing.info("Keyboa
+00022690: 7264 2069 6e74 6572 7275 7074 2c20 7374  rd interrupt, st
+000226a0: 6f70 7069 6e67 206c 6976 6520 696d 6167  opping live imag
+000226b0: 696e 6722 290a 2020 2020 2020 2020 2020  ing").          
+000226c0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
+000226d0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
+000226e0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+000226f0: 6f70 5f65 7665 6e74 2e73 6574 2829 0a20  op_event.set(). 
+00022700: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00022710: 6d70 6f72 7420 7472 6163 6562 6163 6b0a  mport traceback.
+00022720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022730: 6c6f 6767 696e 672e 6572 726f 7228 7472  logging.error(tr
+00022740: 6163 6562 6163 6b2e 666f 726d 6174 5f65  aceback.format_e
+00022750: 7863 2829 290a 2020 2020 2020 2020 0a20  xc()).        . 
+00022760: 2020 2064 6566 2061 7574 6f63 6f6e 7472     def autocontr
+00022770: 6173 7428 7365 6c66 2c20 6265 616d 5f74  ast(self, beam_t
+00022780: 7970 653a 2042 6561 6d54 7970 6529 202d  ype: BeamType) -
+00022790: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000227a0: 2222 2241 7574 6f6d 6174 6963 616c 6c79  """Automatically
+000227b0: 2061 646a 7573 7420 7468 6520 6d69 6372   adjust the micr
+000227c0: 6f73 636f 7065 2069 6d61 6765 2063 6f6e  oscope image con
+000227d0: 7472 6173 7420 666f 7220 7468 6520 7370  trast for the sp
+000227e0: 6563 6966 6965 6420 6265 616d 2074 7970  ecified beam typ
+000227f0: 652e 0a0a 2020 2020 2020 2020 4172 6773  e...        Args
+00022800: 3a0a 2020 2020 2020 2020 2020 2020 6265  :.            be
+00022810: 616d 5f74 7970 6520 2842 6561 6d54 7970  am_type (BeamTyp
+00022820: 652c 206f 7074 696f 6e61 6c29 3a20 5468  e, optional): Th
+00022830: 6520 696d 6167 696e 6720 6265 616d 2074  e imaging beam t
+00022840: 7970 6520 666f 7220 7768 6963 6820 746f  ype for which to
+00022850: 2061 646a 7573 7420 7468 6520 636f 6e74   adjust the cont
+00022860: 7261 7374 2e0a 2020 2020 2020 2020 2020  rast..          
+00022870: 2020 2020 2020 4465 6661 756c 7473 2074        Defaults t
+00022880: 6f20 4265 616d 5479 7065 2e45 4c45 4354  o BeamType.ELECT
+00022890: 524f 4e2e 0a20 2020 2020 2020 2022 2222  RON..        """
+000228a0: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+000228b0: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+000228c0: 7365 6c66 2e73 7973 7465 6d29 0a20 2020  self.system).   
+000228d0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+000228e0: 6f28 6622 5275 6e6e 696e 6720 6175 746f  o(f"Running auto
+000228f0: 636f 6e74 7261 7374 206f 6e20 7b62 6561  contrast on {bea
+00022900: 6d5f 7479 7065 2e6e 616d 657d 2e22 290a  m_type.name}.").
+00022910: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+00022920: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
+00022930: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+00022940: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00022950: 6563 7469 6f6e 2e53 454d 2e44 6574 6563  ection.SEM.Detec
+00022960: 746f 722e 4175 746f 5369 676e 616c 2844  tor.AutoSignal(D
+00022970: 6574 6563 746f 723d 7365 6c66 2e65 6c65  etector=self.ele
+00022980: 6374 726f 6e5f 6465 7465 6374 6f72 5f61  ctron_detector_a
+00022990: 6374 6976 6529 0a20 2020 2020 2020 2069  ctive).        i
+000229a0: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
+000229b0: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+000229c0: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+000229d0: 6e6e 6563 7469 6f6e 2e46 4942 2e44 6574  nnection.FIB.Det
+000229e0: 6563 746f 722e 4175 746f 5369 676e 616c  ector.AutoSignal
+000229f0: 2844 6574 6563 746f 723d 7365 6c66 2e69  (Detector=self.i
+00022a00: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
+00022a10: 7665 290a 0a20 2020 200a 2020 2020 6465  ve)..    .    de
+00022a20: 6620 6175 746f 5f66 6f63 7573 2873 656c  f auto_focus(sel
+00022a30: 662c 2062 6561 6d5f 7479 7065 3a20 4265  f, beam_type: Be
+00022a40: 616d 5479 7065 2920 2d3e 204e 6f6e 653a  amType) -> None:
+00022a50: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+00022a60: 6265 616d 2862 6561 6d5f 7479 7065 2c20  beam(beam_type, 
+00022a70: 7365 6c66 2e73 7973 7465 6d29 0a20 2020  self.system).   
+00022a80: 2020 2020 2069 6620 6265 616d 5f74 7970       if beam_typ
+00022a90: 6520 3d3d 2042 6561 6d54 7970 652e 454c  e == BeamType.EL
+00022aa0: 4543 5452 4f4e 3a0a 2020 2020 2020 2020  ECTRON:.        
+00022ab0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00022ac0: 2822 5275 6e6e 696e 6720 6175 746f 666f  ("Running autofo
+00022ad0: 6375 7320 6f6e 2065 6c65 6374 726f 6e20  cus on electron 
+00022ae0: 6265 616d 2e22 290a 2020 2020 2020 2020  beam.").        
+00022af0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00022b00: 696f 6e2e 5345 4d2e 4175 746f 5744 4669  ion.SEM.AutoWDFi
+00022b10: 6e65 2873 656c 662e 656c 6563 7472 6f6e  ne(self.electron
+00022b20: 5f64 6574 6563 746f 725f 6163 7469 7665  _detector_active
+00022b30: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00022b40: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00022b50: 696e 672e 696e 666f 2822 4175 746f 2066  ing.info("Auto f
+00022b60: 6f63 7573 2069 7320 6e6f 7420 7375 7070  ocus is not supp
+00022b70: 6f72 7465 6420 666f 7220 696f 6e20 6265  orted for ion be
+00022b80: 616d 2074 7970 652e 2229 0a20 2020 2020  am type.").     
+00022b90: 2020 2072 6574 7572 6e20 0a0a 2020 2020     return ..    
+00022ba0: 6465 6620 7265 7365 745f 6265 616d 5f73  def reset_beam_s
+00022bb0: 6869 6674 7328 7365 6c66 293a 0a20 2020  hifts(self):.   
+00022bc0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00022bd0: 2053 6574 2074 6865 2062 6561 6d20 7368   Set the beam sh
+00022be0: 6966 7420 746f 207a 6572 6f20 666f 7220  ift to zero for 
+00022bf0: 7468 6520 656c 6563 7472 6f6e 2061 6e64  the electron and
+00022c00: 2069 6f6e 2062 6561 6d73 2e0a 0a20 2020   ion beams...   
+00022c10: 2020 2020 2052 6573 6574 7320 7468 6520       Resets the 
+00022c20: 6265 616d 2073 6869 6674 2066 6f72 2062  beam shift for b
+00022c30: 6f74 6820 7468 6520 656c 6563 7472 6f6e  oth the electron
+00022c40: 2061 6e64 2069 6f6e 2062 6561 6d73 2074   and ion beams t
+00022c50: 6f20 2830 2c30 292c 2065 6666 6563 7469  o (0,0), effecti
+00022c60: 7665 6c79 2063 656e 7465 7269 6e67 2074  vely centering t
+00022c70: 6865 2062 6561 6d73 206f 6e20 7468 6520  he beams on the 
+00022c80: 7361 6d70 6c65 2e0a 0a20 2020 2020 2020  sample...       
+00022c90: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00022ca0: 2020 2073 656c 6620 2846 6962 7365 6d4d     self (FibsemM
+00022cb0: 6963 726f 7363 6f70 6529 3a20 696e 7374  icroscope): inst
+00022cc0: 616e 6365 206f 6620 7468 6520 4669 6273  ance of the Fibs
+00022cd0: 656d 4d69 6372 6f73 636f 7065 206f 626a  emMicroscope obj
+00022ce0: 6563 740a 2020 2020 2020 2020 2222 220a  ect.        """.
+00022cf0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00022d00: 6561 6d28 4265 616d 5479 7065 2e45 4c45  eam(BeamType.ELE
+00022d10: 4354 524f 4e2c 2073 656c 662e 7379 7374  CTRON, self.syst
+00022d20: 656d 290a 2020 2020 2020 2020 6c6f 6767  em).        logg
+00022d30: 696e 672e 6465 6275 6728 0a20 2020 2020  ing.debug(.     
+00022d40: 2020 2020 2020 2066 2272 6573 6574 696e         f"resetin
+00022d50: 6720 6562 6561 6d20 7368 6966 7420 746f  g ebeam shift to
+00022d60: 2028 302c 2030 2920 6672 6f6d 3a20 7b73   (0, 0) from: {s
+00022d70: 656c 662e 636f 6e6e 6563 7469 6f6e 2e46  elf.connection.F
+00022d80: 4942 2e4f 7074 6963 732e 4765 7449 6d61  IB.Optics.GetIma
+00022d90: 6765 5368 6966 7428 297d 2028 6d6d 2922  geShift()} (mm)"
+00022da0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00022db0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+00022dc0: 6f6e 2e46 4942 2e4f 7074 6963 732e 5365  on.FIB.Optics.Se
+00022dd0: 7449 6d61 6765 5368 6966 7428 302c 2030  tImageShift(0, 0
+00022de0: 290a 2020 2020 2020 2020 5f63 6865 636b  ).        _check
+00022df0: 5f62 6561 6d28 4265 616d 5479 7065 2e49  _beam(BeamType.I
+00022e00: 4f4e 2c20 7365 6c66 2e73 7973 7465 6d29  ON, self.system)
+00022e10: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00022e20: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00022e30: 2020 2020 6622 7265 7365 7469 6e67 2065      f"reseting e
+00022e40: 6265 616d 2073 6869 6674 2074 6f20 2830  beam shift to (0
+00022e50: 2c20 3029 2066 726f 6d3a 207b 7365 6c66  , 0) from: {self
+00022e60: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d2e  .connection.SEM.
+00022e70: 4f70 7469 6373 2e47 6574 496d 6167 6553  Optics.GetImageS
+00022e80: 6869 6674 2829 7d20 286d 6d29 220a 2020  hift()} (mm)".  
+00022e90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00022ea0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00022eb0: 5345 4d2e 4f70 7469 6373 2e53 6574 496d  SEM.Optics.SetIm
+00022ec0: 6167 6553 6869 6674 2830 2c20 3029 0a0a  ageShift(0, 0)..
+00022ed0: 0a20 2020 2064 6566 2062 6561 6d5f 7368  .    def beam_sh
+00022ee0: 6966 7428 7365 6c66 2c20 6478 3a20 666c  ift(self, dx: fl
+00022ef0: 6f61 742c 2064 793a 2066 6c6f 6174 2c20  oat, dy: float, 
+00022f00: 6265 616d 5f74 7970 653a 2042 6561 6d54  beam_type: BeamT
+00022f10: 7970 6520 3d20 4265 616d 5479 7065 2e49  ype = BeamType.I
+00022f20: 4f4e 293a 0a20 2020 2020 2020 2022 2222  ON):.        """
+00022f30: 4164 6a75 7374 7320 7468 6520 6265 616d  Adjusts the beam
+00022f40: 2073 6869 6674 2062 6173 6564 206f 6e20   shift based on 
+00022f50: 7265 6c61 7469 7665 2076 616c 7565 7320  relative values 
+00022f60: 7468 6174 2061 7265 2070 726f 7669 6465  that are provide
+00022f70: 642e 0a20 2020 2020 2020 200a 2020 2020  d..        .    
+00022f80: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00022f90: 2020 2020 2020 7365 6c66 2028 4669 6273        self (Fibs
+00022fa0: 656d 4d69 6372 6f73 636f 7065 293a 2046  emMicroscope): F
+00022fb0: 6962 7365 6d20 6d69 6372 6f73 636f 7065  ibsem microscope
+00022fc0: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
+00022fd0: 2020 2020 6478 2028 666c 6f61 7429 3a20      dx (float): 
+00022fe0: 7468 6520 7265 6c61 7469 7665 2078 2074  the relative x t
+00022ff0: 6572 6d0a 2020 2020 2020 2020 2020 2020  erm.            
+00023000: 6479 2028 666c 6f61 7429 3a20 7468 6520  dy (float): the 
+00023010: 7265 6c61 7469 7665 2079 2074 6572 6d0a  relative y term.
+00023020: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00023030: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+00023040: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
+00023050: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+00023060: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+00023070: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+00023080: 2020 2020 2020 2020 2020 6265 616d 203d            beam =
+00023090: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+000230a0: 2e46 4942 2e4f 7074 6963 730a 2020 2020  .FIB.Optics.    
+000230b0: 2020 2020 656c 6966 2062 6561 6d5f 7479      elif beam_ty
+000230c0: 7065 203d 3d20 4265 616d 5479 7065 2e45  pe == BeamType.E
+000230d0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
+000230e0: 2020 2020 2062 6561 6d20 3d20 7365 6c66       beam = self
+000230f0: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d2e  .connection.SEM.
+00023100: 4f70 7469 6373 0a20 2020 2020 2020 206c  Optics.        l
+00023110: 6f67 6769 6e67 2e69 6e66 6f28 6622 7b62  ogging.info(f"{b
+00023120: 6561 6d5f 7479 7065 2e6e 616d 657d 2073  eam_type.name} s
+00023130: 6869 6674 696e 6720 6279 2028 7b64 787d  hifting by ({dx}
+00023140: 2c20 7b64 797d 2922 290a 2020 2020 2020  , {dy})").      
+00023150: 2020 782c 2079 203d 2062 6561 6d2e 4765    x, y = beam.Ge
+00023160: 7449 6d61 6765 5368 6966 7428 290a 2020  tImageShift().  
+00023170: 2020 2020 2020 6478 202a 3d20 2063 6f6e        dx *=  con
+00023180: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+00023190: 4d49 4c4c 494d 4554 5245 2023 2043 6f6e  MILLIMETRE # Con
+000231a0: 7665 7274 2074 6f20 6d6d 2066 726f 6d20  vert to mm from 
+000231b0: 6d2e 0a20 2020 2020 2020 2064 7920 2a3d  m..        dy *=
+000231c0: 2020 636f 6e73 7461 6e74 732e 4d45 5452    constants.METR
+000231d0: 455f 544f 5f4d 494c 4c49 4d45 5452 450a  E_TO_MILLIMETRE.
+000231e0: 2020 2020 2020 2020 7820 2b3d 2064 7820          x += dx 
+000231f0: 0a20 2020 2020 2020 2079 202b 3d20 6479  .        y += dy
+00023200: 0a20 2020 2020 2020 2062 6561 6d2e 5365  .        beam.Se
+00023210: 7449 6d61 6765 5368 6966 7428 782c 7929  tImageShift(x,y)
+00023220: 200a 0a20 2020 2020 2020 206c 6f67 6769   ..        loggi
+00023230: 6e67 2e64 6562 7567 287b 226d 7367 223a  ng.debug({"msg":
+00023240: 2022 6265 616d 5f73 6869 6674 222c 2022   "beam_shift", "
+00023250: 6478 223a 2064 782c 2022 6479 223a 2064  dx": dx, "dy": d
+00023260: 792c 2022 6265 616d 5f74 7970 6522 3a20  y, "beam_type": 
+00023270: 6265 616d 5f74 7970 652e 6e61 6d65 7d29  beam_type.name})
+00023280: 200a 2020 2020 2020 2020 0a20 2020 2064   .        .    d
+00023290: 6566 2067 6574 5f73 7461 6765 5f70 6f73  ef get_stage_pos
+000232a0: 6974 696f 6e28 7365 6c66 293a 0a20 2020  ition(self):.   
+000232b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000232c0: 2047 6574 2074 6865 2063 7572 7265 6e74   Get the current
+000232d0: 2073 7461 6765 2070 6f73 6974 696f 6e2e   stage position.
+000232e0: 0a0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
+000232f0: 6574 686f 6420 7265 7472 6965 7665 7320  ethod retrieves 
+00023300: 7468 6520 6375 7272 656e 7420 7374 6167  the current stag
+00023310: 6520 706f 7369 7469 6f6e 2066 726f 6d20  e position from 
+00023320: 7468 6520 6d69 6372 6f73 636f 7065 2061  the microscope a
+00023330: 6e64 2072 6574 7572 6e73 2069 7420 6173  nd returns it as
+00023340: 0a20 2020 2020 2020 2061 2046 6962 7365  .        a Fibse
+00023350: 6d53 7461 6765 506f 7369 7469 6f6e 206f  mStagePosition o
+00023360: 626a 6563 742e 0a0a 2020 2020 2020 2020  bject...        
+00023370: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00023380: 2020 2020 2046 6962 7365 6d53 7461 6765       FibsemStage
+00023390: 506f 7369 7469 6f6e 3a20 5468 6520 6375  Position: The cu
+000233a0: 7272 656e 7420 7374 6167 6520 706f 7369  rrent stage posi
+000233b0: 7469 6f6e 2e0a 2020 2020 2020 2020 2222  tion..        ""
+000233c0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+000233d0: 662e 7379 7374 656d 2e73 7461 6765 5f65  f.system.stage_e
+000233e0: 6e61 626c 6564 2069 7320 4661 6c73 653a  nabled is False:
+000233f0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00023400: 7365 204e 6f74 496d 706c 656d 656e 7465  se NotImplemente
+00023410: 6445 7272 6f72 2822 5374 6167 6520 6973  dError("Stage is
+00023420: 206e 6f74 2065 6e61 626c 6564 2e22 290a   not enabled.").
+00023430: 2020 2020 2020 2020 782c 2079 2c20 7a2c          x, y, z,
+00023440: 2072 2c20 7420 3d20 7365 6c66 2e63 6f6e   r, t = self.con
+00023450: 6e65 6374 696f 6e2e 5374 6167 652e 4765  nection.Stage.Ge
+00023460: 7450 6f73 6974 696f 6e28 290a 2020 2020  tPosition().    
+00023470: 2020 2020 7374 6167 655f 706f 7369 7469      stage_positi
+00023480: 6f6e 203d 2046 6962 7365 6d53 7461 6765  on = FibsemStage
+00023490: 506f 7369 7469 6f6e 280a 2020 2020 2020  Position(.      
+000234a0: 2020 2020 2020 7820 3d20 7820 2a20 636f        x = x * co
+000234b0: 6e73 7461 6e74 732e 4d49 4c4c 494d 4554  nstants.MILLIMET
+000234c0: 5245 5f54 4f5f 4d45 5452 452c 0a20 2020  RE_TO_METRE,.   
+000234d0: 2020 2020 2020 2020 2079 203d 2079 202a           y = y *
+000234e0: 2063 6f6e 7374 616e 7473 2e4d 494c 4c49   constants.MILLI
+000234f0: 4d45 5452 455f 544f 5f4d 4554 5245 2c0a  METRE_TO_METRE,.
+00023500: 2020 2020 2020 2020 2020 2020 7a20 3d20              z = 
+00023510: 7a20 2a20 636f 6e73 7461 6e74 732e 4d49  z * constants.MI
+00023520: 4c4c 494d 4554 5245 5f54 4f5f 4d45 5452  LLIMETRE_TO_METR
+00023530: 452c 0a20 2020 2020 2020 2020 2020 2072  E,.            r
+00023540: 203d 2072 202a 2063 6f6e 7374 616e 7473   = r * constants
+00023550: 2e44 4547 5245 4553 5f54 4f5f 5241 4449  .DEGREES_TO_RADI
+00023560: 414e 532c 0a20 2020 2020 2020 2020 2020  ANS,.           
+00023570: 2074 203d 2074 202a 2063 6f6e 7374 616e   t = t * constan
+00023580: 7473 2e44 4547 5245 4553 5f54 4f5f 5241  ts.DEGREES_TO_RA
+00023590: 4449 414e 532c 0a20 2020 2020 2020 2020  DIANS,.         
+000235a0: 2020 2063 6f6f 7264 696e 6174 655f 7379     coordinate_sy
+000235b0: 7374 656d 3d20 2252 4157 222c 0a20 2020  stem= "RAW",.   
+000235c0: 2020 2020 2029 0a20 2020 2020 2020 206c       ).        l
+000235d0: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
+000235e0: 7367 223a 2022 6765 745f 7374 6167 655f  sg": "get_stage_
+000235f0: 706f 7369 7469 6f6e 222c 2022 706f 7322  position", "pos"
+00023600: 3a20 7374 6167 655f 706f 7369 7469 6f6e  : stage_position
+00023610: 2e74 6f5f 6469 6374 2829 7d29 0a20 2020  .to_dict()}).   
+00023620: 2020 2020 2072 6574 7572 6e20 7374 6167       return stag
+00023630: 655f 706f 7369 7469 6f6e 0a0a 2020 2020  e_position..    
+00023640: 6465 6620 6765 745f 6d69 6372 6f73 636f  def get_microsco
+00023650: 7065 5f73 7461 7465 2873 656c 6629 202d  pe_state(self) -
+00023660: 3e20 4d69 6372 6f73 636f 7065 5374 6174  > MicroscopeStat
+00023670: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+00023680: 2020 2020 2020 2047 6574 2074 6865 2063         Get the c
+00023690: 7572 7265 6e74 206d 6963 726f 7363 6f70  urrent microscop
+000236a0: 6520 7374 6174 650a 0a20 2020 2020 2020  e state..       
+000236b0: 2054 6869 7320 6d65 7468 6f64 2072 6574   This method ret
+000236c0: 7269 6576 6573 2074 6865 2063 7572 7265  rieves the curre
+000236d0: 6e74 206d 6963 726f 7363 6f70 6520 7374  nt microscope st
+000236e0: 6174 6520 6672 6f6d 2074 6865 206d 6963  ate from the mic
+000236f0: 726f 7363 6f70 6520 616e 6420 7265 7475  roscope and retu
+00023700: 726e 7320 6974 2061 730a 2020 2020 2020  rns it as.      
+00023710: 2020 6120 4d69 6372 6f73 636f 7065 5374    a MicroscopeSt
+00023720: 6174 6520 6f62 6a65 6374 2e0a 0a20 2020  ate object...   
+00023730: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+00023740: 2020 2020 2020 2020 2020 4d69 6372 6f73            Micros
+00023750: 636f 7065 5374 6174 653a 2063 7572 7265  copeState: curre
+00023760: 6e74 206d 6963 726f 7363 6f70 6520 7374  nt microscope st
+00023770: 6174 650a 2020 2020 2020 2020 2222 220a  ate.        """.
+00023780: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00023790: 2e73 7973 7465 6d2e 656c 6563 7472 6f6e  .system.electron
+000237a0: 2069 7320 5472 7565 3a0a 2020 2020 2020   is True:.      
+000237b0: 2020 2020 2020 696d 6167 655f 6562 203d        image_eb =
+000237c0: 2073 656c 662e 6c61 7374 5f69 6d61 6765   self.last_image
+000237d0: 2842 6561 6d54 7970 652e 454c 4543 5452  (BeamType.ELECTR
+000237e0: 4f4e 290a 2020 2020 2020 2020 2020 2020  ON).            
+000237f0: 6966 2069 6d61 6765 5f65 6220 6973 206e  if image_eb is n
+00023800: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00023810: 2020 2020 2020 2020 2065 6c65 6374 726f           electro
+00023820: 6e5f 6265 616d 203d 2042 6561 6d53 6574  n_beam = BeamSet
+00023830: 7469 6e67 7328 0a20 2020 2020 2020 2020  tings(.         
+00023840: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
+00023850: 3d42 6561 6d54 7970 652e 454c 4543 5452  =BeamType.ELECTR
+00023860: 4f4e 2c0a 2020 2020 2020 2020 2020 2020  ON,.            
+00023870: 2020 2020 776f 726b 696e 675f 6469 7374      working_dist
+00023880: 616e 6365 3d73 656c 662e 636f 6e6e 6563  ance=self.connec
+00023890: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
+000238a0: 4765 7457 4428 2920 2a20 636f 6e73 7461  GetWD() * consta
+000238b0: 6e74 732e 4d49 4c4c 494d 4554 5245 5f54  nts.MILLIMETRE_T
+000238c0: 4f5f 4d45 5452 452c 0a20 2020 2020 2020  O_METRE,.       
+000238d0: 2020 2020 2020 2020 2062 6561 6d5f 6375           beam_cu
+000238e0: 7272 656e 743d 7365 6c66 2e63 6f6e 6e65  rrent=self.conne
+000238f0: 6374 696f 6e2e 5345 4d2e 4265 616d 2e47  ction.SEM.Beam.G
+00023900: 6574 4375 7272 656e 7428 2920 2a20 636f  etCurrent() * co
+00023910: 6e73 7461 6e74 732e 5049 434f 5f54 4f5f  nstants.PICO_TO_
+00023920: 5349 2c0a 2020 2020 2020 2020 2020 2020  SI,.            
+00023930: 2020 2020 766f 6c74 6167 653d 7365 6c66      voltage=self
+00023940: 2e63 6f6e 6e65 6374 696f 6e2e 5345 4d2e  .connection.SEM.
+00023950: 4265 616d 2e47 6574 566f 6c74 6167 6528  Beam.GetVoltage(
+00023960: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00023970: 2020 2068 6677 3d73 656c 662e 636f 6e6e     hfw=self.conn
+00023980: 6563 7469 6f6e 2e53 454d 2e4f 7074 6963  ection.SEM.Optic
+00023990: 732e 4765 7456 6965 7766 6965 6c64 2829  s.GetViewfield()
+000239a0: 202a 2063 6f6e 7374 616e 7473 2e4d 494c   * constants.MIL
+000239b0: 4c49 4d45 5452 455f 544f 5f4d 4554 5245  LIMETRE_TO_METRE
+000239c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000239d0: 2020 7265 736f 6c75 7469 6f6e 3d69 6d61    resolution=ima
+000239e0: 6765 5f65 622e 6d65 7461 6461 7461 2e69  ge_eb.metadata.i
+000239f0: 6d61 6765 5f73 6574 7469 6e67 732e 7265  mage_settings.re
+00023a00: 736f 6c75 7469 6f6e 2c20 2023 2054 4f44  solution,  # TOD
+00023a10: 4f20 6669 7820 7468 6573 6520 656d 7074  O fix these empt
+00023a20: 7920 7061 7261 6d65 7465 7273 0a20 2020  y parameters.   
+00023a30: 2020 2020 2020 2020 2020 2020 2064 7765               dwe
+00023a40: 6c6c 5f74 696d 653d 696d 6167 655f 6562  ll_time=image_eb
+00023a50: 2e6d 6574 6164 6174 612e 696d 6167 655f  .metadata.image_
+00023a60: 7365 7474 696e 6773 2e64 7765 6c6c 5f74  settings.dwell_t
+00023a70: 696d 652c 0a20 2020 2020 2020 2020 2020  ime,.           
+00023a80: 2020 2020 2073 7469 676d 6174 696f 6e3d       stigmation=
+00023a90: 696d 6167 655f 6562 2e6d 6574 6164 6174  image_eb.metadat
+00023aa0: 612e 6d69 6372 6f73 636f 7065 5f73 7461  a.microscope_sta
+00023ab0: 7465 2e65 6c65 6374 726f 6e5f 6265 616d  te.electron_beam
+00023ac0: 2e73 7469 676d 6174 696f 6e2c 0a20 2020  .stigmation,.   
+00023ad0: 2020 2020 2020 2020 2020 2020 2073 6869               shi
+00023ae0: 6674 3d69 6d61 6765 5f65 622e 6d65 7461  ft=image_eb.meta
+00023af0: 6461 7461 2e6d 6963 726f 7363 6f70 655f  data.microscope_
+00023b00: 7374 6174 652e 656c 6563 7472 6f6e 5f62  state.electron_b
+00023b10: 6561 6d2e 7368 6966 742c 0a20 2020 2020  eam.shift,.     
+00023b20: 2020 2020 2020 2020 2020 2073 6361 6e5f             scan_
+00023b30: 726f 7461 7469 6f6e 3d73 656c 662e 636f  rotation=self.co
+00023b40: 6e6e 6563 7469 6f6e 2e53 454d 2e4f 7074  nnection.SEM.Opt
+00023b50: 6963 732e 4765 7449 6d61 6765 526f 7461  ics.GetImageRota
+00023b60: 7469 6f6e 2829 0a20 2020 2020 2020 2020  tion().         
+00023b70: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00023b80: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00023b90: 2020 2020 2020 2065 6c65 6374 726f 6e5f         electron_
+00023ba0: 6265 616d 203d 2042 6561 6d53 6574 7469  beam = BeamSetti
+00023bb0: 6e67 7328 4265 616d 5479 7065 2e45 4c45  ngs(BeamType.ELE
+00023bc0: 4354 524f 4e29 0a20 2020 2020 2020 2065  CTRON).        e
+00023bd0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00023be0: 2065 6c65 6374 726f 6e5f 6265 616d 203d   electron_beam =
+00023bf0: 2042 6561 6d53 6574 7469 6e67 7328 4265   BeamSettings(Be
+00023c00: 616d 5479 7065 2e45 4c45 4354 524f 4e29  amType.ELECTRON)
+00023c10: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00023c20: 2020 6966 2073 656c 662e 7379 7374 656d    if self.system
+00023c30: 2e69 6f6e 2069 7320 5472 7565 3a0a 2020  .ion is True:.  
+00023c40: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+00023c50: 6962 203d 2073 656c 662e 6c61 7374 5f69  ib = self.last_i
+00023c60: 6d61 6765 2842 6561 6d54 7970 652e 494f  mage(BeamType.IO
+00023c70: 4e29 0a20 2020 2020 2020 2020 2020 2069  N).            i
+00023c80: 6620 696d 6167 655f 6962 2069 7320 6e6f  f image_ib is no
+00023c90: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00023ca0: 2020 2020 2020 2020 696f 6e5f 6265 616d          ion_beam
+00023cb0: 203d 2042 6561 6d53 6574 7469 6e67 7328   = BeamSettings(
+00023cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023cd0: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
+00023ce0: 7065 3d42 6561 6d54 7970 652e 494f 4e2c  pe=BeamType.ION,
+00023cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023d00: 2020 2020 2020 2020 2077 6f72 6b69 6e67           working
+00023d10: 5f64 6973 7461 6e63 653d 696d 6167 655f  _distance=image_
+00023d20: 6962 2e6d 6574 6164 6174 612e 6d69 6372  ib.metadata.micr
+00023d30: 6f73 636f 7065 5f73 7461 7465 2e69 6f6e  oscope_state.ion
+00023d40: 5f62 6561 6d2e 776f 726b 696e 675f 6469  _beam.working_di
+00023d50: 7374 616e 6365 2c0a 2020 2020 2020 2020  stance,.        
+00023d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d70: 6265 616d 5f63 7572 7265 6e74 3d73 656c  beam_current=sel
+00023d80: 662e 636f 6e6e 6563 7469 6f6e 2e46 4942  f.connection.FIB
+00023d90: 2e42 6561 6d2e 5265 6164 5072 6f62 6543  .Beam.ReadProbeC
+00023da0: 7572 7265 6e74 2829 202a 2063 6f6e 7374  urrent() * const
+00023db0: 616e 7473 2e50 4943 4f5f 544f 5f53 492c  ants.PICO_TO_SI,
+00023dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023dd0: 2020 2020 2020 2020 2076 6f6c 7461 6765           voltage
+00023de0: 3d73 656c 662e 636f 6e6e 6563 7469 6f6e  =self.connection
+00023df0: 2e46 4942 2e42 6561 6d2e 4765 7456 6f6c  .FIB.Beam.GetVol
+00023e00: 7461 6765 2829 2c0a 2020 2020 2020 2020  tage(),.        
+00023e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e20: 6866 773d 7365 6c66 2e63 6f6e 6e65 6374  hfw=self.connect
+00023e30: 696f 6e2e 4649 422e 4f70 7469 6373 2e47  ion.FIB.Optics.G
+00023e40: 6574 5669 6577 6669 656c 6428 2920 2a20  etViewfield() * 
+00023e50: 636f 6e73 7461 6e74 732e 4d49 4c4c 494d  constants.MILLIM
+00023e60: 4554 5245 5f54 4f5f 4d45 5452 452c 0a20  ETRE_TO_METRE,. 
+00023e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e80: 2020 2020 2020 2072 6573 6f6c 7574 696f         resolutio
+00023e90: 6e3d 696d 6167 655f 6962 2e6d 6574 6164  n=image_ib.metad
+00023ea0: 6174 612e 696d 6167 655f 7365 7474 696e  ata.image_settin
+00023eb0: 6773 2e72 6573 6f6c 7574 696f 6e2c 0a20  gs.resolution,. 
+00023ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ed0: 2020 2020 2020 2064 7765 6c6c 5f74 696d         dwell_tim
+00023ee0: 653d 696d 6167 655f 6962 2e6d 6574 6164  e=image_ib.metad
+00023ef0: 6174 612e 696d 6167 655f 7365 7474 696e  ata.image_settin
+00023f00: 6773 2e64 7765 6c6c 5f74 696d 652c 0a20  gs.dwell_time,. 
+00023f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f20: 2020 2020 2020 2073 7469 676d 6174 696f         stigmatio
+00023f30: 6e3d 696d 6167 655f 6962 2e6d 6574 6164  n=image_ib.metad
+00023f40: 6174 612e 6d69 6372 6f73 636f 7065 5f73  ata.microscope_s
+00023f50: 7461 7465 2e69 6f6e 5f62 6561 6d2e 7374  tate.ion_beam.st
+00023f60: 6967 6d61 7469 6f6e 2c0a 2020 2020 2020  igmation,.      
+00023f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f80: 2020 7368 6966 743d 696d 6167 655f 6962    shift=image_ib
+00023f90: 2e6d 6574 6164 6174 612e 6d69 6372 6f73  .metadata.micros
+00023fa0: 636f 7065 5f73 7461 7465 2e69 6f6e 5f62  cope_state.ion_b
+00023fb0: 6561 6d2e 7368 6966 742c 0a20 2020 2020  eam.shift,.     
+00023fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023fd0: 2020 2073 6361 6e5f 726f 7461 7469 6f6e     scan_rotation
+00023fe0: 3d73 656c 662e 636f 6e6e 6563 7469 6f6e  =self.connection
+00023ff0: 2e46 4942 2e4f 7074 6963 732e 4765 7449  .FIB.Optics.GetI
+00024000: 6d61 6765 526f 7461 7469 6f6e 2829 0a20  mageRotation(). 
+00024010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024020: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00024030: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00024040: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00024050: 2020 2020 2020 2020 696f 6e5f 6265 616d          ion_beam
+00024060: 203d 2042 6561 6d53 6574 7469 6e67 7328   = BeamSettings(
+00024070: 4265 616d 5479 7065 2e49 4f4e 290a 2020  BeamType.ION).  
+00024080: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00024090: 2020 2020 2020 2020 696f 6e5f 6265 616d          ion_beam
+000240a0: 203d 2042 6561 6d53 6574 7469 6e67 7328   = BeamSettings(
+000240b0: 4265 616d 5479 7065 2e49 4f4e 290a 2020  BeamType.ION).  
+000240c0: 2020 0a20 2020 2020 2020 2065 6c65 6374    .        elect
+000240d0: 726f 6e5f 6465 7465 6374 6f72 203d 2073  ron_detector = s
+000240e0: 656c 662e 6765 745f 6465 7465 6374 6f72  elf.get_detector
+000240f0: 5f73 6574 7469 6e67 7328 4265 616d 5479  _settings(BeamTy
+00024100: 7065 2e45 4c45 4354 524f 4e29 0a20 2020  pe.ELECTRON).   
+00024110: 2020 2020 2069 6f6e 5f64 6574 6563 746f       ion_detecto
+00024120: 7220 3d20 7365 6c66 2e67 6574 5f64 6574  r = self.get_det
+00024130: 6563 746f 725f 7365 7474 696e 6773 2842  ector_settings(B
+00024140: 6561 6d54 7970 652e 494f 4e29 0a0a 2020  eamType.ION)..  
+00024150: 2020 2020 2020 6375 7272 656e 745f 6d69        current_mi
+00024160: 6372 6f73 636f 7065 5f73 7461 7465 203d  croscope_state =
+00024170: 204d 6963 726f 7363 6f70 6553 7461 7465   MicroscopeState
+00024180: 280a 2020 2020 2020 2020 2020 2020 7469  (.            ti
+00024190: 6d65 7374 616d 703d 6461 7465 7469 6d65  mestamp=datetime
+000241a0: 2e64 6174 6574 696d 652e 7469 6d65 7374  .datetime.timest
+000241b0: 616d 7028 6461 7465 7469 6d65 2e64 6174  amp(datetime.dat
+000241c0: 6574 696d 652e 6e6f 7728 2929 2c0a 2020  etime.now()),.  
+000241d0: 2020 2020 2020 2020 2020 2320 6765 7420            # get 
+000241e0: 6162 736f 6c75 7465 2073 7461 6765 2063  absolute stage c
+000241f0: 6f6f 7264 696e 6174 6573 2028 5241 5729  oordinates (RAW)
+00024200: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00024210: 6765 5f70 6f73 6974 696f 6e3d 7365 6c66  ge_position=self
+00024220: 2e67 6574 5f73 7461 6765 5f70 6f73 6974  .get_stage_posit
+00024230: 696f 6e28 292c 0a20 2020 2020 2020 2020  ion(),.         
+00024240: 2020 2023 2065 6c65 6374 726f 6e20 6265     # electron be
+00024250: 616d 2073 6574 7469 6e67 730a 2020 2020  am settings.    
+00024260: 2020 2020 2020 2020 656c 6563 7472 6f6e          electron
+00024270: 5f62 6561 6d3d 656c 6563 7472 6f6e 5f62  _beam=electron_b
+00024280: 6561 6d2c 0a20 2020 2020 2020 2020 2020  eam,.           
+00024290: 2023 2069 6f6e 2062 6561 6d20 7365 7474   # ion beam sett
+000242a0: 696e 6773 0a20 2020 2020 2020 2020 2020  ings.           
+000242b0: 2069 6f6e 5f62 6561 6d3d 696f 6e5f 6265   ion_beam=ion_be
+000242c0: 616d 2c0a 2020 2020 2020 2020 2020 2020  am,.            
+000242d0: 2320 656c 6563 7472 6f6e 2064 6574 6563  # electron detec
+000242e0: 746f 7220 7365 7474 696e 6773 0a20 2020  tor settings.   
+000242f0: 2020 2020 2020 2020 2065 6c65 6374 726f           electro
+00024300: 6e5f 6465 7465 6374 6f72 3d65 6c65 6374  n_detector=elect
+00024310: 726f 6e5f 6465 7465 6374 6f72 2c0a 2020  ron_detector,.  
+00024320: 2020 2020 2020 2020 2020 2320 696f 6e20            # ion 
+00024330: 6465 7465 6374 6f72 2073 6574 7469 6e67  detector setting
+00024340: 730a 2020 2020 2020 2020 2020 2020 696f  s.            io
+00024350: 6e5f 6465 7465 6374 6f72 3d69 6f6e 5f64  n_detector=ion_d
+00024360: 6574 6563 746f 722c 0a20 2020 2020 2020  etector,.       
+00024370: 2029 0a0a 2020 2020 2020 2020 6c6f 6767   )..        logg
+00024380: 696e 672e 6465 6275 6728 7b22 6d73 6722  ing.debug({"msg"
+00024390: 3a20 2267 6574 5f6d 6963 726f 7363 6f70  : "get_microscop
+000243a0: 655f 7374 6174 6522 2c20 2273 7461 7465  e_state", "state
+000243b0: 223a 2063 7572 7265 6e74 5f6d 6963 726f  ": current_micro
+000243c0: 7363 6f70 655f 7374 6174 652e 746f 5f64  scope_state.to_d
+000243d0: 6963 7428 297d 290a 0a20 2020 2020 2020  ict()})..       
+000243e0: 2072 6574 7572 6e20 6375 7272 656e 745f   return current_
+000243f0: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+00024400: 0a0a 2020 2020 6465 6620 7361 6665 5f61  ..    def safe_a
+00024410: 6273 6f6c 7574 655f 7374 6167 655f 6d6f  bsolute_stage_mo
+00024420: 7665 6d65 6e74 2873 656c 662c 2073 7461  vement(self, sta
+00024430: 6765 5f70 6f73 6974 696f 6e3a 2046 6962  ge_position: Fib
+00024440: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00024450: 0a20 2020 2020 2020 2029 202d 3e20 4e6f  .        ) -> No
+00024460: 6e65 3a0a 0a20 2020 2020 2020 2023 2054  ne:..        # T
+00024470: 4f44 4f3a 2069 6d70 6c65 6d65 6e74 2069  ODO: implement i
+00024480: 6620 7265 7175 6972 6564 2e0a 2020 2020  f required..    
+00024490: 2020 2020 7365 6c66 2e6d 6f76 655f 7374      self.move_st
+000244a0: 6167 655f 6162 736f 6c75 7465 2873 7461  age_absolute(sta
+000244b0: 6765 5f70 6f73 6974 696f 6e29 0a20 2020  ge_position).   
+000244c0: 200a 2020 2020 6465 6620 7072 6f6a 6563   .    def projec
+000244d0: 745f 7374 6162 6c65 5f6d 6f76 6528 7365  t_stable_move(se
+000244e0: 6c66 2c20 6478 3a66 6c6f 6174 2c20 6479  lf, dx:float, dy
+000244f0: 3a66 6c6f 6174 2c20 6265 616d 5f74 7970  :float, beam_typ
+00024500: 653a 4265 616d 5479 7065 2c20 6261 7365  e:BeamType, base
+00024510: 5f70 6f73 6974 696f 6e3a 4669 6273 656d  _position:Fibsem
+00024520: 5374 6167 6550 6f73 6974 696f 6e29 202d  StagePosition) -
+00024530: 3e20 4669 6273 656d 5374 6167 6550 6f73  > FibsemStagePos
+00024540: 6974 696f 6e3a 0a20 2020 2020 2020 2069  ition:.        i
+00024550: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
+00024560: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00024570: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+00024580: 6167 655f 726f 7461 7469 6f6e 203d 2073  age_rotation = s
+00024590: 656c 662e 636f 6e6e 6563 7469 6f6e 2e53  elf.connection.S
+000245a0: 454d 2e4f 7074 6963 732e 4765 7449 6d61  EM.Optics.GetIma
+000245b0: 6765 526f 7461 7469 6f6e 2829 0a20 2020  geRotation().   
+000245c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000245d0: 2020 2020 2020 2069 6d61 6765 5f72 6f74         image_rot
+000245e0: 6174 696f 6e20 3d20 7365 6c66 2e63 6f6e  ation = self.con
+000245f0: 6e65 6374 696f 6e2e 4649 422e 4f70 7469  nection.FIB.Opti
+00024600: 6373 2e47 6574 496d 6167 6552 6f74 6174  cs.GetImageRotat
+00024610: 696f 6e28 290a 0a20 2020 2020 2020 2069  ion()..        i
+00024620: 6620 6e70 2e69 736e 616e 2869 6d61 6765  f np.isnan(image
+00024630: 5f72 6f74 6174 696f 6e29 3a0a 2020 2020  _rotation):.    
+00024640: 2020 2020 2020 2020 696d 6167 655f 726f          image_ro
+00024650: 7461 7469 6f6e 203d 2030 2e30 0a0a 2020  tation = 0.0..  
+00024660: 2020 2020 2020 6478 203d 2020 2d28 6478        dx =  -(dx
+00024670: 2a6e 702e 636f 7328 696d 6167 655f 726f  *np.cos(image_ro
+00024680: 7461 7469 6f6e 2a6e 702e 7069 2f31 3830  tation*np.pi/180
+00024690: 2920 2b20 6479 2a6e 702e 7369 6e28 696d  ) + dy*np.sin(im
+000246a0: 6167 655f 726f 7461 7469 6f6e 2a6e 702e  age_rotation*np.
+000246b0: 7069 2f31 3830 2929 0a20 2020 2020 2020  pi/180)).       
+000246c0: 2064 7920 3d20 2d28 6479 2a6e 702e 636f   dy = -(dy*np.co
+000246d0: 7328 696d 6167 655f 726f 7461 7469 6f6e  s(image_rotation
+000246e0: 2a6e 702e 7069 2f31 3830 2920 2d20 6478  *np.pi/180) - dx
+000246f0: 2a6e 702e 7369 6e28 696d 6167 655f 726f  *np.sin(image_ro
+00024700: 7461 7469 6f6e 2a6e 702e 7069 2f31 3830  tation*np.pi/180
+00024710: 2929 0a20 2020 2020 2020 2070 6f69 6e74  )).        point
+00024720: 5f79 7a20 3d20 7365 6c66 2e5f 795f 636f  _yz = self._y_co
+00024730: 7272 6563 7465 645f 7374 6167 655f 6d6f  rrected_stage_mo
+00024740: 7665 6d65 6e74 2864 792c 2062 6561 6d5f  vement(dy, beam_
+00024750: 7479 7065 290a 2020 2020 2020 2020 6479  type).        dy
+00024760: 2c20 647a 203d 2070 6f69 6e74 5f79 7a2e  , dz = point_yz.
+00024770: 792c 2070 6f69 6e74 5f79 7a2e 7a0a 0a20  y, point_yz.z.. 
+00024780: 2020 2020 2020 2023 2063 616c 6375 6c61         # calcula
+00024790: 7465 2074 6865 2063 6f72 7265 6374 6564  te the corrected
+000247a0: 206d 6f76 6520 746f 2072 6561 6368 2074   move to reach t
+000247b0: 6861 7420 706f 696e 7420 6672 6f6d 2062  hat point from b
+000247c0: 6173 652d 7374 6174 653f 0a20 2020 2020  ase-state?.     
+000247d0: 2020 205f 6e65 775f 706f 7369 7469 6f6e     _new_position
+000247e0: 203d 2064 6565 7063 6f70 7928 6261 7365   = deepcopy(base
+000247f0: 5f70 6f73 6974 696f 6e29 0a20 2020 2020  _position).     
+00024800: 2020 205f 6e65 775f 706f 7369 7469 6f6e     _new_position
+00024810: 2e78 202b 3d20 6478 0a20 2020 2020 2020  .x += dx.       
+00024820: 205f 6e65 775f 706f 7369 7469 6f6e 2e79   _new_position.y
+00024830: 202b 3d20 6479 0a20 2020 2020 2020 205f   += dy.        _
+00024840: 6e65 775f 706f 7369 7469 6f6e 2e7a 202b  new_position.z +
+00024850: 3d20 647a 0a0a 2020 2020 2020 2020 7265  = dz..        re
+00024860: 7475 726e 205f 6e65 775f 706f 7369 7469  turn _new_positi
+00024870: 6f6e 2023 2054 4f44 4f3a 2069 6d70 6c65  on # TODO: imple
+00024880: 6d65 6e74 0a0a 2020 2020 6465 6620 6d6f  ment..    def mo
+00024890: 7665 5f73 7461 6765 5f61 6273 6f6c 7574  ve_stage_absolut
+000248a0: 6528 7365 6c66 2c20 706f 7369 7469 6f6e  e(self, position
+000248b0: 3a20 4669 6273 656d 5374 6167 6550 6f73  : FibsemStagePos
+000248c0: 6974 696f 6e29 3a0a 2020 2020 2020 2020  ition):.        
+000248d0: 2222 220a 2020 2020 2020 2020 4d6f 7665  """.        Move
+000248e0: 2074 6865 2073 7461 6765 2074 6f20 7468   the stage to th
+000248f0: 6520 7370 6563 6966 6965 6420 636f 6f72  e specified coor
+00024900: 6469 6e61 7465 732e 0a0a 2020 2020 2020  dinates...      
+00024910: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00024920: 2020 2020 7820 2866 6c6f 6174 293a 2054      x (float): T
+00024930: 6865 2078 2d63 6f6f 7264 696e 6174 6520  he x-coordinate 
+00024940: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
+00024950: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
+00024960: 2020 2020 7920 2866 6c6f 6174 293a 2054      y (float): T
+00024970: 6865 2079 2d63 6f6f 7264 696e 6174 6520  he y-coordinate 
+00024980: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
+00024990: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
+000249a0: 2020 2020 7a20 2866 6c6f 6174 293a 2054      z (float): T
+000249b0: 6865 207a 2d63 6f6f 7264 696e 6174 6520  he z-coordinate 
+000249c0: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
+000249d0: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
+000249e0: 2020 2020 7220 2866 6c6f 6174 293a 2054      r (float): T
+000249f0: 6865 2072 6f74 6174 696f 6e20 746f 2061  he rotation to a
+00024a00: 7070 6c79 2028 696e 2072 6164 6961 6e73  pply (in radians
+00024a10: 292e 0a20 2020 2020 2020 2020 2020 2074  )..            t
+00024a20: 7820 2866 6c6f 6174 293a 2054 6865 2078  x (float): The x
+00024a30: 2d61 7869 7320 7469 6c74 2074 6f20 6170  -axis tilt to ap
+00024a40: 706c 7920 2869 6e20 7261 6469 616e 7329  ply (in radians)
+00024a50: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00024a60: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00024a70: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
+00024a80: 0a20 2020 2020 2020 2069 6620 706f 7369  .        if posi
+00024a90: 7469 6f6e 2e72 2069 7320 6e6f 7420 4e6f  tion.r is not No
+00024aa0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00024ab0: 726f 7461 7469 6f6e 203d 2054 7275 650a  rotation = True.
+00024ac0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00024ad0: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
+00024ae0: 6f6e 203d 2046 616c 7365 0a20 2020 2020  on = False.     
+00024af0: 2020 2069 6620 706f 7369 7469 6f6e 2e74     if position.t
+00024b00: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00024b10: 2020 2020 2020 2020 2020 7469 6c74 203d            tilt =
+00024b20: 2054 7275 650a 2020 2020 2020 2020 656c   True.        el
+00024b30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00024b40: 7469 6c74 203d 2046 616c 7365 0a20 2020  tilt = False.   
+00024b50: 2020 2020 205f 6368 6563 6b5f 7374 6167       _check_stag
+00024b60: 6528 7365 6c66 2e73 7973 7465 6d2c 2072  e(self.system, r
+00024b70: 6f74 6174 696f 6e3d 726f 7461 7469 6f6e  otation=rotation
+00024b80: 2c20 7469 6c74 3d74 696c 7429 0a20 2020  , tilt=tilt).   
+00024b90: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00024ba0: 6f28 6622 4d6f 7669 6e67 2073 7461 6765  o(f"Moving stage
+00024bb0: 2074 6f20 7b70 6f73 6974 696f 6e7d 2e22   to {position}."
+00024bc0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+00024bd0: 6f6e 6e65 6374 696f 6e2e 5374 6167 652e  onnection.Stage.
+00024be0: 4d6f 7665 546f 280a 2020 2020 2020 2020  MoveTo(.        
+00024bf0: 2020 2020 706f 7369 7469 6f6e 2e78 202a      position.x *
+00024c00: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
+00024c10: 5f54 4f5f 4d49 4c4c 494d 4554 5245 2069  _TO_MILLIMETRE i
+00024c20: 6620 706f 7369 7469 6f6e 2e78 2069 7320  f position.x is 
+00024c30: 6e6f 7420 4e6f 6e65 2065 6c73 6520 4e6f  not None else No
+00024c40: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00024c50: 706f 7369 7469 6f6e 2e79 202a 2063 6f6e  position.y * con
+00024c60: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+00024c70: 4d49 4c4c 494d 4554 5245 2069 6620 706f  MILLIMETRE if po
+00024c80: 7369 7469 6f6e 2e79 2069 7320 6e6f 7420  sition.y is not 
+00024c90: 4e6f 6e65 2065 6c73 6520 4e6f 6e65 2c0a  None else None,.
+00024ca0: 2020 2020 2020 2020 2020 2020 706f 7369              posi
+00024cb0: 7469 6f6e 2e7a 202a 2063 6f6e 7374 616e  tion.z * constan
+00024cc0: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
+00024cd0: 494d 4554 5245 2069 6620 706f 7369 7469  IMETRE if positi
+00024ce0: 6f6e 2e7a 2069 7320 6e6f 7420 4e6f 6e65  on.z is not None
+00024cf0: 2065 6c73 6520 4e6f 6e65 2c0a 2020 2020   else None,.    
+00024d00: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
+00024d10: 2e72 202a 2063 6f6e 7374 616e 7473 2e52  .r * constants.R
+00024d20: 4144 4941 4e53 5f54 4f5f 4445 4752 4545  ADIANS_TO_DEGREE
+00024d30: 5320 6966 2070 6f73 6974 696f 6e2e 7220  S if position.r 
+00024d40: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+00024d50: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00024d60: 2020 2070 6f73 6974 696f 6e2e 7420 2a20     position.t * 
+00024d70: 636f 6e73 7461 6e74 732e 5241 4449 414e  constants.RADIAN
+00024d80: 535f 544f 5f44 4547 5245 4553 2069 6620  S_TO_DEGREES if 
+00024d90: 706f 7369 7469 6f6e 2e74 2069 7320 6e6f  position.t is no
+00024da0: 7420 4e6f 6e65 2065 6c73 6520 4e6f 6e65  t None else None
+00024db0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00024dc0: 2064 6566 206d 6f76 655f 7374 6167 655f   def move_stage_
+00024dd0: 7265 6c61 7469 7665 280a 2020 2020 2020  relative(.      
+00024de0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00024df0: 706f 7369 7469 6f6e 3a20 4669 6273 656d  position: Fibsem
+00024e00: 5374 6167 6550 6f73 6974 696f 6e2c 0a20  StagePosition,. 
+00024e10: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
+00024e20: 220a 2020 2020 2020 2020 4d6f 7665 2074  ".        Move t
+00024e30: 6865 2073 7461 6765 2062 7920 7468 6520  he stage by the 
+00024e40: 7370 6563 6966 6965 6420 7265 6c61 7469  specified relati
+00024e50: 7665 206d 6f76 652e 0a0a 2020 2020 2020  ve move...      
+00024e60: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00024e70: 2020 2020 7820 2866 6c6f 6174 293a 2054      x (float): T
+00024e80: 6865 2078 2d63 6f6f 7264 696e 6174 6520  he x-coordinate 
+00024e90: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
+00024ea0: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
+00024eb0: 2020 2020 7920 2866 6c6f 6174 293a 2054      y (float): T
+00024ec0: 6865 2079 2d63 6f6f 7264 696e 6174 6520  he y-coordinate 
+00024ed0: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
+00024ee0: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
+00024ef0: 2020 2020 7a20 2866 6c6f 6174 293a 2054      z (float): T
+00024f00: 6865 207a 2d63 6f6f 7264 696e 6174 6520  he z-coordinate 
+00024f10: 746f 206d 6f76 6520 746f 2028 696e 206d  to move to (in m
+00024f20: 6574 6572 7329 2e0a 2020 2020 2020 2020  eters)..        
+00024f30: 2020 2020 7220 2866 6c6f 6174 293a 2054      r (float): T
+00024f40: 6865 2072 6f74 6174 696f 6e20 746f 2061  he rotation to a
+00024f50: 7070 6c79 2028 696e 2064 6567 7265 6573  pply (in degrees
+00024f60: 292e 0a20 2020 2020 2020 2020 2020 2074  )..            t
+00024f70: 7820 2866 6c6f 6174 293a 2054 6865 2078  x (float): The x
+00024f80: 2d61 7869 7320 7469 6c74 2074 6f20 6170  -axis tilt to ap
+00024f90: 706c 7920 2869 6e20 6465 6772 6565 7329  ply (in degrees)
+00024fa0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00024fb0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00024fc0: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
+00024fd0: 0a20 2020 2020 2020 2069 6620 706f 7369  .        if posi
+00024fe0: 7469 6f6e 2e72 2069 7320 6e6f 7420 4e6f  tion.r is not No
+00024ff0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00025000: 726f 7461 7469 6f6e 203d 2054 7275 650a  rotation = True.
+00025010: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00025020: 2020 2020 2020 2020 2020 726f 7461 7469            rotati
+00025030: 6f6e 203d 2046 616c 7365 0a20 2020 2020  on = False.     
+00025040: 2020 2069 6620 706f 7369 7469 6f6e 2e74     if position.t
+00025050: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00025060: 2020 2020 2020 2020 2020 7469 6c74 203d            tilt =
+00025070: 2054 7275 650a 2020 2020 2020 2020 656c   True.        el
+00025080: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00025090: 7469 6c74 203d 2046 616c 7365 0a20 2020  tilt = False.   
+000250a0: 2020 2020 205f 6368 6563 6b5f 7374 6167       _check_stag
+000250b0: 6528 7365 6c66 2e73 7973 7465 6d2c 2072  e(self.system, r
+000250c0: 6f74 6174 696f 6e3d 726f 7461 7469 6f6e  otation=rotation
+000250d0: 2c20 7469 6c74 3d74 696c 7429 0a20 2020  , tilt=tilt).   
+000250e0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+000250f0: 6f28 6622 4d6f 7669 6e67 2073 7461 6765  o(f"Moving stage
+00025100: 2062 7920 7b70 6f73 6974 696f 6e7d 2e22   by {position}."
+00025110: 290a 2020 2020 2020 2020 2320 6375 7272  ).        # curr
+00025120: 656e 745f 706f 7369 7469 6f6e 203d 2073  ent_position = s
+00025130: 656c 662e 6765 745f 7374 6167 655f 706f  elf.get_stage_po
+00025140: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
+00025150: 2023 2078 322c 7932 2c7a 3220 3d20 7365   # x2,y2,z2 = se
+00025160: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5374  lf.connection.St
+00025170: 6167 652e 4b56 462e 436f 6d70 7574 6528  age.KVF.Compute(
+00025180: 0a20 2020 2020 2020 2023 2020 2020 2077  .        #     w
+00025190: 643d 2073 656c 662e 6765 7428 2277 6f72  d= self.get("wor
+000251a0: 6b69 6e67 5f64 6973 7461 6e63 6522 2c20  king_distance", 
+000251b0: 6265 616d 5f74 7970 653d 4265 616d 5479  beam_type=BeamTy
+000251c0: 7065 2e45 4c45 4354 524f 4e29 2c0a 2020  pe.ELECTRON),.  
+000251d0: 2020 2020 2020 2320 2020 2020 7831 3d20        #     x1= 
+000251e0: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+000251f0: 2e78 202a 2063 6f6e 7374 616e 7473 2e4d  .x * constants.M
+00025200: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
+00025210: 5245 2c0a 2020 2020 2020 2020 2320 2020  RE,.        #   
+00025220: 2020 7931 3d20 6375 7272 656e 745f 706f    y1= current_po
+00025230: 7369 7469 6f6e 2e79 202a 2063 6f6e 7374  sition.y * const
+00025240: 616e 7473 2e4d 4554 5245 5f54 4f5f 4d49  ants.METRE_TO_MI
+00025250: 4c4c 494d 4554 5245 2c0a 2020 2020 2020  LLIMETRE,.      
+00025260: 2020 2320 2020 2020 7a31 3d20 6375 7272    #     z1= curr
+00025270: 656e 745f 706f 7369 7469 6f6e 2e7a 202a  ent_position.z *
+00025280: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
+00025290: 5f54 4f5f 4d49 4c4c 494d 4554 5245 2c0a  _TO_MILLIMETRE,.
+000252a0: 2020 2020 2020 2020 2320 2020 2020 7231          #     r1
+000252b0: 3d20 6375 7272 656e 745f 706f 7369 7469  = current_positi
+000252c0: 6f6e 2e72 202a 2063 6f6e 7374 616e 7473  on.r * constants
+000252d0: 2e52 4144 4941 4e53 5f54 4f5f 4445 4752  .RADIANS_TO_DEGR
+000252e0: 4545 532c 0a20 2020 2020 2020 2023 2020  EES,.        #  
+000252f0: 2020 2074 7831 3d20 6375 7272 656e 745f     tx1= current_
+00025300: 706f 7369 7469 6f6e 2e74 202a 2063 6f6e  position.t * con
+00025310: 7374 616e 7473 2e52 4144 4941 4e53 5f54  stants.RADIANS_T
+00025320: 4f5f 4445 4752 4545 532c 0a20 2020 2020  O_DEGREES,.     
+00025330: 2020 2023 2020 2020 2074 7931 203d 2030     #     ty1 = 0
+00025340: 2c0a 2020 2020 2020 2020 2320 2020 2020  ,.        #     
+00025350: 7232 203d 2070 6f73 6974 696f 6e2e 7220  r2 = position.r 
+00025360: 2a20 636f 6e73 7461 6e74 732e 5241 4449  * constants.RADI
+00025370: 414e 535f 544f 5f44 4547 5245 4553 202b  ANS_TO_DEGREES +
+00025380: 2063 7572 7265 6e74 5f70 6f73 6974 696f   current_positio
+00025390: 6e2e 7220 2a20 636f 6e73 7461 6e74 732e  n.r * constants.
+000253a0: 5241 4449 414e 535f 544f 5f44 4547 5245  RADIANS_TO_DEGRE
+000253b0: 4553 2c0a 2020 2020 2020 2020 2320 2020  ES,.        #   
+000253c0: 2020 7478 3220 3d20 706f 7369 7469 6f6e    tx2 = position
+000253d0: 2e74 202a 2063 6f6e 7374 616e 7473 2e52  .t * constants.R
+000253e0: 4144 4941 4e53 5f54 4f5f 4445 4752 4545  ADIANS_TO_DEGREE
+000253f0: 5320 2b20 6375 7272 656e 745f 706f 7369  S + current_posi
+00025400: 7469 6f6e 2e74 202a 2063 6f6e 7374 616e  tion.t * constan
+00025410: 7473 2e52 4144 4941 4e53 5f54 4f5f 4445  ts.RADIANS_TO_DE
+00025420: 4752 4545 532c 0a20 2020 2020 2020 2023  GREES,.        #
+00025430: 2020 2020 2074 7932 203d 2030 2c0a 2020       ty2 = 0,.  
+00025440: 2020 2020 2020 2320 290a 2020 2020 2020        # ).      
+00025450: 2020 2320 7365 6c66 2e6d 6f76 655f 7374    # self.move_st
+00025460: 6167 655f 6162 736f 6c75 7465 2846 6962  age_absolute(Fib
+00025470: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00025480: 2878 322c 7932 2c7a 3229 290a 2020 2020  (x2,y2,z2)).    
+00025490: 2020 2020 6375 7272 656e 745f 706f 7369      current_posi
+000254a0: 7469 6f6e 203d 2073 656c 662e 6765 745f  tion = self.get_
+000254b0: 7374 6167 655f 706f 7369 7469 6f6e 2829  stage_position()
+000254c0: 0a20 2020 2020 2020 2078 5f6d 203d 2063  .        x_m = c
+000254d0: 7572 7265 6e74 5f70 6f73 6974 696f 6e2e  urrent_position.
+000254e0: 780a 2020 2020 2020 2020 795f 6d20 3d20  x.        y_m = 
+000254f0: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+00025500: 2e79 0a20 2020 2020 2020 207a 5f6d 203d  .y.        z_m =
+00025510: 2063 7572 7265 6e74 5f70 6f73 6974 696f   current_positio
+00025520: 6e2e 7a0a 2020 2020 2020 2020 6e65 775f  n.z.        new_
+00025530: 706f 7369 7469 6f6e 203d 2046 6962 7365  position = Fibse
+00025540: 6d53 7461 6765 506f 7369 7469 6f6e 280a  mStagePosition(.
+00025550: 2020 2020 2020 2020 2020 2020 7820 3d20              x = 
+00025560: 2878 5f6d 202b 2070 6f73 6974 696f 6e2e  (x_m + position.
+00025570: 7829 2069 6620 706f 7369 7469 6f6e 2e78  x) if position.x
+00025580: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00025590: 6520 785f 6d2c 0a20 2020 2020 2020 2020  e x_m,.         
+000255a0: 2020 2079 203d 2028 795f 6d20 2b20 706f     y = (y_m + po
+000255b0: 7369 7469 6f6e 2e79 2029 6966 2070 6f73  sition.y )if pos
+000255c0: 6974 696f 6e2e 7920 6973 206e 6f74 204e  ition.y is not N
+000255d0: 6f6e 6520 656c 7365 2079 5f6d 2c0a 2020  one else y_m,.  
+000255e0: 2020 2020 2020 2020 2020 7a20 3d20 287a            z = (z
+000255f0: 5f6d 202b 2070 6f73 6974 696f 6e2e 7a20  _m + position.z 
+00025600: 2969 6620 706f 7369 7469 6f6e 2e7a 2069  )if position.z i
+00025610: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+00025620: 7a5f 6d2c 0a20 2020 2020 2020 2020 2020  z_m,.           
+00025630: 2072 203d 2028 6375 7272 656e 745f 706f   r = (current_po
+00025640: 7369 7469 6f6e 2e72 202b 2070 6f73 6974  sition.r + posit
+00025650: 696f 6e2e 7229 2069 6620 706f 7369 7469  ion.r) if positi
+00025660: 6f6e 2e72 2069 7320 6e6f 7420 4e6f 6e65  on.r is not None
+00025670: 2065 6c73 6520 6375 7272 656e 745f 706f   else current_po
+00025680: 7369 7469 6f6e 2e72 2c0a 2020 2020 2020  sition.r,.      
+00025690: 2020 2020 2020 7420 3d20 2863 7572 7265        t = (curre
+000256a0: 6e74 5f70 6f73 6974 696f 6e2e 7420 2b20  nt_position.t + 
+000256b0: 706f 7369 7469 6f6e 2e74 2920 6966 2070  position.t) if p
+000256c0: 6f73 6974 696f 6e2e 7420 6973 206e 6f74  osition.t is not
+000256d0: 204e 6f6e 6520 656c 7365 2063 7572 7265   None else curre
+000256e0: 6e74 5f70 6f73 6974 696f 6e2e 742c 0a20  nt_position.t,. 
+000256f0: 2020 2020 2020 2020 2020 2063 6f6f 7264             coord
+00025700: 696e 6174 655f 7379 7374 656d 203d 2020  inate_system =  
+00025710: 2252 4157 222c 0a20 2020 2020 2020 2029  "RAW",.        )
+00025720: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
+00025730: 7665 5f73 7461 6765 5f61 6273 6f6c 7574  ve_stage_absolut
+00025740: 6528 6e65 775f 706f 7369 7469 6f6e 290a  e(new_position).
+00025750: 0a20 2020 2064 6566 2073 7461 626c 655f  .    def stable_
+00025760: 6d6f 7665 280a 2020 2020 2020 2020 7365  move(.        se
+00025770: 6c66 2c0a 2020 2020 2020 2020 6478 3a20  lf,.        dx: 
+00025780: 666c 6f61 742c 0a20 2020 2020 2020 2064  float,.        d
+00025790: 793a 2066 6c6f 6174 2c0a 2020 2020 2020  y: float,.      
+000257a0: 2020 6265 616d 5f74 7970 653a 2042 6561    beam_type: Bea
+000257b0: 6d54 7970 652c 0a20 2020 2020 2020 2073  mType,.        s
+000257c0: 7461 7469 635f 7764 3a20 626f 6f6c 203d  tatic_wd: bool =
+000257d0: 2046 616c 7365 2c0a 2020 2020 2920 2d3e   False,.    ) ->
+000257e0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+000257f0: 2222 0a20 2020 2020 2020 2043 616c 6375  "".        Calcu
+00025800: 6c61 7465 2074 6865 2063 6f72 7265 6374  late the correct
+00025810: 6564 2073 7461 6765 206d 6f76 656d 656e  ed stage movemen
+00025820: 7473 2062 6173 6564 206f 6e20 7468 6520  ts based on the 
+00025830: 6265 616d 5f74 7970 652c 2061 6e64 2074  beam_type, and t
+00025840: 6865 6e20 6d6f 7665 2074 6865 2073 7461  hen move the sta
+00025850: 6765 2072 656c 6174 6976 656c 792e 0a0a  ge relatively...
+00025860: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00025870: 2020 2020 2020 2020 2020 6478 2028 666c            dx (fl
+00025880: 6f61 7429 3a20 6469 7374 616e 6365 2061  oat): distance a
+00025890: 6c6f 6e67 2074 6865 2078 2d61 7869 7320  long the x-axis 
+000258a0: 2869 6d61 6765 2063 6f6f 7264 696e 6174  (image coordinat
+000258b0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000258c0: 6479 2028 666c 6f61 7429 3a20 6469 7374  dy (float): dist
+000258d0: 616e 6365 2061 6c6f 6e67 2074 6865 2079  ance along the y
+000258e0: 2d61 7869 7320 2869 6d61 6765 2063 6f6f  -axis (image coo
+000258f0: 7264 696e 6174 6573 290a 2020 2020 2020  rdinates).      
+00025900: 2020 2222 220a 2020 2020 2020 2020 5f63    """.        _c
+00025910: 6865 636b 5f73 7461 6765 2873 656c 662e  heck_stage(self.
+00025920: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+00025930: 7764 203d 2073 656c 662e 636f 6e6e 6563  wd = self.connec
+00025940: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
+00025950: 4765 7457 4428 290a 0a20 2020 2020 2020  GetWD()..       
+00025960: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
+00025970: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+00025980: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+00025990: 696d 6167 655f 726f 7461 7469 6f6e 203d  image_rotation =
+000259a0: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+000259b0: 2e53 454d 2e4f 7074 6963 732e 4765 7449  .SEM.Optics.GetI
+000259c0: 6d61 6765 526f 7461 7469 6f6e 2829 0a20  mageRotation(). 
+000259d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000259e0: 2020 2020 2020 2020 2069 6d61 6765 5f72           image_r
+000259f0: 6f74 6174 696f 6e20 3d20 7365 6c66 2e63  otation = self.c
+00025a00: 6f6e 6e65 6374 696f 6e2e 4649 422e 4f70  onnection.FIB.Op
+00025a10: 7469 6373 2e47 6574 496d 6167 6552 6f74  tics.GetImageRot
+00025a20: 6174 696f 6e28 290a 0a20 2020 2020 2020  ation()..       
+00025a30: 2069 6620 6e70 2e69 736e 616e 2869 6d61   if np.isnan(ima
+00025a40: 6765 5f72 6f74 6174 696f 6e29 3a0a 2020  ge_rotation):.  
+00025a50: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+00025a60: 726f 7461 7469 6f6e 203d 2030 2e30 0a20  rotation = 0.0. 
+00025a70: 2020 2020 2020 2023 2069 6620 696d 6167         # if imag
+00025a80: 655f 726f 7461 7469 6f6e 203d 3d20 303a  e_rotation == 0:
+00025a90: 0a20 2020 2020 2020 2023 2020 2020 2064  .        #     d
+00025aa0: 785f 6d6f 7665 203d 202d 6478 0a20 2020  x_move = -dx.   
+00025ab0: 2020 2020 2023 2020 2020 2064 795f 6d6f       #     dy_mo
+00025ac0: 7665 203d 2064 790a 2020 2020 2020 2020  ve = dy.        
+00025ad0: 2320 656c 6966 2069 6d61 6765 5f72 6f74  # elif image_rot
+00025ae0: 6174 696f 6e20 3d3d 2031 3830 3a0a 2020  ation == 180:.  
+00025af0: 2020 2020 2020 2320 2020 2020 6478 5f6d        #     dx_m
+00025b00: 6f76 6520 3d20 6478 0a20 2020 2020 2020  ove = dx.       
+00025b10: 2023 2020 2020 2064 795f 6d6f 7665 203d   #     dy_move =
+00025b20: 202d 6479 0a0a 2020 2020 2020 2020 6478   -dy..        dx
+00025b30: 5f6d 6f76 6520 3d20 202d 2864 782a 6e70  _move =  -(dx*np
+00025b40: 2e63 6f73 2869 6d61 6765 5f72 6f74 6174  .cos(image_rotat
+00025b50: 696f 6e2a 6e70 2e70 692f 3138 3029 202b  ion*np.pi/180) +
+00025b60: 2064 792a 6e70 2e73 696e 2869 6d61 6765   dy*np.sin(image
+00025b70: 5f72 6f74 6174 696f 6e2a 6e70 2e70 692f  _rotation*np.pi/
+00025b80: 3138 3029 290a 2020 2020 2020 2020 6479  180)).        dy
+00025b90: 5f6d 6f76 6520 3d20 2d28 6479 2a6e 702e  _move = -(dy*np.
+00025ba0: 636f 7328 696d 6167 655f 726f 7461 7469  cos(image_rotati
+00025bb0: 6f6e 2a6e 702e 7069 2f31 3830 2920 2d20  on*np.pi/180) - 
+00025bc0: 6478 2a6e 702e 7369 6e28 696d 6167 655f  dx*np.sin(image_
+00025bd0: 726f 7461 7469 6f6e 2a6e 702e 7069 2f31  rotation*np.pi/1
+00025be0: 3830 2929 0a0a 2020 2020 2020 2020 2320  80))..        # 
+00025bf0: 6361 6c63 756c 6174 6520 7374 6167 6520  calculate stage 
+00025c00: 6d6f 7665 6d65 6e74 0a20 2020 2020 2020  movement.       
+00025c10: 2078 5f6d 6f76 6520 3d20 4669 6273 656d   x_move = Fibsem
+00025c20: 5374 6167 6550 6f73 6974 696f 6e28 783d  StagePosition(x=
+00025c30: 6478 5f6d 6f76 652c 2079 3d30 2c20 7a3d  dx_move, y=0, z=
+00025c40: 3029 200a 2020 2020 2020 2020 797a 5f6d  0) .        yz_m
+00025c50: 6f76 6520 3d20 7365 6c66 2e5f 795f 636f  ove = self._y_co
+00025c60: 7272 6563 7465 645f 7374 6167 655f 6d6f  rrected_stage_mo
+00025c70: 7665 6d65 6e74 280a 2020 2020 2020 2020  vement(.        
+00025c80: 2020 2020 6578 7065 6374 6564 5f79 3d64      expected_y=d
+00025c90: 795f 6d6f 7665 2c0a 2020 2020 2020 2020  y_move,.        
+00025ca0: 2020 2020 6265 616d 5f74 7970 653d 6265      beam_type=be
+00025cb0: 616d 5f74 7970 652c 0a20 2020 2020 2020  am_type,.       
+00025cc0: 2029 0a0a 2020 2020 2020 2020 2320 6d6f   )..        # mo
+00025cd0: 7665 2073 7461 6765 0a20 2020 2020 2020  ve stage.       
+00025ce0: 2073 7461 6765 5f70 6f73 6974 696f 6e20   stage_position 
+00025cf0: 3d20 4669 6273 656d 5374 6167 6550 6f73  = FibsemStagePos
+00025d00: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
+00025d10: 2020 2078 3d78 5f6d 6f76 652e 782c 2079     x=x_move.x, y
+00025d20: 3d79 7a5f 6d6f 7665 2e79 2c20 7a3d 797a  =yz_move.y, z=yz
+00025d30: 5f6d 6f76 652e 7a2c 2072 3d30 2c20 743d  _move.z, r=0, t=
+00025d40: 300a 2020 2020 2020 2020 290a 2020 2020  0.        ).    
+00025d50: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00025d60: 2866 226d 6f76 696e 6720 7374 6167 6520  (f"moving stage 
+00025d70: 287b 6265 616d 5f74 7970 652e 6e61 6d65  ({beam_type.name
+00025d80: 7d29 3a20 7b73 7461 6765 5f70 6f73 6974  }): {stage_posit
+00025d90: 696f 6e7d 2229 0a20 2020 2020 2020 2073  ion}").        s
+00025da0: 656c 662e 6d6f 7665 5f73 7461 6765 5f72  elf.move_stage_r
+00025db0: 656c 6174 6976 6528 7374 6167 655f 706f  elative(stage_po
+00025dc0: 7369 7469 6f6e 290a 0a20 2020 2020 2020  sition)..       
+00025dd0: 2023 2061 646a 7573 7420 776f 726b 696e   # adjust workin
+00025de0: 6720 6469 7374 616e 6365 2074 6f20 636f  g distance to co
+00025df0: 6d70 656e 7361 7465 2066 6f72 2073 7461  mpensate for sta
+00025e00: 6765 206d 6f76 656d 656e 740a 2020 2020  ge movement.    
+00025e10: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00025e20: 696f 6e2e 5345 4d2e 4f70 7469 6373 2e53  ion.SEM.Optics.S
+00025e30: 6574 5744 2877 6429 0a20 2020 2020 2020  etWD(wd).       
+00025e40: 2023 2073 656c 662e 636f 6e6e 6563 7469   # self.connecti
+00025e50: 6f6e 2e73 7065 6369 6d65 6e2e 7374 6167  on.specimen.stag
+00025e60: 652e 6c69 6e6b 2829 2023 2054 4f44 4f20  e.link() # TODO 
+00025e70: 686f 7720 746f 206c 696e 6b20 666f 7220  how to link for 
+00025e80: 5445 5343 414e 3f0a 0a20 2020 2020 2020  TESCAN?..       
+00025e90: 2072 6574 7572 6e0a 0a20 2020 2064 6566   return..    def
+00025ea0: 2076 6572 7469 6361 6c5f 6d6f 7665 280a   vertical_move(.
+00025eb0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00025ec0: 2020 2020 2020 6479 3a20 666c 6f61 742c        dy: float,
+00025ed0: 0a20 2020 2020 2020 2064 783a 2066 6c6f  .        dx: flo
+00025ee0: 6174 203d 2030 2e30 2c0a 2020 2020 2020  at = 0.0,.      
+00025ef0: 2020 7374 6174 6963 5f77 643a 2062 6f6f    static_wd: boo
+00025f00: 6c20 3d20 5472 7565 2c0a 2020 2020 2920  l = True,.    ) 
+00025f10: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00025f20: 2022 2222 0a20 2020 2020 2020 204d 6f76   """.        Mov
+00025f30: 6520 7468 6520 7374 6167 6520 7665 7274  e the stage vert
+00025f40: 6963 616c 6c79 2074 6f20 636f 7272 6563  ically to correc
+00025f50: 7420 6575 6365 6e74 7269 6320 706f 696e  t eucentric poin
+00025f60: 740a 0a20 2020 2020 2020 2041 7267 733a  t..        Args:
+00025f70: 0a20 2020 2020 2020 2020 2020 2064 7920  .            dy 
+00025f80: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
+00025f90: 6520 696e 2079 2d61 7869 7320 2869 6d61  e in y-axis (ima
+00025fa0: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
+00025fb0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00025fc0: 2020 2020 5f63 6865 636b 5f73 7461 6765      _check_stage
+00025fd0: 2873 656c 662e 7379 7374 656d 290a 2020  (self.system).  
+00025fe0: 2020 2020 2020 7764 203d 2073 656c 662e        wd = self.
+00025ff0: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e4f  connection.SEM.O
+00026000: 7074 6963 732e 4765 7457 4428 290a 2020  ptics.GetWD().  
+00026010: 2020 2020 2020 696d 6167 655f 726f 7461        image_rota
+00026020: 7469 6f6e 203d 2073 656c 662e 636f 6e6e  tion = self.conn
+00026030: 6563 7469 6f6e 2e46 4942 2e4f 7074 6963  ection.FIB.Optic
+00026040: 732e 4765 7449 6d61 6765 526f 7461 7469  s.GetImageRotati
+00026050: 6f6e 2829 0a20 2020 2020 2020 2020 2020  on().           
+00026060: 200a 2020 2020 2020 2020 6966 206e 702e   .        if np.
+00026070: 6973 636c 6f73 6528 696d 6167 655f 726f  isclose(image_ro
+00026080: 7461 7469 6f6e 2c20 302e 3029 3a0a 2020  tation, 0.0):.  
+00026090: 2020 2020 2020 2020 2020 6479 5f6d 6f76            dy_mov
+000260a0: 6520 3d20 6479 0a20 2020 2020 2020 2065  e = dy.        e
+000260b0: 6c69 6620 6e70 2e69 7363 6c6f 7365 2869  lif np.isclose(i
+000260c0: 6d61 6765 5f72 6f74 6174 696f 6e2c 2031  mage_rotation, 1
+000260d0: 3830 293a 0a20 2020 2020 2020 2020 2020  80):.           
+000260e0: 2064 795f 6d6f 7665 203d 202d 6479 0a0a   dy_move = -dy..
+000260f0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+00026100: 2020 2020 2020 5052 4554 494c 545f 5349        PRETILT_SI
+00026110: 474e 203d 2031 2e30 0a20 2020 2020 2020  GN = 1.0.       
+00026120: 2066 726f 6d20 6669 6273 656d 2069 6d70   from fibsem imp
+00026130: 6f72 7420 6d6f 7665 6d65 6e74 0a20 2020  ort movement.   
+00026140: 2020 2020 2023 2063 7572 7265 6e74 2073       # current s
+00026150: 7461 6765 2070 6f73 6974 696f 6e0a 2020  tage position.  
+00026160: 2020 2020 2020 6375 7272 656e 745f 7374        current_st
+00026170: 6167 655f 706f 7369 7469 6f6e 203d 2073  age_position = s
+00026180: 656c 662e 6765 745f 7374 6167 655f 706f  elf.get_stage_po
+00026190: 7369 7469 6f6e 2829 0a20 2020 2020 2020  sition().       
+000261a0: 2073 7461 6765 5f72 6f74 6174 696f 6e20   stage_rotation 
+000261b0: 3d20 6375 7272 656e 745f 7374 6167 655f  = current_stage_
+000261c0: 706f 7369 7469 6f6e 2e72 2025 2028 3220  position.r % (2 
+000261d0: 2a20 6e70 2e70 6929 0a20 2020 2020 2020  * np.pi).       
+000261e0: 2073 7461 6765 5f74 696c 7420 3d20 6375   stage_tilt = cu
+000261f0: 7272 656e 745f 7374 6167 655f 706f 7369  rrent_stage_posi
+00026200: 7469 6f6e 2e74 0a20 2020 2020 2020 2073  tion.t.        s
+00026210: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
+00026220: 6f5f 656c 6563 7472 6f6e 203d 206e 702e  o_electron = np.
+00026230: 6465 6732 7261 6428 7365 6c66 2e73 7973  deg2rad(self.sys
+00026240: 7465 6d2e 656c 6563 7472 6f6e 2e63 6f6c  tem.electron.col
+00026250: 756d 6e5f 7469 6c74 290a 2020 2020 2020  umn_tilt).      
+00026260: 2020 7374 6167 655f 7469 6c74 5f66 6c61    stage_tilt_fla
+00026270: 745f 746f 5f69 6f6e 203d 206e 702e 6465  t_to_ion = np.de
+00026280: 6732 7261 6428 7365 6c66 2e73 7973 7465  g2rad(self.syste
+00026290: 6d2e 696f 6e2e 636f 6c75 6d6e 5f74 696c  m.ion.column_til
+000262a0: 7429 0a0a 2020 2020 2020 2020 7374 6167  t)..        stag
+000262b0: 655f 726f 7461 7469 6f6e 5f66 6c61 745f  e_rotation_flat_
+000262c0: 746f 5f69 6f6e 203d 206e 702e 6465 6732  to_ion = np.deg2
+000262d0: 7261 6428 0a20 2020 2020 2020 2020 2020  rad(.           
+000262e0: 2073 656c 662e 7379 7374 656d 2e73 7461   self.system.sta
+000262f0: 6765 2e72 6f74 6174 696f 6e5f 3138 300a  ge.rotation_180.
+00026300: 2020 2020 2020 2020 2920 2520 2832 202a          ) % (2 *
+00026310: 206e 702e 7069 290a 0a20 2020 2020 2020   np.pi)..       
+00026320: 2069 6620 6d6f 7665 6d65 6e74 2e72 6f74   if movement.rot
+00026330: 6174 696f 6e5f 616e 676c 655f 6973 5f73  ation_angle_is_s
+00026340: 6d61 6c6c 6572 280a 2020 2020 2020 2020  maller(.        
+00026350: 2020 2020 7374 6167 655f 726f 7461 7469      stage_rotati
+00026360: 6f6e 2c20 7374 6167 655f 726f 7461 7469  on, stage_rotati
+00026370: 6f6e 5f66 6c61 745f 746f 5f69 6f6e 2c20  on_flat_to_ion, 
+00026380: 6174 6f6c 3d35 0a20 2020 2020 2020 2029  atol=5.        )
+00026390: 3a0a 2020 2020 2020 2020 2020 2020 5052  :.            PR
+000263a0: 4554 494c 545f 5349 474e 203d 202d 312e  ETILT_SIGN = -1.
+000263b0: 300a 0a20 2020 2020 2020 2023 2054 4f44  0..        # TOD
+000263c0: 4f3a 2063 6865 636b 2074 6869 7320 7072  O: check this pr
+000263d0: 652d 7469 6c74 2061 6e67 6c65 2063 616c  e-tilt angle cal
+000263e0: 6375 6c61 7469 6f6e 0a20 2020 2020 2020  culation.       
+000263f0: 2063 6f72 7265 6374 6564 5f70 7265 7469   corrected_preti
+00026400: 6c74 5f61 6e67 6c65 203d 2050 5245 5449  lt_angle = PRETI
+00026410: 4c54 5f53 4947 4e20 2a20 2873 7461 6765  LT_SIGN * (stage
+00026420: 5f74 696c 745f 666c 6174 5f74 6f5f 656c  _tilt_flat_to_el
+00026430: 6563 7472 6f6e 202d 2073 656c 662e 7379  ectron - self.sy
+00026440: 7374 656d 2e73 7461 6765 2e73 6875 7474  stem.stage.shutt
+00026450: 6c65 5f70 7265 5f74 696c 742a 636f 6e73  le_pre_tilt*cons
+00026460: 7461 6e74 732e 4445 4752 4545 535f 544f  tants.DEGREES_TO
+00026470: 5f52 4144 4941 4e53 290a 2020 2020 2020  _RADIANS).      
+00026480: 2020 7065 7273 7065 6374 6976 655f 7469    perspective_ti
+00026490: 6c74 203d 2028 2d20 636f 7272 6563 7465  lt = (- correcte
+000264a0: 645f 7072 6574 696c 745f 616e 676c 6520  d_pretilt_angle 
+000264b0: 2d20 7374 6167 655f 7469 6c74 5f66 6c61  - stage_tilt_fla
+000264c0: 745f 746f 5f69 6f6e 290a 2020 2020 2020  t_to_ion).      
+000264d0: 2020 7a5f 7065 7273 7065 6374 6976 6520    z_perspective 
+000264e0: 3d20 2d20 6479 5f6d 6f76 652f 6e70 2e63  = - dy_move/np.c
+000264f0: 6f73 2828 7374 6167 655f 7469 6c74 202b  os((stage_tilt +
+00026500: 2063 6f72 7265 6374 6564 5f70 7265 7469   corrected_preti
+00026510: 6c74 5f61 6e67 6c65 202b 2070 6572 7370  lt_angle + persp
+00026520: 6563 7469 7665 5f74 696c 7429 290a 2020  ective_tilt)).  
+00026530: 2020 2020 2020 7a5f 6d6f 7665 203d 207a        z_move = z
+00026540: 5f70 6572 7370 6563 7469 7665 2a6e 702e  _perspective*np.
+00026550: 7369 6e28 3930 2a63 6f6e 7374 616e 7473  sin(90*constants
+00026560: 2e44 4547 5245 4553 5f54 4f5f 5241 4449  .DEGREES_TO_RADI
+00026570: 414e 5320 2d20 7374 6167 655f 7469 6c74  ANS - stage_tilt
+00026580: 5f66 6c61 745f 746f 5f69 6f6e 2920 0a20  _flat_to_ion) . 
+00026590: 2020 2020 2020 2023 207a 5f6d 6f76 6520         # z_move 
+000265a0: 3d20 6479 202f 206e 702e 636f 7328 0a20  = dy / np.cos(. 
+000265b0: 2020 2020 2020 2023 2020 2020 206e 702e         #     np.
+000265c0: 6465 6732 7261 6428 3930 202d 2073 7461  deg2rad(90 - sta
+000265d0: 6765 5f74 696c 745f 666c 6174 5f74 6f5f  ge_tilt_flat_to_
+000265e0: 696f 6e20 2b20 7373 656c 662e 7379 7374  ion + sself.syst
+000265f0: 656d 2e73 7461 6765 2e73 6875 7474 6c65  em.stage.shuttle
+00026600: 5f70 7265 5f74 696c 7429 0a20 2020 2020  _pre_tilt).     
+00026610: 2020 2023 2029 2020 2320 544f 444f 3a20     # )  # TODO: 
+00026620: 4d41 4749 4320 4e55 4d42 4552 2c20 3930  MAGIC NUMBER, 90
+00026630: 202d 2066 6962 2074 696c 740a 2020 2020   - fib tilt.    
+00026640: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00026650: 2866 2265 7563 656e 7472 6963 206d 6f76  (f"eucentric mov
+00026660: 656d 656e 743a 207b 7a5f 6d6f 7665 7d22  ement: {z_move}"
+00026670: 290a 2020 2020 2020 2020 7a5f 6d6f 7665  ).        z_move
+00026680: 203d 2046 6962 7365 6d53 7461 6765 506f   = FibsemStagePo
+00026690: 7369 7469 6f6e 2878 3d64 782c 2079 3d30  sition(x=dx, y=0
+000266a0: 2c20 7a3d 7a5f 6d6f 7665 2c20 723d 302c  , z=z_move, r=0,
+000266b0: 2074 3d30 290a 2020 2020 2020 2020 7365   t=0).        se
+000266c0: 6c66 2e6d 6f76 655f 7374 6167 655f 7265  lf.move_stage_re
+000266d0: 6c61 7469 7665 287a 5f6d 6f76 6529 0a0a  lative(z_move)..
+000266e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+000266f0: 6e65 6374 696f 6e2e 5345 4d2e 4f70 7469  nection.SEM.Opti
+00026700: 6373 2e53 6574 5744 2877 6429 0a0a 2020  cs.SetWD(wd)..  
+00026710: 2020 6465 6620 5f79 5f63 6f72 7265 6374    def _y_correct
+00026720: 6564 5f73 7461 6765 5f6d 6f76 656d 656e  ed_stage_movemen
+00026730: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+00026740: 0a20 2020 2020 2020 2065 7870 6563 7465  .        expecte
+00026750: 645f 793a 2066 6c6f 6174 2c0a 2020 2020  d_y: float,.    
+00026760: 2020 2020 6265 616d 5f74 7970 653a 2042      beam_type: B
+00026770: 6561 6d54 7970 6520 3d20 4265 616d 5479  eamType = BeamTy
+00026780: 7065 2e45 4c45 4354 524f 4e2c 0a20 2020  pe.ELECTRON,.   
+00026790: 2029 202d 3e20 4669 6273 656d 5374 6167   ) -> FibsemStag
+000267a0: 6550 6f73 6974 696f 6e3a 0a20 2020 2020  ePosition:.     
+000267b0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+000267c0: 616c 6375 6c61 7465 2074 6865 2079 2063  alculate the y c
+000267d0: 6f72 7265 6374 6564 2073 7461 6765 206d  orrected stage m
+000267e0: 6f76 656d 656e 742c 2063 6f72 7265 6374  ovement, correct
+000267f0: 6564 2066 6f72 2074 6865 2061 6464 6974  ed for the addit
+00026800: 696f 6e61 6c20 7469 6c74 206f 6620 7468  ional tilt of th
+00026810: 6520 7361 6d70 6c65 2068 6f6c 6465 7220  e sample holder 
+00026820: 2870 7265 2d74 696c 7420 616e 676c 6529  (pre-tilt angle)
+00026830: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00026840: 0a20 2020 2020 2020 2020 2020 2065 7870  .            exp
+00026850: 6563 7465 645f 7920 2866 6c6f 6174 2c20  ected_y (float, 
+00026860: 6f70 7469 6f6e 616c 293a 2064 6973 7461  optional): dista
+00026870: 6e63 6520 616c 6f6e 6720 792d 6178 6973  nce along y-axis
+00026880: 2e0a 2020 2020 2020 2020 2020 2020 6265  ..            be
+00026890: 616d 5f74 7970 6520 2842 6561 6d54 7970  am_type (BeamTyp
+000268a0: 652c 206f 7074 696f 6e61 6c29 3a20 6265  e, optional): be
+000268b0: 616d 5f74 7970 6520 746f 206d 6f76 6520  am_type to move 
+000268c0: 696e 2e20 4465 6661 756c 7473 2074 6f20  in. Defaults to 
+000268d0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+000268e0: 4e2e 0a0a 2020 2020 2020 2020 5265 7475  N...        Retu
+000268f0: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+00026900: 2053 7461 6765 506f 7369 7469 6f6e 3a20   StagePosition: 
+00026910: 7920 636f 7272 6563 7465 6420 7374 6167  y corrected stag
+00026920: 6520 6d6f 7665 6d65 6e74 2028 7265 6c61  e movement (rela
+00026930: 7469 7665 2070 6f73 6974 696f 6e29 0a20  tive position). 
+00026940: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00026950: 2020 2020 2320 544f 444f 3a20 7265 706c      # TODO: repl
+00026960: 6163 6520 7769 7468 2063 616d 6572 6120  ace with camera 
+00026970: 6d61 7472 6978 202a 2069 6e76 6572 7365  matrix * inverse
+00026980: 206b 696e 656d 6174 6963 730a 2020 2020   kinematics.    
+00026990: 2020 2020 2320 544f 444f 3a20 7265 706c      # TODO: repl
+000269a0: 6163 6520 7374 6167 655f 7469 6c74 5f66  ace stage_tilt_f
+000269b0: 6c61 745f 746f 5f65 6c65 6374 726f 6e20  lat_to_electron 
+000269c0: 7769 7468 2070 7265 2d74 696c 740a 0a20  with pre-tilt.. 
+000269d0: 2020 2020 2020 2023 2061 6c6c 2061 6e67         # all ang
+000269e0: 6c65 7320 696e 2072 6164 6961 6e73 0a20  les in radians. 
+000269f0: 2020 2020 2020 2073 7461 6765 5f74 696c         stage_til
+00026a00: 745f 666c 6174 5f74 6f5f 656c 6563 7472  t_flat_to_electr
+00026a10: 6f6e 203d 206e 702e 6465 6732 7261 6428  on = np.deg2rad(
+00026a20: 7365 6c66 2e73 7973 7465 6d2e 656c 6563  self.system.elec
+00026a30: 7472 6f6e 2e63 6f6c 756d 6e5f 7469 6c74  tron.column_tilt
+00026a40: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
+00026a50: 7469 6c74 5f66 6c61 745f 746f 5f69 6f6e  tilt_flat_to_ion
+00026a60: 203d 206e 702e 6465 6732 7261 6428 7365   = np.deg2rad(se
+00026a70: 6c66 2e73 7973 7465 6d2e 696f 6e2e 636f  lf.system.ion.co
+00026a80: 6c75 6d6e 5f74 696c 7429 0a0a 2020 2020  lumn_tilt)..    
+00026a90: 2020 2020 7374 6167 655f 726f 7461 7469      stage_rotati
+00026aa0: 6f6e 5f66 6c61 745f 746f 5f69 6f6e 203d  on_flat_to_ion =
+00026ab0: 206e 702e 6465 6732 7261 6428 0a20 2020   np.deg2rad(.   
+00026ac0: 2020 2020 2020 2020 2073 656c 662e 7379           self.sy
+00026ad0: 7374 656d 2e73 7461 6765 2e72 6f74 6174  stem.stage.rotat
+00026ae0: 696f 6e5f 3138 300a 2020 2020 2020 2020  ion_180.        
+00026af0: 2920 2520 2832 202a 206e 702e 7069 290a  ) % (2 * np.pi).
+00026b00: 0a20 2020 2020 2020 2023 2063 7572 7265  .        # curre
+00026b10: 6e74 2073 7461 6765 2070 6f73 6974 696f  nt stage positio
+00026b20: 6e0a 2020 2020 2020 2020 6375 7272 656e  n.        curren
+00026b30: 745f 7374 6167 655f 706f 7369 7469 6f6e  t_stage_position
+00026b40: 203d 2073 656c 662e 6765 745f 7374 6167   = self.get_stag
+00026b50: 655f 706f 7369 7469 6f6e 2829 0a20 2020  e_position().   
+00026b60: 2020 2020 2073 7461 6765 5f72 6f74 6174       stage_rotat
+00026b70: 696f 6e20 3d20 6375 7272 656e 745f 7374  ion = current_st
+00026b80: 6167 655f 706f 7369 7469 6f6e 2e72 2025  age_position.r %
+00026b90: 2028 3220 2a20 6e70 2e70 6929 0a20 2020   (2 * np.pi).   
+00026ba0: 2020 2020 2073 7461 6765 5f74 696c 7420       stage_tilt 
+00026bb0: 3d20 6375 7272 656e 745f 7374 6167 655f  = current_stage_
+00026bc0: 706f 7369 7469 6f6e 2e74 0a0a 2020 2020  position.t..    
+00026bd0: 2020 2020 5052 4554 494c 545f 5349 474e      PRETILT_SIGN
+00026be0: 203d 2031 2e30 0a20 2020 2020 2020 2066   = 1.0.        f
+00026bf0: 726f 6d20 6669 6273 656d 2069 6d70 6f72  rom fibsem impor
+00026c00: 7420 6d6f 7665 6d65 6e74 0a0a 2020 2020  t movement..    
+00026c10: 2020 2020 6966 206d 6f76 656d 656e 742e      if movement.
+00026c20: 726f 7461 7469 6f6e 5f61 6e67 6c65 5f69  rotation_angle_i
+00026c30: 735f 736d 616c 6c65 7228 0a20 2020 2020  s_smaller(.     
+00026c40: 2020 2020 2020 2073 7461 6765 5f72 6f74         stage_rot
+00026c50: 6174 696f 6e2c 2073 7461 6765 5f72 6f74  ation, stage_rot
+00026c60: 6174 696f 6e5f 666c 6174 5f74 6f5f 696f  ation_flat_to_io
+00026c70: 6e2c 2061 746f 6c3d 350a 2020 2020 2020  n, atol=5.      
+00026c80: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00026c90: 2050 5245 5449 4c54 5f53 4947 4e20 3d20   PRETILT_SIGN = 
+00026ca0: 2d31 2e30 0a0a 2020 2020 2020 2020 636f  -1.0..        co
+00026cb0: 7272 6563 7465 645f 7072 6574 696c 745f  rrected_pretilt_
+00026cc0: 616e 676c 6520 3d20 5052 4554 494c 545f  angle = PRETILT_
+00026cd0: 5349 474e 202a 2028 7374 6167 655f 7469  SIGN * (stage_ti
+00026ce0: 6c74 5f66 6c61 745f 746f 5f65 6c65 6374  lt_flat_to_elect
+00026cf0: 726f 6e20 2d20 7365 6c66 2e73 7973 7465  ron - self.syste
+00026d00: 6d2e 7374 6167 652e 7368 7574 746c 655f  m.stage.shuttle_
+00026d10: 7072 655f 7469 6c74 2a63 6f6e 7374 616e  pre_tilt*constan
+00026d20: 7473 2e44 4547 5245 4553 5f54 4f5f 5241  ts.DEGREES_TO_RA
+00026d30: 4449 414e 5329 0a20 2020 2020 2020 200a  DIANS).        .
+00026d40: 2020 2020 2020 2020 7065 7273 7065 6374          perspect
+00026d50: 6976 655f 7469 6c74 203d 202d 2063 6f72  ive_tilt = - cor
+00026d60: 7265 6374 6564 5f70 7265 7469 6c74 5f61  rected_pretilt_a
+00026d70: 6e67 6c65 2069 6620 6265 616d 5f74 7970  ngle if beam_typ
+00026d80: 6520 6973 2042 6561 6d54 7970 652e 454c  e is BeamType.EL
+00026d90: 4543 5452 4f4e 2065 6c73 6520 282d 2063  ECTRON else (- c
+00026da0: 6f72 7265 6374 6564 5f70 7265 7469 6c74  orrected_pretilt
+00026db0: 5f61 6e67 6c65 202d 2073 7461 6765 5f74  _angle - stage_t
+00026dc0: 696c 745f 666c 6174 5f74 6f5f 696f 6e29  ilt_flat_to_ion)
+00026dd0: 0a0a 2020 2020 2020 2020 795f 6d6f 7665  ..        y_move
+00026de0: 203d 2065 7870 6563 7465 645f 792f 6e70   = expected_y/np
+00026df0: 2e63 6f73 2828 7374 6167 655f 7469 6c74  .cos((stage_tilt
+00026e00: 202b 2063 6f72 7265 6374 6564 5f70 7265   + corrected_pre
+00026e10: 7469 6c74 5f61 6e67 6c65 202b 2070 6572  tilt_angle + per
+00026e20: 7370 6563 7469 7665 5f74 696c 7429 290a  spective_tilt)).
+00026e30: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00026e40: 2020 7a5f 6d6f 7665 203d 2079 5f6d 6f76    z_move = y_mov
+00026e50: 652a 6e70 2e73 696e 2828 636f 7272 6563  e*np.sin((correc
+00026e60: 7465 645f 7072 6574 696c 745f 616e 676c  ted_pretilt_angl
+00026e70: 6529 2920 0a20 2020 2020 2020 2070 7269  e)) .        pri
+00026e80: 6e74 2866 2753 7461 6765 2074 696c 743a  nt(f'Stage tilt:
+00026e90: 207b 7374 6167 655f 7469 6c74 7d2c 2063   {stage_tilt}, c
+00026ea0: 6f72 7265 6374 6564 2070 7265 7469 6c74  orrected pretilt
+00026eb0: 3a20 7b63 6f72 7265 6374 6564 5f70 7265  : {corrected_pre
+00026ec0: 7469 6c74 5f61 6e67 6c65 7d2c 2079 5f6d  tilt_angle}, y_m
+00026ed0: 6f76 653a 207b 795f 6d6f 7665 7d20 7a5f  ove: {y_move} z_
+00026ee0: 6d6f 7665 3a20 7b7a 5f6d 6f76 657d 2729  move: {z_move}')
+00026ef0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00026f00: 2046 6962 7365 6d53 7461 6765 506f 7369   FibsemStagePosi
+00026f10: 7469 6f6e 2878 3d30 2c20 793d 795f 6d6f  tion(x=0, y=y_mo
+00026f20: 7665 2c20 7a3d 7a5f 6d6f 7665 290a 0a20  ve, z=z_move).. 
+00026f30: 2020 2064 6566 206d 6f76 655f 666c 6174     def move_flat
+00026f40: 5f74 6f5f 6265 616d 280a 2020 2020 2020  _to_beam(.      
+00026f50: 2020 7365 6c66 2c20 6265 616d 5f74 7970    self, beam_typ
+00026f60: 653a 2042 6561 6d54 7970 6520 3d20 4265  e: BeamType = Be
+00026f70: 616d 5479 7065 2e45 4c45 4354 524f 4e2c  amType.ELECTRON,
+00026f80: 205f 7361 6665 3a20 626f 6f6c 203d 2054   _safe: bool = T
+00026f90: 7275 650a 2020 2020 293a 0a20 2020 2020  rue.    ):.     
+00026fa0: 2020 2022 2222 0a20 2020 2020 2020 204d     """.        M
+00026fb0: 6f76 6573 2074 6865 206d 6963 726f 7363  oves the microsc
+00026fc0: 6f70 6520 7374 6167 6520 746f 2074 6865  ope stage to the
+00026fd0: 2074 696c 7420 616e 676c 6520 636f 7272   tilt angle corr
+00026fe0: 6573 706f 6e64 696e 6720 746f 2074 6865  esponding to the
+00026ff0: 2067 6976 656e 2062 6561 6d20 7479 7065   given beam type
+00027000: 2c0a 2020 2020 2020 2020 736f 2074 6861  ,.        so tha
+00027010: 7420 7468 6520 7374 6167 6520 6973 2066  t the stage is f
+00027020: 6c61 7420 7769 7468 2072 6573 7065 6374  lat with respect
+00027030: 2074 6f20 7468 6520 6265 616d 2e0a 0a20   to the beam... 
+00027040: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00027050: 2020 2020 2020 2020 2062 6561 6d5f 7479           beam_ty
+00027060: 7065 2028 4265 616d 5479 7065 293a 2054  pe (BeamType): T
+00027070: 6865 2074 7970 6520 6f66 2062 6561 6d20  he type of beam 
+00027080: 746f 2077 6869 6368 2074 6865 2073 7461  to which the sta
+00027090: 6765 2073 686f 756c 6420 6265 206d 6164  ge should be mad
+000270a0: 6520 666c 6174 2e0a 2020 2020 2020 2020  e flat..        
+000270b0: 2020 2020 2020 2020 4d75 7374 2062 6520          Must be 
+000270c0: 6f6e 6520 6f66 2042 6561 6d54 7970 652e  one of BeamType.
+000270d0: 454c 4543 5452 4f4e 206f 7220 4265 616d  ELECTRON or Beam
+000270e0: 5479 7065 2e49 4f4e 2e0a 0a20 2020 2020  Type.ION...     
+000270f0: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+00027100: 2020 2020 2020 2020 4e6f 6e65 2e0a 2020          None..  
+00027110: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00027120: 2020 5f63 6865 636b 5f62 6561 6d28 6265    _check_beam(be
+00027130: 616d 5f74 7970 652c 2073 656c 662e 7379  am_type, self.sy
+00027140: 7374 656d 290a 2020 2020 2020 2020 2320  stem).        # 
+00027150: 4255 4720 6966 2049 2073 6574 206f 7220  BUG if I set or 
+00027160: 7061 7373 2042 6561 6d54 7970 652e 494f  pass BeamType.IO
+00027170: 4e20 6974 2073 7469 6c6c 2073 6565 7320  N it still sees 
+00027180: 6265 616d 5f74 7970 6520 6173 2042 6561  beam_type as Bea
+00027190: 6d54 7970 652e 454c 4543 5452 4f4e 0a20  mType.ELECTRON. 
+000271a0: 2020 200a 2020 2020 2020 2020 6966 2062     .        if b
+000271b0: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
+000271c0: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
+000271d0: 2020 2020 2020 7469 6c74 203d 2073 656c        tilt = sel
+000271e0: 662e 7379 7374 656d 2e69 6f6e 2e63 6f6c  f.system.ion.col
+000271f0: 756d 6e5f 7469 6c74 0a20 2020 2020 2020  umn_tilt.       
+00027200: 2065 6c69 6620 6265 616d 5f74 7970 6520   elif beam_type 
+00027210: 6973 2042 6561 6d54 7970 652e 454c 4543  is BeamType.ELEC
+00027220: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
+00027230: 2020 7469 6c74 203d 2073 656c 662e 7379    tilt = self.sy
+00027240: 7374 656d 2e65 6c65 6374 726f 6e2e 636f  stem.electron.co
+00027250: 6c75 6d6e 5f74 696c 7420 0a20 2020 2020  lumn_tilt .     
+00027260: 2020 2023 544f 444f 3a20 6e6f 2070 7265     #TODO: no pre
+00027270: 2d74 696c 7420 6669 7820 7468 6973 0a0a  -tilt fix this..
+00027280: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00027290: 696e 666f 2866 224d 6f76 696e 6720 5374  info(f"Moving St
+000272a0: 6167 6520 466c 6174 2074 6f20 7b62 6561  age Flat to {bea
+000272b0: 6d5f 7479 7065 2e6e 616d 657d 2042 6561  m_type.name} Bea
+000272c0: 6d22 290a 2020 2020 2020 2020 7365 6c66  m").        self
+000272d0: 2e63 6f6e 6e65 6374 696f 6e2e 5374 6167  .connection.Stag
+000272e0: 652e 4d6f 7665 546f 2874 696c 7478 3d74  e.MoveTo(tiltx=t
+000272f0: 696c 7429 0a0a 0a20 2020 2064 6566 2067  ilt)...    def g
+00027300: 6574 5f6d 616e 6970 756c 6174 6f72 5f73  et_manipulator_s
+00027310: 7461 7465 2873 656c 6629 202d 3e20 626f  tate(self) -> bo
+00027320: 6f6c 3a0a 0a20 2020 2020 2020 2022 2222  ol:..        """
+00027330: 7265 7475 726e 7320 7472 7565 2069 6620  returns true if 
+00027340: 6e61 6e6f 6d61 6e69 7075 6c61 746f 7220  nanomanipulator 
+00027350: 6973 2069 6e73 6572 7465 642e 204d 616e  is inserted. Man
+00027360: 6970 756c 6174 6f72 2070 6f73 6974 696f  ipulator positio
+00027370: 6e73 206d 7573 7420 6265 2063 616c 6962  ns must be calib
+00027380: 7261 7465 6420 616e 6420 7374 6f72 6564  rated and stored
+00027390: 2069 6e20 7379 7374 656d 2e79 616d 6c20   in system.yaml 
+000273a0: 6669 6c65 2069 6620 6e6f 7420 646f 6e65  file if not done
+000273b0: 2073 6f0a 0a20 2020 2020 2020 2052 6169   so..        Rai
+000273c0: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
+000273d0: 2056 616c 7565 4572 726f 723a 205f 6465   ValueError: _de
+000273e0: 7363 7269 7074 696f 6e5f 0a0a 2020 2020  scription_..    
+000273f0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+00027400: 2020 2020 2020 2020 205f 7479 7065 5f3a           _type_:
+00027410: 2054 7275 6520 6966 2049 6e73 6572 7465   True if Inserte
+00027420: 642c 2046 616c 7365 2069 6620 7265 7472  d, False if retr
+00027430: 6163 7465 640a 2020 2020 2020 2020 2222  acted.        ""
+00027440: 220a 0a20 2020 2020 2020 206d 616e 6970  "..        manip
+00027450: 756c 6174 6f72 5f70 6f73 6974 696f 6e73  ulator_positions
+00027460: 203d 2063 6667 2e6c 6f61 645f 7465 7363   = cfg.load_tesc
+00027470: 616e 5f6d 616e 6970 756c 6174 6f72 5f63  an_manipulator_c
+00027480: 616c 6962 7261 7469 6f6e 2829 0a0a 2020  alibration()..  
+00027490: 2020 2020 2020 6966 206e 6f74 206d 616e        if not man
+000274a0: 6970 756c 6174 6f72 5f70 6f73 6974 696f  ipulator_positio
+000274b0: 6e73 5b22 6361 6c69 6272 6174 6564 225d  ns["calibrated"]
+000274c0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000274d0: 6767 696e 672e 7761 726e 696e 6728 224d  gging.warning("M
+000274e0: 616e 6970 756c 6174 6f72 2070 6f73 6974  anipulator posit
+000274f0: 696f 6e73 206e 6f74 2063 616c 6962 7261  ions not calibra
+00027500: 7465 642c 2063 616e 6e6f 7420 6765 7420  ted, cannot get 
+00027510: 7374 6174 6522 290a 2020 2020 2020 2020  state").        
+00027520: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00027530: 0a0a 2020 2020 2020 2020 7265 7472 6163  ..        retrac
+00027540: 7465 645f 706f 7369 7469 6f6e 5f78 203d  ted_position_x =
+00027550: 206d 616e 6970 756c 6174 6f72 5f70 6f73   manipulator_pos
+00027560: 6974 696f 6e73 5b22 7061 726b 696e 6722  itions["parking"
+00027570: 5d5b 2278 225d 2a63 6f6e 7374 616e 7473  ]["x"]*constants
+00027580: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
+00027590: 4554 5245 0a20 2020 2020 2020 2072 6574  ETRE.        ret
+000275a0: 7261 6374 6564 5f70 6f73 6974 696f 6e5f  racted_position_
+000275b0: 7920 3d20 6d61 6e69 7075 6c61 746f 725f  y = manipulator_
+000275c0: 706f 7369 7469 6f6e 735b 2270 6172 6b69  positions["parki
+000275d0: 6e67 225d 5b22 7922 5d2a 636f 6e73 7461  ng"]["y"]*consta
+000275e0: 6e74 732e 4d45 5452 455f 544f 5f4d 494c  nts.METRE_TO_MIL
+000275f0: 4c49 4d45 5452 450a 2020 2020 2020 2020  LIMETRE.        
+00027600: 7265 7472 6163 7465 645f 706f 7369 7469  retracted_positi
+00027610: 6f6e 5f7a 203d 206d 616e 6970 756c 6174  on_z = manipulat
+00027620: 6f72 5f70 6f73 6974 696f 6e73 5b22 7061  or_positions["pa
+00027630: 726b 696e 6722 5d5b 227a 225d 2a63 6f6e  rking"]["z"]*con
+00027640: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+00027650: 4d49 4c4c 494d 4554 5245 0a0a 2020 2020  MILLIMETRE..    
+00027660: 2020 2020 6375 7272 656e 745f 706f 7369      current_posi
+00027670: 7469 6f6e 203d 2073 656c 662e 6765 745f  tion = self.get_
+00027680: 6d61 6e69 7075 6c61 746f 725f 706f 7369  manipulator_posi
+00027690: 7469 6f6e 2829 0a0a 2020 2020 2020 2020  tion()..        
+000276a0: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+000276b0: 5f61 7272 6179 203d 205b 6375 7272 656e  _array = [curren
+000276c0: 745f 706f 7369 7469 6f6e 2e78 2a63 6f6e  t_position.x*con
+000276d0: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+000276e0: 4d49 4c4c 494d 4554 5245 2c20 6375 7272  MILLIMETRE, curr
+000276f0: 656e 745f 706f 7369 7469 6f6e 2e79 2a63  ent_position.y*c
+00027700: 6f6e 7374 616e 7473 2e4d 4554 5245 5f54  onstants.METRE_T
+00027710: 4f5f 4d49 4c4c 494d 4554 5245 2c20 6375  O_MILLIMETRE, cu
+00027720: 7272 656e 745f 706f 7369 7469 6f6e 2e7a  rrent_position.z
+00027730: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
+00027740: 5f54 4f5f 4d49 4c4c 494d 4554 5245 5d0a  _TO_MILLIMETRE].
+00027750: 0a20 2020 2020 2020 2063 6865 636b 5f63  .        check_c
+00027760: 6f6d 7061 7265 203d 206e 702e 6973 636c  ompare = np.iscl
+00027770: 6f73 6528 6375 7272 656e 745f 706f 7369  ose(current_posi
+00027780: 7469 6f6e 5f61 7272 6179 2c20 5b72 6574  tion_array, [ret
+00027790: 7261 6374 6564 5f70 6f73 6974 696f 6e5f  racted_position_
+000277a0: 782c 2072 6574 7261 6374 6564 5f70 6f73  x, retracted_pos
+000277b0: 6974 696f 6e5f 792c 2072 6574 7261 6374  ition_y, retract
+000277c0: 6564 5f70 6f73 6974 696f 6e5f 7a5d 2c20  ed_position_z], 
+000277d0: 6174 6f6c 3d30 2e31 290a 0a20 2020 2020  atol=0.1)..     
+000277e0: 2020 2072 6574 7572 6e20 5472 7565 2069     return True i
+000277f0: 6620 4661 6c73 6520 696e 2063 6865 636b  f False in check
+00027800: 5f63 6f6d 7061 7265 2065 6c73 6520 4661  _compare else Fa
+00027810: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00027820: 0a0a 2020 2020 6465 6620 6765 745f 6d61  ..    def get_ma
+00027830: 6e69 7075 6c61 746f 725f 706f 7369 7469  nipulator_positi
+00027840: 6f6e 2873 656c 6629 202d 3e20 4669 6273  on(self) -> Fibs
+00027850: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
+00027860: 6974 696f 6e3a 0a20 2020 2020 2020 2023  ition:.        #
+00027870: 2070 6173 730a 2020 2020 2020 2020 5f63   pass.        _c
+00027880: 6865 636b 5f6d 616e 6970 756c 6174 6f72  heck_manipulator
+00027890: 2873 656c 662e 7379 7374 656d 290a 2020  (self.system).  
+000278a0: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
+000278b0: 2020 2020 2020 2020 6f75 7470 7574 5f70          output_p
+000278c0: 6f73 6974 696f 6e20 3d20 7365 6c66 2e63  osition = self.c
+000278d0: 6f6e 6e65 6374 696f 6e2e 4e61 6e6f 6d61  onnection.Nanoma
+000278e0: 6e69 7075 6c61 746f 722e 4765 7450 6f73  nipulator.GetPos
+000278f0: 6974 696f 6e28 496e 6465 783d 696e 6465  ition(Index=inde
+00027900: 7829 0a0a 2020 2020 2020 2020 2320 4765  x)..        # Ge
+00027910: 7450 6f73 6974 696f 6e20 7265 7475 726e  tPosition return
+00027920: 7320 7475 706c 6520 696e 2074 6865 2066  s tuple in the f
+00027930: 6f72 6d20 2878 2c20 792c 207a 2c20 7229  orm (x, y, z, r)
+00027940: 0a20 2020 2020 2020 2023 2078 2c79 2c7a  .        # x,y,z
+00027950: 2069 6e20 6d6d 2061 6e64 2072 2069 6e20   in mm and r in 
+00027960: 6465 6772 6565 732c 206e 6f20 7469 6c74  degrees, no tilt
+00027970: 2069 6e66 6f72 6d61 7469 6f6e 0a0a 2020   information..  
+00027980: 2020 2020 2020 7820 3d20 6f75 7470 7574        x = output
+00027990: 5f70 6f73 6974 696f 6e5b 305d 2a63 6f6e  _position[0]*con
+000279a0: 7374 616e 7473 2e4d 494c 4c49 4d45 5452  stants.MILLIMETR
+000279b0: 455f 544f 5f4d 4554 5245 0a20 2020 2020  E_TO_METRE.     
+000279c0: 2020 2079 203d 206f 7574 7075 745f 706f     y = output_po
+000279d0: 7369 7469 6f6e 5b31 5d2a 636f 6e73 7461  sition[1]*consta
+000279e0: 6e74 732e 4d49 4c4c 494d 4554 5245 5f54  nts.MILLIMETRE_T
+000279f0: 4f5f 4d45 5452 450a 2020 2020 2020 2020  O_METRE.        
+00027a00: 7a20 3d20 6f75 7470 7574 5f70 6f73 6974  z = output_posit
+00027a10: 696f 6e5b 325d 2a63 6f6e 7374 616e 7473  ion[2]*constants
+00027a20: 2e4d 494c 4c49 4d45 5452 455f 544f 5f4d  .MILLIMETRE_TO_M
+00027a30: 4554 5245 0a20 2020 2020 2020 2072 203d  ETRE.        r =
+00027a40: 206f 7574 7075 745f 706f 7369 7469 6f6e   output_position
+00027a50: 5b33 5d2a 636f 6e73 7461 6e74 732e 4445  [3]*constants.DE
+00027a60: 4752 4545 535f 544f 5f52 4144 4941 4e53  GREES_TO_RADIANS
+00027a70: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00027a80: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+00027a90: 6f72 506f 7369 7469 6f6e 2878 3d78 2c20  orPosition(x=x, 
+00027aa0: 793d 792c 207a 3d7a 2c20 723d 7229 0a0a  y=y, z=z, r=r)..
+00027ab0: 0a0a 2020 2020 6465 6620 696e 7365 7274  ..    def insert
+00027ac0: 5f6d 616e 6970 756c 6174 6f72 2873 656c  _manipulator(sel
+00027ad0: 662c 206e 616d 653a 2073 7472 203d 2022  f, name: str = "
+00027ae0: 5374 616e 6462 7922 293a 0a20 2020 2020  Standby"):.     
+00027af0: 2020 205f 6368 6563 6b5f 6d61 6e69 7075     _check_manipu
+00027b00: 6c61 746f 7228 7365 6c66 2e73 7973 7465  lator(self.syste
+00027b10: 6d29 0a20 2020 2020 2020 2070 7265 7365  m).        prese
+00027b20: 745f 706f 7369 7469 6f6e 7320 3d20 5b22  t_positions = ["
+00027b30: 5061 726b 696e 6722 2c22 5374 616e 6462  Parking","Standb
+00027b40: 7922 2c22 576f 726b 696e 6722 2c5d 0a0a  y","Working",]..
+00027b50: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
+00027b60: 3d3d 2022 5041 524b 223a 0a20 2020 2020  == "PARK":.     
+00027b70: 2020 2020 2020 206e 616d 6520 3d20 2250         name = "P
+00027b80: 6172 6b69 6e67 220a 0a20 2020 2020 2020  arking"..       
+00027b90: 2066 6f72 2070 6f73 6974 696f 6e20 696e   for position in
+00027ba0: 2070 7265 7365 745f 706f 7369 7469 6f6e   preset_position
+00027bb0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00027bc0: 6620 6e61 6d65 2e6c 6f77 6572 2829 203d  f name.lower() =
+00027bd0: 3d20 706f 7369 7469 6f6e 2e6c 6f77 6572  = position.lower
+00027be0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00027bf0: 2020 2020 6e61 6d65 203d 2070 6f73 6974      name = posit
+00027c00: 696f 6e0a 2020 2020 0a0a 2020 2020 2020  ion.    ..      
+00027c10: 2020 6966 206e 616d 6520 6e6f 7420 696e    if name not in
+00027c20: 2070 7265 7365 745f 706f 7369 7469 6f6e   preset_position
+00027c30: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00027c40: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00027c50: 6622 506f 7369 7469 6f6e 207b 6e61 6d65  f"Position {name
+00027c60: 7d20 6973 206e 6f74 2061 2076 616c 6964  } is not a valid
+00027c70: 2070 7265 7365 7420 706f 7369 7469 6f6e   preset position
+00027c80: 2e20 5661 6c69 6420 706f 7369 7469 6f6e  . Valid position
+00027c90: 7320 6172 6520 7b70 7265 7365 745f 706f  s are {preset_po
+00027ca0: 7369 7469 6f6e 737d 2e22 290a 0a0a 2020  sitions}.")...  
+00027cb0: 2020 2020 2020 696e 7365 7274 5f70 6f73        insert_pos
+00027cc0: 6974 696f 6e20 3d20 6765 7461 7474 7228  ition = getattr(
+00027cd0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00027ce0: 4e61 6e6f 6d61 6e69 7075 6c61 746f 722e  Nanomanipulator.
+00027cf0: 506f 7369 7469 6f6e 2c6e 616d 6529 0a0a  Position,name)..
+00027d00: 2020 2020 2020 2020 696e 6465 7820 3d20          index = 
+00027d10: 300a 2020 2020 2020 2020 6c6f 6767 696e  0.        loggin
+00027d20: 672e 696e 666f 2866 2249 6e73 6572 7469  g.info(f"Inserti
+00027d30: 6e67 204e 616e 6f6d 616e 6970 756c 6174  ng Nanomanipulat
+00027d40: 6f72 2074 6f20 7b6e 616d 657d 2070 6f73  or to {name} pos
+00027d50: 6974 696f 6e22 290a 2020 2020 2020 2020  ition").        
+00027d60: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00027d70: 4e61 6e6f 6d61 6e69 7075 6c61 746f 722e  Nanomanipulator.
+00027d80: 4d6f 7665 546f 506f 7369 7469 6f6e 2849  MoveToPosition(I
+00027d90: 6e64 6578 3d69 6e64 6578 2c50 6f73 6974  ndex=index,Posit
+00027da0: 696f 6e3d 696e 7365 7274 5f70 6f73 6974  ion=insert_posit
+00027db0: 696f 6e29 0a0a 2020 2020 6465 6620 5f63  ion)..    def _c
+00027dc0: 6865 636b 5f6d 616e 6970 756c 6174 6f72  heck_manipulator
+00027dd0: 5f6c 696d 6974 7328 7365 6c66 2c78 2c79  _limits(self,x,y
+00027de0: 2c7a 2c72 293a 0a0a 2020 2020 2020 2020  ,z,r):..        
+00027df0: 6c69 6d69 7473 203d 2073 656c 662e 636f  limits = self.co
+00027e00: 6e6e 6563 7469 6f6e 2e4e 616e 6f6d 616e  nnection.Nanoman
+00027e10: 6970 756c 6174 6f72 2e47 6574 4c69 6d69  ipulator.GetLimi
+00027e20: 7473 2849 6e64 6578 3d30 2c54 7970 653d  ts(Index=0,Type=
+00027e30: 3029 0a0a 2020 2020 2020 2020 786d 696e  0)..        xmin
+00027e40: 203d 206c 696d 6974 735b 305d 0a20 2020   = limits[0].   
+00027e50: 2020 2020 2078 6d61 7820 3d20 6c69 6d69       xmax = limi
+00027e60: 7473 5b31 5d0a 2020 2020 2020 2020 796d  ts[1].        ym
+00027e70: 696e 203d 206c 696d 6974 735b 325d 0a20  in = limits[2]. 
+00027e80: 2020 2020 2020 2079 6d61 7820 3d20 6c69         ymax = li
+00027e90: 6d69 7473 5b33 5d0a 2020 2020 2020 2020  mits[3].        
+00027ea0: 7a6d 696e 203d 206c 696d 6974 735b 345d  zmin = limits[4]
+00027eb0: 0a20 2020 2020 2020 207a 6d61 7820 3d20  .        zmax = 
+00027ec0: 6c69 6d69 7473 5b35 5d0a 2020 2020 2020  limits[5].      
+00027ed0: 2020 726d 696e 203d 206c 696d 6974 735b    rmin = limits[
+00027ee0: 365d 0a20 2020 2020 2020 2072 6d61 7820  6].        rmax 
+00027ef0: 3d20 6c69 6d69 7473 5b37 5d0a 0a20 2020  = limits[7]..   
+00027f00: 2020 2020 2061 7373 6572 7420 7820 3e3d       assert x >=
+00027f10: 2078 6d69 6e20 616e 6420 7820 3c3d 2078   xmin and x <= x
+00027f20: 6d61 782c 2066 2258 2070 6f73 6974 696f  max, f"X positio
+00027f30: 6e20 7b78 7d20 6973 206f 7574 7369 6465  n {x} is outside
+00027f40: 206f 6620 6d61 6e69 7075 6c61 746f 7220   of manipulator 
+00027f50: 6c69 6d69 7473 207b 786d 696e 7d20 746f  limits {xmin} to
+00027f60: 207b 786d 6178 7d22 0a20 2020 2020 2020   {xmax}".       
+00027f70: 2061 7373 6572 7420 7920 3e3d 2079 6d69   assert y >= ymi
+00027f80: 6e20 616e 6420 7920 3c3d 2079 6d61 782c  n and y <= ymax,
+00027f90: 2066 2259 2070 6f73 6974 696f 6e20 7b79   f"Y position {y
+00027fa0: 7d20 6973 206f 7574 7369 6465 206f 6620  } is outside of 
+00027fb0: 6d61 6e69 7075 6c61 746f 7220 6c69 6d69  manipulator limi
+00027fc0: 7473 207b 796d 696e 7d20 746f 207b 796d  ts {ymin} to {ym
+00027fd0: 6178 7d22 0a20 2020 2020 2020 2061 7373  ax}".        ass
+00027fe0: 6572 7420 7a20 3e3d 207a 6d69 6e20 616e  ert z >= zmin an
+00027ff0: 6420 7a20 3c3d 207a 6d61 782c 2066 225a  d z <= zmax, f"Z
+00028000: 2070 6f73 6974 696f 6e20 7b7a 7d20 6973   position {z} is
+00028010: 206f 7574 7369 6465 206f 6620 6d61 6e69   outside of mani
+00028020: 7075 6c61 746f 7220 6c69 6d69 7473 207b  pulator limits {
+00028030: 7a6d 696e 7d20 746f 207b 7a6d 6178 7d22  zmin} to {zmax}"
+00028040: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00028050: 7220 3e3d 2072 6d69 6e20 616e 6420 7220  r >= rmin and r 
+00028060: 3c3d 2072 6d61 782c 2066 2252 2070 6f73  <= rmax, f"R pos
+00028070: 6974 696f 6e20 7b72 7d20 6973 206f 7574  ition {r} is out
+00028080: 7369 6465 206f 6620 6d61 6e69 7075 6c61  side of manipula
+00028090: 746f 7220 6c69 6d69 7473 207b 726d 696e  tor limits {rmin
+000280a0: 7d20 746f 207b 726d 6178 7d22 0a20 2020  } to {rmax}".   
+000280b0: 200a 2020 2020 6465 6620 7265 7472 6163   .    def retrac
+000280c0: 745f 6d61 6e69 7075 6c61 746f 7228 7365  t_manipulator(se
+000280d0: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+000280e0: 7261 6374 5f70 6f73 6974 696f 6e20 3d20  ract_position = 
+000280f0: 6765 7461 7474 7228 7365 6c66 2e63 6f6e  getattr(self.con
+00028100: 6e65 6374 696f 6e2e 4e61 6e6f 6d61 6e69  nection.Nanomani
+00028110: 7075 6c61 746f 722e 506f 7369 7469 6f6e  pulator.Position
+00028120: 2c22 5061 726b 696e 6722 290a 2020 2020  ,"Parking").    
+00028130: 2020 2020 696e 6465 7820 3d20 300a 2020      index = 0.  
+00028140: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00028150: 6374 696f 6e2e 4e61 6e6f 6d61 6e69 7075  ction.Nanomanipu
+00028160: 6c61 746f 722e 4d6f 7665 546f 506f 7369  lator.MoveToPosi
+00028170: 7469 6f6e 2849 6e64 6578 3d69 6e64 6578  tion(Index=index
+00028180: 2c50 6f73 6974 696f 6e3d 7265 7472 6163  ,Position=retrac
+00028190: 745f 706f 7369 7469 6f6e 290a 2020 2020  t_position).    
+000281a0: 2020 2020 0a0a 2020 2020 0a20 2020 2064      ..    .    d
+000281b0: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
+000281c0: 746f 725f 7265 6c61 7469 7665 2873 656c  tor_relative(sel
+000281d0: 662c 706f 7369 7469 6f6e 3a20 4669 6273  f,position: Fibs
+000281e0: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
+000281f0: 6974 696f 6e2c 206e 616d 653a 2073 7472  ition, name: str
+00028200: 203d 204e 6f6e 6529 3a0a 2020 2020 2020   = None):.      
+00028210: 2020 6966 206e 6f74 206e 702e 6973 636c    if not np.iscl
+00028220: 6f73 6528 706f 7369 7469 6f6e 2e72 2c20  ose(position.r, 
+00028230: 302e 3029 3a0a 2020 2020 2020 2020 2020  0.0):.          
+00028240: 2020 726f 7461 7469 6f6e 203d 2054 7275    rotation = Tru
+00028250: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00028260: 2020 2020 2020 2020 2020 2020 726f 7461              rota
+00028270: 7469 6f6e 203d 2046 616c 7365 0a20 2020  tion = False.   
+00028280: 2020 2020 2069 6620 6e6f 7420 6e70 2e69       if not np.i
+00028290: 7363 6c6f 7365 2870 6f73 6974 696f 6e2e  sclose(position.
+000282a0: 742c 2030 2e30 293a 0a20 2020 2020 2020  t, 0.0):.       
+000282b0: 2020 2020 2074 696c 7420 3d20 5472 7565       tilt = True
+000282c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000282d0: 2020 2020 2020 2020 2020 2074 696c 7420             tilt 
+000282e0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000282f0: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
+00028300: 6f72 2873 656c 662e 7379 7374 656d 2c20  or(self.system, 
+00028310: 726f 7461 7469 6f6e 2c20 7469 6c74 290a  rotation, tilt).
+00028320: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00028330: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
+00028340: 616e 6970 756c 6174 6f72 2e49 7343 616c  anipulator.IsCal
+00028350: 6962 7261 7465 6428 3029 203d 3d20 4661  ibrated(0) == Fa
+00028360: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00028370: 206c 6f67 6769 6e67 2e69 6e66 6f28 2243   logging.info("C
+00028380: 616c 6962 7261 7469 6e67 206d 616e 6970  alibrating manip
+00028390: 756c 6174 6f72 2229 0a20 2020 2020 2020  ulator").       
+000283a0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+000283b0: 7469 6f6e 2e4e 616e 6f6d 616e 6970 756c  tion.Nanomanipul
+000283c0: 6174 6f72 2e43 616c 6962 7261 7465 2830  ator.Calibrate(0
+000283d0: 290a 0a20 2020 2020 2020 2063 7572 7265  )..        curre
+000283e0: 6e74 5f70 6f73 6974 696f 6e20 3d20 7365  nt_position = se
+000283f0: 6c66 2e67 6574 5f6d 616e 6970 756c 6174  lf.get_manipulat
+00028400: 6f72 5f70 6f73 6974 696f 6e28 290a 2020  or_position().  
+00028410: 2020 2020 2020 0a20 2020 2020 2020 2078        .        x
+00028420: 203d 2028 6375 7272 656e 745f 706f 7369   = (current_posi
+00028430: 7469 6f6e 2e78 202b 2070 6f73 6974 696f  tion.x + positio
+00028440: 6e2e 7829 2a63 6f6e 7374 616e 7473 2e4d  n.x)*constants.M
+00028450: 4554 5245 5f54 4f5f 4d49 4c4c 494d 4554  ETRE_TO_MILLIMET
+00028460: 5245 0a20 2020 2020 2020 2079 203d 2028  RE.        y = (
+00028470: 6375 7272 656e 745f 706f 7369 7469 6f6e  current_position
+00028480: 2e79 202b 2070 6f73 6974 696f 6e2e 7929  .y + position.y)
+00028490: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
+000284a0: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
+000284b0: 2020 2020 2020 207a 203d 2028 6375 7272         z = (curr
+000284c0: 656e 745f 706f 7369 7469 6f6e 2e7a 202b  ent_position.z +
+000284d0: 2070 6f73 6974 696f 6e2e 7a29 2a63 6f6e   position.z)*con
+000284e0: 7374 616e 7473 2e4d 4554 5245 5f54 4f5f  stants.METRE_TO_
+000284f0: 4d49 4c4c 494d 4554 5245 0a20 2020 2020  MILLIMETRE.     
+00028500: 2020 2072 203d 2028 6375 7272 656e 745f     r = (current_
+00028510: 706f 7369 7469 6f6e 2e72 202b 2070 6f73  position.r + pos
+00028520: 6974 696f 6e2e 7229 2a63 6f6e 7374 616e  ition.r)*constan
+00028530: 7473 2e52 4144 4941 4e53 5f54 4f5f 4445  ts.RADIANS_TO_DE
+00028540: 4752 4545 530a 2020 2020 2020 2020 696e  GREES.        in
+00028550: 6465 7820 3d20 300a 0a20 2020 2020 2020  dex = 0..       
+00028560: 2023 2073 656c 662e 5f63 6865 636b 5f6d   # self._check_m
+00028570: 616e 6970 756c 6174 6f72 5f6c 696d 6974  anipulator_limit
+00028580: 7328 782c 792c 7a2c 7229 0a0a 2020 2020  s(x,y,z,r)..    
+00028590: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+000285a0: 2866 226d 6f76 696e 6720 6d61 6e69 7075  (f"moving manipu
+000285b0: 6c61 746f 7220 6279 207b 706f 7369 7469  lator by {positi
+000285c0: 6f6e 7d22 290a 2020 2020 2020 2020 7472  on}").        tr
+000285d0: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+000285e0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e4e  elf.connection.N
+000285f0: 616e 6f6d 616e 6970 756c 6174 6f72 2e4d  anomanipulator.M
+00028600: 6f76 6554 6f28 496e 6465 783d 696e 6465  oveTo(Index=inde
+00028610: 782c 583d 782c 2059 3d79 2c20 5a3d 7a2c  x,X=x, Y=y, Z=z,
+00028620: 2052 6f74 3d72 290a 2020 2020 2020 2020   Rot=r).        
+00028630: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00028640: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00028650: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
+00028660: 2865 290a 2020 2020 2020 2020 2020 2020  (e).            
+00028670: 7265 7475 726e 2065 0a0a 2020 2020 0a20  return e..    . 
+00028680: 2020 2064 6566 206d 6f76 655f 6d61 6e69     def move_mani
+00028690: 7075 6c61 746f 725f 6162 736f 6c75 7465  pulator_absolute
+000286a0: 2873 656c 662c 2070 6f73 6974 696f 6e3a  (self, position:
+000286b0: 2046 6962 7365 6d4d 616e 6970 756c 6174   FibsemManipulat
+000286c0: 6f72 506f 7369 7469 6f6e 2c20 6e61 6d65  orPosition, name
+000286d0: 3a20 7374 7220 3d20 4e6f 6e65 293a 0a20  : str = None):. 
+000286e0: 2020 2020 2020 2069 6620 6e6f 7420 6e70         if not np
+000286f0: 2e69 7363 6c6f 7365 2870 6f73 6974 696f  .isclose(positio
+00028700: 6e2e 722c 2030 2e30 293a 0a20 2020 2020  n.r, 0.0):.     
+00028710: 2020 2020 2020 2072 6f74 6174 696f 6e20         rotation 
+00028720: 3d20 5472 7565 0a20 2020 2020 2020 2065  = True.        e
+00028730: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00028740: 2072 6f74 6174 696f 6e20 3d20 4661 6c73   rotation = Fals
+00028750: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
+00028760: 206e 702e 6973 636c 6f73 6528 706f 7369   np.isclose(posi
+00028770: 7469 6f6e 2e74 2c20 302e 3029 3a0a 2020  tion.t, 0.0):.  
+00028780: 2020 2020 2020 2020 2020 7469 6c74 203d            tilt =
+00028790: 2054 7275 650a 2020 2020 2020 2020 656c   True.        el
+000287a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000287b0: 7469 6c74 203d 2046 616c 7365 0a20 2020  tilt = False.   
+000287c0: 2020 2020 205f 6368 6563 6b5f 6d61 6e69       _check_mani
+000287d0: 7075 6c61 746f 7228 7365 6c66 2e73 7973  pulator(self.sys
+000287e0: 7465 6d2c 2072 6f74 6174 696f 6e2c 2074  tem, rotation, t
+000287f0: 696c 7429 0a20 2020 2020 2020 2069 6620  ilt).        if 
+00028800: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00028810: 4e61 6e6f 6d61 6e69 7075 6c61 746f 722e  Nanomanipulator.
+00028820: 4973 4361 6c69 6272 6174 6564 2830 2920  IsCalibrated(0) 
+00028830: 3d3d 2046 616c 7365 3a0a 2020 2020 2020  == False:.      
+00028840: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00028850: 666f 2822 4361 6c69 6272 6174 696e 6720  fo("Calibrating 
+00028860: 6d61 6e69 7075 6c61 746f 7222 290a 2020  manipulator").  
+00028870: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00028880: 6f6e 6e65 6374 696f 6e2e 4e61 6e6f 6d61  onnection.Nanoma
+00028890: 6e69 7075 6c61 746f 722e 4361 6c69 6272  nipulator.Calibr
+000288a0: 6174 6528 3029 0a20 2020 2020 2020 200a  ate(0).        .
+000288b0: 2020 2020 2020 2020 7820 3d20 706f 7369          x = posi
+000288c0: 7469 6f6e 2e78 2a63 6f6e 7374 616e 7473  tion.x*constants
+000288d0: 2e4d 4554 5245 5f54 4f5f 4d49 4c4c 494d  .METRE_TO_MILLIM
+000288e0: 4554 5245 0a20 2020 2020 2020 2079 203d  ETRE.        y =
+000288f0: 2070 6f73 6974 696f 6e2e 792a 636f 6e73   position.y*cons
+00028900: 7461 6e74 732e 4d45 5452 455f 544f 5f4d  tants.METRE_TO_M
+00028910: 494c 4c49 4d45 5452 450a 2020 2020 2020  ILLIMETRE.      
+00028920: 2020 7a20 3d20 706f 7369 7469 6f6e 2e7a    z = position.z
+00028930: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
+00028940: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
+00028950: 2020 2020 2020 2072 203d 2070 6f73 6974         r = posit
+00028960: 696f 6e2e 722a 636f 6e73 7461 6e74 732e  ion.r*constants.
+00028970: 5241 4449 414e 535f 544f 5f44 4547 5245  RADIANS_TO_DEGRE
+00028980: 4553 0a20 2020 2020 2020 2069 6e64 6578  ES.        index
+00028990: 203d 2030 0a0a 2020 2020 2020 2020 2320   = 0..        # 
+000289a0: 7365 6c66 2e5f 6368 6563 6b5f 6d61 6e69  self._check_mani
+000289b0: 7075 6c61 746f 725f 6c69 6d69 7473 2878  pulator_limits(x
+000289c0: 2c79 2c7a 2c72 290a 0a20 2020 2020 2020  ,y,z,r)..       
+000289d0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+000289e0: 6d6f 7669 6e67 206d 616e 6970 756c 6174  moving manipulat
+000289f0: 6f72 2074 6f20 7b70 6f73 6974 696f 6e7d  or to {position}
+00028a00: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
+00028a10: 2e63 6f6e 6e65 6374 696f 6e2e 4e61 6e6f  .connection.Nano
+00028a20: 6d61 6e69 7075 6c61 746f 722e 4d6f 7665  manipulator.Move
+00028a30: 546f 2849 6e64 6578 3d69 6e64 6578 2c20  To(Index=index, 
+00028a40: 583d 782c 2059 3d79 2c20 5a3d 7a2c 2052  X=x, Y=y, Z=z, R
+00028a50: 6f74 3d72 290a 0a20 2020 2064 6566 2063  ot=r)..    def c
+00028a60: 616c 6962 7261 7465 5f6d 616e 6970 756c  alibrate_manipul
+00028a70: 6174 6f72 2873 656c 6629 3a0a 2020 2020  ator(self):.    
+00028a80: 2020 2020 5f63 6865 636b 5f6d 616e 6970      _check_manip
+00028a90: 756c 6174 6f72 2873 656c 662e 7379 7374  ulator(self.syst
+00028aa0: 656d 290a 2020 2020 2020 2020 6c6f 6767  em).        logg
+00028ab0: 696e 672e 696e 666f 2822 4361 6c69 6272  ing.info("Calibr
+00028ac0: 6174 696e 6720 6d61 6e69 7075 6c61 746f  ating manipulato
+00028ad0: 7222 290a 2020 2020 2020 2020 7365 6c66  r").        self
+00028ae0: 2e63 6f6e 6e65 6374 696f 6e2e 4e61 6e6f  .connection.Nano
+00028af0: 6d61 6e69 7075 6c61 746f 722e 4361 6c69  manipulator.Cali
+00028b00: 6272 6174 6528 3029 0a0a 2020 2020 6465  brate(0)..    de
+00028b10: 6620 5f78 5f63 6f72 7265 6374 6564 5f6e  f _x_corrected_n
+00028b20: 6565 646c 655f 6d6f 7665 6d65 6e74 2873  eedle_movement(s
+00028b30: 656c 662c 2065 7870 6563 7465 645f 783a  elf, expected_x:
+00028b40: 2066 6c6f 6174 2920 2d3e 2046 6962 7365   float) -> Fibse
+00028b50: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+00028b60: 7469 6f6e 3a0a 2020 2020 2020 2020 2222  tion:.        ""
+00028b70: 2243 616c 6375 6c61 7465 2074 6865 2063  "Calculate the c
+00028b80: 6f72 7265 6374 6564 206e 6565 646c 6520  orrected needle 
+00028b90: 6d6f 7665 6d65 6e74 2074 6f20 6d6f 7665  movement to move
+00028ba0: 2069 6e20 7468 6520 782d 6178 6973 2e0a   in the x-axis..
+00028bb0: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+00028bc0: 2020 2020 2020 2020 2020 2065 7870 6563             expec
+00028bd0: 7465 645f 7820 2866 6c6f 6174 293a 2064  ted_x (float): d
+00028be0: 6973 7461 6e63 6520 616c 6f6e 6720 7468  istance along th
+00028bf0: 6520 782d 6178 6973 2028 696d 6167 6520  e x-axis (image 
+00028c00: 636f 6f72 6469 6e61 7465 7329 0a20 2020  coordinates).   
+00028c10: 2020 2020 2052 6574 7572 6e73 3a0a 2020       Returns:.  
+00028c20: 2020 2020 2020 2020 2020 4669 6273 656d            Fibsem
+00028c30: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
+00028c40: 696f 6e3a 2078 2d63 6f72 7265 6374 6564  ion: x-corrected
+00028c50: 206e 6565 646c 6520 6d6f 7665 6d65 6e74   needle movement
+00028c60: 2028 7265 6c61 7469 7665 2070 6f73 6974   (relative posit
+00028c70: 696f 6e29 0a20 2020 2020 2020 2022 2222  ion).        """
+00028c80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00028c90: 4669 6273 656d 4d61 6e69 7075 6c61 746f  FibsemManipulato
+00028ca0: 7250 6f73 6974 696f 6e28 783d 6578 7065  rPosition(x=expe
+00028cb0: 6374 6564 5f78 2c20 793d 302c 207a 3d30  cted_x, y=0, z=0
+00028cc0: 2920 2023 206e 6f20 6164 6a75 7374 6d65  )  # no adjustme
+00028cd0: 6e74 206e 6565 6465 640a 0a0a 2020 2020  nt needed...    
+00028ce0: 6465 6620 5f79 5f63 6f72 7265 6374 6564  def _y_corrected
+00028cf0: 5f6e 6565 646c 655f 6d6f 7665 6d65 6e74  _needle_movement
+00028d00: 2873 656c 662c 200a 2020 2020 2020 2020  (self, .        
+00028d10: 6578 7065 6374 6564 5f79 3a20 666c 6f61  expected_y: floa
+00028d20: 742c 2073 7461 6765 5f74 696c 743a 2066  t, stage_tilt: f
+00028d30: 6c6f 6174 0a20 2020 2029 202d 3e20 4669  loat.    ) -> Fi
+00028d40: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
+00028d50: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
+00028d60: 2022 2222 4361 6c63 756c 6174 6520 7468   """Calculate th
+00028d70: 6520 636f 7272 6563 7465 6420 6e65 6564  e corrected need
+00028d80: 6c65 206d 6f76 656d 656e 7420 746f 206d  le movement to m
+00028d90: 6f76 6520 696e 2074 6865 2079 2d61 7869  ove in the y-axi
+00028da0: 732e 0a0a 2020 2020 2020 2020 4172 6773  s...        Args
+00028db0: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
+00028dc0: 7065 6374 6564 5f79 2028 666c 6f61 7429  pected_y (float)
+00028dd0: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
+00028de0: 2074 6865 2079 2d61 7869 7320 2869 6d61   the y-axis (ima
+00028df0: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
+00028e00: 2020 2020 2020 2020 2020 2020 7374 6167              stag
+00028e10: 655f 7469 6c74 2028 666c 6f61 742c 206f  e_tilt (float, o
+00028e20: 7074 696f 6e61 6c29 3a20 7374 6167 6520  ptional): stage 
+00028e30: 7469 6c74 2e0a 0a20 2020 2020 2020 2052  tilt...        R
+00028e40: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00028e50: 2020 2020 4669 6273 656d 4d61 6e69 7075      FibsemManipu
+00028e60: 6c61 746f 7250 6f73 6974 696f 6e3a 2079  latorPosition: y
+00028e70: 2d63 6f72 7265 6374 6564 206e 6565 646c  -corrected needl
+00028e80: 6520 6d6f 7665 6d65 6e74 2028 7265 6c61  e movement (rela
+00028e90: 7469 7665 2070 6f73 6974 696f 6e29 0a20  tive position). 
+00028ea0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00028eb0: 2020 2079 5f6d 6f76 6520 3d20 2b6e 702e     y_move = +np.
+00028ec0: 636f 7328 7374 6167 655f 7469 6c74 2920  cos(stage_tilt) 
+00028ed0: 2a20 6578 7065 6374 6564 5f79 0a20 2020  * expected_y.   
+00028ee0: 2020 2020 207a 5f6d 6f76 6520 3d20 2b6e       z_move = +n
+00028ef0: 702e 7369 6e28 7374 6167 655f 7469 6c74  p.sin(stage_tilt
+00028f00: 2920 2a20 6578 7065 6374 6564 5f79 0a20  ) * expected_y. 
+00028f10: 2020 2020 2020 2072 6574 7572 6e20 4669         return Fi
+00028f20: 6273 656d 4d61 6e69 7075 6c61 746f 7250  bsemManipulatorP
+00028f30: 6f73 6974 696f 6e28 783d 302c 2079 3d79  osition(x=0, y=y
+00028f40: 5f6d 6f76 652c 207a 3d7a 5f6d 6f76 6529  _move, z=z_move)
+00028f50: 0a0a 0a20 2020 2064 6566 205f 7a5f 636f  ...    def _z_co
+00028f60: 7272 6563 7465 645f 6e65 6564 6c65 5f6d  rrected_needle_m
+00028f70: 6f76 656d 656e 7428 7365 6c66 2c20 0a20  ovement(self, . 
+00028f80: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+00028f90: 7a3a 2066 6c6f 6174 2c20 7374 6167 655f  z: float, stage_
+00028fa0: 7469 6c74 3a20 666c 6f61 740a 2020 2020  tilt: float.    
+00028fb0: 2920 2d3e 2046 6962 7365 6d4d 616e 6970  ) -> FibsemManip
+00028fc0: 756c 6174 6f72 506f 7369 7469 6f6e 3a0a  ulatorPosition:.
+00028fd0: 2020 2020 2020 2020 2222 2243 616c 6375          """Calcu
+00028fe0: 6c61 7465 2074 6865 2063 6f72 7265 6374  late the correct
+00028ff0: 6564 206e 6565 646c 6520 6d6f 7665 6d65  ed needle moveme
+00029000: 6e74 2074 6f20 6d6f 7665 2069 6e20 7468  nt to move in th
+00029010: 6520 7a2d 6178 6973 2e0a 0a20 2020 2020  e z-axis...     
+00029020: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00029030: 2020 2020 2065 7870 6563 7465 645f 7a20       expected_z 
+00029040: 2866 6c6f 6174 293a 2064 6973 7461 6e63  (float): distanc
+00029050: 6520 616c 6f6e 6720 7468 6520 7a2d 6178  e along the z-ax
+00029060: 6973 2028 696d 6167 6520 636f 6f72 6469  is (image coordi
+00029070: 6e61 7465 7329 0a20 2020 2020 2020 2020  nates).         
+00029080: 2020 2073 7461 6765 5f74 696c 7420 2866     stage_tilt (f
+00029090: 6c6f 6174 2c20 6f70 7469 6f6e 616c 293a  loat, optional):
+000290a0: 2073 7461 6765 2074 696c 742e 0a0a 2020   stage tilt...  
+000290b0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+000290c0: 2020 2020 2020 2020 2020 2046 6962 7365             Fibse
+000290d0: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+000290e0: 7469 6f6e 3a20 7a2d 636f 7272 6563 7465  tion: z-correcte
+000290f0: 6420 6e65 6564 6c65 206d 6f76 656d 656e  d needle movemen
+00029100: 7420 2872 656c 6174 6976 6520 706f 7369  t (relative posi
+00029110: 7469 6f6e 290a 2020 2020 2020 2020 2222  tion).        ""
+00029120: 220a 2020 2020 2020 2020 795f 6d6f 7665  ".        y_move
+00029130: 203d 202d 6e70 2e73 696e 2873 7461 6765   = -np.sin(stage
+00029140: 5f74 696c 7429 202a 2065 7870 6563 7465  _tilt) * expecte
+00029150: 645f 7a0a 2020 2020 2020 2020 7a5f 6d6f  d_z.        z_mo
+00029160: 7665 203d 202b 6e70 2e63 6f73 2873 7461  ve = +np.cos(sta
+00029170: 6765 5f74 696c 7429 202a 2065 7870 6563  ge_tilt) * expec
+00029180: 7465 645f 7a0a 2020 2020 2020 2020 7265  ted_z.        re
+00029190: 7475 726e 2046 6962 7365 6d4d 616e 6970  turn FibsemManip
+000291a0: 756c 6174 6f72 506f 7369 7469 6f6e 2878  ulatorPosition(x
+000291b0: 3d30 2c20 793d 795f 6d6f 7665 2c20 7a3d  =0, y=y_move, z=
+000291c0: 7a5f 6d6f 7665 290a 0a20 2020 2064 6566  z_move)..    def
+000291d0: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
+000291e0: 725f 636f 7272 6563 7465 6428 7365 6c66  r_corrected(self
+000291f0: 2c20 0a20 2020 2020 2020 2064 783a 2066  , .        dx: f
+00029200: 6c6f 6174 203d 2030 2c0a 2020 2020 2020  loat = 0,.      
+00029210: 2020 6479 3a20 666c 6f61 7420 3d20 302c    dy: float = 0,
+00029220: 0a20 2020 2020 2020 2062 6561 6d5f 7479  .        beam_ty
+00029230: 7065 3a20 4265 616d 5479 7065 203d 2042  pe: BeamType = B
+00029240: 6561 6d54 7970 652e 454c 4543 5452 4f4e  eamType.ELECTRON
+00029250: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+00029260: 0a20 2020 2020 2020 2022 2222 4361 6c63  .        """Calc
+00029270: 756c 6174 6520 7468 6520 7265 7175 6972  ulate the requir
+00029280: 6564 2063 6f72 7265 6374 6564 206e 6565  ed corrected nee
+00029290: 646c 6520 6d6f 7665 6d65 6e74 7320 6261  dle movements ba
+000292a0: 7365 6420 6f6e 2074 6865 2042 6561 6d54  sed on the BeamT
+000292b0: 7970 6520 746f 206d 6f76 6520 696e 2074  ype to move in t
+000292c0: 6865 2064 6573 6972 6564 2069 6d61 6765  he desired image
+000292d0: 2063 6f6f 7264 696e 6174 6573 2e0a 2020   coordinates..  
+000292e0: 2020 2020 2020 5468 656e 206d 6f76 6520        Then move 
+000292f0: 7468 6520 6e65 6564 6c65 2072 656c 6174  the needle relat
+00029300: 6976 656c 792e 0a0a 2020 2020 2020 2020  ively...        
+00029310: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00029320: 4e3a 2020 6d6f 7665 2069 6e20 782c 2079  N:  move in x, y
+00029330: 2028 7261 7720 636f 6f72 6469 6e61 7465   (raw coordinate
+00029340: 7329 0a20 2020 2020 2020 2042 6561 6d54  s).        BeamT
+00029350: 7970 652e 494f 4e3a 2020 2020 2020 206d  ype.ION:       m
+00029360: 6f76 6520 696e 2078 2c20 7a20 2872 6177  ove in x, z (raw
+00029370: 2063 6f6f 7264 696e 6174 6573 290a 0a20   coordinates).. 
+00029380: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00029390: 2020 2020 2020 2020 206d 6963 726f 7363           microsc
+000293a0: 6f70 6520 2853 6462 4d69 6372 6f73 636f  ope (SdbMicrosco
+000293b0: 7065 436c 6965 6e74 293a 2061 7574 6f53  peClient): autoS
+000293c0: 6372 6970 7420 6d69 6372 6f73 636f 7065  cript microscope
+000293d0: 2069 6e73 7461 6e63 650a 2020 2020 2020   instance.      
+000293e0: 2020 2020 2020 6478 2028 666c 6f61 7429        dx (float)
+000293f0: 3a20 6469 7374 616e 6365 2061 6c6f 6e67  : distance along
+00029400: 2074 6865 2078 2d61 7869 7320 2869 6d61   the x-axis (ima
+00029410: 6765 2063 6f6f 7264 696e 6174 6573 290a  ge coordinates).
+00029420: 2020 2020 2020 2020 2020 2020 6479 2028              dy (
+00029430: 666c 6f61 7429 3a20 6469 7374 616e 6365  float): distance
+00029440: 2061 6c6f 6e67 2074 6865 2079 2d61 7869   along the y-axi
+00029450: 7320 2869 6d61 6765 2063 6f72 6f64 696e  s (image corodin
+00029460: 6174 6573 290a 2020 2020 2020 2020 2020  ates).          
+00029470: 2020 6265 616d 5f74 7970 6520 2842 6561    beam_type (Bea
+00029480: 6d54 7970 652c 206f 7074 696f 6e61 6c29  mType, optional)
+00029490: 3a20 7468 6520 6265 616d 2074 7970 6520  : the beam type 
+000294a0: 746f 206d 6f76 6520 696e 2e20 4465 6661  to move in. Defa
+000294b0: 756c 7473 2074 6f20 4265 616d 5479 7065  ults to BeamType
+000294c0: 2e45 4c45 4354 524f 4e2e 0a20 2020 2020  .ELECTRON..     
+000294d0: 2020 2022 2222 0a20 2020 2020 2020 205f     """.        _
+000294e0: 6368 6563 6b5f 6d61 6e69 7075 6c61 746f  check_manipulato
+000294f0: 7228 7365 6c66 2e73 7973 7465 6d29 0a0a  r(self.system)..
+00029500: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00029510: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
+00029520: 616e 6970 756c 6174 6f72 2e49 7343 616c  anipulator.IsCal
+00029530: 6962 7261 7465 6428 3029 203d 3d20 4661  ibrated(0) == Fa
+00029540: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00029550: 206c 6f67 6769 6e67 2e69 6e66 6f28 2243   logging.info("C
+00029560: 616c 6962 7261 7469 6e67 206d 616e 6970  alibrating manip
+00029570: 756c 6174 6f72 2229 0a20 2020 2020 2020  ulator").       
+00029580: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+00029590: 7469 6f6e 2e4e 616e 6f6d 616e 6970 756c  tion.Nanomanipul
+000295a0: 6174 6f72 2e43 616c 6962 7261 7465 2830  ator.Calibrate(0
+000295b0: 290a 2020 2020 2020 2020 7374 6167 655f  ).        stage_
+000295c0: 7469 6c74 203d 2073 656c 662e 6765 745f  tilt = self.get_
+000295d0: 7374 6167 655f 706f 7369 7469 6f6e 2829  stage_position()
+000295e0: 2e74 0a0a 0a20 2020 2020 2020 2023 2023  .t...        # #
+000295f0: 2078 790a 2020 2020 2020 2020 2320 6966   xy.        # if
+00029600: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
+00029610: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
+00029620: 0a20 2020 2020 2020 2023 2020 2020 2078  .        #     x
+00029630: 5f6d 6f76 6520 3d20 7365 6c66 2e5f 785f  _move = self._x_
+00029640: 636f 7272 6563 7465 645f 6e65 6564 6c65  corrected_needle
+00029650: 5f6d 6f76 656d 656e 7428 6578 7065 6374  _movement(expect
+00029660: 6564 5f78 3d64 7829 0a20 2020 2020 2020  ed_x=dx).       
+00029670: 2023 2020 2020 2079 7a5f 6d6f 7665 203d   #     yz_move =
+00029680: 2073 656c 662e 5f79 5f63 6f72 7265 6374   self._y_correct
+00029690: 6564 5f6e 6565 646c 655f 6d6f 7665 6d65  ed_needle_moveme
+000296a0: 6e74 2864 792c 2073 7461 6765 5f74 696c  nt(dy, stage_til
+000296b0: 743d 7374 6167 655f 7469 6c74 290a 0a20  t=stage_tilt).. 
+000296c0: 2020 2020 2020 2023 2023 2078 7a2c 0a20         # # xz,. 
+000296d0: 2020 2020 2020 2023 2069 6620 6265 616d         # if beam
+000296e0: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
+000296f0: 652e 494f 4e3a 0a0a 2020 2020 2020 2020  e.ION:..        
+00029700: 2320 2020 2020 785f 6d6f 7665 203d 2073  #     x_move = s
+00029710: 656c 662e 5f78 5f63 6f72 7265 6374 6564  elf._x_corrected
+00029720: 5f6e 6565 646c 655f 6d6f 7665 6d65 6e74  _needle_movement
+00029730: 2865 7870 6563 7465 645f 783d 6478 290a  (expected_x=dx).
+00029740: 2020 2020 2020 2020 2320 2020 2020 797a          #     yz
+00029750: 5f6d 6f76 6520 3d20 7365 6c66 2e5f 7a5f  _move = self._z_
+00029760: 636f 7272 6563 7465 645f 6e65 6564 6c65  corrected_needle
+00029770: 5f6d 6f76 656d 656e 7428 6578 7065 6374  _movement(expect
+00029780: 6564 5f7a 3d64 792c 2073 7461 6765 5f74  ed_z=dy, stage_t
+00029790: 696c 743d 7374 6167 655f 7469 6c74 290a  ilt=stage_tilt).
+000297a0: 0a20 2020 2020 2020 2023 206d 6f76 6520  .        # move 
+000297b0: 6e65 6564 6c65 2028 7265 6c61 7469 7665  needle (relative
+000297c0: 290a 2020 2020 2020 2020 2373 656c 662e  ).        #self.
+000297d0: 636f 6e6e 6563 7469 6f6e 2e4e 616e 6f6d  connection.Nanom
+000297e0: 616e 6970 756c 6174 6f72 2e4d 6f76 6554  anipulator.MoveT
+000297f0: 6f28 496e 6465 783d 302c 2058 3d78 5f6d  o(Index=0, X=x_m
+00029800: 6f76 652e 782c 2059 3d79 7a5f 6d6f 7665  ove.x, Y=yz_move
+00029810: 2e79 2c20 5a3d 797a 5f6d 6f76 652e 7a29  .y, Z=yz_move.z)
+00029820: 0a20 2020 2020 2020 2073 656c 662e 6d6f  .        self.mo
+00029830: 7665 5f6d 616e 6970 756c 6174 6f72 5f72  ve_manipulator_r
+00029840: 656c 6174 6976 6528 4669 6273 656d 4d61  elative(FibsemMa
+00029850: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+00029860: 6e28 783d 6478 2c20 793d 6479 2c20 7a3d  n(x=dx, y=dy, z=
+00029870: 3029 290a 0a20 2020 2020 2020 2072 6574  0))..        ret
+00029880: 7572 6e0a 0a20 2020 2064 6566 206d 6f76  urn..    def mov
+00029890: 655f 6d61 6e69 7075 6c61 746f 725f 746f  e_manipulator_to
+000298a0: 5f70 6f73 6974 696f 6e5f 6f66 6673 6574  _position_offset
+000298b0: 2873 656c 662c 206f 6666 7365 743a 2046  (self, offset: F
+000298c0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+000298d0: 506f 7369 7469 6f6e 2c20 6e61 6d65 3a20  Position, name: 
+000298e0: 7374 7220 3d20 4e6f 6e65 2920 2d3e 204e  str = None) -> N
+000298f0: 6f6e 653a 0a20 2020 2020 2020 206c 6f67  one:.        log
+00029900: 6769 6e67 2e77 6172 6e69 6e67 2822 4e6f  ging.warning("No
+00029910: 7420 7375 7070 6f72 7465 6420 6279 2054  t supported by T
+00029920: 4553 4341 4e20 4150 4922 290a 2020 2020  ESCAN API").    
+00029930: 2020 2020 2320 7261 6973 6520 4e6f 7449      # raise NotI
+00029940: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+00029950: 224e 6f74 2073 7570 706f 7274 6564 2062  "Not supported b
+00029960: 7920 5445 5343 414e 2041 5049 2229 0a20  y TESCAN API"). 
+00029970: 2020 2020 2020 2023 205f 6368 6563 6b5f         # _check_
+00029980: 6d61 6e69 7075 6c61 746f 725f 6d6f 7665  manipulator_move
+00029990: 6d65 6e74 2873 656c 662e 7379 7374 656d  ment(self.system
+000299a0: 2c20 6f66 6673 6574 290a 2020 2020 2020  , offset).      
+000299b0: 2020 7061 7373 0a0a 2020 2020 6465 6620    pass..    def 
+000299c0: 5f67 6574 5f73 6176 6564 5f6d 616e 6970  _get_saved_manip
+000299d0: 756c 6174 6f72 5f70 6f73 6974 696f 6e28  ulator_position(
+000299e0: 7365 6c66 293a 0a20 2020 2020 2020 205f  self):.        _
+000299f0: 6368 6563 6b5f 6d61 6e69 7075 6c61 746f  check_manipulato
+00029a00: 7228 7365 6c66 2e73 7973 7465 6d29 0a20  r(self.system). 
+00029a10: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
+00029a20: 6172 6e69 6e67 2822 4e6f 7420 7375 7070  arning("Not supp
+00029a30: 6f72 7465 6420 6279 2054 4553 4341 4e20  orted by TESCAN 
+00029a40: 4150 4922 290a 2020 2020 2020 2020 7061  API").        pa
+00029a50: 7373 0a0a 2020 2020 6465 6620 7365 7475  ss..    def setu
+00029a60: 705f 6d69 6c6c 696e 6728 0a20 2020 2020  p_milling(.     
+00029a70: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00029a80: 206d 696c 6c5f 7365 7474 696e 6773 3a20   mill_settings: 
+00029a90: 4669 6273 656d 4d69 6c6c 696e 6753 6574  FibsemMillingSet
+00029aa0: 7469 6e67 732c 0a20 2020 2029 3a0a 2020  tings,.    ):.  
+00029ab0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00029ac0: 2020 436f 6e66 6967 7572 6520 7468 6520    Configure the 
+00029ad0: 6d69 6372 6f73 636f 7065 2066 6f72 206d  microscope for m
+00029ae0: 696c 6c69 6e67 2075 7369 6e67 2074 6865  illing using the
+00029af0: 2069 6f6e 2062 6561 6d2e 0a0a 2020 2020   ion beam...    
+00029b00: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00029b10: 2020 2020 2020 6170 706c 6963 6174 696f        applicatio
+00029b20: 6e5f 6669 6c65 2028 7374 7229 3a20 5061  n_file (str): Pa
+00029b30: 7468 2074 6f20 7468 6520 6d69 6c6c 696e  th to the millin
+00029b40: 6720 6170 706c 6963 6174 696f 6e20 6669  g application fi
+00029b50: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
+00029b60: 7061 7474 6572 6e69 6e67 5f6d 6f64 6520  patterning_mode 
+00029b70: 2873 7472 293a 2050 6174 7465 726e 696e  (str): Patternin
+00029b80: 6720 6d6f 6465 2074 6f20 7573 652e 0a20  g mode to use.. 
+00029b90: 2020 2020 2020 2020 2020 2068 6677 2028             hfw (
+00029ba0: 666c 6f61 7429 3a20 4465 7369 7265 6420  float): Desired 
+00029bb0: 686f 7269 7a6f 6e74 616c 2066 6965 6c64  horizontal field
+00029bc0: 2077 6964 7468 2069 6e20 6d65 7465 7273   width in meters
+00029bd0: 2e0a 2020 2020 2020 2020 2020 2020 6d69  ..            mi
+00029be0: 6c6c 5f73 6574 7469 6e67 7320 2846 6962  ll_settings (Fib
+00029bf0: 7365 6d4d 696c 6c69 6e67 5365 7474 696e  semMillingSettin
+00029c00: 6773 293a 204d 696c 6c69 6e67 2073 6574  gs): Milling set
+00029c10: 7469 6e67 732e 0a0a 2020 2020 2020 2020  tings...        
+00029c20: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+00029c30: 2020 2020 204e 6f6e 652e 0a0a 2020 2020       None...    
+00029c40: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
+00029c50: 2020 2020 2020 2020 4e6f 7449 6d70 6c65          NotImple
+00029c60: 6d65 6e74 6564 4572 726f 723a 2049 6620  mentedError: If 
+00029c70: 7468 6520 7370 6563 6966 6965 6420 7061  the specified pa
+00029c80: 7474 6572 6e69 6e67 206d 6f64 6520 6973  tterning mode is
+00029c90: 206e 6f74 2073 7570 706f 7274 6564 2e0a   not supported..
+00029ca0: 0a20 2020 2020 2020 204e 6f74 653a 0a20  .        Note:. 
+00029cb0: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+00029cc0: 6d65 7468 6f64 2073 6574 7320 7570 2074  method sets up t
+00029cd0: 6865 206d 6963 726f 7363 6f70 6520 696d  he microscope im
+00029ce0: 6167 696e 6720 616e 6420 7061 7474 6572  aging and patter
+00029cf0: 6e69 6e67 2066 6f72 206d 696c 6c69 6e67  ning for milling
+00029d00: 2075 7369 6e67 2074 6865 2069 6f6e 2062   using the ion b
+00029d10: 6561 6d2e 0a20 2020 2020 2020 2020 2020  eam..           
+00029d20: 2049 7420 7365 7473 2074 6865 2061 6374   It sets the act
+00029d30: 6976 6520 7669 6577 2061 6e64 2064 6576  ive view and dev
+00029d40: 6963 6520 746f 2074 6865 2069 6f6e 2062  ice to the ion b
+00029d50: 6561 6d2c 2074 6865 2064 6566 6175 6c74  eam, the default
+00029d60: 2062 6561 6d20 7479 7065 2074 6f20 7468   beam type to th
+00029d70: 6520 696f 6e20 6265 616d 2c0a 2020 2020  e ion beam,.    
+00029d80: 2020 2020 2020 2020 7468 6520 7370 6563          the spec
+00029d90: 6966 6965 6420 6170 706c 6963 6174 696f  ified applicatio
+00029da0: 6e20 6669 6c65 2c20 616e 6420 7468 6520  n file, and the 
+00029db0: 7370 6563 6966 6965 6420 7061 7474 6572  specified patter
+00029dc0: 6e69 6e67 206d 6f64 652e 0a20 2020 2020  ning mode..     
+00029dd0: 2020 2020 2020 2049 7420 616c 736f 2063         It also c
+00029de0: 6c65 6172 7320 616e 7920 6578 6973 7469  lears any existi
+00029df0: 6e67 2070 6174 7465 726e 7320 616e 6420  ng patterns and 
+00029e00: 7365 7473 2074 6865 2068 6f72 697a 6f6e  sets the horizon
+00029e10: 7461 6c20 6669 656c 6420 7769 6474 6820  tal field width 
+00029e20: 746f 2074 6865 2064 6573 6972 6564 2076  to the desired v
+00029e30: 616c 7565 2e0a 2020 2020 2020 2020 2020  alue..          
+00029e40: 2020 5468 6520 6d65 7468 6f64 2064 6f65    The method doe
+00029e50: 7320 6e6f 7420 7374 6172 7420 7468 6520  s not start the 
+00029e60: 6d69 6c6c 696e 6720 7072 6f63 6573 732e  milling process.
+00029e70: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00029e80: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
+00029e90: 2842 6561 6d54 7970 652e 494f 4e2c 2073  (BeamType.ION, s
+00029ea0: 656c 662e 7379 7374 656d 290a 0a20 2020  elf.system)..   
+00029eb0: 2020 2020 2073 706f 745f 7369 7a65 203d       spot_size =
+00029ec0: 206d 696c 6c5f 7365 7474 696e 6773 2e73   mill_settings.s
+00029ed0: 706f 745f 7369 7a65 2020 2320 6170 706c  pot_size  # appl
+00029ee0: 6963 6174 696f 6e5f 6669 6c65 0a20 2020  ication_file.   
+00029ef0: 2020 2020 2072 6174 6520 3d20 6d69 6c6c       rate = mill
+00029f00: 5f73 6574 7469 6e67 732e 7261 7465 2020  _settings.rate  
+00029f10: 2323 2069 6e20 6170 706c 6963 6174 696f  ## in applicatio
+00029f20: 6e20 6669 6c65 2063 616c 6c65 6420 566f  n file called Vo
+00029f30: 6c75 6d65 2070 6572 2044 6f73 6520 286d  lume per Dose (m
+00029f40: 332f 4329 0a20 2020 2020 2020 2064 7765  3/C).        dwe
+00029f50: 6c6c 5f74 696d 6520 3d20 6d69 6c6c 5f73  ll_time = mill_s
+00029f60: 6574 7469 6e67 732e 6477 656c 6c5f 7469  ettings.dwell_ti
+00029f70: 6d65 2020 2320 696e 2073 6563 6f6e 6473  me  # in seconds
+00029f80: 2023 2320 696e 2061 7070 6c69 6361 7469   ## in applicati
+00029f90: 6f6e 2066 696c 650a 0a20 2020 2020 2020  on file..       
+00029fa0: 2069 6620 6d69 6c6c 5f73 6574 7469 6e67   if mill_setting
+00029fb0: 732e 7061 7474 6572 6e69 6e67 5f6d 6f64  s.patterning_mod
+00029fc0: 6520 3d3d 2022 5365 7269 616c 223a 0a20  e == "Serial":. 
+00029fd0: 2020 2020 2020 2020 2020 2070 6172 616c             paral
+00029fe0: 6c65 6c5f 6d6f 6465 203d 2046 616c 7365  lel_mode = False
+00029ff0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002a000: 2020 2020 2020 2020 2020 2070 6172 616c             paral
+0002a010: 6c65 6c5f 6d6f 6465 203d 2054 7275 650a  lel_mode = True.
+0002a020: 0a20 2020 2020 2020 2070 7269 6e74 2866  .        print(f
+0002a030: 2273 7061 6369 6e67 3a20 7b6d 696c 6c5f  "spacing: {mill_
+0002a040: 7365 7474 696e 6773 2e73 7061 6369 6e67  settings.spacing
+0002a050: 7d22 290a 0a20 2020 2020 2020 2073 656c  }")..        sel
+0002a060: 662e 7365 7428 2270 7265 7365 7422 2c20  f.set("preset", 
+0002a070: 6d69 6c6c 5f73 6574 7469 6e67 732e 7072  mill_settings.pr
+0002a080: 6573 6574 2c20 4265 616d 5479 7065 2e49  eset, BeamType.I
+0002a090: 4f4e 290a 2020 2020 2020 2020 6265 616d  ON).        beam
+0002a0a0: 5f63 7572 7265 6e74 203d 2073 656c 662e  _current = self.
+0002a0b0: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e42  connection.FIB.B
+0002a0c0: 6561 6d2e 5265 6164 5072 6f62 6543 7572  eam.ReadProbeCur
+0002a0d0: 7265 6e74 2829 2a63 6f6e 7374 616e 7473  rent()*constants
+0002a0e0: 2e50 4943 4f5f 544f 5f53 490a 2020 2020  .PICO_TO_SI.    
+0002a0f0: 2020 2020 7072 696e 7428 6622 6265 616d      print(f"beam
+0002a100: 5f63 7572 7265 6e74 3a20 7b62 6561 6d5f  _current: {beam_
+0002a110: 6375 7272 656e 747d 2229 0a20 2020 2020  current}").     
+0002a120: 2020 206c 6179 6572 5f73 6574 7469 6e67     layer_setting
+0002a130: 7320 3d20 4945 7463 6869 6e67 280a 2020  s = IEtching(.  
+0002a140: 2020 2020 2020 2020 2020 7379 6e63 5772            syncWr
+0002a150: 6974 6546 6965 6c64 3d46 616c 7365 2c0a  iteField=False,.
+0002a160: 2020 2020 2020 2020 2020 2020 7772 6974              writ
+0002a170: 6546 6965 6c64 5369 7a65 3d6d 696c 6c5f  eFieldSize=mill_
+0002a180: 7365 7474 696e 6773 2e68 6677 2c0a 2020  settings.hfw,.  
+0002a190: 2020 2020 2020 2020 2020 6265 616d 4375            beamCu
+0002a1a0: 7272 656e 743d 6265 616d 5f63 7572 7265  rrent=beam_curre
+0002a1b0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+0002a1c0: 7370 6f74 5369 7a65 3d73 706f 745f 7369  spotSize=spot_si
+0002a1d0: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+0002a1e0: 7261 7465 3d72 6174 652c 0a20 2020 2020  rate=rate,.     
+0002a1f0: 2020 2020 2020 2064 7765 6c6c 5469 6d65         dwellTime
+0002a200: 3d64 7765 6c6c 5f74 696d 652c 0a20 2020  =dwell_time,.   
+0002a210: 2020 2020 2020 2020 2070 6172 616c 6c65           paralle
+0002a220: 6c3d 7061 7261 6c6c 656c 5f6d 6f64 652c  l=parallel_mode,
+0002a230: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0002a240: 7365 7420 3d20 6d69 6c6c 5f73 6574 7469  set = mill_setti
+0002a250: 6e67 732e 7072 6573 6574 2c0a 2020 2020  ngs.preset,.    
+0002a260: 2020 2020 2020 2020 7370 6163 696e 6720          spacing 
+0002a270: 3d20 6d69 6c6c 5f73 6574 7469 6e67 732e  = mill_settings.
+0002a280: 7370 6163 696e 672c 0a20 2020 2020 2020  spacing,.       
+0002a290: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+0002a2a0: 2e6c 6179 6572 203d 2073 656c 662e 636f  .layer = self.co
+0002a2b0: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
+0002a2c0: 6d2e 4c61 7965 7228 224c 6179 6572 3122  m.Layer("Layer1"
+0002a2d0: 2c20 6c61 7965 725f 7365 7474 696e 6773  , layer_settings
+0002a2e0: 290a 2020 2020 2020 2020 0a0a 2020 2020  ).        ..    
+0002a2f0: 6465 6620 7275 6e5f 6d69 6c6c 696e 6728  def run_milling(
+0002a300: 7365 6c66 2c20 6d69 6c6c 696e 675f 6375  self, milling_cu
+0002a310: 7272 656e 743a 2066 6c6f 6174 2c20 6d69  rrent: float, mi
+0002a320: 6c6c 696e 675f 766f 6c74 6167 653a 2066  lling_voltage: f
+0002a330: 6c6f 6174 2c20 6173 796e 6368 3a20 626f  loat, asynch: bo
+0002a340: 6f6c 203d 2046 616c 7365 293a 0a20 2020  ol = False):.   
+0002a350: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002a360: 2052 756e 7320 7468 6520 696f 6e20 6265   Runs the ion be
+0002a370: 616d 206d 696c 6c69 6e67 2070 726f 6365  am milling proce
+0002a380: 7373 2075 7369 6e67 2074 6865 2073 7065  ss using the spe
+0002a390: 6369 6669 6564 206d 696c 6c69 6e67 2063  cified milling c
+0002a3a0: 7572 7265 6e74 2e0a 0a20 2020 2020 2020  urrent...       
+0002a3b0: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+0002a3c0: 2020 206d 696c 6c69 6e67 5f63 7572 7265     milling_curre
+0002a3d0: 6e74 2028 666c 6f61 7429 3a20 5468 6520  nt (float): The 
+0002a3e0: 6d69 6c6c 696e 6720 6375 7272 656e 7420  milling current 
+0002a3f0: 746f 2075 7365 2c20 696e 2061 6d70 732e  to use, in amps.
+0002a400: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
+0002a410: 6e63 6820 2862 6f6f 6c2c 206f 7074 696f  nch (bool, optio
+0002a420: 6e61 6c29 3a20 5768 6574 6865 7220 746f  nal): Whether to
+0002a430: 2072 756e 2074 6865 206d 696c 6c69 6e67   run the milling
+0002a440: 2061 7379 6e63 6872 6f6e 6f75 736c 792e   asynchronously.
+0002a450: 2044 6566 6175 6c74 7320 746f 2046 616c   Defaults to Fal
+0002a460: 7365 2e0a 0a20 2020 2020 2020 2052 6574  se...        Ret
+0002a470: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+0002a480: 2020 4e6f 6e65 0a20 2020 2020 2020 2022    None.        "
+0002a490: 2222 0a20 2020 2020 2020 205f 6368 6563  "".        _chec
+0002a4a0: 6b5f 6265 616d 2842 6561 6d54 7970 652e  k_beam(BeamType.
+0002a4b0: 494f 4e2c 2073 656c 662e 7379 7374 656d  ION, self.system
+0002a4c0: 290a 2020 2020 2020 2020 7374 6174 7573  ).        status
+0002a4d0: 203d 2073 656c 662e 636f 6e6e 6563 7469   = self.connecti
+0002a4e0: 6f6e 2e46 4942 2e42 6561 6d2e 4765 7453  on.FIB.Beam.GetS
+0002a4f0: 7461 7475 7328 290a 2020 2020 2020 2020  tatus().        
+0002a500: 6966 2073 7461 7475 7320 213d 2041 7574  if status != Aut
+0002a510: 6f6d 6174 696f 6e2e 4649 422e 4265 616d  omation.FIB.Beam
+0002a520: 2e53 7461 7475 732e 4265 616d 4f6e 3a0a  .Status.BeamOn:.
+0002a530: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002a540: 2e63 6f6e 6e65 6374 696f 6e2e 4649 422e  .connection.FIB.
+0002a550: 4265 616d 2e4f 6e28 290a 2020 2020 2020  Beam.On().      
+0002a560: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002a570: 6e2e 4472 6177 4265 616d 2e4c 6f61 644c  n.DrawBeam.LoadL
+0002a580: 6179 6572 2873 656c 662e 6c61 7965 7229  ayer(self.layer)
+0002a590: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+0002a5a0: 2e69 6e66 6f28 6622 7275 6e6e 696e 6720  .info(f"running 
+0002a5b0: 696f 6e20 6265 616d 206d 696c 6c69 6e67  ion beam milling
+0002a5c0: 206e 6f77 2e2e 2e22 290a 2020 2020 2020   now...").      
+0002a5d0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002a5e0: 6e2e 4472 6177 4265 616d 2e53 7461 7274  n.DrawBeam.Start
+0002a5f0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0002a600: 636f 6e6e 6563 7469 6f6e 2e50 726f 6772  connection.Progr
+0002a610: 6573 732e 5368 6f77 280a 2020 2020 2020  ess.Show(.      
+0002a620: 2020 2020 2020 2244 7261 7742 6561 6d22        "DrawBeam"
+0002a630: 2c20 224c 6179 6572 2031 2069 6e20 7072  , "Layer 1 in pr
+0002a640: 6f67 7265 7373 222c 2046 616c 7365 2c20  ogress", False, 
+0002a650: 4661 6c73 652c 2030 2c20 3130 300a 2020  False, 0, 100.  
+0002a660: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002a670: 7768 696c 6520 5472 7565 3a0a 2020 2020  while True:.    
+0002a680: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+0002a690: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0002a6a0: 2e44 7261 7742 6561 6d2e 4765 7453 7461  .DrawBeam.GetSta
+0002a6b0: 7475 7328 290a 2020 2020 2020 2020 2020  tus().          
+0002a6c0: 2020 7275 6e6e 696e 6720 3d20 7374 6174    running = stat
+0002a6d0: 7573 5b30 5d20 3d3d 2044 4253 7461 7475  us[0] == DBStatu
+0002a6e0: 732e 5072 6f6a 6563 744c 6f61 6465 6445  s.ProjectLoadedE
+0002a6f0: 7870 6f73 6974 696f 6e49 6e50 726f 6772  xpositionInProgr
+0002a700: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
+0002a710: 6966 2072 756e 6e69 6e67 3a0a 2020 2020  if running:.    
+0002a720: 2020 2020 2020 2020 2020 2020 7072 6f67              prog
+0002a730: 7265 7373 203d 2030 0a20 2020 2020 2020  ress = 0.       
+0002a740: 2020 2020 2020 2020 2069 6620 7374 6174           if stat
+0002a750: 7573 5b31 5d20 3e20 303a 0a20 2020 2020  us[1] > 0:.     
+0002a760: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0002a770: 726f 6772 6573 7320 3d20 6d69 6e28 3130  rogress = min(10
+0002a780: 302c 2073 7461 7475 735b 325d 202f 2073  0, status[2] / s
+0002a790: 7461 7475 735b 315d 202a 2031 3030 290a  tatus[1] * 100).
+0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7b0: 7072 696e 7450 726f 6772 6573 7342 6172  printProgressBar
+0002a7c0: 2870 726f 6772 6573 732c 2031 3030 290a  (progress, 100).
+0002a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7e0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0002a7f0: 5072 6f67 7265 7373 2e53 6574 5065 7263  Progress.SetPerc
+0002a800: 656e 7473 2870 726f 6772 6573 7329 0a20  ents(progress). 
+0002a810: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002a820: 696d 652e 736c 6565 7028 3129 0a20 2020  ime.sleep(1).   
+0002a830: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002a840: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002a850: 6620 7374 6174 7573 5b30 5d20 3d3d 2044  f status[0] == D
+0002a860: 4253 7461 7475 732e 5072 6f6a 6563 744c  BStatus.ProjectL
+0002a870: 6f61 6465 6445 7870 6f73 6974 696f 6e49  oadedExpositionI
+0002a880: 646c 653a 0a20 2020 2020 2020 2020 2020  dle:.           
+0002a890: 2020 2020 2020 2020 2070 7269 6e74 5072           printPr
+0002a8a0: 6f67 7265 7373 4261 7228 3130 302c 2031  ogressBar(100, 1
+0002a8b0: 3030 2c20 7375 6666 6978 3d22 4669 6e69  00, suffix="Fini
+0002a8c0: 7368 6564 2229 0a20 2020 2020 2020 2020  shed").         
+0002a8d0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+0002a8e0: 2020 2020 2020 7072 696e 7428 2920 2023        print()  #
+0002a8f0: 206e 6577 206c 696e 6520 6f6e 2063 6f6d   new line on com
+0002a900: 706c 6574 650a 2020 2020 2020 2020 7365  plete.        se
+0002a910: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 5072  lf.connection.Pr
+0002a920: 6f67 7265 7373 2e48 6964 6528 290a 0a20  ogress.Hide().. 
+0002a930: 2020 2064 6566 2072 756e 5f6d 696c 6c69     def run_milli
+0002a940: 6e67 5f64 7269 6674 5f63 6f72 7265 6374  ng_drift_correct
+0002a950: 6564 2873 656c 662c 206d 696c 6c69 6e67  ed(self, milling
+0002a960: 5f63 7572 7265 6e74 3a20 666c 6f61 742c  _current: float,
+0002a970: 2020 0a20 2020 2020 2020 2069 6d61 6765    .        image
+0002a980: 5f73 6574 7469 6e67 733a 2049 6d61 6765  _settings: Image
+0002a990: 5365 7474 696e 6773 2c20 0a20 2020 2020  Settings, .     
+0002a9a0: 2020 2072 6566 5f69 6d61 6765 3a20 4669     ref_image: Fi
+0002a9b0: 6273 656d 496d 6167 652c 200a 2020 2020  bsemImage, .    
+0002a9c0: 2020 2020 7265 6475 6365 645f 6172 6561      reduced_area
+0002a9d0: 3a20 4669 6273 656d 5265 6374 616e 676c  : FibsemRectangl
+0002a9e0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+0002a9f0: 2020 6173 796e 6368 3a20 626f 6f6c 203d    asynch: bool =
+0002aa00: 2046 616c 7365 0a20 2020 2020 2020 2029   False.        )
+0002aa10: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0002aa20: 2020 2020 2020 5275 6e20 696f 6e20 6265        Run ion be
+0002aa30: 616d 206d 696c 6c69 6e67 2075 7369 6e67  am milling using
+0002aa40: 2074 6865 2073 7065 6369 6669 6564 206d   the specified m
+0002aa50: 696c 6c69 6e67 2063 7572 7265 6e74 2e0a  illing current..
+0002aa60: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+0002aa70: 2020 2020 2020 2020 2020 206d 696c 6c69             milli
+0002aa80: 6e67 5f63 7572 7265 6e74 2028 666c 6f61  ng_current (floa
+0002aa90: 7429 3a20 5468 6520 6375 7272 656e 7420  t): The current 
+0002aaa0: 746f 2075 7365 2066 6f72 206d 696c 6c69  to use for milli
+0002aab0: 6e67 2069 6e20 616d 7073 2e0a 2020 2020  ng in amps..    
+0002aac0: 2020 2020 2020 2020 6173 796e 6368 2028          asynch (
+0002aad0: 626f 6f6c 2c20 6f70 7469 6f6e 616c 293a  bool, optional):
+0002aae0: 2049 6620 5472 7565 2c20 7468 6520 6d69   If True, the mi
+0002aaf0: 6c6c 696e 6720 7769 6c6c 2062 6520 7275  lling will be ru
+0002ab00: 6e20 6173 796e 6368 726f 6e6f 7573 6c79  n asynchronously
+0002ab10: 2e20 0a20 2020 2020 2020 2020 2020 2020  . .             
+0002ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab30: 2020 2020 2020 2020 4465 6661 756c 7473          Defaults
+0002ab40: 2074 6f20 4661 6c73 652c 2069 6e20 7768   to False, in wh
+0002ab50: 6963 6820 6361 7365 2069 7420 7769 6c6c  ich case it will
+0002ab60: 2072 756e 2073 796e 6368 726f 6e6f 7573   run synchronous
+0002ab70: 6c79 2e0a 0a20 2020 2020 2020 2052 6574  ly...        Ret
+0002ab80: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+0002ab90: 2020 4e6f 6e65 0a0a 2020 2020 2020 2020    None..        
+0002aba0: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+0002abb0: 2020 2020 4e6f 6e65 0a20 2020 2020 2020      None.       
+0002abc0: 2022 2222 0a20 2020 2020 2020 205f 6368   """.        _ch
+0002abd0: 6563 6b5f 6265 616d 2842 6561 6d54 7970  eck_beam(BeamTyp
+0002abe0: 652e 494f 4e2c 2073 656c 662e 7379 7374  e.ION, self.syst
+0002abf0: 656d 290a 2020 2020 2020 2020 7374 6174  em).        stat
+0002ac00: 7573 203d 2073 656c 662e 636f 6e6e 6563  us = self.connec
+0002ac10: 7469 6f6e 2e46 4942 2e42 6561 6d2e 4765  tion.FIB.Beam.Ge
+0002ac20: 7453 7461 7475 7328 290a 2020 2020 2020  tStatus().      
+0002ac30: 2020 6966 2073 7461 7475 7320 213d 2041    if status != A
+0002ac40: 7574 6f6d 6174 696f 6e2e 4649 422e 4265  utomation.FIB.Be
+0002ac50: 616d 2e53 7461 7475 732e 4265 616d 4f6e  am.Status.BeamOn
+0002ac60: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002ac70: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0002ac80: 422e 4265 616d 2e4f 6e28 290a 2020 2020  B.Beam.On().    
+0002ac90: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0002aca0: 696f 6e2e 4472 6177 4265 616d 2e4c 6f61  ion.DrawBeam.Loa
+0002acb0: 644c 6179 6572 2873 656c 662e 6c61 7965  dLayer(self.laye
+0002acc0: 7229 0a20 2020 2020 2020 206c 6f67 6769  r).        loggi
+0002acd0: 6e67 2e69 6e66 6f28 6622 7275 6e6e 696e  ng.info(f"runnin
+0002ace0: 6720 696f 6e20 6265 616d 206d 696c 6c69  g ion beam milli
+0002acf0: 6e67 206e 6f77 2e2e 2e22 290a 2020 2020  ng now...").    
+0002ad00: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0002ad10: 696f 6e2e 4472 6177 4265 616d 2e53 7461  ion.DrawBeam.Sta
+0002ad20: 7274 2829 0a20 2020 2020 2020 2073 656c  rt().        sel
+0002ad30: 662e 636f 6e6e 6563 7469 6f6e 2e50 726f  f.connection.Pro
+0002ad40: 6772 6573 732e 5368 6f77 280a 2020 2020  gress.Show(.    
+0002ad50: 2020 2020 2020 2020 2244 7261 7742 6561          "DrawBea
+0002ad60: 6d22 2c20 224c 6179 6572 2031 2069 6e20  m", "Layer 1 in 
+0002ad70: 7072 6f67 7265 7373 222c 2046 616c 7365  progress", False
+0002ad80: 2c20 4661 6c73 652c 2030 2c20 3130 300a  , False, 0, 100.
+0002ad90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002ada0: 2020 6672 6f6d 2066 6962 7365 6d20 696d    from fibsem im
+0002adb0: 706f 7274 2061 6c69 676e 6d65 6e74 0a20  port alignment. 
+0002adc0: 2020 2020 2020 2077 6869 6c65 2054 7275         while Tru
+0002add0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0002ade0: 7461 7475 7320 3d20 7365 6c66 2e63 6f6e  tatus = self.con
+0002adf0: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
+0002ae00: 2e47 6574 5374 6174 7573 2829 0a20 2020  .GetStatus().   
+0002ae10: 2020 2020 2020 2020 2072 756e 6e69 6e67           running
+0002ae20: 203d 2073 7461 7475 735b 305d 203d 3d20   = status[0] == 
+0002ae30: 4442 5374 6174 7573 2e50 726f 6a65 6374  DBStatus.Project
+0002ae40: 4c6f 6164 6564 4578 706f 7369 7469 6f6e  LoadedExposition
+0002ae50: 496e 5072 6f67 7265 7373 0a20 2020 2020  InProgress.     
+0002ae60: 2020 2020 2020 2069 6620 7275 6e6e 696e         if runnin
+0002ae70: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0002ae80: 2020 2070 726f 6772 6573 7320 3d20 300a     progress = 0.
+0002ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aea0: 6966 2073 7461 7475 735b 315d 203e 2030  if status[1] > 0
+0002aeb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002aec0: 2020 2020 2020 7072 6f67 7265 7373 203d        progress =
+0002aed0: 206d 696e 2831 3030 2c20 7374 6174 7573   min(100, status
+0002aee0: 5b32 5d20 2f20 7374 6174 7573 5b31 5d20  [2] / status[1] 
+0002aef0: 2a20 3130 3029 0a20 2020 2020 2020 2020  * 100).         
+0002af00: 2020 2020 2020 2070 7269 6e74 5072 6f67         printProg
+0002af10: 7265 7373 4261 7228 7072 6f67 7265 7373  ressBar(progress
+0002af20: 2c20 3130 3029 0a20 2020 2020 2020 2020  , 100).         
+0002af30: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0002af40: 6563 7469 6f6e 2e50 726f 6772 6573 732e  ection.Progress.
+0002af50: 5365 7450 6572 6365 6e74 7328 7072 6f67  SetPercents(prog
+0002af60: 7265 7373 290a 2020 2020 2020 2020 2020  ress).          
+0002af70: 2020 2020 2020 7374 6174 7573 203d 2073        status = s
+0002af80: 656c 662e 636f 6e6e 6563 7469 6f6e 2e44  elf.connection.D
+0002af90: 7261 7742 6561 6d2e 4765 7453 7461 7475  rawBeam.GetStatu
+0002afa0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+0002afb0: 2020 2020 6966 2073 7461 7475 735b 305d      if status[0]
+0002afc0: 203d 3d20 4442 5374 6174 7573 2e50 726f   == DBStatus.Pro
+0002afd0: 6a65 6374 4c6f 6164 6564 4578 706f 7369  jectLoadedExposi
+0002afe0: 7469 6f6e 496e 5072 6f67 7265 7373 3a0a  tionInProgress:.
+0002aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b000: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+0002b010: 696f 6e2e 4472 6177 4265 616d 2e50 6175  ion.DrawBeam.Pau
+0002b020: 7365 2829 0a20 2020 2020 2020 2020 2020  se().           
+0002b030: 2020 2020 2065 6c69 6620 7374 6174 7573       elif status
+0002b040: 5b30 5d20 3d3d 2044 4253 7461 7475 732e  [0] == DBStatus.
+0002b050: 5072 6f6a 6563 744c 6f61 6465 6445 7870  ProjectLoadedExp
+0002b060: 6f73 6974 696f 6e49 646c 653a 0a20 2020  ositionIdle:.   
+0002b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b080: 2070 7269 6e74 5072 6f67 7265 7373 4261   printProgressBa
+0002b090: 7228 3130 302c 2031 3030 2c20 7375 6666  r(100, 100, suff
+0002b0a0: 6978 3d22 4669 6e69 7368 6564 2229 0a20  ix="Finished"). 
+0002b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b0c0: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0002b0d0: 6f6e 2e44 7261 7742 6561 6d2e 5374 6f70  on.DrawBeam.Stop
+0002b0e0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0002b0f0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0002b100: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+0002b110: 556e 6c6f 6164 4c61 7965 7228 290a 2020  UnloadLayer().  
+0002b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b130: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+0002b140: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0002b150: 696e 666f 2822 4472 6966 7420 636f 7272  info("Drift corr
+0002b160: 6563 7469 6f6e 2069 6e20 7072 6f67 7265  ection in progre
+0002b170: 7373 2e2e 2e22 290a 2020 2020 2020 2020  ss...").        
+0002b180: 2020 2020 2020 2020 696d 6167 655f 7365          image_se
+0002b190: 7474 696e 6773 2e62 6561 6d5f 7479 7065  ttings.beam_type
+0002b1a0: 203d 2042 6561 6d54 7970 652e 494f 4e0a   = BeamType.ION.
+0002b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1c0: 616c 6967 6e6d 656e 742e 6265 616d 5f73  alignment.beam_s
+0002b1d0: 6869 6674 5f61 6c69 676e 6d65 6e74 280a  hift_alignment(.
+0002b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1f0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0002b200: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0002b210: 6167 655f 7365 7474 696e 6773 2c0a 2020  age_settings,.  
+0002b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b230: 2020 7265 665f 696d 6167 652c 0a20 2020    ref_image,.   
+0002b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b250: 2072 6564 7563 6564 5f61 7265 612c 0a20   reduced_area,. 
+0002b260: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0002b270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b280: 2074 696d 652e 736c 6565 7028 3129 0a20   time.sleep(1). 
+0002b290: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002b2a0: 7461 7475 7320 3d20 7365 6c66 2e63 6f6e  tatus = self.con
+0002b2b0: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
+0002b2c0: 2e47 6574 5374 6174 7573 2829 0a20 2020  .GetStatus().   
+0002b2d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002b2e0: 7374 6174 7573 5b30 5d20 3d3d 2044 4253  status[0] == DBS
+0002b2f0: 7461 7475 732e 5072 6f6a 6563 744c 6f61  tatus.ProjectLoa
+0002b300: 6465 6445 7870 6f73 6974 696f 6e50 6175  dedExpositionPau
+0002b310: 7365 6420 3a0a 2020 2020 2020 2020 2020  sed :.          
+0002b320: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0002b330: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
+0002b340: 616d 2e52 6573 756d 6528 290a 2020 2020  am.Resume().    
+0002b350: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002b360: 696e 672e 696e 666f 2822 4472 6966 7420  ing.info("Drift 
+0002b370: 636f 7272 6563 7469 6f6e 2063 6f6d 706c  correction compl
+0002b380: 6574 652e 2229 0a20 2020 2020 2020 2020  ete.").         
+0002b390: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
+0002b3a0: 7028 3529 0a20 2020 2020 2020 2020 2020  p(5).           
+0002b3b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002b3c0: 2020 2020 2020 2069 6620 7374 6174 7573         if status
+0002b3d0: 5b30 5d20 3d3d 2044 4253 7461 7475 732e  [0] == DBStatus.
+0002b3e0: 5072 6f6a 6563 744c 6f61 6465 6445 7870  ProjectLoadedExp
+0002b3f0: 6f73 6974 696f 6e49 646c 653a 0a20 2020  ositionIdle:.   
+0002b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b410: 2070 7269 6e74 5072 6f67 7265 7373 4261   printProgressBa
+0002b420: 7228 3130 302c 2031 3030 2c20 7375 6666  r(100, 100, suff
+0002b430: 6978 3d22 4669 6e69 7368 6564 2229 0a20  ix="Finished"). 
+0002b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b450: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0002b460: 6f6e 2e44 7261 7742 6561 6d2e 5374 6f70  on.DrawBeam.Stop
+0002b470: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0002b480: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0002b490: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+0002b4a0: 556e 6c6f 6164 4c61 7965 7228 290a 2020  UnloadLayer().  
+0002b4b0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+0002b4c0: 6561 6b0a 0a20 2020 2020 2020 2070 7269  eak..        pri
+0002b4d0: 6e74 2829 2020 2320 6e65 7720 6c69 6e65  nt()  # new line
+0002b4e0: 206f 6e20 636f 6d70 6c65 7465 0a20 2020   on complete.   
+0002b4f0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0002b500: 7469 6f6e 2e50 726f 6772 6573 732e 4869  tion.Progress.Hi
+0002b510: 6465 2829 0a0a 2020 2020 6465 6620 6669  de()..    def fi
+0002b520: 6e69 7368 5f6d 696c 6c69 6e67 2873 656c  nish_milling(sel
+0002b530: 662c 2069 6d61 6769 6e67 5f63 7572 7265  f, imaging_curre
+0002b540: 6e74 3a20 666c 6f61 7429 3a0a 2020 2020  nt: float):.    
+0002b550: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0002b560: 4669 6e61 6c69 7365 7320 7468 6520 6d69  Finalises the mi
+0002b570: 6c6c 696e 6720 7072 6f63 6573 7320 6279  lling process by
+0002b580: 2063 6c65 6172 696e 6720 7468 6520 6d69   clearing the mi
+0002b590: 6372 6f73 636f 7065 206f 6620 616e 7920  croscope of any 
+0002b5a0: 7061 7474 6572 6e73 2061 6e64 2072 6574  patterns and ret
+0002b5b0: 7572 6e69 6e67 2074 6865 2063 7572 7265  urning the curre
+0002b5c0: 6e74 2074 6f20 7468 6520 696d 6167 696e  nt to the imagin
+0002b5d0: 6720 6375 7272 656e 742e 0a0a 2020 2020  g current...    
+0002b5e0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0002b5f0: 2020 2020 2020 696d 6167 696e 675f 6375        imaging_cu
+0002b600: 7272 656e 7420 2866 6c6f 6174 293a 2054  rrent (float): T
+0002b610: 6865 2063 7572 7265 6e74 2074 6f20 7573  he current to us
+0002b620: 6520 666f 7220 696d 6167 696e 6720 696e  e for imaging in
+0002b630: 2061 6d70 732e 0a20 2020 2020 2020 2023   amps..        #
+0002b640: 2022 2222 0a20 2020 2020 2020 2074 7279   """.        try
+0002b650: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002b660: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0002b670: 422e 5072 6573 6574 2e41 6374 6976 6174  B.Preset.Activat
+0002b680: 6528 2233 3020 6b65 563b 2031 3530 2070  e("30 keV; 150 p
+0002b690: 4122 290a 2020 2020 2020 2020 2020 2020  A").            
+0002b6a0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0002b6b0: 4472 6177 4265 616d 2e55 6e6c 6f61 644c  DrawBeam.UnloadL
+0002b6c0: 6179 6572 2829 0a20 2020 2020 2020 2020  ayer().         
+0002b6d0: 2020 2070 7269 6e74 2822 6865 6c6c 6f22     print("hello"
+0002b6e0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+0002b6f0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+0002b700: 7373 0a20 2020 200a 2020 2020 6465 6620  ss.    .    def 
+0002b710: 6573 7469 6d61 7465 5f6d 696c 6c69 6e67  estimate_milling
+0002b720: 5f74 696d 6528 7365 6c66 2c70 6174 7465  _time(self,patte
+0002b730: 726e 7329 3a0a 2020 2020 2020 2020 0a20  rns):.        . 
+0002b740: 2020 2020 2020 2023 206c 6f61 6420 616e         # load an
+0002b750: 6420 756e 6c6f 6164 206c 6179 6572 2074  d unload layer t
+0002b760: 6f20 6368 6563 6b20 7469 6d65 0a20 2020  o check time.   
+0002b770: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0002b780: 7469 6f6e 2e44 7261 7742 6561 6d2e 4c6f  tion.DrawBeam.Lo
+0002b790: 6164 4c61 7965 7228 7365 6c66 2e6c 6179  adLayer(self.lay
+0002b7a0: 6572 290a 2020 2020 2020 2020 6573 745f  er).        est_
+0002b7b0: 7469 6d65 203d 2073 656c 662e 636f 6e6e  time = self.conn
+0002b7c0: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+0002b7d0: 4573 7469 6d61 7465 5469 6d65 2829 200a  EstimateTime() .
+0002b7e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0002b7f0: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
+0002b800: 2e55 6e6c 6f61 644c 6179 6572 2829 0a0a  .UnloadLayer()..
+0002b810: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+0002b820: 7374 5f74 696d 650a 0a20 2020 2064 6566  st_time..    def
+0002b830: 2064 7261 775f 7265 6374 616e 676c 6528   draw_rectangle(
+0002b840: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0002b850: 2020 2020 2020 2070 6174 7465 726e 5f73         pattern_s
+0002b860: 6574 7469 6e67 733a 2046 6962 7365 6d52  ettings: FibsemR
+0002b870: 6563 7461 6e67 6c65 5365 7474 696e 6773  ectangleSettings
+0002b880: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+0002b890: 2022 2222 0a20 2020 2020 2020 2044 7261   """.        Dra
+0002b8a0: 7773 2061 2072 6563 7461 6e67 6c65 2070  ws a rectangle p
+0002b8b0: 6174 7465 726e 2075 7369 6e67 2074 6865  attern using the
+0002b8c0: 2063 7572 7265 6e74 2069 6f6e 2062 6561   current ion bea
+0002b8d0: 6d2e 0a0a 2020 2020 2020 2020 4172 6773  m...        Args
+0002b8e0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+0002b8f0: 7474 6572 6e5f 7365 7474 696e 6773 2028  ttern_settings (
+0002b900: 4669 6273 656d 5265 6374 616e 676c 6553  FibsemRectangleS
+0002b910: 6574 7469 6e67 7329 3a20 7468 6520 7365  ettings): the se
+0002b920: 7474 696e 6773 2066 6f72 2074 6865 2070  ttings for the p
+0002b930: 6174 7465 726e 2074 6f20 6472 6177 2e0a  attern to draw..
+0002b940: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0002b950: 3a0a 2020 2020 2020 2020 2020 2020 5061  :.            Pa
+0002b960: 7474 6572 6e3a 2074 6865 2063 7265 6174  ttern: the creat
+0002b970: 6564 2070 6174 7465 726e 2e0a 0a20 2020  ed pattern...   
+0002b980: 2020 2020 2052 6169 7365 733a 0a20 2020       Raises:.   
+0002b990: 2020 2020 2020 2020 2041 7574 6f6d 6174           Automat
+0002b9a0: 696f 6e45 7272 6f72 3a20 6966 2061 6e20  ionError: if an 
+0002b9b0: 6572 726f 7220 6f63 6375 7273 2077 6869  error occurs whi
+0002b9c0: 6c65 2063 7265 6174 696e 6720 7468 6520  le creating the 
+0002b9d0: 7061 7474 6572 6e2e 0a0a 2020 2020 2020  pattern...      
+0002b9e0: 2020 4e6f 7465 733a 0a20 2020 2020 2020    Notes:.       
+0002b9f0: 2020 2020 2054 6865 2072 6563 7461 6e67       The rectang
+0002ba00: 6c65 2070 6174 7465 726e 2077 696c 6c20  le pattern will 
+0002ba10: 6265 2063 656e 7465 7265 6420 6174 2074  be centered at t
+0002ba20: 6865 2073 7065 6369 6669 6564 2063 6f6f  he specified coo
+0002ba30: 7264 696e 6174 6573 2028 6365 6e74 7265  rdinates (centre
+0002ba40: 5f78 2c20 6365 6e74 7265 5f79 2920 7769  _x, centre_y) wi
+0002ba50: 7468 2074 6865 2073 7065 6369 6669 6564  th the specified
+0002ba60: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+0002ba70: 7468 2c20 6865 6967 6874 2061 6e64 2064  th, height and d
+0002ba80: 6570 7468 2028 696e 206e 6d29 2e20 4966  epth (in nm). If
+0002ba90: 2074 6865 2063 6c65 616e 696e 675f 6372   the cleaning_cr
+0002baa0: 6f73 735f 7365 6374 696f 6e20 6174 7472  oss_section attr
+0002bab0: 6962 7574 6520 6f66 2070 6174 7465 726e  ibute of pattern
+0002bac0: 5f73 6574 7469 6e67 7320 6973 2054 7275  _settings is Tru
+0002bad0: 652c 2061 0a20 2020 2020 2020 2020 2020  e, a.           
+0002bae0: 2063 6c65 616e 696e 6720 6372 6f73 7320   cleaning cross 
+0002baf0: 7365 6374 696f 6e20 7061 7474 6572 6e20  section pattern 
+0002bb00: 7769 6c6c 2062 6520 6372 6561 7465 6420  will be created 
+0002bb10: 696e 7374 6561 6420 6f66 2061 2072 6563  instead of a rec
+0002bb20: 7461 6e67 6c65 2070 6174 7465 726e 2e0a  tangle pattern..
+0002bb30: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+0002bb40: 2070 6174 7465 726e 2077 696c 6c20 6265   pattern will be
+0002bb50: 2072 6f74 6174 6564 2062 7920 7468 6520   rotated by the 
+0002bb60: 616e 676c 6520 7370 6563 6966 6965 6420  angle specified 
+0002bb70: 696e 2074 6865 2072 6f74 6174 696f 6e20  in the rotation 
+0002bb80: 6174 7472 6962 7574 6520 6f66 2070 6174  attribute of pat
+0002bb90: 7465 726e 5f73 6574 7469 6e67 7320 2869  tern_settings (i
+0002bba0: 6e20 6465 6772 6565 7329 0a20 2020 2020  n degrees).     
+0002bbb0: 2020 2020 2020 2061 6e64 2073 6361 6e6e         and scann
+0002bbc0: 6564 2069 6e20 7468 6520 6469 7265 6374  ed in the direct
+0002bbd0: 696f 6e20 7370 6563 6966 6965 6420 696e  ion specified in
+0002bbe0: 2074 6865 2073 6361 6e5f 6469 7265 6374   the scan_direct
+0002bbf0: 696f 6e20 6174 7472 6962 7574 6520 6f66  ion attribute of
+0002bc00: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
+0002bc10: 7320 2827 686f 7269 7a6f 6e74 616c 2720  s ('horizontal' 
+0002bc20: 6f72 0a20 2020 2020 2020 2020 2020 2027  or.            '
+0002bc30: 7665 7274 6963 616c 2729 2e0a 0a20 2020  vertical')...   
+0002bc40: 2020 2020 2020 2020 2054 6865 2063 7265           The cre
+0002bc50: 6174 6564 2070 6174 7465 726e 2063 616e  ated pattern can
+0002bc60: 2062 6520 6164 6465 6420 746f 2074 6865   be added to the
+0002bc70: 2070 6174 7465 726e 696e 6720 7175 6575   patterning queu
+0002bc80: 6520 616e 6420 6578 6563 7574 6564 2075  e and executed u
+0002bc90: 7369 6e67 2074 6865 206c 6179 6572 206d  sing the layer m
+0002bca0: 6574 686f 6473 2069 6e20 4175 746f 6d61  ethods in Automa
+0002bcb0: 7469 6f6e 2e0a 2020 2020 2020 2020 2222  tion..        ""
+0002bcc0: 220a 2020 2020 2020 2020 6365 6e74 7265  ".        centre
+0002bcd0: 5f78 203d 2070 6174 7465 726e 5f73 6574  _x = pattern_set
+0002bce0: 7469 6e67 732e 6365 6e74 7265 5f78 0a20  tings.centre_x. 
+0002bcf0: 2020 2020 2020 2063 656e 7472 655f 7920         centre_y 
+0002bd00: 3d20 7061 7474 6572 6e5f 7365 7474 696e  = pattern_settin
+0002bd10: 6773 2e63 656e 7472 655f 790a 2020 2020  gs.centre_y.    
+0002bd20: 2020 2020 6465 7074 6820 3d20 7061 7474      depth = patt
+0002bd30: 6572 6e5f 7365 7474 696e 6773 2e64 6570  ern_settings.dep
+0002bd40: 7468 0a20 2020 2020 2020 2077 6964 7468  th.        width
+0002bd50: 203d 2070 6174 7465 726e 5f73 6574 7469   = pattern_setti
+0002bd60: 6e67 732e 7769 6474 680a 2020 2020 2020  ngs.width.      
+0002bd70: 2020 6865 6967 6874 203d 2070 6174 7465    height = patte
+0002bd80: 726e 5f73 6574 7469 6e67 732e 6865 6967  rn_settings.heig
+0002bd90: 6874 0a20 2020 2020 2020 2072 6f74 6174  ht.        rotat
+0002bda0: 696f 6e20 3d20 7061 7474 6572 6e5f 7365  ion = pattern_se
+0002bdb0: 7474 696e 6773 2e72 6f74 6174 696f 6e20  ttings.rotation 
+0002bdc0: 2a20 636f 6e73 7461 6e74 732e 5241 4449  * constants.RADI
+0002bdd0: 414e 535f 544f 5f44 4547 5245 4553 2023  ANS_TO_DEGREES #
+0002bde0: 2043 4845 434b 2055 4e49 5453 2028 5445   CHECK UNITS (TE
+0002bdf0: 5343 414e 2054 616b 6573 2044 6567 7265  SCAN Takes Degre
+0002be00: 6573 290a 2020 2020 2020 2020 7061 7468  es).        path
+0002be10: 7320 3d20 7365 6c66 2e67 6574 5f61 7661  s = self.get_ava
+0002be20: 696c 6162 6c65 5f76 616c 7565 7328 6b65  ilable_values(ke
+0002be30: 793d 2273 6361 6e5f 6469 7265 6374 696f  y="scan_directio
+0002be40: 6e22 290a 2020 2020 2020 2020 7061 7373  n").        pass
+0002be50: 6573 203d 2070 6174 7465 726e 5f73 6574  es = pattern_set
+0002be60: 7469 6e67 732e 7061 7373 6573 2069 6620  tings.passes if 
+0002be70: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+0002be80: 2e70 6173 7365 7320 6973 206e 6f74 204e  .passes is not N
+0002be90: 6f6e 6520 656c 7365 2031 2e30 0a20 2020  one else 1.0.   
+0002bea0: 2020 2020 2069 6620 7061 7474 6572 6e5f       if pattern_
+0002beb0: 7365 7474 696e 6773 2e73 6361 6e5f 6469  settings.scan_di
+0002bec0: 7265 6374 696f 6e20 696e 2070 6174 6873  rection in paths
+0002bed0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+0002bee0: 7468 203d 2070 6174 7465 726e 5f73 6574  th = pattern_set
+0002bef0: 7469 6e67 732e 7363 616e 5f64 6972 6563  tings.scan_direc
+0002bf00: 7469 6f6e 0a20 2020 2020 2020 2065 6c73  tion.        els
+0002bf10: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0002bf20: 6174 6820 3d20 2246 6c79 6261 636b 220a  ath = "Flyback".
+0002bf30: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002bf40: 696e 672e 696e 666f 2866 2253 6361 6e20  ing.info(f"Scan 
+0002bf50: 6469 7265 6374 696f 6e20 7b70 6174 7465  direction {patte
+0002bf60: 726e 5f73 6574 7469 6e67 732e 7363 616e  rn_settings.scan
+0002bf70: 5f64 6972 6563 7469 6f6e 7d20 6e6f 7420  _direction} not 
+0002bf80: 7375 7070 6f72 7465 642e 2055 7369 6e67  supported. Using
+0002bf90: 2046 6c79 6261 636b 2069 6e73 7465 6164   Flyback instead
+0002bfa0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0002bfb0: 6c6f 6767 696e 672e 696e 666f 2866 2253  logging.info(f"S
+0002bfc0: 7570 706f 7274 6564 2073 6361 6e20 6469  upported scan di
+0002bfd0: 7265 6374 696f 6e73 2061 7265 3a20 466c  rections are: Fl
+0002bfe0: 7962 6163 6b2c 2052 4c45 2c20 5370 6972  yback, RLE, Spir
+0002bff0: 616c 496e 7369 6465 4f75 742c 2053 7069  alInsideOut, Spi
+0002c000: 7261 6c4f 7574 7369 6465 496e 2c20 5a69  ralOutsideIn, Zi
+0002c010: 675a 6167 2229 0a20 2020 2020 2020 2073  gZag").        s
+0002c020: 656c 662e 636f 6e6e 6563 7469 6f6e 2e44  elf.connection.D
+0002c030: 7261 7742 6561 6d2e 5363 616e 6e69 6e67  rawBeam.Scanning
+0002c040: 5061 7468 203d 2070 6174 7465 726e 5f73  Path = pattern_s
+0002c050: 6574 7469 6e67 732e 7363 616e 5f64 6972  ettings.scan_dir
+0002c060: 6563 7469 6f6e 0a0a 2020 2020 2020 2020  ection..        
+0002c070: 2320 544f 444f 3a20 7265 706c 6163 6520  # TODO: replace 
+0002c080: 7769 7468 2063 726f 7373 5f73 6563 7469  with cross_secti
+0002c090: 6f6e 2070 6172 616d 6574 6572 0a20 2020  on parameter.   
+0002c0a0: 2020 2020 2069 6620 7061 7474 6572 6e5f       if pattern_
+0002c0b0: 7365 7474 696e 6773 2e63 6c65 616e 696e  settings.cleanin
+0002c0c0: 675f 6372 6f73 735f 7365 6374 696f 6e3a  g_cross_section:
+0002c0d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002c0e0: 662e 6c61 7965 722e 6164 6452 6563 7461  f.layer.addRecta
+0002c0f0: 6e67 6c65 506f 6c69 7368 280a 2020 2020  nglePolish(.    
+0002c100: 2020 2020 2020 2020 2020 2020 4365 6e74              Cent
+0002c110: 6572 583d 6365 6e74 7265 5f78 2c0a 2020  erX=centre_x,.  
+0002c120: 2020 2020 2020 2020 2020 2020 2020 4365                Ce
+0002c130: 6e74 6572 593d 6365 6e74 7265 5f79 2c0a  nterY=centre_y,.
+0002c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c150: 4465 7074 683d 6465 7074 682c 0a20 2020  Depth=depth,.   
+0002c160: 2020 2020 2020 2020 2020 2020 2044 6570               Dep
+0002c170: 7468 556e 6974 3d27 6d27 2c0a 2020 2020  thUnit='m',.    
+0002c180: 2020 2020 2020 2020 2020 2020 5769 6474              Widt
+0002c190: 683d 7769 6474 682c 0a20 2020 2020 2020  h=width,.       
+0002c1a0: 2020 2020 2020 2020 2048 6569 6768 743d           Height=
+0002c1b0: 6865 6967 6874 2c0a 2020 2020 2020 2020  height,.        
+0002c1c0: 2020 2020 2020 2020 416e 676c 653d 726f          Angle=ro
+0002c1d0: 7461 7469 6f6e 2c0a 2020 2020 2020 2020  tation,.        
+0002c1e0: 2020 2020 2020 2020 5363 616e 6e69 6e67          Scanning
+0002c1f0: 5061 7468 3d70 6174 682c 0a20 2020 2020  Path=path,.     
+0002c200: 2020 2020 2020 2020 2020 2045 7870 6f73             Expos
+0002c210: 6974 696f 6e46 6163 746f 723d 7061 7373  itionFactor=pass
+0002c220: 6573 0a20 2020 2020 2020 2020 2020 2029  es.            )
+0002c230: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0002c240: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002c250: 6c61 7965 722e 6164 6452 6563 7461 6e67  layer.addRectang
+0002c260: 6c65 4669 6c6c 6564 280a 2020 2020 2020  leFilled(.      
+0002c270: 2020 2020 2020 2020 2020 4365 6e74 6572            Center
+0002c280: 583d 6365 6e74 7265 5f78 2c0a 2020 2020  X=centre_x,.    
+0002c290: 2020 2020 2020 2020 2020 2020 4365 6e74              Cent
+0002c2a0: 6572 593d 6365 6e74 7265 5f79 2c0a 2020  erY=centre_y,.  
+0002c2b0: 2020 2020 2020 2020 2020 2020 2020 4465                De
+0002c2c0: 7074 683d 6465 7074 682c 0a20 2020 2020  pth=depth,.     
+0002c2d0: 2020 2020 2020 2020 2020 2044 6570 7468             Depth
+0002c2e0: 556e 6974 3d27 6d27 2c0a 2020 2020 2020  Unit='m',.      
+0002c2f0: 2020 2020 2020 2020 2020 5769 6474 683d            Width=
+0002c300: 7769 6474 682c 0a20 2020 2020 2020 2020  width,.         
+0002c310: 2020 2020 2020 2048 6569 6768 743d 6865         Height=he
+0002c320: 6967 6874 2c0a 2020 2020 2020 2020 2020  ight,.          
+0002c330: 2020 2020 2020 416e 676c 653d 726f 7461        Angle=rota
+0002c340: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+0002c350: 2020 2020 2020 5363 616e 6e69 6e67 5061        ScanningPa
+0002c360: 7468 3d70 6174 682c 0a20 2020 2020 2020  th=path,.       
+0002c370: 2020 2020 2020 2020 2045 7870 6f73 6974           Exposit
+0002c380: 696f 6e46 6163 746f 723d 7061 7373 6573  ionFactor=passes
+0002c390: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0002c3a0: 2020 2020 2020 2020 7061 7474 6572 6e20          pattern 
+0002c3b0: 3d20 7365 6c66 2e6c 6179 6572 0a20 2020  = self.layer.   
+0002c3c0: 2020 2020 200a 2020 2020 2020 2020 7265       .        re
+0002c3d0: 7475 726e 2070 6174 7465 726e 0a0a 2020  turn pattern..  
+0002c3e0: 2020 6465 6620 6472 6177 5f6c 696e 6528    def draw_line(
+0002c3f0: 7365 6c66 2c20 7061 7474 6572 6e5f 7365  self, pattern_se
+0002c400: 7474 696e 6773 3a20 4669 6273 656d 4c69  ttings: FibsemLi
+0002c410: 6e65 5365 7474 696e 6773 293a 0a20 2020  neSettings):.   
+0002c420: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002c430: 2044 7261 7773 2061 206c 696e 6520 7061   Draws a line pa
+0002c440: 7474 6572 6e20 6f6e 2074 6865 2063 7572  ttern on the cur
+0002c450: 7265 6e74 2069 6d61 6769 6e67 2076 6965  rent imaging vie
+0002c460: 7720 6f66 2074 6865 206d 6963 726f 7363  w of the microsc
+0002c470: 6f70 652e 0a0a 2020 2020 2020 2020 4172  ope...        Ar
+0002c480: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+0002c490: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+0002c4a0: 2028 4669 6273 656d 4c69 6e65 5365 7474   (FibsemLineSett
+0002c4b0: 696e 6773 293a 2041 2064 6174 6120 636c  ings): A data cl
+0002c4c0: 6173 7320 6f62 6a65 6374 2073 7065 6369  ass object speci
+0002c4d0: 6679 696e 6720 7468 6520 7061 7474 6572  fying the patter
+0002c4e0: 6e20 7061 7261 6d65 7465 7273 2c0a 2020  n parameters,.  
+0002c4f0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0002c500: 636c 7564 696e 6720 7468 6520 7374 6172  cluding the star
+0002c510: 7420 616e 6420 656e 6420 706f 696e 7473  t and end points
+0002c520: 2c20 616e 6420 7468 6520 6465 7074 6820  , and the depth 
+0002c530: 6f66 2074 6865 2070 6174 7465 726e 2e0a  of the pattern..
+0002c540: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0002c550: 3a0a 2020 2020 2020 2020 2020 2020 4c69  :.            Li
+0002c560: 6e65 5061 7474 6572 6e3a 2041 206c 696e  nePattern: A lin
+0002c570: 6520 7061 7474 6572 6e20 6f62 6a65 6374  e pattern object
+0002c580: 2c20 7768 6963 6820 6361 6e20 6265 2075  , which can be u
+0002c590: 7365 6420 746f 2063 6f6e 6669 6775 7265  sed to configure
+0002c5a0: 2066 7572 7468 6572 2070 726f 7065 7274   further propert
+0002c5b0: 6965 7320 6f72 2074 6f20 6164 6420 7468  ies or to add th
+0002c5c0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0002c5d0: 2020 7061 7474 6572 6e20 746f 2074 6865    pattern to the
+0002c5e0: 206d 696c 6c69 6e67 206c 6973 742e 0a20   milling list.. 
+0002c5f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0002c600: 2020 2073 7461 7274 5f78 203d 2070 6174     start_x = pat
+0002c610: 7465 726e 5f73 6574 7469 6e67 732e 7374  tern_settings.st
+0002c620: 6172 745f 780a 2020 2020 2020 2020 7374  art_x.        st
+0002c630: 6172 745f 7920 3d20 7061 7474 6572 6e5f  art_y = pattern_
+0002c640: 7365 7474 696e 6773 2e73 7461 7274 5f79  settings.start_y
+0002c650: 0a20 2020 2020 2020 2065 6e64 5f78 203d  .        end_x =
+0002c660: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
+0002c670: 732e 656e 645f 780a 2020 2020 2020 2020  s.end_x.        
+0002c680: 656e 645f 7920 3d20 7061 7474 6572 6e5f  end_y = pattern_
+0002c690: 7365 7474 696e 6773 2e65 6e64 5f79 0a20  settings.end_y. 
+0002c6a0: 2020 2020 2020 2064 6570 7468 203d 2070         depth = p
+0002c6b0: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+0002c6c0: 6465 7074 680a 0a20 2020 2020 2020 2073  depth..        s
+0002c6d0: 656c 662e 6c61 7965 722e 6164 644c 696e  elf.layer.addLin
+0002c6e0: 6528 0a20 2020 2020 2020 2020 2020 2042  e(.            B
+0002c6f0: 6567 696e 583d 7374 6172 745f 782c 2042  eginX=start_x, B
+0002c700: 6567 696e 593d 7374 6172 745f 792c 2045  eginY=start_y, E
+0002c710: 6e64 583d 656e 645f 782c 2045 6e64 593d  ndX=end_x, EndY=
+0002c720: 656e 645f 792c 2044 6570 7468 3d64 6570  end_y, Depth=dep
+0002c730: 7468 2c20 4465 7074 6855 6e69 743d 276d  th, DepthUnit='m
+0002c740: 272c 0a20 2020 2020 2020 2029 0a0a 2020  ',.        )..  
+0002c750: 2020 2020 2020 7061 7474 6572 6e20 3d20        pattern = 
+0002c760: 7365 6c66 2e6c 6179 6572 0a20 2020 2020  self.layer.     
+0002c770: 2020 2072 6574 7572 6e20 7061 7474 6572     return patter
+0002c780: 6e0a 0a20 2020 2064 6566 2064 7261 775f  n..    def draw_
+0002c790: 6369 7263 6c65 2873 656c 662c 2070 6174  circle(self, pat
+0002c7a0: 7465 726e 5f73 6574 7469 6e67 733a 2046  tern_settings: F
+0002c7b0: 6962 7365 6d43 6972 636c 6553 6574 7469  ibsemCircleSetti
+0002c7c0: 6e67 7329 3a0a 2020 2020 2020 2020 2222  ngs):.        ""
+0002c7d0: 220a 2020 2020 2020 2020 4472 6177 7320  ".        Draws 
+0002c7e0: 6120 6369 7263 6c65 2070 6174 7465 726e  a circle pattern
+0002c7f0: 206f 6e20 7468 6520 6375 7272 656e 7420   on the current 
+0002c800: 696d 6167 696e 6720 7669 6577 206f 6620  imaging view of 
+0002c810: 7468 6520 6d69 6372 6f73 636f 7065 2e0a  the microscope..
+0002c820: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+0002c830: 2020 2020 2020 2020 2020 2070 6174 7465             patte
+0002c840: 726e 5f73 6574 7469 6e67 7320 2846 6962  rn_settings (Fib
+0002c850: 7365 6d43 6972 636c 6553 6574 7469 6e67  semCircleSetting
+0002c860: 7329 3a20 4120 6461 7461 2063 6c61 7373  s): A data class
+0002c870: 206f 626a 6563 7420 7370 6563 6966 7969   object specifyi
+0002c880: 6e67 2074 6865 2070 6174 7465 726e 2070  ng the pattern p
+0002c890: 6172 616d 6574 6572 732c 0a20 2020 2020  arameters,.     
+0002c8a0: 2020 2020 2020 2020 2020 2069 6e63 6c75             inclu
+0002c8b0: 6469 6e67 2074 6865 2063 656e 7472 6520  ding the centre 
+0002c8c0: 706f 696e 742c 2072 6164 6975 7320 616e  point, radius an
+0002c8d0: 6420 6465 7074 6820 6f66 2074 6865 2070  d depth of the p
+0002c8e0: 6174 7465 726e 2e0a 0a20 2020 2020 2020  attern...       
+0002c8f0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+0002c900: 2020 2020 2020 4369 7263 6c65 5061 7474        CirclePatt
+0002c910: 6572 6e3a 2041 2063 6972 636c 6520 7061  ern: A circle pa
+0002c920: 7474 6572 6e20 6f62 6a65 6374 2c20 7768  ttern object, wh
+0002c930: 6963 6820 6361 6e20 6265 2075 7365 6420  ich can be used 
+0002c940: 746f 2063 6f6e 6669 6775 7265 2066 7572  to configure fur
+0002c950: 7468 6572 2070 726f 7065 7274 6965 7320  ther properties 
+0002c960: 6f72 2074 6f20 6164 6420 7468 650a 2020  or to add the.  
+0002c970: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+0002c980: 7474 6572 6e20 746f 2074 6865 206d 696c  ttern to the mil
+0002c990: 6c69 6e67 206c 6973 742e 0a0a 2020 2020  ling list...    
+0002c9a0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0002c9b0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+0002c9c0: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+0002c9d0: 2e63 6c65 616e 696e 675f 6372 6f73 735f  .cleaning_cross_
+0002c9e0: 7365 6374 696f 6e3a 0a20 2020 2020 2020  section:.       
+0002c9f0: 2020 2020 2070 6174 7465 726e 203d 2073       pattern = s
+0002ca00: 656c 662e 6c61 7965 722e 6164 6441 6e6e  elf.layer.addAnn
+0002ca10: 756c 7573 506f 6c69 7368 280a 2020 2020  ulusPolish(.    
+0002ca20: 2020 2020 2020 2020 2020 2020 4365 6e74              Cent
+0002ca30: 6572 583d 7061 7474 6572 6e5f 7365 7474  erX=pattern_sett
+0002ca40: 696e 6773 2e63 656e 7472 655f 782c 0a20  ings.centre_x,. 
+0002ca50: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+0002ca60: 656e 7465 7259 3d70 6174 7465 726e 5f73  enterY=pattern_s
+0002ca70: 6574 7469 6e67 732e 6365 6e74 7265 5f79  ettings.centre_y
+0002ca80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ca90: 2020 5261 6469 7573 413d 7061 7474 6572    RadiusA=patter
+0002caa0: 6e5f 7365 7474 696e 6773 2e72 6164 6975  n_settings.radiu
+0002cab0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0002cac0: 2020 2052 6164 6975 7342 3d30 2c0a 2020     RadiusB=0,.  
+0002cad0: 2020 2020 2020 2020 2020 2020 2020 4465                De
+0002cae0: 7074 683d 7061 7474 6572 6e5f 7365 7474  pth=pattern_sett
+0002caf0: 696e 6773 2e64 6570 7468 2c0a 2020 2020  ings.depth,.    
+0002cb00: 2020 2020 2020 2020 2020 2020 4465 7074              Dept
+0002cb10: 6855 6e69 743d 276d 272c 0a20 2020 2020  hUnit='m',.     
+0002cb20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002cb30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002cb40: 2020 2070 6174 7465 726e 203d 2073 656c     pattern = sel
+0002cb50: 662e 6c61 7965 722e 6164 6441 6e6e 756c  f.layer.addAnnul
+0002cb60: 7573 4669 6c6c 6564 280a 2020 2020 2020  usFilled(.      
+0002cb70: 2020 2020 2020 2020 2020 4365 6e74 6572            Center
+0002cb80: 583d 7061 7474 6572 6e5f 7365 7474 696e  X=pattern_settin
+0002cb90: 6773 2e63 656e 7472 655f 782c 0a20 2020  gs.centre_x,.   
+0002cba0: 2020 2020 2020 2020 2020 2020 2043 656e               Cen
+0002cbb0: 7465 7259 3d70 6174 7465 726e 5f73 6574  terY=pattern_set
+0002cbc0: 7469 6e67 732e 6365 6e74 7265 5f79 2c0a  tings.centre_y,.
+0002cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cbe0: 5261 6469 7573 413d 7061 7474 6572 6e5f  RadiusA=pattern_
+0002cbf0: 7365 7474 696e 6773 2e72 6164 6975 732c  settings.radius,
+0002cc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cc10: 2052 6164 6975 7342 3d30 2c0a 2020 2020   RadiusB=0,.    
+0002cc20: 2020 2020 2020 2020 2020 2020 4465 7074              Dept
+0002cc30: 683d 7061 7474 6572 6e5f 7365 7474 696e  h=pattern_settin
+0002cc40: 6773 2e64 6570 7468 2c0a 2020 2020 2020  gs.depth,.      
+0002cc50: 2020 2020 2020 2020 2020 4465 7074 6855            DepthU
+0002cc60: 6e69 743d 276d 272c 0a20 2020 2020 2020  nit='m',.       
+0002cc70: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0002cc80: 7265 7475 726e 2070 6174 7465 726e 0a20  return pattern. 
+0002cc90: 2020 200a 2020 2020 6465 6620 6472 6177     .    def draw
+0002cca0: 5f61 6e6e 756c 7573 2873 656c 662c 7061  _annulus(self,pa
+0002ccb0: 7474 6572 6e5f 7365 7474 696e 6773 3a20  ttern_settings: 
+0002ccc0: 4669 6273 656d 4369 7263 6c65 5365 7474  FibsemCircleSett
+0002ccd0: 696e 6773 293a 0a0a 2020 2020 2020 2020  ings):..        
+0002cce0: 2222 2244 7261 7773 2061 6e20 616e 6e75  """Draws an annu
+0002ccf0: 6c75 7320 2864 6f6e 7574 2920 7061 7474  lus (donut) patt
+0002cd00: 6572 6e20 6f6e 2074 6865 2063 7572 7265  ern on the curre
+0002cd10: 6e74 2069 6d61 6769 6e67 2076 6965 7720  nt imaging view 
+0002cd20: 6f66 2074 6865 206d 6963 726f 7363 6f70  of the microscop
+0002cd30: 652e 0a0a 2020 2020 2020 2020 4172 6773  e...        Args
+0002cd40: 3a20 0a20 2020 2020 2020 2020 2020 2070  : .            p
+0002cd50: 6174 7465 726e 5f73 6574 7469 6e67 7320  attern_settings 
+0002cd60: 2846 6962 7365 6d43 6972 636c 6553 6574  (FibsemCircleSet
+0002cd70: 7469 6e67 7329 3a20 4120 6461 7461 2063  tings): A data c
+0002cd80: 6c61 7373 206f 626a 6563 7420 7370 6563  lass object spec
+0002cd90: 6966 7969 6e67 2074 6865 2070 6174 7465  ifying the patte
+0002cda0: 726e 2070 6172 616d 6574 6572 732c 0a20  rn parameters,. 
+0002cdb0: 2020 2020 2020 2020 2020 2069 6e63 6c75             inclu
+0002cdc0: 6469 6e67 2074 6865 2063 656e 7472 6520  ding the centre 
+0002cdd0: 706f 696e 742c 206f 7574 6572 2072 6164  point, outer rad
+0002cde0: 6975 7320 616e 6420 7468 6963 6b6e 6573  ius and thicknes
+0002cdf0: 7320 6f66 2074 6865 2061 6e6e 756c 7573  s of the annulus
+0002ce00: 2c20 616e 6420 7468 6520 6465 7074 6820  , and the depth 
+0002ce10: 6f66 2074 6865 2070 6174 7465 726e 2e0a  of the pattern..
+0002ce20: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0002ce30: 3a0a 2020 2020 2020 2020 2020 2020 616e  :.            an
+0002ce40: 6e75 6c75 7320 7061 7474 6572 6e20 6f62  nulus pattern ob
+0002ce50: 6a65 6374 0a20 2020 2020 2020 2022 2222  ject.        """
+0002ce60: 0a20 2020 2020 2020 206f 7574 6572 5f72  .        outer_r
+0002ce70: 6164 6975 7320 3d20 7061 7474 6572 6e5f  adius = pattern_
+0002ce80: 7365 7474 696e 6773 2e72 6164 6975 730a  settings.radius.
+0002ce90: 2020 2020 2020 2020 696e 6e65 725f 7261          inner_ra
+0002cea0: 6469 7573 203d 2070 6174 7465 726e 5f73  dius = pattern_s
+0002ceb0: 6574 7469 6e67 732e 7261 6469 7573 202d  ettings.radius -
+0002cec0: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
+0002ced0: 732e 7468 6963 6b6e 6573 730a 0a0a 2020  s.thickness...  
+0002cee0: 2020 2020 2020 7061 7474 6572 6e20 3d20        pattern = 
+0002cef0: 7365 6c66 2e6c 6179 6572 2e61 6464 416e  self.layer.addAn
+0002cf00: 6e75 6c75 7346 696c 6c65 6428 0a20 2020  nulusFilled(.   
+0002cf10: 2020 2020 2020 2020 2043 656e 7465 7258           CenterX
+0002cf20: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
+0002cf30: 732e 6365 6e74 7265 5f78 2c0a 2020 2020  s.centre_x,.    
+0002cf40: 2020 2020 2020 2020 4365 6e74 6572 593d          CenterY=
+0002cf50: 7061 7474 6572 6e5f 7365 7474 696e 6773  pattern_settings
+0002cf60: 2e63 656e 7472 655f 792c 0a20 2020 2020  .centre_y,.     
+0002cf70: 2020 2020 2020 2052 6164 6975 7341 3d6f         RadiusA=o
+0002cf80: 7574 6572 5f72 6164 6975 732c 0a20 2020  uter_radius,.   
+0002cf90: 2020 2020 2020 2020 2052 6164 6975 7342           RadiusB
+0002cfa0: 3d69 6e6e 6572 5f72 6164 6975 732c 0a20  =inner_radius,. 
+0002cfb0: 2020 2020 2020 2020 2020 2044 6570 7468             Depth
+0002cfc0: 3d70 6174 7465 726e 5f73 6574 7469 6e67  =pattern_setting
+0002cfd0: 732e 6465 7074 682c 0a20 2020 2020 2020  s.depth,.       
+0002cfe0: 2020 2020 2044 6570 7468 556e 6974 3d27       DepthUnit='
+0002cff0: 6d27 2c0a 2020 2020 2020 2020 290a 0a20  m',.        ).. 
+0002d000: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0002d010: 7474 6572 6e0a 2020 2020 0a20 2020 2064  ttern.    .    d
+0002d020: 6566 2064 7261 775f 6269 746d 6170 5f70  ef draw_bitmap_p
+0002d030: 6174 7465 726e 280a 2020 2020 2020 2020  attern(.        
+0002d040: 7365 6c66 2c0a 2020 2020 2020 2020 7061  self,.        pa
+0002d050: 7474 6572 6e5f 7365 7474 696e 6773 3a20  ttern_settings: 
+0002d060: 4669 6273 656d 4269 746d 6170 5365 7474  FibsemBitmapSett
+0002d070: 696e 6773 2c0a 2020 2020 2020 2020 7061  ings,.        pa
+0002d080: 7468 3a20 7374 722c 0a20 2020 2029 3a0a  th: str,.    ):.
+0002d090: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0002d0a0: 6f74 496d 706c 656d 656e 7465 640a 0a20  otImplemented.. 
+0002d0b0: 2020 2064 6566 2073 6574 7570 5f73 7075     def setup_spu
+0002d0c0: 7474 6572 2873 656c 662c 2070 726f 746f  tter(self, proto
+0002d0d0: 636f 6c3a 2064 6963 7429 3a0a 2020 2020  col: dict):.    
+0002d0e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0002d0f0: 5365 7420 7570 2074 6865 2073 7075 7474  Set up the sputt
+0002d100: 6572 2063 6f61 7469 6e67 2070 726f 6365  er coating proce
+0002d110: 7373 206f 6e20 7468 6520 6d69 6372 6f73  ss on the micros
+0002d120: 636f 7065 2e0a 0a20 2020 2020 2020 2041  cope...        A
+0002d130: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+0002d140: 2070 726f 746f 636f 6c20 2864 6963 7429   protocol (dict)
+0002d150: 3a20 436f 6e74 6169 6e73 2061 6c6c 206f  : Contains all o
+0002d160: 6620 7468 6520 6e65 6365 7373 6172 7920  f the necessary 
+0002d170: 7661 6c75 6573 2074 6f20 7365 7475 7020  values to setup 
+0002d180: 7570 2070 6c61 7469 6e75 6d20 7370 7574  up platinum sput
+0002d190: 7465 7269 6e67 2e0a 2020 2020 2020 2020  tering..        
+0002d1a0: 2020 2020 2020 2020 466f 7220 5445 5343          For TESC
+0002d1b0: 414e 3a0a 2020 2020 2020 2020 2020 2020  AN:.            
+0002d1c0: 2020 2020 2020 2020 2d20 6866 773a 2048          - hfw: H
+0002d1d0: 6f72 697a 6f6e 7461 6c20 6669 656c 6420  orizontal field 
+0002d1e0: 7769 6474 6820 286d 292e 0a20 2020 2020  width (m)..     
+0002d1f0: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+0002d200: 2062 6561 6d5f 6375 7272 656e 743a 2049   beam_current: I
+0002d210: 6f6e 2062 6561 6d20 6375 7272 656e 7420  on beam current 
+0002d220: 696e 205b 415d 2e0a 2020 2020 2020 2020  in [A]..        
+0002d230: 2020 2020 2020 2020 2020 2020 2d20 7370              - sp
+0002d240: 6f74 5f73 697a 653a 2049 6f6e 2062 6561  ot_size: Ion bea
+0002d250: 6d20 7370 6f74 2073 697a 6520 696e 205b  m spot size in [
+0002d260: 6d5d 2e0a 2020 2020 2020 2020 2020 2020  m]..            
+0002d270: 2020 2020 2020 2020 2d20 7261 7465 3a20          - rate: 
+0002d280: 496f 6e2f 656c 6563 7472 6f6e 2065 7463  Ion/electron etc
+0002d290: 6869 6e67 2072 6174 6520 2864 6570 6f73  hing rate (depos
+0002d2a0: 6974 696f 6e20 7261 7465 2920 696e 205b  ition rate) in [
+0002d2b0: 6d33 2f41 2f73 5d2e 2045 2e67 2e20 666f  m3/A/s]. E.g. fo
+0002d2c0: 7220 7369 6c69 636f 6e65 2034 2e37 652d  r silicone 4.7e-
+0002d2d0: 3130 206d 332f 412f 732e 0a20 2020 2020  10 m3/A/s..     
+0002d2e0: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+0002d2f0: 2064 7765 6c6c 2074 696d 653a 2050 6978   dwell time: Pix
+0002d300: 656c 2064 7765 6c6c 2074 696d 6520 696e  el dwell time in
+0002d310: 205b 735d 2e0a 0a20 2020 2020 2020 2052   [s]...        R
+0002d320: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+0002d330: 2020 2020 4e6f 6e65 0a0a 2020 2020 2020      None..      
+0002d340: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+0002d350: 2020 2020 2020 4e6f 6e65 0a0a 2020 2020        None..    
+0002d360: 2020 2020 4e6f 7465 733a 0a20 2020 2020      Notes:.     
+0002d370: 2020 2020 2020 2054 6869 7320 6675 6e63         This func
+0002d380: 7469 6f6e 2073 6574 7320 7570 2074 6865  tion sets up the
+0002d390: 2073 7075 7474 6572 2063 6f61 7469 6e67   sputter coating
+0002d3a0: 2070 726f 6365 7373 206f 6e20 7468 6520   process on the 
+0002d3b0: 6d69 6372 6f73 636f 7065 2e20 0a20 2020  microscope. .   
+0002d3c0: 2020 2020 2020 2020 2049 7420 7365 7473           It sets
+0002d3d0: 2074 6865 2061 6374 6976 6520 7669 6577   the active view
+0002d3e0: 2074 6f20 7468 6520 656c 6563 7472 6f6e   to the electron
+0002d3f0: 2062 6561 6d2c 2063 6c65 6172 7320 616e   beam, clears an
+0002d400: 7920 6578 6973 7469 6e67 2070 6174 7465  y existing patte
+0002d410: 726e 732c 2061 6e64 2073 6574 7320 7468  rns, and sets th
+0002d420: 6520 6465 6661 756c 7420 6265 616d 2074  e default beam t
+0002d430: 7970 6520 746f 2074 6865 2065 6c65 6374  ype to the elect
+0002d440: 726f 6e20 6265 616d 2e20 0a20 2020 2020  ron beam. .     
+0002d450: 2020 2020 2020 2049 7420 7468 656e 2069         It then i
+0002d460: 6e73 6572 7473 2074 6865 206d 756c 7469  nserts the multi
+0002d470: 6368 656d 2061 6e64 2074 7572 6e73 206f  chem and turns o
+0002d480: 6e20 7468 6520 6865 6174 6572 2066 6f72  n the heater for
+0002d490: 2074 6865 2073 7065 6369 6669 6564 2067   the specified g
+0002d4a0: 6173 2061 6363 6f72 6469 6e67 2074 6f20  as according to 
+0002d4b0: 7468 6520 6769 7665 6e20 7072 6f74 6f63  the given protoc
+0002d4c0: 6f6c 2e20 0a20 2020 2020 2020 2020 2020  ol. .           
+0002d4d0: 2054 6869 7320 6675 6e63 7469 6f6e 2061   This function a
+0002d4e0: 6c73 6f20 7761 6974 7320 666f 7220 3320  lso waits for 3 
+0002d4f0: 7365 636f 6e64 7320 746f 2061 6c6c 6f77  seconds to allow
+0002d500: 2074 6865 2068 6561 7465 7220 746f 2077   the heater to w
+0002d510: 6172 6d20 7570 2e0a 2020 2020 2020 2020  arm up..        
+0002d520: 2222 220a 2020 2020 2020 2020 5f63 6865  """.        _che
+0002d530: 636b 5f73 7075 7474 6572 2873 656c 662e  ck_sputter(self.
+0002d540: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+0002d550: 6761 7320 3d20 7072 6f74 6f63 6f6c 5b22  gas = protocol["
+0002d560: 6761 7322 5d0a 2020 2020 2020 2020 7365  gas"].        se
+0002d570: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4649  lf.connection.FI
+0002d580: 422e 4265 616d 2e4f 6e28 290a 2020 2020  B.Beam.On().    
+0002d590: 2020 2020 6c69 6e65 7320 3d20 7365 6c66      lines = self
+0002d5a0: 2e63 6f6e 6e65 6374 696f 6e2e 4749 532e  .connection.GIS.
+0002d5b0: 456e 756d 2829 0a20 2020 2020 2020 2066  Enum().        f
+0002d5c0: 6f72 206c 696e 6520 696e 206c 696e 6573  or line in lines
+0002d5d0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0002d5e0: 206c 696e 652e 6e61 6d65 203d 3d20 6761   line.name == ga
+0002d5f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002d600: 2020 2073 656c 662e 6c69 6e65 203d 206c     self.line = l
+0002d610: 696e 650a 0a20 2020 2020 2020 2020 2020  ine..           
+0002d620: 2020 2020 2023 2053 7461 7274 2047 4953       # Start GIS
+0002d630: 2068 6561 7469 6e67 0a20 2020 2020 2020   heating.       
+0002d640: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+0002d650: 6e6e 6563 7469 6f6e 2e47 4953 2e50 7265  nnection.GIS.Pre
+0002d660: 7061 7265 5465 6d70 6572 6174 7572 6528  pareTemperature(
+0002d670: 6c69 6e65 2c20 5472 7565 290a 0a20 2020  line, True)..   
+0002d680: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0002d690: 6e73 6572 7420 4749 5320 696e 746f 2077  nsert GIS into w
+0002d6a0: 6f72 6b69 6e67 2070 6f73 6974 696f 6e0a  orking position.
+0002d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6c0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0002d6d0: 4749 532e 4d6f 7665 546f 286c 696e 652c  GIS.MoveTo(line,
+0002d6e0: 2041 7574 6f6d 6174 696f 6e2e 4749 532e   Automation.GIS.
+0002d6f0: 506f 7369 7469 6f6e 2e57 6f72 6b69 6e67  Position.Working
+0002d700: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0002d710: 2020 2023 2057 6169 7420 666f 7220 4749     # Wait for GI
+0002d720: 5320 6865 6174 6564 0a20 2020 2020 2020  S heated.       
+0002d730: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+0002d740: 6e6e 6563 7469 6f6e 2e47 4953 2e57 6169  nnection.GIS.Wai
+0002d750: 7446 6f72 5465 6d70 6572 6174 7572 6552  tForTemperatureR
+0002d760: 6561 6479 286c 696e 6529 0a0a 2020 2020  eady(line)..    
+0002d770: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0002d780: 2020 2020 206c 6179 6572 5365 7474 696e       layerSettin
+0002d790: 6773 203d 2073 656c 662e 636f 6e6e 6563  gs = self.connec
+0002d7a0: 7469 6f6e 2e44 7261 7742 6561 6d2e 4c61  tion.DrawBeam.La
+0002d7b0: 7965 7253 6574 7469 6e67 732e 4944 6570  yerSettings.IDep
+0002d7c0: 6f73 6974 696f 6e28 0a20 2020 2020 2020  osition(.       
+0002d7d0: 2020 2020 2020 2020 2073 796e 6357 7269           syncWri
+0002d7e0: 7465 4669 656c 643d 5472 7565 2c0a 2020  teField=True,.  
+0002d7f0: 2020 2020 2020 2020 2020 2020 2020 7772                wr
+0002d800: 6974 6546 6965 6c64 5369 7a65 3d70 726f  iteFieldSize=pro
+0002d810: 746f 636f 6c5b 2268 6677 225d 2c0a 2020  tocol["hfw"],.  
+0002d820: 2020 2020 2020 2020 2020 2020 2020 6265                be
+0002d830: 616d 4375 7272 656e 743d 7072 6f74 6f63  amCurrent=protoc
+0002d840: 6f6c 5b22 6265 616d 5f63 7572 7265 6e74  ol["beam_current
+0002d850: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0002d860: 2020 2020 7370 6f74 5369 7a65 3d70 726f      spotSize=pro
+0002d870: 746f 636f 6c5b 2273 706f 745f 7369 7a65  tocol["spot_size
+0002d880: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+0002d890: 2020 2020 7261 7465 3d33 652d 3130 2c20      rate=3e-10, 
+0002d8a0: 2320 5661 6c75 6520 666f 7220 706c 6174  # Value for plat
+0002d8b0: 696e 756d 0a20 2020 2020 2020 2020 2020  inum.           
+0002d8c0: 2020 2020 2064 7765 6c6c 5469 6d65 3d70       dwellTime=p
+0002d8d0: 726f 746f 636f 6c5b 2264 7765 6c6c 5f74  rotocol["dwell_t
+0002d8e0: 696d 6522 5d2c 0a20 2020 2020 2020 2020  ime"],.         
+0002d8f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002d900: 2073 656c 662e 6c61 7965 7220 3d20 7365   self.layer = se
+0002d910: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4472  lf.connection.Dr
+0002d920: 6177 4265 616d 2e4c 6179 6572 2822 4c61  awBeam.Layer("La
+0002d930: 7965 7231 222c 206c 6179 6572 5365 7474  yer1", layerSett
+0002d940: 696e 6773 290a 2020 2020 2020 2020 2020  ings).          
+0002d950: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002d960: 6e2e 4472 6177 4265 616d 2e4c 6f61 644c  n.DrawBeam.LoadL
+0002d970: 6179 6572 2873 656c 662e 6c61 7965 7229  ayer(self.layer)
+0002d980: 0a0a 2020 2020 2020 2020 6578 6365 7074  ..        except
+0002d990: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+0002d9a0: 706f 7274 2066 6962 7365 6d0a 2020 2020  port fibsem.    
+0002d9b0: 2020 2020 2020 2020 6261 7365 5f70 6174          base_pat
+0002d9c0: 6820 3d20 6f73 2e70 6174 682e 6469 726e  h = os.path.dirn
+0002d9d0: 616d 6528 6669 6273 656d 2e5f 5f70 6174  ame(fibsem.__pat
+0002d9e0: 685f 5f5b 305d 290a 2020 2020 2020 2020  h__[0]).        
+0002d9f0: 2020 2020 6c61 7965 725f 7061 7468 203d      layer_path =
+0002da00: 206f 732e 7061 7468 2e6a 6f69 6e28 6261   os.path.join(ba
+0002da10: 7365 5f70 6174 682c 2266 6962 7365 6d22  se_path,"fibsem"
+0002da20: 2c20 2263 6f6e 6669 6722 2c20 2264 6570  , "config", "dep
+0002da30: 6f73 6974 696f 6e2e 6462 7022 290a 2020  osition.dbp").  
+0002da40: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+0002da50: 6179 6572 203d 2073 656c 662e 636f 6e6e  ayer = self.conn
+0002da60: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+0002da70: 4c61 7965 722e 6672 6f6d 4462 7028 6c61  Layer.fromDbp(la
+0002da80: 7965 725f 7061 7468 295b 305d 0a20 2020  yer_path)[0].   
+0002da90: 2020 2020 2020 2020 2023 2073 656c 662e           # self.
+0002daa0: 6c61 7965 7220 3d20 7365 6c66 2e63 6f6e  layer = self.con
+0002dab0: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
+0002dac0: 2e4c 6f61 644c 6179 6572 2864 6566 6175  .LoadLayer(defau
+0002dad0: 6c74 4c61 7965 7253 6574 7469 6e67 735b  ltLayerSettings[
+0002dae0: 305d 290a 0a20 2020 2064 6566 2064 7261  0])..    def dra
+0002daf0: 775f 7370 7574 7465 725f 7061 7474 6572  w_sputter_patter
+0002db00: 6e28 7365 6c66 2c20 6866 772c 206c 696e  n(self, hfw, lin
+0002db10: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+0002db20: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+0002db30: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
+0002db40: 2020 2020 2020 2020 4472 6177 7320 6120          Draws a 
+0002db50: 6c69 6e65 2070 6174 7465 726e 2066 6f72  line pattern for
+0002db60: 2073 7075 7474 6572 696e 6720 7769 7468   sputtering with
+0002db70: 2074 6865 2067 6976 656e 2070 6172 616d   the given param
+0002db80: 6574 6572 732e 0a0a 2020 2020 2020 2020  eters...        
+0002db90: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+0002dba0: 2020 6866 7720 2866 6c6f 6174 293a 2054    hfw (float): T
+0002dbb0: 6865 2068 6f72 697a 6f6e 7461 6c20 6669  he horizontal fi
+0002dbc0: 656c 6420 7769 6474 6820 6f66 2074 6865  eld width of the
+0002dbd0: 2065 6c65 6374 726f 6e20 6265 616d 2e0a   electron beam..
+0002dbe0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+0002dbf0: 5f70 6174 7465 726e 5f6c 656e 6774 6820  _pattern_length 
+0002dc00: 2866 6c6f 6174 293a 2054 6865 206c 656e  (float): The len
+0002dc10: 6774 6820 6f66 2074 6865 206c 696e 6520  gth of the line 
+0002dc20: 7061 7474 6572 6e20 746f 2064 7261 772e  pattern to draw.
+0002dc30: 0a20 2020 2020 2020 2020 2020 202a 6172  .            *ar
+0002dc40: 6773 2c20 2a2a 6b77 6172 6773 3a20 5468  gs, **kwargs: Th
+0002dc50: 6973 2072 6570 7265 7365 6e74 7320 7468  is represents th
+0002dc60: 6520 6172 6775 6d65 6e74 7320 7573 6564  e arguments used
+0002dc70: 2062 7920 5468 6572 6d6f 4d69 6372 6f73   by ThermoMicros
+0002dc80: 636f 7065 2074 6861 7420 6172 6520 6e6f  cope that are no
+0002dc90: 7420 7265 7175 6972 6564 2066 6f72 2074  t required for t
+0002dca0: 6865 2054 6573 6361 6e4d 6963 726f 7363  he TescanMicrosc
+0002dcb0: 6f70 652e 0a0a 2020 2020 2020 2020 5265  ope...        Re
+0002dcc0: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
+0002dcd0: 2020 204e 6f6e 650a 0a20 2020 2020 2020     None..       
+0002dce0: 204e 6f74 6573 3a0a 2020 2020 2020 2020   Notes:.        
+0002dcf0: 2020 2020 5365 7473 2074 6865 2068 6f72      Sets the hor
+0002dd00: 697a 6f6e 7461 6c20 6669 656c 6420 7769  izontal field wi
+0002dd10: 6474 6820 6f66 2074 6865 2065 6c65 6374  dth of the elect
+0002dd20: 726f 6e20 6265 616d 2074 6f20 7468 6520  ron beam to the 
+0002dd30: 6769 7665 6e20 7661 6c75 652e 0a20 2020  given value..   
+0002dd40: 2020 2020 2020 2020 2044 7261 7773 2061           Draws a
+0002dd50: 206c 696e 6520 7061 7474 6572 6e20 666f   line pattern fo
+0002dd60: 7220 7370 7574 7465 7269 6e67 2077 6974  r sputtering wit
+0002dd70: 6820 7468 6520 6769 7665 6e20 6c65 6e67  h the given leng
+0002dd80: 7468 2061 6e64 206d 696c 6c69 6e67 2064  th and milling d
+0002dd90: 6570 7468 2e0a 2020 2020 2020 2020 2020  epth..          
+0002dda0: 2020 5365 7473 2074 6865 2073 7075 7474    Sets the sputt
+0002ddb0: 6572 2074 696d 6520 6f66 2074 6865 206c  er time of the l
+0002ddc0: 696e 6520 7061 7474 6572 6e20 746f 2074  ine pattern to t
+0002ddd0: 6865 2067 6976 656e 2076 616c 7565 2e0a  he given value..
+0002dde0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0002ddf0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+0002de00: 7469 6f6e 2e46 4942 2e4f 7074 6963 732e  tion.FIB.Optics.
+0002de10: 5365 7456 6965 7766 6965 6c64 280a 2020  SetViewfield(.  
+0002de20: 2020 2020 2020 2020 2020 6866 7720 2a20            hfw * 
+0002de30: 636f 6e73 7461 6e74 732e 4d45 5452 455f  constants.METRE_
+0002de40: 544f 5f4d 494c 4c49 4d45 5452 450a 2020  TO_MILLIMETRE.  
+0002de50: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0002de60: 2073 7461 7274 5f78 3d2d 6c69 6e65 5f70   start_x=-line_p
+0002de70: 6174 7465 726e 5f6c 656e 6774 682f 322c  attern_length/2,
+0002de80: 200a 2020 2020 2020 2020 7374 6172 745f   .        start_
+0002de90: 793d 2b6c 696e 655f 7061 7474 6572 6e5f  y=+line_pattern_
+0002dea0: 6c65 6e67 7468 2c0a 2020 2020 2020 2020  length,.        
+0002deb0: 656e 645f 783d 2b6c 696e 655f 7061 7474  end_x=+line_patt
+0002dec0: 6572 6e5f 6c65 6e67 7468 2f32 2c0a 2020  ern_length/2,.  
+0002ded0: 2020 2020 2020 656e 645f 793d 2b6c 696e        end_y=+lin
+0002dee0: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+0002def0: 2c0a 2020 2020 2020 2020 6465 7074 683d  ,.        depth=
+0002df00: 3265 2d36 0a20 2020 2020 2020 200a 2020  2e-6.        .  
+0002df10: 2020 2020 2020 7061 7474 6572 6e20 3d20        pattern = 
+0002df20: 7365 6c66 2e6c 6179 6572 2e61 6464 4c69  self.layer.addLi
+0002df30: 6e65 280a 2020 2020 2020 2020 2020 2020  ne(.            
+0002df40: 4265 6769 6e58 3d73 7461 7274 5f78 2c20  BeginX=start_x, 
+0002df50: 4265 6769 6e59 3d73 7461 7274 5f79 2c20  BeginY=start_y, 
+0002df60: 456e 6458 3d65 6e64 5f78 2c20 456e 6459  EndX=end_x, EndY
+0002df70: 3d65 6e64 5f79 2c20 4465 7074 683d 6465  =end_y, Depth=de
+0002df80: 7074 680a 2020 2020 2020 2020 290a 2020  pth.        ).  
+0002df90: 2020 2020 2020 0a20 2020 2020 2020 2072        .        r
+0002dfa0: 6574 7572 6e20 7061 7474 6572 6e0a 0a20  eturn pattern.. 
+0002dfb0: 2020 2064 6566 2072 756e 5f73 7075 7474     def run_sputt
+0002dfc0: 6572 2873 656c 662c 202a 6172 6773 2c20  er(self, *args, 
+0002dfd0: 2a2a 6b77 6172 6773 293a 0a20 2020 2020  **kwargs):.     
+0002dfe0: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
+0002dff0: 756e 7320 7468 6520 4749 5320 506c 6174  uns the GIS Plat
+0002e000: 696e 756d 2053 7075 7474 6572 2e0a 0a20  inum Sputter... 
+0002e010: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+0002e020: 2020 2020 2020 2020 202a 6172 6773 2c20           *args, 
+0002e030: 2a2a 6b77 6172 6773 3a20 5573 6564 2074  **kwargs: Used t
+0002e040: 6f20 6d61 696e 7461 696e 2066 756e 6374  o maintain funct
+0002e050: 696f 6e61 6c69 7479 2061 6e64 2063 6f6d  ionality and com
+0002e060: 7061 7461 6269 6c69 7479 2062 6574 7765  patability betwe
+0002e070: 656e 206d 6963 726f 7363 6f70 6573 2e20  en microscopes. 
+0002e080: 4e6f 2061 7267 756d 656e 7473 2072 6571  No arguments req
+0002e090: 7569 7265 642e 0a20 2020 2020 2020 2020  uired..         
+0002e0a0: 2020 200a 2020 2020 2020 2020 5275 6e73     .        Runs
+0002e0b0: 2074 6865 2047 4953 2050 6c61 7469 6e75   the GIS Platinu
+0002e0c0: 6d20 5370 7574 7465 722e 0a0a 2020 2020  m Sputter...    
+0002e0d0: 2020 2020 5265 7475 726e 733a 0a20 2020      Returns:.   
+0002e0e0: 2020 2020 2020 2020 204e 6f6e 650a 2020           None.  
+0002e0f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0002e100: 2020 5f63 6865 636b 5f73 7075 7474 6572    _check_sputter
+0002e110: 2873 656c 662e 7379 7374 656d 290a 2020  (self.system).  
+0002e120: 2020 2020 2020 2320 4f70 656e 2047 4953        # Open GIS
+0002e130: 2076 616c 7665 2074 6f20 6c65 7420 7468   valve to let th
+0002e140: 6520 6761 7320 666c 6f77 206f 6e74 6f20  e gas flow onto 
+0002e150: 7468 6520 7361 6d70 6c65 0a20 2020 2020  the sample.     
+0002e160: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0002e170: 6f6e 2e47 4953 2e4f 7065 6e56 616c 7665  on.GIS.OpenValve
+0002e180: 2873 656c 662e 6c69 6e65 290a 0a20 2020  (self.line)..   
+0002e190: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0002e1a0: 2020 2020 2020 2320 5275 6e20 7072 6564        # Run pred
+0002e1b0: 6566 696e 6564 2064 6570 6f73 6974 696f  efined depositio
+0002e1c0: 6e20 7072 6f63 6573 730a 2020 2020 2020  n process.      
+0002e1d0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+0002e1e0: 6374 696f 6e2e 4472 6177 4265 616d 2e53  ction.DrawBeam.S
+0002e1f0: 7461 7274 2829 0a20 2020 2020 2020 2020  tart().         
+0002e200: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0002e210: 6f6e 2e50 726f 6772 6573 732e 5368 6f77  on.Progress.Show
+0002e220: 2822 4472 6177 4265 616d 222c 2022 4c61  ("DrawBeam", "La
+0002e230: 7965 7220 3120 696e 2070 726f 6772 6573  yer 1 in progres
+0002e240: 7322 2c20 4661 6c73 652c 2046 616c 7365  s", False, False
+0002e250: 2c20 302c 2031 3030 290a 2020 2020 2020  , 0, 100).      
+0002e260: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0002e270: 666f 2822 5370 7574 7465 7269 6e67 2077  fo("Sputtering w
+0002e280: 6974 6820 706c 6174 696e 756d 2073 7461  ith platinum sta
+0002e290: 7274 6564 2e22 290a 2020 2020 2020 2020  rted.").        
+0002e2a0: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
+0002e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e2c0: 7374 6174 7573 203d 2073 656c 662e 636f  status = self.co
+0002e2d0: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
+0002e2e0: 6d2e 4765 7453 7461 7475 7328 290a 2020  m.GetStatus().  
+0002e2f0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
+0002e300: 6e6e 696e 6720 3d20 7374 6174 7573 5b30  nning = status[0
+0002e310: 5d20 3d3d 2073 656c 662e 636f 6e6e 6563  ] == self.connec
+0002e320: 7469 6f6e 2e44 7261 7742 6561 6d2e 5374  tion.DrawBeam.St
+0002e330: 6174 7573 2e50 726f 6a65 6374 4c6f 6164  atus.ProjectLoad
+0002e340: 6564 4578 706f 7369 7469 6f6e 496e 5072  edExpositionInPr
+0002e350: 6f67 7265 7373 0a20 2020 2020 2020 2020  ogress.         
+0002e360: 2020 2020 2020 2069 6620 7275 6e6e 696e         if runnin
+0002e370: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0002e380: 2020 2020 2020 2070 726f 6772 6573 7320         progress 
+0002e390: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+0002e3a0: 2020 2020 2020 2020 6966 2073 7461 7475          if statu
+0002e3b0: 735b 315d 203e 2030 3a0a 2020 2020 2020  s[1] > 0:.      
+0002e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3d0: 2020 7072 6f67 7265 7373 203d 206d 696e    progress = min
+0002e3e0: 2831 3030 2c20 7374 6174 7573 5b32 5d20  (100, status[2] 
+0002e3f0: 2f20 7374 6174 7573 5b31 5d20 2a20 3130  / status[1] * 10
+0002e400: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0002e410: 2020 2020 2020 2070 7269 6e74 5072 6f67         printProg
+0002e420: 7265 7373 4261 7228 7072 6f67 7265 7373  ressBar(progress
+0002e430: 2c20 3130 3029 0a20 2020 2020 2020 2020  , 100).         
+0002e440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002e450: 636f 6e6e 6563 7469 6f6e 2e50 726f 6772  connection.Progr
+0002e460: 6573 732e 5365 7450 6572 6365 6e74 7328  ess.SetPercents(
+0002e470: 7072 6f67 7265 7373 290a 2020 2020 2020  progress).      
+0002e480: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+0002e490: 6d65 2e73 6c65 6570 2831 290a 2020 2020  me.sleep(1).    
+0002e4a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002e4b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002e4c0: 2020 2020 2020 6966 2073 7461 7475 735b        if status[
+0002e4d0: 305d 203d 3d20 7365 6c66 2e63 6f6e 6e65  0] == self.conne
+0002e4e0: 6374 696f 6e2e 4472 6177 4265 616d 2e53  ction.DrawBeam.S
+0002e4f0: 7461 7475 732e 5072 6f6a 6563 744c 6f61  tatus.ProjectLoa
+0002e500: 6465 6445 7870 6f73 6974 696f 6e49 646c  dedExpositionIdl
+0002e510: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002e520: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0002e530: 5072 6f67 7265 7373 4261 7228 3130 302c  ProgressBar(100,
+0002e540: 2031 3030 2c20 7375 6666 6978 3d27 4669   100, suffix='Fi
+0002e550: 6e69 7368 6564 2729 0a20 2020 2020 2020  nished').       
+0002e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e570: 2070 7269 6e74 2827 2729 0a20 2020 2020   print('').     
+0002e580: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0002e590: 7265 616b 0a20 2020 2020 2020 2066 696e  reak.        fin
+0002e5a0: 616c 6c79 3a0a 2020 2020 2020 2020 2020  ally:.          
+0002e5b0: 2020 2320 436c 6f73 6520 4749 5320 5661    # Close GIS Va
+0002e5c0: 6c76 6520 696e 2062 6f74 6820 2d20 7375  lve in both - su
+0002e5d0: 6363 6573 7320 616e 6420 6661 696c 7572  ccess and failur
+0002e5e0: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
+0002e5f0: 6c66 2e63 6f6e 6e65 6374 696f 6e2e 4749  lf.connection.GI
+0002e600: 532e 436c 6f73 6556 616c 7665 2873 656c  S.CloseValve(sel
+0002e610: 662e 6c69 6e65 290a 2020 2020 2020 2020  f.line).        
+0002e620: 0a20 2020 2064 6566 2066 696e 6973 685f  .    def finish_
+0002e630: 7370 7574 7465 7228 7365 6c66 2c20 2a61  sputter(self, *a
+0002e640: 7267 732c 202a 2a6b 7761 7267 7329 3a0a  rgs, **kwargs):.
+0002e650: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0002e660: 2020 2020 4669 6e69 7368 2074 6865 2073      Finish the s
+0002e670: 7075 7474 6572 2070 726f 6365 7373 2062  putter process b
+0002e680: 7920 7265 7472 6163 7469 6e67 2074 6865  y retracting the
+0002e690: 2047 4953 2063 6861 6d62 6572 2061 6e64   GIS chamber and
+0002e6a0: 2074 7572 6e69 6e67 206f 6666 2074 6865   turning off the
+0002e6b0: 2068 6561 7469 6e67 2e0a 0a20 2020 2020   heating...     
+0002e6c0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+0002e6d0: 2020 2020 202a 6172 6773 2c20 2a2a 6b77       *args, **kw
+0002e6e0: 6172 6773 3a20 5468 6973 2072 6570 7265  args: This repre
+0002e6f0: 7365 6e74 7320 7468 6520 6172 6775 6d65  sents the argume
+0002e700: 6e74 7320 7573 6564 2062 7920 5468 6572  nts used by Ther
+0002e710: 6d6f 4d69 6372 6f73 636f 7065 2074 6861  moMicroscope tha
+0002e720: 7420 6172 6520 6e6f 7420 7265 7175 6972  t are not requir
+0002e730: 6564 2066 6f72 2074 6865 2054 6573 6361  ed for the Tesca
+0002e740: 6e4d 6963 726f 7363 6f70 652e 0a0a 2020  nMicroscope...  
+0002e750: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+0002e760: 2020 2020 2020 2020 2020 204e 6f6e 650a             None.
+0002e770: 0a20 2020 2020 2020 2052 6169 7365 733a  .        Raises:
+0002e780: 0a20 2020 2020 2020 2020 2020 204e 6f6e  .            Non
+0002e790: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+0002e7a0: 2020 2020 2020 5f63 6865 636b 5f73 7075        _check_spu
+0002e7b0: 7474 6572 2873 656c 662e 7379 7374 656d  tter(self.system
+0002e7c0: 290a 2020 2020 2020 2020 2320 4d6f 7665  ).        # Move
+0002e7d0: 2047 4953 206f 7574 2066 726f 6d20 6368   GIS out from ch
+0002e7e0: 616d 6265 7220 616e 6420 7475 726e 206f  amber and turn o
+0002e7f0: 6666 2068 6561 7469 6e67 0a20 2020 2020  ff heating.     
+0002e800: 2020 2073 656c 662e 636f 6e6e 6563 7469     self.connecti
+0002e810: 6f6e 2e47 4953 2e4d 6f76 6554 6f28 7365  on.GIS.MoveTo(se
+0002e820: 6c66 2e6c 696e 652c 2041 7574 6f6d 6174  lf.line, Automat
+0002e830: 696f 6e2e 4749 532e 506f 7369 7469 6f6e  ion.GIS.Position
+0002e840: 2e48 6f6d 6529 0a20 2020 2020 2020 2073  .Home).        s
+0002e850: 656c 662e 636f 6e6e 6563 7469 6f6e 2e47  elf.connection.G
+0002e860: 4953 2e50 7265 7061 7265 5465 6d70 6572  IS.PrepareTemper
+0002e870: 6174 7572 6528 7365 6c66 2e6c 696e 652c  ature(self.line,
+0002e880: 2046 616c 7365 290a 2020 2020 2020 2020   False).        
+0002e890: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0002e8a0: 4472 6177 4265 616d 2e55 6e6c 6f61 644c  DrawBeam.UnloadL
+0002e8b0: 6179 6572 2829 0a20 2020 2020 2020 206c  ayer().        l
+0002e8c0: 6f67 6769 6e67 2e69 6e66 6f28 2250 6c61  ogging.info("Pla
+0002e8d0: 7469 6e75 6d20 7370 7574 7465 7269 6e67  tinum sputtering
+0002e8e0: 2070 726f 6365 7373 2063 6f6d 706c 6574   process complet
+0002e8f0: 6564 2e22 290a 0a20 2020 2023 2064 6566  ed.")..    # def
+0002e900: 2073 6574 7570 5f47 4953 2873 656c 662c   setup_GIS(self,
+0002e910: 7072 6f74 6f63 6f6c 2920 2d3e 204e 6f6e  protocol) -> Non
+0002e920: 653a 0a0a 2020 2020 2320 2020 2020 6265  e:..    #     be
+0002e930: 616d 5f74 7970 6520 3d20 7072 6f74 6f63  am_type = protoc
+0002e940: 6f6c 5b22 6265 616d 5f74 7970 6522 5d0a  ol["beam_type"].
+0002e950: 0a20 2020 2023 2020 2020 2069 6620 6265  .    #     if be
+0002e960: 616d 5f74 7970 6520 3d3d 2022 494f 4e22  am_type == "ION"
+0002e970: 3a0a 0a0a 2020 2020 2320 2020 2020 2020  :...    #       
+0002e980: 2020 6c61 7965 7253 6574 7469 6e67 7320    layerSettings 
+0002e990: 3d20 7365 6c66 2e63 6f6e 6e65 6374 696f  = self.connectio
+0002e9a0: 6e2e 4472 6177 4265 616d 2e4c 6179 6572  n.DrawBeam.Layer
+0002e9b0: 5365 7474 696e 6773 2e49 4465 706f 7369  Settings.IDeposi
+0002e9c0: 7469 6f6e 280a 2020 2020 2320 2020 2020  tion(.    #     
+0002e9d0: 2020 2020 2020 2020 7379 6e63 5772 6974          syncWrit
+0002e9e0: 6546 6965 6c64 3d54 7275 652c 0a20 2020  eField=True,.   
+0002e9f0: 2023 2020 2020 2020 2020 2020 2020 2077   #             w
+0002ea00: 7269 7465 4669 656c 6453 697a 653d 7072  riteFieldSize=pr
+0002ea10: 6f74 6f63 6f6c 2e67 6574 2822 6866 7722  otocol.get("hfw"
+0002ea20: 2c30 2e30 3030 3529 2c0a 2020 2020 2320  ,0.0005),.    # 
+0002ea30: 2020 2020 2020 2020 2020 2020 6265 616d              beam
+0002ea40: 4375 7272 656e 743d 7072 6f74 6f63 6f6c  Current=protocol
+0002ea50: 2e67 6574 2822 6265 616d 5f63 7572 7265  .get("beam_curre
+0002ea60: 6e74 222c 3565 2d31 3029 2c0a 2020 2020  nt",5e-10),.    
+0002ea70: 2320 2020 2020 2020 2020 2020 2020 7370  #             sp
+0002ea80: 6f74 5369 7a65 3d70 726f 746f 636f 6c2e  otSize=protocol.
+0002ea90: 6765 7428 2273 706f 745f 7369 7a65 222c  get("spot_size",
+0002eaa0: 352e 3065 2d38 292c 0a20 2020 2023 2020  5.0e-8),.    #  
+0002eab0: 2020 2020 2020 2020 2020 2073 7061 6369             spaci
+0002eac0: 6e67 3d31 2e30 2c0a 2020 2020 2320 2020  ng=1.0,.    #   
+0002ead0: 2020 2020 2020 2020 2020 7261 7465 3d33            rate=3
+0002eae0: 652d 3130 2c20 2320 5661 6c75 6520 666f  e-10, # Value fo
+0002eaf0: 7220 706c 6174 696e 756d 0a20 2020 2023  r platinum.    #
+0002eb00: 2020 2020 2020 2020 2020 2020 2064 7765               dwe
+0002eb10: 6c6c 5469 6d65 3d70 726f 746f 636f 6c2e  llTime=protocol.
+0002eb20: 6765 7428 2264 7765 6c6c 5f74 696d 6522  get("dwell_time"
+0002eb30: 2c31 2e30 652d 3629 2c0a 2020 2020 2320  ,1.0e-6),.    # 
+0002eb40: 2020 2020 2020 2020 2020 2020 7072 6573              pres
+0002eb50: 6574 3d4e 6f6e 652c 0a20 2020 2023 2020  et=None,.    #  
+0002eb60: 2020 2020 2020 2020 2020 2070 6172 616c             paral
+0002eb70: 6c65 6c3d 4661 6c73 652c 0a20 2020 2023  lel=False,.    #
+0002eb80: 2020 2020 2020 2020 2020 2020 206d 6174               mat
+0002eb90: 6572 6961 6c3d 2744 6566 6175 6c74 204d  erial='Default M
+0002eba0: 6174 6572 6961 6c27 2c0a 2020 2020 2320  aterial',.    # 
+0002ebb0: 2020 2020 2020 2020 2020 2020 6769 7350              gisP
+0002ebc0: 7265 6375 7273 6f72 3d4e 6f6e 652c 0a0a  recursor=None,..
+0002ebd0: 2020 2020 2320 2020 2020 2020 2020 290a      #         ).
+0002ebe0: 0a20 2020 2023 2020 2020 2065 6c73 653a  .    #     else:
+0002ebf0: 0a0a 0a20 2020 2023 2020 2020 2020 2020  ...    #        
+0002ec00: 206c 6179 6572 5365 7474 696e 6773 203d   layerSettings =
+0002ec10: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0002ec20: 2e44 7261 7742 6561 6d2e 4c61 7965 7253  .DrawBeam.LayerS
+0002ec30: 6574 7469 6e67 732e 4544 6570 6f73 6974  ettings.EDeposit
+0002ec40: 696f 6e28 0a20 2020 2023 2020 2020 2020  ion(.    #      
+0002ec50: 2020 2020 2020 2073 796e 6357 7269 7465         syncWrite
+0002ec60: 4669 656c 643d 5472 7565 2c0a 2020 2020  Field=True,.    
+0002ec70: 2320 2020 2020 2020 2020 2020 2020 7772  #             wr
+0002ec80: 6974 6546 6965 6c64 5369 7a65 3d70 726f  iteFieldSize=pro
+0002ec90: 746f 636f 6c2e 6765 7428 2268 6677 222c  tocol.get("hfw",
+0002eca0: 302e 3030 3035 292c 0a20 2020 2023 2020  0.0005),.    #  
+0002ecb0: 2020 2020 2020 2020 2020 2062 6561 6d43             beamC
+0002ecc0: 7572 7265 6e74 3d70 726f 746f 636f 6c2e  urrent=protocol.
+0002ecd0: 6765 7428 2262 6561 6d5f 6375 7272 656e  get("beam_curren
+0002ece0: 7422 2c35 652d 3130 292c 0a20 2020 2023  t",5e-10),.    #
+0002ecf0: 2020 2020 2020 2020 2020 2020 2073 706f               spo
+0002ed00: 7453 697a 653d 7072 6f74 6f63 6f6c 2e67  tSize=protocol.g
+0002ed10: 6574 2822 7370 6f74 5f73 697a 6522 2c35  et("spot_size",5
+0002ed20: 2e30 652d 3829 2c0a 2020 2020 2320 2020  .0e-8),.    #   
+0002ed30: 2020 2020 2020 2020 2020 7261 7465 3d33            rate=3
+0002ed40: 652d 3130 2c20 2320 5661 6c75 6520 666f  e-10, # Value fo
+0002ed50: 7220 706c 6174 696e 756d 0a20 2020 2023  r platinum.    #
+0002ed60: 2020 2020 2020 2020 2020 2020 2073 7061               spa
+0002ed70: 6369 6e67 3d31 2e30 2c0a 2020 2020 2320  cing=1.0,.    # 
+0002ed80: 2020 2020 2020 2020 2020 2020 6477 656c              dwel
+0002ed90: 6c54 696d 653d 7072 6f74 6f63 6f6c 2e67  lTime=protocol.g
+0002eda0: 6574 2822 6477 656c 6c5f 7469 6d65 222c  et("dwell_time",
+0002edb0: 312e 3065 2d36 292c 0a20 2020 2023 2020  1.0e-6),.    #  
+0002edc0: 2020 2020 2020 2020 2020 2070 7265 7365             prese
+0002edd0: 743d 4e6f 6e65 2c0a 2020 2020 2320 2020  t=None,.    #   
+0002ede0: 2020 2020 2020 2020 2020 7061 7261 6c6c            parall
+0002edf0: 656c 3d46 616c 7365 2c0a 2020 2020 2320  el=False,.    # 
+0002ee00: 2020 2020 2020 2020 2020 2020 6d61 7465              mate
+0002ee10: 7269 616c 3d27 4465 6661 756c 7420 4d61  rial='Default Ma
+0002ee20: 7465 7269 616c 272c 0a20 2020 2023 2020  terial',.    #  
+0002ee30: 2020 2020 2020 2020 2020 2067 6973 5072             gisPr
+0002ee40: 6563 7572 736f 723d 4e6f 6e65 2c0a 2020  ecursor=None,.  
+0002ee50: 2020 2320 2020 2020 2020 2020 290a 2020    #         ).  
+0002ee60: 2020 2320 2020 2020 7365 6c66 2e67 6973    #     self.gis
+0002ee70: 5f6c 6179 6572 203d 2073 656c 662e 636f  _layer = self.co
+0002ee80: 6e6e 6563 7469 6f6e 2e44 7261 7742 6561  nnection.DrawBea
+0002ee90: 6d2e 4c61 7965 7228 224c 6179 6572 5f47  m.Layer("Layer_G
+0002eea0: 4953 222c 206c 6179 6572 5365 7474 696e  IS", layerSettin
+0002eeb0: 6773 290a 0a0a 2020 2020 2320 2020 2020  gs)...    #     
+0002eec0: 6c6f 6767 696e 672e 696e 666f 2866 2247  logging.info(f"G
+0002eed0: 4953 2053 6574 7570 2043 6f6d 706c 6574  IS Setup Complet
+0002eee0: 652c 207b 6265 616d 5f74 7970 657d 206c  e, {beam_type} l
+0002eef0: 6179 6572 2073 6574 7469 6e67 7320 6c6f  ayer settings lo
+0002ef00: 6164 6564 2229 0a0a 2020 2020 2320 6465  aded")..    # de
+0002ef10: 6620 7365 7475 705f 4749 535f 7061 7474  f setup_GIS_patt
+0002ef20: 6572 6e28 7365 6c66 2c70 726f 746f 636f  ern(self,protoco
+0002ef30: 6c29 3a0a 0a20 2020 2023 2020 2020 2068  l):..    #     h
+0002ef40: 6677 203d 2070 726f 746f 636f 6c5b 2268  fw = protocol["h
+0002ef50: 6677 225d 0a20 2020 2023 2020 2020 206c  fw"].    #     l
+0002ef60: 696e 655f 7061 7474 6572 6e5f 6c65 6e67  ine_pattern_leng
+0002ef70: 7468 203d 2070 726f 746f 636f 6c5b 226c  th = protocol["l
+0002ef80: 656e 6774 6822 5d0a 0a0a 2020 2020 2320  ength"]...    # 
+0002ef90: 2020 2020 7374 6172 745f 783d 2d6c 696e      start_x=-lin
+0002efa0: 655f 7061 7474 6572 6e5f 6c65 6e67 7468  e_pattern_length
+0002efb0: 2f32 200a 2020 2020 2320 2020 2020 7374  /2 .    #     st
+0002efc0: 6172 745f 793d 2b6c 696e 655f 7061 7474  art_y=+line_patt
+0002efd0: 6572 6e5f 6c65 6e67 7468 0a20 2020 2023  ern_length.    #
+0002efe0: 2020 2020 2065 6e64 5f78 3d2b 6c69 6e65       end_x=+line
+0002eff0: 5f70 6174 7465 726e 5f6c 656e 6774 682f  _pattern_length/
+0002f000: 320a 2020 2020 2320 2020 2020 656e 645f  2.    #     end_
+0002f010: 793d 2b6c 696e 655f 7061 7474 6572 6e5f  y=+line_pattern_
+0002f020: 6c65 6e67 7468 0a20 2020 2023 2020 2020  length.    #    
+0002f030: 2064 6570 7468 3d32 652d 360a 0a20 2020   depth=2e-6..   
+0002f040: 2023 2020 2020 2073 656c 662e 6769 735f   #     self.gis_
+0002f050: 6c61 7965 722e 6164 644c 696e 6528 0a20  layer.addLine(. 
+0002f060: 2020 2023 2020 2020 2020 2020 2042 6567     #         Beg
+0002f070: 696e 583d 7374 6172 745f 782c 0a20 2020  inX=start_x,.   
+0002f080: 2023 2020 2020 2020 2020 2042 6567 696e   #         Begin
+0002f090: 593d 7374 6172 745f 792c 0a20 2020 2023  Y=start_y,.    #
+0002f0a0: 2020 2020 2020 2020 2045 6e64 583d 656e           EndX=en
+0002f0b0: 645f 782c 0a20 2020 2023 2020 2020 2020  d_x,.    #      
+0002f0c0: 2020 2045 6e64 593d 656e 645f 792c 0a20     EndY=end_y,. 
+0002f0d0: 2020 2023 2020 2020 2020 2020 2044 6570     #         Dep
+0002f0e0: 7468 3d33 652d 3036 2c0a 0a20 2020 2023  th=3e-06,..    #
+0002f0f0: 2020 2020 2029 0a0a 2020 2020 2320 2020       )..    #   
+0002f100: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002f110: 6e2e 4472 6177 4265 616d 2e4c 6f61 644c  n.DrawBeam.LoadL
+0002f120: 6179 6572 2873 656c 662e 6769 735f 6c61  ayer(self.gis_la
+0002f130: 7965 7229 0a20 2020 2023 2020 2020 206c  yer).    #     l
+0002f140: 6f67 6769 6e67 2e69 6e66 6f28 6622 4749  ogging.info(f"GI
+0002f150: 5320 5061 7474 6572 6e20 5365 7475 7020  S Pattern Setup 
+0002f160: 436f 6d70 6c65 7465 2229 0a0a 2020 2020  Complete")..    
+0002f170: 2320 6465 6620 7275 6e5f 4749 5328 7365  # def run_GIS(se
+0002f180: 6c66 2c70 726f 746f 636f 6c29 202d 3e20  lf,protocol) -> 
+0002f190: 4e6f 6e65 3a0a 0a0a 2020 2020 2320 2020  None:...    #   
+0002f1a0: 2020 6761 735f 6c69 6e65 203d 2073 656c    gas_line = sel
+0002f1b0: 662e 6c69 6e65 735b 7072 6f74 6f63 6f6c  f.lines[protocol
+0002f1c0: 5b27 6761 7327 5d5d 0a0a 2020 2020 2320  ['gas']]..    # 
+0002f1d0: 2020 2020 7472 793a 0a0a 2020 2020 2320      try:..    # 
+0002f1e0: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+0002f1f0: 6e65 6374 696f 6e2e 4749 532e 4f70 656e  nection.GIS.Open
+0002f200: 5661 6c76 6528 6761 735f 6c69 6e65 290a  Valve(gas_line).
+0002f210: 0a20 2020 2023 2020 2020 2065 7863 6570  .    #     excep
+0002f220: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+0002f230: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
+0002f240: 6966 2065 2e61 7267 735b 305d 203d 3d20  if e.args[0] == 
+0002f250: 2745 7272 6f72 2e4f 7574 6761 7352 6571  'Error.OutgasReq
+0002f260: 7569 7265 6427 3a0a 2020 2020 2320 2020  uired':.    #   
+0002f270: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+0002f280: 672e 696e 666f 2822 4f75 7467 6173 7369  g.info("Outgassi
+0002f290: 6e67 2072 6571 7569 7265 642e 2229 0a20  ng required."). 
+0002f2a0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+0002f2b0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0002f2c0: 4f75 7467 6173 7369 6e67 207b 7072 6f74  Outgassing {prot
+0002f2d0: 6f63 6f6c 5b27 6761 7327 5d7d 204c 696e  ocol['gas']} Lin
+0002f2e0: 6522 290a 2020 2020 2320 2020 2020 2020  e").    #       
+0002f2f0: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+0002f300: 6374 696f 6e2e 4749 532e 4f75 7467 6173  ction.GIS.Outgas
+0002f310: 2867 6173 5f6c 696e 6529 0a20 2020 2023  (gas_line).    #
+0002f320: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0002f330: 662e 636f 6e6e 6563 7469 6f6e 2e47 4953  f.connection.GIS
+0002f340: 2e4f 7065 6e56 616c 7665 2867 6173 5f6c  .OpenValve(gas_l
+0002f350: 696e 6529 0a0a 2020 2020 2320 2020 2020  ine)..    #     
+0002f360: 7661 6c76 655f 6f70 656e 203d 2073 656c  valve_open = sel
+0002f370: 662e 636f 6e6e 6563 7469 6f6e 2e47 4953  f.connection.GIS
+0002f380: 2e47 6574 5661 6c76 6553 7461 7475 7328  .GetValveStatus(
+0002f390: 6761 735f 6c69 6e65 290a 0a20 2020 2023  gas_line)..    #
+0002f3a0: 2020 2020 2074 7279 3a0a 2020 2020 2320       try:.    # 
+0002f3b0: 2020 2020 2020 2020 2320 5275 6e20 7072          # Run pr
+0002f3c0: 6564 6566 696e 6564 2064 6570 6f73 6974  edefined deposit
+0002f3d0: 696f 6e20 7072 6f63 6573 730a 2020 2020  ion process.    
+0002f3e0: 2320 2020 2020 2020 2020 7365 6c66 2e63  #         self.c
+0002f3f0: 6f6e 6e65 6374 696f 6e2e 4472 6177 4265  onnection.DrawBe
+0002f400: 616d 2e53 7461 7274 2829 0a20 2020 2023  am.Start().    #
+0002f410: 2020 2020 2020 2020 2073 656c 662e 636f           self.co
+0002f420: 6e6e 6563 7469 6f6e 2e50 726f 6772 6573  nnection.Progres
+0002f430: 732e 5368 6f77 2822 4472 6177 4265 616d  s.Show("DrawBeam
+0002f440: 222c 2022 4c61 7965 7220 3120 696e 2070  ", "Layer 1 in p
+0002f450: 726f 6772 6573 7322 2c20 4661 6c73 652c  rogress", False,
+0002f460: 2046 616c 7365 2c20 302c 2031 3030 290a   False, 0, 100).
+0002f470: 2020 2020 2320 2020 2020 2020 2020 6c6f      #         lo
+0002f480: 6767 696e 672e 696e 666f 2822 5370 7574  gging.info("Sput
+0002f490: 7465 7269 6e67 2073 7461 7274 6564 2e22  tering started."
+0002f4a0: 290a 2020 2020 2320 2020 2020 2020 2020  ).    #         
+0002f4b0: 7768 696c 6520 5472 7565 3a0a 2020 2020  while True:.    
+0002f4c0: 2320 2020 2020 2020 2020 2020 2020 7374  #             st
+0002f4d0: 6174 7573 203d 2073 656c 662e 636f 6e6e  atus = self.conn
+0002f4e0: 6563 7469 6f6e 2e44 7261 7742 6561 6d2e  ection.DrawBeam.
+0002f4f0: 4765 7453 7461 7475 7328 290a 2020 2020  GetStatus().    
+0002f500: 2320 2020 2020 2020 2020 2020 2020 7275  #             ru
+0002f510: 6e6e 696e 6720 3d20 7374 6174 7573 5b30  nning = status[0
+0002f520: 5d20 3d3d 2073 656c 662e 636f 6e6e 6563  ] == self.connec
+0002f530: 7469 6f6e 2e44 7261 7742 6561 6d2e 5374  tion.DrawBeam.St
+0002f540: 6174 7573 2e50 726f 6a65 6374 4c6f 6164  atus.ProjectLoad
+0002f550: 6564 4578 706f 7369 7469 6f6e 496e 5072  edExpositionInPr
+0002f560: 6f67 7265 7373 0a20 2020 2023 2020 2020  ogress.    #    
+0002f570: 2020 2020 2020 2020 2069 6620 7275 6e6e           if runn
+0002f580: 696e 673a 0a20 2020 2023 2020 2020 2020  ing:.    #      
+0002f590: 2020 2020 2020 2020 2020 2070 726f 6772             progr
+0002f5a0: 6573 7320 3d20 300a 2020 2020 2320 2020  ess = 0.    #   
+0002f5b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002f5c0: 2073 7461 7475 735b 315d 203e 2030 3a0a   status[1] > 0:.
+0002f5d0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+0002f5e0: 2020 2020 2020 2020 2020 7072 6f67 7265            progre
+0002f5f0: 7373 203d 206d 696e 2831 3030 2c20 7374  ss = min(100, st
+0002f600: 6174 7573 5b32 5d20 2f20 7374 6174 7573  atus[2] / status
+0002f610: 5b31 5d20 2a20 3130 3029 0a20 2020 2023  [1] * 100).    #
+0002f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f630: 2070 7269 6e74 5072 6f67 7265 7373 4261   printProgressBa
+0002f640: 7228 7072 6f67 7265 7373 2c20 3130 3029  r(progress, 100)
+0002f650: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
+0002f660: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+0002f670: 6563 7469 6f6e 2e50 726f 6772 6573 732e  ection.Progress.
+0002f680: 5365 7450 6572 6365 6e74 7328 7072 6f67  SetPercents(prog
+0002f690: 7265 7373 290a 2020 2020 2320 2020 2020  ress).    #     
+0002f6a0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+0002f6b0: 2e73 6c65 6570 2831 290a 2020 2020 2320  .sleep(1).    # 
+0002f6c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002f6d0: 3a0a 2020 2020 2320 2020 2020 2020 2020  :.    #         
+0002f6e0: 2020 2020 2020 2020 6966 2073 7461 7475          if statu
+0002f6f0: 735b 305d 203d 3d20 7365 6c66 2e63 6f6e  s[0] == self.con
+0002f700: 6e65 6374 696f 6e2e 4472 6177 4265 616d  nection.DrawBeam
+0002f710: 2e53 7461 7475 732e 5072 6f6a 6563 744c  .Status.ProjectL
+0002f720: 6f61 6465 6445 7870 6f73 6974 696f 6e49  oadedExpositionI
+0002f730: 646c 653a 0a20 2020 2023 2020 2020 2020  dle:.    #      
+0002f740: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0002f750: 7269 6e74 5072 6f67 7265 7373 4261 7228  rintProgressBar(
+0002f760: 3130 302c 2031 3030 2c20 7375 6666 6978  100, 100, suffix
+0002f770: 3d27 4669 6e69 7368 6564 2729 0a20 2020  ='Finished').   
+0002f780: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+0002f790: 2020 2020 2020 2070 7269 6e74 2827 2729         print('')
+0002f7a0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
+0002f7b0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
+0002f7c0: 2023 2020 2020 2066 696e 616c 6c79 3a0a   #     finally:.
+0002f7d0: 2020 2020 2320 2020 2020 2020 2020 2320      #         # 
+0002f7e0: 436c 6f73 6520 4749 5320 5661 6c76 6520  Close GIS Valve 
+0002f7f0: 696e 2062 6f74 6820 2d20 7375 6363 6573  in both - succes
+0002f800: 7320 616e 6420 6661 696c 7572 650a 2020  s and failure.  
+0002f810: 2020 2320 2020 2020 2020 2020 6966 2076    #         if v
+0002f820: 616c 7665 5f6f 7065 6e3a 0a20 2020 2023  alve_open:.    #
+0002f830: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0002f840: 662e 636f 6e6e 6563 7469 6f6e 2e47 4953  f.connection.GIS
+0002f850: 2e43 6c6f 7365 5661 6c76 6528 6761 735f  .CloseValve(gas_
+0002f860: 6c69 6e65 290a 0a20 2020 2023 2020 2020  line)..    #    
+0002f870: 2073 656c 662e 636f 6e6e 6563 7469 6f6e   self.connection
+0002f880: 2e47 4953 2e4d 6f76 6554 6f28 6761 735f  .GIS.MoveTo(gas_
+0002f890: 6c69 6e65 2c20 4175 746f 6d61 7469 6f6e  line, Automation
+0002f8a0: 2e47 4953 2e50 6f73 6974 696f 6e2e 486f  .GIS.Position.Ho
+0002f8b0: 6d65 290a 2020 2020 2320 2020 2020 2320  me).    #     # 
+0002f8c0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+0002f8d0: 4749 532e 5072 6570 6172 6554 656d 7065  GIS.PrepareTempe
+0002f8e0: 7261 7475 7265 2867 6173 5f6c 696e 652c  rature(gas_line,
+0002f8f0: 2046 616c 7365 290a 2020 2020 2320 2020   False).    #   
+0002f900: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002f910: 6e2e 4472 6177 4265 616d 2e55 6e6c 6f61  n.DrawBeam.Unloa
+0002f920: 644c 6179 6572 2829 0a20 2020 2023 2020  dLayer().    #  
+0002f930: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0002f940: 2270 726f 6365 7373 2063 6f6d 706c 6574  "process complet
+0002f950: 6564 2e22 290a 0a0a 2020 2020 2320 6465  ed.")...    # de
+0002f960: 6620 4749 535f 6176 6169 6c61 626c 655f  f GIS_available_
+0002f970: 6c69 6e65 7328 7365 6c66 2920 2d3e 206c  lines(self) -> l
+0002f980: 6973 745b 7374 725d 3a0a 2020 2020 2320  ist[str]:.    # 
+0002f990: 2020 2020 2222 220a 2020 2020 2320 2020      """.    #   
+0002f9a0: 2020 5265 7475 726e 7320 6120 6c69 7374    Returns a list
+0002f9b0: 206f 6620 6176 6169 6c61 626c 6520 4749   of available GI
+0002f9c0: 5320 6c69 6e65 732e 0a20 2020 2023 2020  S lines..    #  
+0002f9d0: 2020 2041 7267 733a 0a20 2020 2023 2020     Args:.    #  
+0002f9e0: 2020 2020 2020 204e 6f6e 650a 2020 2020         None.    
+0002f9f0: 2320 2020 2020 5265 7475 726e 733a 0a20  #     Returns:. 
+0002fa00: 2020 2023 2020 2020 2020 2020 2041 2064     #         A d
+0002fa10: 6963 7469 6f6e 6172 7920 6f66 2061 7661  ictionary of ava
+0002fa20: 696c 6162 6c65 2047 4953 206c 696e 6573  ilable GIS lines
+0002fa30: 2e0a 2020 2020 2320 2020 2020 2222 220a  ..    #     """.
+0002fa40: 2020 2020 2320 2020 2020 5f63 6865 636b      #     _check
+0002fa50: 5f73 7075 7474 6572 2873 656c 662e 7379  _sputter(self.sy
+0002fa60: 7374 656d 290a 2020 2020 2320 2020 2020  stem).    #     
+0002fa70: 4749 535f 6c69 6e65 7320 3d20 7365 6c66  GIS_lines = self
+0002fa80: 2e63 6f6e 6e65 6374 696f 6e2e 4749 532e  .connection.GIS.
+0002fa90: 456e 756d 2829 0a20 2020 2023 2020 2020  Enum().    #    
+0002faa0: 2073 656c 662e 6c69 6e65 7320 3d20 7b7d   self.lines = {}
+0002fab0: 0a20 2020 2023 2020 2020 206c 696e 655f  .    #     line_
+0002fac0: 6e61 6d65 7320 3d20 5b5d 0a20 2020 2023  names = [].    #
+0002fad0: 2020 2020 2066 6f72 206c 696e 6520 696e       for line in
+0002fae0: 2047 4953 5f6c 696e 6573 3a0a 2020 2020   GIS_lines:.    
+0002faf0: 2320 2020 2020 2020 2020 7365 6c66 2e6c  #         self.l
+0002fb00: 696e 6573 5b6c 696e 652e 6e61 6d65 5d20  ines[line.name] 
+0002fb10: 3d20 6c69 6e65 0a20 2020 2023 2020 2020  = line.    #    
+0002fb20: 2020 2020 206c 696e 655f 6e61 6d65 732e       line_names.
+0002fb30: 6170 7065 6e64 286c 696e 652e 6e61 6d65  append(line.name
+0002fb40: 290a 0a20 2020 2023 2020 2020 2072 6574  )..    #     ret
+0002fb50: 7572 6e20 6c69 6e65 5f6e 616d 6573 0a0a  urn line_names..
+0002fb60: 2020 2020 2320 6465 6620 4749 535f 706f      # def GIS_po
+0002fb70: 7369 7469 6f6e 2873 656c 662c 6c69 6e65  sition(self,line
+0002fb80: 5f6e 616d 653a 7374 7229 202d 3e20 7374  _name:str) -> st
+0002fb90: 723a 0a20 2020 2023 2020 2020 205f 6368  r:.    #     _ch
+0002fba0: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+0002fbb0: 2e73 7973 7465 6d29 0a0a 2020 2020 2320  .system)..    # 
+0002fbc0: 2020 2020 6c69 6e65 203d 2073 656c 662e      line = self.
+0002fbd0: 6c69 6e65 735b 6c69 6e65 5f6e 616d 655d  lines[line_name]
+0002fbe0: 0a0a 2020 2020 2320 2020 2020 706f 7369  ..    #     posi
+0002fbf0: 7469 6f6e 203d 2073 656c 662e 636f 6e6e  tion = self.conn
+0002fc00: 6563 7469 6f6e 2e47 4953 2e47 6574 506f  ection.GIS.GetPo
+0002fc10: 7369 7469 6f6e 286c 696e 6529 0a0a 2020  sition(line)..  
+0002fc20: 2020 2320 2020 2020 7265 7475 726e 2070    #     return p
+0002fc30: 6f73 6974 696f 6e2e 6e61 6d65 0a0a 2020  osition.name..  
+0002fc40: 2020 2320 6465 6620 4749 535f 6176 6169    # def GIS_avai
+0002fc50: 6c61 626c 655f 706f 7369 7469 6f6e 7328  lable_positions(
+0002fc60: 7365 6c66 2920 2d3e 206c 6973 745b 7374  self) -> list[st
+0002fc70: 725d 3a0a 0a20 2020 2023 2020 2020 205f  r]:..    #     _
+0002fc80: 6368 6563 6b5f 7370 7574 7465 7228 7365  check_sputter(se
+0002fc90: 6c66 2e73 7973 7465 6d29 0a20 2020 2023  lf.system).    #
+0002fca0: 2020 2020 2073 656c 662e 4749 535f 706f       self.GIS_po
+0002fcb0: 7369 7469 6f6e 7320 3d20 7365 6c66 2e63  sitions = self.c
+0002fcc0: 6f6e 6e65 6374 696f 6e2e 4749 532e 506f  onnection.GIS.Po
+0002fcd0: 7369 7469 6f6e 0a0a 2020 2020 2320 2020  sition..    #   
+0002fce0: 2020 7265 7475 726e 2073 656c 662e 4749    return self.GI
+0002fcf0: 535f 706f 7369 7469 6f6e 732e 5f5f 6d65  S_positions.__me
+0002fd00: 6d62 6572 735f 5f2e 6b65 7973 2829 0a0a  mbers__.keys()..
+0002fd10: 2020 2020 2320 6465 6620 4749 535f 6d6f      # def GIS_mo
+0002fd20: 7665 5f74 6f28 7365 6c66 2c6c 696e 655f  ve_to(self,line_
+0002fd30: 6e61 6d65 2c70 6f73 6974 696f 6e29 202d  name,position) -
+0002fd40: 3e20 4e6f 6e65 3a0a 0a20 2020 2023 2020  > None:..    #  
+0002fd50: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
+0002fd60: 7228 7365 6c66 2e73 7973 7465 6d29 0a0a  r(self.system)..
+0002fd70: 2020 2020 2320 2020 2020 6c69 6e65 203d      #     line =
+0002fd80: 2073 656c 662e 6c69 6e65 735b 6c69 6e65   self.lines[line
+0002fd90: 5f6e 616d 655d 0a0a 2020 2020 2320 2020  _name]..    #   
+0002fda0: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002fdb0: 6e2e 4749 532e 4d6f 7665 546f 286c 696e  n.GIS.MoveTo(lin
+0002fdc0: 652c 7365 6c66 2e47 4953 5f70 6f73 6974  e,self.GIS_posit
+0002fdd0: 696f 6e73 5b70 6f73 6974 696f 6e5d 290a  ions[position]).
+0002fde0: 0a20 2020 2023 2064 6566 2047 4953 5f68  .    # def GIS_h
+0002fdf0: 6561 745f 7570 2873 656c 662c 6c69 6e65  eat_up(self,line
+0002fe00: 5f6e 616d 6529 3a0a 0a20 2020 2023 2020  _name):..    #  
+0002fe10: 2020 205f 6368 6563 6b5f 7370 7574 7465     _check_sputte
+0002fe20: 7228 7365 6c66 2e73 7973 7465 6d29 0a0a  r(self.system)..
+0002fe30: 2020 2020 2320 2020 2020 6c69 6e65 203d      #     line =
+0002fe40: 2073 656c 662e 6c69 6e65 735b 6c69 6e65   self.lines[line
+0002fe50: 5f6e 616d 655d 0a0a 2020 2020 2320 2020  _name]..    #   
+0002fe60: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+0002fe70: 6e2e 4749 532e 5072 6570 6172 6554 656d  n.GIS.PrepareTem
+0002fe80: 7065 7261 7475 7265 286c 696e 652c 5472  perature(line,Tr
+0002fe90: 7565 290a 0a20 2020 2023 2020 2020 2073  ue)..    #     s
+0002fea0: 656c 662e 636f 6e6e 6563 7469 6f6e 2e47  elf.connection.G
+0002feb0: 4953 2e57 6169 7446 6f72 5465 6d70 6572  IS.WaitForTemper
+0002fec0: 6174 7572 6552 6561 6479 286c 696e 6529  atureReady(line)
+0002fed0: 0a0a 2020 2020 2320 2020 2020 7469 6d65  ..    #     time
+0002fee0: 2e73 6c65 6570 2835 290a 0a20 2020 2023  .sleep(5)..    #
+0002fef0: 2064 6566 2047 4953 5f74 656d 705f 7265   def GIS_temp_re
+0002ff00: 6164 7928 7365 6c66 2c6c 696e 655f 6e61  ady(self,line_na
+0002ff10: 6d65 293a 0a0a 2020 2020 2320 2020 2020  me):..    #     
+0002ff20: 5f63 6865 636b 5f73 7075 7474 6572 2873  _check_sputter(s
+0002ff30: 656c 662e 7379 7374 656d 290a 0a20 2020  elf.system)..   
+0002ff40: 2023 2020 2020 206c 696e 6520 3d20 7365   #     line = se
+0002ff50: 6c66 2e6c 696e 6573 5b6c 696e 655f 6e61  lf.lines[line_na
+0002ff60: 6d65 5d0a 0a20 2020 2023 2020 2020 2072  me]..    #     r
+0002ff70: 6574 7572 6e20 7365 6c66 2e63 6f6e 6e65  eturn self.conne
+0002ff80: 6374 696f 6e2e 4749 532e 4765 7454 656d  ction.GIS.GetTem
+0002ff90: 7065 7261 7475 7265 5265 6164 7928 6c69  peratureReady(li
+0002ffa0: 6e65 290a 0a20 2020 2064 6566 2073 6574  ne)..    def set
+0002ffb0: 5f6d 6963 726f 7363 6f70 655f 7374 6174  _microscope_stat
+0002ffc0: 6528 7365 6c66 2c20 6d69 6372 6f73 636f  e(self, microsco
+0002ffd0: 7065 5f73 7461 7465 3a20 4d69 6372 6f73  pe_state: Micros
+0002ffe0: 636f 7065 5374 6174 6529 3a0a 2020 2020  copeState):.    
+0002fff0: 2020 2020 2222 2252 6573 6574 2074 6865      """Reset the
+00030000: 206d 6963 726f 7363 6f70 6520 7374 6174   microscope stat
+00030010: 6520 746f 2074 6865 2070 726f 7669 6465  e to the provide
+00030020: 6420 7374 6174 652e 0a0a 2020 2020 2020  d state...      
+00030030: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00030040: 2020 2020 6d69 6372 6f73 636f 7065 5f73      microscope_s
+00030050: 7461 7465 2028 4d69 6372 6f73 636f 7065  tate (Microscope
+00030060: 5374 6174 6529 3a20 4120 604d 6963 726f  State): A `Micro
+00030070: 7363 6f70 6553 7461 7465 6020 6f62 6a65  scopeState` obje
+00030080: 6374 2074 6861 7420 636f 6e74 6169 6e73  ct that contains
+00030090: 2074 6865 2064 6573 6972 6564 2073 7461   the desired sta
+000300a0: 7465 206f 6620 7468 6520 6d69 6372 6f73  te of the micros
+000300b0: 636f 7065 2e0a 0a20 2020 2020 2020 2052  cope...        R
+000300c0: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+000300d0: 2020 2020 4e6f 6e65 2e0a 0a20 2020 2020      None...     
+000300e0: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
+000300f0: 2020 2020 2020 204e 6f6e 652e 0a0a 2020         None...  
+00030100: 2020 2020 2020 4e6f 7465 733a 0a20 2020        Notes:.   
+00030110: 2020 2020 2020 2020 2054 6869 7320 6675           This fu
+00030120: 6e63 7469 6f6e 2072 6573 746f 7265 7320  nction restores 
+00030130: 7468 6520 6d69 6372 6f73 636f 7065 2073  the microscope s
+00030140: 7461 7465 2074 6f20 7468 6520 7072 6f76  tate to the prov
+00030150: 6964 6564 2073 7461 7465 2e20 5468 6973  ided state. This
+00030160: 2066 756e 6374 696f 6e20 6361 6e6e 6f74   function cannot
+00030170: 2062 6520 6675 6c6c 7920 696d 706c 656d   be fully implem
+00030180: 656e 7465 6420 6173 2074 6865 6972 2061  ented as their a
+00030190: 7265 2063 6572 7461 696e 2061 7370 6563  re certain aspec
+000301a0: 7473 206f 660a 2020 2020 2020 2020 2020  ts of.          
+000301b0: 2020 7468 6520 7374 6174 6520 7468 6174    the state that
+000301c0: 2063 616e 6e6f 7420 6265 2073 6574 2066   cannot be set f
+000301d0: 6f72 2074 6865 2054 4553 4341 4e20 6d69  or the TESCAN mi
+000301e0: 6372 6f73 636f 7065 2062 7920 7468 6520  croscope by the 
+000301f0: 5445 5343 414e 2041 7574 6f6d 6174 696f  TESCAN Automatio
+00030200: 6e20 4150 492e 0a20 2020 2020 2020 2022  n API..        "
+00030210: 2222 0a0a 2020 2020 2020 2020 6c6f 6767  ""..        logg
+00030220: 696e 672e 696e 666f 2866 2272 6573 746f  ing.info(f"resto
+00030230: 7269 6e67 206d 6963 726f 7363 6f70 6520  ring microscope 
+00030240: 7374 6174 652e 2e2e 2229 0a0a 2020 2020  state...")..    
+00030250: 2020 2020 2320 7265 7374 6f72 6520 656c      # restore el
+00030260: 6563 7472 6f6e 2062 6561 6d0a 2020 2020  ectron beam.    
+00030270: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+00030280: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00030290: 4e2c 2073 656c 662e 7379 7374 656d 290a  N, self.system).
+000302a0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000302b0: 696e 666f 2866 2272 6573 746f 7269 6e67  info(f"restoring
+000302c0: 2065 6c65 6374 726f 6e20 6265 616d 2073   electron beam s
+000302d0: 6574 7469 6e67 732e 2e2e 2229 0a20 2020  ettings...").   
+000302e0: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
+000302f0: 7469 6f6e 2e53 454d 2e4f 7074 6963 732e  tion.SEM.Optics.
+00030300: 5365 7457 4428 0a20 2020 2020 2020 2020  SetWD(.         
+00030310: 2020 206d 6963 726f 7363 6f70 655f 7374     microscope_st
+00030320: 6174 652e 656c 6563 7472 6f6e 5f62 6561  ate.electron_bea
+00030330: 6d2e 776f 726b 696e 675f 6469 7374 616e  m.working_distan
+00030340: 6365 0a20 2020 2020 2020 2020 2020 202a  ce.            *
+00030350: 2063 6f6e 7374 616e 7473 2e4d 4554 5245   constants.METRE
+00030360: 5f54 4f5f 4d49 4c4c 494d 4554 5245 0a20  _TO_MILLIMETRE. 
+00030370: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00030380: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
+00030390: 6e2e 5345 4d2e 4265 616d 2e53 6574 4375  n.SEM.Beam.SetCu
+000303a0: 7272 656e 7428 0a20 2020 2020 2020 2020  rrent(.         
+000303b0: 2020 206d 6963 726f 7363 6f70 655f 7374     microscope_st
+000303c0: 6174 652e 656c 6563 7472 6f6e 5f62 6561  ate.electron_bea
+000303d0: 6d2e 6265 616d 5f63 7572 7265 6e74 202a  m.beam_current *
+000303e0: 2063 6f6e 7374 616e 7473 2e53 495f 544f   constants.SI_TO
+000303f0: 5f50 4943 4f0a 2020 2020 2020 2020 290a  _PICO.        ).
+00030400: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00030410: 6e6e 6563 7469 6f6e 2e53 454d 2e4f 7074  nnection.SEM.Opt
+00030420: 6963 732e 5365 7456 6965 7766 6965 6c64  ics.SetViewfield
+00030430: 280a 2020 2020 2020 2020 2020 2020 6d69  (.            mi
+00030440: 6372 6f73 636f 7065 5f73 7461 7465 2e65  croscope_state.e
+00030450: 6c65 6374 726f 6e5f 6265 616d 2e68 6677  lectron_beam.hfw
+00030460: 202a 2063 6f6e 7374 616e 7473 2e4d 4554   * constants.MET
+00030470: 5245 5f54 4f5f 4d49 4c4c 494d 4554 5245  RE_TO_MILLIMETRE
+00030480: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00030490: 2020 2020 6966 206d 6963 726f 7363 6f70      if microscop
+000304a0: 655f 7374 6174 652e 656c 6563 7472 6f6e  e_state.electron
+000304b0: 5f62 6561 6d2e 7368 6966 7420 6973 206e  _beam.shift is n
+000304c0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000304d0: 2020 2020 2070 7269 6e74 286d 6963 726f       print(micro
+000304e0: 7363 6f70 655f 7374 6174 652e 656c 6563  scope_state.elec
+000304f0: 7472 6f6e 5f62 6561 6d2e 7368 6966 742e  tron_beam.shift.
+00030500: 782c 206d 6963 726f 7363 6f70 655f 7374  x, microscope_st
+00030510: 6174 652e 656c 6563 7472 6f6e 5f62 6561  ate.electron_bea
+00030520: 6d2e 7368 6966 742e 7929 0a20 2020 2020  m.shift.y).     
+00030530: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
+00030540: 6563 7469 6f6e 2e53 454d 2e4f 7074 6963  ection.SEM.Optic
+00030550: 732e 5365 7449 6d61 6765 5368 6966 7428  s.SetImageShift(
+00030560: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+00030570: 2e65 6c65 6374 726f 6e5f 6265 616d 2e73  .electron_beam.s
+00030580: 6869 6674 2e78 2c20 6d69 6372 6f73 636f  hift.x, microsco
+00030590: 7065 5f73 7461 7465 2e65 6c65 6374 726f  pe_state.electro
+000305a0: 6e5f 6265 616d 2e73 6869 6674 2e79 290a  n_beam.shift.y).
+000305b0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+000305c0: 2e73 6c65 6570 2831 290a 2020 2020 2020  .sleep(1).      
+000305d0: 2020 6966 206d 6963 726f 7363 6f70 655f    if microscope_
+000305e0: 7374 6174 652e 656c 6563 7472 6f6e 5f62  state.electron_b
+000305f0: 6561 6d2e 7363 616e 5f72 6f74 6174 696f  eam.scan_rotatio
+00030600: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
+00030610: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00030620: 636f 6e6e 6563 7469 6f6e 2e53 454d 2e4f  connection.SEM.O
+00030630: 7074 6963 732e 5365 7449 6d61 6765 526f  ptics.SetImageRo
+00030640: 7461 7469 6f6e 286d 6963 726f 7363 6f70  tation(microscop
+00030650: 655f 7374 6174 652e 656c 6563 7472 6f6e  e_state.electron
+00030660: 5f62 6561 6d2e 7363 616e 5f72 6f74 6174  _beam.scan_rotat
+00030670: 696f 6e29 0a20 2020 2020 2020 2023 206d  ion).        # m
+00030680: 6963 726f 7363 6f70 652e 6265 616d 732e  icroscope.beams.
+00030690: 656c 6563 7472 6f6e 5f62 6561 6d2e 7374  electron_beam.st
+000306a0: 6967 6d61 746f 722e 7661 6c75 6520 3d20  igmator.value = 
+000306b0: 280a 2020 2020 2020 2020 2320 2020 2020  (.        #     
+000306c0: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+000306d0: 2e65 6c65 6374 726f 6e5f 6265 616d 2e73  .electron_beam.s
+000306e0: 7469 676d 6174 696f 6e0a 2020 2020 2020  tigmation.      
+000306f0: 2020 2320 290a 2020 2020 2020 2020 7365    # ).        se
+00030700: 6c66 2e73 6574 5f64 6574 6563 746f 725f  lf.set_detector_
+00030710: 7365 7474 696e 6773 286d 6963 726f 7363  settings(microsc
+00030720: 6f70 655f 7374 6174 652e 656c 6563 7472  ope_state.electr
+00030730: 6f6e 5f64 6574 6563 746f 722c 2042 6561  on_detector, Bea
+00030740: 6d54 7970 652e 454c 4543 5452 4f4e 290a  mType.ELECTRON).
+00030750: 2020 2020 2020 2020 2320 7265 7374 6f72          # restor
+00030760: 6520 696f 6e20 6265 616d 0a20 2020 2020  e ion beam.     
+00030770: 2020 205f 6368 6563 6b5f 6265 616d 2842     _check_beam(B
+00030780: 6561 6d54 7970 652e 494f 4e2c 2073 656c  eamType.ION, sel
+00030790: 662e 7379 7374 656d 290a 2020 2020 2020  f.system).      
+000307a0: 2020 6c6f 6767 696e 672e 696e 666f 2866    logging.info(f
+000307b0: 2272 6573 746f 7269 6e67 2069 6f6e 2062  "restoring ion b
+000307c0: 6561 6d20 7365 7474 696e 6773 2e2e 2e22  eam settings..."
+000307d0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000307e0: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e4f  connection.FIB.O
+000307f0: 7074 6963 732e 5365 7456 6965 7766 6965  ptics.SetViewfie
+00030800: 6c64 280a 2020 2020 2020 2020 2020 2020  ld(.            
+00030810: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+00030820: 2e69 6f6e 5f62 6561 6d2e 6866 7720 2a20  .ion_beam.hfw * 
+00030830: 636f 6e73 7461 6e74 732e 4d45 5452 455f  constants.METRE_
+00030840: 544f 5f4d 494c 4c49 4d45 5452 450a 2020  TO_MILLIMETRE.  
+00030850: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00030860: 6966 206d 6963 726f 7363 6f70 655f 7374  if microscope_st
+00030870: 6174 652e 696f 6e5f 6265 616d 2e73 6869  ate.ion_beam.shi
+00030880: 6674 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ft is not None:.
+00030890: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000308a0: 2e63 6f6e 6e65 6374 696f 6e2e 4649 422e  .connection.FIB.
+000308b0: 4f70 7469 6373 2e53 6574 496d 6167 6553  Optics.SetImageS
+000308c0: 6869 6674 286d 6963 726f 7363 6f70 655f  hift(microscope_
+000308d0: 7374 6174 652e 656c 6563 7472 6f6e 5f62  state.electron_b
+000308e0: 6561 6d2e 7368 6966 742e 782c 206d 6963  eam.shift.x, mic
+000308f0: 726f 7363 6f70 655f 7374 6174 652e 656c  roscope_state.el
+00030900: 6563 7472 6f6e 5f62 6561 6d2e 7368 6966  ectron_beam.shif
+00030910: 742e 7929 0a20 2020 2020 2020 2020 2020  t.y).           
+00030920: 2074 696d 652e 736c 6565 7028 3129 0a20   time.sleep(1). 
+00030930: 2020 2020 2020 2069 6620 6d69 6372 6f73         if micros
+00030940: 636f 7065 5f73 7461 7465 2e65 6c65 6374  cope_state.elect
+00030950: 726f 6e5f 6265 616d 2e73 6361 6e5f 726f  ron_beam.scan_ro
+00030960: 7461 7469 6f6e 2069 7320 6e6f 7420 4e6f  tation is not No
+00030970: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00030980: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00030990: 4649 422e 4f70 7469 6373 2e53 6574 496d  FIB.Optics.SetIm
+000309a0: 6167 6552 6f74 6174 696f 6e28 6d69 6372  ageRotation(micr
+000309b0: 6f73 636f 7065 5f73 7461 7465 2e65 6c65  oscope_state.ele
+000309c0: 6374 726f 6e5f 6265 616d 2e73 6361 6e5f  ctron_beam.scan_
+000309d0: 726f 7461 7469 6f6e 290a 2020 2020 2020  rotation).      
+000309e0: 2020 2320 6d69 6372 6f73 636f 7065 2e62    # microscope.b
+000309f0: 6561 6d73 2e69 6f6e 5f62 6561 6d2e 7374  eams.ion_beam.st
+00030a00: 6967 6d61 746f 722e 7661 6c75 6520 3d20  igmator.value = 
+00030a10: 6d69 6372 6f73 636f 7065 5f73 7461 7465  microscope_state
+00030a20: 2e69 6f6e 5f62 6561 6d2e 7374 6967 6d61  .ion_beam.stigma
+00030a30: 7469 6f6e 0a20 2020 2020 2020 2073 656c  tion.        sel
+00030a40: 662e 7365 745f 6465 7465 6374 6f72 5f73  f.set_detector_s
+00030a50: 6574 7469 6e67 7328 6d69 6372 6f73 636f  ettings(microsco
+00030a60: 7065 5f73 7461 7465 2e69 6f6e 5f64 6574  pe_state.ion_det
+00030a70: 6563 746f 722c 2042 6561 6d54 7970 652e  ector, BeamType.
+00030a80: 494f 4e29 0a0a 2020 2020 2020 2020 7365  ION)..        se
+00030a90: 6c66 2e6d 6f76 655f 7374 6167 655f 6162  lf.move_stage_ab
+00030aa0: 736f 6c75 7465 286d 6963 726f 7363 6f70  solute(microscop
+00030ab0: 655f 7374 6174 652e 7374 6167 655f 706f  e_state.stage_po
+00030ac0: 7369 7469 6f6e 290a 2020 2020 2020 2020  sition).        
+00030ad0: 6c6f 6767 696e 672e 696e 666f 2866 226d  logging.info(f"m
+00030ae0: 6963 726f 7363 6f70 6520 7374 6174 6520  icroscope state 
+00030af0: 7265 7374 6f72 6564 2229 0a20 2020 2020  restored").     
+00030b00: 2020 2072 6574 7572 6e0a 0a20 2020 2064     return..    d
+00030b10: 6566 2067 6574 5f61 7661 696c 6162 6c65  ef get_available
+00030b20: 5f76 616c 7565 7328 7365 6c66 2c20 6b65  _values(self, ke
+00030b30: 793a 2073 7472 2c20 6265 616d 5f74 7970  y: str, beam_typ
+00030b40: 653a 2042 6561 6d54 7970 6520 3d20 4e6f  e: BeamType = No
+00030b50: 6e65 292d 3e20 6c69 7374 3a0a 2020 2020  ne)-> list:.    
+00030b60: 2020 2020 2222 2247 6574 2061 206c 6973      """Get a lis
+00030b70: 7420 6f66 2061 7661 696c 6162 6c65 2076  t of available v
+00030b80: 616c 7565 7320 666f 7220 6120 6769 7665  alues for a give
+00030b90: 6e20 6b65 792e 0a20 2020 2020 2020 204b  n key..        K
+00030ba0: 6579 733a 2070 6c61 736d 615f 6761 732c  eys: plasma_gas,
+00030bb0: 2063 7572 7265 6e74 2c20 6465 7465 6374   current, detect
+00030bc0: 6f72 5f74 7970 650a 2020 2020 2020 2020  or_type.        
+00030bd0: 2222 220a 2020 2020 2020 2020 7661 6c75  """.        valu
+00030be0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+00030bf0: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+00030c00: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+00030c10: 2020 2020 2020 2020 2020 6966 206b 6579            if key
+00030c20: 203d 3d20 2270 6c61 736d 615f 6761 7322   == "plasma_gas"
+00030c30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00030c40: 2020 7661 6c75 6573 203d 2073 656c 662e    values = self.
+00030c50: 636f 6e6e 6563 7469 6f6e 2e47 4953 2e45  connection.GIS.E
+00030c60: 6e75 6d28 290a 0a20 2020 2020 2020 2069  num()..        i
+00030c70: 6620 6b65 7920 3d3d 2022 6375 7272 656e  f key == "curren
+00030c80: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+00030c90: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+00030ca0: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00030cb0: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+00030cc0: 2020 2076 616c 7565 7320 3d20 5b31 2e30     values = [1.0
+00030cd0: 652d 3132 5d0a 2020 2020 2020 2020 2020  e-12].          
+00030ce0: 2020 6966 2062 6561 6d5f 7479 7065 203d    if beam_type =
+00030cf0: 3d20 4265 616d 5479 7065 2e49 4f4e 3a0a  = BeamType.ION:.
+00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d10: 7661 6c75 6573 203d 205b 3230 652d 3132  values = [20e-12
+00030d20: 2c20 3630 652d 3132 2c20 302e 3265 2d39  , 60e-12, 0.2e-9
+00030d30: 2c20 302e 3734 652d 392c 2032 2e30 652d  , 0.74e-9, 2.0e-
+00030d40: 392c 2037 2e36 652d 392c 2032 382e 3065  9, 7.6e-9, 28.0e
+00030d50: 2d39 2c20 3132 3065 2d39 5d0a 0a20 2020  -9, 120e-9]..   
+00030d60: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00030d70: 6465 7465 6374 6f72 5f74 7970 6522 2061  detector_type" a
+00030d80: 6e64 2062 6561 6d5f 7479 7065 203d 3d20  nd beam_type == 
+00030d90: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00030da0: 4e3a 0a20 2020 2020 2020 2020 2020 2076  N:.            v
+00030db0: 616c 7565 7320 3d20 7365 6c66 2e63 6f6e  alues = self.con
+00030dc0: 6e65 6374 696f 6e2e 5345 4d2e 4465 7465  nection.SEM.Dete
+00030dd0: 6374 6f72 2e45 6e75 6d28 290a 2020 2020  ctor.Enum().    
+00030de0: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+00030df0: 2072 616e 6765 286c 656e 2876 616c 7565   range(len(value
+00030e00: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
+00030e10: 2020 2020 2076 616c 7565 735b 692d 315d       values[i-1]
+00030e20: 203d 2076 616c 7565 735b 692d 315d 2e6e   = values[i-1].n
+00030e30: 616d 6520 0a20 2020 2020 2020 2069 6620  ame .        if 
+00030e40: 6b65 7920 3d3d 2022 6465 7465 6374 6f72  key == "detector
+00030e50: 5f74 7970 6522 2061 6e64 2062 6561 6d5f  _type" and beam_
+00030e60: 7479 7065 203d 3d20 4265 616d 5479 7065  type == BeamType
+00030e70: 2e49 4f4e 3a0a 2020 2020 2020 2020 2020  .ION:.          
+00030e80: 2020 7661 6c75 6573 203d 2073 656c 662e    values = self.
+00030e90: 636f 6e6e 6563 7469 6f6e 2e46 4942 2e44  connection.FIB.D
+00030ea0: 6574 6563 746f 722e 456e 756d 2829 0a20  etector.Enum(). 
+00030eb0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00030ec0: 2069 6e20 7261 6e67 6528 6c65 6e28 7661   in range(len(va
+00030ed0: 6c75 6573 2929 3a0a 2020 2020 2020 2020  lues)):.        
+00030ee0: 2020 2020 2020 2020 7661 6c75 6573 5b69          values[i
+00030ef0: 2d31 5d20 3d20 7661 6c75 6573 5b69 2d31  -1] = values[i-1
+00030f00: 5d2e 6e61 6d65 0a20 2020 2020 2020 200a  ].name.        .
+00030f10: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+00030f20: 3d20 2264 6574 6563 746f 725f 6d6f 6465  = "detector_mode
+00030f30: 223a 200a 2020 2020 2020 2020 2020 2020  ": .            
+00030f40: 7661 6c75 6573 203d 204e 6f6e 6520 0a0a  values = None ..
+00030f50: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+00030f60: 3d20 2270 7265 7365 7473 223a 0a20 2020  = "presets":.   
+00030f70: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00030f80: 7365 6c66 2e5f 6765 745f 7072 6573 6574  self._get_preset
+00030f90: 7328 290a 0a20 2020 2020 2020 2069 6620  s()..        if 
+00030fa0: 6b65 7920 3d3d 2022 7363 616e 5f64 6972  key == "scan_dir
+00030fb0: 6563 7469 6f6e 223a 0a20 2020 2020 2020  ection":.       
+00030fc0: 2020 2020 2076 616c 7565 7320 3d20 5b22       values = ["
+00030fd0: 466c 7962 6163 6b22 2c20 2252 4c45 222c  Flyback", "RLE",
+00030fe0: 2022 5370 6972 616c 496e 7369 6465 4f75   "SpiralInsideOu
+00030ff0: 7422 2c20 2253 7069 7261 6c4f 7574 7369  t", "SpiralOutsi
+00031000: 6465 496e 222c 2022 5a69 675a 6167 225d  deIn", "ZigZag"]
+00031010: 0a20 2020 2020 2020 2020 2020 200a 0a20  .            .. 
+00031020: 2020 2020 2020 2072 6574 7572 6e20 7661         return va
+00031030: 6c75 6573 0a0a 2020 200a 2020 2020 6465  lues..   .    de
+00031040: 6620 5f67 6574 2873 656c 662c 206b 6579  f _get(self, key
+00031050: 3a20 7374 722c 2062 6561 6d5f 7479 7065  : str, beam_type
+00031060: 3a20 4265 616d 5479 7065 203d 204e 6f6e  : BeamType = Non
+00031070: 6529 202d 3e20 556e 696f 6e5b 666c 6f61  e) -> Union[floa
+00031080: 742c 2073 7472 2c20 4e6f 6e65 5d3a 0a20  t, str, None]:. 
+00031090: 2020 2020 2020 2022 2222 4765 7420 6120         """Get a 
+000310a0: 7072 6f70 6572 7479 206f 6620 7468 6520  property of the 
+000310b0: 6d69 6372 6f73 636f 7065 2e22 2222 0a20  microscope.""". 
+000310c0: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
+000310d0: 7970 6520 6973 204e 6f6e 653a 0a20 2020  ype is None:.   
+000310e0: 2020 2020 2020 2020 2062 6561 6d20 3d20           beam = 
+000310f0: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e2e  self.connection.
+00031100: 5345 4d20 6966 2062 6561 6d5f 7479 7065  SEM if beam_type
+00031110: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
+00031120: 4354 524f 4e20 656c 7365 2073 656c 662e  CTRON else self.
+00031130: 636f 6e6e 6563 7469 6f6e 2e46 4942 0a20  connection.FIB. 
+00031140: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+00031150: 6b5f 6265 616d 2862 6561 6d5f 7479 7065  k_beam(beam_type
+00031160: 2c20 7365 6c66 2e73 7973 7465 6d29 0a20  , self.system). 
+00031170: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00031180: 2320 6265 616d 2070 726f 7065 7274 6965  # beam propertie
+00031190: 7320 0a20 2020 2020 2020 2069 6620 6b65  s .        if ke
+000311a0: 7920 3d3d 2022 6f6e 223a 200a 2020 2020  y == "on": .    
+000311b0: 2020 2020 2020 2020 7265 7475 726e 2062          return b
+000311c0: 6561 6d2e 4265 616d 2e47 6574 5374 6174  eam.Beam.GetStat
+000311d0: 7573 2829 0a20 2020 2020 2020 2069 6620  us().        if 
+000311e0: 6b65 7920 3d3d 2022 776f 726b 696e 675f  key == "working_
+000311f0: 6469 7374 616e 6365 2220 616e 6420 6265  distance" and be
+00031200: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+00031210: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
+00031220: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00031230: 2062 6561 6d2e 4f70 7469 6373 2e47 6574   beam.Optics.Get
+00031240: 5744 2829 202a 2063 6f6e 7374 616e 7473  WD() * constants
+00031250: 2e4d 494c 4c49 4d45 5452 455f 544f 5f4d  .MILLIMETRE_TO_M
+00031260: 4554 5245 0a20 2020 2020 2020 2069 6620  ETRE.        if 
+00031270: 6b65 7920 3d3d 2022 6375 7272 656e 7422  key == "current"
+00031280: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00031290: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
+000312a0: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
+000312b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000312c0: 2072 6574 7572 6e20 6265 616d 2e42 6561   return beam.Bea
+000312d0: 6d2e 4765 7443 7572 7265 6e74 2829 202a  m.GetCurrent() *
+000312e0: 2063 6f6e 7374 616e 7473 2e50 4943 4f5f   constants.PICO_
+000312f0: 544f 5f53 490a 2020 2020 2020 2020 2020  TO_SI.          
+00031300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00031310: 2020 2020 2020 2020 7265 7475 726e 2062          return b
+00031320: 6561 6d2e 4265 616d 2e52 6561 6450 726f  eam.Beam.ReadPro
+00031330: 6265 4375 7272 656e 7428 2920 2a20 636f  beCurrent() * co
+00031340: 6e73 7461 6e74 732e 5049 434f 5f54 4f5f  nstants.PICO_TO_
+00031350: 5349 0a20 2020 2020 2020 2069 6620 6b65  SI.        if ke
+00031360: 7920 3d3d 2022 766f 6c74 6167 6522 3a0a  y == "voltage":.
+00031370: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00031380: 726e 2062 6561 6d2e 4265 616d 2e47 6574  rn beam.Beam.Get
+00031390: 566f 6c74 6167 6528 2920 0a20 2020 2020  Voltage() .     
+000313a0: 2020 2069 6620 6b65 7920 3d3d 2022 6866     if key == "hf
+000313b0: 7722 3a0a 2020 2020 2020 2020 2020 2020  w":.            
+000313c0: 7265 7475 726e 2062 6561 6d2e 4f70 7469  return beam.Opti
+000313d0: 6373 2e47 6574 5669 6577 6669 656c 6428  cs.GetViewfield(
+000313e0: 2920 2a20 636f 6e73 7461 6e74 732e 4d49  ) * constants.MI
+000313f0: 4c4c 494d 4554 5245 5f54 4f5f 4d45 5452  LLIMETRE_TO_METR
+00031400: 450a 2020 2020 2020 2020 6966 206b 6579  E.        if key
+00031410: 203d 3d20 2272 6573 6f6c 7574 696f 6e22   == "resolution"
+00031420: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00031430: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
+00031440: 616d 5479 7065 2e45 4c45 4354 524f 4e20  amType.ELECTRON 
+00031450: 616e 6420 7365 6c66 2e6c 6173 745f 696d  and self.last_im
+00031460: 6167 655f 6562 2069 7320 6e6f 7420 4e6f  age_eb is not No
+00031470: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00031480: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00031490: 6c61 7374 5f69 6d61 6765 5f65 622e 6d65  last_image_eb.me
+000314a0: 7461 6461 7461 2e69 6d61 6765 5f73 6574  tadata.image_set
+000314b0: 7469 6e67 732e 7265 736f 6c75 7469 6f6e  tings.resolution
+000314c0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+000314d0: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
+000314e0: 6561 6d54 7970 652e 494f 4e20 616e 6420  eamType.ION and 
+000314f0: 7365 6c66 2e6c 6173 745f 696d 6167 655f  self.last_image_
+00031500: 6962 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ib is not None:.
+00031510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031520: 7265 7475 726e 2073 656c 662e 6c61 7374  return self.last
+00031530: 5f69 6d61 6765 5f69 622e 6d65 7461 6461  _image_ib.metada
+00031540: 7461 2e69 6d61 6765 5f73 6574 7469 6e67  ta.image_setting
+00031550: 732e 7265 736f 6c75 7469 6f6e 0a20 2020  s.resolution.   
+00031560: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00031570: 6477 656c 6c5f 7469 6d65 223a 0a20 2020  dwell_time":.   
+00031580: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
+00031590: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
+000315a0: 652e 454c 4543 5452 4f4e 2061 6e64 2073  e.ELECTRON and s
+000315b0: 656c 662e 6c61 7374 5f69 6d61 6765 5f65  elf.last_image_e
+000315c0: 6220 6973 206e 6f74 204e 6f6e 653a 0a20  b is not None:. 
+000315d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000315e0: 6574 7572 6e20 7365 6c66 2e6c 6173 745f  eturn self.last_
+000315f0: 696d 6167 655f 6562 2e6d 6574 6164 6174  image_eb.metadat
+00031600: 612e 696d 6167 655f 7365 7474 696e 6773  a.image_settings
+00031610: 2e64 7765 6c6c 5f74 696d 650a 2020 2020  .dwell_time.    
+00031620: 2020 2020 2020 2020 656c 6966 2062 6561          elif bea
+00031630: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+00031640: 7065 2e49 4f4e 2061 6e64 2073 656c 662e  pe.ION and self.
+00031650: 6c61 7374 5f69 6d61 6765 5f69 6220 6973  last_image_ib is
+00031660: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00031670: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00031680: 6e20 7365 6c66 2e6c 6173 745f 696d 6167  n self.last_imag
+00031690: 655f 6962 2e6d 6574 6164 6174 612e 696d  e_ib.metadata.im
+000316a0: 6167 655f 7365 7474 696e 6773 2e64 7765  age_settings.dwe
+000316b0: 6c6c 5f74 696d 6520 2020 0a20 2020 2020  ll_time   .     
+000316c0: 2020 2069 6620 6b65 7920 3d3d 2273 6361     if key =="sca
+000316d0: 6e5f 726f 7461 7469 6f6e 223a 0a20 2020  n_rotation":.   
+000316e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000316f0: 6265 616d 2e4f 7074 6963 732e 4765 7449  beam.Optics.GetI
+00031700: 6d61 6765 526f 7461 7469 6f6e 2829 2020  mageRotation()  
+00031710: 200a 2020 2020 2020 2020 6966 206b 6579   .        if key
+00031720: 203d 3d20 2273 6869 6674 223a 0a20 2020   == "shift":.   
+00031730: 2020 2020 2020 2020 2076 616c 7565 7320           values 
+00031740: 3d20 6265 616d 2e4f 7074 6963 732e 4765  = beam.Optics.Ge
+00031750: 7449 6d61 6765 5368 6966 7428 290a 2020  tImageShift().  
+00031760: 2020 2020 2020 2020 2020 7368 6966 7420            shift 
+00031770: 3d20 506f 696e 7428 7661 6c75 6573 5b30  = Point(values[0
+00031780: 5d2a 636f 6e73 7461 6e74 732e 4d49 4c4c  ]*constants.MILL
+00031790: 494d 4554 5245 5f54 4f5f 4d45 5452 452c  IMETRE_TO_METRE,
+000317a0: 2076 616c 7565 735b 315d 2a63 6f6e 7374   values[1]*const
+000317b0: 616e 7473 2e4d 494c 4c49 4d45 5452 455f  ants.MILLIMETRE_
+000317c0: 544f 5f4d 4554 5245 290a 2020 2020 2020  TO_METRE).      
+000317d0: 2020 2020 2020 7265 7475 726e 2073 6869        return shi
+000317e0: 6674 0a20 2020 2020 2020 200a 0a0a 2020  ft.        ...  
+000317f0: 2020 2020 2020 2320 7379 7374 656d 2070        # system p
+00031800: 726f 7065 7274 6965 730a 2020 2020 2020  roperties.      
+00031810: 2020 6966 206b 6579 203d 3d20 2265 7563    if key == "euc
+00031820: 656e 7472 6963 5f68 6569 6768 7422 3a0a  entric_height":.
+00031830: 2020 2020 2020 2020 2020 2020 6966 2062              if b
+00031840: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
+00031850: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
+00031860: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00031870: 6574 7572 6e20 7365 6c66 2e73 7973 7465  eturn self.syste
+00031880: 6d2e 656c 6563 7472 6f6e 2e65 7563 656e  m.electron.eucen
+00031890: 7472 6963 5f68 6569 6768 740a 2020 2020  tric_height.    
+000318a0: 2020 2020 2020 2020 656c 6966 2062 6561          elif bea
+000318b0: 6d5f 7479 7065 2069 7320 4265 616d 5479  m_type is BeamTy
+000318c0: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
+000318d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000318e0: 656c 662e 7379 7374 656d 2e69 6f6e 2e65  elf.system.ion.e
+000318f0: 7563 656e 7472 6963 5f68 6569 6768 740a  ucentric_height.
+00031900: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00031910: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00031920: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00031930: 6f72 2866 2255 6e6b 6e6f 776e 2062 6561  or(f"Unknown bea
+00031940: 6d20 7479 7065 3a20 7b62 6561 6d5f 7479  m type: {beam_ty
+00031950: 7065 7d20 666f 7220 7b6b 6579 7d22 290a  pe} for {key}").
+00031960: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00031970: 3d3d 2022 636f 6c75 6d6e 5f74 696c 7422  == "column_tilt"
+00031980: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00031990: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
+000319a0: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
+000319b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000319c0: 2072 6574 7572 6e20 7365 6c66 2e73 7973   return self.sys
+000319d0: 7465 6d2e 656c 6563 7472 6f6e 2e63 6f6c  tem.electron.col
+000319e0: 756d 6e5f 7469 6c74 0a20 2020 2020 2020  umn_tilt.       
+000319f0: 2020 2020 2065 6c69 6620 6265 616d 5f74       elif beam_t
+00031a00: 7970 6520 6973 2042 6561 6d54 7970 652e  ype is BeamType.
+00031a10: 494f 4e3a 0a20 2020 2020 2020 2020 2020  ION:.           
+00031a20: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00031a30: 2e73 7973 7465 6d2e 696f 6e2e 636f 6c75  .system.ion.colu
+00031a40: 6d6e 5f74 696c 740a 2020 2020 2020 2020  mn_tilt.        
+00031a50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00031a60: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00031a70: 5661 6c75 6545 7272 6f72 2866 2255 6e6b  ValueError(f"Unk
+00031a80: 6e6f 776e 2062 6561 6d20 7479 7065 3a20  nown beam type: 
+00031a90: 7b62 6561 6d5f 7479 7065 7d20 666f 7220  {beam_type} for 
+00031aa0: 7b6b 6579 7d22 290a 0a20 2020 2020 2020  {key}")..       
+00031ab0: 2023 2069 6f6e 2062 6561 6d20 7072 6f70   # ion beam prop
+00031ac0: 6572 7469 6573 0a20 2020 2020 2020 2069  erties.        i
+00031ad0: 6620 6b65 7920 3d3d 2022 706c 6173 6d61  f key == "plasma
+00031ae0: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
+00031af0: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
+00031b00: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+00031b10: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00031b20: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
+00031b30: 696f 6e2e 706c 6173 6d61 0a20 2020 2020  ion.plasma.     
+00031b40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00031b50: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00031b60: 7572 6e20 4661 6c73 650a 0a20 2020 2020  urn False..     
+00031b70: 2020 2023 2073 7461 6765 2070 726f 7065     # stage prope
+00031b80: 7274 6965 730a 2020 2020 2020 2020 6966  rties.        if
+00031b90: 206b 6579 203d 3d20 2273 7461 6765 5f70   key == "stage_p
+00031ba0: 6f73 6974 696f 6e22 3a0a 2020 2020 2020  osition":.      
+00031bb0: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
+00031bc0: 6765 2873 656c 662e 7379 7374 656d 290a  ge(self.system).
+00031bd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00031be0: 726e 2073 656c 662e 6765 745f 7374 6167  rn self.get_stag
+00031bf0: 655f 706f 7369 7469 6f6e 2829 0a20 2020  e_position().   
+00031c00: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00031c10: 7374 6167 655f 6361 6c69 6272 6174 6564  stage_calibrated
+00031c20: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
+00031c30: 6368 6563 6b5f 7374 6167 6528 7365 6c66  check_stage(self
+00031c40: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
+00031c50: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00031c60: 2e63 6f6e 6e65 6374 696f 6e2e 5374 6167  .connection.Stag
+00031c70: 652e 4973 4361 6c69 6272 6174 6564 2829  e.IsCalibrated()
+00031c80: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00031c90: 2020 2320 6368 616d 6265 7220 7072 6f70    # chamber prop
+00031ca0: 6572 7469 6573 0a20 2020 2020 2020 2069  erties.        i
+00031cb0: 6620 6b65 7920 3d3d 2022 6368 616d 6265  f key == "chambe
+00031cc0: 725f 7374 6174 6522 3a0a 2020 2020 2020  r_state":.      
+00031cd0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00031ce0: 662e 636f 6e6e 6563 7469 6f6e 2e43 6861  f.connection.Cha
+00031cf0: 6d62 6572 2e47 6574 5374 6174 7573 2829  mber.GetStatus()
+00031d00: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00031d10: 3d3d 2022 6368 616d 6265 725f 7072 6573  == "chamber_pres
+00031d20: 7375 7265 223a 0a20 2020 2020 2020 2020  sure":.         
+00031d30: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00031d40: 6f6e 6e65 6374 696f 6e2e 4368 616d 6265  onnection.Chambe
+00031d50: 722e 4765 7450 7265 7373 7572 6528 3029  r.GetPressure(0)
+00031d60: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00031d70: 2020 2320 6465 7465 6374 6f72 2070 726f    # detector pro
+00031d80: 7065 7274 6965 730a 2020 2020 2020 2020  perties.        
+00031d90: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
+00031da0: 746f 725f 7479 7065 223a 0a20 2020 2020  tor_type":.     
+00031db0: 2020 2020 2020 2064 6574 6563 746f 7220         detector 
+00031dc0: 3d20 6265 616d 2e44 6574 6563 746f 722e  = beam.Detector.
+00031dd0: 4765 7428 4368 616e 6e65 6c20 3d20 3029  Get(Channel = 0)
+00031de0: 200a 2020 2020 2020 2020 2020 2020 6966   .            if
+00031df0: 2064 6574 6563 746f 7220 6973 206e 6f74   detector is not
+00031e00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00031e10: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
+00031e20: 7465 6374 6f72 2e6e 616d 650a 2020 2020  tector.name.    
+00031e30: 2020 2020 2020 2020 656c 7365 3a20 0a20          else: . 
+00031e40: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00031e50: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+00031e60: 2020 2069 6620 6b65 7920 3d3d 2022 6465     if key == "de
+00031e70: 7465 6374 6f72 5f63 6f6e 7472 6173 7422  tector_contrast"
+00031e80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00031e90: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
+00031ea0: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
+00031eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031ec0: 2063 6f6e 7472 6173 742c 2062 7269 6768   contrast, brigh
+00031ed0: 746e 6573 7320 3d20 6265 616d 2e44 6574  tness = beam.Det
+00031ee0: 6563 746f 722e 4765 7447 6169 6e42 6c61  ector.GetGainBla
+00031ef0: 636b 2844 6574 6563 746f 723d 2073 656c  ck(Detector= sel
+00031f00: 662e 656c 6563 7472 6f6e 5f64 6574 6563  f.electron_detec
+00031f10: 746f 725f 6163 7469 7665 290a 2020 2020  tor_active).    
+00031f20: 2020 2020 2020 2020 656c 6966 2062 6561          elif bea
+00031f30: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+00031f40: 7065 2e49 4f4e 3a0a 2020 2020 2020 2020  pe.ION:.        
+00031f50: 2020 2020 2020 2020 636f 6e74 7261 7374          contrast
+00031f60: 2c20 6272 6967 6874 6e65 7373 203d 2062  , brightness = b
+00031f70: 6561 6d2e 4465 7465 6374 6f72 2e47 6574  eam.Detector.Get
+00031f80: 4761 696e 426c 6163 6b28 4465 7465 6374  GainBlack(Detect
+00031f90: 6f72 3d20 7365 6c66 2e69 6f6e 5f64 6574  or= self.ion_det
+00031fa0: 6563 746f 725f 6163 7469 7665 290a 2020  ector_active).  
+00031fb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00031fc0: 2063 6f6e 7472 6173 742f 3130 300a 2020   contrast/100.  
+00031fd0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00031fe0: 2264 6574 6563 746f 725f 6272 6967 6874  "detector_bright
+00031ff0: 6e65 7373 223a 0a20 2020 2020 2020 2020  ness":.         
+00032000: 2020 2069 6620 6265 616d 5f74 7970 6520     if beam_type 
+00032010: 3d3d 2042 6561 6d54 7970 652e 454c 4543  == BeamType.ELEC
+00032020: 5452 4f4e 3a0a 2020 2020 2020 2020 2020  TRON:.          
+00032030: 2020 2020 2020 636f 6e74 7261 7374 2c20        contrast, 
+00032040: 6272 6967 6874 6e65 7373 203d 2062 6561  brightness = bea
+00032050: 6d2e 4465 7465 6374 6f72 2e47 6574 4761  m.Detector.GetGa
+00032060: 696e 426c 6163 6b28 4465 7465 6374 6f72  inBlack(Detector
+00032070: 3d20 7365 6c66 2e65 6c65 6374 726f 6e5f  = self.electron_
+00032080: 6465 7465 6374 6f72 5f61 6374 6976 6529  detector_active)
+00032090: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+000320a0: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
+000320b0: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+000320c0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000320d0: 7472 6173 742c 2062 7269 6768 746e 6573  trast, brightnes
+000320e0: 7320 3d20 6265 616d 2e44 6574 6563 746f  s = beam.Detecto
+000320f0: 722e 4765 7447 6169 6e42 6c61 636b 2844  r.GetGainBlack(D
+00032100: 6574 6563 746f 723d 2073 656c 662e 696f  etector= self.io
+00032110: 6e5f 6465 7465 6374 6f72 5f61 6374 6976  n_detector_activ
+00032120: 6529 0a20 2020 2020 2020 2020 2020 2072  e).            r
+00032130: 6574 7572 6e20 6272 6967 6874 6e65 7373  eturn brightness
+00032140: 2f31 3030 0a20 2020 2020 2020 200a 2020  /100.        .  
+00032150: 2020 2020 2020 2320 6d61 6e69 7075 6c61        # manipula
+00032160: 746f 7220 7072 6f70 6572 7469 6573 0a20  tor properties. 
+00032170: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+00032180: 2022 6d61 6e69 7075 6c61 746f 725f 706f   "manipulator_po
+00032190: 7369 7469 6f6e 223a 0a20 2020 2020 2020  sition":.       
+000321a0: 2020 2020 205f 6368 6563 6b5f 6d61 6e69       _check_mani
+000321b0: 7075 6c61 746f 7228 7365 6c66 2e73 7973  pulator(self.sys
+000321c0: 7465 6d29 0a20 2020 2020 2020 2020 2020  tem).           
+000321d0: 2072 6574 7572 6e20 7365 6c66 2e63 6f6e   return self.con
+000321e0: 6e65 6374 696f 6e2e 4e61 6e6f 6d61 6e69  nection.Nanomani
+000321f0: 7075 6c61 746f 722e 4765 7450 6f73 6974  pulator.GetPosit
+00032200: 696f 6e28 3029 0a20 2020 2020 2020 2069  ion(0).        i
+00032210: 6620 6b65 7920 3d3d 2022 6d61 6e69 7075  f key == "manipu
+00032220: 6c61 746f 725f 6361 6c69 6272 6174 6564  lator_calibrated
+00032230: 223a 0a20 2020 2020 2020 2020 2020 205f  ":.            _
+00032240: 6368 6563 6b5f 6d61 6e69 7075 6c61 746f  check_manipulato
+00032250: 7228 7365 6c66 2e73 7973 7465 6d29 0a20  r(self.system). 
+00032260: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00032270: 6e20 7365 6c66 2e63 6f6e 6e65 6374 696f  n self.connectio
+00032280: 6e2e 4e61 6e6f 6d61 6e69 7075 6c61 746f  n.Nanomanipulato
+00032290: 722e 4973 4361 6c69 6272 6174 6564 2830  r.IsCalibrated(0
+000322a0: 290a 2020 2020 2020 2020 6966 206b 6579  ).        if key
+000322b0: 203d 3d20 226d 616e 6970 756c 6174 6f72   == "manipulator
+000322c0: 5f73 7461 7465 223a 0a20 2020 2020 2020  _state":.       
+000322d0: 2020 2020 205f 6368 6563 6b5f 6d61 6e69       _check_mani
+000322e0: 7075 6c61 746f 7228 7365 6c66 2e73 7973  pulator(self.sys
+000322f0: 7465 6d29 0a20 2020 2020 2020 2020 2020  tem).           
+00032300: 2072 6574 7572 6e20 7365 6c66 2e63 6f6e   return self.con
+00032310: 6e65 6374 696f 6e2e 4e61 6e6f 6d61 6e69  nection.Nanomani
+00032320: 7075 6c61 746f 722e 4765 7453 7461 7475  pulator.GetStatu
+00032330: 7328 3029 0a0a 2020 2020 2020 2020 6966  s(0)..        if
+00032340: 206b 6579 203d 3d20 2270 7265 7365 7473   key == "presets
+00032350: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
+00032360: 6574 7572 6e20 7365 6c66 2e5f 6765 745f  eturn self._get_
+00032370: 7072 6573 6574 7328 290a 0a0a 2020 2020  presets()...    
+00032380: 2020 2020 2320 6d61 6e75 6661 6374 7572      # manufactur
+00032390: 6572 2070 726f 7065 7274 6965 730a 2020  er properties.  
+000323a0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+000323b0: 226d 616e 7566 6163 7475 7265 7222 3a0a  "manufacturer":.
+000323c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000323d0: 726e 2073 656c 662e 7379 7374 656d 2e69  rn self.system.i
+000323e0: 6e66 6f2e 6d61 6e75 6661 6374 7572 6572  nfo.manufacturer
+000323f0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00032400: 3d3d 2022 6d6f 6465 6c22 3a0a 2020 2020  == "model":.    
+00032410: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00032420: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
+00032430: 6d6f 6465 6c0a 2020 2020 2020 2020 6966  model.        if
+00032440: 206b 6579 203d 3d20 2273 6f66 7477 6172   key == "softwar
+00032450: 655f 7665 7273 696f 6e22 3a0a 2020 2020  e_version":.    
+00032460: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00032470: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
+00032480: 736f 6674 7761 7265 5f76 6572 7369 6f6e  software_version
+00032490: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+000324a0: 3d3d 2022 7365 7269 616c 5f6e 756d 6265  == "serial_numbe
+000324b0: 7222 3a0a 2020 2020 2020 2020 2020 2020  r":.            
+000324c0: 7265 7475 726e 2073 656c 662e 7379 7374  return self.syst
+000324d0: 656d 2e69 6e66 6f2e 7365 7269 616c 5f6e  em.info.serial_n
+000324e0: 756d 6265 720a 2020 2020 2020 2020 6966  umber.        if
+000324f0: 206b 6579 203d 3d20 2268 6172 6477 6172   key == "hardwar
+00032500: 655f 7665 7273 696f 6e22 3a0a 2020 2020  e_version":.    
+00032510: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00032520: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
+00032530: 6861 7264 7761 7265 5f76 6572 7369 6f6e  hardware_version
+00032540: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00032550: 2020 6966 206b 6579 203d 3d20 2263 6f6c    if key == "col
+00032560: 756d 6e5f 7469 6c74 223a 0a20 2020 2020  umn_tilt":.     
+00032570: 2020 2020 2020 2023 2054 4f44 4f3a 2063         # TODO: c
+00032580: 6865 636b 2069 6620 7468 6973 2069 7320  heck if this is 
+00032590: 6176 6169 6c61 626c 650a 2020 2020 2020  available.      
+000325a0: 2020 2020 2020 6966 2062 6561 6d5f 7479        if beam_ty
+000325b0: 7065 2069 7320 4265 616d 5479 7065 2e45  pe is BeamType.E
+000325c0: 4c45 4354 524f 4e3a 0a20 2020 2020 2020  LECTRON:.       
+000325d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000325e0: 7365 6c66 2e73 7973 7465 6d2e 656c 6563  self.system.elec
+000325f0: 7472 6f6e 2e63 6f6c 756d 6e5f 7469 6c74  tron.column_tilt
+00032600: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00032610: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
+00032620: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+00032630: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00032640: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
+00032650: 696f 6e2e 636f 6c75 6d6e 5f74 696c 740a  ion.column_tilt.
+00032660: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00032670: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032680: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00032690: 6f72 2866 2255 6e6b 6e6f 776e 2062 6561  or(f"Unknown bea
+000326a0: 6d20 7479 7065 3a20 7b62 6561 6d5f 7479  m type: {beam_ty
+000326b0: 7065 7d20 666f 7220 7b6b 6579 7d22 290a  pe} for {key}").
+000326c0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000326d0: 2023 206c 6f67 6769 6e67 2e77 6172 6e69   # logging.warni
+000326e0: 6e67 2866 2255 6e6b 6e6f 776e 206b 6579  ng(f"Unknown key
+000326f0: 3a20 7b6b 6579 7d20 287b 6265 616d 5f74  : {key} ({beam_t
+00032700: 7970 657d 2922 290a 2020 2020 2020 2020  ype})").        
+00032710: 7265 7475 726e 204e 6f6e 6520 2020 0a0a  return None   ..
+00032720: 2020 2020 6465 6620 5f73 6574 2873 656c      def _set(sel
+00032730: 662c 206b 6579 3a20 7374 722c 2076 616c  f, key: str, val
+00032740: 7565 2c20 6265 616d 5f74 7970 653a 2042  ue, beam_type: B
+00032750: 6561 6d54 7970 6520 3d20 4e6f 6e65 2920  eamType = None) 
+00032760: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00032770: 2022 2222 5365 7420 6120 7072 6f70 6572   """Set a proper
+00032780: 7479 206f 6620 7468 6520 6d69 6372 6f73  ty of the micros
+00032790: 636f 7065 2e22 2222 0a20 2020 2020 2020  cope.""".       
+000327a0: 2069 6620 6265 616d 5f74 7970 6520 6973   if beam_type is
+000327b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000327c0: 2020 2062 6561 6d20 3d20 7365 6c66 2e63     beam = self.c
+000327d0: 6f6e 6e65 6374 696f 6e2e 5345 4d20 6966  onnection.SEM if
+000327e0: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
+000327f0: 616d 5479 7065 2e45 4c45 4354 524f 4e20  amType.ELECTRON 
+00032800: 656c 7365 2073 656c 662e 636f 6e6e 6563  else self.connec
+00032810: 7469 6f6e 2e46 4942 0a20 2020 2020 2020  tion.FIB.       
+00032820: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
+00032830: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
+00032840: 2e73 7973 7465 6d29 0a0a 2020 2020 2020  .system)..      
+00032850: 2020 6966 206b 6579 203d 3d20 2277 6f72    if key == "wor
+00032860: 6b69 6e67 5f64 6973 7461 6e63 6522 3a0a  king_distance":.
+00032870: 2020 2020 2020 2020 2020 2020 6966 2062              if b
+00032880: 6561 6d5f 7479 7065 203d 3d20 4265 616d  eam_type == Beam
+00032890: 5479 7065 2e45 4c45 4354 524f 4e3a 0a20  Type.ELECTRON:. 
+000328a0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000328b0: 6561 6d2e 4f70 7469 6373 2e53 6574 5744  eam.Optics.SetWD
+000328c0: 2876 616c 7565 202a 2063 6f6e 7374 616e  (value * constan
+000328d0: 7473 2e4d 4554 5245 5f54 4f5f 4d49 4c4c  ts.METRE_TO_MILL
+000328e0: 494d 4554 5245 290a 2020 2020 2020 2020  IMETRE).        
+000328f0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00032900: 696e 666f 2866 2245 6c65 6374 726f 6e20  info(f"Electron 
+00032910: 6265 616d 2077 6f72 6b69 6e67 2064 6973  beam working dis
+00032920: 7461 6e63 6520 7365 7420 746f 207b 7661  tance set to {va
+00032930: 6c75 657d 206d 2e22 290a 2020 2020 2020  lue} m.").      
+00032940: 2020 2020 2020 656c 7365 3a20 0a20 2020        else: .   
+00032950: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00032960: 6769 6e67 2e69 6e66 6f28 6622 5365 7474  ging.info(f"Sett
+00032970: 696e 6720 776f 726b 696e 6720 6469 7374  ing working dist
+00032980: 616e 6365 2066 6f72 2069 6f6e 2062 6561  ance for ion bea
+00032990: 6d20 6973 206e 6f74 2073 7570 706f 7274  m is not support
+000329a0: 6564 2062 7920 5465 7363 616e 2041 5049  ed by Tescan API
+000329b0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+000329c0: 7265 7475 726e 0a20 2020 2020 2020 2069  return.        i
+000329d0: 6620 6b65 7920 3d3d 2022 6375 7272 656e  f key == "curren
+000329e0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+000329f0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+00032a00: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+00032a10: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+00032a20: 2020 2062 6561 6d2e 4265 616d 2e53 6574     beam.Beam.Set
+00032a30: 4375 7272 656e 7428 7661 6c75 6520 2a20  Current(value * 
+00032a40: 636f 6e73 7461 6e74 732e 5349 5f54 4f5f  constants.SI_TO_
+00032a50: 5049 434f 290a 2020 2020 2020 2020 2020  PICO).          
+00032a60: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00032a70: 666f 2866 2245 6c65 6374 726f 6e20 6265  fo(f"Electron be
+00032a80: 616d 2063 7572 7265 6e74 2073 6574 2074  am current set t
+00032a90: 6f20 7b76 616c 7565 7d20 412e 2229 0a20  o {value} A."). 
+00032aa0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00032ab0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00032ac0: 2020 6c6f 6767 696e 672e 7761 726e 696e    logging.warnin
+00032ad0: 6728 6622 5365 7474 696e 6720 6375 7272  g(f"Setting curr
+00032ae0: 656e 7420 666f 7220 696f 6e20 6265 616d  ent for ion beam
+00032af0: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
+00032b00: 6420 6279 2054 6573 6361 6e20 4150 492c  d by Tescan API,
+00032b10: 2070 6c65 6173 6520 7573 6520 7468 6520   please use the 
+00032b20: 6e61 7469 7665 206d 6963 726f 7363 6f70  native microscop
+00032b30: 6520 696e 7465 7266 6163 652e 2229 0a20  e interface."). 
+00032b40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00032b50: 6e0a 2020 2020 2020 2020 6966 206b 6579  n.        if key
+00032b60: 203d 3d20 2276 6f6c 7461 6765 223a 0a20   == "voltage":. 
+00032b70: 2020 2020 2020 2020 2020 2069 6620 6265             if be
+00032b80: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+00032b90: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
+00032ba0: 2020 2020 2020 2020 2020 2020 2020 6265                be
+00032bb0: 616d 2e42 6561 6d2e 5365 7456 6f6c 7461  am.Beam.SetVolta
+00032bc0: 6765 2876 616c 7565 290a 2020 2020 2020  ge(value).      
+00032bd0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+00032be0: 672e 696e 666f 2866 2245 6c65 6374 726f  g.info(f"Electro
+00032bf0: 6e20 6265 616d 2076 6f6c 7461 6765 2073  n beam voltage s
+00032c00: 6574 2074 6f20 7b76 616c 7565 7d20 562e  et to {value} V.
+00032c10: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
+00032c20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00032c30: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
+00032c40: 6e69 6e67 2866 2253 6574 7469 6e67 2076  ning(f"Setting v
+00032c50: 6f6c 7461 6765 2066 6f72 2069 6f6e 2062  oltage for ion b
+00032c60: 6561 6d20 6973 206e 6f74 2073 7570 706f  eam is not suppo
+00032c70: 7274 6564 2062 7920 5465 7363 616e 2041  rted by Tescan A
+00032c80: 5049 2c20 706c 6561 7365 2075 7365 2074  PI, please use t
+00032c90: 6865 206e 6174 6976 6520 6d69 6372 6f73  he native micros
+00032ca0: 636f 7065 2069 6e74 6572 6661 6365 2e22  cope interface."
+00032cb0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00032cc0: 7475 726e 0a20 2020 2020 2020 2069 6620  turn.        if 
+00032cd0: 6b65 7920 3d3d 2022 6866 7722 3a0a 2020  key == "hfw":.  
+00032ce0: 2020 2020 2020 2020 2020 6265 616d 2e4f            beam.O
+00032cf0: 7074 6963 732e 5365 7456 6965 7766 6965  ptics.SetViewfie
+00032d00: 6c64 2876 616c 7565 202a 2063 6f6e 7374  ld(value * const
+00032d10: 616e 7473 2e4d 4554 5245 5f54 4f5f 4d49  ants.METRE_TO_MI
+00032d20: 4c4c 494d 4554 5245 290a 2020 2020 2020  LLIMETRE).      
+00032d30: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00032d40: 666f 2866 227b 6265 616d 5f74 7970 652e  fo(f"{beam_type.
+00032d50: 6e61 6d65 7d20 4846 5720 7365 7420 746f  name} HFW set to
+00032d60: 207b 7661 6c75 657d 206d 2e22 290a 2020   {value} m.").  
+00032d70: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00032d80: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00032d90: 3d3d 2022 7363 616e 5f72 6f74 6174 696f  == "scan_rotatio
+00032da0: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
+00032db0: 6265 616d 2e4f 7074 6963 732e 5365 7449  beam.Optics.SetI
+00032dc0: 6d61 6765 526f 7461 7469 6f6e 2876 616c  mageRotation(val
+00032dd0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+00032de0: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
+00032df0: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
+00032e00: 7363 616e 2072 6f74 6174 696f 6e20 7365  scan rotation se
+00032e10: 7420 746f 207b 7661 6c75 657d 2064 6567  t to {value} deg
+00032e20: 7265 6573 2e22 290a 2020 2020 2020 2020  rees.").        
+00032e30: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+00032e40: 2020 2020 2320 6265 616d 2063 6f6e 7472      # beam contr
+00032e50: 6f6c 0a20 2020 2020 2020 2069 6620 6b65  ol.        if ke
+00032e60: 7920 3d3d 2022 6f6e 223a 0a20 2020 2020  y == "on":.     
+00032e70: 2020 2020 2020 2062 6561 6d2e 4265 616d         beam.Beam
+00032e80: 2e4f 6e28 2920 6966 2076 616c 7565 2065  .On() if value e
+00032e90: 6c73 6520 6265 616d 2e42 6561 6d2e 4f66  lse beam.Beam.Of
+00032ea0: 6628 290a 2020 2020 2020 2020 2020 2020  f().            
+00032eb0: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
+00032ec0: 6265 616d 5f74 7970 652e 6e61 6d65 7d20  beam_type.name} 
+00032ed0: 6265 616d 2074 7572 6e65 6420 7b27 6f6e  beam turned {'on
+00032ee0: 2720 6966 2076 616c 7565 2065 6c73 6520  ' if value else 
+00032ef0: 276f 6666 277d 2e22 290a 2020 2020 2020  'off'}.").      
+00032f00: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00032f10: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+00032f20: 7368 6966 7422 3a0a 2020 2020 2020 2020  shift":.        
+00032f30: 2020 2020 706f 696e 7420 3d20 506f 696e      point = Poin
+00032f40: 7428 7661 6c75 652e 782a 636f 6e73 7461  t(value.x*consta
+00032f50: 6e74 732e 4d45 5452 455f 544f 5f4d 494c  nts.METRE_TO_MIL
+00032f60: 4c49 4d45 5452 452c 2076 616c 7565 2e79  LIMETRE, value.y
+00032f70: 2a63 6f6e 7374 616e 7473 2e4d 4554 5245  *constants.METRE
+00032f80: 5f54 4f5f 4d49 4c4c 494d 4554 5245 290a  _TO_MILLIMETRE).
+00032f90: 2020 2020 2020 2020 2020 2020 6265 616d              beam
+00032fa0: 2e4f 7074 6963 732e 5365 7449 6d61 6765  .Optics.SetImage
+00032fb0: 5368 6966 7428 706f 696e 742e 782c 2070  Shift(point.x, p
+00032fc0: 6f69 6e74 2e79 290a 2020 2020 2020 2020  oint.y).        
+00032fd0: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00032fe0: 2866 227b 6265 616d 5f74 7970 652e 6e61  (f"{beam_type.na
+00032ff0: 6d65 7d20 6265 616d 2073 6869 6674 2073  me} beam shift s
+00033000: 6574 2074 6f20 7b76 616c 7565 7d2e 2229  et to {value}.")
+00033010: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00033020: 7572 6e0a 2020 2020 2020 2020 0a20 2020  urn.        .   
+00033030: 2020 2020 2023 2064 6574 6563 746f 7220       # detector 
+00033040: 636f 6e74 726f 6c0a 2020 2020 2020 2020  control.        
+00033050: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
+00033060: 746f 725f 7479 7065 223a 0a20 2020 2020  tor_type":.     
+00033070: 2020 2020 2020 2069 6620 6265 616d 5f74         if beam_t
+00033080: 7970 6520 3d3d 2042 6561 6d54 7970 652e  ype == BeamType.
+00033090: 454c 4543 5452 4f4e 3a0a 2020 2020 2020  ELECTRON:.      
+000330a0: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+000330b0: 6c65 6374 726f 6e5f 6465 7465 6374 6f72  lectron_detector
+000330c0: 5f61 6374 6976 6520 3d20 7661 6c75 650a  _active = value.
+000330d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330e0: 6265 616d 2e44 6574 6563 746f 722e 5365  beam.Detector.Se
+000330f0: 7428 4368 616e 6e65 6c20 3d20 302c 2044  t(Channel = 0, D
+00033100: 6574 6563 746f 7220 3d20 7661 6c75 6529  etector = value)
+00033110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033120: 2073 656c 662e 656c 6563 7472 6f6e 5f64   self.electron_d
+00033130: 6574 6563 746f 725f 6163 7469 7665 203d  etector_active =
+00033140: 2062 6561 6d2e 4465 7465 6374 6f72 2e47   beam.Detector.G
+00033150: 6574 2843 6861 6e6e 656c 203d 2030 290a  et(Channel = 0).
+00033160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033170: 6c6f 6767 696e 672e 696e 666f 2866 227b  logging.info(f"{
+00033180: 6265 616d 5f74 7970 657d 2064 6574 6563  beam_type} detec
+00033190: 746f 7220 7479 7065 2073 6574 2074 6f20  tor type set to 
+000331a0: 7b76 616c 7565 7d2e 2229 0a20 2020 2020  {value}.").     
+000331b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000331c0: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
+000331d0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+000331e0: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+000331f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00033200: 6c66 2e69 6f6e 5f64 6574 6563 746f 725f  lf.ion_detector_
+00033210: 6163 7469 7665 203d 2076 616c 7565 0a20  active = value. 
+00033220: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00033230: 6561 6d2e 4465 7465 6374 6f72 2e53 6574  eam.Detector.Set
+00033240: 2843 6861 6e6e 656c 203d 2030 2c20 4465  (Channel = 0, De
+00033250: 7465 6374 6f72 203d 2076 616c 7565 290a  tector = value).
+00033260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033270: 7365 6c66 2e69 6f6e 5f64 6574 6563 746f  self.ion_detecto
+00033280: 725f 6163 7469 7665 203d 2062 6561 6d2e  r_active = beam.
+00033290: 4465 7465 6374 6f72 2e47 6574 2843 6861  Detector.Get(Cha
+000332a0: 6e6e 656c 203d 2030 290a 2020 2020 2020  nnel = 0).      
+000332b0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+000332c0: 672e 696e 666f 2866 227b 6265 616d 5f74  g.info(f"{beam_t
+000332d0: 7970 657d 2064 6574 6563 746f 7220 7479  ype} detector ty
+000332e0: 7065 2073 6574 2074 6f20 7b76 616c 7565  pe set to {value
+000332f0: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
+00033300: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00033310: 2020 2020 6966 206b 6579 2069 6e20 5b22      if key in ["
+00033320: 6465 7465 6374 6f72 5f62 7269 6768 746e  detector_brightn
+00033330: 6573 7322 2c20 2264 6574 6563 746f 725f  ess", "detector_
+00033340: 636f 6e74 7261 7374 225d 3a0a 2020 2020  contrast"]:.    
+00033350: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00033360: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+00033370: 656c 662e 7379 7374 656d 290a 2020 2020  elf.system).    
+00033380: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+00033390: 3d20 2264 6574 6563 746f 725f 6272 6967  = "detector_brig
+000333a0: 6874 6e65 7373 223a 0a20 2020 2020 2020  htness":.       
+000333b0: 2020 2020 2020 2020 2069 6620 3020 3c3d           if 0 <=
+000333c0: 2076 616c 7565 203c 3d20 313a 0a20 2020   value <= 1:.   
+000333d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000333e0: 2069 6620 6265 616d 5f74 7970 6520 3d3d   if beam_type ==
+000333f0: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+00033400: 4f4e 3a0a 2020 2020 2020 2020 2020 2020  ON:.            
+00033410: 2020 2020 2020 2020 2020 2020 6f67 5f63              og_c
+00033420: 6f6e 7472 6173 742c 206f 675f 6272 6967  ontrast, og_brig
+00033430: 6874 6e65 7373 203d 2062 6561 6d2e 4465  htness = beam.De
+00033440: 7465 6374 6f72 2e47 6574 4761 696e 426c  tector.GetGainBl
+00033450: 6163 6b28 4465 7465 6374 6f72 3d20 7365  ack(Detector= se
+00033460: 6c66 2e65 6c65 6374 726f 6e5f 6465 7465  lf.electron_dete
+00033470: 6374 6f72 5f61 6374 6976 6529 0a20 2020  ctor_active).   
+00033480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033490: 2020 2020 2062 6561 6d2e 4465 7465 6374       beam.Detect
+000334a0: 6f72 2e53 6574 4761 696e 426c 6163 6b28  or.SetGainBlack(
+000334b0: 4465 7465 6374 6f72 3d20 7365 6c66 2e65  Detector= self.e
+000334c0: 6c65 6374 726f 6e5f 6465 7465 6374 6f72  lectron_detector
+000334d0: 5f61 6374 6976 652c 2047 6169 6e20 3d20  _active, Gain = 
+000334e0: 6f67 5f63 6f6e 7472 6173 742c 2042 6c61  og_contrast, Bla
+000334f0: 636b 203d 2076 616c 7565 2a31 3030 290a  ck = value*100).
+00033500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033510: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00033520: 696e 666f 2866 227b 6265 616d 5f74 7970  info(f"{beam_typ
+00033530: 657d 2064 6574 6563 746f 7220 6272 6967  e} detector brig
+00033540: 6874 6e65 7373 2073 6574 2074 6f20 7b76  htness set to {v
+00033550: 616c 7565 7d2e 2229 0a20 2020 2020 2020  alue}.").       
+00033560: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00033570: 6620 6265 616d 5f74 7970 6520 3d3d 2042  f beam_type == B
+00033580: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+00033590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000335a0: 2020 2020 206f 675f 636f 6e74 7261 7374       og_contrast
+000335b0: 2c20 6f67 5f62 7269 6768 746e 6573 7320  , og_brightness 
+000335c0: 3d20 6265 616d 2e44 6574 6563 746f 722e  = beam.Detector.
+000335d0: 4765 7447 6169 6e42 6c61 636b 2844 6574  GetGainBlack(Det
+000335e0: 6563 746f 723d 2073 656c 662e 696f 6e5f  ector= self.ion_
+000335f0: 6465 7465 6374 6f72 5f61 6374 6976 6529  detector_active)
+00033600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033610: 2020 2020 2020 2020 2062 6561 6d2e 4465           beam.De
+00033620: 7465 6374 6f72 2e53 6574 4761 696e 426c  tector.SetGainBl
+00033630: 6163 6b28 4465 7465 6374 6f72 3d20 7365  ack(Detector= se
+00033640: 6c66 2e69 6f6e 5f64 6574 6563 746f 725f  lf.ion_detector_
+00033650: 6163 7469 7665 2c20 4761 696e 203d 206f  active, Gain = o
+00033660: 675f 636f 6e74 7261 7374 2c20 426c 6163  g_contrast, Blac
+00033670: 6b20 3d20 7661 6c75 652a 3130 3029 0a20  k = value*100). 
+00033680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033690: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+000336a0: 6e66 6f28 6622 7b62 6561 6d5f 7479 7065  nfo(f"{beam_type
+000336b0: 7d20 6465 7465 6374 6f72 2062 7269 6768  } detector brigh
+000336c0: 746e 6573 7320 7365 7420 746f 207b 7661  tness set to {va
+000336d0: 6c75 657d 2e22 290a 2020 2020 2020 2020  lue}.").        
+000336e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000336f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033700: 2020 6c6f 6767 696e 672e 7761 726e 696e    logging.warnin
+00033710: 6728 6622 496e 7661 6c69 6420 6272 6967  g(f"Invalid brig
+00033720: 6874 6e65 7373 2076 616c 7565 3a20 7b76  htness value: {v
+00033730: 616c 7565 7d2c 206d 7573 7420 6265 2062  alue}, must be b
+00033740: 6574 7765 656e 2030 2061 6e64 2031 2e22  etween 0 and 1."
+00033750: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00033760: 2020 7265 7475 726e 200a 2020 2020 2020    return .      
+00033770: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+00033780: 2264 6574 6563 746f 725f 636f 6e74 7261  "detector_contra
+00033790: 7374 223a 0a20 2020 2020 2020 2020 2020  st":.           
+000337a0: 2020 2020 2069 6620 3020 3c3d 2076 616c       if 0 <= val
+000337b0: 7565 203c 3d20 313a 0a20 2020 2020 2020  ue <= 1:.       
+000337c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000337d0: 6265 616d 5f74 7970 6520 3d3d 2042 6561  beam_type == Bea
+000337e0: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
+000337f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033800: 2020 2020 2020 2020 6f67 5f63 6f6e 7472          og_contr
+00033810: 6173 742c 206f 675f 6272 6967 6874 6e65  ast, og_brightne
+00033820: 7373 203d 2062 6561 6d2e 4465 7465 6374  ss = beam.Detect
+00033830: 6f72 2e47 6574 4761 696e 426c 6163 6b28  or.GetGainBlack(
+00033840: 4465 7465 6374 6f72 3d20 7365 6c66 2e65  Detector= self.e
+00033850: 6c65 6374 726f 6e5f 6465 7465 6374 6f72  lectron_detector
+00033860: 5f61 6374 6976 6529 0a20 2020 2020 2020  _active).       
+00033870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033880: 2062 6561 6d2e 4465 7465 6374 6f72 2e53   beam.Detector.S
+00033890: 6574 4761 696e 426c 6163 6b28 4465 7465  etGainBlack(Dete
+000338a0: 6374 6f72 3d20 7365 6c66 2e65 6c65 6374  ctor= self.elect
+000338b0: 726f 6e5f 6465 7465 6374 6f72 5f61 6374  ron_detector_act
+000338c0: 6976 652c 2047 6169 6e20 3d20 7661 6c75  ive, Gain = valu
+000338d0: 652a 3130 302c 2042 6c61 636b 203d 206f  e*100, Black = o
+000338e0: 675f 6272 6967 6874 6e65 7373 290a 2020  g_brightness).  
+000338f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033900: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00033910: 666f 2866 227b 6265 616d 5f74 7970 657d  fo(f"{beam_type}
+00033920: 2064 6574 6563 746f 7220 636f 6e74 7261   detector contra
+00033930: 7374 2073 6574 2074 6f20 7b76 616c 7565  st set to {value
+00033940: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
+00033950: 2020 2020 2020 2020 2065 6c69 6620 6265           elif be
+00033960: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+00033970: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
+00033980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033990: 206f 675f 636f 6e74 7261 7374 2c20 6f67   og_contrast, og
+000339a0: 5f62 7269 6768 746e 6573 7320 3d20 6265  _brightness = be
+000339b0: 616d 2e44 6574 6563 746f 722e 4765 7447  am.Detector.GetG
+000339c0: 6169 6e42 6c61 636b 2844 6574 6563 746f  ainBlack(Detecto
+000339d0: 723d 2073 656c 662e 696f 6e5f 6465 7465  r= self.ion_dete
+000339e0: 6374 6f72 5f61 6374 6976 6529 0a20 2020  ctor_active).   
+000339f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a00: 2020 2020 2062 6561 6d2e 4465 7465 6374       beam.Detect
+00033a10: 6f72 2e53 6574 4761 696e 426c 6163 6b28  or.SetGainBlack(
+00033a20: 4465 7465 6374 6f72 3d20 7365 6c66 2e69  Detector= self.i
+00033a30: 6f6e 5f64 6574 6563 746f 725f 6163 7469  on_detector_acti
+00033a40: 7665 2c20 4761 696e 203d 2076 616c 7565  ve, Gain = value
+00033a50: 2a31 3030 2c20 426c 6163 6b20 3d20 6f67  *100, Black = og
+00033a60: 5f62 7269 6768 746e 6573 7329 0a20 2020  _brightness).   
+00033a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a80: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00033a90: 6f28 6622 7b62 6561 6d5f 7479 7065 7d20  o(f"{beam_type} 
+00033aa0: 6465 7465 6374 6f72 2063 6f6e 7472 6173  detector contras
+00033ab0: 7420 7365 7420 746f 207b 7661 6c75 657d  t set to {value}
+00033ac0: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+00033ad0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00033ae0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00033af0: 6767 696e 672e 7761 726e 696e 6728 6622  gging.warning(f"
+00033b00: 496e 7661 6c69 6420 636f 6e74 7261 7374  Invalid contrast
+00033b10: 2076 616c 7565 3a20 7b76 616c 7565 7d2c   value: {value},
+00033b20: 206d 7573 7420 6265 2062 6574 7765 656e   must be between
+00033b30: 2030 2061 6e64 2031 2e22 290a 2020 2020   0 and 1.").    
+00033b40: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00033b50: 726e 200a 0a20 2020 2020 2020 2069 6620  rn ..        if 
+00033b60: 6b65 7920 3d3d 2022 7072 6573 6574 223a  key == "preset":
+00033b70: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+00033b80: 6d2e 5072 6573 6574 2e41 6374 6976 6174  m.Preset.Activat
+00033b90: 6528 7661 6c75 6529 0a20 2020 2020 2020  e(value).       
+00033ba0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00033bb0: 6f28 6622 5072 6573 6574 207b 7661 6c75  o(f"Preset {valu
+00033bc0: 657d 2061 6374 6976 6174 6564 2066 6f72  e} activated for
+00033bd0: 207b 6265 616d 5f74 7970 657d 2e22 290a   {beam_type}.").
+00033be0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00033bf0: 726e 0a20 2020 2020 2020 2020 2020 2020  rn.             
+00033c00: 2020 2020 2020 200a 0a20 2020 2020 2020         ..       
+00033c10: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
+00033c20: 2866 2255 6e6b 6e6f 776e 206b 6579 3a20  (f"Unknown key: 
+00033c30: 7b6b 6579 7d2c 2076 616c 7565 3a20 7b76  {key}, value: {v
+00033c40: 616c 7565 7d20 287b 6265 616d 5f74 7970  alue} ({beam_typ
+00033c50: 657d 2922 290a 2020 2020 2020 2020 7265  e})").        re
+00033c60: 7475 726e 0a0a 2020 2020 6465 6620 6368  turn..    def ch
+00033c70: 6563 6b5f 6176 6169 6c61 626c 655f 7661  eck_available_va
+00033c80: 6c75 6573 2873 656c 662c 206b 6579 3a20  lues(self, key: 
+00033c90: 7374 722c 2062 6561 6d5f 7479 7065 3a20  str, beam_type: 
+00033ca0: 4265 616d 5479 7065 203d 204e 6f6e 6529  BeamType = None)
+00033cb0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00033cc0: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
+00033cd0: 2020 200a 2020 2020 6465 6620 686f 6d65     .    def home
+00033ce0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
+00033cf0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00033d00: 7761 726e 696e 6728 6622 4e6f 2068 6f6d  warning(f"No hom
+00033d10: 696e 6720 6176 6169 6c61 626c 652c 2070  ing available, p
+00033d20: 6c65 6173 6520 7573 6520 6e61 7469 7665  lease use native
+00033d30: 2055 492e 2229 0a20 2020 2020 2020 2072   UI.").        r
+00033d40: 6574 7572 6e0a 0a23 2323 2323 2323 2323  eturn..#########
+00033d50: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00033d60: 636c 6173 7320 4465 6d6f 4d69 6372 6f73  class DemoMicros
+00033d70: 636f 7065 2846 6962 7365 6d4d 6963 726f  cope(FibsemMicro
+00033d80: 7363 6f70 6529 3a0a 0a20 2020 2064 6566  scope):..    def
+00033d90: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00033da0: 7379 7374 656d 5f73 6574 7469 6e67 733a  system_settings:
+00033db0: 2053 7973 7465 6d53 6574 7469 6e67 7329   SystemSettings)
+00033dc0: 3a20 2020 2020 2020 2020 2020 200a 2020  :            .  
+00033dd0: 2020 2020 2020 0a20 2020 2020 2020 200a        .        .
+00033de0: 2020 2020 2020 2020 2320 6861 636b 2c20          # hack, 
+00033df0: 646f 2074 6869 7320 7072 6f70 6572 6c79  do this properly
+00033e00: 2040 7061 7472 6963 6b0a 2020 2020 2020   @patrick.      
+00033e10: 2020 6672 6f6d 2064 6174 6163 6c61 7373    from dataclass
+00033e20: 6573 2069 6d70 6f72 7420 6461 7461 636c  es import datacl
+00033e30: 6173 730a 0a20 2020 2020 2020 2040 6461  ass..        @da
+00033e40: 7461 636c 6173 730a 2020 2020 2020 2020  taclass.        
+00033e50: 636c 6173 7320 4465 6d6f 4d69 6372 6f73  class DemoMicros
+00033e60: 636f 7065 436c 6965 6e74 3a0a 2020 2020  copeClient:.    
+00033e70: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00033e80: 6e65 6374 6564 3a20 626f 6f6c 203d 2046  nected: bool = F
+00033e90: 616c 7365 0a0a 2020 2020 2020 2020 2020  alse..          
+00033ea0: 2020 6465 6620 636f 6e6e 6563 7428 7365    def connect(se
+00033eb0: 6c66 2c20 6970 5f61 6464 7265 7373 3a20  lf, ip_address: 
+00033ec0: 7374 722c 2070 6f72 743a 2069 6e74 203d  str, port: int =
+00033ed0: 2038 3038 3029 3a0a 2020 2020 2020 2020   8080):.        
+00033ee0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00033ef0: 6465 6275 6728 6622 436f 6e6e 6563 7469  debug(f"Connecti
+00033f00: 6e67 2074 6f20 6d69 6372 6f73 636f 7065  ng to microscope
+00033f10: 2061 7420 7b69 705f 6164 6472 6573 737d   at {ip_address}
+00033f20: 3a7b 706f 7274 7d22 290a 2020 2020 2020  :{port}").      
+00033f30: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00033f40: 6f6e 6e65 6374 6564 203d 2054 7275 650a  onnected = True.
+00033f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033f60: 6c6f 6767 696e 672e 6465 6275 6728 6622  logging.debug(f"
+00033f70: 436f 6e6e 6563 7465 6420 746f 206d 6963  Connected to mic
+00033f80: 726f 7363 6f70 6520 6174 207b 6970 5f61  roscope at {ip_a
+00033f90: 6464 7265 7373 7d3a 7b70 6f72 747d 2229  ddress}:{port}")
+00033fa0: 0a0a 2020 2020 2020 2020 2020 2020 6465  ..            de
+00033fb0: 6620 6469 7363 6f6e 6e65 6374 2873 656c  f disconnect(sel
+00033fc0: 6629 3a0a 2020 2020 2020 2020 2020 2020  f):.            
+00033fd0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00033fe0: 6564 203d 2046 616c 7365 0a0a 2020 2020  ed = False..    
+00033ff0: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00034000: 696f 6e20 3d20 4465 6d6f 4d69 6372 6f73  ion = DemoMicros
+00034010: 636f 7065 436c 6965 6e74 2829 0a0a 2020  copeClient()..  
+00034020: 2020 2020 2020 4064 6174 6163 6c61 7373        @dataclass
+00034030: 0a20 2020 2020 2020 2063 6c61 7373 2042  .        class B
+00034040: 6561 6d53 7973 7465 6d3a 0a20 2020 2020  eamSystem:.     
+00034050: 2020 2020 2020 206f 6e3a 2062 6f6f 6c0a         on: bool.
+00034060: 2020 2020 2020 2020 2020 2020 626c 616e              blan
+00034070: 6b65 643a 2062 6f6f 6c0a 2020 2020 2020  ked: bool.      
+00034080: 2020 2020 2020 6265 616d 3a20 4265 616d        beam: Beam
+00034090: 5365 7474 696e 6773 0a20 2020 2020 2020  Settings.       
+000340a0: 2020 2020 2064 6574 6563 746f 723a 2046       detector: F
+000340b0: 6962 7365 6d44 6574 6563 746f 7253 6574  ibsemDetectorSet
+000340c0: 7469 6e67 7320 2020 200a 0a20 2020 2020  tings    ..     
+000340d0: 2020 2040 6461 7461 636c 6173 730a 2020     @dataclass.  
+000340e0: 2020 2020 2020 636c 6173 7320 4368 616d        class Cham
+000340f0: 6265 7253 7973 7465 6d3a 0a20 2020 2020  berSystem:.     
+00034100: 2020 2020 2020 2073 7461 7465 3a20 7374         state: st
+00034110: 720a 2020 2020 2020 2020 2020 2020 7072  r.            pr
+00034120: 6573 7375 7265 3a20 666c 6f61 740a 0a20  essure: float.. 
+00034130: 2020 2020 2020 2040 6461 7461 636c 6173         @dataclas
+00034140: 730a 2020 2020 2020 2020 636c 6173 7320  s.        class 
+00034150: 5374 6167 6553 7973 7465 6d3a 0a20 2020  StageSystem:.   
+00034160: 2020 2020 2020 2020 2069 735f 686f 6d65           is_home
+00034170: 643a 2062 6f6f 6c0a 2020 2020 2020 2020  d: bool.        
+00034180: 2020 2020 6973 5f6c 696e 6b65 643a 2062      is_linked: b
+00034190: 6f6f 6c0a 2020 2020 2020 2020 2020 2020  ool.            
+000341a0: 706f 7369 7469 6f6e 3a20 4669 6273 656d  position: Fibsem
+000341b0: 5374 6167 6550 6f73 6974 696f 6e0a 2020  StagePosition.  
+000341c0: 2020 2020 2020 0a20 2020 2020 2020 2040        .        @
+000341d0: 6461 7461 636c 6173 730a 2020 2020 2020  dataclass.      
+000341e0: 2020 636c 6173 7320 4d61 6e69 7075 6c61    class Manipula
+000341f0: 746f 7253 7973 7465 6d3a 0a20 2020 2020  torSystem:.     
+00034200: 2020 2020 2020 2069 6e73 6572 7465 643a         inserted:
+00034210: 2062 6f6f 6c0a 2020 2020 2020 2020 2020   bool.          
+00034220: 2020 706f 7369 7469 6f6e 3a20 4669 6273    position: Fibs
+00034230: 656d 4d61 6e69 7075 6c61 746f 7250 6f73  emManipulatorPos
+00034240: 6974 696f 6e0a 0a20 2020 2020 2020 2040  ition..        @
+00034250: 6461 7461 636c 6173 730a 2020 2020 2020  dataclass.      
+00034260: 2020 636c 6173 7320 4761 7349 6e6a 6563    class GasInjec
+00034270: 7469 6f6e 5379 7374 656d 3a0a 2020 2020  tionSystem:.    
+00034280: 2020 2020 2020 2020 6761 733a 2073 7472          gas: str
+00034290: 0a20 2020 2020 2020 2020 2020 2069 6e73  .            ins
+000342a0: 6572 7465 643a 2062 6f6f 6c20 3d20 4661  erted: bool = Fa
+000342b0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+000342c0: 6865 6174 6564 3a20 626f 6f6c 203d 2046  heated: bool = F
+000342d0: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+000342e0: 206f 7065 6e65 643a 2062 6f6f 6c20 3d20   opened: bool = 
+000342f0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00034300: 2020 706f 7369 7469 6f6e 3a20 7374 7220    position: str 
+00034310: 3d20 4e6f 6e65 0a20 2020 2020 2020 200a  = None.        .
+00034320: 2020 2020 2020 2020 2020 2020 6465 6620              def 
+00034330: 696e 7365 7274 2873 656c 6629 3a0a 2020  insert(self):.  
+00034340: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00034350: 6c66 2e69 6e73 6572 7465 6420 3d20 5472  lf.inserted = Tr
+00034360: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00034370: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+00034380: 2866 2247 4953 2069 6e73 6572 7465 6422  (f"GIS inserted"
+00034390: 290a 0a20 2020 2020 2020 2020 2020 2064  )..            d
+000343a0: 6566 2072 6574 7261 6374 2873 656c 6629  ef retract(self)
+000343b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000343c0: 2020 7365 6c66 2e69 6e73 6572 7465 6420    self.inserted 
+000343d0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+000343e0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+000343f0: 6465 6275 6728 6622 4749 5320 7265 7472  debug(f"GIS retr
+00034400: 6163 7465 6422 290a 0a20 2020 2020 2020  acted")..       
+00034410: 2020 2020 2064 6566 2074 7572 6e5f 6865       def turn_he
+00034420: 6174 6572 5f6f 6e28 7365 6c66 293a 0a20  ater_on(self):. 
+00034430: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00034440: 656c 662e 6865 6174 6564 203d 2054 7275  elf.heated = Tru
+00034450: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00034460: 2020 6c6f 6767 696e 672e 6465 6275 6728    logging.debug(
+00034470: 6622 4749 5320 6865 6174 6572 206f 6e22  f"GIS heater on"
+00034480: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
+00034490: 2020 2020 2020 2020 2020 2064 6566 2074             def t
+000344a0: 7572 6e5f 6865 6174 6572 5f6f 6666 2873  urn_heater_off(s
+000344b0: 656c 6629 3a0a 2020 2020 2020 2020 2020  elf):.          
+000344c0: 2020 2020 2020 7365 6c66 2e68 6561 7465        self.heate
+000344d0: 6420 3d20 4661 6c73 650a 2020 2020 2020  d = False.      
+000344e0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+000344f0: 672e 6465 6275 6728 6622 4749 5320 6865  g.debug(f"GIS he
+00034500: 6174 6572 206f 6666 2229 0a0a 2020 2020  ater off")..    
+00034510: 2020 2020 2020 2020 6465 6620 6f70 656e          def open
+00034520: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00034530: 2020 2020 2020 2020 7365 6c66 2e6f 7065          self.ope
+00034540: 6e65 6420 3d20 5472 7565 0a20 2020 2020  ned = True.     
+00034550: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00034560: 6e67 2e64 6562 7567 2866 2247 4953 206f  ng.debug(f"GIS o
+00034570: 7065 6e65 6422 290a 0a20 2020 2020 2020  pened")..       
+00034580: 2020 2020 2064 6566 2063 6c6f 7365 2873       def close(s
+00034590: 656c 6629 3a0a 2020 2020 2020 2020 2020  elf):.          
+000345a0: 2020 2020 2020 7365 6c66 2e6f 7065 6e65        self.opene
+000345b0: 6420 3d20 4661 6c73 650a 2020 2020 2020  d = False.      
+000345c0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+000345d0: 672e 6465 6275 6728 6622 4749 5320 636c  g.debug(f"GIS cl
+000345e0: 6f73 6564 2229 0a0a 2020 2020 2020 2020  osed")..        
+000345f0: 2320 696e 6974 6961 6c69 7365 2073 7973  # initialise sys
+00034600: 7465 6d0a 2020 2020 2020 2020 7365 6c66  tem.        self
+00034610: 2e63 6f6e 6e65 6374 696f 6e20 3d20 4465  .connection = De
+00034620: 6d6f 4d69 6372 6f73 636f 7065 436c 6965  moMicroscopeClie
+00034630: 6e74 2829 0a20 2020 2020 2020 2073 656c  nt().        sel
+00034640: 662e 7379 7374 656d 203d 2073 7973 7465  f.system = syste
+00034650: 6d5f 7365 7474 696e 6773 2020 2020 0a0a  m_settings    ..
+00034660: 2020 2020 2020 2020 7365 6c66 2e63 6861          self.cha
+00034670: 6d62 6572 203d 2043 6861 6d62 6572 5379  mber = ChamberSy
+00034680: 7374 656d 2873 7461 7465 3d22 5075 6d70  stem(state="Pump
+00034690: 6564 222c 200a 2020 2020 2020 2020 2020  ed", .          
+000346a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000346b0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000346c0: 6573 7375 7265 3d31 652d 3629 0a20 2020  essure=1e-6).   
+000346d0: 2020 2020 2073 656c 662e 7374 6167 655f       self.stage_
+000346e0: 7379 7374 656d 203d 2053 7461 6765 5379  system = StageSy
+000346f0: 7374 656d 2869 735f 686f 6d65 6420 3d20  stem(is_homed = 
+00034700: 5472 7565 2c20 0a20 2020 2020 2020 2020  True, .         
+00034710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034720: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00034730: 735f 6c69 6e6b 6564 3d20 5472 7565 2c0a  s_linked= True,.
+00034740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034760: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
+00034770: 3d46 6962 7365 6d53 7461 6765 506f 7369  =FibsemStagePosi
+00034780: 7469 6f6e 2878 3d30 2c20 793d 302c 207a  tion(x=0, y=0, z
+00034790: 3d30 2c20 723d 302c 2074 3d30 2c20 636f  =0, r=0, t=0, co
+000347a0: 6f72 6469 6e61 7465 5f73 7973 7465 6d3d  ordinate_system=
+000347b0: 2252 4157 2229 290a 2020 2020 2020 2020  "RAW")).        
+000347c0: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
+000347d0: 6e69 7075 6c61 746f 725f 7379 7374 656d  nipulator_system
+000347e0: 203d 204d 616e 6970 756c 6174 6f72 5379   = ManipulatorSy
+000347f0: 7374 656d 280a 2020 2020 2020 2020 2020  stem(.          
+00034800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034810: 2020 696e 7365 7274 6564 3d20 4661 6c73    inserted= Fals
+00034820: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00034830: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00034840: 6f73 6974 696f 6e20 3d20 4669 6273 656d  osition = Fibsem
+00034850: 4d61 6e69 7075 6c61 746f 7250 6f73 6974  ManipulatorPosit
+00034860: 696f 6e28 783d 302c 2079 3d30 2c20 7a3d  ion(x=0, y=0, z=
+00034870: 302c 2072 3d30 2c20 743d 302c 2063 6f6f  0, r=0, t=0, coo
+00034880: 7264 696e 6174 655f 7379 7374 656d 3d22  rdinate_system="
+00034890: 5241 5722 290a 2020 2020 2020 2020 2020  RAW").          
+000348a0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000348b0: 2020 2020 0a20 2020 2020 2020 2073 656c      .        sel
+000348c0: 662e 6769 735f 7379 7374 656d 203d 2047  f.gis_system = G
+000348d0: 6173 496e 6a65 6374 696f 6e53 7973 7465  asInjectionSyste
+000348e0: 6d28 6761 733d 2250 7420 6465 7022 290a  m(gas="Pt dep").
+000348f0: 0a20 2020 2020 2020 2073 656c 662e 656c  .        self.el
+00034900: 6563 7472 6f6e 5f73 7973 7465 6d20 3d20  ectron_system = 
+00034910: 4265 616d 5379 7374 656d 280a 2020 2020  BeamSystem(.    
+00034920: 2020 2020 2020 2020 6f6e 3d46 616c 7365          on=False
+00034930: 2c0a 2020 2020 2020 2020 2020 2020 626c  ,.            bl
+00034940: 616e 6b65 643d 5472 7565 2c0a 2020 2020  anked=True,.    
+00034950: 2020 2020 2020 2020 6265 616d 3d42 6561          beam=Bea
+00034960: 6d53 6574 7469 6e67 7328 0a20 2020 2020  mSettings(.     
+00034970: 2020 2020 2020 2020 2020 2062 6561 6d5f             beam_
+00034980: 7479 7065 3d42 6561 6d54 7970 652e 454c  type=BeamType.EL
+00034990: 4543 5452 4f4e 2c0a 2020 2020 2020 2020  ECTRON,.        
+000349a0: 2020 2020 2020 2020 776f 726b 696e 675f          working_
+000349b0: 6469 7374 616e 6365 3d34 2e30 652d 332c  distance=4.0e-3,
+000349c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000349d0: 2062 6561 6d5f 6375 7272 656e 743d 3165   beam_current=1e
+000349e0: 2d31 322c 0a20 2020 2020 2020 2020 2020  -12,.           
+000349f0: 2020 2020 2076 6f6c 7461 6765 3d32 3030       voltage=200
+00034a00: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00034a10: 2020 2068 6677 3d31 3530 652d 362c 0a20     hfw=150e-6,. 
+00034a20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00034a30: 6573 6f6c 7574 696f 6e3d 5b31 3533 362c  esolution=[1536,
+00034a40: 2031 3032 345d 2c0a 2020 2020 2020 2020   1024],.        
+00034a50: 2020 2020 2020 2020 6477 656c 6c5f 7469          dwell_ti
+00034a60: 6d65 3d31 652d 362c 0a20 2020 2020 2020  me=1e-6,.       
+00034a70: 2020 2020 2020 2020 2073 7469 676d 6174           stigmat
+00034a80: 696f 6e3d 506f 696e 7428 302c 2030 292c  ion=Point(0, 0),
+00034a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034aa0: 2073 6869 6674 3d50 6f69 6e74 2830 2c20   shift=Point(0, 
+00034ab0: 3029 2c0a 2020 2020 2020 2020 2020 2020  0),.            
+00034ac0: 2020 2020 7363 616e 5f72 6f74 6174 696f      scan_rotatio
+00034ad0: 6e3d 302c 0a20 2020 2020 2020 2020 2020  n=0,.           
+00034ae0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00034af0: 6465 7465 6374 6f72 3d46 6962 7365 6d44  detector=FibsemD
+00034b00: 6574 6563 746f 7253 6574 7469 6e67 7328  etectorSettings(
+00034b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034b20: 2074 7970 653d 2245 5444 222c 0a20 2020   type="ETD",.   
+00034b30: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00034b40: 653d 2253 6563 6f6e 6461 7279 456c 6563  e="SecondaryElec
+00034b50: 7472 6f6e 7322 2c0a 2020 2020 2020 2020  trons",.        
+00034b60: 2020 2020 2020 2020 6272 6967 6874 6e65          brightne
+00034b70: 7373 3d30 2e35 2c0a 2020 2020 2020 2020  ss=0.5,.        
+00034b80: 2020 2020 2020 2020 636f 6e74 7261 7374          contrast
+00034b90: 3d30 2e35 2c0a 2020 2020 2020 2020 2020  =0.5,.          
+00034ba0: 2020 290a 2020 2020 2020 2020 290a 2020    ).        ).  
+00034bb0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00034bc0: 2020 2073 656c 662e 696f 6e5f 7379 7374     self.ion_syst
+00034bd0: 656d 203d 2042 6561 6d53 7973 7465 6d28  em = BeamSystem(
+00034be0: 0a20 2020 2020 2020 2020 2020 206f 6e3d  .            on=
+00034bf0: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00034c00: 2020 2062 6c61 6e6b 6564 3d54 7275 652c     blanked=True,
+00034c10: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+00034c20: 6d3d 4265 616d 5365 7474 696e 6773 280a  m=BeamSettings(.
+00034c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034c40: 6265 616d 5f74 7970 653d 4265 616d 5479  beam_type=BeamTy
+00034c50: 7065 2e49 4f4e 2c0a 2020 2020 2020 2020  pe.ION,.        
+00034c60: 2020 2020 2020 2020 776f 726b 696e 675f          working_
+00034c70: 6469 7374 616e 6365 3d31 362e 3565 2d33  distance=16.5e-3
+00034c80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00034c90: 2020 6265 616d 5f63 7572 7265 6e74 3d32    beam_current=2
+00034ca0: 3065 2d31 322c 200a 2020 2020 2020 2020  0e-12, .        
+00034cb0: 2020 2020 2020 2020 766f 6c74 6167 653d          voltage=
+00034cc0: 3330 3030 302c 0a20 2020 2020 2020 2020  30000,.         
+00034cd0: 2020 2020 2020 2068 6677 3d31 3530 652d         hfw=150e-
+00034ce0: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
+00034cf0: 2020 2072 6573 6f6c 7574 696f 6e3d 5b31     resolution=[1
+00034d00: 3533 362c 2031 3032 345d 2c0a 2020 2020  536, 1024],.    
+00034d10: 2020 2020 2020 2020 2020 2020 6477 656c              dwel
+00034d20: 6c5f 7469 6d65 3d31 652d 362c 0a20 2020  l_time=1e-6,.   
+00034d30: 2020 2020 2020 2020 2020 2020 2073 7469               sti
+00034d40: 676d 6174 696f 6e3d 506f 696e 7428 302c  gmation=Point(0,
+00034d50: 2030 292c 0a20 2020 2020 2020 2020 2020   0),.           
+00034d60: 2020 2020 2073 6869 6674 3d50 6f69 6e74       shift=Point
+00034d70: 2830 2c20 3029 2c0a 2020 2020 2020 2020  (0, 0),.        
+00034d80: 2020 2020 2020 2020 7363 616e 5f72 6f74          scan_rot
+00034d90: 6174 696f 6e3d 302c 0a20 2020 2020 2020  ation=0,.       
+00034da0: 2020 2020 2020 2020 2029 2c20 0a20 2020           ), .   
+00034db0: 2020 2020 2020 2020 2064 6574 6563 746f           detecto
+00034dc0: 723d 4669 6273 656d 4465 7465 6374 6f72  r=FibsemDetector
+00034dd0: 5365 7474 696e 6773 280a 2020 2020 2020  Settings(.      
+00034de0: 2020 2020 2020 2020 2020 7479 7065 3d22            type="
+00034df0: 4554 4422 2c0a 2020 2020 2020 2020 2020  ETD",.          
+00034e00: 2020 2020 2020 6d6f 6465 3d22 5365 636f        mode="Seco
+00034e10: 6e64 6172 7945 6c65 6374 726f 6e73 222c  ndaryElectrons",
+00034e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034e30: 2062 7269 6768 746e 6573 733d 302e 352c   brightness=0.5,
+00034e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034e50: 2063 6f6e 7472 6173 743d 302e 352c 0a20   contrast=0.5,. 
+00034e60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00034e70: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00034e80: 656c 662e 7374 6167 655f 6973 5f63 6f6d  elf.stage_is_com
+00034e90: 7075 7374 6167 653a 2062 6f6f 6c20 3d20  pustage: bool = 
+00034ea0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+00034eb0: 200a 2020 2020 2020 2020 2320 7573 6572   .        # user
+00034ec0: 2c20 6578 7065 7269 6d65 6e74 206d 6574  , experiment met
+00034ed0: 6164 6174 610a 2020 2020 2020 2020 2320  adata.        # 
+00034ee0: 544f 444f 3a20 7265 6d6f 7665 206f 6e63  TODO: remove onc
+00034ef0: 6520 6462 2069 6e74 6567 7261 7465 640a  e db integrated.
+00034f00: 2020 2020 2020 2020 7365 6c66 2e75 7365          self.use
+00034f10: 7220 3d20 4669 6273 656d 5573 6572 2e66  r = FibsemUser.f
+00034f20: 726f 6d5f 656e 7669 726f 6e6d 656e 7428  rom_environment(
+00034f30: 290a 2020 2020 2020 2020 7365 6c66 2e65  ).        self.e
+00034f40: 7870 6572 696d 656e 7420 3d20 4669 6273  xperiment = Fibs
+00034f50: 656d 4578 7065 7269 6d65 6e74 2829 0a0a  emExperiment()..
+00034f60: 2020 2020 2020 2020 2320 6c6f 6767 696e          # loggin
+00034f70: 670a 2020 2020 2020 2020 6c6f 6767 696e  g.        loggin
+00034f80: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
+00034f90: 2263 7265 6174 655f 6d69 6372 6f73 636f  "create_microsco
+00034fa0: 7065 5f63 6c69 656e 7422 2c20 2273 7973  pe_client", "sys
+00034fb0: 7465 6d5f 7365 7474 696e 6773 223a 2073  tem_settings": s
+00034fc0: 7973 7465 6d5f 7365 7474 696e 6773 2e74  ystem_settings.t
+00034fd0: 6f5f 6469 6374 2829 7d29 0a0a 0a20 2020  o_dict()})...   
+00034fe0: 2064 6566 2063 6f6e 6e65 6374 5f74 6f5f   def connect_to_
+00034ff0: 6d69 6372 6f73 636f 7065 2873 656c 662c  microscope(self,
+00035000: 2069 705f 6164 6472 6573 733a 2073 7472   ip_address: str
+00035010: 2c20 706f 7274 3a20 696e 7420 3d20 3830  , port: int = 80
+00035020: 3830 293a 0a20 2020 2020 2020 200a 2020  80):.        .  
+00035030: 2020 2020 2020 2320 636f 6e6e 6563 7420        # connect 
+00035040: 746f 206d 6963 726f 7363 6f70 650a 2020  to microscope.  
+00035050: 2020 2020 2020 7365 6c66 2e63 6f6e 6e65        self.conne
+00035060: 6374 696f 6e2e 636f 6e6e 6563 7428 6970  ction.connect(ip
+00035070: 5f61 6464 7265 7373 3d69 705f 6164 6472  _address=ip_addr
+00035080: 6573 732c 2070 6f72 743d 706f 7274 290a  ess, port=port).
+00035090: 0a20 2020 2020 2020 2023 2073 7973 7465  .        # syste
+000350a0: 6d20 696e 666f 726d 6174 696f 6e0a 2020  m information.  
+000350b0: 2020 2020 2020 7365 6c66 2e73 7973 7465        self.syste
+000350c0: 6d2e 696e 666f 2e6d 6f64 656c 3d22 4465  m.info.model="De
+000350d0: 6d6f 4d69 6372 6f73 636f 7065 220a 2020  moMicroscope".  
+000350e0: 2020 2020 2020 7365 6c66 2e73 7973 7465        self.syste
+000350f0: 6d2e 696e 666f 2e73 6572 6961 6c5f 6e75  m.info.serial_nu
+00035100: 6d62 6572 3d22 3132 3334 3536 220a 2020  mber="123456".  
+00035110: 2020 2020 2020 7365 6c66 2e73 7973 7465        self.syste
+00035120: 6d2e 696e 666f 2e73 6f66 7477 6172 655f  m.info.software_
+00035130: 7665 7273 696f 6e3d 2230 2e31 220a 2020  version="0.1".  
+00035140: 2020 2020 2020 7365 6c66 2e73 7973 7465        self.syste
+00035150: 6d2e 696e 666f 2e68 6172 6477 6172 655f  m.info.hardware_
+00035160: 7665 7273 696f 6e3d 2276 302e 3233 220a  version="v0.23".
+00035170: 2020 2020 2020 2020 7365 6c66 2e73 7973          self.sys
+00035180: 7465 6d2e 696e 666f 2e69 705f 6164 6472  tem.info.ip_addr
+00035190: 6573 733d 6970 5f61 6464 7265 7373 0a20  ess=ip_address. 
+000351a0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+000351b0: 2320 7265 7365 7420 6265 616d 2073 6869  # reset beam shi
+000351c0: 6674 730a 2020 2020 2020 2020 7365 6c66  fts.        self
+000351d0: 2e72 6573 6574 5f62 6561 6d5f 7368 6966  .reset_beam_shif
+000351e0: 7473 2829 0a0a 2020 2020 2020 2020 2320  ts()..        # 
+000351f0: 7573 6572 206c 6f67 6769 6e67 0a20 2020  user logging.   
+00035200: 2020 2020 2069 6e66 6f20 3d20 7365 6c66       info = self
+00035210: 2e73 7973 7465 6d2e 696e 666f 0a20 2020  .system.info.   
+00035220: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00035230: 6f28 6622 4d69 6372 6f73 636f 7065 2063  o(f"Microscope c
+00035240: 6c69 656e 7420 636f 6e6e 6563 7465 6420  lient connected 
+00035250: 746f 207b 696e 666f 2e6d 6f64 656c 7d20  to {info.model} 
+00035260: 7769 7468 2073 6572 6961 6c20 6e75 6d62  with serial numb
+00035270: 6572 207b 696e 666f 2e73 6572 6961 6c5f  er {info.serial_
+00035280: 6e75 6d62 6572 7d20 616e 6420 736f 6674  number} and soft
+00035290: 7761 7265 2076 6572 7369 6f6e 207b 696e  ware version {in
+000352a0: 666f 2e73 6f66 7477 6172 655f 7665 7273  fo.software_vers
+000352b0: 696f 6e7d 2229 2020 2020 2020 200a 0a20  ion}")       .. 
+000352c0: 2020 2020 2020 2023 206c 6f67 6769 6e67         # logging
+000352d0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+000352e0: 2e64 6562 7567 287b 226d 7367 223a 2022  .debug({"msg": "
+000352f0: 636f 6e6e 6563 745f 746f 5f6d 6963 726f  connect_to_micro
+00035300: 7363 6f70 6522 2c20 2269 705f 6164 6472  scope", "ip_addr
+00035310: 6573 7322 3a20 6970 5f61 6464 7265 7373  ess": ip_address
+00035320: 2c20 2270 6f72 7422 3a20 706f 7274 2c20  , "port": port, 
+00035330: 2273 7973 7465 6d5f 696e 666f 223a 2069  "system_info": i
+00035340: 6e66 6f2e 746f 5f64 6963 7428 2920 7d29  nfo.to_dict() })
+00035350: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00035360: 0a0a 2020 2020 6465 6620 6469 7363 6f6e  ..    def discon
+00035370: 6e65 6374 2873 656c 6629 3a0a 2020 2020  nect(self):.    
+00035380: 2020 2020 7365 6c66 2e63 6f6e 6e65 6374      self.connect
+00035390: 696f 6e2e 6469 7363 6f6e 6e65 6374 2829  ion.disconnect()
+000353a0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+000353b0: 2e69 6e66 6f28 6622 4469 7363 6f6e 6e65  .info(f"Disconne
+000353c0: 6374 6564 2066 726f 6d20 4465 6d6f 204d  cted from Demo M
+000353d0: 6963 726f 7363 6f70 6522 290a 0a20 2020  icroscope")..   
+000353e0: 2064 6566 2061 6371 7569 7265 5f69 6d61   def acquire_ima
+000353f0: 6765 2873 656c 662c 2069 6d61 6765 5f73  ge(self, image_s
+00035400: 6574 7469 6e67 733a 2049 6d61 6765 5365  ettings: ImageSe
+00035410: 7474 696e 6773 2920 2d3e 2046 6962 7365  ttings) -> Fibse
+00035420: 6d49 6d61 6765 3a0a 2020 2020 2020 2020  mImage:.        
+00035430: 5f63 6865 636b 5f62 6561 6d28 696d 6167  _check_beam(imag
+00035440: 655f 7365 7474 696e 6773 2e62 6561 6d5f  e_settings.beam_
+00035450: 7479 7065 2c20 7365 6c66 2e73 7973 7465  type, self.syste
+00035460: 6d29 0a20 2020 2020 2020 2076 6677 203d  m).        vfw =
+00035470: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
+00035480: 6866 7720 2a20 696d 6167 655f 7365 7474  hfw * image_sett
+00035490: 696e 6773 2e72 6573 6f6c 7574 696f 6e5b  ings.resolution[
+000354a0: 315d 202f 2069 6d61 6765 5f73 6574 7469  1] / image_setti
+000354b0: 6e67 732e 7265 736f 6c75 7469 6f6e 5b30  ngs.resolution[0
+000354c0: 5d0a 2020 2020 2020 2020 7069 7865 6c73  ].        pixels
+000354d0: 697a 6520 3d20 506f 696e 7428 696d 6167  ize = Point(imag
+000354e0: 655f 7365 7474 696e 6773 2e68 6677 202f  e_settings.hfw /
+000354f0: 2069 6d61 6765 5f73 6574 7469 6e67 732e   image_settings.
+00035500: 7265 736f 6c75 7469 6f6e 5b30 5d2c 200a  resolution[0], .
+00035510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035520: 2020 2020 2020 2020 2020 7666 7720 2f20            vfw / 
+00035530: 696d 6167 655f 7365 7474 696e 6773 2e72  image_settings.r
+00035540: 6573 6f6c 7574 696f 6e5b 315d 290a 2020  esolution[1]).  
+00035550: 2020 2020 2020 0a20 2020 2020 2020 206c        .        l
+00035560: 6f67 6769 6e67 2e69 6e66 6f28 6622 6163  ogging.info(f"ac
+00035570: 7175 6972 696e 6720 6e65 7720 7b69 6d61  quiring new {ima
+00035580: 6765 5f73 6574 7469 6e67 732e 6265 616d  ge_settings.beam
+00035590: 5f74 7970 652e 6e61 6d65 7d20 696d 6167  _type.name} imag
+000355a0: 652e 2229 0a20 2020 2020 2020 2069 6d61  e.").        ima
+000355b0: 6765 203d 2046 6962 7365 6d49 6d61 6765  ge = FibsemImage
+000355c0: 280a 2020 2020 2020 2020 2020 2020 6461  (.            da
+000355d0: 7461 3d6e 702e 7261 6e64 6f6d 2e72 616e  ta=np.random.ran
+000355e0: 6469 6e74 286c 6f77 3d30 2c20 6869 6768  dint(low=0, high
+000355f0: 3d32 3536 2c20 0a20 2020 2020 2020 2020  =256, .         
+00035600: 2020 2020 2020 2073 697a 653d 2869 6d61         size=(ima
+00035610: 6765 5f73 6574 7469 6e67 732e 7265 736f  ge_settings.reso
+00035620: 6c75 7469 6f6e 5b31 5d2c 696d 6167 655f  lution[1],image_
+00035630: 7365 7474 696e 6773 2e72 6573 6f6c 7574  settings.resolut
+00035640: 696f 6e5b 305d 292c 200a 2020 2020 2020  ion[0]), .      
+00035650: 2020 2020 2020 2020 2020 6474 7970 653d            dtype=
+00035660: 6e70 2e75 696e 7438 292c 0a20 2020 2020  np.uint8),.     
+00035670: 2020 2020 2020 206d 6574 6164 6174 613d         metadata=
+00035680: 4669 6273 656d 496d 6167 654d 6574 6164  FibsemImageMetad
+00035690: 6174 6128 696d 6167 655f 7365 7474 696e  ata(image_settin
+000356a0: 6773 3d69 6d61 6765 5f73 6574 7469 6e67  gs=image_setting
+000356b0: 732c 200a 2020 2020 2020 2020 2020 2020  s, .            
+000356c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000356d0: 2020 2020 2020 2020 2020 2020 7069 7865              pixe
+000356e0: 6c5f 7369 7a65 3d70 6978 656c 7369 7a65  l_size=pixelsize
+000356f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00035700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035710: 2020 2020 2020 2020 2020 6d69 6372 6f73            micros
+00035720: 636f 7065 5f73 7461 7465 3d73 656c 662e  cope_state=self.
+00035730: 6765 745f 6d69 6372 6f73 636f 7065 5f73  get_microscope_s
+00035740: 7461 7465 2862 6561 6d5f 7479 7065 3d69  tate(beam_type=i
+00035750: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+00035760: 616d 5f74 7970 6529 2c0a 2020 2020 2020  am_type),.      
+00035770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035790: 2020 7379 7374 656d 3d73 656c 662e 7379    system=self.sy
+000357a0: 7374 656d 0a20 2020 2020 2020 2020 2020  stem.           
+000357b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000357c0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000357d0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000357e0: 2020 696d 6167 652e 6d65 7461 6461 7461    image.metadata
+000357f0: 2e75 7365 7220 3d20 7365 6c66 2e75 7365  .user = self.use
+00035800: 720a 2020 2020 2020 2020 696d 6167 652e  r.        image.
+00035810: 6d65 7461 6461 7461 2e65 7870 6572 696d  metadata.experim
+00035820: 656e 7420 3d20 7365 6c66 2e65 7870 6572  ent = self.exper
+00035830: 696d 656e 740a 2020 2020 2020 2020 696d  iment.        im
+00035840: 6167 652e 6d65 7461 6461 7461 2e73 7973  age.metadata.sys
+00035850: 7465 6d20 3d20 7365 6c66 2e73 7973 7465  tem = self.syste
+00035860: 6d0a 0a20 2020 2020 2020 2069 6620 696d  m..        if im
+00035870: 6167 655f 7365 7474 696e 6773 2e62 6561  age_settings.bea
+00035880: 6d5f 7479 7065 2069 7320 4265 616d 5479  m_type is BeamTy
+00035890: 7065 2e45 4c45 4354 524f 4e3a 0a20 2020  pe.ELECTRON:.   
+000358a0: 2020 2020 2020 2020 2073 656c 662e 5f65           self._e
+000358b0: 625f 696d 6167 6520 3d20 696d 6167 650a  b_image = image.
+000358c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000358d0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000358e0: 6962 5f69 6d61 6765 203d 2069 6d61 6765  ib_image = image
+000358f0: 0a0a 2020 2020 2020 2020 6c6f 6767 696e  ..        loggin
+00035900: 672e 6465 6275 6728 7b22 6d73 6722 3a20  g.debug({"msg": 
+00035910: 2261 6371 7569 7265 5f69 6d61 6765 222c  "acquire_image",
+00035920: 2022 6d65 7461 6461 7461 223a 2069 6d61   "metadata": ima
+00035930: 6765 2e6d 6574 6164 6174 612e 746f 5f64  ge.metadata.to_d
+00035940: 6963 7428 297d 290a 0a20 2020 2020 2020  ict()})..       
+00035950: 2072 6574 7572 6e20 696d 6167 650a 0a20   return image.. 
+00035960: 2020 2064 6566 206c 6173 745f 696d 6167     def last_imag
+00035970: 6528 7365 6c66 2c20 6265 616d 5f74 7970  e(self, beam_typ
+00035980: 653a 2042 6561 6d54 7970 6529 202d 3e20  e: BeamType) -> 
+00035990: 4669 6273 656d 496d 6167 653a 0a20 2020  FibsemImage:.   
+000359a0: 2020 2020 205f 6368 6563 6b5f 6265 616d       _check_beam
+000359b0: 2862 6561 6d5f 7479 7065 2c20 7365 6c66  (beam_type, self
+000359c0: 2e73 7973 7465 6d29 0a0a 2020 2020 2020  .system)..      
+000359d0: 2020 696d 6167 6520 3d20 7365 6c66 2e5f    image = self._
+000359e0: 6562 5f69 6d61 6765 2069 6620 6265 616d  eb_image if beam
+000359f0: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
+00035a00: 652e 454c 4543 5452 4f4e 2065 6c73 6520  e.ELECTRON else 
+00035a10: 7365 6c66 2e5f 6962 5f69 6d61 6765 0a20  self._ib_image. 
+00035a20: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00035a30: 6562 7567 287b 226d 7367 223a 2022 6c61  ebug({"msg": "la
+00035a40: 7374 5f69 6d61 6765 222c 2022 6265 616d  st_image", "beam
+00035a50: 5f74 7970 6522 3a20 6265 616d 5f74 7970  _type": beam_typ
+00035a60: 652e 6e61 6d65 2c20 226d 6574 6164 6174  e.name, "metadat
+00035a70: 6122 3a20 696d 6167 652e 6d65 7461 6461  a": image.metada
+00035a80: 7461 2e74 6f5f 6469 6374 2829 7d29 0a20  ta.to_dict()}). 
+00035a90: 2020 2020 2020 2072 6574 7572 6e20 696d         return im
+00035aa0: 6167 650a 2020 2020 0a20 2020 2064 6566  age.    .    def
+00035ab0: 2061 6371 7569 7265 5f63 6861 6d62 6572   acquire_chamber
+00035ac0: 5f69 6d61 6765 2873 656c 6629 202d 3e20  _image(self) -> 
+00035ad0: 4669 6273 656d 496d 6167 653a 0a20 2020  FibsemImage:.   
+00035ae0: 2020 2020 2022 2222 4163 7175 6972 6520       """Acquire 
+00035af0: 616e 2069 6d61 6765 206f 6620 7468 6520  an image of the 
+00035b00: 6368 616d 6265 7220 696e 7369 6465 2e22  chamber inside."
+00035b10: 2222 0a20 2020 2020 2020 2069 6d61 6765  "".        image
+00035b20: 203d 2046 6962 7365 6d49 6d61 6765 280a   = FibsemImage(.
+00035b30: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00035b40: 3d6e 702e 7261 6e64 6f6d 2e72 616e 6469  =np.random.randi
+00035b50: 6e74 286c 6f77 3d30 2c20 6869 6768 3d32  nt(low=0, high=2
+00035b60: 3536 2c20 0a20 2020 2020 2020 2020 2020  56, .           
+00035b70: 2020 2020 2073 697a 653d 2831 3032 342c       size=(1024,
+00035b80: 3135 3336 292c 200a 2020 2020 2020 2020  1536), .        
+00035b90: 2020 2020 2020 2020 6474 7970 653d 6e70          dtype=np
+00035ba0: 2e75 696e 7438 292c 0a20 2020 2020 2020  .uint8),.       
+00035bb0: 2020 2020 2020 2020 206d 6574 6164 6174           metadat
+00035bc0: 613d 4e6f 6e65 290a 2020 2020 2020 2020  a=None).        
+00035bd0: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
+00035be0: 6d73 6722 3a20 2261 6371 7569 7265 5f63  msg": "acquire_c
+00035bf0: 6861 6d62 6572 5f69 6d61 6765 227d 290a  hamber_image"}).
+00035c00: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+00035c10: 6d61 6765 0a0a 2020 2020 6465 6620 6c69  mage..    def li
+00035c20: 7665 5f69 6d61 6769 6e67 2873 656c 662c  ve_imaging(self,
+00035c30: 2069 6d61 6765 5f73 6574 7469 6e67 733a   image_settings:
+00035c40: 2049 6d61 6765 5365 7474 696e 6773 2c20   ImageSettings, 
+00035c50: 696d 6167 655f 7175 6575 653a 2051 7565  image_queue: Que
+00035c60: 7565 2c20 7374 6f70 5f65 7665 6e74 3a20  ue, stop_event: 
+00035c70: 7468 7265 6164 696e 672e 4576 656e 7429  threading.Event)
+00035c80: 3a0a 2020 2020 2020 2020 7365 6c66 2e69  :.        self.i
+00035c90: 6d61 6765 5f71 7565 7565 203d 2069 6d61  mage_queue = ima
+00035ca0: 6765 5f71 7565 7565 0a20 2020 2020 2020  ge_queue.       
+00035cb0: 2073 656c 662e 7374 6f70 5f65 7665 6e74   self.stop_event
+00035cc0: 203d 2073 746f 705f 6576 656e 740a 2020   = stop_event.  
+00035cd0: 2020 2020 2020 5f63 6865 636b 5f62 6561        _check_bea
+00035ce0: 6d28 696d 6167 655f 7365 7474 696e 6773  m(image_settings
+00035cf0: 2e62 6561 6d5f 7479 7065 2c20 7365 6c66  .beam_type, self
+00035d00: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
+00035d10: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+00035d20: 4c69 7665 2069 6d61 6769 6e67 3a20 7b69  Live imaging: {i
+00035d30: 6d61 6765 5f73 6574 7469 6e67 732e 6265  mage_settings.be
+00035d40: 616d 5f74 7970 657d 2229 0a20 2020 2020  am_type}").     
+00035d50: 2020 2077 6869 6c65 206e 6f74 2073 746f     while not sto
+00035d60: 705f 6576 656e 742e 6973 5f73 6574 2829  p_event.is_set()
+00035d70: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+00035d80: 6167 6520 3d20 7365 6c66 2e61 6371 7569  age = self.acqui
+00035d90: 7265 5f69 6d61 6765 2869 6d61 6765 5f73  re_image(image_s
+00035da0: 6574 7469 6e67 7329 0a20 2020 2020 2020  ettings).       
+00035db0: 2020 2020 2069 6d61 6765 5f71 7565 7565       image_queue
+00035dc0: 2e70 7574 2869 6d61 6765 290a 2020 2020  .put(image).    
+00035dd0: 2020 2020 2020 2020 7365 6c66 2e73 6c65          self.sle
+00035de0: 6570 5f74 696d 6520 3d20 696d 6167 655f  ep_time = image_
+00035df0: 7365 7474 696e 6773 2e64 7765 6c6c 5f74  settings.dwell_t
+00035e00: 696d 652a 696d 6167 655f 7365 7474 696e  ime*image_settin
+00035e10: 6773 2e72 6573 6f6c 7574 696f 6e5b 305d  gs.resolution[0]
+00035e20: 2a69 6d61 6765 5f73 6574 7469 6e67 732e  *image_settings.
+00035e30: 7265 736f 6c75 7469 6f6e 5b31 5d0a 2020  resolution[1].  
+00035e40: 2020 2020 2020 2020 2020 7469 6d65 2e73            time.s
+00035e50: 6c65 6570 2873 656c 662e 736c 6565 705f  leep(self.sleep_
+00035e60: 7469 6d65 290a 0a20 2020 2040 7468 7265  time)..    @thre
+00035e70: 6164 5f77 6f72 6b65 720a 2020 2020 6465  ad_worker.    de
+00035e80: 6620 636f 6e73 756d 655f 696d 6167 655f  f consume_image_
+00035e90: 7175 6575 6528 7365 6c66 2c20 7061 7265  queue(self, pare
+00035ea0: 6e74 5f75 6920 3d20 4e6f 6e65 2c20 736c  nt_ui = None, sl
+00035eb0: 6565 7020 3d20 302e 3129 3a0a 0a20 2020  eep = 0.1):..   
+00035ec0: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00035ed0: 6f28 2243 6f6e 7375 6d69 6e67 2069 6d61  o("Consuming ima
+00035ee0: 6765 2071 7565 7565 2229 0a0a 2020 2020  ge queue")..    
+00035ef0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00035f00: 2020 2020 2077 6869 6c65 206e 6f74 2073       while not s
+00035f10: 656c 662e 7374 6f70 5f65 7665 6e74 2e69  elf.stop_event.i
+00035f20: 735f 7365 7428 293a 0a20 2020 2020 2020  s_set():.       
+00035f30: 2020 2020 2020 2020 2069 6d61 6765 203d           image =
+00035f40: 2073 656c 662e 696d 6167 655f 7175 6575   self.image_queu
+00035f50: 652e 6765 7428 7469 6d65 6f75 743d 3129  e.get(timeout=1)
+00035f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035f70: 2069 6620 696d 6167 652e 6d65 7461 6461   if image.metada
+00035f80: 7461 2e69 6d61 6765 5f73 6574 7469 6e67  ta.image_setting
+00035f90: 732e 7361 7665 3a0a 2020 2020 2020 2020  s.save:.        
+00035fa0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00035fb0: 652e 6d65 7461 6461 7461 2e69 6d61 6765  e.metadata.image
+00035fc0: 5f73 6574 7469 6e67 732e 6669 6c65 6e61  _settings.filena
+00035fd0: 6d65 203d 2066 227b 696d 6167 652e 6d65  me = f"{image.me
+00035fe0: 7461 6461 7461 2e69 6d61 6765 5f73 6574  tadata.image_set
+00035ff0: 7469 6e67 732e 6669 6c65 6e61 6d65 7d5f  tings.filename}_
+00036000: 7b75 7469 6c73 2e63 7572 7265 6e74 5f74  {utils.current_t
+00036010: 696d 6573 7461 6d70 2829 7d22 0a20 2020  imestamp()}".   
+00036020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036030: 2066 696c 656e 616d 6520 3d20 6f73 2e70   filename = os.p
+00036040: 6174 682e 6a6f 696e 2869 6d61 6765 2e6d  ath.join(image.m
+00036050: 6574 6164 6174 612e 696d 6167 655f 7365  etadata.image_se
+00036060: 7474 696e 6773 2e70 6174 682c 2069 6d61  ttings.path, ima
+00036070: 6765 2e6d 6574 6164 6174 612e 696d 6167  ge.metadata.imag
+00036080: 655f 7365 7474 696e 6773 2e66 696c 656e  e_settings.filen
+00036090: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+000360a0: 2020 2020 2020 2020 2069 6d61 6765 2e73           image.s
+000360b0: 6176 6528 7061 7468 3d66 696c 656e 616d  ave(path=filenam
+000360c0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000360d0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+000360e0: 6e66 6f28 6622 5361 7665 6420 696d 6167  nfo(f"Saved imag
+000360f0: 6520 746f 207b 6669 6c65 6e61 6d65 7d22  e to {filename}"
+00036100: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00036110: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+00036120: 6622 496d 6167 653a 207b 696d 6167 652e  f"Image: {image.
+00036130: 6461 7461 2e73 6861 7065 7d22 290a 2020  data.shape}").  
+00036140: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00036150: 6767 696e 672e 696e 666f 2866 222d 2220  gging.info(f"-" 
+00036160: 2a20 3530 290a 0a20 2020 2020 2020 2020  * 50)..         
+00036170: 2020 2020 2020 2069 6620 7061 7265 6e74         if parent
+00036180: 5f75 6920 6973 206e 6f74 204e 6f6e 653a  _ui is not None:
+00036190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000361a0: 2020 2020 2020 2020 2070 6172 656e 745f           parent_
+000361b0: 7569 2e6c 6976 655f 696d 6167 696e 675f  ui.live_imaging_
+000361c0: 7369 676e 616c 2e65 6d69 7428 7b22 696d  signal.emit({"im
+000361d0: 6167 6522 3a20 696d 6167 657d 290a 2020  age": image}).  
+000361e0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+000361f0: 6d65 2e73 6c65 6570 2873 6c65 6570 290a  me.sleep(sleep).
+00036200: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00036210: 6579 626f 6172 6449 6e74 6572 7275 7074  eyboardInterrupt
+00036220: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00036230: 6c66 2e73 746f 705f 6576 656e 740a 2020  lf.stop_event.  
+00036240: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+00036250: 672e 696e 666f 2822 4b65 7962 6f61 7264  g.info("Keyboard
+00036260: 2069 6e74 6572 7275 7074 2c20 7374 6f70   interrupt, stop
+00036270: 7069 6e67 206c 6976 6520 696d 6167 696e  ping live imagin
+00036280: 6722 290a 2020 2020 2020 2020 6578 6365  g").        exce
+00036290: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+000362a0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000362b0: 656c 662e 7374 6f70 5f65 7665 6e74 2e73  elf.stop_event.s
+000362c0: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
+000362d0: 2069 6d70 6f72 7420 7472 6163 6562 6163   import tracebac
+000362e0: 6b0a 2020 2020 2020 2020 2020 2020 6c6f  k.            lo
+000362f0: 6767 696e 672e 6572 726f 7228 7472 6163  gging.error(trac
+00036300: 6562 6163 6b2e 666f 726d 6174 5f65 7863  eback.format_exc
+00036310: 2829 290a 2020 2020 2020 2020 6669 6e61  ()).        fina
+00036320: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
+00036330: 206c 6f67 6769 6e67 2e69 6e66 6f28 2253   logging.info("S
+00036340: 746f 7070 6564 2074 6872 6561 6420 696d  topped thread im
+00036350: 6167 6520 636f 6e73 756d 7074 696f 6e22  age consumption"
+00036360: 290a 2020 2020 0a20 2020 2064 6566 2061  ).    .    def a
+00036370: 7574 6f63 6f6e 7472 6173 7428 7365 6c66  utocontrast(self
+00036380: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+00036390: 6d54 7970 6529 202d 3e20 4e6f 6e65 3a0a  mType) -> None:.
+000363a0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+000363b0: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+000363c0: 656c 662e 7379 7374 656d 290a 2020 2020  elf.system).    
+000363d0: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+000363e0: 6728 7b22 6d73 6722 3a20 2261 7574 6f63  g({"msg": "autoc
+000363f0: 6f6e 7472 6173 7422 2c20 2262 6561 6d5f  ontrast", "beam_
+00036400: 7479 7065 223a 2062 6561 6d5f 7479 7065  type": beam_type
+00036410: 2e6e 616d 657d 290a 0a20 2020 2064 6566  .name})..    def
+00036420: 2061 7574 6f5f 666f 6375 7328 7365 6c66   auto_focus(self
+00036430: 2c20 6265 616d 5f74 7970 653a 2042 6561  , beam_type: Bea
+00036440: 6d54 7970 6529 202d 3e20 4e6f 6e65 3a0a  mType) -> None:.
+00036450: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+00036460: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+00036470: 656c 662e 7379 7374 656d 290a 2020 2020  elf.system).    
+00036480: 2020 2020 6c6f 6767 696e 672e 6465 6275      logging.debu
+00036490: 6728 7b22 6d73 6722 3a20 2261 7574 6f5f  g({"msg": "auto_
+000364a0: 666f 6375 7322 2c20 2262 6561 6d5f 7479  focus", "beam_ty
+000364b0: 7065 223a 2062 6561 6d5f 7479 7065 2e6e  pe": beam_type.n
+000364c0: 616d 657d 290a 2020 2020 2020 2020 0a20  ame}).        . 
+000364d0: 2020 2064 6566 2062 6561 6d5f 7368 6966     def beam_shif
+000364e0: 7428 7365 6c66 2c20 6478 3a20 666c 6f61  t(self, dx: floa
+000364f0: 742c 2064 793a 2066 6c6f 6174 2c20 6265  t, dy: float, be
+00036500: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
+00036510: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+00036520: 2020 2020 5f63 6865 636b 5f62 6561 6d28      _check_beam(
+00036530: 6265 616d 5f74 7970 652c 2073 656c 662e  beam_type, self.
+00036540: 7379 7374 656d 290a 0a20 2020 2020 2020  system)..       
+00036550: 206c 6f67 6769 6e67 2e64 6562 7567 287b   logging.debug({
+00036560: 226d 7367 223a 2022 6265 616d 5f73 6869  "msg": "beam_shi
+00036570: 6674 222c 2022 6478 223a 2064 782c 2022  ft", "dx": dx, "
+00036580: 6479 223a 2064 792c 2022 6265 616d 5f74  dy": dy, "beam_t
+00036590: 7970 6522 3a20 6265 616d 5f74 7970 652e  ype": beam_type.
+000365a0: 6e61 6d65 7d29 2020 2020 2020 2020 200a  name})         .
+000365b0: 0a20 2020 2020 2020 2069 6620 6265 616d  .        if beam
+000365c0: 5f74 7970 6520 3d3d 2042 6561 6d54 7970  _type == BeamTyp
+000365d0: 652e 454c 4543 5452 4f4e 3a0a 2020 2020  e.ELECTRON:.    
+000365e0: 2020 2020 2020 2020 7365 6c66 2e65 6c65          self.ele
+000365f0: 6374 726f 6e5f 7379 7374 656d 2e62 6561  ctron_system.bea
+00036600: 6d2e 7368 6966 7420 2b3d 2050 6f69 6e74  m.shift += Point
+00036610: 2866 6c6f 6174 2864 7829 2c20 666c 6f61  (float(dx), floa
+00036620: 7428 6479 2929 0a20 2020 2020 2020 2065  t(dy)).        e
+00036630: 6c69 6620 6265 616d 5f74 7970 6520 3d3d  lif beam_type ==
+00036640: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
+00036650: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00036660: 696f 6e5f 7379 7374 656d 2e62 6561 6d2e  ion_system.beam.
+00036670: 7368 6966 7420 2b3d 2050 6f69 6e74 2866  shift += Point(f
+00036680: 6c6f 6174 2864 7829 2c20 666c 6f61 7428  loat(dx), float(
+00036690: 6479 2929 0a0a 2020 200a 2020 2020 6465  dy))..   .    de
+000366a0: 6620 7361 6665 5f61 6273 6f6c 7574 655f  f safe_absolute_
+000366b0: 7374 6167 655f 6d6f 7665 6d65 6e74 2873  stage_movement(s
+000366c0: 656c 662c 2073 7461 6765 5f70 6f73 6974  elf, stage_posit
+000366d0: 696f 6e3a 2046 6962 7365 6d53 7461 6765  ion: FibsemStage
+000366e0: 506f 7369 7469 6f6e 2920 2d3e 204e 6f6e  Position) -> Non
+000366f0: 653a 0a20 2020 2020 2020 2022 2222 4d6f  e:.        """Mo
+00036700: 7665 2074 6865 2073 7461 6765 2074 6f20  ve the stage to 
+00036710: 7468 6520 7370 6563 6966 6965 6420 706f  the specified po
+00036720: 7369 7469 6f6e 2075 7369 6e67 2073 6166  sition using saf
+00036730: 6520 7374 7261 7465 6779 2222 220a 2020  e strategy""".  
+00036740: 2020 2020 2020 7365 6c66 2e6d 6f76 655f        self.move_
+00036750: 7374 6167 655f 6162 736f 6c75 7465 2873  stage_absolute(s
+00036760: 7461 6765 5f70 6f73 6974 696f 6e29 0a0a  tage_position)..
+00036770: 2020 2020 6465 6620 7072 6f6a 6563 745f      def project_
+00036780: 7374 6162 6c65 5f6d 6f76 6528 7365 6c66  stable_move(self
+00036790: 2c20 6478 3a66 6c6f 6174 2c20 6479 3a66  , dx:float, dy:f
+000367a0: 6c6f 6174 2c20 6265 616d 5f74 7970 653a  loat, beam_type:
+000367b0: 4265 616d 5479 7065 2c20 6261 7365 5f70  BeamType, base_p
+000367c0: 6f73 6974 696f 6e3a 4669 6273 656d 5374  osition:FibsemSt
+000367d0: 6167 6550 6f73 6974 696f 6e29 202d 3e20  agePosition) -> 
+000367e0: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+000367f0: 696f 6e3a 0a0a 2020 2020 2020 2020 7265  ion:..        re
+00036800: 7475 726e 2062 6173 655f 706f 7369 7469  turn base_positi
+00036810: 6f6e 202b 2046 6962 7365 6d53 7461 6765  on + FibsemStage
+00036820: 506f 7369 7469 6f6e 2878 3d64 782c 2079  Position(x=dx, y
+00036830: 3d64 7929 2023 2054 4f44 4f3a 2069 6d70  =dy) # TODO: imp
+00036840: 6c65 6d65 6e74 0a0a 2020 2020 6465 6620  lement..    def 
+00036850: 6d6f 7665 5f73 7461 6765 5f61 6273 6f6c  move_stage_absol
+00036860: 7574 6528 7365 6c66 2c20 706f 7369 7469  ute(self, positi
+00036870: 6f6e 3a20 4669 6273 656d 5374 6167 6550  on: FibsemStageP
+00036880: 6f73 6974 696f 6e29 202d 3e20 4e6f 6e65  osition) -> None
+00036890: 3a0a 2020 2020 2020 2020 2222 224d 6f76  :.        """Mov
+000368a0: 6520 7468 6520 7374 6167 6520 746f 2074  e the stage to t
+000368b0: 6865 2073 7065 6369 6669 6564 2070 6f73  he specified pos
+000368c0: 6974 696f 6e2e 2222 220a 2020 2020 2020  ition.""".      
+000368d0: 2020 5f63 6865 636b 5f73 7461 6765 5f6d    _check_stage_m
+000368e0: 6f76 656d 656e 7428 7365 6c66 2e73 7973  ovement(self.sys
+000368f0: 7465 6d2c 2070 6f73 6974 696f 6e29 0a20  tem, position). 
+00036900: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00036910: 2320 6f6e 6c79 2061 7373 6967 6e20 6966  # only assign if
+00036920: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
+00036930: 2020 6966 2070 6f73 6974 696f 6e2e 7820    if position.x 
+00036940: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00036950: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+00036960: 6167 655f 7379 7374 656d 2e70 6f73 6974  age_system.posit
+00036970: 696f 6e2e 7820 3d20 706f 7369 7469 6f6e  ion.x = position
+00036980: 2e78 0a20 2020 2020 2020 2069 6620 706f  .x.        if po
+00036990: 7369 7469 6f6e 2e79 2069 7320 6e6f 7420  sition.y is not 
+000369a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000369b0: 2020 7365 6c66 2e73 7461 6765 5f73 7973    self.stage_sys
+000369c0: 7465 6d2e 706f 7369 7469 6f6e 2e79 203d  tem.position.y =
+000369d0: 2070 6f73 6974 696f 6e2e 790a 2020 2020   position.y.    
+000369e0: 2020 2020 6966 2070 6f73 6974 696f 6e2e      if position.
+000369f0: 7a20 6973 206e 6f74 204e 6f6e 653a 0a20  z is not None:. 
+00036a00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00036a10: 7374 6167 655f 7379 7374 656d 2e70 6f73  stage_system.pos
+00036a20: 6974 696f 6e2e 7a20 3d20 706f 7369 7469  ition.z = positi
+00036a30: 6f6e 2e7a 0a20 2020 2020 2020 2069 6620  on.z.        if 
+00036a40: 706f 7369 7469 6f6e 2e72 2069 7320 6e6f  position.r is no
+00036a50: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00036a60: 2020 2020 7365 6c66 2e73 7461 6765 5f73      self.stage_s
+00036a70: 7973 7465 6d2e 706f 7369 7469 6f6e 2e72  ystem.position.r
+00036a80: 203d 2070 6f73 6974 696f 6e2e 720a 2020   = position.r.  
+00036a90: 2020 2020 2020 6966 2070 6f73 6974 696f        if positio
+00036aa0: 6e2e 7420 6973 206e 6f74 204e 6f6e 653a  n.t is not None:
+00036ab0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00036ac0: 662e 7374 6167 655f 7379 7374 656d 2e70  f.stage_system.p
+00036ad0: 6f73 6974 696f 6e2e 7420 3d20 706f 7369  osition.t = posi
+00036ae0: 7469 6f6e 2e74 0a20 2020 2020 2020 200a  tion.t.        .
+00036af0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00036b00: 6465 6275 6728 7b22 6d73 6722 3a20 226d  debug({"msg": "m
+00036b10: 6f76 655f 7374 6167 655f 6162 736f 6c75  ove_stage_absolu
+00036b20: 7465 222c 2022 706f 7369 7469 6f6e 223a  te", "position":
+00036b30: 2070 6f73 6974 696f 6e2e 746f 5f64 6963   position.to_dic
+00036b40: 7428 297d 290a 0a20 2020 2020 2020 2072  t()})..        r
+00036b50: 6574 7572 6e20 7365 6c66 2e67 6574 5f73  eturn self.get_s
+00036b60: 7461 6765 5f70 6f73 6974 696f 6e28 290a  tage_position().
+00036b70: 0a20 2020 2064 6566 206d 6f76 655f 7374  .    def move_st
+00036b80: 6167 655f 7265 6c61 7469 7665 2873 656c  age_relative(sel
+00036b90: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
+00036ba0: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00036bb0: 2920 2d3e 2046 6962 7365 6d53 7461 6765  ) -> FibsemStage
+00036bc0: 506f 7369 7469 6f6e 3a0a 2020 2020 2020  Position:.      
+00036bd0: 2020 2222 224d 6f76 6520 7468 6520 7374    """Move the st
+00036be0: 6167 6520 6279 2074 6865 2073 7065 6369  age by the speci
+00036bf0: 6669 6564 2061 6d6f 756e 742e 2222 220a  fied amount.""".
+00036c00: 2020 2020 0a20 2020 2020 2020 2073 656c      .        sel
+00036c10: 662e 7374 6167 655f 7379 7374 656d 2e70  f.stage_system.p
+00036c20: 6f73 6974 696f 6e20 2b3d 2070 6f73 6974  osition += posit
+00036c30: 696f 6e0a 0a20 2020 2020 2020 206c 6f67  ion..        log
+00036c40: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
+00036c50: 223a 2022 6d6f 7665 5f73 7461 6765 5f72  ": "move_stage_r
+00036c60: 656c 6174 6976 6522 2c20 2270 6f73 6974  elative", "posit
+00036c70: 696f 6e22 3a20 706f 7369 7469 6f6e 2e74  ion": position.t
+00036c80: 6f5f 6469 6374 2829 7d29 0a0a 2020 2020  o_dict()})..    
+00036c90: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00036ca0: 6765 745f 7374 6167 655f 706f 7369 7469  get_stage_positi
+00036cb0: 6f6e 2829 0a0a 2020 2020 6465 6620 7374  on()..    def st
+00036cc0: 6162 6c65 5f6d 6f76 6528 7365 6c66 2c20  able_move(self, 
+00036cd0: 6478 3a20 666c 6f61 742c 2064 793a 666c  dx: float, dy:fl
+00036ce0: 6f61 742c 2062 6561 6d5f 7479 7065 3a20  oat, beam_type: 
+00036cf0: 4265 616d 5479 7065 2c20 7374 6174 6963  BeamType, static
+00036d00: 5f77 643a 2062 6f6f 6c3d 4661 6c73 6529  _wd: bool=False)
+00036d10: 202d 3e20 4669 6273 656d 5374 6167 6550   -> FibsemStageP
+00036d20: 6f73 6974 696f 6e3a 0a20 2020 2020 2020  osition:.       
+00036d30: 200a 2020 2020 2020 2020 5f63 6865 636b   .        _check
+00036d40: 5f73 7461 6765 5f6d 6f76 656d 656e 7428  _stage_movement(
+00036d50: 7365 6c66 2e73 7973 7465 6d2c 2046 6962  self.system, Fib
+00036d60: 7365 6d53 7461 6765 506f 7369 7469 6f6e  semStagePosition
+00036d70: 2878 3d64 782c 2079 3d64 7929 290a 0a20  (x=dx, y=dy)).. 
+00036d80: 2020 2020 2020 2077 6420 3d20 7365 6c66         wd = self
+00036d90: 2e67 6574 2822 776f 726b 696e 675f 6469  .get("working_di
+00036da0: 7374 616e 6365 222c 2042 6561 6d54 7970  stance", BeamTyp
+00036db0: 652e 454c 4543 5452 4f4e 2920 0a0a 2020  e.ELECTRON) ..  
+00036dc0: 2020 2020 2020 7363 616e 5f72 6f74 6174        scan_rotat
+00036dd0: 696f 6e20 3d20 7365 6c66 2e67 6574 2822  ion = self.get("
+00036de0: 7363 616e 5f72 6f74 6174 696f 6e22 2c20  scan_rotation", 
+00036df0: 6265 616d 5f74 7970 6529 0a20 2020 2020  beam_type).     
+00036e00: 2020 2069 6620 6e70 2e69 7363 6c6f 7365     if np.isclose
+00036e10: 2873 6361 6e5f 726f 7461 7469 6f6e 2c20  (scan_rotation, 
+00036e20: 6e70 2e70 6929 3a0a 2020 2020 2020 2020  np.pi):.        
+00036e30: 2020 2020 6478 202a 3d20 2d31 2e30 0a20      dx *= -1.0. 
+00036e40: 2020 2020 2020 2020 2020 2064 7920 2a3d             dy *=
+00036e50: 202d 312e 300a 2020 2020 2020 2020 0a20   -1.0.        . 
+00036e60: 2020 2020 2020 2023 2063 616c 6375 6c61         # calcula
+00036e70: 7465 2073 7461 626c 6520 6d6f 7665 6d65  te stable moveme
+00036e80: 6e74 0a20 2020 2020 2020 2079 7a5f 6d6f  nt.        yz_mo
+00036e90: 7665 203d 2073 656c 662e 5f79 5f63 6f72  ve = self._y_cor
+00036ea0: 7265 6374 6564 5f73 7461 6765 5f6d 6f76  rected_stage_mov
+00036eb0: 656d 656e 7428 0a20 2020 2020 2020 2020  ement(.         
+00036ec0: 2020 2065 7870 6563 7465 645f 793d 6479     expected_y=dy
+00036ed0: 2c0a 2020 2020 2020 2020 2020 2020 6265  ,.            be
+00036ee0: 616d 5f74 7970 653d 6265 616d 5f74 7970  am_type=beam_typ
+00036ef0: 652c 0a20 2020 2020 2020 2029 0a20 2020  e,.        ).   
+00036f00: 2020 2020 2073 7461 6765 5f70 6f73 6974       stage_posit
+00036f10: 696f 6e20 3d20 4669 6273 656d 5374 6167  ion = FibsemStag
+00036f20: 6550 6f73 6974 696f 6e28 0a20 2020 2020  ePosition(.     
+00036f30: 2020 2020 2020 2078 3d64 782c 2079 3d79         x=dx, y=y
+00036f40: 7a5f 6d6f 7665 2e79 2c20 7a3d 797a 5f6d  z_move.y, z=yz_m
+00036f50: 6f76 652e 7a2c 0a20 2020 2020 2020 2020  ove.z,.         
+00036f60: 2020 2072 3d30 2c20 743d 302c 2063 6f6f     r=0, t=0, coo
+00036f70: 7264 696e 6174 655f 7379 7374 656d 3d22  rdinate_system="
+00036f80: 5241 5722 2c0a 2020 2020 2020 2020 290a  RAW",.        ).
+00036f90: 0a20 2020 2020 2020 2023 206d 6f76 6520  .        # move 
+00036fa0: 7374 6167 6520 2020 2020 2020 200a 2020  stage        .  
+00036fb0: 2020 2020 2020 7365 6c66 2e6d 6f76 655f        self.move_
+00036fc0: 7374 6167 655f 7265 6c61 7469 7665 2873  stage_relative(s
+00036fd0: 7461 6765 5f70 6f73 6974 696f 6e29 0a0a  tage_position)..
+00036fe0: 2020 2020 2020 2020 2320 6164 6a75 7374          # adjust
+00036ff0: 2077 6f72 6b69 6e67 2064 6973 7461 6e63   working distanc
+00037000: 6520 746f 2063 6f6d 7065 6e73 6174 6520  e to compensate 
+00037010: 666f 7220 7374 6167 6520 6d6f 7665 6d65  for stage moveme
+00037020: 6e74 0a20 2020 2020 2020 2069 6620 7374  nt.        if st
+00037030: 6174 6963 5f77 643a 0a20 2020 2020 2020  atic_wd:.       
+00037040: 2020 2020 2077 6420 3d20 7365 6c66 2e73       wd = self.s
+00037050: 7973 7465 6d2e 656c 6563 7472 6f6e 2e65  ystem.electron.e
+00037060: 7563 656e 7472 6963 5f68 6569 6768 740a  ucentric_height.
+00037070: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00037080: 2073 656c 662e 7365 7428 2277 6f72 6b69   self.set("worki
+00037090: 6e67 5f64 6973 7461 6e63 6522 2c20 7764  ng_distance", wd
+000370a0: 2c20 4265 616d 5479 7065 2e45 4c45 4354  , BeamType.ELECT
+000370b0: 524f 4e29 0a0a 2020 2020 2020 2020 2320  RON)..        # 
+000370c0: 6c6f 6767 696e 670a 2020 2020 2020 2020  logging.        
+000370d0: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
+000370e0: 6d73 6722 3a20 2273 7461 626c 655f 6d6f  msg": "stable_mo
+000370f0: 7665 222c 2022 6478 223a 2064 782c 2022  ve", "dx": dx, "
+00037100: 6479 223a 2064 792c 200a 2020 2020 2020  dy": dy, .      
+00037110: 2020 2020 2020 2020 2020 2262 6561 6d5f            "beam_
+00037120: 7479 7065 223a 2062 6561 6d5f 7479 7065  type": beam_type
+00037130: 2e6e 616d 652c 2022 7374 6174 6963 5f77  .name, "static_w
+00037140: 6422 3a20 7374 6174 6963 5f77 642c 200a  d": static_wd, .
+00037150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037160: 2277 6f72 6b69 6e67 5f64 6973 7461 6e63  "working_distanc
+00037170: 6522 3a20 7764 2c20 2273 6361 6e5f 726f  e": wd, "scan_ro
+00037180: 7461 7469 6f6e 223a 2073 6361 6e5f 726f  tation": scan_ro
+00037190: 7461 7469 6f6e 2c0a 2020 2020 2020 2020  tation,.        
+000371a0: 2020 2020 2020 2020 2270 6f73 6974 696f          "positio
+000371b0: 6e22 3a20 7374 6167 655f 706f 7369 7469  n": stage_positi
+000371c0: 6f6e 2e74 6f5f 6469 6374 2829 7d29 0a0a  on.to_dict()})..
+000371d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+000371e0: 7461 6765 5f70 6f73 6974 696f 6e0a 0a0a  tage_position...
+000371f0: 2020 2020 6465 6620 7665 7274 6963 616c      def vertical
+00037200: 5f6d 6f76 6528 7365 6c66 2c20 6479 3a20  _move(self, dy: 
+00037210: 666c 6f61 742c 2064 783a 666c 6f61 7420  float, dx:float 
+00037220: 3d20 302e 302c 2073 7461 7469 635f 7764  = 0.0, static_wd
+00037230: 3a20 626f 6f6c 3d54 7275 6529 202d 3e20  : bool=True) -> 
+00037240: 4669 6273 656d 5374 6167 6550 6f73 6974  FibsemStagePosit
+00037250: 696f 6e3a 0a20 2020 2020 2020 2022 2222  ion:.        """
+00037260: 4d6f 7665 2074 6865 2073 7461 6765 2076  Move the stage v
+00037270: 6572 7469 6361 6c6c 7920 6279 2074 6865  ertically by the
+00037280: 2073 7065 6369 6669 6564 2061 6d6f 756e   specified amoun
+00037290: 742e 2222 220a 2020 2020 2020 2020 2320  t.""".        # 
+000372a0: 636f 6e66 6972 6d20 7374 6167 6520 6973  confirm stage is
+000372b0: 2065 6e61 626c 6564 0a20 2020 2020 2020   enabled.       
+000372c0: 205f 6368 6563 6b5f 7374 6167 6528 7365   _check_stage(se
+000372d0: 6c66 2e73 7973 7465 6d29 0a0a 2020 2020  lf.system)..    
+000372e0: 2020 2020 2320 6765 7420 6375 7272 656e      # get curren
+000372f0: 7420 776f 726b 696e 6720 6469 7374 616e  t working distan
+00037300: 6365 2c20 746f 2062 6520 7265 7374 6f72  ce, to be restor
+00037310: 6564 206c 6174 6572 0a20 2020 2020 2020  ed later.       
+00037320: 2077 6420 3d20 7365 6c66 2e67 6574 2822   wd = self.get("
+00037330: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
+00037340: 222c 2042 6561 6d54 7970 652e 454c 4543  ", BeamType.ELEC
+00037350: 5452 4f4e 290a 0a20 2020 2020 2020 2023  TRON)..        #
+00037360: 2061 646a 7573 7420 666f 7220 7363 616e   adjust for scan
+00037370: 2072 6f74 6174 696f 6e0a 2020 2020 2020   rotation.      
+00037380: 2020 7363 616e 5f72 6f74 6174 696f 6e20    scan_rotation 
+00037390: 3d20 7365 6c66 2e67 6574 2822 7363 616e  = self.get("scan
+000373a0: 5f72 6f74 6174 696f 6e22 2c20 4265 616d  _rotation", Beam
+000373b0: 5479 7065 2e49 4f4e 290a 2020 2020 2020  Type.ION).      
+000373c0: 2020 6966 206e 702e 6973 636c 6f73 6528    if np.isclose(
+000373d0: 7363 616e 5f72 6f74 6174 696f 6e2c 206e  scan_rotation, n
+000373e0: 702e 7069 293a 0a20 2020 2020 2020 2020  p.pi):.         
+000373f0: 2020 2064 7820 2a3d 202d 312e 300a 2020     dx *= -1.0.  
+00037400: 2020 2020 2020 2020 2020 6479 202a 3d20            dy *= 
+00037410: 2d31 2e30 0a0a 2020 2020 2020 2020 2320  -1.0..        # 
+00037420: 544f 444f 3a20 696d 706c 656d 656e 7420  TODO: implement 
+00037430: 7065 7273 7065 6374 6976 6520 636f 7272  perspective corr
+00037440: 6563 7469 6f6e 0a20 2020 2020 2020 2050  ection.        P
+00037450: 4552 5350 4543 5449 5645 5f43 4f52 5245  ERSPECTIVE_CORRE
+00037460: 4354 494f 4e20 3d20 302e 390a 2020 2020  CTION = 0.9.    
+00037470: 2020 2020 7a5f 6d6f 7665 203d 2064 7920      z_move = dy 
+00037480: 2f20 6e70 2e63 6f73 286e 702e 6465 6732  / np.cos(np.deg2
+00037490: 7261 6428 3930 202d 2073 656c 662e 7379  rad(90 - self.sy
+000374a0: 7374 656d 2e69 6f6e 2e63 6f6c 756d 6e5f  stem.ion.column_
+000374b0: 7469 6c74 2929 202a 2050 4552 5350 4543  tilt)) * PERSPEC
+000374c0: 5449 5645 5f43 4f52 5245 4354 494f 4e20  TIVE_CORRECTION 
+000374d0: 2023 2054 4f44 4f3a 204d 4147 4943 204e   # TODO: MAGIC N
+000374e0: 554d 4245 522c 2039 3020 2d20 6669 6220  UMBER, 90 - fib 
+000374f0: 7469 6c74 0a0a 2020 2020 2020 2020 2320  tilt..        # 
+00037500: 544f 444f 3a20 646f 2074 6869 7320 6d61  TODO: do this ma
+00037510: 6e75 616c 6c79 2077 6974 686f 7574 2061  nually without a
+00037520: 7574 6f73 6372 6970 7420 696e 2072 6177  utoscript in raw
+00037530: 2063 6f6f 7264 696e 6174 6573 0a20 2020   coordinates.   
+00037540: 2020 2020 2073 7461 6765 5f70 6f73 6974       stage_posit
+00037550: 696f 6e20 3d20 4669 6273 656d 5374 6167  ion = FibsemStag
+00037560: 6550 6f73 6974 696f 6e28 0a20 2020 2020  ePosition(.     
+00037570: 2020 2020 2020 2078 3d64 782c 0a20 2020         x=dx,.   
+00037580: 2020 2020 2020 2020 207a 3d7a 5f6d 6f76           z=z_mov
+00037590: 652c 200a 2020 2020 2020 2020 2020 2020  e, .            
+000375a0: 636f 6f72 6469 6e61 7465 5f73 7973 7465  coordinate_syste
+000375b0: 6d3d 2253 7065 6369 6d65 6e22 0a20 2020  m="Specimen".   
+000375c0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000375d0: 2320 6d6f 7665 2073 7461 6765 0a20 2020  # move stage.   
+000375e0: 2020 2020 2073 656c 662e 6d6f 7665 5f73       self.move_s
+000375f0: 7461 6765 5f72 656c 6174 6976 6528 7374  tage_relative(st
+00037600: 6167 655f 706f 7369 7469 6f6e 290a 0a20  age_position).. 
+00037610: 2020 2020 2020 2069 6620 7374 6174 6963         if static
+00037620: 5f77 643a 0a20 2020 2020 2020 2020 2020  _wd:.           
+00037630: 2073 656c 662e 7365 7428 2277 6f72 6b69   self.set("worki
+00037640: 6e67 5f64 6973 7461 6e63 6522 2c20 7365  ng_distance", se
+00037650: 6c66 2e73 7973 7465 6d2e 656c 6563 7472  lf.system.electr
+00037660: 6f6e 2e65 7563 656e 7472 6963 5f68 6569  on.eucentric_hei
+00037670: 6768 742c 2042 6561 6d54 7970 652e 454c  ght, BeamType.EL
+00037680: 4543 5452 4f4e 290a 2020 2020 2020 2020  ECTRON).        
+00037690: 2020 2020 7365 6c66 2e73 6574 2822 776f      self.set("wo
+000376a0: 726b 696e 675f 6469 7374 616e 6365 222c  rking_distance",
+000376b0: 2073 656c 662e 7379 7374 656d 2e69 6f6e   self.system.ion
+000376c0: 2e65 7563 656e 7472 6963 5f68 6569 6768  .eucentric_heigh
+000376d0: 742c 2042 6561 6d54 7970 652e 494f 4e29  t, BeamType.ION)
+000376e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000376f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00037700: 7365 7428 2277 6f72 6b69 6e67 5f64 6973  set("working_dis
+00037710: 7461 6e63 6522 2c20 7764 2c20 4265 616d  tance", wd, Beam
+00037720: 5479 7065 2e45 4c45 4354 524f 4e29 0a20  Type.ELECTRON). 
+00037730: 2020 200a 2020 2020 2020 2020 2320 6c6f     .        # lo
+00037740: 6767 696e 670a 2020 2020 2020 2020 6c6f  gging.        lo
+00037750: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00037760: 6722 3a20 2276 6572 7469 6361 6c5f 6d6f  g": "vertical_mo
+00037770: 7665 222c 2022 6479 223a 2064 792c 2022  ve", "dy": dy, "
+00037780: 6478 223a 2064 782c 200a 2020 2020 2020  dx": dx, .      
+00037790: 2020 2020 2020 2020 2020 2273 7461 7469            "stati
+000377a0: 635f 7764 223a 2073 7461 7469 635f 7764  c_wd": static_wd
+000377b0: 2c20 2277 6f72 6b69 6e67 5f64 6973 7461  , "working_dista
+000377c0: 6e63 6522 3a20 7764 2c20 0a20 2020 2020  nce": wd, .     
+000377d0: 2020 2020 2020 2020 2020 2022 7363 616e             "scan
+000377e0: 5f72 6f74 6174 696f 6e22 3a20 7363 616e  _rotation": scan
+000377f0: 5f72 6f74 6174 696f 6e2c 200a 2020 2020  _rotation, .    
+00037800: 2020 2020 2020 2020 2020 2020 2270 6f73              "pos
+00037810: 6974 696f 6e22 3a20 7374 6167 655f 706f  ition": stage_po
+00037820: 7369 7469 6f6e 2e74 6f5f 6469 6374 2829  sition.to_dict()
+00037830: 7d29 0a0a 2020 2020 2020 2020 7265 7475  })..        retu
+00037840: 726e 2073 656c 662e 6765 745f 7374 6167  rn self.get_stag
+00037850: 655f 706f 7369 7469 6f6e 2829 0a0a 2020  e_position()..  
+00037860: 2020 6465 6620 5f79 5f63 6f72 7265 6374    def _y_correct
+00037870: 6564 5f73 7461 6765 5f6d 6f76 656d 656e  ed_stage_movemen
+00037880: 7428 7365 6c66 2c20 6578 7065 6374 6564  t(self, expected
+00037890: 5f79 3a20 666c 6f61 742c 2062 6561 6d5f  _y: float, beam_
+000378a0: 7479 7065 3a20 4265 616d 5479 7065 2920  type: BeamType) 
+000378b0: 2d3e 2046 6962 7365 6d53 7461 6765 506f  -> FibsemStagePo
+000378c0: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
+000378d0: 2222 220a 2020 2020 2020 2020 4361 6c63  """.        Calc
+000378e0: 756c 6174 6520 7468 6520 636f 7272 6563  ulate the correc
+000378f0: 7465 6420 7374 6167 6520 6d6f 7665 6d65  ted stage moveme
+00037900: 6e74 7320 6261 7365 6420 6f6e 2074 6865  nts based on the
+00037910: 2062 6561 6d5f 7479 7065 2c20 616e 6420   beam_type, and 
+00037920: 7468 656e 206d 6f76 6520 7468 6520 7374  then move the st
+00037930: 6167 6520 7265 6c61 7469 7665 6c79 2e0a  age relatively..
+00037940: 0a20 2020 2020 2020 2041 7267 733a 0a20  .        Args:. 
+00037950: 2020 2020 2020 2020 2020 2064 7820 2866             dx (f
+00037960: 6c6f 6174 293a 2064 6973 7461 6e63 6520  loat): distance 
+00037970: 616c 6f6e 6720 7468 6520 782d 6178 6973  along the x-axis
+00037980: 2028 696d 6167 6520 636f 6f72 6469 6e61   (image coordina
+00037990: 7465 7329 0a20 2020 2020 2020 2020 2020  tes).           
+000379a0: 2064 7920 2866 6c6f 6174 293a 2064 6973   dy (float): dis
+000379b0: 7461 6e63 6520 616c 6f6e 6720 7468 6520  tance along the 
+000379c0: 792d 6178 6973 2028 696d 6167 6520 636f  y-axis (image co
+000379d0: 6f72 6469 6e61 7465 7329 0a20 2020 2020  ordinates).     
+000379e0: 2020 2020 2020 2062 6561 6d5f 7479 7065         beam_type
+000379f0: 2028 4265 616d 5479 7065 293a 2062 6561   (BeamType): bea
+00037a00: 6d20 7479 7065 2074 6f20 6d6f 7665 2069  m type to move i
+00037a10: 6e0a 2020 2020 2020 2020 2020 2020 7374  n.            st
+00037a20: 6174 6963 5f77 6420 2862 6f6f 6c2c 206f  atic_wd (bool, o
+00037a30: 7074 696f 6e61 6c29 3a20 7768 6574 6865  ptional): whethe
+00037a40: 7220 746f 2066 6978 2074 6865 2077 6f72  r to fix the wor
+00037a50: 6b69 6e67 2064 6973 7461 6e63 652e 2044  king distance. D
+00037a60: 6566 6175 6c74 7320 746f 2046 616c 7365  efaults to False
+00037a70: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00037a80: 2020 2020 2020 0a20 2020 2020 2020 2023        .        #
+00037a90: 2061 6c6c 2061 6e67 6c65 7320 696e 2072   all angles in r
+00037aa0: 6164 6961 6e73 0a20 2020 2020 2020 2073  adians.        s
+00037ab0: 7461 6765 5f74 696c 745f 666c 6174 5f74  tage_tilt_flat_t
+00037ac0: 6f5f 656c 6563 7472 6f6e 203d 206e 702e  o_electron = np.
+00037ad0: 6465 6732 7261 6428 7365 6c66 2e73 7973  deg2rad(self.sys
+00037ae0: 7465 6d2e 656c 6563 7472 6f6e 2e63 6f6c  tem.electron.col
+00037af0: 756d 6e5f 7469 6c74 290a 2020 2020 2020  umn_tilt).      
+00037b00: 2020 7374 6167 655f 7469 6c74 5f66 6c61    stage_tilt_fla
+00037b10: 745f 746f 5f69 6f6e 203d 206e 702e 6465  t_to_ion = np.de
+00037b20: 6732 7261 6428 7365 6c66 2e73 7973 7465  g2rad(self.syste
+00037b30: 6d2e 696f 6e2e 636f 6c75 6d6e 5f74 696c  m.ion.column_til
+00037b40: 7429 0a0a 2020 2020 2020 2020 7374 6167  t)..        stag
+00037b50: 655f 7072 6574 696c 7420 3d20 6e70 2e64  e_pretilt = np.d
+00037b60: 6567 3272 6164 2873 656c 662e 7379 7374  eg2rad(self.syst
+00037b70: 656d 2e73 7461 6765 2e73 6875 7474 6c65  em.stage.shuttle
+00037b80: 5f70 7265 5f74 696c 7429 0a0a 2020 2020  _pre_tilt)..    
+00037b90: 2020 2020 7374 6167 655f 726f 7461 7469      stage_rotati
+00037ba0: 6f6e 5f66 6c61 745f 746f 5f65 6220 3d20  on_flat_to_eb = 
+00037bb0: 6e70 2e64 6567 3272 6164 280a 2020 2020  np.deg2rad(.    
+00037bc0: 2020 2020 2020 2020 7365 6c66 2e73 7973          self.sys
+00037bd0: 7465 6d2e 7374 6167 652e 726f 7461 7469  tem.stage.rotati
+00037be0: 6f6e 5f72 6566 6572 656e 6365 0a20 2020  on_reference.   
+00037bf0: 2020 2020 2029 2025 2028 3220 2a20 6e70       ) % (2 * np
+00037c00: 2e70 6929 0a20 2020 2020 2020 2073 7461  .pi).        sta
+00037c10: 6765 5f72 6f74 6174 696f 6e5f 666c 6174  ge_rotation_flat
+00037c20: 5f74 6f5f 696f 6e20 3d20 6e70 2e64 6567  _to_ion = np.deg
+00037c30: 3272 6164 280a 2020 2020 2020 2020 2020  2rad(.          
+00037c40: 2020 7365 6c66 2e73 7973 7465 6d2e 7374    self.system.st
+00037c50: 6167 652e 726f 7461 7469 6f6e 5f31 3830  age.rotation_180
+00037c60: 0a20 2020 2020 2020 2029 2025 2028 3220  .        ) % (2 
+00037c70: 2a20 6e70 2e70 6929 0a0a 2020 2020 2020  * np.pi)..      
+00037c80: 2020 2320 6375 7272 656e 7420 7374 6167    # current stag
+00037c90: 6520 706f 7369 7469 6f6e 0a20 2020 2020  e position.     
+00037ca0: 2020 2063 7572 7265 6e74 5f73 7461 6765     current_stage
+00037cb0: 5f70 6f73 6974 696f 6e20 3d20 7365 6c66  _position = self
+00037cc0: 2e67 6574 5f73 7461 6765 5f70 6f73 6974  .get_stage_posit
+00037cd0: 696f 6e28 290a 2020 2020 2020 2020 7374  ion().        st
+00037ce0: 6167 655f 726f 7461 7469 6f6e 203d 2063  age_rotation = c
+00037cf0: 7572 7265 6e74 5f73 7461 6765 5f70 6f73  urrent_stage_pos
+00037d00: 6974 696f 6e2e 7220 2520 2832 202a 206e  ition.r % (2 * n
+00037d10: 702e 7069 290a 2020 2020 2020 2020 7374  p.pi).        st
+00037d20: 6167 655f 7469 6c74 203d 2063 7572 7265  age_tilt = curre
+00037d30: 6e74 5f73 7461 6765 5f70 6f73 6974 696f  nt_stage_positio
+00037d40: 6e2e 740a 0a20 2020 2020 2020 2050 5245  n.t..        PRE
+00037d50: 5449 4c54 5f53 4947 4e20 3d20 312e 300a  TILT_SIGN = 1.0.
+00037d60: 2020 2020 2020 2020 2320 7072 6574 696c          # pretil
+00037d70: 7420 616e 676c 6520 6465 7065 6e64 7320  t angle depends 
+00037d80: 6f6e 2072 6f74 6174 696f 6e0a 2020 2020  on rotation.    
+00037d90: 2020 2020 6672 6f6d 2066 6962 7365 6d20      from fibsem 
+00037da0: 696d 706f 7274 206d 6f76 656d 656e 740a  import movement.
+00037db0: 2020 2020 2020 2020 6966 206d 6f76 656d          if movem
+00037dc0: 656e 742e 726f 7461 7469 6f6e 5f61 6e67  ent.rotation_ang
+00037dd0: 6c65 5f69 735f 736d 616c 6c65 7228 7374  le_is_smaller(st
+00037de0: 6167 655f 726f 7461 7469 6f6e 2c20 7374  age_rotation, st
+00037df0: 6167 655f 726f 7461 7469 6f6e 5f66 6c61  age_rotation_fla
+00037e00: 745f 746f 5f65 622c 2061 746f 6c3d 3529  t_to_eb, atol=5)
+00037e10: 3a0a 2020 2020 2020 2020 2020 2020 5052  :.            PR
+00037e20: 4554 494c 545f 5349 474e 203d 2031 2e30  ETILT_SIGN = 1.0
+00037e30: 0a20 2020 2020 2020 2069 6620 6d6f 7665  .        if move
+00037e40: 6d65 6e74 2e72 6f74 6174 696f 6e5f 616e  ment.rotation_an
+00037e50: 676c 655f 6973 5f73 6d61 6c6c 6572 280a  gle_is_smaller(.
+00037e60: 2020 2020 2020 2020 2020 2020 7374 6167              stag
+00037e70: 655f 726f 7461 7469 6f6e 2c20 7374 6167  e_rotation, stag
+00037e80: 655f 726f 7461 7469 6f6e 5f66 6c61 745f  e_rotation_flat_
+00037e90: 746f 5f69 6f6e 2c20 6174 6f6c 3d35 0a20  to_ion, atol=5. 
+00037ea0: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
+00037eb0: 2020 2020 2020 5052 4554 494c 545f 5349        PRETILT_SI
+00037ec0: 474e 203d 202d 312e 300a 0a20 2020 2020  GN = -1.0..     
+00037ed0: 2020 2023 2063 6f72 7265 6374 6564 5f70     # corrected_p
+00037ee0: 7265 7469 6c74 5f61 6e67 6c65 203d 2050  retilt_angle = P
+00037ef0: 5245 5449 4c54 5f53 4947 4e20 2a20 7374  RETILT_SIGN * st
+00037f00: 6167 655f 7469 6c74 5f66 6c61 745f 746f  age_tilt_flat_to
+00037f10: 5f65 6c65 6374 726f 6e0a 2020 2020 2020  _electron.      
+00037f20: 2020 636f 7272 6563 7465 645f 7072 6574    corrected_pret
+00037f30: 696c 745f 616e 676c 6520 3d20 5052 4554  ilt_angle = PRET
+00037f40: 494c 545f 5349 474e 202a 2028 7374 6167  ILT_SIGN * (stag
+00037f50: 655f 7072 6574 696c 7420 2b20 7374 6167  e_pretilt + stag
+00037f60: 655f 7469 6c74 5f66 6c61 745f 746f 5f65  e_tilt_flat_to_e
+00037f70: 6c65 6374 726f 6e29 2023 2065 6c65 6374  lectron) # elect
+00037f80: 726f 6e20 616e 676c 6520 3d20 302c 2069  ron angle = 0, i
+00037f90: 6f6e 203d 2035 320a 0a20 2020 2020 2020  on = 52..       
+00037fa0: 2023 2070 6572 7370 6563 7469 7665 2074   # perspective t
+00037fb0: 696c 7420 6164 6a75 7374 6d65 6e74 2028  ilt adjustment (
+00037fc0: 6469 6666 6572 656e 6365 2062 6574 7765  difference betwe
+00037fd0: 656e 2070 6572 7370 6563 7469 7665 2076  en perspective v
+00037fe0: 6965 7720 616e 6420 7361 6d70 6c65 2063  iew and sample c
+00037ff0: 6f6f 7264 696e 6174 6520 7379 7374 656d  oordinate system
+00038000: 290a 2020 2020 2020 2020 6966 2062 6561  ).        if bea
+00038010: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+00038020: 7065 2e45 4c45 4354 524f 4e3a 0a20 2020  pe.ELECTRON:.   
+00038030: 2020 2020 2020 2020 2070 6572 7370 6563           perspec
+00038040: 7469 7665 5f74 696c 745f 6164 6a75 7374  tive_tilt_adjust
+00038050: 6d65 6e74 203d 202d 636f 7272 6563 7465  ment = -correcte
+00038060: 645f 7072 6574 696c 745f 616e 676c 650a  d_pretilt_angle.
+00038070: 2020 2020 2020 2020 2020 2020 5343 414c              SCAL
+00038080: 455f 4641 4354 4f52 203d 2031 2e30 2020  E_FACTOR = 1.0  
+00038090: 2320 302e 3738 3334 3220 2023 2070 6174  # 0.78342  # pat
+000380a0: 656e 7465 6420 7465 6368 6e6f 6c6f 6779  ented technology
+000380b0: 0a20 2020 2020 2020 2065 6c69 6620 6265  .        elif be
+000380c0: 616d 5f74 7970 6520 3d3d 2042 6561 6d54  am_type == BeamT
+000380d0: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
+000380e0: 2020 2020 2070 6572 7370 6563 7469 7665       perspective
+000380f0: 5f74 696c 745f 6164 6a75 7374 6d65 6e74  _tilt_adjustment
+00038100: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00038110: 2020 2020 202d 636f 7272 6563 7465 645f       -corrected_
+00038120: 7072 6574 696c 745f 616e 676c 6520 2d20  pretilt_angle - 
+00038130: 7374 6167 655f 7469 6c74 5f66 6c61 745f  stage_tilt_flat_
+00038140: 746f 5f69 6f6e 0a20 2020 2020 2020 2020  to_ion.         
+00038150: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00038160: 2053 4341 4c45 5f46 4143 544f 5220 3d20   SCALE_FACTOR = 
+00038170: 312e 300a 0a20 2020 2020 2020 2023 2074  1.0..        # t
+00038180: 6865 2061 6d6f 756e 7420 7468 6520 7361  he amount the sa
+00038190: 6d70 6c65 2068 6173 2074 6f20 6d6f 7665  mple has to move
+000381a0: 2069 6e20 7468 6520 792d 6178 6973 0a20   in the y-axis. 
+000381b0: 2020 2020 2020 2079 5f73 616d 706c 655f         y_sample_
+000381c0: 6d6f 7665 203d 2028 6578 7065 6374 6564  move = (expected
+000381d0: 5f79 202a 2053 4341 4c45 5f46 4143 544f  _y * SCALE_FACTO
+000381e0: 5229 202f 206e 702e 636f 7328 0a20 2020  R) / np.cos(.   
+000381f0: 2020 2020 2020 2020 2073 7461 6765 5f74           stage_t
+00038200: 696c 7420 2b20 7065 7273 7065 6374 6976  ilt + perspectiv
+00038210: 655f 7469 6c74 5f61 646a 7573 746d 656e  e_tilt_adjustmen
+00038220: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
+00038230: 2020 200a 2020 2020 2020 2020 2320 7468     .        # th
+00038240: 6520 616d 6f75 6e74 2074 6865 2073 7461  e amount the sta
+00038250: 6765 2068 6173 2074 6f20 6d6f 7665 2069  ge has to move i
+00038260: 6e20 6561 6368 2061 7869 730a 2020 2020  n each axis.    
+00038270: 2020 2020 795f 6d6f 7665 203d 2079 5f73      y_move = y_s
+00038280: 616d 706c 655f 6d6f 7665 202a 206e 702e  ample_move * np.
+00038290: 636f 7328 636f 7272 6563 7465 645f 7072  cos(corrected_pr
+000382a0: 6574 696c 745f 616e 676c 6529 0a20 2020  etilt_angle).   
+000382b0: 2020 2020 207a 5f6d 6f76 6520 3d20 2d79       z_move = -y
+000382c0: 5f73 616d 706c 655f 6d6f 7665 202a 206e  _sample_move * n
+000382d0: 702e 7369 6e28 636f 7272 6563 7465 645f  p.sin(corrected_
+000382e0: 7072 6574 696c 745f 616e 676c 6529 2023  pretilt_angle) #
+000382f0: 544f 444f 3a20 696e 7665 7374 6967 6174  TODO: investigat
+00038300: 6520 7468 6973 0a0a 2020 2020 2020 2020  e this..        
+00038310: 7265 7475 726e 2046 6962 7365 6d53 7461  return FibsemSta
+00038320: 6765 506f 7369 7469 6f6e 2878 3d30 2c20  gePosition(x=0, 
+00038330: 793d 795f 6d6f 7665 2c20 7a3d 7a5f 6d6f  y=y_move, z=z_mo
+00038340: 7665 290a 0a20 2020 2064 6566 2069 6e73  ve)..    def ins
+00038350: 6572 745f 6d61 6e69 7075 6c61 746f 7228  ert_manipulator(
+00038360: 7365 6c66 2c20 6e61 6d65 3a20 7374 7220  self, name: str 
+00038370: 3d20 2250 4152 4b22 2920 2d3e 2046 6962  = "PARK") -> Fib
+00038380: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+00038390: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
+000383a0: 2222 2249 6e73 6572 7420 7468 6520 6d61  """Insert the ma
+000383b0: 6e69 7075 6c61 746f 7220 746f 2074 6865  nipulator to the
+000383c0: 2073 7065 6369 6669 6564 2070 6f73 6974   specified posit
+000383d0: 696f 6e2e 2222 220a 2020 2020 2020 2020  ion.""".        
+000383e0: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
+000383f0: 6f72 2873 656c 662e 7379 7374 656d 290a  or(self.system).
+00038400: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00038410: 2e69 6e66 6f28 6622 496e 7365 7274 696e  .info(f"Insertin
+00038420: 6720 6d61 6e69 7075 6c61 746f 7220 746f  g manipulator to
+00038430: 207b 6e61 6d65 7d2e 2e2e 2229 0a20 2020   {name}...").   
+00038440: 2020 2020 2073 656c 662e 6d6f 7665 5f6d       self.move_m
+00038450: 616e 6970 756c 6174 6f72 5f61 6273 6f6c  anipulator_absol
+00038460: 7574 6528 4669 6273 656d 4d61 6e69 7075  ute(FibsemManipu
+00038470: 6c61 746f 7250 6f73 6974 696f 6e28 783d  latorPosition(x=
+00038480: 302c 2079 3d30 2c20 7a3d 3138 3065 2d36  0, y=0, z=180e-6
+00038490: 2c20 723d 302c 2074 3d30 2929 0a20 2020  , r=0, t=0)).   
+000384a0: 2020 2020 2073 656c 662e 6d61 6e69 7075       self.manipu
+000384b0: 6c61 746f 725f 7379 7374 656d 2e69 6e73  lator_system.ins
+000384c0: 6572 7465 6420 3d20 5472 7565 0a20 2020  erted = True.   
+000384d0: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
+000384e0: 7567 287b 226d 7367 223a 2022 696e 7365  ug({"msg": "inse
+000384f0: 7274 5f6d 616e 6970 756c 6174 6f72 222c  rt_manipulator",
+00038500: 2022 6e61 6d65 223a 206e 616d 657d 290a   "name": name}).
+00038510: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00038520: 7365 6c66 2e67 6574 5f6d 616e 6970 756c  self.get_manipul
+00038530: 6174 6f72 5f70 6f73 6974 696f 6e28 290a  ator_position().
+00038540: 2020 2020 0a20 2020 2064 6566 2072 6574      .    def ret
+00038550: 7261 6374 5f6d 616e 6970 756c 6174 6f72  ract_manipulator
+00038560: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00038570: 2222 2252 6574 7261 6374 2074 6865 206d  """Retract the m
+00038580: 616e 6970 756c 6174 6f72 2e22 2222 0a20  anipulator.""". 
+00038590: 2020 2020 2020 205f 6368 6563 6b5f 6d61         _check_ma
+000385a0: 6e69 7075 6c61 746f 7228 7365 6c66 2e73  nipulator(self.s
+000385b0: 7973 7465 6d29 0a20 2020 2020 2020 206c  ystem).        l
+000385c0: 6f67 6769 6e67 2e69 6e66 6f28 6622 5265  ogging.info(f"Re
+000385d0: 7472 6163 7469 6e67 206d 616e 6970 756c  tracting manipul
+000385e0: 6174 6f72 2e2e 2e22 290a 2020 2020 2020  ator...").      
+000385f0: 2020 7365 6c66 2e6d 6f76 655f 6d61 6e69    self.move_mani
+00038600: 7075 6c61 746f 725f 6162 736f 6c75 7465  pulator_absolute
+00038610: 2846 6962 7365 6d4d 616e 6970 756c 6174  (FibsemManipulat
+00038620: 6f72 506f 7369 7469 6f6e 2878 3d30 2c20  orPosition(x=0, 
+00038630: 793d 302c 207a 3d30 2c20 723d 302c 2074  y=0, z=0, r=0, t
+00038640: 3d30 2929 0a20 2020 2020 2020 2073 656c  =0)).        sel
+00038650: 662e 6d61 6e69 7075 6c61 746f 725f 7379  f.manipulator_sy
+00038660: 7374 656d 2e69 6e73 6572 7465 6420 3d20  stem.inserted = 
+00038670: 4661 6c73 650a 2020 2020 2020 2020 6c6f  False.        lo
+00038680: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00038690: 6722 3a20 2272 6574 7261 6374 5f6d 616e  g": "retract_man
+000386a0: 6970 756c 6174 6f72 227d 290a 0a20 2020  ipulator"})..   
+000386b0: 2064 6566 206d 6f76 655f 6d61 6e69 7075   def move_manipu
+000386c0: 6c61 746f 725f 7265 6c61 7469 7665 2873  lator_relative(s
+000386d0: 656c 662c 2070 6f73 6974 696f 6e3a 2046  elf, position: F
+000386e0: 6962 7365 6d4d 616e 6970 756c 6174 6f72  ibsemManipulator
+000386f0: 506f 7369 7469 6f6e 2920 2d3e 2046 6962  Position) -> Fib
+00038700: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+00038710: 7369 7469 6f6e 3a0a 2020 2020 2020 2020  sition:.        
+00038720: 5f63 6865 636b 5f6d 616e 6970 756c 6174  _check_manipulat
+00038730: 6f72 5f6d 6f76 656d 656e 7428 7365 6c66  or_movement(self
+00038740: 2e73 7973 7465 6d2c 2070 6f73 6974 696f  .system, positio
+00038750: 6e29 0a20 2020 2020 2020 206c 6f67 6769  n).        loggi
+00038760: 6e67 2e69 6e66 6f28 6622 4d6f 7669 6e67  ng.info(f"Moving
+00038770: 206d 616e 6970 756c 6174 6f72 3a20 7b70   manipulator: {p
+00038780: 6f73 6974 696f 6e7d 2028 5265 6c61 7469  osition} (Relati
+00038790: 7665 2922 290a 2020 2020 2020 2020 7365  ve)").        se
+000387a0: 6c66 2e6d 616e 6970 756c 6174 6f72 5f73  lf.manipulator_s
+000387b0: 7973 7465 6d2e 706f 7369 7469 6f6e 202b  ystem.position +
+000387c0: 3d20 706f 7369 7469 6f6e 0a20 2020 2020  = position.     
+000387d0: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+000387e0: 287b 226d 7367 223a 2022 6d6f 7665 5f6d  ({"msg": "move_m
+000387f0: 616e 6970 756c 6174 6f72 5f72 656c 6174  anipulator_relat
+00038800: 6976 6522 2c20 2270 6f73 6974 696f 6e22  ive", "position"
+00038810: 3a20 706f 7369 7469 6f6e 2e74 6f5f 6469  : position.to_di
+00038820: 6374 2829 7d29 0a20 2020 2020 2020 2072  ct()}).        r
+00038830: 6574 7572 6e20 7365 6c66 2e67 6574 5f6d  eturn self.get_m
+00038840: 616e 6970 756c 6174 6f72 5f70 6f73 6974  anipulator_posit
+00038850: 696f 6e28 290a 2020 2020 0a20 2020 2064  ion().    .    d
+00038860: 6566 206d 6f76 655f 6d61 6e69 7075 6c61  ef move_manipula
+00038870: 746f 725f 6162 736f 6c75 7465 2873 656c  tor_absolute(sel
+00038880: 662c 2070 6f73 6974 696f 6e3a 2046 6962  f, position: Fib
+00038890: 7365 6d4d 616e 6970 756c 6174 6f72 506f  semManipulatorPo
+000388a0: 7369 7469 6f6e 2920 2d3e 2046 6962 7365  sition) -> Fibse
+000388b0: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+000388c0: 7469 6f6e 3a0a 2020 2020 2020 2020 5f63  tion:.        _c
+000388d0: 6865 636b 5f6d 616e 6970 756c 6174 6f72  heck_manipulator
+000388e0: 2873 656c 662e 7379 7374 656d 290a 2020  (self.system).  
+000388f0: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+00038900: 666f 2866 224d 6f76 696e 6720 6d61 6e69  fo(f"Moving mani
+00038910: 7075 6c61 746f 723a 207b 706f 7369 7469  pulator: {positi
+00038920: 6f6e 7d20 2841 6273 6f6c 7574 6529 2229  on} (Absolute)")
+00038930: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
+00038940: 6e69 7075 6c61 746f 725f 7379 7374 656d  nipulator_system
+00038950: 2e70 6f73 6974 696f 6e20 3d20 706f 7369  .position = posi
+00038960: 7469 6f6e 0a20 2020 2020 2020 206c 6f67  tion.        log
+00038970: 6769 6e67 2e64 6562 7567 287b 226d 7367  ging.debug({"msg
+00038980: 223a 2022 6d6f 7665 5f6d 616e 6970 756c  ": "move_manipul
+00038990: 6174 6f72 5f61 6273 6f6c 7574 6522 2c20  ator_absolute", 
+000389a0: 2270 6f73 6974 696f 6e22 3a20 706f 7369  "position": posi
+000389b0: 7469 6f6e 2e74 6f5f 6469 6374 2829 7d29  tion.to_dict()})
+000389c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000389d0: 7365 6c66 2e67 6574 5f6d 616e 6970 756c  self.get_manipul
+000389e0: 6174 6f72 5f70 6f73 6974 696f 6e28 290a  ator_position().
+000389f0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00038a00: 2020 2064 6566 206d 6f76 655f 6d61 6e69     def move_mani
+00038a10: 7075 6c61 746f 725f 636f 7272 6563 7465  pulator_correcte
+00038a20: 6428 7365 6c66 2c20 6478 3a20 666c 6f61  d(self, dx: floa
+00038a30: 742c 2064 793a 2066 6c6f 6174 2c20 6265  t, dy: float, be
+00038a40: 616d 5f74 7970 653a 2042 6561 6d54 7970  am_type: BeamTyp
+00038a50: 6529 202d 3e20 4669 6273 656d 4d61 6e69  e) -> FibsemMani
+00038a60: 7075 6c61 746f 7250 6f73 6974 696f 6e3a  pulatorPosition:
+00038a70: 0a20 2020 2020 2020 205f 6368 6563 6b5f  .        _check_
+00038a80: 6d61 6e69 7075 6c61 746f 7228 7365 6c66  manipulator(self
+00038a90: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
+00038aa0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+00038ab0: 4d6f 7669 6e67 206d 616e 6970 756c 6174  Moving manipulat
+00038ac0: 6f72 3a20 6478 3d7b 6478 3a2e 3265 7d2c  or: dx={dx:.2e},
+00038ad0: 2064 793d 7b64 793a 2e32 657d 2c20 6265   dy={dy:.2e}, be
+00038ae0: 616d 5f74 7970 6520 3d20 7b62 6561 6d5f  am_type = {beam_
+00038af0: 7479 7065 2e6e 616d 657d 2028 436f 7272  type.name} (Corr
+00038b00: 6563 7465 6429 2229 0a20 2020 2020 2020  ected)").       
+00038b10: 2073 656c 662e 6d61 6e69 7075 6c61 746f   self.manipulato
+00038b20: 725f 7379 7374 656d 2e70 6f73 6974 696f  r_system.positio
+00038b30: 6e2e 7820 2b3d 2064 780a 2020 2020 2020  n.x += dx.      
+00038b40: 2020 7365 6c66 2e6d 616e 6970 756c 6174    self.manipulat
+00038b50: 6f72 5f73 7973 7465 6d2e 706f 7369 7469  or_system.positi
+00038b60: 6f6e 2e79 202b 3d20 6479 0a20 2020 2020  on.y += dy.     
+00038b70: 2020 206c 6f67 6769 6e67 2e64 6562 7567     logging.debug
+00038b80: 287b 226d 7367 223a 2022 6d6f 7665 5f6d  ({"msg": "move_m
+00038b90: 616e 6970 756c 6174 6f72 5f63 6f72 7265  anipulator_corre
+00038ba0: 6374 6564 222c 2022 6478 223a 2064 782c  cted", "dx": dx,
+00038bb0: 2022 6479 223a 2064 792c 2022 6265 616d   "dy": dy, "beam
+00038bc0: 5f74 7970 6522 3a20 6265 616d 5f74 7970  _type": beam_typ
+00038bd0: 652e 6e61 6d65 7d29 0a20 2020 2020 2020  e.name}).       
+00038be0: 2072 6574 7572 6e20 7365 6c66 2e67 6574   return self.get
+00038bf0: 5f6d 616e 6970 756c 6174 6f72 5f70 6f73  _manipulator_pos
+00038c00: 6974 696f 6e28 290a 0a20 2020 2064 6566  ition()..    def
+00038c10: 206d 6f76 655f 6d61 6e69 7075 6c61 746f   move_manipulato
+00038c20: 725f 746f 5f70 6f73 6974 696f 6e5f 6f66  r_to_position_of
+00038c30: 6673 6574 2873 656c 662c 206f 6666 7365  fset(self, offse
+00038c40: 743a 2046 6962 7365 6d4d 616e 6970 756c  t: FibsemManipul
+00038c50: 6174 6f72 506f 7369 7469 6f6e 2c20 6e61  atorPosition, na
+00038c60: 6d65 3a20 7374 7220 3d20 4e6f 6e65 2920  me: str = None) 
+00038c70: 2d3e 2046 6962 7365 6d4d 616e 6970 756c  -> FibsemManipul
+00038c80: 6174 6f72 506f 7369 7469 6f6e 3a0a 2020  atorPosition:.  
+00038c90: 2020 2020 2020 5f63 6865 636b 5f6d 616e        _check_man
+00038ca0: 6970 756c 6174 6f72 2873 656c 662e 7379  ipulator(self.sy
+00038cb0: 7374 656d 290a 2020 2020 2020 2020 6966  stem).        if
+00038cc0: 206e 616d 6520 6973 204e 6f6e 653a 0a20   name is None:. 
+00038cd0: 2020 2020 2020 2020 2020 206e 616d 6520             name 
+00038ce0: 3d20 2245 5543 454e 5452 4943 220a 0a20  = "EUCENTRIC".. 
+00038cf0: 2020 2020 2020 2070 6f73 6974 696f 6e20         position 
+00038d00: 3d20 7365 6c66 2e5f 6765 745f 7361 7665  = self._get_save
+00038d10: 645f 6d61 6e69 7075 6c61 746f 725f 706f  d_manipulator_po
+00038d20: 7369 7469 6f6e 286e 616d 6529 0a20 2020  sition(name).   
+00038d30: 2020 2020 200a 2020 2020 2020 2020 6c6f       .        lo
+00038d40: 6767 696e 672e 696e 666f 2866 224d 6f76  gging.info(f"Mov
+00038d50: 696e 6720 6d61 6e69 7075 6c61 746f 723a  ing manipulator:
+00038d60: 207b 6f66 6673 6574 7d20 746f 207b 6e61   {offset} to {na
+00038d70: 6d65 7d22 290a 2020 2020 2020 2020 7365  me}").        se
+00038d80: 6c66 2e6d 6f76 655f 6d61 6e69 7075 6c61  lf.move_manipula
+00038d90: 746f 725f 6162 736f 6c75 7465 2870 6f73  tor_absolute(pos
+00038da0: 6974 696f 6e20 2b20 6f66 6673 6574 290a  ition + offset).
+00038db0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00038dc0: 6465 6275 6728 7b22 6d73 6722 3a20 226d  debug({"msg": "m
+00038dd0: 6f76 655f 6d61 6e69 7075 6c61 746f 725f  ove_manipulator_
+00038de0: 746f 5f70 6f73 6974 696f 6e5f 6f66 6673  to_position_offs
+00038df0: 6574 222c 2022 6f66 6673 6574 223a 206f  et", "offset": o
+00038e00: 6666 7365 742e 746f 5f64 6963 7428 292c  ffset.to_dict(),
+00038e10: 2022 6e61 6d65 223a 206e 616d 657d 290a   "name": name}).
+00038e20: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00038e30: 656c 662e 6765 745f 6d61 6e69 7075 6c61  elf.get_manipula
+00038e40: 746f 725f 706f 7369 7469 6f6e 2829 0a0a  tor_position()..
+00038e50: 2020 2020 6465 6620 5f67 6574 5f73 6176      def _get_sav
+00038e60: 6564 5f6d 616e 6970 756c 6174 6f72 5f70  ed_manipulator_p
+00038e70: 6f73 6974 696f 6e28 7365 6c66 2c20 6e61  osition(self, na
+00038e80: 6d65 3a20 7374 7220 3d20 2250 4152 4b22  me: str = "PARK"
+00038e90: 2920 2d3e 2046 6962 7365 6d4d 616e 6970  ) -> FibsemManip
+00038ea0: 756c 6174 6f72 506f 7369 7469 6f6e 3a0a  ulatorPosition:.
+00038eb0: 2020 2020 2020 2020 5f63 6865 636b 5f6d          _check_m
+00038ec0: 616e 6970 756c 6174 6f72 2873 656c 662e  anipulator(self.
+00038ed0: 7379 7374 656d 290a 0a20 2020 2020 2020  system)..       
+00038ee0: 2069 6620 6e61 6d65 206e 6f74 2069 6e20   if name not in 
+00038ef0: 5b22 5041 524b 222c 2022 4555 4345 4e54  ["PARK", "EUCENT
+00038f00: 5249 4322 5d3a 0a20 2020 2020 2020 2020  RIC"]:.         
+00038f10: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00038f20: 726f 7228 6622 556e 6b6e 6f77 6e20 6d61  ror(f"Unknown ma
+00038f30: 6e69 7075 6c61 746f 7220 706f 7369 7469  nipulator positi
+00038f40: 6f6e 3a20 7b6e 616d 657d 2229 0a20 2020  on: {name}").   
+00038f50: 2020 2020 2069 6620 6e61 6d65 203d 3d20       if name == 
+00038f60: 2250 4152 4b22 3a0a 2020 2020 2020 2020  "PARK":.        
+00038f70: 2020 2020 7265 7475 726e 2046 6962 7365      return Fibse
+00038f80: 6d4d 616e 6970 756c 6174 6f72 506f 7369  mManipulatorPosi
+00038f90: 7469 6f6e 2878 3d30 2c20 793d 302c 207a  tion(x=0, y=0, z
+00038fa0: 3d31 3830 652d 362c 2072 3d30 2c20 743d  =180e-6, r=0, t=
+00038fb0: 3029 0a20 2020 2020 2020 2069 6620 6e61  0).        if na
+00038fc0: 6d65 203d 3d20 2245 5543 454e 5452 4943  me == "EUCENTRIC
+00038fd0: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
+00038fe0: 6574 7572 6e20 4669 6273 656d 4d61 6e69  eturn FibsemMani
+00038ff0: 7075 6c61 746f 7250 6f73 6974 696f 6e28  pulatorPosition(
+00039000: 783d 302c 2079 3d30 2c20 7a3d 302c 2072  x=0, y=0, z=0, r
+00039010: 3d30 2c20 743d 3029 0a0a 2020 2020 6465  =0, t=0)..    de
+00039020: 6620 7365 7475 705f 6d69 6c6c 696e 6728  f setup_milling(
+00039030: 7365 6c66 2c20 6d69 6c6c 5f73 6574 7469  self, mill_setti
+00039040: 6e67 733a 2046 6962 7365 6d4d 696c 6c69  ngs: FibsemMilli
+00039050: 6e67 5365 7474 696e 6773 293a 0a20 2020  ngSettings):.   
+00039060: 2020 2020 2022 2222 5365 7475 7020 7468       """Setup th
+00039070: 6520 6d69 6c6c 696e 6720 7061 7261 6d65  e milling parame
+00039080: 7465 7273 2e22 2222 0a20 2020 2020 2020  ters.""".       
+00039090: 205f 6368 6563 6b5f 6265 616d 2842 6561   _check_beam(Bea
+000390a0: 6d54 7970 652e 494f 4e2c 2073 656c 662e  mType.ION, self.
+000390b0: 7379 7374 656d 290a 2020 2020 2020 2020  system).        
+000390c0: 7365 6c66 2e73 6574 2822 6375 7272 656e  self.set("curren
+000390d0: 7422 2c20 6d69 6c6c 5f73 6574 7469 6e67  t", mill_setting
+000390e0: 732e 6d69 6c6c 696e 675f 6375 7272 656e  s.milling_curren
+000390f0: 742c 2042 6561 6d54 7970 652e 494f 4e29  t, BeamType.ION)
+00039100: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00039110: 7428 2276 6f6c 7461 6765 222c 206d 696c  t("voltage", mil
+00039120: 6c5f 7365 7474 696e 6773 2e6d 696c 6c69  l_settings.milli
+00039130: 6e67 5f76 6f6c 7461 6765 2c20 4265 616d  ng_voltage, Beam
+00039140: 5479 7065 2e49 4f4e 290a 2020 2020 0a20  Type.ION).    . 
+00039150: 2020 2020 2020 206c 6f67 6769 6e67 2e64         logging.d
+00039160: 6562 7567 287b 226d 7367 223a 2022 7365  ebug({"msg": "se
+00039170: 7475 705f 6d69 6c6c 696e 6722 2c20 226d  tup_milling", "m
+00039180: 696c 6c5f 7365 7474 696e 6773 223a 206d  ill_settings": m
+00039190: 696c 6c5f 7365 7474 696e 6773 2e74 6f5f  ill_settings.to_
+000391a0: 6469 6374 2829 7d29 0a0a 2020 2020 6465  dict()})..    de
+000391b0: 6620 7275 6e5f 6d69 6c6c 696e 6728 7365  f run_milling(se
+000391c0: 6c66 2c20 6d69 6c6c 696e 675f 6375 7272  lf, milling_curr
+000391d0: 656e 743a 2066 6c6f 6174 2c20 6d69 6c6c  ent: float, mill
+000391e0: 696e 675f 766f 6c74 6167 653a 2066 6c6f  ing_voltage: flo
+000391f0: 6174 2c20 6173 796e 6368 3a20 626f 6f6c  at, asynch: bool
+00039200: 203d 2046 616c 7365 2920 2d3e 204e 6f6e   = False) -> Non
+00039210: 653a 0a20 2020 2020 2020 2022 2222 5275  e:.        """Ru
+00039220: 6e20 6d69 6c6c 696e 6720 7769 7468 2074  n milling with t
+00039230: 6865 2073 7065 6369 6669 6564 2063 7572  he specified cur
+00039240: 7265 6e74 2061 6e64 2076 6f6c 7461 6765  rent and voltage
+00039250: 2e22 2222 0a20 2020 2020 2020 205f 6368  .""".        _ch
+00039260: 6563 6b5f 6265 616d 2842 6561 6d54 7970  eck_beam(BeamTyp
+00039270: 652e 494f 4e2c 2073 656c 662e 7379 7374  e.ION, self.syst
+00039280: 656d 290a 2020 2020 2020 2020 2320 696d  em).        # im
+00039290: 706f 7274 2072 616e 646f 6d0a 2020 2020  port random.    
+000392a0: 2020 2020 2320 7469 6d65 2e73 6c65 6570      # time.sleep
+000392b0: 2872 616e 646f 6d2e 7261 6e64 696e 7428  (random.randint(
+000392c0: 312c 2035 2929 0a20 2020 2020 2020 2074  1, 5)).        t
+000392d0: 696d 652e 736c 6565 7028 3529 0a20 2020  ime.sleep(5).   
+000392e0: 2020 2020 206c 6f67 6769 6e67 2e64 6562       logging.deb
+000392f0: 7567 287b 226d 7367 223a 2022 7275 6e5f  ug({"msg": "run_
+00039300: 6d69 6c6c 696e 6722 2c20 226d 696c 6c69  milling", "milli
+00039310: 6e67 5f63 7572 7265 6e74 223a 206d 696c  ng_current": mil
+00039320: 6c69 6e67 5f63 7572 7265 6e74 2c20 226d  ling_current, "m
+00039330: 696c 6c69 6e67 5f76 6f6c 7461 6765 223a  illing_voltage":
+00039340: 206d 696c 6c69 6e67 5f76 6f6c 7461 6765   milling_voltage
+00039350: 2c20 2261 7379 6e63 6822 3a20 6173 796e  , "asynch": asyn
+00039360: 6368 7d29 0a0a 2020 2020 6465 6620 6669  ch})..    def fi
+00039370: 6e69 7368 5f6d 696c 6c69 6e67 2873 656c  nish_milling(sel
+00039380: 662c 2069 6d61 6769 6e67 5f63 7572 7265  f, imaging_curre
+00039390: 6e74 3a20 666c 6f61 742c 2069 6d61 6769  nt: float, imagi
+000393a0: 6e67 5f76 6f6c 7461 6765 3a20 666c 6f61  ng_voltage: floa
+000393b0: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+000393c0: 2020 2020 2222 2246 696e 6973 6820 6d69      """Finish mi
+000393d0: 6c6c 696e 6720 6279 2072 6573 746f 7269  lling by restori
+000393e0: 6e67 2074 6865 2069 6d61 6769 6e67 2063  ng the imaging c
+000393f0: 7572 7265 6e74 2061 6e64 2076 6f6c 7461  urrent and volta
+00039400: 6765 2e22 2222 0a20 2020 2020 2020 205f  ge.""".        _
+00039410: 6368 6563 6b5f 6265 616d 2842 6561 6d54  check_beam(BeamT
+00039420: 7970 652e 494f 4e2c 2073 656c 662e 7379  ype.ION, self.sy
+00039430: 7374 656d 290a 2020 2020 2020 2020 6c6f  stem).        lo
+00039440: 6767 696e 672e 696e 666f 2866 2246 696e  gging.info(f"Fin
+00039450: 6973 6869 6e67 206d 696c 6c69 6e67 3a20  ishing milling: 
+00039460: 7b69 6d61 6769 6e67 5f63 7572 7265 6e74  {imaging_current
+00039470: 3a2e 3265 7d22 290a 2020 2020 2020 2020  :.2e}").        
+00039480: 7365 6c66 2e73 6574 2822 6375 7272 656e  self.set("curren
+00039490: 7422 2c20 696d 6167 696e 675f 6375 7272  t", imaging_curr
+000394a0: 656e 742c 2042 6561 6d54 7970 652e 494f  ent, BeamType.IO
+000394b0: 4e29 0a20 2020 2020 2020 2073 656c 662e  N).        self.
+000394c0: 7365 7428 2276 6f6c 7461 6765 222c 2069  set("voltage", i
+000394d0: 6d61 6769 6e67 5f76 6f6c 7461 6765 2c20  maging_voltage, 
+000394e0: 4265 616d 5479 7065 2e49 4f4e 290a 0a20  BeamType.ION).. 
+000394f0: 2020 2064 6566 2073 746f 705f 6d69 6c6c     def stop_mill
+00039500: 696e 6728 7365 6c66 2920 2d3e 204e 6f6e  ing(self) -> Non
+00039510: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+00039520: 6e0a 0a20 2020 2064 6566 2065 7374 696d  n..    def estim
+00039530: 6174 655f 6d69 6c6c 696e 675f 7469 6d65  ate_milling_time
+00039540: 2873 656c 662c 2070 6174 7465 726e 733a  (self, patterns:
+00039550: 206c 6973 7429 202d 3e20 666c 6f61 743a   list) -> float:
+00039560: 0a20 2020 2020 2020 2022 2222 4573 7469  .        """Esti
+00039570: 6d61 7465 2074 6865 206d 696c 6c69 6e67  mate the milling
+00039580: 2074 696d 6520 666f 7220 7468 6520 7370   time for the sp
+00039590: 6563 6966 6965 6420 7061 7474 6572 6e73  ecified patterns
+000395a0: 2e22 2222 0a20 2020 2020 2020 2074 6f74  .""".        tot
+000395b0: 616c 5f74 696d 6520 3d20 300a 2020 2020  al_time = 0.    
+000395c0: 2020 2020 666f 7220 7061 7474 6572 6e20      for pattern 
+000395d0: 696e 2070 6174 7465 726e 733a 0a20 2020  in patterns:.   
+000395e0: 2020 2020 2020 2020 2074 6f74 616c 5f74           total_t
+000395f0: 696d 6520 2b3d 2035 0a20 2020 2020 2020  ime += 5.       
+00039600: 200a 2020 2020 2020 2020 7265 7475 726e   .        return
+00039610: 2074 6f74 616c 5f74 696d 650a 2020 2020   total_time.    
+00039620: 2020 2020 0a0a 2020 2020 6465 6620 6472      ..    def dr
+00039630: 6177 5f72 6563 7461 6e67 6c65 2873 656c  aw_rectangle(sel
+00039640: 662c 2070 6174 7465 726e 5f73 6574 7469  f, pattern_setti
+00039650: 6e67 733a 2046 6962 7365 6d52 6563 7461  ngs: FibsemRecta
+00039660: 6e67 6c65 5365 7474 696e 6773 2920 2d3e  ngleSettings) ->
+00039670: 204e 6f6e 653a 0a20 2020 2020 2020 206c   None:.        l
+00039680: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
+00039690: 7367 223a 2022 6472 6177 5f72 6563 7461  sg": "draw_recta
+000396a0: 6e67 6c65 222c 2022 7061 7474 6572 6e5f  ngle", "pattern_
+000396b0: 7365 7474 696e 6773 223a 2070 6174 7465  settings": patte
+000396c0: 726e 5f73 6574 7469 6e67 732e 746f 5f64  rn_settings.to_d
+000396d0: 6963 7428 297d 290a 0a20 2020 2064 6566  ict()})..    def
+000396e0: 2064 7261 775f 6c69 6e65 2873 656c 662c   draw_line(self,
+000396f0: 2070 6174 7465 726e 5f73 6574 7469 6e67   pattern_setting
+00039700: 733a 2046 6962 7365 6d4c 696e 6553 6574  s: FibsemLineSet
+00039710: 7469 6e67 7329 202d 3e20 4e6f 6e65 3a0a  tings) -> None:.
+00039720: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00039730: 6465 6275 6728 7b22 6d73 6722 3a20 2264  debug({"msg": "d
+00039740: 7261 775f 6c69 6e65 222c 2022 7061 7474  raw_line", "patt
+00039750: 6572 6e5f 7365 7474 696e 6773 223a 2070  ern_settings": p
+00039760: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+00039770: 746f 5f64 6963 7428 297d 290a 0a20 2020  to_dict()})..   
+00039780: 2064 6566 2064 7261 775f 6369 7263 6c65   def draw_circle
+00039790: 2873 656c 662c 2070 6174 7465 726e 5f73  (self, pattern_s
+000397a0: 6574 7469 6e67 733a 2046 6962 7365 6d43  ettings: FibsemC
+000397b0: 6972 636c 6553 6574 7469 6e67 7329 202d  ircleSettings) -
+000397c0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000397d0: 6c6f 6767 696e 672e 6465 6275 6728 7b22  logging.debug({"
+000397e0: 6d73 6722 3a20 2264 7261 775f 6369 7263  msg": "draw_circ
+000397f0: 6c65 222c 2022 7061 7474 6572 6e5f 7365  le", "pattern_se
+00039800: 7474 696e 6773 223a 2070 6174 7465 726e  ttings": pattern
+00039810: 5f73 6574 7469 6e67 732e 746f 5f64 6963  _settings.to_dic
+00039820: 7428 297d 290a 2020 2020 0a20 2020 2064  t()}).    .    d
+00039830: 6566 2064 7261 775f 616e 6e75 6c75 7328  ef draw_annulus(
+00039840: 7365 6c66 2c20 7061 7474 6572 6e5f 7365  self, pattern_se
+00039850: 7474 696e 6773 3a20 4669 6273 656d 4369  ttings: FibsemCi
+00039860: 7263 6c65 5365 7474 696e 6773 2920 2d3e  rcleSettings) ->
+00039870: 204e 6f6e 653a 0a20 2020 2020 2020 206c   None:.        l
+00039880: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
+00039890: 7367 223a 2022 6472 6177 5f61 6e6e 756c  sg": "draw_annul
+000398a0: 7573 222c 2022 7061 7474 6572 6e5f 7365  us", "pattern_se
+000398b0: 7474 696e 6773 223a 2070 6174 7465 726e  ttings": pattern
+000398c0: 5f73 6574 7469 6e67 732e 746f 5f64 6963  _settings.to_dic
+000398d0: 7428 297d 290a 0a0a 2020 2020 6465 6620  t()})...    def 
+000398e0: 6472 6177 5f62 6974 6d61 705f 7061 7474  draw_bitmap_patt
+000398f0: 6572 6e28 7365 6c66 2c20 7061 7474 6572  ern(self, patter
+00039900: 6e5f 7365 7474 696e 6773 3a20 4669 6273  n_settings: Fibs
+00039910: 656d 4269 746d 6170 5365 7474 696e 6773  emBitmapSettings
+00039920: 2c0a 2020 2020 2020 2020 7061 7468 3a20  ,.        path: 
+00039930: 7374 7229 3a0a 2020 2020 2020 2020 6c6f  str):.        lo
+00039940: 6767 696e 672e 6465 6275 6728 7b22 6d73  gging.debug({"ms
+00039950: 6722 3a20 2264 7261 775f 6269 746d 6170  g": "draw_bitmap
+00039960: 5f70 6174 7465 726e 222c 2022 7061 7474  _pattern", "patt
+00039970: 6572 6e5f 7365 7474 696e 6773 223a 2070  ern_settings": p
+00039980: 6174 7465 726e 5f73 6574 7469 6e67 732e  attern_settings.
+00039990: 746f 5f64 6963 7428 292c 2022 7061 7468  to_dict(), "path
+000399a0: 223a 2070 6174 687d 290a 2020 2020 2020  ": path}).      
+000399b0: 2020 7265 7475 726e 200a 2020 2020 6465    return .    de
+000399c0: 6620 7275 6e5f 6d69 6c6c 696e 675f 6472  f run_milling_dr
+000399d0: 6966 745f 636f 7272 6563 7465 6428 7365  ift_corrected(se
+000399e0: 6c66 293a 0a20 2020 2020 2020 205f 6368  lf):.        _ch
+000399f0: 6563 6b5f 6265 616d 2842 6561 6d54 7970  eck_beam(BeamTyp
+00039a00: 652e 494f 4e2c 2073 656c 662e 7379 7374  e.ION, self.syst
+00039a10: 656d 290a 2020 2020 2020 2020 7265 7475  em).        retu
+00039a20: 726e 0a0a 2020 2020 6465 6620 7365 7475  rn..    def setu
+00039a30: 705f 7370 7574 7465 7228 7365 6c66 2c20  p_sputter(self, 
+00039a40: 7072 6f74 6f63 6f6c 3a20 6469 6374 2920  protocol: dict) 
+00039a50: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00039a60: 205f 6368 6563 6b5f 7370 7574 7465 7228   _check_sputter(
+00039a70: 7365 6c66 2e73 7973 7465 6d29 0a20 2020  self.system).   
+00039a80: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+00039a90: 6f28 6622 5365 7474 696e 6720 7570 2073  o(f"Setting up s
+00039aa0: 7075 7474 6572 3a20 7b70 726f 746f 636f  putter: {protoco
+00039ab0: 6c7d 2229 0a0a 2020 2020 6465 6620 6472  l}")..    def dr
+00039ac0: 6177 5f73 7075 7474 6572 5f70 6174 7465  aw_sputter_patte
+00039ad0: 726e 2873 656c 662c 2068 6677 3a20 666c  rn(self, hfw: fl
+00039ae0: 6f61 742c 206c 696e 655f 7061 7474 6572  oat, line_patter
+00039af0: 6e5f 6c65 6e67 7468 3a20 666c 6f61 742c  n_length: float,
+00039b00: 2073 7075 7474 6572 5f74 696d 653a 2066   sputter_time: f
+00039b10: 6c6f 6174 293a 0a20 2020 2020 2020 206c  loat):.        l
+00039b20: 6f67 6769 6e67 2e64 6562 7567 287b 226d  ogging.debug({"m
+00039b30: 7367 223a 2022 6472 6177 5f73 7075 7474  sg": "draw_sputt
+00039b40: 6572 5f70 6174 7465 726e 222c 2022 6866  er_pattern", "hf
+00039b50: 7722 3a20 6866 772c 2022 6c69 6e65 5f70  w": hfw, "line_p
+00039b60: 6174 7465 726e 5f6c 656e 6774 6822 3a20  attern_length": 
+00039b70: 6c69 6e65 5f70 6174 7465 726e 5f6c 656e  line_pattern_len
+00039b80: 6774 682c 2022 7370 7574 7465 725f 7469  gth, "sputter_ti
+00039b90: 6d65 223a 2073 7075 7474 6572 5f74 696d  me": sputter_tim
+00039ba0: 657d 290a 0a20 2020 2064 6566 2063 7279  e})..    def cry
+00039bb0: 6f5f 6465 706f 7369 7469 6f6e 5f76 3228  o_deposition_v2(
+00039bc0: 7365 6c66 2c20 6769 735f 7365 7474 696e  self, gis_settin
+00039bd0: 6773 3a20 4669 6273 656d 4761 7349 6e6a  gs: FibsemGasInj
+00039be0: 6563 7469 6f6e 5365 7474 696e 6773 2920  ectionSettings) 
+00039bf0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00039c00: 2022 2222 5275 6e20 6e6f 6e2d 7370 6563   """Run non-spec
+00039c10: 6966 6963 2063 7279 6f20 6465 706f 7369  ific cryo deposi
+00039c20: 7469 6f6e 2070 726f 746f 636f 6c2e 0a0a  tion protocol...
+00039c30: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
+00039c40: 756e 6976 6572 7361 6c69 7365 2074 6869  universalise thi
+00039c50: 7320 666f 7220 6465 6d6f 2c20 7465 7363  s for demo, tesc
+00039c60: 616e 0a20 2020 2020 2020 2022 2222 0a0a  an.        """..
+00039c70: 2020 2020 2020 2020 7573 655f 6d75 6c74          use_mult
+00039c80: 6963 6865 6d20 3d20 7365 6c66 2e69 735f  ichem = self.is_
+00039c90: 6176 6169 6c61 626c 6528 226d 756c 7469  available("multi
+00039ca0: 6368 656d 2229 0a20 2020 2020 2020 2070  chem").        p
+00039cb0: 6f72 7420 3d20 6769 735f 7365 7474 696e  ort = gis_settin
+00039cc0: 6773 2e70 6f72 740a 2020 2020 2020 2020  gs.port.        
+00039cd0: 6761 7320 3d20 6769 735f 7365 7474 696e  gas = gis_settin
+00039ce0: 6773 2e67 6173 0a20 2020 2020 2020 2064  gs.gas.        d
+00039cf0: 7572 6174 696f 6e20 3d20 6769 735f 7365  uration = gis_se
+00039d00: 7474 696e 6773 2e64 7572 6174 696f 6e0a  ttings.duration.
+00039d10: 2020 2020 2020 2020 696e 7365 7274 5f70          insert_p
+00039d20: 6f73 6974 696f 6e20 3d20 6769 735f 7365  osition = gis_se
+00039d30: 7474 696e 6773 2e69 6e73 6572 745f 706f  ttings.insert_po
+00039d40: 7369 7469 6f6e 0a0a 2020 2020 2020 2020  sition..        
+00039d50: 6c6f 6767 696e 672e 696e 666f 287b 226d  logging.info({"m
+00039d60: 7367 223a 2022 696e 7365 7274 696e 6720  sg": "inserting 
+00039d70: 6769 7322 2c20 2273 6574 7469 6e67 7322  gis", "settings"
+00039d80: 3a20 6769 735f 7365 7474 696e 6773 2e74  : gis_settings.t
+00039d90: 6f5f 6469 6374 2829 7d29 0a20 2020 2020  o_dict()}).     
+00039da0: 2020 200a 2020 2020 2020 2020 6769 7320     .        gis 
+00039db0: 3d20 7365 6c66 2e67 6973 5f73 7973 7465  = self.gis_syste
+00039dc0: 6d0a 0a20 2020 2020 2020 2023 2069 6e73  m..        # ins
+00039dd0: 6572 7420 6769 7320 2f20 6d75 6c74 6963  ert gis / multic
+00039de0: 6865 6d0a 2020 2020 2020 2020 6c6f 6767  hem.        logg
+00039df0: 696e 672e 696e 666f 2866 2249 6e73 6572  ing.info(f"Inser
+00039e00: 7469 6e67 2047 6173 2049 6e6a 6563 7469  ting Gas Injecti
+00039e10: 6f6e 2053 7973 7465 6d20 6174 207b 696e  on System at {in
+00039e20: 7365 7274 5f70 6f73 6974 696f 6e7d 2229  sert_position}")
+00039e30: 0a20 2020 2020 2020 2067 6973 2e69 6e73  .        gis.ins
+00039e40: 6572 7428 290a 2020 2020 0a20 2020 2020  ert().    .     
+00039e50: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+00039e60: 6622 5475 726e 696e 6720 6f6e 2068 6561  f"Turning on hea
+00039e70: 7465 7220 666f 7220 7b67 6173 7d22 290a  ter for {gas}").
+00039e80: 2020 2020 2020 2020 2320 7475 726e 206f          # turn o
+00039e90: 6e20 6865 6174 6572 0a20 2020 2020 2020  n heater.       
+00039ea0: 2067 6973 2e74 7572 6e5f 6865 6174 6572   gis.turn_heater
+00039eb0: 5f6f 6e28 290a 2020 2020 2020 2020 7469  _on().        ti
+00039ec0: 6d65 2e73 6c65 6570 2833 2920 2320 7761  me.sleep(3) # wa
+00039ed0: 6974 2066 6f72 2074 6865 2068 6561 740a  it for the heat.
+00039ee0: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
+00039ef0: 6765 7420 7374 6174 6520 6665 6564 6261  get state feedba
+00039f00: 636b 2c20 7761 6974 2066 6f72 2068 6561  ck, wait for hea
+00039f10: 7465 7220 746f 2062 6520 6174 2074 656d  ter to be at tem
+00039f20: 700a 0a20 2020 2020 2020 2023 2072 756e  p..        # run
+00039f30: 2064 6570 6f73 6974 696f 6e0a 2020 2020   deposition.    
+00039f40: 2020 2020 6c6f 6767 696e 672e 696e 666f      logging.info
+00039f50: 2866 2252 756e 6e69 6e67 2064 6570 6f73  (f"Running depos
+00039f60: 6974 696f 6e20 666f 7220 7b64 7572 6174  ition for {durat
+00039f70: 696f 6e7d 2073 6563 6f6e 6473 2229 0a20  ion} seconds"). 
+00039f80: 2020 2020 2020 2023 2067 6973 2e6f 7065         # gis.ope
+00039f90: 6e28 290a 2020 2020 2020 2020 7469 6d65  n().        time
+00039fa0: 2e73 6c65 6570 2864 7572 6174 696f 6e29  .sleep(duration)
+00039fb0: 200a 2020 2020 2020 2020 6769 732e 636c   .        gis.cl
+00039fc0: 6f73 6528 290a 0a20 2020 2020 2020 2023  ose()..        #
+00039fd0: 2074 7572 6e20 6f66 6620 6865 6174 6572   turn off heater
+00039fe0: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+00039ff0: 2e69 6e66 6f28 6622 5475 726e 696e 6720  .info(f"Turning 
+0003a000: 6f66 6620 6865 6174 6572 2066 6f72 207b  off heater for {
+0003a010: 6761 737d 2229 0a20 2020 2020 2020 2067  gas}").        g
+0003a020: 6973 2e74 7572 6e5f 6865 6174 6572 5f6f  is.turn_heater_o
+0003a030: 6666 2829 0a0a 2020 2020 2020 2020 2320  ff()..        # 
+0003a040: 7265 7472 6163 7420 6769 7320 2f20 6d75  retract gis / mu
+0003a050: 6c74 6963 6865 6d0a 2020 2020 2020 2020  ltichem.        
+0003a060: 6c6f 6767 696e 672e 696e 666f 2866 2252  logging.info(f"R
+0003a070: 6574 7261 6374 696e 6720 4761 7320 496e  etracting Gas In
+0003a080: 6a65 6374 696f 6e20 5379 7374 656d 2229  jection System")
+0003a090: 0a20 2020 2020 2020 2067 6973 2e72 6574  .        gis.ret
+0003a0a0: 7261 6374 2829 0a20 2020 2020 2020 2020  ract().         
+0003a0b0: 2020 200a 2020 2020 2020 2020 7265 7475     .        retu
+0003a0c0: 726e 0a20 2020 2020 2020 2020 2020 200a  rn.            .
+0003a0d0: 2020 2020 6465 6620 7275 6e5f 7370 7574      def run_sput
+0003a0e0: 7465 7228 7365 6c66 2c20 2a2a 6b77 6172  ter(self, **kwar
+0003a0f0: 6773 293a 0a20 2020 2020 2020 205f 6368  gs):.        _ch
+0003a100: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+0003a110: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
+0003a120: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0003a130: 5275 6e6e 696e 6720 7370 7574 7465 723a  Running sputter:
+0003a140: 207b 6b77 6172 6773 7d22 290a 0a20 2020   {kwargs}")..   
+0003a150: 2064 6566 2066 696e 6973 685f 7370 7574   def finish_sput
+0003a160: 7465 7228 7365 6c66 2c20 2a2a 6b77 6172  ter(self, **kwar
+0003a170: 6773 293a 0a20 2020 2020 2020 205f 6368  gs):.        _ch
+0003a180: 6563 6b5f 7370 7574 7465 7228 7365 6c66  eck_sputter(self
+0003a190: 2e73 7973 7465 6d29 0a20 2020 2020 2020  .system).       
+0003a1a0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0003a1b0: 4669 6e69 7368 696e 6720 7370 7574 7465  Finishing sputte
+0003a1c0: 723a 207b 6b77 6172 6773 7d22 290a 0a20  r: {kwargs}").. 
+0003a1d0: 2020 2064 6566 2067 6574 5f61 7661 696c     def get_avail
+0003a1e0: 6162 6c65 5f76 616c 7565 7328 7365 6c66  able_values(self
+0003a1f0: 2c20 6b65 793a 2073 7472 2c20 6265 616d  , key: str, beam
+0003a200: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
+0003a210: 3d20 4e6f 6e65 2920 2d3e 206c 6973 745b  = None) -> list[
+0003a220: 666c 6f61 745d 3a0a 2020 2020 2020 2020  float]:.        
+0003a230: 0a20 2020 2020 2020 2076 616c 7565 7320  .        values 
+0003a240: 3d20 5b5d 0a20 2020 2020 2020 2069 6620  = [].        if 
+0003a250: 6b65 7920 3d3d 2022 6375 7272 656e 7422  key == "current"
+0003a260: 3a0a 2020 2020 2020 2020 2020 2020 5f63  :.            _c
+0003a270: 6865 636b 5f62 6561 6d28 6265 616d 5f74  heck_beam(beam_t
+0003a280: 7970 652c 2073 656c 662e 7379 7374 656d  ype, self.system
+0003a290: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0003a2a0: 2062 6561 6d5f 7479 7065 203d 3d20 4265   beam_type == Be
+0003a2b0: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
+0003a2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a2d0: 2076 616c 7565 7320 3d20 5b31 2e30 652d   values = [1.0e-
+0003a2e0: 3132 5d0a 2020 2020 2020 2020 2020 2020  12].            
+0003a2f0: 6966 2062 6561 6d5f 7479 7065 203d 3d20  if beam_type == 
+0003a300: 4265 616d 5479 7065 2e49 4f4e 3a0a 2020  BeamType.ION:.  
+0003a310: 2020 2020 2020 2020 2020 2020 2020 7661                va
+0003a320: 6c75 6573 203d 205b 3230 652d 3132 2c20  lues = [20e-12, 
+0003a330: 3630 652d 3132 2c20 302e 3265 2d39 2c20  60e-12, 0.2e-9, 
+0003a340: 302e 3734 652d 392c 2032 2e30 652d 392c  0.74e-9, 2.0e-9,
+0003a350: 2037 2e36 652d 392c 2032 382e 3065 2d39   7.6e-9, 28.0e-9
+0003a360: 2c20 3132 3065 2d39 5d0a 2020 2020 2020  , 120e-9].      
+0003a370: 2020 0a0a 2020 2020 2020 2020 6966 206b    ..        if k
+0003a380: 6579 203d 3d20 2261 7070 6c69 6361 7469  ey == "applicati
+0003a390: 6f6e 5f66 696c 6522 3a0a 2020 2020 2020  on_file":.      
+0003a3a0: 2020 2020 2020 7661 6c75 6573 203d 205b        values = [
+0003a3b0: 2253 6922 2c20 2261 7574 6f6c 616d 656c  "Si", "autolamel
+0003a3c0: 6c61 222c 2022 6372 796f 5f50 745f 6465  la", "cryo_Pt_de
+0003a3d0: 7022 5d0a 0a20 2020 2020 2020 2069 6620  p"]..        if 
+0003a3e0: 6b65 7920 3d3d 2022 6465 7465 6374 6f72  key == "detector
+0003a3f0: 5f74 7970 6522 3a0a 2020 2020 2020 2020  _type":.        
+0003a400: 2020 2020 7661 6c75 6573 203d 205b 2245      values = ["E
+0003a410: 5444 222c 2022 544c 4422 2c20 2245 4453  TD", "TLD", "EDS
+0003a420: 225d 0a20 2020 2020 2020 2069 6620 6b65  "].        if ke
+0003a430: 7920 3d3d 2022 6465 7465 6374 6f72 5f6d  y == "detector_m
+0003a440: 6f64 6522 3a0a 2020 2020 2020 2020 2020  ode":.          
+0003a450: 2020 7661 6c75 6573 203d 205b 2253 6563    values = ["Sec
+0003a460: 6f6e 6461 7279 456c 6563 7472 6f6e 7322  ondaryElectrons"
+0003a470: 2c20 2242 6163 6b73 6361 7474 6572 6564  , "Backscattered
+0003a480: 456c 6563 7472 6f6e 7322 2c20 2245 4453  Electrons", "EDS
+0003a490: 225d 0a20 2020 2020 2020 200a 2020 2020  "].        .    
+0003a4a0: 2020 2020 6966 206b 6579 203d 3d20 2273      if key == "s
+0003a4b0: 6361 6e5f 6469 7265 6374 696f 6e22 3a0a  can_direction":.
+0003a4c0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+0003a4d0: 6573 203d 205b 2242 6f74 746f 6d54 6f54  es = ["BottomToT
+0003a4e0: 6f70 222c 200a 2020 2020 2020 2020 2020  op", .          
+0003a4f0: 2020 2020 2020 224c 6566 7454 6f52 6967        "LeftToRig
+0003a500: 6874 222c 2009 0a20 2020 2020 2020 2020  ht", ..         
+0003a510: 2020 2020 2020 2022 5269 6768 7454 6f4c         "RightToL
+0003a520: 6566 7422 2c20 090a 2020 2020 2020 2020  eft", ..        
+0003a530: 2020 2020 2020 2020 2254 6f70 546f 426f          "TopToBo
+0003a540: 7474 6f6d 225d 0a20 2020 2020 2020 2020  ttom"].         
+0003a550: 2020 200a 2020 2020 2020 2020 6966 206b     .        if k
+0003a560: 6579 203d 3d20 2270 6c61 736d 615f 6761  ey == "plasma_ga
+0003a570: 7322 3a0a 2020 2020 2020 2020 2020 2020  s":.            
+0003a580: 7661 6c75 6573 203d 205b 224f 7879 6765  values = ["Oxyge
+0003a590: 6e22 2c20 2241 7267 6f6e 222c 2022 4e69  n", "Argon", "Ni
+0003a5a0: 7472 6f67 656e 222c 2022 5865 6e6f 6e22  trogen", "Xenon"
+0003a5b0: 5d0a 2020 2020 2020 2020 200a 2020 2020  ].         .    
+0003a5c0: 2020 2020 6966 206b 6579 203d 3d20 2267      if key == "g
+0003a5d0: 6973 5f70 6f72 7473 223a 0a20 2020 2020  is_ports":.     
+0003a5e0: 2020 2020 2020 2076 616c 7565 7320 3d20         values = 
+0003a5f0: 5b22 5074 2044 6570 222c 2022 5074 2044  ["Pt Dep", "Pt D
+0003a600: 6570 2043 7279 6f32 225d 0a20 2020 2020  ep Cryo2"].     
+0003a610: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0003a620: 2020 2020 7265 7475 726e 2076 616c 7565      return value
+0003a630: 730a 0a20 2020 2064 6566 205f 6765 7428  s..    def _get(
+0003a640: 7365 6c66 2c20 6b65 792c 2062 6561 6d5f  self, key, beam_
+0003a650: 7479 7065 3a20 4265 616d 5479 7065 203d  type: BeamType =
+0003a660: 204e 6f6e 6529 202d 3e20 556e 696f 6e5b   None) -> Union[
+0003a670: 666c 6f61 742c 2069 6e74 2c20 626f 6f6c  float, int, bool
+0003a680: 2c20 7374 722c 206c 6973 745d 3a0a 2020  , str, list]:.  
+0003a690: 2020 2020 2020 2222 2247 6574 2061 2076        """Get a v
+0003a6a0: 616c 7565 2066 726f 6d20 7468 6520 6d69  alue from the mi
+0003a6b0: 6372 6f73 636f 7065 2e22 2222 0a20 2020  croscope.""".   
+0003a6c0: 2020 2020 2023 2067 6574 2062 6561 6d0a       # get beam.
+0003a6d0: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+0003a6e0: 7479 7065 2069 7320 6e6f 7420 4e6f 6e65  type is not None
+0003a6f0: 3a0a 2020 2020 2020 2020 2020 2020 6265  :.            be
+0003a700: 616d 5f73 7973 7465 6d20 3d20 7365 6c66  am_system = self
+0003a710: 2e65 6c65 6374 726f 6e5f 7379 7374 656d  .electron_system
+0003a720: 2069 6620 6265 616d 5f74 7970 6520 6973   if beam_type is
+0003a730: 2042 6561 6d54 7970 652e 454c 4543 5452   BeamType.ELECTR
+0003a740: 4f4e 2065 6c73 6520 7365 6c66 2e69 6f6e  ON else self.ion
+0003a750: 5f73 7973 7465 6d0a 2020 2020 2020 2020  _system.        
+0003a760: 2020 2020 6265 616d 2c20 6465 7465 6374      beam, detect
+0003a770: 6f72 203d 2062 6561 6d5f 7379 7374 656d  or = beam_system
+0003a780: 2e62 6561 6d2c 2062 6561 6d5f 7379 7374  .beam, beam_syst
+0003a790: 656d 2e64 6574 6563 746f 720a 2020 2020  em.detector.    
+0003a7a0: 2020 2020 2020 2020 5f63 6865 636b 5f62          _check_b
+0003a7b0: 6561 6d28 6265 616d 5f74 7970 652c 2073  eam(beam_type, s
+0003a7c0: 656c 662e 7379 7374 656d 290a 2020 2020  elf.system).    
+0003a7d0: 2020 2020 0a20 2020 2020 2020 2023 2054      .        # T
+0003a7e0: 4f44 4f3a 2063 6861 6e67 6520 7468 6973  ODO: change this
+0003a7f0: 2073 6f20 7661 6c75 6520 6973 2072 6574   so value is ret
+0003a800: 7572 6e65 642c 2073 6f20 7765 2063 616e  urned, so we can
+0003a810: 206c 6f67 2074 6865 2072 6574 7572 6e20   log the return 
+0003a820: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0003a830: 2020 0a20 2020 2020 2020 2023 2062 6561    .        # bea
+0003a840: 6d20 7072 6f70 6572 7469 6573 0a20 2020  m properties.   
+0003a850: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0003a860: 6f6e 223a 200a 2020 2020 2020 2020 2020  on": .          
+0003a870: 2020 7265 7475 726e 2062 6561 6d5f 7379    return beam_sy
+0003a880: 7374 656d 2e6f 6e0a 2020 2020 2020 2020  stem.on.        
+0003a890: 6966 206b 6579 203d 3d20 2262 6c61 6e6b  if key == "blank
+0003a8a0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
+0003a8b0: 2072 6574 7572 6e20 6265 616d 5f73 7973   return beam_sys
+0003a8c0: 7465 6d2e 626c 616e 6b65 640a 2020 2020  tem.blanked.    
+0003a8d0: 2020 2020 6966 206b 6579 203d 3d20 2276      if key == "v
+0003a8e0: 6f6c 7461 6765 223a 0a20 2020 2020 2020  oltage":.       
+0003a8f0: 2020 2020 2072 6574 7572 6e20 6265 616d       return beam
+0003a900: 2e76 6f6c 7461 6765 0a20 2020 2020 2020  .voltage.       
+0003a910: 2069 6620 6b65 7920 3d3d 2022 6375 7272   if key == "curr
+0003a920: 656e 7422 3a0a 2020 2020 2020 2020 2020  ent":.          
+0003a930: 2020 7265 7475 726e 2062 6561 6d2e 6265    return beam.be
+0003a940: 616d 5f63 7572 7265 6e74 0a20 2020 2020  am_current.     
+0003a950: 2020 2069 6620 6b65 7920 3d3d 2022 776f     if key == "wo
+0003a960: 726b 696e 675f 6469 7374 616e 6365 223a  rking_distance":
+0003a970: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003a980: 7572 6e20 6265 616d 2e77 6f72 6b69 6e67  urn beam.working
+0003a990: 5f64 6973 7461 6e63 650a 2020 2020 2020  _distance.      
+0003a9a0: 2020 6966 206b 6579 203d 3d20 2268 6677    if key == "hfw
+0003a9b0: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
+0003a9c0: 6574 7572 6e20 6265 616d 2e68 6677 0a20  eturn beam.hfw. 
+0003a9d0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0003a9e0: 2022 7265 736f 6c75 7469 6f6e 223a 0a20   "resolution":. 
+0003a9f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003aa00: 6e20 6265 616d 2e72 6573 6f6c 7574 696f  n beam.resolutio
+0003aa10: 6e0a 2020 2020 2020 2020 6966 206b 6579  n.        if key
+0003aa20: 203d 3d20 2264 7765 6c6c 5f74 696d 6522   == "dwell_time"
+0003aa30: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0003aa40: 7475 726e 2062 6561 6d2e 6477 656c 6c5f  turn beam.dwell_
+0003aa50: 7469 6d65 0a20 2020 2020 2020 2069 6620  time.        if 
+0003aa60: 6b65 7920 3d3d 2022 7374 6967 6d61 7469  key == "stigmati
+0003aa70: 6f6e 223a 0a20 2020 2020 2020 2020 2020  on":.           
+0003aa80: 2072 6574 7572 6e20 506f 696e 7428 6265   return Point(be
+0003aa90: 616d 2e73 7469 676d 6174 696f 6e2e 782c  am.stigmation.x,
+0003aaa0: 2062 6561 6d2e 7374 6967 6d61 7469 6f6e   beam.stigmation
+0003aab0: 2e79 290a 2020 2020 2020 2020 6966 206b  .y).        if k
+0003aac0: 6579 203d 3d20 2273 6869 6674 223a 0a20  ey == "shift":. 
+0003aad0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003aae0: 6e20 506f 696e 7428 6265 616d 2e73 6869  n Point(beam.shi
+0003aaf0: 6674 2e78 2c20 6265 616d 2e73 6869 6674  ft.x, beam.shift
+0003ab00: 2e79 290a 2020 2020 2020 2020 6966 206b  .y).        if k
+0003ab10: 6579 203d 3d20 2273 6361 6e5f 726f 7461  ey == "scan_rota
+0003ab20: 7469 6f6e 223a 0a20 2020 2020 2020 2020  tion":.         
+0003ab30: 2020 2072 6574 7572 6e20 6265 616d 2e73     return beam.s
+0003ab40: 6361 6e5f 726f 7461 7469 6f6e 0a20 2020  can_rotation.   
+0003ab50: 2020 2020 200a 2020 2020 2020 2020 2320       .        # 
+0003ab60: 7379 7374 656d 2070 726f 7065 7274 6965  system propertie
+0003ab70: 730a 2020 2020 2020 2020 2020 2020 0a20  s.            . 
+0003ab80: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0003ab90: 2022 6265 616d 5f65 6e61 626c 6564 223a   "beam_enabled":
+0003aba0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003abb0: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
+0003abc0: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
+0003abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003abe0: 7265 7475 726e 2073 656c 662e 7379 7374  return self.syst
+0003abf0: 656d 2e65 6c65 6374 726f 6e2e 656e 6162  em.electron.enab
+0003ac00: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
+0003ac10: 656c 6966 2062 6561 6d5f 7479 7065 2069  elif beam_type i
+0003ac20: 7320 4265 616d 5479 7065 2e49 4f4e 3a0a  s BeamType.ION:.
+0003ac30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac40: 7265 7475 726e 2073 656c 662e 7379 7374  return self.syst
+0003ac50: 656d 2e69 6f6e 2e65 6e61 626c 6564 0a20  em.ion.enabled. 
+0003ac60: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0003ac70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ac80: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0003ac90: 7228 6622 556e 6b6e 6f77 6e20 6265 616d  r(f"Unknown beam
+0003aca0: 2074 7970 653a 207b 6265 616d 5f74 7970   type: {beam_typ
+0003acb0: 657d 2066 6f72 207b 6b65 797d 2229 0a20  e} for {key}"). 
+0003acc0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0003acd0: 2020 2020 6966 206b 6579 203d 3d20 2265      if key == "e
+0003ace0: 7563 656e 7472 6963 5f68 6569 6768 7422  ucentric_height"
+0003acf0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0003ad00: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
+0003ad10: 616d 5479 7065 2e45 4c45 4354 524f 4e3a  amType.ELECTRON:
+0003ad20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ad30: 2072 6574 7572 6e20 7365 6c66 2e73 7973   return self.sys
+0003ad40: 7465 6d2e 656c 6563 7472 6f6e 2e65 7563  tem.electron.euc
+0003ad50: 656e 7472 6963 5f68 6569 6768 740a 2020  entric_height.  
+0003ad60: 2020 2020 2020 2020 2020 656c 6966 2062            elif b
+0003ad70: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
+0003ad80: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
+0003ad90: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003ada0: 2073 656c 662e 7379 7374 656d 2e69 6f6e   self.system.ion
+0003adb0: 2e65 7563 656e 7472 6963 5f68 6569 6768  .eucentric_heigh
+0003adc0: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+0003add0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003ade0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0003adf0: 7272 6f72 2866 2255 6e6b 6e6f 776e 2062  rror(f"Unknown b
+0003ae00: 6561 6d20 7479 7065 3a20 7b62 6561 6d5f  eam type: {beam_
+0003ae10: 7479 7065 7d20 666f 7220 7b6b 6579 7d22  type} for {key}"
+0003ae20: 290a 0a20 2020 2020 2020 2069 6620 6b65  )..        if ke
+0003ae30: 7920 3d3d 2022 636f 6c75 6d6e 5f74 696c  y == "column_til
+0003ae40: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+0003ae50: 6966 2062 6561 6d5f 7479 7065 2069 7320  if beam_type is 
+0003ae60: 4265 616d 5479 7065 2e45 4c45 4354 524f  BeamType.ELECTRO
+0003ae70: 4e3a 0a20 2020 2020 2020 2020 2020 2020  N:.             
+0003ae80: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+0003ae90: 7973 7465 6d2e 656c 6563 7472 6f6e 2e63  ystem.electron.c
+0003aea0: 6f6c 756d 6e5f 7469 6c74 0a20 2020 2020  olumn_tilt.     
+0003aeb0: 2020 2020 2020 2065 6c69 6620 6265 616d         elif beam
+0003aec0: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
+0003aed0: 652e 494f 4e3a 0a20 2020 2020 2020 2020  e.ION:.         
+0003aee0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0003aef0: 6c66 2e73 7973 7465 6d2e 696f 6e2e 636f  lf.system.ion.co
+0003af00: 6c75 6d6e 5f74 696c 740a 2020 2020 2020  lumn_tilt.      
+0003af10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0003af20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0003af30: 6520 5661 6c75 6545 7272 6f72 2866 2255  e ValueError(f"U
+0003af40: 6e6b 6e6f 776e 2062 6561 6d20 7479 7065  nknown beam type
+0003af50: 3a20 7b62 6561 6d5f 7479 7065 7d20 666f  : {beam_type} fo
+0003af60: 7220 7b6b 6579 7d22 290a 0a20 2020 2020  r {key}")..     
+0003af70: 2020 2023 2069 6f6e 2062 6561 6d20 7072     # ion beam pr
+0003af80: 6f70 6572 7469 6573 0a20 2020 2020 2020  operties.       
+0003af90: 2069 6620 6b65 7920 3d3d 2022 706c 6173   if key == "plas
+0003afa0: 6d61 223a 0a20 2020 2020 2020 2020 2020  ma":.           
+0003afb0: 2069 6620 6265 616d 5f74 7970 6520 6973   if beam_type is
+0003afc0: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
+0003afd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003afe0: 6574 7572 6e20 7365 6c66 2e73 7973 7465  eturn self.syste
+0003aff0: 6d2e 696f 6e2e 706c 6173 6d61 0a20 2020  m.ion.plasma.   
+0003b000: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0003b010: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003b020: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+0003b030: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0003b040: 706c 6173 6d61 5f67 6173 223a 0a20 2020  plasma_gas":.   
+0003b050: 2020 2020 2020 2020 2069 6620 6265 616d           if beam
+0003b060: 5f74 7970 6520 6973 2042 6561 6d54 7970  _type is BeamTyp
+0003b070: 652e 494f 4e20 616e 6420 7365 6c66 2e73  e.ION and self.s
+0003b080: 7973 7465 6d2e 696f 6e2e 706c 6173 6d61  ystem.ion.plasma
+0003b090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003b0a0: 2020 7265 7475 726e 2073 656c 662e 7379    return self.sy
+0003b0b0: 7374 656d 2e69 6f6e 2e70 6c61 736d 615f  stem.ion.plasma_
+0003b0c0: 6761 7320 2320 6d69 6768 7420 6e65 6564  gas # might need
+0003b0d0: 2074 6f20 6368 6563 6b20 6966 2074 6869   to check if thi
+0003b0e0: 7320 6973 2061 7661 696c 6162 6c65 3f0a  s is available?.
+0003b0f0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0003b100: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003b110: 2020 7265 7475 726e 204e 6f6e 6520 2020    return None   
+0003b120: 2020 0a20 2020 200a 2020 2020 2020 2020    .    .        
+0003b130: 2320 7374 6167 6520 0a20 2020 2020 2020  # stage .       
+0003b140: 2069 6620 6b65 7920 3d3d 2022 7374 6167   if key == "stag
+0003b150: 655f 706f 7369 7469 6f6e 223a 0a20 2020  e_position":.   
+0003b160: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003b170: 7365 6c66 2e73 7461 6765 5f73 7973 7465  self.stage_syste
+0003b180: 6d2e 706f 7369 7469 6f6e 0a20 2020 2020  m.position.     
+0003b190: 2020 2069 6620 6b65 7920 3d3d 2022 7374     if key == "st
+0003b1a0: 6167 655f 686f 6d65 6422 3a0a 2020 2020  age_homed":.    
+0003b1b0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0003b1c0: 656c 662e 7374 6167 655f 7379 7374 656d  elf.stage_system
+0003b1d0: 2e69 735f 686f 6d65 640a 2020 2020 2020  .is_homed.      
+0003b1e0: 2020 6966 206b 6579 203d 3d20 2273 7461    if key == "sta
+0003b1f0: 6765 5f6c 696e 6b65 6422 3a0a 2020 2020  ge_linked":.    
+0003b200: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0003b210: 656c 662e 7374 6167 655f 7379 7374 656d  elf.stage_system
+0003b220: 2e69 735f 6c69 6e6b 6564 0a20 2020 2020  .is_linked.     
+0003b230: 2020 200a 2020 2020 2020 2020 2320 6465     .        # de
+0003b240: 7465 6374 6f72 2070 726f 7065 7274 6965  tector propertie
+0003b250: 730a 2020 2020 2020 2020 6966 206b 6579  s.        if key
+0003b260: 203d 3d20 2264 6574 6563 746f 725f 7479   == "detector_ty
+0003b270: 7065 223a 0a20 2020 2020 2020 2020 2020  pe":.           
+0003b280: 2072 6574 7572 6e20 6465 7465 6374 6f72   return detector
+0003b290: 2e74 7970 650a 2020 2020 2020 2020 6966  .type.        if
+0003b2a0: 206b 6579 203d 3d20 2264 6574 6563 746f   key == "detecto
+0003b2b0: 725f 6d6f 6465 223a 0a20 2020 2020 2020  r_mode":.       
+0003b2c0: 2020 2020 2072 6574 7572 6e20 6465 7465       return dete
+0003b2d0: 6374 6f72 2e6d 6f64 650a 2020 2020 2020  ctor.mode.      
+0003b2e0: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
+0003b2f0: 6563 746f 725f 6272 6967 6874 6e65 7373  ector_brightness
+0003b300: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
+0003b310: 6574 7572 6e20 6465 7465 6374 6f72 2e62  eturn detector.b
+0003b320: 7269 6768 746e 6573 730a 2020 2020 2020  rightness.      
+0003b330: 2020 6966 206b 6579 203d 3d20 2264 6574    if key == "det
+0003b340: 6563 746f 725f 636f 6e74 7261 7374 223a  ector_contrast":
+0003b350: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003b360: 7572 6e20 6465 7465 6374 6f72 2e63 6f6e  urn detector.con
+0003b370: 7472 6173 740a 0a20 2020 2020 2020 2023  trast..        #
+0003b380: 206d 616e 6970 756c 6174 6f72 2070 726f   manipulator pro
+0003b390: 7065 7274 6965 730a 2020 2020 2020 2020  perties.        
+0003b3a0: 6966 206b 6579 203d 3d20 226d 616e 6970  if key == "manip
+0003b3b0: 756c 6174 6f72 5f70 6f73 6974 696f 6e22  ulator_position"
+0003b3c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0003b3d0: 7475 726e 2073 656c 662e 6d61 6e69 7075  turn self.manipu
+0003b3e0: 6c61 746f 725f 7379 7374 656d 2e70 6f73  lator_system.pos
+0003b3f0: 6974 696f 6e0a 2020 2020 2020 2020 6966  ition.        if
+0003b400: 206b 6579 203d 3d20 226d 616e 6970 756c   key == "manipul
+0003b410: 6174 6f72 5f73 7461 7465 223a 2020 0a20  ator_state":  . 
+0003b420: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003b430: 6e20 7365 6c66 2e6d 616e 6970 756c 6174  n self.manipulat
+0003b440: 6f72 5f73 7973 7465 6d2e 696e 7365 7274  or_system.insert
+0003b450: 6564 2020 2020 200a 2020 2020 2020 2020  ed     .        
+0003b460: 0a20 2020 2020 2020 2023 206d 616e 7566  .        # manuf
+0003b470: 6163 7475 7265 7220 7072 6f70 6572 7469  acturer properti
+0003b480: 6573 0a20 2020 2020 2020 2069 6620 6b65  es.        if ke
+0003b490: 7920 3d3d 2022 6d61 6e75 6661 6374 7572  y == "manufactur
+0003b4a0: 6572 223a 0a20 2020 2020 2020 2020 2020  er":.           
+0003b4b0: 2072 6574 7572 6e20 7365 6c66 2e73 7973   return self.sys
+0003b4c0: 7465 6d2e 696e 666f 2e6d 616e 7566 6163  tem.info.manufac
+0003b4d0: 7475 7265 720a 2020 2020 2020 2020 6966  turer.        if
+0003b4e0: 206b 6579 203d 3d20 226d 6f64 656c 223a   key == "model":
+0003b4f0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003b500: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
+0003b510: 696e 666f 2e6d 6f64 656c 0a20 2020 2020  info.model.     
+0003b520: 2020 2069 6620 6b65 7920 3d3d 2022 736f     if key == "so
+0003b530: 6674 7761 7265 5f76 6572 7369 6f6e 223a  ftware_version":
+0003b540: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003b550: 7572 6e20 7365 6c66 2e73 7973 7465 6d2e  urn self.system.
+0003b560: 696e 666f 2e73 6f66 7477 6172 655f 7665  info.software_ve
+0003b570: 7273 696f 6e0a 2020 2020 2020 2020 6966  rsion.        if
+0003b580: 206b 6579 203d 3d20 2273 6572 6961 6c5f   key == "serial_
+0003b590: 6e75 6d62 6572 223a 0a20 2020 2020 2020  number":.       
+0003b5a0: 2020 2020 2072 6574 7572 6e20 2255 6e6b       return "Unk
+0003b5b0: 6e6f 776e 220a 2020 2020 2020 2020 6966  nown".        if
+0003b5c0: 206b 6579 203d 3d20 2268 6172 6477 6172   key == "hardwar
+0003b5d0: 655f 7665 7273 696f 6e22 3a0a 2020 2020  e_version":.    
+0003b5e0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0003b5f0: 656c 662e 7379 7374 656d 2e69 6e66 6f2e  elf.system.info.
+0003b600: 6861 7264 7761 7265 5f76 6572 7369 6f6e  hardware_version
+0003b610: 0a0a 2020 2020 2020 2020 2320 6368 616d  ..        # cham
+0003b620: 6265 7220 7072 6f70 6572 7469 6573 0a20  ber properties. 
+0003b630: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0003b640: 2022 6368 616d 6265 725f 7374 6174 6522   "chamber_state"
+0003b650: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0003b660: 7475 726e 2073 656c 662e 6368 616d 6265  turn self.chambe
+0003b670: 722e 7374 6174 650a 2020 2020 2020 2020  r.state.        
+0003b680: 6966 206b 6579 203d 3d20 2263 6861 6d62  if key == "chamb
+0003b690: 6572 5f70 7265 7373 7572 6522 3a0a 2020  er_pressure":.  
+0003b6a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003b6b0: 2073 656c 662e 6368 616d 6265 722e 7072   self.chamber.pr
+0003b6c0: 6573 7375 7265 0a20 2020 2020 2020 200a  essure.        .
+0003b6d0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0003b6e0: 7761 726e 696e 6728 6622 556e 6b6e 6f77  warning(f"Unknow
+0003b6f0: 6e20 6b65 793a 207b 6b65 797d 2028 7b62  n key: {key} ({b
+0003b700: 6561 6d5f 7479 7065 7d29 2229 0a20 2020  eam_type})").   
+0003b710: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+0003b720: 0a0a 2020 2020 6465 6620 5f73 6574 2873  ..    def _set(s
+0003b730: 656c 662c 206b 6579 3a20 7374 722c 2076  elf, key: str, v
+0003b740: 616c 7565 2c20 6265 616d 5f74 7970 653a  alue, beam_type:
+0003b750: 2042 6561 6d54 7970 6520 3d20 4e6f 6e65   BeamType = None
+0003b760: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0003b770: 2020 2022 2222 5365 7420 6120 7072 6f70     """Set a prop
+0003b780: 6572 7479 206f 6620 7468 6520 6d69 6372  erty of the micr
+0003b790: 6f73 636f 7065 2e22 2222 0a20 2020 2020  oscope.""".     
+0003b7a0: 2020 200a 2020 2020 2020 2020 2320 6765     .        # ge
+0003b7b0: 7420 6265 616d 0a20 2020 2020 2020 2069  t beam.        i
+0003b7c0: 6620 6265 616d 5f74 7970 6520 6973 206e  f beam_type is n
+0003b7d0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0003b7e0: 2020 2020 2062 6561 6d5f 7379 7374 656d       beam_system
+0003b7f0: 203d 2073 656c 662e 656c 6563 7472 6f6e   = self.electron
+0003b800: 5f73 7973 7465 6d20 6966 2062 6561 6d5f  _system if beam_
+0003b810: 7479 7065 2069 7320 4265 616d 5479 7065  type is BeamType
+0003b820: 2e45 4c45 4354 524f 4e20 656c 7365 2073  .ELECTRON else s
+0003b830: 656c 662e 696f 6e5f 7379 7374 656d 2020  elf.ion_system  
+0003b840: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0003b850: 2020 2020 2020 2062 6561 6d20 3d20 6265         beam = be
+0003b860: 616d 5f73 7973 7465 6d2e 6265 616d 0a20  am_system.beam. 
+0003b870: 2020 2020 2020 2020 2020 2064 6574 6563             detec
+0003b880: 746f 7220 3d20 6265 616d 5f73 7973 7465  tor = beam_syste
+0003b890: 6d2e 6465 7465 6374 6f72 0a20 2020 2020  m.detector.     
+0003b8a0: 2020 2020 2020 205f 6368 6563 6b5f 6265         _check_be
+0003b8b0: 616d 2862 6561 6d5f 7479 7065 2c20 7365  am(beam_type, se
+0003b8c0: 6c66 2e73 7973 7465 6d29 0a0a 0a20 2020  lf.system)...   
+0003b8d0: 2020 2020 2023 2076 6f6c 7461 6765 0a20       # voltage. 
+0003b8e0: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0003b8f0: 2022 766f 6c74 6167 6522 3a0a 2020 2020   "voltage":.    
+0003b900: 2020 2020 2020 2020 6265 616d 2e76 6f6c          beam.vol
+0003b910: 7461 6765 203d 2076 616c 7565 0a20 2020  tage = value.   
+0003b920: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0003b930: 2020 2020 2020 2020 2320 6375 7272 656e          # curren
+0003b940: 740a 2020 2020 2020 2020 6966 206b 6579  t.        if key
+0003b950: 203d 3d20 2263 7572 7265 6e74 223a 0a20   == "current":. 
+0003b960: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0003b970: 6265 616d 5f63 7572 7265 6e74 203d 2076  beam_current = v
+0003b980: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+0003b990: 2072 6574 7572 6e20 2020 2020 2020 200a   return        .
+0003b9a0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0003b9b0: 2069 6620 6b65 7920 3d3d 2022 776f 726b   if key == "work
+0003b9c0: 696e 675f 6469 7374 616e 6365 223a 0a20  ing_distance":. 
+0003b9d0: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0003b9e0: 776f 726b 696e 675f 6469 7374 616e 6365  working_distance
+0003b9f0: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+0003ba00: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0003ba10: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
+0003ba20: 6b65 7920 3d3d 2022 7374 6967 6d61 7469  key == "stigmati
+0003ba30: 6f6e 223a 0a20 2020 2020 2020 2020 2020  on":.           
+0003ba40: 2062 6561 6d2e 7374 6967 6d61 7469 6f6e   beam.stigmation
+0003ba50: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+0003ba60: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+0003ba70: 2020 2020 6966 206b 6579 203d 3d20 2273      if key == "s
+0003ba80: 6869 6674 223a 0a20 2020 2020 2020 2020  hift":.         
+0003ba90: 2020 2062 6561 6d2e 7368 6966 7420 3d20     beam.shift = 
+0003baa0: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0003bab0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+0003bac0: 2069 6620 6b65 7920 3d3d 2022 7363 616e   if key == "scan
+0003bad0: 5f72 6f74 6174 696f 6e22 3a0a 2020 2020  _rotation":.    
+0003bae0: 2020 2020 2020 2020 6265 616d 2e73 6361          beam.sca
+0003baf0: 6e5f 726f 7461 7469 6f6e 203d 2076 616c  n_rotation = val
+0003bb00: 7565 0a20 2020 2020 2020 2020 2020 2072  ue.            r
+0003bb10: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
+0003bb20: 206b 6579 203d 3d20 2268 6677 223a 0a20   key == "hfw":. 
+0003bb30: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0003bb40: 6866 7720 3d20 7661 6c75 650a 2020 2020  hfw = value.    
+0003bb50: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0003bb60: 2020 2020 2020 2069 6620 6b65 7920 3d3d         if key ==
+0003bb70: 2022 7265 736f 6c75 7469 6f6e 223a 0a20   "resolution":. 
+0003bb80: 2020 2020 2020 2020 2020 2062 6561 6d2e             beam.
+0003bb90: 7265 736f 6c75 7469 6f6e 203d 2076 616c  resolution = val
+0003bba0: 7565 0a20 2020 2020 2020 2020 2020 2072  ue.            r
+0003bbb0: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
+0003bbc0: 206b 6579 203d 3d20 2264 7765 6c6c 5f74   key == "dwell_t
+0003bbd0: 696d 6522 3a0a 2020 2020 2020 2020 2020  ime":.          
+0003bbe0: 2020 6265 616d 2e64 7765 6c6c 5f74 696d    beam.dwell_tim
+0003bbf0: 6520 3d20 7661 6c75 650a 2020 2020 2020  e = value.      
+0003bc00: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0003bc10: 2020 2020 2020 2320 6265 616d 2063 6f6e        # beam con
+0003bc20: 7472 6f6c 0a20 2020 2020 2020 2069 6620  trol.        if 
+0003bc30: 6b65 7920 3d3d 2022 6f6e 223a 0a20 2020  key == "on":.   
+0003bc40: 2020 2020 2020 2020 2062 6561 6d5f 7379           beam_sy
+0003bc50: 7374 656d 2e6f 6e20 3d20 7661 6c75 650a  stem.on = value.
+0003bc60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003bc70: 726e 0a0a 2020 2020 2020 2020 6966 206b  rn..        if k
+0003bc80: 6579 203d 3d20 2262 6c61 6e6b 6564 223a  ey == "blanked":
+0003bc90: 0a20 2020 2020 2020 2020 2020 2062 6561  .            bea
+0003bca0: 6d5f 7379 7374 656d 2e62 6c61 6e6b 6564  m_system.blanked
+0003bcb0: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+0003bcc0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0003bcd0: 2020 2020 2023 2064 6574 6563 746f 720a       # detector.
+0003bce0: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+0003bcf0: 3d20 2264 6574 6563 746f 725f 7479 7065  = "detector_type
+0003bd00: 223a 0a20 2020 2020 2020 2020 2020 2064  ":.            d
+0003bd10: 6574 6563 746f 722e 7479 7065 203d 2076  etector.type = v
+0003bd20: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+0003bd30: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0003bd40: 6966 206b 6579 203d 3d20 2264 6574 6563  if key == "detec
+0003bd50: 746f 725f 6d6f 6465 223a 0a20 2020 2020  tor_mode":.     
+0003bd60: 2020 2020 2020 2064 6574 6563 746f 722e         detector.
+0003bd70: 6d6f 6465 203d 2076 616c 7565 0a20 2020  mode = value.   
+0003bd80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003bd90: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+0003bda0: 3d3d 2022 6465 7465 6374 6f72 5f63 6f6e  == "detector_con
+0003bdb0: 7472 6173 7422 3a0a 2020 2020 2020 2020  trast":.        
+0003bdc0: 2020 2020 6465 7465 6374 6f72 2e63 6f6e      detector.con
+0003bdd0: 7472 6173 7420 3d20 7661 6c75 650a 2020  trast = value.  
+0003bde0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003bdf0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+0003be00: 3d3d 2022 6465 7465 6374 6f72 5f62 7269  == "detector_bri
+0003be10: 6768 746e 6573 7322 3a0a 2020 2020 2020  ghtness":.      
+0003be20: 2020 2020 2020 6465 7465 6374 6f72 2e62        detector.b
+0003be30: 7269 6768 746e 6573 7320 3d20 7661 6c75  rightness = valu
+0003be40: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
+0003be50: 7475 726e 0a20 2020 2020 2020 200a 2020  turn.        .  
+0003be60: 2020 2020 2020 2320 7379 7374 656d 2070        # system p
+0003be70: 726f 7065 7274 6965 730a 2020 2020 2020  roperties.      
+0003be80: 2020 6966 206b 6579 203d 3d20 2262 6561    if key == "bea
+0003be90: 6d5f 656e 6162 6c65 6422 3a0a 2020 2020  m_enabled":.    
+0003bea0: 2020 2020 2020 2020 6966 2062 6561 6d5f          if beam_
+0003beb0: 7479 7065 2069 7320 4265 616d 5479 7065  type is BeamType
+0003bec0: 2e45 4c45 4354 524f 4e3a 0a20 2020 2020  .ELECTRON:.     
+0003bed0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003bee0: 7379 7374 656d 2e65 6c65 6374 726f 6e2e  system.electron.
+0003bef0: 6265 616d 2e65 6e61 626c 6564 203d 2076  beam.enabled = v
+0003bf00: 616c 7565 0a20 2020 2020 2020 2020 2020  alue.           
+0003bf10: 2020 2020 2072 6574 7572 6e20 0a20 2020       return .   
+0003bf20: 2020 2020 2020 2020 2065 6c69 6620 6265           elif be
+0003bf30: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
+0003bf40: 7970 652e 494f 4e3a 0a20 2020 2020 2020  ype.ION:.       
+0003bf50: 2020 2020 2020 2020 2073 656c 662e 7379           self.sy
+0003bf60: 7374 656d 2e69 6f6e 2e62 6561 6d2e 656e  stem.ion.beam.en
+0003bf70: 6162 6c65 6420 3d20 7661 6c75 650a 2020  abled = value.  
+0003bf80: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0003bf90: 7475 726e 0a20 2020 2020 2020 2020 2020  turn.           
+0003bfa0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0003bfb0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0003bfc0: 7565 4572 726f 7228 6622 556e 6b6e 6f77  ueError(f"Unknow
+0003bfd0: 6e20 6265 616d 2074 7970 653a 207b 6265  n beam type: {be
+0003bfe0: 616d 5f74 7970 657d 2066 6f72 207b 6b65  am_type} for {ke
+0003bff0: 797d 2229 0a20 2020 2020 2020 2020 2020  y}").           
+0003c000: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+0003c010: 2069 6620 6b65 7920 3d3d 2022 6575 6365   if key == "euce
+0003c020: 6e74 7269 635f 6865 6967 6874 223a 0a20  ntric_height":. 
+0003c030: 2020 2020 2020 2020 2020 2069 6620 6265             if be
+0003c040: 616d 5f74 7970 6520 6973 2042 6561 6d54  am_type is BeamT
+0003c050: 7970 652e 454c 4543 5452 4f4e 3a0a 2020  ype.ELECTRON:.  
+0003c060: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0003c070: 6c66 2e73 7973 7465 6d2e 656c 6563 7472  lf.system.electr
+0003c080: 6f6e 2e65 7563 656e 7472 6963 5f68 6569  on.eucentric_hei
+0003c090: 6768 7420 3d20 7661 6c75 650a 2020 2020  ght = value.    
+0003c0a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003c0b0: 726e 0a20 2020 2020 2020 2020 2020 2065  rn.            e
+0003c0c0: 6c69 6620 6265 616d 5f74 7970 6520 6973  lif beam_type is
+0003c0d0: 2042 6561 6d54 7970 652e 494f 4e3a 0a20   BeamType.ION:. 
+0003c0e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003c0f0: 656c 662e 7379 7374 656d 2e69 6f6e 2e65  elf.system.ion.e
+0003c100: 7563 656e 7472 6963 5f68 6569 6768 7420  ucentric_height 
+0003c110: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
+0003c120: 2020 2020 2020 2020 7265 7475 726e 200a          return .
+0003c130: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0003c140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003c150: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0003c160: 6f72 2866 2255 6e6b 6e6f 776e 2062 6561  or(f"Unknown bea
+0003c170: 6d20 7479 7065 3a20 7b62 6561 6d5f 7479  m type: {beam_ty
+0003c180: 7065 7d20 666f 7220 7b6b 6579 7d22 290a  pe} for {key}").
+0003c190: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+0003c1a0: 3d3d 2263 6f6c 756d 6e5f 7469 6c74 223a  =="column_tilt":
+0003c1b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003c1c0: 6265 616d 5f74 7970 6520 6973 2042 6561  beam_type is Bea
+0003c1d0: 6d54 7970 652e 454c 4543 5452 4f4e 3a0a  mType.ELECTRON:.
+0003c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c1f0: 7365 6c66 2e73 7973 7465 6d2e 656c 6563  self.system.elec
+0003c200: 7472 6f6e 2e63 6f6c 756d 6e5f 7469 6c74  tron.column_tilt
+0003c210: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+0003c220: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0003c230: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0003c240: 2062 6561 6d5f 7479 7065 2069 7320 4265   beam_type is Be
+0003c250: 616d 5479 7065 2e49 4f4e 3a0a 2020 2020  amType.ION:.    
+0003c260: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003c270: 2e73 7973 7465 6d2e 696f 6e2e 636f 6c75  .system.ion.colu
+0003c280: 6d6e 5f74 696c 7420 3d20 7661 6c75 650a  mn_tilt = value.
+0003c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c2a0: 7265 7475 726e 200a 2020 2020 2020 2020  return .        
+0003c2b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0003c2c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0003c2d0: 5661 6c75 6545 7272 6f72 2866 2255 6e6b  ValueError(f"Unk
+0003c2e0: 6e6f 776e 2062 6561 6d20 7479 7065 3a20  nown beam type: 
+0003c2f0: 7b62 6561 6d5f 7479 7065 7d20 666f 7220  {beam_type} for 
+0003c300: 7b6b 6579 7d22 290a 0a20 2020 2020 2020  {key}")..       
+0003c310: 2023 2069 6f6e 2062 6561 6d20 7072 6f70   # ion beam prop
+0003c320: 6572 7469 6573 0a20 2020 2020 2020 2069  erties.        i
+0003c330: 6620 6b65 7920 3d3d 2022 706c 6173 6d61  f key == "plasma
+0003c340: 223a 0a20 2020 2020 2020 2020 2020 2069  ":.            i
+0003c350: 6620 6265 616d 5f74 7970 6520 6973 2042  f beam_type is B
+0003c360: 6561 6d54 7970 652e 494f 4e3a 0a20 2020  eamType.ION:.   
+0003c370: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0003c380: 662e 7379 7374 656d 2e69 6f6e 2e70 6c61  f.system.ion.pla
+0003c390: 736d 6120 3d20 7661 6c75 650a 2020 2020  sma = value.    
+0003c3a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003c3b0: 726e 0a0a 2020 2020 2020 2020 6966 2062  rn..        if b
+0003c3c0: 6561 6d5f 7479 7065 2069 7320 4265 616d  eam_type is Beam
+0003c3d0: 5479 7065 2e49 4f4e 3a0a 2020 2020 2020  Type.ION:.      
+0003c3e0: 2020 2020 2020 6966 206b 6579 203d 3d20        if key == 
+0003c3f0: 2270 6c61 736d 615f 6761 7322 3a0a 2020  "plasma_gas":.  
+0003c400: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003c410: 206e 6f74 2073 656c 662e 7379 7374 656d   not self.system
+0003c420: 2e69 6f6e 2e70 6c61 736d 613a 0a20 2020  .ion.plasma:.   
+0003c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c440: 206c 6f67 6769 6e67 2e64 6562 7567 2866   logging.debug(f
+0003c450: 2250 6c61 736d 6120 6761 7320 6361 6e6e  "Plasma gas cann
+0003c460: 6f74 2062 6520 7365 7420 6f6e 2074 6869  ot be set on thi
+0003c470: 7320 6d69 6372 6f73 636f 7065 2e22 290a  s microscope.").
+0003c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c490: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+0003c4a0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0003c4b0: 7420 7365 6c66 2e63 6865 636b 5f61 7661  t self.check_ava
+0003c4c0: 696c 6162 6c65 5f76 616c 7565 7328 2270  ilable_values("p
+0003c4d0: 6c61 736d 615f 6761 7322 2c20 7661 6c75  lasma_gas", valu
+0003c4e0: 652c 2062 6561 6d5f 7479 7065 293a 0a20  e, beam_type):. 
+0003c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c500: 2020 206c 6f67 6769 6e67 2e77 6172 6e69     logging.warni
+0003c510: 6e67 2866 2250 6c61 736d 6120 6761 7320  ng(f"Plasma gas 
+0003c520: 7b76 616c 7565 7d20 6e6f 7420 6176 6169  {value} not avai
+0003c530: 6c61 626c 652e 2041 7661 696c 6162 6c65  lable. Available
+0003c540: 2076 616c 7565 733a 207b 7365 6c66 2e67   values: {self.g
+0003c550: 6574 5f61 7661 696c 6162 6c65 5f76 616c  et_available_val
+0003c560: 7565 7328 2770 6c61 736d 615f 6761 7327  ues('plasma_gas'
+0003c570: 2c20 6265 616d 5f74 7970 6529 7d22 290a  , beam_type)}").
+0003c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c590: 2020 2020 7265 7475 726e 200a 2020 2020      return .    
+0003c5a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0003c5b0: 696e 672e 696e 666f 2866 2253 6574 7469  ing.info(f"Setti
+0003c5c0: 6e67 2070 6c61 736d 6120 6761 7320 746f  ng plasma gas to
+0003c5d0: 207b 7661 6c75 657d 2e2e 2e20 7468 6973   {value}... this
+0003c5e0: 206d 6179 2074 616b 6520 736f 6d65 2074   may take some t
+0003c5f0: 696d 652e 2e2e 2229 0a20 2020 2020 2020  ime...").       
+0003c600: 2020 2020 2020 2020 2073 656c 662e 7379           self.sy
+0003c610: 7374 656d 2e69 6f6e 2e70 6c61 736d 615f  stem.ion.plasma_
+0003c620: 6761 7320 3d20 7661 6c75 650a 2020 2020  gas = value.    
+0003c630: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0003c640: 696e 672e 696e 666f 2866 2250 6c61 736d  ing.info(f"Plasm
+0003c650: 6120 6761 7320 7365 7420 746f 207b 7661  a gas set to {va
+0003c660: 6c75 657d 2e22 290a 0a20 2020 2020 2020  lue}.")..       
+0003c670: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0003c680: 0a20 2020 2020 2020 2023 2073 7461 6765  .        # stage
+0003c690: 2070 726f 7065 7274 6965 730a 2020 2020   properties.    
+0003c6a0: 2020 2020 6966 206b 6579 203d 3d20 2273      if key == "s
+0003c6b0: 7461 6765 5f68 6f6d 6522 3a0a 2020 2020  tage_home":.    
+0003c6c0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0003c6d0: 696e 666f 2866 2248 6f6d 696e 6720 7374  info(f"Homing st
+0003c6e0: 6167 652e 2e2e 2229 0a20 2020 2020 2020  age...").       
+0003c6f0: 2020 2020 2073 656c 662e 7374 6167 655f       self.stage_
+0003c700: 7379 7374 656d 2e69 735f 686f 6d65 6420  system.is_homed 
+0003c710: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+0003c720: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0003c730: 6622 5374 6167 6520 686f 6d65 642e 2229  f"Stage homed.")
+0003c740: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003c750: 7572 6e0a 2020 2020 2020 2020 0a20 2020  urn.        .   
+0003c760: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0003c770: 7374 6167 655f 6c69 6e6b 223a 0a20 2020  stage_link":.   
+0003c780: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0003c790: 2e73 7461 6765 5f69 735f 636f 6d70 7573  .stage_is_compus
+0003c7a0: 7461 6765 3a0a 2020 2020 2020 2020 2020  tage:.          
+0003c7b0: 2020 2020 2020 6c6f 6767 696e 672e 6465        logging.de
+0003c7c0: 6275 6728 6622 436f 6d70 7573 7461 6765  bug(f"Compustage
+0003c7d0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+0003c7e0: 7420 6c69 6e6b 696e 672e 2229 0a20 2020  t linking.").   
+0003c7f0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0003c800: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
+0003c810: 6c6f 6767 696e 672e 696e 666f 2866 224c  logging.info(f"L
+0003c820: 696e 6b69 6e67 2073 7461 6765 2e2e 2e22  inking stage..."
+0003c830: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0003c840: 6c66 2e73 7461 6765 5f73 7973 7465 6d2e  lf.stage_system.
+0003c850: 6973 5f6c 696e 6b65 6420 3d20 5472 7565  is_linked = True
+0003c860: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0003c870: 6769 6e67 2e69 6e66 6f28 6622 5374 6167  ging.info(f"Stag
+0003c880: 6520 6c69 6e6b 6564 2e22 290a 2020 2020  e linked.").    
+0003c890: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+0003c8a0: 2020 2020 2020 2020 2320 6368 616d 6265          # chambe
+0003c8b0: 7220 7072 6f70 6572 7469 6573 0a20 2020  r properties.   
+0003c8c0: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0003c8d0: 7075 6d70 5f63 6861 6d62 6572 223a 0a20  pump_chamber":. 
+0003c8e0: 2020 2020 2020 2020 2020 2069 6620 7661             if va
+0003c8f0: 6c75 653a 0a20 2020 2020 2020 2020 2020  lue:.           
+0003c900: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0003c910: 6f28 6622 5075 6d70 696e 6720 6368 616d  o(f"Pumping cham
+0003c920: 6265 722e 2e2e 2229 0a20 2020 2020 2020  ber...").       
+0003c930: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
+0003c940: 616d 6265 722e 7374 6174 6520 3d20 2250  amber.state = "P
+0003c950: 756d 7065 6422 0a20 2020 2020 2020 2020  umped".         
+0003c960: 2020 2020 2020 2073 656c 662e 6368 616d         self.cham
+0003c970: 6265 722e 7072 6573 7375 7265 203d 2031  ber.pressure = 1
+0003c980: 652d 3620 2320 3120 7554 6f72 720a 2020  e-6 # 1 uTorr.  
+0003c990: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0003c9a0: 6767 696e 672e 696e 666f 2866 2243 6861  gging.info(f"Cha
+0003c9b0: 6d62 6572 2070 756d 7065 642e 2229 0a20  mber pumped."). 
+0003c9c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0003c9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003c9e0: 206c 6f67 6769 6e67 2e69 6e66 6f28 6622   logging.info(f"
+0003c9f0: 496e 7661 6c69 6420 7661 6c75 6520 666f  Invalid value fo
+0003ca00: 7220 7075 6d70 5f63 6861 6d62 6572 3a20  r pump_chamber: 
+0003ca10: 7b76 616c 7565 7d22 290a 2020 2020 2020  {value}").      
+0003ca20: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+0003ca30: 2020 2020 2069 6620 6b65 7920 3d3d 2022       if key == "
+0003ca40: 7665 6e74 5f63 6861 6d62 6572 223a 0a20  vent_chamber":. 
+0003ca50: 2020 2020 2020 2020 2020 2069 6620 7661             if va
+0003ca60: 6c75 653a 0a20 2020 2020 2020 2020 2020  lue:.           
+0003ca70: 2020 2020 206c 6f67 6769 6e67 2e69 6e66       logging.inf
+0003ca80: 6f28 6622 5665 6e74 696e 6720 6368 616d  o(f"Venting cham
+0003ca90: 6265 722e 2e2e 2229 0a20 2020 2020 2020  ber...").       
+0003caa0: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
+0003cab0: 616d 6265 722e 7374 6174 6520 3d20 2256  amber.state = "V
+0003cac0: 656e 7465 6422 0a20 2020 2020 2020 2020  ented".         
+0003cad0: 2020 2020 2020 2073 656c 662e 6368 616d         self.cham
+0003cae0: 6265 722e 7072 6573 7375 7265 203d 2031  ber.pressure = 1
+0003caf0: 6535 0a20 2020 2020 2020 2020 2020 2020  e5.             
+0003cb00: 2020 206c 6f67 6769 6e67 2e69 6e66 6f28     logging.info(
+0003cb10: 6622 4368 616d 6265 7220 7665 6e74 6564  f"Chamber vented
+0003cb20: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+0003cb30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003cb40: 2020 2020 2020 6c6f 6767 696e 672e 696e        logging.in
+0003cb50: 666f 2866 2249 6e76 616c 6964 2076 616c  fo(f"Invalid val
+0003cb60: 7565 2066 6f72 2076 656e 745f 6368 616d  ue for vent_cham
+0003cb70: 6265 723a 207b 7661 6c75 657d 2229 0a20  ber: {value}"). 
+0003cb80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003cb90: 6e0a 0a0a 2020 2020 2020 2020 6c6f 6767  n...        logg
+0003cba0: 696e 672e 7761 726e 696e 6728 6622 556e  ing.warning(f"Un
+0003cbb0: 6b6e 6f77 6e20 6b65 793a 207b 6b65 797d  known key: {key}
+0003cbc0: 2028 7b62 6561 6d5f 7479 7065 7d29 2229   ({beam_type})")
+0003cbd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0003cbe0: 4e6f 6e65 0a0a 2020 2020 6465 6620 6368  None..    def ch
+0003cbf0: 6563 6b5f 6176 6169 6c61 626c 655f 7661  eck_available_va
+0003cc00: 6c75 6573 2873 656c 662c 206b 6579 3a20  lues(self, key: 
+0003cc10: 7374 722c 2076 616c 7565 2c20 6265 616d  str, value, beam
+0003cc20: 5f74 7970 653a 2042 6561 6d54 7970 6520  _type: BeamType 
+0003cc30: 3d20 4e6f 6e65 2920 2d3e 2062 6f6f 6c3a  = None) -> bool:
+0003cc40: 0a20 2020 2020 2020 206c 6f67 6769 6e67  .        logging
+0003cc50: 2e69 6e66 6f28 6622 4368 6563 6b69 6e67  .info(f"Checking
+0003cc60: 2069 6620 7b6b 6579 7d3d 7b76 616c 7565   if {key}={value
+0003cc70: 7d20 6973 2061 7661 696c 6162 6c65 2028  } is available (
+0003cc80: 7b62 6561 6d5f 7479 7065 7d29 2229 0a0a  {beam_type})")..
+0003cc90: 2020 2020 2020 2020 6966 206b 6579 203d          if key =
+0003cca0: 3d20 2270 6c61 736d 615f 6761 7322 3a0a  = "plasma_gas":.
+0003ccb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003ccc0: 726e 2076 616c 7565 2069 6e20 7365 6c66  rn value in self
+0003ccd0: 2e67 6574 5f61 7661 696c 6162 6c65 5f76  .get_available_v
+0003cce0: 616c 7565 7328 6b65 792c 2062 6561 6d5f  alues(key, beam_
+0003ccf0: 7479 7065 290a 2020 2020 2020 2020 0a0a  type).        ..
+0003cd00: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+0003cd10: 616c 7365 0a20 2020 200a 2020 2020 6465  alse.    .    de
+0003cd20: 6620 686f 6d65 2873 656c 6629 3a0a 2020  f home(self):.  
+0003cd30: 2020 2020 2020 5f63 6865 636b 5f73 7461        _check_sta
+0003cd40: 6765 2873 656c 662e 7379 7374 656d 290a  ge(self.system).
+0003cd50: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+0003cd60: 696e 666f 2822 486f 6d69 6e67 2053 7461  info("Homing Sta
+0003cd70: 6765 2229 0a20 2020 2020 2020 2073 656c  ge").        sel
+0003cd80: 662e 7374 6167 655f 7379 7374 656d 2e69  f.stage_system.i
+0003cd90: 735f 686f 6d65 6420 3d20 5472 7565 0a20  s_homed = True. 
+0003cda0: 2020 2020 2020 206c 6f67 6769 6e67 2e69         logging.i
+0003cdb0: 6e66 6f28 6622 5374 6167 6520 686f 6d65  nfo(f"Stage home
+0003cdc0: 642e 2229 0a20 2020 2020 2020 2072 6574  d.").        ret
+0003cdd0: 7572 6e0a 0a0a 2323 2323 2323 2323 2323  urn...##########
+0003cde0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0003cdf0: 2323 2323 2323 2323 2323 2323 2323 2048  ############## H
+0003ce00: 656c 7065 7220 6675 6e63 7469 6f6e 7320  elper functions 
+0003ce10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0003ce20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0003ce30: 2323 2323 2323 2323 0a0a 0a0a 6465 6620  ########....def 
+0003ce40: 7072 696e 7450 726f 6772 6573 7342 6172  printProgressBar
+0003ce50: 280a 2020 2020 7661 6c75 652c 2074 6f74  (.    value, tot
+0003ce60: 616c 2c20 7072 6566 6978 3d22 222c 2073  al, prefix="", s
+0003ce70: 7566 6669 783d 2222 2c20 6465 6369 6d61  uffix="", decima
+0003ce80: 6c73 3d30 2c20 6c65 6e67 7468 3d31 3030  ls=0, length=100
+0003ce90: 2c20 6669 6c6c 3d22 e296 8822 0a29 3a0a  , fill="...".):.
+0003cea0: 2020 2020 2222 220a 2020 2020 7465 726d      """.    term
+0003ceb0: 696e 616c 2070 726f 6772 6573 7320 6261  inal progress ba
+0003cec0: 720a 2020 2020 2222 220a 2020 2020 7065  r.    """.    pe
+0003ced0: 7263 656e 7420 3d20 2822 7b30 3a2e 2220  rcent = ("{0:." 
+0003cee0: 2b20 7374 7228 6465 6369 6d61 6c73 2920  + str(decimals) 
+0003cef0: 2b20 2266 7d22 292e 666f 726d 6174 2831  + "f}").format(1
+0003cf00: 3030 202a 2028 7661 6c75 6520 2f20 666c  00 * (value / fl
+0003cf10: 6f61 7428 746f 7461 6c29 2929 0a20 2020  oat(total))).   
+0003cf20: 2066 696c 6c65 645f 6c65 6e67 7468 203d   filled_length =
+0003cf30: 2069 6e74 286c 656e 6774 6820 2a20 7661   int(length * va
+0003cf40: 6c75 6520 2f2f 2074 6f74 616c 290a 2020  lue // total).  
+0003cf50: 2020 6261 7220 3d20 6669 6c6c 202a 2066    bar = fill * f
+0003cf60: 696c 6c65 645f 6c65 6e67 7468 202b 2022  illed_length + "
+0003cf70: 2d22 202a 2028 6c65 6e67 7468 202d 2066  -" * (length - f
+0003cf80: 696c 6c65 645f 6c65 6e67 7468 290a 2020  illed_length).  
+0003cf90: 2020 7072 696e 7428 6622 5c72 7b70 7265    print(f"\r{pre
+0003cfa0: 6669 787d 207c 7b62 6172 7d7c 207b 7065  fix} |{bar}| {pe
+0003cfb0: 7263 656e 747d 2520 7b73 7566 6669 787d  rcent}% {suffix}
+0003cfc0: 222c 2065 6e64 3d22 5c72 2229 0a0a 696d  ", end="\r")..im
+0003cfd0: 706f 7274 2077 6172 6e69 6e67 730a 0a64  port warnings..d
+0003cfe0: 6566 205f 6368 6563 6b5f 6265 616d 2862  ef _check_beam(b
+0003cff0: 6561 6d5f 7479 7065 3a20 4265 616d 5479  eam_type: BeamTy
+0003d000: 7065 2c20 7365 7474 696e 6773 3a20 5379  pe, settings: Sy
+0003d010: 7374 656d 5365 7474 696e 6773 293a 0a20  stemSettings):. 
+0003d020: 2020 2022 2222 0a20 2020 2043 6865 636b     """.    Check
+0003d030: 7320 6966 2062 6561 6d20 6973 2061 7661  s if beam is ava
+0003d040: 696c 6162 6c65 2e0a 2020 2020 2222 220a  ilable..    """.
+0003d050: 2020 2020 6966 2062 6561 6d5f 7479 7065      if beam_type
+0003d060: 203d 3d20 4265 616d 5479 7065 2e45 4c45   == BeamType.ELE
+0003d070: 4354 524f 4e20 616e 6420 7365 7474 696e  CTRON and settin
+0003d080: 6773 2e65 6c65 6374 726f 6e2e 656e 6162  gs.electron.enab
+0003d090: 6c65 6420 3d3d 2046 616c 7365 3a0a 2020  led == False:.  
+0003d0a0: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+0003d0b0: 6172 6e28 2254 6865 206d 6963 726f 7363  arn("The microsc
+0003d0c0: 6f70 6520 646f 6573 206e 6f74 2068 6176  ope does not hav
+0003d0d0: 6520 616e 2065 6c65 6374 726f 6e20 6265  e an electron be
+0003d0e0: 616d 2e22 290a 2020 2020 6966 2062 6561  am.").    if bea
+0003d0f0: 6d5f 7479 7065 203d 3d20 4265 616d 5479  m_type == BeamTy
+0003d100: 7065 2e49 4f4e 2061 6e64 2073 6574 7469  pe.ION and setti
+0003d110: 6e67 732e 696f 6e2e 656e 6162 6c65 6420  ngs.ion.enabled 
+0003d120: 203d 3d20 4661 6c73 653a 0a20 2020 2020   == False:.     
+0003d130: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+0003d140: 2822 5468 6520 6d69 6372 6f73 636f 7065  ("The microscope
+0003d150: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
+0003d160: 6e20 696f 6e20 6265 616d 2e22 290a 0a64  n ion beam.")..d
+0003d170: 6566 205f 6368 6563 6b5f 7374 6167 6528  ef _check_stage(
+0003d180: 7365 7474 696e 6773 2c20 726f 7461 7469  settings, rotati
+0003d190: 6f6e 3a20 626f 6f6c 203d 2046 616c 7365  on: bool = False
+0003d1a0: 2c20 7469 6c74 3a20 626f 6f6c 203d 2046  , tilt: bool = F
+0003d1b0: 616c 7365 293a 0a20 2020 2022 2222 0a20  alse):.    """. 
+0003d1c0: 2020 2043 6865 636b 7320 6966 2074 6865     Checks if the
+0003d1d0: 2073 7461 6765 2069 7320 6675 6c6c 7920   stage is fully 
+0003d1e0: 6d6f 7661 626c 652e 0a20 2020 2022 2222  movable..    """
+0003d1f0: 0a20 2020 2069 6620 7365 7474 696e 6773  .    if settings
+0003d200: 2e73 7461 6765 2e65 6e61 626c 6564 203d  .stage.enabled =
+0003d210: 3d20 4661 6c73 653a 0a20 2020 2020 2020  = False:.       
+0003d220: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
+0003d230: 5468 6520 6d69 6372 6f73 636f 7065 2064  The microscope d
+0003d240: 6f65 7320 6e6f 7420 6861 7665 2061 206d  oes not have a m
+0003d250: 6f76 696e 6720 7374 6167 652e 2229 0a20  oving stage."). 
+0003d260: 2020 2069 6620 7365 7474 696e 6773 2e73     if settings.s
+0003d270: 7461 6765 2e72 6f74 6174 696f 6e20 3d3d  tage.rotation ==
+0003d280: 2046 616c 7365 2061 6e64 2072 6f74 6174   False and rotat
+0003d290: 696f 6e20 3d3d 2054 7275 653a 0a20 2020  ion == True:.   
+0003d2a0: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
+0003d2b0: 726e 2822 5468 6520 6d69 6372 6f73 636f  rn("The microsco
+0003d2c0: 7065 2073 7461 6765 2064 6f65 7320 6e6f  pe stage does no
+0003d2d0: 7420 726f 7461 7465 2e22 290a 2020 2020  t rotate.").    
+0003d2e0: 6966 2073 6574 7469 6e67 732e 7374 6167  if settings.stag
+0003d2f0: 652e 7469 6c74 203d 3d20 4661 6c73 6520  e.tilt == False 
+0003d300: 616e 6420 7469 6c74 203d 3d20 5472 7565  and tilt == True
+0003d310: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
+0003d320: 6773 2e77 6172 6e28 2254 6865 206d 6963  gs.warn("The mic
+0003d330: 726f 7363 6f70 6520 7374 6167 6520 646f  roscope stage do
+0003d340: 6573 206e 6f74 2074 696c 742e 2229 0a0a  es not tilt.")..
+0003d350: 6465 6620 5f63 6865 636b 5f6d 616e 6970  def _check_manip
+0003d360: 756c 6174 6f72 2873 6574 7469 6e67 732c  ulator(settings,
+0003d370: 2072 6f74 6174 696f 6e3a 2062 6f6f 6c20   rotation: bool 
+0003d380: 3d20 4661 6c73 652c 2074 696c 743a 2062  = False, tilt: b
+0003d390: 6f6f 6c20 3d20 4661 6c73 6529 3a0a 2020  ool = False):.  
+0003d3a0: 2020 2222 220a 2020 2020 4368 6563 6b73    """.    Checks
+0003d3b0: 2069 6620 7468 6520 6e65 6564 6c65 2069   if the needle i
+0003d3c0: 7320 6176 6169 6c61 626c 652e 0a20 2020  s available..   
+0003d3d0: 2022 2222 0a20 2020 2069 6620 7365 7474   """.    if sett
+0003d3e0: 696e 6773 2e6d 616e 6970 756c 6174 6f72  ings.manipulator
+0003d3f0: 2e65 6e61 626c 6564 203d 3d20 4661 6c73  .enabled == Fals
+0003d400: 653a 0a20 2020 2020 2020 2077 6172 6e69  e:.        warni
+0003d410: 6e67 732e 7761 726e 2822 5468 6520 6d69  ngs.warn("The mi
+0003d420: 6372 6f73 636f 7065 2064 6f65 7320 6e6f  croscope does no
+0003d430: 7420 6861 7665 2061 206e 6565 646c 652e  t have a needle.
+0003d440: 2229 0a20 2020 2069 6620 7365 7474 696e  ").    if settin
+0003d450: 6773 2e6d 616e 6970 756c 6174 6f72 2e72  gs.manipulator.r
+0003d460: 6f74 6174 696f 6e20 3d3d 2046 616c 7365  otation == False
+0003d470: 2061 6e64 2072 6f74 6174 696f 6e20 3d3d   and rotation ==
+0003d480: 2054 7275 653a 0a20 2020 2020 2020 2077   True:.        w
+0003d490: 6172 6e69 6e67 732e 7761 726e 2822 5468  arnings.warn("Th
+0003d4a0: 6520 6d69 6372 6f73 636f 7065 206e 6565  e microscope nee
+0003d4b0: 646c 6520 646f 6573 206e 6f74 2072 6f74  dle does not rot
+0003d4c0: 6174 652e 2229 0a20 2020 2069 6620 7365  ate.").    if se
+0003d4d0: 7474 696e 6773 2e6d 616e 6970 756c 6174  ttings.manipulat
+0003d4e0: 6f72 2e74 696c 7420 3d3d 2046 616c 7365  or.tilt == False
+0003d4f0: 2061 6e64 2074 696c 7420 3d3d 2054 7275   and tilt == Tru
+0003d500: 653a 0a20 2020 2020 2020 2077 6172 6e69  e:.        warni
+0003d510: 6e67 732e 7761 726e 2822 5468 6520 6d69  ngs.warn("The mi
+0003d520: 6372 6f73 636f 7065 206e 6565 646c 6520  croscope needle 
+0003d530: 646f 6573 206e 6f74 2074 696c 742e 2229  does not tilt.")
+0003d540: 0a0a 6465 6620 5f63 6865 636b 5f73 7075  ..def _check_spu
+0003d550: 7474 6572 2873 6574 7469 6e67 733a 2053  tter(settings: S
+0003d560: 7973 7465 6d53 6574 7469 6e67 7329 3a0a  ystemSettings):.
+0003d570: 2020 2020 2222 220a 2020 2020 4368 6563      """.    Chec
+0003d580: 6b73 2069 6620 7468 6520 7370 7574 7465  ks if the sputte
+0003d590: 7220 6973 2061 7661 696c 6162 6c65 2e0a  r is available..
+0003d5a0: 2020 2020 2222 220a 2020 2020 6966 2073      """.    if s
+0003d5b0: 6574 7469 6e67 732e 6769 732e 656e 6162  ettings.gis.enab
+0003d5c0: 6c65 6420 3d3d 2046 616c 7365 3a0a 2020  led == False:.  
+0003d5d0: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+0003d5e0: 6172 6e28 2254 6865 206d 6963 726f 7363  arn("The microsc
+0003d5f0: 6f70 6520 646f 6573 206e 6f74 2068 6176  ope does not hav
+0003d600: 6520 6120 4749 5320 7379 7374 656d 2e22  e a GIS system."
+0003d610: 290a 2020 2020 6966 2073 6574 7469 6e67  ).    if setting
+0003d620: 732e 6769 732e 6d75 6c74 6963 6865 6d20  s.gis.multichem 
+0003d630: 3d3d 2046 616c 7365 3a0a 2020 2020 2020  == False:.      
+0003d640: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
+0003d650: 2254 6865 206d 6963 726f 7363 6f70 6520  "The microscope 
+0003d660: 646f 6573 206e 6f74 2068 6176 6520 6120  does not have a 
+0003d670: 6d75 6c74 6963 6865 6d20 7379 7374 656d  multichem system
+0003d680: 2e22 290a 2020 2020 0a64 6566 205f 6368  .").    .def _ch
+0003d690: 6563 6b5f 7374 6167 655f 6d6f 7665 6d65  eck_stage_moveme
+0003d6a0: 6e74 2873 6574 7469 6e67 733a 2053 7973  nt(settings: Sys
+0003d6b0: 7465 6d53 6574 7469 6e67 732c 2070 6f73  temSettings, pos
+0003d6c0: 6974 696f 6e3a 2046 6962 7365 6d53 7461  ition: FibsemSta
+0003d6d0: 6765 506f 7369 7469 6f6e 293a 0a20 2020  gePosition):.   
+0003d6e0: 2072 6571 5f72 6f74 6174 696f 6e20 3d20   req_rotation = 
+0003d6f0: 706f 7369 7469 6f6e 2e72 2069 7320 6e6f  position.r is no
+0003d700: 7420 4e6f 6e65 200a 2020 2020 7265 715f  t None .    req_
+0003d710: 7469 6c74 203d 2070 6f73 6974 696f 6e2e  tilt = position.
+0003d720: 7420 6973 206e 6f74 204e 6f6e 650a 2020  t is not None.  
+0003d730: 2020 5f63 6865 636b 5f73 7461 6765 2873    _check_stage(s
+0003d740: 6574 7469 6e67 732c 2072 6f74 6174 696f  ettings, rotatio
+0003d750: 6e3d 7265 715f 726f 7461 7469 6f6e 2c20  n=req_rotation, 
+0003d760: 7469 6c74 3d72 6571 5f74 696c 7429 2020  tilt=req_tilt)  
+0003d770: 2020 0a0a 6465 6620 5f63 6865 636b 5f6d    ..def _check_m
+0003d780: 616e 6970 756c 6174 6f72 5f6d 6f76 656d  anipulator_movem
+0003d790: 656e 7428 7365 7474 696e 6773 3a20 5379  ent(settings: Sy
+0003d7a0: 7374 656d 5365 7474 696e 6773 2c20 706f  stemSettings, po
+0003d7b0: 7369 7469 6f6e 3a20 4669 6273 656d 4d61  sition: FibsemMa
+0003d7c0: 6e69 7075 6c61 746f 7250 6f73 6974 696f  nipulatorPositio
+0003d7d0: 6e29 3a0a 2020 2020 7265 715f 726f 7461  n):.    req_rota
+0003d7e0: 7469 6f6e 203d 2070 6f73 6974 696f 6e2e  tion = position.
+0003d7f0: 7220 6973 206e 6f74 204e 6f6e 650a 2020  r is not None.  
+0003d800: 2020 7265 715f 7469 6c74 203d 2070 6f73    req_tilt = pos
+0003d810: 6974 696f 6e2e 7420 6973 206e 6f74 204e  ition.t is not N
+0003d820: 6f6e 650a 0a20 2020 205f 6368 6563 6b5f  one..    _check_
+0003d830: 6d61 6e69 7075 6c61 746f 7228 7365 7474  manipulator(sett
+0003d840: 696e 6773 2c20 726f 7461 7469 6f6e 3d72  ings, rotation=r
+0003d850: 6571 5f72 6f74 6174 696f 6e2c 2074 696c  eq_rotation, til
+0003d860: 743d 7265 715f 7469 6c74 29              t=req_tilt)
```

### Comparing `fibsem-0.3.3/fibsem/milling.py` & `fibsem-0.3.4/fibsem/milling.py`

 * *Files 1% similar despite different names*

```diff
@@ -149,15 +149,18 @@
     # set up milling
     setup_milling(microscope, stage.milling)
 
     # draw patterns
     for pattern in stage.pattern.patterns:
         draw_pattern(microscope, pattern)
 
-    run_milling(microscope, stage.milling.milling_current, asynch)
+    run_milling(microscope=microscope, 
+        milling_current=stage.milling.milling_current, 
+        milling_voltage=stage.milling.milling_voltage, 
+        asynch=asynch)
 
     # finish milling
     finish_milling(microscope)
 
 
 
 def mill_stages_ui(microscope: FibsemMicroscope, stages: list[FibsemMillingStage], asynch: bool=False, parent_ui = None):
```

### Comparing `fibsem-0.3.3/fibsem/movement.py` & `fibsem-0.3.4/fibsem/movement.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/patterning.py` & `fibsem-0.3.4/fibsem/patterning.py`

 * *Files 3% similar despite different names*

```diff
@@ -17,25 +17,24 @@
 # TODO: define the configuration for each key,
 # e.g. 
 # "width": {"type": "float", "min": 0, "max": 1000, "default": 100, "description": "Width of the rectangle"}
 # "cross_section": {"type": "str", "options": [cs.name for cs in CrossSectionPattern], "default": "Rectangle", "description": "Cross section of the milling pattern"}
 
     
 REQUIRED_KEYS = {
-    "Rectangle": ("width", "height", "depth", "rotation","passes", "cleaning_cross_section","scan_direction", "cross_section"),
+    "Rectangle": ("width", "height", "depth", "rotation","passes", "scan_direction", "cross_section"),
     "Line": ("start_x", "end_x", "start_y", "end_y", "depth"),
-    "Circle": ("radius", "depth","cleaning_cross_section"),
+    "Circle": ("radius", "depth"),
     "Trench": (
         "lamella_width",
         "lamella_height",
         "trench_height",
         "size_ratio",
         "offset",
         "depth",
-        "cleaning_cross_section",
         "cross_section",
     ),
     "Horseshoe": (
         "lamella_width",
         "lamella_height",
         "trench_height",
         "size_ratio",
@@ -52,23 +51,32 @@
         "side_trench_width",
         "top_trench_height",
         "depth",
         "scan_direction",
         "inverted",
         "cross_section", 
     ),
-    "Fiducial": ("height", "width", "depth", "rotation","cleaning_cross_section", "cross_section"),
+    "SerialSection": (
+        "section_thickness",
+        "section_width",
+        "section_depth",
+        "side_width",
+        "side_height",
+        "side_depth",
+        "inverted",
+        "use_side_patterns",
+    ),
+    "Fiducial": ("height", "width", "depth", "rotation", "cross_section"),
     "Undercut": (
         "height",
         "width",
         "depth",
         "trench_width",
         "rhs_height",
         "h_offset",
-        "cleaning_cross_section",
         "cross_section",
     ),
     "MicroExpansion": (
         "height",
         "width",
         "depth",
         "distance",
@@ -79,14 +87,15 @@
     "WaffleNotch": (
         "vheight",
         "vwidth",
         "hheight",
         "hwidth",
         "depth",
         "distance",
+        "inverted",
         "cross_section",
     ),
     "Clover": ("radius", "depth"),
     "TriForce": ("height", "width", "depth"),
     "Trapezoid": ("inner_width", "outer_width", "trench_height", "depth", "distance", "n_rectangles", "overlap"),
 }
 
@@ -270,15 +279,15 @@
         lamella_width = protocol["lamella_width"]
         lamella_height = protocol["lamella_height"]
         trench_height = protocol["trench_height"]
         upper_trench_height = trench_height / max(protocol["size_ratio"], 1.0)
         lower_trench_height = trench_height * min(protocol["size_ratio"], 1.0)
         offset = protocol["offset"]
         depth = protocol["depth"]
-        use_cleaning_cross_section = protocol.get("cleaning_cross_section", True)
+        use_cleaning_cross_section = protocol.get("cleaning_cross_section", False)
         cross_section = CrossSectionPattern[protocol.get("cross_section", "Rectangle")]
 
         centre_upper_y = point.y + (
             lamella_height / 2 + upper_trench_height / 2 + offset
         )
         centre_lower_y = point.y - (lamella_height / 2 + lower_trench_height / 2 + offset)
 
@@ -412,26 +421,26 @@
         left_pattern = FibsemRectangleSettings(
             width=trench_width,
             height=height,
             depth=depth,
             centre_x=point.x - (width / 2) - (trench_width / 2),
             centre_y=point.y,
             cleaning_cross_section=False,
-            scan_direction=scan_direction,
+            scan_direction="LeftToRight",
             cross_section=cross_section
         )
 
         right_pattern = FibsemRectangleSettings(
             width=trench_width,
             height=height,
             depth=depth,
             centre_x=point.x + (width / 2) + (trench_width / 2),
             centre_y=point.y,
             cleaning_cross_section=False,
-            scan_direction=scan_direction,
+            scan_direction="RightToLeft",
             cross_section=cross_section
         )
         y_offset = (height / 2) + (upper_trench_height / 2)
         if inverted:
             y_offset = -y_offset
         upper_pattern = FibsemRectangleSettings(
             width=width + (2 * trench_width),
@@ -445,14 +454,98 @@
         )
         
         self.patterns = [left_pattern,right_pattern, upper_pattern]
         self.protocol = protocol
         self.point = point
         return self.patterns
 
+@dataclass
+class SerialSectionPattern(BasePattern):
+    name: str = "SerialSection"
+    required_keys: tuple[str] = REQUIRED_KEYS["SerialSection"]
+    patterns = None
+    protocol = None
+    point = None
+    # ref: "serial-liftout section" https://www.nature.com/articles/s41592-023-02113-5
+
+    def define(
+        self, protocol: dict, point: Point = Point()
+    ) -> list[FibsemRectangleSettings]:
+        """Calculate the serial liftout sectioning milling patterns"""
+
+        check_keys(protocol, self.required_keys)
+
+        # TODO: make side patterns optional
+
+        section_thickness = protocol["section_thickness"]
+        section_width = protocol["section_width"]
+        section_depth = protocol["section_depth"]
+        side_width = protocol["side_width"]
+        side_height = protocol.get("side_height",  0)
+        side_depth = protocol["side_depth"]
+        inverted = protocol.get("inverted", False)
+        use_side_patterns = protocol.get("use_side_patterns", True)
+
+        # draw a line of section width
+        section_y = section_thickness
+        if inverted:
+            section_y *= -1.0
+            side_height *= -1.0
+
+        # main section pattern
+        section_pattern = FibsemLineSettings(start_x=point.x - section_width / 2, 
+                                             end_x=point.x + section_width / 2, 
+                                             start_y=point.y + section_y, 
+                                             end_y=point.y + section_y, 
+                                             depth=section_depth)
+        
+        self.patterns = [section_pattern]
+
+        if use_side_patterns:
+            # side cleaning patterns
+            left_side_pattern = FibsemLineSettings(
+                start_x=point.x - section_width / 2 - side_width / 2,
+                end_x=point.x - section_width / 2 + side_width / 2,
+                start_y=point.y + section_y,
+                end_y=point.y + section_y,
+                depth=side_depth,
+            )
+            right_side_pattern = FibsemLineSettings(
+                start_x=point.x + section_width / 2 - side_width / 2,
+                end_x=point.x + section_width / 2 + side_width / 2,
+                start_y=point.y + section_y,
+                end_y=point.y + section_y,
+                depth=side_depth,
+            )
+
+            # side vertical patterns
+            left_side_pattern_vertical = FibsemLineSettings(
+                start_x=point.x - section_width / 2,
+                end_x=point.x - section_width / 2,
+                start_y=point.y + section_y,
+                end_y=point.y + section_y + side_height,
+                depth=side_depth,
+            )
+
+            right_side_pattern_vertical = FibsemLineSettings(
+                start_x=point.x + section_width / 2,
+                end_x=point.x + section_width / 2,
+                start_y=point.y + section_y,
+                end_y=point.y + section_y + side_height,
+                depth=side_depth,
+            )
+
+            self.patterns += [left_side_pattern, right_side_pattern, 
+                            left_side_pattern_vertical, 
+                            right_side_pattern_vertical]
+            
+        self.protocol = protocol
+        self.point = point
+
+        return self.patterns
 
 @dataclass
 class FiducialPattern(BasePattern):
     name: str = "Fiducial"
     required_keys: tuple[str] = REQUIRED_KEYS["Fiducial"]
     patterns = None
     protocol = None
@@ -685,14 +778,15 @@
         vwidth = protocol["vwidth"]
         vheight = protocol["vheight"]
         hwidth = protocol["hwidth"]
         hheight = protocol["hheight"]
         depth = protocol["depth"]
         distance = protocol["distance"]
         cross_section = CrossSectionPattern[protocol.get("cross_section", "Rectangle")]
+        inverted = -1  if protocol.get("inverted", False) else 1
 
         # five patterns
         top_vertical_pattern = FibsemRectangleSettings(
             width=vwidth,
             height=vheight,
             depth=depth,
             centre_x=point.x,
@@ -713,37 +807,37 @@
             cross_section=cross_section
         )
 
         top_horizontal_pattern = FibsemRectangleSettings(
             width=hwidth,
             height=hheight,
             depth=depth,
-            centre_x=point.x + hwidth / 2 + vwidth / 2,
+            centre_x=point.x + (hwidth / 2 + vwidth / 2) * inverted,
             centre_y=point.y - distance / 2,
             cleaning_cross_section=False,
             scan_direction="TopToBottom",
             cross_section=cross_section
         )
 
         bottom_horizontal_pattern = FibsemRectangleSettings(
             width=hwidth,
             height=hheight,
             depth=depth,
-            centre_x=point.x + hwidth / 2 + vwidth / 2,
+            centre_x=point.x + (hwidth / 2 + vwidth / 2) * inverted,
             centre_y=point.y + distance / 2,
             cleaning_cross_section=False,
             scan_direction="BottomToTop",
             cross_section=cross_section
         )
 
         centre_vertical_pattern = FibsemRectangleSettings(
             width=vwidth,
             height=distance + hheight,
             depth=depth,
-            centre_x=point.x + hwidth + vwidth,
+            centre_x=point.x + (hwidth + vwidth) * inverted,
             centre_y=point.y,
             cleaning_cross_section=False,
             scan_direction="TopToBottom",
             cross_section=cross_section
         )
 
         self.patterns = [
@@ -909,14 +1003,15 @@
 __PATTERNS__ = [
     RectanglePattern,
     LinePattern,
     CirclePattern,
     TrenchPattern,
     HorseshoePattern,
     HorseshoePatternVertical,
+    SerialSectionPattern,
     UndercutPattern,
     FiducialPattern,
     ArrayPattern,
     MicroExpansionPattern,
     WaffleNotchPattern,
     CloverPattern,
     TriForcePattern,
```

### Comparing `fibsem-0.3.3/fibsem/segmentation/README.md` & `fibsem-0.3.4/fibsem/segmentation/README.md`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/_nnunet.py` & `fibsem-0.3.4/fibsem/segmentation/_nnunet.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/augmentation.ipynb` & `fibsem-0.3.4/fibsem/segmentation/augmentation.ipynb`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/config-autolamella-mega-v4-xl.yml` & `fibsem-0.3.4/fibsem/segmentation/config-autolamella-mega-v4-xl.yml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/config-autolamella-mega-v4.yml` & `fibsem-0.3.4/fibsem/segmentation/config-autolamella-mega-v4.yml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/config-autolamella-mega-v5.yml` & `fibsem-0.3.4/fibsem/segmentation/config-autolamella-mega-v5.yml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/config-autolamella-serial-liftout-v1.yaml` & `fibsem-0.3.4/fibsem/segmentation/config-autolamella-serial-liftout-v1.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/config.py` & `fibsem-0.3.4/fibsem/segmentation/config.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/config.yml` & `fibsem-0.3.4/fibsem/segmentation/config.yml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/dataset.py` & `fibsem-0.3.4/fibsem/segmentation/dataset.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/docs/example_napari.png` & `fibsem-0.3.4/fibsem/segmentation/docs/example_napari.png`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/docs/imgs/combined/combined.jpg` & `fibsem-0.3.4/fibsem/segmentation/docs/imgs/combined/combined.jpg`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/docs/imgs/labelled/label.tif` & `fibsem-0.3.4/fibsem/segmentation/docs/imgs/labelled/label.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/docs/imgs/raw/image.tif` & `fibsem-0.3.4/fibsem/segmentation/docs/imgs/raw/image.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/example.ipynb` & `fibsem-0.3.4/fibsem/segmentation/example.ipynb`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/inference.py` & `fibsem-0.3.4/fibsem/segmentation/inference.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/model.py` & `fibsem-0.3.4/fibsem/segmentation/model.py`

 * *Files 8% similar despite different names*

```diff
@@ -179,14 +179,16 @@
 
 def get_backend(checkpoint: str) -> str:
 
     if "nnunet" in checkpoint:
         return "nnunet"
     elif "onnx" in checkpoint:
         return "onnx"
+    elif "hf" in checkpoint or "transformers" in checkpoint or "segformer" in checkpoint:
+        return "huggingface"
     else:
         return "smp"
 
 def load_model(
     checkpoint: Path, encoder: str = "resnet34", nc: int = 3, _fix_numeric_scaling: bool = True, backend = None
 ) -> SegmentationModel:
     """Load a model checkpoint
@@ -198,14 +200,17 @@
     # load model
     if backend == "nnunet":
         from fibsem.segmentation.nnunet_model import SegmentationModelNNUnet
         model = SegmentationModelNNUnet(checkpoint=checkpoint)
     elif backend == "onnx":
         from fibsem.segmentation.onnx_model import SegmentationModelONNX
         model = SegmentationModelONNX(checkpoint=checkpoint)
+    elif backend == "huggingface":
+        from fibsem.segmentation.hf_segmentation_model import SegmentationModelHuggingFace
+        model = SegmentationModelHuggingFace(checkpoint=checkpoint)
     else:
         model = SegmentationModel(checkpoint=checkpoint, encoder=encoder, num_classes=nc, _fix_numeric_scaling=_fix_numeric_scaling)
 
     return model
 
 
 if __name__ == "__main__":
```

### Comparing `fibsem-0.3.3/fibsem/segmentation/nnunet_model.py` & `fibsem-0.3.4/fibsem/segmentation/nnunet_model.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/onnx_model.py` & `fibsem-0.3.4/fibsem/segmentation/onnx_model.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/sam_model.py` & `fibsem-0.3.4/fibsem/segmentation/sam_model.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/segmentation_config.yaml` & `fibsem-0.3.4/fibsem/segmentation/segmentation_config.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/spacetomo_config.yaml` & `fibsem-0.3.4/fibsem/segmentation/spacetomo_config.yaml`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/test_image.tif` & `fibsem-0.3.4/fibsem/segmentation/test_image.tif`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/train.py` & `fibsem-0.3.4/fibsem/segmentation/train.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/segmentation/utils.py` & `fibsem-0.3.4/fibsem/segmentation/utils.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/structures.py` & `fibsem-0.3.4/fibsem/structures.py`

 * *Files 1% similar despite different names*

```diff
@@ -4,15 +4,15 @@
 import os
 import sys
 from dataclasses import dataclass
 from datetime import datetime
 from enum import Enum, auto
 from pathlib import Path
 from fibsem.config import SUPPORTED_COORDINATE_SYSTEMS
-from typing import Optional
+from typing import Optional, Union
 import numpy as np
 import tifffile as tff
 import fibsem
 from fibsem.config import METADATA_VERSION
 from abc import ABC, abstractmethod, abstractstaticmethod
 
 try:
@@ -30,15 +30,17 @@
     sys.path.append("C:\Program Files\Python36\envs\AutoScript")
     sys.path.append("C:\Program Files\Python36\envs\AutoScript\Lib\site-packages")
     from autoscript_sdb_microscope_client.structures import (
         AdornedImage,
         ManipulatorPosition,
         Rectangle,
         StagePosition,
+        CompustagePosition,
     )
+    from autoscript_sdb_microscope_client.enumerations import CoordinateSystem
 
     THERMO = True
 except:
     THERMO = False
 
 
 
@@ -153,16 +155,16 @@
         r (float): The Rotation of the stage in radians.
         t (float): The Tilt of the stage in radians.
         coordinate_system (str): The coordinate system used for the stage position.
 
     Methods:
         to_dict(): Convert the stage position object to a dictionary.
         from_dict(data: dict): Create a new stage position object from a dictionary.
-        to_autoscript_position(stage_tilt: float = 0.0) -> StagePosition: Convert the stage position to a StagePosition object that is compatible with Autoscript.
-        from_autoscript_position(position: StagePosition, stage_tilt: float = 0.0) -> None: Create a new FibsemStagePosition object from a StagePosition object that is compatible with Autoscript.
+        to_autoscript_position(compustage: bool) -> StagePosition: Convert the stage position to a StagePosition object that is compatible with Autoscript.
+        from_autoscript_position(position: StagePosition) -> None: Create a new FibsemStagePosition object from a StagePosition object that is compatible with Autoscript.
         to_tescan_position(stage_tilt: float = 0.0): Convert the stage position to a format that is compatible with Tescan.
         from_tescan_position(): Create a new FibsemStagePosition object from a Tescan-compatible stage position.
     """
 
     name: str = None
     x: float = None
     y: float = None
@@ -201,32 +203,64 @@
             r=data["r"],
             t=data["t"],
             coordinate_system=data["coordinate_system"],
         )
 
     if THERMO:
 
-        def to_autoscript_position(self, stage_tilt: float = 0.0) -> StagePosition:
-            return StagePosition(
-                x=self.x,
-                y=self.y,  # / np.cos(stage_tilt),
-                z=self.z,  # / np.cos(stage_tilt),
-                r=self.r,
-                t=self.t,
-                coordinate_system=self.coordinate_system,
-            )
+        def to_autoscript_position(self, compustage: bool = False) -> Union[StagePosition, CompustagePosition]:
+            """Converts the stage position to a StagePosition object that is compatible with Autoscript.
+            Args:
+                compustage: bool = False: Whether or not the stage is a compustage.
+            Returns:
+                StagePosition / CompuStagePosition compatible with Autoscript.        
+            """
+
+            # reference: SerialFIB Arctis Driver
+            # https://github.com/sklumpe/SerialFIB/blob/main/src/Arctis/ArctisDriver.py
+            if compustage:
+                stage_position = CompustagePosition(
+                    x=self.x,
+                    y=self.y,
+                    z=self.z,
+                    a=self.t,
+                    coordinate_system=CoordinateSystem.SPECIMEN,
+                )               
+                
+            else:
+                stage_position = StagePosition(
+                    x=self.x,
+                    y=self.y, 
+                    z=self.z,  
+                    r=self.r,
+                    t=self.t,
+                    coordinate_system=CoordinateSystem.RAW,
+                )
+        
+            return stage_position
+
+        @classmethod # TODO: convert this to staticmethod?
+        def from_autoscript_position(cls, position: Union[StagePosition, CompustagePosition]) -> 'FibsemStagePosition':
+            
+            # compustage position
+            if isinstance(position, CompustagePosition):
+                return cls(
+                    x=position.x,
+                    y=position.y,
+                    z=position.z,
+                    r=0.0,
+                    t=position.a,
+                    coordinate_system=CoordinateSystem.SPECIMEN,
+                )
+
 
-        @classmethod
-        def from_autoscript_position(
-            cls, position: StagePosition, stage_tilt: float = 0.0
-        ) -> None:
             return cls(
                 x=position.x,
-                y=position.y,  # * np.cos(stage_tilt),
-                z=position.z,  # * np.cos(stage_tilt),
+                y=position.y,  
+                z=position.z,
                 r=position.r,
                 t=position.t,
                 coordinate_system=position.coordinate_system.upper(),
             )
 
     if TESCAN:
 
@@ -256,14 +290,21 @@
             t=self.t - other.t,
             coordinate_system=self.coordinate_system,
         )
 
     def _scale_repr(self, scale: float, precision: int = 2):
         return f"x:{self.x*scale:.{precision}f}, y:{self.y*scale:.{precision}f}, z:{self.z*scale:.{precision}f}"
 
+    def is_close(self, pos2: 'FibsemStagePosition', tol: float = 1e-6) -> bool:
+        """Check if two positions are close to each other."""
+        return ((abs(self.x - pos2.x) < tol) and 
+                (abs(self.y - pos2.y) < tol) and 
+                (abs(self.z - pos2.z) < tol) and 
+                (abs(self.t - pos2.t) < tol) and 
+                (abs(self.r - pos2.r) < tol))
 
 
 @dataclass
 class FibsemManipulatorPosition:
     """Data class for storing manipulator position data.
 
     Attributes:
@@ -1894,7 +1935,32 @@
 def check_data_format(data: np.ndarray) -> bool:
     """Checks that data is in the correct format."""
     # assert data.ndim == 2  # or data.ndim == 3
     # assert data.dtype in [np.uint8, np.uint16]
     if data.ndim == 3 and data.shape[2] == 1:
         data = data[:, :, 0]
     return data.ndim == 2 and data.dtype in [np.uint8, np.uint16]
+
+@dataclass
+class FibsemGasInjectionSettings:
+    port: str
+    gas: str
+    duration: float
+    insert_position: str = None # multichem only
+
+    @staticmethod
+    def from_dict(d: dict):
+        return FibsemGasInjectionSettings(
+            port=d["port"],
+            gas=d["gas"],
+            duration=d["duration"],
+            insert_position=d.get("insert_position", None),
+        )
+    
+    def to_dict(self):
+        return {
+            "port": self.port,
+            "gas": self.gas,
+            "duration": self.duration,
+            "insert_position": self.insert_position,
+        }
+
```

### Comparing `fibsem-0.3.3/fibsem/tools/_parser.py` & `fibsem-0.3.4/fibsem/tools/_parser.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/tools/run_manipulator_calibration.py` & `fibsem-0.3.4/fibsem/tools/run_manipulator_calibration.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/tools/run_split_dataset.py` & `fibsem-0.3.4/fibsem/tools/run_split_dataset.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/tools/telemetry.py` & `fibsem-0.3.4/fibsem/tools/telemetry.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemAlignmentWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemAlignmentWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemCryoDepositionWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemCryoDepositionWidget.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,21 +1,21 @@
 import logging
 import napari
 import napari.utils.notifications
-import numpy as np
 from PyQt5 import QtWidgets
 from fibsem import config as cfg
 from fibsem import constants, conversions, utils
 from fibsem.microscope import FibsemMicroscope, TescanMicroscope, ThermoMicroscope, DemoMicroscope
-from fibsem.structures import MicroscopeSettings
-from fibsem.ui import FibsemCryoDepositionWidget_qt
+from fibsem.structures import MicroscopeSettings, FibsemGasInjectionSettings
+
+from fibsem.ui.qtdesigner_files import FibsemCryoDepositionWidget
 from fibsem import gis
 
 
-class FibsemCryoDepositionWidget(FibsemCryoDepositionWidget_qt.Ui_Dialog, QtWidgets.QDialog):
+class FibsemCryoDepositionWidget(FibsemCryoDepositionWidget.Ui_Dialog, QtWidgets.QDialog):
     def __init__(
         self,
         microscope: FibsemMicroscope = None,
         settings: MicroscopeSettings = None,
         parent=None,
     ):
         super(FibsemCryoDepositionWidget, self).__init__(parent=parent)
@@ -28,41 +28,51 @@
         self.setup_connections()
 
     def setup_connections(self):
 
         self.pushButton_run_sputter.clicked.connect(self.run_sputter)
 
         positions = utils.load_yaml(cfg.POSITION_PATH)
-        self.comboBox_sputter_stage_position.addItems([p["name"] for p in positions])
+        self.comboBox_stage_position.addItems(["Current Position"] + [p["name"] for p in positions])
+        available_ports = self.microscope.get_available_values("gis_ports")
+        self.comboBox_port.addItems([str(p) for p in available_ports])
+
 
+        # TODO: show / hide based on gis / multichem available
+        multichem_available = self.microscope.is_available("gis_multichem")
+        self.lineEdit_gas.setVisible(multichem_available)
+        self.label_gas.setVisible(multichem_available)
+        self.lineEdit_insert_position.setVisible(multichem_available)
+        self.label_insert_position.setVisible(multichem_available)
+        self.comboBox_port.setVisible(not multichem_available)  # gis only
+        self.label_port.setVisible(not multichem_available)     # gis only
 
     def _get_protocol_from_ui(self):
         
         protocol = {
-            "application_file": self.lineEdit_sputter_application_file.text(),
-            "gas": self.lineEdit_sputter_gas.text(),
-            "position": self.lineEdit_sputter_gis_position.text(),
-            "name": self.comboBox_sputter_stage_position.currentText(),
-            "time": self.doubleSpinBox_sputter_time.value(),
-            "hfw": self.doubleSpinBox_sputter_hfw.value() * constants.MICRO_TO_SI,
-            "beam_current": self.doubleSpinBox_sputter_beam_current.value() * constants.NANO_TO_SI,
-            "length": self.doubleSpinBox_sputter_length.value() * constants.MICRO_TO_SI,
+            "port": self.comboBox_port.currentText(),
+            "gas": self.lineEdit_gas.text(),
+            "insert_position": self.lineEdit_insert_position.text(),
+            "duration": self.doubleSpinBox_duration.value(),
+            "name": self.comboBox_stage_position.currentText(),
 
         }
 
         return protocol
 
-    # TODO: thread this
+    # TODO: thread this, add progress bar, feedback
     def run_sputter(self):
         
-        protocol = self._get_protocol_from_ui()
-
-        gis.cryo_deposition(self.microscope, protocol, name=protocol["name"])
+        gdict = self._get_protocol_from_ui()
+        gis_settings = FibsemGasInjectionSettings.from_dict(gdict)
 
+        if gdict["name"] == "Current Position":
+            gdict["name"] = None
 
+        gis.cryo_deposition_v2(self.microscope, gis_settings, name=gdict["name"])
 
 
 def main():
 
     viewer = napari.Viewer(ndisplay=2)
     microscope, settings = utils.setup_session()
     cryo_sputter_widget = FibsemCryoDepositionWidget(microscope, settings)
```

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemCryoDepositionWidget_qt.py` & `fibsem-0.3.4/fibsem/ui/FibsemCryoDepositionWidget_qt.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemDetectionUI.py` & `fibsem-0.3.4/fibsem/ui/FibsemDetectionUI.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemDetectionWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemDetectionWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemEmbeddedDetectionWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemEmbeddedDetectionWidget.py`

 * *Files 0% similar despite different names*

```diff
@@ -182,15 +182,15 @@
         self._image_layer = self.viewer.add_image(
             self.det.image, name="image", opacity=0.7, blending="additive",
         )
 
         # add mask to viewer
         self._mask_layer = self.viewer.add_labels(self.det.mask, 
                                                     name="mask", 
-                                                    opacity=0.7,
+                                                    opacity=0.3,
                                                     blending="additive", 
                                                     color=CLASS_COLORS)
 
         # add points to viewer
         data = []
         for feature in self.det.features:
             x, y = feature.px
```

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemFeatureLabellingUI.py` & `fibsem-0.3.4/fibsem/ui/FibsemFeatureLabellingUI.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemGISWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemGISWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemImageSettingsWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemImageSettingsWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemImageViewer.py` & `fibsem-0.3.4/fibsem/ui/FibsemImageViewer.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemLabellingUI.py` & `fibsem-0.3.4/fibsem/ui/FibsemLabellingUI.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,17 +1,17 @@
 import logging
 import os
 import sys
 import glob
 
+import yaml
 import fibsem
 import napari
 import napari.utils.notifications
 import numpy as np
-import tifffile as tff
 from PIL import Image
 from fibsem.ui.qtdesigner_files import FibsemLabellingUI
 from PyQt5 import QtWidgets
 from fibsem.segmentation.config import CLASS_COLORS, CLASS_LABELS, convert_color_names_to_rgb, CLASS_CONFIG_PATH
 from fibsem.segmentation import utils as seg_utils
 
 from fibsem.ui.FibsemSegmentationModelWidget import FibsemSegmentationModelWidget
@@ -211,15 +211,14 @@
             if path is not None and path != "":
                 self.model_widget.lineEdit_checkpoint.setText(path)
         elif self.sender() == self.pushButton_data_config:
             path = _get_file_ui(msg="Select Configuration File", path=CLASS_CONFIG_PATH, _filter="*.yaml")
             if path is not None and path != "":
                 self.lineEdit_data_config.setText(path)
 
-                import yaml
                 with open(path) as f:
                     CLASS_CONFIG = yaml.load(f, Loader=yaml.FullLoader) 
 
                 CONFIGURATION["LABELS"]["COLOR_MAP"] = CLASS_CONFIG["CLASS_COLORS"]
                 CONFIGURATION["LABELS"]["LABEL_MAP"] = CLASS_CONFIG["CLASS_LABELS"]
```

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemManipulatorWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemManipulatorWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemMicroscopeConfigurationWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemMicroscopeConfigurationWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemMicroscopeConfigurationWidgetBase.py` & `fibsem-0.3.4/fibsem/ui/FibsemMicroscopeConfigurationWidgetBase.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemMillingWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemMillingWidget.py`

 * *Files 2% similar despite different names*

```diff
@@ -23,15 +23,15 @@
                             validate_pattern_placement,
                             _get_directory_ui,_get_file_ui, 
                             _calculate_fiducial_area_v2)
 from napari.qt.threading import thread_worker
 from fibsem.ui import _stylesheets
 
 _UNSCALED_VALUES  = ["rotation", "size_ratio", "scan_direction", "cleaning_cross_section", 
-                     "number", "passes", "n_rectangles", "overlap", "inverted",
+                     "number", "passes", "n_rectangles", "overlap", "inverted", "use_side_patterns",
                      "n_columns", "n_rows", "cross_section" ]
 _ANGLE_KEYS = ["rotation"]
 _LINE_KEYS = ["start_x", "start_y", "end_x", "end_y"]
 
 _MILLING_WIDGET_INSTRUCTIONS = """Controls:
 Shift + Left Click to Move Selected Pattern
 Ctrl + Shift + Left Click to Move All Patterns
@@ -83,14 +83,15 @@
 
         self.update_pattern_ui()
 
         self.good_copy_pattern = None
 
         self._UPDATING_PATTERN:bool = False
         self._PATTERN_IS_MOVEABLE: bool = True
+        self._STOP_MILLING: bool = False
 
     def setup_connections(self):
 
         self.image_widget.viewer_update_signal.connect(self.update_ui) # this happens after every time the viewer is updated
 
         # milling
         self.AVAILABLE_MILLING_CURRENTS = self.microscope.get_available_values("current", BeamType.ION)
@@ -116,21 +117,24 @@
         self.comboBox_application_file.addItems(available_application_files)
         self.comboBox_preset.setVisible(_THERMO)
         self.label_preset.setVisible(_THERMO)
         self.doubleSpinBox_milling_current.setVisible(_THERMO)
         self.label_milling_current.setVisible(_THERMO)
         self.label_voltage.setVisible(_THERMO)
         self.spinBox_voltage.setVisible(_THERMO) # TODO: set this to the available voltages
+        self.label_patterning_mode.setVisible(_THERMO)
+        self.comboBox_patterning_mode.setVisible(_THERMO)
         self.comboBox_application_file.currentIndexChanged.connect(self.update_settings)
         self.doubleSpinBox_milling_current.valueChanged.connect(self.update_settings)
         self.doubleSpinBox_hfw.valueChanged.connect(self.update_settings)
         if self.comboBox_application_file.findText(self.protocol["milling"]["application_file"]) == -1:
                 napari.utils.notifications.show_warning("Application file not available, setting to Si instead")
                 self.protocol["milling"]["application_file"] = "Si"
         self.comboBox_application_file.setCurrentText(self.protocol["milling"]["application_file"])
+        self.comboBox_patterning_mode.addItems(["Serial", "Parallel"])
         
         # TESCAN
         self.label_rate.setVisible(_TESCAN)
         self.label_spot_size.setVisible(_TESCAN)
         self.label_dwell_time.setVisible(_TESCAN)
         self.doubleSpinBox_rate.setVisible(_TESCAN)
         self.doubleSpinBox_spot_size.setVisible(_TESCAN)
@@ -174,14 +178,19 @@
         self.pushButton_update_pattern.clicked.connect(lambda: self.update_ui())
         self.pushButton_update_pattern.setStyleSheet(_stylesheets._BLUE_PUSHBUTTON_STYLE)
         self.milling_notification.connect(self.update_milling_ui)
 
         # run milling
         self.pushButton_run_milling.clicked.connect(self.run_milling)
         self.pushButton_run_milling.setStyleSheet(_stylesheets._GREEN_PUSHBUTTON_STYLE)
+        
+        # stop milling
+        self.pushButton_stop_milling.clicked.connect(self.stop_milling)
+        self.pushButton_stop_milling.setStyleSheet(_stylesheets._RED_PUSHBUTTON_STYLE)
+        self.pushButton_stop_milling.setVisible(False)
 
         if self.milling_stages:
             self.comboBox_milling_stage.addItems([stage.name for stage in self.milling_stages])
             self.update_milling_stage_ui()
         self.comboBox_milling_stage.currentIndexChanged.connect(lambda: self.update_milling_stage_ui())
 
         # progress bar
@@ -226,14 +235,16 @@
         napari.utils.notifications.show_info(f"Added {name}.")
         log_status_message(self.milling_stages[-1], "CREATED_STAGE")
 
     def remove_milling_stage(self):
         logging.info("Removing milling stage")
 
         current_index = self.comboBox_milling_stage.currentIndex()
+        if current_index == -1:
+            return
         log_status_message(self.milling_stages[current_index], "REMOVED_STAGE")
         self.milling_stages.pop(current_index)
         self.comboBox_milling_stage.removeItem(current_index)
         napari.utils.notifications.show_info(f"Removed milling stage.")     
 
 
     def _remove_all_stages(self):
@@ -395,18 +406,27 @@
                 continue
 
             if key == "inverted":
                 label = QtWidgets.QLabel(key)
                 self.checkbox_inverted = QtWidgets.QCheckBox()
                 self.gridLayout_patterns.addWidget(label, i, 0)
                 self.gridLayout_patterns.addWidget(self.checkbox_inverted, i, 1)
-                self.checkbox_inverted.setChecked(pattern_protocol[key])
+                self.checkbox_inverted.setChecked(pattern_protocol.get(key, False))
                 self.checkbox_inverted.stateChanged.connect(self.update_ui_pattern)
                 continue
 
+            if key == "use_side_patterns":
+                label = QtWidgets.QLabel(key)
+                self.checkbox_use_side_patterns = QtWidgets.QCheckBox()
+                self.gridLayout_patterns.addWidget(label, i, 0)
+                self.gridLayout_patterns.addWidget(self.checkbox_use_side_patterns, i, 1)
+                self.checkbox_use_side_patterns.setChecked(pattern_protocol.get(key, False))
+                self.checkbox_use_side_patterns.stateChanged.connect(self.update_ui_pattern)
+                continue
+                
             if key == "cross_section":
                 label = QtWidgets.QLabel(key)
                 self.comboBox_cross_section = QtWidgets.QComboBox()
                 self.gridLayout_patterns.addWidget(label, i, 0)
                 self.gridLayout_patterns.addWidget(self.comboBox_cross_section, i, 1)               
                 self.comboBox_cross_section.addItems([section.name for section in CrossSectionPattern])
                 self.comboBox_cross_section.setCurrentText(pattern_protocol.get(key, "Rectangle"))
@@ -458,14 +478,17 @@
                 if isinstance(self.microscope, ThermoMicroscope) and pattern.name == "Circle":
                     continue
                 pattern_dict[key] = self.checkbox_cleaning_cross_section.isChecked()
                 continue
             if key == "inverted":
                 pattern_dict[key] = self.checkbox_inverted.isChecked()
                 continue
+            if key == "use_side_patterns":
+                pattern_dict[key] = self.checkbox_use_side_patterns.isChecked()
+                continue
             if key == "cross_section":
                 pattern_dict[key] = self.comboBox_cross_section.currentText()
                 continue
                 
             spinbox = self.gridLayout_patterns.itemAtPosition(i, 1).widget()
             value = _scale_value(key, spinbox.value(), constants.MICRO_TO_SI)
             # value = value * constants.DEGREES_TO_RADIANS if key in _ANGLE_KEYS else value
@@ -624,14 +647,15 @@
         self.comboBox_application_file.setCurrentText(milling.application_file)
         self.doubleSpinBox_rate.setValue(milling.rate*constants.SI_TO_NANO)
         self.doubleSpinBox_dwell_time.setValue(milling.dwell_time * constants.SI_TO_MICRO)
         self.doubleSpinBox_spot_size.setValue(milling.spot_size * constants.SI_TO_MICRO)
         self.doubleSpinBox_hfw.setValue(milling.hfw * constants.SI_TO_MICRO)
         self.comboBox_preset.setCurrentText(str(milling.preset))
         self.spinBox_voltage.setValue(milling.milling_voltage)
+        self.comboBox_patterning_mode.setCurrentText(milling.patterning_mode)
 
     def get_milling_settings_from_ui(self):
 
         current_amps = float(self.doubleSpinBox_milling_current.value()) * constants.NANO_TO_SI
 
         milling_settings = FibsemMillingSettings(
             milling_current=current_amps,
@@ -639,14 +663,15 @@
             rate=self.doubleSpinBox_rate.value()*1e-9,
             dwell_time = self.doubleSpinBox_dwell_time.value() * constants.MICRO_TO_SI,
             spot_size=self.doubleSpinBox_spot_size.value() * constants.MICRO_TO_SI,
             hfw=self.doubleSpinBox_hfw.value() * constants.MICRO_TO_SI,
             preset= self.comboBox_preset.currentText(),
             spacing=self.doubleSpinBox_spacing.value(),
             milling_voltage=self.spinBox_voltage.value(),
+            patterning_mode=self.comboBox_patterning_mode.currentText()
         )
 
         return milling_settings
 
     def update_ui(self, milling_stages: list[FibsemMillingStage] = None):
         self.doubleSpinBox_hfw.setValue(self.image_widget.doubleSpinBox_image_hfw.value())
 
@@ -709,34 +734,44 @@
         self.pushButton_run_milling.setEnabled(enabled)
         if enabled:
             self.pushButton_run_milling.setStyleSheet(_stylesheets._GREEN_PUSHBUTTON_STYLE)
             self.pushButton_run_milling.setText("Run Milling")
             self.pushButton_update_pattern.setStyleSheet(_stylesheets._BLUE_PUSHBUTTON_STYLE)
             self.pushButton_add_milling_stage.setStyleSheet(_stylesheets._GREEN_PUSHBUTTON_STYLE)
             self.pushButton_remove_milling_stage.setStyleSheet(_stylesheets._RED_PUSHBUTTON_STYLE)
+            self.pushButton_stop_milling.setVisible(False)
         elif milling:
             self.pushButton_run_milling.setStyleSheet(_stylesheets._ORANGE_PUSHBUTTON_STYLE)
             self.pushButton_run_milling.setText("Running...")
+            self.pushButton_stop_milling.setVisible(True)
         else:
             self.pushButton_run_milling.setStyleSheet(_stylesheets._DISABLED_PUSHBUTTON_STYLE)
             self.pushButton_update_pattern.setStyleSheet(_stylesheets._DISABLED_PUSHBUTTON_STYLE)
             self.pushButton_add_milling_stage.setStyleSheet(_stylesheets._DISABLED_PUSHBUTTON_STYLE)
             self.pushButton_remove_milling_stage.setStyleSheet(_stylesheets._DISABLED_PUSHBUTTON_STYLE)
+            self.pushButton_stop_milling.setVisible(False)
+
 
         if caller is None:
             self.parent.image_widget._toggle_interactions(enabled, caller="milling")
             self.parent.movement_widget._toggle_interactions(enabled, caller="milling")
 
 
     def run_milling(self):
         
         worker = self.run_milling_step()
         worker.finished.connect(self.run_milling_finished)
         worker.start()
-        
+    
+    def stop_milling(self):
+        """Request milling stop."""
+        self._STOP_MILLING = True
+        self.microscope.stop_milling()
+        self._quit_progress_bar()
+        self.finish_progress_bar()
     
     def start_progress_thread(self,info):
 
         est_time = info['estimated_time']  # TODO: add some extra time to this to account for changing currents etc
         idx = info['idx']
         total = info['total']
 
@@ -776,18 +811,20 @@
 
     def update_progress_bar(self, info):
         
         value = info['progress_percent']
         idx = info['idx']
         total = info['total']
         est_time = info['est_time']
+        t_m = int(est_time // 60)
+        t_s = int(est_time % 60)
 
         self.progressBar_milling.setVisible(True)
         self.progressBar_milling.setValue(value*100)
-        self.progressBar_milling.setFormat(f"Milling Stage {idx+1}/{total}: {est_time:.1f}s remaining...")
+        self.progressBar_milling.setFormat(f"Milling Stage {idx+1}/{total}: {t_m:02d}:{t_s:02d} remaining...")
 
     def finish_progress_bar(self):
         self.progressBar_milling.setVisible(False)
         self.progressBar_milling.setValue(0)
 
     def _quit_progress_bar(self):
         self.progress_bar_worker.quit()
@@ -804,21 +841,28 @@
             milling.mill_stages_ui(microscope=self.microscope, 
                                 stages=milling_stages, 
                                 parent_ui=self)
             return
             
         for idx,stage in enumerate(milling_stages):
             self.milling_notification.emit(f"Preparing: {stage.name}")
+
+            if self._STOP_MILLING:
+                return
+                
             if stage.pattern is not None:
                 log_status_message(stage, f"RUNNING_MILLING_STAGE_{stage.name}") # TODO: refactor to json
                 log_status_message(stage, f"MILLING_PATTERN_{stage.pattern.name}: {stage.pattern.patterns}")
                 log_status_message(stage, f"MILLING_SETTINGS_{stage.milling}")
                 try:
                     milling.setup_milling(self.microscope, mill_settings=stage.milling)
-
+                    
+                    if self._STOP_MILLING:
+                        return
+                    
                     microscope_patterns = milling.draw_patterns(self.microscope, stage.pattern.patterns)
                     estimated_time = milling.estimate_milling_time(self.microscope, microscope_patterns)
                     progress_bar_dict = {"estimated_time": estimated_time, "idx": idx, "total": len(milling_stages)}
                     self._progress_bar_start.emit(progress_bar_dict)
 
                     self.milling_notification.emit(f"Running {stage.name}...")
                     milling.run_milling(self.microscope, stage.milling.milling_current, stage.milling.milling_voltage)
@@ -850,14 +894,15 @@
         # take new images and update ui
         self._toggle_interactions(enabled=True)
         self.image_widget.take_reference_images()
         self.update_ui()
         self._milling_finished.emit()
         self._quit_progress_bar()
         self.finish_progress_bar()
+        self._STOP_MILLING = False
 
 
 
 
 def main():
     millings_stages = [
     FibsemMillingStage(
```

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemMinimapWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemMinimapWidget.py`

 * *Files 12% similar despite different names*

```diff
@@ -52,14 +52,15 @@
         self.image = None
         self._image_layer = None
         self._reprojection_layer = None
         self._corr_image_layers = []
 
         self.positions = []
         self._correlation = {}
+        self._correlation_mode: bool = False
 
         self._tile_info = {}
 
         self.setup_connections()
 
         self._update_ui()
 
@@ -77,26 +78,28 @@
         self.pushButton_update_position.clicked.connect(self._update_position_pressed)
         self.pushButton_update_position.setStyleSheet(_stylesheets._BLUE_PUSHBUTTON_STYLE)
         self.pushButton_remove_position.clicked.connect(self._remove_position_pressed)
         self.pushButton_remove_position.setStyleSheet(_stylesheets._RED_PUSHBUTTON_STYLE)
 
         self.actionSave_Positions.triggered.connect(self._save_positions_pressed)
         self.actionLoad_Positions.triggered.connect(self._load_positions)
+        self.pushButton_enable_correlation.setStyleSheet(_stylesheets._GREEN_PUSHBUTTON_STYLE)
 
         # checkbox
         self.checkBox_options_move_with_translation.stateChanged.connect(self._update_ui)
         self.checkBox_options_move_with_translation.setVisible(cfg._MINIMAP_MOVE_WITH_TRANSLATION)
         self.label_options_move_with_translate_info.setVisible(cfg._MINIMAP_MOVE_WITH_TRANSLATION)
         self.checkBox_options_acquire_after_movement.setVisible(cfg._MINIMAP_ACQUIRE_AFTER_MOVEMENT)
         self.label_options_header.setVisible(cfg._MINIMAP_ACQUIRE_AFTER_MOVEMENT and cfg._MINIMAP_MOVE_WITH_TRANSLATION)
 
         # signals
         # self._stage_position_added.connect(self._position_added_callback)
         self._update_tile_collection.connect(self._update_tile_collection_callback)
-        self.parent._minimap_signal.connect(self.update_positions_from_parent)
+        if self.parent:
+            self.parent._minimap_signal.connect(self.update_positions_from_parent)
 
 
         # pattern overlay
         milling_protocol = self.settings.protocol.get("milling", {})
         milling_patterns = [k for k in milling_protocol if "stages" in milling_protocol[k] or "type" in milling_protocol[k]]
         self.comboBox_pattern_overlay.addItems(milling_patterns)
         if "trench" in milling_patterns:
@@ -104,16 +107,17 @@
         elif "lamella" in milling_patterns:
             self.comboBox_pattern_overlay.setCurrentText("lamella")
         self.comboBox_pattern_overlay.currentIndexChanged.connect(self._update_pattern_overlay)
         self.checkBox_pattern_overlay.stateChanged.connect(self._update_pattern_overlay)
 
         # correlation
         self.actionLoad_Correlation_Image.triggered.connect(self._load_correlation_image)
-        self.pushButton_update_correlation_image.clicked.connect(lambda: self._update_correlation_image(None))
         self.comboBox_correlation_selected_layer.currentIndexChanged.connect(self._update_correlation_ui)
+        self.pushButton_enable_correlation.clicked.connect(self._toggle_correlation_mode)
+        self.pushButton_enable_correlation.setEnabled(False) # disabled until correlation images added
 
         # auto update correlation image
         self.doubleSpinBox_correlation_translation_x.valueChanged.connect(self._update_correlation_data)
         self.doubleSpinBox_correlation_translation_y.valueChanged.connect(self._update_correlation_data)
         self.doubleSpinBox_correlation_scale_x.valueChanged.connect(self._update_correlation_data) 
         self.doubleSpinBox_correlation_scale_y.valueChanged.connect(self._update_correlation_data)
         self.doubleSpinBox_correlation_rotation.valueChanged.connect(self._update_correlation_data)
@@ -236,23 +240,23 @@
             self.doubleSpinBox_gb_width.setVisible(False)
 
             self.viewer.layers.remove(layer_to_remove)
             self.comboBox_correlation_selected_layer.currentIndexChanged.disconnect()
             self.comboBox_correlation_selected_layer.clear()
             self.comboBox_correlation_selected_layer.addItems([layer.name for layer in self.viewer.layers if "correlation-image" in layer.name ])
             self.comboBox_correlation_selected_layer.currentIndexChanged.connect(self._update_correlation_ui)
+            # if no correlation layers left, disable enable correlation
+            if len(self.comboBox_correlation_selected_layer) == 0:
+                self.pushButton_enable_correlation.setEnabled(False)
 
 
     def _update_gridbar(self):
 
         pixel_size = self.image.metadata.pixel_size.x
 
-        print(f'pixel size: {pixel_size}')
-
-
         BAR_THICKNESS_PX = int(self.doubleSpinBox_gb_width.value() * constants.MICRO_TO_SI / pixel_size)
         BAR_SPACING_PX = int(self.doubleSpinBox_gb_spacing.value() * constants.MICRO_TO_SI / pixel_size)
 
         gridbar_layer = ''
 
         for layer in self.viewer.layers:
             if "gridbar" in layer.name:
@@ -451,18 +455,19 @@
         
         if event.button !=1:
             return
         coords, point = self._validate_mouse_click(layer, event)
 
         if point is False: # clicked outside image
             return
-
+        
+        beam_type = self.image.metadata.image_settings.beam_type
         _new_position = self.microscope.project_stable_move( 
             dx=point.x, dy=point.y, 
-            beam_type=self.image.metadata.image_settings.beam_type, 
+            beam_type=beam_type, 
             base_position=self.image.metadata.microscope_state.stage_position)   
 
 
         _MOVE_WITH_TRANSLATION = self.checkBox_options_move_with_translation.isChecked()
         if _MOVE_WITH_TRANSLATION:
             dx = self.doubleSpinBox_translation_x.value() * constants.MILLI_TO_SI
             dy = self.doubleSpinBox_translation_y.value() * constants.MILLI_TO_SI
@@ -706,20 +711,22 @@
             self.comboBox_correlation_selected_layer.clear()
             self.comboBox_correlation_selected_layer.addItems([layer.name for layer in self.viewer.layers if "correlation-image" in layer.name or "gridbar-image" in layer.name])
             if idx != -1:
                 self.comboBox_correlation_selected_layer.setCurrentIndex(idx)
             self.comboBox_correlation_selected_layer.currentIndexChanged.connect(self._update_correlation_ui)
             
             self.viewer.layers.selection.active = self._image_layer
-    
+            self.pushButton_enable_correlation.setEnabled(True)
+
     # do this when image selected is changed
     def _update_correlation_ui(self):
 
         # set ui
         layer_name = self.comboBox_correlation_selected_layer.currentText()
+        self.pushButton_enable_correlation.setEnabled(layer_name != "")
         if layer_name == "":
             napari.utils.notifications.show_info(f"Please select a layer to correlate with  update data...")
             return
 
         tx, ty, sx, sy, r = self._correlation[layer_name]
 
         self.doubleSpinBox_correlation_translation_x.setValue(tx)
@@ -769,14 +776,46 @@
         self._correlation[layer_name] = deepcopy([tx, ty, sx, sy, r])
 
         # apply to selected layer
         self.viewer.layers[layer_name].translate = [corrected_ty, corrected_tx]
         self.viewer.layers[layer_name].scale = [sy, sx]
         self.viewer.layers[layer_name].rotate = r
 
+    def _toggle_correlation_mode(self):
+        
+        # toggle correlation mode
+        self._correlation_mode = not self._correlation_mode
+
+        if self._correlation_mode:
+            self.pushButton_enable_correlation.setStyleSheet(_stylesheets._ORANGE_PUSHBUTTON_STYLE)
+            self.pushButton_enable_correlation.setText("Disable Correlation Mode")
+            self.comboBox_correlation_selected_layer.setEnabled(False)
+        else:
+            self.pushButton_enable_correlation.setStyleSheet(_stylesheets._GREEN_PUSHBUTTON_STYLE)
+            self.pushButton_enable_correlation.setText("Enable Correlation Mode")
+            self.comboBox_correlation_selected_layer.setEnabled(True)
+
+        # if no correlation layer selected, disable the button
+        if self.comboBox_correlation_selected_layer.currentText() == "":
+            self.pushButton_enable_correlation.setEnabled(False)
+            return
+
+        # get current correlation layer
+        layer_name = self.comboBox_correlation_selected_layer.currentText()
+        correlation_layer = self.viewer.layers[layer_name]
+        
+        # set transformation mode on
+        if self._correlation_mode:
+            correlation_layer.mode = 'transform'
+            self.viewer.layers.selection.active = correlation_layer
+        else:
+            correlation_layer.mode = 'pan_zoom'
+            self.viewer.layers.selection.active = self._image_layer
+
+
 # TODO: update layer name, set from file?
 # TODO: set combobox to all images in viewer 
 
 
 
 def main():
```

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemModelTrainingWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemModelTrainingWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemMovementWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemMovementWidget.py`

 * *Files 3% similar despite different names*

```diff
@@ -104,14 +104,32 @@
         self.pushButton_import.clicked.connect(self.import_positions)
         self.pushButton_import.setStyleSheet(_stylesheets._GRAY_PUSHBUTTON_STYLE)
         self.pushButton_update_position.clicked.connect(self.update_saved_position)
         self.pushButton_update_position.setStyleSheet(_stylesheets._ORANGE_PUSHBUTTON_STYLE)
 
         self.movement_notification_signal.connect(self.update_moving_ui)
 
+        # set custom tilt limits for the compustage
+        if self.microscope is not None:
+            if self.microscope.stage_is_compustage:
+                self.doubleSpinBox_movement_stage_tilt.setMinimum(-195.0)
+                self.doubleSpinBox_movement_stage_tilt.setMaximum(15)
+
+                # NOTE: these values are expressed in mm in the UI, hence the conversion
+                # set x, y, z step sizes to be 1 um
+                self.doubleSpinBox_movement_stage_x.setSingleStep(1e-6 * constants.SI_TO_MILLI)
+                self.doubleSpinBox_movement_stage_y.setSingleStep(1e-6 * constants.SI_TO_MILLI)
+                self.doubleSpinBox_movement_stage_z.setSingleStep(1e-6 * constants.SI_TO_MILLI)
+
+                # TODO: get the true limits from the microscope
+                self.doubleSpinBox_movement_stage_x.setMinimum(-999.9e-6 * constants.SI_TO_MILLI)
+                self.doubleSpinBox_movement_stage_x.setMaximum(999.9e-6 * constants.SI_TO_MILLI)
+                self.doubleSpinBox_movement_stage_y.setMinimum(-377.8e-6 * constants.SI_TO_MILLI)
+                self.doubleSpinBox_movement_stage_y.setMaximum(377.8e-6 * constants.SI_TO_MILLI)
+
     def _toggle_interactions(self, enable: bool, caller: str = None):
         
         self.pushButton_move.setEnabled(enable)
         self.pushButton_move_flat_ion.setEnabled(enable)
         self.pushButton_move_flat_electron.setEnabled(enable)
         self.pushButton_go_to.setEnabled(enable)
         if caller is None:
@@ -439,8 +457,8 @@
     viewer.window.add_dock_widget(
         movement_widget, area="right", add_vertical_stretch=False
     )
     napari.run()
 
 
 if __name__ == "__main__":
-    main()
+    main()
```

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemMultiChemWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemMultiChemWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemPositionsWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemPositionsWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemSegmentationModelWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemSegmentationModelWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemSystemSetupWidget.py` & `fibsem-0.3.4/fibsem/ui/FibsemSystemSetupWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/FibsemUI.py` & `fibsem-0.3.4/fibsem/ui/FibsemUI.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/_stylesheets.py` & `fibsem-0.3.4/fibsem/ui/_stylesheets.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/CurrentAlignmentWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemDetectionWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemDetectionWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemEmbeddedDetectionWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemFeatureDetectionUI.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemFeatureDetectionUI.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemGISWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemGISWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemLabellingUI.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemLabellingUI.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemManipulatorWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidgetBase.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMicroscopeConfigurationWidgetBase.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMillingWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMillingWidget.py`

 * *Files 7% similar despite different names*

```diff
@@ -13,200 +13,209 @@
 
 class Ui_Form(object):
     def setupUi(self, Form):
         Form.setObjectName("Form")
         Form.resize(608, 850)
         self.gridLayout = QtWidgets.QGridLayout(Form)
         self.gridLayout.setObjectName("gridLayout")
+        self.label_info = QtWidgets.QLabel(Form)
+        self.label_info.setText("")
+        self.label_info.setWordWrap(True)
+        self.label_info.setObjectName("label_info")
+        self.gridLayout.addWidget(self.label_info, 29, 0, 1, 2)
+        self.line = QtWidgets.QFrame(Form)
+        self.line.setFrameShape(QtWidgets.QFrame.HLine)
+        self.line.setFrameShadow(QtWidgets.QFrame.Sunken)
+        self.line.setObjectName("line")
+        self.gridLayout.addWidget(self.line, 18, 0, 1, 2)
+        self.progressBar_milling = QtWidgets.QProgressBar(Form)
+        self.progressBar_milling.setProperty("value", 24)
+        self.progressBar_milling.setObjectName("progressBar_milling")
+        self.gridLayout.addWidget(self.progressBar_milling, 28, 0, 1, 1)
         self.pushButton_run_milling = QtWidgets.QPushButton(Form)
         self.pushButton_run_milling.setObjectName("pushButton_run_milling")
         self.gridLayout.addWidget(self.pushButton_run_milling, 26, 0, 1, 2)
         self.frame = QtWidgets.QFrame(Form)
         self.frame.setMinimumSize(QtCore.QSize(0, 0))
         self.frame.setObjectName("frame")
         self.gridLayout_4 = QtWidgets.QGridLayout(self.frame)
         self.gridLayout_4.setObjectName("gridLayout_4")
-        self.comboBox_milling_stage = QtWidgets.QComboBox(self.frame)
-        self.comboBox_milling_stage.setObjectName("comboBox_milling_stage")
-        self.gridLayout_4.addWidget(self.comboBox_milling_stage, 2, 1, 1, 1)
-        self.doubleSpinBox_centre_y = QtWidgets.QDoubleSpinBox(self.frame)
-        self.doubleSpinBox_centre_y.setMinimum(-1e+16)
-        self.doubleSpinBox_centre_y.setMaximum(1e+23)
-        self.doubleSpinBox_centre_y.setSingleStep(0.1)
-        self.doubleSpinBox_centre_y.setObjectName("doubleSpinBox_centre_y")
-        self.gridLayout_4.addWidget(self.doubleSpinBox_centre_y, 22, 1, 1, 1)
-        self.pushButton_remove_milling_stage = QtWidgets.QPushButton(self.frame)
-        self.pushButton_remove_milling_stage.setObjectName("pushButton_remove_milling_stage")
-        self.gridLayout_4.addWidget(self.pushButton_remove_milling_stage, 3, 1, 1, 1)
-        self.label_centre_x = QtWidgets.QLabel(self.frame)
-        self.label_centre_x.setObjectName("label_centre_x")
-        self.gridLayout_4.addWidget(self.label_centre_x, 21, 0, 1, 1)
         self.label_hfw = QtWidgets.QLabel(self.frame)
         self.label_hfw.setObjectName("label_hfw")
         self.gridLayout_4.addWidget(self.label_hfw, 8, 0, 1, 1)
-        self.checkBox_relative_move = QtWidgets.QCheckBox(self.frame)
-        self.checkBox_relative_move.setChecked(True)
-        self.checkBox_relative_move.setObjectName("checkBox_relative_move")
-        self.gridLayout_4.addWidget(self.checkBox_relative_move, 27, 1, 1, 1)
-        self.doubleSpinBox_dwell_time = QtWidgets.QDoubleSpinBox(self.frame)
-        self.doubleSpinBox_dwell_time.setDecimals(4)
-        self.doubleSpinBox_dwell_time.setMinimum(0.0)
-        self.doubleSpinBox_dwell_time.setMaximum(4000000.0)
-        self.doubleSpinBox_dwell_time.setSingleStep(0.01)
-        self.doubleSpinBox_dwell_time.setProperty("value", 0.0)
-        self.doubleSpinBox_dwell_time.setObjectName("doubleSpinBox_dwell_time")
-        self.gridLayout_4.addWidget(self.doubleSpinBox_dwell_time, 11, 1, 1, 1)
         self.checkBox_live_update = QtWidgets.QCheckBox(self.frame)
         self.checkBox_live_update.setObjectName("checkBox_live_update")
-        self.gridLayout_4.addWidget(self.checkBox_live_update, 27, 0, 1, 1)
-        self.doubleSpinBox_spot_size = QtWidgets.QDoubleSpinBox(self.frame)
-        self.doubleSpinBox_spot_size.setDecimals(4)
-        self.doubleSpinBox_spot_size.setMinimum(0.0)
-        self.doubleSpinBox_spot_size.setMaximum(100000.0)
-        self.doubleSpinBox_spot_size.setSingleStep(0.01)
-        self.doubleSpinBox_spot_size.setProperty("value", 0.0)
-        self.doubleSpinBox_spot_size.setObjectName("doubleSpinBox_spot_size")
-        self.gridLayout_4.addWidget(self.doubleSpinBox_spot_size, 12, 1, 1, 1)
-        self.doubleSpinBox_rate = QtWidgets.QDoubleSpinBox(self.frame)
-        self.doubleSpinBox_rate.setDecimals(4)
-        self.doubleSpinBox_rate.setMinimum(0.0)
-        self.doubleSpinBox_rate.setMaximum(100000.0)
-        self.doubleSpinBox_rate.setSingleStep(0.01)
-        self.doubleSpinBox_rate.setProperty("value", 0.0)
-        self.doubleSpinBox_rate.setObjectName("doubleSpinBox_rate")
-        self.gridLayout_4.addWidget(self.doubleSpinBox_rate, 10, 1, 1, 1)
-        self.comboBox_patterns = QtWidgets.QComboBox(self.frame)
-        self.comboBox_patterns.setObjectName("comboBox_patterns")
-        self.gridLayout_4.addWidget(self.comboBox_patterns, 19, 1, 1, 1)
-        self.label_centre_y = QtWidgets.QLabel(self.frame)
-        self.label_centre_y.setObjectName("label_centre_y")
-        self.gridLayout_4.addWidget(self.label_centre_y, 22, 0, 1, 1)
-        self.label_voltage = QtWidgets.QLabel(self.frame)
-        self.label_voltage.setObjectName("label_voltage")
-        self.gridLayout_4.addWidget(self.label_voltage, 6, 0, 1, 1)
+        self.gridLayout_4.addWidget(self.checkBox_live_update, 28, 0, 1, 1)
         self.doubleSpinBox_spacing = QtWidgets.QDoubleSpinBox(self.frame)
         self.doubleSpinBox_spacing.setProperty("value", 1.0)
         self.doubleSpinBox_spacing.setObjectName("doubleSpinBox_spacing")
-        self.gridLayout_4.addWidget(self.doubleSpinBox_spacing, 13, 1, 1, 1)
-        self.gridLayout_patterns = QtWidgets.QGridLayout()
-        self.gridLayout_patterns.setObjectName("gridLayout_patterns")
-        self.gridLayout_4.addLayout(self.gridLayout_patterns, 24, 0, 2, 2)
-        self.line_3 = QtWidgets.QFrame(self.frame)
-        self.line_3.setFrameShape(QtWidgets.QFrame.HLine)
-        self.line_3.setFrameShadow(QtWidgets.QFrame.Sunken)
-        self.line_3.setObjectName("line_3")
-        self.gridLayout_4.addWidget(self.line_3, 4, 0, 1, 2)
-        spacerItem = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_4.addItem(spacerItem, 26, 0, 1, 2)
-        self.label_pattern_set = QtWidgets.QLabel(self.frame)
-        self.label_pattern_set.setObjectName("label_pattern_set")
-        self.gridLayout_4.addWidget(self.label_pattern_set, 19, 0, 1, 1)
-        self.comboBox_application_file = QtWidgets.QComboBox(self.frame)
-        self.comboBox_application_file.setObjectName("comboBox_application_file")
-        self.gridLayout_4.addWidget(self.comboBox_application_file, 9, 1, 1, 1)
+        self.gridLayout_4.addWidget(self.doubleSpinBox_spacing, 14, 1, 1, 1)
         self.label_milling_header = QtWidgets.QLabel(self.frame)
         font = QtGui.QFont()
         font.setPointSize(10)
         font.setBold(True)
         font.setWeight(75)
         self.label_milling_header.setFont(font)
         self.label_milling_header.setObjectName("label_milling_header")
         self.gridLayout_4.addWidget(self.label_milling_header, 5, 0, 1, 2)
-        self.label_milling_instructions = QtWidgets.QLabel(self.frame)
-        self.label_milling_instructions.setObjectName("label_milling_instructions")
-        self.gridLayout_4.addWidget(self.label_milling_instructions, 29, 0, 1, 2)
+        self.doubleSpinBox_milling_current = QtWidgets.QDoubleSpinBox(self.frame)
+        self.doubleSpinBox_milling_current.setObjectName("doubleSpinBox_milling_current")
+        self.gridLayout_4.addWidget(self.doubleSpinBox_milling_current, 7, 1, 1, 1)
         self.doubleSpinBox_centre_x = QtWidgets.QDoubleSpinBox(self.frame)
         self.doubleSpinBox_centre_x.setMinimum(-1e+28)
         self.doubleSpinBox_centre_x.setMaximum(1e+18)
         self.doubleSpinBox_centre_x.setSingleStep(0.1)
         self.doubleSpinBox_centre_x.setObjectName("doubleSpinBox_centre_x")
-        self.gridLayout_4.addWidget(self.doubleSpinBox_centre_x, 21, 1, 1, 1)
-        self.label_spot_size = QtWidgets.QLabel(self.frame)
-        self.label_spot_size.setObjectName("label_spot_size")
-        self.gridLayout_4.addWidget(self.label_spot_size, 12, 0, 1, 1)
-        self.spinBox_voltage = QtWidgets.QSpinBox(self.frame)
-        self.spinBox_voltage.setMaximum(1000000)
-        self.spinBox_voltage.setProperty("value", 30000)
-        self.spinBox_voltage.setObjectName("spinBox_voltage")
-        self.gridLayout_4.addWidget(self.spinBox_voltage, 6, 1, 1, 1)
-        self.label_preset = QtWidgets.QLabel(self.frame)
-        self.label_preset.setObjectName("label_preset")
-        self.gridLayout_4.addWidget(self.label_preset, 14, 0, 1, 1)
-        self.label_application_file = QtWidgets.QLabel(self.frame)
-        self.label_application_file.setObjectName("label_application_file")
-        self.gridLayout_4.addWidget(self.label_application_file, 9, 0, 1, 1)
-        self.label_dwell_time = QtWidgets.QLabel(self.frame)
-        self.label_dwell_time.setObjectName("label_dwell_time")
-        self.gridLayout_4.addWidget(self.label_dwell_time, 11, 0, 1, 1)
+        self.gridLayout_4.addWidget(self.doubleSpinBox_centre_x, 22, 1, 1, 1)
         self.label_milling_stage = QtWidgets.QLabel(self.frame)
         self.label_milling_stage.setObjectName("label_milling_stage")
         self.gridLayout_4.addWidget(self.label_milling_stage, 2, 0, 1, 1)
+        self.label_dwell_time = QtWidgets.QLabel(self.frame)
+        self.label_dwell_time.setObjectName("label_dwell_time")
+        self.gridLayout_4.addWidget(self.label_dwell_time, 12, 0, 1, 1)
+        self.label_pattern_set = QtWidgets.QLabel(self.frame)
+        self.label_pattern_set.setObjectName("label_pattern_set")
+        self.gridLayout_4.addWidget(self.label_pattern_set, 20, 0, 1, 1)
+        self.label_patterns_header = QtWidgets.QLabel(self.frame)
+        font = QtGui.QFont()
+        font.setPointSize(10)
+        font.setBold(True)
+        font.setWeight(75)
+        self.label_patterns_header.setFont(font)
+        self.label_patterns_header.setObjectName("label_patterns_header")
+        self.gridLayout_4.addWidget(self.label_patterns_header, 18, 0, 1, 2)
+        self.label_preset = QtWidgets.QLabel(self.frame)
+        self.label_preset.setObjectName("label_preset")
+        self.gridLayout_4.addWidget(self.label_preset, 15, 0, 1, 1)
+        self.doubleSpinBox_rate = QtWidgets.QDoubleSpinBox(self.frame)
+        self.doubleSpinBox_rate.setDecimals(4)
+        self.doubleSpinBox_rate.setMinimum(0.0)
+        self.doubleSpinBox_rate.setMaximum(100000.0)
+        self.doubleSpinBox_rate.setSingleStep(0.01)
+        self.doubleSpinBox_rate.setProperty("value", 0.0)
+        self.doubleSpinBox_rate.setObjectName("doubleSpinBox_rate")
+        self.gridLayout_4.addWidget(self.doubleSpinBox_rate, 11, 1, 1, 1)
+        self.pushButton_add_milling_stage = QtWidgets.QPushButton(self.frame)
+        self.pushButton_add_milling_stage.setObjectName("pushButton_add_milling_stage")
+        self.gridLayout_4.addWidget(self.pushButton_add_milling_stage, 3, 0, 1, 1)
+        self.comboBox_patterns = QtWidgets.QComboBox(self.frame)
+        self.comboBox_patterns.setObjectName("comboBox_patterns")
+        self.gridLayout_4.addWidget(self.comboBox_patterns, 20, 1, 1, 1)
+        self.comboBox_preset = QtWidgets.QComboBox(self.frame)
+        self.comboBox_preset.setObjectName("comboBox_preset")
+        self.gridLayout_4.addWidget(self.comboBox_preset, 15, 1, 1, 1)
+        self.label_milling_instructions = QtWidgets.QLabel(self.frame)
+        self.label_milling_instructions.setObjectName("label_milling_instructions")
+        self.gridLayout_4.addWidget(self.label_milling_instructions, 30, 0, 1, 2)
+        self.checkBox_relative_move = QtWidgets.QCheckBox(self.frame)
+        self.checkBox_relative_move.setChecked(True)
+        self.checkBox_relative_move.setObjectName("checkBox_relative_move")
+        self.gridLayout_4.addWidget(self.checkBox_relative_move, 28, 1, 1, 1)
         self.doubleSpinBox_hfw = QtWidgets.QDoubleSpinBox(self.frame)
         self.doubleSpinBox_hfw.setEnabled(True)
         self.doubleSpinBox_hfw.setReadOnly(True)
         self.doubleSpinBox_hfw.setMinimum(10.0)
         self.doubleSpinBox_hfw.setMaximum(1000000000.0)
         self.doubleSpinBox_hfw.setProperty("value", 150.0)
         self.doubleSpinBox_hfw.setObjectName("doubleSpinBox_hfw")
         self.gridLayout_4.addWidget(self.doubleSpinBox_hfw, 8, 1, 1, 1)
+        self.label_centre_x = QtWidgets.QLabel(self.frame)
+        self.label_centre_x.setObjectName("label_centre_x")
+        self.gridLayout_4.addWidget(self.label_centre_x, 22, 0, 1, 1)
         self.line_2 = QtWidgets.QFrame(self.frame)
         self.line_2.setFrameShape(QtWidgets.QFrame.HLine)
         self.line_2.setFrameShadow(QtWidgets.QFrame.Sunken)
         self.line_2.setObjectName("line_2")
-        self.gridLayout_4.addWidget(self.line_2, 16, 0, 1, 2)
-        self.doubleSpinBox_milling_current = QtWidgets.QDoubleSpinBox(self.frame)
-        self.doubleSpinBox_milling_current.setObjectName("doubleSpinBox_milling_current")
-        self.gridLayout_4.addWidget(self.doubleSpinBox_milling_current, 7, 1, 1, 1)
-        self.comboBox_preset = QtWidgets.QComboBox(self.frame)
-        self.comboBox_preset.setObjectName("comboBox_preset")
-        self.gridLayout_4.addWidget(self.comboBox_preset, 14, 1, 1, 1)
-        self.label_rate = QtWidgets.QLabel(self.frame)
-        self.label_rate.setObjectName("label_rate")
-        self.gridLayout_4.addWidget(self.label_rate, 10, 0, 1, 1)
-        self.pushButton_update_pattern = QtWidgets.QPushButton(self.frame)
-        self.pushButton_update_pattern.setObjectName("pushButton_update_pattern")
-        self.gridLayout_4.addWidget(self.pushButton_update_pattern, 30, 0, 1, 2)
-        self.label_milling_current = QtWidgets.QLabel(self.frame)
-        self.label_milling_current.setObjectName("label_milling_current")
-        self.gridLayout_4.addWidget(self.label_milling_current, 7, 0, 1, 1)
-        self.label_patterns_header = QtWidgets.QLabel(self.frame)
-        font = QtGui.QFont()
-        font.setPointSize(10)
-        font.setBold(True)
-        font.setWeight(75)
-        self.label_patterns_header.setFont(font)
-        self.label_patterns_header.setObjectName("label_patterns_header")
-        self.gridLayout_4.addWidget(self.label_patterns_header, 17, 0, 1, 2)
+        self.gridLayout_4.addWidget(self.line_2, 17, 0, 1, 2)
+        self.doubleSpinBox_centre_y = QtWidgets.QDoubleSpinBox(self.frame)
+        self.doubleSpinBox_centre_y.setMinimum(-1e+16)
+        self.doubleSpinBox_centre_y.setMaximum(1e+23)
+        self.doubleSpinBox_centre_y.setSingleStep(0.1)
+        self.doubleSpinBox_centre_y.setObjectName("doubleSpinBox_centre_y")
+        self.gridLayout_4.addWidget(self.doubleSpinBox_centre_y, 23, 1, 1, 1)
+        self.doubleSpinBox_dwell_time = QtWidgets.QDoubleSpinBox(self.frame)
+        self.doubleSpinBox_dwell_time.setDecimals(4)
+        self.doubleSpinBox_dwell_time.setMinimum(0.0)
+        self.doubleSpinBox_dwell_time.setMaximum(4000000.0)
+        self.doubleSpinBox_dwell_time.setSingleStep(0.01)
+        self.doubleSpinBox_dwell_time.setProperty("value", 0.0)
+        self.doubleSpinBox_dwell_time.setObjectName("doubleSpinBox_dwell_time")
+        self.gridLayout_4.addWidget(self.doubleSpinBox_dwell_time, 12, 1, 1, 1)
         self.label_spacing = QtWidgets.QLabel(self.frame)
         self.label_spacing.setObjectName("label_spacing")
-        self.gridLayout_4.addWidget(self.label_spacing, 13, 0, 1, 1)
-        self.pushButton_add_milling_stage = QtWidgets.QPushButton(self.frame)
-        self.pushButton_add_milling_stage.setObjectName("pushButton_add_milling_stage")
-        self.gridLayout_4.addWidget(self.pushButton_add_milling_stage, 3, 0, 1, 1)
+        self.gridLayout_4.addWidget(self.label_spacing, 14, 0, 1, 1)
+        self.pushButton_remove_milling_stage = QtWidgets.QPushButton(self.frame)
+        self.pushButton_remove_milling_stage.setObjectName("pushButton_remove_milling_stage")
+        self.gridLayout_4.addWidget(self.pushButton_remove_milling_stage, 3, 1, 1, 1)
         self.checkBox_show_milling_crosshair = QtWidgets.QCheckBox(self.frame)
         self.checkBox_show_milling_crosshair.setChecked(True)
         self.checkBox_show_milling_crosshair.setObjectName("checkBox_show_milling_crosshair")
-        self.gridLayout_4.addWidget(self.checkBox_show_milling_crosshair, 28, 1, 1, 1)
+        self.gridLayout_4.addWidget(self.checkBox_show_milling_crosshair, 29, 1, 1, 1)
+        self.label_application_file = QtWidgets.QLabel(self.frame)
+        self.label_application_file.setObjectName("label_application_file")
+        self.gridLayout_4.addWidget(self.label_application_file, 9, 0, 1, 1)
+        self.label_spot_size = QtWidgets.QLabel(self.frame)
+        self.label_spot_size.setObjectName("label_spot_size")
+        self.gridLayout_4.addWidget(self.label_spot_size, 13, 0, 1, 1)
+        self.label_centre_y = QtWidgets.QLabel(self.frame)
+        self.label_centre_y.setObjectName("label_centre_y")
+        self.gridLayout_4.addWidget(self.label_centre_y, 23, 0, 1, 1)
+        self.gridLayout_patterns = QtWidgets.QGridLayout()
+        self.gridLayout_patterns.setObjectName("gridLayout_patterns")
+        self.gridLayout_4.addLayout(self.gridLayout_patterns, 25, 0, 2, 2)
+        self.label_rate = QtWidgets.QLabel(self.frame)
+        self.label_rate.setObjectName("label_rate")
+        self.gridLayout_4.addWidget(self.label_rate, 11, 0, 1, 1)
+        self.label_milling_current = QtWidgets.QLabel(self.frame)
+        self.label_milling_current.setObjectName("label_milling_current")
+        self.gridLayout_4.addWidget(self.label_milling_current, 7, 0, 1, 1)
+        self.spinBox_voltage = QtWidgets.QSpinBox(self.frame)
+        self.spinBox_voltage.setMaximum(1000000)
+        self.spinBox_voltage.setProperty("value", 30000)
+        self.spinBox_voltage.setObjectName("spinBox_voltage")
+        self.gridLayout_4.addWidget(self.spinBox_voltage, 6, 1, 1, 1)
+        self.pushButton_update_pattern = QtWidgets.QPushButton(self.frame)
+        self.pushButton_update_pattern.setObjectName("pushButton_update_pattern")
+        self.gridLayout_4.addWidget(self.pushButton_update_pattern, 31, 0, 1, 2)
+        self.line_3 = QtWidgets.QFrame(self.frame)
+        self.line_3.setFrameShape(QtWidgets.QFrame.HLine)
+        self.line_3.setFrameShadow(QtWidgets.QFrame.Sunken)
+        self.line_3.setObjectName("line_3")
+        self.gridLayout_4.addWidget(self.line_3, 4, 0, 1, 2)
+        self.comboBox_milling_stage = QtWidgets.QComboBox(self.frame)
+        self.comboBox_milling_stage.setObjectName("comboBox_milling_stage")
+        self.gridLayout_4.addWidget(self.comboBox_milling_stage, 2, 1, 1, 1)
+        self.doubleSpinBox_spot_size = QtWidgets.QDoubleSpinBox(self.frame)
+        self.doubleSpinBox_spot_size.setDecimals(4)
+        self.doubleSpinBox_spot_size.setMinimum(0.0)
+        self.doubleSpinBox_spot_size.setMaximum(100000.0)
+        self.doubleSpinBox_spot_size.setSingleStep(0.01)
+        self.doubleSpinBox_spot_size.setProperty("value", 0.0)
+        self.doubleSpinBox_spot_size.setObjectName("doubleSpinBox_spot_size")
+        self.gridLayout_4.addWidget(self.doubleSpinBox_spot_size, 13, 1, 1, 1)
+        self.label_voltage = QtWidgets.QLabel(self.frame)
+        self.label_voltage.setObjectName("label_voltage")
+        self.gridLayout_4.addWidget(self.label_voltage, 6, 0, 1, 1)
+        self.comboBox_application_file = QtWidgets.QComboBox(self.frame)
+        self.comboBox_application_file.setObjectName("comboBox_application_file")
+        self.gridLayout_4.addWidget(self.comboBox_application_file, 9, 1, 1, 1)
+        spacerItem = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_4.addItem(spacerItem, 27, 0, 1, 2)
+        self.label_patterning_mode = QtWidgets.QLabel(self.frame)
+        self.label_patterning_mode.setObjectName("label_patterning_mode")
+        self.gridLayout_4.addWidget(self.label_patterning_mode, 10, 0, 1, 1)
+        self.comboBox_patterning_mode = QtWidgets.QComboBox(self.frame)
+        self.comboBox_patterning_mode.setObjectName("comboBox_patterning_mode")
+        self.gridLayout_4.addWidget(self.comboBox_patterning_mode, 10, 1, 1, 1)
         self.gridLayout.addWidget(self.frame, 16, 0, 1, 2)
         spacerItem1 = QtWidgets.QSpacerItem(20, 40, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout.addItem(spacerItem1, 29, 0, 1, 2)
-        self.label_info = QtWidgets.QLabel(Form)
-        self.label_info.setText("")
-        self.label_info.setWordWrap(True)
-        self.label_info.setObjectName("label_info")
-        self.gridLayout.addWidget(self.label_info, 28, 0, 1, 2)
-        self.line = QtWidgets.QFrame(Form)
-        self.line.setFrameShape(QtWidgets.QFrame.HLine)
-        self.line.setFrameShadow(QtWidgets.QFrame.Sunken)
-        self.line.setObjectName("line")
-        self.gridLayout.addWidget(self.line, 18, 0, 1, 2)
-        self.progressBar_milling = QtWidgets.QProgressBar(Form)
-        self.progressBar_milling.setProperty("value", 24)
-        self.progressBar_milling.setObjectName("progressBar_milling")
-        self.gridLayout.addWidget(self.progressBar_milling, 27, 0, 1, 1)
+        self.gridLayout.addItem(spacerItem1, 30, 0, 1, 2)
+        self.pushButton_stop_milling = QtWidgets.QPushButton(Form)
+        self.pushButton_stop_milling.setObjectName("pushButton_stop_milling")
+        self.gridLayout.addWidget(self.pushButton_stop_milling, 27, 0, 1, 2)
 
         self.retranslateUi(Form)
         QtCore.QMetaObject.connectSlotsByName(Form)
         Form.setTabOrder(self.frame, self.comboBox_milling_stage)
         Form.setTabOrder(self.comboBox_milling_stage, self.pushButton_add_milling_stage)
         Form.setTabOrder(self.pushButton_add_milling_stage, self.pushButton_remove_milling_stage)
         Form.setTabOrder(self.pushButton_remove_milling_stage, self.checkBox_live_update)
@@ -223,29 +232,31 @@
         Form.setTabOrder(self.comboBox_patterns, self.doubleSpinBox_centre_x)
         Form.setTabOrder(self.doubleSpinBox_centre_x, self.doubleSpinBox_centre_y)
 
     def retranslateUi(self, Form):
         _translate = QtCore.QCoreApplication.translate
         Form.setWindowTitle(_translate("Form", "Form"))
         self.pushButton_run_milling.setText(_translate("Form", "Run Milling"))
-        self.pushButton_remove_milling_stage.setText(_translate("Form", "Remove"))
-        self.label_centre_x.setText(_translate("Form", "Centre X (um)"))
         self.label_hfw.setText(_translate("Form", "Horizontal Field Width (um)"))
-        self.checkBox_relative_move.setText(_translate("Form", "Keep Relative Orientation"))
         self.checkBox_live_update.setText(_translate("Form", "Live Update"))
-        self.label_centre_y.setText(_translate("Form", "Centre Y (um)"))
-        self.label_voltage.setText(_translate("Form", "Voltage (V)"))
-        self.label_pattern_set.setText(_translate("Form", "Pattern"))
         self.label_milling_header.setText(_translate("Form", "Milling"))
-        self.label_milling_instructions.setText(_translate("Form", "Controls:"))
-        self.label_spot_size.setText(_translate("Form", "Spot Size (um)"))
-        self.label_preset.setText(_translate("Form", "Preset"))
-        self.label_application_file.setText(_translate("Form", "Application File"))
-        self.label_dwell_time.setText(_translate("Form", "Dwell Time (us)"))
         self.label_milling_stage.setText(_translate("Form", "Milling Stage"))
-        self.label_rate.setText(_translate("Form", "Rate (mm3/A/s)"))
-        self.pushButton_update_pattern.setText(_translate("Form", "Update Pattern"))
-        self.label_milling_current.setText(_translate("Form", "Current (nA)"))
+        self.label_dwell_time.setText(_translate("Form", "Dwell Time (us)"))
+        self.label_pattern_set.setText(_translate("Form", "Pattern"))
         self.label_patterns_header.setText(_translate("Form", "Patterns"))
-        self.label_spacing.setText(_translate("Form", "Spacing"))
+        self.label_preset.setText(_translate("Form", "Preset"))
         self.pushButton_add_milling_stage.setText(_translate("Form", "Add"))
+        self.label_milling_instructions.setText(_translate("Form", "Controls:"))
+        self.checkBox_relative_move.setText(_translate("Form", "Keep Relative Orientation"))
+        self.label_centre_x.setText(_translate("Form", "Centre X (um)"))
+        self.label_spacing.setText(_translate("Form", "Spacing"))
+        self.pushButton_remove_milling_stage.setText(_translate("Form", "Remove"))
         self.checkBox_show_milling_crosshair.setText(_translate("Form", "Show Milling Crosshair"))
+        self.label_application_file.setText(_translate("Form", "Application File"))
+        self.label_spot_size.setText(_translate("Form", "Spot Size (um)"))
+        self.label_centre_y.setText(_translate("Form", "Centre Y (um)"))
+        self.label_rate.setText(_translate("Form", "Rate (mm3/A/s)"))
+        self.label_milling_current.setText(_translate("Form", "Current (nA)"))
+        self.pushButton_update_pattern.setText(_translate("Form", "Update Pattern"))
+        self.label_voltage.setText(_translate("Form", "Voltage (V)"))
+        self.label_patterning_mode.setText(_translate("Form", "Patterning Mode"))
+        self.pushButton_stop_milling.setText(_translate("Form", "Stop Milling"))
```

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMinimapWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMinimapWidget.py`

 * *Files 4% similar despite different names*

```diff
@@ -205,80 +205,80 @@
         self.tab_2 = QtWidgets.QWidget()
         self.tab_2.setObjectName("tab_2")
         self.gridLayout_3 = QtWidgets.QGridLayout(self.tab_2)
         self.gridLayout_3.setObjectName("gridLayout_3")
         self.label_correlation_selected_layer = QtWidgets.QLabel(self.tab_2)
         self.label_correlation_selected_layer.setObjectName("label_correlation_selected_layer")
         self.gridLayout_3.addWidget(self.label_correlation_selected_layer, 1, 0, 1, 1)
-        self.label_correlation_scale_x = QtWidgets.QLabel(self.tab_2)
-        self.label_correlation_scale_x.setObjectName("label_correlation_scale_x")
-        self.gridLayout_3.addWidget(self.label_correlation_scale_x, 3, 0, 1, 1)
-        self.checkBox_gridbar = QtWidgets.QCheckBox(self.tab_2)
-        self.checkBox_gridbar.setObjectName("checkBox_gridbar")
-        self.gridLayout_3.addWidget(self.checkBox_gridbar, 5, 0, 1, 1)
-        spacerItem2 = QtWidgets.QSpacerItem(483, 261, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
-        self.gridLayout_3.addItem(spacerItem2, 9, 0, 1, 2)
-        self.doubleSpinBox_correlation_translation_x = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_correlation_translation_x.setDecimals(0)
-        self.doubleSpinBox_correlation_translation_x.setMinimum(-100000000.0)
-        self.doubleSpinBox_correlation_translation_x.setMaximum(1000000000.0)
-        self.doubleSpinBox_correlation_translation_x.setObjectName("doubleSpinBox_correlation_translation_x")
-        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_translation_x, 2, 1, 1, 1)
+        self.doubleSpinBox_correlation_scale_x = QtWidgets.QDoubleSpinBox(self.tab_2)
+        self.doubleSpinBox_correlation_scale_x.setDecimals(3)
+        self.doubleSpinBox_correlation_scale_x.setMinimum(-100000000.0)
+        self.doubleSpinBox_correlation_scale_x.setMaximum(1000000000.0)
+        self.doubleSpinBox_correlation_scale_x.setProperty("value", 1.0)
+        self.doubleSpinBox_correlation_scale_x.setObjectName("doubleSpinBox_correlation_scale_x")
+        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_scale_x, 3, 1, 1, 1)
         self.label_correlation_rotation = QtWidgets.QLabel(self.tab_2)
         self.label_correlation_rotation.setObjectName("label_correlation_rotation")
         self.gridLayout_3.addWidget(self.label_correlation_rotation, 4, 0, 1, 1)
         self.label_correlation_translation_x = QtWidgets.QLabel(self.tab_2)
         self.label_correlation_translation_x.setObjectName("label_correlation_translation_x")
         self.gridLayout_3.addWidget(self.label_correlation_translation_x, 2, 0, 1, 1)
+        self.checkBox_gridbar = QtWidgets.QCheckBox(self.tab_2)
+        self.checkBox_gridbar.setObjectName("checkBox_gridbar")
+        self.gridLayout_3.addWidget(self.checkBox_gridbar, 6, 0, 1, 1)
+        self.doubleSpinBox_gb_spacing = QtWidgets.QDoubleSpinBox(self.tab_2)
+        self.doubleSpinBox_gb_spacing.setMaximum(10000.0)
+        self.doubleSpinBox_gb_spacing.setObjectName("doubleSpinBox_gb_spacing")
+        self.gridLayout_3.addWidget(self.doubleSpinBox_gb_spacing, 8, 1, 1, 1)
+        self.label_gb_width = QtWidgets.QLabel(self.tab_2)
+        self.label_gb_width.setObjectName("label_gb_width")
+        self.gridLayout_3.addWidget(self.label_gb_width, 7, 0, 1, 1)
+        self.doubleSpinBox_correlation_rotation = QtWidgets.QDoubleSpinBox(self.tab_2)
+        self.doubleSpinBox_correlation_rotation.setDecimals(2)
+        self.doubleSpinBox_correlation_rotation.setMinimum(-360.0)
+        self.doubleSpinBox_correlation_rotation.setMaximum(360.0)
+        self.doubleSpinBox_correlation_rotation.setObjectName("doubleSpinBox_correlation_rotation")
+        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_rotation, 4, 1, 1, 2)
+        self.pushButton_enable_correlation = QtWidgets.QPushButton(self.tab_2)
+        self.pushButton_enable_correlation.setObjectName("pushButton_enable_correlation")
+        self.gridLayout_3.addWidget(self.pushButton_enable_correlation, 5, 0, 1, 3)
+        self.label_correlation_scale_x = QtWidgets.QLabel(self.tab_2)
+        self.label_correlation_scale_x.setObjectName("label_correlation_scale_x")
+        self.gridLayout_3.addWidget(self.label_correlation_scale_x, 3, 0, 1, 1)
         self.comboBox_correlation_selected_layer = QtWidgets.QComboBox(self.tab_2)
         self.comboBox_correlation_selected_layer.setObjectName("comboBox_correlation_selected_layer")
         self.gridLayout_3.addWidget(self.comboBox_correlation_selected_layer, 1, 1, 1, 2)
-        self.doubleSpinBox_correlation_scale_y = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_correlation_scale_y.setDecimals(3)
-        self.doubleSpinBox_correlation_scale_y.setMinimum(-100000000.0)
-        self.doubleSpinBox_correlation_scale_y.setMaximum(1000000000.0)
-        self.doubleSpinBox_correlation_scale_y.setProperty("value", 1.0)
-        self.doubleSpinBox_correlation_scale_y.setObjectName("doubleSpinBox_correlation_scale_y")
-        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_scale_y, 3, 2, 1, 1)
-        self.label_gb_width = QtWidgets.QLabel(self.tab_2)
-        self.label_gb_width.setObjectName("label_gb_width")
-        self.gridLayout_3.addWidget(self.label_gb_width, 6, 0, 1, 1)
         self.doubleSpinBox_correlation_translation_y = QtWidgets.QDoubleSpinBox(self.tab_2)
         self.doubleSpinBox_correlation_translation_y.setDecimals(0)
         self.doubleSpinBox_correlation_translation_y.setMinimum(-100000000.0)
         self.doubleSpinBox_correlation_translation_y.setMaximum(1000000000.0)
         self.doubleSpinBox_correlation_translation_y.setObjectName("doubleSpinBox_correlation_translation_y")
         self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_translation_y, 2, 2, 1, 1)
-        self.doubleSpinBox_correlation_scale_x = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_correlation_scale_x.setDecimals(3)
-        self.doubleSpinBox_correlation_scale_x.setMinimum(-100000000.0)
-        self.doubleSpinBox_correlation_scale_x.setMaximum(1000000000.0)
-        self.doubleSpinBox_correlation_scale_x.setProperty("value", 1.0)
-        self.doubleSpinBox_correlation_scale_x.setObjectName("doubleSpinBox_correlation_scale_x")
-        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_scale_x, 3, 1, 1, 1)
-        self.pushButton_update_correlation_image = QtWidgets.QPushButton(self.tab_2)
-        self.pushButton_update_correlation_image.setObjectName("pushButton_update_correlation_image")
-        self.gridLayout_3.addWidget(self.pushButton_update_correlation_image, 8, 1, 1, 2)
-        self.doubleSpinBox_correlation_rotation = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_correlation_rotation.setDecimals(2)
-        self.doubleSpinBox_correlation_rotation.setMinimum(-360.0)
-        self.doubleSpinBox_correlation_rotation.setMaximum(360.0)
-        self.doubleSpinBox_correlation_rotation.setObjectName("doubleSpinBox_correlation_rotation")
-        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_rotation, 4, 1, 1, 2)
         self.label_gb_spacing = QtWidgets.QLabel(self.tab_2)
         self.label_gb_spacing.setObjectName("label_gb_spacing")
-        self.gridLayout_3.addWidget(self.label_gb_spacing, 7, 0, 1, 1)
+        self.gridLayout_3.addWidget(self.label_gb_spacing, 8, 0, 1, 1)
+        self.doubleSpinBox_correlation_translation_x = QtWidgets.QDoubleSpinBox(self.tab_2)
+        self.doubleSpinBox_correlation_translation_x.setDecimals(0)
+        self.doubleSpinBox_correlation_translation_x.setMinimum(-100000000.0)
+        self.doubleSpinBox_correlation_translation_x.setMaximum(1000000000.0)
+        self.doubleSpinBox_correlation_translation_x.setObjectName("doubleSpinBox_correlation_translation_x")
+        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_translation_x, 2, 1, 1, 1)
+        self.doubleSpinBox_correlation_scale_y = QtWidgets.QDoubleSpinBox(self.tab_2)
+        self.doubleSpinBox_correlation_scale_y.setDecimals(3)
+        self.doubleSpinBox_correlation_scale_y.setMinimum(-100000000.0)
+        self.doubleSpinBox_correlation_scale_y.setMaximum(1000000000.0)
+        self.doubleSpinBox_correlation_scale_y.setProperty("value", 1.0)
+        self.doubleSpinBox_correlation_scale_y.setObjectName("doubleSpinBox_correlation_scale_y")
+        self.gridLayout_3.addWidget(self.doubleSpinBox_correlation_scale_y, 3, 2, 1, 1)
         self.doubleSpinBox_gb_width = QtWidgets.QDoubleSpinBox(self.tab_2)
         self.doubleSpinBox_gb_width.setMaximum(10000.0)
         self.doubleSpinBox_gb_width.setObjectName("doubleSpinBox_gb_width")
-        self.gridLayout_3.addWidget(self.doubleSpinBox_gb_width, 6, 1, 1, 1)
-        self.doubleSpinBox_gb_spacing = QtWidgets.QDoubleSpinBox(self.tab_2)
-        self.doubleSpinBox_gb_spacing.setMaximum(10000.0)
-        self.doubleSpinBox_gb_spacing.setObjectName("doubleSpinBox_gb_spacing")
-        self.gridLayout_3.addWidget(self.doubleSpinBox_gb_spacing, 7, 1, 1, 1)
+        self.gridLayout_3.addWidget(self.doubleSpinBox_gb_width, 7, 1, 1, 1)
+        spacerItem2 = QtWidgets.QSpacerItem(483, 261, QtWidgets.QSizePolicy.Minimum, QtWidgets.QSizePolicy.Expanding)
+        self.gridLayout_3.addItem(spacerItem2, 10, 0, 1, 3)
         self.tabWidget.addTab(self.tab_2, "")
         self.gridLayout.addWidget(self.tabWidget, 1, 0, 1, 1)
         MainWindow.setCentralWidget(self.centralwidget)
         self.menubar = QtWidgets.QMenuBar(MainWindow)
         self.menubar.setGeometry(QtCore.QRect(0, 0, 670, 22))
         self.menubar.setObjectName("menubar")
         self.menuFile = QtWidgets.QMenu(self.menubar)
@@ -336,20 +336,20 @@
         self.label_pattern_overlay.setText(_translate("MainWindow", "Pattern Overlay"))
         self.label_position_header.setText(_translate("MainWindow", "Saved Positions"))
         self.pushButton_move_to_position.setText(_translate("MainWindow", "Move to Position"))
         self.pushButton_remove_position.setText(_translate("MainWindow", "Remove Position"))
         self.checkBox_pattern_overlay.setText(_translate("MainWindow", "Display Pattern"))
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_4), _translate("MainWindow", "Positions"))
         self.label_correlation_selected_layer.setText(_translate("MainWindow", "Selected Layer"))
-        self.label_correlation_scale_x.setText(_translate("MainWindow", "Scale x, y (%)"))
-        self.checkBox_gridbar.setText(_translate("MainWindow", "Overlay Gridbar"))
         self.label_correlation_rotation.setText(_translate("MainWindow", "Rotation (deg)"))
         self.label_correlation_translation_x.setText(_translate("MainWindow", "Translation x, y (px)"))
+        self.checkBox_gridbar.setText(_translate("MainWindow", "Overlay Gridbar"))
         self.label_gb_width.setText(_translate("MainWindow", "Gridbar Width (um)"))
-        self.pushButton_update_correlation_image.setText(_translate("MainWindow", "Update Correlation Image"))
+        self.pushButton_enable_correlation.setText(_translate("MainWindow", "Enable Correlation Mode"))
+        self.label_correlation_scale_x.setText(_translate("MainWindow", "Scale x, y (%)"))
         self.label_gb_spacing.setText(_translate("MainWindow", "Gridbar Spacing (um)"))
         self.tabWidget.setTabText(self.tabWidget.indexOf(self.tab_2), _translate("MainWindow", "Correlation"))
         self.menuFile.setTitle(_translate("MainWindow", "File"))
         self.actionLoad_Image.setText(_translate("MainWindow", "Load Image"))
         self.actionLoad_Correlation_Image.setText(_translate("MainWindow", "Load Correlation Image"))
         self.actionSave_Positions.setText(_translate("MainWindow", "Save Positions"))
         self.actionLoad_Positions.setText(_translate("MainWindow", "Load Positions"))
```

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemModelTrainingWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMovementWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMovementWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemMultiChemWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemPositionsWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemPositionsWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemSegmentationModelWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemSystemSetupWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/FibsemUI.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/FibsemUI.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/ImageSettingsWidget.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/ImageSettingsWidget.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/detection_dialog.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/detection_dialog.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/qtdesigner_files/image_viewer.py` & `fibsem-0.3.4/fibsem/ui/qtdesigner_files/image_viewer.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/utils.py` & `fibsem-0.3.4/fibsem/ui/utils.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/ui/windows.py` & `fibsem-0.3.4/fibsem/ui/windows.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/utils.py` & `fibsem-0.3.4/fibsem/utils.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem/validation.py` & `fibsem-0.3.4/fibsem/validation.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/fibsem.egg-info/PKG-INFO` & `fibsem-0.3.4/fibsem.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: fibsem
-Version: 0.3.3
+Version: 0.3.4
 Summary: a universal api for fibsem control
 Home-page: https://github.com/DeMarcoLab/fibsem
 Author: Patrick Cleeve
 Author-email: Patrick.Cleeve@monash.edu
 Project-URL: Bug Tracker, https://github.com/DeMarcoLab/fibsem/issues
 Classifier: Programming Language :: Python :: 3.9
 Classifier: License :: OSI Approved :: MIT License
```

### Comparing `fibsem-0.3.3/fibsem.egg-info/SOURCES.txt` & `fibsem-0.3.4/fibsem.egg-info/SOURCES.txt`

 * *Files 6% similar despite different names*

```diff
@@ -56,17 +56,28 @@
 fibsem/config/protocol.yaml
 fibsem/config/tescan_manipulator.yaml
 fibsem/config/user-configurations.yaml
 fibsem/db/app.py
 fibsem/db/config.yaml
 fibsem/db/notebook.ipynb
 fibsem/db/util.py
+fibsem/db/v2/app.py
+fibsem/db/v2/models.py
+fibsem/db/v2/notebook.ipynb
+fibsem/db/v2/util.py
+fibsem/db/v3/app.py
+fibsem/db/v3/models.py
+fibsem/db/v3/notebook.ipynb
+fibsem/db/v3/util.py
 fibsem/detection/__init__.py
+fibsem/detection/config-autolamella-liftout-hf-mega.yaml
 fibsem/detection/config-autolamella-liftout.yaml
+fibsem/detection/config-autolamella-serial-liftout-hf-mega.yaml
 fibsem/detection/config-autolamella-serial-liftout.yaml
+fibsem/detection/config-autolamella-waffle-v2-hf-mega.yaml
 fibsem/detection/config-autolamella-waffle-v2.yaml
 fibsem/detection/config-autolamella-waffle.yml
 fibsem/detection/config-autoliftout-dm-embryo.yml
 fibsem/detection/detection.py
 fibsem/detection/evaluation.py
 fibsem/detection/run_evaluation.py
 fibsem/detection/test_image.tif
@@ -98,14 +109,16 @@
 fibsem/segmentation/config-autolamella-mega-v5.yml
 fibsem/segmentation/config-autolamella-serial-liftout-v1.yaml
 fibsem/segmentation/config-autolamella-waffle4.yml
 fibsem/segmentation/config.py
 fibsem/segmentation/config.yml
 fibsem/segmentation/dataset.py
 fibsem/segmentation/example.ipynb
+fibsem/segmentation/hf_segmentation_model.py
+fibsem/segmentation/huggingface.ipynb
 fibsem/segmentation/inference.py
 fibsem/segmentation/model.py
 fibsem/segmentation/nnunet_model.py
 fibsem/segmentation/onnx_model.py
 fibsem/segmentation/requirements.txt
 fibsem/segmentation/sam_model.py
 fibsem/segmentation/segmentation_config.yaml
```

### Comparing `fibsem-0.3.3/scripts/convert_to_nnunet_dataset.py` & `fibsem-0.3.4/scripts/convert_to_nnunet_dataset.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/scripts/convert_to_onnx.py` & `fibsem-0.3.4/scripts/convert_to_onnx.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/scripts/export_nnunet_checkpoint.py` & `fibsem-0.3.4/scripts/export_nnunet_checkpoint.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/scripts/generate_segmentation_objects.py` & `fibsem-0.3.4/scripts/generate_segmentation_objects.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/scripts/shortcut.py` & `fibsem-0.3.4/scripts/shortcut.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/scripts/test_installation.py` & `fibsem-0.3.4/scripts/test_installation.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/setup.cfg` & `fibsem-0.3.4/setup.cfg`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [metadata]
 name = fibsem
-version = 0.3.3
+version = 0.3.4
 author = Patrick Cleeve
 author_email = Patrick.Cleeve@monash.edu
 description = a universal api for fibsem control
 long_description = file: README.md
 long_description_content_type = text/markdown
 url = https://github.com/DeMarcoLab/fibsem
 project_urls =
```

### Comparing `fibsem-0.3.3/tests/test_alignment.py` & `fibsem-0.3.4/tests/test_alignment.py`

 * *Files identical despite different names*

### Comparing `fibsem-0.3.3/tests/test_movement.py` & `fibsem-0.3.4/tests/test_movement.py`

 * *Files identical despite different names*

