# Comparing `tmp/ggml-python-0.0.8.tar.gz` & `tmp/ggml-python-0.0.9.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ggml-python-0.0.8.tar", last modified: Wed Nov  9 12:37:21 2022, max compression
+gzip compressed data, was "ggml-python-0.0.9.tar", last modified: Wed Nov  9 12:37:21 2022, max compression
```

## Comparing `ggml-python-0.0.8.tar` & `ggml-python-0.0.9.tar`

### file list

```diff
@@ -1,267 +1,268 @@
--rw-r--r--   0        0        0     2055 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.github/workflows/test.yaml
--rw-r--r--   0        0        0     3146 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.gitignore
--rw-r--r--   0        0        0       87 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.gitmodules
--rw-r--r--   0        0        0      443 2022-11-09 12:37:21.000000 ggml-python-0.0.8/.readthedocs.yaml
--rw-r--r--   0        0        0      800 2022-11-09 12:37:21.000000 ggml-python-0.0.8/CMakeLists.txt
--rw-r--r--   0        0        0     1069 2022-11-09 12:37:21.000000 ggml-python-0.0.8/LICENSE.md
--rw-r--r--   0        0        0      958 2022-11-09 12:37:21.000000 ggml-python-0.0.8/Makefile
--rw-r--r--   0        0        0     3429 2022-11-09 12:37:21.000000 ggml-python-0.0.8/README.md
--rw-r--r--   0        0        0      107 2022-11-09 12:37:21.000000 ggml-python-0.0.8/docs/api-reference.md
--rw-r--r--   0        0        0     3486 2022-11-09 12:37:21.000000 ggml-python-0.0.8/docs/index.md
--rw-r--r--   0        0        0     1330 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/README.md
--rw-r--r--   0        0        0     4527 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/convert-pt-to-ggml.py
--rw-r--r--   0        0        0    31690 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/model.py
--rw-r--r--   0        0        0      470 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/requirements.txt
--rw-r--r--   0        0        0     7599 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/clip/utils.py
--rw-r--r--   0        0        0     1170 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/README.md
--rw-r--r--   0        0        0    24959 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/app.py
--rw-r--r--   0        0        0    39016 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/main.py
--rw-r--r--   0        0        0    68226 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/recording.svg
--rw-r--r--   0        0        0       72 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/requirements.txt
--rwxr-xr-x   0        0        0      385 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/run_demo.sh
--rwxr-xr-x   0        0        0      105 2022-11-09 12:37:21.000000 ggml-python-0.0.8/examples/replit/run_server.sh
--rw-r--r--   0        0        0       19 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/__init__.py
--rw-r--r--   0        0        0    33572 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/experimental.py
--rw-r--r--   0        0        0   155356 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/ggml.py
--rw-r--r--   0        0        0     4527 2022-11-09 12:37:21.000000 ggml-python-0.0.8/ggml/utils.py
--rw-r--r--   0        0        0      950 2022-11-09 12:37:21.000000 ggml-python-0.0.8/mkdocs.yml
--rw-r--r--   0        0        0     1291 2022-11-09 12:37:21.000000 ggml-python-0.0.8/pyproject.toml
--rw-r--r--   0        0        0        0 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/__init__.py
--rw-r--r--   0        0        0      661 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_experimental.py
--rw-r--r--   0        0        0     3571 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_ggml.py
--rw-r--r--   0        0        0     2940 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_ggml_cuda.py
--rw-r--r--   0        0        0     1800 2022-11-09 12:37:21.000000 ggml-python-0.0.8/tests/test_utils.py
--rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/.git
--rw-r--r--   0        0        0      865 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/.github/workflows/ci.yml
--rw-r--r--   0        0        0      191 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/.gitignore
--rw-r--r--   0        0        0     2845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/CMakeLists.txt
--rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/LICENSE
--rw-r--r--   0        0        0     5514 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/README.md
--rw-r--r--   0        0        0     4251 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/build.zig
--rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/cmake/BuildTypes.cmake
--rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/cmake/GitVars.cmake
--rw-r--r--   0        0        0      815 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/CMakeLists.txt
--rw-r--r--   0        0        0     8676 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common-ggml.cpp
--rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common-ggml.h
--rw-r--r--   0        0        0    24799 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common.cpp
--rw-r--r--   0        0        0     4619 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/common.h
--rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/CMakeLists.txt
--rw-r--r--   0        0        0     5398 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/README.md
--rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    33342 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/main.cpp
--rw-r--r--   0        0        0     6037 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/quantize.cpp
--rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/dr_wav.h
--rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/CMakeLists.txt
--rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/README.md
--rw-r--r--   0        0        0     6319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py
--rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py
--rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py
--rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-ggml-model.sh
--rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-model.sh
--rw-r--r--   0        0        0    29487 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/main.cpp
--rw-r--r--   0        0        0     5859 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-2/quantize.cpp
--rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/CMakeLists.txt
--rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/README.md
--rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py
--rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-ggml-model.sh
--rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-model.sh
--rw-r--r--   0        0        0    25934 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/main.cpp
--rw-r--r--   0        0        0     5861 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-j/quantize.cpp
--rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/CMakeLists.txt
--rw-r--r--   0        0        0     3948 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/README.md
--rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    28383 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/main.cpp
--rw-r--r--   0        0        0     5845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/quantize.cpp
--rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/CMakeLists.txt
--rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/README.md
--rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/convert-h5-to-ggml.py
--rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-cpu.cpp
--rw-r--r--   0        0        0     3417 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.cpp
--rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.h
--rw-r--r--   0        0        0    21090 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.m
--rw-r--r--   0        0        0     9472 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/main.cpp
--rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/web/.gitignore
--rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mnist/web/index.html
--rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/CMakeLists.txt
--rw-r--r--   0        0        0      671 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/README.md
--rwxr-xr-x   0        0        0     4948 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    38183 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/main.cpp
--rw-r--r--   0        0        0     6101 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/mpt/quantize.cpp
--rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/dolly-v2.txt
--rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-2-chinese.txt
--rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-2.txt
--rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-j.txt
--rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-neox-japanese.txt
--rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-neox.txt
--rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/polyglot-ko.txt
--rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/replit.txt
--rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/starcoder.txt
--rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/test-cases.txt
--rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/tokenize_huggingface.py
--rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/prompts/whisper.txt
--rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/CMakeLists.txt
--rw-r--r--   0        0        0     3364 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    27974 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/main.cpp
--rw-r--r--   0        0        0     5641 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/replit/quantize.cpp
--rw-r--r--   0        0        0      327 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/CMakeLists.txt
--rw-r--r--   0        0        0     3831 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/README.md
--rw-r--r--   0        0        0     7852 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py
--rw-r--r--   0        0        0    33059 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/main.cpp
--rw-r--r--   0        0        0     5880 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/starcoder/quantize.cpp
--rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/CMakeLists.txt
--rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/README.md
--rw-r--r--   0        0        0     9441 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/convert-pt-to-ggml.py
--rw-r--r--   0        0        0    40940 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/main.cpp
--rw-r--r--   0        0        0     8150 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/quantize.cpp
--rw-r--r--   0        0        0   189520 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/whisper.cpp
--rw-r--r--   0        0        0    25668 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/examples/whisper/whisper.h
--rw-r--r--   0        0        0      241 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/ggml.pc.in
--rw-r--r--   0        0        0    55052 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/include/ggml/ggml.h
--rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/requirements.txt
--rwxr-xr-x   0        0        0      806 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/scripts/sync-llama.sh
--rwxr-xr-x   0        0        0     1286 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/scripts/sync-whisper.sh
--rw-r--r--   0        0        0     8982 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/CMakeLists.txt
--rw-r--r--   0        0        0   134240 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-cuda.cu
--rw-r--r--   0        0        0     1460 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-cuda.h
--rw-r--r--   0        0        0     2769 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-metal.h
--rw-r--r--   0        0        0    50140 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-metal.m
--rw-r--r--   0        0        0    59655 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-metal.metal
--rw-r--r--   0        0        0    68854 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-opencl.cpp
--rw-r--r--   0        0        0      845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml-opencl.h
--rw-r--r--   0        0        0   608566 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/src/ggml.c
--rw-r--r--   0        0        0     9736 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/CMakeLists.txt
--rw-r--r--   0        0        0     6639 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-blas0.c
--rw-r--r--   0        0        0    40350 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-grad0.c
--rw-r--r--   0        0        0    10892 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat0.c
--rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat1.c
--rw-r--r--   0        0        0    91888 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat2.c
--rw-r--r--   0        0        0     5728 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-opt.c
--rw-r--r--   0        0        0     4434 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-pool.c
--rw-r--r--   0        0        0     5614 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-quantize-fns.cpp
--rw-r--r--   0        0        0    13999 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-quantize-perf.cpp
--rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-svd0.c
--rw-r--r--   0        0        0     3402 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-vec0.c
--rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-vec1.c
--rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test-vec2.c
--rw-r--r--   0        0        0     1237 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test0.c
--rw-r--r--   0        0        0     1425 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test0.zig
--rw-r--r--   0        0        0    15593 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test1.c
--rw-r--r--   0        0        0    18066 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test1.zig
--rw-r--r--   0        0        0     5931 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test2.c
--rw-r--r--   0        0        0     5828 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test2.zig
--rw-r--r--   0        0        0     2843 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test3.c
--rw-r--r--   0        0        0     3278 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml/tests/test3.zig
--rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/.git
--rw-r--r--   0        0        0      865 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/.github/workflows/ci.yml
--rw-r--r--   0        0        0      191 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/.gitignore
--rw-r--r--   0        0        0     2630 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/CMakeLists.txt
--rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/LICENSE
--rw-r--r--   0        0        0     5281 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/README.md
--rw-r--r--   0        0        0     4385 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/build.zig
--rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/cmake/BuildTypes.cmake
--rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/cmake/GitVars.cmake
--rw-r--r--   0        0        0      815 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/CMakeLists.txt
--rw-r--r--   0        0        0     8676 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common-ggml.cpp
--rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common-ggml.h
--rw-r--r--   0        0        0    24038 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common.cpp
--rw-r--r--   0        0        0     4445 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/common.h
--rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/CMakeLists.txt
--rw-r--r--   0        0        0     5398 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/README.md
--rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    28935 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/main.cpp
--rw-r--r--   0        0        0     6032 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/quantize.cpp
--rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/dr_wav.h
--rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/CMakeLists.txt
--rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/README.md
--rw-r--r--   0        0        0     6319 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-cerebras-to-ggml.py
--rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-ckpt-to-ggml.py
--rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-h5-to-ggml.py
--rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/download-ggml-model.sh
--rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/download-model.sh
--rw-r--r--   0        0        0    29499 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/main.cpp
--rw-r--r--   0        0        0     5854 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/quantize.cpp
--rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/CMakeLists.txt
--rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/README.md
--rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/convert-h5-to-ggml.py
--rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/download-ggml-model.sh
--rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/download-model.sh
--rw-r--r--   0        0        0    25946 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/main.cpp
--rw-r--r--   0        0        0     5856 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/quantize.cpp
--rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/CMakeLists.txt
--rw-r--r--   0        0        0     3948 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/README.md
--rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    28395 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/main.cpp
--rw-r--r--   0        0        0     5840 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/quantize.cpp
--rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/CMakeLists.txt
--rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/README.md
--rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/convert-h5-to-ggml.py
--rw-r--r--   0        0        0     3431 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-cpu.cpp
--rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.cpp
--rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.h
--rw-r--r--   0        0        0    21062 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.m
--rw-r--r--   0        0        0     9484 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main.cpp
--rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/web/.gitignore
--rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/web/index.html
--rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/CMakeLists.txt
--rw-r--r--   0        0        0     4722 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    38188 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/main.cpp
--rw-r--r--   0        0        0     6096 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/quantize.cpp
--rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/dolly-v2.txt
--rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-2-chinese.txt
--rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-2.txt
--rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-j.txt
--rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-neox-japanese.txt
--rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-neox.txt
--rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/polyglot-ko.txt
--rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/replit.txt
--rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/starcoder.txt
--rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/test-cases.txt
--rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/tokenize_huggingface.py
--rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/whisper.txt
--rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/CMakeLists.txt
--rw-r--r--   0        0        0     3364 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/convert-h5-to-ggml.py
--rw-r--r--   0        0        0    27951 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/main.cpp
--rw-r--r--   0        0        0     5636 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/quantize.cpp
--rw-r--r--   0        0        0      327 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/CMakeLists.txt
--rw-r--r--   0        0        0     3831 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/README.md
--rw-r--r--   0        0        0     7758 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/convert-hf-to-ggml.py
--rw-r--r--   0        0        0    31853 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/main.cpp
--rw-r--r--   0        0        0     5875 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/quantize.cpp
--rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/CMakeLists.txt
--rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/README.md
--rw-r--r--   0        0        0     9441 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/convert-pt-to-ggml.py
--rw-r--r--   0        0        0    39190 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/main.cpp
--rw-r--r--   0        0        0     8145 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/quantize.cpp
--rw-r--r--   0        0        0   185322 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.cpp
--rw-r--r--   0        0        0    24087 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.h
--rw-r--r--   0        0        0    52032 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/include/ggml/ggml.h
--rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/requirements.txt
--rwxr-xr-x   0        0        0      512 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/scripts/sync-llama.sh
--rwxr-xr-x   0        0        0     1286 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/scripts/sync-whisper.sh
--rw-r--r--   0        0        0     8756 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/CMakeLists.txt
--rw-r--r--   0        0        0   120472 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.cu
--rw-r--r--   0        0        0     1513 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.h
--rw-r--r--   0        0        0     2615 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.h
--rw-r--r--   0        0        0    49870 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.m
--rw-r--r--   0        0        0    59655 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.metal
--rw-r--r--   0        0        0    62020 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-opencl.cpp
--rw-r--r--   0        0        0      845 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-opencl.h
--rw-r--r--   0        0        0   624971 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/src/ggml.c
--rw-r--r--   0        0        0     9496 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/CMakeLists.txt
--rw-r--r--   0        0        0     6569 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-blas0.c
--rw-r--r--   0        0        0    40249 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-grad0.c
--rw-r--r--   0        0        0    10698 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat0.c
--rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat1.c
--rw-r--r--   0        0        0    91888 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat2.c
--rw-r--r--   0        0        0     5616 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-opt.c
--rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-svd0.c
--rw-r--r--   0        0        0     3402 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec0.c
--rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec1.c
--rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec2.c
--rw-r--r--   0        0        0     1237 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test0.c
--rw-r--r--   0        0        0     1480 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test0.zig
--rw-r--r--   0        0        0    15323 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.c
--rw-r--r--   0        0        0    17877 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.zig
--rw-r--r--   0        0        0     5931 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test2.c
--rw-r--r--   0        0        0     2843 2022-11-09 12:37:21.000000 ggml-python-0.0.8/vendor/ggml-cpy/tests/test3.c
--rw-r--r--   0        0        0     4838 2022-11-09 12:37:21.000000 ggml-python-0.0.8/PKG-INFO
+-rw-r--r--   0        0        0     2055 2022-11-09 12:37:21.000000 ggml-python-0.0.9/.github/workflows/test.yaml
+-rw-r--r--   0        0        0     3146 2022-11-09 12:37:21.000000 ggml-python-0.0.9/.gitignore
+-rw-r--r--   0        0        0       87 2022-11-09 12:37:21.000000 ggml-python-0.0.9/.gitmodules
+-rw-r--r--   0        0        0      443 2022-11-09 12:37:21.000000 ggml-python-0.0.9/.readthedocs.yaml
+-rw-r--r--   0        0        0      800 2022-11-09 12:37:21.000000 ggml-python-0.0.9/CMakeLists.txt
+-rw-r--r--   0        0        0     1069 2022-11-09 12:37:21.000000 ggml-python-0.0.9/LICENSE.md
+-rw-r--r--   0        0        0      958 2022-11-09 12:37:21.000000 ggml-python-0.0.9/Makefile
+-rw-r--r--   0        0        0     3429 2022-11-09 12:37:21.000000 ggml-python-0.0.9/README.md
+-rw-r--r--   0        0        0      107 2022-11-09 12:37:21.000000 ggml-python-0.0.9/docs/api-reference.md
+-rw-r--r--   0        0        0     3486 2022-11-09 12:37:21.000000 ggml-python-0.0.9/docs/index.md
+-rw-r--r--   0        0        0     1330 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/clip/README.md
+-rw-r--r--   0        0        0     4527 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/clip/convert-pt-to-ggml.py
+-rw-r--r--   0        0        0    31690 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/clip/model.py
+-rw-r--r--   0        0        0      470 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/clip/requirements.txt
+-rw-r--r--   0        0        0     7599 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/clip/utils.py
+-rw-r--r--   0        0        0     1170 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/replit/README.md
+-rw-r--r--   0        0        0    25174 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/replit/app.py
+-rw-r--r--   0        0        0    39071 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/replit/main.py
+-rw-r--r--   0        0        0    68226 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/replit/recording.svg
+-rw-r--r--   0        0        0       72 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/replit/requirements.txt
+-rwxr-xr-x   0        0        0      385 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/replit/run_demo.sh
+-rwxr-xr-x   0        0        0      192 2022-11-09 12:37:21.000000 ggml-python-0.0.9/examples/replit/run_server.sh
+-rw-r--r--   0        0        0       19 2022-11-09 12:37:21.000000 ggml-python-0.0.9/ggml/__init__.py
+-rw-r--r--   0        0        0    31753 2022-11-09 12:37:21.000000 ggml-python-0.0.9/ggml/experimental.py
+-rw-r--r--   0        0        0   155356 2022-11-09 12:37:21.000000 ggml-python-0.0.9/ggml/ggml.py
+-rw-r--r--   0        0        0     4527 2022-11-09 12:37:21.000000 ggml-python-0.0.9/ggml/utils.py
+-rw-r--r--   0        0        0      950 2022-11-09 12:37:21.000000 ggml-python-0.0.9/mkdocs.yml
+-rw-r--r--   0        0        0     1291 2022-11-09 12:37:21.000000 ggml-python-0.0.9/pyproject.toml
+-rw-r--r--   0        0        0        0 2022-11-09 12:37:21.000000 ggml-python-0.0.9/tests/__init__.py
+-rw-r--r--   0        0        0      661 2022-11-09 12:37:21.000000 ggml-python-0.0.9/tests/test_experimental.py
+-rw-r--r--   0        0        0     3588 2022-11-09 12:37:21.000000 ggml-python-0.0.9/tests/test_ggml.py
+-rw-r--r--   0        0        0     2940 2022-11-09 12:37:21.000000 ggml-python-0.0.9/tests/test_ggml_cuda.py
+-rw-r--r--   0        0        0     1800 2022-11-09 12:37:21.000000 ggml-python-0.0.9/tests/test_utils.py
+-rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/.git
+-rw-r--r--   0        0        0      865 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/.github/workflows/ci.yml
+-rw-r--r--   0        0        0      191 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/.gitignore
+-rw-r--r--   0        0        0     2845 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/CMakeLists.txt
+-rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/LICENSE
+-rw-r--r--   0        0        0     5514 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/README.md
+-rw-r--r--   0        0        0     4251 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/build.zig
+-rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/cmake/BuildTypes.cmake
+-rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/cmake/GitVars.cmake
+-rw-r--r--   0        0        0      815 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/CMakeLists.txt
+-rw-r--r--   0        0        0     8676 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/common-ggml.cpp
+-rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/common-ggml.h
+-rw-r--r--   0        0        0    25085 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/common.cpp
+-rw-r--r--   0        0        0     4654 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/common.h
+-rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/CMakeLists.txt
+-rw-r--r--   0        0        0     5398 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/README.md
+-rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    33342 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/main.cpp
+-rw-r--r--   0        0        0     6037 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/quantize.cpp
+-rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/dr_wav.h
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/CMakeLists.txt
+-rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/README.md
+-rw-r--r--   0        0        0     6319 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py
+-rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py
+-rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/download-ggml-model.sh
+-rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/download-model.sh
+-rw-r--r--   0        0        0    29487 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/main.cpp
+-rw-r--r--   0        0        0     5859 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-2/quantize.cpp
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-j/CMakeLists.txt
+-rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-j/README.md
+-rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-j/download-ggml-model.sh
+-rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-j/download-model.sh
+-rw-r--r--   0        0        0    25934 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-j/main.cpp
+-rw-r--r--   0        0        0     5861 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-j/quantize.cpp
+-rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/CMakeLists.txt
+-rw-r--r--   0        0        0     3948 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/README.md
+-rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28383 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/main.cpp
+-rw-r--r--   0        0        0     5845 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/quantize.cpp
+-rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/CMakeLists.txt
+-rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/README.md
+-rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/main-cpu.cpp
+-rw-r--r--   0        0        0     3417 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/main-mtl.cpp
+-rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/main-mtl.h
+-rw-r--r--   0        0        0    21090 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/main-mtl.m
+-rw-r--r--   0        0        0     9472 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/main.cpp
+-rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/web/.gitignore
+-rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mnist/web/index.html
+-rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mpt/CMakeLists.txt
+-rw-r--r--   0        0        0      671 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mpt/README.md
+-rwxr-xr-x   0        0        0     4948 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mpt/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    38183 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mpt/main.cpp
+-rw-r--r--   0        0        0     6101 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/mpt/quantize.cpp
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/dolly-v2.txt
+-rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-2-chinese.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-2.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-j.txt
+-rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-neox-japanese.txt
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-neox.txt
+-rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/polyglot-ko.txt
+-rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/replit.txt
+-rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/starcoder.txt
+-rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/test-cases.txt
+-rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/tokenize_huggingface.py
+-rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/prompts/whisper.txt
+-rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/replit/CMakeLists.txt
+-rw-r--r--   0        0        0     3364 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/replit/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    27974 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/replit/main.cpp
+-rw-r--r--   0        0        0     5641 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/replit/quantize.cpp
+-rw-r--r--   0        0        0      668 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/starcoder/CMakeLists.txt
+-rw-r--r--   0        0        0     3831 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/starcoder/README.md
+-rw-r--r--   0        0        0     7852 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py
+-rw-r--r--   0        0        0    33059 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/starcoder/main.cpp
+-rw-r--r--   0        0        0     5880 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/starcoder/quantize.cpp
+-rw-r--r--   0        0        0    39315 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/starcoder/starcoder-mmap.cpp
+-rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/whisper/CMakeLists.txt
+-rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/whisper/README.md
+-rw-r--r--   0        0        0     9441 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/whisper/convert-pt-to-ggml.py
+-rw-r--r--   0        0        0    40940 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/whisper/main.cpp
+-rw-r--r--   0        0        0     8150 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/whisper/quantize.cpp
+-rw-r--r--   0        0        0   189520 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/whisper/whisper.cpp
+-rw-r--r--   0        0        0    25668 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/examples/whisper/whisper.h
+-rw-r--r--   0        0        0      241 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/ggml.pc.in
+-rw-r--r--   0        0        0    55052 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/include/ggml/ggml.h
+-rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/requirements.txt
+-rwxr-xr-x   0        0        0      806 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/scripts/sync-llama.sh
+-rwxr-xr-x   0        0        0     1286 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/scripts/sync-whisper.sh
+-rw-r--r--   0        0        0     8986 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/CMakeLists.txt
+-rw-r--r--   0        0        0   136219 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml-cuda.cu
+-rw-r--r--   0        0        0     1460 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml-cuda.h
+-rw-r--r--   0        0        0     2769 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml-metal.h
+-rw-r--r--   0        0        0    50042 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml-metal.m
+-rw-r--r--   0        0        0    62545 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml-metal.metal
+-rw-r--r--   0        0        0    68854 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml-opencl.cpp
+-rw-r--r--   0        0        0      845 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml-opencl.h
+-rw-r--r--   0        0        0   608837 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/src/ggml.c
+-rw-r--r--   0        0        0     9736 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/CMakeLists.txt
+-rw-r--r--   0        0        0     6639 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-blas0.c
+-rw-r--r--   0        0        0    40350 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-grad0.c
+-rw-r--r--   0        0        0    10892 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-mul-mat0.c
+-rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-mul-mat1.c
+-rw-r--r--   0        0        0    91888 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-mul-mat2.c
+-rw-r--r--   0        0        0     5728 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-opt.c
+-rw-r--r--   0        0        0     4434 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-pool.c
+-rw-r--r--   0        0        0     5614 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-quantize-fns.cpp
+-rw-r--r--   0        0        0    13999 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-quantize-perf.cpp
+-rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-svd0.c
+-rw-r--r--   0        0        0     3402 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-vec0.c
+-rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-vec1.c
+-rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test-vec2.c
+-rw-r--r--   0        0        0     1237 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test0.c
+-rw-r--r--   0        0        0     1425 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test0.zig
+-rw-r--r--   0        0        0    15593 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test1.c
+-rw-r--r--   0        0        0    18066 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test1.zig
+-rw-r--r--   0        0        0     5931 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test2.c
+-rw-r--r--   0        0        0     5828 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test2.zig
+-rw-r--r--   0        0        0     2843 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test3.c
+-rw-r--r--   0        0        0     3278 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml/tests/test3.zig
+-rw-r--r--   0        0        0       39 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/.git
+-rw-r--r--   0        0        0      865 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/.github/workflows/ci.yml
+-rw-r--r--   0        0        0      191 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/.gitignore
+-rw-r--r--   0        0        0     2630 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/CMakeLists.txt
+-rw-r--r--   0        0        0     1072 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/LICENSE
+-rw-r--r--   0        0        0     5281 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/README.md
+-rw-r--r--   0        0        0     4385 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/build.zig
+-rw-r--r--   0        0        0     2037 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/cmake/BuildTypes.cmake
+-rw-r--r--   0        0        0      717 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/cmake/GitVars.cmake
+-rw-r--r--   0        0        0      815 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/CMakeLists.txt
+-rw-r--r--   0        0        0     8676 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/common-ggml.cpp
+-rw-r--r--   0        0        0      410 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/common-ggml.h
+-rw-r--r--   0        0        0    24038 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/common.cpp
+-rw-r--r--   0        0        0     4445 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/common.h
+-rw-r--r--   0        0        0      319 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/CMakeLists.txt
+-rw-r--r--   0        0        0     5398 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/README.md
+-rw-r--r--   0        0        0     3540 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28935 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/main.cpp
+-rw-r--r--   0        0        0     6032 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/quantize.cpp
+-rw-r--r--   0        0        0   241358 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/dr_wav.h
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/CMakeLists.txt
+-rw-r--r--   0        0        0     6370 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/README.md
+-rw-r--r--   0        0        0     6319 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/convert-cerebras-to-ggml.py
+-rw-r--r--   0        0        0     4873 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/convert-ckpt-to-ggml.py
+-rw-r--r--   0        0        0     6436 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1752 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/download-ggml-model.sh
+-rwxr-xr-x   0        0        0     1117 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/download-model.sh
+-rw-r--r--   0        0        0    29499 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/main.cpp
+-rw-r--r--   0        0        0     5854 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/quantize.cpp
+-rw-r--r--   0        0        0      311 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/CMakeLists.txt
+-rw-r--r--   0        0        0    11108 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/README.md
+-rw-r--r--   0        0        0     5509 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/convert-h5-to-ggml.py
+-rwxr-xr-x   0        0        0     1728 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/download-ggml-model.sh
+-rwxr-xr-x   0        0        0      571 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/download-model.sh
+-rw-r--r--   0        0        0    25946 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/main.cpp
+-rw-r--r--   0        0        0     5856 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/quantize.cpp
+-rw-r--r--   0        0        0      323 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/CMakeLists.txt
+-rw-r--r--   0        0        0     3948 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/README.md
+-rw-r--r--   0        0        0     3296 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    28395 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/main.cpp
+-rw-r--r--   0        0        0     5840 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/quantize.cpp
+-rw-r--r--   0        0        0      857 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/CMakeLists.txt
+-rw-r--r--   0        0        0     4104 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/README.md
+-rw-r--r--   0        0        0     1491 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0     3431 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main-cpu.cpp
+-rw-r--r--   0        0        0     3423 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main-mtl.cpp
+-rw-r--r--   0        0        0      500 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main-mtl.h
+-rw-r--r--   0        0        0    21062 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main-mtl.m
+-rw-r--r--   0        0        0     9484 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main.cpp
+-rw-r--r--   0        0        0        2 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/web/.gitignore
+-rw-r--r--   0        0        0     5597 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/web/index.html
+-rw-r--r--   0        0        0      303 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mpt/CMakeLists.txt
+-rw-r--r--   0        0        0     4722 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mpt/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    38188 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mpt/main.cpp
+-rw-r--r--   0        0        0     6096 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/mpt/quantize.cpp
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/dolly-v2.txt
+-rw-r--r--   0        0        0       76 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-2-chinese.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-2.txt
+-rw-r--r--   0        0        0     8176 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-j.txt
+-rw-r--r--   0        0        0       78 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-neox-japanese.txt
+-rw-r--r--   0        0        0     8222 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-neox.txt
+-rw-r--r--   0        0        0      174 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/polyglot-ko.txt
+-rw-r--r--   0        0        0    10111 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/replit.txt
+-rw-r--r--   0        0        0     9134 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/starcoder.txt
+-rw-r--r--   0        0        0     5094 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/test-cases.txt
+-rw-r--r--   0        0        0     3285 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/tokenize_huggingface.py
+-rw-r--r--   0        0        0     8727 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/whisper.txt
+-rw-r--r--   0        0        0      315 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/replit/CMakeLists.txt
+-rw-r--r--   0        0        0     3364 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/replit/convert-h5-to-ggml.py
+-rw-r--r--   0        0        0    27951 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/replit/main.cpp
+-rw-r--r--   0        0        0     5636 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/replit/quantize.cpp
+-rw-r--r--   0        0        0      327 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/CMakeLists.txt
+-rw-r--r--   0        0        0     3831 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/README.md
+-rw-r--r--   0        0        0     7758 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/convert-hf-to-ggml.py
+-rw-r--r--   0        0        0    31853 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/main.cpp
+-rw-r--r--   0        0        0     5875 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/quantize.cpp
+-rw-r--r--   0        0        0      501 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/CMakeLists.txt
+-rw-r--r--   0        0        0      718 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/README.md
+-rw-r--r--   0        0        0     9441 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/convert-pt-to-ggml.py
+-rw-r--r--   0        0        0    39190 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/main.cpp
+-rw-r--r--   0        0        0     8145 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/quantize.cpp
+-rw-r--r--   0        0        0   185322 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/whisper.cpp
+-rw-r--r--   0        0        0    24087 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/whisper.h
+-rw-r--r--   0        0        0    52032 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/include/ggml/ggml.h
+-rw-r--r--   0        0        0      126 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/requirements.txt
+-rwxr-xr-x   0        0        0      512 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/scripts/sync-llama.sh
+-rwxr-xr-x   0        0        0     1286 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/scripts/sync-whisper.sh
+-rw-r--r--   0        0        0     8756 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/CMakeLists.txt
+-rw-r--r--   0        0        0   120472 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-cuda.cu
+-rw-r--r--   0        0        0     1513 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-cuda.h
+-rw-r--r--   0        0        0     2615 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-metal.h
+-rw-r--r--   0        0        0    49870 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-metal.m
+-rw-r--r--   0        0        0    59655 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-metal.metal
+-rw-r--r--   0        0        0    62020 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-opencl.cpp
+-rw-r--r--   0        0        0      845 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-opencl.h
+-rw-r--r--   0        0        0   624971 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/src/ggml.c
+-rw-r--r--   0        0        0     9496 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/CMakeLists.txt
+-rw-r--r--   0        0        0     6569 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-blas0.c
+-rw-r--r--   0        0        0    40249 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-grad0.c
+-rw-r--r--   0        0        0    10698 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-mul-mat0.c
+-rw-r--r--   0        0        0     9003 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-mul-mat1.c
+-rw-r--r--   0        0        0    91888 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-mul-mat2.c
+-rw-r--r--   0        0        0     5616 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-opt.c
+-rw-r--r--   0        0        0     5141 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-svd0.c
+-rw-r--r--   0        0        0     3402 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-vec0.c
+-rw-r--r--   0        0        0    21179 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-vec1.c
+-rw-r--r--   0        0        0     7310 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test-vec2.c
+-rw-r--r--   0        0        0     1237 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test0.c
+-rw-r--r--   0        0        0     1480 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test0.zig
+-rw-r--r--   0        0        0    15323 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test1.c
+-rw-r--r--   0        0        0    17877 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test1.zig
+-rw-r--r--   0        0        0     5931 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test2.c
+-rw-r--r--   0        0        0     2843 2022-11-09 12:37:21.000000 ggml-python-0.0.9/vendor/ggml-cpy/tests/test3.c
+-rw-r--r--   0        0        0     4838 2022-11-09 12:37:21.000000 ggml-python-0.0.9/PKG-INFO
```

### Comparing `ggml-python-0.0.8/.github/workflows/test.yaml` & `ggml-python-0.0.9/.github/workflows/test.yaml`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/.gitignore` & `ggml-python-0.0.9/.gitignore`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/CMakeLists.txt` & `ggml-python-0.0.9/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/LICENSE.md` & `ggml-python-0.0.9/LICENSE.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/Makefile` & `ggml-python-0.0.9/Makefile`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/README.md` & `ggml-python-0.0.9/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/docs/index.md` & `ggml-python-0.0.9/docs/index.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/examples/clip/README.md` & `ggml-python-0.0.9/examples/clip/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/examples/clip/convert-pt-to-ggml.py` & `ggml-python-0.0.9/examples/clip/convert-pt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/examples/clip/model.py` & `ggml-python-0.0.9/examples/clip/model.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/examples/clip/utils.py` & `ggml-python-0.0.9/examples/clip/utils.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/examples/replit/README.md` & `ggml-python-0.0.9/examples/replit/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/examples/replit/app.py` & `ggml-python-0.0.9/examples/replit/app.py`

 * *Files 2% similar despite different names*

```diff
@@ -26,15 +26,15 @@
 import anyio
 from anyio.streams.memory import MemoryObjectSendStream
 from starlette.concurrency import run_in_threadpool, iterate_in_threadpool
 from fastapi import FastAPI, Request, Depends
 from pydantic import BaseModel, BaseSettings, Field, create_model_from_typeddict
 from sse_starlette.sse import EventSourceResponse
 
-from main import ReplitModel
+from main import ReplitModel, ReplitSentencepieceTokenizer
 
 
 ## Types
 class CompletionLogprobs(TypedDict):
     text_offset: List[int]
     token_logprobs: List[Optional[float]]
     tokens: List[str]
@@ -127,15 +127,15 @@
         stop = (
             stop if isinstance(stop, list) else [stop] if isinstance(stop, str) else []
         )
         model_name: str = model if model is not None else "replit-code-v1-3b"
 
         # Truncate prompt if it is too long
         max_tokens = min(
-            max_tokens, max(0, self.model.max_seq_len - len(prompt_tokens))
+            max_tokens, max(0, self.model.max_seq_len - len(prompt_tokens) - 1)
         )
         if len(prompt_tokens) + max_tokens > self.model.max_seq_len:
             raise ValueError(
                 f"Requested tokens exceed context window of {self.model.max_seq_len}"
             )
 
         stop_sequences = stop if stop != [] else []
@@ -464,14 +464,15 @@
 
 
 class Settings(BaseSettings):
     model_file: str
     n_gpu_layers: int = 32
     n_batch: int = 2048
     n_threads: int = max(multiprocessing.cpu_count() // 2, 1)
+    sentencepiece_model: Optional[str] = None
 
 
 class CreateCompletionRequest(BaseModel):
     prompt: Union[str, List[str]] = Field(
         default="", description="The prompt to generate completions for."
     )
     suffix: Optional[str] = Field(
@@ -577,17 +578,19 @@
 let g:copilot_strict_ssl = 0
 ```
 """,
 )
 outer_lock = Lock()
 inner_lock = Lock()
 
+tokenizer = ReplitSentencepieceTokenizer(settings.sentencepiece_model) if settings.sentencepiece_model else None
+
 model = OpenAIify(
     ReplitModel.init_from_file(
-        model_file=settings.model_file, n_gpu_layers=settings.n_gpu_layers
+        model_file=settings.model_file, n_gpu_layers=settings.n_gpu_layers, tokenizer=tokenizer
     ),
     # check if any other requests are pending in the same thread and cancel the stream if so
     cancel_callback=lambda: outer_lock.locked(),
 )
 
 
 def get_model():
```

### Comparing `ggml-python-0.0.8/examples/replit/main.py` & `ggml-python-0.0.9/examples/replit/main.py`

 * *Files 1% similar despite different names*

```diff
@@ -474,15 +474,15 @@
             # offload_func(cur)
             ggml.ggml_set_name(cur, b"norm_0")
             cur = ggml.ggml_mul(
                 ctx0,
                 ggml.ggml_repeat(ctx0, self.layers[il].norm_1_weight, cur),
                 cur,
             )
-            # offload_func(cur)
+            offload_func(cur)
             ggml.ggml_set_name(cur, b"attention_norm_0")
 
             # // self-attention
             # //  b, _, past_key_value = self.attn(a, past_key_value=past_key_value,
             # //  attn_bias=attn_bias, attention_mask=attention_mask,
             # //  is_causal=is_causal)
 
@@ -727,15 +727,15 @@
             # // lctx.use_buf(ctx0, 1)
 
             inpL = ggml.ggml_add(
                 ctx0,
                 inpL,
                 cur,
             )
-            # offload_func(cur)
+            offload_func(cur)
             ggml.ggml_set_name(cur, b"inpFF")
 
             # // m = self.ln_2(x)
             cur = ggml.ggml_norm(ctx0, inpL)
             # offload_func(cur)
             ggml.ggml_set_name(cur, b"norm_1")
             cur = ggml.ggml_mul(
@@ -748,41 +748,41 @@
 
             # // n = self.mlp(m)
             cur = ggml.ggml_mul_mat(
                 ctx0,
                 self.layers[il].c_ffn_up_proj_weight,
                 cur,
             )
-            # offload_func(cur)
+            offload_func(cur)
             ggml.ggml_set_name(cur, b"result_mlp_up")
 
             # // GELU activation
-            cur = ggml.ggml_gelu_quick(
+            cur = ggml.ggml_gelu(
                 ctx0,
                 cur,
             )
-            # offload_func(cur)
+            offload_func(cur)
             ggml.ggml_set_name(cur, b"gelu")
             # // projection
             # // cur = proj_w*cur + proj_b
             cur = ggml.ggml_mul_mat(
                 ctx0,
                 self.layers[il].c_ffn_down_proj_weight,
                 cur,
             )
-            # offload_func(cur)
+            offload_func(cur)
             ggml.ggml_set_name(cur, b"result_mlp_down")
 
             # // x = x + n
             inpL = ggml.ggml_add(
                 ctx0,
                 inpL,
                 cur,
             )
-            # offload_func(cur)
+            offload_func(cur)
             ggml.ggml_set_name(cur, b"inpFF_+_result_mlp_down")
 
         # // lctx.use_buf(ctx0, 0)
 
         # // norm
         inpL = ggml.ggml_norm(ctx0, inpL)
         # offload_func_nr(inpL)
@@ -790,15 +790,15 @@
 
         # // inpL = ln_f_g*inpL
         inpL = ggml.ggml_mul(
             ctx0,
             ggml.ggml_repeat(ctx0, self.norm_f_weight, inpL),
             inpL,
         )
-        # offload_func_nr(inpL)
+        offload_func_nr(inpL)
         ggml.ggml_set_name(inpL, b"norm_f_mul")
 
         # // output embedding weight tied to input embedding
         inpL = ggml.ggml_mul_mat(
             ctx0,
             self.wte_weight,
             inpL,
@@ -904,14 +904,15 @@
 
     @staticmethod
     def init_from_file(
         model_file: str,
         n_gpu_layers: int = 0,
         n_batch: int = 1,
         n_threads: int = 1,
+        tokenizer: Optional[Tokenizer] = None,
         verbose: bool = True,
     ) -> ReplitModel:
         with open(model_file, "rb") as fin:
             # Magic Number
             (magic,) = struct.unpack("i", (fin.read(struct.calcsize("i"))))
             assert magic == ggml.GGML_FILE_MAGIC
             if verbose:
@@ -975,15 +976,15 @@
                 max_seq_len=max_seq_len,
                 n_heads=n_heads,
                 n_layers=n_layers,
                 vocab_size=vocab_size,
                 ftype=ftype,
                 # vocabulary
                 vocab=vocab,
-                tokenizer=ReplitTokenizer(vocab),
+                tokenizer=ReplitTokenizer(vocab) if tokenizer is None else tokenizer,
                 ctx=ctx,
                 n_batch=n_batch,
                 n_threads=n_threads,
                 weights_buffer=weights_buffer,
             )
 
             n_tensors = 0
@@ -1024,19 +1025,19 @@
                     (ctypes.c_uint8 * ggml.ggml_nbytes(tensor)).from_address(
                         ggml.ggml_get_data(tensor)
                     )
                 )
                 if ggml.GGML_USE_CUBLAS and name.startswith("transformer.block"):
                     should_offload_suffix = [
                         # "norm_1.weight",
-                        # "attn.Wqkv.weight",
-                        # "attn.out_proj.weight",
+                        "attn.Wqkv.weight",
+                        "attn.out_proj.weight",
                         # "norm_2.weight",
-                        # "ffn.up_proj.weight",
-                        # "ffn.down_proj.weight",
+                        "ffn.up_proj.weight",
+                        "ffn.down_proj.weight",
                     ]
                     if any(name.endswith(s) for s in should_offload_suffix):
                         tensor.contents.backend = ggml.GGML_BACKEND_GPU
                         ggml.ggml_cuda_transform_tensor(tensor.contents.data, tensor)
                 if ggml.GGML_USE_CUBLAS and name.startswith("transformer.block"):
                     if (
                         name == "transformer.wte.weight"
```

### Comparing `ggml-python-0.0.8/examples/replit/recording.svg` & `ggml-python-0.0.9/examples/replit/recording.svg`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/ggml/experimental.py` & `ggml-python-0.0.9/ggml/experimental.py`

 * *Files 8% similar despite different names*

```diff
@@ -24,15 +24,15 @@
     def __init__(
         self,
         mem_size: int = 16 * 1024 * 1024,
         mem_buffer: Optional[ctypes.c_void_p] = None,
         no_alloc: bool = False,
     ):
         self.mem_size = mem_size
-        self.mem_buffer = mem_buffer # NOTE: DO NOT REMOVE THIS
+        self.mem_buffer = mem_buffer  # NOTE: DO NOT REMOVE THIS
         self.no_alloc = no_alloc
         self.params = ggml.ggml_init_params(
             mem_size=self.mem_size,
             mem_buffer=self.mem_buffer,
             no_alloc=self.no_alloc,
         )
 
@@ -81,15 +81,15 @@
     MOSTLY_Q5_0 = ggml.GGML_FTYPE_MOSTLY_Q5_0
     MOSTLY_Q5_1 = ggml.GGML_FTYPE_MOSTLY_Q5_1
 
 
 class Tensor:
     def __init__(
         self,
-        tensor,  # type: ctypes._Pointer[ggml.ggml_tensor] # type: ignore
+        tensor: ggml.ggml_tensor_p,
         ctx: Optional[Context] = None,
     ):
         self.tensor = tensor
         self.ctx = ctx or default_context()
 
     def nelements(self):
         return ggml.ggml_nelements(self.tensor)
@@ -157,16 +157,16 @@
     @classmethod
     def with_shape(
         cls, shape: Sequence[int], ggml_type: GGML_TYPE, ctx: Optional[Context] = None
     ):
         ctx = ctx or default_context()
         tensor = ggml.ggml_new_tensor(
             ctx.context,
-            ctypes.c_int(ggml_type.value),
-            ctypes.c_int(len(shape)),
+            ggml_type.value,
+            len(shape),
             (ctypes.c_int64 * len(shape))(*shape),
         )
         return cls(tensor=tensor, ctx=ctx)
 
     @classmethod
     def from_numpy(cls, x: npt.NDArray[Any], ctx: Optional[Context] = None):
         ctx = ctx or default_context()
@@ -178,65 +178,65 @@
         ggml_type: GGML_TYPE = GGML_TYPE.F32,
         shape: Sequence[int] = (),
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         tensor = ggml.ggml_new_tensor(
             ctx.context,
-            ctypes.c_int(ggml_type.value),
-            ctypes.c_int(len(shape)),
+            ggml_type.value,
+            len(shape),
             (ctypes.c_int64 * len(shape))(*shape),
         )
         return Tensor(tensor=tensor, ctx=ctx)
 
     @staticmethod
     def new_tensor_1d(
         ggml_type: GGML_TYPE = GGML_TYPE.F32,
         ne0: int = 0,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         tensor = ggml.ggml_new_tensor_1d(
             ctx.context,
-            ctypes.c_int(ggml_type.value),
-            ctypes.c_int64(ne0),
+            ggml_type.value,
+            ne0,
         )
         return Tensor(tensor=tensor, ctx=ctx)
 
     @staticmethod
     def new_tensor_2d(
         ggml_type: GGML_TYPE = GGML_TYPE.F32,
         ne0: int = 0,
         ne1: int = 0,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         tensor = ggml.ggml_new_tensor_2d(
             ctx.context,
-            ctypes.c_int(ggml_type.value),
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
+            ggml_type.value,
+            ne0,
+            ne1,
         )
         return Tensor(tensor=tensor, ctx=ctx)
 
     @staticmethod
     def new_tensor_3d(
         ggml_type: GGML_TYPE = GGML_TYPE.F32,
         ne0: int = 0,
         ne1: int = 0,
         ne2: int = 0,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         tensor = ggml.ggml_new_tensor_3d(
             ctx.context,
-            ctypes.c_int(ggml_type.value),
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
-            ctypes.c_int64(ne2),
+            ggml_type.value,
+            ne0,
+            ne1,
+            ne2,
         )
         return Tensor(tensor=tensor, ctx=ctx)
 
     @staticmethod
     def new_tensor_4d(
         ggml_type: GGML_TYPE = GGML_TYPE.F32,
         ne0: int = 0,
@@ -244,38 +244,38 @@
         ne2: int = 0,
         ne3: int = 0,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         tensor = ggml.ggml_new_tensor_4d(
             ctx.context,
-            ctypes.c_int(ggml_type.value),
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
-            ctypes.c_int64(ne2),
-            ctypes.c_int64(ne3),
+            ggml_type.value,
+            ne0,
+            ne1,
+            ne2,
+            ne3,
         )
         return Tensor(tensor=tensor, ctx=ctx)
 
     @staticmethod
     def new_i32(
         value: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
-        tensor = ggml.ggml_new_i32(ctx.context, ctypes.c_int32(value))
+        tensor = ggml.ggml_new_i32(ctx.context, value)
         return Tensor(tensor=tensor, ctx=ctx)
 
     @staticmethod
     def new_f32(
         value: float,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
-        tensor = ggml.ggml_new_f32(ctx.context, ctypes.c_float(value))
+        tensor = ggml.ggml_new_f32(ctx.context, value)
         return Tensor(tensor=tensor, ctx=ctx)
 
     @staticmethod
     def dup_tensor(a: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         op = ggml.ggml_dup_tensor(ctx.context, a.tensor)
         return Tensor(tensor=op, ctx=ctx)
@@ -289,33 +289,33 @@
     @staticmethod
     def set_zero(a: Tensor):
         op = ggml.ggml_set_zero(a.tensor)
         return Tensor(tensor=op, ctx=a.ctx)
 
     @staticmethod
     def set_i32(a: Tensor, value: int):
-        op = ggml.ggml_set_i32(a.tensor, ctypes.c_int32(value))
+        op = ggml.ggml_set_i32(a.tensor, value)
         return Tensor(tensor=op, ctx=a.ctx)
 
     @staticmethod
     def get_i32_1d(a: Tensor, i: int):
-        return ggml.ggml_get_i32_1d(a.tensor, ctypes.c_int(i))
+        return ggml.ggml_get_i32_1d(a.tensor, i)
 
     @staticmethod
     def set_f32(a: Tensor, i: int, value: float):
-        op = ggml.ggml_set_f32_1d(a.tensor, ctypes.c_int(i), ctypes.c_float(value))
+        op = ggml.ggml_set_f32_1d(a.tensor, i, value)
         return Tensor(tensor=op, ctx=a.ctx)
 
     @staticmethod
     def get_f32_1d(a: Tensor, i: int):
-        return ggml.ggml_get_f32_1d(a.tensor, ctypes.c_int(i))
+        return ggml.ggml_get_f32_1d(a.tensor, i)
 
     @staticmethod
     def set_f32_1d(a: Tensor, i: int, value: float):
-        op = ggml.ggml_set_f32_1d(a.tensor, ctypes.c_int(i), ctypes.c_float(value))
+        op = ggml.ggml_set_f32_1d(a.tensor, i, value)
         return Tensor(tensor=op, ctx=a.ctx)
 
     @staticmethod
     def get_data(a: Tensor):
         return ggml.ggml_get_data(a.tensor)
 
     @staticmethod
@@ -365,18 +365,18 @@
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_acc(
             ctx.context,
             a.tensor,
             b.tensor,
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(nb2),
-            ctypes.c_size_t(nb3),
-            ctypes.c_size_t(offset),
+            nb1,
+            nb2,
+            nb3,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def acc_inplace(
         a: Tensor,
         b: Tensor,
@@ -387,18 +387,18 @@
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_acc_inplace(
             ctx.context,
             a.tensor,
             b.tensor,
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(nb2),
-            ctypes.c_size_t(nb3),
-            ctypes.c_size_t(offset),
+            nb1,
+            nb2,
+            nb3,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def sub(a: Tensor, b: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         op = ggml.ggml_sub(ctx.context, a.tensor, b.tensor)
@@ -559,18 +559,18 @@
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_set(
             ctx.context,
             a.tensor,
             b.tensor,
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(nb2),
-            ctypes.c_size_t(nb3),
-            ctypes.c_size_t(offset),
+            nb1,
+            nb2,
+            nb3,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def set_inplace(
         a: Tensor,
         b: Tensor,
@@ -581,35 +581,33 @@
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_set_inplace(
             ctx.context,
             a.tensor,
             b.tensor,
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(nb2),
-            ctypes.c_size_t(nb3),
-            ctypes.c_size_t(offset),
+            nb1,
+            nb2,
+            nb3,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def set_1d(a: Tensor, b: Tensor, offset: int, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_set_1d(ctx.context, a.tensor, b.tensor, ctypes.c_size_t(offset))
+        op = ggml.ggml_set_1d(ctx.context, a.tensor, b.tensor, offset)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def set_1d_inplace(
         a: Tensor, b: Tensor, offset: int, ctx: Optional[Context] = None
     ):
         ctx = ctx or default_context()
-        op = ggml.ggml_set_1d_inplace(
-            ctx.context, a.tensor, b.tensor, ctypes.c_size_t(offset)
-        )
+        op = ggml.ggml_set_1d_inplace(ctx.context, a.tensor, b.tensor, offset)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def set_2d(
         a: Tensor,
         b: Tensor,
         nb1: int,
@@ -617,16 +615,16 @@
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_set_2d(
             ctx.context,
             a.tensor,
             b.tensor,
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(offset),
+            nb1,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def set_2d_inplace(
         a: Tensor,
         b: Tensor,
@@ -635,16 +633,16 @@
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_set_2d_inplace(
             ctx.context,
             a.tensor,
             b.tensor,
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(offset),
+            nb1,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def cpy(a: Tensor, b: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         op = ggml.ggml_cpy(ctx.context, a.tensor, b.tensor)
@@ -661,36 +659,34 @@
         ctx = ctx or default_context()
         op = ggml.ggml_reshape(ctx.context, a.tensor, b.tensor)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def reshape_1d(a: Tensor, ne0: int, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_reshape_1d(ctx.context, a.tensor, ctypes.c_int64(ne0))
+        op = ggml.ggml_reshape_1d(ctx.context, a.tensor, ne0)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def reshape_2d(a: Tensor, ne0: int, ne1: int, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_reshape_2d(
-            ctx.context, a.tensor, ctypes.c_int64(ne0), ctypes.c_int64(ne1)
-        )
+        op = ggml.ggml_reshape_2d(ctx.context, a.tensor, ne0, ne1)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def reshape_3d(
         a: Tensor, ne0: int, ne1: int, ne2: int, ctx: Optional[Context] = None
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_reshape_3d(
             ctx.context,
             a.tensor,
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
-            ctypes.c_int64(ne2),
+            ne0,
+            ne1,
+            ne2,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def reshape_4d(
         a: Tensor,
         ne0: int,
@@ -699,32 +695,30 @@
         ne3: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_reshape_4d(
             ctx.context,
             a.tensor,
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
-            ctypes.c_int64(ne2),
-            ctypes.c_int64(ne3),
+            ne0,
+            ne1,
+            ne2,
+            ne3,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def view_1d(
         a: Tensor,
         ne0: int,
         offset: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
-        op = ggml.ggml_view_1d(
-            ctx.context, a.tensor, ctypes.c_int64(ne0), ctypes.c_size_t(offset)
-        )
+        op = ggml.ggml_view_1d(ctx.context, a.tensor, ne0, offset)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def view_2d(
         a: Tensor,
         ne0: int,
         ne1: int,
@@ -732,18 +726,18 @@
         offset: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_view_2d(
             ctx.context,
             a.tensor,
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(offset),
+            ne0,
+            ne1,
+            nb1,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def view_3d(
         a: Tensor,
         ne0: int,
@@ -754,20 +748,20 @@
         offset: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_view_3d(
             ctx.context,
             a.tensor,
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
-            ctypes.c_int64(ne2),
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(nb2),
-            ctypes.c_size_t(offset),
+            ne0,
+            ne1,
+            ne2,
+            nb1,
+            nb2,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def view_4d(
         a: Tensor,
         ne0: int,
@@ -780,22 +774,22 @@
         offset: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_view_4d(
             ctx.context,
             a.tensor,
-            ctypes.c_int64(ne0),
-            ctypes.c_int64(ne1),
-            ctypes.c_int64(ne2),
-            ctypes.c_int64(ne3),
-            ctypes.c_size_t(nb1),
-            ctypes.c_size_t(nb2),
-            ctypes.c_size_t(nb3),
-            ctypes.c_size_t(offset),
+            ne0,
+            ne1,
+            ne2,
+            ne3,
+            nb1,
+            nb2,
+            nb3,
+            offset,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def permute(
         a: Tensor,
         axis0: int,
@@ -804,18 +798,18 @@
         axis3: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_permute(
             ctx.context,
             a.tensor,
-            ctypes.c_int(axis0),
-            ctypes.c_int(axis1),
-            ctypes.c_int(axis2),
-            ctypes.c_int(axis3),
+            axis0,
+            axis1,
+            axis2,
+            axis3,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def transpose(a: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         op = ggml.ggml_transpose(ctx.context, a.tensor)
@@ -838,37 +832,33 @@
         ctx = ctx or default_context()
         op = ggml.ggml_diag(ctx.context, a.tensor)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def diag_mask_inf(a: Tensor, n_past: int, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_diag_mask_inf(ctx.context, a.tensor, ctypes.c_int(n_past))
+        op = ggml.ggml_diag_mask_inf(ctx.context, a.tensor, n_past)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def diag_mask_inf_inplace(a: Tensor, n_past: int, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_diag_mask_inf_inplace(
-            ctx.context, a.tensor, ctypes.c_int(n_past)
-        )
+        op = ggml.ggml_diag_mask_inf_inplace(ctx.context, a.tensor, n_past)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def diag_mask_zero(a: Tensor, n_past: int, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_diag_mask_zero(ctx.context, a.tensor, ctypes.c_int(n_past))
+        op = ggml.ggml_diag_mask_zero(ctx.context, a.tensor, n_past)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def diag_mask_zero_inplace(a: Tensor, n_past: int, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_diag_mask_zero_inplace(
-            ctx.context, a.tensor, ctypes.c_int(n_past)
-        )
+        op = ggml.ggml_diag_mask_zero_inplace(ctx.context, a.tensor, n_past)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def soft_max(a: Tensor, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
         op = ggml.ggml_soft_max(ctx.context, a.tensor)
         return Tensor(tensor=op, ctx=ctx)
@@ -881,59 +871,56 @@
 
     @staticmethod
     def rope(
         a: Tensor,
         n_past: int,
         n_dims: int,
         mode: int,
+        n_ctx: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_rope(
             ctx.context,
             a.tensor,
-            ctypes.c_int(n_past),
-            ctypes.c_int(n_dims),
-            ctypes.c_int(mode),
+            n_past,
+            n_dims,
+            mode,
+            n_ctx,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def rope_inplace(
         a: Tensor,
         n_past: int,
         n_dims: int,
         mode: int,
+        n_ctx: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
-        op = ggml.ggml_rope_inplace(
-            ctx.context,
-            a.tensor,
-            ctypes.c_int(n_past),
-            ctypes.c_int(n_dims),
-            ctypes.c_int(mode),
-        )
+        op = ggml.ggml_rope_inplace(ctx.context, a.tensor, n_past, n_dims, mode, n_ctx)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def rope_back(
         a: Tensor,
         n_past: int,
         n_dims: int,
         mode: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_rope_back(
             ctx.context,
             a.tensor,
-            ctypes.c_int(n_past),
-            ctypes.c_int(n_dims),
-            ctypes.c_int(mode),
+            n_past,
+            n_dims,
+            mode,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def alibi(
         a: Tensor,
         n_past: int,
@@ -941,52 +928,53 @@
         bias_max: float,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
         op = ggml.ggml_alibi(
             ctx.context,
             a.tensor,
-            ctypes.c_int(n_past),
-            ctypes.c_int(n_head),
-            ctypes.c_float(bias_max),
+            n_past,
+            n_head,
+            bias_max,
         )
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def clamp(a: Tensor, min: float, max: float, ctx: Optional[Context] = None):
         ctx = ctx or default_context()
-        op = ggml.ggml_clamp(
-            ctx.context, a.tensor, ctypes.c_float(min), ctypes.c_float(max)
-        )
+        op = ggml.ggml_clamp(ctx.context, a.tensor, min, max)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
-    def conv_1d_s1_ph(
+    def conv_1d(
         a: Tensor,
         b: Tensor,
+        s0: int,
+        p0: int,
+        d0: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
-        op = ggml.ggml_conv_1d_s1_ph(ctx.context, a.tensor, b.tensor)
+        op = ggml.ggml_conv_1d(ctx.context, a.tensor, b.tensor, s0, p0, d0)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
-    def conv_2d_sk_p0(a: Tensor, b: Tensor, ctx: Optional[Context] = None):
-        ctx = ctx or default_context()
-        op = ggml.ggml_conv_2d_sk_p0(ctx.context, a.tensor, b.tensor)
-        return Tensor(tensor=op, ctx=ctx)
-
-    @staticmethod
-    def conv_1d_s2_ph(
+    def conv_2d(
         a: Tensor,
         b: Tensor,
+        s0: int,
+        s1: int,
+        p0: int,
+        p1: int,
+        d0: int,
+        d1: int,
         ctx: Optional[Context] = None,
     ):
         ctx = ctx or default_context()
-        op = ggml.ggml_conv_1d_s2_ph(ctx.context, a.tensor, b.tensor)
+        op = ggml.ggml_conv_2d(ctx.context, a.tensor, b.tensor, s0, s1, p0, p1, d0, d1)
         return Tensor(tensor=op, ctx=ctx)
 
     @staticmethod
     def flash_attn(
         q: Tensor,
         k: Tensor,
         v: Tensor,
@@ -1064,15 +1052,17 @@
 
 class CGraph:
     def __init__(self, cgraph: ggml.ggml_cgraph, ctx: Optional[Context] = None):
         self.cgraph = cgraph
         self.ctx = ctx or default_context()
 
     def compute(self, n_threads: int = 1):
-        ggml.ggml_graph_compute_with_ctx(self.ctx.context, ctypes.pointer(self.cgraph), n_threads=n_threads)
+        ggml.ggml_graph_compute_with_ctx(
+            self.ctx.context, ctypes.pointer(self.cgraph), n_threads=n_threads
+        )
 
     def reset(self):
         ggml.ggml_graph_reset(ctypes.pointer(self.cgraph))
 
     def get_tensor(self, name: bytes):
         return Tensor(
             tensor=ggml.ggml_graph_get_tensor(ctypes.pointer(self.cgraph), name),
```

### Comparing `ggml-python-0.0.8/ggml/ggml.py` & `ggml-python-0.0.9/ggml/ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/ggml/utils.py` & `ggml-python-0.0.9/ggml/utils.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/mkdocs.yml` & `ggml-python-0.0.9/mkdocs.yml`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/pyproject.toml` & `ggml-python-0.0.9/pyproject.toml`

 * *Files 7% similar despite different names*

```diff
@@ -4,15 +4,15 @@
     "cmake>=3.18",
     "ninja",
 ]
 build-backend = "scikit_build_core.build"
 
 [project]
 name = "ggml_python"
-version = "0.0.8"
+version = "0.0.9"
 description = "Python bindings for ggml"
 readme = "README.md"
 license = { text = "MIT" }
 authors = [
     { name = "Andrei Betlen", email = "abetlen@gmail.com" },
 ]
 requires-python = ">=3.7"
```

### Comparing `ggml-python-0.0.8/tests/test_experimental.py` & `ggml-python-0.0.9/tests/test_experimental.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/tests/test_ggml.py` & `ggml-python-0.0.9/tests/test_ggml.py`

 * *Files 0% similar despite different names*

```diff
@@ -78,15 +78,17 @@
     leafs_size = sum(ggml.ggml_nbytes(gf.leafs[i]) for i in range(n_leafs))
 
     ggml.ggml_free(ctx)
 
     assert n_nodes == 3  # 3 nodes: mul, mul, add
     assert n_leafs == 3  # 3 leafs: x, a, b
 
-    mem_size = nodes_size + leafs_size + overhead * (n_nodes + n_leafs + 1) # TODO: why +1?
+    mem_size = (
+        nodes_size + leafs_size + overhead * (n_nodes + n_leafs + 1)
+    )  # TODO: why +1?
     params = ggml.ggml_init_params(mem_size=mem_size, mem_buffer=None)
     ctx = ggml.ggml_init(params=params)
     gf = build_graph(ctx)
 
     a = ggml.ggml_get_tensor(ctx, b"a")
     b = ggml.ggml_get_tensor(ctx, b"b")
     x = ggml.ggml_get_tensor(ctx, b"x")
```

### Comparing `ggml-python-0.0.8/tests/test_ggml_cuda.py` & `ggml-python-0.0.9/tests/test_ggml_cuda.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/tests/test_utils.py` & `ggml-python-0.0.9/tests/test_utils.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/.github/workflows/ci.yml` & `ggml-python-0.0.9/vendor/ggml/.github/workflows/ci.yml`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/LICENSE` & `ggml-python-0.0.9/vendor/ggml/LICENSE`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/README.md` & `ggml-python-0.0.9/vendor/ggml/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/build.zig` & `ggml-python-0.0.9/vendor/ggml/build.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/cmake/BuildTypes.cmake` & `ggml-python-0.0.9/vendor/ggml/cmake/BuildTypes.cmake`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/cmake/GitVars.cmake` & `ggml-python-0.0.9/vendor/ggml/cmake/GitVars.cmake`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml/examples/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/common-ggml.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/common-ggml.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/common.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/common.cpp`

 * *Files 1% similar despite different names*

```diff
@@ -25,14 +25,16 @@
     for (int i = 1; i < argc; i++) {
         std::string arg = argv[i];
 
         if (arg == "-s" || arg == "--seed") {
             params.seed = std::stoi(argv[++i]);
         } else if (arg == "-t" || arg == "--threads") {
             params.n_threads = std::stoi(argv[++i]);
+        } else if (arg == "-ngl" || arg == "--gpu-layers" || arg == "--n-gpu-layers") {
+            params.n_gpu_layers = std::stoi(argv[++i]);
         } else if (arg == "-p" || arg == "--prompt") {
             params.prompt = argv[++i];
         } else if (arg == "-n" || arg == "--n_predict") {
             params.n_predict = std::stoi(argv[++i]);
         } else if (arg == "--top_k") {
             params.top_k = std::max(1, std::stoi(argv[++i]));
         } else if (arg == "--top_p") {
@@ -85,14 +87,15 @@
 void gpt_print_usage(int /*argc*/, char ** argv, const gpt_params & params) {
     fprintf(stderr, "usage: %s [options]\n", argv[0]);
     fprintf(stderr, "\n");
     fprintf(stderr, "options:\n");
     fprintf(stderr, "  -h, --help            show this help message and exit\n");
     fprintf(stderr, "  -s SEED, --seed SEED  RNG seed (default: -1)\n");
     fprintf(stderr, "  -t N, --threads N     number of threads to use during computation (default: %d)\n", params.n_threads);
+    fprintf(stderr, "  -ngl N, --gpu-layers N  number of layers to offload to GPU on supported models (default: %d)\n", params.n_gpu_layers);
     fprintf(stderr, "  -p PROMPT, --prompt PROMPT\n");
     fprintf(stderr, "                        prompt to start generation with (default: random)\n");
     fprintf(stderr, "  -f FNAME, --file FNAME\n");
     fprintf(stderr, "                        load prompt from a file\n");
     fprintf(stderr, "  -tt TOKEN_TEST, --token_test TOKEN_TEST\n");
     fprintf(stderr, "                        test tokenization\n");
     fprintf(stderr, "  -n N, --n_predict N   number of tokens to predict (default: %d)\n", params.n_predict);
```

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/common.h` & `ggml-python-0.0.9/vendor/ggml/examples/common.h`

 * *Files 2% similar despite different names*

```diff
@@ -29,14 +29,16 @@
 
     std::string model      = "models/gpt-2-117M/ggml-model.bin"; // model path
     std::string prompt     = "";
     std::string token_test = "";
 
     bool    interactive      = false;
     int32_t interactive_port = -1;
+
+    int32_t n_gpu_layers     = 0;
 };
 
 bool gpt_params_parse(int argc, char ** argv, gpt_params & params);
 
 void gpt_print_usage(int argc, char ** argv, const gpt_params & params);
 
 std::string gpt_random_prompt(std::mt19937 & rng);
```

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/dolly-v2/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/dolly-v2/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/dr_wav.h` & `ggml-python-0.0.9/vendor/ggml/examples/dr_wav.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/convert-cerebras-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/convert-ckpt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-ggml-model.sh` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/download-model.sh` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-2/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-2/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-j/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-j/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-ggml-model.sh` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-j/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/download-model.sh` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-j/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-j/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-j/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-j/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/gpt-neox/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/gpt-neox/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/main-cpu.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/main-cpu.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/main-mtl.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/main-mtl.m` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/main-mtl.m`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mnist/web/index.html` & `ggml-python-0.0.9/vendor/ggml/examples/mnist/web/index.html`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mpt/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/mpt/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mpt/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/mpt/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mpt/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/mpt/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/mpt/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/mpt/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/dolly-v2.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/dolly-v2.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-2.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-2.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-j.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-j.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/gpt-neox.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/gpt-neox.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/replit.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/replit.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/starcoder.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/starcoder.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/test-cases.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/test-cases.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/tokenize_huggingface.py` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/tokenize_huggingface.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/prompts/whisper.txt` & `ggml-python-0.0.9/vendor/ggml/examples/prompts/whisper.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/replit/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/replit/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/replit/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/replit/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/replit/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/replit/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/starcoder/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/starcoder/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/starcoder/convert-hf-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/starcoder/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/starcoder/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/starcoder/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/starcoder/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/whisper/README.md` & `ggml-python-0.0.9/vendor/ggml/examples/whisper/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/whisper/convert-pt-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml/examples/whisper/convert-pt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/whisper/main.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/whisper/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/whisper/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/whisper/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/whisper/whisper.cpp` & `ggml-python-0.0.9/vendor/ggml/examples/whisper/whisper.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/examples/whisper/whisper.h` & `ggml-python-0.0.9/vendor/ggml/examples/whisper/whisper.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/include/ggml/ggml.h` & `ggml-python-0.0.9/vendor/ggml/include/ggml/ggml.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/scripts/sync-llama.sh` & `ggml-python-0.0.9/vendor/ggml/scripts/sync-llama.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/scripts/sync-whisper.sh` & `ggml-python-0.0.9/vendor/ggml/scripts/sync-whisper.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/src/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml/src/CMakeLists.txt`

 * *Files 0% similar despite different names*

```diff
@@ -251,15 +251,15 @@
     target_link_libraries(${TARGET} PUBLIC
         stdc++
         )
 endif()
 
 if (GGML_CUDA_SOURCES)
     message(STATUS "GGML CUDA sources found, configuring CUDA architecture")
-    set_property(TARGET ggml  PROPERTY CUDA_ARCHITECTURES OFF)
+    set_property(TARGET ggml  PROPERTY CUDA_ARCHITECTURES "52;61")
     set_property(TARGET ggml  PROPERTY CUDA_SELECT_NVCC_ARCH_FLAGS "Auto")
     target_link_libraries(ggml PUBLIC stdc++)
 endif()
 
 set (GGML_PUBLIC_HEADERS ${CMAKE_CURRENT_SOURCE_DIR}/../include/ggml/ggml.h)
 set_target_properties(${TARGET} PROPERTIES
                       PUBLIC_HEADER "${GGML_PUBLIC_HEADERS}")
```

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml-cuda.cu` & `ggml-python-0.0.9/vendor/ggml/src/ggml-cuda.cu`

 * *Files 1% similar despite different names*

```diff
@@ -263,18 +263,17 @@
 
     if (i >= kx) {
         return;
     }
     dst[i] = x[i] * y[i%ky];
 }
 
-static const float GELU_COEF_A    = 0.044715f;
-static const float SQRT_2_OVER_PI = 0.79788456080286535587989211986876f;
-
 static __global__ void gelu_f32(const float * x, float * dst, const int k) {
+    const float GELU_COEF_A    = 0.044715f;
+    const float SQRT_2_OVER_PI = 0.79788456080286535587989211986876f;
     const int i = blockDim.x*blockIdx.x + threadIdx.x;
 
     if (i >= k) {
         return;
     }
 
     float xi = x[i];
@@ -1664,14 +1663,48 @@
     const float x0 = x[i + 0];
     const float x1 = x[i + 1];
 
     dst[i + 0] = x0*cos_theta - x1*sin_theta;
     dst[i + 1] = x0*sin_theta + x1*cos_theta;
 }
 
+static __global__ void rope_glm_f32(const float * x, float * dst, const int ncols, const float p, const float block_p, const float theta_scale) {
+    const int col = blockDim.x*blockIdx.x + threadIdx.x;
+    const int half_n_dims = ncols/4;
+
+    if (col >= half_n_dims) {
+        return;
+    }
+
+    const int row = blockDim.y*blockIdx.y + threadIdx.y;
+    const int i = row*ncols + col;
+
+    const float col_theta_scale = powf(theta_scale, col);
+
+    const float theta = p*col_theta_scale;
+    const float sin_theta = sinf(theta);
+    const float cos_theta = cosf(theta);
+
+    const float x0 = x[i + 0];
+    const float x1 = x[i + half_n_dims];
+
+    dst[i + 0]           = x0*cos_theta - x1*sin_theta;
+    dst[i + half_n_dims] = x0*sin_theta + x1*cos_theta;
+
+    const float block_theta = block_p*col_theta_scale;
+    const float sin_block_theta = sinf(block_theta);
+    const float cos_block_theta = cosf(block_theta);
+
+    const float x2 = x[i + half_n_dims * 2];
+    const float x3 = x[i + half_n_dims * 3];
+
+    dst[i + half_n_dims * 2] = x2*cos_block_theta - x3*sin_block_theta;
+    dst[i + half_n_dims * 3] = x2*sin_block_theta + x3*cos_block_theta;
+}
+
 static __global__ void diag_mask_inf_f32(const float * x, float * dst, const int ncols, const int rows_per_channel, const int n_past) {
     const int col = blockDim.x*blockIdx.x + threadIdx.x;
     const int row = blockDim.y*blockIdx.y + threadIdx.y;
 
     if (col >= ncols) {
         return;
     }
@@ -2061,14 +2094,22 @@
     GGML_ASSERT(nrows % 2 == 0);
     const dim3 block_dims(2*CUDA_ROPE_BLOCK_SIZE, 1, 1);
     const int num_blocks_x = (ncols + 2*CUDA_ROPE_BLOCK_SIZE - 1) / (2*CUDA_ROPE_BLOCK_SIZE);
     const dim3 block_nums(num_blocks_x, nrows, 1);
     rope_f32<<<block_nums, block_dims, 0, stream>>>(x, dst, ncols, p, theta_scale);
 }
 
+static void rope_glm_f32_cuda(const float * x, float * dst, const int ncols, const int nrows, const float p, const float block_p, const float theta_scale, cudaStream_t stream) {
+    GGML_ASSERT(nrows % 4 == 0);
+    const dim3 block_dims(4*CUDA_ROPE_BLOCK_SIZE, 1, 1);
+    const int num_blocks_x = (ncols + 4*CUDA_ROPE_BLOCK_SIZE - 1) / (4*CUDA_ROPE_BLOCK_SIZE);
+    const dim3 block_nums(num_blocks_x, nrows, 1);
+    rope_glm_f32<<<block_nums, block_dims, 0, stream>>>(x, dst, ncols, p, block_p, theta_scale);
+}
+
 static void diag_mask_inf_f32_cuda(const float * x, float * dst, const int ncols_x, const int nrows_x, const int rows_per_channel, const int n_past, cudaStream_t stream) {
     const dim3 block_dims(CUDA_DIAG_MASK_INF_BLOCK_SIZE, 1, 1);
     const int block_num_x = (ncols_x + CUDA_DIAG_MASK_INF_BLOCK_SIZE - 1) / CUDA_DIAG_MASK_INF_BLOCK_SIZE;
     const dim3 block_nums(block_num_x, nrows_x, 1);
     diag_mask_inf_f32<<<block_nums, block_dims, 0, stream>>>(x, dst, ncols_x, rows_per_channel, n_past);
 }
 
@@ -2296,15 +2337,15 @@
 
     // TODO: support broadcasting
     GGML_ASSERT(ggml_nelements(src0) == ggml_nelements(src1));
 
     const int64_t ne00 = src0->ne[0];
     const int64_t i01_diff = i01_high - i01_low;
 
-    const int64_t ne10 = src1->ne[0];
+    // const int64_t ne10 = src1->ne[0];
 
     // compute
     if (src0->type == GGML_TYPE_F32 && dst->type == GGML_TYPE_F32) {
         add_f32_cuda(src0_ddf_i, src1_ddf_i, dst_ddf_i, ne00*i01_diff, cudaStream_main);
     } else if (src0->type == GGML_TYPE_F16 && dst->type == GGML_TYPE_F16) {
         add_f16_f32_f16_cuda((half *) src0_ddq_i, src1_ddf_i, (half *) dst_ddf_i, ne00*i01_diff, cudaStream_main);
     } else {
@@ -2615,21 +2656,29 @@
 
     const int64_t ne00 = src0->ne[0];
     const int64_t i01_diff = i01_high - i01_low;
 
     const int n_past = ((int32_t *) src1->data)[0];
     const int n_dims = ((int32_t *) src1->data)[1];
     const int mode   = ((int32_t *) src1->data)[2];
-    GGML_ASSERT(mode == 0);
+    const int n_ctx  = ((int32_t *) src1->data)[3];
 
     const float theta_scale = powf(10000.0, -2.0f/n_dims);
     const float p = ((mode & 1) == 0 ? n_past + i02 : i02);
 
+    bool is_glm = mode & 4;
+
     // compute
-    rope_f32_cuda(src0_ddf_i, dst_ddf_i, ne00, i01_diff, p, theta_scale, cudaStream_main);
+    if (is_glm) {
+        const float id_p = min(p, n_ctx - 2.f);
+        const float block_p = max(p - (n_ctx - 2.f), 0.f);
+        rope_glm_f32_cuda(src0_ddf_i, dst_ddf_i, ne00, i01_diff, id_p, block_p, theta_scale, cudaStream_main);
+    } else {
+        rope_f32_cuda(src0_ddf_i, dst_ddf_i, ne00, i01_diff, p, theta_scale, cudaStream_main);
+    }
 
     (void) dst;
     (void) src0_ddq_i;
     (void) src1_ddf_i;
     (void) i1;
 }
```

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml-cuda.h` & `ggml-python-0.0.9/vendor/ggml/src/ggml-cuda.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml-metal.h` & `ggml-python-0.0.9/vendor/ggml/src/ggml-metal.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml-metal.m` & `ggml-python-0.0.9/vendor/ggml/src/ggml-metal.m`

 * *Files 1% similar despite different names*

```diff
@@ -736,16 +736,15 @@
                                 [encoder setBytes:&nb10 length:sizeof(nb10) atIndex:10];
                                 [encoder setBytes:&nb11 length:sizeof(nb11) atIndex:11];
                                 [encoder setBytes:&nb12 length:sizeof(nb12) atIndex:12];
                                 [encoder setBytes:&ne0  length:sizeof(ne0)  atIndex:13];
                                 [encoder setBytes:&ne1  length:sizeof(ne1)  atIndex:14];
 
                                 if (src0t == GGML_TYPE_Q4_0 || src0t == GGML_TYPE_Q4_1) {
-                                    [encoder setThreadgroupMemoryLength:nth0*nth1*sizeof(float) atIndex:0];
-                                    [encoder dispatchThreadgroups:MTLSizeMake(ne01, ne11, 1) threadsPerThreadgroup:MTLSizeMake(nth0, nth1, 1)];
+                                    [encoder dispatchThreadgroups:MTLSizeMake((ne01 + 7) / 8, ne11, 1) threadsPerThreadgroup:MTLSizeMake(nth0, nth1, 1)];
                                 }
                                 else if (src0t == GGML_TYPE_Q2_K ||
                                          src0t == GGML_TYPE_Q3_K ||
                                          src0t == GGML_TYPE_Q4_K ||
                                          src0t == GGML_TYPE_Q5_K ||
                                          src0t == GGML_TYPE_Q6_K) {
                                     [encoder setThreadgroupMemoryLength:nth0*nth1*sizeof(float) atIndex:0];
```

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml-metal.metal` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-metal.metal`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml-opencl.cpp` & `ggml-python-0.0.9/vendor/ggml/src/ggml-opencl.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml-opencl.h` & `ggml-python-0.0.9/vendor/ggml/src/ggml-opencl.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/src/ggml.c` & `ggml-python-0.0.9/vendor/ggml/src/ggml.c`

 * *Files 0% similar despite different names*

```diff
@@ -21279,16758 +21279,16775 @@
 000531e0: 4c4f 4341 4c53 3b0a 0a20 2020 2063 6f6e  LOCALS;..    con
 000531f0: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
 00053200: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
 00053210: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
 00053220: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
 00053230: 636f 6e73 7420 656e 756d 2067 676d 6c5f  const enum ggml_
 00053240: 7479 7065 2074 7970 6520 3d20 7372 6330  type type = src0
-00053250: 2d3e 7479 7065 3b0a 0a20 2020 2067 676d  ->type;..    ggm
-00053260: 6c5f 7665 635f 646f 745f 7420 2020 2063  l_vec_dot_t    c
-00053270: 6f6e 7374 2076 6563 5f64 6f74 2020 2020  onst vec_dot    
-00053280: 2020 2020 2020 2020 2020 203d 2074 7970             = typ
-00053290: 655f 7472 6169 7473 5b74 7970 655d 2e76  e_traits[type].v
-000532a0: 6563 5f64 6f74 3b0a 2020 2020 656e 756d  ec_dot;.    enum
-000532b0: 2067 676d 6c5f 7479 7065 2020 2020 636f   ggml_type    co
-000532c0: 6e73 7420 7665 635f 646f 745f 7479 7065  nst vec_dot_type
-000532d0: 2020 2020 2020 2020 2020 3d20 7479 7065            = type
-000532e0: 5f74 7261 6974 735b 7479 7065 5d2e 7665  _traits[type].ve
-000532f0: 635f 646f 745f 7479 7065 3b0a 2020 2020  c_dot_type;.    
-00053300: 6767 6d6c 5f66 726f 6d5f 666c 6f61 745f  ggml_from_float_
-00053310: 7420 636f 6e73 7420 6672 6f6d 5f66 6c6f  t const from_flo
-00053320: 6174 5f74 6f5f 7665 635f 646f 7420 3d20  at_to_vec_dot = 
-00053330: 7479 7065 5f74 7261 6974 735b 7665 635f  type_traits[vec_
-00053340: 646f 745f 7479 7065 5d2e 6672 6f6d 5f66  dot_type].from_f
-00053350: 6c6f 6174 3b0a 0a20 2020 2047 474d 4c5f  loat;..    GGML_
-00053360: 4153 5345 5254 286e 6530 203d 3d20 6e65  ASSERT(ne0 == ne
-00053370: 3031 293b 0a20 2020 2047 474d 4c5f 4153  01);.    GGML_AS
-00053380: 5345 5254 286e 6531 203d 3d20 6e65 3131  SERT(ne1 == ne11
-00053390: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000533a0: 5254 286e 6532 203d 3d20 6e65 3132 293b  RT(ne2 == ne12);
-000533b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000533c0: 286e 6533 203d 3d20 6e65 3133 293b 0a0a  (ne3 == ne13);..
-000533d0: 2020 2020 2f2f 2077 6520 646f 6e27 7420      // we don't 
-000533e0: 7375 7070 6f72 7420 7065 726d 7574 6564  support permuted
-000533f0: 2073 7263 3020 6f72 2073 7263 310a 2020   src0 or src1.  
-00053400: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-00053410: 3030 203d 3d20 4747 4d4c 5f54 5950 455f  00 == GGML_TYPE_
-00053420: 5349 5a45 5b74 7970 655d 293b 0a20 2020  SIZE[type]);.   
-00053430: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
-00053440: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-00053450: 7429 293b 0a0a 2020 2020 2f2f 2064 7374  t));..    // dst
-00053460: 2063 616e 6e6f 7420 6265 2074 7261 6e73   cannot be trans
-00053470: 706f 7365 6420 6f72 2070 6572 6d75 7465  posed or permute
-00053480: 640a 2020 2020 4747 4d4c 5f41 5353 4552  d.    GGML_ASSER
-00053490: 5428 6e62 3020 3d3d 2073 697a 656f 6628  T(nb0 == sizeof(
-000534a0: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
-000534b0: 4c5f 4153 5345 5254 286e 6230 203c 3d20  L_ASSERT(nb0 <= 
-000534c0: 6e62 3129 3b0a 2020 2020 4747 4d4c 5f41  nb1);.    GGML_A
-000534d0: 5353 4552 5428 6e62 3120 3c3d 206e 6232  SSERT(nb1 <= nb2
-000534e0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000534f0: 5254 286e 6232 203c 3d20 6e62 3329 3b0a  RT(nb2 <= nb3);.
-00053500: 0a20 2020 202f 2f20 6e62 3031 203e 3d20  .    // nb01 >= 
-00053510: 6e62 3030 202d 2073 7263 3020 6973 206e  nb00 - src0 is n
-00053520: 6f74 2074 7261 6e73 706f 7365 640a 2020  ot transposed.  
-00053530: 2020 2f2f 2020 2063 6f6d 7075 7465 2062    //   compute b
-00053540: 7920 7372 6330 2072 6f77 730a 0a23 6966  y src0 rows..#if
-00053550: 2064 6566 696e 6564 2847 474d 4c5f 5553   defined(GGML_US
-00053560: 455f 434c 424c 4153 5429 0a20 2020 2069  E_CLBLAST).    i
-00053570: 6620 2867 676d 6c5f 636c 5f63 616e 5f6d  f (ggml_cl_can_m
-00053580: 756c 5f6d 6174 2873 7263 302c 2073 7263  ul_mat(src0, src
-00053590: 312c 2064 7374 2929 207b 0a20 2020 2020  1, dst)) {.     
-000535a0: 2020 202f 2f20 544f 444f 3a20 6861 6e64     // TODO: hand
-000535b0: 6c65 2063 6173 6520 7768 656e 2073 7263  le case when src
-000535c0: 3020 6973 2062 726f 6164 6361 7374 2d61  0 is broadcast-a
-000535d0: 626c 6520 696e 746f 2073 7263 3120 6163  ble into src1 ac
-000535e0: 726f 7373 2032 6e64 2c33 7264 2064 696d  ross 2nd,3rd dim
-000535f0: 656e 7369 6f6e 0a20 2020 2020 2020 202f  ension.        /
-00053600: 2f20 2020 2020 2020 7265 663a 2068 7474  /       ref: htt
-00053610: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
-00053620: 6767 6572 6761 6e6f 762f 6767 6d6c 2f70  ggerganov/ggml/p
-00053630: 756c 6c2f 3232 340a 2020 2020 2020 2020  ull/224.        
-00053640: 4747 4d4c 5f41 5353 4552 5428 6e65 3032  GGML_ASSERT(ne02
-00053650: 203d 3d20 6e65 3132 293b 0a20 2020 2020   == ne12);.     
-00053660: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00053670: 6530 3320 3d3d 206e 6531 3329 3b0a 0a20  e03 == ne13);.. 
-00053680: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
-00053690: 732d 3e69 7468 203d 3d20 3020 2626 2070  s->ith == 0 && p
-000536a0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000536b0: 474d 4c5f 5441 534b 5f43 4f4d 5055 5445  GML_TASK_COMPUTE
-000536c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000536d0: 6767 6d6c 5f63 6c5f 6d75 6c5f 6d61 7428  ggml_cl_mul_mat(
-000536e0: 7372 6330 2c20 7372 6331 2c20 6473 742c  src0, src1, dst,
-000536f0: 2070 6172 616d 732d 3e77 6461 7461 2c20   params->wdata, 
-00053700: 7061 7261 6d73 2d3e 7773 697a 6529 3b0a  params->wsize);.
-00053710: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00053720: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00053730: 2365 6e64 6966 0a0a 2369 6620 6465 6669  #endif..#if defi
-00053740: 6e65 6428 4747 4d4c 5f55 5345 5f41 4343  ned(GGML_USE_ACC
-00053750: 454c 4552 4154 4529 207c 7c20 6465 6669  ELERATE) || defi
-00053760: 6e65 6428 4747 4d4c 5f55 5345 5f4f 5045  ned(GGML_USE_OPE
-00053770: 4e42 4c41 5329 0a20 2020 2069 6620 2867  NBLAS).    if (g
-00053780: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00053790: 6172 645f 6d75 6c5f 6d61 745f 7573 655f  ard_mul_mat_use_
-000537a0: 626c 6173 2873 7263 302c 2073 7263 312c  blas(src0, src1,
-000537b0: 2064 7374 2929 207b 0a20 2020 2020 2020   dst)) {.       
-000537c0: 202f 2f20 544f 444f 3a20 6861 6e64 6c65   // TODO: handle
-000537d0: 2063 6173 6520 7768 656e 2073 7263 3020   case when src0 
-000537e0: 6973 2062 726f 6164 6361 7374 2d61 626c  is broadcast-abl
-000537f0: 6520 696e 746f 2073 7263 3120 6163 726f  e into src1 acro
-00053800: 7373 2032 6e64 2c33 7264 2064 696d 656e  ss 2nd,3rd dimen
-00053810: 7369 6f6e 0a20 2020 2020 2020 202f 2f20  sion.        // 
-00053820: 2020 2020 2020 7265 663a 2068 7474 7073        ref: https
-00053830: 3a2f 2f67 6974 6875 622e 636f 6d2f 6767  ://github.com/gg
-00053840: 6572 6761 6e6f 762f 6767 6d6c 2f70 756c  erganov/ggml/pul
-00053850: 6c2f 3232 340a 2020 2020 2020 2020 4747  l/224.        GG
-00053860: 4d4c 5f41 5353 4552 5428 6e65 3032 203d  ML_ASSERT(ne02 =
-00053870: 3d20 6e65 3132 293b 0a20 2020 2020 2020  = ne12);.       
-00053880: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
-00053890: 3320 3d3d 206e 6531 3329 3b0a 0a20 2020  3 == ne13);..   
-000538a0: 2020 2020 2069 6620 2870 6172 616d 732d       if (params-
-000538b0: 3e69 7468 2021 3d20 3029 207b 0a20 2020  >ith != 0) {.   
-000538c0: 2020 2020 2020 2020 2072 6574 7572 6e3b           return;
-000538d0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-000538e0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-000538f0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00053900: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
-00053910: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00053920: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00053930: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00053940: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00053950: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00053960: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-00053970: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00053980: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-00053990: 3033 203d 2030 3b20 6930 3320 3c20 6e65  03 = 0; i03 < ne
-000539a0: 3033 3b20 6930 332b 2b29 207b 0a20 2020  03; i03++) {.   
-000539b0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-000539c0: 7436 345f 7420 6930 3220 3d20 303b 2069  t64_t i02 = 0; i
-000539d0: 3032 203c 206e 6530 323b 2069 3032 2b2b  02 < ne02; i02++
-000539e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000539f0: 2020 2020 636f 6e73 7420 766f 6964 202a      const void *
-00053a00: 2078 203d 2028 6368 6172 202a 2920 7372   x = (char *) sr
-00053a10: 6330 2d3e 6461 7461 202b 2069 3033 2a6e  c0->data + i03*n
-00053a20: 6230 3320 2b20 6930 322a 6e62 3032 3b0a  b03 + i02*nb02;.
-00053a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053a40: 636f 6e73 7420 666c 6f61 7420 2a20 7920  const float * y 
-00053a50: 3d20 2866 6c6f 6174 202a 2920 2828 6368  = (float *) ((ch
-00053a60: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
-00053a70: 202b 2069 3032 2a6e 6231 3220 2b20 6930   + i02*nb12 + i0
-00053a80: 332a 6e62 3133 293b 0a0a 2020 2020 2020  3*nb13);..      
-00053a90: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00053aa0: 2a20 6420 3d20 2866 6c6f 6174 202a 2920  * d = (float *) 
-00053ab0: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
-00053ac0: 6174 6120 2b20 6930 322a 6e62 3220 2b20  ata + i02*nb2 + 
-00053ad0: 6930 332a 6e62 3329 3b0a 0a20 2020 2020  i03*nb3);..     
-00053ae0: 2020 2020 2020 2020 2020 2069 6620 2874             if (t
-00053af0: 7970 6520 213d 2047 474d 4c5f 5459 5045  ype != GGML_TYPE
-00053b00: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
-00053b10: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00053b20: 7420 2a20 636f 6e73 7420 7764 6174 6120  t * const wdata 
-00053b30: 3d20 7061 7261 6d73 2d3e 7764 6174 613b  = params->wdata;
-00053b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00053b50: 2020 2020 2067 676d 6c5f 746f 5f66 6c6f       ggml_to_flo
-00053b60: 6174 5f74 2063 6f6e 7374 2074 6f5f 666c  at_t const to_fl
-00053b70: 6f61 7420 3d20 7479 7065 5f74 7261 6974  oat = type_trait
-00053b80: 735b 7479 7065 5d2e 746f 5f66 6c6f 6174  s[type].to_float
-00053b90: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00053ba0: 2020 2020 2020 2073 697a 655f 7420 6964         size_t id
-00053bb0: 203d 2030 3b0a 2020 2020 2020 2020 2020   = 0;.          
-00053bc0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00053bd0: 6e74 3634 5f74 2069 3031 203d 2030 3b20  nt64_t i01 = 0; 
-00053be0: 6930 3120 3c20 6e65 3031 3b20 2b2b 6930  i01 < ne01; ++i0
-00053bf0: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00053c00: 2020 2020 2020 2020 2020 2020 2074 6f5f               to_
-00053c10: 666c 6f61 7428 2863 6861 7220 2a29 2073  float((char *) s
-00053c20: 7263 302d 3e64 6174 6120 2b20 6930 332a  rc0->data + i03*
-00053c30: 6e62 3033 202b 2069 3032 2a6e 6230 3220  nb03 + i02*nb02 
-00053c40: 2b20 6930 312a 6e62 3031 2c20 7764 6174  + i01*nb01, wdat
-00053c50: 6120 2b20 6964 2c20 6e65 3030 293b 0a20  a + id, ne00);. 
-00053c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053c70: 2020 2020 2020 2069 6420 2b3d 206e 6530         id += ne0
-00053c80: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-00053c90: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00053ca0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00053cb0: 7365 7274 2869 642a 7369 7a65 6f66 2866  sert(id*sizeof(f
-00053cc0: 6c6f 6174 2920 3c3d 2070 6172 616d 732d  loat) <= params-
-00053cd0: 3e77 7369 7a65 293b 0a20 2020 2020 2020  >wsize);.       
-00053ce0: 2020 2020 2020 2020 2020 2020 2078 203d               x =
-00053cf0: 2077 6461 7461 3b0a 2020 2020 2020 2020   wdata;.        
-00053d00: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00053d10: 2020 2020 2020 2020 2020 2063 626c 6173             cblas
-00053d20: 5f73 6765 6d6d 2843 626c 6173 526f 774d  _sgemm(CblasRowM
-00053d30: 616a 6f72 2c20 4362 6c61 734e 6f54 7261  ajor, CblasNoTra
-00053d40: 6e73 2c20 4362 6c61 7354 7261 6e73 2c0a  ns, CblasTrans,.
-00053d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d60: 2020 2020 2020 2020 6e65 3131 2c20 6e65          ne11, ne
-00053d70: 3031 2c20 6e65 3130 2c0a 2020 2020 2020  01, ne10,.      
-00053d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053d90: 2020 312e 3066 2c20 2020 2079 2c20 6e65    1.0f,    y, ne
-00053da0: 3130 2c0a 2020 2020 2020 2020 2020 2020  10,.            
-00053db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053dc0: 2020 2020 2078 2c20 6e65 3030 2c0a 2020       x, ne00,.  
-00053dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00053de0: 2020 2020 2020 302e 3066 2c20 2020 2064        0.0f,    d
-00053df0: 2c20 6e65 3031 293b 0a20 2020 2020 2020  , ne01);.       
-00053e00: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00053e10: 0a0a 2020 2020 2020 2020 2f2f 7072 696e  ..        //prin
-00053e20: 7466 2822 4342 4c41 5320 3d20 2566 206d  tf("CBLAS = %f m
-00053e30: 732c 2025 6420 7820 2564 2078 2025 6420  s, %d x %d x %d 
-00053e40: 7820 2564 5c6e 222c 2028 6767 6d6c 5f70  x %d\n", (ggml_p
-00053e50: 6572 665f 7469 6d65 5f75 7328 2920 2d20  erf_time_us() - 
-00053e60: 7430 292f 3130 3030 2e30 2c20 6e65 302c  t0)/1000.0, ne0,
-00053e70: 206e 6531 2c20 6e65 322c 206e 6533 293b   ne1, ne2, ne3);
-00053e80: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00053e90: 3b0a 2020 2020 7d0a 2365 6e64 6966 0a0a  ;.    }.#endif..
-00053ea0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00053eb0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00053ec0: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
-00053ed0: 2020 6966 2028 7372 6331 2d3e 7479 7065    if (src1->type
-00053ee0: 2021 3d20 7665 635f 646f 745f 7479 7065   != vec_dot_type
-00053ef0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00053f00: 6368 6172 202a 2077 6461 7461 203d 2070  char * wdata = p
-00053f10: 6172 616d 732d 3e77 6461 7461 3b0a 2020  arams->wdata;.  
-00053f20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00053f30: 7369 7a65 5f74 2072 6f77 5f73 697a 6520  size_t row_size 
-00053f40: 3d20 6e65 3130 2a47 474d 4c5f 5459 5045  = ne10*GGML_TYPE
-00053f50: 5f53 495a 455b 7665 635f 646f 745f 7479  _SIZE[vec_dot_ty
-00053f60: 7065 5d2f 4747 4d4c 5f42 4c43 4b5f 5349  pe]/GGML_BLCK_SI
-00053f70: 5a45 5b76 6563 5f64 6f74 5f74 7970 655d  ZE[vec_dot_type]
-00053f80: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
-00053f90: 6f72 2028 696e 7436 345f 7420 6931 3320  or (int64_t i13 
-00053fa0: 3d20 303b 2069 3133 203c 206e 6531 333b  = 0; i13 < ne13;
-00053fb0: 202b 2b69 3133 2920 7b0a 2020 2020 2020   ++i13) {.      
-00053fc0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00053fd0: 6e74 3634 5f74 2069 3132 203d 2030 3b20  nt64_t i12 = 0; 
-00053fe0: 6931 3220 3c20 6e65 3132 3b20 2b2b 6931  i12 < ne12; ++i1
-00053ff0: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
-00054000: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00054010: 7436 345f 7420 6931 3120 3d20 303b 2069  t64_t i11 = 0; i
-00054020: 3131 203c 206e 6531 313b 202b 2b69 3131  11 < ne11; ++i11
-00054030: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00054040: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
-00054050: 5f66 6c6f 6174 5f74 6f5f 7665 635f 646f  _float_to_vec_do
-00054060: 7428 2866 6c6f 6174 202a 2928 2863 6861  t((float *)((cha
-00054070: 7220 2a29 2073 7263 312d 3e64 6174 6120  r *) src1->data 
-00054080: 2b20 6931 332a 6e62 3133 202b 2069 3132  + i13*nb13 + i12
-00054090: 2a6e 6231 3220 2b20 6931 312a 6e62 3131  *nb12 + i11*nb11
-000540a0: 292c 2028 766f 6964 202a 2920 7764 6174  ), (void *) wdat
-000540b0: 612c 206e 6531 3029 3b0a 2020 2020 2020  a, ne10);.      
-000540c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000540d0: 2020 7764 6174 6120 2b3d 2072 6f77 5f73    wdata += row_s
-000540e0: 697a 653b 0a20 2020 2020 2020 2020 2020  ize;.           
-000540f0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00054100: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00054110: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00054120: 2020 207d 0a0a 2020 2020 2020 2020 7265     }..        re
-00054130: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00054140: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00054150: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00054160: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00054170: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00054180: 0a0a 2020 2020 2f2f 2070 6172 616c 6c65  ..    // paralle
-00054190: 6c69 7a65 2062 7920 7372 6330 2072 6f77  lize by src0 row
-000541a0: 730a 2020 2020 636f 6e73 7420 696e 7436  s.    const int6
-000541b0: 345f 7420 6472 203d 2028 6e65 3031 202b  4_t dr = (ne01 +
-000541c0: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-000541d0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-000541e0: 7420 6972 3130 203d 2064 722a 6974 683b  t ir10 = dr*ith;
-000541f0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-00054200: 5f74 2069 7231 3120 3d20 4d49 4e28 6972  _t ir11 = MIN(ir
-00054210: 3130 202b 2064 722c 206e 6530 3129 3b0a  10 + dr, ne01);.
-00054220: 0a20 2020 202f 2f20 7372 6331 2072 6f77  .    // src1 row
-00054230: 730a 2020 2020 636f 6e73 7420 696e 7436  s.    const int6
-00054240: 345f 7420 6e72 3120 3d20 6e65 3131 2a6e  4_t nr1 = ne11*n
-00054250: 6531 322a 6e65 3133 3b0a 0a20 2020 2076  e12*ne13;..    v
-00054260: 6f69 6420 2a20 7764 6174 6120 3d20 2873  oid * wdata = (s
-00054270: 7263 312d 3e74 7970 6520 3d3d 2076 6563  rc1->type == vec
-00054280: 5f64 6f74 5f74 7970 6529 203f 2073 7263  _dot_type) ? src
-00054290: 312d 3e64 6174 6120 3a20 7061 7261 6d73  1->data : params
-000542a0: 2d3e 7764 6174 613b 0a20 2020 2063 6f6e  ->wdata;.    con
-000542b0: 7374 2073 697a 655f 7420 726f 775f 7369  st size_t row_si
-000542c0: 7a65 203d 206e 6531 302a 4747 4d4c 5f54  ze = ne10*GGML_T
-000542d0: 5950 455f 5349 5a45 5b76 6563 5f64 6f74  YPE_SIZE[vec_dot
-000542e0: 5f74 7970 655d 2f47 474d 4c5f 424c 434b  _type]/GGML_BLCK
-000542f0: 5f53 495a 455b 7665 635f 646f 745f 7479  _SIZE[vec_dot_ty
-00054300: 7065 5d3b 0a0a 2020 2020 666f 7220 2869  pe];..    for (i
-00054310: 6e74 3634 5f74 2069 7231 203d 2030 3b20  nt64_t ir1 = 0; 
-00054320: 6972 3120 3c20 6e72 313b 202b 2b69 7231  ir1 < nr1; ++ir1
-00054330: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
-00054340: 7420 696e 7436 345f 7420 6931 3320 3d20  t int64_t i13 = 
-00054350: 2869 7231 2f28 6e65 3132 2a6e 6531 3129  (ir1/(ne12*ne11)
-00054360: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-00054370: 2069 6e74 3634 5f74 2069 3132 203d 2028   int64_t i12 = (
-00054380: 6972 3120 2d20 6931 332a 6e65 3132 2a6e  ir1 - i13*ne12*n
-00054390: 6531 3129 2f6e 6531 313b 0a20 2020 2020  e11)/ne11;.     
-000543a0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-000543b0: 2069 3131 203d 2028 6972 3120 2d20 6931   i11 = (ir1 - i1
-000543c0: 332a 6e65 3132 2a6e 6531 3120 2d20 6931  3*ne12*ne11 - i1
-000543d0: 322a 6e65 3131 293b 0a0a 2020 2020 2020  2*ne11);..      
-000543e0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000543f0: 6972 3020 3d20 2869 7231 2f6e 6531 3129  ir0 = (ir1/ne11)
-00054400: 2528 6e65 3032 2a6e 6530 3329 3b0a 2020  %(ne02*ne03);.  
-00054410: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-00054420: 345f 7420 6930 3320 3d20 2869 7230 2f28  4_t i03 = (ir0/(
-00054430: 6e65 3032 2929 3b0a 2020 2020 2020 2020  ne02));.        
-00054440: 2f2f 2048 6163 6b20 666f 7220 2246 616c  // Hack for "Fal
-00054450: 636f 6e20 6d75 6c74 692d 7175 6572 792d  con multi-query-
-00054460: 6174 7465 6e74 696f 6e20 6b65 7920 7374  attention key st
-00054470: 7574 7465 7222 202f 2061 6c74 6572 6e61  utter" / alterna
-00054480: 7469 7665 2074 6f20 6767 6d6c 5f72 6570  tive to ggml_rep
-00054490: 6561 7432 2e0a 2020 2020 2020 2020 2f2f  eat2..        //
-000544a0: 2053 6565 2068 7474 7073 3a2f 2f67 6974   See https://git
-000544b0: 6875 622e 636f 6d2f 6767 6572 6761 6e6f  hub.com/ggergano
-000544c0: 762f 6c6c 616d 612e 6370 702f 6973 7375  v/llama.cpp/issu
-000544d0: 6573 2f31 3630 3223 6973 7375 6563 6f6d  es/1602#issuecom
-000544e0: 6d65 6e74 2d31 3630 3630 3837 3437 303a  ment-1606087470:
-000544f0: 0a20 2020 2020 2020 202f 2f20 4747 3a20  .        // GG: 
-00054500: 7468 6973 2069 7320 6c69 6b65 6c79 2074  this is likely t
-00054510: 6865 2063 6f72 7265 6374 2077 6179 2074  he correct way t
-00054520: 6f20 6272 6f61 6463 6173 742c 2074 686f  o broadcast, tho
-00054530: 7567 6820 6e65 6564 2073 6f6d 6520 6d6f  ugh need some mo
-00054540: 7265 2074 686f 7567 6874 0a20 2020 2020  re thought.     
-00054550: 2020 202f 2f20 2020 2020 7468 6572 6566     //     theref
-00054560: 6f72 6520 6c65 6176 696e 6720 7468 6520  ore leaving the 
-00054570: 636f 6d6d 656e 7473 2074 6f20 7265 6d69  comments to remi
-00054580: 6e64 2075 7320 666f 7220 6e6f 770a 2020  nd us for now.  
-00054590: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-000545a0: 345f 7420 6930 3220 3d20 2869 3132 202f  4_t i02 = (i12 /
-000545b0: 2028 6e65 3132 202f 206e 6530 3229 293b   (ne12 / ne02));
-000545c0: 0a20 2020 2020 2020 202f 2f20 4f72 6967  .        // Orig
-000545d0: 696e 616c 2066 726f 6d20 5052 2f32 3234  inal from PR/224
-000545e0: 2028 616e 6420 616c 736f 2065 7373 656e   (and also essen
-000545f0: 7469 616c 2f63 6f72 7265 6374 2066 6f72  tial/correct for
-00054600: 206e 6f6e 2d62 726f 6164 6361 7374 206d   non-broadcast m
-00054610: 6174 6d75 6c73 2069 6e20 4661 6c63 6f6e  atmuls in Falcon
-00054620: 290a 2020 2020 2020 2020 2f2f 2063 6f6e  ).        // con
-00054630: 7374 2069 6e74 3634 5f74 2069 3032 203d  st int64_t i02 =
-00054640: 2028 6972 3020 2d20 6930 332a 6e65 3032   (ir0 - i03*ne02
-00054650: 293b 0a0a 2020 2020 2020 2020 636f 6e73  );..        cons
-00054660: 7420 696e 7436 345f 7420 6931 203d 2069  t int64_t i1 = i
-00054670: 3131 3b0a 2020 2020 2020 2020 636f 6e73  11;.        cons
-00054680: 7420 696e 7436 345f 7420 6932 203d 2069  t int64_t i2 = i
-00054690: 3132 3b0a 2020 2020 2020 2020 636f 6e73  12;.        cons
-000546a0: 7420 696e 7436 345f 7420 6933 203d 2069  t int64_t i3 = i
-000546b0: 3133 3b0a 0a20 2020 2020 2020 2063 6f6e  13;..        con
-000546c0: 7374 2063 6861 7220 2a20 7372 6330 5f72  st char * src0_r
-000546d0: 6f77 203d 2028 636f 6e73 7420 6368 6172  ow = (const char
-000546e0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-000546f0: 2028 2020 3020 2b20 6930 322a 6e62 3032   (  0 + i02*nb02
-00054700: 202b 2069 3033 2a6e 6230 3320 2020 2020   + i03*nb03     
-00054710: 293b 0a20 2020 2020 2020 2063 6f6e 7374  );.        const
-00054720: 2063 6861 7220 2a20 7372 6331 5f63 6f6c   char * src1_col
-00054730: 203d 2028 636f 6e73 7420 6368 6172 202a   = (const char *
-00054740: 2920 2020 2020 2077 6461 7461 202b 2028  )      wdata + (
-00054750: 6931 3120 2b20 6931 322a 6e65 3131 202b  i11 + i12*ne11 +
-00054760: 2069 3133 2a6e 6531 322a 6e65 3131 292a   i13*ne12*ne11)*
-00054770: 726f 775f 7369 7a65 3b0a 0a20 2020 2020  row_size;..     
-00054780: 2020 2066 6c6f 6174 202a 2064 7374 5f63     float * dst_c
-00054790: 6f6c 203d 2028 666c 6f61 7420 2a29 2028  ol = (float *) (
-000547a0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-000547b0: 7461 202b 2028 6931 2a6e 6231 202b 2069  ta + (i1*nb1 + i
-000547c0: 322a 6e62 3220 2b20 6933 2a6e 6233 2929  2*nb2 + i3*nb3))
-000547d0: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-000547e0: 696e 7436 345f 7420 6972 203d 2069 7231  int64_t ir = ir1
-000547f0: 303b 2069 7220 3c20 6972 3131 3b20 2b2b  0; ir < ir11; ++
-00054800: 6972 2920 7b0a 2020 2020 2020 2020 2020  ir) {.          
-00054810: 2020 7665 635f 646f 7428 6e65 3030 2c20    vec_dot(ne00, 
-00054820: 2664 7374 5f63 6f6c 5b69 725d 2c20 7372  &dst_col[ir], sr
-00054830: 6330 5f72 6f77 202b 2069 722a 6e62 3031  c0_row + ir*nb01
-00054840: 2c20 7372 6331 5f63 6f6c 293b 0a20 2020  , src1_col);.   
-00054850: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-00054860: 2020 2f2f 696e 7436 345f 7420 7431 203d    //int64_t t1 =
-00054870: 2067 676d 6c5f 7469 6d65 5f75 7328 293b   ggml_time_us();
-00054880: 0a20 2020 202f 2f73 7461 7469 6320 696e  .    //static in
-00054890: 7436 345f 7420 6163 6320 3d20 303b 0a20  t64_t acc = 0;. 
-000548a0: 2020 202f 2f61 6363 202b 3d20 7431 202d     //acc += t1 -
-000548b0: 2074 303b 0a20 2020 202f 2f69 6620 2874   t0;.    //if (t
-000548c0: 3120 2d20 7430 203e 2031 3029 207b 0a20  1 - t0 > 10) {. 
-000548d0: 2020 202f 2f20 2020 2070 7269 6e74 6628     //    printf(
-000548e0: 225c 6e22 293b 0a20 2020 202f 2f20 2020  "\n");.    //   
-000548f0: 2070 7269 6e74 6628 226e 6530 3020 3d20   printf("ne00 = 
-00054900: 2535 642c 206e 6530 3120 3d20 2535 642c  %5d, ne01 = %5d,
-00054910: 206e 6530 3220 3d20 2535 642c 206e 6530   ne02 = %5d, ne0
-00054920: 3320 3d20 2535 645c 6e22 2c20 6e65 3030  3 = %5d\n", ne00
-00054930: 2c20 6e65 3031 2c20 6e65 3032 2c20 6e65  , ne01, ne02, ne
-00054940: 3033 293b 0a20 2020 202f 2f20 2020 2070  03);.    //    p
-00054950: 7269 6e74 6628 226e 6230 3020 3d20 2535  rintf("nb00 = %5
-00054960: 642c 206e 6230 3120 3d20 2535 642c 206e  d, nb01 = %5d, n
-00054970: 6230 3220 3d20 2535 642c 206e 6230 3320  b02 = %5d, nb03 
-00054980: 3d20 2535 645c 6e22 2c20 6e62 3030 2c20  = %5d\n", nb00, 
-00054990: 6e62 3031 2c20 6e62 3032 2c20 6e62 3033  nb01, nb02, nb03
-000549a0: 293b 0a20 2020 202f 2f20 2020 2070 7269  );.    //    pri
-000549b0: 6e74 6628 226e 6531 3020 3d20 2535 642c  ntf("ne10 = %5d,
-000549c0: 206e 6531 3120 3d20 2535 642c 206e 6531   ne11 = %5d, ne1
-000549d0: 3220 3d20 2535 642c 206e 6531 3320 3d20  2 = %5d, ne13 = 
-000549e0: 2535 645c 6e22 2c20 6e65 3130 2c20 6e65  %5d\n", ne10, ne
-000549f0: 3131 2c20 6e65 3132 2c20 6e65 3133 293b  11, ne12, ne13);
-00054a00: 0a0a 2020 2020 2f2f 2020 2020 7072 696e  ..    //    prin
-00054a10: 7466 2822 5858 5858 5858 5858 5858 5858  tf("XXXXXXXXXXXX
-00054a20: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00054a30: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-00054a40: 5858 5858 5858 5858 2074 6173 6b20 2564  XXXXXXXX task %d
-00054a50: 2f25 643a 2025 6420 7573 2c20 6163 6320  /%d: %d us, acc 
-00054a60: 3d20 2564 5c6e 222c 2069 7468 2c20 6e74  = %d\n", ith, nt
-00054a70: 682c 2028 696e 7429 2028 7431 202d 2074  h, (int) (t1 - t
-00054a80: 3029 2c20 2869 6e74 2920 6163 6329 3b0a  0), (int) acc);.
-00054a90: 2020 2020 2f2f 7d0a 7d0a 0a0a 2f2f 2067      //}.}...// g
-00054aa0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00054ab0: 6172 645f 6f75 745f 7072 6f64 0a0a 0a73  ard_out_prod...s
-00054ac0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00054ad0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00054ae0: 6f75 745f 7072 6f64 5f66 3332 280a 2020  out_prod_f32(.  
-00054af0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00054b00: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00054b10: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00054b20: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00054b30: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00054b40: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00054b50: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00054b60: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00054b70: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00054b80: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00054b90: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00054ba0: 2069 6e74 3634 5f74 2074 3020 3d20 6767   int64_t t0 = gg
-00054bb0: 6d6c 5f70 6572 665f 7469 6d65 5f75 7328  ml_perf_time_us(
-00054bc0: 293b 0a20 2020 2055 4e55 5345 4428 7430  );.    UNUSED(t0
-00054bd0: 293b 0a0a 2020 2020 4747 4d4c 5f54 454e  );..    GGML_TEN
-00054be0: 534f 525f 4249 4e41 5259 5f4f 505f 4c4f  SOR_BINARY_OP_LO
-00054bf0: 4341 4c53 3b0a 0a20 2020 2063 6f6e 7374  CALS;..    const
-00054c00: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
-00054c10: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
-00054c20: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
-00054c30: 6d73 2d3e 6e74 683b 0a0a 2020 2020 4747  ms->nth;..    GG
-00054c40: 4d4c 5f41 5353 4552 5428 6e65 3032 203d  ML_ASSERT(ne02 =
-00054c50: 3d20 6e65 3132 293b 0a20 2020 2047 474d  = ne12);.    GGM
-00054c60: 4c5f 4153 5345 5254 286e 6530 3320 3d3d  L_ASSERT(ne03 ==
-00054c70: 206e 6531 3329 3b0a 2020 2020 4747 4d4c   ne13);.    GGML
-00054c80: 5f41 5353 4552 5428 6e65 3220 203d 3d20  _ASSERT(ne2  == 
-00054c90: 6e65 3132 293b 0a20 2020 2047 474d 4c5f  ne12);.    GGML_
-00054ca0: 4153 5345 5254 286e 6533 2020 3d3d 206e  ASSERT(ne3  == n
-00054cb0: 6531 3329 3b0a 0a20 2020 202f 2f20 7765  e13);..    // we
-00054cc0: 2064 6f6e 2774 2073 7570 706f 7274 2070   don't support p
-00054cd0: 6572 6d75 7465 6420 7372 6330 206f 7220  ermuted src0 or 
-00054ce0: 7372 6331 0a20 2020 2047 474d 4c5f 4153  src1.    GGML_AS
-00054cf0: 5345 5254 286e 6230 3020 3d3d 2073 697a  SERT(nb00 == siz
-00054d00: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00054d10: 2020 2f2f 2064 7374 2063 616e 6e6f 7420    // dst cannot 
-00054d20: 6265 2074 7261 6e73 706f 7365 6420 6f72  be transposed or
-00054d30: 2070 6572 6d75 7465 640a 2020 2020 4747   permuted.    GG
-00054d40: 4d4c 5f41 5353 4552 5428 6e62 3020 3d3d  ML_ASSERT(nb0 ==
-00054d50: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00054d60: 0a20 2020 202f 2f20 4747 4d4c 5f41 5353  .    // GGML_ASS
-00054d70: 4552 5428 6e62 3020 3c3d 206e 6231 293b  ERT(nb0 <= nb1);
-00054d80: 0a20 2020 202f 2f20 4747 4d4c 5f41 5353  .    // GGML_ASS
-00054d90: 4552 5428 6e62 3120 3c3d 206e 6232 293b  ERT(nb1 <= nb2);
-00054da0: 0a20 2020 202f 2f20 4747 4d4c 5f41 5353  .    // GGML_ASS
-00054db0: 4552 5428 6e62 3220 3c3d 206e 6233 293b  ERT(nb2 <= nb3);
-00054dc0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00054dd0: 5428 6e65 3020 3d3d 206e 6530 3029 3b0a  T(ne0 == ne00);.
-00054de0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00054df0: 6e65 3120 3d3d 206e 6531 3029 3b0a 2020  ne1 == ne10);.  
-00054e00: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-00054e10: 3220 3d3d 206e 6530 3229 3b0a 2020 2020  2 == ne02);.    
-00054e20: 4747 4d4c 5f41 5353 4552 5428 6e65 3320  GGML_ASSERT(ne3 
-00054e30: 3d3d 206e 6530 3329 3b0a 0a20 2020 202f  == ne03);..    /
-00054e40: 2f20 6e62 3031 203e 3d20 6e62 3030 202d  / nb01 >= nb00 -
-00054e50: 2073 7263 3020 6973 206e 6f74 2074 7261   src0 is not tra
-00054e60: 6e73 706f 7365 640a 2020 2020 2f2f 2020  nsposed.    //  
-00054e70: 2063 6f6d 7075 7465 2062 7920 7372 6330   compute by src0
-00054e80: 2072 6f77 730a 0a20 2020 202f 2f20 544f   rows..    // TO
-00054e90: 444f 3a20 2369 6620 6465 6669 6e65 6428  DO: #if defined(
-00054ea0: 4747 4d4c 5f55 5345 5f43 5542 4c41 5329  GGML_USE_CUBLAS)
-00054eb0: 2067 676d 6c5f 6375 6461 5f6f 7574 5f70   ggml_cuda_out_p
-00054ec0: 726f 640a 2020 2020 2f2f 2054 4f44 4f3a  rod.    // TODO:
-00054ed0: 2023 6966 2064 6566 696e 6564 2847 474d   #if defined(GGM
-00054ee0: 4c5f 5553 455f 4143 4345 4c45 5241 5445  L_USE_ACCELERATE
-00054ef0: 2920 7c7c 2064 6566 696e 6564 2847 474d  ) || defined(GGM
-00054f00: 4c5f 5553 455f 4f50 454e 424c 4153 2920  L_USE_OPENBLAS) 
-00054f10: 7c7c 2064 6566 696e 6564 2847 474d 4c5f  || defined(GGML_
-00054f20: 5553 455f 434c 424c 4153 5429 0a0a 2020  USE_CLBLAST)..  
-00054f30: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-00054f40: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00054f50: 494e 4954 2920 7b0a 2020 2020 2020 2020  INIT) {.        
-00054f60: 6767 6d6c 5f76 6563 5f73 6574 5f66 3332  ggml_vec_set_f32
-00054f70: 286e 6530 2a6e 6531 2a6e 6532 2a6e 6533  (ne0*ne1*ne2*ne3
-00054f80: 2c20 6473 742d 3e64 6174 612c 2030 293b  , dst->data, 0);
-00054f90: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00054fa0: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
-00054fb0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00054fc0: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00054fd0: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-00054fe0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00054ff0: 202f 2f20 7061 7261 6c6c 656c 697a 6520   // parallelize 
-00055000: 6279 206c 6173 7420 7468 7265 6520 6469  by last three di
-00055010: 6d65 6e73 696f 6e73 0a0a 2020 2020 2f2f  mensions..    //
-00055020: 2074 6f74 616c 2072 6f77 7320 696e 2064   total rows in d
-00055030: 7374 0a20 2020 2063 6f6e 7374 2069 6e74  st.    const int
-00055040: 3634 5f74 206e 7220 3d20 6e65 312a 6e65  64_t nr = ne1*ne
-00055050: 322a 6e65 333b 0a0a 2020 2020 2f2f 2072  2*ne3;..    // r
-00055060: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
-00055070: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00055080: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
-00055090: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-000550a0: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
-000550b0: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
-000550c0: 636f 6e73 7420 696e 7436 345f 7420 6972  const int64_t ir
-000550d0: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
-000550e0: 636f 6e73 7420 696e 7436 345f 7420 6972  const int64_t ir
-000550f0: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
-00055100: 2c20 6e72 293b 0a0a 2020 2020 2f2f 2064  , nr);..    // d
-00055110: 7374 5b3a 2c3a 2c3a 2c3a 5d20 3d20 300a  st[:,:,:,:] = 0.
-00055120: 2020 2020 2f2f 2066 6f72 2069 322c 6933      // for i2,i3
-00055130: 3a0a 2020 2020 2f2f 2020 2066 6f72 2069  :.    //   for i
-00055140: 313a 0a20 2020 202f 2f20 2020 2020 666f  1:.    //     fo
-00055150: 7220 6930 313a 0a20 2020 202f 2f20 2020  r i01:.    //   
-00055160: 2020 2020 666f 7220 6930 3a0a 2020 2020      for i0:.    
-00055170: 2f2f 2020 2020 2020 2020 2064 7374 5b69  //         dst[i
-00055180: 302c 6931 2c69 322c 6933 5d20 2b3d 2073  0,i1,i2,i3] += s
-00055190: 7263 305b 6930 2c69 3031 2c69 322c 6933  rc0[i0,i01,i2,i3
-000551a0: 5d20 2a20 7372 6331 5b69 312c 6930 312c  ] * src1[i1,i01,
-000551b0: 6932 2c69 335d 0a0a 2020 2020 666f 7220  i2,i3]..    for 
-000551c0: 2869 6e74 3634 5f74 2069 7220 3d20 6972  (int64_t ir = ir
-000551d0: 303b 2069 7220 3c20 6972 313b 202b 2b69  0; ir < ir1; ++i
-000551e0: 7229 207b 0a20 2020 2020 2020 202f 2f20  r) {.        // 
-000551f0: 6473 7420 696e 6469 6365 730a 2020 2020  dst indices.    
-00055200: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00055210: 7420 6933 203d 2069 722f 286e 6532 2a6e  t i3 = ir/(ne2*n
-00055220: 6531 293b 0a20 2020 2020 2020 2063 6f6e  e1);.        con
-00055230: 7374 2069 6e74 3634 5f74 2069 3220 3d20  st int64_t i2 = 
-00055240: 2869 7220 2d20 6933 2a6e 6532 2a6e 6531  (ir - i3*ne2*ne1
-00055250: 292f 6e65 313b 0a20 2020 2020 2020 2063  )/ne1;.        c
-00055260: 6f6e 7374 2069 6e74 3634 5f74 2069 3120  onst int64_t i1 
-00055270: 3d20 2869 7220 2d20 6933 2a6e 6532 2a6e  = (ir - i3*ne2*n
-00055280: 6531 202d 2069 322a 6e65 3129 3b0a 0a20  e1 - i2*ne1);.. 
-00055290: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-000552a0: 3634 5f74 2069 3032 203d 2069 323b 0a20  64_t i02 = i2;. 
-000552b0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-000552c0: 3634 5f74 2069 3033 203d 2069 333b 0a0a  64_t i03 = i3;..
-000552d0: 2020 2020 2020 2020 2f2f 636f 6e73 7420          //const 
-000552e0: 696e 7436 345f 7420 6931 3020 3d20 6931  int64_t i10 = i1
-000552f0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-00055300: 696e 7436 345f 7420 6931 3220 3d20 6932  int64_t i12 = i2
-00055310: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-00055320: 696e 7436 345f 7420 6931 3320 3d20 6933  int64_t i13 = i3
-00055330: 3b0a 0a20 2020 2020 2020 2066 6f72 2028  ;..        for (
-00055340: 696e 7436 345f 7420 6930 3120 3d20 303b  int64_t i01 = 0;
-00055350: 2069 3031 203c 206e 6530 313b 202b 2b69   i01 < ne01; ++i
-00055360: 3031 2920 7b0a 2020 2020 2020 2020 2020  01) {.          
-00055370: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00055380: 6931 3120 3d20 6930 313b 0a0a 2020 2020  i11 = i01;..    
-00055390: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-000553a0: 7330 203d 2028 666c 6f61 7420 2a29 2028  s0 = (float *) (
-000553b0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-000553c0: 6174 6120 2b20 2820 2020 2020 2020 2020  ata + (         
-000553d0: 2069 3031 2a6e 6230 3120 2b20 6930 322a   i01*nb01 + i02*
-000553e0: 6e62 3032 202b 2069 3033 2a6e 6230 3329  nb02 + i03*nb03)
-000553f0: 293b 0a20 2020 2020 2020 2020 2020 2066  );.            f
-00055400: 6c6f 6174 202a 2073 3120 3d20 2866 6c6f  loat * s1 = (flo
-00055410: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-00055420: 7372 6331 2d3e 6461 7461 202b 2028 6931  src1->data + (i1
-00055430: 2a6e 6231 3020 2b20 6931 312a 6e62 3131  *nb10 + i11*nb11
-00055440: 202b 2069 3132 2a6e 6231 3220 2b20 6931   + i12*nb12 + i1
-00055450: 332a 6e62 3133 2929 3b0a 2020 2020 2020  3*nb13));.      
-00055460: 2020 2020 2020 666c 6f61 7420 2a20 6420        float * d 
-00055470: 203d 2028 666c 6f61 7420 2a29 2028 2863   = (float *) ((c
-00055480: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
-00055490: 6120 2b20 2820 2020 2020 2020 2020 2069  a + (          i
-000554a0: 312a 6e62 3120 2b20 6932 2a6e 6232 202b  1*nb1 + i2*nb2 +
-000554b0: 2069 332a 6e62 3329 293b 0a0a 2020 2020   i3*nb3));..    
-000554c0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-000554d0: 5f6d 6164 5f66 3332 286e 6530 2c20 642c  _mad_f32(ne0, d,
-000554e0: 2073 302c 202a 7331 293b 0a20 2020 2020   s0, *s1);.     
-000554f0: 2020 2020 2020 202f 2f20 666f 7220 2869         // for (i
-00055500: 6e74 3634 5f74 2069 3020 3d20 303b 2069  nt64_t i0 = 0; i
-00055510: 3020 3c20 6e65 303b 202b 2b69 3029 207b  0 < ne0; ++i0) {
-00055520: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-00055530: 2020 2020 645b 6930 5d20 2b3d 2073 305b      d[i0] += s0[
-00055540: 6930 5d20 2a20 7331 5b69 315d 3b0a 2020  i0] * s1[i1];.  
-00055550: 2020 2020 2020 2020 2020 2f2f 207d 0a20            // }. 
-00055560: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-00055570: 2020 2020 2f2f 696e 7436 345f 7420 7431      //int64_t t1
-00055580: 203d 2067 676d 6c5f 7065 7266 5f74 696d   = ggml_perf_tim
-00055590: 655f 7573 2829 3b0a 2020 2020 2f2f 7374  e_us();.    //st
-000555a0: 6174 6963 2069 6e74 3634 5f74 2061 6363  atic int64_t acc
-000555b0: 203d 2030 3b0a 2020 2020 2f2f 6163 6320   = 0;.    //acc 
-000555c0: 2b3d 2074 3120 2d20 7430 3b0a 2020 2020  += t1 - t0;.    
-000555d0: 2f2f 6966 2028 7431 202d 2074 3020 3e20  //if (t1 - t0 > 
-000555e0: 3130 2920 7b0a 2020 2020 2f2f 2020 2020  10) {.    //    
-000555f0: 7072 696e 7466 2822 5c6e 2229 3b0a 2020  printf("\n");.  
-00055600: 2020 2f2f 2020 2020 7072 696e 7466 2822    //    printf("
-00055610: 6e65 3030 203d 2025 3564 2c20 6e65 3031  ne00 = %5d, ne01
-00055620: 203d 2025 3564 2c20 6e65 3032 203d 2025   = %5d, ne02 = %
-00055630: 3564 2c20 6e65 3033 203d 2025 3564 5c6e  5d, ne03 = %5d\n
-00055640: 222c 206e 6530 302c 206e 6530 312c 206e  ", ne00, ne01, n
-00055650: 6530 322c 206e 6530 3329 3b0a 2020 2020  e02, ne03);.    
-00055660: 2f2f 2020 2020 7072 696e 7466 2822 6e62  //    printf("nb
-00055670: 3030 203d 2025 3564 2c20 6e62 3031 203d  00 = %5d, nb01 =
-00055680: 2025 3564 2c20 6e62 3032 203d 2025 3564   %5d, nb02 = %5d
-00055690: 2c20 6e62 3033 203d 2025 3564 5c6e 222c  , nb03 = %5d\n",
-000556a0: 206e 6230 302c 206e 6230 312c 206e 6230   nb00, nb01, nb0
-000556b0: 322c 206e 6230 3329 3b0a 2020 2020 2f2f  2, nb03);.    //
-000556c0: 2020 2020 7072 696e 7466 2822 6e65 3130      printf("ne10
-000556d0: 203d 2025 3564 2c20 6e65 3131 203d 2025   = %5d, ne11 = %
-000556e0: 3564 2c20 6e65 3132 203d 2025 3564 2c20  5d, ne12 = %5d, 
-000556f0: 6e65 3133 203d 2025 3564 5c6e 222c 206e  ne13 = %5d\n", n
-00055700: 6531 302c 206e 6531 312c 206e 6531 322c  e10, ne11, ne12,
-00055710: 206e 6531 3329 3b0a 2020 2020 2f2f 2020   ne13);.    //  
-00055720: 2020 7072 696e 7466 2822 6e62 3130 203d    printf("nb10 =
-00055730: 2025 3564 2c20 6e62 3131 203d 2025 3564   %5d, nb11 = %5d
-00055740: 2c20 6e62 3132 203d 2025 3564 2c20 6e62  , nb12 = %5d, nb
-00055750: 3133 203d 2025 3564 5c6e 222c 206e 6231  13 = %5d\n", nb1
-00055760: 302c 206e 6231 312c 206e 6231 322c 206e  0, nb11, nb12, n
-00055770: 6231 3329 3b0a 0a20 2020 202f 2f20 2020  b13);..    //   
-00055780: 2070 7269 6e74 6628 2258 5858 5858 5858   printf("XXXXXXX
-00055790: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-000557a0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
-000557b0: 5858 5858 5858 5858 5858 5858 5820 7461  XXXXXXXXXXXXX ta
-000557c0: 736b 2025 642f 2564 3a20 2564 2075 732c  sk %d/%d: %d us,
-000557d0: 2061 6363 203d 2025 645c 6e22 2c20 6974   acc = %d\n", it
-000557e0: 682c 206e 7468 2c20 2869 6e74 2920 2874  h, nth, (int) (t
-000557f0: 3120 2d20 7430 292c 2028 696e 7429 2061  1 - t0), (int) a
-00055800: 6363 293b 0a20 2020 202f 2f7d 0a7d 0a0a  cc);.    //}.}..
-00055810: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00055820: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00055830: 5f6f 7574 5f70 726f 6428 0a20 2020 2020  _out_prod(.     
-00055840: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00055850: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00055860: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00055870: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00055880: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00055890: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-000558a0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000558b0: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-000558c0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-000558d0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-000558e0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
-000558f0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
-00055900: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00055910: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
-00055920: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00055930: 455f 5134 5f31 3a0a 2020 2020 2020 2020  E_Q4_1:.        
-00055940: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00055950: 355f 303a 0a20 2020 2020 2020 2063 6173  5_0:.        cas
-00055960: 6520 4747 4d4c 5f54 5950 455f 5135 5f31  e GGML_TYPE_Q5_1
-00055970: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-00055980: 474d 4c5f 5459 5045 5f51 385f 303a 0a20  GML_TYPE_Q8_0:. 
-00055990: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000559a0: 5f54 5950 455f 5138 5f31 3a0a 2020 2020  _TYPE_Q8_1:.    
-000559b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000559c0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-000559d0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
-000559e0: 2074 6f64 6f0a 2020 2020 2020 2020 2020   todo.          
-000559f0: 2020 2020 2020 2f2f 2067 676d 6c5f 636f        // ggml_co
-00055a00: 6d70 7574 655f 666f 7277 6172 645f 6f75  mpute_forward_ou
-00055a10: 745f 7072 6f64 5f71 5f66 3332 2870 6172  t_prod_q_f32(par
-00055a20: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00055a30: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00055a40: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00055a50: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00055a60: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
-00055a70: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00055a80: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00055a90: 5428 6661 6c73 6529 3b20 2f2f 2074 6f64  T(false); // tod
-00055aa0: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
-00055ab0: 2020 2f2f 2067 676d 6c5f 636f 6d70 7574    // ggml_comput
-00055ac0: 655f 666f 7277 6172 645f 6f75 745f 7072  e_forward_out_pr
-00055ad0: 6f64 5f66 3136 5f66 3332 2870 6172 616d  od_f16_f32(param
-00055ae0: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00055af0: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00055b00: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00055b10: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00055b20: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-00055b30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00055b40: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00055b50: 5f66 6f72 7761 7264 5f6f 7574 5f70 726f  _forward_out_pro
-00055b60: 645f 6633 3228 7061 7261 6d73 2c20 7372  d_f32(params, sr
-00055b70: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-00055b80: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00055b90: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
-00055ba0: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
-00055bb0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00055bc0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00055bd0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-00055be0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00055bf0: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
-00055c00: 6d70 7574 655f 666f 7277 6172 645f 7363  mpute_forward_sc
-00055c10: 616c 650a 0a73 7461 7469 6320 766f 6964  ale..static void
-00055c20: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00055c30: 7277 6172 645f 7363 616c 655f 6633 3228  rward_scale_f32(
-00055c40: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00055c50: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00055c60: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00055c70: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00055c80: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00055c90: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-00055ca0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00055cb0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00055cc0: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
-00055cd0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00055ce0: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
-00055cf0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
-00055d00: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
-00055d10: 3029 293b 0a20 2020 2047 474d 4c5f 4153  0));.    GGML_AS
-00055d20: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
-00055d30: 7469 6775 6f75 7328 6473 7429 293b 0a20  tiguous(dst));. 
-00055d40: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-00055d50: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
-00055d60: 7065 2873 7263 302c 2064 7374 2929 3b0a  pe(src0, dst));.
-00055d70: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00055d80: 6767 6d6c 5f69 735f 7363 616c 6172 2873  ggml_is_scalar(s
-00055d90: 7263 3129 293b 0a0a 2020 2020 6966 2028  rc1));..    if (
-00055da0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00055db0: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-00055dc0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-00055dd0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00055de0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00055df0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00055e00: 2020 202f 2f20 7363 616c 6520 6661 6374     // scale fact
-00055e10: 6f72 0a20 2020 2063 6f6e 7374 2066 6c6f  or.    const flo
-00055e20: 6174 2076 203d 202a 2866 6c6f 6174 202a  at v = *(float *
-00055e30: 2920 7372 6331 2d3e 6461 7461 3b0a 0a20  ) src1->data;.. 
-00055e40: 2020 2063 6f6e 7374 2069 6e74 2069 7468     const int ith
-00055e50: 203d 2070 6172 616d 732d 3e69 7468 3b0a   = params->ith;.
-00055e60: 2020 2020 636f 6e73 7420 696e 7420 6e74      const int nt
-00055e70: 6820 3d20 7061 7261 6d73 2d3e 6e74 683b  h = params->nth;
-00055e80: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00055e90: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
-00055ea0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00055eb0: 6e72 203d 2067 676d 6c5f 6e72 6f77 7328  nr = ggml_nrows(
-00055ec0: 7372 6330 293b 0a0a 2020 2020 2f2f 2072  src0);..    // r
-00055ed0: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
-00055ee0: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
-00055ef0: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
-00055f00: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
-00055f10: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
-00055f20: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-00055f30: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
-00055f40: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-00055f50: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
-00055f60: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
-00055f70: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-00055f80: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
-00055f90: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
-00055fa0: 5f74 206e 6231 203d 2064 7374 2d3e 6e62  _t nb1 = dst->nb
-00055fb0: 5b31 5d3b 0a0a 0a20 2020 2066 6f72 2028  [1];...    for (
-00055fc0: 696e 7420 6931 203d 2069 7230 3b20 6931  int i1 = ir0; i1
-00055fd0: 203c 2069 7231 3b20 6931 2b2b 2920 7b0a   < ir1; i1++) {.
-00055fe0: 2020 2020 2020 2020 6966 2028 6473 742d          if (dst-
-00055ff0: 3e64 6174 6120 213d 2073 7263 302d 3e64  >data != src0->d
-00056000: 6174 6129 207b 0a20 2020 2020 2020 2020  ata) {.         
-00056010: 2020 202f 2f20 7372 6330 2069 7320 7361     // src0 is sa
-00056020: 6d65 2073 6861 7065 2061 7320 6473 7420  me shape as dst 
-00056030: 3d3e 2073 616d 6520 696e 6469 6365 730a  => same indices.
-00056040: 2020 2020 2020 2020 2020 2020 6d65 6d63              memc
-00056050: 7079 2828 6368 6172 202a 2964 7374 2d3e  py((char *)dst->
-00056060: 6461 7461 202b 2069 312a 6e62 312c 2028  data + i1*nb1, (
-00056070: 6368 6172 202a 2973 7263 302d 3e64 6174  char *)src0->dat
-00056080: 6120 2b20 6931 2a6e 6230 312c 206e 6320  a + i1*nb01, nc 
-00056090: 2a20 7369 7a65 6f66 2866 6c6f 6174 2929  * sizeof(float))
-000560a0: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-000560b0: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
-000560c0: 6c65 5f66 3332 286e 632c 2028 666c 6f61  le_f32(nc, (floa
-000560d0: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
-000560e0: 7374 2d3e 6461 7461 202b 2069 312a 6e62  st->data + i1*nb
-000560f0: 3129 2c20 7629 3b0a 2020 2020 7d0a 7d0a  1), v);.    }.}.
-00056100: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00056110: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00056120: 645f 7363 616c 6528 0a20 2020 2020 2020  d_scale(.       
-00056130: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00056140: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00056150: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00056160: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00056170: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00056180: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00056190: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000561a0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
-000561b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-000561c0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-000561d0: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
-000561e0: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
-000561f0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00056200: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-00056210: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00056220: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00056230: 7465 5f66 6f72 7761 7264 5f73 6361 6c65  te_forward_scale
-00056240: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-00056250: 302c 2073 7263 312c 2064 7374 293b 0a20  0, src1, dst);. 
-00056260: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00056270: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-00056280: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-00056290: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000562a0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-000562b0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-000562c0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000562d0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
-000562e0: 7075 7465 5f66 6f72 7761 7264 5f73 6574  pute_forward_set
-000562f0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00056300: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00056310: 7264 5f73 6574 5f66 3332 280a 2020 2020  rd_set_f32(.    
-00056320: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00056330: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00056340: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00056350: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00056360: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00056370: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00056380: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00056390: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-000563a0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-000563b0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000563c0: 7220 2a20 6f70 7430 2c0a 2020 2020 2020  r * opt0,.      
-000563d0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000563e0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-000563f0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00056400: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
-00056410: 6528 7372 6330 2c20 6473 7429 293b 0a20  e(src0, dst));. 
-00056420: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-00056430: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
-00056440: 7328 6473 7429 2026 2620 6767 6d6c 5f69  s(dst) && ggml_i
-00056450: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
-00056460: 3029 293b 0a0a 2020 2020 4747 4d4c 5f41  0));..    GGML_A
-00056470: 5353 4552 5428 6f70 7430 2d3e 7479 7065  SSERT(opt0->type
-00056480: 203d 3d20 4747 4d4c 5f54 5950 455f 4933   == GGML_TYPE_I3
-00056490: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
-000564a0: 4552 5428 6767 6d6c 5f6e 656c 656d 656e  ERT(ggml_nelemen
-000564b0: 7473 286f 7074 3029 203d 3d20 3529 3b0a  ts(opt0) == 5);.
-000564c0: 0a20 2020 202f 2f20 7669 6577 2073 7263  .    // view src
-000564d0: 3020 616e 6420 6473 7420 7769 7468 2074  0 and dst with t
-000564e0: 6865 7365 2073 7472 6964 6573 2061 6e64  hese strides and
-000564f0: 2064 6174 6120 6f66 6673 6574 2069 6e62   data offset inb
-00056500: 7974 6573 2064 7572 696e 6720 7365 740a  ytes during set.
-00056510: 2020 2020 2f2f 206e 6230 2069 7320 696d      // nb0 is im
-00056520: 706c 6963 6974 656c 7920 656c 656d 656e  plicitely elemen
-00056530: 745f 7369 7a65 2062 6563 6175 7365 2073  t_size because s
-00056540: 7263 3020 616e 6420 6473 7420 6172 6520  rc0 and dst are 
-00056550: 636f 6e74 6967 756f 7573 0a20 2020 2073  contiguous.    s
-00056560: 697a 655f 7420 6e62 3120 2020 2020 3d20  ize_t nb1     = 
-00056570: 2828 696e 7433 325f 7420 2a29 206f 7074  ((int32_t *) opt
-00056580: 302d 3e64 6174 6129 5b30 5d3b 0a20 2020  0->data)[0];.   
-00056590: 2073 697a 655f 7420 6e62 3220 2020 2020   size_t nb2     
-000565a0: 3d20 2828 696e 7433 325f 7420 2a29 206f  = ((int32_t *) o
-000565b0: 7074 302d 3e64 6174 6129 5b31 5d3b 0a20  pt0->data)[1];. 
-000565c0: 2020 2073 697a 655f 7420 6e62 3320 2020     size_t nb3   
-000565d0: 2020 3d20 2828 696e 7433 325f 7420 2a29    = ((int32_t *)
-000565e0: 206f 7074 302d 3e64 6174 6129 5b32 5d3b   opt0->data)[2];
-000565f0: 0a20 2020 2073 697a 655f 7420 6f66 6673  .    size_t offs
-00056600: 6574 2020 3d20 2828 696e 7433 325f 7420  et  = ((int32_t 
-00056610: 2a29 206f 7074 302d 3e64 6174 6129 5b33  *) opt0->data)[3
-00056620: 5d3b 0a20 2020 2062 6f6f 6c20 2020 696e  ];.    bool   in
-00056630: 706c 6163 6520 3d20 2862 6f6f 6c29 2028  place = (bool) (
-00056640: 2869 6e74 3332 5f74 202a 2920 6f70 7430  (int32_t *) opt0
-00056650: 2d3e 6461 7461 295b 345d 3b0a 0a20 2020  ->data)[4];..   
-00056660: 2069 6620 2821 696e 706c 6163 6520 2626   if (!inplace &&
-00056670: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-00056680: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
-00056690: 2929 207b 0a20 2020 2020 2020 202f 2f20  )) {.        // 
-000566a0: 6d65 6d63 7079 206e 6565 6473 2074 6f20  memcpy needs to 
-000566b0: 6265 2073 796e 6368 726f 6e69 7a65 6420  be synchronized 
-000566c0: 6163 726f 7373 2074 6872 6561 6473 2074  across threads t
-000566d0: 6f20 6176 6f69 6420 7261 6365 2063 6f6e  o avoid race con
-000566e0: 6469 7469 6f6e 732e 0a20 2020 2020 2020  ditions..       
-000566f0: 202f 2f20 3d3e 2064 6f20 6974 2069 6e20   // => do it in 
-00056700: 494e 4954 2070 6861 7365 0a20 2020 2020  INIT phase.     
-00056710: 2020 206d 656d 6370 7928 0a20 2020 2020     memcpy(.     
-00056720: 2020 2020 2020 2028 2863 6861 7220 2a29         ((char *)
-00056730: 2020 6473 742d 3e64 6174 6129 2c0a 2020    dst->data),.  
-00056740: 2020 2020 2020 2020 2020 2828 6368 6172            ((char
-00056750: 202a 2920 7372 6330 2d3e 6461 7461 292c   *) src0->data),
-00056760: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00056770: 6c5f 6e62 7974 6573 2864 7374 2929 3b0a  l_nbytes(dst));.
-00056780: 2020 2020 7d0a 0a20 2020 2069 6620 2870      }..    if (p
-00056790: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000567a0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
-000567b0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
-000567c0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-000567d0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-000567e0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-000567f0: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-00056800: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
-00056810: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-00056820: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
-00056830: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00056840: 7220 3d20 6767 6d6c 5f6e 726f 7773 2873  r = ggml_nrows(s
-00056850: 7263 3129 3b0a 2020 2020 636f 6e73 7420  rc1);.    const 
-00056860: 696e 7420 6e63 203d 2073 7263 312d 3e6e  int nc = src1->n
-00056870: 655b 305d 3b0a 0a20 2020 2047 474d 4c5f  e[0];..    GGML_
-00056880: 5445 4e53 4f52 5f4c 4f43 414c 5328 696e  TENSOR_LOCALS(in
-00056890: 7436 345f 742c 206e 6531 2c20 7372 6331  t64_t, ne1, src1
-000568a0: 2c20 6e65 293b 0a20 2020 2047 474d 4c5f  , ne);.    GGML_
-000568b0: 5445 4e53 4f52 5f4c 4f43 414c 5328 7369  TENSOR_LOCALS(si
-000568c0: 7a65 5f74 2c20 206e 6231 2c20 7372 6331  ze_t,  nb1, src1
-000568d0: 2c20 6e62 293b 0a0a 2020 2020 2f2f 2073  , nb);..    // s
-000568e0: 7263 3020 616e 6420 6473 7420 6173 2076  rc0 and dst as v
-000568f0: 6965 7765 6420 6475 7269 6e67 2073 6574  iewed during set
-00056900: 0a20 2020 2063 6f6e 7374 2073 697a 655f  .    const size_
-00056910: 7420 6e62 3020 3d20 6767 6d6c 5f65 6c65  t nb0 = ggml_ele
-00056920: 6d65 6e74 5f73 697a 6528 7372 6330 293b  ment_size(src0);
-00056930: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00056940: 696d 3020 3d20 286e 6531 3020 3d3d 2030  im0 = (ne10 == 0
-00056950: 203f 2030 203a 206e 6531 302d 3129 3b0a   ? 0 : ne10-1);.
-00056960: 2020 2020 636f 6e73 7420 696e 7420 696d      const int im
-00056970: 3120 3d20 286e 6531 3120 3d3d 2030 203f  1 = (ne11 == 0 ?
-00056980: 2030 203a 206e 6531 312d 3129 3b0a 2020   0 : ne11-1);.  
-00056990: 2020 636f 6e73 7420 696e 7420 696d 3220    const int im2 
-000569a0: 3d20 286e 6531 3220 3d3d 2030 203f 2030  = (ne12 == 0 ? 0
-000569b0: 203a 206e 6531 322d 3129 3b0a 2020 2020   : ne12-1);.    
-000569c0: 636f 6e73 7420 696e 7420 696d 3320 3d20  const int im3 = 
-000569d0: 286e 6531 3320 3d3d 2030 203f 2030 203a  (ne13 == 0 ? 0 :
-000569e0: 206e 6531 332d 3129 3b0a 0a20 2020 2047   ne13-1);..    G
-000569f0: 474d 4c5f 4153 5345 5254 286f 6666 7365  GML_ASSERT(offse
-00056a00: 7420 2b20 696d 302a 6e62 3020 202b 2069  t + im0*nb0  + i
-00056a10: 6d31 2a6e 6231 2020 2b20 696d 322a 6e62  m1*nb1  + im2*nb
-00056a20: 3220 202b 2069 6d33 2a6e 6233 2020 3c3d  2  + im3*nb3  <=
-00056a30: 2067 676d 6c5f 6e62 7974 6573 2864 7374   ggml_nbytes(dst
-00056a40: 2929 3b0a 0a20 2020 2047 474d 4c5f 4153  ));..    GGML_AS
-00056a50: 5345 5254 286e 6231 3020 3d3d 2073 697a  SERT(nb10 == siz
-00056a60: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00056a70: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
-00056a80: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-00056a90: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
-00056aa0: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
-00056ab0: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
-00056ac0: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
-00056ad0: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
-00056ae0: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
-00056af0: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
-00056b00: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
-00056b10: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
-00056b20: 7220 3d20 6972 303b 2069 7220 3c20 6972  r = ir0; ir < ir
-00056b30: 313b 202b 2b69 7229 207b 0a20 2020 2020  1; ++ir) {.     
-00056b40: 2020 202f 2f20 7372 6330 2061 6e64 2064     // src0 and d
-00056b50: 7374 2061 7265 2076 6965 7765 6420 7769  st are viewed wi
-00056b60: 7468 2073 6861 7065 206f 6620 7372 6331  th shape of src1
-00056b70: 2061 6e64 206f 6666 7365 740a 2020 2020   and offset.    
-00056b80: 2020 2020 2f2f 203d 3e20 7361 6d65 2069      // => same i
-00056b90: 6e64 6963 6573 0a20 2020 2020 2020 2063  ndices.        c
-00056ba0: 6f6e 7374 2069 6e74 2069 3320 3d20 6972  onst int i3 = ir
-00056bb0: 2f28 6e65 3132 2a6e 6531 3129 3b0a 2020  /(ne12*ne11);.  
-00056bc0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00056bd0: 6932 203d 2028 6972 202d 2069 332a 6e65  i2 = (ir - i3*ne
-00056be0: 3132 2a6e 6531 3129 2f6e 6531 313b 0a20  12*ne11)/ne11;. 
-00056bf0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00056c00: 2069 3120 3d20 2869 7220 2d20 6933 2a6e   i1 = (ir - i3*n
-00056c10: 6531 322a 6e65 3131 202d 2069 322a 6e65  e12*ne11 - i2*ne
-00056c20: 3131 293b 0a0a 2020 2020 2020 2020 6767  11);..        gg
-00056c30: 6d6c 5f76 6563 5f63 7079 5f66 3332 286e  ml_vec_cpy_f32(n
-00056c40: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-00056c50: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-00056c60: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
-00056c70: 6120 2b20 6933 2a6e 6233 2020 2b20 6932  a + i3*nb3  + i2
-00056c80: 2a6e 6232 2020 2b20 6931 2a6e 6231 2020  *nb2  + i1*nb1  
-00056c90: 2b20 6f66 6673 6574 292c 0a20 2020 2020  + offset),.     
-00056ca0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-00056cb0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
-00056cc0: 7263 312d 3e64 6174 6120 2b20 6933 2a6e  rc1->data + i3*n
-00056cd0: 6231 3320 2b20 6932 2a6e 6231 3220 2b20  b13 + i2*nb12 + 
-00056ce0: 6931 2a6e 6231 3129 293b 0a20 2020 207d  i1*nb11));.    }
-00056cf0: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-00056d00: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00056d10: 7761 7264 5f73 6574 280a 2020 2020 2020  ward_set(.      
-00056d20: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00056d30: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00056d40: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00056d50: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00056d60: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00056d70: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00056d80: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00056d90: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00056da0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00056db0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00056dc0: 2a20 6f70 7430 2c0a 2020 2020 2020 2020  * opt0,.        
-00056dd0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00056de0: 6f72 202a 2064 7374 2920 7b0a 0a20 2020  or * dst) {..   
-00056df0: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-00056e00: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-00056e10: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-00056e20: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00056e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00056e40: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00056e50: 7277 6172 645f 7365 745f 6633 3228 7061  rward_set_f32(pa
-00056e60: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
-00056e70: 2c20 6f70 7430 2c20 6473 7429 3b0a 2020  , opt0, dst);.  
-00056e80: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00056e90: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00056ea0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
-00056eb0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00056ec0: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
-00056ed0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00056ee0: 5045 5f51 345f 313a 0a20 2020 2020 2020  PE_Q4_1:.       
-00056ef0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00056f00: 5135 5f30 3a0a 2020 2020 2020 2020 6361  Q5_0:.        ca
-00056f10: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
-00056f20: 313a 0a20 2020 2020 2020 2063 6173 6520  1:.        case 
-00056f30: 4747 4d4c 5f54 5950 455f 5138 5f30 3a0a  GGML_TYPE_Q8_0:.
-00056f40: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00056f50: 4c5f 5459 5045 5f51 385f 313a 0a20 2020  L_TYPE_Q8_1:.   
-00056f60: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00056f70: 5950 455f 5132 5f4b 3a0a 2020 2020 2020  YPE_Q2_K:.      
-00056f80: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00056f90: 5f51 335f 4b3a 0a20 2020 2020 2020 2063  _Q3_K:.        c
-00056fa0: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00056fb0: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
-00056fc0: 2047 474d 4c5f 5459 5045 5f51 355f 4b3a   GGML_TYPE_Q5_K:
-00056fd0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00056fe0: 4d4c 5f54 5950 455f 5136 5f4b 3a0a 2020  ML_TYPE_Q6_K:.  
-00056ff0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
-00057000: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00057010: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00057020: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00057030: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00057040: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
-00057050: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00057060: 6f72 7761 7264 5f63 7079 0a0a 7374 6174  orward_cpy..stat
-00057070: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00057080: 7075 7465 5f66 6f72 7761 7264 5f63 7079  pute_forward_cpy
-00057090: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-000570a0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-000570b0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-000570c0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-000570d0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000570e0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-000570f0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00057100: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00057110: 7b0a 2020 2020 6767 6d6c 5f63 6f6d 7075  {.    ggml_compu
-00057120: 7465 5f66 6f72 7761 7264 5f64 7570 2870  te_forward_dup(p
-00057130: 6172 616d 732c 2073 7263 302c 2064 7374  arams, src0, dst
-00057140: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 636f  );.}..// ggml_co
-00057150: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
-00057160: 6e74 0a0a 7374 6174 6963 2076 6f69 6420  nt..static void 
-00057170: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00057180: 7761 7264 5f63 6f6e 7428 0a20 2020 2020  ward_cont(.     
-00057190: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000571a0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-000571b0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-000571c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-000571d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-000571e0: 2073 7263 302c 0a20 2020 2020 2020 2073   src0,.        s
-000571f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00057200: 7220 2a20 6473 7429 207b 0a20 2020 2067  r * dst) {.    g
-00057210: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00057220: 6172 645f 6475 7028 7061 7261 6d73 2c20  ard_dup(params, 
-00057230: 7372 6330 2c20 6473 7429 3b0a 7d0a 0a2f  src0, dst);.}../
-00057240: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00057250: 6f72 7761 7264 5f72 6573 6861 7065 0a0a  orward_reshape..
-00057260: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00057270: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00057280: 5f72 6573 6861 7065 280a 2020 2020 2020  _reshape(.      
-00057290: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000572a0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-000572b0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-000572c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000572d0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000572e0: 7372 6330 2c0a 2020 2020 2020 2020 7374  src0,.        st
-000572f0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00057300: 202a 2064 7374 2920 7b0a 2020 2020 2f2f   * dst) {.    //
-00057310: 204e 4f50 0a20 2020 2055 4e55 5345 4428   NOP.    UNUSED(
-00057320: 7061 7261 6d73 293b 0a20 2020 2055 4e55  params);.    UNU
-00057330: 5345 4428 7372 6330 293b 0a20 2020 2055  SED(src0);.    U
-00057340: 4e55 5345 4428 6473 7429 3b0a 7d0a 0a2f  NUSED(dst);.}../
-00057350: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
-00057360: 6f72 7761 7264 5f76 6965 770a 0a73 7461  orward_view..sta
-00057370: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00057380: 6d70 7574 655f 666f 7277 6172 645f 7669  mpute_forward_vi
-00057390: 6577 280a 2020 2020 2020 2020 636f 6e73  ew(.        cons
-000573a0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-000573b0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-000573c0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-000573d0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000573e0: 5f74 656e 736f 7220 2a20 7372 6330 2920  _tensor * src0) 
-000573f0: 7b0a 2020 2020 2f2f 204e 4f50 0a20 2020  {.    // NOP.   
-00057400: 2055 4e55 5345 4428 7061 7261 6d73 293b   UNUSED(params);
-00057410: 0a20 2020 2055 4e55 5345 4428 7372 6330  .    UNUSED(src0
-00057420: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 636f  );.}..// ggml_co
-00057430: 6d70 7574 655f 666f 7277 6172 645f 7065  mpute_forward_pe
-00057440: 726d 7574 650a 0a73 7461 7469 6320 766f  rmute..static vo
-00057450: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00057460: 666f 7277 6172 645f 7065 726d 7574 6528  forward_permute(
-00057470: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00057480: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00057490: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-000574a0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-000574b0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000574c0: 6e73 6f72 202a 2073 7263 3029 207b 0a20  nsor * src0) {. 
-000574d0: 2020 202f 2f20 4e4f 500a 2020 2020 554e     // NOP.    UN
-000574e0: 5553 4544 2870 6172 616d 7329 3b0a 2020  USED(params);.  
-000574f0: 2020 554e 5553 4544 2873 7263 3029 3b0a    UNUSED(src0);.
-00057500: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-00057510: 7465 5f66 6f72 7761 7264 5f74 7261 6e73  te_forward_trans
-00057520: 706f 7365 0a0a 7374 6174 6963 2076 6f69  pose..static voi
-00057530: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00057540: 6f72 7761 7264 5f74 7261 6e73 706f 7365  orward_transpose
-00057550: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00057560: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00057570: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00057580: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00057590: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000575a0: 656e 736f 7220 2a20 7372 6330 2920 7b0a  ensor * src0) {.
-000575b0: 2020 2020 2f2f 204e 4f50 0a20 2020 2055      // NOP.    U
-000575c0: 4e55 5345 4428 7061 7261 6d73 293b 0a20  NUSED(params);. 
-000575d0: 2020 2055 4e55 5345 4428 7372 6330 293b     UNUSED(src0);
-000575e0: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
-000575f0: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
-00057600: 726f 7773 0a0a 7374 6174 6963 2076 6f69  rows..static voi
-00057610: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-00057620: 6f72 7761 7264 5f67 6574 5f72 6f77 735f  orward_get_rows_
-00057630: 7128 0a20 2020 2020 2020 2063 6f6e 7374  q(.        const
-00057640: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00057650: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-00057660: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-00057670: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00057680: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-00057690: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000576a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000576b0: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
-000576c0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-000576d0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-000576e0: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
-000576f0: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
-00057700: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00057710: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00057720: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00057730: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00057740: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00057750: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00057760: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
-00057770: 7420 696e 7420 6e63 203d 2073 7263 302d  t int nc = src0-
-00057780: 3e6e 655b 305d 3b0a 2020 2020 636f 6e73  >ne[0];.    cons
-00057790: 7420 696e 7420 6e72 203d 2067 676d 6c5f  t int nr = ggml_
-000577a0: 6e65 6c65 6d65 6e74 7328 7372 6331 293b  nelements(src1);
-000577b0: 0a20 2020 2063 6f6e 7374 2065 6e75 6d20  .    const enum 
-000577c0: 6767 6d6c 5f74 7970 6520 7479 7065 203d  ggml_type type =
-000577d0: 2073 7263 302d 3e74 7970 653b 0a20 2020   src0->type;.   
-000577e0: 2067 676d 6c5f 746f 5f66 6c6f 6174 5f74   ggml_to_float_t
-000577f0: 2063 6f6e 7374 2064 6571 7561 6e74 697a   const dequantiz
-00057800: 655f 726f 775f 7120 3d20 7479 7065 5f74  e_row_q = type_t
-00057810: 7261 6974 735b 7479 7065 5d2e 746f 5f66  raits[type].to_f
-00057820: 6c6f 6174 3b0a 0a20 2020 2061 7373 6572  loat;..    asser
-00057830: 7428 2064 7374 2d3e 6e65 5b30 5d20 3d3d  t( dst->ne[0] ==
-00057840: 206e 6329 3b0a 2020 2020 6173 7365 7274   nc);.    assert
-00057850: 2820 6473 742d 3e6e 655b 315d 203d 3d20  ( dst->ne[1] == 
-00057860: 6e72 293b 0a20 2020 2061 7373 6572 7428  nr);.    assert(
-00057870: 7372 6330 2d3e 6e62 5b30 5d20 3d3d 2047  src0->nb[0] == G
-00057880: 474d 4c5f 5459 5045 5f53 495a 455b 7479  GML_TYPE_SIZE[ty
-00057890: 7065 5d29 3b0a 0a20 2020 2066 6f72 2028  pe]);..    for (
-000578a0: 696e 7420 6920 3d20 303b 2069 203c 206e  int i = 0; i < n
-000578b0: 723b 202b 2b69 2920 7b0a 2020 2020 2020  r; ++i) {.      
-000578c0: 2020 636f 6e73 7420 696e 7420 7220 3d20    const int r = 
-000578d0: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
-000578e0: 312d 3e64 6174 6129 5b69 5d3b 0a0a 2020  1->data)[i];..  
-000578f0: 2020 2020 2020 6465 7175 616e 7469 7a65        dequantize
-00057900: 5f72 6f77 5f71 280a 2020 2020 2020 2020  _row_q(.        
-00057910: 2020 2020 2020 2020 2863 6f6e 7374 2076          (const v
-00057920: 6f69 6420 2a29 2028 2863 6861 7220 2a29  oid *) ((char *)
-00057930: 2073 7263 302d 3e64 6174 6120 2b20 722a   src0->data + r*
-00057940: 7372 6330 2d3e 6e62 5b31 5d29 2c0a 2020  src0->nb[1]),.  
-00057950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00057960: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-00057970: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
-00057980: 6120 2b20 692a 6473 742d 3e6e 625b 315d  a + i*dst->nb[1]
-00057990: 292c 206e 6329 3b0a 2020 2020 7d0a 7d0a  ), nc);.    }.}.
-000579a0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000579b0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000579c0: 645f 6765 745f 726f 7773 5f66 3136 280a  d_get_rows_f16(.
-000579d0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000579e0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000579f0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00057a00: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00057a10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00057a20: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00057a30: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00057a40: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00057a50: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
-00057a60: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00057a70: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-00057a80: 2020 2061 7373 6572 7428 7061 7261 6d73     assert(params
-00057a90: 2d3e 6974 6820 3d3d 2030 293b 0a0a 2020  ->ith == 0);..  
-00057aa0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-00057ab0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00057ac0: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
-00057ad0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00057ae0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-00057af0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-00057b00: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
-00057b10: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
-00057b20: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-00057b30: 6e74 206e 7220 3d20 6767 6d6c 5f6e 656c  nt nr = ggml_nel
-00057b40: 656d 656e 7473 2873 7263 3129 3b0a 0a20  ements(src1);.. 
-00057b50: 2020 2061 7373 6572 7428 2064 7374 2d3e     assert( dst->
-00057b60: 6e65 5b30 5d20 3d3d 206e 6329 3b0a 2020  ne[0] == nc);.  
-00057b70: 2020 6173 7365 7274 2820 6473 742d 3e6e    assert( dst->n
-00057b80: 655b 315d 203d 3d20 6e72 293b 0a20 2020  e[1] == nr);.   
-00057b90: 2061 7373 6572 7428 7372 6330 2d3e 6e62   assert(src0->nb
-00057ba0: 5b30 5d20 3d3d 2073 697a 656f 6628 6767  [0] == sizeof(gg
-00057bb0: 6d6c 5f66 7031 365f 7429 293b 0a0a 2020  ml_fp16_t));..  
-00057bc0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00057bd0: 3b20 6920 3c20 6e72 3b20 2b2b 6929 207b  ; i < nr; ++i) {
-00057be0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00057bf0: 6e74 2072 203d 2028 2869 6e74 3332 5f74  nt r = ((int32_t
-00057c00: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-00057c10: 695d 3b0a 0a20 2020 2020 2020 2066 6f72  i];..        for
-00057c20: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
-00057c30: 206e 633b 202b 2b6a 2920 7b0a 2020 2020   nc; ++j) {.    
-00057c40: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-00057c50: 365f 7420 7620 3d20 2828 6767 6d6c 5f66  6_t v = ((ggml_f
-00057c60: 7031 365f 7420 2a29 2028 2863 6861 7220  p16_t *) ((char 
-00057c70: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00057c80: 722a 7372 6330 2d3e 6e62 5b31 5d29 295b  r*src0->nb[1]))[
-00057c90: 6a5d 3b0a 2020 2020 2020 2020 2020 2020  j];.            
-00057ca0: 2828 666c 6f61 7420 2a29 2028 2863 6861  ((float *) ((cha
-00057cb0: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
-00057cc0: 2b20 692a 6473 742d 3e6e 625b 315d 2929  + i*dst->nb[1]))
-00057cd0: 5b6a 5d20 3d20 4747 4d4c 5f46 5031 365f  [j] = GGML_FP16_
-00057ce0: 544f 5f46 5033 3228 7629 3b0a 2020 2020  TO_FP32(v);.    
-00057cf0: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-00057d00: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00057d10: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00057d20: 6765 745f 726f 7773 5f66 3332 280a 2020  get_rows_f32(.  
-00057d30: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00057d40: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00057d50: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00057d60: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00057d70: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00057d80: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-00057d90: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00057da0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00057db0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00057dc0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00057dd0: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00057de0: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
-00057df0: 6974 6820 3d3d 2030 293b 0a0a 2020 2020  ith == 0);..    
-00057e00: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00057e10: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
-00057e20: 4954 207c 7c20 7061 7261 6d73 2d3e 7479  IT || params->ty
-00057e30: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00057e40: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
-00057e50: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00057e60: 7d0a 0a20 2020 2063 6f6e 7374 2069 6e74  }..    const int
-00057e70: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
-00057e80: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00057e90: 206e 7220 3d20 6767 6d6c 5f6e 656c 656d   nr = ggml_nelem
-00057ea0: 656e 7473 2873 7263 3129 3b0a 0a20 2020  ents(src1);..   
-00057eb0: 2061 7373 6572 7428 2064 7374 2d3e 6e65   assert( dst->ne
-00057ec0: 5b30 5d20 3d3d 206e 6329 3b0a 2020 2020  [0] == nc);.    
-00057ed0: 6173 7365 7274 2820 6473 742d 3e6e 655b  assert( dst->ne[
-00057ee0: 315d 203d 3d20 6e72 293b 0a20 2020 2061  1] == nr);.    a
-00057ef0: 7373 6572 7428 7372 6330 2d3e 6e62 5b30  ssert(src0->nb[0
-00057f00: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
-00057f10: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
-00057f20: 6e74 2069 203d 2030 3b20 6920 3c20 6e72  nt i = 0; i < nr
-00057f30: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00057f40: 2063 6f6e 7374 2069 6e74 2072 203d 2028   const int r = (
-00057f50: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-00057f60: 2d3e 6461 7461 295b 695d 3b0a 0a20 2020  ->data)[i];..   
-00057f70: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
-00057f80: 795f 6633 3228 6e63 2c0a 2020 2020 2020  y_f32(nc,.      
-00057f90: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00057fa0: 202a 2920 2828 6368 6172 202a 2920 2064   *) ((char *)  d
-00057fb0: 7374 2d3e 6461 7461 202b 2069 2a64 7374  st->data + i*dst
-00057fc0: 2d3e 6e62 5b31 5d29 2c0a 2020 2020 2020  ->nb[1]),.      
-00057fd0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00057fe0: 202a 2920 2828 6368 6172 202a 2920 7372   *) ((char *) sr
-00057ff0: 6330 2d3e 6461 7461 202b 2072 2a73 7263  c0->data + r*src
-00058000: 302d 3e6e 625b 315d 2929 3b0a 2020 2020  0->nb[1]));.    
-00058010: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
-00058020: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00058030: 7277 6172 645f 6765 745f 726f 7773 280a  rward_get_rows(.
-00058040: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00058050: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00058060: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00058070: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00058080: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00058090: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-000580a0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-000580b0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-000580c0: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
-000580d0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000580e0: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
-000580f0: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
-00058100: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-00058110: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
-00058120: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00058130: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
-00058140: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00058150: 5950 455f 5135 5f30 3a0a 2020 2020 2020  YPE_Q5_0:.      
-00058160: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00058170: 5f51 355f 313a 0a20 2020 2020 2020 2063  _Q5_1:.        c
-00058180: 6173 6520 4747 4d4c 5f54 5950 455f 5138  ase GGML_TYPE_Q8
-00058190: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
-000581a0: 2047 474d 4c5f 5459 5045 5f51 385f 313a   GGML_TYPE_Q8_1:
-000581b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000581c0: 4d4c 5f54 5950 455f 5132 5f4b 3a0a 2020  ML_TYPE_Q2_K:.  
-000581d0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000581e0: 5459 5045 5f51 335f 4b3a 0a20 2020 2020  TYPE_Q3_K:.     
-000581f0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00058200: 455f 5134 5f4b 3a0a 2020 2020 2020 2020  E_Q4_K:.        
-00058210: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-00058220: 355f 4b3a 0a20 2020 2020 2020 2063 6173  5_K:.        cas
-00058230: 6520 4747 4d4c 5f54 5950 455f 5136 5f4b  e GGML_TYPE_Q6_K
-00058240: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00058250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00058260: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00058270: 7761 7264 5f67 6574 5f72 6f77 735f 7128  ward_get_rows_q(
-00058280: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-00058290: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-000582a0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000582b0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000582c0: 5f54 5950 455f 4631 363a 0a20 2020 2020  _TYPE_F16:.     
-000582d0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000582e0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000582f0: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
-00058300: 745f 726f 7773 5f66 3136 2870 6172 616d  t_rows_f16(param
-00058310: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00058320: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00058330: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00058340: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00058350: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-00058360: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00058370: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00058380: 5f66 6f72 7761 7264 5f67 6574 5f72 6f77  _forward_get_row
-00058390: 735f 6633 3228 7061 7261 6d73 2c20 7372  s_f32(params, sr
-000583a0: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-000583b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-000583c0: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
-000583d0: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
-000583e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000583f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00058400: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-00058410: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00058420: 207d 0a0a 2020 2020 2f2f 7374 6174 6963   }..    //static
-00058430: 2062 6f6f 6c20 6669 7273 7420 3d20 7472   bool first = tr
-00058440: 7565 3b0a 2020 2020 2f2f 7072 696e 7466  ue;.    //printf
-00058450: 2822 6e65 3020 3d20 2564 2c20 6e65 3120  ("ne0 = %d, ne1 
-00058460: 3d20 2564 2c20 6e65 3220 3d20 2564 5c6e  = %d, ne2 = %d\n
-00058470: 222c 2064 7374 2d3e 6e65 5b30 5d2c 2064  ", dst->ne[0], d
-00058480: 7374 2d3e 6e65 5b31 5d2c 2064 7374 2d3e  st->ne[1], dst->
-00058490: 6e65 5b32 5d29 3b0a 2020 2020 2f2f 6966  ne[2]);.    //if
-000584a0: 2028 6669 7273 7429 207b 0a20 2020 202f   (first) {.    /
-000584b0: 2f20 2020 2066 6972 7374 203d 2066 616c  /    first = fal
-000584c0: 7365 3b0a 2020 2020 2f2f 7d20 656c 7365  se;.    //} else
-000584d0: 207b 0a20 2020 202f 2f20 2020 2066 6f72   {.    //    for
-000584e0: 2028 696e 7420 6b20 3d20 303b 206b 203c   (int k = 0; k <
-000584f0: 2064 7374 2d3e 6e65 5b31 5d3b 202b 2b6b   dst->ne[1]; ++k
-00058500: 2920 7b0a 2020 2020 2f2f 2020 2020 2020  ) {.    //      
-00058510: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
-00058520: 3b20 6a20 3c20 6473 742d 3e6e 655b 305d  ; j < dst->ne[0]
-00058530: 2f31 363b 202b 2b6a 2920 7b0a 2020 2020  /16; ++j) {.    
-00058540: 2f2f 2020 2020 2020 2020 2020 2020 666f  //            fo
-00058550: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00058560: 3c20 3136 3b20 2b2b 6929 207b 0a20 2020  < 16; ++i) {.   
-00058570: 202f 2f20 2020 2020 2020 2020 2020 2020   //             
-00058580: 2020 2070 7269 6e74 6628 2225 382e 3466     printf("%8.4f
-00058590: 2022 2c20 2828 666c 6f61 7420 2a29 2064   ", ((float *) d
-000585a0: 7374 2d3e 6461 7461 295b 6b2a 6473 742d  st->data)[k*dst-
-000585b0: 3e6e 655b 305d 202b 206a 2a31 3620 2b20  >ne[0] + j*16 + 
-000585c0: 695d 293b 0a20 2020 202f 2f20 2020 2020  i]);.    //     
-000585d0: 2020 2020 2020 207d 0a20 2020 202f 2f20         }.    // 
-000585e0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-000585f0: 6628 225c 6e22 293b 0a20 2020 202f 2f20  f("\n");.    // 
-00058600: 2020 2020 2020 207d 0a20 2020 202f 2f20         }.    // 
-00058610: 2020 2020 2020 2070 7269 6e74 6628 225c         printf("\
-00058620: 6e22 293b 0a20 2020 202f 2f20 2020 207d  n");.    //    }
-00058630: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
-00058640: 6628 225c 6e22 293b 0a20 2020 202f 2f20  f("\n");.    // 
-00058650: 2020 2065 7869 7428 3029 3b0a 2020 2020     exit(0);.    
-00058660: 2f2f 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63  //}.}..// ggml_c
-00058670: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
-00058680: 6574 5f72 6f77 735f 6261 636b 0a0a 7374  et_rows_back..st
-00058690: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-000586a0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
-000586b0: 6574 5f72 6f77 735f 6261 636b 5f66 3332  et_rows_back_f32
-000586c0: 5f66 3136 280a 2020 2020 2020 2020 636f  _f16(.        co
-000586d0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000586e0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-000586f0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00058700: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00058710: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-00058720: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00058730: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00058740: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
-00058750: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00058760: 6767 6d6c 5f74 656e 736f 7220 2a20 6f70  ggml_tensor * op
-00058770: 7430 2c0a 2020 2020 2020 2020 2020 2020  t0,.            
-00058780: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00058790: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-000587a0: 2020 4747 4d4c 5f41 5353 4552 5428 7061    GGML_ASSERT(pa
-000587b0: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
-000587c0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000587d0: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
-000587e0: 6861 7065 286f 7074 302c 2064 7374 2929  hape(opt0, dst))
-000587f0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00058800: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-00058810: 756f 7573 286f 7074 3029 293b 0a20 2020  uous(opt0));.   
-00058820: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
-00058830: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-00058840: 6473 7429 293b 0a0a 2020 2020 6767 6d6c  dst));..    ggml
-00058850: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00058860: 5f64 7570 5f73 616d 655f 636f 6e74 2870  _dup_same_cont(p
-00058870: 6172 616d 732c 206f 7074 302c 2064 7374  arams, opt0, dst
-00058880: 293b 0a0a 2020 2020 6966 2028 7061 7261  );..    if (para
-00058890: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-000588a0: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
-000588b0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-000588c0: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-000588d0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-000588e0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
-000588f0: 6f6e 7374 2069 6e74 206e 6320 3d20 7372  onst int nc = sr
-00058900: 6330 2d3e 6e65 5b30 5d3b 0a20 2020 2063  c0->ne[0];.    c
-00058910: 6f6e 7374 2069 6e74 206e 7220 3d20 6767  onst int nr = gg
-00058920: 6d6c 5f6e 656c 656d 656e 7473 2873 7263  ml_nelements(src
-00058930: 3129 3b0a 0a20 2020 2047 474d 4c5f 4153  1);..    GGML_AS
-00058940: 5345 5254 2820 6473 742d 3e6e 655b 305d  SERT( dst->ne[0]
-00058950: 203d 3d20 6e63 293b 0a20 2020 2047 474d   == nc);.    GGM
-00058960: 4c5f 4153 5345 5254 2873 7263 302d 3e6e  L_ASSERT(src0->n
-00058970: 625b 305d 203d 3d20 7369 7a65 6f66 2867  b[0] == sizeof(g
-00058980: 676d 6c5f 6670 3136 5f74 2929 3b0a 0a20  gml_fp16_t));.. 
-00058990: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-000589a0: 303b 2069 203c 206e 723b 202b 2b69 2920  0; i < nr; ++i) 
-000589b0: 7b0a 2020 2020 2020 2020 636f 6e73 7420  {.        const 
-000589c0: 696e 7420 7220 3d20 2828 696e 7433 325f  int r = ((int32_
-000589d0: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
-000589e0: 5b69 5d3b 0a0a 2020 2020 2020 2020 666f  [i];..        fo
-000589f0: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
-00058a00: 3c20 6e63 3b20 2b2b 6a29 207b 0a20 2020  < nc; ++j) {.   
-00058a10: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
-00058a20: 3136 5f74 2076 203d 2028 2867 676d 6c5f  16_t v = ((ggml_
-00058a30: 6670 3136 5f74 202a 2920 2828 6368 6172  fp16_t *) ((char
-00058a40: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-00058a50: 2069 2a73 7263 302d 3e6e 625b 315d 2929   i*src0->nb[1]))
-00058a60: 5b6a 5d3b 0a20 2020 2020 2020 2020 2020  [j];.           
-00058a70: 2028 2866 6c6f 6174 202a 2920 2828 6368   ((float *) ((ch
-00058a80: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
-00058a90: 2b20 722a 6473 742d 3e6e 625b 315d 2929  + r*dst->nb[1]))
-00058aa0: 5b6a 5d20 2b3d 2047 474d 4c5f 4650 3136  [j] += GGML_FP16
-00058ab0: 5f54 4f5f 4650 3332 2876 293b 0a20 2020  _TO_FP32(v);.   
-00058ac0: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
-00058ad0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-00058ae0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00058af0: 5f67 6574 5f72 6f77 735f 6261 636b 5f66  _get_rows_back_f
-00058b00: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
-00058b10: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00058b20: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00058b30: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00058b40: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00058b50: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00058b60: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00058b70: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00058b80: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-00058b90: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00058ba0: 6d6c 5f74 656e 736f 7220 2a20 6f70 7430  ml_tensor * opt0
-00058bb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00058bc0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00058bd0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00058be0: 4747 4d4c 5f41 5353 4552 5428 7061 7261  GGML_ASSERT(para
-00058bf0: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a20  ms->ith == 0);. 
-00058c00: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-00058c10: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
-00058c20: 7065 286f 7074 302c 2064 7374 2929 3b0a  pe(opt0, dst));.
-00058c30: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00058c40: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
-00058c50: 7573 286f 7074 3029 293b 0a20 2020 2047  us(opt0));.    G
-00058c60: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-00058c70: 6973 5f63 6f6e 7469 6775 6f75 7328 6473  is_contiguous(ds
-00058c80: 7429 293b 0a0a 2020 2020 2f2f 2067 676d  t));..    // ggm
-00058c90: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00058ca0: 645f 6475 705f 7361 6d65 5f63 6f6e 7428  d_dup_same_cont(
-00058cb0: 7061 7261 6d73 2c20 6f70 7430 2c20 6473  params, opt0, ds
-00058cc0: 7429 3b0a 0a20 2020 2069 6620 2870 6172  t);..    if (par
-00058cd0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-00058ce0: 4c5f 5441 534b 5f49 4e49 5429 207b 0a20  L_TASK_INIT) {. 
-00058cf0: 2020 2020 2020 206d 656d 7365 7428 6473         memset(ds
-00058d00: 742d 3e64 6174 612c 2030 2c20 6767 6d6c  t->data, 0, ggml
-00058d10: 5f6e 6279 7465 7328 6473 7429 293b 0a20  _nbytes(dst));. 
-00058d20: 2020 207d 0a0a 2020 2020 6966 2028 7061     }..    if (pa
-00058d30: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00058d40: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-00058d50: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00058d60: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00058d70: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-00058d80: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00058d90: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
-00058da0: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
-00058db0: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
-00058dc0: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-00058dd0: 7263 3129 3b0a 0a20 2020 2047 474d 4c5f  rc1);..    GGML_
-00058de0: 4153 5345 5254 2820 6473 742d 3e6e 655b  ASSERT( dst->ne[
-00058df0: 305d 203d 3d20 6e63 293b 0a20 2020 2047  0] == nc);.    G
-00058e00: 474d 4c5f 4153 5345 5254 2873 7263 302d  GML_ASSERT(src0-
-00058e10: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-00058e20: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
-00058e30: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00058e40: 203c 206e 723b 202b 2b69 2920 7b0a 2020   < nr; ++i) {.  
-00058e50: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00058e60: 7220 3d20 2828 696e 7433 325f 7420 2a29  r = ((int32_t *)
-00058e70: 2073 7263 312d 3e64 6174 6129 5b69 5d3b   src1->data)[i];
-00058e80: 0a0a 2020 2020 2020 2020 6767 6d6c 5f76  ..        ggml_v
-00058e90: 6563 5f61 6464 5f66 3332 286e 632c 0a20  ec_add_f32(nc,. 
-00058ea0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00058eb0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00058ec0: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
-00058ed0: 722a 6473 742d 3e6e 625b 315d 292c 0a20  r*dst->nb[1]),. 
-00058ee0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00058ef0: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00058f00: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
-00058f10: 722a 6473 742d 3e6e 625b 315d 292c 0a20  r*dst->nb[1]),. 
-00058f20: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00058f30: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
-00058f40: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00058f50: 692a 7372 6330 2d3e 6e62 5b31 5d29 293b  i*src0->nb[1]));
-00058f60: 0a20 2020 207d 0a7d 0a0a 0a73 7461 7469  .    }.}...stati
-00058f70: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00058f80: 7574 655f 666f 7277 6172 645f 6765 745f  ute_forward_get_
-00058f90: 726f 7773 5f62 6163 6b28 0a20 2020 2020  rows_back(.     
-00058fa0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00058fb0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00058fc0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00058fd0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00058fe0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00058ff0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
-00059000: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00059010: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
-00059020: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00059030: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00059040: 202a 206f 7074 302c 0a20 2020 2020 2020   * opt0,.       
-00059050: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00059060: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00059070: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-00059080: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-00059090: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
-000590a0: 363a 0a20 2020 2020 2020 2020 2020 207b  6:.            {
-000590b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000590c0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-000590d0: 7277 6172 645f 6765 745f 726f 7773 5f62  rward_get_rows_b
-000590e0: 6163 6b5f 6633 325f 6631 3628 7061 7261  ack_f32_f16(para
-000590f0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
-00059100: 6f70 7430 2c20 6473 7429 3b0a 2020 2020  opt0, dst);.    
-00059110: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00059120: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00059130: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
-00059140: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00059150: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00059160: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00059170: 6765 745f 726f 7773 5f62 6163 6b5f 6633  get_rows_back_f3
-00059180: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
-00059190: 7372 6331 2c20 6f70 7430 2c20 6473 7429  src1, opt0, dst)
-000591a0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000591b0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
-000591c0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-000591d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000591e0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-000591f0: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-00059200: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00059210: 2020 207d 0a0a 2020 2020 2f2f 7374 6174     }..    //stat
-00059220: 6963 2062 6f6f 6c20 6669 7273 7420 3d20  ic bool first = 
-00059230: 7472 7565 3b0a 2020 2020 2f2f 7072 696e  true;.    //prin
-00059240: 7466 2822 6e65 3020 3d20 2564 2c20 6e65  tf("ne0 = %d, ne
-00059250: 3120 3d20 2564 2c20 6e65 3220 3d20 2564  1 = %d, ne2 = %d
-00059260: 5c6e 222c 2064 7374 2d3e 6e65 5b30 5d2c  \n", dst->ne[0],
-00059270: 2064 7374 2d3e 6e65 5b31 5d2c 2064 7374   dst->ne[1], dst
-00059280: 2d3e 6e65 5b32 5d29 3b0a 2020 2020 2f2f  ->ne[2]);.    //
-00059290: 6966 2028 6669 7273 7429 207b 0a20 2020  if (first) {.   
-000592a0: 202f 2f20 2020 2066 6972 7374 203d 2066   //    first = f
-000592b0: 616c 7365 3b0a 2020 2020 2f2f 7d20 656c  alse;.    //} el
-000592c0: 7365 207b 0a20 2020 202f 2f20 2020 2066  se {.    //    f
-000592d0: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
-000592e0: 203c 2064 7374 2d3e 6e65 5b31 5d3b 202b   < dst->ne[1]; +
-000592f0: 2b6b 2920 7b0a 2020 2020 2f2f 2020 2020  +k) {.    //    
-00059300: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
-00059310: 2030 3b20 6a20 3c20 6473 742d 3e6e 655b   0; j < dst->ne[
-00059320: 305d 2f31 363b 202b 2b6a 2920 7b0a 2020  0]/16; ++j) {.  
-00059330: 2020 2f2f 2020 2020 2020 2020 2020 2020    //            
-00059340: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00059350: 6920 3c20 3136 3b20 2b2b 6929 207b 0a20  i < 16; ++i) {. 
-00059360: 2020 202f 2f20 2020 2020 2020 2020 2020     //           
-00059370: 2020 2020 2070 7269 6e74 6628 2225 382e       printf("%8.
-00059380: 3466 2022 2c20 2828 666c 6f61 7420 2a29  4f ", ((float *)
-00059390: 2064 7374 2d3e 6461 7461 295b 6b2a 6473   dst->data)[k*ds
-000593a0: 742d 3e6e 655b 305d 202b 206a 2a31 3620  t->ne[0] + j*16 
-000593b0: 2b20 695d 293b 0a20 2020 202f 2f20 2020  + i]);.    //   
-000593c0: 2020 2020 2020 2020 207d 0a20 2020 202f           }.    /
-000593d0: 2f20 2020 2020 2020 2020 2020 2070 7269  /            pri
-000593e0: 6e74 6628 225c 6e22 293b 0a20 2020 202f  ntf("\n");.    /
-000593f0: 2f20 2020 2020 2020 207d 0a20 2020 202f  /        }.    /
-00059400: 2f20 2020 2020 2020 2070 7269 6e74 6628  /        printf(
-00059410: 225c 6e22 293b 0a20 2020 202f 2f20 2020  "\n");.    //   
-00059420: 207d 0a20 2020 202f 2f20 2020 2070 7269   }.    //    pri
-00059430: 6e74 6628 225c 6e22 293b 0a20 2020 202f  ntf("\n");.    /
-00059440: 2f20 2020 2065 7869 7428 3029 3b0a 2020  /    exit(0);.  
-00059450: 2020 2f2f 7d0a 7d0a 0a2f 2f20 6767 6d6c    //}.}..// ggml
-00059460: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00059470: 5f64 6961 670a 0a73 7461 7469 6320 766f  _diag..static vo
-00059480: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00059490: 666f 7277 6172 645f 6469 6167 5f66 3332  forward_diag_f32
-000594a0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-000594b0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-000594c0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-000594d0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-000594e0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000594f0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00059500: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00059510: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00059520: 7b0a 2020 2020 4747 4d4c 5f41 5353 4552  {.    GGML_ASSER
-00059530: 5428 7061 7261 6d73 2d3e 6974 6820 3d3d  T(params->ith ==
-00059540: 2030 293b 0a0a 2020 2020 6966 2028 7061   0);..    if (pa
-00059550: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00059560: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-00059570: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00059580: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00059590: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-000595a0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-000595b0: 202f 2f20 544f 444f 3a20 6861 6e64 6c65   // TODO: handle
-000595c0: 2074 7261 6e73 706f 7365 642f 7065 726d   transposed/perm
-000595d0: 7574 6564 206d 6174 7269 6365 730a 0a20  uted matrices.. 
-000595e0: 2020 2047 474d 4c5f 5445 4e53 4f52 5f55     GGML_TENSOR_U
-000595f0: 4e41 5259 5f4f 505f 4c4f 4341 4c53 3b0a  NARY_OP_LOCALS;.
-00059600: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00059610: 286e 6530 3020 3d3d 206e 6530 293b 0a20  (ne00 == ne0);. 
-00059620: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00059630: 6530 3020 3d3d 206e 6531 293b 0a20 2020  e00 == ne1);.   
-00059640: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
-00059650: 3120 3d3d 2031 293b 0a20 2020 2047 474d  1 == 1);.    GGM
-00059660: 4c5f 4153 5345 5254 286e 6530 3220 3d3d  L_ASSERT(ne02 ==
-00059670: 206e 6532 293b 0a20 2020 2047 474d 4c5f   ne2);.    GGML_
-00059680: 4153 5345 5254 286e 6530 3320 3d3d 206e  ASSERT(ne03 == n
-00059690: 6533 293b 0a0a 2020 2020 4747 4d4c 5f41  e3);..    GGML_A
-000596a0: 5353 4552 5428 6e62 3030 203d 3d20 7369  SSERT(nb00 == si
-000596b0: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
-000596c0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-000596d0: 3020 203d 3d20 7369 7a65 6f66 2866 6c6f  0  == sizeof(flo
-000596e0: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
-000596f0: 696e 7420 6933 203d 2030 3b20 6933 203c  int i3 = 0; i3 <
-00059700: 206e 6533 3b20 6933 2b2b 2920 7b0a 2020   ne3; i3++) {.  
-00059710: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00059720: 3220 3d20 303b 2069 3220 3c20 6e65 323b  2 = 0; i2 < ne2;
-00059730: 2069 322b 2b29 207b 0a20 2020 2020 2020   i2++) {.       
-00059740: 2020 2020 2066 6f72 2028 696e 7420 6931       for (int i1
-00059750: 203d 2030 3b20 6931 203c 206e 6531 3b20   = 0; i1 < ne1; 
-00059760: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
-00059770: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00059780: 6420 3d20 2866 6c6f 6174 202a 2928 2863  d = (float *)((c
-00059790: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
-000597a0: 6120 2b20 6933 2a6e 6233 2020 2b20 6932  a + i3*nb3  + i2
-000597b0: 2a6e 6232 202b 2069 312a 6e62 3129 3b0a  *nb2 + i1*nb1);.
-000597c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000597d0: 666c 6f61 7420 2a20 7320 3d20 2866 6c6f  float * s = (flo
-000597e0: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
-000597f0: 7263 302d 3e64 6174 6120 2b20 6933 2a6e  rc0->data + i3*n
-00059800: 6230 3320 2b20 6932 2a6e 6230 3229 3b0a  b03 + i2*nb02);.
-00059810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00059820: 666f 7220 2869 6e74 2069 3020 3d20 303b  for (int i0 = 0;
-00059830: 2069 3020 3c20 6931 3b20 6930 2b2b 2920   i0 < i1; i0++) 
-00059840: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00059850: 2020 2020 2020 645b 6930 5d20 3d20 303b        d[i0] = 0;
-00059860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00059870: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00059880: 2020 2064 5b69 315d 203d 2073 5b69 315d     d[i1] = s[i1]
-00059890: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000598a0: 2020 666f 7220 2869 6e74 2069 3020 3d20    for (int i0 = 
-000598b0: 6931 2b31 3b20 6930 203c 206e 6530 3b20  i1+1; i0 < ne0; 
-000598c0: 6930 2b2b 2920 7b0a 2020 2020 2020 2020  i0++) {.        
-000598d0: 2020 2020 2020 2020 2020 2020 645b 6930              d[i0
-000598e0: 5d20 3d20 303b 0a20 2020 2020 2020 2020  ] = 0;.         
-000598f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00059900: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00059910: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
-00059920: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00059930: 7465 5f66 6f72 7761 7264 5f64 6961 6728  te_forward_diag(
-00059940: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00059950: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-00059960: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-00059970: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-00059980: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00059990: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-000599a0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000599b0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-000599c0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-000599d0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-000599e0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-000599f0: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-00059a00: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00059a10: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00059a20: 655f 666f 7277 6172 645f 6469 6167 5f66  e_forward_diag_f
-00059a30: 3332 2870 6172 616d 732c 2073 7263 302c  32(params, src0,
-00059a40: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00059a50: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00059a60: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-00059a70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00059a80: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00059a90: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-00059aa0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00059ab0: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-00059ac0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00059ad0: 7761 7264 5f64 6961 675f 6d61 736b 5f69  ward_diag_mask_i
-00059ae0: 6e66 0a0a 7374 6174 6963 2076 6f69 6420  nf..static void 
-00059af0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00059b00: 7761 7264 5f64 6961 675f 6d61 736b 5f66  ward_diag_mask_f
-00059b10: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
-00059b20: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00059b30: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00059b40: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00059b50: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00059b60: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00059b70: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00059b80: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00059b90: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-00059ba0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00059bb0: 736f 7220 2a20 6473 742c 0a20 2020 2020  sor * dst,.     
-00059bc0: 2020 2063 6f6e 7374 2066 6c6f 6174 2076     const float v
-00059bd0: 616c 7565 2920 7b0a 2020 2020 4747 4d4c  alue) {.    GGML
-00059be0: 5f41 5353 4552 5428 7372 6331 2d3e 7479  _ASSERT(src1->ty
-00059bf0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-00059c00: 4933 3229 3b0a 2020 2020 4747 4d4c 5f41  I32);.    GGML_A
-00059c10: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
-00059c20: 656e 7473 2873 7263 3129 203d 3d20 3229  ents(src1) == 2)
-00059c30: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00059c40: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
-00059c50: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-00059c60: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
-00059c70: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
-00059c80: 696e 7420 206e 5f70 6173 7420 203d 2020  int  n_past  =  
-00059c90: 2020 2020 2028 2869 6e74 3332 5f74 202a       ((int32_t *
-00059ca0: 2920 7372 6331 2d3e 6461 7461 295b 305d  ) src1->data)[0]
-00059cb0: 3b0a 2020 2020 636f 6e73 7420 626f 6f6c  ;.    const bool
-00059cc0: 2069 6e70 6c61 6365 203d 2028 626f 6f6c   inplace = (bool
-00059cd0: 2928 2869 6e74 3332 5f74 202a 2920 7372  )((int32_t *) sr
-00059ce0: 6331 2d3e 6461 7461 295b 315d 3b0a 0a20  c1->data)[1];.. 
-00059cf0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00059d00: 5f70 6173 7420 3e3d 2030 293b 0a0a 2020  _past >= 0);..  
-00059d10: 2020 6966 2028 2169 6e70 6c61 6365 2026    if (!inplace &
-00059d20: 2620 2870 6172 616d 732d 3e74 7970 6520  & (params->type 
-00059d30: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-00059d40: 5429 2920 7b0a 2020 2020 2020 2020 2f2f  T)) {.        //
-00059d50: 206d 656d 6370 7920 6e65 6564 7320 746f   memcpy needs to
-00059d60: 2062 6520 7379 6e63 6872 6f6e 697a 6564   be synchronized
-00059d70: 2061 6372 6f73 7320 7468 7265 6164 7320   across threads 
-00059d80: 746f 2061 766f 6964 2072 6163 6520 636f  to avoid race co
-00059d90: 6e64 6974 696f 6e73 2e0a 2020 2020 2020  nditions..      
-00059da0: 2020 2f2f 203d 3e20 646f 2069 7420 696e    // => do it in
-00059db0: 2049 4e49 5420 7068 6173 650a 2020 2020   INIT phase.    
-00059dc0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00059dd0: 6767 6d6c 5f6e 656c 656d 656e 7473 2864  ggml_nelements(d
-00059de0: 7374 2920 3d3d 2067 676d 6c5f 6e65 6c65  st) == ggml_nele
-00059df0: 6d65 6e74 7328 7372 6330 2929 3b0a 2020  ments(src0));.  
-00059e00: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00059e10: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
-00059e20: 756f 7573 2864 7374 2920 2626 2067 676d  uous(dst) && ggm
-00059e30: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
-00059e40: 7372 6330 2929 3b0a 2020 2020 2020 2020  src0));.        
-00059e50: 6d65 6d63 7079 280a 2020 2020 2020 2020  memcpy(.        
-00059e60: 2020 2020 2828 6368 6172 202a 2920 2064      ((char *)  d
-00059e70: 7374 2d3e 6461 7461 292c 0a20 2020 2020  st->data),.     
-00059e80: 2020 2020 2020 2028 2863 6861 7220 2a29         ((char *)
-00059e90: 2073 7263 302d 3e64 6174 6129 2c0a 2020   src0->data),.  
-00059ea0: 2020 2020 2020 2020 2020 6767 6d6c 5f6e            ggml_n
-00059eb0: 6279 7465 7328 6473 7429 293b 0a20 2020  bytes(dst));.   
-00059ec0: 207d 0a0a 2020 2020 6966 2028 7061 7261   }..    if (para
-00059ed0: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00059ee0: 5f54 4153 4b5f 494e 4954 207c 7c20 7061  _TASK_INIT || pa
-00059ef0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00059f00: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
-00059f10: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-00059f20: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
-00059f30: 2f20 544f 444f 3a20 6861 6e64 6c65 2074  / TODO: handle t
-00059f40: 7261 6e73 706f 7365 642f 7065 726d 7574  ransposed/permut
-00059f50: 6564 206d 6174 7269 6365 730a 0a20 2020  ed matrices..   
-00059f60: 2063 6f6e 7374 2069 6e74 206e 2020 3d20   const int n  = 
-00059f70: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
-00059f80: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00059f90: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
-00059fa0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00059fb0: 6e72 203d 2073 7263 302d 3e6e 655b 315d  nr = src0->ne[1]
-00059fc0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00059fd0: 6e7a 203d 206e 2f6e 723b 0a0a 2020 2020  nz = n/nr;..    
-00059fe0: 4747 4d4c 5f41 5353 4552 5428 2064 7374  GGML_ASSERT( dst
-00059ff0: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
-0005a000: 6628 666c 6f61 7429 293b 0a20 2020 2047  f(float));.    G
-0005a010: 474d 4c5f 4153 5345 5254 2873 7263 302d  GML_ASSERT(src0-
-0005a020: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
-0005a030: 2866 6c6f 6174 2929 3b0a 0a20 2020 2066  (float));..    f
-0005a040: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
-0005a050: 203c 206e 7a3b 206b 2b2b 2920 7b0a 2020   < nz; k++) {.  
-0005a060: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-0005a070: 203d 2069 7468 3b20 6a20 3c20 6e72 3b20   = ith; j < nr; 
-0005a080: 6a20 2b3d 206e 7468 2920 7b0a 2020 2020  j += nth) {.    
-0005a090: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005a0a0: 2069 203d 206e 5f70 6173 743b 2069 203c   i = n_past; i <
-0005a0b0: 206e 633b 2069 2b2b 2920 7b0a 2020 2020   nc; i++) {.    
-0005a0c0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0005a0d0: 6920 3e20 6e5f 7061 7374 202b 206a 2920  i > n_past + j) 
-0005a0e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0005a0f0: 2020 2020 2020 2a28 666c 6f61 7420 2a29        *(float *)
-0005a100: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
-0005a110: 6174 6120 2b20 6b2a 6473 742d 3e6e 625b  ata + k*dst->nb[
-0005a120: 325d 202b 206a 2a64 7374 2d3e 6e62 5b31  2] + j*dst->nb[1
-0005a130: 5d20 2b20 692a 6473 742d 3e6e 625b 305d  ] + i*dst->nb[0]
-0005a140: 2920 3d20 7661 6c75 653b 0a20 2020 2020  ) = value;.     
-0005a150: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0005a160: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0005a170: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-0005a180: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-0005a190: 6f6d 7075 7465 5f66 6f72 7761 7264 5f64  ompute_forward_d
-0005a1a0: 6961 675f 6d61 736b 5f69 6e66 280a 2020  iag_mask_inf(.  
-0005a1b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0005a1c0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-0005a1d0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-0005a1e0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0005a1f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0005a200: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-0005a210: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005a220: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-0005a230: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
-0005a240: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005a250: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
-0005a260: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
-0005a270: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0005a280: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
-0005a290: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0005a2a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0005a2b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005a2c0: 6469 6167 5f6d 6173 6b5f 6633 3228 7061  diag_mask_f32(pa
-0005a2d0: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
-0005a2e0: 2c20 6473 742c 202d 494e 4649 4e49 5459  , dst, -INFINITY
-0005a2f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0005a300: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0005a310: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-0005a320: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0005a330: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0005a340: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-0005a350: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0005a360: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-0005a370: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-0005a380: 655f 666f 7277 6172 645f 6469 6167 5f6d  e_forward_diag_m
-0005a390: 6173 6b5f 7a65 726f 280a 2020 2020 2020  ask_zero(.      
-0005a3a0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005a3b0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0005a3c0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0005a3d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005a3e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005a3f0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0005a400: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0005a410: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0005a420: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0005a430: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0005a440: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
-0005a450: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
-0005a460: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0005a470: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-0005a480: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0005a490: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-0005a4a0: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
-0005a4b0: 5f6d 6173 6b5f 6633 3228 7061 7261 6d73  _mask_f32(params
-0005a4c0: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
-0005a4d0: 742c 2030 293b 0a20 2020 2020 2020 2020  t, 0);.         
-0005a4e0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0005a4f0: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-0005a500: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0005a510: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-0005a520: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-0005a530: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0005a540: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-0005a550: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0005a560: 7761 7264 5f73 6f66 745f 6d61 780a 0a73  ward_soft_max..s
-0005a570: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0005a580: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005a590: 736f 6674 5f6d 6178 5f66 3332 280a 2020  soft_max_f32(.  
-0005a5a0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0005a5b0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-0005a5c0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-0005a5d0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0005a5e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0005a5f0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
-0005a600: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0005a610: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-0005a620: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-0005a630: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-0005a640: 2873 7263 3029 293b 0a20 2020 2047 474d  (src0));.    GGM
-0005a650: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-0005a660: 5f63 6f6e 7469 6775 6f75 7328 6473 7429  _contiguous(dst)
-0005a670: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0005a680: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
-0005a690: 5f73 6861 7065 2873 7263 302c 2064 7374  _shape(src0, dst
-0005a6a0: 2929 3b0a 0a20 2020 2069 6620 2870 6172  ));..    if (par
-0005a6b0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0005a6c0: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-0005a6d0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-0005a6e0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-0005a6f0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-0005a700: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-0005a710: 2f2f 2054 4f44 4f3a 2068 616e 646c 6520  // TODO: handle 
-0005a720: 7472 616e 7370 6f73 6564 2f70 6572 6d75  transposed/permu
-0005a730: 7465 6420 6d61 7472 6963 6573 0a0a 2020  ted matrices..  
-0005a740: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-0005a750: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
-0005a760: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-0005a770: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
-0005a780: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005a790: 6320 3d20 7372 6330 2d3e 6e65 5b30 5d3b  c = src0->ne[0];
-0005a7a0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005a7b0: 7220 3d20 6767 6d6c 5f6e 726f 7773 2873  r = ggml_nrows(s
-0005a7c0: 7263 3029 3b0a 0a20 2020 202f 2f20 726f  rc0);..    // ro
-0005a7d0: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-0005a7e0: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
-0005a7f0: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
-0005a800: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
-0005a810: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
-0005a820: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-0005a830: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
-0005a840: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-0005a850: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-0005a860: 2064 722c 206e 7229 3b0a 0a20 2020 2066   dr, nr);..    f
-0005a870: 6f72 2028 696e 7420 6931 203d 2069 7230  or (int i1 = ir0
-0005a880: 3b20 6931 203c 2069 7231 3b20 6931 2b2b  ; i1 < ir1; i1++
-0005a890: 2920 7b0a 2020 2020 2020 2020 666c 6f61  ) {.        floa
-0005a8a0: 7420 2a73 7020 3d20 2866 6c6f 6174 202a  t *sp = (float *
-0005a8b0: 2928 2863 6861 7220 2a29 2073 7263 302d  )((char *) src0-
-0005a8c0: 3e64 6174 6120 2b20 6931 2a73 7263 302d  >data + i1*src0-
-0005a8d0: 3e6e 625b 315d 293b 0a20 2020 2020 2020  >nb[1]);.       
-0005a8e0: 2066 6c6f 6174 202a 6470 203d 2028 666c   float *dp = (fl
-0005a8f0: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-0005a900: 2064 7374 2d3e 6461 7461 202b 2020 6931   dst->data +  i1
-0005a910: 2a64 7374 2d3e 6e62 5b31 5d29 3b0a 0a23  *dst->nb[1]);..#
-0005a920: 6966 6e64 6566 204e 4445 4255 470a 2020  ifndef NDEBUG.  
-0005a930: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-0005a940: 203d 2030 3b20 6920 3c20 6e63 3b20 2b2b   = 0; i < nc; ++
-0005a950: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
-0005a960: 202f 2f70 7269 6e74 6628 2270 5b25 645d   //printf("p[%d]
-0005a970: 203d 2025 665c 6e22 2c20 692c 2070 5b69   = %f\n", i, p[i
-0005a980: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
-0005a990: 6173 7365 7274 2821 6973 6e61 6e28 7370  assert(!isnan(sp
-0005a9a0: 5b69 5d29 293b 0a20 2020 2020 2020 207d  [i]));.        }
-0005a9b0: 0a23 656e 6469 660a 0a20 2020 2020 2020  .#endif..       
-0005a9c0: 2066 6c6f 6174 206d 6178 203d 202d 494e   float max = -IN
-0005a9d0: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
-0005a9e0: 6767 6d6c 5f76 6563 5f6d 6178 5f66 3332  ggml_vec_max_f32
-0005a9f0: 286e 632c 2026 6d61 782c 2073 7029 3b0a  (nc, &max, sp);.
-0005aa00: 0a20 2020 2020 2020 2067 676d 6c5f 666c  .        ggml_fl
-0005aa10: 6f61 7420 7375 6d20 3d20 302e 303b 0a0a  oat sum = 0.0;..
-0005aa20: 2020 2020 2020 2020 7569 6e74 3136 5f74          uint16_t
-0005aa30: 2073 6376 743b 0a20 2020 2020 2020 2066   scvt;.        f
-0005aa40: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0005aa50: 203c 206e 633b 2069 2b2b 2920 7b0a 2020   < nc; i++) {.  
-0005aa60: 2020 2020 2020 2020 2020 6966 2028 7370            if (sp
-0005aa70: 5b69 5d20 3d3d 202d 494e 4649 4e49 5459  [i] == -INFINITY
-0005aa80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005aa90: 2020 2020 6470 5b69 5d20 3d20 302e 3066      dp[i] = 0.0f
-0005aaa0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-0005aab0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-0005aac0: 2020 2020 2020 202f 2f20 636f 6e73 7420         // const 
-0005aad0: 666c 6f61 7420 7661 6c20 3d20 2873 705b  float val = (sp[
-0005aae0: 695d 203d 3d20 2d49 4e46 494e 4954 5929  i] == -INFINITY)
-0005aaf0: 203f 2030 2e30 203a 2065 7870 2873 705b   ? 0.0 : exp(sp[
-0005ab00: 695d 202d 206d 6178 293b 0a20 2020 2020  i] - max);.     
-0005ab10: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0005ab20: 6670 3136 5f74 2073 203d 2047 474d 4c5f  fp16_t s = GGML_
-0005ab30: 4650 3332 5f54 4f5f 4650 3136 2873 705b  FP32_TO_FP16(sp[
-0005ab40: 695d 202d 206d 6178 293b 0a20 2020 2020  i] - max);.     
-0005ab50: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
-0005ab60: 7928 2673 6376 742c 2026 732c 2073 697a  y(&scvt, &s, siz
-0005ab70: 656f 6628 7363 7674 2929 3b0a 2020 2020  eof(scvt));.    
-0005ab80: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005ab90: 7420 666c 6f61 7420 7661 6c20 3d20 4747  t float val = GG
-0005aba0: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-0005abb0: 7461 626c 655f 6578 705f 6631 365b 7363  table_exp_f16[sc
-0005abc0: 7674 5d29 3b0a 2020 2020 2020 2020 2020  vt]);.          
-0005abd0: 2020 2020 2020 7375 6d20 2b3d 2028 6767        sum += (gg
-0005abe0: 6d6c 5f66 6c6f 6174 2976 616c 3b0a 2020  ml_float)val;.  
-0005abf0: 2020 2020 2020 2020 2020 2020 2020 6470                dp
-0005ac00: 5b69 5d20 3d20 7661 6c3b 0a20 2020 2020  [i] = val;.     
-0005ac10: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0005ac20: 207d 0a0a 2020 2020 2020 2020 6173 7365   }..        asse
-0005ac30: 7274 2873 756d 203e 2030 2e30 293b 0a0a  rt(sum > 0.0);..
-0005ac40: 2020 2020 2020 2020 7375 6d20 3d20 312e          sum = 1.
-0005ac50: 302f 7375 6d3b 0a20 2020 2020 2020 2067  0/sum;.        g
-0005ac60: 676d 6c5f 7665 635f 7363 616c 655f 6633  gml_vec_scale_f3
-0005ac70: 3228 6e63 2c20 6470 2c20 7375 6d29 3b0a  2(nc, dp, sum);.
-0005ac80: 0a23 6966 6e64 6566 204e 4445 4255 470a  .#ifndef NDEBUG.
-0005ac90: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005aca0: 2069 203d 2030 3b20 6920 3c20 6e63 3b20   i = 0; i < nc; 
-0005acb0: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
-0005acc0: 2020 2061 7373 6572 7428 2169 736e 616e     assert(!isnan
-0005acd0: 2864 705b 695d 2929 3b0a 2020 2020 2020  (dp[i]));.      
-0005ace0: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
-0005acf0: 696e 6628 6470 5b69 5d29 293b 0a20 2020  inf(dp[i]));.   
-0005ad00: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
-0005ad10: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-0005ad20: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-0005ad30: 666f 7277 6172 645f 736f 6674 5f6d 6178  forward_soft_max
-0005ad40: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-0005ad50: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-0005ad60: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-0005ad70: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-0005ad80: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0005ad90: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-0005ada0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0005adb0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-0005adc0: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
-0005add0: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
-0005ade0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0005adf0: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-0005ae00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0005ae10: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-0005ae20: 7465 5f66 6f72 7761 7264 5f73 6f66 745f  te_forward_soft_
-0005ae30: 6d61 785f 6633 3228 7061 7261 6d73 2c20  max_f32(params, 
-0005ae40: 7372 6330 2c20 6473 7429 3b0a 2020 2020  src0, dst);.    
-0005ae50: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0005ae60: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
-0005ae70: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0005ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ae90: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0005aea0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0005aeb0: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
-0005aec0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
-0005aed0: 655f 666f 7277 6172 645f 736f 6674 5f6d  e_forward_soft_m
-0005aee0: 6178 5f62 6163 6b0a 0a73 7461 7469 6320  ax_back..static 
-0005aef0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-0005af00: 655f 666f 7277 6172 645f 736f 6674 5f6d  e_forward_soft_m
-0005af10: 6178 5f62 6163 6b5f 6633 3228 0a20 2020  ax_back_f32(.   
-0005af20: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005af30: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-0005af40: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-0005af50: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0005af60: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0005af70: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-0005af80: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0005af90: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-0005afa0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0005afb0: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-0005afc0: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-0005afd0: 5353 4552 5428 6767 6d6c 5f69 735f 636f  SSERT(ggml_is_co
-0005afe0: 6e74 6967 756f 7573 2873 7263 3029 293b  ntiguous(src0));
-0005aff0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0005b000: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
-0005b010: 6f75 7328 7372 6331 2929 3b0a 2020 2020  ous(src1));.    
-0005b020: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0005b030: 5f69 735f 636f 6e74 6967 756f 7573 2864  _is_contiguous(d
-0005b040: 7374 2929 3b0a 2020 2020 4747 4d4c 5f41  st));.    GGML_A
-0005b050: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
-0005b060: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-0005b070: 6473 7429 293b 0a20 2020 2047 474d 4c5f  dst));.    GGML_
-0005b080: 4153 5345 5254 2867 676d 6c5f 6172 655f  ASSERT(ggml_are_
-0005b090: 7361 6d65 5f73 6861 7065 2873 7263 312c  same_shape(src1,
-0005b0a0: 2064 7374 2929 3b0a 0a20 2020 2069 6620   dst));..    if 
-0005b0b0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-0005b0c0: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-0005b0d0: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-0005b0e0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-0005b0f0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-0005b100: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-0005b110: 2020 2020 2f2f 2054 4f44 4f3a 2068 616e      // TODO: han
-0005b120: 646c 6520 7472 616e 7370 6f73 6564 2f70  dle transposed/p
-0005b130: 6572 6d75 7465 6420 6d61 7472 6963 6573  ermuted matrices
-0005b140: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-0005b150: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-0005b160: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-0005b170: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
-0005b180: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
-0005b190: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
-0005b1a0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-0005b1b0: 6e74 206e 7220 3d20 6767 6d6c 5f6e 726f  nt nr = ggml_nro
-0005b1c0: 7773 2873 7263 3029 3b0a 0a20 2020 202f  ws(src0);..    /
-0005b1d0: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-0005b1e0: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-0005b1f0: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-0005b200: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-0005b210: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-0005b220: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-0005b230: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-0005b240: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-0005b250: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-0005b260: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-0005b270: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
-0005b280: 2069 7230 3b20 6931 203c 2069 7231 3b20   ir0; i1 < ir1; 
-0005b290: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
-0005b2a0: 666c 6f61 7420 2a64 7920 3d20 2866 6c6f  float *dy = (flo
-0005b2b0: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
-0005b2c0: 7263 302d 3e64 6174 6120 2b20 6931 2a73  rc0->data + i1*s
-0005b2d0: 7263 302d 3e6e 625b 315d 293b 0a20 2020  rc0->nb[1]);.   
-0005b2e0: 2020 2020 2066 6c6f 6174 202a 7920 203d       float *y  =
-0005b2f0: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
-0005b300: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
-0005b310: 2069 312a 7372 6331 2d3e 6e62 5b31 5d29   i1*src1->nb[1])
-0005b320: 3b0a 2020 2020 2020 2020 666c 6f61 7420  ;.        float 
-0005b330: 2a64 7820 3d20 2866 6c6f 6174 202a 2928  *dx = (float *)(
-0005b340: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-0005b350: 7461 2020 2b20 6931 2a64 7374 2d3e 6e62  ta  + i1*dst->nb
-0005b360: 5b31 5d29 3b0a 0a23 6966 6e64 6566 204e  [1]);..#ifndef N
-0005b370: 4445 4255 470a 2020 2020 2020 2020 666f  DEBUG.        fo
-0005b380: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0005b390: 3c20 6e63 3b20 2b2b 6929 207b 0a20 2020  < nc; ++i) {.   
-0005b3a0: 2020 2020 2020 2020 202f 2f70 7269 6e74           //print
-0005b3b0: 6628 2270 5b25 645d 203d 2025 665c 6e22  f("p[%d] = %f\n"
-0005b3c0: 2c20 692c 2070 5b69 5d29 3b0a 2020 2020  , i, p[i]);.    
-0005b3d0: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
-0005b3e0: 6973 6e61 6e28 6479 5b69 5d29 293b 0a20  isnan(dy[i]));. 
-0005b3f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0005b400: 7428 2169 736e 616e 2879 5b69 5d29 293b  t(!isnan(y[i]));
-0005b410: 0a20 2020 2020 2020 207d 0a23 656e 6469  .        }.#endi
-0005b420: 660a 2020 2020 2020 2020 2f2f 204a 6969  f.        // Jii
-0005b430: 203d 2079 6920 2d20 7969 2a79 690a 2020   = yi - yi*yi.  
-0005b440: 2020 2020 2020 2f2f 204a 696a 203d 202d        // Jij = -
-0005b450: 7969 2a79 6a0a 2020 2020 2020 2020 2f2f  yi*yj.        //
-0005b460: 204a 203d 2064 6961 6728 7929 2d79 2e54   J = diag(y)-y.T
-0005b470: 2a79 0a20 2020 2020 2020 202f 2f20 6478  *y.        // dx
-0005b480: 203d 204a 202a 2064 790a 2020 2020 2020   = J * dy.      
-0005b490: 2020 2f2f 2064 786b 203d 2073 756d 5f69    // dxk = sum_i
-0005b4a0: 284a 6b69 202a 2064 7969 290a 2020 2020  (Jki * dyi).    
-0005b4b0: 2020 2020 2f2f 2064 786b 203d 2073 756d      // dxk = sum
-0005b4c0: 5f69 282d 796b 2a79 6920 2a20 6479 6929  _i(-yk*yi * dyi)
-0005b4d0: 202d 2028 2d79 6b2a 796b 292a 6479 6b20   - (-yk*yk)*dyk 
-0005b4e0: 2b20 2879 6b20 2d20 796b 2a79 6b29 2a64  + (yk - yk*yk)*d
-0005b4f0: 796b 0a20 2020 2020 2020 202f 2f20 6478  yk.        // dx
-0005b500: 6b20 3d20 7375 6d5f 6928 2d79 6b2a 7969  k = sum_i(-yk*yi
-0005b510: 202a 2064 7969 2920 2b20 796b 2a64 796b   * dyi) + yk*dyk
-0005b520: 0a20 2020 2020 2020 202f 2f20 6478 6b20  .        // dxk 
-0005b530: 3d20 2d79 6b20 2a20 7375 6d5f 6928 7969  = -yk * sum_i(yi
-0005b540: 202a 2064 7969 2920 2b20 796b 2a64 796b   * dyi) + yk*dyk
-0005b550: 0a20 2020 2020 2020 202f 2f20 6478 6b20  .        // dxk 
-0005b560: 3d20 2d79 6b20 2a20 646f 7428 792c 2064  = -yk * dot(y, d
-0005b570: 7929 202b 2079 6b2a 6479 6b0a 2020 2020  y) + yk*dyk.    
-0005b580: 2020 2020 2f2f 2064 786b 203d 2079 6b20      // dxk = yk 
-0005b590: 2a20 282d 2064 6f74 2879 2c20 6479 2920  * (- dot(y, dy) 
-0005b5a0: 2b20 6479 6b29 0a20 2020 2020 2020 202f  + dyk).        /
-0005b5b0: 2f20 6478 6b20 3d20 796b 202a 2028 6479  / dxk = yk * (dy
-0005b5c0: 6b20 2d20 646f 7428 792c 2064 7929 290a  k - dot(y, dy)).
-0005b5d0: 2020 2020 2020 2020 2f2f 0a20 2020 2020          //.     
-0005b5e0: 2020 202f 2f20 706f 7374 2d6f 7264 6572     // post-order
-0005b5f0: 3a0a 2020 2020 2020 2020 2f2f 2064 6f74  :.        // dot
-0005b600: 5f79 5f64 7920 3a3d 2064 6f74 2879 2c20  _y_dy := dot(y, 
-0005b610: 6479 290a 2020 2020 2020 2020 2f2f 2064  dy).        // d
-0005b620: 7820 3a3d 2064 790a 2020 2020 2020 2020  x := dy.        
-0005b630: 2f2f 2064 7820 3a3d 2064 7820 2d20 646f  // dx := dx - do
-0005b640: 745f 795f 6479 0a20 2020 2020 2020 202f  t_y_dy.        /
-0005b650: 2f20 6478 203a 3d20 6478 202a 2079 0a0a  / dx := dx * y..
-0005b660: 2020 2020 2020 2020 2f2f 206c 696e 6561          // linea
-0005b670: 7220 7275 6e74 696d 652c 206e 6f20 6164  r runtime, no ad
-0005b680: 6469 7469 6f6e 616c 206d 656d 6f72 790a  ditional memory.
-0005b690: 2020 2020 2020 2020 666c 6f61 7420 646f          float do
-0005b6a0: 745f 795f 6479 203d 2030 3b0a 2020 2020  t_y_dy = 0;.    
-0005b6b0: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
-0005b6c0: 5f66 3332 2028 6e63 2c20 2664 6f74 5f79  _f32 (nc, &dot_y
-0005b6d0: 5f64 792c 2079 2c20 6479 293b 0a20 2020  _dy, y, dy);.   
-0005b6e0: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
-0005b6f0: 795f 6633 3220 286e 632c 2064 782c 2064  y_f32 (nc, dx, d
-0005b700: 7929 3b0a 2020 2020 2020 2020 6767 6d6c  y);.        ggml
-0005b710: 5f76 6563 5f61 6363 315f 6633 3228 6e63  _vec_acc1_f32(nc
-0005b720: 2c20 6478 2c20 2d64 6f74 5f79 5f64 7929  , dx, -dot_y_dy)
-0005b730: 3b0a 2020 2020 2020 2020 6767 6d6c 5f76  ;.        ggml_v
-0005b740: 6563 5f6d 756c 5f66 3332 2028 6e63 2c20  ec_mul_f32 (nc, 
-0005b750: 6478 2c20 6478 2c20 7929 3b0a 0a23 6966  dx, dx, y);..#if
-0005b760: 6e64 6566 204e 4445 4255 470a 2020 2020  ndef NDEBUG.    
-0005b770: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-0005b780: 2030 3b20 6920 3c20 6e63 3b20 2b2b 6929   0; i < nc; ++i)
-0005b790: 207b 0a20 2020 2020 2020 2020 2020 2061   {.            a
-0005b7a0: 7373 6572 7428 2169 736e 616e 2864 785b  ssert(!isnan(dx[
-0005b7b0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
-0005b7c0: 2020 6173 7365 7274 2821 6973 696e 6628    assert(!isinf(
-0005b7d0: 6478 5b69 5d29 293b 0a20 2020 2020 2020  dx[i]));.       
-0005b7e0: 207d 0a23 656e 6469 660a 2020 2020 7d0a   }.#endif.    }.
-0005b7f0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-0005b800: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-0005b810: 6172 645f 736f 6674 5f6d 6178 5f62 6163  ard_soft_max_bac
-0005b820: 6b28 0a20 2020 2020 2020 2063 6f6e 7374  k(.        const
-0005b830: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-0005b840: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-0005b850: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-0005b860: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0005b870: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-0005b880: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0005b890: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005b8a0: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
-0005b8b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0005b8c0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-0005b8d0: 7377 6974 6368 2028 7372 6330 2d3e 7479  switch (src0->ty
-0005b8e0: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-0005b8f0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-0005b900: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0005b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005b920: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-0005b930: 7761 7264 5f73 6f66 745f 6d61 785f 6261  ward_soft_max_ba
-0005b940: 636b 5f66 3332 2870 6172 616d 732c 2073  ck_f32(params, s
-0005b950: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
-0005b960: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0005b970: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
-0005b980: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-0005b990: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0005b9a0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-0005b9b0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
-0005b9c0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0005b9d0: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
-0005b9e0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-0005b9f0: 6c69 6269 0a0a 7374 6174 6963 2076 6f69  libi..static voi
-0005ba00: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-0005ba10: 6f72 7761 7264 5f61 6c69 6269 5f66 3332  orward_alibi_f32
-0005ba20: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-0005ba30: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-0005ba40: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-0005ba50: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-0005ba60: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0005ba70: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-0005ba80: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0005ba90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0005baa0: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
-0005bab0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0005bac0: 7220 2a20 6473 7429 207b 0a20 2020 2061  r * dst) {.    a
-0005bad0: 7373 6572 7428 7061 7261 6d73 2d3e 6974  ssert(params->it
-0005bae0: 6820 3d3d 2030 293b 0a0a 2020 2020 4747  h == 0);..    GG
-0005baf0: 4d4c 5f41 5353 4552 5428 7372 6331 2d3e  ML_ASSERT(src1->
-0005bb00: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-0005bb10: 455f 4933 3229 3b0a 2020 2020 4747 4d4c  E_I32);.    GGML
-0005bb20: 5f41 5353 4552 5428 6767 6d6c 5f6e 656c  _ASSERT(ggml_nel
-0005bb30: 656d 656e 7473 2873 7263 3129 203d 3d20  ements(src1) == 
-0005bb40: 3329 3b0a 0a20 2020 2069 6620 2870 6172  3);..    if (par
-0005bb50: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0005bb60: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-0005bb70: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-0005bb80: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-0005bb90: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-0005bba0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-0005bbb0: 636f 6e73 7420 696e 7420 2020 6e5f 7061  const int   n_pa
-0005bbc0: 7374 2020 203d 2028 2869 6e74 3332 5f74  st   = ((int32_t
-0005bbd0: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-0005bbe0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0005bbf0: 7420 2020 6e5f 6865 6164 2020 203d 2028  t   n_head   = (
-0005bc00: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-0005bc10: 2d3e 6461 7461 295b 315d 3b0a 2020 2020  ->data)[1];.    
-0005bc20: 636f 6e73 7420 666c 6f61 7420 6d61 785f  const float max_
-0005bc30: 6269 6173 203d 2028 2866 6c6f 6174 202a  bias = ((float *
-0005bc40: 2920 2020 7372 6331 2d3e 6461 7461 295b  )   src1->data)[
-0005bc50: 325d 3b0a 0a20 2020 2061 7373 6572 7428  2];..    assert(
-0005bc60: 6e5f 7061 7374 203e 3d20 3029 3b0a 0a20  n_past >= 0);.. 
-0005bc70: 2020 2063 6f6e 7374 2069 6e74 206e 6530     const int ne0
-0005bc80: 203d 2073 7263 302d 3e6e 655b 305d 3b20   = src0->ne[0]; 
-0005bc90: 2f2f 2061 6c6c 5f73 6571 5f6c 656e 203d  // all_seq_len =
-0005bca0: 206e 5f70 6173 7420 2b20 6e65 310a 2020   n_past + ne1.  
-0005bcb0: 2020 636f 6e73 7420 696e 7420 6e65 3120    const int ne1 
-0005bcc0: 3d20 7372 6330 2d3e 6e65 5b31 5d3b 202f  = src0->ne[1]; /
-0005bcd0: 2f20 7365 715f 6c65 6e5f 7769 7468 6f75  / seq_len_withou
-0005bce0: 745f 7061 7374 0a20 2020 2063 6f6e 7374  t_past.    const
-0005bcf0: 2069 6e74 206e 6532 203d 2073 7263 302d   int ne2 = src0-
-0005bd00: 3e6e 655b 325d 3b20 2f2f 206e 5f68 6561  >ne[2]; // n_hea
-0005bd10: 6420 2d3e 2074 6869 7320 6973 206b 0a20  d -> this is k. 
-0005bd20: 2020 202f 2f63 6f6e 7374 2069 6e74 206e     //const int n
-0005bd30: 6533 203d 2073 7263 302d 3e6e 655b 335d  e3 = src0->ne[3]
-0005bd40: 3b20 2f2f 2031 202d 3e20 6273 7a0a 0a20  ; // 1 -> bsz.. 
-0005bd50: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
-0005bd60: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
-0005bd70: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
-0005bd80: 7420 6e65 325f 6e65 3320 3d20 6e2f 6e65  t ne2_ne3 = n/ne
-0005bd90: 313b 202f 2f20 6e65 322a 6e65 330a 0a20  1; // ne2*ne3.. 
-0005bda0: 2020 2063 6f6e 7374 2069 6e74 206e 6230     const int nb0
-0005bdb0: 203d 2073 7263 302d 3e6e 625b 305d 3b0a   = src0->nb[0];.
-0005bdc0: 2020 2020 636f 6e73 7420 696e 7420 6e62      const int nb
-0005bdd0: 3120 3d20 7372 6330 2d3e 6e62 5b31 5d3b  1 = src0->nb[1];
-0005bde0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005bdf0: 6232 203d 2073 7263 302d 3e6e 625b 325d  b2 = src0->nb[2]
-0005be00: 3b0a 2020 2020 2f2f 636f 6e73 7420 696e  ;.    //const in
-0005be10: 7420 6e62 3320 3d20 7372 6330 2d3e 6e62  t nb3 = src0->nb
-0005be20: 5b33 5d3b 0a0a 2020 2020 4747 4d4c 5f41  [3];..    GGML_A
-0005be30: 5353 4552 5428 6e62 3020 3d3d 2073 697a  SSERT(nb0 == siz
-0005be40: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-0005be50: 2047 474d 4c5f 4153 5345 5254 286e 6531   GGML_ASSERT(ne1
-0005be60: 202b 206e 5f70 6173 7420 3d3d 206e 6530   + n_past == ne0
-0005be70: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0005be80: 5254 286e 5f68 6561 6420 3d3d 206e 6532  RT(n_head == ne2
-0005be90: 293b 0a0a 2020 2020 2f2f 2061 6464 2061  );..    // add a
-0005bea0: 6c69 6269 2074 6f20 7372 6330 2028 4b51  libi to src0 (KQ
-0005beb0: 5f73 6361 6c65 6429 0a20 2020 2063 6f6e  _scaled).    con
-0005bec0: 7374 2069 6e74 206e 5f68 6561 6473 5f6c  st int n_heads_l
-0005bed0: 6f67 325f 666c 6f6f 7220 3d20 3120 3c3c  og2_floor = 1 <<
-0005bee0: 2028 696e 7429 2066 6c6f 6f72 286c 6f67   (int) floor(log
-0005bef0: 3228 6e5f 6865 6164 2929 3b0a 0a20 2020  2(n_head));..   
-0005bf00: 2063 6f6e 7374 2066 6c6f 6174 206d 3020   const float m0 
-0005bf10: 3d20 706f 7766 2832 2e30 662c 202d 286d  = powf(2.0f, -(m
-0005bf20: 6178 5f62 6961 7329 202f 206e 5f68 6561  ax_bias) / n_hea
-0005bf30: 6473 5f6c 6f67 325f 666c 6f6f 7229 3b0a  ds_log2_floor);.
-0005bf40: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0005bf50: 6d31 203d 2070 6f77 6628 322e 3066 2c20  m1 = powf(2.0f, 
-0005bf60: 2d28 6d61 785f 6269 6173 202f 2032 2e30  -(max_bias / 2.0
-0005bf70: 6629 202f 206e 5f68 6561 6473 5f6c 6f67  f) / n_heads_log
-0005bf80: 325f 666c 6f6f 7229 3b0a 0a20 2020 2066  2_floor);..    f
-0005bf90: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0005bfa0: 203c 206e 6530 3b20 692b 2b29 207b 0a20   < ne0; i++) {. 
-0005bfb0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0005bfc0: 6a20 3d20 303b 206a 203c 206e 6531 3b20  j = 0; j < ne1; 
-0005bfd0: 6a2b 2b29 207b 0a20 2020 2020 2020 2020  j++) {.         
-0005bfe0: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
-0005bff0: 303b 206b 203c 206e 6532 5f6e 6533 3b20  0; k < ne2_ne3; 
-0005c000: 6b2b 2b29 207b 0a20 2020 2020 2020 2020  k++) {.         
-0005c010: 2020 2020 2020 2066 6c6f 6174 202a 2063         float * c
-0005c020: 6f6e 7374 2073 7263 203d 2028 666c 6f61  onst src = (floa
-0005c030: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
-0005c040: 6330 2d3e 6461 7461 202b 2069 2a6e 6230  c0->data + i*nb0
-0005c050: 202b 206a 2a6e 6231 202b 206b 2a6e 6232   + j*nb1 + k*nb2
-0005c060: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005c070: 2020 2066 6c6f 6174 202a 2020 2020 2020     float *      
-0005c080: 7064 7374 203d 2028 666c 6f61 7420 2a29  pdst = (float *)
-0005c090: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
-0005c0a0: 6461 7461 202b 2069 2a6e 6230 202b 206a  data + i*nb0 + j
-0005c0b0: 2a6e 6231 202b 206b 2a6e 6232 293b 0a0a  *nb1 + k*nb2);..
-0005c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c0d0: 2f2f 2054 4f44 4f3a 206b 2a6e 6232 206f  // TODO: k*nb2 o
-0005c0e0: 7220 6b2a 6e62 330a 0a20 2020 2020 2020  r k*nb3..       
-0005c0f0: 2020 2020 2020 2020 2066 6c6f 6174 206d           float m
-0005c100: 5f6b 3b0a 0a20 2020 2020 2020 2020 2020  _k;..           
-0005c110: 2020 2020 2069 6620 286b 203c 206e 5f68       if (k < n_h
-0005c120: 6561 6473 5f6c 6f67 325f 666c 6f6f 7229  eads_log2_floor)
-0005c130: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0005c140: 2020 2020 2020 206d 5f6b 203d 2070 6f77         m_k = pow
-0005c150: 6628 6d30 2c20 6b20 2b20 3129 3b0a 2020  f(m0, k + 1);.  
-0005c160: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-0005c170: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-0005c180: 2020 2020 2020 2020 2020 206d 5f6b 203d             m_k =
-0005c190: 2070 6f77 6628 6d31 2c20 3220 2a20 286b   powf(m1, 2 * (k
-0005c1a0: 202d 206e 5f68 6561 6473 5f6c 6f67 325f   - n_heads_log2_
-0005c1b0: 666c 6f6f 7229 202b 2031 293b 0a20 2020  floor) + 1);.   
-0005c1c0: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-0005c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c1e0: 7064 7374 5b30 5d20 3d20 6920 2a20 6d5f  pdst[0] = i * m_
-0005c1f0: 6b20 2b20 7372 635b 305d 3b0a 0a20 2020  k + src[0];..   
-0005c200: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0005c210: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-0005c220: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-0005c230: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-0005c240: 6c69 6269 5f66 3136 280a 2020 2020 2020  libi_f16(.      
-0005c250: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0005c260: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0005c270: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0005c280: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005c290: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005c2a0: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-0005c2b0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0005c2c0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-0005c2d0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0005c2e0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0005c2f0: 207b 0a20 2020 2061 7373 6572 7428 7061   {.    assert(pa
-0005c300: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
-0005c310: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-0005c320: 5428 7372 6331 2d3e 7479 7065 203d 3d20  T(src1->type == 
-0005c330: 4747 4d4c 5f54 5950 455f 4933 3229 3b0a  GGML_TYPE_I32);.
-0005c340: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0005c350: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-0005c360: 7263 3129 203d 3d20 3329 3b0a 0a20 2020  rc1) == 3);..   
-0005c370: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-0005c380: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-0005c390: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-0005c3a0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0005c3b0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-0005c3c0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-0005c3d0: 207d 0a0a 2020 2020 636f 6e73 7420 696e   }..    const in
-0005c3e0: 7420 2020 6e5f 7061 7374 2020 203d 2028  t   n_past   = (
-0005c3f0: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-0005c400: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
-0005c410: 636f 6e73 7420 696e 7420 2020 6e5f 6865  const int   n_he
-0005c420: 6164 2020 203d 2028 2869 6e74 3332 5f74  ad   = ((int32_t
-0005c430: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-0005c440: 315d 3b0a 2020 2020 636f 6e73 7420 666c  1];.    const fl
-0005c450: 6f61 7420 6d61 785f 6269 6173 203d 2028  oat max_bias = (
-0005c460: 2866 6c6f 6174 202a 2920 2020 7372 6331  (float *)   src1
-0005c470: 2d3e 6461 7461 295b 325d 3b0a 0a20 2020  ->data)[2];..   
-0005c480: 2061 7373 6572 7428 6e5f 7061 7374 203e   assert(n_past >
-0005c490: 3d20 3029 3b0a 0a20 2020 2063 6f6e 7374  = 0);..    const
-0005c4a0: 2069 6e74 206e 6530 203d 2073 7263 302d   int ne0 = src0-
-0005c4b0: 3e6e 655b 305d 3b20 2f2f 2061 6c6c 5f73  >ne[0]; // all_s
-0005c4c0: 6571 5f6c 656e 203d 206e 5f70 6173 7420  eq_len = n_past 
-0005c4d0: 2b20 6e65 310a 2020 2020 636f 6e73 7420  + ne1.    const 
-0005c4e0: 696e 7420 6e65 3120 3d20 7372 6330 2d3e  int ne1 = src0->
-0005c4f0: 6e65 5b31 5d3b 202f 2f20 7365 715f 6c65  ne[1]; // seq_le
-0005c500: 6e5f 7769 7468 6f75 745f 7061 7374 0a20  n_without_past. 
-0005c510: 2020 2063 6f6e 7374 2069 6e74 206e 6532     const int ne2
-0005c520: 203d 2073 7263 302d 3e6e 655b 325d 3b20   = src0->ne[2]; 
-0005c530: 2f2f 206e 5f68 6561 6420 2d3e 2074 6869  // n_head -> thi
-0005c540: 7320 6973 206b 0a20 2020 202f 2f63 6f6e  s is k.    //con
-0005c550: 7374 2069 6e74 206e 6533 203d 2073 7263  st int ne3 = src
-0005c560: 302d 3e6e 655b 335d 3b20 2f2f 2031 202d  0->ne[3]; // 1 -
-0005c570: 3e20 6273 7a0a 0a20 2020 2063 6f6e 7374  > bsz..    const
-0005c580: 2069 6e74 206e 2020 3d20 6767 6d6c 5f6e   int n  = ggml_n
-0005c590: 726f 7773 2873 7263 3029 3b0a 2020 2020  rows(src0);.    
-0005c5a0: 636f 6e73 7420 696e 7420 6e65 325f 6e65  const int ne2_ne
-0005c5b0: 3320 3d20 6e2f 6e65 313b 202f 2f20 6e65  3 = n/ne1; // ne
-0005c5c0: 322a 6e65 330a 0a20 2020 2063 6f6e 7374  2*ne3..    const
-0005c5d0: 2069 6e74 206e 6230 203d 2073 7263 302d   int nb0 = src0-
-0005c5e0: 3e6e 625b 305d 3b0a 2020 2020 636f 6e73  >nb[0];.    cons
-0005c5f0: 7420 696e 7420 6e62 3120 3d20 7372 6330  t int nb1 = src0
-0005c600: 2d3e 6e62 5b31 5d3b 0a20 2020 2063 6f6e  ->nb[1];.    con
-0005c610: 7374 2069 6e74 206e 6232 203d 2073 7263  st int nb2 = src
-0005c620: 302d 3e6e 625b 325d 3b0a 2020 2020 2f2f  0->nb[2];.    //
-0005c630: 636f 6e73 7420 696e 7420 6e62 3320 3d20  const int nb3 = 
-0005c640: 7372 6330 2d3e 6e62 5b33 5d3b 0a0a 2020  src0->nb[3];..  
-0005c650: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-0005c660: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
-0005c670: 5f66 7031 365f 7429 293b 0a20 2020 2047  _fp16_t));.    G
-0005c680: 474d 4c5f 4153 5345 5254 286e 6531 202b  GML_ASSERT(ne1 +
-0005c690: 206e 5f70 6173 7420 3d3d 206e 6530 293b   n_past == ne0);
-0005c6a0: 2028 766f 6964 2920 6e5f 7061 7374 3b0a   (void) n_past;.
-0005c6b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0005c6c0: 6e5f 6865 6164 203d 3d20 6e65 3229 3b0a  n_head == ne2);.
-0005c6d0: 0a20 2020 202f 2f20 6164 6420 616c 6962  .    // add alib
-0005c6e0: 6920 746f 2073 7263 3020 284b 515f 7363  i to src0 (KQ_sc
-0005c6f0: 616c 6564 290a 2020 2020 636f 6e73 7420  aled).    const 
-0005c700: 696e 7420 6e5f 6865 6164 735f 6c6f 6732  int n_heads_log2
-0005c710: 5f66 6c6f 6f72 203d 2031 203c 3c20 2869  _floor = 1 << (i
-0005c720: 6e74 2920 666c 6f6f 7228 6c6f 6732 286e  nt) floor(log2(n
-0005c730: 5f68 6561 6429 293b 0a0a 2020 2020 636f  _head));..    co
-0005c740: 6e73 7420 666c 6f61 7420 6d30 203d 2070  nst float m0 = p
-0005c750: 6f77 6628 322e 3066 2c20 2d28 6d61 785f  owf(2.0f, -(max_
-0005c760: 6269 6173 2920 2f20 6e5f 6865 6164 735f  bias) / n_heads_
-0005c770: 6c6f 6732 5f66 6c6f 6f72 293b 0a20 2020  log2_floor);.   
-0005c780: 2063 6f6e 7374 2066 6c6f 6174 206d 3120   const float m1 
-0005c790: 3d20 706f 7766 2832 2e30 662c 202d 286d  = powf(2.0f, -(m
-0005c7a0: 6178 5f62 6961 7320 2f20 322e 3066 2920  ax_bias / 2.0f) 
-0005c7b0: 2f20 6e5f 6865 6164 735f 6c6f 6732 5f66  / n_heads_log2_f
-0005c7c0: 6c6f 6f72 293b 0a0a 2020 2020 666f 7220  loor);..    for 
-0005c7d0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-0005c7e0: 6e65 303b 2069 2b2b 2920 7b0a 2020 2020  ne0; i++) {.    
-0005c7f0: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
-0005c800: 2030 3b20 6a20 3c20 6e65 313b 206a 2b2b   0; j < ne1; j++
-0005c810: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005c820: 666f 7220 2869 6e74 206b 203d 2030 3b20  for (int k = 0; 
-0005c830: 6b20 3c20 6e65 325f 6e65 333b 206b 2b2b  k < ne2_ne3; k++
-0005c840: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005c850: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-0005c860: 2a20 636f 6e73 7420 7372 6320 203d 2028  * const src  = (
-0005c870: 6767 6d6c 5f66 7031 365f 7420 2a29 2828  ggml_fp16_t *)((
-0005c880: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-0005c890: 7461 202b 2069 2a6e 6230 202b 206a 2a6e  ta + i*nb0 + j*n
-0005c8a0: 6231 202b 206b 2a6e 6232 293b 0a20 2020  b1 + k*nb2);.   
-0005c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c8c0: 2020 2066 6c6f 6174 202a 2020 2020 2020     float *      
-0005c8d0: 7064 7374 2020 3d20 2020 2020 2020 2866  pdst  =       (f
-0005c8e0: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
-0005c8f0: 2020 6473 742d 3e64 6174 6120 2b20 692a    dst->data + i*
-0005c900: 6e62 3020 2b20 6a2a 6e62 3120 2b20 6b2a  nb0 + j*nb1 + k*
-0005c910: 6e62 3229 3b0a 0a20 2020 2020 2020 2020  nb2);..         
-0005c920: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
-0005c930: 6b2a 6e62 3220 6f72 206b 2a6e 6233 0a0a  k*nb2 or k*nb3..
-0005c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c950: 666c 6f61 7420 6d5f 6b3b 0a0a 2020 2020  float m_k;..    
-0005c960: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0005c970: 6b20 3c20 6e5f 6865 6164 735f 6c6f 6732  k < n_heads_log2
-0005c980: 5f66 6c6f 6f72 2920 7b0a 2020 2020 2020  _floor) {.      
-0005c990: 2020 2020 2020 2020 2020 2020 2020 6d5f                m_
-0005c9a0: 6b20 3d20 706f 7766 286d 302c 206b 202b  k = powf(m0, k +
-0005c9b0: 2031 293b 0a20 2020 2020 2020 2020 2020   1);.           
-0005c9c0: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
-0005c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005c9e0: 2020 6d5f 6b20 3d20 706f 7766 286d 312c    m_k = powf(m1,
-0005c9f0: 2032 202a 2028 6b20 2d20 6e5f 6865 6164   2 * (k - n_head
-0005ca00: 735f 6c6f 6732 5f66 6c6f 6f72 2920 2b20  s_log2_floor) + 
-0005ca10: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-0005ca20: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-0005ca30: 2020 2020 2020 202f 2f20 7765 2072 6574         // we ret
-0005ca40: 7572 6e20 4633 320a 2020 2020 2020 2020  urn F32.        
-0005ca50: 2020 2020 2020 2020 7064 7374 5b30 5d20          pdst[0] 
-0005ca60: 3d20 6920 2a20 6d5f 6b20 2b20 4747 4d4c  = i * m_k + GGML
-0005ca70: 5f46 5031 365f 544f 5f46 5033 3228 7372  _FP16_TO_FP32(sr
-0005ca80: 635b 305d 293b 0a20 2020 2020 2020 2020  c[0]);.         
-0005ca90: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-0005caa0: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-0005cab0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-0005cac0: 5f66 6f72 7761 7264 5f61 6c69 6269 280a  _forward_alibi(.
-0005cad0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0005cae0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-0005caf0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-0005cb00: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-0005cb10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005cb20: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-0005cb30: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0005cb40: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-0005cb50: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
-0005cb60: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005cb70: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
-0005cb80: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
-0005cb90: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
-0005cba0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
-0005cbb0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0005cbc0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0005cbd0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0005cbe0: 645f 616c 6962 695f 6631 3628 7061 7261  d_alibi_f16(para
-0005cbf0: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
-0005cc00: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
-0005cc10: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0005cc20: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0005cc30: 455f 4633 323a 0a20 2020 2020 2020 2020  E_F32:.         
-0005cc40: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0005cc50: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-0005cc60: 655f 666f 7277 6172 645f 616c 6962 695f  e_forward_alibi_
-0005cc70: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
-0005cc80: 2c20 7372 6331 2c20 6473 7429 3b0a 2020  , src1, dst);.  
-0005cc90: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0005cca0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0005ccb0: 4747 4d4c 5f54 5950 455f 5134 5f30 3a0a  GGML_TYPE_Q4_0:.
-0005ccc0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0005ccd0: 4c5f 5459 5045 5f51 345f 313a 0a20 2020  L_TYPE_Q4_1:.   
-0005cce0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0005ccf0: 5950 455f 5135 5f30 3a0a 2020 2020 2020  YPE_Q5_0:.      
-0005cd00: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0005cd10: 5f51 355f 313a 0a20 2020 2020 2020 2063  _Q5_1:.        c
-0005cd20: 6173 6520 4747 4d4c 5f54 5950 455f 5138  ase GGML_TYPE_Q8
-0005cd30: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
-0005cd40: 2047 474d 4c5f 5459 5045 5f51 385f 313a   GGML_TYPE_Q8_1:
-0005cd50: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0005cd60: 4d4c 5f54 5950 455f 5132 5f4b 3a0a 2020  ML_TYPE_Q2_K:.  
-0005cd70: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0005cd80: 5459 5045 5f51 335f 4b3a 0a20 2020 2020  TYPE_Q3_K:.     
-0005cd90: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0005cda0: 455f 5134 5f4b 3a0a 2020 2020 2020 2020  E_Q4_K:.        
-0005cdb0: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-0005cdc0: 355f 4b3a 0a20 2020 2020 2020 2063 6173  5_K:.        cas
-0005cdd0: 6520 4747 4d4c 5f54 5950 455f 5136 5f4b  e GGML_TYPE_Q6_K
-0005cde0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-0005cdf0: 474d 4c5f 5459 5045 5f51 385f 4b3a 0a20  GML_TYPE_Q8_K:. 
-0005ce00: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0005ce10: 5f54 5950 455f 4938 3a0a 2020 2020 2020  _TYPE_I8:.      
-0005ce20: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0005ce30: 5f49 3136 3a0a 2020 2020 2020 2020 6361  _I16:.        ca
-0005ce40: 7365 2047 474d 4c5f 5459 5045 5f49 3332  se GGML_TYPE_I32
-0005ce50: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-0005ce60: 474d 4c5f 5459 5045 5f43 4f55 4e54 3a0a  GML_TYPE_COUNT:.
-0005ce70: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0005ce80: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0005ce90: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-0005cea0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-0005ceb0: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-0005cec0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-0005ced0: 5f66 6f72 7761 7264 5f63 6c61 6d70 0a0a  _forward_clamp..
-0005cee0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
-0005cef0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0005cf00: 5f63 6c61 6d70 5f66 3332 280a 2020 2020  _clamp_f32(.    
-0005cf10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0005cf20: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-0005cf30: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-0005cf40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0005cf50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005cf60: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-0005cf70: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0005cf80: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-0005cf90: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0005cfa0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-0005cfb0: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
-0005cfc0: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
-0005cfd0: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-0005cfe0: 4552 5428 7372 6331 2d3e 7479 7065 203d  ERT(src1->type =
-0005cff0: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
-0005d000: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-0005d010: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
-0005d020: 2873 7263 3129 203d 3d20 3229 3b0a 0a20  (src1) == 2);.. 
-0005d030: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0005d040: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0005d050: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
-0005d060: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-0005d070: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-0005d080: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-0005d090: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-0005d0a0: 666c 6f61 7420 6d69 6e20 3d20 2828 666c  float min = ((fl
-0005d0b0: 6f61 7420 2a29 2073 7263 312d 3e64 6174  oat *) src1->dat
-0005d0c0: 6129 5b30 5d3b 0a20 2020 2063 6f6e 7374  a)[0];.    const
-0005d0d0: 2066 6c6f 6174 206d 6178 203d 2028 2866   float max = ((f
-0005d0e0: 6c6f 6174 202a 2920 7372 6331 2d3e 6461  loat *) src1->da
-0005d0f0: 7461 295b 315d 3b0a 0a20 2020 2063 6f6e  ta)[1];..    con
-0005d100: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
-0005d110: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
-0005d120: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
-0005d130: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
-0005d140: 636f 6e73 7420 696e 7420 6e20 203d 2067  const int n  = g
-0005d150: 676d 6c5f 6e72 6f77 7328 7372 6330 293b  gml_nrows(src0);
-0005d160: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0005d170: 6320 3d20 7372 6330 2d3e 6e65 5b30 5d3b  c = src0->ne[0];
-0005d180: 0a0a 2020 2020 636f 6e73 7420 7369 7a65  ..    const size
-0005d190: 5f74 206e 6230 3020 3d20 7372 6330 2d3e  _t nb00 = src0->
-0005d1a0: 6e62 5b30 5d3b 0a20 2020 2063 6f6e 7374  nb[0];.    const
-0005d1b0: 2073 697a 655f 7420 6e62 3031 203d 2073   size_t nb01 = s
-0005d1c0: 7263 302d 3e6e 625b 315d 3b0a 0a20 2020  rc0->nb[1];..   
-0005d1d0: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
-0005d1e0: 3020 3d20 6473 742d 3e6e 625b 305d 3b0a  0 = dst->nb[0];.
-0005d1f0: 2020 2020 636f 6e73 7420 7369 7a65 5f74      const size_t
-0005d200: 206e 6231 203d 2064 7374 2d3e 6e62 5b31   nb1 = dst->nb[1
-0005d210: 5d3b 0a0a 2020 2020 4747 4d4c 5f41 5353  ];..    GGML_ASS
-0005d220: 4552 5428 206e 6230 203d 3d20 7369 7a65  ERT( nb0 == size
-0005d230: 6f66 2866 6c6f 6174 2929 3b0a 2020 2020  of(float));.    
-0005d240: 4747 4d4c 5f41 5353 4552 5428 6e62 3030  GGML_ASSERT(nb00
-0005d250: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
-0005d260: 2929 3b0a 0a20 2020 2066 6f72 2028 696e  ));..    for (in
-0005d270: 7420 6a20 3d20 6974 683b 206a 203c 206e  t j = ith; j < n
-0005d280: 3b20 6a20 2b3d 206e 7468 2920 7b0a 2020  ; j += nth) {.  
-0005d290: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-0005d2a0: 745f 7074 7220 203d 2028 666c 6f61 7420  t_ptr  = (float 
-0005d2b0: 2a29 2028 2863 6861 7220 2a29 2020 6473  *) ((char *)  ds
-0005d2c0: 742d 3e64 6174 6120 2b20 6a2a 6e62 3129  t->data + j*nb1)
-0005d2d0: 3b0a 2020 2020 2020 2020 666c 6f61 7420  ;.        float 
-0005d2e0: 2a20 7372 6330 5f70 7472 203d 2028 666c  * src0_ptr = (fl
-0005d2f0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-0005d300: 2073 7263 302d 3e64 6174 6120 2b20 6a2a   src0->data + j*
-0005d310: 6e62 3031 293b 0a0a 2020 2020 2020 2020  nb01);..        
-0005d320: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0005d330: 6920 3c20 6e63 3b20 692b 2b29 207b 0a20  i < nc; i++) {. 
-0005d340: 2020 2020 2020 2020 2020 2064 7374 5f70             dst_p
-0005d350: 7472 5b69 5d20 3d20 4d41 5828 4d49 4e28  tr[i] = MAX(MIN(
-0005d360: 7372 6330 5f70 7472 5b69 5d2c 206d 6178  src0_ptr[i], max
-0005d370: 292c 206d 696e 293b 0a20 2020 2020 2020  ), min);.       
-0005d380: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
-0005d390: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-0005d3a0: 7075 7465 5f66 6f72 7761 7264 5f63 6c61  pute_forward_cla
-0005d3b0: 6d70 280a 2020 2020 2020 2020 636f 6e73  mp(.        cons
-0005d3c0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-0005d3d0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-0005d3e0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-0005d3f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0005d400: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-0005d410: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-0005d420: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0005d430: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-0005d440: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0005d450: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-0005d460: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-0005d470: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-0005d480: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-0005d490: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-0005d4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005d4b0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-0005d4c0: 7277 6172 645f 636c 616d 705f 6633 3228  rward_clamp_f32(
-0005d4d0: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-0005d4e0: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-0005d4f0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0005d500: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0005d510: 5f54 5950 455f 4631 363a 0a20 2020 2020  _TYPE_F16:.     
-0005d520: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0005d530: 455f 5134 5f30 3a0a 2020 2020 2020 2020  E_Q4_0:.        
-0005d540: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
-0005d550: 345f 313a 0a20 2020 2020 2020 2063 6173  4_1:.        cas
-0005d560: 6520 4747 4d4c 5f54 5950 455f 5135 5f30  e GGML_TYPE_Q5_0
-0005d570: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-0005d580: 474d 4c5f 5459 5045 5f51 355f 313a 0a20  GML_TYPE_Q5_1:. 
-0005d590: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0005d5a0: 5f54 5950 455f 5138 5f30 3a0a 2020 2020  _TYPE_Q8_0:.    
-0005d5b0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-0005d5c0: 5045 5f51 385f 313a 0a20 2020 2020 2020  PE_Q8_1:.       
-0005d5d0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-0005d5e0: 5132 5f4b 3a0a 2020 2020 2020 2020 6361  Q2_K:.        ca
-0005d5f0: 7365 2047 474d 4c5f 5459 5045 5f51 335f  se GGML_TYPE_Q3_
-0005d600: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
-0005d610: 4747 4d4c 5f54 5950 455f 5134 5f4b 3a0a  GGML_TYPE_Q4_K:.
-0005d620: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0005d630: 4c5f 5459 5045 5f51 355f 4b3a 0a20 2020  L_TYPE_Q5_K:.   
-0005d640: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0005d650: 5950 455f 5136 5f4b 3a0a 2020 2020 2020  YPE_Q6_K:.      
-0005d660: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0005d670: 5f51 385f 4b3a 0a20 2020 2020 2020 2063  _Q8_K:.        c
-0005d680: 6173 6520 4747 4d4c 5f54 5950 455f 4938  ase GGML_TYPE_I8
-0005d690: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
-0005d6a0: 474d 4c5f 5459 5045 5f49 3136 3a0a 2020  GML_TYPE_I16:.  
-0005d6b0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0005d6c0: 5459 5045 5f49 3332 3a0a 2020 2020 2020  TYPE_I32:.      
-0005d6d0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0005d6e0: 5f43 4f55 4e54 3a0a 2020 2020 2020 2020  _COUNT:.        
-0005d6f0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0005d700: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0005d710: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
-0005d720: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0005d730: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
-0005d740: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0005d750: 726f 7065 0a0a 7374 6174 6963 2076 6f69  rope..static voi
-0005d760: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-0005d770: 6f72 7761 7264 5f72 6f70 655f 6633 3228  orward_rope_f32(
-0005d780: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0005d790: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
-0005d7a0: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
-0005d7b0: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
-0005d7c0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0005d7d0: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
-0005d7e0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0005d7f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0005d800: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
-0005d810: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0005d820: 202a 2064 7374 2920 7b0a 2020 2020 4747   * dst) {.    GG
-0005d830: 4d4c 5f41 5353 4552 5428 7372 6331 2d3e  ML_ASSERT(src1->
-0005d840: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-0005d850: 455f 4933 3229 3b0a 2020 2020 4747 4d4c  E_I32);.    GGML
-0005d860: 5f41 5353 4552 5428 6767 6d6c 5f6e 656c  _ASSERT(ggml_nel
-0005d870: 656d 656e 7473 2873 7263 3129 203d 3d20  ements(src1) == 
-0005d880: 3429 3b0a 0a20 2020 2069 6620 2870 6172  4);..    if (par
-0005d890: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-0005d8a0: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-0005d8b0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-0005d8c0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-0005d8d0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-0005d8e0: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-0005d8f0: 636f 6e73 7420 696e 7420 6e5f 7061 7374  const int n_past
-0005d900: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-0005d910: 7372 6331 2d3e 6461 7461 295b 305d 3b0a  src1->data)[0];.
-0005d920: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-0005d930: 6469 6d73 203d 2028 2869 6e74 3332 5f74  dims = ((int32_t
-0005d940: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-0005d950: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
-0005d960: 7420 6d6f 6465 2020 203d 2028 2869 6e74  t mode   = ((int
-0005d970: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-0005d980: 7461 295b 325d 3b0a 2020 2020 636f 6e73  ta)[2];.    cons
-0005d990: 7420 696e 7420 6e5f 6374 7820 203d 2028  t int n_ctx  = (
-0005d9a0: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
-0005d9b0: 2d3e 6461 7461 295b 335d 3b0a 0a20 2020  ->data)[3];..   
-0005d9c0: 2061 7373 6572 7428 6e5f 7061 7374 203e   assert(n_past >
-0005d9d0: 3d20 3029 3b0a 0a20 2020 2047 474d 4c5f  = 0);..    GGML_
-0005d9e0: 5445 4e53 4f52 5f55 4e41 5259 5f4f 505f  TENSOR_UNARY_OP_
-0005d9f0: 4c4f 4341 4c53 3b0a 0a20 2020 202f 2f70  LOCALS;..    //p
-0005da00: 7269 6e74 6628 226e 6530 3a20 2564 2c20  rintf("ne0: %d, 
-0005da10: 6e65 313a 2025 642c 206e 6532 3a20 2564  ne1: %d, ne2: %d
-0005da20: 2c20 6e65 333a 2025 645c 6e22 2c20 6e65  , ne3: %d\n", ne
-0005da30: 302c 206e 6531 2c20 6e65 322c 206e 6533  0, ne1, ne2, ne3
-0005da40: 293b 0a20 2020 202f 2f70 7269 6e74 6628  );.    //printf(
-0005da50: 226e 5f70 6173 7420 3d20 2564 2c20 6e65  "n_past = %d, ne
-0005da60: 3220 3d20 2564 5c6e 222c 206e 5f70 6173  2 = %d\n", n_pas
-0005da70: 742c 206e 6532 293b 0a0a 2020 2020 4747  t, ne2);..    GG
-0005da80: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
-0005da90: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
-0005daa0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0005dab0: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
-0005dac0: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-0005dad0: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
-0005dae0: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
-0005daf0: 696e 7420 6e72 203d 2067 676d 6c5f 6e72  int nr = ggml_nr
-0005db00: 6f77 7328 6473 7429 3b0a 0a20 2020 2047  ows(dst);..    G
-0005db10: 474d 4c5f 4153 5345 5254 286e 5f64 696d  GML_ASSERT(n_dim
-0005db20: 7320 3c3d 206e 6530 293b 0a20 2020 2047  s <= ne0);.    G
-0005db30: 474d 4c5f 4153 5345 5254 286e 5f64 696d  GML_ASSERT(n_dim
-0005db40: 7320 2520 3220 3d3d 2030 293b 0a0a 2020  s % 2 == 0);..  
-0005db50: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
-0005db60: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-0005db70: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
-0005db80: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
-0005db90: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
-0005dba0: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
-0005dbb0: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
-0005dbc0: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
-0005dbd0: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
-0005dbe0: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
-0005dbf0: 0a0a 2020 2020 2f2f 2072 6f77 2069 6e64  ..    // row ind
-0005dc00: 6578 2075 7365 6420 746f 2064 6574 6572  ex used to deter
-0005dc10: 6d69 6e65 2077 6869 6368 2074 6872 6561  mine which threa
-0005dc20: 6420 746f 2075 7365 0a20 2020 2069 6e74  d to use.    int
-0005dc30: 2069 7220 3d20 303b 0a0a 2020 2020 636f   ir = 0;..    co
-0005dc40: 6e73 7420 666c 6f61 7420 7468 6574 615f  nst float theta_
-0005dc50: 7363 616c 6520 3d20 706f 7766 2831 3030  scale = powf(100
-0005dc60: 3030 2e30 2c20 2d32 2e30 662f 6e5f 6469  00.0, -2.0f/n_di
-0005dc70: 6d73 293b 0a0a 2020 2020 636f 6e73 7420  ms);..    const 
-0005dc80: 626f 6f6c 2069 735f 6e65 6f78 203d 206d  bool is_neox = m
-0005dc90: 6f64 6520 2620 323b 0a20 2020 2063 6f6e  ode & 2;.    con
-0005dca0: 7374 2062 6f6f 6c20 6973 5f67 6c6d 2020  st bool is_glm  
-0005dcb0: 3d20 6d6f 6465 2026 2034 3b0a 0a20 2020  = mode & 4;..   
-0005dcc0: 2066 6f72 2028 696e 7436 345f 7420 6933   for (int64_t i3
-0005dcd0: 203d 2030 3b20 6933 203c 206e 6533 3b20   = 0; i3 < ne3; 
-0005dce0: 6933 2b2b 2920 7b0a 2020 2020 2020 2020  i3++) {.        
-0005dcf0: 666f 7220 2869 6e74 3634 5f74 2069 3220  for (int64_t i2 
-0005dd00: 3d20 2828 6d6f 6465 2026 2031 2920 3d3d  = ((mode & 1) ==
-0005dd10: 2030 203f 2030 203a 206e 5f70 6173 7429   0 ? 0 : n_past)
-0005dd20: 3b20 6932 203c 206e 6532 3b20 6932 2b2b  ; i2 < ne2; i2++
-0005dd30: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005dd40: 636f 6e73 7420 696e 7436 345f 7420 7020  const int64_t p 
-0005dd50: 3d20 2828 6d6f 6465 2026 2031 2920 3d3d  = ((mode & 1) ==
-0005dd60: 2030 203f 206e 5f70 6173 7420 2b20 6932   0 ? n_past + i2
-0005dd70: 203a 2069 3229 3b0a 2020 2020 2020 2020   : i2);.        
-0005dd80: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005dd90: 2069 3120 3d20 303b 2069 3120 3c20 6e65   i1 = 0; i1 < ne
-0005dda0: 313b 2069 312b 2b29 207b 0a20 2020 2020  1; i1++) {.     
-0005ddb0: 2020 2020 2020 2020 2020 2069 6620 2869             if (i
-0005ddc0: 722b 2b20 3c20 6972 3029 2063 6f6e 7469  r++ < ir0) conti
-0005ddd0: 6e75 653b 0a20 2020 2020 2020 2020 2020  nue;.           
-0005dde0: 2020 2020 2069 6620 2869 7220 2020 3e20       if (ir   > 
-0005ddf0: 6972 3129 2062 7265 616b 3b0a 0a20 2020  ir1) break;..   
-0005de00: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0005de10: 6174 2074 6865 7461 203d 2028 666c 6f61  at theta = (floa
-0005de20: 7429 703b 0a0a 2020 2020 2020 2020 2020  t)p;..          
-0005de30: 2020 2020 2020 6966 2028 6973 5f67 6c6d        if (is_glm
-0005de40: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005de50: 2020 2020 2020 2020 7468 6574 6120 3d20          theta = 
-0005de60: 4d49 4e28 702c 206e 5f63 7478 202d 2032  MIN(p, n_ctx - 2
-0005de70: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005de80: 2020 2020 2020 2066 6c6f 6174 2062 6c6f         float blo
-0005de90: 636b 5f74 6865 7461 203d 204d 4158 2870  ck_theta = MAX(p
-0005dea0: 202d 2028 6e5f 6374 7820 2d20 3229 2c20   - (n_ctx - 2), 
-0005deb0: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-0005dec0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005ded0: 3634 5f74 2069 3020 3d20 303b 2069 3020  64_t i0 = 0; i0 
-0005dee0: 3c20 6e65 3020 2f20 343b 2069 302b 2b29  < ne0 / 4; i0++)
-0005def0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0005df00: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005df10: 2066 6c6f 6174 2063 6f73 5f74 6865 7461   float cos_theta
-0005df20: 203d 2063 6f73 6628 7468 6574 6129 3b0a   = cosf(theta);.
-0005df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005df40: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005df50: 6f61 7420 7369 6e5f 7468 6574 6120 3d20  oat sin_theta = 
-0005df60: 7369 6e66 2874 6865 7461 293b 0a20 2020  sinf(theta);.   
-0005df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005df80: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-0005df90: 2063 6f73 5f62 6c6f 636b 5f74 6865 7461   cos_block_theta
-0005dfa0: 203d 2063 6f73 6628 626c 6f63 6b5f 7468   = cosf(block_th
-0005dfb0: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
-0005dfc0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005dfd0: 6e73 7420 666c 6f61 7420 7369 6e5f 626c  nst float sin_bl
-0005dfe0: 6f63 6b5f 7468 6574 6120 3d20 7369 6e66  ock_theta = sinf
-0005dff0: 2862 6c6f 636b 5f74 6865 7461 293b 0a0a  (block_theta);..
-0005e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e010: 2020 2020 2020 2020 7468 6574 6120 2a3d          theta *=
-0005e020: 2074 6865 7461 5f73 6361 6c65 3b0a 2020   theta_scale;.  
-0005e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e040: 2020 2020 2020 626c 6f63 6b5f 7468 6574        block_thet
-0005e050: 6120 2a3d 2074 6865 7461 5f73 6361 6c65  a *= theta_scale
-0005e060: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0005e070: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005e080: 2066 6c6f 6174 202a 2063 6f6e 7374 2073   float * const s
-0005e090: 7263 203d 2028 666c 6f61 7420 2a29 2828  rc = (float *)((
-0005e0a0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-0005e0b0: 7461 202b 2069 332a 6e62 3033 202b 2069  ta + i3*nb03 + i
-0005e0c0: 322a 6e62 3032 202b 2069 312a 6e62 3031  2*nb02 + i1*nb01
-0005e0d0: 202b 2069 302a 6e62 3030 293b 0a20 2020   + i0*nb00);.   
-0005e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e0f0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-0005e100: 202a 2064 7374 5f64 6174 6120 203d 2028   * dst_data  = (
-0005e110: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-0005e120: 2920 2064 7374 2d3e 6461 7461 202b 2020  )  dst->data +  
-0005e130: 6933 2a6e 6233 202b 2069 322a 6e62 3220  i3*nb3 + i2*nb2 
-0005e140: 202b 2069 312a 6e62 3120 202b 2069 302a   + i1*nb1  + i0*
-0005e150: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
-0005e160: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0005e170: 6f6e 7374 2066 6c6f 6174 2078 3020 3d20  onst float x0 = 
-0005e180: 7372 635b 305d 3b0a 2020 2020 2020 2020  src[0];.        
-0005e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e1a0: 636f 6e73 7420 666c 6f61 7420 7831 203d  const float x1 =
-0005e1b0: 2073 7263 5b6e 5f64 696d 732f 325d 3b0a   src[n_dims/2];.
-0005e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e1d0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005e1e0: 6f61 7420 7832 203d 2073 7263 5b6e 5f64  oat x2 = src[n_d
-0005e1f0: 696d 735d 3b0a 2020 2020 2020 2020 2020  ims];.          
-0005e200: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005e210: 6e73 7420 666c 6f61 7420 7833 203d 2073  nst float x3 = s
-0005e220: 7263 5b6e 5f64 696d 732f 322a 335d 3b0a  rc[n_dims/2*3];.
-0005e230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005e240: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-0005e250: 615b 305d 2020 2020 2020 2020 2020 3d20  a[0]          = 
-0005e260: 7830 2a63 6f73 5f74 6865 7461 202d 2078  x0*cos_theta - x
-0005e270: 312a 7369 6e5f 7468 6574 613b 0a20 2020  1*sin_theta;.   
-0005e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e290: 2020 2020 2064 7374 5f64 6174 615b 6e5f       dst_data[n_
-0005e2a0: 6469 6d73 2f32 5d20 2020 3d20 7830 2a73  dims/2]   = x0*s
-0005e2b0: 696e 5f74 6865 7461 202b 2078 312a 636f  in_theta + x1*co
-0005e2c0: 735f 7468 6574 613b 0a20 2020 2020 2020  s_theta;.       
-0005e2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e2e0: 2064 7374 5f64 6174 615b 6e5f 6469 6d73   dst_data[n_dims
-0005e2f0: 5d20 2020 2020 3d20 7832 2a63 6f73 5f62  ]     = x2*cos_b
-0005e300: 6c6f 636b 5f74 6865 7461 202d 2078 332a  lock_theta - x3*
-0005e310: 7369 6e5f 626c 6f63 6b5f 7468 6574 613b  sin_block_theta;
-0005e320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005e330: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-0005e340: 615b 6e5f 6469 6d73 2f32 2a33 5d20 3d20  a[n_dims/2*3] = 
-0005e350: 7832 2a73 696e 5f62 6c6f 636b 5f74 6865  x2*sin_block_the
-0005e360: 7461 202b 2078 332a 636f 735f 626c 6f63  ta + x3*cos_bloc
-0005e370: 6b5f 7468 6574 613b 0a20 2020 2020 2020  k_theta;.       
-0005e380: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0005e390: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005e3a0: 2065 6c73 6520 6966 2028 2169 735f 6e65   else if (!is_ne
-0005e3b0: 6f78 2920 7b0a 2020 2020 2020 2020 2020  ox) {.          
-0005e3c0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0005e3d0: 6e74 3634 5f74 2069 3020 3d20 303b 2069  nt64_t i0 = 0; i
-0005e3e0: 3020 3c20 6e65 303b 2069 3020 2b3d 2032  0 < ne0; i0 += 2
-0005e3f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005e400: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005e410: 7420 666c 6f61 7420 636f 735f 7468 6574  t float cos_thet
-0005e420: 6120 3d20 636f 7366 2874 6865 7461 293b  a = cosf(theta);
-0005e430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005e440: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0005e450: 6c6f 6174 2073 696e 5f74 6865 7461 203d  loat sin_theta =
-0005e460: 2073 696e 6628 7468 6574 6129 3b0a 0a20   sinf(theta);.. 
-0005e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e480: 2020 2020 2020 2074 6865 7461 202a 3d20         theta *= 
-0005e490: 7468 6574 615f 7363 616c 653b 0a0a 2020  theta_scale;..  
-0005e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e4b0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0005e4c0: 7420 2a20 636f 6e73 7420 7372 6320 3d20  t * const src = 
-0005e4d0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
-0005e4e0: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-0005e4f0: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
-0005e500: 3220 2b20 6931 2a6e 6230 3120 2b20 6930  2 + i1*nb01 + i0
-0005e510: 2a6e 6230 3029 3b0a 2020 2020 2020 2020  *nb00);.        
-0005e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e530: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-0005e540: 745f 6461 7461 2020 3d20 2866 6c6f 6174  t_data  = (float
-0005e550: 202a 2928 2863 6861 7220 2a29 2020 6473   *)((char *)  ds
-0005e560: 742d 3e64 6174 6120 2b20 6933 2a6e 6233  t->data + i3*nb3
-0005e570: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
-0005e580: 2a6e 6231 2020 2b20 6930 2a6e 6230 293b  *nb1  + i0*nb0);
-0005e590: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005e5a0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0005e5b0: 666c 6f61 7420 7830 203d 2073 7263 5b30  float x0 = src[0
-0005e5c0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0005e5d0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005e5e0: 2066 6c6f 6174 2078 3120 3d20 7372 635b   float x1 = src[
-0005e5f0: 315d 3b0a 0a20 2020 2020 2020 2020 2020  1];..           
-0005e600: 2020 2020 2020 2020 2020 2020 2064 7374               dst
-0005e610: 5f64 6174 615b 305d 203d 2078 302a 636f  _data[0] = x0*co
-0005e620: 735f 7468 6574 6120 2d20 7831 2a73 696e  s_theta - x1*sin
-0005e630: 5f74 6865 7461 3b0a 2020 2020 2020 2020  _theta;.        
-0005e640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e650: 6473 745f 6461 7461 5b31 5d20 3d20 7830  dst_data[1] = x0
-0005e660: 2a73 696e 5f74 6865 7461 202b 2078 312a  *sin_theta + x1*
-0005e670: 636f 735f 7468 6574 613b 0a20 2020 2020  cos_theta;.     
-0005e680: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005e690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005e6a0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-0005e6b0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0005e6c0: 2054 4f44 4f3a 2074 6869 7320 6973 2070   TODO: this is p
-0005e6d0: 726f 6261 626c 7920 7772 6f6e 672c 2062  robably wrong, b
-0005e6e0: 7574 2049 2063 616e 2774 2066 6967 7572  ut I can't figur
-0005e6f0: 6520 6974 206f 7574 202e 2e0a 2020 2020  e it out ...    
+00053250: 2d3e 7479 7065 3b0a 0a20 2020 2063 6f6e  ->type;..    con
+00053260: 7374 2062 6f6f 6c20 7372 6331 5f63 6f6e  st bool src1_con
+00053270: 7420 3d20 6767 6d6c 5f69 735f 636f 6e74  t = ggml_is_cont
+00053280: 6967 756f 7573 2873 7263 3129 3b0a 0a20  iguous(src1);.. 
+00053290: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
+000532a0: 7420 2020 2063 6f6e 7374 2076 6563 5f64  t    const vec_d
+000532b0: 6f74 2020 2020 2020 2020 2020 2020 2020  ot              
+000532c0: 203d 2074 7970 655f 7472 6169 7473 5b74   = type_traits[t
+000532d0: 7970 655d 2e76 6563 5f64 6f74 3b0a 2020  ype].vec_dot;.  
+000532e0: 2020 656e 756d 2067 676d 6c5f 7479 7065    enum ggml_type
+000532f0: 2020 2020 636f 6e73 7420 7665 635f 646f      const vec_do
+00053300: 745f 7479 7065 2020 2020 2020 2020 2020  t_type          
+00053310: 3d20 7479 7065 5f74 7261 6974 735b 7479  = type_traits[ty
+00053320: 7065 5d2e 7665 635f 646f 745f 7479 7065  pe].vec_dot_type
+00053330: 3b0a 2020 2020 6767 6d6c 5f66 726f 6d5f  ;.    ggml_from_
+00053340: 666c 6f61 745f 7420 636f 6e73 7420 6672  float_t const fr
+00053350: 6f6d 5f66 6c6f 6174 5f74 6f5f 7665 635f  om_float_to_vec_
+00053360: 646f 7420 3d20 7479 7065 5f74 7261 6974  dot = type_trait
+00053370: 735b 7665 635f 646f 745f 7479 7065 5d2e  s[vec_dot_type].
+00053380: 6672 6f6d 5f66 6c6f 6174 3b0a 0a20 2020  from_float;..   
+00053390: 2047 474d 4c5f 4153 5345 5254 286e 6530   GGML_ASSERT(ne0
+000533a0: 203d 3d20 6e65 3031 293b 0a20 2020 2047   == ne01);.    G
+000533b0: 474d 4c5f 4153 5345 5254 286e 6531 203d  GML_ASSERT(ne1 =
+000533c0: 3d20 6e65 3131 293b 0a20 2020 2047 474d  = ne11);.    GGM
+000533d0: 4c5f 4153 5345 5254 286e 6532 203d 3d20  L_ASSERT(ne2 == 
+000533e0: 6e65 3132 293b 0a20 2020 2047 474d 4c5f  ne12);.    GGML_
+000533f0: 4153 5345 5254 286e 6533 203d 3d20 6e65  ASSERT(ne3 == ne
+00053400: 3133 293b 0a0a 2020 2020 2f2f 2077 6520  13);..    // we 
+00053410: 646f 6e27 7420 7375 7070 6f72 7420 7065  don't support pe
+00053420: 726d 7574 6564 2073 7263 3020 6f72 2073  rmuted src0 or s
+00053430: 7263 310a 2020 2020 4747 4d4c 5f41 5353  rc1.    GGML_ASS
+00053440: 4552 5428 6e62 3030 203d 3d20 4747 4d4c  ERT(nb00 == GGML
+00053450: 5f54 5950 455f 5349 5a45 5b74 7970 655d  _TYPE_SIZE[type]
+00053460: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00053470: 5254 286e 6231 3020 3d3d 2073 697a 656f  RT(nb10 == sizeo
+00053480: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+00053490: 2f2f 2064 7374 2063 616e 6e6f 7420 6265  // dst cannot be
+000534a0: 2074 7261 6e73 706f 7365 6420 6f72 2070   transposed or p
+000534b0: 6572 6d75 7465 640a 2020 2020 4747 4d4c  ermuted.    GGML
+000534c0: 5f41 5353 4552 5428 6e62 3020 3d3d 2073  _ASSERT(nb0 == s
+000534d0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+000534e0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+000534f0: 6230 203c 3d20 6e62 3129 3b0a 2020 2020  b0 <= nb1);.    
+00053500: 4747 4d4c 5f41 5353 4552 5428 6e62 3120  GGML_ASSERT(nb1 
+00053510: 3c3d 206e 6232 293b 0a20 2020 2047 474d  <= nb2);.    GGM
+00053520: 4c5f 4153 5345 5254 286e 6232 203c 3d20  L_ASSERT(nb2 <= 
+00053530: 6e62 3329 3b0a 0a20 2020 202f 2f20 6e62  nb3);..    // nb
+00053540: 3031 203e 3d20 6e62 3030 202d 2073 7263  01 >= nb00 - src
+00053550: 3020 6973 206e 6f74 2074 7261 6e73 706f  0 is not transpo
+00053560: 7365 640a 2020 2020 2f2f 2020 2063 6f6d  sed.    //   com
+00053570: 7075 7465 2062 7920 7372 6330 2072 6f77  pute by src0 row
+00053580: 730a 0a23 6966 2064 6566 696e 6564 2847  s..#if defined(G
+00053590: 474d 4c5f 5553 455f 434c 424c 4153 5429  GML_USE_CLBLAST)
+000535a0: 0a20 2020 2069 6620 2867 676d 6c5f 636c  .    if (ggml_cl
+000535b0: 5f63 616e 5f6d 756c 5f6d 6174 2873 7263  _can_mul_mat(src
+000535c0: 302c 2073 7263 312c 2064 7374 2929 207b  0, src1, dst)) {
+000535d0: 0a20 2020 2020 2020 202f 2f20 544f 444f  .        // TODO
+000535e0: 3a20 6861 6e64 6c65 2063 6173 6520 7768  : handle case wh
+000535f0: 656e 2073 7263 3020 6973 2062 726f 6164  en src0 is broad
+00053600: 6361 7374 2d61 626c 6520 696e 746f 2073  cast-able into s
+00053610: 7263 3120 6163 726f 7373 2032 6e64 2c33  rc1 across 2nd,3
+00053620: 7264 2064 696d 656e 7369 6f6e 0a20 2020  rd dimension.   
+00053630: 2020 2020 202f 2f20 2020 2020 2020 7265       //       re
+00053640: 663a 2068 7474 7073 3a2f 2f67 6974 6875  f: https://githu
+00053650: 622e 636f 6d2f 6767 6572 6761 6e6f 762f  b.com/ggerganov/
+00053660: 6767 6d6c 2f70 756c 6c2f 3232 340a 2020  ggml/pull/224.  
+00053670: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00053680: 5428 6e65 3032 203d 3d20 6e65 3132 293b  T(ne02 == ne12);
+00053690: 0a20 2020 2020 2020 2047 474d 4c5f 4153  .        GGML_AS
+000536a0: 5345 5254 286e 6530 3320 3d3d 206e 6531  SERT(ne03 == ne1
+000536b0: 3329 3b0a 0a20 2020 2020 2020 2069 6620  3);..        if 
+000536c0: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
+000536d0: 3020 2626 2070 6172 616d 732d 3e74 7970  0 && params->typ
+000536e0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f43  e == GGML_TASK_C
+000536f0: 4f4d 5055 5445 2920 7b0a 2020 2020 2020  OMPUTE) {.      
+00053700: 2020 2020 2020 6767 6d6c 5f63 6c5f 6d75        ggml_cl_mu
+00053710: 6c5f 6d61 7428 7372 6330 2c20 7372 6331  l_mat(src0, src1
+00053720: 2c20 6473 742c 2070 6172 616d 732d 3e77  , dst, params->w
+00053730: 6461 7461 2c20 7061 7261 6d73 2d3e 7773  data, params->ws
+00053740: 697a 6529 3b0a 2020 2020 2020 2020 7d0a  ize);.        }.
+00053750: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00053760: 2020 2020 7d0a 2365 6e64 6966 0a0a 2369      }.#endif..#i
+00053770: 6620 6465 6669 6e65 6428 4747 4d4c 5f55  f defined(GGML_U
+00053780: 5345 5f41 4343 454c 4552 4154 4529 207c  SE_ACCELERATE) |
+00053790: 7c20 6465 6669 6e65 6428 4747 4d4c 5f55  | defined(GGML_U
+000537a0: 5345 5f4f 5045 4e42 4c41 5329 0a20 2020  SE_OPENBLAS).   
+000537b0: 2069 6620 2867 676d 6c5f 636f 6d70 7574   if (ggml_comput
+000537c0: 655f 666f 7277 6172 645f 6d75 6c5f 6d61  e_forward_mul_ma
+000537d0: 745f 7573 655f 626c 6173 2873 7263 302c  t_use_blas(src0,
+000537e0: 2073 7263 312c 2064 7374 2929 207b 0a20   src1, dst)) {. 
+000537f0: 2020 2020 2020 202f 2f20 544f 444f 3a20         // TODO: 
+00053800: 6861 6e64 6c65 2063 6173 6520 7768 656e  handle case when
+00053810: 2073 7263 3020 6973 2062 726f 6164 6361   src0 is broadca
+00053820: 7374 2d61 626c 6520 696e 746f 2073 7263  st-able into src
+00053830: 3120 6163 726f 7373 2032 6e64 2c33 7264  1 across 2nd,3rd
+00053840: 2064 696d 656e 7369 6f6e 0a20 2020 2020   dimension.     
+00053850: 2020 202f 2f20 2020 2020 2020 7265 663a     //       ref:
+00053860: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
+00053870: 636f 6d2f 6767 6572 6761 6e6f 762f 6767  com/ggerganov/gg
+00053880: 6d6c 2f70 756c 6c2f 3232 340a 2020 2020  ml/pull/224.    
+00053890: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000538a0: 6e65 3032 203d 3d20 6e65 3132 293b 0a20  ne02 == ne12);. 
+000538b0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+000538c0: 5254 286e 6530 3320 3d3d 206e 6531 3329  RT(ne03 == ne13)
+000538d0: 3b0a 0a20 2020 2020 2020 2069 6620 2870  ;..        if (p
+000538e0: 6172 616d 732d 3e69 7468 2021 3d20 3029  arams->ith != 0)
+000538f0: 207b 0a20 2020 2020 2020 2020 2020 2072   {.            r
+00053900: 6574 7572 6e3b 0a20 2020 2020 2020 207d  eturn;.        }
+00053910: 0a0a 2020 2020 2020 2020 6966 2028 7061  ..        if (pa
+00053920: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00053930: 4d4c 5f54 4153 4b5f 494e 4954 2920 7b0a  ML_TASK_INIT) {.
+00053940: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00053950: 726e 3b0a 2020 2020 2020 2020 7d0a 0a20  rn;.        }.. 
+00053960: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
+00053970: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00053980: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+00053990: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000539a0: 7572 6e3b 0a20 2020 2020 2020 207d 0a0a  urn;.        }..
+000539b0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000539c0: 3634 5f74 2069 3033 203d 2030 3b20 6930  64_t i03 = 0; i0
+000539d0: 3320 3c20 6e65 3033 3b20 6930 332b 2b29  3 < ne03; i03++)
+000539e0: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+000539f0: 6f72 2028 696e 7436 345f 7420 6930 3220  or (int64_t i02 
+00053a00: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
+00053a10: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
+00053a20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00053a30: 766f 6964 202a 2078 203d 2028 6368 6172  void * x = (char
+00053a40: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00053a50: 2069 3033 2a6e 6230 3320 2b20 6930 322a   i03*nb03 + i02*
+00053a60: 6e62 3032 3b0a 2020 2020 2020 2020 2020  nb02;.          
+00053a70: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+00053a80: 7420 2a20 7920 3d20 2866 6c6f 6174 202a  t * y = (float *
+00053a90: 2920 2828 6368 6172 202a 2920 7372 6331  ) ((char *) src1
+00053aa0: 2d3e 6461 7461 202b 2069 3032 2a6e 6231  ->data + i02*nb1
+00053ab0: 3220 2b20 6930 332a 6e62 3133 293b 0a0a  2 + i03*nb13);..
+00053ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053ad0: 666c 6f61 7420 2a20 6420 3d20 2866 6c6f  float * d = (flo
+00053ae0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+00053af0: 6473 742d 3e64 6174 6120 2b20 6930 322a  dst->data + i02*
+00053b00: 6e62 3220 2b20 6930 332a 6e62 3329 3b0a  nb2 + i03*nb3);.
+00053b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053b20: 2069 6620 2874 7970 6520 213d 2047 474d   if (type != GGM
+00053b30: 4c5f 5459 5045 5f46 3332 2920 7b0a 2020  L_TYPE_F32) {.  
+00053b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053b50: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00053b60: 2a20 636f 6e73 7420 7764 6174 6120 2020  * const wdata   
+00053b70: 203d 2070 6172 616d 732d 3e77 6461 7461   = params->wdata
+00053b80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00053b90: 2020 2020 2020 6767 6d6c 5f74 6f5f 666c        ggml_to_fl
+00053ba0: 6f61 745f 7420 636f 6e73 7420 746f 5f66  oat_t const to_f
+00053bb0: 6c6f 6174 203d 2074 7970 655f 7472 6169  loat = type_trai
+00053bc0: 7473 5b74 7970 655d 2e74 6f5f 666c 6f61  ts[type].to_floa
+00053bd0: 743b 0a0a 2020 2020 2020 2020 2020 2020  t;..            
+00053be0: 2020 2020 2020 2020 7369 7a65 5f74 2069          size_t i
+00053bf0: 6420 3d20 303b 0a20 2020 2020 2020 2020  d = 0;.         
+00053c00: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00053c10: 696e 7436 345f 7420 6930 3120 3d20 303b  int64_t i01 = 0;
+00053c20: 2069 3031 203c 206e 6530 313b 202b 2b69   i01 < ne01; ++i
+00053c30: 3031 2920 7b0a 2020 2020 2020 2020 2020  01) {.          
+00053c40: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00053c50: 5f66 6c6f 6174 2828 6368 6172 202a 2920  _float((char *) 
+00053c60: 7372 6330 2d3e 6461 7461 202b 2069 3033  src0->data + i03
+00053c70: 2a6e 6230 3320 2b20 6930 322a 6e62 3032  *nb03 + i02*nb02
+00053c80: 202b 2069 3031 2a6e 6230 312c 2077 6461   + i01*nb01, wda
+00053c90: 7461 202b 2069 642c 206e 6530 3029 3b0a  ta + id, ne00);.
+00053ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053cb0: 2020 2020 2020 2020 6964 202b 3d20 6e65          id += ne
+00053cc0: 3030 3b0a 2020 2020 2020 2020 2020 2020  00;.            
+00053cd0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00053ce0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00053cf0: 7373 6572 7428 6964 2a73 697a 656f 6628  ssert(id*sizeof(
+00053d00: 666c 6f61 7429 203c 3d20 7061 7261 6d73  float) <= params
+00053d10: 2d3e 7773 697a 6529 3b0a 2020 2020 2020  ->wsize);.      
+00053d20: 2020 2020 2020 2020 2020 2020 2020 7820                x 
+00053d30: 3d20 7764 6174 613b 0a20 2020 2020 2020  = wdata;.       
+00053d40: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00053d50: 2020 2020 2020 2020 2020 2020 6362 6c61              cbla
+00053d60: 735f 7367 656d 6d28 4362 6c61 7352 6f77  s_sgemm(CblasRow
+00053d70: 4d61 6a6f 722c 2043 626c 6173 4e6f 5472  Major, CblasNoTr
+00053d80: 616e 732c 2043 626c 6173 5472 616e 732c  ans, CblasTrans,
+00053d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053da0: 2020 2020 2020 2020 206e 6531 312c 206e           ne11, n
+00053db0: 6530 312c 206e 6531 302c 0a20 2020 2020  e01, ne10,.     
+00053dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053dd0: 2020 2031 2e30 662c 2020 2020 792c 206e     1.0f,    y, n
+00053de0: 6531 302c 0a20 2020 2020 2020 2020 2020  e10,.           
+00053df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e00: 2020 2020 2020 782c 206e 6530 302c 0a20        x, ne00,. 
+00053e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e20: 2020 2020 2020 2030 2e30 662c 2020 2020         0.0f,    
+00053e30: 642c 206e 6530 3129 3b0a 2020 2020 2020  d, ne01);.      
+00053e40: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00053e50: 7d0a 0a20 2020 2020 2020 202f 2f70 7269  }..        //pri
+00053e60: 6e74 6628 2243 424c 4153 203d 2025 6620  ntf("CBLAS = %f 
+00053e70: 6d73 2c20 2564 2078 2025 6420 7820 2564  ms, %d x %d x %d
+00053e80: 2078 2025 645c 6e22 2c20 2867 676d 6c5f   x %d\n", (ggml_
+00053e90: 7065 7266 5f74 696d 655f 7573 2829 202d  perf_time_us() -
+00053ea0: 2074 3029 2f31 3030 302e 302c 206e 6530   t0)/1000.0, ne0
+00053eb0: 2c20 6e65 312c 206e 6532 2c20 6e65 3329  , ne1, ne2, ne3)
+00053ec0: 3b0a 0a20 2020 2020 2020 2072 6574 7572  ;..        retur
+00053ed0: 6e3b 0a20 2020 207d 0a23 656e 6469 660a  n;.    }.#endif.
+00053ee0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+00053ef0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+00053f00: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
+00053f10: 2020 2069 6620 2873 7263 312d 3e74 7970     if (src1->typ
+00053f20: 6520 213d 2076 6563 5f64 6f74 5f74 7970  e != vec_dot_typ
+00053f30: 6529 207b 0a20 2020 2020 2020 2020 2020  e) {.           
+00053f40: 2063 6861 7220 2a20 7764 6174 6120 3d20   char * wdata = 
+00053f50: 7061 7261 6d73 2d3e 7764 6174 613b 0a20  params->wdata;. 
+00053f60: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00053f70: 2073 697a 655f 7420 726f 775f 7369 7a65   size_t row_size
+00053f80: 203d 206e 6531 302a 4747 4d4c 5f54 5950   = ne10*GGML_TYP
+00053f90: 455f 5349 5a45 5b76 6563 5f64 6f74 5f74  E_SIZE[vec_dot_t
+00053fa0: 7970 655d 2f47 474d 4c5f 424c 434b 5f53  ype]/GGML_BLCK_S
+00053fb0: 495a 455b 7665 635f 646f 745f 7479 7065  IZE[vec_dot_type
+00053fc0: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
+00053fd0: 666f 7220 2869 6e74 3634 5f74 2069 3133  for (int64_t i13
+00053fe0: 203d 2030 3b20 6931 3320 3c20 6e65 3133   = 0; i13 < ne13
+00053ff0: 3b20 2b2b 6931 3329 207b 0a20 2020 2020  ; ++i13) {.     
+00054000: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00054010: 696e 7436 345f 7420 6931 3220 3d20 303b  int64_t i12 = 0;
+00054020: 2069 3132 203c 206e 6531 323b 202b 2b69   i12 < ne12; ++i
+00054030: 3132 2920 7b0a 2020 2020 2020 2020 2020  12) {.          
+00054040: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00054050: 6e74 3634 5f74 2069 3131 203d 2030 3b20  nt64_t i11 = 0; 
+00054060: 6931 3120 3c20 6e65 3131 3b20 2b2b 6931  i11 < ne11; ++i1
+00054070: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
+00054080: 2020 2020 2020 2020 2020 2020 2066 726f               fro
+00054090: 6d5f 666c 6f61 745f 746f 5f76 6563 5f64  m_float_to_vec_d
+000540a0: 6f74 2828 666c 6f61 7420 2a29 2828 6368  ot((float *)((ch
+000540b0: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
+000540c0: 202b 2069 3133 2a6e 6231 3320 2b20 6931   + i13*nb13 + i1
+000540d0: 322a 6e62 3132 202b 2069 3131 2a6e 6231  2*nb12 + i11*nb1
+000540e0: 3129 2c20 2876 6f69 6420 2a29 2077 6461  1), (void *) wda
+000540f0: 7461 2c20 6e65 3130 293b 0a20 2020 2020  ta, ne10);.     
+00054100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054110: 2020 2077 6461 7461 202b 3d20 726f 775f     wdata += row_
+00054120: 7369 7a65 3b0a 2020 2020 2020 2020 2020  size;.          
+00054130: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00054140: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00054150: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00054160: 2020 2020 7d0a 0a20 2020 2020 2020 2072      }..        r
+00054170: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+00054180: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00054190: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+000541a0: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+000541b0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+000541c0: 7d0a 0a20 2020 202f 2f20 7061 7261 6c6c  }..    // parall
+000541d0: 656c 697a 6520 6279 2073 7263 3020 726f  elize by src0 ro
+000541e0: 7773 0a20 2020 2063 6f6e 7374 2069 6e74  ws.    const int
+000541f0: 3634 5f74 2064 7220 3d20 286e 6530 3120  64_t dr = (ne01 
+00054200: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
+00054210: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00054220: 5f74 2069 7231 3020 3d20 6472 2a69 7468  _t ir10 = dr*ith
+00054230: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+00054240: 345f 7420 6972 3131 203d 204d 494e 2869  4_t ir11 = MIN(i
+00054250: 7231 3020 2b20 6472 2c20 6e65 3031 293b  r10 + dr, ne01);
+00054260: 0a0a 2020 2020 2f2f 2073 7263 3120 726f  ..    // src1 ro
+00054270: 7773 0a20 2020 2063 6f6e 7374 2069 6e74  ws.    const int
+00054280: 3634 5f74 206e 7231 203d 206e 6531 312a  64_t nr1 = ne11*
+00054290: 6e65 3132 2a6e 6531 333b 0a0a 2020 2020  ne12*ne13;..    
+000542a0: 636f 6e73 7420 766f 6964 202a 2077 6461  const void * wda
+000542b0: 7461 2020 2020 3d20 2873 7263 312d 3e74  ta    = (src1->t
+000542c0: 7970 6520 3d3d 2076 6563 5f64 6f74 5f74  ype == vec_dot_t
+000542d0: 7970 6529 203f 2073 7263 312d 3e64 6174  ype) ? src1->dat
+000542e0: 6120 3a20 7061 7261 6d73 2d3e 7764 6174  a : params->wdat
+000542f0: 613b 0a20 2020 2063 6f6e 7374 2073 697a  a;.    const siz
+00054300: 655f 7420 726f 775f 7369 7a65 203d 206e  e_t row_size = n
+00054310: 6531 302a 4747 4d4c 5f54 5950 455f 5349  e10*GGML_TYPE_SI
+00054320: 5a45 5b76 6563 5f64 6f74 5f74 7970 655d  ZE[vec_dot_type]
+00054330: 2f47 474d 4c5f 424c 434b 5f53 495a 455b  /GGML_BLCK_SIZE[
+00054340: 7665 635f 646f 745f 7479 7065 5d3b 0a0a  vec_dot_type];..
+00054350: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00054360: 2069 7231 203d 2030 3b20 6972 3120 3c20   ir1 = 0; ir1 < 
+00054370: 6e72 313b 202b 2b69 7231 2920 7b0a 2020  nr1; ++ir1) {.  
+00054380: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00054390: 345f 7420 6931 3320 3d20 2869 7231 2f28  4_t i13 = (ir1/(
+000543a0: 6e65 3132 2a6e 6531 3129 293b 0a20 2020  ne12*ne11));.   
+000543b0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+000543c0: 5f74 2069 3132 203d 2028 6972 3120 2d20  _t i12 = (ir1 - 
+000543d0: 6931 332a 6e65 3132 2a6e 6531 3129 2f6e  i13*ne12*ne11)/n
+000543e0: 6531 313b 0a20 2020 2020 2020 2063 6f6e  e11;.        con
+000543f0: 7374 2069 6e74 3634 5f74 2069 3131 203d  st int64_t i11 =
+00054400: 2028 6972 3120 2d20 6931 332a 6e65 3132   (ir1 - i13*ne12
+00054410: 2a6e 6531 3120 2d20 6931 322a 6e65 3131  *ne11 - i12*ne11
+00054420: 293b 0a0a 2020 2020 2020 2020 636f 6e73  );..        cons
+00054430: 7420 696e 7436 345f 7420 6972 3020 3d20  t int64_t ir0 = 
+00054440: 2869 7231 2f6e 6531 3129 2528 6e65 3032  (ir1/ne11)%(ne02
+00054450: 2a6e 6530 3329 3b0a 2020 2020 2020 2020  *ne03);.        
+00054460: 636f 6e73 7420 696e 7436 345f 7420 6930  const int64_t i0
+00054470: 3320 3d20 2869 7230 2f28 6e65 3032 2929  3 = (ir0/(ne02))
+00054480: 3b0a 2020 2020 2020 2020 2f2f 2048 6163  ;.        // Hac
+00054490: 6b20 666f 7220 2246 616c 636f 6e20 6d75  k for "Falcon mu
+000544a0: 6c74 692d 7175 6572 792d 6174 7465 6e74  lti-query-attent
+000544b0: 696f 6e20 6b65 7920 7374 7574 7465 7222  ion key stutter"
+000544c0: 202f 2061 6c74 6572 6e61 7469 7665 2074   / alternative t
+000544d0: 6f20 6767 6d6c 5f72 6570 6561 7432 2e0a  o ggml_repeat2..
+000544e0: 2020 2020 2020 2020 2f2f 2053 6565 2068          // See h
+000544f0: 7474 7073 3a2f 2f67 6974 6875 622e 636f  ttps://github.co
+00054500: 6d2f 6767 6572 6761 6e6f 762f 6c6c 616d  m/ggerganov/llam
+00054510: 612e 6370 702f 6973 7375 6573 2f31 3630  a.cpp/issues/160
+00054520: 3223 6973 7375 6563 6f6d 6d65 6e74 2d31  2#issuecomment-1
+00054530: 3630 3630 3837 3437 303a 0a20 2020 2020  606087470:.     
+00054540: 2020 202f 2f20 4747 3a20 7468 6973 2069     // GG: this i
+00054550: 7320 6c69 6b65 6c79 2074 6865 2063 6f72  s likely the cor
+00054560: 7265 6374 2077 6179 2074 6f20 6272 6f61  rect way to broa
+00054570: 6463 6173 742c 2074 686f 7567 6820 6e65  dcast, though ne
+00054580: 6564 2073 6f6d 6520 6d6f 7265 2074 686f  ed some more tho
+00054590: 7567 6874 0a20 2020 2020 2020 202f 2f20  ught.        // 
+000545a0: 2020 2020 7468 6572 6566 6f72 6520 6c65      therefore le
+000545b0: 6176 696e 6720 7468 6520 636f 6d6d 656e  aving the commen
+000545c0: 7473 2074 6f20 7265 6d69 6e64 2075 7320  ts to remind us 
+000545d0: 666f 7220 6e6f 770a 2020 2020 2020 2020  for now.        
+000545e0: 636f 6e73 7420 696e 7436 345f 7420 6930  const int64_t i0
+000545f0: 3220 3d20 2869 3132 202f 2028 6e65 3132  2 = (i12 / (ne12
+00054600: 202f 206e 6530 3229 293b 0a20 2020 2020   / ne02));.     
+00054610: 2020 202f 2f20 4f72 6967 696e 616c 2066     // Original f
+00054620: 726f 6d20 5052 2f32 3234 2028 616e 6420  rom PR/224 (and 
+00054630: 616c 736f 2065 7373 656e 7469 616c 2f63  also essential/c
+00054640: 6f72 7265 6374 2066 6f72 206e 6f6e 2d62  orrect for non-b
+00054650: 726f 6164 6361 7374 206d 6174 6d75 6c73  roadcast matmuls
+00054660: 2069 6e20 4661 6c63 6f6e 290a 2020 2020   in Falcon).    
+00054670: 2020 2020 2f2f 2063 6f6e 7374 2069 6e74      // const int
+00054680: 3634 5f74 2069 3032 203d 2028 6972 3020  64_t i02 = (ir0 
+00054690: 2d20 6930 332a 6e65 3032 293b 0a0a 2020  - i03*ne02);..  
+000546a0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+000546b0: 345f 7420 6931 203d 2069 3131 3b0a 2020  4_t i1 = i11;.  
+000546c0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+000546d0: 345f 7420 6932 203d 2069 3132 3b0a 2020  4_t i2 = i12;.  
+000546e0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+000546f0: 345f 7420 6933 203d 2069 3133 3b0a 0a20  4_t i3 = i13;.. 
+00054700: 2020 2020 2020 2063 6f6e 7374 2063 6861         const cha
+00054710: 7220 2a20 7372 6330 5f72 6f77 203d 2028  r * src0_row = (
+00054720: 636f 6e73 7420 6368 6172 202a 2920 7372  const char *) sr
+00054730: 6330 2d3e 6461 7461 202b 2028 2020 3020  c0->data + (  0 
+00054740: 2b20 6930 322a 6e62 3032 202b 2069 3033  + i02*nb02 + i03
+00054750: 2a6e 6230 3320 2020 2020 293b 0a0a 2020  *nb03     );..  
+00054760: 2020 2020 2020 2f2f 2064 6573 633a 2077        // desc: w
+00054770: 6865 6e20 7372 6331 2069 7320 6e6f 7420  hen src1 is not 
+00054780: 6120 636f 6e74 6967 756f 7573 206d 656d  a contiguous mem
+00054790: 6f72 7920 626c 6f63 6b20 7765 2068 6176  ory block we hav
+000547a0: 6520 746f 2063 616c 6375 6c61 7465 2074  e to calculate t
+000547b0: 6865 206f 6666 7365 7420 7573 696e 6720  he offset using 
+000547c0: 7468 6520 7374 7269 6465 730a 2020 2020  the strides.    
+000547d0: 2020 2020 2f2f 2020 2020 2020 2069 6620      //       if 
+000547e0: 6974 2069 732c 2074 6865 6e20 7765 2068  it is, then we h
+000547f0: 6176 6520 6569 7468 6572 2063 6f70 6965  ave either copie
+00054800: 6420 7468 6520 6461 7461 2074 6f20 7061  d the data to pa
+00054810: 7261 6d73 2d3e 7764 6174 6120 616e 6420  rams->wdata and 
+00054820: 6d61 6465 2069 7420 636f 6e74 6967 756f  made it contiguo
+00054830: 7573 206f 7220 7765 2061 7265 2075 7369  us or we are usi
+00054840: 6e67 0a20 2020 2020 2020 202f 2f20 2020  ng.        //   
+00054850: 2020 2020 7468 6520 6f72 6967 696e 616c      the original
+00054860: 2073 7263 3120 6461 7461 2070 6f69 6e74   src1 data point
+00054870: 6572 2c20 736f 2077 6520 7368 6f75 6c64  er, so we should
+00054880: 2069 6e64 6578 2075 7369 6e67 2074 6865   index using the
+00054890: 2069 6e64 6963 6573 2064 6972 6563 746c   indices directl
+000548a0: 790a 2020 2020 2020 2020 2f2f 2054 4f44  y.        // TOD
+000548b0: 4f3a 2074 6869 7320 6973 2061 2062 6974  O: this is a bit
+000548c0: 206f 6620 6120 6861 636b 2c20 7765 2073   of a hack, we s
+000548d0: 686f 756c 6420 7072 6f62 6162 6c79 2068  hould probably h
+000548e0: 6176 6520 6120 6265 7474 6572 2077 6179  ave a better way
+000548f0: 2074 6f20 6861 6e64 6c65 2074 6869 730a   to handle this.
+00054900: 2020 2020 2020 2020 636f 6e73 7420 6368          const ch
+00054910: 6172 202a 2073 7263 315f 636f 6c20 3d20  ar * src1_col = 
+00054920: 2863 6f6e 7374 2063 6861 7220 2a29 2077  (const char *) w
+00054930: 6461 7461 202b 0a20 2020 2020 2020 2020  data +.         
+00054940: 2020 2028 7372 6331 5f63 6f6e 7420 7c7c     (src1_cont ||
+00054950: 2073 7263 312d 3e74 7970 6520 213d 2076   src1->type != v
+00054960: 6563 5f64 6f74 5f74 7970 650a 2020 2020  ec_dot_type.    
+00054970: 2020 2020 2020 2020 203f 2028 6931 3120           ? (i11 
+00054980: 2020 2020 202b 2069 3132 2a6e 6531 3120       + i12*ne11 
+00054990: 2b20 6931 332a 6e65 3132 2a6e 6531 3129  + i13*ne12*ne11)
+000549a0: 2a72 6f77 5f73 697a 650a 2020 2020 2020  *row_size.      
+000549b0: 2020 2020 2020 203a 2028 6931 312a 6e62         : (i11*nb
+000549c0: 3131 202b 2069 3132 2a6e 6231 3220 2b20  11 + i12*nb12 + 
+000549d0: 6931 332a 6e62 3133 2929 3b0a 0a20 2020  i13*nb13));..   
+000549e0: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
+000549f0: 5f63 6f6c 203d 2028 666c 6f61 7420 2a29  _col = (float *)
+00054a00: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+00054a10: 6461 7461 202b 2028 6931 2a6e 6231 202b  data + (i1*nb1 +
+00054a20: 2069 322a 6e62 3220 2b20 6933 2a6e 6233   i2*nb2 + i3*nb3
+00054a30: 2929 3b0a 0a20 2020 2020 2020 2066 6f72  ));..        for
+00054a40: 2028 696e 7436 345f 7420 6972 203d 2069   (int64_t ir = i
+00054a50: 7231 303b 2069 7220 3c20 6972 3131 3b20  r10; ir < ir11; 
+00054a60: 2b2b 6972 2920 7b0a 2020 2020 2020 2020  ++ir) {.        
+00054a70: 2020 2020 7665 635f 646f 7428 6e65 3030      vec_dot(ne00
+00054a80: 2c20 2664 7374 5f63 6f6c 5b69 725d 2c20  , &dst_col[ir], 
+00054a90: 7372 6330 5f72 6f77 202b 2069 722a 6e62  src0_row + ir*nb
+00054aa0: 3031 2c20 7372 6331 5f63 6f6c 293b 0a20  01, src1_col);. 
+00054ab0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+00054ac0: 2020 2020 2f2f 696e 7436 345f 7420 7431      //int64_t t1
+00054ad0: 203d 2067 676d 6c5f 7469 6d65 5f75 7328   = ggml_time_us(
+00054ae0: 293b 0a20 2020 202f 2f73 7461 7469 6320  );.    //static 
+00054af0: 696e 7436 345f 7420 6163 6320 3d20 303b  int64_t acc = 0;
+00054b00: 0a20 2020 202f 2f61 6363 202b 3d20 7431  .    //acc += t1
+00054b10: 202d 2074 303b 0a20 2020 202f 2f69 6620   - t0;.    //if 
+00054b20: 2874 3120 2d20 7430 203e 2031 3029 207b  (t1 - t0 > 10) {
+00054b30: 0a20 2020 202f 2f20 2020 2070 7269 6e74  .    //    print
+00054b40: 6628 225c 6e22 293b 0a20 2020 202f 2f20  f("\n");.    // 
+00054b50: 2020 2070 7269 6e74 6628 226e 6530 3020     printf("ne00 
+00054b60: 3d20 2535 642c 206e 6530 3120 3d20 2535  = %5d, ne01 = %5
+00054b70: 642c 206e 6530 3220 3d20 2535 642c 206e  d, ne02 = %5d, n
+00054b80: 6530 3320 3d20 2535 645c 6e22 2c20 6e65  e03 = %5d\n", ne
+00054b90: 3030 2c20 6e65 3031 2c20 6e65 3032 2c20  00, ne01, ne02, 
+00054ba0: 6e65 3033 293b 0a20 2020 202f 2f20 2020  ne03);.    //   
+00054bb0: 2070 7269 6e74 6628 226e 6230 3020 3d20   printf("nb00 = 
+00054bc0: 2535 642c 206e 6230 3120 3d20 2535 642c  %5d, nb01 = %5d,
+00054bd0: 206e 6230 3220 3d20 2535 642c 206e 6230   nb02 = %5d, nb0
+00054be0: 3320 3d20 2535 645c 6e22 2c20 6e62 3030  3 = %5d\n", nb00
+00054bf0: 2c20 6e62 3031 2c20 6e62 3032 2c20 6e62  , nb01, nb02, nb
+00054c00: 3033 293b 0a20 2020 202f 2f20 2020 2070  03);.    //    p
+00054c10: 7269 6e74 6628 226e 6531 3020 3d20 2535  rintf("ne10 = %5
+00054c20: 642c 206e 6531 3120 3d20 2535 642c 206e  d, ne11 = %5d, n
+00054c30: 6531 3220 3d20 2535 642c 206e 6531 3320  e12 = %5d, ne13 
+00054c40: 3d20 2535 645c 6e22 2c20 6e65 3130 2c20  = %5d\n", ne10, 
+00054c50: 6e65 3131 2c20 6e65 3132 2c20 6e65 3133  ne11, ne12, ne13
+00054c60: 293b 0a0a 2020 2020 2f2f 2020 2020 7072  );..    //    pr
+00054c70: 696e 7466 2822 5858 5858 5858 5858 5858  intf("XXXXXXXXXX
+00054c80: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00054c90: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00054ca0: 5858 5858 5858 5858 5858 2074 6173 6b20  XXXXXXXXXX task 
+00054cb0: 2564 2f25 643a 2025 6420 7573 2c20 6163  %d/%d: %d us, ac
+00054cc0: 6320 3d20 2564 5c6e 222c 2069 7468 2c20  c = %d\n", ith, 
+00054cd0: 6e74 682c 2028 696e 7429 2028 7431 202d  nth, (int) (t1 -
+00054ce0: 2074 3029 2c20 2869 6e74 2920 6163 6329   t0), (int) acc)
+00054cf0: 3b0a 2020 2020 2f2f 7d0a 7d0a 0a0a 2f2f  ;.    //}.}...//
+00054d00: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00054d10: 7277 6172 645f 6f75 745f 7072 6f64 0a0a  rward_out_prod..
+00054d20: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00054d30: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00054d40: 645f 6f75 745f 7072 6f64 5f66 3332 280a  d_out_prod_f32(.
+00054d50: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00054d60: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00054d70: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00054d80: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00054d90: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00054da0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00054db0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00054dc0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00054dd0: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
+00054de0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00054df0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00054e00: 2020 2069 6e74 3634 5f74 2074 3020 3d20     int64_t t0 = 
+00054e10: 6767 6d6c 5f70 6572 665f 7469 6d65 5f75  ggml_perf_time_u
+00054e20: 7328 293b 0a20 2020 2055 4e55 5345 4428  s();.    UNUSED(
+00054e30: 7430 293b 0a0a 2020 2020 4747 4d4c 5f54  t0);..    GGML_T
+00054e40: 454e 534f 525f 4249 4e41 5259 5f4f 505f  ENSOR_BINARY_OP_
+00054e50: 4c4f 4341 4c53 3b0a 0a20 2020 2063 6f6e  LOCALS;..    con
+00054e60: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00054e70: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00054e80: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+00054e90: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+00054ea0: 4747 4d4c 5f41 5353 4552 5428 6e65 3032  GGML_ASSERT(ne02
+00054eb0: 203d 3d20 6e65 3132 293b 0a20 2020 2047   == ne12);.    G
+00054ec0: 474d 4c5f 4153 5345 5254 286e 6530 3320  GML_ASSERT(ne03 
+00054ed0: 3d3d 206e 6531 3329 3b0a 2020 2020 4747  == ne13);.    GG
+00054ee0: 4d4c 5f41 5353 4552 5428 6e65 3220 203d  ML_ASSERT(ne2  =
+00054ef0: 3d20 6e65 3132 293b 0a20 2020 2047 474d  = ne12);.    GGM
+00054f00: 4c5f 4153 5345 5254 286e 6533 2020 3d3d  L_ASSERT(ne3  ==
+00054f10: 206e 6531 3329 3b0a 0a20 2020 202f 2f20   ne13);..    // 
+00054f20: 7765 2064 6f6e 2774 2073 7570 706f 7274  we don't support
+00054f30: 2070 6572 6d75 7465 6420 7372 6330 206f   permuted src0 o
+00054f40: 7220 7372 6331 0a20 2020 2047 474d 4c5f  r src1.    GGML_
+00054f50: 4153 5345 5254 286e 6230 3020 3d3d 2073  ASSERT(nb00 == s
+00054f60: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+00054f70: 2020 2020 2f2f 2064 7374 2063 616e 6e6f      // dst canno
+00054f80: 7420 6265 2074 7261 6e73 706f 7365 6420  t be transposed 
+00054f90: 6f72 2070 6572 6d75 7465 640a 2020 2020  or permuted.    
+00054fa0: 4747 4d4c 5f41 5353 4552 5428 6e62 3020  GGML_ASSERT(nb0 
+00054fb0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+00054fc0: 293b 0a20 2020 202f 2f20 4747 4d4c 5f41  );.    // GGML_A
+00054fd0: 5353 4552 5428 6e62 3020 3c3d 206e 6231  SSERT(nb0 <= nb1
+00054fe0: 293b 0a20 2020 202f 2f20 4747 4d4c 5f41  );.    // GGML_A
+00054ff0: 5353 4552 5428 6e62 3120 3c3d 206e 6232  SSERT(nb1 <= nb2
+00055000: 293b 0a20 2020 202f 2f20 4747 4d4c 5f41  );.    // GGML_A
+00055010: 5353 4552 5428 6e62 3220 3c3d 206e 6233  SSERT(nb2 <= nb3
+00055020: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+00055030: 4552 5428 6e65 3020 3d3d 206e 6530 3029  ERT(ne0 == ne00)
+00055040: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00055050: 5428 6e65 3120 3d3d 206e 6531 3029 3b0a  T(ne1 == ne10);.
+00055060: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00055070: 6e65 3220 3d3d 206e 6530 3229 3b0a 2020  ne2 == ne02);.  
+00055080: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+00055090: 3320 3d3d 206e 6530 3329 3b0a 0a20 2020  3 == ne03);..   
+000550a0: 202f 2f20 6e62 3031 203e 3d20 6e62 3030   // nb01 >= nb00
+000550b0: 202d 2073 7263 3020 6973 206e 6f74 2074   - src0 is not t
+000550c0: 7261 6e73 706f 7365 640a 2020 2020 2f2f  ransposed.    //
+000550d0: 2020 2063 6f6d 7075 7465 2062 7920 7372     compute by sr
+000550e0: 6330 2072 6f77 730a 0a20 2020 202f 2f20  c0 rows..    // 
+000550f0: 544f 444f 3a20 2369 6620 6465 6669 6e65  TODO: #if define
+00055100: 6428 4747 4d4c 5f55 5345 5f43 5542 4c41  d(GGML_USE_CUBLA
+00055110: 5329 2067 676d 6c5f 6375 6461 5f6f 7574  S) ggml_cuda_out
+00055120: 5f70 726f 640a 2020 2020 2f2f 2054 4f44  _prod.    // TOD
+00055130: 4f3a 2023 6966 2064 6566 696e 6564 2847  O: #if defined(G
+00055140: 474d 4c5f 5553 455f 4143 4345 4c45 5241  GML_USE_ACCELERA
+00055150: 5445 2920 7c7c 2064 6566 696e 6564 2847  TE) || defined(G
+00055160: 474d 4c5f 5553 455f 4f50 454e 424c 4153  GML_USE_OPENBLAS
+00055170: 2920 7c7c 2064 6566 696e 6564 2847 474d  ) || defined(GGM
+00055180: 4c5f 5553 455f 434c 424c 4153 5429 0a0a  L_USE_CLBLAST)..
+00055190: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+000551a0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000551b0: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
+000551c0: 2020 6767 6d6c 5f76 6563 5f73 6574 5f66    ggml_vec_set_f
+000551d0: 3332 286e 6530 2a6e 6531 2a6e 6532 2a6e  32(ne0*ne1*ne2*n
+000551e0: 6533 2c20 6473 742d 3e64 6174 612c 2030  e3, dst->data, 0
+000551f0: 293b 0a20 2020 2020 2020 2072 6574 7572  );.        retur
+00055200: 6e3b 0a20 2020 207d 0a0a 2020 2020 6966  n;.    }..    if
+00055210: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00055220: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00055230: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+00055240: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00055250: 2020 202f 2f20 7061 7261 6c6c 656c 697a     // paralleliz
+00055260: 6520 6279 206c 6173 7420 7468 7265 6520  e by last three 
+00055270: 6469 6d65 6e73 696f 6e73 0a0a 2020 2020  dimensions..    
+00055280: 2f2f 2074 6f74 616c 2072 6f77 7320 696e  // total rows in
+00055290: 2064 7374 0a20 2020 2063 6f6e 7374 2069   dst.    const i
+000552a0: 6e74 3634 5f74 206e 7220 3d20 6e65 312a  nt64_t nr = ne1*
+000552b0: 6e65 322a 6e65 333b 0a0a 2020 2020 2f2f  ne2*ne3;..    //
+000552c0: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
+000552d0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+000552e0: 5f74 2064 7220 3d20 286e 7220 2b20 6e74  _t dr = (nr + nt
+000552f0: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
+00055300: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
+00055310: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
+00055320: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00055330: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
+00055340: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00055350: 6972 3120 3d20 4d49 4e28 6972 3020 2b20  ir1 = MIN(ir0 + 
+00055360: 6472 2c20 6e72 293b 0a0a 2020 2020 2f2f  dr, nr);..    //
+00055370: 2064 7374 5b3a 2c3a 2c3a 2c3a 5d20 3d20   dst[:,:,:,:] = 
+00055380: 300a 2020 2020 2f2f 2066 6f72 2069 322c  0.    // for i2,
+00055390: 6933 3a0a 2020 2020 2f2f 2020 2066 6f72  i3:.    //   for
+000553a0: 2069 313a 0a20 2020 202f 2f20 2020 2020   i1:.    //     
+000553b0: 666f 7220 6930 313a 0a20 2020 202f 2f20  for i01:.    // 
+000553c0: 2020 2020 2020 666f 7220 6930 3a0a 2020        for i0:.  
+000553d0: 2020 2f2f 2020 2020 2020 2020 2064 7374    //         dst
+000553e0: 5b69 302c 6931 2c69 322c 6933 5d20 2b3d  [i0,i1,i2,i3] +=
+000553f0: 2073 7263 305b 6930 2c69 3031 2c69 322c   src0[i0,i01,i2,
+00055400: 6933 5d20 2a20 7372 6331 5b69 312c 6930  i3] * src1[i1,i0
+00055410: 312c 6932 2c69 335d 0a0a 2020 2020 666f  1,i2,i3]..    fo
+00055420: 7220 2869 6e74 3634 5f74 2069 7220 3d20  r (int64_t ir = 
+00055430: 6972 303b 2069 7220 3c20 6972 313b 202b  ir0; ir < ir1; +
+00055440: 2b69 7229 207b 0a20 2020 2020 2020 202f  +ir) {.        /
+00055450: 2f20 6473 7420 696e 6469 6365 730a 2020  / dst indices.  
+00055460: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00055470: 345f 7420 6933 203d 2069 722f 286e 6532  4_t i3 = ir/(ne2
+00055480: 2a6e 6531 293b 0a20 2020 2020 2020 2063  *ne1);.        c
+00055490: 6f6e 7374 2069 6e74 3634 5f74 2069 3220  onst int64_t i2 
+000554a0: 3d20 2869 7220 2d20 6933 2a6e 6532 2a6e  = (ir - i3*ne2*n
+000554b0: 6531 292f 6e65 313b 0a20 2020 2020 2020  e1)/ne1;.       
+000554c0: 2063 6f6e 7374 2069 6e74 3634 5f74 2069   const int64_t i
+000554d0: 3120 3d20 2869 7220 2d20 6933 2a6e 6532  1 = (ir - i3*ne2
+000554e0: 2a6e 6531 202d 2069 322a 6e65 3129 3b0a  *ne1 - i2*ne1);.
+000554f0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+00055500: 6e74 3634 5f74 2069 3032 203d 2069 323b  nt64_t i02 = i2;
+00055510: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+00055520: 6e74 3634 5f74 2069 3033 203d 2069 333b  nt64_t i03 = i3;
+00055530: 0a0a 2020 2020 2020 2020 2f2f 636f 6e73  ..        //cons
+00055540: 7420 696e 7436 345f 7420 6931 3020 3d20  t int64_t i10 = 
+00055550: 6931 3b0a 2020 2020 2020 2020 636f 6e73  i1;.        cons
+00055560: 7420 696e 7436 345f 7420 6931 3220 3d20  t int64_t i12 = 
+00055570: 6932 3b0a 2020 2020 2020 2020 636f 6e73  i2;.        cons
+00055580: 7420 696e 7436 345f 7420 6931 3320 3d20  t int64_t i13 = 
+00055590: 6933 3b0a 0a20 2020 2020 2020 2066 6f72  i3;..        for
+000555a0: 2028 696e 7436 345f 7420 6930 3120 3d20   (int64_t i01 = 
+000555b0: 303b 2069 3031 203c 206e 6530 313b 202b  0; i01 < ne01; +
+000555c0: 2b69 3031 2920 7b0a 2020 2020 2020 2020  +i01) {.        
+000555d0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+000555e0: 7420 6931 3120 3d20 6930 313b 0a0a 2020  t i11 = i01;..  
+000555f0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00055600: 2a20 7330 203d 2028 666c 6f61 7420 2a29  * s0 = (float *)
+00055610: 2028 2863 6861 7220 2a29 2073 7263 302d   ((char *) src0-
+00055620: 3e64 6174 6120 2b20 2820 2020 2020 2020  >data + (       
+00055630: 2020 2069 3031 2a6e 6230 3120 2b20 6930     i01*nb01 + i0
+00055640: 322a 6e62 3032 202b 2069 3033 2a6e 6230  2*nb02 + i03*nb0
+00055650: 3329 293b 0a20 2020 2020 2020 2020 2020  3));.           
+00055660: 2066 6c6f 6174 202a 2073 3120 3d20 2866   float * s1 = (f
+00055670: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00055680: 2920 7372 6331 2d3e 6461 7461 202b 2028  ) src1->data + (
+00055690: 6931 2a6e 6231 3020 2b20 6931 312a 6e62  i1*nb10 + i11*nb
+000556a0: 3131 202b 2069 3132 2a6e 6231 3220 2b20  11 + i12*nb12 + 
+000556b0: 6931 332a 6e62 3133 2929 3b0a 2020 2020  i13*nb13));.    
+000556c0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+000556d0: 6420 203d 2028 666c 6f61 7420 2a29 2028  d  = (float *) (
+000556e0: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+000556f0: 6174 6120 2b20 2820 2020 2020 2020 2020  ata + (         
+00055700: 2069 312a 6e62 3120 2b20 6932 2a6e 6232   i1*nb1 + i2*nb2
+00055710: 202b 2069 332a 6e62 3329 293b 0a0a 2020   + i3*nb3));..  
+00055720: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+00055730: 6563 5f6d 6164 5f66 3332 286e 6530 2c20  ec_mad_f32(ne0, 
+00055740: 642c 2073 302c 202a 7331 293b 0a20 2020  d, s0, *s1);.   
+00055750: 2020 2020 2020 2020 202f 2f20 666f 7220           // for 
+00055760: 2869 6e74 3634 5f74 2069 3020 3d20 303b  (int64_t i0 = 0;
+00055770: 2069 3020 3c20 6e65 303b 202b 2b69 3029   i0 < ne0; ++i0)
+00055780: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
+00055790: 2f20 2020 2020 645b 6930 5d20 2b3d 2073  /     d[i0] += s
+000557a0: 305b 6930 5d20 2a20 7331 5b69 315d 3b0a  0[i0] * s1[i1];.
+000557b0: 2020 2020 2020 2020 2020 2020 2f2f 207d              // }
+000557c0: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+000557d0: 0a0a 2020 2020 2f2f 696e 7436 345f 7420  ..    //int64_t 
+000557e0: 7431 203d 2067 676d 6c5f 7065 7266 5f74  t1 = ggml_perf_t
+000557f0: 696d 655f 7573 2829 3b0a 2020 2020 2f2f  ime_us();.    //
+00055800: 7374 6174 6963 2069 6e74 3634 5f74 2061  static int64_t a
+00055810: 6363 203d 2030 3b0a 2020 2020 2f2f 6163  cc = 0;.    //ac
+00055820: 6320 2b3d 2074 3120 2d20 7430 3b0a 2020  c += t1 - t0;.  
+00055830: 2020 2f2f 6966 2028 7431 202d 2074 3020    //if (t1 - t0 
+00055840: 3e20 3130 2920 7b0a 2020 2020 2f2f 2020  > 10) {.    //  
+00055850: 2020 7072 696e 7466 2822 5c6e 2229 3b0a    printf("\n");.
+00055860: 2020 2020 2f2f 2020 2020 7072 696e 7466      //    printf
+00055870: 2822 6e65 3030 203d 2025 3564 2c20 6e65  ("ne00 = %5d, ne
+00055880: 3031 203d 2025 3564 2c20 6e65 3032 203d  01 = %5d, ne02 =
+00055890: 2025 3564 2c20 6e65 3033 203d 2025 3564   %5d, ne03 = %5d
+000558a0: 5c6e 222c 206e 6530 302c 206e 6530 312c  \n", ne00, ne01,
+000558b0: 206e 6530 322c 206e 6530 3329 3b0a 2020   ne02, ne03);.  
+000558c0: 2020 2f2f 2020 2020 7072 696e 7466 2822    //    printf("
+000558d0: 6e62 3030 203d 2025 3564 2c20 6e62 3031  nb00 = %5d, nb01
+000558e0: 203d 2025 3564 2c20 6e62 3032 203d 2025   = %5d, nb02 = %
+000558f0: 3564 2c20 6e62 3033 203d 2025 3564 5c6e  5d, nb03 = %5d\n
+00055900: 222c 206e 6230 302c 206e 6230 312c 206e  ", nb00, nb01, n
+00055910: 6230 322c 206e 6230 3329 3b0a 2020 2020  b02, nb03);.    
+00055920: 2f2f 2020 2020 7072 696e 7466 2822 6e65  //    printf("ne
+00055930: 3130 203d 2025 3564 2c20 6e65 3131 203d  10 = %5d, ne11 =
+00055940: 2025 3564 2c20 6e65 3132 203d 2025 3564   %5d, ne12 = %5d
+00055950: 2c20 6e65 3133 203d 2025 3564 5c6e 222c  , ne13 = %5d\n",
+00055960: 206e 6531 302c 206e 6531 312c 206e 6531   ne10, ne11, ne1
+00055970: 322c 206e 6531 3329 3b0a 2020 2020 2f2f  2, ne13);.    //
+00055980: 2020 2020 7072 696e 7466 2822 6e62 3130      printf("nb10
+00055990: 203d 2025 3564 2c20 6e62 3131 203d 2025   = %5d, nb11 = %
+000559a0: 3564 2c20 6e62 3132 203d 2025 3564 2c20  5d, nb12 = %5d, 
+000559b0: 6e62 3133 203d 2025 3564 5c6e 222c 206e  nb13 = %5d\n", n
+000559c0: 6231 302c 206e 6231 312c 206e 6231 322c  b10, nb11, nb12,
+000559d0: 206e 6231 3329 3b0a 0a20 2020 202f 2f20   nb13);..    // 
+000559e0: 2020 2070 7269 6e74 6628 2258 5858 5858     printf("XXXXX
+000559f0: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00055a00: 5858 5858 5858 5858 5858 5858 5858 5858  XXXXXXXXXXXXXXXX
+00055a10: 5858 5858 5858 5858 5858 5858 5858 5820  XXXXXXXXXXXXXXX 
+00055a20: 7461 736b 2025 642f 2564 3a20 2564 2075  task %d/%d: %d u
+00055a30: 732c 2061 6363 203d 2025 645c 6e22 2c20  s, acc = %d\n", 
+00055a40: 6974 682c 206e 7468 2c20 2869 6e74 2920  ith, nth, (int) 
+00055a50: 2874 3120 2d20 7430 292c 2028 696e 7429  (t1 - t0), (int)
+00055a60: 2061 6363 293b 0a20 2020 202f 2f7d 0a7d   acc);.    //}.}
+00055a70: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00055a80: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00055a90: 7264 5f6f 7574 5f70 726f 6428 0a20 2020  rd_out_prod(.   
+00055aa0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00055ab0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00055ac0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00055ad0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00055ae0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00055af0: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00055b00: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00055b10: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
+00055b20: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00055b30: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00055b40: 7374 2920 7b0a 2020 2020 7377 6974 6368  st) {.    switch
+00055b50: 2028 7372 6330 2d3e 7479 7065 2920 7b0a   (src0->type) {.
+00055b60: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00055b70: 4c5f 5459 5045 5f51 345f 303a 0a20 2020  L_TYPE_Q4_0:.   
+00055b80: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00055b90: 5950 455f 5134 5f31 3a0a 2020 2020 2020  YPE_Q4_1:.      
+00055ba0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00055bb0: 5f51 355f 303a 0a20 2020 2020 2020 2063  _Q5_0:.        c
+00055bc0: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
+00055bd0: 5f31 3a0a 2020 2020 2020 2020 6361 7365  _1:.        case
+00055be0: 2047 474d 4c5f 5459 5045 5f51 385f 303a   GGML_TYPE_Q8_0:
+00055bf0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00055c00: 4d4c 5f54 5950 455f 5138 5f31 3a0a 2020  ML_TYPE_Q8_1:.  
+00055c10: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00055c20: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+00055c30: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+00055c40: 2f2f 2074 6f64 6f0a 2020 2020 2020 2020  // todo.        
+00055c50: 2020 2020 2020 2020 2f2f 2067 676d 6c5f          // ggml_
+00055c60: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00055c70: 6f75 745f 7072 6f64 5f71 5f66 3332 2870  out_prod_q_f32(p
+00055c80: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
+00055c90: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
+00055ca0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00055cb0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00055cc0: 5459 5045 5f46 3136 3a0a 2020 2020 2020  TYPE_F16:.      
+00055cd0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00055ce0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00055cf0: 4552 5428 6661 6c73 6529 3b20 2f2f 2074  ERT(false); // t
+00055d00: 6f64 6f0a 2020 2020 2020 2020 2020 2020  odo.            
+00055d10: 2020 2020 2f2f 2067 676d 6c5f 636f 6d70      // ggml_comp
+00055d20: 7574 655f 666f 7277 6172 645f 6f75 745f  ute_forward_out_
+00055d30: 7072 6f64 5f66 3136 5f66 3332 2870 6172  prod_f16_f32(par
+00055d40: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
+00055d50: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+00055d60: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00055d70: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00055d80: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+00055d90: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00055da0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00055db0: 7465 5f66 6f72 7761 7264 5f6f 7574 5f70  te_forward_out_p
+00055dc0: 726f 645f 6633 3228 7061 7261 6d73 2c20  rod_f32(params, 
+00055dd0: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+00055de0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00055df0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
+00055e00: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
+00055e10: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00055e20: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00055e30: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+00055e40: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00055e50: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
+00055e60: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00055e70: 7363 616c 650a 0a73 7461 7469 6320 766f  scale..static vo
+00055e80: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00055e90: 666f 7277 6172 645f 7363 616c 655f 6633  forward_scale_f3
+00055ea0: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+00055eb0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00055ec0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00055ed0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00055ee0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00055ef0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00055f00: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00055f10: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00055f20: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
+00055f30: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00055f40: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+00055f50: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
+00055f60: 5f69 735f 636f 6e74 6967 756f 7573 2873  _is_contiguous(s
+00055f70: 7263 3029 293b 0a20 2020 2047 474d 4c5f  rc0));.    GGML_
+00055f80: 4153 5345 5254 2867 676d 6c5f 6973 5f63  ASSERT(ggml_is_c
+00055f90: 6f6e 7469 6775 6f75 7328 6473 7429 293b  ontiguous(dst));
+00055fa0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00055fb0: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+00055fc0: 6861 7065 2873 7263 302c 2064 7374 2929  hape(src0, dst))
+00055fd0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00055fe0: 5428 6767 6d6c 5f69 735f 7363 616c 6172  T(ggml_is_scalar
+00055ff0: 2873 7263 3129 293b 0a0a 2020 2020 6966  (src1));..    if
+00056000: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00056010: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00056020: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00056030: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00056040: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00056050: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00056060: 0a20 2020 202f 2f20 7363 616c 6520 6661  .    // scale fa
+00056070: 6374 6f72 0a20 2020 2063 6f6e 7374 2066  ctor.    const f
+00056080: 6c6f 6174 2076 203d 202a 2866 6c6f 6174  loat v = *(float
+00056090: 202a 2920 7372 6331 2d3e 6461 7461 3b0a   *) src1->data;.
+000560a0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+000560b0: 7468 203d 2070 6172 616d 732d 3e69 7468  th = params->ith
+000560c0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+000560d0: 6e74 6820 3d20 7061 7261 6d73 2d3e 6e74  nth = params->nt
+000560e0: 683b 0a0a 2020 2020 636f 6e73 7420 696e  h;..    const in
+000560f0: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
+00056100: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00056110: 7420 6e72 203d 2067 676d 6c5f 6e72 6f77  t nr = ggml_nrow
+00056120: 7328 7372 6330 293b 0a0a 2020 2020 2f2f  s(src0);..    //
+00056130: 2072 6f77 7320 7065 7220 7468 7265 6164   rows per thread
+00056140: 0a20 2020 2063 6f6e 7374 2069 6e74 2064  .    const int d
+00056150: 7220 3d20 286e 7220 2b20 6e74 6820 2d20  r = (nr + nth - 
+00056160: 3129 2f6e 7468 3b0a 0a20 2020 202f 2f20  1)/nth;..    // 
+00056170: 726f 7720 7261 6e67 6520 666f 7220 7468  row range for th
+00056180: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
+00056190: 6e73 7420 696e 7420 6972 3020 3d20 6472  nst int ir0 = dr
+000561a0: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
+000561b0: 696e 7420 6972 3120 3d20 4d49 4e28 6972  int ir1 = MIN(ir
+000561c0: 3020 2b20 6472 2c20 6e72 293b 0a0a 2020  0 + dr, nr);..  
+000561d0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+000561e0: 6230 3120 3d20 7372 6330 2d3e 6e62 5b31  b01 = src0->nb[1
+000561f0: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+00056200: 7a65 5f74 206e 6231 203d 2064 7374 2d3e  ze_t nb1 = dst->
+00056210: 6e62 5b31 5d3b 0a0a 0a20 2020 2066 6f72  nb[1];...    for
+00056220: 2028 696e 7420 6931 203d 2069 7230 3b20   (int i1 = ir0; 
+00056230: 6931 203c 2069 7231 3b20 6931 2b2b 2920  i1 < ir1; i1++) 
+00056240: 7b0a 2020 2020 2020 2020 6966 2028 6473  {.        if (ds
+00056250: 742d 3e64 6174 6120 213d 2073 7263 302d  t->data != src0-
+00056260: 3e64 6174 6129 207b 0a20 2020 2020 2020  >data) {.       
+00056270: 2020 2020 202f 2f20 7372 6330 2069 7320       // src0 is 
+00056280: 7361 6d65 2073 6861 7065 2061 7320 6473  same shape as ds
+00056290: 7420 3d3e 2073 616d 6520 696e 6469 6365  t => same indice
+000562a0: 730a 2020 2020 2020 2020 2020 2020 6d65  s.            me
+000562b0: 6d63 7079 2828 6368 6172 202a 2964 7374  mcpy((char *)dst
+000562c0: 2d3e 6461 7461 202b 2069 312a 6e62 312c  ->data + i1*nb1,
+000562d0: 2028 6368 6172 202a 2973 7263 302d 3e64   (char *)src0->d
+000562e0: 6174 6120 2b20 6931 2a6e 6230 312c 206e  ata + i1*nb01, n
+000562f0: 6320 2a20 7369 7a65 6f66 2866 6c6f 6174  c * sizeof(float
+00056300: 2929 3b0a 2020 2020 2020 2020 7d0a 2020  ));.        }.  
+00056310: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+00056320: 6361 6c65 5f66 3332 286e 632c 2028 666c  cale_f32(nc, (fl
+00056330: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+00056340: 2064 7374 2d3e 6461 7461 202b 2069 312a   dst->data + i1*
+00056350: 6e62 3129 2c20 7629 3b0a 2020 2020 7d0a  nb1), v);.    }.
+00056360: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00056370: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00056380: 6172 645f 7363 616c 6528 0a20 2020 2020  ard_scale(.     
+00056390: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000563a0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+000563b0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+000563c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000563d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000563e0: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+000563f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00056400: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00056410: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00056420: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00056430: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+00056440: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+00056450: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00056460: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00056470: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00056480: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00056490: 7075 7465 5f66 6f72 7761 7264 5f73 6361  pute_forward_sca
+000564a0: 6c65 5f66 3332 2870 6172 616d 732c 2073  le_f32(params, s
+000564b0: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
+000564c0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000564d0: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
+000564e0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+000564f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00056500: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00056510: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00056520: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00056530: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
+00056540: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00056550: 6574 0a0a 7374 6174 6963 2076 6f69 6420  et..static void 
+00056560: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00056570: 7761 7264 5f73 6574 5f66 3332 280a 2020  ward_set_f32(.  
+00056580: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00056590: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000565a0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+000565b0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000565c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000565d0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+000565e0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000565f0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00056600: 312c 0a20 2020 2020 2020 2063 6f6e 7374  1,.        const
+00056610: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00056620: 736f 7220 2a20 6f70 7430 2c0a 2020 2020  sor * opt0,.    
+00056630: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00056640: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00056650: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00056660: 6767 6d6c 5f61 7265 5f73 616d 655f 7368  ggml_are_same_sh
+00056670: 6170 6528 7372 6330 2c20 6473 7429 293b  ape(src0, dst));
+00056680: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00056690: 2867 676d 6c5f 6973 5f63 6f6e 7469 6775  (ggml_is_contigu
+000566a0: 6f75 7328 6473 7429 2026 2620 6767 6d6c  ous(dst) && ggml
+000566b0: 5f69 735f 636f 6e74 6967 756f 7573 2873  _is_contiguous(s
+000566c0: 7263 3029 293b 0a0a 2020 2020 4747 4d4c  rc0));..    GGML
+000566d0: 5f41 5353 4552 5428 6f70 7430 2d3e 7479  _ASSERT(opt0->ty
+000566e0: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+000566f0: 4933 3229 3b0a 2020 2020 4747 4d4c 5f41  I32);.    GGML_A
+00056700: 5353 4552 5428 6767 6d6c 5f6e 656c 656d  SSERT(ggml_nelem
+00056710: 656e 7473 286f 7074 3029 203d 3d20 3529  ents(opt0) == 5)
+00056720: 3b0a 0a20 2020 202f 2f20 7669 6577 2073  ;..    // view s
+00056730: 7263 3020 616e 6420 6473 7420 7769 7468  rc0 and dst with
+00056740: 2074 6865 7365 2073 7472 6964 6573 2061   these strides a
+00056750: 6e64 2064 6174 6120 6f66 6673 6574 2069  nd data offset i
+00056760: 6e62 7974 6573 2064 7572 696e 6720 7365  nbytes during se
+00056770: 740a 2020 2020 2f2f 206e 6230 2069 7320  t.    // nb0 is 
+00056780: 696d 706c 6963 6974 656c 7920 656c 656d  implicitely elem
+00056790: 656e 745f 7369 7a65 2062 6563 6175 7365  ent_size because
+000567a0: 2073 7263 3020 616e 6420 6473 7420 6172   src0 and dst ar
+000567b0: 6520 636f 6e74 6967 756f 7573 0a20 2020  e contiguous.   
+000567c0: 2073 697a 655f 7420 6e62 3120 2020 2020   size_t nb1     
+000567d0: 3d20 2828 696e 7433 325f 7420 2a29 206f  = ((int32_t *) o
+000567e0: 7074 302d 3e64 6174 6129 5b30 5d3b 0a20  pt0->data)[0];. 
+000567f0: 2020 2073 697a 655f 7420 6e62 3220 2020     size_t nb2   
+00056800: 2020 3d20 2828 696e 7433 325f 7420 2a29    = ((int32_t *)
+00056810: 206f 7074 302d 3e64 6174 6129 5b31 5d3b   opt0->data)[1];
+00056820: 0a20 2020 2073 697a 655f 7420 6e62 3320  .    size_t nb3 
+00056830: 2020 2020 3d20 2828 696e 7433 325f 7420      = ((int32_t 
+00056840: 2a29 206f 7074 302d 3e64 6174 6129 5b32  *) opt0->data)[2
+00056850: 5d3b 0a20 2020 2073 697a 655f 7420 6f66  ];.    size_t of
+00056860: 6673 6574 2020 3d20 2828 696e 7433 325f  fset  = ((int32_
+00056870: 7420 2a29 206f 7074 302d 3e64 6174 6129  t *) opt0->data)
+00056880: 5b33 5d3b 0a20 2020 2062 6f6f 6c20 2020  [3];.    bool   
+00056890: 696e 706c 6163 6520 3d20 2862 6f6f 6c29  inplace = (bool)
+000568a0: 2028 2869 6e74 3332 5f74 202a 2920 6f70   ((int32_t *) op
+000568b0: 7430 2d3e 6461 7461 295b 345d 3b0a 0a20  t0->data)[4];.. 
+000568c0: 2020 2069 6620 2821 696e 706c 6163 6520     if (!inplace 
+000568d0: 2626 2028 7061 7261 6d73 2d3e 7479 7065  && (params->type
+000568e0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 494e   == GGML_TASK_IN
+000568f0: 4954 2929 207b 0a20 2020 2020 2020 202f  IT)) {.        /
+00056900: 2f20 6d65 6d63 7079 206e 6565 6473 2074  / memcpy needs t
+00056910: 6f20 6265 2073 796e 6368 726f 6e69 7a65  o be synchronize
+00056920: 6420 6163 726f 7373 2074 6872 6561 6473  d across threads
+00056930: 2074 6f20 6176 6f69 6420 7261 6365 2063   to avoid race c
+00056940: 6f6e 6469 7469 6f6e 732e 0a20 2020 2020  onditions..     
+00056950: 2020 202f 2f20 3d3e 2064 6f20 6974 2069     // => do it i
+00056960: 6e20 494e 4954 2070 6861 7365 0a20 2020  n INIT phase.   
+00056970: 2020 2020 206d 656d 6370 7928 0a20 2020       memcpy(.   
+00056980: 2020 2020 2020 2020 2028 2863 6861 7220           ((char 
+00056990: 2a29 2020 6473 742d 3e64 6174 6129 2c0a  *)  dst->data),.
+000569a0: 2020 2020 2020 2020 2020 2020 2828 6368              ((ch
+000569b0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+000569c0: 292c 0a20 2020 2020 2020 2020 2020 2067  ),.            g
+000569d0: 676d 6c5f 6e62 7974 6573 2864 7374 2929  gml_nbytes(dst))
+000569e0: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
+000569f0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00056a00: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+00056a10: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00056a20: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00056a30: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00056a40: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00056a50: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+00056a60: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+00056a70: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00056a80: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+00056a90: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00056aa0: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
+00056ab0: 2873 7263 3129 3b0a 2020 2020 636f 6e73  (src1);.    cons
+00056ac0: 7420 696e 7420 6e63 203d 2073 7263 312d  t int nc = src1-
+00056ad0: 3e6e 655b 305d 3b0a 0a20 2020 2047 474d  >ne[0];..    GGM
+00056ae0: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
+00056af0: 696e 7436 345f 742c 206e 6531 2c20 7372  int64_t, ne1, sr
+00056b00: 6331 2c20 6e65 293b 0a20 2020 2047 474d  c1, ne);.    GGM
+00056b10: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
+00056b20: 7369 7a65 5f74 2c20 206e 6231 2c20 7372  size_t,  nb1, sr
+00056b30: 6331 2c20 6e62 293b 0a0a 2020 2020 2f2f  c1, nb);..    //
+00056b40: 2073 7263 3020 616e 6420 6473 7420 6173   src0 and dst as
+00056b50: 2076 6965 7765 6420 6475 7269 6e67 2073   viewed during s
+00056b60: 6574 0a20 2020 2063 6f6e 7374 2073 697a  et.    const siz
+00056b70: 655f 7420 6e62 3020 3d20 6767 6d6c 5f65  e_t nb0 = ggml_e
+00056b80: 6c65 6d65 6e74 5f73 697a 6528 7372 6330  lement_size(src0
+00056b90: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
+00056ba0: 7420 696d 3020 3d20 286e 6531 3020 3d3d  t im0 = (ne10 ==
+00056bb0: 2030 203f 2030 203a 206e 6531 302d 3129   0 ? 0 : ne10-1)
+00056bc0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+00056bd0: 696d 3120 3d20 286e 6531 3120 3d3d 2030  im1 = (ne11 == 0
+00056be0: 203f 2030 203a 206e 6531 312d 3129 3b0a   ? 0 : ne11-1);.
+00056bf0: 2020 2020 636f 6e73 7420 696e 7420 696d      const int im
+00056c00: 3220 3d20 286e 6531 3220 3d3d 2030 203f  2 = (ne12 == 0 ?
+00056c10: 2030 203a 206e 6531 322d 3129 3b0a 2020   0 : ne12-1);.  
+00056c20: 2020 636f 6e73 7420 696e 7420 696d 3320    const int im3 
+00056c30: 3d20 286e 6531 3320 3d3d 2030 203f 2030  = (ne13 == 0 ? 0
+00056c40: 203a 206e 6531 332d 3129 3b0a 0a20 2020   : ne13-1);..   
+00056c50: 2047 474d 4c5f 4153 5345 5254 286f 6666   GGML_ASSERT(off
+00056c60: 7365 7420 2b20 696d 302a 6e62 3020 202b  set + im0*nb0  +
+00056c70: 2069 6d31 2a6e 6231 2020 2b20 696d 322a   im1*nb1  + im2*
+00056c80: 6e62 3220 202b 2069 6d33 2a6e 6233 2020  nb2  + im3*nb3  
+00056c90: 3c3d 2067 676d 6c5f 6e62 7974 6573 2864  <= ggml_nbytes(d
+00056ca0: 7374 2929 3b0a 0a20 2020 2047 474d 4c5f  st));..    GGML_
+00056cb0: 4153 5345 5254 286e 6231 3020 3d3d 2073  ASSERT(nb10 == s
+00056cc0: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+00056cd0: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
+00056ce0: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+00056cf0: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
+00056d00: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
+00056d10: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+00056d20: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+00056d30: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+00056d40: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
+00056d50: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
+00056d60: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
+00056d70: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
+00056d80: 2069 7220 3d20 6972 303b 2069 7220 3c20   ir = ir0; ir < 
+00056d90: 6972 313b 202b 2b69 7229 207b 0a20 2020  ir1; ++ir) {.   
+00056da0: 2020 2020 202f 2f20 7372 6330 2061 6e64       // src0 and
+00056db0: 2064 7374 2061 7265 2076 6965 7765 6420   dst are viewed 
+00056dc0: 7769 7468 2073 6861 7065 206f 6620 7372  with shape of sr
+00056dd0: 6331 2061 6e64 206f 6666 7365 740a 2020  c1 and offset.  
+00056de0: 2020 2020 2020 2f2f 203d 3e20 7361 6d65        // => same
+00056df0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+00056e00: 2063 6f6e 7374 2069 6e74 2069 3320 3d20   const int i3 = 
+00056e10: 6972 2f28 6e65 3132 2a6e 6531 3129 3b0a  ir/(ne12*ne11);.
+00056e20: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00056e30: 7420 6932 203d 2028 6972 202d 2069 332a  t i2 = (ir - i3*
+00056e40: 6e65 3132 2a6e 6531 3129 2f6e 6531 313b  ne12*ne11)/ne11;
+00056e50: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+00056e60: 6e74 2069 3120 3d20 2869 7220 2d20 6933  nt i1 = (ir - i3
+00056e70: 2a6e 6531 322a 6e65 3131 202d 2069 322a  *ne12*ne11 - i2*
+00056e80: 6e65 3131 293b 0a0a 2020 2020 2020 2020  ne11);..        
+00056e90: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
+00056ea0: 286e 632c 0a20 2020 2020 2020 2020 2020  (nc,.           
+00056eb0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00056ec0: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+00056ed0: 6174 6120 2b20 6933 2a6e 6233 2020 2b20  ata + i3*nb3  + 
+00056ee0: 6932 2a6e 6232 2020 2b20 6931 2a6e 6231  i2*nb2  + i1*nb1
+00056ef0: 2020 2b20 6f66 6673 6574 292c 0a20 2020    + offset),.   
+00056f00: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+00056f10: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+00056f20: 2073 7263 312d 3e64 6174 6120 2b20 6933   src1->data + i3
+00056f30: 2a6e 6231 3320 2b20 6932 2a6e 6231 3220  *nb13 + i2*nb12 
+00056f40: 2b20 6931 2a6e 6231 3129 293b 0a20 2020  + i1*nb11));.   
+00056f50: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
+00056f60: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00056f70: 6f72 7761 7264 5f73 6574 280a 2020 2020  orward_set(.    
+00056f80: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00056f90: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00056fa0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00056fb0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00056fc0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00056fd0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+00056fe0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00056ff0: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+00057000: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00057010: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00057020: 7220 2a20 6f70 7430 2c0a 2020 2020 2020  r * opt0,.      
+00057030: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00057040: 6e73 6f72 202a 2064 7374 2920 7b0a 0a20  nsor * dst) {.. 
+00057050: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+00057060: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+00057070: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00057080: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
+00057090: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000570a0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+000570b0: 666f 7277 6172 645f 7365 745f 6633 3228  forward_set_f32(
+000570c0: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
+000570d0: 6331 2c20 6f70 7430 2c20 6473 7429 3b0a  c1, opt0, dst);.
+000570e0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000570f0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00057100: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
+00057110: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00057120: 4d4c 5f54 5950 455f 5134 5f30 3a0a 2020  ML_TYPE_Q4_0:.  
+00057130: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00057140: 5459 5045 5f51 345f 313a 0a20 2020 2020  TYPE_Q4_1:.     
+00057150: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+00057160: 455f 5135 5f30 3a0a 2020 2020 2020 2020  E_Q5_0:.        
+00057170: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+00057180: 355f 313a 0a20 2020 2020 2020 2063 6173  5_1:.        cas
+00057190: 6520 4747 4d4c 5f54 5950 455f 5138 5f30  e GGML_TYPE_Q8_0
+000571a0: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+000571b0: 474d 4c5f 5459 5045 5f51 385f 313a 0a20  GML_TYPE_Q8_1:. 
+000571c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000571d0: 5f54 5950 455f 5132 5f4b 3a0a 2020 2020  _TYPE_Q2_K:.    
+000571e0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+000571f0: 5045 5f51 335f 4b3a 0a20 2020 2020 2020  PE_Q3_K:.       
+00057200: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00057210: 5134 5f4b 3a0a 2020 2020 2020 2020 6361  Q4_K:.        ca
+00057220: 7365 2047 474d 4c5f 5459 5045 5f51 355f  se GGML_TYPE_Q5_
+00057230: 4b3a 0a20 2020 2020 2020 2063 6173 6520  K:.        case 
+00057240: 4747 4d4c 5f54 5950 455f 5136 5f4b 3a0a  GGML_TYPE_Q6_K:.
+00057250: 2020 2020 2020 2020 6465 6661 756c 743a          default:
+00057260: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00057270: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00057280: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00057290: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000572a0: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+000572b0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+000572c0: 5f66 6f72 7761 7264 5f63 7079 0a0a 7374  _forward_cpy..st
+000572d0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+000572e0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+000572f0: 7079 280a 2020 2020 2020 2020 636f 6e73  py(.        cons
+00057300: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00057310: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+00057320: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+00057330: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00057340: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+00057350: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00057360: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00057370: 2920 7b0a 2020 2020 6767 6d6c 5f63 6f6d  ) {.    ggml_com
+00057380: 7075 7465 5f66 6f72 7761 7264 5f64 7570  pute_forward_dup
+00057390: 2870 6172 616d 732c 2073 7263 302c 2064  (params, src0, d
+000573a0: 7374 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  st);.}..// ggml_
+000573b0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000573c0: 636f 6e74 0a0a 7374 6174 6963 2076 6f69  cont..static voi
+000573d0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+000573e0: 6f72 7761 7264 5f63 6f6e 7428 0a20 2020  orward_cont(.   
+000573f0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00057400: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00057410: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00057420: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00057430: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00057440: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00057450: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00057460: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+00057470: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00057480: 7277 6172 645f 6475 7028 7061 7261 6d73  rward_dup(params
+00057490: 2c20 7372 6330 2c20 6473 7429 3b0a 7d0a  , src0, dst);.}.
+000574a0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+000574b0: 5f66 6f72 7761 7264 5f72 6573 6861 7065  _forward_reshape
+000574c0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+000574d0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000574e0: 7264 5f72 6573 6861 7065 280a 2020 2020  rd_reshape(.    
+000574f0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00057500: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00057510: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00057520: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00057530: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00057540: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+00057550: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00057560: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+00057570: 2f2f 204e 4f50 0a20 2020 2055 4e55 5345  // NOP.    UNUSE
+00057580: 4428 7061 7261 6d73 293b 0a20 2020 2055  D(params);.    U
+00057590: 4e55 5345 4428 7372 6330 293b 0a20 2020  NUSED(src0);.   
+000575a0: 2055 4e55 5345 4428 6473 7429 3b0a 7d0a   UNUSED(dst);.}.
+000575b0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
+000575c0: 5f66 6f72 7761 7264 5f76 6965 770a 0a73  _forward_view..s
+000575d0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+000575e0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000575f0: 7669 6577 280a 2020 2020 2020 2020 636f  view(.        co
+00057600: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00057610: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00057620: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00057630: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00057640: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00057650: 2920 7b0a 2020 2020 2f2f 204e 4f50 0a20  ) {.    // NOP. 
+00057660: 2020 2055 4e55 5345 4428 7061 7261 6d73     UNUSED(params
+00057670: 293b 0a20 2020 2055 4e55 5345 4428 7372  );.    UNUSED(sr
+00057680: 6330 293b 0a7d 0a0a 2f2f 2067 676d 6c5f  c0);.}..// ggml_
+00057690: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000576a0: 7065 726d 7574 650a 0a73 7461 7469 6320  permute..static 
+000576b0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+000576c0: 655f 666f 7277 6172 645f 7065 726d 7574  e_forward_permut
+000576d0: 6528 0a20 2020 2020 2020 2063 6f6e 7374  e(.        const
+000576e0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+000576f0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00057700: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00057710: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00057720: 7465 6e73 6f72 202a 2073 7263 3029 207b  tensor * src0) {
+00057730: 0a20 2020 202f 2f20 4e4f 500a 2020 2020  .    // NOP.    
+00057740: 554e 5553 4544 2870 6172 616d 7329 3b0a  UNUSED(params);.
+00057750: 2020 2020 554e 5553 4544 2873 7263 3029      UNUSED(src0)
+00057760: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  ;.}..// ggml_com
+00057770: 7075 7465 5f66 6f72 7761 7264 5f74 7261  pute_forward_tra
+00057780: 6e73 706f 7365 0a0a 7374 6174 6963 2076  nspose..static v
+00057790: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+000577a0: 5f66 6f72 7761 7264 5f74 7261 6e73 706f  _forward_transpo
+000577b0: 7365 280a 2020 2020 2020 2020 636f 6e73  se(.        cons
+000577c0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+000577d0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+000577e0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+000577f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00057800: 5f74 656e 736f 7220 2a20 7372 6330 2920  _tensor * src0) 
+00057810: 7b0a 2020 2020 2f2f 204e 4f50 0a20 2020  {.    // NOP.   
+00057820: 2055 4e55 5345 4428 7061 7261 6d73 293b   UNUSED(params);
+00057830: 0a20 2020 2055 4e55 5345 4428 7372 6330  .    UNUSED(src0
+00057840: 293b 0a7d 0a0a 2f2f 2067 676d 6c5f 636f  );.}..// ggml_co
+00057850: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
+00057860: 745f 726f 7773 0a0a 7374 6174 6963 2076  t_rows..static v
+00057870: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00057880: 5f66 6f72 7761 7264 5f67 6574 5f72 6f77  _forward_get_row
+00057890: 735f 7128 0a20 2020 2020 2020 2063 6f6e  s_q(.        con
+000578a0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+000578b0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+000578c0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+000578d0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000578e0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+000578f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00057900: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00057910: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+00057920: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00057930: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00057940: 2920 7b0a 2020 2020 6173 7365 7274 2870  ) {.    assert(p
+00057950: 6172 616d 732d 3e69 7468 203d 3d20 3029  arams->ith == 0)
+00057960: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+00057970: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00057980: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+00057990: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+000579a0: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+000579b0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+000579c0: 6e3b 0a20 2020 207d 0a0a 2020 2020 636f  n;.    }..    co
+000579d0: 6e73 7420 696e 7420 6e63 203d 2073 7263  nst int nc = src
+000579e0: 302d 3e6e 655b 305d 3b0a 2020 2020 636f  0->ne[0];.    co
+000579f0: 6e73 7420 696e 7420 6e72 203d 2067 676d  nst int nr = ggm
+00057a00: 6c5f 6e65 6c65 6d65 6e74 7328 7372 6331  l_nelements(src1
+00057a10: 293b 0a20 2020 2063 6f6e 7374 2065 6e75  );.    const enu
+00057a20: 6d20 6767 6d6c 5f74 7970 6520 7479 7065  m ggml_type type
+00057a30: 203d 2073 7263 302d 3e74 7970 653b 0a20   = src0->type;. 
+00057a40: 2020 2067 676d 6c5f 746f 5f66 6c6f 6174     ggml_to_float
+00057a50: 5f74 2063 6f6e 7374 2064 6571 7561 6e74  _t const dequant
+00057a60: 697a 655f 726f 775f 7120 3d20 7479 7065  ize_row_q = type
+00057a70: 5f74 7261 6974 735b 7479 7065 5d2e 746f  _traits[type].to
+00057a80: 5f66 6c6f 6174 3b0a 0a20 2020 2061 7373  _float;..    ass
+00057a90: 6572 7428 2064 7374 2d3e 6e65 5b30 5d20  ert( dst->ne[0] 
+00057aa0: 3d3d 206e 6329 3b0a 2020 2020 6173 7365  == nc);.    asse
+00057ab0: 7274 2820 6473 742d 3e6e 655b 315d 203d  rt( dst->ne[1] =
+00057ac0: 3d20 6e72 293b 0a20 2020 2061 7373 6572  = nr);.    asser
+00057ad0: 7428 7372 6330 2d3e 6e62 5b30 5d20 3d3d  t(src0->nb[0] ==
+00057ae0: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+00057af0: 7479 7065 5d29 3b0a 0a20 2020 2066 6f72  type]);..    for
+00057b00: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00057b10: 206e 723b 202b 2b69 2920 7b0a 2020 2020   nr; ++i) {.    
+00057b20: 2020 2020 636f 6e73 7420 696e 7420 7220      const int r 
+00057b30: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+00057b40: 7263 312d 3e64 6174 6129 5b69 5d3b 0a0a  rc1->data)[i];..
+00057b50: 2020 2020 2020 2020 6465 7175 616e 7469          dequanti
+00057b60: 7a65 5f72 6f77 5f71 280a 2020 2020 2020  ze_row_q(.      
+00057b70: 2020 2020 2020 2020 2020 2863 6f6e 7374            (const
+00057b80: 2076 6f69 6420 2a29 2028 2863 6861 7220   void *) ((char 
+00057b90: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+00057ba0: 722a 7372 6330 2d3e 6e62 5b31 5d29 2c0a  r*src0->nb[1]),.
+00057bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00057bc0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00057bd0: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+00057be0: 6174 6120 2b20 692a 6473 742d 3e6e 625b  ata + i*dst->nb[
+00057bf0: 315d 292c 206e 6329 3b0a 2020 2020 7d0a  1]), nc);.    }.
+00057c00: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00057c10: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00057c20: 6172 645f 6765 745f 726f 7773 5f66 3136  ard_get_rows_f16
+00057c30: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00057c40: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00057c50: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00057c60: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00057c70: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00057c80: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00057c90: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00057ca0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00057cb0: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
+00057cc0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00057cd0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+00057ce0: 0a20 2020 2061 7373 6572 7428 7061 7261  .    assert(para
+00057cf0: 6d73 2d3e 6974 6820 3d3d 2030 293b 0a0a  ms->ith == 0);..
+00057d00: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+00057d10: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00057d20: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
+00057d30: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00057d40: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+00057d50: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+00057d60: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
+00057d70: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
+00057d80: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+00057d90: 2069 6e74 206e 7220 3d20 6767 6d6c 5f6e   int nr = ggml_n
+00057da0: 656c 656d 656e 7473 2873 7263 3129 3b0a  elements(src1);.
+00057db0: 0a20 2020 2061 7373 6572 7428 2064 7374  .    assert( dst
+00057dc0: 2d3e 6e65 5b30 5d20 3d3d 206e 6329 3b0a  ->ne[0] == nc);.
+00057dd0: 2020 2020 6173 7365 7274 2820 6473 742d      assert( dst-
+00057de0: 3e6e 655b 315d 203d 3d20 6e72 293b 0a20  >ne[1] == nr);. 
+00057df0: 2020 2061 7373 6572 7428 7372 6330 2d3e     assert(src0->
+00057e00: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+00057e10: 6767 6d6c 5f66 7031 365f 7429 293b 0a0a  ggml_fp16_t));..
+00057e20: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+00057e30: 2030 3b20 6920 3c20 6e72 3b20 2b2b 6929   0; i < nr; ++i)
+00057e40: 207b 0a20 2020 2020 2020 2063 6f6e 7374   {.        const
+00057e50: 2069 6e74 2072 203d 2028 2869 6e74 3332   int r = ((int32
+00057e60: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+00057e70: 295b 695d 3b0a 0a20 2020 2020 2020 2066  )[i];..        f
+00057e80: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
+00057e90: 203c 206e 633b 202b 2b6a 2920 7b0a 2020   < nc; ++j) {.  
+00057ea0: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
+00057eb0: 7031 365f 7420 7620 3d20 2828 6767 6d6c  p16_t v = ((ggml
+00057ec0: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
+00057ed0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+00057ee0: 2b20 722a 7372 6330 2d3e 6e62 5b31 5d29  + r*src0->nb[1])
+00057ef0: 295b 6a5d 3b0a 2020 2020 2020 2020 2020  )[j];.          
+00057f00: 2020 2828 666c 6f61 7420 2a29 2028 2863    ((float *) ((c
+00057f10: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
+00057f20: 6120 2b20 692a 6473 742d 3e6e 625b 315d  a + i*dst->nb[1]
+00057f30: 2929 5b6a 5d20 3d20 4747 4d4c 5f46 5031  ))[j] = GGML_FP1
+00057f40: 365f 544f 5f46 5033 3228 7629 3b0a 2020  6_TO_FP32(v);.  
+00057f50: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
+00057f60: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00057f70: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00057f80: 645f 6765 745f 726f 7773 5f66 3332 280a  d_get_rows_f32(.
+00057f90: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00057fa0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00057fb0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00057fc0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00057fd0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00057fe0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+00057ff0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00058000: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00058010: 7263 312c 0a20 2020 2020 2020 2020 2020  rc1,.           
+00058020: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00058030: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00058040: 2020 2061 7373 6572 7428 7061 7261 6d73     assert(params
+00058050: 2d3e 6974 6820 3d3d 2030 293b 0a0a 2020  ->ith == 0);..  
+00058060: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00058070: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00058080: 494e 4954 207c 7c20 7061 7261 6d73 2d3e  INIT || params->
+00058090: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+000580a0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
+000580b0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+000580c0: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
+000580d0: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
+000580e0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+000580f0: 6e74 206e 7220 3d20 6767 6d6c 5f6e 656c  nt nr = ggml_nel
+00058100: 656d 656e 7473 2873 7263 3129 3b0a 0a20  ements(src1);.. 
+00058110: 2020 2061 7373 6572 7428 2064 7374 2d3e     assert( dst->
+00058120: 6e65 5b30 5d20 3d3d 206e 6329 3b0a 2020  ne[0] == nc);.  
+00058130: 2020 6173 7365 7274 2820 6473 742d 3e6e    assert( dst->n
+00058140: 655b 315d 203d 3d20 6e72 293b 0a20 2020  e[1] == nr);.   
+00058150: 2061 7373 6572 7428 7372 6330 2d3e 6e62   assert(src0->nb
+00058160: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
+00058170: 6f61 7429 293b 0a0a 2020 2020 666f 7220  oat));..    for 
+00058180: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00058190: 6e72 3b20 2b2b 6929 207b 0a20 2020 2020  nr; ++i) {.     
+000581a0: 2020 2063 6f6e 7374 2069 6e74 2072 203d     const int r =
+000581b0: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
+000581c0: 6331 2d3e 6461 7461 295b 695d 3b0a 0a20  c1->data)[i];.. 
+000581d0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+000581e0: 6370 795f 6633 3228 6e63 2c0a 2020 2020  cpy_f32(nc,.    
+000581f0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+00058200: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+00058210: 2064 7374 2d3e 6461 7461 202b 2069 2a64   dst->data + i*d
+00058220: 7374 2d3e 6e62 5b31 5d29 2c0a 2020 2020  st->nb[1]),.    
+00058230: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+00058240: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+00058250: 7372 6330 2d3e 6461 7461 202b 2072 2a73  src0->data + r*s
+00058260: 7263 302d 3e6e 625b 315d 2929 3b0a 2020  rc0->nb[1]));.  
+00058270: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
+00058280: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
+00058290: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
+000582a0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+000582b0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+000582c0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+000582d0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+000582e0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000582f0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00058300: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00058310: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00058320: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
+00058330: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00058340: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+00058350: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+00058360: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00058370: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
+00058380: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+00058390: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
+000583a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000583b0: 5f54 5950 455f 5135 5f30 3a0a 2020 2020  _TYPE_Q5_0:.    
+000583c0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+000583d0: 5045 5f51 355f 313a 0a20 2020 2020 2020  PE_Q5_1:.       
+000583e0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+000583f0: 5138 5f30 3a0a 2020 2020 2020 2020 6361  Q8_0:.        ca
+00058400: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
+00058410: 313a 0a20 2020 2020 2020 2063 6173 6520  1:.        case 
+00058420: 4747 4d4c 5f54 5950 455f 5132 5f4b 3a0a  GGML_TYPE_Q2_K:.
+00058430: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00058440: 4c5f 5459 5045 5f51 335f 4b3a 0a20 2020  L_TYPE_Q3_K:.   
+00058450: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00058460: 5950 455f 5134 5f4b 3a0a 2020 2020 2020  YPE_Q4_K:.      
+00058470: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00058480: 5f51 355f 4b3a 0a20 2020 2020 2020 2063  _Q5_K:.        c
+00058490: 6173 6520 4747 4d4c 5f54 5950 455f 5136  ase GGML_TYPE_Q6
+000584a0: 5f4b 3a0a 2020 2020 2020 2020 2020 2020  _K:.            
+000584b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000584c0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+000584d0: 6f72 7761 7264 5f67 6574 5f72 6f77 735f  orward_get_rows_
+000584e0: 7128 7061 7261 6d73 2c20 7372 6330 2c20  q(params, src0, 
+000584f0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+00058500: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00058510: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00058520: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
+00058530: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00058540: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00058550: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00058560: 6765 745f 726f 7773 5f66 3136 2870 6172  get_rows_f16(par
+00058570: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
+00058580: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+00058590: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+000585a0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+000585b0: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+000585c0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000585d0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+000585e0: 7465 5f66 6f72 7761 7264 5f67 6574 5f72  te_forward_get_r
+000585f0: 6f77 735f 6633 3228 7061 7261 6d73 2c20  ows_f32(params, 
+00058600: 7372 6330 2c20 7372 6331 2c20 6473 7429  src0, src1, dst)
+00058610: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00058620: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
+00058630: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
+00058640: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00058650: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00058660: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+00058670: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00058680: 2020 207d 0a0a 2020 2020 2f2f 7374 6174     }..    //stat
+00058690: 6963 2062 6f6f 6c20 6669 7273 7420 3d20  ic bool first = 
+000586a0: 7472 7565 3b0a 2020 2020 2f2f 7072 696e  true;.    //prin
+000586b0: 7466 2822 6e65 3020 3d20 2564 2c20 6e65  tf("ne0 = %d, ne
+000586c0: 3120 3d20 2564 2c20 6e65 3220 3d20 2564  1 = %d, ne2 = %d
+000586d0: 5c6e 222c 2064 7374 2d3e 6e65 5b30 5d2c  \n", dst->ne[0],
+000586e0: 2064 7374 2d3e 6e65 5b31 5d2c 2064 7374   dst->ne[1], dst
+000586f0: 2d3e 6e65 5b32 5d29 3b0a 2020 2020 2f2f  ->ne[2]);.    //
+00058700: 6966 2028 6669 7273 7429 207b 0a20 2020  if (first) {.   
+00058710: 202f 2f20 2020 2066 6972 7374 203d 2066   //    first = f
+00058720: 616c 7365 3b0a 2020 2020 2f2f 7d20 656c  alse;.    //} el
+00058730: 7365 207b 0a20 2020 202f 2f20 2020 2066  se {.    //    f
+00058740: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
+00058750: 203c 2064 7374 2d3e 6e65 5b31 5d3b 202b   < dst->ne[1]; +
+00058760: 2b6b 2920 7b0a 2020 2020 2f2f 2020 2020  +k) {.    //    
+00058770: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+00058780: 2030 3b20 6a20 3c20 6473 742d 3e6e 655b   0; j < dst->ne[
+00058790: 305d 2f31 363b 202b 2b6a 2920 7b0a 2020  0]/16; ++j) {.  
+000587a0: 2020 2f2f 2020 2020 2020 2020 2020 2020    //            
+000587b0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+000587c0: 6920 3c20 3136 3b20 2b2b 6929 207b 0a20  i < 16; ++i) {. 
+000587d0: 2020 202f 2f20 2020 2020 2020 2020 2020     //           
+000587e0: 2020 2020 2070 7269 6e74 6628 2225 382e       printf("%8.
+000587f0: 3466 2022 2c20 2828 666c 6f61 7420 2a29  4f ", ((float *)
+00058800: 2064 7374 2d3e 6461 7461 295b 6b2a 6473   dst->data)[k*ds
+00058810: 742d 3e6e 655b 305d 202b 206a 2a31 3620  t->ne[0] + j*16 
+00058820: 2b20 695d 293b 0a20 2020 202f 2f20 2020  + i]);.    //   
+00058830: 2020 2020 2020 2020 207d 0a20 2020 202f           }.    /
+00058840: 2f20 2020 2020 2020 2020 2020 2070 7269  /            pri
+00058850: 6e74 6628 225c 6e22 293b 0a20 2020 202f  ntf("\n");.    /
+00058860: 2f20 2020 2020 2020 207d 0a20 2020 202f  /        }.    /
+00058870: 2f20 2020 2020 2020 2070 7269 6e74 6628  /        printf(
+00058880: 225c 6e22 293b 0a20 2020 202f 2f20 2020  "\n");.    //   
+00058890: 207d 0a20 2020 202f 2f20 2020 2070 7269   }.    //    pri
+000588a0: 6e74 6628 225c 6e22 293b 0a20 2020 202f  ntf("\n");.    /
+000588b0: 2f20 2020 2065 7869 7428 3029 3b0a 2020  /    exit(0);.  
+000588c0: 2020 2f2f 7d0a 7d0a 0a2f 2f20 6767 6d6c    //}.}..// ggml
+000588d0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000588e0: 5f67 6574 5f72 6f77 735f 6261 636b 0a0a  _get_rows_back..
+000588f0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00058900: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00058910: 5f67 6574 5f72 6f77 735f 6261 636b 5f66  _get_rows_back_f
+00058920: 3332 5f66 3136 280a 2020 2020 2020 2020  32_f16(.        
+00058930: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00058940: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+00058950: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+00058960: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00058970: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+00058980: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+00058990: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+000589a0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
+000589b0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000589c0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000589d0: 6f70 7430 2c0a 2020 2020 2020 2020 2020  opt0,.          
+000589e0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000589f0: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00058a00: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00058a10: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
+00058a20: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00058a30: 5254 2867 676d 6c5f 6172 655f 7361 6d65  RT(ggml_are_same
+00058a40: 5f73 6861 7065 286f 7074 302c 2064 7374  _shape(opt0, dst
+00058a50: 2929 3b0a 2020 2020 4747 4d4c 5f41 5353  ));.    GGML_ASS
+00058a60: 4552 5428 6767 6d6c 5f69 735f 636f 6e74  ERT(ggml_is_cont
+00058a70: 6967 756f 7573 286f 7074 3029 293b 0a20  iguous(opt0));. 
+00058a80: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
+00058a90: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+00058aa0: 7328 6473 7429 293b 0a0a 2020 2020 6767  s(dst));..    gg
+00058ab0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00058ac0: 7264 5f64 7570 5f73 616d 655f 636f 6e74  rd_dup_same_cont
+00058ad0: 2870 6172 616d 732c 206f 7074 302c 2064  (params, opt0, d
+00058ae0: 7374 293b 0a0a 2020 2020 6966 2028 7061  st);..    if (pa
+00058af0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00058b00: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+00058b10: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00058b20: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+00058b30: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+00058b40: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+00058b50: 2063 6f6e 7374 2069 6e74 206e 6320 3d20   const int nc = 
+00058b60: 7372 6330 2d3e 6e65 5b30 5d3b 0a20 2020  src0->ne[0];.   
+00058b70: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
+00058b80: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
+00058b90: 7263 3129 3b0a 0a20 2020 2047 474d 4c5f  rc1);..    GGML_
+00058ba0: 4153 5345 5254 2820 6473 742d 3e6e 655b  ASSERT( dst->ne[
+00058bb0: 305d 203d 3d20 6e63 293b 0a20 2020 2047  0] == nc);.    G
+00058bc0: 474d 4c5f 4153 5345 5254 2873 7263 302d  GML_ASSERT(src0-
+00058bd0: 3e6e 625b 305d 203d 3d20 7369 7a65 6f66  >nb[0] == sizeof
+00058be0: 2867 676d 6c5f 6670 3136 5f74 2929 3b0a  (ggml_fp16_t));.
+00058bf0: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
+00058c00: 3d20 303b 2069 203c 206e 723b 202b 2b69  = 0; i < nr; ++i
+00058c10: 2920 7b0a 2020 2020 2020 2020 636f 6e73  ) {.        cons
+00058c20: 7420 696e 7420 7220 3d20 2828 696e 7433  t int r = ((int3
+00058c30: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+00058c40: 6129 5b69 5d3b 0a0a 2020 2020 2020 2020  a)[i];..        
+00058c50: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
+00058c60: 6a20 3c20 6e63 3b20 2b2b 6a29 207b 0a20  j < nc; ++j) {. 
+00058c70: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00058c80: 6670 3136 5f74 2076 203d 2028 2867 676d  fp16_t v = ((ggm
+00058c90: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
+00058ca0: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+00058cb0: 202b 2069 2a73 7263 302d 3e6e 625b 315d   + i*src0->nb[1]
+00058cc0: 2929 5b6a 5d3b 0a20 2020 2020 2020 2020  ))[j];.         
+00058cd0: 2020 2028 2866 6c6f 6174 202a 2920 2828     ((float *) ((
+00058ce0: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+00058cf0: 6120 2b20 722a 6473 742d 3e6e 625b 315d  a + r*dst->nb[1]
+00058d00: 2929 5b6a 5d20 2b3d 2047 474d 4c5f 4650  ))[j] += GGML_FP
+00058d10: 3136 5f54 4f5f 4650 3332 2876 293b 0a20  16_TO_FP32(v);. 
+00058d20: 2020 2020 2020 207d 0a20 2020 207d 0a7d         }.    }.}
+00058d30: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+00058d40: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00058d50: 7264 5f67 6574 5f72 6f77 735f 6261 636b  rd_get_rows_back
+00058d60: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+00058d70: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00058d80: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00058d90: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00058da0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00058db0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00058dc0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00058dd0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00058de0: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+00058df0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00058e00: 6767 6d6c 5f74 656e 736f 7220 2a20 6f70  ggml_tensor * op
+00058e10: 7430 2c0a 2020 2020 2020 2020 2020 2020  t0,.            
+00058e20: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00058e30: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00058e40: 2020 4747 4d4c 5f41 5353 4552 5428 7061    GGML_ASSERT(pa
+00058e50: 7261 6d73 2d3e 6974 6820 3d3d 2030 293b  rams->ith == 0);
+00058e60: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00058e70: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+00058e80: 6861 7065 286f 7074 302c 2064 7374 2929  hape(opt0, dst))
+00058e90: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00058ea0: 5428 6767 6d6c 5f69 735f 636f 6e74 6967  T(ggml_is_contig
+00058eb0: 756f 7573 286f 7074 3029 293b 0a20 2020  uous(opt0));.   
+00058ec0: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+00058ed0: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
+00058ee0: 6473 7429 293b 0a0a 2020 2020 2f2f 2067  dst));..    // g
+00058ef0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00058f00: 6172 645f 6475 705f 7361 6d65 5f63 6f6e  ard_dup_same_con
+00058f10: 7428 7061 7261 6d73 2c20 6f70 7430 2c20  t(params, opt0, 
+00058f20: 6473 7429 3b0a 0a20 2020 2069 6620 2870  dst);..    if (p
+00058f30: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+00058f40: 474d 4c5f 5441 534b 5f49 4e49 5429 207b  GML_TASK_INIT) {
+00058f50: 0a20 2020 2020 2020 206d 656d 7365 7428  .        memset(
+00058f60: 6473 742d 3e64 6174 612c 2030 2c20 6767  dst->data, 0, gg
+00058f70: 6d6c 5f6e 6279 7465 7328 6473 7429 293b  ml_nbytes(dst));
+00058f80: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
+00058f90: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00058fa0: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+00058fb0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+00058fc0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00058fd0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+00058fe0: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00058ff0: 2020 2063 6f6e 7374 2069 6e74 206e 6320     const int nc 
+00059000: 3d20 7372 6330 2d3e 6e65 5b30 5d3b 0a20  = src0->ne[0];. 
+00059010: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
+00059020: 3d20 6767 6d6c 5f6e 656c 656d 656e 7473  = ggml_nelements
+00059030: 2873 7263 3129 3b0a 0a20 2020 2047 474d  (src1);..    GGM
+00059040: 4c5f 4153 5345 5254 2820 6473 742d 3e6e  L_ASSERT( dst->n
+00059050: 655b 305d 203d 3d20 6e63 293b 0a20 2020  e[0] == nc);.   
+00059060: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
+00059070: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
+00059080: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
+00059090: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+000590a0: 2069 203c 206e 723b 202b 2b69 2920 7b0a   i < nr; ++i) {.
+000590b0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+000590c0: 7420 7220 3d20 2828 696e 7433 325f 7420  t r = ((int32_t 
+000590d0: 2a29 2073 7263 312d 3e64 6174 6129 5b69  *) src1->data)[i
+000590e0: 5d3b 0a0a 2020 2020 2020 2020 6767 6d6c  ];..        ggml
+000590f0: 5f76 6563 5f61 6464 5f66 3332 286e 632c  _vec_add_f32(nc,
+00059100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059110: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00059120: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
+00059130: 2b20 722a 6473 742d 3e6e 625b 315d 292c  + r*dst->nb[1]),
+00059140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059150: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+00059160: 7220 2a29 2020 6473 742d 3e64 6174 6120  r *)  dst->data 
+00059170: 2b20 722a 6473 742d 3e6e 625b 315d 292c  + r*dst->nb[1]),
+00059180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00059190: 2028 666c 6f61 7420 2a29 2028 2863 6861   (float *) ((cha
+000591a0: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+000591b0: 2b20 692a 7372 6330 2d3e 6e62 5b31 5d29  + i*src0->nb[1])
+000591c0: 293b 0a20 2020 207d 0a7d 0a0a 0a73 7461  );.    }.}...sta
+000591d0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+000591e0: 6d70 7574 655f 666f 7277 6172 645f 6765  mpute_forward_ge
+000591f0: 745f 726f 7773 5f62 6163 6b28 0a20 2020  t_rows_back(.   
+00059200: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00059210: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00059220: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00059230: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00059240: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00059250: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
+00059260: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00059270: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
+00059280: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00059290: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000592a0: 6f72 202a 206f 7074 302c 0a20 2020 2020  or * opt0,.     
+000592b0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+000592c0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+000592d0: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+000592e0: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+000592f0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00059300: 4631 363a 0a20 2020 2020 2020 2020 2020  F16:.           
+00059310: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00059320: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00059330: 666f 7277 6172 645f 6765 745f 726f 7773  forward_get_rows
+00059340: 5f62 6163 6b5f 6633 325f 6631 3628 7061  _back_f32_f16(pa
+00059350: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
+00059360: 2c20 6f70 7430 2c20 6473 7429 3b0a 2020  , opt0, dst);.  
+00059370: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00059380: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00059390: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
+000593a0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000593b0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000593c0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000593d0: 645f 6765 745f 726f 7773 5f62 6163 6b5f  d_get_rows_back_
+000593e0: 6633 3228 7061 7261 6d73 2c20 7372 6330  f32(params, src0
+000593f0: 2c20 7372 6331 2c20 6f70 7430 2c20 6473  , src1, opt0, ds
+00059400: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00059410: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00059420: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
+00059430: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00059440: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00059450: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+00059460: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00059470: 0a20 2020 207d 0a0a 2020 2020 2f2f 7374  .    }..    //st
+00059480: 6174 6963 2062 6f6f 6c20 6669 7273 7420  atic bool first 
+00059490: 3d20 7472 7565 3b0a 2020 2020 2f2f 7072  = true;.    //pr
+000594a0: 696e 7466 2822 6e65 3020 3d20 2564 2c20  intf("ne0 = %d, 
+000594b0: 6e65 3120 3d20 2564 2c20 6e65 3220 3d20  ne1 = %d, ne2 = 
+000594c0: 2564 5c6e 222c 2064 7374 2d3e 6e65 5b30  %d\n", dst->ne[0
+000594d0: 5d2c 2064 7374 2d3e 6e65 5b31 5d2c 2064  ], dst->ne[1], d
+000594e0: 7374 2d3e 6e65 5b32 5d29 3b0a 2020 2020  st->ne[2]);.    
+000594f0: 2f2f 6966 2028 6669 7273 7429 207b 0a20  //if (first) {. 
+00059500: 2020 202f 2f20 2020 2066 6972 7374 203d     //    first =
+00059510: 2066 616c 7365 3b0a 2020 2020 2f2f 7d20   false;.    //} 
+00059520: 656c 7365 207b 0a20 2020 202f 2f20 2020  else {.    //   
+00059530: 2066 6f72 2028 696e 7420 6b20 3d20 303b   for (int k = 0;
+00059540: 206b 203c 2064 7374 2d3e 6e65 5b31 5d3b   k < dst->ne[1];
+00059550: 202b 2b6b 2920 7b0a 2020 2020 2f2f 2020   ++k) {.    //  
+00059560: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+00059570: 203d 2030 3b20 6a20 3c20 6473 742d 3e6e   = 0; j < dst->n
+00059580: 655b 305d 2f31 363b 202b 2b6a 2920 7b0a  e[0]/16; ++j) {.
+00059590: 2020 2020 2f2f 2020 2020 2020 2020 2020      //          
+000595a0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+000595b0: 3b20 6920 3c20 3136 3b20 2b2b 6929 207b  ; i < 16; ++i) {
+000595c0: 0a20 2020 202f 2f20 2020 2020 2020 2020  .    //         
+000595d0: 2020 2020 2020 2070 7269 6e74 6628 2225         printf("%
+000595e0: 382e 3466 2022 2c20 2828 666c 6f61 7420  8.4f ", ((float 
+000595f0: 2a29 2064 7374 2d3e 6461 7461 295b 6b2a  *) dst->data)[k*
+00059600: 6473 742d 3e6e 655b 305d 202b 206a 2a31  dst->ne[0] + j*1
+00059610: 3620 2b20 695d 293b 0a20 2020 202f 2f20  6 + i]);.    // 
+00059620: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00059630: 202f 2f20 2020 2020 2020 2020 2020 2070   //            p
+00059640: 7269 6e74 6628 225c 6e22 293b 0a20 2020  rintf("\n");.   
+00059650: 202f 2f20 2020 2020 2020 207d 0a20 2020   //        }.   
+00059660: 202f 2f20 2020 2020 2020 2070 7269 6e74   //        print
+00059670: 6628 225c 6e22 293b 0a20 2020 202f 2f20  f("\n");.    // 
+00059680: 2020 207d 0a20 2020 202f 2f20 2020 2070     }.    //    p
+00059690: 7269 6e74 6628 225c 6e22 293b 0a20 2020  rintf("\n");.   
+000596a0: 202f 2f20 2020 2065 7869 7428 3029 3b0a   //    exit(0);.
+000596b0: 2020 2020 2f2f 7d0a 7d0a 0a2f 2f20 6767      //}.}..// gg
+000596c0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000596d0: 7264 5f64 6961 670a 0a73 7461 7469 6320  rd_diag..static 
+000596e0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+000596f0: 655f 666f 7277 6172 645f 6469 6167 5f66  e_forward_diag_f
+00059700: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
+00059710: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00059720: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+00059730: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+00059740: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00059750: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+00059760: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00059770: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00059780: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
+00059790: 4552 5428 7061 7261 6d73 2d3e 6974 6820  ERT(params->ith 
+000597a0: 3d3d 2030 293b 0a0a 2020 2020 6966 2028  == 0);..    if (
+000597b0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+000597c0: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+000597d0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+000597e0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+000597f0: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+00059800: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00059810: 2020 202f 2f20 544f 444f 3a20 6861 6e64     // TODO: hand
+00059820: 6c65 2074 7261 6e73 706f 7365 642f 7065  le transposed/pe
+00059830: 726d 7574 6564 206d 6174 7269 6365 730a  rmuted matrices.
+00059840: 0a20 2020 2047 474d 4c5f 5445 4e53 4f52  .    GGML_TENSOR
+00059850: 5f55 4e41 5259 5f4f 505f 4c4f 4341 4c53  _UNARY_OP_LOCALS
+00059860: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00059870: 5254 286e 6530 3020 3d3d 206e 6530 293b  RT(ne00 == ne0);
+00059880: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00059890: 286e 6530 3020 3d3d 206e 6531 293b 0a20  (ne00 == ne1);. 
+000598a0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+000598b0: 6530 3120 3d3d 2031 293b 0a20 2020 2047  e01 == 1);.    G
+000598c0: 474d 4c5f 4153 5345 5254 286e 6530 3220  GML_ASSERT(ne02 
+000598d0: 3d3d 206e 6532 293b 0a20 2020 2047 474d  == ne2);.    GGM
+000598e0: 4c5f 4153 5345 5254 286e 6530 3320 3d3d  L_ASSERT(ne03 ==
+000598f0: 206e 6533 293b 0a0a 2020 2020 4747 4d4c   ne3);..    GGML
+00059900: 5f41 5353 4552 5428 6e62 3030 203d 3d20  _ASSERT(nb00 == 
+00059910: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
+00059920: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00059930: 6e62 3020 203d 3d20 7369 7a65 6f66 2866  nb0  == sizeof(f
+00059940: 6c6f 6174 2929 3b0a 0a20 2020 2066 6f72  loat));..    for
+00059950: 2028 696e 7420 6933 203d 2030 3b20 6933   (int i3 = 0; i3
+00059960: 203c 206e 6533 3b20 6933 2b2b 2920 7b0a   < ne3; i3++) {.
+00059970: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00059980: 2069 3220 3d20 303b 2069 3220 3c20 6e65   i2 = 0; i2 < ne
+00059990: 323b 2069 322b 2b29 207b 0a20 2020 2020  2; i2++) {.     
+000599a0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+000599b0: 6931 203d 2030 3b20 6931 203c 206e 6531  i1 = 0; i1 < ne1
+000599c0: 3b20 6931 2b2b 2920 7b0a 2020 2020 2020  ; i1++) {.      
+000599d0: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+000599e0: 2a20 6420 3d20 2866 6c6f 6174 202a 2928  * d = (float *)(
+000599f0: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+00059a00: 6174 6120 2b20 6933 2a6e 6233 2020 2b20  ata + i3*nb3  + 
+00059a10: 6932 2a6e 6232 202b 2069 312a 6e62 3129  i2*nb2 + i1*nb1)
+00059a20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00059a30: 2020 666c 6f61 7420 2a20 7320 3d20 2866    float * s = (f
+00059a40: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+00059a50: 2073 7263 302d 3e64 6174 6120 2b20 6933   src0->data + i3
+00059a60: 2a6e 6230 3320 2b20 6932 2a6e 6230 3229  *nb03 + i2*nb02)
+00059a70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00059a80: 2020 666f 7220 2869 6e74 2069 3020 3d20    for (int i0 = 
+00059a90: 303b 2069 3020 3c20 6931 3b20 6930 2b2b  0; i0 < i1; i0++
+00059aa0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00059ab0: 2020 2020 2020 2020 645b 6930 5d20 3d20          d[i0] = 
+00059ac0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+00059ad0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00059ae0: 2020 2020 2064 5b69 315d 203d 2073 5b69       d[i1] = s[i
+00059af0: 315d 3b0a 2020 2020 2020 2020 2020 2020  1];.            
+00059b00: 2020 2020 666f 7220 2869 6e74 2069 3020      for (int i0 
+00059b10: 3d20 6931 2b31 3b20 6930 203c 206e 6530  = i1+1; i0 < ne0
+00059b20: 3b20 6930 2b2b 2920 7b0a 2020 2020 2020  ; i0++) {.      
+00059b30: 2020 2020 2020 2020 2020 2020 2020 645b                d[
+00059b40: 6930 5d20 3d20 303b 0a20 2020 2020 2020  i0] = 0;.       
+00059b50: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00059b60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00059b70: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
+00059b80: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00059b90: 7075 7465 5f66 6f72 7761 7264 5f64 6961  pute_forward_dia
+00059ba0: 6728 0a20 2020 2020 2020 2063 6f6e 7374  g(.        const
+00059bb0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+00059bc0: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+00059bd0: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+00059be0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00059bf0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+00059c00: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00059c10: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00059c20: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+00059c30: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+00059c40: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00059c50: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+00059c60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00059c70: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00059c80: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
+00059c90: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
+00059ca0: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
+00059cb0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00059cc0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+00059cd0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00059ce0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00059cf0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00059d00: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00059d10: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+00059d20: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00059d30: 6f72 7761 7264 5f64 6961 675f 6d61 736b  orward_diag_mask
+00059d40: 5f69 6e66 0a0a 7374 6174 6963 2076 6f69  _inf..static voi
+00059d50: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+00059d60: 6f72 7761 7264 5f64 6961 675f 6d61 736b  orward_diag_mask
+00059d70: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+00059d80: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00059d90: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00059da0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00059db0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00059dc0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00059dd0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00059de0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00059df0: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+00059e00: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00059e10: 656e 736f 7220 2a20 6473 742c 0a20 2020  ensor * dst,.   
+00059e20: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00059e30: 2076 616c 7565 2920 7b0a 2020 2020 4747   value) {.    GG
+00059e40: 4d4c 5f41 5353 4552 5428 7372 6331 2d3e  ML_ASSERT(src1->
+00059e50: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+00059e60: 455f 4933 3229 3b0a 2020 2020 4747 4d4c  E_I32);.    GGML
+00059e70: 5f41 5353 4552 5428 6767 6d6c 5f6e 656c  _ASSERT(ggml_nel
+00059e80: 656d 656e 7473 2873 7263 3129 203d 3d20  ements(src1) == 
+00059e90: 3229 3b0a 0a20 2020 2063 6f6e 7374 2069  2);..    const i
+00059ea0: 6e74 2069 7468 203d 2070 6172 616d 732d  nt ith = params-
+00059eb0: 3e69 7468 3b0a 2020 2020 636f 6e73 7420  >ith;.    const 
+00059ec0: 696e 7420 6e74 6820 3d20 7061 7261 6d73  int nth = params
+00059ed0: 2d3e 6e74 683b 0a0a 2020 2020 636f 6e73  ->nth;..    cons
+00059ee0: 7420 696e 7420 206e 5f70 6173 7420 203d  t int  n_past  =
+00059ef0: 2020 2020 2020 2028 2869 6e74 3332 5f74         ((int32_t
+00059f00: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+00059f10: 305d 3b0a 2020 2020 636f 6e73 7420 626f  0];.    const bo
+00059f20: 6f6c 2069 6e70 6c61 6365 203d 2028 626f  ol inplace = (bo
+00059f30: 6f6c 2928 2869 6e74 3332 5f74 202a 2920  ol)((int32_t *) 
+00059f40: 7372 6331 2d3e 6461 7461 295b 315d 3b0a  src1->data)[1];.
+00059f50: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00059f60: 286e 5f70 6173 7420 3e3d 2030 293b 0a0a  (n_past >= 0);..
+00059f70: 2020 2020 6966 2028 2169 6e70 6c61 6365      if (!inplace
+00059f80: 2026 2620 2870 6172 616d 732d 3e74 7970   && (params->typ
+00059f90: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+00059fa0: 4e49 5429 2920 7b0a 2020 2020 2020 2020  NIT)) {.        
+00059fb0: 2f2f 206d 656d 6370 7920 6e65 6564 7320  // memcpy needs 
+00059fc0: 746f 2062 6520 7379 6e63 6872 6f6e 697a  to be synchroniz
+00059fd0: 6564 2061 6372 6f73 7320 7468 7265 6164  ed across thread
+00059fe0: 7320 746f 2061 766f 6964 2072 6163 6520  s to avoid race 
+00059ff0: 636f 6e64 6974 696f 6e73 2e0a 2020 2020  conditions..    
+0005a000: 2020 2020 2f2f 203d 3e20 646f 2069 7420      // => do it 
+0005a010: 696e 2049 4e49 5420 7068 6173 650a 2020  in INIT phase.  
+0005a020: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0005a030: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
+0005a040: 2864 7374 2920 3d3d 2067 676d 6c5f 6e65  (dst) == ggml_ne
+0005a050: 6c65 6d65 6e74 7328 7372 6330 2929 3b0a  lements(src0));.
+0005a060: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0005a070: 4552 5428 6767 6d6c 5f69 735f 636f 6e74  ERT(ggml_is_cont
+0005a080: 6967 756f 7573 2864 7374 2920 2626 2067  iguous(dst) && g
+0005a090: 676d 6c5f 6973 5f63 6f6e 7469 6775 6f75  gml_is_contiguou
+0005a0a0: 7328 7372 6330 2929 3b0a 2020 2020 2020  s(src0));.      
+0005a0b0: 2020 6d65 6d63 7079 280a 2020 2020 2020    memcpy(.      
+0005a0c0: 2020 2020 2020 2828 6368 6172 202a 2920        ((char *) 
+0005a0d0: 2064 7374 2d3e 6461 7461 292c 0a20 2020   dst->data),.   
+0005a0e0: 2020 2020 2020 2020 2028 2863 6861 7220           ((char 
+0005a0f0: 2a29 2073 7263 302d 3e64 6174 6129 2c0a  *) src0->data),.
+0005a100: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0005a110: 5f6e 6279 7465 7328 6473 7429 293b 0a20  _nbytes(dst));. 
+0005a120: 2020 207d 0a0a 2020 2020 6966 2028 7061     }..    if (pa
+0005a130: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+0005a140: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
+0005a150: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+0005a160: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
+0005a170: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
+0005a180: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+0005a190: 202f 2f20 544f 444f 3a20 6861 6e64 6c65   // TODO: handle
+0005a1a0: 2074 7261 6e73 706f 7365 642f 7065 726d   transposed/perm
+0005a1b0: 7574 6564 206d 6174 7269 6365 730a 0a20  uted matrices.. 
+0005a1c0: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
+0005a1d0: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
+0005a1e0: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+0005a1f0: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
+0005a200: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+0005a210: 7420 6e72 203d 2073 7263 302d 3e6e 655b  t nr = src0->ne[
+0005a220: 315d 3b0a 2020 2020 636f 6e73 7420 696e  1];.    const in
+0005a230: 7420 6e7a 203d 206e 2f6e 723b 0a0a 2020  t nz = n/nr;..  
+0005a240: 2020 4747 4d4c 5f41 5353 4552 5428 2064    GGML_ASSERT( d
+0005a250: 7374 2d3e 6e62 5b30 5d20 3d3d 2073 697a  st->nb[0] == siz
+0005a260: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
+0005a270: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
+0005a280: 302d 3e6e 625b 305d 203d 3d20 7369 7a65  0->nb[0] == size
+0005a290: 6f66 2866 6c6f 6174 2929 3b0a 0a20 2020  of(float));..   
+0005a2a0: 2066 6f72 2028 696e 7420 6b20 3d20 303b   for (int k = 0;
+0005a2b0: 206b 203c 206e 7a3b 206b 2b2b 2920 7b0a   k < nz; k++) {.
+0005a2c0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0005a2d0: 206a 203d 2069 7468 3b20 6a20 3c20 6e72   j = ith; j < nr
+0005a2e0: 3b20 6a20 2b3d 206e 7468 2920 7b0a 2020  ; j += nth) {.  
+0005a2f0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0005a300: 6e74 2069 203d 206e 5f70 6173 743b 2069  nt i = n_past; i
+0005a310: 203c 206e 633b 2069 2b2b 2920 7b0a 2020   < nc; i++) {.  
+0005a320: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0005a330: 2028 6920 3e20 6e5f 7061 7374 202b 206a   (i > n_past + j
+0005a340: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0005a350: 2020 2020 2020 2020 2a28 666c 6f61 7420          *(float 
+0005a360: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
+0005a370: 3e64 6174 6120 2b20 6b2a 6473 742d 3e6e  >data + k*dst->n
+0005a380: 625b 325d 202b 206a 2a64 7374 2d3e 6e62  b[2] + j*dst->nb
+0005a390: 5b31 5d20 2b20 692a 6473 742d 3e6e 625b  [1] + i*dst->nb[
+0005a3a0: 305d 2920 3d20 7661 6c75 653b 0a20 2020  0]) = value;.   
+0005a3b0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0005a3c0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0005a3d0: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+0005a3e0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0005a3f0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0005a400: 5f64 6961 675f 6d61 736b 5f69 6e66 280a  _diag_mask_inf(.
+0005a410: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0005a420: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+0005a430: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+0005a440: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+0005a450: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0005a460: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+0005a470: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0005a480: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+0005a490: 7263 312c 0a20 2020 2020 2020 2073 7472  rc1,.        str
+0005a4a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0005a4b0: 2a20 6473 7429 207b 0a20 2020 2073 7769  * dst) {.    swi
+0005a4c0: 7463 6820 2873 7263 302d 3e74 7970 6529  tch (src0->type)
+0005a4d0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+0005a4e0: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
+0005a4f0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0005a500: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0005a510: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0005a520: 645f 6469 6167 5f6d 6173 6b5f 6633 3228  d_diag_mask_f32(
+0005a530: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
+0005a540: 6331 2c20 6473 742c 202d 494e 4649 4e49  c1, dst, -INFINI
+0005a550: 5459 293b 0a20 2020 2020 2020 2020 2020  TY);.           
+0005a560: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0005a570: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
+0005a580: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0005a590: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0005a5a0: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+0005a5b0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0005a5c0: 3b0a 2020 2020 7d0a 7d0a 0a73 7461 7469  ;.    }.}..stati
+0005a5d0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+0005a5e0: 7574 655f 666f 7277 6172 645f 6469 6167  ute_forward_diag
+0005a5f0: 5f6d 6173 6b5f 7a65 726f 280a 2020 2020  _mask_zero(.    
+0005a600: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0005a610: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0005a620: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0005a630: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005a640: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0005a650: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0005a660: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005a670: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+0005a680: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0005a690: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0005a6a0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+0005a6b0: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
+0005a6c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0005a6d0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+0005a6e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0005a6f0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+0005a700: 6d70 7574 655f 666f 7277 6172 645f 6469  mpute_forward_di
+0005a710: 6167 5f6d 6173 6b5f 6633 3228 7061 7261  ag_mask_f32(para
+0005a720: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+0005a730: 6473 742c 2030 293b 0a20 2020 2020 2020  dst, 0);.       
+0005a740: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0005a750: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+0005a760: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0005a770: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+0005a780: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+0005a790: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0005a7a0: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+0005a7b0: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+0005a7c0: 6f72 7761 7264 5f73 6f66 745f 6d61 780a  orward_soft_max.
+0005a7d0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+0005a7e0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0005a7f0: 645f 736f 6674 5f6d 6178 5f66 3332 280a  d_soft_max_f32(.
+0005a800: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0005a810: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+0005a820: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+0005a830: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+0005a840: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0005a850: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+0005a860: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+0005a870: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+0005a880: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0005a890: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
+0005a8a0: 7573 2873 7263 3029 293b 0a20 2020 2047  us(src0));.    G
+0005a8b0: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+0005a8c0: 6973 5f63 6f6e 7469 6775 6f75 7328 6473  is_contiguous(ds
+0005a8d0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+0005a8e0: 5345 5254 2867 676d 6c5f 6172 655f 7361  SERT(ggml_are_sa
+0005a8f0: 6d65 5f73 6861 7065 2873 7263 302c 2064  me_shape(src0, d
+0005a900: 7374 2929 3b0a 0a20 2020 2069 6620 2870  st));..    if (p
+0005a910: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005a920: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+0005a930: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+0005a940: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0005a950: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0005a960: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0005a970: 2020 2f2f 2054 4f44 4f3a 2068 616e 646c    // TODO: handl
+0005a980: 6520 7472 616e 7370 6f73 6564 2f70 6572  e transposed/per
+0005a990: 6d75 7465 6420 6d61 7472 6963 6573 0a0a  muted matrices..
+0005a9a0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+0005a9b0: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+0005a9c0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005a9d0: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+0005a9e0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+0005a9f0: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
+0005aa00: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0005aa10: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
+0005aa20: 2873 7263 3029 3b0a 0a20 2020 202f 2f20  (src0);..    // 
+0005aa30: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
+0005aa40: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
+0005aa50: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
+0005aa60: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
+0005aa70: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
+0005aa80: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
+0005aa90: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
+0005aaa0: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0005aab0: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
+0005aac0: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
+0005aad0: 2066 6f72 2028 696e 7420 6931 203d 2069   for (int i1 = i
+0005aae0: 7230 3b20 6931 203c 2069 7231 3b20 6931  r0; i1 < ir1; i1
+0005aaf0: 2b2b 2920 7b0a 2020 2020 2020 2020 666c  ++) {.        fl
+0005ab00: 6f61 7420 2a73 7020 3d20 2866 6c6f 6174  oat *sp = (float
+0005ab10: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
+0005ab20: 302d 3e64 6174 6120 2b20 6931 2a73 7263  0->data + i1*src
+0005ab30: 302d 3e6e 625b 315d 293b 0a20 2020 2020  0->nb[1]);.     
+0005ab40: 2020 2066 6c6f 6174 202a 6470 203d 2028     float *dp = (
+0005ab50: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
+0005ab60: 2920 2064 7374 2d3e 6461 7461 202b 2020  )  dst->data +  
+0005ab70: 6931 2a64 7374 2d3e 6e62 5b31 5d29 3b0a  i1*dst->nb[1]);.
+0005ab80: 0a23 6966 6e64 6566 204e 4445 4255 470a  .#ifndef NDEBUG.
+0005ab90: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0005aba0: 2069 203d 2030 3b20 6920 3c20 6e63 3b20   i = 0; i < nc; 
+0005abb0: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
+0005abc0: 2020 202f 2f70 7269 6e74 6628 2270 5b25     //printf("p[%
+0005abd0: 645d 203d 2025 665c 6e22 2c20 692c 2070  d] = %f\n", i, p
+0005abe0: 5b69 5d29 3b0a 2020 2020 2020 2020 2020  [i]);.          
+0005abf0: 2020 6173 7365 7274 2821 6973 6e61 6e28    assert(!isnan(
+0005ac00: 7370 5b69 5d29 293b 0a20 2020 2020 2020  sp[i]));.       
+0005ac10: 207d 0a23 656e 6469 660a 0a20 2020 2020   }.#endif..     
+0005ac20: 2020 2066 6c6f 6174 206d 6178 203d 202d     float max = -
+0005ac30: 494e 4649 4e49 5459 3b0a 2020 2020 2020  INFINITY;.      
+0005ac40: 2020 6767 6d6c 5f76 6563 5f6d 6178 5f66    ggml_vec_max_f
+0005ac50: 3332 286e 632c 2026 6d61 782c 2073 7029  32(nc, &max, sp)
+0005ac60: 3b0a 0a20 2020 2020 2020 2067 676d 6c5f  ;..        ggml_
+0005ac70: 666c 6f61 7420 7375 6d20 3d20 302e 303b  float sum = 0.0;
+0005ac80: 0a0a 2020 2020 2020 2020 7569 6e74 3136  ..        uint16
+0005ac90: 5f74 2073 6376 743b 0a20 2020 2020 2020  _t scvt;.       
+0005aca0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0005acb0: 2069 203c 206e 633b 2069 2b2b 2920 7b0a   i < nc; i++) {.
+0005acc0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0005acd0: 7370 5b69 5d20 3d3d 202d 494e 4649 4e49  sp[i] == -INFINI
+0005ace0: 5459 2920 7b0a 2020 2020 2020 2020 2020  TY) {.          
+0005acf0: 2020 2020 2020 6470 5b69 5d20 3d20 302e        dp[i] = 0.
+0005ad00: 3066 3b0a 2020 2020 2020 2020 2020 2020  0f;.            
+0005ad10: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+0005ad20: 2020 2020 2020 2020 202f 2f20 636f 6e73           // cons
+0005ad30: 7420 666c 6f61 7420 7661 6c20 3d20 2873  t float val = (s
+0005ad40: 705b 695d 203d 3d20 2d49 4e46 494e 4954  p[i] == -INFINIT
+0005ad50: 5929 203f 2030 2e30 203a 2065 7870 2873  Y) ? 0.0 : exp(s
+0005ad60: 705b 695d 202d 206d 6178 293b 0a20 2020  p[i] - max);.   
+0005ad70: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0005ad80: 6c5f 6670 3136 5f74 2073 203d 2047 474d  l_fp16_t s = GGM
+0005ad90: 4c5f 4650 3332 5f54 4f5f 4650 3136 2873  L_FP32_TO_FP16(s
+0005ada0: 705b 695d 202d 206d 6178 293b 0a20 2020  p[i] - max);.   
+0005adb0: 2020 2020 2020 2020 2020 2020 206d 656d               mem
+0005adc0: 6370 7928 2673 6376 742c 2026 732c 2073  cpy(&scvt, &s, s
+0005add0: 697a 656f 6628 7363 7674 2929 3b0a 2020  izeof(scvt));.  
+0005ade0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0005adf0: 6e73 7420 666c 6f61 7420 7661 6c20 3d20  nst float val = 
+0005ae00: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
+0005ae10: 3228 7461 626c 655f 6578 705f 6631 365b  2(table_exp_f16[
+0005ae20: 7363 7674 5d29 3b0a 2020 2020 2020 2020  scvt]);.        
+0005ae30: 2020 2020 2020 2020 7375 6d20 2b3d 2028          sum += (
+0005ae40: 6767 6d6c 5f66 6c6f 6174 2976 616c 3b0a  ggml_float)val;.
+0005ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ae60: 6470 5b69 5d20 3d20 7661 6c3b 0a20 2020  dp[i] = val;.   
+0005ae70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0005ae80: 2020 207d 0a0a 2020 2020 2020 2020 6173     }..        as
+0005ae90: 7365 7274 2873 756d 203e 2030 2e30 293b  sert(sum > 0.0);
+0005aea0: 0a0a 2020 2020 2020 2020 7375 6d20 3d20  ..        sum = 
+0005aeb0: 312e 302f 7375 6d3b 0a20 2020 2020 2020  1.0/sum;.       
+0005aec0: 2067 676d 6c5f 7665 635f 7363 616c 655f   ggml_vec_scale_
+0005aed0: 6633 3228 6e63 2c20 6470 2c20 7375 6d29  f32(nc, dp, sum)
+0005aee0: 3b0a 0a23 6966 6e64 6566 204e 4445 4255  ;..#ifndef NDEBU
+0005aef0: 470a 2020 2020 2020 2020 666f 7220 2869  G.        for (i
+0005af00: 6e74 2069 203d 2030 3b20 6920 3c20 6e63  nt i = 0; i < nc
+0005af10: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
+0005af20: 2020 2020 2061 7373 6572 7428 2169 736e       assert(!isn
+0005af30: 616e 2864 705b 695d 2929 3b0a 2020 2020  an(dp[i]));.    
+0005af40: 2020 2020 2020 2020 6173 7365 7274 2821          assert(!
+0005af50: 6973 696e 6628 6470 5b69 5d29 293b 0a20  isinf(dp[i]));. 
+0005af60: 2020 2020 2020 207d 0a23 656e 6469 660a         }.#endif.
+0005af70: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+0005af80: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+0005af90: 655f 666f 7277 6172 645f 736f 6674 5f6d  e_forward_soft_m
+0005afa0: 6178 280a 2020 2020 2020 2020 636f 6e73  ax(.        cons
+0005afb0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+0005afc0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+0005afd0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+0005afe0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0005aff0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+0005b000: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+0005b010: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+0005b020: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+0005b030: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+0005b040: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0005b050: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+0005b060: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0005b070: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+0005b080: 7075 7465 5f66 6f72 7761 7264 5f73 6f66  pute_forward_sof
+0005b090: 745f 6d61 785f 6633 3228 7061 7261 6d73  t_max_f32(params
+0005b0a0: 2c20 7372 6330 2c20 6473 7429 3b0a 2020  , src0, dst);.  
+0005b0b0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0005b0c0: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
+0005b0d0: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+0005b0e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005b0f0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0005b100: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
+0005b110: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
+0005b120: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
+0005b130: 7574 655f 666f 7277 6172 645f 736f 6674  ute_forward_soft
+0005b140: 5f6d 6178 5f62 6163 6b0a 0a73 7461 7469  _max_back..stati
+0005b150: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+0005b160: 7574 655f 666f 7277 6172 645f 736f 6674  ute_forward_soft
+0005b170: 5f6d 6178 5f62 6163 6b5f 6633 3228 0a20  _max_back_f32(. 
+0005b180: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005b190: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+0005b1a0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+0005b1b0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0005b1c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005b1d0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+0005b1e0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0005b1f0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0005b200: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+0005b210: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005b220: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
+0005b230: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
+0005b240: 636f 6e74 6967 756f 7573 2873 7263 3029  contiguous(src0)
+0005b250: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0005b260: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
+0005b270: 6775 6f75 7328 7372 6331 2929 3b0a 2020  guous(src1));.  
+0005b280: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0005b290: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+0005b2a0: 2864 7374 2929 3b0a 2020 2020 4747 4d4c  (dst));.    GGML
+0005b2b0: 5f41 5353 4552 5428 6767 6d6c 5f61 7265  _ASSERT(ggml_are
+0005b2c0: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+0005b2d0: 2c20 6473 7429 293b 0a20 2020 2047 474d  , dst));.    GGM
+0005b2e0: 4c5f 4153 5345 5254 2867 676d 6c5f 6172  L_ASSERT(ggml_ar
+0005b2f0: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
+0005b300: 312c 2064 7374 2929 3b0a 0a20 2020 2069  1, dst));..    i
+0005b310: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+0005b320: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+0005b330: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
+0005b340: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+0005b350: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+0005b360: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+0005b370: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 2068  ..    // TODO: h
+0005b380: 616e 646c 6520 7472 616e 7370 6f73 6564  andle transposed
+0005b390: 2f70 6572 6d75 7465 6420 6d61 7472 6963  /permuted matric
+0005b3a0: 6573 0a0a 2020 2020 636f 6e73 7420 696e  es..    const in
+0005b3b0: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+0005b3c0: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+0005b3d0: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
+0005b3e0: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
+0005b3f0: 2069 6e74 206e 6320 3d20 7372 6330 2d3e   int nc = src0->
+0005b400: 6e65 5b30 5d3b 0a20 2020 2063 6f6e 7374  ne[0];.    const
+0005b410: 2069 6e74 206e 7220 3d20 6767 6d6c 5f6e   int nr = ggml_n
+0005b420: 726f 7773 2873 7263 3029 3b0a 0a20 2020  rows(src0);..   
+0005b430: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
+0005b440: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+0005b450: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
+0005b460: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
+0005b470: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
+0005b480: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
+0005b490: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
+0005b4a0: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
+0005b4b0: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
+0005b4c0: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
+0005b4d0: 0a20 2020 2066 6f72 2028 696e 7420 6931  .    for (int i1
+0005b4e0: 203d 2069 7230 3b20 6931 203c 2069 7231   = ir0; i1 < ir1
+0005b4f0: 3b20 6931 2b2b 2920 7b0a 2020 2020 2020  ; i1++) {.      
+0005b500: 2020 666c 6f61 7420 2a64 7920 3d20 2866    float *dy = (f
+0005b510: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+0005b520: 2073 7263 302d 3e64 6174 6120 2b20 6931   src0->data + i1
+0005b530: 2a73 7263 302d 3e6e 625b 315d 293b 0a20  *src0->nb[1]);. 
+0005b540: 2020 2020 2020 2066 6c6f 6174 202a 7920         float *y 
+0005b550: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
+0005b560: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
+0005b570: 202b 2069 312a 7372 6331 2d3e 6e62 5b31   + i1*src1->nb[1
+0005b580: 5d29 3b0a 2020 2020 2020 2020 666c 6f61  ]);.        floa
+0005b590: 7420 2a64 7820 3d20 2866 6c6f 6174 202a  t *dx = (float *
+0005b5a0: 2928 2863 6861 7220 2a29 2064 7374 2d3e  )((char *) dst->
+0005b5b0: 6461 7461 2020 2b20 6931 2a64 7374 2d3e  data  + i1*dst->
+0005b5c0: 6e62 5b31 5d29 3b0a 0a23 6966 6e64 6566  nb[1]);..#ifndef
+0005b5d0: 204e 4445 4255 470a 2020 2020 2020 2020   NDEBUG.        
+0005b5e0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+0005b5f0: 6920 3c20 6e63 3b20 2b2b 6929 207b 0a20  i < nc; ++i) {. 
+0005b600: 2020 2020 2020 2020 2020 202f 2f70 7269             //pri
+0005b610: 6e74 6628 2270 5b25 645d 203d 2025 665c  ntf("p[%d] = %f\
+0005b620: 6e22 2c20 692c 2070 5b69 5d29 3b0a 2020  n", i, p[i]);.  
+0005b630: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0005b640: 2821 6973 6e61 6e28 6479 5b69 5d29 293b  (!isnan(dy[i]));
+0005b650: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0005b660: 6572 7428 2169 736e 616e 2879 5b69 5d29  ert(!isnan(y[i])
+0005b670: 293b 0a20 2020 2020 2020 207d 0a23 656e  );.        }.#en
+0005b680: 6469 660a 2020 2020 2020 2020 2f2f 204a  dif.        // J
+0005b690: 6969 203d 2079 6920 2d20 7969 2a79 690a  ii = yi - yi*yi.
+0005b6a0: 2020 2020 2020 2020 2f2f 204a 696a 203d          // Jij =
+0005b6b0: 202d 7969 2a79 6a0a 2020 2020 2020 2020   -yi*yj.        
+0005b6c0: 2f2f 204a 203d 2064 6961 6728 7929 2d79  // J = diag(y)-y
+0005b6d0: 2e54 2a79 0a20 2020 2020 2020 202f 2f20  .T*y.        // 
+0005b6e0: 6478 203d 204a 202a 2064 790a 2020 2020  dx = J * dy.    
+0005b6f0: 2020 2020 2f2f 2064 786b 203d 2073 756d      // dxk = sum
+0005b700: 5f69 284a 6b69 202a 2064 7969 290a 2020  _i(Jki * dyi).  
+0005b710: 2020 2020 2020 2f2f 2064 786b 203d 2073        // dxk = s
+0005b720: 756d 5f69 282d 796b 2a79 6920 2a20 6479  um_i(-yk*yi * dy
+0005b730: 6929 202d 2028 2d79 6b2a 796b 292a 6479  i) - (-yk*yk)*dy
+0005b740: 6b20 2b20 2879 6b20 2d20 796b 2a79 6b29  k + (yk - yk*yk)
+0005b750: 2a64 796b 0a20 2020 2020 2020 202f 2f20  *dyk.        // 
+0005b760: 6478 6b20 3d20 7375 6d5f 6928 2d79 6b2a  dxk = sum_i(-yk*
+0005b770: 7969 202a 2064 7969 2920 2b20 796b 2a64  yi * dyi) + yk*d
+0005b780: 796b 0a20 2020 2020 2020 202f 2f20 6478  yk.        // dx
+0005b790: 6b20 3d20 2d79 6b20 2a20 7375 6d5f 6928  k = -yk * sum_i(
+0005b7a0: 7969 202a 2064 7969 2920 2b20 796b 2a64  yi * dyi) + yk*d
+0005b7b0: 796b 0a20 2020 2020 2020 202f 2f20 6478  yk.        // dx
+0005b7c0: 6b20 3d20 2d79 6b20 2a20 646f 7428 792c  k = -yk * dot(y,
+0005b7d0: 2064 7929 202b 2079 6b2a 6479 6b0a 2020   dy) + yk*dyk.  
+0005b7e0: 2020 2020 2020 2f2f 2064 786b 203d 2079        // dxk = y
+0005b7f0: 6b20 2a20 282d 2064 6f74 2879 2c20 6479  k * (- dot(y, dy
+0005b800: 2920 2b20 6479 6b29 0a20 2020 2020 2020  ) + dyk).       
+0005b810: 202f 2f20 6478 6b20 3d20 796b 202a 2028   // dxk = yk * (
+0005b820: 6479 6b20 2d20 646f 7428 792c 2064 7929  dyk - dot(y, dy)
+0005b830: 290a 2020 2020 2020 2020 2f2f 0a20 2020  ).        //.   
+0005b840: 2020 2020 202f 2f20 706f 7374 2d6f 7264       // post-ord
+0005b850: 6572 3a0a 2020 2020 2020 2020 2f2f 2064  er:.        // d
+0005b860: 6f74 5f79 5f64 7920 3a3d 2064 6f74 2879  ot_y_dy := dot(y
+0005b870: 2c20 6479 290a 2020 2020 2020 2020 2f2f  , dy).        //
+0005b880: 2064 7820 3a3d 2064 790a 2020 2020 2020   dx := dy.      
+0005b890: 2020 2f2f 2064 7820 3a3d 2064 7820 2d20    // dx := dx - 
+0005b8a0: 646f 745f 795f 6479 0a20 2020 2020 2020  dot_y_dy.       
+0005b8b0: 202f 2f20 6478 203a 3d20 6478 202a 2079   // dx := dx * y
+0005b8c0: 0a0a 2020 2020 2020 2020 2f2f 206c 696e  ..        // lin
+0005b8d0: 6561 7220 7275 6e74 696d 652c 206e 6f20  ear runtime, no 
+0005b8e0: 6164 6469 7469 6f6e 616c 206d 656d 6f72  additional memor
+0005b8f0: 790a 2020 2020 2020 2020 666c 6f61 7420  y.        float 
+0005b900: 646f 745f 795f 6479 203d 2030 3b0a 2020  dot_y_dy = 0;.  
+0005b910: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+0005b920: 6f74 5f66 3332 2028 6e63 2c20 2664 6f74  ot_f32 (nc, &dot
+0005b930: 5f79 5f64 792c 2079 2c20 6479 293b 0a20  _y_dy, y, dy);. 
+0005b940: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0005b950: 6370 795f 6633 3220 286e 632c 2064 782c  cpy_f32 (nc, dx,
+0005b960: 2064 7929 3b0a 2020 2020 2020 2020 6767   dy);.        gg
+0005b970: 6d6c 5f76 6563 5f61 6363 315f 6633 3228  ml_vec_acc1_f32(
+0005b980: 6e63 2c20 6478 2c20 2d64 6f74 5f79 5f64  nc, dx, -dot_y_d
+0005b990: 7929 3b0a 2020 2020 2020 2020 6767 6d6c  y);.        ggml
+0005b9a0: 5f76 6563 5f6d 756c 5f66 3332 2028 6e63  _vec_mul_f32 (nc
+0005b9b0: 2c20 6478 2c20 6478 2c20 7929 3b0a 0a23  , dx, dx, y);..#
+0005b9c0: 6966 6e64 6566 204e 4445 4255 470a 2020  ifndef NDEBUG.  
+0005b9d0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0005b9e0: 203d 2030 3b20 6920 3c20 6e63 3b20 2b2b   = 0; i < nc; ++
+0005b9f0: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
+0005ba00: 2061 7373 6572 7428 2169 736e 616e 2864   assert(!isnan(d
+0005ba10: 785b 695d 2929 3b0a 2020 2020 2020 2020  x[i]));.        
+0005ba20: 2020 2020 6173 7365 7274 2821 6973 696e      assert(!isin
+0005ba30: 6628 6478 5b69 5d29 293b 0a20 2020 2020  f(dx[i]));.     
+0005ba40: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
+0005ba50: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+0005ba60: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+0005ba70: 7277 6172 645f 736f 6674 5f6d 6178 5f62  rward_soft_max_b
+0005ba80: 6163 6b28 0a20 2020 2020 2020 2063 6f6e  ack(.        con
+0005ba90: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0005baa0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+0005bab0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0005bac0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005bad0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+0005bae0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0005baf0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005bb00: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+0005bb10: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0005bb20: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0005bb30: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
+0005bb40: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+0005bb50: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
+0005bb60: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
+0005bb70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0005bb80: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+0005bb90: 6f72 7761 7264 5f73 6f66 745f 6d61 785f  orward_soft_max_
+0005bba0: 6261 636b 5f66 3332 2870 6172 616d 732c  back_f32(params,
+0005bbb0: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
+0005bbc0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+0005bbd0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0005bbe0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+0005bbf0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0005bc00: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0005bc10: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
+0005bc20: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0005bc30: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
+0005bc40: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0005bc50: 5f61 6c69 6269 0a0a 7374 6174 6963 2076  _alibi..static v
+0005bc60: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+0005bc70: 5f66 6f72 7761 7264 5f61 6c69 6269 5f66  _forward_alibi_f
+0005bc80: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
+0005bc90: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+0005bca0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+0005bcb0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+0005bcc0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0005bcd0: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+0005bce0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0005bcf0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0005bd00: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
+0005bd10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0005bd20: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+0005bd30: 2061 7373 6572 7428 7061 7261 6d73 2d3e   assert(params->
+0005bd40: 6974 6820 3d3d 2030 293b 0a0a 2020 2020  ith == 0);..    
+0005bd50: 4747 4d4c 5f41 5353 4552 5428 7372 6331  GGML_ASSERT(src1
+0005bd60: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0005bd70: 5950 455f 4933 3229 3b0a 2020 2020 4747  YPE_I32);.    GG
+0005bd80: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f6e  ML_ASSERT(ggml_n
+0005bd90: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
+0005bda0: 3d20 3329 3b0a 0a20 2020 2069 6620 2870  = 3);..    if (p
+0005bdb0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005bdc0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+0005bdd0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+0005bde0: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0005bdf0: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0005be00: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0005be10: 2020 636f 6e73 7420 696e 7420 2020 6e5f    const int   n_
+0005be20: 7061 7374 2020 203d 2028 2869 6e74 3332  past   = ((int32
+0005be30: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+0005be40: 295b 305d 3b0a 2020 2020 636f 6e73 7420  )[0];.    const 
+0005be50: 696e 7420 2020 6e5f 6865 6164 2020 203d  int   n_head   =
+0005be60: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
+0005be70: 6331 2d3e 6461 7461 295b 315d 3b0a 2020  c1->data)[1];.  
+0005be80: 2020 636f 6e73 7420 666c 6f61 7420 6d61    const float ma
+0005be90: 785f 6269 6173 203d 2028 2866 6c6f 6174  x_bias = ((float
+0005bea0: 202a 2920 2020 7372 6331 2d3e 6461 7461   *)   src1->data
+0005beb0: 295b 325d 3b0a 0a20 2020 2061 7373 6572  )[2];..    asser
+0005bec0: 7428 6e5f 7061 7374 203e 3d20 3029 3b0a  t(n_past >= 0);.
+0005bed0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005bee0: 6530 203d 2073 7263 302d 3e6e 655b 305d  e0 = src0->ne[0]
+0005bef0: 3b20 2f2f 2061 6c6c 5f73 6571 5f6c 656e  ; // all_seq_len
+0005bf00: 203d 206e 5f70 6173 7420 2b20 6e65 310a   = n_past + ne1.
+0005bf10: 2020 2020 636f 6e73 7420 696e 7420 6e65      const int ne
+0005bf20: 3120 3d20 7372 6330 2d3e 6e65 5b31 5d3b  1 = src0->ne[1];
+0005bf30: 202f 2f20 7365 715f 6c65 6e5f 7769 7468   // seq_len_with
+0005bf40: 6f75 745f 7061 7374 0a20 2020 2063 6f6e  out_past.    con
+0005bf50: 7374 2069 6e74 206e 6532 203d 2073 7263  st int ne2 = src
+0005bf60: 302d 3e6e 655b 325d 3b20 2f2f 206e 5f68  0->ne[2]; // n_h
+0005bf70: 6561 6420 2d3e 2074 6869 7320 6973 206b  ead -> this is k
+0005bf80: 0a20 2020 202f 2f63 6f6e 7374 2069 6e74  .    //const int
+0005bf90: 206e 6533 203d 2073 7263 302d 3e6e 655b   ne3 = src0->ne[
+0005bfa0: 335d 3b20 2f2f 2031 202d 3e20 6273 7a0a  3]; // 1 -> bsz.
+0005bfb0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005bfc0: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
+0005bfd0: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
+0005bfe0: 696e 7420 6e65 325f 6e65 3320 3d20 6e2f  int ne2_ne3 = n/
+0005bff0: 6e65 313b 202f 2f20 6e65 322a 6e65 330a  ne1; // ne2*ne3.
+0005c000: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005c010: 6230 203d 2073 7263 302d 3e6e 625b 305d  b0 = src0->nb[0]
+0005c020: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0005c030: 6e62 3120 3d20 7372 6330 2d3e 6e62 5b31  nb1 = src0->nb[1
+0005c040: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0005c050: 206e 6232 203d 2073 7263 302d 3e6e 625b   nb2 = src0->nb[
+0005c060: 325d 3b0a 2020 2020 2f2f 636f 6e73 7420  2];.    //const 
+0005c070: 696e 7420 6e62 3320 3d20 7372 6330 2d3e  int nb3 = src0->
+0005c080: 6e62 5b33 5d3b 0a0a 2020 2020 4747 4d4c  nb[3];..    GGML
+0005c090: 5f41 5353 4552 5428 6e62 3020 3d3d 2073  _ASSERT(nb0 == s
+0005c0a0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+0005c0b0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0005c0c0: 6531 202b 206e 5f70 6173 7420 3d3d 206e  e1 + n_past == n
+0005c0d0: 6530 293b 0a20 2020 2047 474d 4c5f 4153  e0);.    GGML_AS
+0005c0e0: 5345 5254 286e 5f68 6561 6420 3d3d 206e  SERT(n_head == n
+0005c0f0: 6532 293b 0a0a 2020 2020 2f2f 2061 6464  e2);..    // add
+0005c100: 2061 6c69 6269 2074 6f20 7372 6330 2028   alibi to src0 (
+0005c110: 4b51 5f73 6361 6c65 6429 0a20 2020 2063  KQ_scaled).    c
+0005c120: 6f6e 7374 2069 6e74 206e 5f68 6561 6473  onst int n_heads
+0005c130: 5f6c 6f67 325f 666c 6f6f 7220 3d20 3120  _log2_floor = 1 
+0005c140: 3c3c 2028 696e 7429 2066 6c6f 6f72 286c  << (int) floor(l
+0005c150: 6f67 3228 6e5f 6865 6164 2929 3b0a 0a20  og2(n_head));.. 
+0005c160: 2020 2063 6f6e 7374 2066 6c6f 6174 206d     const float m
+0005c170: 3020 3d20 706f 7766 2832 2e30 662c 202d  0 = powf(2.0f, -
+0005c180: 286d 6178 5f62 6961 7329 202f 206e 5f68  (max_bias) / n_h
+0005c190: 6561 6473 5f6c 6f67 325f 666c 6f6f 7229  eads_log2_floor)
+0005c1a0: 3b0a 2020 2020 636f 6e73 7420 666c 6f61  ;.    const floa
+0005c1b0: 7420 6d31 203d 2070 6f77 6628 322e 3066  t m1 = powf(2.0f
+0005c1c0: 2c20 2d28 6d61 785f 6269 6173 202f 2032  , -(max_bias / 2
+0005c1d0: 2e30 6629 202f 206e 5f68 6561 6473 5f6c  .0f) / n_heads_l
+0005c1e0: 6f67 325f 666c 6f6f 7229 3b0a 0a20 2020  og2_floor);..   
+0005c1f0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0005c200: 2069 203c 206e 6530 3b20 692b 2b29 207b   i < ne0; i++) {
+0005c210: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+0005c220: 7420 6a20 3d20 303b 206a 203c 206e 6531  t j = 0; j < ne1
+0005c230: 3b20 6a2b 2b29 207b 0a20 2020 2020 2020  ; j++) {.       
+0005c240: 2020 2020 2066 6f72 2028 696e 7420 6b20       for (int k 
+0005c250: 3d20 303b 206b 203c 206e 6532 5f6e 6533  = 0; k < ne2_ne3
+0005c260: 3b20 6b2b 2b29 207b 0a20 2020 2020 2020  ; k++) {.       
+0005c270: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+0005c280: 2063 6f6e 7374 2073 7263 203d 2028 666c   const src = (fl
+0005c290: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
+0005c2a0: 7372 6330 2d3e 6461 7461 202b 2069 2a6e  src0->data + i*n
+0005c2b0: 6230 202b 206a 2a6e 6231 202b 206b 2a6e  b0 + j*nb1 + k*n
+0005c2c0: 6232 293b 0a20 2020 2020 2020 2020 2020  b2);.           
+0005c2d0: 2020 2020 2066 6c6f 6174 202a 2020 2020       float *    
+0005c2e0: 2020 7064 7374 203d 2028 666c 6f61 7420    pdst = (float 
+0005c2f0: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
+0005c300: 2d3e 6461 7461 202b 2069 2a6e 6230 202b  ->data + i*nb0 +
+0005c310: 206a 2a6e 6231 202b 206b 2a6e 6232 293b   j*nb1 + k*nb2);
+0005c320: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005c330: 2020 2f2f 2054 4f44 4f3a 206b 2a6e 6232    // TODO: k*nb2
+0005c340: 206f 7220 6b2a 6e62 330a 0a20 2020 2020   or k*nb3..     
+0005c350: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
+0005c360: 206d 5f6b 3b0a 0a20 2020 2020 2020 2020   m_k;..         
+0005c370: 2020 2020 2020 2069 6620 286b 203c 206e         if (k < n
+0005c380: 5f68 6561 6473 5f6c 6f67 325f 666c 6f6f  _heads_log2_floo
+0005c390: 7229 207b 0a20 2020 2020 2020 2020 2020  r) {.           
+0005c3a0: 2020 2020 2020 2020 206d 5f6b 203d 2070           m_k = p
+0005c3b0: 6f77 6628 6d30 2c20 6b20 2b20 3129 3b0a  owf(m0, k + 1);.
+0005c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005c3d0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+0005c3e0: 2020 2020 2020 2020 2020 2020 206d 5f6b               m_k
+0005c3f0: 203d 2070 6f77 6628 6d31 2c20 3220 2a20   = powf(m1, 2 * 
+0005c400: 286b 202d 206e 5f68 6561 6473 5f6c 6f67  (k - n_heads_log
+0005c410: 325f 666c 6f6f 7229 202b 2031 293b 0a20  2_floor) + 1);. 
+0005c420: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0005c430: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005c440: 2020 7064 7374 5b30 5d20 3d20 6920 2a20    pdst[0] = i * 
+0005c450: 6d5f 6b20 2b20 7372 635b 305d 3b0a 0a20  m_k + src[0];.. 
+0005c460: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0005c470: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+0005c480: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0005c490: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+0005c4a0: 5f61 6c69 6269 5f66 3136 280a 2020 2020  _alibi_f16(.    
+0005c4b0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0005c4c0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0005c4d0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0005c4e0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005c4f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0005c500: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+0005c510: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0005c520: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+0005c530: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0005c540: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0005c550: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
+0005c560: 7061 7261 6d73 2d3e 6974 6820 3d3d 2030  params->ith == 0
+0005c570: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+0005c580: 4552 5428 7372 6331 2d3e 7479 7065 203d  ERT(src1->type =
+0005c590: 3d20 4747 4d4c 5f54 5950 455f 4933 3229  = GGML_TYPE_I32)
+0005c5a0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0005c5b0: 5428 6767 6d6c 5f6e 656c 656d 656e 7473  T(ggml_nelements
+0005c5c0: 2873 7263 3129 203d 3d20 3329 3b0a 0a20  (src1) == 3);.. 
+0005c5d0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+0005c5e0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+0005c5f0: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
+0005c600: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0005c610: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+0005c620: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0005c630: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
+0005c640: 696e 7420 2020 6e5f 7061 7374 2020 203d  int   n_past   =
+0005c650: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
+0005c660: 6331 2d3e 6461 7461 295b 305d 3b0a 2020  c1->data)[0];.  
+0005c670: 2020 636f 6e73 7420 696e 7420 2020 6e5f    const int   n_
+0005c680: 6865 6164 2020 203d 2028 2869 6e74 3332  head   = ((int32
+0005c690: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+0005c6a0: 295b 315d 3b0a 2020 2020 636f 6e73 7420  )[1];.    const 
+0005c6b0: 666c 6f61 7420 6d61 785f 6269 6173 203d  float max_bias =
+0005c6c0: 2028 2866 6c6f 6174 202a 2920 2020 7372   ((float *)   sr
+0005c6d0: 6331 2d3e 6461 7461 295b 325d 3b0a 0a20  c1->data)[2];.. 
+0005c6e0: 2020 2061 7373 6572 7428 6e5f 7061 7374     assert(n_past
+0005c6f0: 203e 3d20 3029 3b0a 0a20 2020 2063 6f6e   >= 0);..    con
+0005c700: 7374 2069 6e74 206e 6530 203d 2073 7263  st int ne0 = src
+0005c710: 302d 3e6e 655b 305d 3b20 2f2f 2061 6c6c  0->ne[0]; // all
+0005c720: 5f73 6571 5f6c 656e 203d 206e 5f70 6173  _seq_len = n_pas
+0005c730: 7420 2b20 6e65 310a 2020 2020 636f 6e73  t + ne1.    cons
+0005c740: 7420 696e 7420 6e65 3120 3d20 7372 6330  t int ne1 = src0
+0005c750: 2d3e 6e65 5b31 5d3b 202f 2f20 7365 715f  ->ne[1]; // seq_
+0005c760: 6c65 6e5f 7769 7468 6f75 745f 7061 7374  len_without_past
+0005c770: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+0005c780: 6532 203d 2073 7263 302d 3e6e 655b 325d  e2 = src0->ne[2]
+0005c790: 3b20 2f2f 206e 5f68 6561 6420 2d3e 2074  ; // n_head -> t
+0005c7a0: 6869 7320 6973 206b 0a20 2020 202f 2f63  his is k.    //c
+0005c7b0: 6f6e 7374 2069 6e74 206e 6533 203d 2073  onst int ne3 = s
+0005c7c0: 7263 302d 3e6e 655b 335d 3b20 2f2f 2031  rc0->ne[3]; // 1
+0005c7d0: 202d 3e20 6273 7a0a 0a20 2020 2063 6f6e   -> bsz..    con
+0005c7e0: 7374 2069 6e74 206e 2020 3d20 6767 6d6c  st int n  = ggml
+0005c7f0: 5f6e 726f 7773 2873 7263 3029 3b0a 2020  _nrows(src0);.  
+0005c800: 2020 636f 6e73 7420 696e 7420 6e65 325f    const int ne2_
+0005c810: 6e65 3320 3d20 6e2f 6e65 313b 202f 2f20  ne3 = n/ne1; // 
+0005c820: 6e65 322a 6e65 330a 0a20 2020 2063 6f6e  ne2*ne3..    con
+0005c830: 7374 2069 6e74 206e 6230 203d 2073 7263  st int nb0 = src
+0005c840: 302d 3e6e 625b 305d 3b0a 2020 2020 636f  0->nb[0];.    co
+0005c850: 6e73 7420 696e 7420 6e62 3120 3d20 7372  nst int nb1 = sr
+0005c860: 6330 2d3e 6e62 5b31 5d3b 0a20 2020 2063  c0->nb[1];.    c
+0005c870: 6f6e 7374 2069 6e74 206e 6232 203d 2073  onst int nb2 = s
+0005c880: 7263 302d 3e6e 625b 325d 3b0a 2020 2020  rc0->nb[2];.    
+0005c890: 2f2f 636f 6e73 7420 696e 7420 6e62 3320  //const int nb3 
+0005c8a0: 3d20 7372 6330 2d3e 6e62 5b33 5d3b 0a0a  = src0->nb[3];..
+0005c8b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0005c8c0: 6e62 3020 3d3d 2073 697a 656f 6628 6767  nb0 == sizeof(gg
+0005c8d0: 6d6c 5f66 7031 365f 7429 293b 0a20 2020  ml_fp16_t));.   
+0005c8e0: 2047 474d 4c5f 4153 5345 5254 286e 6531   GGML_ASSERT(ne1
+0005c8f0: 202b 206e 5f70 6173 7420 3d3d 206e 6530   + n_past == ne0
+0005c900: 293b 2028 766f 6964 2920 6e5f 7061 7374  ); (void) n_past
+0005c910: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0005c920: 5428 6e5f 6865 6164 203d 3d20 6e65 3229  T(n_head == ne2)
+0005c930: 3b0a 0a20 2020 202f 2f20 6164 6420 616c  ;..    // add al
+0005c940: 6962 6920 746f 2073 7263 3020 284b 515f  ibi to src0 (KQ_
+0005c950: 7363 616c 6564 290a 2020 2020 636f 6e73  scaled).    cons
+0005c960: 7420 696e 7420 6e5f 6865 6164 735f 6c6f  t int n_heads_lo
+0005c970: 6732 5f66 6c6f 6f72 203d 2031 203c 3c20  g2_floor = 1 << 
+0005c980: 2869 6e74 2920 666c 6f6f 7228 6c6f 6732  (int) floor(log2
+0005c990: 286e 5f68 6561 6429 293b 0a0a 2020 2020  (n_head));..    
+0005c9a0: 636f 6e73 7420 666c 6f61 7420 6d30 203d  const float m0 =
+0005c9b0: 2070 6f77 6628 322e 3066 2c20 2d28 6d61   powf(2.0f, -(ma
+0005c9c0: 785f 6269 6173 2920 2f20 6e5f 6865 6164  x_bias) / n_head
+0005c9d0: 735f 6c6f 6732 5f66 6c6f 6f72 293b 0a20  s_log2_floor);. 
+0005c9e0: 2020 2063 6f6e 7374 2066 6c6f 6174 206d     const float m
+0005c9f0: 3120 3d20 706f 7766 2832 2e30 662c 202d  1 = powf(2.0f, -
+0005ca00: 286d 6178 5f62 6961 7320 2f20 322e 3066  (max_bias / 2.0f
+0005ca10: 2920 2f20 6e5f 6865 6164 735f 6c6f 6732  ) / n_heads_log2
+0005ca20: 5f66 6c6f 6f72 293b 0a0a 2020 2020 666f  _floor);..    fo
+0005ca30: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+0005ca40: 3c20 6e65 303b 2069 2b2b 2920 7b0a 2020  < ne0; i++) {.  
+0005ca50: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+0005ca60: 203d 2030 3b20 6a20 3c20 6e65 313b 206a   = 0; j < ne1; j
+0005ca70: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005ca80: 2020 666f 7220 2869 6e74 206b 203d 2030    for (int k = 0
+0005ca90: 3b20 6b20 3c20 6e65 325f 6e65 333b 206b  ; k < ne2_ne3; k
+0005caa0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005cab0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
+0005cac0: 7420 2a20 636f 6e73 7420 7372 6320 203d  t * const src  =
+0005cad0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+0005cae0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+0005caf0: 6461 7461 202b 2069 2a6e 6230 202b 206a  data + i*nb0 + j
+0005cb00: 2a6e 6231 202b 206b 2a6e 6232 293b 0a20  *nb1 + k*nb2);. 
+0005cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cb20: 2020 2020 2066 6c6f 6174 202a 2020 2020       float *    
+0005cb30: 2020 7064 7374 2020 3d20 2020 2020 2020    pdst  =       
+0005cb40: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
+0005cb50: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
+0005cb60: 692a 6e62 3020 2b20 6a2a 6e62 3120 2b20  i*nb0 + j*nb1 + 
+0005cb70: 6b2a 6e62 3229 3b0a 0a20 2020 2020 2020  k*nb2);..       
+0005cb80: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
+0005cb90: 3a20 6b2a 6e62 3220 6f72 206b 2a6e 6233  : k*nb2 or k*nb3
+0005cba0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005cbb0: 2020 666c 6f61 7420 6d5f 6b3b 0a0a 2020    float m_k;..  
+0005cbc0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0005cbd0: 2028 6b20 3c20 6e5f 6865 6164 735f 6c6f   (k < n_heads_lo
+0005cbe0: 6732 5f66 6c6f 6f72 2920 7b0a 2020 2020  g2_floor) {.    
+0005cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cc00: 6d5f 6b20 3d20 706f 7766 286d 302c 206b  m_k = powf(m0, k
+0005cc10: 202b 2031 293b 0a20 2020 2020 2020 2020   + 1);.         
+0005cc20: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
+0005cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005cc40: 2020 2020 6d5f 6b20 3d20 706f 7766 286d      m_k = powf(m
+0005cc50: 312c 2032 202a 2028 6b20 2d20 6e5f 6865  1, 2 * (k - n_he
+0005cc60: 6164 735f 6c6f 6732 5f66 6c6f 6f72 2920  ads_log2_floor) 
+0005cc70: 2b20 3129 3b0a 2020 2020 2020 2020 2020  + 1);.          
+0005cc80: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0005cc90: 2020 2020 2020 2020 202f 2f20 7765 2072           // we r
+0005cca0: 6574 7572 6e20 4633 320a 2020 2020 2020  eturn F32.      
+0005ccb0: 2020 2020 2020 2020 2020 7064 7374 5b30            pdst[0
+0005ccc0: 5d20 3d20 6920 2a20 6d5f 6b20 2b20 4747  ] = i * m_k + GG
+0005ccd0: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+0005cce0: 7372 635b 305d 293b 0a20 2020 2020 2020  src[0]);.       
+0005ccf0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+0005cd00: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+0005cd10: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0005cd20: 7465 5f66 6f72 7761 7264 5f61 6c69 6269  te_forward_alibi
+0005cd30: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+0005cd40: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+0005cd50: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+0005cd60: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+0005cd70: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0005cd80: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+0005cd90: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0005cda0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0005cdb0: 2073 7263 312c 0a20 2020 2020 2020 2073   src1,.        s
+0005cdc0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005cdd0: 7220 2a20 6473 7429 207b 0a20 2020 2073  r * dst) {.    s
+0005cde0: 7769 7463 6820 2873 7263 302d 3e74 7970  witch (src0->typ
+0005cdf0: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+0005ce00: 6520 4747 4d4c 5f54 5950 455f 4631 363a  e GGML_TYPE_F16:
+0005ce10: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0005ce20: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0005ce30: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0005ce40: 6172 645f 616c 6962 695f 6631 3628 7061  ard_alibi_f16(pa
+0005ce50: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
+0005ce60: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
+0005ce70: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0005ce80: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0005ce90: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
+0005cea0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0005ceb0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+0005cec0: 7574 655f 666f 7277 6172 645f 616c 6962  ute_forward_alib
+0005ced0: 695f 6633 3228 7061 7261 6d73 2c20 7372  i_f32(params, sr
+0005cee0: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
+0005cef0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0005cf00: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0005cf10: 6520 4747 4d4c 5f54 5950 455f 5134 5f30  e GGML_TYPE_Q4_0
+0005cf20: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+0005cf30: 474d 4c5f 5459 5045 5f51 345f 313a 0a20  GML_TYPE_Q4_1:. 
+0005cf40: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0005cf50: 5f54 5950 455f 5135 5f30 3a0a 2020 2020  _TYPE_Q5_0:.    
+0005cf60: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0005cf70: 5045 5f51 355f 313a 0a20 2020 2020 2020  PE_Q5_1:.       
+0005cf80: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0005cf90: 5138 5f30 3a0a 2020 2020 2020 2020 6361  Q8_0:.        ca
+0005cfa0: 7365 2047 474d 4c5f 5459 5045 5f51 385f  se GGML_TYPE_Q8_
+0005cfb0: 313a 0a20 2020 2020 2020 2063 6173 6520  1:.        case 
+0005cfc0: 4747 4d4c 5f54 5950 455f 5132 5f4b 3a0a  GGML_TYPE_Q2_K:.
+0005cfd0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0005cfe0: 4c5f 5459 5045 5f51 335f 4b3a 0a20 2020  L_TYPE_Q3_K:.   
+0005cff0: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0005d000: 5950 455f 5134 5f4b 3a0a 2020 2020 2020  YPE_Q4_K:.      
+0005d010: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0005d020: 5f51 355f 4b3a 0a20 2020 2020 2020 2063  _Q5_K:.        c
+0005d030: 6173 6520 4747 4d4c 5f54 5950 455f 5136  ase GGML_TYPE_Q6
+0005d040: 5f4b 3a0a 2020 2020 2020 2020 6361 7365  _K:.        case
+0005d050: 2047 474d 4c5f 5459 5045 5f51 385f 4b3a   GGML_TYPE_Q8_K:
+0005d060: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0005d070: 4d4c 5f54 5950 455f 4938 3a0a 2020 2020  ML_TYPE_I8:.    
+0005d080: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0005d090: 5045 5f49 3136 3a0a 2020 2020 2020 2020  PE_I16:.        
+0005d0a0: 6361 7365 2047 474d 4c5f 5459 5045 5f49  case GGML_TYPE_I
+0005d0b0: 3332 3a0a 2020 2020 2020 2020 6361 7365  32:.        case
+0005d0c0: 2047 474d 4c5f 5459 5045 5f43 4f55 4e54   GGML_TYPE_COUNT
+0005d0d0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0005d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005d0f0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0005d100: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+0005d110: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+0005d120: 0a0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  ...// ggml_compu
+0005d130: 7465 5f66 6f72 7761 7264 5f63 6c61 6d70  te_forward_clamp
+0005d140: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
+0005d150: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0005d160: 7264 5f63 6c61 6d70 5f66 3332 280a 2020  rd_clamp_f32(.  
+0005d170: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0005d180: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0005d190: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0005d1a0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0005d1b0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005d1c0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0005d1d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0005d1e0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0005d1f0: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+0005d200: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0005d210: 6473 7429 207b 0a20 2020 2061 7373 6572  dst) {.    asser
+0005d220: 7428 7061 7261 6d73 2d3e 6974 6820 3d3d  t(params->ith ==
+0005d230: 2030 293b 0a0a 2020 2020 4747 4d4c 5f41   0);..    GGML_A
+0005d240: 5353 4552 5428 7372 6331 2d3e 7479 7065  SSERT(src1->type
+0005d250: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
+0005d260: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
+0005d270: 4552 5428 6767 6d6c 5f6e 656c 656d 656e  ERT(ggml_nelemen
+0005d280: 7473 2873 7263 3129 203d 3d20 3229 3b0a  ts(src1) == 2);.
+0005d290: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+0005d2a0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0005d2b0: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+0005d2c0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0005d2d0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+0005d2e0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+0005d2f0: 0a20 2020 207d 0a0a 2020 2020 636f 6e73  .    }..    cons
+0005d300: 7420 666c 6f61 7420 6d69 6e20 3d20 2828  t float min = ((
+0005d310: 666c 6f61 7420 2a29 2073 7263 312d 3e64  float *) src1->d
+0005d320: 6174 6129 5b30 5d3b 0a20 2020 2063 6f6e  ata)[0];.    con
+0005d330: 7374 2066 6c6f 6174 206d 6178 203d 2028  st float max = (
+0005d340: 2866 6c6f 6174 202a 2920 7372 6331 2d3e  (float *) src1->
+0005d350: 6461 7461 295b 315d 3b0a 0a20 2020 2063  data)[1];..    c
+0005d360: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
+0005d370: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
+0005d380: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
+0005d390: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
+0005d3a0: 2020 636f 6e73 7420 696e 7420 6e20 203d    const int n  =
+0005d3b0: 2067 676d 6c5f 6e72 6f77 7328 7372 6330   ggml_nrows(src0
+0005d3c0: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
+0005d3d0: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
+0005d3e0: 5d3b 0a0a 2020 2020 636f 6e73 7420 7369  ];..    const si
+0005d3f0: 7a65 5f74 206e 6230 3020 3d20 7372 6330  ze_t nb00 = src0
+0005d400: 2d3e 6e62 5b30 5d3b 0a20 2020 2063 6f6e  ->nb[0];.    con
+0005d410: 7374 2073 697a 655f 7420 6e62 3031 203d  st size_t nb01 =
+0005d420: 2073 7263 302d 3e6e 625b 315d 3b0a 0a20   src0->nb[1];.. 
+0005d430: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
+0005d440: 6e62 3020 3d20 6473 742d 3e6e 625b 305d  nb0 = dst->nb[0]
+0005d450: 3b0a 2020 2020 636f 6e73 7420 7369 7a65  ;.    const size
+0005d460: 5f74 206e 6231 203d 2064 7374 2d3e 6e62  _t nb1 = dst->nb
+0005d470: 5b31 5d3b 0a0a 2020 2020 4747 4d4c 5f41  [1];..    GGML_A
+0005d480: 5353 4552 5428 206e 6230 203d 3d20 7369  SSERT( nb0 == si
+0005d490: 7a65 6f66 2866 6c6f 6174 2929 3b0a 2020  zeof(float));.  
+0005d4a0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0005d4b0: 3030 203d 3d20 7369 7a65 6f66 2866 6c6f  00 == sizeof(flo
+0005d4c0: 6174 2929 3b0a 0a20 2020 2066 6f72 2028  at));..    for (
+0005d4d0: 696e 7420 6a20 3d20 6974 683b 206a 203c  int j = ith; j <
+0005d4e0: 206e 3b20 6a20 2b3d 206e 7468 2920 7b0a   n; j += nth) {.
+0005d4f0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+0005d500: 6473 745f 7074 7220 203d 2028 666c 6f61  dst_ptr  = (floa
+0005d510: 7420 2a29 2028 2863 6861 7220 2a29 2020  t *) ((char *)  
+0005d520: 6473 742d 3e64 6174 6120 2b20 6a2a 6e62  dst->data + j*nb
+0005d530: 3129 3b0a 2020 2020 2020 2020 666c 6f61  1);.        floa
+0005d540: 7420 2a20 7372 6330 5f70 7472 203d 2028  t * src0_ptr = (
+0005d550: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+0005d560: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+0005d570: 6a2a 6e62 3031 293b 0a0a 2020 2020 2020  j*nb01);..      
+0005d580: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0005d590: 3b20 6920 3c20 6e63 3b20 692b 2b29 207b  ; i < nc; i++) {
+0005d5a0: 0a20 2020 2020 2020 2020 2020 2064 7374  .            dst
+0005d5b0: 5f70 7472 5b69 5d20 3d20 4d41 5828 4d49  _ptr[i] = MAX(MI
+0005d5c0: 4e28 7372 6330 5f70 7472 5b69 5d2c 206d  N(src0_ptr[i], m
+0005d5d0: 6178 292c 206d 696e 293b 0a20 2020 2020  ax), min);.     
+0005d5e0: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+0005d5f0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+0005d600: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+0005d610: 6c61 6d70 280a 2020 2020 2020 2020 636f  lamp(.        co
+0005d620: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0005d630: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+0005d640: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+0005d650: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0005d660: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+0005d670: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+0005d680: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005d690: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+0005d6a0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0005d6b0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+0005d6c0: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+0005d6d0: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+0005d6e0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0005d6f0: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
+0005d700: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0005d710: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+0005d720: 666f 7277 6172 645f 636c 616d 705f 6633  forward_clamp_f3
+0005d730: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+0005d740: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+0005d750: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0005d760: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0005d770: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
+0005d780: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0005d790: 5950 455f 5134 5f30 3a0a 2020 2020 2020  YPE_Q4_0:.      
+0005d7a0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+0005d7b0: 5f51 345f 313a 0a20 2020 2020 2020 2063  _Q4_1:.        c
+0005d7c0: 6173 6520 4747 4d4c 5f54 5950 455f 5135  ase GGML_TYPE_Q5
+0005d7d0: 5f30 3a0a 2020 2020 2020 2020 6361 7365  _0:.        case
+0005d7e0: 2047 474d 4c5f 5459 5045 5f51 355f 313a   GGML_TYPE_Q5_1:
+0005d7f0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0005d800: 4d4c 5f54 5950 455f 5138 5f30 3a0a 2020  ML_TYPE_Q8_0:.  
+0005d810: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0005d820: 5459 5045 5f51 385f 313a 0a20 2020 2020  TYPE_Q8_1:.     
+0005d830: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
+0005d840: 455f 5132 5f4b 3a0a 2020 2020 2020 2020  E_Q2_K:.        
+0005d850: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+0005d860: 335f 4b3a 0a20 2020 2020 2020 2063 6173  3_K:.        cas
+0005d870: 6520 4747 4d4c 5f54 5950 455f 5134 5f4b  e GGML_TYPE_Q4_K
+0005d880: 3a0a 2020 2020 2020 2020 6361 7365 2047  :.        case G
+0005d890: 474d 4c5f 5459 5045 5f51 355f 4b3a 0a20  GML_TYPE_Q5_K:. 
+0005d8a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0005d8b0: 5f54 5950 455f 5136 5f4b 3a0a 2020 2020  _TYPE_Q6_K:.    
+0005d8c0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0005d8d0: 5045 5f51 385f 4b3a 0a20 2020 2020 2020  PE_Q8_K:.       
+0005d8e0: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+0005d8f0: 4938 3a0a 2020 2020 2020 2020 6361 7365  I8:.        case
+0005d900: 2047 474d 4c5f 5459 5045 5f49 3136 3a0a   GGML_TYPE_I16:.
+0005d910: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0005d920: 4c5f 5459 5045 5f49 3332 3a0a 2020 2020  L_TYPE_I32:.    
+0005d930: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0005d940: 5045 5f43 4f55 4e54 3a0a 2020 2020 2020  PE_COUNT:.      
+0005d950: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0005d960: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0005d970: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
+0005d980: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0005d990: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
+0005d9a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0005d9b0: 645f 726f 7065 0a0a 7374 6174 6963 2076  d_rope..static v
+0005d9c0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+0005d9d0: 5f66 6f72 7761 7264 5f72 6f70 655f 6633  _forward_rope_f3
+0005d9e0: 3228 0a20 2020 2020 2020 2063 6f6e 7374  2(.        const
+0005d9f0: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
+0005da00: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
+0005da10: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
+0005da20: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0005da30: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
+0005da40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0005da50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0005da60: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
+0005da70: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0005da80: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+0005da90: 4747 4d4c 5f41 5353 4552 5428 7372 6331  GGML_ASSERT(src1
+0005daa0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0005dab0: 5950 455f 4933 3229 3b0a 2020 2020 4747  YPE_I32);.    GG
+0005dac0: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f6e  ML_ASSERT(ggml_n
+0005dad0: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
+0005dae0: 3d20 3429 3b0a 0a20 2020 2069 6620 2870  = 4);..    if (p
+0005daf0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+0005db00: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+0005db10: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+0005db20: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+0005db30: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+0005db40: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+0005db50: 2020 636f 6e73 7420 696e 7420 6e5f 7061    const int n_pa
+0005db60: 7374 203d 2028 2869 6e74 3332 5f74 202a  st = ((int32_t *
+0005db70: 2920 7372 6331 2d3e 6461 7461 295b 305d  ) src1->data)[0]
+0005db80: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
+0005db90: 6e5f 6469 6d73 203d 2028 2869 6e74 3332  n_dims = ((int32
+0005dba0: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+0005dbb0: 295b 315d 3b0a 2020 2020 636f 6e73 7420  )[1];.    const 
+0005dbc0: 696e 7420 6d6f 6465 2020 203d 2028 2869  int mode   = ((i
+0005dbd0: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
+0005dbe0: 6461 7461 295b 325d 3b0a 2020 2020 636f  data)[2];.    co
+0005dbf0: 6e73 7420 696e 7420 6e5f 6374 7820 203d  nst int n_ctx  =
+0005dc00: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
+0005dc10: 6331 2d3e 6461 7461 295b 335d 3b0a 0a20  c1->data)[3];.. 
+0005dc20: 2020 2061 7373 6572 7428 6e5f 7061 7374     assert(n_past
+0005dc30: 203e 3d20 3029 3b0a 0a20 2020 2047 474d   >= 0);..    GGM
+0005dc40: 4c5f 5445 4e53 4f52 5f55 4e41 5259 5f4f  L_TENSOR_UNARY_O
+0005dc50: 505f 4c4f 4341 4c53 3b0a 0a20 2020 202f  P_LOCALS;..    /
+0005dc60: 2f70 7269 6e74 6628 226e 6530 3a20 2564  /printf("ne0: %d
+0005dc70: 2c20 6e65 313a 2025 642c 206e 6532 3a20  , ne1: %d, ne2: 
+0005dc80: 2564 2c20 6e65 333a 2025 645c 6e22 2c20  %d, ne3: %d\n", 
+0005dc90: 6e65 302c 206e 6531 2c20 6e65 322c 206e  ne0, ne1, ne2, n
+0005dca0: 6533 293b 0a20 2020 202f 2f70 7269 6e74  e3);.    //print
+0005dcb0: 6628 226e 5f70 6173 7420 3d20 2564 2c20  f("n_past = %d, 
+0005dcc0: 6e65 3220 3d20 2564 5c6e 222c 206e 5f70  ne2 = %d\n", n_p
+0005dcd0: 6173 742c 206e 6532 293b 0a0a 2020 2020  ast, ne2);..    
+0005dce0: 4747 4d4c 5f41 5353 4552 5428 6e62 3030  GGML_ASSERT(nb00
+0005dcf0: 203d 3d20 7369 7a65 6f66 2866 6c6f 6174   == sizeof(float
+0005dd00: 2929 3b0a 0a20 2020 2063 6f6e 7374 2069  ));..    const i
+0005dd10: 6e74 2069 7468 203d 2070 6172 616d 732d  nt ith = params-
+0005dd20: 3e69 7468 3b0a 2020 2020 636f 6e73 7420  >ith;.    const 
+0005dd30: 696e 7420 6e74 6820 3d20 7061 7261 6d73  int nth = params
+0005dd40: 2d3e 6e74 683b 0a0a 2020 2020 636f 6e73  ->nth;..    cons
+0005dd50: 7420 696e 7420 6e72 203d 2067 676d 6c5f  t int nr = ggml_
+0005dd60: 6e72 6f77 7328 6473 7429 3b0a 0a20 2020  nrows(dst);..   
+0005dd70: 2047 474d 4c5f 4153 5345 5254 286e 5f64   GGML_ASSERT(n_d
+0005dd80: 696d 7320 3c3d 206e 6530 293b 0a20 2020  ims <= ne0);.   
+0005dd90: 2047 474d 4c5f 4153 5345 5254 286e 5f64   GGML_ASSERT(n_d
+0005dda0: 696d 7320 2520 3220 3d3d 2030 293b 0a0a  ims % 2 == 0);..
+0005ddb0: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
+0005ddc0: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+0005ddd0: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
+0005dde0: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
+0005ddf0: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+0005de00: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+0005de10: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+0005de20: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
+0005de30: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
+0005de40: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
+0005de50: 293b 0a0a 2020 2020 2f2f 2072 6f77 2069  );..    // row i
+0005de60: 6e64 6578 2075 7365 6420 746f 2064 6574  ndex used to det
+0005de70: 6572 6d69 6e65 2077 6869 6368 2074 6872  ermine which thr
+0005de80: 6561 6420 746f 2075 7365 0a20 2020 2069  ead to use.    i
+0005de90: 6e74 2069 7220 3d20 303b 0a0a 2020 2020  nt ir = 0;..    
+0005dea0: 636f 6e73 7420 666c 6f61 7420 7468 6574  const float thet
+0005deb0: 615f 7363 616c 6520 3d20 706f 7766 2831  a_scale = powf(1
+0005dec0: 3030 3030 2e30 2c20 2d32 2e30 662f 6e5f  0000.0, -2.0f/n_
+0005ded0: 6469 6d73 293b 0a0a 2020 2020 636f 6e73  dims);..    cons
+0005dee0: 7420 626f 6f6c 2069 735f 6e65 6f78 203d  t bool is_neox =
+0005def0: 206d 6f64 6520 2620 323b 0a20 2020 2063   mode & 2;.    c
+0005df00: 6f6e 7374 2062 6f6f 6c20 6973 5f67 6c6d  onst bool is_glm
+0005df10: 2020 3d20 6d6f 6465 2026 2034 3b0a 0a20    = mode & 4;.. 
+0005df20: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+0005df30: 6933 203d 2030 3b20 6933 203c 206e 6533  i3 = 0; i3 < ne3
+0005df40: 3b20 6933 2b2b 2920 7b0a 2020 2020 2020  ; i3++) {.      
+0005df50: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0005df60: 3220 3d20 2828 6d6f 6465 2026 2031 2920  2 = ((mode & 1) 
+0005df70: 3d3d 2030 203f 2030 203a 206e 5f70 6173  == 0 ? 0 : n_pas
+0005df80: 7429 3b20 6932 203c 206e 6532 3b20 6932  t); i2 < ne2; i2
+0005df90: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005dfa0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0005dfb0: 7020 3d20 2828 6d6f 6465 2026 2031 2920  p = ((mode & 1) 
+0005dfc0: 3d3d 2030 203f 206e 5f70 6173 7420 2b20  == 0 ? n_past + 
+0005dfd0: 6932 203a 2069 3229 3b0a 2020 2020 2020  i2 : i2);.      
+0005dfe0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0005dff0: 5f74 2069 3120 3d20 303b 2069 3120 3c20  _t i1 = 0; i1 < 
+0005e000: 6e65 313b 2069 312b 2b29 207b 0a20 2020  ne1; i1++) {.   
+0005e010: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0005e020: 2869 722b 2b20 3c20 6972 3029 2063 6f6e  (ir++ < ir0) con
+0005e030: 7469 6e75 653b 0a20 2020 2020 2020 2020  tinue;.         
+0005e040: 2020 2020 2020 2069 6620 2869 7220 2020         if (ir   
+0005e050: 3e20 6972 3129 2062 7265 616b 3b0a 0a20  > ir1) break;.. 
+0005e060: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0005e070: 6c6f 6174 2074 6865 7461 203d 2028 666c  loat theta = (fl
+0005e080: 6f61 7429 703b 0a0a 2020 2020 2020 2020  oat)p;..        
+0005e090: 2020 2020 2020 2020 6966 2028 6973 5f67          if (is_g
+0005e0a0: 6c6d 2920 7b0a 2020 2020 2020 2020 2020  lm) {.          
+0005e0b0: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
+0005e0c0: 3d20 4d49 4e28 702c 206e 5f63 7478 202d  = MIN(p, n_ctx -
+0005e0d0: 2032 293b 0a20 2020 2020 2020 2020 2020   2);.           
+0005e0e0: 2020 2020 2020 2020 2066 6c6f 6174 2062           float b
+0005e0f0: 6c6f 636b 5f74 6865 7461 203d 204d 4158  lock_theta = MAX
+0005e100: 2870 202d 2028 6e5f 6374 7820 2d20 3229  (p - (n_ctx - 2)
+0005e110: 2c20 3029 3b0a 2020 2020 2020 2020 2020  , 0);.          
+0005e120: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0005e130: 6e74 3634 5f74 2069 3020 3d20 303b 2069  nt64_t i0 = 0; i
+0005e140: 3020 3c20 6e65 3020 2f20 343b 2069 302b  0 < ne0 / 4; i0+
+0005e150: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0005e160: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005e170: 7374 2066 6c6f 6174 2063 6f73 5f74 6865  st float cos_the
+0005e180: 7461 203d 2063 6f73 6628 7468 6574 6129  ta = cosf(theta)
+0005e190: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005e1a0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005e1b0: 666c 6f61 7420 7369 6e5f 7468 6574 6120  float sin_theta 
+0005e1c0: 3d20 7369 6e66 2874 6865 7461 293b 0a20  = sinf(theta);. 
+0005e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e1e0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0005e1f0: 6174 2063 6f73 5f62 6c6f 636b 5f74 6865  at cos_block_the
+0005e200: 7461 203d 2063 6f73 6628 626c 6f63 6b5f  ta = cosf(block_
+0005e210: 7468 6574 6129 3b0a 2020 2020 2020 2020  theta);.        
+0005e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e230: 636f 6e73 7420 666c 6f61 7420 7369 6e5f  const float sin_
+0005e240: 626c 6f63 6b5f 7468 6574 6120 3d20 7369  block_theta = si
+0005e250: 6e66 2862 6c6f 636b 5f74 6865 7461 293b  nf(block_theta);
+0005e260: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005e270: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
+0005e280: 2a3d 2074 6865 7461 5f73 6361 6c65 3b0a  *= theta_scale;.
+0005e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e2a0: 2020 2020 2020 2020 626c 6f63 6b5f 7468          block_th
+0005e2b0: 6574 6120 2a3d 2074 6865 7461 5f73 6361  eta *= theta_sca
+0005e2c0: 6c65 3b0a 0a20 2020 2020 2020 2020 2020  le;..           
+0005e2d0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005e2e0: 7374 2066 6c6f 6174 202a 2063 6f6e 7374  st float * const
+0005e2f0: 2073 7263 203d 2028 666c 6f61 7420 2a29   src = (float *)
+0005e300: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+0005e310: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
+0005e320: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
+0005e330: 3031 202b 2069 302a 6e62 3030 293b 0a20  01 + i0*nb00);. 
+0005e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e350: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+0005e360: 6174 202a 2064 7374 5f64 6174 6120 203d  at * dst_data  =
+0005e370: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+0005e380: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+0005e390: 2020 6933 2a6e 6233 202b 2069 322a 6e62    i3*nb3 + i2*nb
+0005e3a0: 3220 202b 2069 312a 6e62 3120 202b 2069  2  + i1*nb1  + i
+0005e3b0: 302a 6e62 3029 3b0a 0a20 2020 2020 2020  0*nb0);..       
+0005e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e3d0: 2063 6f6e 7374 2066 6c6f 6174 2078 3020   const float x0 
+0005e3e0: 3d20 7372 635b 305d 3b0a 2020 2020 2020  = src[0];.      
+0005e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e400: 2020 636f 6e73 7420 666c 6f61 7420 7831    const float x1
+0005e410: 203d 2073 7263 5b6e 5f64 696d 732f 325d   = src[n_dims/2]
+0005e420: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005e430: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005e440: 666c 6f61 7420 7832 203d 2073 7263 5b6e  float x2 = src[n
+0005e450: 5f64 696d 735d 3b0a 2020 2020 2020 2020  _dims];.        
+0005e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e470: 636f 6e73 7420 666c 6f61 7420 7833 203d  const float x3 =
+0005e480: 2073 7263 5b6e 5f64 696d 732f 322a 335d   src[n_dims/2*3]
+0005e490: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0005e4a0: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+0005e4b0: 6174 615b 305d 2020 2020 2020 2020 2020  ata[0]          
+0005e4c0: 3d20 7830 2a63 6f73 5f74 6865 7461 202d  = x0*cos_theta -
+0005e4d0: 2078 312a 7369 6e5f 7468 6574 613b 0a20   x1*sin_theta;. 
+0005e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e4f0: 2020 2020 2020 2064 7374 5f64 6174 615b         dst_data[
+0005e500: 6e5f 6469 6d73 2f32 5d20 2020 3d20 7830  n_dims/2]   = x0
+0005e510: 2a73 696e 5f74 6865 7461 202b 2078 312a  *sin_theta + x1*
+0005e520: 636f 735f 7468 6574 613b 0a20 2020 2020  cos_theta;.     
+0005e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e540: 2020 2064 7374 5f64 6174 615b 6e5f 6469     dst_data[n_di
+0005e550: 6d73 5d20 2020 2020 3d20 7832 2a63 6f73  ms]     = x2*cos
+0005e560: 5f62 6c6f 636b 5f74 6865 7461 202d 2078  _block_theta - x
+0005e570: 332a 7369 6e5f 626c 6f63 6b5f 7468 6574  3*sin_block_thet
+0005e580: 613b 0a20 2020 2020 2020 2020 2020 2020  a;.             
+0005e590: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+0005e5a0: 6174 615b 6e5f 6469 6d73 2f32 2a33 5d20  ata[n_dims/2*3] 
+0005e5b0: 3d20 7832 2a73 696e 5f62 6c6f 636b 5f74  = x2*sin_block_t
+0005e5c0: 6865 7461 202b 2078 332a 636f 735f 626c  heta + x3*cos_bl
+0005e5d0: 6f63 6b5f 7468 6574 613b 0a20 2020 2020  ock_theta;.     
+0005e5e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0005e5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005e600: 207d 2065 6c73 6520 6966 2028 2169 735f   } else if (!is_
+0005e610: 6e65 6f78 2920 7b0a 2020 2020 2020 2020  neox) {.        
+0005e620: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0005e630: 2869 6e74 3634 5f74 2069 3020 3d20 303b  (int64_t i0 = 0;
+0005e640: 2069 3020 3c20 6e65 303b 2069 3020 2b3d   i0 < ne0; i0 +=
+0005e650: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
+0005e660: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0005e670: 6e73 7420 666c 6f61 7420 636f 735f 7468  nst float cos_th
+0005e680: 6574 6120 3d20 636f 7366 2874 6865 7461  eta = cosf(theta
+0005e690: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0005e6a0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005e6b0: 2066 6c6f 6174 2073 696e 5f74 6865 7461   float sin_theta
+0005e6c0: 203d 2073 696e 6628 7468 6574 6129 3b0a   = sinf(theta);.
+0005e6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005e6e0: 2020 2020 2020 2020 2074 6865 7461 202a           theta *
+0005e6f0: 3d20 7468 6574 615f 7363 616c 653b 0a0a  = theta_scale;..
 0005e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e710: 2f2f 2072 6566 3a20 2068 7474 7073 3a2f  // ref:  https:/
-0005e720: 2f67 6974 6875 622e 636f 6d2f 6875 6767  /github.com/hugg
-0005e730: 696e 6766 6163 652f 7472 616e 7366 6f72  ingface/transfor
-0005e740: 6d65 7273 2f62 6c6f 622f 6d61 696e 2f73  mers/blob/main/s
-0005e750: 7263 2f74 7261 6e73 666f 726d 6572 732f  rc/transformers/
-0005e760: 6d6f 6465 6c73 2f67 7074 5f6e 656f 782f  models/gpt_neox/
-0005e770: 6d6f 6465 6c69 6e67 5f67 7074 5f6e 656f  modeling_gpt_neo
-0005e780: 782e 7079 234c 4c32 3531 4331 2d4c 3239  x.py#LL251C1-L29
-0005e790: 3443 3238 0a20 2020 2020 2020 2020 2020  4C28.           
-0005e7a0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0005e7b0: 7436 345f 7420 6962 203d 2030 3b20 6962  t64_t ib = 0; ib
-0005e7c0: 203c 206e 6530 2f6e 5f64 696d 733b 202b   < ne0/n_dims; +
-0005e7d0: 2b69 6229 207b 0a20 2020 2020 2020 2020  +ib) {.         
-0005e7e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0005e7f0: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
-0005e800: 2030 3b20 6963 203c 206e 5f64 696d 733b   0; ic < n_dims;
-0005e810: 2069 6320 2b3d 2032 2920 7b0a 2020 2020   ic += 2) {.    
-0005e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e830: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005e840: 6f61 7420 636f 735f 7468 6574 6120 3d20  oat cos_theta = 
-0005e850: 636f 7366 2874 6865 7461 293b 0a20 2020  cosf(theta);.   
-0005e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e870: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0005e880: 6c6f 6174 2073 696e 5f74 6865 7461 203d  loat sin_theta =
-0005e890: 2073 696e 6628 7468 6574 6129 3b0a 0a20   sinf(theta);.. 
+0005e710: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+0005e720: 6f61 7420 2a20 636f 6e73 7420 7372 6320  oat * const src 
+0005e730: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
+0005e740: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+0005e750: 2b20 6933 2a6e 6230 3320 2b20 6932 2a6e  + i3*nb03 + i2*n
+0005e760: 6230 3220 2b20 6931 2a6e 6230 3120 2b20  b02 + i1*nb01 + 
+0005e770: 6930 2a6e 6230 3029 3b0a 2020 2020 2020  i0*nb00);.      
+0005e780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e790: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+0005e7a0: 6473 745f 6461 7461 2020 3d20 2866 6c6f  dst_data  = (flo
+0005e7b0: 6174 202a 2928 2863 6861 7220 2a29 2020  at *)((char *)  
+0005e7c0: 6473 742d 3e64 6174 6120 2b20 6933 2a6e  dst->data + i3*n
+0005e7d0: 6233 2020 2b20 6932 2a6e 6232 2020 2b20  b3  + i2*nb2  + 
+0005e7e0: 6931 2a6e 6231 2020 2b20 6930 2a6e 6230  i1*nb1  + i0*nb0
+0005e7f0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0005e800: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0005e810: 7420 666c 6f61 7420 7830 203d 2073 7263  t float x0 = src
+0005e820: 5b30 5d3b 0a20 2020 2020 2020 2020 2020  [0];.           
+0005e830: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005e840: 7374 2066 6c6f 6174 2078 3120 3d20 7372  st float x1 = sr
+0005e850: 635b 315d 3b0a 0a20 2020 2020 2020 2020  c[1];..         
+0005e860: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0005e870: 7374 5f64 6174 615b 305d 203d 2078 302a  st_data[0] = x0*
+0005e880: 636f 735f 7468 6574 6120 2d20 7831 2a73  cos_theta - x1*s
+0005e890: 696e 5f74 6865 7461 3b0a 2020 2020 2020  in_theta;.      
 0005e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e8b0: 2020 2020 2020 2020 2020 2074 6865 7461             theta
-0005e8c0: 202a 3d20 7468 6574 615f 7363 616c 653b   *= theta_scale;
-0005e8d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005e8e0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005e8f0: 6e73 7420 696e 7436 345f 7420 6930 203d  nst int64_t i0 =
-0005e900: 2069 622a 6e5f 6469 6d73 202b 2069 632f   ib*n_dims + ic/
-0005e910: 323b 0a0a 2020 2020 2020 2020 2020 2020  2;..            
-0005e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e930: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
-0005e940: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
-0005e950: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
-0005e960: 302d 3e64 6174 6120 2b20 6933 2a6e 6230  0->data + i3*nb0
-0005e970: 3320 2b20 6932 2a6e 6230 3220 2b20 6931  3 + i2*nb02 + i1
-0005e980: 2a6e 6230 3120 2b20 6930 2a6e 6230 3029  *nb01 + i0*nb00)
-0005e990: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0005e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005e9b0: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
-0005e9c0: 6461 7461 2020 3d20 2866 6c6f 6174 202a  data  = (float *
-0005e9d0: 2928 2863 6861 7220 2a29 2020 6473 742d  )((char *)  dst-
-0005e9e0: 3e64 6174 6120 2b20 6933 2a6e 6233 2020  >data + i3*nb3  
-0005e9f0: 2b20 6932 2a6e 6232 2020 2b20 6931 2a6e  + i2*nb2  + i1*n
-0005ea00: 6231 2020 2b20 6930 2a6e 6230 293b 0a0a  b1  + i0*nb0);..
-0005ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ea20: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0005ea30: 7420 666c 6f61 7420 7830 203d 2073 7263  t float x0 = src
-0005ea40: 5b30 5d3b 0a20 2020 2020 2020 2020 2020  [0];.           
-0005ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ea60: 2063 6f6e 7374 2066 6c6f 6174 2078 3120   const float x1 
-0005ea70: 3d20 7372 635b 6e5f 6469 6d73 2f32 5d3b  = src[n_dims/2];
-0005ea80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0005ea90: 2020 2020 2020 2020 2020 2020 2020 6473                ds
-0005eaa0: 745f 6461 7461 5b30 5d20 2020 2020 2020  t_data[0]       
-0005eab0: 203d 2078 302a 636f 735f 7468 6574 6120   = x0*cos_theta 
-0005eac0: 2d20 7831 2a73 696e 5f74 6865 7461 3b0a  - x1*sin_theta;.
-0005ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005eae0: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0005eaf0: 6461 7461 5b6e 5f64 696d 732f 325d 203d  data[n_dims/2] =
-0005eb00: 2078 302a 7369 6e5f 7468 6574 6120 2b20   x0*sin_theta + 
-0005eb10: 7831 2a63 6f73 5f74 6865 7461 3b0a 2020  x1*cos_theta;.  
-0005eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005eb30: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0005eb40: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0005eb50: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0005eb60: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0005eb70: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-0005eb80: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-0005eb90: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0005eba0: 645f 726f 7065 5f66 3136 280a 2020 2020  d_rope_f16(.    
-0005ebb0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0005ebc0: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-0005ebd0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-0005ebe0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0005ebf0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0005ec00: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-0005ec10: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0005ec20: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-0005ec30: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-0005ec40: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-0005ec50: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
-0005ec60: 5345 5254 2873 7263 312d 3e74 7970 6520  SERT(src1->type 
-0005ec70: 3d3d 2047 474d 4c5f 5459 5045 5f49 3332  == GGML_TYPE_I32
-0005ec80: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-0005ec90: 5254 2867 676d 6c5f 6e65 6c65 6d65 6e74  RT(ggml_nelement
-0005eca0: 7328 7372 6331 2920 3d3d 2034 293b 0a0a  s(src1) == 4);..
-0005ecb0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0005ecc0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0005ecd0: 4b5f 494e 4954 207c 7c20 7061 7261 6d73  K_INIT || params
-0005ece0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-0005ecf0: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
-0005ed00: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-0005ed10: 2020 2020 7d0a 0a20 2020 2063 6f6e 7374      }..    const
-0005ed20: 2069 6e74 206e 5f70 6173 7420 3d20 2828   int n_past = ((
-0005ed30: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
-0005ed40: 3e64 6174 6129 5b30 5d3b 0a20 2020 2063  >data)[0];.    c
-0005ed50: 6f6e 7374 2069 6e74 206e 5f64 696d 7320  onst int n_dims 
-0005ed60: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
-0005ed70: 7263 312d 3e64 6174 6129 5b31 5d3b 0a20  rc1->data)[1];. 
-0005ed80: 2020 2063 6f6e 7374 2069 6e74 206d 6f64     const int mod
-0005ed90: 6520 2020 3d20 2828 696e 7433 325f 7420  e   = ((int32_t 
-0005eda0: 2a29 2073 7263 312d 3e64 6174 6129 5b32  *) src1->data)[2
-0005edb0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-0005edc0: 206e 5f63 7478 2020 3d20 2828 696e 7433   n_ctx  = ((int3
-0005edd0: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
-0005ede0: 6129 5b33 5d3b 0a0a 2020 2020 6173 7365  a)[3];..    asse
-0005edf0: 7274 286e 5f70 6173 7420 3e3d 2030 293b  rt(n_past >= 0);
-0005ee00: 0a0a 2020 2020 4747 4d4c 5f54 454e 534f  ..    GGML_TENSO
-0005ee10: 525f 554e 4152 595f 4f50 5f4c 4f43 414c  R_UNARY_OP_LOCAL
-0005ee20: 533b 0a0a 2020 2020 2f2f 7072 696e 7466  S;..    //printf
-0005ee30: 2822 6e65 303a 2025 642c 206e 6531 3a20  ("ne0: %d, ne1: 
-0005ee40: 2564 2c20 6e65 323a 2025 642c 206e 6533  %d, ne2: %d, ne3
-0005ee50: 3a20 2564 5c6e 222c 206e 6530 2c20 6e65  : %d\n", ne0, ne
-0005ee60: 312c 206e 6532 2c20 6e65 3329 3b0a 2020  1, ne2, ne3);.  
-0005ee70: 2020 2f2f 7072 696e 7466 2822 6e5f 7061    //printf("n_pa
-0005ee80: 7374 203d 2025 642c 206e 6532 203d 2025  st = %d, ne2 = %
-0005ee90: 645c 6e22 2c20 6e5f 7061 7374 2c20 6e65  d\n", n_past, ne
-0005eea0: 3229 3b0a 0a20 2020 2047 474d 4c5f 4153  2);..    GGML_AS
-0005eeb0: 5345 5254 286e 6230 203d 3d20 7369 7a65  SERT(nb0 == size
-0005eec0: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
-0005eed0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-0005eee0: 2069 7468 203d 2070 6172 616d 732d 3e69   ith = params->i
-0005eef0: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
-0005ef00: 7420 6e74 6820 3d20 7061 7261 6d73 2d3e  t nth = params->
-0005ef10: 6e74 683b 0a0a 2020 2020 636f 6e73 7420  nth;..    const 
-0005ef20: 696e 7420 6e72 203d 2067 676d 6c5f 6e72  int nr = ggml_nr
-0005ef30: 6f77 7328 6473 7429 3b0a 0a20 2020 2047  ows(dst);..    G
-0005ef40: 474d 4c5f 4153 5345 5254 286e 5f64 696d  GML_ASSERT(n_dim
-0005ef50: 7320 3c3d 206e 6530 293b 0a20 2020 2047  s <= ne0);.    G
-0005ef60: 474d 4c5f 4153 5345 5254 286e 5f64 696d  GML_ASSERT(n_dim
-0005ef70: 7320 2520 3220 3d3d 2030 293b 0a0a 2020  s % 2 == 0);..  
-0005ef80: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
-0005ef90: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-0005efa0: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
-0005efb0: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
-0005efc0: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
-0005efd0: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
-0005efe0: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
-0005eff0: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
-0005f000: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
-0005f010: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
-0005f020: 0a0a 2020 2020 2f2f 2072 6f77 2069 6e64  ..    // row ind
-0005f030: 6578 2075 7365 6420 746f 2064 6574 6572  ex used to deter
-0005f040: 6d69 6e65 2077 6869 6368 2074 6872 6561  mine which threa
-0005f050: 6420 746f 2075 7365 0a20 2020 2069 6e74  d to use.    int
-0005f060: 2069 7220 3d20 303b 0a0a 2020 2020 636f   ir = 0;..    co
-0005f070: 6e73 7420 666c 6f61 7420 7468 6574 615f  nst float theta_
-0005f080: 7363 616c 6520 3d20 706f 7766 2831 3030  scale = powf(100
-0005f090: 3030 2e30 2c20 2d32 2e30 662f 6e5f 6469  00.0, -2.0f/n_di
-0005f0a0: 6d73 293b 0a0a 2020 2020 636f 6e73 7420  ms);..    const 
-0005f0b0: 626f 6f6c 2069 735f 6e65 6f78 203d 206d  bool is_neox = m
-0005f0c0: 6f64 6520 2620 323b 0a20 2020 2063 6f6e  ode & 2;.    con
-0005f0d0: 7374 2062 6f6f 6c20 6973 5f67 6c6d 2020  st bool is_glm  
-0005f0e0: 3d20 6d6f 6465 2026 2034 3b0a 0a20 2020  = mode & 4;..   
-0005f0f0: 2066 6f72 2028 696e 7436 345f 7420 6933   for (int64_t i3
-0005f100: 203d 2030 3b20 6933 203c 206e 6533 3b20   = 0; i3 < ne3; 
-0005f110: 6933 2b2b 2920 7b0a 2020 2020 2020 2020  i3++) {.        
-0005f120: 666f 7220 2869 6e74 3634 5f74 2069 3220  for (int64_t i2 
-0005f130: 3d20 2828 6d6f 6465 2026 2031 2920 3d3d  = ((mode & 1) ==
-0005f140: 2030 203f 2030 203a 206e 5f70 6173 7429   0 ? 0 : n_past)
-0005f150: 3b20 6932 203c 206e 6532 3b20 6932 2b2b  ; i2 < ne2; i2++
-0005f160: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005f170: 636f 6e73 7420 696e 7436 345f 7420 7020  const int64_t p 
-0005f180: 3d20 2828 6d6f 6465 2026 2031 2920 3d3d  = ((mode & 1) ==
-0005f190: 2030 203f 206e 5f70 6173 7420 2b20 6932   0 ? n_past + i2
-0005f1a0: 203a 2069 3229 3b0a 2020 2020 2020 2020   : i2);.        
-0005f1b0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0005f1c0: 2069 3120 3d20 303b 2069 3120 3c20 6e65   i1 = 0; i1 < ne
-0005f1d0: 313b 2069 312b 2b29 207b 0a20 2020 2020  1; i1++) {.     
-0005f1e0: 2020 2020 2020 2020 2020 2069 6620 2869             if (i
-0005f1f0: 722b 2b20 3c20 6972 3029 2063 6f6e 7469  r++ < ir0) conti
-0005f200: 6e75 653b 0a20 2020 2020 2020 2020 2020  nue;.           
-0005f210: 2020 2020 2069 6620 2869 7220 2020 3e20       if (ir   > 
-0005f220: 6972 3129 2062 7265 616b 3b0a 0a20 2020  ir1) break;..   
-0005f230: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-0005f240: 6174 2074 6865 7461 203d 2028 666c 6f61  at theta = (floa
-0005f250: 7429 703b 0a0a 2020 2020 2020 2020 2020  t)p;..          
-0005f260: 2020 2020 2020 6966 2028 6973 5f67 6c6d        if (is_glm
-0005f270: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0005f280: 2020 2020 2020 2020 7468 6574 6120 3d20          theta = 
-0005f290: 4d49 4e28 702c 206e 5f63 7478 202d 2032  MIN(p, n_ctx - 2
-0005f2a0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005f2b0: 2020 2020 2020 2066 6c6f 6174 2062 6c6f         float blo
-0005f2c0: 636b 5f74 6865 7461 203d 204d 4158 2870  ck_theta = MAX(p
-0005f2d0: 202d 2028 6e5f 6374 7820 2d20 3229 2c20   - (n_ctx - 2), 
-0005f2e0: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-0005f2f0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005f300: 3634 5f74 2069 3020 3d20 303b 2069 3020  64_t i0 = 0; i0 
-0005f310: 3c20 6e65 3020 2f20 343b 2069 302b 2b29  < ne0 / 4; i0++)
-0005f320: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0005f330: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005f340: 2066 6c6f 6174 2063 6f73 5f74 6865 7461   float cos_theta
-0005f350: 203d 2063 6f73 6628 7468 6574 6129 3b0a   = cosf(theta);.
-0005f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f370: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005f380: 6f61 7420 7369 6e5f 7468 6574 6120 3d20  oat sin_theta = 
-0005f390: 7369 6e66 2874 6865 7461 293b 0a20 2020  sinf(theta);.   
-0005f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f3b0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-0005f3c0: 2063 6f73 5f62 6c6f 636b 5f74 6865 7461   cos_block_theta
-0005f3d0: 203d 2063 6f73 6628 626c 6f63 6b5f 7468   = cosf(block_th
-0005f3e0: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
-0005f3f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0005f400: 6e73 7420 666c 6f61 7420 7369 6e5f 626c  nst float sin_bl
-0005f410: 6f63 6b5f 7468 6574 6120 3d20 7369 6e66  ock_theta = sinf
-0005f420: 2862 6c6f 636b 5f74 6865 7461 293b 0a0a  (block_theta);..
-0005f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f440: 2020 2020 2020 2020 7468 6574 6120 2a3d          theta *=
-0005f450: 2074 6865 7461 5f73 6361 6c65 3b0a 2020   theta_scale;.  
-0005f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f470: 2020 2020 2020 626c 6f63 6b5f 7468 6574        block_thet
-0005f480: 6120 2a3d 2074 6865 7461 5f73 6361 6c65  a *= theta_scale
-0005f490: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0005f4a0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005f4b0: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
-0005f4c0: 6f6e 7374 2073 7263 203d 2028 6767 6d6c  onst src = (ggml
-0005f4d0: 5f66 7031 365f 7420 2a29 2828 6368 6172  _fp16_t *)((char
-0005f4e0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
-0005f4f0: 2069 332a 6e62 3033 202b 2069 322a 6e62   i3*nb03 + i2*nb
-0005f500: 3032 202b 2069 312a 6e62 3031 202b 2069  02 + i1*nb01 + i
-0005f510: 302a 6e62 3030 293b 0a20 2020 2020 2020  0*nb00);.       
-0005f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f530: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
-0005f540: 5f74 202a 2064 7374 5f64 6174 6120 203d  _t * dst_data  =
-0005f550: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-0005f560: 2828 6368 6172 202a 2920 2064 7374 2d3e  ((char *)  dst->
-0005f570: 6461 7461 202b 2020 6933 2a6e 6233 202b  data +  i3*nb3 +
-0005f580: 2069 322a 6e62 3220 202b 2069 312a 6e62   i2*nb2  + i1*nb
-0005f590: 3120 202b 2069 302a 6e62 3029 3b0a 0a20  1  + i0*nb0);.. 
-0005f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f5b0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0005f5c0: 6174 2078 3020 3d20 4747 4d4c 5f46 5031  at x0 = GGML_FP1
-0005f5d0: 365f 544f 5f46 5033 3228 7372 635b 305d  6_TO_FP32(src[0]
-0005f5e0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005f5f0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005f600: 2066 6c6f 6174 2078 3120 3d20 4747 4d4c   float x1 = GGML
-0005f610: 5f46 5031 365f 544f 5f46 5033 3228 7372  _FP16_TO_FP32(sr
-0005f620: 635b 6e5f 6469 6d73 2f32 5d29 3b0a 2020  c[n_dims/2]);.  
-0005f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f640: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-0005f650: 7420 7832 203d 2047 474d 4c5f 4650 3136  t x2 = GGML_FP16
-0005f660: 5f54 4f5f 4650 3332 2873 7263 5b6e 5f64  _TO_FP32(src[n_d
-0005f670: 696d 735d 293b 0a20 2020 2020 2020 2020  ims]);.         
-0005f680: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0005f690: 6f6e 7374 2066 6c6f 6174 2078 3320 3d20  onst float x3 = 
-0005f6a0: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
-0005f6b0: 3228 7372 635b 6e5f 6469 6d73 2f32 2a33  2(src[n_dims/2*3
-0005f6c0: 5d29 3b0a 0a20 2020 2020 2020 2020 2020  ]);..           
-0005f6d0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
-0005f6e0: 5f64 6174 615b 305d 2020 2020 2020 2020  _data[0]        
-0005f6f0: 2020 3d20 4747 4d4c 5f46 5033 325f 544f    = GGML_FP32_TO
-0005f700: 5f46 5031 3628 7830 2a63 6f73 5f74 6865  _FP16(x0*cos_the
-0005f710: 7461 202d 2078 312a 7369 6e5f 7468 6574  ta - x1*sin_thet
-0005f720: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
-0005f730: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0005f740: 6461 7461 5b6e 5f64 696d 732f 325d 2020  data[n_dims/2]  
-0005f750: 203d 2047 474d 4c5f 4650 3332 5f54 4f5f   = GGML_FP32_TO_
-0005f760: 4650 3136 2878 302a 7369 6e5f 7468 6574  FP16(x0*sin_thet
-0005f770: 6120 2b20 7831 2a63 6f73 5f74 6865 7461  a + x1*cos_theta
-0005f780: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0005f790: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
-0005f7a0: 6174 615b 6e5f 6469 6d73 5d20 2020 2020  ata[n_dims]     
-0005f7b0: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
-0005f7c0: 5031 3628 7832 2a63 6f73 5f62 6c6f 636b  P16(x2*cos_block
-0005f7d0: 5f74 6865 7461 202d 2078 332a 7369 6e5f  _theta - x3*sin_
-0005f7e0: 626c 6f63 6b5f 7468 6574 6129 3b0a 2020  block_theta);.  
-0005f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f800: 2020 2020 2020 6473 745f 6461 7461 5b6e        dst_data[n
-0005f810: 5f64 696d 732f 322a 335d 203d 2047 474d  _dims/2*3] = GGM
-0005f820: 4c5f 4650 3332 5f54 4f5f 4650 3136 2878  L_FP32_TO_FP16(x
-0005f830: 322a 7369 6e5f 626c 6f63 6b5f 7468 6574  2*sin_block_thet
-0005f840: 6120 2b20 7833 2a63 6f73 5f62 6c6f 636b  a + x3*cos_block
-0005f850: 5f74 6865 7461 293b 0a20 2020 2020 2020  _theta);.       
-0005f860: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0005f870: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0005f880: 2069 6620 2821 6973 5f6e 656f 7829 207b   if (!is_neox) {
-0005f890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005f8a0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-0005f8b0: 7420 6930 203d 2030 3b20 6930 203c 206e  t i0 = 0; i0 < n
-0005f8c0: 6530 3b20 6930 202b 3d20 3229 207b 0a20  e0; i0 += 2) {. 
-0005f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f8e0: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0005f8f0: 6174 2063 6f73 5f74 6865 7461 203d 2063  at cos_theta = c
-0005f900: 6f73 6628 7468 6574 6129 3b0a 2020 2020  osf(theta);.    
-0005f910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f920: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-0005f930: 7369 6e5f 7468 6574 6120 3d20 7369 6e66  sin_theta = sinf
-0005f940: 2874 6865 7461 293b 0a0a 2020 2020 2020  (theta);..      
-0005f950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f960: 2020 7468 6574 6120 2a3d 2074 6865 7461    theta *= theta
-0005f970: 5f73 6361 6c65 3b0a 0a20 2020 2020 2020  _scale;..       
-0005f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005f990: 2063 6f6e 7374 2067 676d 6c5f 6670 3136   const ggml_fp16
-0005f9a0: 5f74 202a 2063 6f6e 7374 2073 7263 203d  _t * const src =
-0005f9b0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
-0005f9c0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
-0005f9d0: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
-0005f9e0: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
-0005f9f0: 3031 202b 2069 302a 6e62 3030 293b 0a20  01 + i0*nb00);. 
-0005fa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fa10: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0005fa20: 6c5f 6670 3136 5f74 202a 2064 7374 5f64  l_fp16_t * dst_d
-0005fa30: 6174 6120 203d 2028 6767 6d6c 5f66 7031  ata  = (ggml_fp1
-0005fa40: 365f 7420 2a29 2828 6368 6172 202a 2920  6_t *)((char *) 
-0005fa50: 2064 7374 2d3e 6461 7461 202b 2069 332a   dst->data + i3*
-0005fa60: 6e62 3320 202b 2069 322a 6e62 3220 202b  nb3  + i2*nb2  +
-0005fa70: 2069 312a 6e62 3120 202b 2069 302a 6e62   i1*nb1  + i0*nb
-0005fa80: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
-0005fa90: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0005faa0: 7374 2066 6c6f 6174 2078 3020 3d20 4747  st float x0 = GG
-0005fab0: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
-0005fac0: 7372 635b 305d 293b 0a20 2020 2020 2020  src[0]);.       
-0005fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fae0: 2063 6f6e 7374 2066 6c6f 6174 2078 3120   const float x1 
-0005faf0: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
-0005fb00: 5033 3228 7372 635b 315d 293b 0a0a 2020  P32(src[1]);..  
-0005fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fb20: 2020 2020 2020 6473 745f 6461 7461 5b30        dst_data[0
-0005fb30: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
-0005fb40: 5f46 5031 3628 7830 2a63 6f73 5f74 6865  _FP16(x0*cos_the
-0005fb50: 7461 202d 2078 312a 7369 6e5f 7468 6574  ta - x1*sin_thet
-0005fb60: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
-0005fb70: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-0005fb80: 6461 7461 5b31 5d20 3d20 4747 4d4c 5f46  data[1] = GGML_F
-0005fb90: 5033 325f 544f 5f46 5031 3628 7830 2a73  P32_TO_FP16(x0*s
-0005fba0: 696e 5f74 6865 7461 202b 2078 312a 636f  in_theta + x1*co
-0005fbb0: 735f 7468 6574 6129 3b0a 2020 2020 2020  s_theta);.      
-0005fbc0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0005fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fbe0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-0005fbf0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0005fc00: 544f 444f 3a20 7468 6973 2069 7320 7072  TODO: this is pr
-0005fc10: 6f62 6162 6c79 2077 726f 6e67 2c20 6275  obably wrong, bu
-0005fc20: 7420 4920 6361 6e27 7420 6669 6775 7265  t I can't figure
-0005fc30: 2069 7420 6f75 7420 2e2e 0a20 2020 2020   it out ...     
-0005fc40: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0005fc50: 2f20 7265 663a 2020 6874 7470 733a 2f2f  / ref:  https://
-0005fc60: 6769 7468 7562 2e63 6f6d 2f68 7567 6769  github.com/huggi
-0005fc70: 6e67 6661 6365 2f74 7261 6e73 666f 726d  ngface/transform
-0005fc80: 6572 732f 626c 6f62 2f6d 6169 6e2f 7372  ers/blob/main/sr
-0005fc90: 632f 7472 616e 7366 6f72 6d65 7273 2f6d  c/transformers/m
-0005fca0: 6f64 656c 732f 6770 745f 6e65 6f78 2f6d  odels/gpt_neox/m
-0005fcb0: 6f64 656c 696e 675f 6770 745f 6e65 6f78  odeling_gpt_neox
-0005fcc0: 2e70 7923 4c4c 3235 3143 312d 4c32 3934  .py#LL251C1-L294
-0005fcd0: 4332 380a 2020 2020 2020 2020 2020 2020  C28.            
-0005fce0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0005fcf0: 3634 5f74 2069 6220 3d20 303b 2069 6220  64_t ib = 0; ib 
-0005fd00: 3c20 6e65 302f 6e5f 6469 6d73 3b20 2b2b  < ne0/n_dims; ++
-0005fd10: 6962 2920 7b0a 2020 2020 2020 2020 2020  ib) {.          
-0005fd20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0005fd30: 7220 2869 6e74 3634 5f74 2069 6320 3d20  r (int64_t ic = 
-0005fd40: 303b 2069 6320 3c20 6e5f 6469 6d73 3b20  0; ic < n_dims; 
-0005fd50: 6963 202b 3d20 3229 207b 0a20 2020 2020  ic += 2) {.     
-0005fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fd70: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-0005fd80: 6174 2063 6f73 5f74 6865 7461 203d 2063  at cos_theta = c
-0005fd90: 6f73 6628 7468 6574 6129 3b0a 2020 2020  osf(theta);.    
-0005fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fdb0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-0005fdc0: 6f61 7420 7369 6e5f 7468 6574 6120 3d20  oat sin_theta = 
-0005fdd0: 7369 6e66 2874 6865 7461 293b 0a0a 2020  sinf(theta);..  
-0005fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fdf0: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
-0005fe00: 2a3d 2074 6865 7461 5f73 6361 6c65 3b0a  *= theta_scale;.
-0005fe10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0005fe20: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0005fe30: 7374 2069 6e74 3634 5f74 2069 3020 3d20  st int64_t i0 = 
-0005fe40: 6962 2a6e 5f64 696d 7320 2b20 6963 2f32  ib*n_dims + ic/2
-0005fe50: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0005fe60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0005fe70: 6f6e 7374 2067 676d 6c5f 6670 3136 5f74  onst ggml_fp16_t
-0005fe80: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
-0005fe90: 6767 6d6c 5f66 7031 365f 7420 2a29 2828  ggml_fp16_t *)((
-0005fea0: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-0005feb0: 7461 202b 2069 332a 6e62 3033 202b 2069  ta + i3*nb03 + i
-0005fec0: 322a 6e62 3032 202b 2069 312a 6e62 3031  2*nb02 + i1*nb01
-0005fed0: 202b 2069 302a 6e62 3030 293b 0a20 2020   + i0*nb00);.   
-0005fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005fef0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0005ff00: 676d 6c5f 6670 3136 5f74 202a 2064 7374  gml_fp16_t * dst
-0005ff10: 5f64 6174 6120 203d 2028 6767 6d6c 5f66  _data  = (ggml_f
-0005ff20: 7031 365f 7420 2a29 2828 6368 6172 202a  p16_t *)((char *
-0005ff30: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
-0005ff40: 332a 6e62 3320 202b 2069 322a 6e62 3220  3*nb3  + i2*nb2 
-0005ff50: 202b 2069 312a 6e62 3120 202b 2069 302a   + i1*nb1  + i0*
-0005ff60: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
-0005ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ff80: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
-0005ff90: 3020 3d20 4747 4d4c 5f46 5031 365f 544f  0 = GGML_FP16_TO
-0005ffa0: 5f46 5033 3228 7372 635b 305d 293b 0a20  _FP32(src[0]);. 
-0005ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0005ffc0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0005ffd0: 2066 6c6f 6174 2078 3120 3d20 4747 4d4c   float x1 = GGML
-0005ffe0: 5f46 5031 365f 544f 5f46 5033 3228 7372  _FP16_TO_FP32(sr
-0005fff0: 635b 6e5f 6469 6d73 2f32 5d29 3b0a 0a20  c[n_dims/2]);.. 
+0005e8b0: 2020 6473 745f 6461 7461 5b31 5d20 3d20    dst_data[1] = 
+0005e8c0: 7830 2a73 696e 5f74 6865 7461 202b 2078  x0*sin_theta + x
+0005e8d0: 312a 636f 735f 7468 6574 613b 0a20 2020  1*cos_theta;.   
+0005e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e8f0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0005e900: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0005e910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e920: 2f2f 2054 4f44 4f3a 2074 6869 7320 6973  // TODO: this is
+0005e930: 2070 726f 6261 626c 7920 7772 6f6e 672c   probably wrong,
+0005e940: 2062 7574 2049 2063 616e 2774 2066 6967   but I can't fig
+0005e950: 7572 6520 6974 206f 7574 202e 2e0a 2020  ure it out ...  
+0005e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005e970: 2020 2f2f 2072 6566 3a20 2068 7474 7073    // ref:  https
+0005e980: 3a2f 2f67 6974 6875 622e 636f 6d2f 6875  ://github.com/hu
+0005e990: 6767 696e 6766 6163 652f 7472 616e 7366  ggingface/transf
+0005e9a0: 6f72 6d65 7273 2f62 6c6f 622f 6d61 696e  ormers/blob/main
+0005e9b0: 2f73 7263 2f74 7261 6e73 666f 726d 6572  /src/transformer
+0005e9c0: 732f 6d6f 6465 6c73 2f67 7074 5f6e 656f  s/models/gpt_neo
+0005e9d0: 782f 6d6f 6465 6c69 6e67 5f67 7074 5f6e  x/modeling_gpt_n
+0005e9e0: 656f 782e 7079 234c 4c32 3531 4331 2d4c  eox.py#LL251C1-L
+0005e9f0: 3239 3443 3238 0a20 2020 2020 2020 2020  294C28.         
+0005ea00: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0005ea10: 696e 7436 345f 7420 6962 203d 2030 3b20  int64_t ib = 0; 
+0005ea20: 6962 203c 206e 6530 2f6e 5f64 696d 733b  ib < ne0/n_dims;
+0005ea30: 202b 2b69 6229 207b 0a20 2020 2020 2020   ++ib) {.       
+0005ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ea50: 2066 6f72 2028 696e 7436 345f 7420 6963   for (int64_t ic
+0005ea60: 203d 2030 3b20 6963 203c 206e 5f64 696d   = 0; ic < n_dim
+0005ea70: 733b 2069 6320 2b3d 2032 2920 7b0a 2020  s; ic += 2) {.  
+0005ea80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ea90: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005eaa0: 666c 6f61 7420 636f 735f 7468 6574 6120  float cos_theta 
+0005eab0: 3d20 636f 7366 2874 6865 7461 293b 0a20  = cosf(theta);. 
+0005eac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ead0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0005eae0: 2066 6c6f 6174 2073 696e 5f74 6865 7461   float sin_theta
+0005eaf0: 203d 2073 696e 6628 7468 6574 6129 3b0a   = sinf(theta);.
+0005eb00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005eb10: 2020 2020 2020 2020 2020 2020 2074 6865               the
+0005eb20: 7461 202a 3d20 7468 6574 615f 7363 616c  ta *= theta_scal
+0005eb30: 653b 0a0a 2020 2020 2020 2020 2020 2020  e;..            
+0005eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005eb50: 636f 6e73 7420 696e 7436 345f 7420 6930  const int64_t i0
+0005eb60: 203d 2069 622a 6e5f 6469 6d73 202b 2069   = ib*n_dims + i
+0005eb70: 632f 323b 0a0a 2020 2020 2020 2020 2020  c/2;..          
+0005eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005eb90: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
+0005eba0: 636f 6e73 7420 7372 6320 3d20 2866 6c6f  const src = (flo
+0005ebb0: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
+0005ebc0: 7263 302d 3e64 6174 6120 2b20 6933 2a6e  rc0->data + i3*n
+0005ebd0: 6230 3320 2b20 6932 2a6e 6230 3220 2b20  b03 + i2*nb02 + 
+0005ebe0: 6931 2a6e 6230 3120 2b20 6930 2a6e 6230  i1*nb01 + i0*nb0
+0005ebf0: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+0005ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ec10: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
+0005ec20: 745f 6461 7461 2020 3d20 2866 6c6f 6174  t_data  = (float
+0005ec30: 202a 2928 2863 6861 7220 2a29 2020 6473   *)((char *)  ds
+0005ec40: 742d 3e64 6174 6120 2b20 6933 2a6e 6233  t->data + i3*nb3
+0005ec50: 2020 2b20 6932 2a6e 6232 2020 2b20 6931    + i2*nb2  + i1
+0005ec60: 2a6e 6231 2020 2b20 6930 2a6e 6230 293b  *nb1  + i0*nb0);
+0005ec70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005ec80: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0005ec90: 6e73 7420 666c 6f61 7420 7830 203d 2073  nst float x0 = s
+0005eca0: 7263 5b30 5d3b 0a20 2020 2020 2020 2020  rc[0];.         
+0005ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ecc0: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
+0005ecd0: 3120 3d20 7372 635b 6e5f 6469 6d73 2f32  1 = src[n_dims/2
+0005ece0: 5d3b 0a0a 2020 2020 2020 2020 2020 2020  ];..            
+0005ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ed00: 6473 745f 6461 7461 5b30 5d20 2020 2020  dst_data[0]     
+0005ed10: 2020 203d 2078 302a 636f 735f 7468 6574     = x0*cos_thet
+0005ed20: 6120 2d20 7831 2a73 696e 5f74 6865 7461  a - x1*sin_theta
+0005ed30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005ed40: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+0005ed50: 745f 6461 7461 5b6e 5f64 696d 732f 325d  t_data[n_dims/2]
+0005ed60: 203d 2078 302a 7369 6e5f 7468 6574 6120   = x0*sin_theta 
+0005ed70: 2b20 7831 2a63 6f73 5f74 6865 7461 3b0a  + x1*cos_theta;.
+0005ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ed90: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0005eda0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0005edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005edc0: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+0005edd0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0005ede0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+0005edf0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0005ee00: 6172 645f 726f 7065 5f66 3136 280a 2020  ard_rope_f16(.  
+0005ee10: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0005ee20: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+0005ee30: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+0005ee40: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0005ee50: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0005ee60: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+0005ee70: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0005ee80: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+0005ee90: 312c 0a20 2020 2020 2020 2073 7472 7563  1,.        struc
+0005eea0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0005eeb0: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+0005eec0: 4153 5345 5254 2873 7263 312d 3e74 7970  ASSERT(src1->typ
+0005eed0: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
+0005eee0: 3332 293b 0a20 2020 2047 474d 4c5f 4153  32);.    GGML_AS
+0005eef0: 5345 5254 2867 676d 6c5f 6e65 6c65 6d65  SERT(ggml_neleme
+0005ef00: 6e74 7328 7372 6331 2920 3d3d 2034 293b  nts(src1) == 4);
+0005ef10: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+0005ef20: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0005ef30: 4153 4b5f 494e 4954 207c 7c20 7061 7261  ASK_INIT || para
+0005ef40: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
+0005ef50: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
+0005ef60: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
+0005ef70: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
+0005ef80: 7374 2069 6e74 206e 5f70 6173 7420 3d20  st int n_past = 
+0005ef90: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+0005efa0: 312d 3e64 6174 6129 5b30 5d3b 0a20 2020  1->data)[0];.   
+0005efb0: 2063 6f6e 7374 2069 6e74 206e 5f64 696d   const int n_dim
+0005efc0: 7320 3d20 2828 696e 7433 325f 7420 2a29  s = ((int32_t *)
+0005efd0: 2073 7263 312d 3e64 6174 6129 5b31 5d3b   src1->data)[1];
+0005efe0: 0a20 2020 2063 6f6e 7374 2069 6e74 206d  .    const int m
+0005eff0: 6f64 6520 2020 3d20 2828 696e 7433 325f  ode   = ((int32_
+0005f000: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
+0005f010: 5b32 5d3b 0a20 2020 2063 6f6e 7374 2069  [2];.    const i
+0005f020: 6e74 206e 5f63 7478 2020 3d20 2828 696e  nt n_ctx  = ((in
+0005f030: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
+0005f040: 6174 6129 5b33 5d3b 0a0a 2020 2020 6173  ata)[3];..    as
+0005f050: 7365 7274 286e 5f70 6173 7420 3e3d 2030  sert(n_past >= 0
+0005f060: 293b 0a0a 2020 2020 4747 4d4c 5f54 454e  );..    GGML_TEN
+0005f070: 534f 525f 554e 4152 595f 4f50 5f4c 4f43  SOR_UNARY_OP_LOC
+0005f080: 414c 533b 0a0a 2020 2020 2f2f 7072 696e  ALS;..    //prin
+0005f090: 7466 2822 6e65 303a 2025 642c 206e 6531  tf("ne0: %d, ne1
+0005f0a0: 3a20 2564 2c20 6e65 323a 2025 642c 206e  : %d, ne2: %d, n
+0005f0b0: 6533 3a20 2564 5c6e 222c 206e 6530 2c20  e3: %d\n", ne0, 
+0005f0c0: 6e65 312c 206e 6532 2c20 6e65 3329 3b0a  ne1, ne2, ne3);.
+0005f0d0: 2020 2020 2f2f 7072 696e 7466 2822 6e5f      //printf("n_
+0005f0e0: 7061 7374 203d 2025 642c 206e 6532 203d  past = %d, ne2 =
+0005f0f0: 2025 645c 6e22 2c20 6e5f 7061 7374 2c20   %d\n", n_past, 
+0005f100: 6e65 3229 3b0a 0a20 2020 2047 474d 4c5f  ne2);..    GGML_
+0005f110: 4153 5345 5254 286e 6230 203d 3d20 7369  ASSERT(nb0 == si
+0005f120: 7a65 6f66 2867 676d 6c5f 6670 3136 5f74  zeof(ggml_fp16_t
+0005f130: 2929 3b0a 0a20 2020 2063 6f6e 7374 2069  ));..    const i
+0005f140: 6e74 2069 7468 203d 2070 6172 616d 732d  nt ith = params-
+0005f150: 3e69 7468 3b0a 2020 2020 636f 6e73 7420  >ith;.    const 
+0005f160: 696e 7420 6e74 6820 3d20 7061 7261 6d73  int nth = params
+0005f170: 2d3e 6e74 683b 0a0a 2020 2020 636f 6e73  ->nth;..    cons
+0005f180: 7420 696e 7420 6e72 203d 2067 676d 6c5f  t int nr = ggml_
+0005f190: 6e72 6f77 7328 6473 7429 3b0a 0a20 2020  nrows(dst);..   
+0005f1a0: 2047 474d 4c5f 4153 5345 5254 286e 5f64   GGML_ASSERT(n_d
+0005f1b0: 696d 7320 3c3d 206e 6530 293b 0a20 2020  ims <= ne0);.   
+0005f1c0: 2047 474d 4c5f 4153 5345 5254 286e 5f64   GGML_ASSERT(n_d
+0005f1d0: 696d 7320 2520 3220 3d3d 2030 293b 0a0a  ims % 2 == 0);..
+0005f1e0: 2020 2020 2f2f 2072 6f77 7320 7065 7220      // rows per 
+0005f1f0: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+0005f200: 2069 6e74 2064 7220 3d20 286e 7220 2b20   int dr = (nr + 
+0005f210: 6e74 6820 2d20 3129 2f6e 7468 3b0a 0a20  nth - 1)/nth;.. 
+0005f220: 2020 202f 2f20 726f 7720 7261 6e67 6520     // row range 
+0005f230: 666f 7220 7468 6973 2074 6872 6561 640a  for this thread.
+0005f240: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+0005f250: 3020 3d20 6472 2a69 7468 3b0a 2020 2020  0 = dr*ith;.    
+0005f260: 636f 6e73 7420 696e 7420 6972 3120 3d20  const int ir1 = 
+0005f270: 4d49 4e28 6972 3020 2b20 6472 2c20 6e72  MIN(ir0 + dr, nr
+0005f280: 293b 0a0a 2020 2020 2f2f 2072 6f77 2069  );..    // row i
+0005f290: 6e64 6578 2075 7365 6420 746f 2064 6574  ndex used to det
+0005f2a0: 6572 6d69 6e65 2077 6869 6368 2074 6872  ermine which thr
+0005f2b0: 6561 6420 746f 2075 7365 0a20 2020 2069  ead to use.    i
+0005f2c0: 6e74 2069 7220 3d20 303b 0a0a 2020 2020  nt ir = 0;..    
+0005f2d0: 636f 6e73 7420 666c 6f61 7420 7468 6574  const float thet
+0005f2e0: 615f 7363 616c 6520 3d20 706f 7766 2831  a_scale = powf(1
+0005f2f0: 3030 3030 2e30 2c20 2d32 2e30 662f 6e5f  0000.0, -2.0f/n_
+0005f300: 6469 6d73 293b 0a0a 2020 2020 636f 6e73  dims);..    cons
+0005f310: 7420 626f 6f6c 2069 735f 6e65 6f78 203d  t bool is_neox =
+0005f320: 206d 6f64 6520 2620 323b 0a20 2020 2063   mode & 2;.    c
+0005f330: 6f6e 7374 2062 6f6f 6c20 6973 5f67 6c6d  onst bool is_glm
+0005f340: 2020 3d20 6d6f 6465 2026 2034 3b0a 0a20    = mode & 4;.. 
+0005f350: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+0005f360: 6933 203d 2030 3b20 6933 203c 206e 6533  i3 = 0; i3 < ne3
+0005f370: 3b20 6933 2b2b 2920 7b0a 2020 2020 2020  ; i3++) {.      
+0005f380: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0005f390: 3220 3d20 2828 6d6f 6465 2026 2031 2920  2 = ((mode & 1) 
+0005f3a0: 3d3d 2030 203f 2030 203a 206e 5f70 6173  == 0 ? 0 : n_pas
+0005f3b0: 7429 3b20 6932 203c 206e 6532 3b20 6932  t); i2 < ne2; i2
+0005f3c0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0005f3d0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+0005f3e0: 7020 3d20 2828 6d6f 6465 2026 2031 2920  p = ((mode & 1) 
+0005f3f0: 3d3d 2030 203f 206e 5f70 6173 7420 2b20  == 0 ? n_past + 
+0005f400: 6932 203a 2069 3229 3b0a 2020 2020 2020  i2 : i2);.      
+0005f410: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0005f420: 5f74 2069 3120 3d20 303b 2069 3120 3c20  _t i1 = 0; i1 < 
+0005f430: 6e65 313b 2069 312b 2b29 207b 0a20 2020  ne1; i1++) {.   
+0005f440: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0005f450: 2869 722b 2b20 3c20 6972 3029 2063 6f6e  (ir++ < ir0) con
+0005f460: 7469 6e75 653b 0a20 2020 2020 2020 2020  tinue;.         
+0005f470: 2020 2020 2020 2069 6620 2869 7220 2020         if (ir   
+0005f480: 3e20 6972 3129 2062 7265 616b 3b0a 0a20  > ir1) break;.. 
+0005f490: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0005f4a0: 6c6f 6174 2074 6865 7461 203d 2028 666c  loat theta = (fl
+0005f4b0: 6f61 7429 703b 0a0a 2020 2020 2020 2020  oat)p;..        
+0005f4c0: 2020 2020 2020 2020 6966 2028 6973 5f67          if (is_g
+0005f4d0: 6c6d 2920 7b0a 2020 2020 2020 2020 2020  lm) {.          
+0005f4e0: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
+0005f4f0: 3d20 4d49 4e28 702c 206e 5f63 7478 202d  = MIN(p, n_ctx -
+0005f500: 2032 293b 0a20 2020 2020 2020 2020 2020   2);.           
+0005f510: 2020 2020 2020 2020 2066 6c6f 6174 2062           float b
+0005f520: 6c6f 636b 5f74 6865 7461 203d 204d 4158  lock_theta = MAX
+0005f530: 2870 202d 2028 6e5f 6374 7820 2d20 3229  (p - (n_ctx - 2)
+0005f540: 2c20 3029 3b0a 2020 2020 2020 2020 2020  , 0);.          
+0005f550: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0005f560: 6e74 3634 5f74 2069 3020 3d20 303b 2069  nt64_t i0 = 0; i
+0005f570: 3020 3c20 6e65 3020 2f20 343b 2069 302b  0 < ne0 / 4; i0+
+0005f580: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0005f590: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005f5a0: 7374 2066 6c6f 6174 2063 6f73 5f74 6865  st float cos_the
+0005f5b0: 7461 203d 2063 6f73 6628 7468 6574 6129  ta = cosf(theta)
+0005f5c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0005f5d0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0005f5e0: 666c 6f61 7420 7369 6e5f 7468 6574 6120  float sin_theta 
+0005f5f0: 3d20 7369 6e66 2874 6865 7461 293b 0a20  = sinf(theta);. 
+0005f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f610: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+0005f620: 6174 2063 6f73 5f62 6c6f 636b 5f74 6865  at cos_block_the
+0005f630: 7461 203d 2063 6f73 6628 626c 6f63 6b5f  ta = cosf(block_
+0005f640: 7468 6574 6129 3b0a 2020 2020 2020 2020  theta);.        
+0005f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f660: 636f 6e73 7420 666c 6f61 7420 7369 6e5f  const float sin_
+0005f670: 626c 6f63 6b5f 7468 6574 6120 3d20 7369  block_theta = si
+0005f680: 6e66 2862 6c6f 636b 5f74 6865 7461 293b  nf(block_theta);
+0005f690: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0005f6a0: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
+0005f6b0: 2a3d 2074 6865 7461 5f73 6361 6c65 3b0a  *= theta_scale;.
+0005f6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f6d0: 2020 2020 2020 2020 626c 6f63 6b5f 7468          block_th
+0005f6e0: 6574 6120 2a3d 2074 6865 7461 5f73 6361  eta *= theta_sca
+0005f6f0: 6c65 3b0a 0a20 2020 2020 2020 2020 2020  le;..           
+0005f700: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005f710: 7374 2067 676d 6c5f 6670 3136 5f74 202a  st ggml_fp16_t *
+0005f720: 2063 6f6e 7374 2073 7263 203d 2028 6767   const src = (gg
+0005f730: 6d6c 5f66 7031 365f 7420 2a29 2828 6368  ml_fp16_t *)((ch
+0005f740: 6172 202a 2920 7372 6330 2d3e 6461 7461  ar *) src0->data
+0005f750: 202b 2069 332a 6e62 3033 202b 2069 322a   + i3*nb03 + i2*
+0005f760: 6e62 3032 202b 2069 312a 6e62 3031 202b  nb02 + i1*nb01 +
+0005f770: 2069 302a 6e62 3030 293b 0a20 2020 2020   i0*nb00);.     
+0005f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f790: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
+0005f7a0: 3136 5f74 202a 2064 7374 5f64 6174 6120  16_t * dst_data 
+0005f7b0: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
+0005f7c0: 2a29 2828 6368 6172 202a 2920 2064 7374  *)((char *)  dst
+0005f7d0: 2d3e 6461 7461 202b 2020 6933 2a6e 6233  ->data +  i3*nb3
+0005f7e0: 202b 2069 322a 6e62 3220 202b 2069 312a   + i2*nb2  + i1*
+0005f7f0: 6e62 3120 202b 2069 302a 6e62 3029 3b0a  nb1  + i0*nb0);.
+0005f800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005f810: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0005f820: 6c6f 6174 2078 3020 3d20 4747 4d4c 5f46  loat x0 = GGML_F
+0005f830: 5031 365f 544f 5f46 5033 3228 7372 635b  P16_TO_FP32(src[
+0005f840: 305d 293b 0a20 2020 2020 2020 2020 2020  0]);.           
+0005f850: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0005f860: 7374 2066 6c6f 6174 2078 3120 3d20 4747  st float x1 = GG
+0005f870: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+0005f880: 7372 635b 6e5f 6469 6d73 2f32 5d29 3b0a  src[n_dims/2]);.
+0005f890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f8a0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+0005f8b0: 6f61 7420 7832 203d 2047 474d 4c5f 4650  oat x2 = GGML_FP
+0005f8c0: 3136 5f54 4f5f 4650 3332 2873 7263 5b6e  16_TO_FP32(src[n
+0005f8d0: 5f64 696d 735d 293b 0a20 2020 2020 2020  _dims]);.       
+0005f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005f8f0: 2063 6f6e 7374 2066 6c6f 6174 2078 3320   const float x3 
+0005f900: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
+0005f910: 5033 3228 7372 635b 6e5f 6469 6d73 2f32  P32(src[n_dims/2
+0005f920: 2a33 5d29 3b0a 0a20 2020 2020 2020 2020  *3]);..         
+0005f930: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0005f940: 7374 5f64 6174 615b 305d 2020 2020 2020  st_data[0]      
+0005f950: 2020 2020 3d20 4747 4d4c 5f46 5033 325f      = GGML_FP32_
+0005f960: 544f 5f46 5031 3628 7830 2a63 6f73 5f74  TO_FP16(x0*cos_t
+0005f970: 6865 7461 202d 2078 312a 7369 6e5f 7468  heta - x1*sin_th
+0005f980: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
+0005f990: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+0005f9a0: 745f 6461 7461 5b6e 5f64 696d 732f 325d  t_data[n_dims/2]
+0005f9b0: 2020 203d 2047 474d 4c5f 4650 3332 5f54     = GGML_FP32_T
+0005f9c0: 4f5f 4650 3136 2878 302a 7369 6e5f 7468  O_FP16(x0*sin_th
+0005f9d0: 6574 6120 2b20 7831 2a63 6f73 5f74 6865  eta + x1*cos_the
+0005f9e0: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
+0005f9f0: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+0005fa00: 5f64 6174 615b 6e5f 6469 6d73 5d20 2020  _data[n_dims]   
+0005fa10: 2020 3d20 4747 4d4c 5f46 5033 325f 544f    = GGML_FP32_TO
+0005fa20: 5f46 5031 3628 7832 2a63 6f73 5f62 6c6f  _FP16(x2*cos_blo
+0005fa30: 636b 5f74 6865 7461 202d 2078 332a 7369  ck_theta - x3*si
+0005fa40: 6e5f 626c 6f63 6b5f 7468 6574 6129 3b0a  n_block_theta);.
+0005fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fa60: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
+0005fa70: 5b6e 5f64 696d 732f 322a 335d 203d 2047  [n_dims/2*3] = G
+0005fa80: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+0005fa90: 2878 322a 7369 6e5f 626c 6f63 6b5f 7468  (x2*sin_block_th
+0005faa0: 6574 6120 2b20 7833 2a63 6f73 5f62 6c6f  eta + x3*cos_blo
+0005fab0: 636b 5f74 6865 7461 293b 0a20 2020 2020  ck_theta);.     
+0005fac0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0005fad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005fae0: 207d 2069 6620 2821 6973 5f6e 656f 7829   } if (!is_neox)
+0005faf0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0005fb00: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0005fb10: 345f 7420 6930 203d 2030 3b20 6930 203c  4_t i0 = 0; i0 <
+0005fb20: 206e 6530 3b20 6930 202b 3d20 3229 207b   ne0; i0 += 2) {
+0005fb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005fb40: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0005fb50: 6c6f 6174 2063 6f73 5f74 6865 7461 203d  loat cos_theta =
+0005fb60: 2063 6f73 6628 7468 6574 6129 3b0a 2020   cosf(theta);.  
+0005fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fb80: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
+0005fb90: 7420 7369 6e5f 7468 6574 6120 3d20 7369  t sin_theta = si
+0005fba0: 6e66 2874 6865 7461 293b 0a0a 2020 2020  nf(theta);..    
+0005fbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fbc0: 2020 2020 7468 6574 6120 2a3d 2074 6865      theta *= the
+0005fbd0: 7461 5f73 6361 6c65 3b0a 0a20 2020 2020  ta_scale;..     
+0005fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fbf0: 2020 2063 6f6e 7374 2067 676d 6c5f 6670     const ggml_fp
+0005fc00: 3136 5f74 202a 2063 6f6e 7374 2073 7263  16_t * const src
+0005fc10: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
+0005fc20: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
+0005fc30: 2d3e 6461 7461 202b 2069 332a 6e62 3033  ->data + i3*nb03
+0005fc40: 202b 2069 322a 6e62 3032 202b 2069 312a   + i2*nb02 + i1*
+0005fc50: 6e62 3031 202b 2069 302a 6e62 3030 293b  nb01 + i0*nb00);
+0005fc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0005fc70: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0005fc80: 676d 6c5f 6670 3136 5f74 202a 2064 7374  gml_fp16_t * dst
+0005fc90: 5f64 6174 6120 203d 2028 6767 6d6c 5f66  _data  = (ggml_f
+0005fca0: 7031 365f 7420 2a29 2828 6368 6172 202a  p16_t *)((char *
+0005fcb0: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
+0005fcc0: 332a 6e62 3320 202b 2069 322a 6e62 3220  3*nb3  + i2*nb2 
+0005fcd0: 202b 2069 312a 6e62 3120 202b 2069 302a   + i1*nb1  + i0*
+0005fce0: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
+0005fcf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0005fd00: 6f6e 7374 2066 6c6f 6174 2078 3020 3d20  onst float x0 = 
+0005fd10: 4747 4d4c 5f46 5031 365f 544f 5f46 5033  GGML_FP16_TO_FP3
+0005fd20: 3228 7372 635b 305d 293b 0a20 2020 2020  2(src[0]);.     
+0005fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fd40: 2020 2063 6f6e 7374 2066 6c6f 6174 2078     const float x
+0005fd50: 3120 3d20 4747 4d4c 5f46 5031 365f 544f  1 = GGML_FP16_TO
+0005fd60: 5f46 5033 3228 7372 635b 315d 293b 0a0a  _FP32(src[1]);..
+0005fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fd80: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
+0005fd90: 5b30 5d20 3d20 4747 4d4c 5f46 5033 325f  [0] = GGML_FP32_
+0005fda0: 544f 5f46 5031 3628 7830 2a63 6f73 5f74  TO_FP16(x0*cos_t
+0005fdb0: 6865 7461 202d 2078 312a 7369 6e5f 7468  heta - x1*sin_th
+0005fdc0: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
+0005fdd0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+0005fde0: 745f 6461 7461 5b31 5d20 3d20 4747 4d4c  t_data[1] = GGML
+0005fdf0: 5f46 5033 325f 544f 5f46 5031 3628 7830  _FP32_TO_FP16(x0
+0005fe00: 2a73 696e 5f74 6865 7461 202b 2078 312a  *sin_theta + x1*
+0005fe10: 636f 735f 7468 6574 6129 3b0a 2020 2020  cos_theta);.    
+0005fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005fe30: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0005fe40: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+0005fe50: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0005fe60: 2f20 544f 444f 3a20 7468 6973 2069 7320  / TODO: this is 
+0005fe70: 7072 6f62 6162 6c79 2077 726f 6e67 2c20  probably wrong, 
+0005fe80: 6275 7420 4920 6361 6e27 7420 6669 6775  but I can't figu
+0005fe90: 7265 2069 7420 6f75 7420 2e2e 0a20 2020  re it out ...   
+0005fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005feb0: 202f 2f20 7265 663a 2020 6874 7470 733a   // ref:  https:
+0005fec0: 2f2f 6769 7468 7562 2e63 6f6d 2f68 7567  //github.com/hug
+0005fed0: 6769 6e67 6661 6365 2f74 7261 6e73 666f  gingface/transfo
+0005fee0: 726d 6572 732f 626c 6f62 2f6d 6169 6e2f  rmers/blob/main/
+0005fef0: 7372 632f 7472 616e 7366 6f72 6d65 7273  src/transformers
+0005ff00: 2f6d 6f64 656c 732f 6770 745f 6e65 6f78  /models/gpt_neox
+0005ff10: 2f6d 6f64 656c 696e 675f 6770 745f 6e65  /modeling_gpt_ne
+0005ff20: 6f78 2e70 7923 4c4c 3235 3143 312d 4c32  ox.py#LL251C1-L2
+0005ff30: 3934 4332 380a 2020 2020 2020 2020 2020  94C28.          
+0005ff40: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0005ff50: 6e74 3634 5f74 2069 6220 3d20 303b 2069  nt64_t ib = 0; i
+0005ff60: 6220 3c20 6e65 302f 6e5f 6469 6d73 3b20  b < ne0/n_dims; 
+0005ff70: 2b2b 6962 2920 7b0a 2020 2020 2020 2020  ++ib) {.        
+0005ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ff90: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
+0005ffa0: 3d20 303b 2069 6320 3c20 6e5f 6469 6d73  = 0; ic < n_dims
+0005ffb0: 3b20 6963 202b 3d20 3229 207b 0a20 2020  ; ic += 2) {.   
+0005ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0005ffd0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+0005ffe0: 6c6f 6174 2063 6f73 5f74 6865 7461 203d  loat cos_theta =
+0005fff0: 2063 6f73 6628 7468 6574 6129 3b0a 2020   cosf(theta);.  
 00060000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060010: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
-00060020: 6174 615b 305d 2020 2020 203d 2047 474d  ata[0]     = GGM
-00060030: 4c5f 4650 3332 5f54 4f5f 4650 3136 2878  L_FP32_TO_FP16(x
-00060040: 302a 636f 735f 7468 6574 6120 2d20 7831  0*cos_theta - x1
-00060050: 2a73 696e 5f74 6865 7461 293b 0a20 2020  *sin_theta);.   
-00060060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060070: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-00060080: 615b 6e5f 6469 6d73 2f32 5d20 3d20 4747  a[n_dims/2] = GG
-00060090: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
-000600a0: 7830 2a73 696e 5f74 6865 7461 202b 2078  x0*sin_theta + x
-000600b0: 312a 636f 735f 7468 6574 6129 3b0a 2020  1*cos_theta);.  
+00060010: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00060020: 666c 6f61 7420 7369 6e5f 7468 6574 6120  float sin_theta 
+00060030: 3d20 7369 6e66 2874 6865 7461 293b 0a0a  = sinf(theta);..
+00060040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060050: 2020 2020 2020 2020 2020 2020 7468 6574              thet
+00060060: 6120 2a3d 2074 6865 7461 5f73 6361 6c65  a *= theta_scale
+00060070: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00060080: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00060090: 6f6e 7374 2069 6e74 3634 5f74 2069 3020  onst int64_t i0 
+000600a0: 3d20 6962 2a6e 5f64 696d 7320 2b20 6963  = ib*n_dims + ic
+000600b0: 2f32 3b0a 0a20 2020 2020 2020 2020 2020  /2;..           
 000600c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000600d0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000600e0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000600f0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00060100: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00060110: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-00060120: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00060130: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00060140: 645f 726f 7065 280a 2020 2020 2020 2020  d_rope(.        
-00060150: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00060160: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00060170: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00060180: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00060190: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000601a0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-000601b0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000601c0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-000601d0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000601e0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-000601f0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-00060200: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-00060210: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00060220: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
-00060230: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00060240: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00060250: 655f 666f 7277 6172 645f 726f 7065 5f66  e_forward_rope_f
-00060260: 3136 2870 6172 616d 732c 2073 7263 302c  16(params, src0,
-00060270: 2073 7263 312c 2064 7374 293b 0a20 2020   src1, dst);.   
-00060280: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00060290: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-000602a0: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-000602b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000602c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000602d0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000602e0: 5f72 6f70 655f 6633 3228 7061 7261 6d73  _rope_f32(params
-000602f0: 2c20 7372 6330 2c20 7372 6331 2c20 6473  , src0, src1, ds
-00060300: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-00060310: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00060320: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
-00060330: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00060340: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00060350: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
-00060360: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00060370: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
-00060380: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00060390: 645f 726f 7065 5f62 6163 6b0a 0a73 7461  d_rope_back..sta
-000603a0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-000603b0: 6d70 7574 655f 666f 7277 6172 645f 726f  mpute_forward_ro
-000603c0: 7065 5f62 6163 6b5f 6633 3228 0a20 2020  pe_back_f32(.   
-000603d0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000603e0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-000603f0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-00060400: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00060410: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00060420: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00060430: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00060440: 6d6c 5f74 656e 736f 7220 2a20 7372 6331  ml_tensor * src1
-00060450: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00060460: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00060470: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
-00060480: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
-00060490: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
-000604a0: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
-000604b0: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
-000604c0: 3d20 3329 3b0a 0a20 2020 2069 6620 2870  = 3);..    if (p
-000604d0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000604e0: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
-000604f0: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
-00060500: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-00060510: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-00060520: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00060530: 2020 2f2f 2079 203d 2072 6f70 6528 782c    // y = rope(x,
-00060540: 2073 7263 3129 0a20 2020 202f 2f20 6478   src1).    // dx
-00060550: 203d 2072 6f70 655f 6261 636b 2864 792c   = rope_back(dy,
-00060560: 2073 7263 3129 0a20 2020 202f 2f20 7372   src1).    // sr
-00060570: 6330 2069 7320 6479 2c20 7372 6331 2063  c0 is dy, src1 c
-00060580: 6f6e 7461 696e 7320 6f70 7469 6f6e 730a  ontains options.
-00060590: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-000605a0: 5f70 6173 7420 3d20 2828 696e 7433 325f  _past = ((int32_
-000605b0: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
-000605c0: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
-000605d0: 6e74 206e 5f64 696d 7320 3d20 2828 696e  nt n_dims = ((in
-000605e0: 7433 325f 7420 2a29 2073 7263 312d 3e64  t32_t *) src1->d
-000605f0: 6174 6129 5b31 5d3b 0a20 2020 2063 6f6e  ata)[1];.    con
-00060600: 7374 2069 6e74 206d 6f64 6520 2020 3d20  st int mode   = 
-00060610: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
-00060620: 312d 3e64 6174 6129 5b32 5d3b 0a0a 2020  1->data)[2];..  
-00060630: 2020 6173 7365 7274 286e 5f70 6173 7420    assert(n_past 
-00060640: 3e3d 2030 293b 0a0a 2020 2020 4747 4d4c  >= 0);..    GGML
-00060650: 5f54 454e 534f 525f 554e 4152 595f 4f50  _TENSOR_UNARY_OP
-00060660: 5f4c 4f43 414c 533b 0a0a 2020 2020 2f2f  _LOCALS;..    //
-00060670: 7072 696e 7466 2822 6e65 303a 2025 642c  printf("ne0: %d,
-00060680: 206e 6531 3a20 2564 2c20 6e65 323a 2025   ne1: %d, ne2: %
-00060690: 642c 206e 6533 3a20 2564 5c6e 222c 206e  d, ne3: %d\n", n
-000606a0: 6530 2c20 6e65 312c 206e 6532 2c20 6e65  e0, ne1, ne2, ne
-000606b0: 3329 3b0a 2020 2020 2f2f 7072 696e 7466  3);.    //printf
-000606c0: 2822 6e5f 7061 7374 203d 2025 642c 206e  ("n_past = %d, n
-000606d0: 6532 203d 2025 645c 6e22 2c20 6e5f 7061  e2 = %d\n", n_pa
-000606e0: 7374 2c20 6e65 3229 3b0a 0a20 2020 2061  st, ne2);..    a
-000606f0: 7373 6572 7428 6e62 3020 3d3d 2073 697a  ssert(nb0 == siz
-00060700: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00060710: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-00060720: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
-00060730: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-00060740: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
-00060750: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00060760: 7220 3d20 6767 6d6c 5f6e 726f 7773 2864  r = ggml_nrows(d
-00060770: 7374 293b 0a0a 2020 2020 2f2f 2072 6f77  st);..    // row
-00060780: 7320 7065 7220 7468 7265 6164 0a20 2020  s per thread.   
-00060790: 2063 6f6e 7374 2069 6e74 2064 7220 3d20   const int dr = 
-000607a0: 286e 7220 2b20 6e74 6820 2d20 3129 2f6e  (nr + nth - 1)/n
-000607b0: 7468 3b0a 0a20 2020 202f 2f20 726f 7720  th;..    // row 
-000607c0: 7261 6e67 6520 666f 7220 7468 6973 2074  range for this t
-000607d0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
-000607e0: 696e 7420 6972 3020 3d20 6472 2a69 7468  int ir0 = dr*ith
-000607f0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00060800: 6972 3120 3d20 4d49 4e28 6972 3020 2b20  ir1 = MIN(ir0 + 
-00060810: 6472 2c20 6e72 293b 0a0a 2020 2020 2f2f  dr, nr);..    //
-00060820: 2072 6f77 2069 6e64 6578 2075 7365 6420   row index used 
-00060830: 746f 2064 6574 6572 6d69 6e65 2077 6869  to determine whi
-00060840: 6368 2074 6872 6561 6420 746f 2075 7365  ch thread to use
-00060850: 0a20 2020 2069 6e74 2069 7220 3d20 303b  .    int ir = 0;
-00060860: 0a0a 2020 2020 636f 6e73 7420 666c 6f61  ..    const floa
-00060870: 7420 7468 6574 615f 7363 616c 6520 3d20  t theta_scale = 
-00060880: 706f 7766 2831 3030 3030 2e30 2c20 2d32  powf(10000.0, -2
-00060890: 2e30 662f 6e5f 6469 6d73 293b 0a0a 2020  .0f/n_dims);..  
-000608a0: 2020 636f 6e73 7420 626f 6f6c 2069 735f    const bool is_
-000608b0: 6e65 6f78 203d 206d 6f64 6520 2620 323b  neox = mode & 2;
-000608c0: 0a0a 2020 2020 666f 7220 2869 6e74 3634  ..    for (int64
-000608d0: 5f74 2069 3320 3d20 303b 2069 3320 3c20  _t i3 = 0; i3 < 
-000608e0: 6e65 333b 2069 332b 2b29 207b 0a20 2020  ne3; i3++) {.   
-000608f0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00060900: 7420 6932 203d 2028 286d 6f64 6520 2620  t i2 = ((mode & 
-00060910: 3129 203d 3d20 3020 3f20 3020 3a20 6e5f  1) == 0 ? 0 : n_
-00060920: 7061 7374 293b 2069 3220 3c20 6e65 323b  past); i2 < ne2;
-00060930: 2069 322b 2b29 207b 0a20 2020 2020 2020   i2++) {.       
-00060940: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-00060950: 5f74 2070 203d 2028 286d 6f64 6520 2620  _t p = ((mode & 
-00060960: 3129 203d 3d20 3020 3f20 6e5f 7061 7374  1) == 0 ? n_past
-00060970: 202b 2069 3220 3a20 6932 293b 0a20 2020   + i2 : i2);.   
-00060980: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00060990: 7436 345f 7420 6931 203d 2030 3b20 6931  t64_t i1 = 0; i1
-000609a0: 203c 206e 6531 3b20 6931 2b2b 2920 7b0a   < ne1; i1++) {.
-000609b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000609c0: 6966 2028 6972 2b2b 203c 2069 7230 2920  if (ir++ < ir0) 
-000609d0: 636f 6e74 696e 7565 3b0a 2020 2020 2020  continue;.      
-000609e0: 2020 2020 2020 2020 2020 6966 2028 6972            if (ir
-000609f0: 2020 203e 2069 7231 2920 6272 6561 6b3b     > ir1) break;
-00060a00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00060a10: 2020 666c 6f61 7420 7468 6574 6120 3d20    float theta = 
-00060a20: 2866 6c6f 6174 2970 3b0a 0a20 2020 2020  (float)p;..     
-00060a30: 2020 2020 2020 2020 2020 2069 6620 2821             if (!
-00060a40: 6973 5f6e 656f 7829 207b 0a20 2020 2020  is_neox) {.     
-00060a50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00060a60: 6f72 2028 696e 7436 345f 7420 6930 203d  or (int64_t i0 =
-00060a70: 2030 3b20 6930 203c 206e 6530 3b20 6930   0; i0 < ne0; i0
-00060a80: 202b 3d20 3229 207b 0a20 2020 2020 2020   += 2) {.       
-00060a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060aa0: 2063 6f6e 7374 2066 6c6f 6174 2063 6f73   const float cos
-00060ab0: 5f74 6865 7461 203d 2063 6f73 6628 7468  _theta = cosf(th
-00060ac0: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
-00060ad0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00060ae0: 6e73 7420 666c 6f61 7420 7369 6e5f 7468  nst float sin_th
-00060af0: 6574 6120 3d20 7369 6e66 2874 6865 7461  eta = sinf(theta
-00060b00: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00060b10: 2020 2020 2020 2020 2020 2020 7468 6574              thet
-00060b20: 6120 2a3d 2074 6865 7461 5f73 6361 6c65  a *= theta_scale
-00060b30: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00060b40: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00060b50: 2066 6c6f 6174 202a 2063 6f6e 7374 2064   float * const d
-00060b60: 7920 203d 2028 666c 6f61 7420 2a29 2828  y  = (float *)((
-00060b70: 6368 6172 202a 2920 7372 6330 2d3e 6461  char *) src0->da
-00060b80: 7461 202b 2069 332a 6e62 3033 202b 2069  ta + i3*nb03 + i
-00060b90: 322a 6e62 3032 202b 2069 312a 6e62 3031  2*nb02 + i1*nb01
-00060ba0: 202b 2069 302a 6e62 3030 293b 0a20 2020   + i0*nb00);.   
-00060bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060bc0: 2020 2020 2020 2020 2020 2066 6c6f 6174             float
-00060bd0: 202a 2020 2020 2020 2064 7820 203d 2028   *       dx  = (
-00060be0: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-00060bf0: 2920 2064 7374 2d3e 6461 7461 202b 2069  )  dst->data + i
-00060c00: 332a 6e62 3320 202b 2069 322a 6e62 3220  3*nb3  + i2*nb2 
-00060c10: 202b 2069 312a 6e62 3120 202b 2069 302a   + i1*nb1  + i0*
-00060c20: 6e62 3029 3b0a 0a20 2020 2020 2020 2020  nb0);..         
-00060c30: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00060c40: 6f6e 7374 2066 6c6f 6174 2064 7930 203d  onst float dy0 =
-00060c50: 2064 795b 305d 3b0a 2020 2020 2020 2020   dy[0];.        
-00060c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060c70: 636f 6e73 7420 666c 6f61 7420 6479 3120  const float dy1 
-00060c80: 3d20 6479 5b31 5d3b 0a0a 2020 2020 2020  = dy[1];..      
-00060c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060ca0: 2020 6478 5b30 5d20 3d20 2020 6479 302a    dx[0] =   dy0*
-00060cb0: 636f 735f 7468 6574 6120 2b20 6479 312a  cos_theta + dy1*
-00060cc0: 7369 6e5f 7468 6574 613b 0a20 2020 2020  sin_theta;.     
-00060cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060ce0: 2020 2064 785b 315d 203d 202d 2064 7930     dx[1] = - dy0
-00060cf0: 2a73 696e 5f74 6865 7461 202b 2064 7931  *sin_theta + dy1
-00060d00: 2a63 6f73 5f74 6865 7461 3b0a 2020 2020  *cos_theta;.    
-00060d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060d20: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00060d30: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00060d40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00060d50: 6f72 2028 696e 7436 345f 7420 6962 203d  or (int64_t ib =
-00060d60: 2030 3b20 6962 203c 206e 6530 2f6e 5f64   0; ib < ne0/n_d
-00060d70: 696d 733b 202b 2b69 6229 207b 0a20 2020  ims; ++ib) {.   
-00060d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060d90: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00060da0: 7420 6963 203d 2030 3b20 6963 203c 206e  t ic = 0; ic < n
-00060db0: 5f64 696d 733b 2069 6320 2b3d 2032 2920  _dims; ic += 2) 
-00060dc0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00060dd0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00060de0: 6e73 7420 666c 6f61 7420 636f 735f 7468  nst float cos_th
-00060df0: 6574 6120 3d20 636f 7366 2874 6865 7461  eta = cosf(theta
-00060e00: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00060e10: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00060e20: 6f6e 7374 2066 6c6f 6174 2073 696e 5f74  onst float sin_t
-00060e30: 6865 7461 203d 2073 696e 6628 7468 6574  heta = sinf(thet
-00060e40: 6129 3b0a 0a20 2020 2020 2020 2020 2020  a);..           
-00060e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060e60: 2074 6865 7461 202a 3d20 7468 6574 615f   theta *= theta_
-00060e70: 7363 616c 653b 0a0a 2020 2020 2020 2020  scale;..        
-00060e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060e90: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00060ea0: 7420 6930 203d 2069 622a 6e5f 6469 6d73  t i0 = ib*n_dims
-00060eb0: 202b 2069 632f 323b 0a0a 2020 2020 2020   + ic/2;..      
+000600d0: 2063 6f6e 7374 2067 676d 6c5f 6670 3136   const ggml_fp16
+000600e0: 5f74 202a 2063 6f6e 7374 2073 7263 203d  _t * const src =
+000600f0: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00060100: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+00060110: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
+00060120: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
+00060130: 3031 202b 2069 302a 6e62 3030 293b 0a20  01 + i0*nb00);. 
+00060140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060160: 2067 676d 6c5f 6670 3136 5f74 202a 2064   ggml_fp16_t * d
+00060170: 7374 5f64 6174 6120 203d 2028 6767 6d6c  st_data  = (ggml
+00060180: 5f66 7031 365f 7420 2a29 2828 6368 6172  _fp16_t *)((char
+00060190: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+000601a0: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
+000601b0: 3220 202b 2069 312a 6e62 3120 202b 2069  2  + i1*nb1  + i
+000601c0: 302a 6e62 3029 3b0a 0a20 2020 2020 2020  0*nb0);..       
+000601d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000601e0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+000601f0: 2078 3020 3d20 4747 4d4c 5f46 5031 365f   x0 = GGML_FP16_
+00060200: 544f 5f46 5033 3228 7372 635b 305d 293b  TO_FP32(src[0]);
+00060210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00060220: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00060230: 7374 2066 6c6f 6174 2078 3120 3d20 4747  st float x1 = GG
+00060240: 4d4c 5f46 5031 365f 544f 5f46 5033 3228  ML_FP16_TO_FP32(
+00060250: 7372 635b 6e5f 6469 6d73 2f32 5d29 3b0a  src[n_dims/2]);.
+00060260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00060270: 2020 2020 2020 2020 2020 2020 2064 7374               dst
+00060280: 5f64 6174 615b 305d 2020 2020 203d 2047  _data[0]     = G
+00060290: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+000602a0: 2878 302a 636f 735f 7468 6574 6120 2d20  (x0*cos_theta - 
+000602b0: 7831 2a73 696e 5f74 6865 7461 293b 0a20  x1*sin_theta);. 
+000602c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000602d0: 2020 2020 2020 2020 2020 2064 7374 5f64             dst_d
+000602e0: 6174 615b 6e5f 6469 6d73 2f32 5d20 3d20  ata[n_dims/2] = 
+000602f0: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
+00060300: 3628 7830 2a73 696e 5f74 6865 7461 202b  6(x0*sin_theta +
+00060310: 2078 312a 636f 735f 7468 6574 6129 3b0a   x1*cos_theta);.
+00060320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060330: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00060340: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00060350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060360: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+00060370: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+00060380: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+00060390: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000603a0: 6172 645f 726f 7065 280a 2020 2020 2020  ard_rope(.      
+000603b0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000603c0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000603d0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000603e0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000603f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00060400: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
+00060410: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00060420: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00060430: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00060440: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00060450: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+00060460: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+00060470: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00060480: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+00060490: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000604a0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+000604b0: 7574 655f 666f 7277 6172 645f 726f 7065  ute_forward_rope
+000604c0: 5f66 3136 2870 6172 616d 732c 2073 7263  _f16(params, src
+000604d0: 302c 2073 7263 312c 2064 7374 293b 0a20  0, src1, dst);. 
+000604e0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000604f0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00060500: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+00060510: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00060520: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00060530: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00060540: 7264 5f72 6f70 655f 6633 3228 7061 7261  rd_rope_f32(para
+00060550: 6d73 2c20 7372 6330 2c20 7372 6331 2c20  ms, src0, src1, 
+00060560: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+00060570: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00060580: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00060590: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000605a0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+000605b0: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+000605c0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000605d0: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+000605e0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000605f0: 6172 645f 726f 7065 5f62 6163 6b0a 0a73  ard_rope_back..s
+00060600: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00060610: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00060620: 726f 7065 5f62 6163 6b5f 6633 3228 0a20  rope_back_f32(. 
+00060630: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00060640: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00060650: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00060660: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00060670: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00060680: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00060690: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+000606a0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+000606b0: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
+000606c0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000606d0: 2064 7374 2920 7b0a 2020 2020 6173 7365   dst) {.    asse
+000606e0: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
+000606f0: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
+00060700: 0a20 2020 2061 7373 6572 7428 6767 6d6c  .    assert(ggml
+00060710: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
+00060720: 203d 3d20 3329 3b0a 0a20 2020 2069 6620   == 3);..    if 
+00060730: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00060740: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
+00060750: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
+00060760: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00060770: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+00060780: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00060790: 2020 2020 2f2f 2079 203d 2072 6f70 6528      // y = rope(
+000607a0: 782c 2073 7263 3129 0a20 2020 202f 2f20  x, src1).    // 
+000607b0: 6478 203d 2072 6f70 655f 6261 636b 2864  dx = rope_back(d
+000607c0: 792c 2073 7263 3129 0a20 2020 202f 2f20  y, src1).    // 
+000607d0: 7372 6330 2069 7320 6479 2c20 7372 6331  src0 is dy, src1
+000607e0: 2063 6f6e 7461 696e 7320 6f70 7469 6f6e   contains option
+000607f0: 730a 0a20 2020 2063 6f6e 7374 2069 6e74  s..    const int
+00060800: 206e 5f70 6173 7420 3d20 2828 696e 7433   n_past = ((int3
+00060810: 325f 7420 2a29 2073 7263 312d 3e64 6174  2_t *) src1->dat
+00060820: 6129 5b30 5d3b 0a20 2020 2063 6f6e 7374  a)[0];.    const
+00060830: 2069 6e74 206e 5f64 696d 7320 3d20 2828   int n_dims = ((
+00060840: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
+00060850: 3e64 6174 6129 5b31 5d3b 0a20 2020 2063  >data)[1];.    c
+00060860: 6f6e 7374 2069 6e74 206d 6f64 6520 2020  onst int mode   
+00060870: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
+00060880: 7263 312d 3e64 6174 6129 5b32 5d3b 0a0a  rc1->data)[2];..
+00060890: 2020 2020 6173 7365 7274 286e 5f70 6173      assert(n_pas
+000608a0: 7420 3e3d 2030 293b 0a0a 2020 2020 4747  t >= 0);..    GG
+000608b0: 4d4c 5f54 454e 534f 525f 554e 4152 595f  ML_TENSOR_UNARY_
+000608c0: 4f50 5f4c 4f43 414c 533b 0a0a 2020 2020  OP_LOCALS;..    
+000608d0: 2f2f 7072 696e 7466 2822 6e65 303a 2025  //printf("ne0: %
+000608e0: 642c 206e 6531 3a20 2564 2c20 6e65 323a  d, ne1: %d, ne2:
+000608f0: 2025 642c 206e 6533 3a20 2564 5c6e 222c   %d, ne3: %d\n",
+00060900: 206e 6530 2c20 6e65 312c 206e 6532 2c20   ne0, ne1, ne2, 
+00060910: 6e65 3329 3b0a 2020 2020 2f2f 7072 696e  ne3);.    //prin
+00060920: 7466 2822 6e5f 7061 7374 203d 2025 642c  tf("n_past = %d,
+00060930: 206e 6532 203d 2025 645c 6e22 2c20 6e5f   ne2 = %d\n", n_
+00060940: 7061 7374 2c20 6e65 3229 3b0a 0a20 2020  past, ne2);..   
+00060950: 2061 7373 6572 7428 6e62 3020 3d3d 2073   assert(nb0 == s
+00060960: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+00060970: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
+00060980: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
+00060990: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000609a0: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
+000609b0: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+000609c0: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
+000609d0: 2864 7374 293b 0a0a 2020 2020 2f2f 2072  (dst);..    // r
+000609e0: 6f77 7320 7065 7220 7468 7265 6164 0a20  ows per thread. 
+000609f0: 2020 2063 6f6e 7374 2069 6e74 2064 7220     const int dr 
+00060a00: 3d20 286e 7220 2b20 6e74 6820 2d20 3129  = (nr + nth - 1)
+00060a10: 2f6e 7468 3b0a 0a20 2020 202f 2f20 726f  /nth;..    // ro
+00060a20: 7720 7261 6e67 6520 666f 7220 7468 6973  w range for this
+00060a30: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+00060a40: 7420 696e 7420 6972 3020 3d20 6472 2a69  t int ir0 = dr*i
+00060a50: 7468 3b0a 2020 2020 636f 6e73 7420 696e  th;.    const in
+00060a60: 7420 6972 3120 3d20 4d49 4e28 6972 3020  t ir1 = MIN(ir0 
+00060a70: 2b20 6472 2c20 6e72 293b 0a0a 2020 2020  + dr, nr);..    
+00060a80: 2f2f 2072 6f77 2069 6e64 6578 2075 7365  // row index use
+00060a90: 6420 746f 2064 6574 6572 6d69 6e65 2077  d to determine w
+00060aa0: 6869 6368 2074 6872 6561 6420 746f 2075  hich thread to u
+00060ab0: 7365 0a20 2020 2069 6e74 2069 7220 3d20  se.    int ir = 
+00060ac0: 303b 0a0a 2020 2020 636f 6e73 7420 666c  0;..    const fl
+00060ad0: 6f61 7420 7468 6574 615f 7363 616c 6520  oat theta_scale 
+00060ae0: 3d20 706f 7766 2831 3030 3030 2e30 2c20  = powf(10000.0, 
+00060af0: 2d32 2e30 662f 6e5f 6469 6d73 293b 0a0a  -2.0f/n_dims);..
+00060b00: 2020 2020 636f 6e73 7420 626f 6f6c 2069      const bool i
+00060b10: 735f 6e65 6f78 203d 206d 6f64 6520 2620  s_neox = mode & 
+00060b20: 323b 0a0a 2020 2020 666f 7220 2869 6e74  2;..    for (int
+00060b30: 3634 5f74 2069 3320 3d20 303b 2069 3320  64_t i3 = 0; i3 
+00060b40: 3c20 6e65 333b 2069 332b 2b29 207b 0a20  < ne3; i3++) {. 
+00060b50: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00060b60: 345f 7420 6932 203d 2028 286d 6f64 6520  4_t i2 = ((mode 
+00060b70: 2620 3129 203d 3d20 3020 3f20 3020 3a20  & 1) == 0 ? 0 : 
+00060b80: 6e5f 7061 7374 293b 2069 3220 3c20 6e65  n_past); i2 < ne
+00060b90: 323b 2069 322b 2b29 207b 0a20 2020 2020  2; i2++) {.     
+00060ba0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00060bb0: 3634 5f74 2070 203d 2028 286d 6f64 6520  64_t p = ((mode 
+00060bc0: 2620 3129 203d 3d20 3020 3f20 6e5f 7061  & 1) == 0 ? n_pa
+00060bd0: 7374 202b 2069 3220 3a20 6932 293b 0a20  st + i2 : i2);. 
+00060be0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+00060bf0: 696e 7436 345f 7420 6931 203d 2030 3b20  int64_t i1 = 0; 
+00060c00: 6931 203c 206e 6531 3b20 6931 2b2b 2920  i1 < ne1; i1++) 
+00060c10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00060c20: 2020 6966 2028 6972 2b2b 203c 2069 7230    if (ir++ < ir0
+00060c30: 2920 636f 6e74 696e 7565 3b0a 2020 2020  ) continue;.    
+00060c40: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00060c50: 6972 2020 203e 2069 7231 2920 6272 6561  ir   > ir1) brea
+00060c60: 6b3b 0a0a 2020 2020 2020 2020 2020 2020  k;..            
+00060c70: 2020 2020 666c 6f61 7420 7468 6574 6120      float theta 
+00060c80: 3d20 2866 6c6f 6174 2970 3b0a 0a20 2020  = (float)p;..   
+00060c90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00060ca0: 2821 6973 5f6e 656f 7829 207b 0a20 2020  (!is_neox) {.   
+00060cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060cc0: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+00060cd0: 203d 2030 3b20 6930 203c 206e 6530 3b20   = 0; i0 < ne0; 
+00060ce0: 6930 202b 3d20 3229 207b 0a20 2020 2020  i0 += 2) {.     
+00060cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060d00: 2020 2063 6f6e 7374 2066 6c6f 6174 2063     const float c
+00060d10: 6f73 5f74 6865 7461 203d 2063 6f73 6628  os_theta = cosf(
+00060d20: 7468 6574 6129 3b0a 2020 2020 2020 2020  theta);.        
+00060d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060d40: 636f 6e73 7420 666c 6f61 7420 7369 6e5f  const float sin_
+00060d50: 7468 6574 6120 3d20 7369 6e66 2874 6865  theta = sinf(the
+00060d60: 7461 293b 0a0a 2020 2020 2020 2020 2020  ta);..          
+00060d70: 2020 2020 2020 2020 2020 2020 2020 7468                th
+00060d80: 6574 6120 2a3d 2074 6865 7461 5f73 6361  eta *= theta_sca
+00060d90: 6c65 3b0a 0a20 2020 2020 2020 2020 2020  le;..           
+00060da0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00060db0: 7374 2066 6c6f 6174 202a 2063 6f6e 7374  st float * const
+00060dc0: 2064 7920 203d 2028 666c 6f61 7420 2a29   dy  = (float *)
+00060dd0: 2828 6368 6172 202a 2920 7372 6330 2d3e  ((char *) src0->
+00060de0: 6461 7461 202b 2069 332a 6e62 3033 202b  data + i3*nb03 +
+00060df0: 2069 322a 6e62 3032 202b 2069 312a 6e62   i2*nb02 + i1*nb
+00060e00: 3031 202b 2069 302a 6e62 3030 293b 0a20  01 + i0*nb00);. 
+00060e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060e20: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+00060e30: 6174 202a 2020 2020 2020 2064 7820 203d  at *       dx  =
+00060e40: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+00060e50: 202a 2920 2064 7374 2d3e 6461 7461 202b   *)  dst->data +
+00060e60: 2069 332a 6e62 3320 202b 2069 322a 6e62   i3*nb3  + i2*nb
+00060e70: 3220 202b 2069 312a 6e62 3120 202b 2069  2  + i1*nb1  + i
+00060e80: 302a 6e62 3029 3b0a 0a20 2020 2020 2020  0*nb0);..       
+00060e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060ea0: 2063 6f6e 7374 2066 6c6f 6174 2064 7930   const float dy0
+00060eb0: 203d 2064 795b 305d 3b0a 2020 2020 2020   = dy[0];.      
 00060ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060ed0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-00060ee0: 7420 2a20 636f 6e73 7420 6479 2020 3d20  t * const dy  = 
-00060ef0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
-00060f00: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
-00060f10: 6933 2a6e 6230 3320 2b20 6932 2a6e 6230  i3*nb03 + i2*nb0
-00060f20: 3220 2b20 6931 2a6e 6230 3120 2b20 6930  2 + i1*nb01 + i0
-00060f30: 2a6e 6230 3029 3b0a 2020 2020 2020 2020  *nb00);.        
-00060f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060f50: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-00060f60: 2a20 2020 2020 2020 6478 2020 3d20 2866  *       dx  = (f
-00060f70: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
-00060f80: 2020 6473 742d 3e64 6174 6120 2b20 6933    dst->data + i3
-00060f90: 2a6e 6233 2020 2b20 6932 2a6e 6232 2020  *nb3  + i2*nb2  
-00060fa0: 2b20 6931 2a6e 6231 2020 2b20 6930 2a6e  + i1*nb1  + i0*n
-00060fb0: 6230 293b 0a0a 2020 2020 2020 2020 2020  b0);..          
-00060fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00060fd0: 2020 636f 6e73 7420 666c 6f61 7420 6479    const float dy
-00060fe0: 3020 3d20 6479 5b30 5d3b 0a20 2020 2020  0 = dy[0];.     
-00060ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061000: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-00061010: 6174 2064 7931 203d 2064 795b 6e5f 6469  at dy1 = dy[n_di
-00061020: 6d73 2f32 5d3b 0a0a 2020 2020 2020 2020  ms/2];..        
+00060ed0: 2020 636f 6e73 7420 666c 6f61 7420 6479    const float dy
+00060ee0: 3120 3d20 6479 5b31 5d3b 0a0a 2020 2020  1 = dy[1];..    
+00060ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060f00: 2020 2020 6478 5b30 5d20 3d20 2020 6479      dx[0] =   dy
+00060f10: 302a 636f 735f 7468 6574 6120 2b20 6479  0*cos_theta + dy
+00060f20: 312a 7369 6e5f 7468 6574 613b 0a20 2020  1*sin_theta;.   
+00060f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060f40: 2020 2020 2064 785b 315d 203d 202d 2064       dx[1] = - d
+00060f50: 7930 2a73 696e 5f74 6865 7461 202b 2064  y0*sin_theta + d
+00060f60: 7931 2a63 6f73 5f74 6865 7461 3b0a 2020  y1*cos_theta;.  
+00060f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060f80: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00060f90: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+00060fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060fb0: 2066 6f72 2028 696e 7436 345f 7420 6962   for (int64_t ib
+00060fc0: 203d 2030 3b20 6962 203c 206e 6530 2f6e   = 0; ib < ne0/n
+00060fd0: 5f64 696d 733b 202b 2b69 6229 207b 0a20  _dims; ++ib) {. 
+00060fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00060ff0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00061000: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
+00061010: 206e 5f64 696d 733b 2069 6320 2b3d 2032   n_dims; ic += 2
+00061020: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
 00061030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061040: 2020 2020 6478 5b30 5d20 2020 2020 2020      dx[0]       
-00061050: 203d 2020 2064 7930 2a63 6f73 5f74 6865   =   dy0*cos_the
-00061060: 7461 202b 2064 7931 2a73 696e 5f74 6865  ta + dy1*sin_the
-00061070: 7461 3b0a 2020 2020 2020 2020 2020 2020  ta;.            
-00061080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061090: 6478 5b6e 5f64 696d 732f 325d 203d 202d  dx[n_dims/2] = -
-000610a0: 2064 7930 2a73 696e 5f74 6865 7461 202b   dy0*sin_theta +
-000610b0: 2064 7931 2a63 6f73 5f74 6865 7461 3b0a   dy1*cos_theta;.
-000610c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000610d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000610e0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-000610f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061100: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-00061110: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00061120: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00061130: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00061140: 6172 645f 726f 7065 5f62 6163 6b5f 6631  ard_rope_back_f1
-00061150: 3628 0a20 2020 2020 2020 2063 6f6e 7374  6(.        const
-00061160: 2073 7472 7563 7420 6767 6d6c 5f63 6f6d   struct ggml_com
-00061170: 7075 7465 5f70 6172 616d 7320 2a20 7061  pute_params * pa
-00061180: 7261 6d73 2c0a 2020 2020 2020 2020 636f  rams,.        co
-00061190: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000611a0: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-000611b0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000611c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000611d0: 2a20 7372 6331 2c0a 2020 2020 2020 2020  * src1,.        
-000611e0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000611f0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-00061200: 6173 7365 7274 2873 7263 312d 3e74 7970  assert(src1->typ
-00061210: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
-00061220: 3332 293b 0a20 2020 2061 7373 6572 7428  32);.    assert(
-00061230: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-00061240: 7263 3129 203d 3d20 3329 3b0a 0a20 2020  rc1) == 3);..   
-00061250: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
-00061260: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
-00061270: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
-00061280: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00061290: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-000612a0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-000612b0: 207d 0a0a 2020 2020 2f2f 2079 203d 2072   }..    // y = r
-000612c0: 6f70 6528 782c 2073 7263 3129 0a20 2020  ope(x, src1).   
-000612d0: 202f 2f20 6478 203d 2072 6f70 655f 6261   // dx = rope_ba
-000612e0: 636b 2864 792c 2073 7263 3129 0a20 2020  ck(dy, src1).   
-000612f0: 202f 2f20 7372 6330 2069 7320 6479 2c20   // src0 is dy, 
-00061300: 7372 6331 2063 6f6e 7461 696e 7320 6f70  src1 contains op
-00061310: 7469 6f6e 730a 0a20 2020 2063 6f6e 7374  tions..    const
-00061320: 2069 6e74 206e 5f70 6173 7420 3d20 2828   int n_past = ((
-00061330: 696e 7433 325f 7420 2a29 2073 7263 312d  int32_t *) src1-
-00061340: 3e64 6174 6129 5b30 5d3b 0a20 2020 2063  >data)[0];.    c
-00061350: 6f6e 7374 2069 6e74 206e 5f64 696d 7320  onst int n_dims 
-00061360: 3d20 2828 696e 7433 325f 7420 2a29 2073  = ((int32_t *) s
-00061370: 7263 312d 3e64 6174 6129 5b31 5d3b 0a20  rc1->data)[1];. 
-00061380: 2020 2063 6f6e 7374 2069 6e74 206d 6f64     const int mod
-00061390: 6520 2020 3d20 2828 696e 7433 325f 7420  e   = ((int32_t 
-000613a0: 2a29 2073 7263 312d 3e64 6174 6129 5b32  *) src1->data)[2
-000613b0: 5d3b 0a0a 2020 2020 6173 7365 7274 286e  ];..    assert(n
-000613c0: 5f70 6173 7420 3e3d 2030 293b 0a0a 2020  _past >= 0);..  
-000613d0: 2020 4747 4d4c 5f54 454e 534f 525f 554e    GGML_TENSOR_UN
-000613e0: 4152 595f 4f50 5f4c 4f43 414c 533b 0a0a  ARY_OP_LOCALS;..
-000613f0: 2020 2020 2f2f 7072 696e 7466 2822 6e65      //printf("ne
-00061400: 303a 2025 642c 206e 6531 3a20 2564 2c20  0: %d, ne1: %d, 
-00061410: 6e65 323a 2025 642c 206e 6533 3a20 2564  ne2: %d, ne3: %d
-00061420: 5c6e 222c 206e 6530 2c20 6e65 312c 206e  \n", ne0, ne1, n
-00061430: 6532 2c20 6e65 3329 3b0a 2020 2020 2f2f  e2, ne3);.    //
-00061440: 7072 696e 7466 2822 6e5f 7061 7374 203d  printf("n_past =
-00061450: 2025 642c 206e 6532 203d 2025 645c 6e22   %d, ne2 = %d\n"
-00061460: 2c20 6e5f 7061 7374 2c20 6e65 3229 3b0a  , n_past, ne2);.
-00061470: 0a20 2020 2061 7373 6572 7428 6e62 3020  .    assert(nb0 
-00061480: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-00061490: 7031 365f 7429 293b 0a0a 2020 2020 636f  p16_t));..    co
-000614a0: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
-000614b0: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
-000614c0: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
-000614d0: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
-000614e0: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
-000614f0: 6767 6d6c 5f6e 726f 7773 2864 7374 293b  ggml_nrows(dst);
-00061500: 0a0a 2020 2020 2f2f 2072 6f77 7320 7065  ..    // rows pe
-00061510: 7220 7468 7265 6164 0a20 2020 2063 6f6e  r thread.    con
-00061520: 7374 2069 6e74 2064 7220 3d20 286e 7220  st int dr = (nr 
-00061530: 2b20 6e74 6820 2d20 3129 2f6e 7468 3b0a  + nth - 1)/nth;.
-00061540: 0a20 2020 202f 2f20 726f 7720 7261 6e67  .    // row rang
-00061550: 6520 666f 7220 7468 6973 2074 6872 6561  e for this threa
-00061560: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-00061570: 6972 3020 3d20 6472 2a69 7468 3b0a 2020  ir0 = dr*ith;.  
-00061580: 2020 636f 6e73 7420 696e 7420 6972 3120    const int ir1 
-00061590: 3d20 4d49 4e28 6972 3020 2b20 6472 2c20  = MIN(ir0 + dr, 
-000615a0: 6e72 293b 0a0a 2020 2020 2f2f 2072 6f77  nr);..    // row
-000615b0: 2069 6e64 6578 2075 7365 6420 746f 2064   index used to d
-000615c0: 6574 6572 6d69 6e65 2077 6869 6368 2074  etermine which t
-000615d0: 6872 6561 6420 746f 2075 7365 0a20 2020  hread to use.   
-000615e0: 2069 6e74 2069 7220 3d20 303b 0a0a 2020   int ir = 0;..  
-000615f0: 2020 636f 6e73 7420 666c 6f61 7420 7468    const float th
-00061600: 6574 615f 7363 616c 6520 3d20 706f 7766  eta_scale = powf
-00061610: 2831 3030 3030 2e30 2c20 2d32 2e30 662f  (10000.0, -2.0f/
-00061620: 6e5f 6469 6d73 293b 0a0a 2020 2020 636f  n_dims);..    co
-00061630: 6e73 7420 626f 6f6c 2069 735f 6e65 6f78  nst bool is_neox
-00061640: 203d 206d 6f64 6520 2620 323b 0a0a 2020   = mode & 2;..  
-00061650: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-00061660: 3320 3d20 303b 2069 3320 3c20 6e65 333b  3 = 0; i3 < ne3;
-00061670: 2069 332b 2b29 207b 0a20 2020 2020 2020   i3++) {.       
-00061680: 2066 6f72 2028 696e 7436 345f 7420 6932   for (int64_t i2
-00061690: 203d 2028 286d 6f64 6520 2620 3129 203d   = ((mode & 1) =
-000616a0: 3d20 3020 3f20 3020 3a20 6e5f 7061 7374  = 0 ? 0 : n_past
-000616b0: 293b 2069 3220 3c20 6e65 323b 2069 322b  ); i2 < ne2; i2+
-000616c0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-000616d0: 2063 6f6e 7374 2069 6e74 3634 5f74 2070   const int64_t p
-000616e0: 203d 2028 286d 6f64 6520 2620 3129 203d   = ((mode & 1) =
-000616f0: 3d20 3020 3f20 6e5f 7061 7374 202b 2069  = 0 ? n_past + i
-00061700: 3220 3a20 6932 293b 0a20 2020 2020 2020  2 : i2);.       
-00061710: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00061720: 7420 6931 203d 2030 3b20 6931 203c 206e  t i1 = 0; i1 < n
-00061730: 6531 3b20 6931 2b2b 2920 7b0a 2020 2020  e1; i1++) {.    
-00061740: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00061750: 6972 2b2b 203c 2069 7230 2920 636f 6e74  ir++ < ir0) cont
-00061760: 696e 7565 3b0a 2020 2020 2020 2020 2020  inue;.          
-00061770: 2020 2020 2020 6966 2028 6972 2020 203e        if (ir   >
-00061780: 2069 7231 2920 6272 6561 6b3b 0a0a 2020   ir1) break;..  
-00061790: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-000617a0: 6f61 7420 7468 6574 6120 3d20 2866 6c6f  oat theta = (flo
-000617b0: 6174 2970 3b0a 0a20 2020 2020 2020 2020  at)p;..         
-000617c0: 2020 2020 2020 2069 6620 2821 6973 5f6e         if (!is_n
-000617d0: 656f 7829 207b 0a20 2020 2020 2020 2020  eox) {.         
-000617e0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-000617f0: 696e 7436 345f 7420 6930 203d 2030 3b20  int64_t i0 = 0; 
-00061800: 6930 203c 206e 6530 3b20 6930 202b 3d20  i0 < ne0; i0 += 
-00061810: 3229 207b 0a20 2020 2020 2020 2020 2020  2) {.           
-00061820: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00061830: 7374 2066 6c6f 6174 2063 6f73 5f74 6865  st float cos_the
-00061840: 7461 203d 2063 6f73 6628 7468 6574 6129  ta = cosf(theta)
-00061850: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00061860: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00061870: 666c 6f61 7420 7369 6e5f 7468 6574 6120  float sin_theta 
-00061880: 3d20 7369 6e66 2874 6865 7461 293b 0a0a  = sinf(theta);..
-00061890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000618a0: 2020 2020 2020 2020 7468 6574 6120 2a3d          theta *=
-000618b0: 2074 6865 7461 5f73 6361 6c65 3b0a 0a20   theta_scale;.. 
-000618c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000618d0: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
-000618e0: 6c5f 6670 3136 5f74 202a 2063 6f6e 7374  l_fp16_t * const
-000618f0: 2064 7920 203d 2028 6767 6d6c 5f66 7031   dy  = (ggml_fp1
-00061900: 365f 7420 2a29 2828 6368 6172 202a 2920  6_t *)((char *) 
-00061910: 7372 6330 2d3e 6461 7461 202b 2069 332a  src0->data + i3*
-00061920: 6e62 3033 202b 2069 322a 6e62 3032 202b  nb03 + i2*nb02 +
-00061930: 2069 312a 6e62 3031 202b 2069 302a 6e62   i1*nb01 + i0*nb
-00061940: 3030 293b 0a20 2020 2020 2020 2020 2020  00);.           
-00061950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061960: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
-00061970: 2020 2020 2020 2064 7820 203d 2028 6767         dx  = (gg
-00061980: 6d6c 5f66 7031 365f 7420 2a29 2828 6368  ml_fp16_t *)((ch
-00061990: 6172 202a 2920 2064 7374 2d3e 6461 7461  ar *)  dst->data
-000619a0: 202b 2069 332a 6e62 3320 202b 2069 322a   + i3*nb3  + i2*
-000619b0: 6e62 3220 202b 2069 312a 6e62 3120 202b  nb2  + i1*nb1  +
-000619c0: 2069 302a 6e62 3029 3b0a 0a20 2020 2020   i0*nb0);..     
-000619d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000619e0: 2020 2063 6f6e 7374 2066 6c6f 6174 2064     const float d
-000619f0: 7930 203d 2047 474d 4c5f 4650 3136 5f54  y0 = GGML_FP16_T
-00061a00: 4f5f 4650 3332 2864 795b 305d 293b 0a20  O_FP32(dy[0]);. 
-00061a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061a20: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
-00061a30: 6174 2064 7931 203d 2047 474d 4c5f 4650  at dy1 = GGML_FP
-00061a40: 3136 5f54 4f5f 4650 3332 2864 795b 315d  16_TO_FP32(dy[1]
-00061a50: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00061a60: 2020 2020 2020 2020 2020 2020 6478 5b30              dx[0
-00061a70: 5d20 3d20 4747 4d4c 5f46 5033 325f 544f  ] = GGML_FP32_TO
-00061a80: 5f46 5031 3628 2064 7930 2a63 6f73 5f74  _FP16( dy0*cos_t
-00061a90: 6865 7461 202b 2064 7931 2a73 696e 5f74  heta + dy1*sin_t
-00061aa0: 6865 7461 293b 0a20 2020 2020 2020 2020  heta);.         
-00061ab0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00061ac0: 785b 315d 203d 2047 474d 4c5f 4650 3332  x[1] = GGML_FP32
-00061ad0: 5f54 4f5f 4650 3136 282d 6479 302a 7369  _TO_FP16(-dy0*si
-00061ae0: 6e5f 7468 6574 6120 2b20 6479 312a 636f  n_theta + dy1*co
-00061af0: 735f 7468 6574 6129 3b0a 2020 2020 2020  s_theta);.      
-00061b00: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00061b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061b20: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-00061b30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00061b40: 2028 696e 7436 345f 7420 6962 203d 2030   (int64_t ib = 0
-00061b50: 3b20 6962 203c 206e 6530 2f6e 5f64 696d  ; ib < ne0/n_dim
-00061b60: 733b 202b 2b69 6229 207b 0a20 2020 2020  s; ++ib) {.     
-00061b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061b80: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-00061b90: 6963 203d 2030 3b20 6963 203c 206e 5f64  ic = 0; ic < n_d
-00061ba0: 696d 733b 2069 6320 2b3d 2032 2920 7b0a  ims; ic += 2) {.
+00061040: 636f 6e73 7420 666c 6f61 7420 636f 735f  const float cos_
+00061050: 7468 6574 6120 3d20 636f 7366 2874 6865  theta = cosf(the
+00061060: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
+00061070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061080: 2063 6f6e 7374 2066 6c6f 6174 2073 696e   const float sin
+00061090: 5f74 6865 7461 203d 2073 696e 6628 7468  _theta = sinf(th
+000610a0: 6574 6129 3b0a 0a20 2020 2020 2020 2020  eta);..         
+000610b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000610c0: 2020 2074 6865 7461 202a 3d20 7468 6574     theta *= thet
+000610d0: 615f 7363 616c 653b 0a0a 2020 2020 2020  a_scale;..      
+000610e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000610f0: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00061100: 345f 7420 6930 203d 2069 622a 6e5f 6469  4_t i0 = ib*n_di
+00061110: 6d73 202b 2069 632f 323b 0a0a 2020 2020  ms + ic/2;..    
+00061120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061130: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+00061140: 6f61 7420 2a20 636f 6e73 7420 6479 2020  oat * const dy  
+00061150: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
+00061160: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
+00061170: 2b20 6933 2a6e 6230 3320 2b20 6932 2a6e  + i3*nb03 + i2*n
+00061180: 6230 3220 2b20 6931 2a6e 6230 3120 2b20  b02 + i1*nb01 + 
+00061190: 6930 2a6e 6230 3029 3b0a 2020 2020 2020  i0*nb00);.      
+000611a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000611b0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+000611c0: 7420 2a20 2020 2020 2020 6478 2020 3d20  t *       dx  = 
+000611d0: 2866 6c6f 6174 202a 2928 2863 6861 7220  (float *)((char 
+000611e0: 2a29 2020 6473 742d 3e64 6174 6120 2b20  *)  dst->data + 
+000611f0: 6933 2a6e 6233 2020 2b20 6932 2a6e 6232  i3*nb3  + i2*nb2
+00061200: 2020 2b20 6931 2a6e 6231 2020 2b20 6930    + i1*nb1  + i0
+00061210: 2a6e 6230 293b 0a0a 2020 2020 2020 2020  *nb0);..        
+00061220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061230: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00061240: 6479 3020 3d20 6479 5b30 5d3b 0a20 2020  dy0 = dy[0];.   
+00061250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061260: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00061270: 6c6f 6174 2064 7931 203d 2064 795b 6e5f  loat dy1 = dy[n_
+00061280: 6469 6d73 2f32 5d3b 0a0a 2020 2020 2020  dims/2];..      
+00061290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000612a0: 2020 2020 2020 6478 5b30 5d20 2020 2020        dx[0]     
+000612b0: 2020 203d 2020 2064 7930 2a63 6f73 5f74     =   dy0*cos_t
+000612c0: 6865 7461 202b 2064 7931 2a73 696e 5f74  heta + dy1*sin_t
+000612d0: 6865 7461 3b0a 2020 2020 2020 2020 2020  heta;.          
+000612e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000612f0: 2020 6478 5b6e 5f64 696d 732f 325d 203d    dx[n_dims/2] =
+00061300: 202d 2064 7930 2a73 696e 5f74 6865 7461   - dy0*sin_theta
+00061310: 202b 2064 7931 2a63 6f73 5f74 6865 7461   + dy1*cos_theta
+00061320: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00061330: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00061340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061350: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00061360: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00061370: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+00061380: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+00061390: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000613a0: 7277 6172 645f 726f 7065 5f62 6163 6b5f  rward_rope_back_
+000613b0: 6631 3628 0a20 2020 2020 2020 2063 6f6e  f16(.        con
+000613c0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+000613d0: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+000613e0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+000613f0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00061400: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00061410: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00061420: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00061430: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+00061440: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00061450: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+00061460: 2020 6173 7365 7274 2873 7263 312d 3e74    assert(src1->t
+00061470: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00061480: 5f49 3332 293b 0a20 2020 2061 7373 6572  _I32);.    asser
+00061490: 7428 6767 6d6c 5f6e 656c 656d 656e 7473  t(ggml_nelements
+000614a0: 2873 7263 3129 203d 3d20 3329 3b0a 0a20  (src1) == 3);.. 
+000614b0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
+000614c0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+000614d0: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
+000614e0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+000614f0: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
+00061500: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+00061510: 2020 207d 0a0a 2020 2020 2f2f 2079 203d     }..    // y =
+00061520: 2072 6f70 6528 782c 2073 7263 3129 0a20   rope(x, src1). 
+00061530: 2020 202f 2f20 6478 203d 2072 6f70 655f     // dx = rope_
+00061540: 6261 636b 2864 792c 2073 7263 3129 0a20  back(dy, src1). 
+00061550: 2020 202f 2f20 7372 6330 2069 7320 6479     // src0 is dy
+00061560: 2c20 7372 6331 2063 6f6e 7461 696e 7320  , src1 contains 
+00061570: 6f70 7469 6f6e 730a 0a20 2020 2063 6f6e  options..    con
+00061580: 7374 2069 6e74 206e 5f70 6173 7420 3d20  st int n_past = 
+00061590: 2828 696e 7433 325f 7420 2a29 2073 7263  ((int32_t *) src
+000615a0: 312d 3e64 6174 6129 5b30 5d3b 0a20 2020  1->data)[0];.   
+000615b0: 2063 6f6e 7374 2069 6e74 206e 5f64 696d   const int n_dim
+000615c0: 7320 3d20 2828 696e 7433 325f 7420 2a29  s = ((int32_t *)
+000615d0: 2073 7263 312d 3e64 6174 6129 5b31 5d3b   src1->data)[1];
+000615e0: 0a20 2020 2063 6f6e 7374 2069 6e74 206d  .    const int m
+000615f0: 6f64 6520 2020 3d20 2828 696e 7433 325f  ode   = ((int32_
+00061600: 7420 2a29 2073 7263 312d 3e64 6174 6129  t *) src1->data)
+00061610: 5b32 5d3b 0a0a 2020 2020 6173 7365 7274  [2];..    assert
+00061620: 286e 5f70 6173 7420 3e3d 2030 293b 0a0a  (n_past >= 0);..
+00061630: 2020 2020 4747 4d4c 5f54 454e 534f 525f      GGML_TENSOR_
+00061640: 554e 4152 595f 4f50 5f4c 4f43 414c 533b  UNARY_OP_LOCALS;
+00061650: 0a0a 2020 2020 2f2f 7072 696e 7466 2822  ..    //printf("
+00061660: 6e65 303a 2025 642c 206e 6531 3a20 2564  ne0: %d, ne1: %d
+00061670: 2c20 6e65 323a 2025 642c 206e 6533 3a20  , ne2: %d, ne3: 
+00061680: 2564 5c6e 222c 206e 6530 2c20 6e65 312c  %d\n", ne0, ne1,
+00061690: 206e 6532 2c20 6e65 3329 3b0a 2020 2020   ne2, ne3);.    
+000616a0: 2f2f 7072 696e 7466 2822 6e5f 7061 7374  //printf("n_past
+000616b0: 203d 2025 642c 206e 6532 203d 2025 645c   = %d, ne2 = %d\
+000616c0: 6e22 2c20 6e5f 7061 7374 2c20 6e65 3229  n", n_past, ne2)
+000616d0: 3b0a 0a20 2020 2061 7373 6572 7428 6e62  ;..    assert(nb
+000616e0: 3020 3d3d 2073 697a 656f 6628 6767 6d6c  0 == sizeof(ggml
+000616f0: 5f66 7031 365f 7429 293b 0a0a 2020 2020  _fp16_t));..    
+00061700: 636f 6e73 7420 696e 7420 6974 6820 3d20  const int ith = 
+00061710: 7061 7261 6d73 2d3e 6974 683b 0a20 2020  params->ith;.   
+00061720: 2063 6f6e 7374 2069 6e74 206e 7468 203d   const int nth =
+00061730: 2070 6172 616d 732d 3e6e 7468 3b0a 0a20   params->nth;.. 
+00061740: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
+00061750: 3d20 6767 6d6c 5f6e 726f 7773 2864 7374  = ggml_nrows(dst
+00061760: 293b 0a0a 2020 2020 2f2f 2072 6f77 7320  );..    // rows 
+00061770: 7065 7220 7468 7265 6164 0a20 2020 2063  per thread.    c
+00061780: 6f6e 7374 2069 6e74 2064 7220 3d20 286e  onst int dr = (n
+00061790: 7220 2b20 6e74 6820 2d20 3129 2f6e 7468  r + nth - 1)/nth
+000617a0: 3b0a 0a20 2020 202f 2f20 726f 7720 7261  ;..    // row ra
+000617b0: 6e67 6520 666f 7220 7468 6973 2074 6872  nge for this thr
+000617c0: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+000617d0: 7420 6972 3020 3d20 6472 2a69 7468 3b0a  t ir0 = dr*ith;.
+000617e0: 2020 2020 636f 6e73 7420 696e 7420 6972      const int ir
+000617f0: 3120 3d20 4d49 4e28 6972 3020 2b20 6472  1 = MIN(ir0 + dr
+00061800: 2c20 6e72 293b 0a0a 2020 2020 2f2f 2072  , nr);..    // r
+00061810: 6f77 2069 6e64 6578 2075 7365 6420 746f  ow index used to
+00061820: 2064 6574 6572 6d69 6e65 2077 6869 6368   determine which
+00061830: 2074 6872 6561 6420 746f 2075 7365 0a20   thread to use. 
+00061840: 2020 2069 6e74 2069 7220 3d20 303b 0a0a     int ir = 0;..
+00061850: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00061860: 7468 6574 615f 7363 616c 6520 3d20 706f  theta_scale = po
+00061870: 7766 2831 3030 3030 2e30 2c20 2d32 2e30  wf(10000.0, -2.0
+00061880: 662f 6e5f 6469 6d73 293b 0a0a 2020 2020  f/n_dims);..    
+00061890: 636f 6e73 7420 626f 6f6c 2069 735f 6e65  const bool is_ne
+000618a0: 6f78 203d 206d 6f64 6520 2620 323b 0a0a  ox = mode & 2;..
+000618b0: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+000618c0: 2069 3320 3d20 303b 2069 3320 3c20 6e65   i3 = 0; i3 < ne
+000618d0: 333b 2069 332b 2b29 207b 0a20 2020 2020  3; i3++) {.     
+000618e0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+000618f0: 6932 203d 2028 286d 6f64 6520 2620 3129  i2 = ((mode & 1)
+00061900: 203d 3d20 3020 3f20 3020 3a20 6e5f 7061   == 0 ? 0 : n_pa
+00061910: 7374 293b 2069 3220 3c20 6e65 323b 2069  st); i2 < ne2; i
+00061920: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
+00061930: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00061940: 2070 203d 2028 286d 6f64 6520 2620 3129   p = ((mode & 1)
+00061950: 203d 3d20 3020 3f20 6e5f 7061 7374 202b   == 0 ? n_past +
+00061960: 2069 3220 3a20 6932 293b 0a20 2020 2020   i2 : i2);.     
+00061970: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00061980: 345f 7420 6931 203d 2030 3b20 6931 203c  4_t i1 = 0; i1 <
+00061990: 206e 6531 3b20 6931 2b2b 2920 7b0a 2020   ne1; i1++) {.  
+000619a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000619b0: 2028 6972 2b2b 203c 2069 7230 2920 636f   (ir++ < ir0) co
+000619c0: 6e74 696e 7565 3b0a 2020 2020 2020 2020  ntinue;.        
+000619d0: 2020 2020 2020 2020 6966 2028 6972 2020          if (ir  
+000619e0: 203e 2069 7231 2920 6272 6561 6b3b 0a0a   > ir1) break;..
+000619f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061a00: 666c 6f61 7420 7468 6574 6120 3d20 2866  float theta = (f
+00061a10: 6c6f 6174 2970 3b0a 0a20 2020 2020 2020  loat)p;..       
+00061a20: 2020 2020 2020 2020 2069 6620 2821 6973           if (!is
+00061a30: 5f6e 656f 7829 207b 0a20 2020 2020 2020  _neox) {.       
+00061a40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00061a50: 2028 696e 7436 345f 7420 6930 203d 2030   (int64_t i0 = 0
+00061a60: 3b20 6930 203c 206e 6530 3b20 6930 202b  ; i0 < ne0; i0 +
+00061a70: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
+00061a80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00061a90: 6f6e 7374 2066 6c6f 6174 2063 6f73 5f74  onst float cos_t
+00061aa0: 6865 7461 203d 2063 6f73 6628 7468 6574  heta = cosf(thet
+00061ab0: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+00061ac0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00061ad0: 7420 666c 6f61 7420 7369 6e5f 7468 6574  t float sin_thet
+00061ae0: 6120 3d20 7369 6e66 2874 6865 7461 293b  a = sinf(theta);
+00061af0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00061b00: 2020 2020 2020 2020 2020 7468 6574 6120            theta 
+00061b10: 2a3d 2074 6865 7461 5f73 6361 6c65 3b0a  *= theta_scale;.
+00061b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00061b30: 2020 2020 2020 2020 2063 6f6e 7374 2067           const g
+00061b40: 676d 6c5f 6670 3136 5f74 202a 2063 6f6e  gml_fp16_t * con
+00061b50: 7374 2064 7920 203d 2028 6767 6d6c 5f66  st dy  = (ggml_f
+00061b60: 7031 365f 7420 2a29 2828 6368 6172 202a  p16_t *)((char *
+00061b70: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
+00061b80: 332a 6e62 3033 202b 2069 322a 6e62 3032  3*nb03 + i2*nb02
+00061b90: 202b 2069 312a 6e62 3031 202b 2069 302a   + i1*nb01 + i0*
+00061ba0: 6e62 3030 293b 0a20 2020 2020 2020 2020  nb00);.         
 00061bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061bc0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00061bd0: 7420 666c 6f61 7420 636f 735f 7468 6574  t float cos_thet
-00061be0: 6120 3d20 636f 7366 2874 6865 7461 293b  a = cosf(theta);
-00061bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00061c00: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00061c10: 7374 2066 6c6f 6174 2073 696e 5f74 6865  st float sin_the
-00061c20: 7461 203d 2073 696e 6628 7468 6574 6129  ta = sinf(theta)
-00061c30: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00061c40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00061c50: 6865 7461 202a 3d20 7468 6574 615f 7363  heta *= theta_sc
-00061c60: 616c 653b 0a0a 2020 2020 2020 2020 2020  ale;..          
-00061c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061c80: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00061c90: 6930 203d 2069 622a 6e5f 6469 6d73 202b  i0 = ib*n_dims +
-00061ca0: 2069 632f 323b 0a0a 2020 2020 2020 2020   ic/2;..        
-00061cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061cc0: 2020 2020 636f 6e73 7420 6767 6d6c 5f66      const ggml_f
-00061cd0: 7031 365f 7420 2a20 636f 6e73 7420 6479  p16_t * const dy
-00061ce0: 2020 3d20 2867 676d 6c5f 6670 3136 5f74    = (ggml_fp16_t
-00061cf0: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
-00061d00: 302d 3e64 6174 6120 2b20 6933 2a6e 6230  0->data + i3*nb0
-00061d10: 3320 2b20 6932 2a6e 6230 3220 2b20 6931  3 + i2*nb02 + i1
-00061d20: 2a6e 6230 3120 2b20 6930 2a6e 6230 3029  *nb01 + i0*nb00)
-00061d30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00061d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061d50: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-00061d60: 2a20 2020 2020 2020 6478 2020 3d20 2867  *       dx  = (g
-00061d70: 676d 6c5f 6670 3136 5f74 202a 2928 2863  gml_fp16_t *)((c
-00061d80: 6861 7220 2a29 2020 6473 742d 3e64 6174  har *)  dst->dat
-00061d90: 6120 2b20 6933 2a6e 6233 2020 2b20 6932  a + i3*nb3  + i2
-00061da0: 2a6e 6232 2020 2b20 6931 2a6e 6231 2020  *nb2  + i1*nb1  
-00061db0: 2b20 6930 2a6e 6230 293b 0a0a 2020 2020  + i0*nb0);..    
-00061dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061dd0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00061de0: 6f61 7420 6479 3020 3d20 4747 4d4c 5f46  oat dy0 = GGML_F
-00061df0: 5031 365f 544f 5f46 5033 3228 6479 5b30  P16_TO_FP32(dy[0
-00061e00: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
-00061e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061e20: 636f 6e73 7420 666c 6f61 7420 6479 3120  const float dy1 
-00061e30: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
-00061e40: 5033 3228 6479 5b6e 5f64 696d 732f 325d  P32(dy[n_dims/2]
-00061e50: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00061e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061e70: 6478 5b30 5d20 2020 2020 2020 203d 2047  dx[0]        = G
-00061e80: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
-00061e90: 2820 6479 302a 636f 735f 7468 6574 6120  ( dy0*cos_theta 
-00061ea0: 2b20 6479 312a 7369 6e5f 7468 6574 6129  + dy1*sin_theta)
-00061eb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00061ec0: 2020 2020 2020 2020 2020 2020 2020 6478                dx
-00061ed0: 5b6e 5f64 696d 732f 325d 203d 2047 474d  [n_dims/2] = GGM
-00061ee0: 4c5f 4650 3332 5f54 4f5f 4650 3136 282d  L_FP32_TO_FP16(-
-00061ef0: 6479 302a 7369 6e5f 7468 6574 6120 2b20  dy0*sin_theta + 
-00061f00: 6479 312a 636f 735f 7468 6574 6129 3b0a  dy1*cos_theta);.
+00061bc0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+00061bd0: 202a 2020 2020 2020 2064 7820 203d 2028   *       dx  = (
+00061be0: 6767 6d6c 5f66 7031 365f 7420 2a29 2828  ggml_fp16_t *)((
+00061bf0: 6368 6172 202a 2920 2064 7374 2d3e 6461  char *)  dst->da
+00061c00: 7461 202b 2069 332a 6e62 3320 202b 2069  ta + i3*nb3  + i
+00061c10: 322a 6e62 3220 202b 2069 312a 6e62 3120  2*nb2  + i1*nb1 
+00061c20: 202b 2069 302a 6e62 3029 3b0a 0a20 2020   + i0*nb0);..   
+00061c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061c40: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00061c50: 2064 7930 203d 2047 474d 4c5f 4650 3136   dy0 = GGML_FP16
+00061c60: 5f54 4f5f 4650 3332 2864 795b 305d 293b  _TO_FP32(dy[0]);
+00061c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00061c80: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00061c90: 6c6f 6174 2064 7931 203d 2047 474d 4c5f  loat dy1 = GGML_
+00061ca0: 4650 3136 5f54 4f5f 4650 3332 2864 795b  FP16_TO_FP32(dy[
+00061cb0: 315d 293b 0a0a 2020 2020 2020 2020 2020  1]);..          
+00061cc0: 2020 2020 2020 2020 2020 2020 2020 6478                dx
+00061cd0: 5b30 5d20 3d20 4747 4d4c 5f46 5033 325f  [0] = GGML_FP32_
+00061ce0: 544f 5f46 5031 3628 2064 7930 2a63 6f73  TO_FP16( dy0*cos
+00061cf0: 5f74 6865 7461 202b 2064 7931 2a73 696e  _theta + dy1*sin
+00061d00: 5f74 6865 7461 293b 0a20 2020 2020 2020  _theta);.       
+00061d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061d20: 2064 785b 315d 203d 2047 474d 4c5f 4650   dx[1] = GGML_FP
+00061d30: 3332 5f54 4f5f 4650 3136 282d 6479 302a  32_TO_FP16(-dy0*
+00061d40: 7369 6e5f 7468 6574 6120 2b20 6479 312a  sin_theta + dy1*
+00061d50: 636f 735f 7468 6574 6129 3b0a 2020 2020  cos_theta);.    
+00061d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061d70: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00061d80: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
+00061d90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00061da0: 6f72 2028 696e 7436 345f 7420 6962 203d  or (int64_t ib =
+00061db0: 2030 3b20 6962 203c 206e 6530 2f6e 5f64   0; ib < ne0/n_d
+00061dc0: 696d 733b 202b 2b69 6229 207b 0a20 2020  ims; ++ib) {.   
+00061dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061de0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+00061df0: 7420 6963 203d 2030 3b20 6963 203c 206e  t ic = 0; ic < n
+00061e00: 5f64 696d 733b 2069 6320 2b3d 2032 2920  _dims; ic += 2) 
+00061e10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00061e20: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00061e30: 6e73 7420 666c 6f61 7420 636f 735f 7468  nst float cos_th
+00061e40: 6574 6120 3d20 636f 7366 2874 6865 7461  eta = cosf(theta
+00061e50: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00061e60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00061e70: 6f6e 7374 2066 6c6f 6174 2073 696e 5f74  onst float sin_t
+00061e80: 6865 7461 203d 2073 696e 6628 7468 6574  heta = sinf(thet
+00061e90: 6129 3b0a 0a20 2020 2020 2020 2020 2020  a);..           
+00061ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061eb0: 2074 6865 7461 202a 3d20 7468 6574 615f   theta *= theta_
+00061ec0: 7363 616c 653b 0a0a 2020 2020 2020 2020  scale;..        
+00061ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061ee0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00061ef0: 7420 6930 203d 2069 622a 6e5f 6469 6d73  t i0 = ib*n_dims
+00061f00: 202b 2069 632f 323b 0a0a 2020 2020 2020   + ic/2;..      
 00061f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061f20: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00061f30: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00061f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00061f50: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-00061f60: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00061f70: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
-00061f80: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00061f90: 6172 645f 726f 7065 5f62 6163 6b28 0a20  ard_rope_back(. 
-00061fa0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00061fb0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00061fc0: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-00061fd0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00061fe0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00061ff0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-00062000: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00062010: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00062020: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
-00062030: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00062040: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-00062050: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00062060: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00062070: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00062080: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00062090: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000620a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-000620b0: 5f72 6f70 655f 6261 636b 5f66 3136 2870  _rope_back_f16(p
-000620c0: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
-000620d0: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
-000620e0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000620f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00062100: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-00062110: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00062120: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00062130: 7075 7465 5f66 6f72 7761 7264 5f72 6f70  pute_forward_rop
-00062140: 655f 6261 636b 5f66 3332 2870 6172 616d  e_back_f32(param
-00062150: 732c 2073 7263 302c 2073 7263 312c 2064  s, src0, src1, d
-00062160: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00062170: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00062180: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-00062190: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000621a0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-000621b0: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-000621c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-000621d0: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-000621e0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000621f0: 7264 5f63 6f6e 765f 3164 0a0a 7374 6174  rd_conv_1d..stat
-00062200: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-00062210: 7075 7465 5f66 6f72 7761 7264 5f63 6f6e  pute_forward_con
-00062220: 765f 3164 5f73 315f 7068 5f66 3136 5f66  v_1d_s1_ph_f16_f
-00062230: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
-00062240: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00062250: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00062260: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00062270: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00062280: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00062290: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-000622a0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-000622b0: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-000622c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000622d0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-000622e0: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-000622f0: 5254 2873 7263 302d 3e74 7970 6520 3d3d  RT(src0->type ==
-00062300: 2047 474d 4c5f 5459 5045 5f46 3136 293b   GGML_TYPE_F16);
-00062310: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00062320: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
-00062330: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
-00062340: 2020 2047 474d 4c5f 4153 5345 5254 2820     GGML_ASSERT( 
-00062350: 6473 742d 3e74 7970 6520 3d3d 2047 474d  dst->type == GGM
-00062360: 4c5f 5459 5045 5f46 3332 293b 0a0a 2020  L_TYPE_F32);..  
-00062370: 2020 696e 7436 345f 7420 7430 203d 2067    int64_t t0 = g
-00062380: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
-00062390: 2829 3b0a 2020 2020 554e 5553 4544 2874  ();.    UNUSED(t
-000623a0: 3029 3b0a 0a20 2020 2047 474d 4c5f 5445  0);..    GGML_TE
-000623b0: 4e53 4f52 5f42 494e 4152 595f 4f50 5f4c  NSOR_BINARY_OP_L
-000623c0: 4f43 414c 533b 0a0a 2020 2020 636f 6e73  OCALS;..    cons
-000623d0: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
-000623e0: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
-000623f0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
-00062400: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
-00062410: 6f6e 7374 2069 6e74 206e 6b20 3d20 6e65  onst int nk = ne
-00062420: 3030 3b0a 2020 2020 636f 6e73 7420 696e  00;.    const in
-00062430: 7420 6e68 203d 206e 6b2f 323b 0a0a 2020  t nh = nk/2;..  
-00062440: 2020 636f 6e73 7420 696e 7420 6577 3020    const int ew0 
-00062450: 3d20 6767 6d6c 5f75 7033 3228 6e65 3031  = ggml_up32(ne01
-00062460: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
-00062470: 4552 5428 6e65 3030 2025 2032 203d 3d20  ERT(ne00 % 2 == 
-00062480: 3129 3b20 2f2f 2054 4f44 4f3a 2073 7570  1); // TODO: sup
-00062490: 706f 7274 2065 7665 6e20 6b65 726e 656c  port even kernel
-000624a0: 2073 697a 6573 0a20 2020 2047 474d 4c5f   sizes.    GGML_
-000624b0: 4153 5345 5254 286e 6230 3020 3d3d 2073  ASSERT(nb00 == s
-000624c0: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-000624d0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
-000624e0: 5345 5254 286e 6231 3020 3d3d 2073 697a  SERT(nb10 == siz
-000624f0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
-00062500: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
-00062510: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
-00062520: 494e 4954 2920 7b0a 2020 2020 2020 2020  INIT) {.        
-00062530: 2f2f 2054 4f44 4f3a 2066 6978 2074 6869  // TODO: fix thi
-00062540: 7320 6d65 6d73 6574 2028 7773 697a 6520  s memset (wsize 
-00062550: 6973 206f 7665 7265 7374 696d 6174 6564  is overestimated
-00062560: 290a 2020 2020 2020 2020 6d65 6d73 6574  ).        memset
-00062570: 2870 6172 616d 732d 3e77 6461 7461 2c20  (params->wdata, 
-00062580: 302c 2070 6172 616d 732d 3e77 7369 7a65  0, params->wsize
-00062590: 293b 0a0a 2020 2020 2020 2020 2f2f 2070  );..        // p
-000625a0: 7265 7061 7265 206b 6572 6e65 6c20 6461  repare kernel da
-000625b0: 7461 2028 7372 6330 290a 2020 2020 2020  ta (src0).      
-000625c0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000625d0: 6767 6d6c 5f66 7031 365f 7420 2a20 636f  ggml_fp16_t * co
-000625e0: 6e73 7420 7764 6174 6120 3d20 2867 676d  nst wdata = (ggm
-000625f0: 6c5f 6670 3136 5f74 202a 2920 7061 7261  l_fp16_t *) para
-00062600: 6d73 2d3e 7764 6174 6120 2b20 303b 0a0a  ms->wdata + 0;..
-00062610: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00062620: 2869 6e74 3634 5f74 2069 3032 203d 2030  (int64_t i02 = 0
-00062630: 3b20 6930 3220 3c20 6e65 3032 3b20 6930  ; i02 < ne02; i0
-00062640: 322b 2b29 207b 0a20 2020 2020 2020 2020  2++) {.         
-00062650: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00062660: 345f 7420 6930 3120 3d20 303b 2069 3031  4_t i01 = 0; i01
-00062670: 203c 206e 6530 313b 2069 3031 2b2b 2920   < ne01; i01++) 
-00062680: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00062690: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
-000626a0: 5f66 7031 365f 7420 2a20 636f 6e73 7420  _fp16_t * const 
-000626b0: 7372 6320 3d20 2867 676d 6c5f 6670 3136  src = (ggml_fp16
-000626c0: 5f74 202a 2928 2863 6861 7220 2a29 2073  _t *)((char *) s
-000626d0: 7263 302d 3e64 6174 6120 2b20 6930 322a  rc0->data + i02*
-000626e0: 6e62 3032 202b 2069 3031 2a6e 6230 3129  nb02 + i01*nb01)
-000626f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00062700: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-00062710: 7420 2a20 6473 745f 6461 7461 203d 2077  t * dst_data = w
-00062720: 6461 7461 202b 2069 3032 2a65 7730 2a6e  data + i02*ew0*n
-00062730: 6530 303b 0a20 2020 2020 2020 2020 2020  e00;.           
-00062740: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00062750: 7436 345f 7420 6930 3020 3d20 303b 2069  t64_t i00 = 0; i
-00062760: 3030 203c 206e 6530 303b 2069 3030 2b2b  00 < ne00; i00++
-00062770: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00062780: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-00062790: 6461 7461 5b69 3030 2a65 7730 202b 2069  data[i00*ew0 + i
-000627a0: 3031 5d20 3d20 7372 635b 6930 305d 3b0a  01] = src[i00];.
-000627b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000627c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000627d0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000627e0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-000627f0: 0a20 2020 2020 2020 202f 2f20 7072 6570  .        // prep
-00062800: 6172 6520 736f 7572 6365 2064 6174 6120  are source data 
-00062810: 2873 7263 3129 0a20 2020 2020 2020 207b  (src1).        {
-00062820: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00062830: 6c5f 6670 3136 5f74 202a 2063 6f6e 7374  l_fp16_t * const
-00062840: 2077 6461 7461 203d 2028 6767 6d6c 5f66   wdata = (ggml_f
-00062850: 7031 365f 7420 2a29 2070 6172 616d 732d  p16_t *) params-
-00062860: 3e77 6461 7461 202b 206e 6530 322a 6577  >wdata + ne02*ew
-00062870: 302a 6e65 3030 3b0a 0a20 2020 2020 2020  0*ne00;..       
-00062880: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00062890: 7420 6931 3120 3d20 303b 2069 3131 203c  t i11 = 0; i11 <
-000628a0: 206e 6531 313b 2069 3131 2b2b 2920 7b0a   ne11; i11++) {.
-000628b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000628c0: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
-000628d0: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
-000628e0: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
-000628f0: 312d 3e64 6174 6120 2b20 6931 312a 6e62  1->data + i11*nb
-00062900: 3131 293b 0a20 2020 2020 2020 2020 2020  11);.           
-00062910: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
-00062920: 202a 2064 7374 5f64 6174 6120 3d20 7764   * dst_data = wd
-00062930: 6174 613b 0a20 2020 2020 2020 2020 2020  ata;.           
-00062940: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-00062950: 7420 6931 3020 3d20 303b 2069 3130 203c  t i10 = 0; i10 <
-00062960: 206e 6531 303b 2069 3130 2b2b 2920 7b0a   ne10; i10++) {.
-00062970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062980: 2020 2020 6473 745f 6461 7461 5b28 6931      dst_data[(i1
-00062990: 3020 2b20 6e68 292a 6577 3020 2b20 6931  0 + nh)*ew0 + i1
-000629a0: 315d 203d 2047 474d 4c5f 4650 3332 5f54  1] = GGML_FP32_T
-000629b0: 4f5f 4650 3136 2873 7263 5b69 3130 5d29  O_FP16(src[i10])
-000629c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000629d0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000629e0: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-000629f0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-00062a00: 207d 0a0a 2020 2020 6966 2028 7061 7261   }..    if (para
-00062a10: 6d73 2d3e 7479 7065 203d 3d20 4747 4d4c  ms->type == GGML
-00062a20: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2920  _TASK_FINALIZE) 
-00062a30: 7b0a 2020 2020 2020 2020 7265 7475 726e  {.        return
-00062a40: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
-00062a50: 746f 7461 6c20 726f 7773 2069 6e20 6473  total rows in ds
-00062a60: 740a 2020 2020 636f 6e73 7420 696e 7420  t.    const int 
-00062a70: 6e72 203d 206e 6530 323b 0a0a 2020 2020  nr = ne02;..    
-00062a80: 2f2f 2072 6f77 7320 7065 7220 7468 7265  // rows per thre
-00062a90: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00062aa0: 2064 7220 3d20 286e 7220 2b20 6e74 6820   dr = (nr + nth 
-00062ab0: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-00062ac0: 2f20 726f 7720 7261 6e67 6520 666f 7220  / row range for 
-00062ad0: 7468 6973 2074 6872 6561 640a 2020 2020  this thread.    
-00062ae0: 636f 6e73 7420 696e 7420 6972 3020 3d20  const int ir0 = 
-00062af0: 6472 2a69 7468 3b0a 2020 2020 636f 6e73  dr*ith;.    cons
-00062b00: 7420 696e 7420 6972 3120 3d20 4d49 4e28  t int ir1 = MIN(
-00062b10: 6972 3020 2b20 6472 2c20 6e72 293b 0a0a  ir0 + dr, nr);..
-00062b20: 2020 2020 666f 7220 2869 6e74 2069 3120      for (int i1 
-00062b30: 3d20 6972 303b 2069 3120 3c20 6972 313b  = ir0; i1 < ir1;
-00062b40: 2069 312b 2b29 207b 0a20 2020 2020 2020   i1++) {.       
-00062b50: 2066 6c6f 6174 202a 2064 7374 5f64 6174   float * dst_dat
-00062b60: 6120 3d20 2866 6c6f 6174 202a 2928 2863  a = (float *)((c
-00062b70: 6861 7220 2a29 2064 7374 2d3e 6461 7461  har *) dst->data
-00062b80: 202b 2069 312a 6e62 3129 3b0a 2020 2020   + i1*nb1);.    
-00062b90: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-00062ba0: 2069 3020 3d20 303b 2069 3020 3c20 6e65   i0 = 0; i0 < ne
-00062bb0: 3130 3b20 2b2b 6930 2920 7b0a 2020 2020  10; ++i0) {.    
-00062bc0: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
-00062bd0: 5b69 305d 203d 2030 3b0a 2020 2020 2020  [i0] = 0;.      
-00062be0: 2020 2020 2020 666f 7220 2869 6e74 206b        for (int k
-00062bf0: 203d 202d 6e68 3b20 6b20 3c3d 206e 683b   = -nh; k <= nh;
-00062c00: 206b 2b2b 2920 7b0a 2020 2020 2020 2020   k++) {.        
-00062c10: 2020 2020 2020 2020 666c 6f61 7420 7620          float v 
-00062c20: 3d20 302e 3066 3b0a 2020 2020 2020 2020  = 0.0f;.        
-00062c30: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-00062c40: 5f64 6f74 5f66 3136 2865 7730 2c20 2676  _dot_f16(ew0, &v
-00062c50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00062c60: 2020 2020 2020 2020 2020 2867 676d 6c5f            (ggml_
-00062c70: 6670 3136 5f74 202a 2920 7061 7261 6d73  fp16_t *) params
-00062c80: 2d3e 7764 6174 6120 2b20 2020 6931 2a65  ->wdata +   i1*e
-00062c90: 7730 2a6e 6530 3020 2b20 2020 2020 2028  w0*ne00 +      (
-00062ca0: 6e68 202b 206b 292a 6577 302c 0a20 2020  nh + k)*ew0,.   
-00062cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00062cc0: 2020 2020 2028 6767 6d6c 5f66 7031 365f       (ggml_fp16_
-00062cd0: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
-00062ce0: 7461 202b 206e 6530 322a 6577 302a 6e65  ta + ne02*ew0*ne
-00062cf0: 3030 202b 2028 6930 202b 206e 6820 2b20  00 + (i0 + nh + 
-00062d00: 6b29 2a65 7730 293b 0a0a 2020 2020 2020  k)*ew0);..      
-00062d10: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
-00062d20: 7461 5b69 305d 202b 3d20 763b 0a20 2020  ta[i0] += v;.   
-00062d30: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00062d40: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
-00062d50: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00062d60: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00062d70: 6f6e 765f 3164 5f73 315f 7068 5f66 3332  onv_1d_s1_ph_f32
-00062d80: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00062d90: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00062da0: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00062db0: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-00062dc0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00062dd0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
-00062de0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00062df0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00062e00: 2073 7263 312c 0a20 2020 2020 2020 2020   src1,.         
-00062e10: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00062e20: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-00062e30: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00062e40: 2873 7263 302d 3e74 7970 6520 3d3d 2047  (src0->type == G
-00062e50: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
-00062e60: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
-00062e70: 7263 312d 3e74 7970 6520 3d3d 2047 474d  rc1->type == GGM
-00062e80: 4c5f 5459 5045 5f46 3332 293b 0a20 2020  L_TYPE_F32);.   
-00062e90: 2047 474d 4c5f 4153 5345 5254 2820 6473   GGML_ASSERT( ds
-00062ea0: 742d 3e74 7970 6520 3d3d 2047 474d 4c5f  t->type == GGML_
-00062eb0: 5459 5045 5f46 3332 293b 0a0a 2020 2020  TYPE_F32);..    
-00062ec0: 696e 7436 345f 7420 7430 203d 2067 676d  int64_t t0 = ggm
-00062ed0: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
-00062ee0: 3b0a 2020 2020 554e 5553 4544 2874 3029  ;.    UNUSED(t0)
-00062ef0: 3b0a 0a20 2020 2047 474d 4c5f 5445 4e53  ;..    GGML_TENS
-00062f00: 4f52 5f42 494e 4152 595f 4f50 5f4c 4f43  OR_BINARY_OP_LOC
-00062f10: 414c 533b 0a0a 2020 2020 636f 6e73 7420  ALS;..    const 
-00062f20: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-00062f30: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-00062f40: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-00062f50: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
-00062f60: 7374 2069 6e74 206e 6b20 3d20 6e65 3030  st int nk = ne00
-00062f70: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00062f80: 6e68 203d 206e 6b2f 323b 0a0a 2020 2020  nh = nk/2;..    
-00062f90: 636f 6e73 7420 696e 7420 6577 3020 3d20  const int ew0 = 
-00062fa0: 6767 6d6c 5f75 7033 3228 6e65 3031 293b  ggml_up32(ne01);
-00062fb0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00062fc0: 5428 6e65 3030 2025 2032 203d 3d20 3129  T(ne00 % 2 == 1)
-00062fd0: 3b20 2f2f 2054 4f44 4f3a 2073 7570 706f  ; // TODO: suppo
-00062fe0: 7274 2065 7665 6e20 6b65 726e 656c 2073  rt even kernel s
-00062ff0: 697a 6573 0a20 2020 2047 474d 4c5f 4153  izes.    GGML_AS
-00063000: 5345 5254 286e 6230 3020 3d3d 2073 697a  SERT(nb00 == siz
-00063010: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-00063020: 2047 474d 4c5f 4153 5345 5254 286e 6231   GGML_ASSERT(nb1
-00063030: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
-00063040: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
-00063050: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00063060: 4d4c 5f54 4153 4b5f 494e 4954 2920 7b0a  ML_TASK_INIT) {.
-00063070: 2020 2020 2020 2020 2f2f 2054 4f44 4f3a          // TODO:
-00063080: 2066 6978 2074 6869 7320 6d65 6d73 6574   fix this memset
-00063090: 2028 7773 697a 6520 6973 206f 7665 7265   (wsize is overe
-000630a0: 7374 696d 6174 6564 290a 2020 2020 2020  stimated).      
-000630b0: 2020 6d65 6d73 6574 2870 6172 616d 732d    memset(params-
-000630c0: 3e77 6461 7461 2c20 302c 2070 6172 616d  >wdata, 0, param
-000630d0: 732d 3e77 7369 7a65 293b 0a0a 2020 2020  s->wsize);..    
-000630e0: 2020 2020 2f2f 2070 7265 7061 7265 206b      // prepare k
-000630f0: 6572 6e65 6c20 6461 7461 2028 7372 6330  ernel data (src0
-00063100: 290a 2020 2020 2020 2020 7b0a 2020 2020  ).        {.    
-00063110: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-00063120: 636f 6e73 7420 7764 6174 6120 3d20 2866  const wdata = (f
-00063130: 6c6f 6174 202a 2920 7061 7261 6d73 2d3e  loat *) params->
-00063140: 7764 6174 6120 2b20 303b 0a0a 2020 2020  wdata + 0;..    
-00063150: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00063160: 3634 5f74 2069 3032 203d 2030 3b20 6930  64_t i02 = 0; i0
-00063170: 3220 3c20 6e65 3032 3b20 6930 322b 2b29  2 < ne02; i02++)
-00063180: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00063190: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-000631a0: 6930 3120 3d20 303b 2069 3031 203c 206e  i01 = 0; i01 < n
-000631b0: 6530 313b 2069 3031 2b2b 2920 7b0a 2020  e01; i01++) {.  
-000631c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000631d0: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
-000631e0: 636f 6e73 7420 7372 6320 3d20 2866 6c6f  const src = (flo
-000631f0: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
-00063200: 7263 302d 3e64 6174 6120 2b20 6930 322a  rc0->data + i02*
-00063210: 6e62 3032 202b 2069 3031 2a6e 6230 3129  nb02 + i01*nb01)
-00063220: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00063230: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-00063240: 745f 6461 7461 203d 2077 6461 7461 202b  t_data = wdata +
-00063250: 2069 3032 2a65 7730 2a6e 6530 303b 0a20   i02*ew0*ne00;. 
-00063260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063270: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-00063280: 6930 3020 3d20 303b 2069 3030 203c 206e  i00 = 0; i00 < n
-00063290: 6530 303b 2069 3030 2b2b 2920 7b0a 2020  e00; i00++) {.  
-000632a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000632b0: 2020 2020 2020 6473 745f 6461 7461 5b69        dst_data[i
-000632c0: 3030 2a65 7730 202b 2069 3031 5d20 3d20  00*ew0 + i01] = 
-000632d0: 7372 635b 6930 305d 3b0a 2020 2020 2020  src[i00];.      
-000632e0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-000632f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00063300: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
-00063310: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00063320: 2020 202f 2f20 7072 6570 6172 6520 736f     // prepare so
-00063330: 7572 6365 2064 6174 6120 2873 7263 3129  urce data (src1)
-00063340: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-00063350: 2020 2020 2020 2066 6c6f 6174 202a 2063         float * c
-00063360: 6f6e 7374 2077 6461 7461 203d 2028 666c  onst wdata = (fl
-00063370: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
-00063380: 6461 7461 202b 206e 6530 322a 6577 302a  data + ne02*ew0*
-00063390: 6e65 3030 3b0a 0a20 2020 2020 2020 2020  ne00;..         
-000633a0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-000633b0: 6931 3120 3d20 303b 2069 3131 203c 206e  i11 = 0; i11 < n
-000633c0: 6531 313b 2069 3131 2b2b 2920 7b0a 2020  e11; i11++) {.  
-000633d0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000633e0: 6e73 7420 666c 6f61 7420 2a20 636f 6e73  nst float * cons
-000633f0: 7420 7372 6320 3d20 2866 6c6f 6174 202a  t src = (float *
-00063400: 2928 2863 6861 7220 2a29 2073 7263 312d  )((char *) src1-
-00063410: 3e64 6174 6120 2b20 6931 312a 6e62 3131  >data + i11*nb11
-00063420: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00063430: 2020 2066 6c6f 6174 202a 2064 7374 5f64     float * dst_d
-00063440: 6174 6120 3d20 7764 6174 613b 0a20 2020  ata = wdata;.   
-00063450: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00063460: 2028 696e 7436 345f 7420 6931 3020 3d20   (int64_t i10 = 
-00063470: 303b 2069 3130 203c 206e 6531 303b 2069  0; i10 < ne10; i
-00063480: 3130 2b2b 2920 7b0a 2020 2020 2020 2020  10++) {.        
-00063490: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
-000634a0: 6461 7461 5b28 6931 3020 2b20 6e68 292a  data[(i10 + nh)*
-000634b0: 6577 3020 2b20 6931 315d 203d 2073 7263  ew0 + i11] = src
-000634c0: 5b69 3130 5d3b 0a20 2020 2020 2020 2020  [i10];.         
-000634d0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000634e0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-000634f0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00063500: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
-00063510: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00063520: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
-00063530: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
-00063540: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00063550: 2020 2f2f 2074 6f74 616c 2072 6f77 7320    // total rows 
-00063560: 696e 2064 7374 0a20 2020 2063 6f6e 7374  in dst.    const
-00063570: 2069 6e74 206e 7220 3d20 6e65 3032 3b0a   int nr = ne02;.
-00063580: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
-00063590: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-000635a0: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
-000635b0: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-000635c0: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
-000635d0: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
-000635e0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-000635f0: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
-00063600: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
-00063610: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
-00063620: 7229 3b0a 0a20 2020 2066 6f72 2028 696e  r);..    for (in
-00063630: 7420 6931 203d 2069 7230 3b20 6931 203c  t i1 = ir0; i1 <
-00063640: 2069 7231 3b20 6931 2b2b 2920 7b0a 2020   ir1; i1++) {.  
-00063650: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-00063660: 745f 6461 7461 203d 2028 666c 6f61 7420  t_data = (float 
-00063670: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
-00063680: 3e64 6174 6120 2b20 6931 2a6e 6231 293b  >data + i1*nb1);
-00063690: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
-000636a0: 7436 345f 7420 6930 203d 2030 3b20 6930  t64_t i0 = 0; i0
-000636b0: 203c 206e 6531 303b 202b 2b69 3029 207b   < ne10; ++i0) {
-000636c0: 0a20 2020 2020 2020 2020 2020 2064 7374  .            dst
-000636d0: 5f64 6174 615b 6930 5d20 3d20 303b 0a20  _data[i0] = 0;. 
-000636e0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-000636f0: 696e 7420 6b20 3d20 2d6e 683b 206b 203c  int k = -nh; k <
-00063700: 3d20 6e68 3b20 6b2b 2b29 207b 0a20 2020  = nh; k++) {.   
-00063710: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-00063720: 6174 2076 203d 2030 2e30 663b 0a20 2020  at v = 0.0f;.   
-00063730: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00063740: 6c5f 7665 635f 646f 745f 6633 3228 6577  l_vec_dot_f32(ew
-00063750: 302c 2026 762c 0a20 2020 2020 2020 2020  0, &v,.         
-00063760: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00063770: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
-00063780: 3e77 6461 7461 202b 2020 2069 312a 6577  >wdata +   i1*ew
-00063790: 302a 6e65 3030 202b 2020 2020 2020 286e  0*ne00 +      (n
-000637a0: 6820 2b20 6b29 2a65 7730 2c0a 2020 2020  h + k)*ew0,.    
-000637b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000637c0: 2020 2020 2866 6c6f 6174 202a 2920 7061      (float *) pa
-000637d0: 7261 6d73 2d3e 7764 6174 6120 2b20 6e65  rams->wdata + ne
-000637e0: 3032 2a65 7730 2a6e 6530 3020 2b20 2869  02*ew0*ne00 + (i
-000637f0: 3020 2b20 6e68 202b 206b 292a 6577 3029  0 + nh + k)*ew0)
-00063800: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00063810: 2020 2064 7374 5f64 6174 615b 6930 5d20     dst_data[i0] 
-00063820: 2b3d 2076 3b0a 2020 2020 2020 2020 2020  += v;.          
-00063830: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-00063840: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-00063850: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-00063860: 666f 7277 6172 645f 636f 6e76 5f31 645f  forward_conv_1d_
-00063870: 7331 5f70 6828 0a20 2020 2020 2020 2063  s1_ph(.        c
-00063880: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00063890: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-000638a0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-000638b0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000638c0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-000638d0: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-000638e0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000638f0: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00063900: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00063910: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
-00063920: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
-00063930: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-00063940: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00063950: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
-00063960: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00063970: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-00063980: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
-00063990: 5f73 315f 7068 5f66 3136 5f66 3332 2870  _s1_ph_f16_f32(p
-000639a0: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
-000639b0: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
-000639c0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000639d0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000639e0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
-000639f0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00063a00: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00063a10: 7075 7465 5f66 6f72 7761 7264 5f63 6f6e  pute_forward_con
-00063a20: 765f 3164 5f73 315f 7068 5f66 3332 2870  v_1d_s1_ph_f32(p
-00063a30: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
-00063a40: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
-00063a50: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00063a60: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
-00063a70: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00063a80: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00063a90: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00063aa0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00063ab0: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a73  reak;.    }.}..s
-00063ac0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00063ad0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00063ae0: 636f 6e76 5f31 645f 7332 5f70 685f 6631  conv_1d_s2_ph_f1
-00063af0: 365f 6633 3228 0a20 2020 2020 2020 2063  6_f32(.        c
-00063b00: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00063b10: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00063b20: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00063b30: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00063b40: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00063b50: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00063b60: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00063b70: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-00063b80: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00063b90: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
-00063ba0: 7374 2920 7b0a 2020 2020 4747 4d4c 5f41  st) {.    GGML_A
-00063bb0: 5353 4552 5428 7372 6330 2d3e 7479 7065  SSERT(src0->type
-00063bc0: 203d 3d20 4747 4d4c 5f54 5950 455f 4631   == GGML_TYPE_F1
-00063bd0: 3629 3b0a 2020 2020 4747 4d4c 5f41 5353  6);.    GGML_ASS
-00063be0: 4552 5428 7372 6331 2d3e 7479 7065 203d  ERT(src1->type =
-00063bf0: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
-00063c00: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00063c10: 5428 2064 7374 2d3e 7479 7065 203d 3d20  T( dst->type == 
-00063c20: 4747 4d4c 5f54 5950 455f 4633 3229 3b0a  GGML_TYPE_F32);.
-00063c30: 0a20 2020 2069 6e74 3634 5f74 2074 3020  .    int64_t t0 
-00063c40: 3d20 6767 6d6c 5f70 6572 665f 7469 6d65  = ggml_perf_time
-00063c50: 5f75 7328 293b 0a20 2020 2055 4e55 5345  _us();.    UNUSE
-00063c60: 4428 7430 293b 0a0a 2020 2020 4747 4d4c  D(t0);..    GGML
-00063c70: 5f54 454e 534f 525f 4249 4e41 5259 5f4f  _TENSOR_BINARY_O
-00063c80: 505f 4c4f 4341 4c53 3b0a 0a20 2020 2063  P_LOCALS;..    c
-00063c90: 6f6e 7374 2069 6e74 2069 7468 203d 2070  onst int ith = p
-00063ca0: 6172 616d 732d 3e69 7468 3b0a 2020 2020  arams->ith;.    
-00063cb0: 636f 6e73 7420 696e 7420 6e74 6820 3d20  const int nth = 
-00063cc0: 7061 7261 6d73 2d3e 6e74 683b 0a0a 2020  params->nth;..  
-00063cd0: 2020 636f 6e73 7420 696e 7420 6e6b 203d    const int nk =
-00063ce0: 206e 6530 303b 0a20 2020 2063 6f6e 7374   ne00;.    const
-00063cf0: 2069 6e74 206e 6820 3d20 6e6b 2f32 3b0a   int nh = nk/2;.
-00063d00: 0a20 2020 2063 6f6e 7374 2069 6e74 2065  .    const int e
-00063d10: 7730 203d 2067 676d 6c5f 7570 3332 286e  w0 = ggml_up32(n
-00063d20: 6530 3129 3b0a 0a20 2020 2047 474d 4c5f  e01);..    GGML_
-00063d30: 4153 5345 5254 286e 6530 3020 2520 3220  ASSERT(ne00 % 2 
-00063d40: 3d3d 2031 293b 202f 2f20 544f 444f 3a20  == 1); // TODO: 
-00063d50: 7375 7070 6f72 7420 6576 656e 206b 6572  support even ker
-00063d60: 6e65 6c20 7369 7a65 730a 2020 2020 4747  nel sizes.    GG
-00063d70: 4d4c 5f41 5353 4552 5428 6e62 3030 203d  ML_ASSERT(nb00 =
-00063d80: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
-00063d90: 3136 5f74 2929 3b0a 2020 2020 4747 4d4c  16_t));.    GGML
-00063da0: 5f41 5353 4552 5428 6e62 3130 203d 3d20  _ASSERT(nb10 == 
-00063db0: 7369 7a65 6f66 2866 6c6f 6174 2929 3b0a  sizeof(float));.
-00063dc0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00063dd0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00063de0: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
-00063df0: 2020 202f 2f20 544f 444f 3a20 6669 7820     // TODO: fix 
-00063e00: 7468 6973 206d 656d 7365 7420 2877 7369  this memset (wsi
-00063e10: 7a65 2069 7320 6f76 6572 6573 7469 6d61  ze is overestima
-00063e20: 7465 6429 0a20 2020 2020 2020 206d 656d  ted).        mem
-00063e30: 7365 7428 7061 7261 6d73 2d3e 7764 6174  set(params->wdat
-00063e40: 612c 2030 2c20 7061 7261 6d73 2d3e 7773  a, 0, params->ws
-00063e50: 697a 6529 3b0a 0a20 2020 2020 2020 202f  ize);..        /
-00063e60: 2f20 7072 6570 6172 6520 6b65 726e 656c  / prepare kernel
-00063e70: 2064 6174 6120 2873 7263 3029 0a20 2020   data (src0).   
-00063e80: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00063e90: 2020 2067 676d 6c5f 6670 3136 5f74 202a     ggml_fp16_t *
-00063ea0: 2063 6f6e 7374 2077 6461 7461 203d 2028   const wdata = (
-00063eb0: 6767 6d6c 5f66 7031 365f 7420 2a29 2070  ggml_fp16_t *) p
-00063ec0: 6172 616d 732d 3e77 6461 7461 202b 2030  arams->wdata + 0
-00063ed0: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
-00063ee0: 6f72 2028 696e 7436 345f 7420 6930 3220  or (int64_t i02 
-00063ef0: 3d20 303b 2069 3032 203c 206e 6530 323b  = 0; i02 < ne02;
-00063f00: 2069 3032 2b2b 2920 7b0a 2020 2020 2020   i02++) {.      
-00063f10: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00063f20: 6e74 3634 5f74 2069 3031 203d 2030 3b20  nt64_t i01 = 0; 
-00063f30: 6930 3120 3c20 6e65 3031 3b20 6930 312b  i01 < ne01; i01+
-00063f40: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00063f50: 2020 2020 2020 2020 2063 6f6e 7374 2067           const g
-00063f60: 676d 6c5f 6670 3136 5f74 202a 2063 6f6e  gml_fp16_t * con
-00063f70: 7374 2073 7263 203d 2028 6767 6d6c 5f66  st src = (ggml_f
-00063f80: 7031 365f 7420 2a29 2828 6368 6172 202a  p16_t *)((char *
-00063f90: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-00063fa0: 3032 2a6e 6230 3220 2b20 6930 312a 6e62  02*nb02 + i01*nb
-00063fb0: 3031 293b 0a20 2020 2020 2020 2020 2020  01);.           
-00063fc0: 2020 2020 2020 2020 2067 676d 6c5f 6670           ggml_fp
-00063fd0: 3136 5f74 202a 2064 7374 5f64 6174 6120  16_t * dst_data 
-00063fe0: 3d20 7764 6174 6120 2b20 6930 322a 6577  = wdata + i02*ew
-00063ff0: 302a 6e65 3030 3b0a 2020 2020 2020 2020  0*ne00;.        
-00064000: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00064010: 2869 6e74 3634 5f74 2069 3030 203d 2030  (int64_t i00 = 0
-00064020: 3b20 6930 3020 3c20 6e65 3030 3b20 6930  ; i00 < ne00; i0
-00064030: 302b 2b29 207b 0a20 2020 2020 2020 2020  0++) {.         
-00064040: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00064050: 7374 5f64 6174 615b 6930 302a 6577 3020  st_data[i00*ew0 
-00064060: 2b20 6930 315d 203d 2073 7263 5b69 3030  + i01] = src[i00
-00064070: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-00064080: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00064090: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000640a0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000640b0: 207d 0a0a 2020 2020 2020 2020 2f2f 2070   }..        // p
-000640c0: 7265 7061 7265 2073 6f75 7263 6520 6461  repare source da
-000640d0: 7461 2028 7372 6331 290a 2020 2020 2020  ta (src1).      
-000640e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000640f0: 6767 6d6c 5f66 7031 365f 7420 2a20 636f  ggml_fp16_t * co
-00064100: 6e73 7420 7764 6174 6120 3d20 2867 676d  nst wdata = (ggm
-00064110: 6c5f 6670 3136 5f74 202a 2920 7061 7261  l_fp16_t *) para
-00064120: 6d73 2d3e 7764 6174 6120 2b20 6e65 3032  ms->wdata + ne02
-00064130: 2a65 7730 2a6e 6530 303b 0a0a 2020 2020  *ew0*ne00;..    
-00064140: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00064150: 3634 5f74 2069 3131 203d 2030 3b20 6931  64_t i11 = 0; i1
-00064160: 3120 3c20 6e65 3131 3b20 6931 312b 2b29  1 < ne11; i11++)
-00064170: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00064180: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
-00064190: 2063 6f6e 7374 2073 7263 203d 2028 666c   const src = (fl
-000641a0: 6f61 7420 2a29 2828 6368 6172 202a 2920  oat *)((char *) 
-000641b0: 7372 6331 2d3e 6461 7461 202b 2069 3131  src1->data + i11
-000641c0: 2a6e 6231 3129 3b0a 2020 2020 2020 2020  *nb11);.        
-000641d0: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
-000641e0: 365f 7420 2a20 6473 745f 6461 7461 203d  6_t * dst_data =
-000641f0: 2077 6461 7461 3b0a 2020 2020 2020 2020   wdata;.        
-00064200: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00064210: 3634 5f74 2069 3130 203d 2030 3b20 6931  64_t i10 = 0; i1
-00064220: 3020 3c20 6e65 3130 3b20 6931 302b 2b29  0 < ne10; i10++)
-00064230: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00064240: 2020 2020 2020 2064 7374 5f64 6174 615b         dst_data[
-00064250: 2869 3130 202b 206e 6829 2a65 7730 202b  (i10 + nh)*ew0 +
-00064260: 2069 3131 5d20 3d20 4747 4d4c 5f46 5033   i11] = GGML_FP3
-00064270: 325f 544f 5f46 5031 3628 7372 635b 6931  2_TO_FP16(src[i1
-00064280: 305d 293b 0a20 2020 2020 2020 2020 2020  0]);.           
-00064290: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000642a0: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
-000642b0: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
-000642c0: 2020 2020 7d0a 0a20 2020 2069 6620 2870      }..    if (p
-000642d0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000642e0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-000642f0: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00064300: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00064310: 2f2f 2074 6f74 616c 2072 6f77 7320 696e  // total rows in
-00064320: 2064 7374 0a20 2020 2063 6f6e 7374 2069   dst.    const i
-00064330: 6e74 206e 7220 3d20 6e65 3032 3b0a 0a20  nt nr = ne02;.. 
-00064340: 2020 202f 2f20 726f 7773 2070 6572 2074     // rows per t
-00064350: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
-00064360: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
-00064370: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-00064380: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-00064390: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-000643a0: 2020 2063 6f6e 7374 2069 6e74 2069 7230     const int ir0
-000643b0: 203d 2064 722a 6974 683b 0a20 2020 2063   = dr*ith;.    c
-000643c0: 6f6e 7374 2069 6e74 2069 7231 203d 204d  onst int ir1 = M
-000643d0: 494e 2869 7230 202b 2064 722c 206e 7229  IN(ir0 + dr, nr)
-000643e0: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-000643f0: 6931 203d 2069 7230 3b20 6931 203c 2069  i1 = ir0; i1 < i
-00064400: 7231 3b20 6931 2b2b 2920 7b0a 2020 2020  r1; i1++) {.    
-00064410: 2020 2020 666c 6f61 7420 2a20 6473 745f      float * dst_
-00064420: 6461 7461 203d 2028 666c 6f61 7420 2a29  data = (float *)
-00064430: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
-00064440: 6174 6120 2b20 6931 2a6e 6231 293b 0a20  ata + i1*nb1);. 
-00064450: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00064460: 345f 7420 6930 203d 2030 3b20 6930 203c  4_t i0 = 0; i0 <
-00064470: 206e 6531 303b 2069 3020 2b3d 2032 2920   ne10; i0 += 2) 
-00064480: 7b0a 2020 2020 2020 2020 2020 2020 6473  {.            ds
-00064490: 745f 6461 7461 5b69 302f 325d 203d 2030  t_data[i0/2] = 0
-000644a0: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
-000644b0: 7220 2869 6e74 206b 203d 202d 6e68 3b20  r (int k = -nh; 
-000644c0: 6b20 3c3d 206e 683b 206b 2b2b 2920 7b0a  k <= nh; k++) {.
-000644d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000644e0: 666c 6f61 7420 7620 3d20 302e 3066 3b0a  float v = 0.0f;.
-000644f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064500: 6767 6d6c 5f76 6563 5f64 6f74 5f66 3136  ggml_vec_dot_f16
-00064510: 2865 7730 2c20 2676 2c0a 2020 2020 2020  (ew0, &v,.      
-00064520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064530: 2020 2867 676d 6c5f 6670 3136 5f74 202a    (ggml_fp16_t *
-00064540: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
-00064550: 2b20 2020 6931 2a65 7730 2a6e 6530 3020  +   i1*ew0*ne00 
-00064560: 2b20 2020 2020 2028 6e68 202b 206b 292a  +      (nh + k)*
-00064570: 6577 302c 0a20 2020 2020 2020 2020 2020  ew0,.           
-00064580: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
-00064590: 6d6c 5f66 7031 365f 7420 2a29 2070 6172  ml_fp16_t *) par
-000645a0: 616d 732d 3e77 6461 7461 202b 206e 6530  ams->wdata + ne0
-000645b0: 322a 6577 302a 6e65 3030 202b 2028 6930  2*ew0*ne00 + (i0
-000645c0: 202b 206e 6820 2b20 6b29 2a65 7730 293b   + nh + k)*ew0);
-000645d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000645e0: 2020 6473 745f 6461 7461 5b69 302f 325d    dst_data[i0/2]
-000645f0: 202b 3d20 763b 0a20 2020 2020 2020 2020   += v;.         
-00064600: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-00064610: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-00064620: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00064630: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
-00064640: 5f73 325f 7068 5f66 3332 280a 2020 2020  _s2_ph_f32(.    
-00064650: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00064660: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00064670: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00064680: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00064690: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000646a0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-000646b0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000646c0: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-000646d0: 0a20 2020 2020 2020 2020 2020 2020 2073  .              s
-000646e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-000646f0: 7220 2a20 6473 7429 207b 0a20 2020 2047  r * dst) {.    G
-00064700: 474d 4c5f 4153 5345 5254 2873 7263 302d  GML_ASSERT(src0-
-00064710: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00064720: 5045 5f46 3332 293b 0a20 2020 2047 474d  PE_F32);.    GGM
-00064730: 4c5f 4153 5345 5254 2873 7263 312d 3e74  L_ASSERT(src1->t
-00064740: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00064750: 5f46 3332 293b 0a20 2020 2047 474d 4c5f  _F32);.    GGML_
-00064760: 4153 5345 5254 2820 6473 742d 3e74 7970  ASSERT( dst->typ
-00064770: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-00064780: 3332 293b 0a0a 2020 2020 696e 7436 345f  32);..    int64_
-00064790: 7420 7430 203d 2067 676d 6c5f 7065 7266  t t0 = ggml_perf
-000647a0: 5f74 696d 655f 7573 2829 3b0a 2020 2020  _time_us();.    
-000647b0: 554e 5553 4544 2874 3029 3b0a 0a20 2020  UNUSED(t0);..   
-000647c0: 2047 474d 4c5f 5445 4e53 4f52 5f42 494e   GGML_TENSOR_BIN
-000647d0: 4152 595f 4f50 5f4c 4f43 414c 533b 0a0a  ARY_OP_LOCALS;..
-000647e0: 2020 2020 636f 6e73 7420 696e 7420 6974      const int it
-000647f0: 6820 3d20 7061 7261 6d73 2d3e 6974 683b  h = params->ith;
-00064800: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00064810: 7468 203d 2070 6172 616d 732d 3e6e 7468  th = params->nth
-00064820: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
-00064830: 206e 6b20 3d20 6e65 3030 3b0a 2020 2020   nk = ne00;.    
-00064840: 636f 6e73 7420 696e 7420 6e68 203d 206e  const int nh = n
-00064850: 6b2f 323b 0a0a 2020 2020 636f 6e73 7420  k/2;..    const 
-00064860: 696e 7420 6577 3020 3d20 6767 6d6c 5f75  int ew0 = ggml_u
-00064870: 7033 3228 6e65 3031 293b 0a0a 2020 2020  p32(ne01);..    
-00064880: 4747 4d4c 5f41 5353 4552 5428 6e65 3030  GGML_ASSERT(ne00
-00064890: 2025 2032 203d 3d20 3129 3b20 2f2f 2054   % 2 == 1); // T
-000648a0: 4f44 4f3a 2073 7570 706f 7274 2065 7665  ODO: support eve
-000648b0: 6e20 6b65 726e 656c 2073 697a 6573 0a20  n kernel sizes. 
-000648c0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-000648d0: 6230 3020 3d3d 2073 697a 656f 6628 666c  b00 == sizeof(fl
-000648e0: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
-000648f0: 4153 5345 5254 286e 6231 3020 3d3d 2073  ASSERT(nb10 == s
-00064900: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
-00064910: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-00064920: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-00064930: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
-00064940: 2020 2f2f 2054 4f44 4f3a 2066 6978 2074    // TODO: fix t
-00064950: 6869 7320 6d65 6d73 6574 2028 7773 697a  his memset (wsiz
-00064960: 6520 6973 206f 7665 7265 7374 696d 6174  e is overestimat
-00064970: 6564 290a 2020 2020 2020 2020 6d65 6d73  ed).        mems
-00064980: 6574 2870 6172 616d 732d 3e77 6461 7461  et(params->wdata
-00064990: 2c20 302c 2070 6172 616d 732d 3e77 7369  , 0, params->wsi
-000649a0: 7a65 293b 0a0a 2020 2020 2020 2020 2f2f  ze);..        //
-000649b0: 2070 7265 7061 7265 206b 6572 6e65 6c20   prepare kernel 
-000649c0: 6461 7461 2028 7372 6330 290a 2020 2020  data (src0).    
-000649d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000649e0: 2020 666c 6f61 7420 2a20 636f 6e73 7420    float * const 
-000649f0: 7764 6174 6120 3d20 2866 6c6f 6174 202a  wdata = (float *
-00064a00: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
-00064a10: 2b20 303b 0a0a 2020 2020 2020 2020 2020  + 0;..          
-00064a20: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-00064a30: 3032 203d 2030 3b20 6930 3220 3c20 6e65  02 = 0; i02 < ne
-00064a40: 3032 3b20 6930 322b 2b29 207b 0a20 2020  02; i02++) {.   
-00064a50: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00064a60: 2028 696e 7436 345f 7420 6930 3120 3d20   (int64_t i01 = 
-00064a70: 303b 2069 3031 203c 206e 6530 313b 2069  0; i01 < ne01; i
-00064a80: 3031 2b2b 2920 7b0a 2020 2020 2020 2020  01++) {.        
-00064a90: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00064aa0: 7420 666c 6f61 7420 2a20 636f 6e73 7420  t float * const 
-00064ab0: 7372 6320 3d20 2866 6c6f 6174 202a 2928  src = (float *)(
-00064ac0: 2863 6861 7220 2a29 2073 7263 302d 3e64  (char *) src0->d
-00064ad0: 6174 6120 2b20 6930 322a 6e62 3032 202b  ata + i02*nb02 +
-00064ae0: 2069 3031 2a6e 6230 3129 3b0a 2020 2020   i01*nb01);.    
-00064af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064b00: 666c 6f61 7420 2a20 6473 745f 6461 7461  float * dst_data
-00064b10: 203d 2077 6461 7461 202b 2069 3032 2a65   = wdata + i02*e
-00064b20: 7730 2a6e 6530 303b 0a20 2020 2020 2020  w0*ne00;.       
-00064b30: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00064b40: 2028 696e 7436 345f 7420 6930 3020 3d20   (int64_t i00 = 
-00064b50: 303b 2069 3030 203c 206e 6530 303b 2069  0; i00 < ne00; i
-00064b60: 3030 2b2b 2920 7b0a 2020 2020 2020 2020  00++) {.        
-00064b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00064b80: 6473 745f 6461 7461 5b69 3030 2a65 7730  dst_data[i00*ew0
-00064b90: 202b 2069 3031 5d20 3d20 7372 635b 6930   + i01] = src[i0
-00064ba0: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
-00064bb0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00064bc0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00064bd0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00064be0: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
-00064bf0: 7072 6570 6172 6520 736f 7572 6365 2064  prepare source d
-00064c00: 6174 6120 2873 7263 3129 0a20 2020 2020  ata (src1).     
-00064c10: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00064c20: 2066 6c6f 6174 202a 2063 6f6e 7374 2077   float * const w
-00064c30: 6461 7461 203d 2028 666c 6f61 7420 2a29  data = (float *)
-00064c40: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
-00064c50: 206e 6530 322a 6577 302a 6e65 3030 3b0a   ne02*ew0*ne00;.
-00064c60: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00064c70: 2028 696e 7436 345f 7420 6931 3120 3d20   (int64_t i11 = 
-00064c80: 303b 2069 3131 203c 206e 6531 313b 2069  0; i11 < ne11; i
-00064c90: 3131 2b2b 2920 7b0a 2020 2020 2020 2020  11++) {.        
-00064ca0: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
-00064cb0: 6f61 7420 2a20 636f 6e73 7420 7372 6320  oat * const src 
-00064cc0: 3d20 2866 6c6f 6174 202a 2928 2863 6861  = (float *)((cha
-00064cd0: 7220 2a29 2073 7263 312d 3e64 6174 6120  r *) src1->data 
-00064ce0: 2b20 6931 312a 6e62 3131 293b 0a20 2020  + i11*nb11);.   
-00064cf0: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-00064d00: 6174 202a 2064 7374 5f64 6174 6120 3d20  at * dst_data = 
-00064d10: 7764 6174 613b 0a20 2020 2020 2020 2020  wdata;.         
-00064d20: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-00064d30: 345f 7420 6931 3020 3d20 303b 2069 3130  4_t i10 = 0; i10
-00064d40: 203c 206e 6531 303b 2069 3130 2b2b 2920   < ne10; i10++) 
-00064d50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00064d60: 2020 2020 2020 6473 745f 6461 7461 5b28        dst_data[(
-00064d70: 6931 3020 2b20 6e68 292a 6577 3020 2b20  i10 + nh)*ew0 + 
-00064d80: 6931 315d 203d 2073 7263 5b69 3130 5d3b  i11] = src[i10];
-00064d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00064da0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-00064db0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00064dc0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00064dd0: 7d0a 0a20 2020 2069 6620 2870 6172 616d  }..    if (param
-00064de0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00064df0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00064e00: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00064e10: 0a20 2020 207d 0a0a 2020 2020 2f2f 2074  .    }..    // t
-00064e20: 6f74 616c 2072 6f77 7320 696e 2064 7374  otal rows in dst
-00064e30: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00064e40: 7220 3d20 6e65 3032 3b0a 0a20 2020 202f  r = ne02;..    /
-00064e50: 2f20 726f 7773 2070 6572 2074 6872 6561  / rows per threa
-00064e60: 640a 2020 2020 636f 6e73 7420 696e 7420  d.    const int 
-00064e70: 6472 203d 2028 6e72 202b 206e 7468 202d  dr = (nr + nth -
-00064e80: 2031 292f 6e74 683b 0a0a 2020 2020 2f2f   1)/nth;..    //
-00064e90: 2072 6f77 2072 616e 6765 2066 6f72 2074   row range for t
-00064ea0: 6869 7320 7468 7265 6164 0a20 2020 2063  his thread.    c
-00064eb0: 6f6e 7374 2069 6e74 2069 7230 203d 2064  onst int ir0 = d
-00064ec0: 722a 6974 683b 0a20 2020 2063 6f6e 7374  r*ith;.    const
-00064ed0: 2069 6e74 2069 7231 203d 204d 494e 2869   int ir1 = MIN(i
-00064ee0: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
-00064ef0: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
-00064f00: 2069 7230 3b20 6931 203c 2069 7231 3b20   ir0; i1 < ir1; 
-00064f10: 6931 2b2b 2920 7b0a 2020 2020 2020 2020  i1++) {.        
-00064f20: 666c 6f61 7420 2a20 6473 745f 6461 7461  float * dst_data
-00064f30: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
-00064f40: 6172 202a 2920 6473 742d 3e64 6174 6120  ar *) dst->data 
-00064f50: 2b20 6931 2a6e 6231 293b 0a20 2020 2020  + i1*nb1);.     
-00064f60: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
-00064f70: 6930 203d 2030 3b20 6930 203c 206e 6531  i0 = 0; i0 < ne1
-00064f80: 303b 2069 3020 2b3d 2032 2920 7b0a 2020  0; i0 += 2) {.  
-00064f90: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
-00064fa0: 7461 5b69 302f 325d 203d 2030 3b0a 2020  ta[i0/2] = 0;.  
-00064fb0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00064fc0: 6e74 206b 203d 202d 6e68 3b20 6b20 3c3d  nt k = -nh; k <=
-00064fd0: 206e 683b 206b 2b2b 2920 7b0a 2020 2020   nh; k++) {.    
-00064fe0: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-00064ff0: 7420 7620 3d20 302e 3066 3b0a 2020 2020  t v = 0.0f;.    
-00065000: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00065010: 5f76 6563 5f64 6f74 5f66 3332 2865 7730  _vec_dot_f32(ew0
-00065020: 2c20 2676 2c0a 2020 2020 2020 2020 2020  , &v,.          
-00065030: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-00065040: 6c6f 6174 202a 2920 7061 7261 6d73 2d3e  loat *) params->
-00065050: 7764 6174 6120 2b20 2020 6931 2a65 7730  wdata +   i1*ew0
-00065060: 2a6e 6530 3020 2b20 2020 2020 2028 6e68  *ne00 +      (nh
-00065070: 202b 206b 292a 6577 302c 0a20 2020 2020   + k)*ew0,.     
-00065080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065090: 2020 2028 666c 6f61 7420 2a29 2070 6172     (float *) par
-000650a0: 616d 732d 3e77 6461 7461 202b 206e 6530  ams->wdata + ne0
-000650b0: 322a 6577 302a 6e65 3030 202b 2028 6930  2*ew0*ne00 + (i0
-000650c0: 202b 206e 6820 2b20 6b29 2a65 7730 293b   + nh + k)*ew0);
-000650d0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000650e0: 2020 6473 745f 6461 7461 5b69 302f 325d    dst_data[i0/2]
-000650f0: 202b 3d20 763b 0a20 2020 2020 2020 2020   += v;.         
-00065100: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-00065110: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
-00065120: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00065130: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
-00065140: 5f73 325f 7068 280a 2020 2020 2020 2020  _s2_ph(.        
-00065150: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00065160: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00065170: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-00065180: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00065190: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000651a0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
-000651b0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-000651c0: 6e73 6f72 202a 2073 7263 312c 0a20 2020  nsor * src1,.   
-000651d0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-000651e0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-000651f0: 0a20 2020 2073 7769 7463 6820 2873 7263  .    switch (src
-00065200: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-00065210: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-00065220: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
-00065230: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00065240: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00065250: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
-00065260: 645f 7332 5f70 685f 6631 365f 6633 3228  d_s2_ph_f16_f32(
-00065270: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-00065280: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-00065290: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000652a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000652b0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-000652c0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000652d0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-000652e0: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
-000652f0: 6e76 5f31 645f 7332 5f70 685f 6633 3228  nv_1d_s2_ph_f32(
-00065300: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-00065310: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
-00065320: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00065330: 2020 2020 2020 2064 6566 6175 6c74 3a0a         default:.
-00065340: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00065350: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00065360: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00065370: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00065380: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00065390: 2f2f 2067 676d 6c5f 636f 6d70 7574 655f  // ggml_compute_
-000653a0: 666f 7277 6172 645f 636f 6e76 5f31 640a  forward_conv_1d.
-000653b0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-000653c0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000653d0: 645f 636f 6e76 5f31 6428 0a20 2020 2063  d_conv_1d(.    c
-000653e0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000653f0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00065400: 2a20 7061 7261 6d73 2c0a 2020 2020 636f  * params,.    co
+00061f20: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
+00061f30: 5f66 7031 365f 7420 2a20 636f 6e73 7420  _fp16_t * const 
+00061f40: 6479 2020 3d20 2867 676d 6c5f 6670 3136  dy  = (ggml_fp16
+00061f50: 5f74 202a 2928 2863 6861 7220 2a29 2073  _t *)((char *) s
+00061f60: 7263 302d 3e64 6174 6120 2b20 6933 2a6e  rc0->data + i3*n
+00061f70: 6230 3320 2b20 6932 2a6e 6230 3220 2b20  b03 + i2*nb02 + 
+00061f80: 6931 2a6e 6230 3120 2b20 6930 2a6e 6230  i1*nb01 + i0*nb0
+00061f90: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+00061fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00061fb0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
+00061fc0: 7420 2a20 2020 2020 2020 6478 2020 3d20  t *       dx  = 
+00061fd0: 2867 676d 6c5f 6670 3136 5f74 202a 2928  (ggml_fp16_t *)(
+00061fe0: 2863 6861 7220 2a29 2020 6473 742d 3e64  (char *)  dst->d
+00061ff0: 6174 6120 2b20 6933 2a6e 6233 2020 2b20  ata + i3*nb3  + 
+00062000: 6932 2a6e 6232 2020 2b20 6931 2a6e 6231  i2*nb2  + i1*nb1
+00062010: 2020 2b20 6930 2a6e 6230 293b 0a0a 2020    + i0*nb0);..  
+00062020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062030: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00062040: 666c 6f61 7420 6479 3020 3d20 4747 4d4c  float dy0 = GGML
+00062050: 5f46 5031 365f 544f 5f46 5033 3228 6479  _FP16_TO_FP32(dy
+00062060: 5b30 5d29 3b0a 2020 2020 2020 2020 2020  [0]);.          
+00062070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062080: 2020 636f 6e73 7420 666c 6f61 7420 6479    const float dy
+00062090: 3120 3d20 4747 4d4c 5f46 5031 365f 544f  1 = GGML_FP16_TO
+000620a0: 5f46 5033 3228 6479 5b6e 5f64 696d 732f  _FP32(dy[n_dims/
+000620b0: 325d 293b 0a0a 2020 2020 2020 2020 2020  2]);..          
+000620c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000620d0: 2020 6478 5b30 5d20 2020 2020 2020 203d    dx[0]        =
+000620e0: 2047 474d 4c5f 4650 3332 5f54 4f5f 4650   GGML_FP32_TO_FP
+000620f0: 3136 2820 6479 302a 636f 735f 7468 6574  16( dy0*cos_thet
+00062100: 6120 2b20 6479 312a 7369 6e5f 7468 6574  a + dy1*sin_thet
+00062110: 6129 3b0a 2020 2020 2020 2020 2020 2020  a);.            
+00062120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062130: 6478 5b6e 5f64 696d 732f 325d 203d 2047  dx[n_dims/2] = G
+00062140: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+00062150: 282d 6479 302a 7369 6e5f 7468 6574 6120  (-dy0*sin_theta 
+00062160: 2b20 6479 312a 636f 735f 7468 6574 6129  + dy1*cos_theta)
+00062170: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00062180: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00062190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000621a0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+000621b0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+000621c0: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+000621d0: 7d0a 7d0a 0a73 7461 7469 6320 766f 6964  }.}..static void
+000621e0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+000621f0: 7277 6172 645f 726f 7065 5f62 6163 6b28  rward_rope_back(
+00062200: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00062210: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00062220: 7465 5f70 6172 616d 7320 2a20 7061 7261  te_params * para
+00062230: 6d73 2c0a 2020 2020 2020 2020 636f 6e73  ms,.        cons
+00062240: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00062250: 6e73 6f72 202a 2073 7263 302c 0a20 2020  nsor * src0,.   
+00062260: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00062270: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00062280: 7372 6331 2c0a 2020 2020 2020 2020 7374  src1,.        st
+00062290: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000622a0: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
+000622b0: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
+000622c0: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+000622d0: 2047 474d 4c5f 5459 5045 5f46 3136 3a0a   GGML_TYPE_F16:.
+000622e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000622f0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00062300: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00062310: 7264 5f72 6f70 655f 6261 636b 5f66 3136  rd_rope_back_f16
+00062320: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+00062330: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+00062340: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00062350: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00062360: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00062370: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00062380: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00062390: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+000623a0: 6f70 655f 6261 636b 5f66 3332 2870 6172  ope_back_f32(par
+000623b0: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
+000623c0: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+000623d0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+000623e0: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
+000623f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00062400: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00062410: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+00062420: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00062430: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
+00062440: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00062450: 7761 7264 5f63 6f6e 765f 3164 0a0a 7374  ward_conv_1d..st
+00062460: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00062470: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+00062480: 6f6e 765f 3164 5f73 315f 7068 5f66 3136  onv_1d_s1_ph_f16
+00062490: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
+000624a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000624b0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+000624c0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+000624d0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+000624e0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+000624f0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00062500: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00062510: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+00062520: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+00062530: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00062540: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
+00062550: 5345 5254 2873 7263 302d 3e74 7970 6520  SERT(src0->type 
+00062560: 3d3d 2047 474d 4c5f 5459 5045 5f46 3136  == GGML_TYPE_F16
+00062570: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00062580: 5254 2873 7263 312d 3e74 7970 6520 3d3d  RT(src1->type ==
+00062590: 2047 474d 4c5f 5459 5045 5f46 3332 293b   GGML_TYPE_F32);
+000625a0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000625b0: 2820 6473 742d 3e74 7970 6520 3d3d 2047  ( dst->type == G
+000625c0: 474d 4c5f 5459 5045 5f46 3332 293b 0a0a  GML_TYPE_F32);..
+000625d0: 2020 2020 696e 7436 345f 7420 7430 203d      int64_t t0 =
+000625e0: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
+000625f0: 7573 2829 3b0a 2020 2020 554e 5553 4544  us();.    UNUSED
+00062600: 2874 3029 3b0a 0a20 2020 2047 474d 4c5f  (t0);..    GGML_
+00062610: 5445 4e53 4f52 5f42 494e 4152 595f 4f50  TENSOR_BINARY_OP
+00062620: 5f4c 4f43 414c 533b 0a0a 2020 2020 636f  _LOCALS;..    co
+00062630: 6e73 7420 696e 7420 6974 6820 3d20 7061  nst int ith = pa
+00062640: 7261 6d73 2d3e 6974 683b 0a20 2020 2063  rams->ith;.    c
+00062650: 6f6e 7374 2069 6e74 206e 7468 203d 2070  onst int nth = p
+00062660: 6172 616d 732d 3e6e 7468 3b0a 0a20 2020  arams->nth;..   
+00062670: 2063 6f6e 7374 2069 6e74 206e 6b20 3d20   const int nk = 
+00062680: 6e65 3030 3b0a 2020 2020 636f 6e73 7420  ne00;.    const 
+00062690: 696e 7420 6e68 203d 206e 6b2f 323b 0a0a  int nh = nk/2;..
+000626a0: 2020 2020 636f 6e73 7420 696e 7420 6577      const int ew
+000626b0: 3020 3d20 6767 6d6c 5f75 7033 3228 6e65  0 = ggml_up32(ne
+000626c0: 3031 293b 0a0a 2020 2020 4747 4d4c 5f41  01);..    GGML_A
+000626d0: 5353 4552 5428 6e65 3030 2025 2032 203d  SSERT(ne00 % 2 =
+000626e0: 3d20 3129 3b20 2f2f 2054 4f44 4f3a 2073  = 1); // TODO: s
+000626f0: 7570 706f 7274 2065 7665 6e20 6b65 726e  upport even kern
+00062700: 656c 2073 697a 6573 0a20 2020 2047 474d  el sizes.    GGM
+00062710: 4c5f 4153 5345 5254 286e 6230 3020 3d3d  L_ASSERT(nb00 ==
+00062720: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
+00062730: 365f 7429 293b 0a20 2020 2047 474d 4c5f  6_t));.    GGML_
+00062740: 4153 5345 5254 286e 6231 3020 3d3d 2073  ASSERT(nb10 == s
+00062750: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
+00062760: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
+00062770: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
+00062780: 4b5f 494e 4954 2920 7b0a 2020 2020 2020  K_INIT) {.      
+00062790: 2020 2f2f 2054 4f44 4f3a 2066 6978 2074    // TODO: fix t
+000627a0: 6869 7320 6d65 6d73 6574 2028 7773 697a  his memset (wsiz
+000627b0: 6520 6973 206f 7665 7265 7374 696d 6174  e is overestimat
+000627c0: 6564 290a 2020 2020 2020 2020 6d65 6d73  ed).        mems
+000627d0: 6574 2870 6172 616d 732d 3e77 6461 7461  et(params->wdata
+000627e0: 2c20 302c 2070 6172 616d 732d 3e77 7369  , 0, params->wsi
+000627f0: 7a65 293b 0a0a 2020 2020 2020 2020 2f2f  ze);..        //
+00062800: 2070 7265 7061 7265 206b 6572 6e65 6c20   prepare kernel 
+00062810: 6461 7461 2028 7372 6330 290a 2020 2020  data (src0).    
+00062820: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00062830: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+00062840: 636f 6e73 7420 7764 6174 6120 3d20 2867  const wdata = (g
+00062850: 676d 6c5f 6670 3136 5f74 202a 2920 7061  gml_fp16_t *) pa
+00062860: 7261 6d73 2d3e 7764 6174 6120 2b20 303b  rams->wdata + 0;
+00062870: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+00062880: 7220 2869 6e74 3634 5f74 2069 3032 203d  r (int64_t i02 =
+00062890: 2030 3b20 6930 3220 3c20 6e65 3032 3b20   0; i02 < ne02; 
+000628a0: 6930 322b 2b29 207b 0a20 2020 2020 2020  i02++) {.       
+000628b0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+000628c0: 7436 345f 7420 6930 3120 3d20 303b 2069  t64_t i01 = 0; i
+000628d0: 3031 203c 206e 6530 313b 2069 3031 2b2b  01 < ne01; i01++
+000628e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000628f0: 2020 2020 2020 2020 636f 6e73 7420 6767          const gg
+00062900: 6d6c 5f66 7031 365f 7420 2a20 636f 6e73  ml_fp16_t * cons
+00062910: 7420 7372 6320 3d20 2867 676d 6c5f 6670  t src = (ggml_fp
+00062920: 3136 5f74 202a 2928 2863 6861 7220 2a29  16_t *)((char *)
+00062930: 2073 7263 302d 3e64 6174 6120 2b20 6930   src0->data + i0
+00062940: 322a 6e62 3032 202b 2069 3031 2a6e 6230  2*nb02 + i01*nb0
+00062950: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
+00062960: 2020 2020 2020 2020 6767 6d6c 5f66 7031          ggml_fp1
+00062970: 365f 7420 2a20 6473 745f 6461 7461 203d  6_t * dst_data =
+00062980: 2077 6461 7461 202b 2069 3032 2a65 7730   wdata + i02*ew0
+00062990: 2a6e 6530 303b 0a20 2020 2020 2020 2020  *ne00;.         
+000629a0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+000629b0: 696e 7436 345f 7420 6930 3020 3d20 303b  int64_t i00 = 0;
+000629c0: 2069 3030 203c 206e 6530 303b 2069 3030   i00 < ne00; i00
+000629d0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+000629e0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+000629f0: 745f 6461 7461 5b69 3030 2a65 7730 202b  t_data[i00*ew0 +
+00062a00: 2069 3031 5d20 3d20 7372 635b 6930 305d   i01] = src[i00]
+00062a10: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00062a20: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00062a30: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00062a40: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00062a50: 7d0a 0a20 2020 2020 2020 202f 2f20 7072  }..        // pr
+00062a60: 6570 6172 6520 736f 7572 6365 2064 6174  epare source dat
+00062a70: 6120 2873 7263 3129 0a20 2020 2020 2020  a (src1).       
+00062a80: 207b 0a20 2020 2020 2020 2020 2020 2067   {.            g
+00062a90: 676d 6c5f 6670 3136 5f74 202a 2063 6f6e  gml_fp16_t * con
+00062aa0: 7374 2077 6461 7461 203d 2028 6767 6d6c  st wdata = (ggml
+00062ab0: 5f66 7031 365f 7420 2a29 2070 6172 616d  _fp16_t *) param
+00062ac0: 732d 3e77 6461 7461 202b 206e 6530 322a  s->wdata + ne02*
+00062ad0: 6577 302a 6e65 3030 3b0a 0a20 2020 2020  ew0*ne00;..     
+00062ae0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00062af0: 345f 7420 6931 3120 3d20 303b 2069 3131  4_t i11 = 0; i11
+00062b00: 203c 206e 6531 313b 2069 3131 2b2b 2920   < ne11; i11++) 
+00062b10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00062b20: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
+00062b30: 636f 6e73 7420 7372 6320 3d20 2866 6c6f  const src = (flo
+00062b40: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
+00062b50: 7263 312d 3e64 6174 6120 2b20 6931 312a  rc1->data + i11*
+00062b60: 6e62 3131 293b 0a20 2020 2020 2020 2020  nb11);.         
+00062b70: 2020 2020 2020 2067 676d 6c5f 6670 3136         ggml_fp16
+00062b80: 5f74 202a 2064 7374 5f64 6174 6120 3d20  _t * dst_data = 
+00062b90: 7764 6174 613b 0a20 2020 2020 2020 2020  wdata;.         
+00062ba0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+00062bb0: 345f 7420 6931 3020 3d20 303b 2069 3130  4_t i10 = 0; i10
+00062bc0: 203c 206e 6531 303b 2069 3130 2b2b 2920   < ne10; i10++) 
+00062bd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00062be0: 2020 2020 2020 6473 745f 6461 7461 5b28        dst_data[(
+00062bf0: 6931 3020 2b20 6e68 292a 6577 3020 2b20  i10 + nh)*ew0 + 
+00062c00: 6931 315d 203d 2047 474d 4c5f 4650 3332  i11] = GGML_FP32
+00062c10: 5f54 4f5f 4650 3136 2873 7263 5b69 3130  _TO_FP16(src[i10
+00062c20: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
+00062c30: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00062c40: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+00062c50: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+00062c60: 2020 207d 0a0a 2020 2020 6966 2028 7061     }..    if (pa
+00062c70: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
+00062c80: 4d4c 5f54 4153 4b5f 4649 4e41 4c49 5a45  ML_TASK_FINALIZE
+00062c90: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
+00062ca0: 726e 3b0a 2020 2020 7d0a 0a20 2020 202f  rn;.    }..    /
+00062cb0: 2f20 746f 7461 6c20 726f 7773 2069 6e20  / total rows in 
+00062cc0: 6473 740a 2020 2020 636f 6e73 7420 696e  dst.    const in
+00062cd0: 7420 6e72 203d 206e 6530 323b 0a0a 2020  t nr = ne02;..  
+00062ce0: 2020 2f2f 2072 6f77 7320 7065 7220 7468    // rows per th
+00062cf0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+00062d00: 6e74 2064 7220 3d20 286e 7220 2b20 6e74  nt dr = (nr + nt
+00062d10: 6820 2d20 3129 2f6e 7468 3b0a 0a20 2020  h - 1)/nth;..   
+00062d20: 202f 2f20 726f 7720 7261 6e67 6520 666f   // row range fo
+00062d30: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
+00062d40: 2020 636f 6e73 7420 696e 7420 6972 3020    const int ir0 
+00062d50: 3d20 6472 2a69 7468 3b0a 2020 2020 636f  = dr*ith;.    co
+00062d60: 6e73 7420 696e 7420 6972 3120 3d20 4d49  nst int ir1 = MI
+00062d70: 4e28 6972 3020 2b20 6472 2c20 6e72 293b  N(ir0 + dr, nr);
+00062d80: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00062d90: 3120 3d20 6972 303b 2069 3120 3c20 6972  1 = ir0; i1 < ir
+00062da0: 313b 2069 312b 2b29 207b 0a20 2020 2020  1; i1++) {.     
+00062db0: 2020 2066 6c6f 6174 202a 2064 7374 5f64     float * dst_d
+00062dc0: 6174 6120 3d20 2866 6c6f 6174 202a 2928  ata = (float *)(
+00062dd0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
+00062de0: 7461 202b 2069 312a 6e62 3129 3b0a 2020  ta + i1*nb1);.  
+00062df0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+00062e00: 5f74 2069 3020 3d20 303b 2069 3020 3c20  _t i0 = 0; i0 < 
+00062e10: 6e65 3130 3b20 2b2b 6930 2920 7b0a 2020  ne10; ++i0) {.  
+00062e20: 2020 2020 2020 2020 2020 6473 745f 6461            dst_da
+00062e30: 7461 5b69 305d 203d 2030 3b0a 2020 2020  ta[i0] = 0;.    
+00062e40: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00062e50: 206b 203d 202d 6e68 3b20 6b20 3c3d 206e   k = -nh; k <= n
+00062e60: 683b 206b 2b2b 2920 7b0a 2020 2020 2020  h; k++) {.      
+00062e70: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00062e80: 7620 3d20 302e 3066 3b0a 2020 2020 2020  v = 0.0f;.      
+00062e90: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+00062ea0: 6563 5f64 6f74 5f66 3136 2865 7730 2c20  ec_dot_f16(ew0, 
+00062eb0: 2676 2c0a 2020 2020 2020 2020 2020 2020  &v,.            
+00062ec0: 2020 2020 2020 2020 2020 2020 2867 676d              (ggm
+00062ed0: 6c5f 6670 3136 5f74 202a 2920 7061 7261  l_fp16_t *) para
+00062ee0: 6d73 2d3e 7764 6174 6120 2b20 2020 6931  ms->wdata +   i1
+00062ef0: 2a65 7730 2a6e 6530 3020 2b20 2020 2020  *ew0*ne00 +     
+00062f00: 2028 6e68 202b 206b 292a 6577 302c 0a20   (nh + k)*ew0,. 
+00062f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00062f20: 2020 2020 2020 2028 6767 6d6c 5f66 7031         (ggml_fp1
+00062f30: 365f 7420 2a29 2070 6172 616d 732d 3e77  6_t *) params->w
+00062f40: 6461 7461 202b 206e 6530 322a 6577 302a  data + ne02*ew0*
+00062f50: 6e65 3030 202b 2028 6930 202b 206e 6820  ne00 + (i0 + nh 
+00062f60: 2b20 6b29 2a65 7730 293b 0a0a 2020 2020  + k)*ew0);..    
+00062f70: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
+00062f80: 6461 7461 5b69 305d 202b 3d20 763b 0a20  data[i0] += v;. 
+00062f90: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00062fa0: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+00062fb0: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00062fc0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00062fd0: 5f63 6f6e 765f 3164 5f73 315f 7068 5f66  _conv_1d_s1_ph_f
+00062fe0: 3332 280a 2020 2020 2020 2020 636f 6e73  32(.        cons
+00062ff0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+00063000: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+00063010: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+00063020: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00063030: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
+00063040: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00063050: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00063060: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
+00063070: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00063080: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00063090: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
+000630a0: 5254 2873 7263 302d 3e74 7970 6520 3d3d  RT(src0->type ==
+000630b0: 2047 474d 4c5f 5459 5045 5f46 3332 293b   GGML_TYPE_F32);
+000630c0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+000630d0: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
+000630e0: 474d 4c5f 5459 5045 5f46 3332 293b 0a20  GML_TYPE_F32);. 
+000630f0: 2020 2047 474d 4c5f 4153 5345 5254 2820     GGML_ASSERT( 
+00063100: 6473 742d 3e74 7970 6520 3d3d 2047 474d  dst->type == GGM
+00063110: 4c5f 5459 5045 5f46 3332 293b 0a0a 2020  L_TYPE_F32);..  
+00063120: 2020 696e 7436 345f 7420 7430 203d 2067    int64_t t0 = g
+00063130: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
+00063140: 2829 3b0a 2020 2020 554e 5553 4544 2874  ();.    UNUSED(t
+00063150: 3029 3b0a 0a20 2020 2047 474d 4c5f 5445  0);..    GGML_TE
+00063160: 4e53 4f52 5f42 494e 4152 595f 4f50 5f4c  NSOR_BINARY_OP_L
+00063170: 4f43 414c 533b 0a0a 2020 2020 636f 6e73  OCALS;..    cons
+00063180: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
+00063190: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
+000631a0: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
+000631b0: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
+000631c0: 6f6e 7374 2069 6e74 206e 6b20 3d20 6e65  onst int nk = ne
+000631d0: 3030 3b0a 2020 2020 636f 6e73 7420 696e  00;.    const in
+000631e0: 7420 6e68 203d 206e 6b2f 323b 0a0a 2020  t nh = nk/2;..  
+000631f0: 2020 636f 6e73 7420 696e 7420 6577 3020    const int ew0 
+00063200: 3d20 6767 6d6c 5f75 7033 3228 6e65 3031  = ggml_up32(ne01
+00063210: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+00063220: 4552 5428 6e65 3030 2025 2032 203d 3d20  ERT(ne00 % 2 == 
+00063230: 3129 3b20 2f2f 2054 4f44 4f3a 2073 7570  1); // TODO: sup
+00063240: 706f 7274 2065 7665 6e20 6b65 726e 656c  port even kernel
+00063250: 2073 697a 6573 0a20 2020 2047 474d 4c5f   sizes.    GGML_
+00063260: 4153 5345 5254 286e 6230 3020 3d3d 2073  ASSERT(nb00 == s
+00063270: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+00063280: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00063290: 6231 3020 3d3d 2073 697a 656f 6628 666c  b10 == sizeof(fl
+000632a0: 6f61 7429 293b 0a0a 2020 2020 6966 2028  oat));..    if (
+000632b0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+000632c0: 4747 4d4c 5f54 4153 4b5f 494e 4954 2920  GGML_TASK_INIT) 
+000632d0: 7b0a 2020 2020 2020 2020 2f2f 2054 4f44  {.        // TOD
+000632e0: 4f3a 2066 6978 2074 6869 7320 6d65 6d73  O: fix this mems
+000632f0: 6574 2028 7773 697a 6520 6973 206f 7665  et (wsize is ove
+00063300: 7265 7374 696d 6174 6564 290a 2020 2020  restimated).    
+00063310: 2020 2020 6d65 6d73 6574 2870 6172 616d      memset(param
+00063320: 732d 3e77 6461 7461 2c20 302c 2070 6172  s->wdata, 0, par
+00063330: 616d 732d 3e77 7369 7a65 293b 0a0a 2020  ams->wsize);..  
+00063340: 2020 2020 2020 2f2f 2070 7265 7061 7265        // prepare
+00063350: 206b 6572 6e65 6c20 6461 7461 2028 7372   kernel data (sr
+00063360: 6330 290a 2020 2020 2020 2020 7b0a 2020  c0).        {.  
+00063370: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
+00063380: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
+00063390: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
+000633a0: 2d3e 7764 6174 6120 2b20 303b 0a0a 2020  ->wdata + 0;..  
+000633b0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+000633c0: 6e74 3634 5f74 2069 3032 203d 2030 3b20  nt64_t i02 = 0; 
+000633d0: 6930 3220 3c20 6e65 3032 3b20 6930 322b  i02 < ne02; i02+
+000633e0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000633f0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+00063400: 7420 6930 3120 3d20 303b 2069 3031 203c  t i01 = 0; i01 <
+00063410: 206e 6530 313b 2069 3031 2b2b 2920 7b0a   ne01; i01++) {.
+00063420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063430: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
+00063440: 2a20 636f 6e73 7420 7372 6320 3d20 2866  * const src = (f
+00063450: 6c6f 6174 202a 2928 2863 6861 7220 2a29  loat *)((char *)
+00063460: 2073 7263 302d 3e64 6174 6120 2b20 6930   src0->data + i0
+00063470: 322a 6e62 3032 202b 2069 3031 2a6e 6230  2*nb02 + i01*nb0
+00063480: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
+00063490: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+000634a0: 6473 745f 6461 7461 203d 2077 6461 7461  dst_data = wdata
+000634b0: 202b 2069 3032 2a65 7730 2a6e 6530 303b   + i02*ew0*ne00;
+000634c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000634d0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+000634e0: 7420 6930 3020 3d20 303b 2069 3030 203c  t i00 = 0; i00 <
+000634f0: 206e 6530 303b 2069 3030 2b2b 2920 7b0a   ne00; i00++) {.
+00063500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063510: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
+00063520: 5b69 3030 2a65 7730 202b 2069 3031 5d20  [i00*ew0 + i01] 
+00063530: 3d20 7372 635b 6930 305d 3b0a 2020 2020  = src[i00];.    
+00063540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063550: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00063560: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00063570: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
+00063580: 2020 2020 202f 2f20 7072 6570 6172 6520       // prepare 
+00063590: 736f 7572 6365 2064 6174 6120 2873 7263  source data (src
+000635a0: 3129 0a20 2020 2020 2020 207b 0a20 2020  1).        {.   
+000635b0: 2020 2020 2020 2020 2066 6c6f 6174 202a           float *
+000635c0: 2063 6f6e 7374 2077 6461 7461 203d 2028   const wdata = (
+000635d0: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
+000635e0: 3e77 6461 7461 202b 206e 6530 322a 6577  >wdata + ne02*ew
+000635f0: 302a 6e65 3030 3b0a 0a20 2020 2020 2020  0*ne00;..       
+00063600: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+00063610: 7420 6931 3120 3d20 303b 2069 3131 203c  t i11 = 0; i11 <
+00063620: 206e 6531 313b 2069 3131 2b2b 2920 7b0a   ne11; i11++) {.
+00063630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063640: 636f 6e73 7420 666c 6f61 7420 2a20 636f  const float * co
+00063650: 6e73 7420 7372 6320 3d20 2866 6c6f 6174  nst src = (float
+00063660: 202a 2928 2863 6861 7220 2a29 2073 7263   *)((char *) src
+00063670: 312d 3e64 6174 6120 2b20 6931 312a 6e62  1->data + i11*nb
+00063680: 3131 293b 0a20 2020 2020 2020 2020 2020  11);.           
+00063690: 2020 2020 2066 6c6f 6174 202a 2064 7374       float * dst
+000636a0: 5f64 6174 6120 3d20 7764 6174 613b 0a20  _data = wdata;. 
+000636b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000636c0: 6f72 2028 696e 7436 345f 7420 6931 3020  or (int64_t i10 
+000636d0: 3d20 303b 2069 3130 203c 206e 6531 303b  = 0; i10 < ne10;
+000636e0: 2069 3130 2b2b 2920 7b0a 2020 2020 2020   i10++) {.      
+000636f0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+00063700: 745f 6461 7461 5b28 6931 3020 2b20 6e68  t_data[(i10 + nh
+00063710: 292a 6577 3020 2b20 6931 315d 203d 2073  )*ew0 + i11] = s
+00063720: 7263 5b69 3130 5d3b 0a20 2020 2020 2020  rc[i10];.       
+00063730: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00063740: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00063750: 207d 0a0a 2020 2020 2020 2020 7265 7475   }..        retu
+00063760: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
+00063770: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00063780: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+00063790: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+000637a0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+000637b0: 2020 2020 2f2f 2074 6f74 616c 2072 6f77      // total row
+000637c0: 7320 696e 2064 7374 0a20 2020 2063 6f6e  s in dst.    con
+000637d0: 7374 2069 6e74 206e 7220 3d20 6e65 3032  st int nr = ne02
+000637e0: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
+000637f0: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
+00063800: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
+00063810: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+00063820: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+00063830: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+00063840: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00063850: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
+00063860: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
+00063870: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
+00063880: 206e 7229 3b0a 0a20 2020 2066 6f72 2028   nr);..    for (
+00063890: 696e 7420 6931 203d 2069 7230 3b20 6931  int i1 = ir0; i1
+000638a0: 203c 2069 7231 3b20 6931 2b2b 2920 7b0a   < ir1; i1++) {.
+000638b0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+000638c0: 6473 745f 6461 7461 203d 2028 666c 6f61  dst_data = (floa
+000638d0: 7420 2a29 2828 6368 6172 202a 2920 6473  t *)((char *) ds
+000638e0: 742d 3e64 6174 6120 2b20 6931 2a6e 6231  t->data + i1*nb1
+000638f0: 293b 0a20 2020 2020 2020 2066 6f72 2028  );.        for (
+00063900: 696e 7436 345f 7420 6930 203d 2030 3b20  int64_t i0 = 0; 
+00063910: 6930 203c 206e 6531 303b 202b 2b69 3029  i0 < ne10; ++i0)
+00063920: 207b 0a20 2020 2020 2020 2020 2020 2064   {.            d
+00063930: 7374 5f64 6174 615b 6930 5d20 3d20 303b  st_data[i0] = 0;
+00063940: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00063950: 2028 696e 7420 6b20 3d20 2d6e 683b 206b   (int k = -nh; k
+00063960: 203c 3d20 6e68 3b20 6b2b 2b29 207b 0a20   <= nh; k++) {. 
+00063970: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00063980: 6c6f 6174 2076 203d 2030 2e30 663b 0a20  loat v = 0.0f;. 
+00063990: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000639a0: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
+000639b0: 6577 302c 2026 762c 0a20 2020 2020 2020  ew0, &v,.       
+000639c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000639d0: 2028 666c 6f61 7420 2a29 2070 6172 616d   (float *) param
+000639e0: 732d 3e77 6461 7461 202b 2020 2069 312a  s->wdata +   i1*
+000639f0: 6577 302a 6e65 3030 202b 2020 2020 2020  ew0*ne00 +      
+00063a00: 286e 6820 2b20 6b29 2a65 7730 2c0a 2020  (nh + k)*ew0,.  
+00063a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00063a20: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
+00063a30: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
+00063a40: 6e65 3032 2a65 7730 2a6e 6530 3020 2b20  ne02*ew0*ne00 + 
+00063a50: 2869 3020 2b20 6e68 202b 206b 292a 6577  (i0 + nh + k)*ew
+00063a60: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
+00063a70: 2020 2020 2064 7374 5f64 6174 615b 6930       dst_data[i0
+00063a80: 5d20 2b3d 2076 3b0a 2020 2020 2020 2020  ] += v;.        
+00063a90: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+00063aa0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+00063ab0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+00063ac0: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
+00063ad0: 645f 7331 5f70 6828 0a20 2020 2020 2020  d_s1_ph(.       
+00063ae0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00063af0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00063b00: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00063b10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00063b20: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00063b30: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+00063b40: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00063b50: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+00063b60: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00063b70: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
+00063b80: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
+00063b90: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
+00063ba0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00063bb0: 5045 5f46 3136 3a0a 2020 2020 2020 2020  PE_F16:.        
+00063bc0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00063bd0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00063be0: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
+00063bf0: 3164 5f73 315f 7068 5f66 3136 5f66 3332  1d_s1_ph_f16_f32
+00063c00: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+00063c10: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+00063c20: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00063c30: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00063c40: 4c5f 5459 5045 5f46 3332 3a0a 2020 2020  L_TYPE_F32:.    
+00063c50: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00063c60: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00063c70: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+00063c80: 6f6e 765f 3164 5f73 315f 7068 5f66 3332  onv_1d_s1_ph_f32
+00063c90: 2870 6172 616d 732c 2073 7263 302c 2073  (params, src0, s
+00063ca0: 7263 312c 2064 7374 293b 0a20 2020 2020  rc1, dst);.     
+00063cb0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00063cc0: 2020 2020 2020 2020 6465 6661 756c 743a          default:
+00063cd0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00063ce0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00063cf0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00063d00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00063d10: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
+00063d20: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00063d30: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00063d40: 645f 636f 6e76 5f31 645f 7332 5f70 685f  d_conv_1d_s2_ph_
+00063d50: 6631 365f 6633 3228 0a20 2020 2020 2020  f16_f32(.       
+00063d60: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00063d70: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00063d80: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00063d90: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00063da0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00063db0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+00063dc0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00063dd0: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+00063de0: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00063df0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00063e00: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
+00063e10: 5f41 5353 4552 5428 7372 6330 2d3e 7479  _ASSERT(src0->ty
+00063e20: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00063e30: 4631 3629 3b0a 2020 2020 4747 4d4c 5f41  F16);.    GGML_A
+00063e40: 5353 4552 5428 7372 6331 2d3e 7479 7065  SSERT(src1->type
+00063e50: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
+00063e60: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
+00063e70: 4552 5428 2064 7374 2d3e 7479 7065 203d  ERT( dst->type =
+00063e80: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
+00063e90: 3b0a 0a20 2020 2069 6e74 3634 5f74 2074  ;..    int64_t t
+00063ea0: 3020 3d20 6767 6d6c 5f70 6572 665f 7469  0 = ggml_perf_ti
+00063eb0: 6d65 5f75 7328 293b 0a20 2020 2055 4e55  me_us();.    UNU
+00063ec0: 5345 4428 7430 293b 0a0a 2020 2020 4747  SED(t0);..    GG
+00063ed0: 4d4c 5f54 454e 534f 525f 4249 4e41 5259  ML_TENSOR_BINARY
+00063ee0: 5f4f 505f 4c4f 4341 4c53 3b0a 0a20 2020  _OP_LOCALS;..   
+00063ef0: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
+00063f00: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
+00063f10: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
+00063f20: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
+00063f30: 2020 2020 636f 6e73 7420 696e 7420 6e6b      const int nk
+00063f40: 203d 206e 6530 303b 0a20 2020 2063 6f6e   = ne00;.    con
+00063f50: 7374 2069 6e74 206e 6820 3d20 6e6b 2f32  st int nh = nk/2
+00063f60: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00063f70: 2065 7730 203d 2067 676d 6c5f 7570 3332   ew0 = ggml_up32
+00063f80: 286e 6530 3129 3b0a 0a20 2020 2047 474d  (ne01);..    GGM
+00063f90: 4c5f 4153 5345 5254 286e 6530 3020 2520  L_ASSERT(ne00 % 
+00063fa0: 3220 3d3d 2031 293b 202f 2f20 544f 444f  2 == 1); // TODO
+00063fb0: 3a20 7375 7070 6f72 7420 6576 656e 206b  : support even k
+00063fc0: 6572 6e65 6c20 7369 7a65 730a 2020 2020  ernel sizes.    
+00063fd0: 4747 4d4c 5f41 5353 4552 5428 6e62 3030  GGML_ASSERT(nb00
+00063fe0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
+00063ff0: 6670 3136 5f74 2929 3b0a 2020 2020 4747  fp16_t));.    GG
+00064000: 4d4c 5f41 5353 4552 5428 6e62 3130 203d  ML_ASSERT(nb10 =
+00064010: 3d20 7369 7a65 6f66 2866 6c6f 6174 2929  = sizeof(float))
+00064020: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+00064030: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+00064040: 5441 534b 5f49 4e49 5429 207b 0a20 2020  TASK_INIT) {.   
+00064050: 2020 2020 202f 2f20 544f 444f 3a20 6669       // TODO: fi
+00064060: 7820 7468 6973 206d 656d 7365 7420 2877  x this memset (w
+00064070: 7369 7a65 2069 7320 6f76 6572 6573 7469  size is overesti
+00064080: 6d61 7465 6429 0a20 2020 2020 2020 206d  mated).        m
+00064090: 656d 7365 7428 7061 7261 6d73 2d3e 7764  emset(params->wd
+000640a0: 6174 612c 2030 2c20 7061 7261 6d73 2d3e  ata, 0, params->
+000640b0: 7773 697a 6529 3b0a 0a20 2020 2020 2020  wsize);..       
+000640c0: 202f 2f20 7072 6570 6172 6520 6b65 726e   // prepare kern
+000640d0: 656c 2064 6174 6120 2873 7263 3029 0a20  el data (src0). 
+000640e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000640f0: 2020 2020 2067 676d 6c5f 6670 3136 5f74       ggml_fp16_t
+00064100: 202a 2063 6f6e 7374 2077 6461 7461 203d   * const wdata =
+00064110: 2028 6767 6d6c 5f66 7031 365f 7420 2a29   (ggml_fp16_t *)
+00064120: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00064130: 2030 3b0a 0a20 2020 2020 2020 2020 2020   0;..           
+00064140: 2066 6f72 2028 696e 7436 345f 7420 6930   for (int64_t i0
+00064150: 3220 3d20 303b 2069 3032 203c 206e 6530  2 = 0; i02 < ne0
+00064160: 323b 2069 3032 2b2b 2920 7b0a 2020 2020  2; i02++) {.    
+00064170: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00064180: 2869 6e74 3634 5f74 2069 3031 203d 2030  (int64_t i01 = 0
+00064190: 3b20 6930 3120 3c20 6e65 3031 3b20 6930  ; i01 < ne01; i0
+000641a0: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
+000641b0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+000641c0: 2067 676d 6c5f 6670 3136 5f74 202a 2063   ggml_fp16_t * c
+000641d0: 6f6e 7374 2073 7263 203d 2028 6767 6d6c  onst src = (ggml
+000641e0: 5f66 7031 365f 7420 2a29 2828 6368 6172  _fp16_t *)((char
+000641f0: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00064200: 2069 3032 2a6e 6230 3220 2b20 6930 312a   i02*nb02 + i01*
+00064210: 6e62 3031 293b 0a20 2020 2020 2020 2020  nb01);.         
+00064220: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00064230: 6670 3136 5f74 202a 2064 7374 5f64 6174  fp16_t * dst_dat
+00064240: 6120 3d20 7764 6174 6120 2b20 6930 322a  a = wdata + i02*
+00064250: 6577 302a 6e65 3030 3b0a 2020 2020 2020  ew0*ne00;.      
+00064260: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00064270: 7220 2869 6e74 3634 5f74 2069 3030 203d  r (int64_t i00 =
+00064280: 2030 3b20 6930 3020 3c20 6e65 3030 3b20   0; i00 < ne00; 
+00064290: 6930 302b 2b29 207b 0a20 2020 2020 2020  i00++) {.       
+000642a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000642b0: 2064 7374 5f64 6174 615b 6930 302a 6577   dst_data[i00*ew
+000642c0: 3020 2b20 6930 315d 203d 2073 7263 5b69  0 + i01] = src[i
+000642d0: 3030 5d3b 0a20 2020 2020 2020 2020 2020  00];.           
+000642e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000642f0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00064300: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00064310: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
+00064320: 2070 7265 7061 7265 2073 6f75 7263 6520   prepare source 
+00064330: 6461 7461 2028 7372 6331 290a 2020 2020  data (src1).    
+00064340: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00064350: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+00064360: 636f 6e73 7420 7764 6174 6120 3d20 2867  const wdata = (g
+00064370: 676d 6c5f 6670 3136 5f74 202a 2920 7061  gml_fp16_t *) pa
+00064380: 7261 6d73 2d3e 7764 6174 6120 2b20 6e65  rams->wdata + ne
+00064390: 3032 2a65 7730 2a6e 6530 303b 0a0a 2020  02*ew0*ne00;..  
+000643a0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+000643b0: 6e74 3634 5f74 2069 3131 203d 2030 3b20  nt64_t i11 = 0; 
+000643c0: 6931 3120 3c20 6e65 3131 3b20 6931 312b  i11 < ne11; i11+
+000643d0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000643e0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+000643f0: 202a 2063 6f6e 7374 2073 7263 203d 2028   * const src = (
+00064400: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
+00064410: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
+00064420: 3131 2a6e 6231 3129 3b0a 2020 2020 2020  11*nb11);.      
+00064430: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
+00064440: 7031 365f 7420 2a20 6473 745f 6461 7461  p16_t * dst_data
+00064450: 203d 2077 6461 7461 3b0a 2020 2020 2020   = wdata;.      
+00064460: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00064470: 6e74 3634 5f74 2069 3130 203d 2030 3b20  nt64_t i10 = 0; 
+00064480: 6931 3020 3c20 6e65 3130 3b20 6931 302b  i10 < ne10; i10+
+00064490: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000644a0: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+000644b0: 615b 2869 3130 202b 206e 6829 2a65 7730  a[(i10 + nh)*ew0
+000644c0: 202b 2069 3131 5d20 3d20 4747 4d4c 5f46   + i11] = GGML_F
+000644d0: 5033 325f 544f 5f46 5031 3628 7372 635b  P32_TO_FP16(src[
+000644e0: 6931 305d 293b 0a20 2020 2020 2020 2020  i10]);.         
+000644f0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00064500: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00064510: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00064520: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
+00064530: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
+00064540: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+00064550: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+00064560: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+00064570: 2020 2f2f 2074 6f74 616c 2072 6f77 7320    // total rows 
+00064580: 696e 2064 7374 0a20 2020 2063 6f6e 7374  in dst.    const
+00064590: 2069 6e74 206e 7220 3d20 6e65 3032 3b0a   int nr = ne02;.
+000645a0: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
+000645b0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+000645c0: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
+000645d0: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
+000645e0: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
+000645f0: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
+00064600: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+00064610: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
+00064620: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
+00064630: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
+00064640: 7229 3b0a 0a20 2020 2066 6f72 2028 696e  r);..    for (in
+00064650: 7420 6931 203d 2069 7230 3b20 6931 203c  t i1 = ir0; i1 <
+00064660: 2069 7231 3b20 6931 2b2b 2920 7b0a 2020   ir1; i1++) {.  
+00064670: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
+00064680: 745f 6461 7461 203d 2028 666c 6f61 7420  t_data = (float 
+00064690: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
+000646a0: 3e64 6174 6120 2b20 6931 2a6e 6231 293b  >data + i1*nb1);
+000646b0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+000646c0: 7436 345f 7420 6930 203d 2030 3b20 6930  t64_t i0 = 0; i0
+000646d0: 203c 206e 6531 303b 2069 3020 2b3d 2032   < ne10; i0 += 2
+000646e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000646f0: 6473 745f 6461 7461 5b69 302f 325d 203d  dst_data[i0/2] =
+00064700: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00064710: 666f 7220 2869 6e74 206b 203d 202d 6e68  for (int k = -nh
+00064720: 3b20 6b20 3c3d 206e 683b 206b 2b2b 2920  ; k <= nh; k++) 
+00064730: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00064740: 2020 666c 6f61 7420 7620 3d20 302e 3066    float v = 0.0f
+00064750: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00064760: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
+00064770: 3136 2865 7730 2c20 2676 2c0a 2020 2020  16(ew0, &v,.    
+00064780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00064790: 2020 2020 2867 676d 6c5f 6670 3136 5f74      (ggml_fp16_t
+000647a0: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+000647b0: 6120 2b20 2020 6931 2a65 7730 2a6e 6530  a +   i1*ew0*ne0
+000647c0: 3020 2b20 2020 2020 2028 6e68 202b 206b  0 +      (nh + k
+000647d0: 292a 6577 302c 0a20 2020 2020 2020 2020  )*ew0,.         
+000647e0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000647f0: 6767 6d6c 5f66 7031 365f 7420 2a29 2070  ggml_fp16_t *) p
+00064800: 6172 616d 732d 3e77 6461 7461 202b 206e  arams->wdata + n
+00064810: 6530 322a 6577 302a 6e65 3030 202b 2028  e02*ew0*ne00 + (
+00064820: 6930 202b 206e 6820 2b20 6b29 2a65 7730  i0 + nh + k)*ew0
+00064830: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00064840: 2020 2020 6473 745f 6461 7461 5b69 302f      dst_data[i0/
+00064850: 325d 202b 3d20 763b 0a20 2020 2020 2020  2] += v;.       
+00064860: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00064870: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00064880: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00064890: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
+000648a0: 3164 5f73 325f 7068 5f66 3332 280a 2020  1d_s2_ph_f32(.  
+000648b0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000648c0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000648d0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+000648e0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000648f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00064900: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00064910: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00064920: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00064930: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+00064940: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00064950: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
+00064960: 2047 474d 4c5f 4153 5345 5254 2873 7263   GGML_ASSERT(src
+00064970: 302d 3e74 7970 6520 3d3d 2047 474d 4c5f  0->type == GGML_
+00064980: 5459 5045 5f46 3332 293b 0a20 2020 2047  TYPE_F32);.    G
+00064990: 474d 4c5f 4153 5345 5254 2873 7263 312d  GML_ASSERT(src1-
+000649a0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+000649b0: 5045 5f46 3332 293b 0a20 2020 2047 474d  PE_F32);.    GGM
+000649c0: 4c5f 4153 5345 5254 2820 6473 742d 3e74  L_ASSERT( dst->t
+000649d0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+000649e0: 5f46 3332 293b 0a0a 2020 2020 696e 7436  _F32);..    int6
+000649f0: 345f 7420 7430 203d 2067 676d 6c5f 7065  4_t t0 = ggml_pe
+00064a00: 7266 5f74 696d 655f 7573 2829 3b0a 2020  rf_time_us();.  
+00064a10: 2020 554e 5553 4544 2874 3029 3b0a 0a20    UNUSED(t0);.. 
+00064a20: 2020 2047 474d 4c5f 5445 4e53 4f52 5f42     GGML_TENSOR_B
+00064a30: 494e 4152 595f 4f50 5f4c 4f43 414c 533b  INARY_OP_LOCALS;
+00064a40: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+00064a50: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
+00064a60: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+00064a70: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
+00064a80: 7468 3b0a 0a20 2020 2063 6f6e 7374 2069  th;..    const i
+00064a90: 6e74 206e 6b20 3d20 6e65 3030 3b0a 2020  nt nk = ne00;.  
+00064aa0: 2020 636f 6e73 7420 696e 7420 6e68 203d    const int nh =
+00064ab0: 206e 6b2f 323b 0a0a 2020 2020 636f 6e73   nk/2;..    cons
+00064ac0: 7420 696e 7420 6577 3020 3d20 6767 6d6c  t int ew0 = ggml
+00064ad0: 5f75 7033 3228 6e65 3031 293b 0a0a 2020  _up32(ne01);..  
+00064ae0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+00064af0: 3030 2025 2032 203d 3d20 3129 3b20 2f2f  00 % 2 == 1); //
+00064b00: 2054 4f44 4f3a 2073 7570 706f 7274 2065   TODO: support e
+00064b10: 7665 6e20 6b65 726e 656c 2073 697a 6573  ven kernel sizes
+00064b20: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00064b30: 286e 6230 3020 3d3d 2073 697a 656f 6628  (nb00 == sizeof(
+00064b40: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
+00064b50: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
+00064b60: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00064b70: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+00064b80: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00064b90: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
+00064ba0: 2020 2020 2f2f 2054 4f44 4f3a 2066 6978      // TODO: fix
+00064bb0: 2074 6869 7320 6d65 6d73 6574 2028 7773   this memset (ws
+00064bc0: 697a 6520 6973 206f 7665 7265 7374 696d  ize is overestim
+00064bd0: 6174 6564 290a 2020 2020 2020 2020 6d65  ated).        me
+00064be0: 6d73 6574 2870 6172 616d 732d 3e77 6461  mset(params->wda
+00064bf0: 7461 2c20 302c 2070 6172 616d 732d 3e77  ta, 0, params->w
+00064c00: 7369 7a65 293b 0a0a 2020 2020 2020 2020  size);..        
+00064c10: 2f2f 2070 7265 7061 7265 206b 6572 6e65  // prepare kerne
+00064c20: 6c20 6461 7461 2028 7372 6330 290a 2020  l data (src0).  
+00064c30: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00064c40: 2020 2020 666c 6f61 7420 2a20 636f 6e73      float * cons
+00064c50: 7420 7764 6174 6120 3d20 2866 6c6f 6174  t wdata = (float
+00064c60: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+00064c70: 6120 2b20 303b 0a0a 2020 2020 2020 2020  a + 0;..        
+00064c80: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+00064c90: 2069 3032 203d 2030 3b20 6930 3220 3c20   i02 = 0; i02 < 
+00064ca0: 6e65 3032 3b20 6930 322b 2b29 207b 0a20  ne02; i02++) {. 
+00064cb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00064cc0: 6f72 2028 696e 7436 345f 7420 6930 3120  or (int64_t i01 
+00064cd0: 3d20 303b 2069 3031 203c 206e 6530 313b  = 0; i01 < ne01;
+00064ce0: 2069 3031 2b2b 2920 7b0a 2020 2020 2020   i01++) {.      
+00064cf0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00064d00: 6e73 7420 666c 6f61 7420 2a20 636f 6e73  nst float * cons
+00064d10: 7420 7372 6320 3d20 2866 6c6f 6174 202a  t src = (float *
+00064d20: 2928 2863 6861 7220 2a29 2073 7263 302d  )((char *) src0-
+00064d30: 3e64 6174 6120 2b20 6930 322a 6e62 3032  >data + i02*nb02
+00064d40: 202b 2069 3031 2a6e 6230 3129 3b0a 2020   + i01*nb01);.  
+00064d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00064d60: 2020 666c 6f61 7420 2a20 6473 745f 6461    float * dst_da
+00064d70: 7461 203d 2077 6461 7461 202b 2069 3032  ta = wdata + i02
+00064d80: 2a65 7730 2a6e 6530 303b 0a20 2020 2020  *ew0*ne00;.     
+00064d90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00064da0: 6f72 2028 696e 7436 345f 7420 6930 3020  or (int64_t i00 
+00064db0: 3d20 303b 2069 3030 203c 206e 6530 303b  = 0; i00 < ne00;
+00064dc0: 2069 3030 2b2b 2920 7b0a 2020 2020 2020   i00++) {.      
+00064dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00064de0: 2020 6473 745f 6461 7461 5b69 3030 2a65    dst_data[i00*e
+00064df0: 7730 202b 2069 3031 5d20 3d20 7372 635b  w0 + i01] = src[
+00064e00: 6930 305d 3b0a 2020 2020 2020 2020 2020  i00];.          
+00064e10: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00064e20: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00064e30: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00064e40: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
+00064e50: 2f20 7072 6570 6172 6520 736f 7572 6365  / prepare source
+00064e60: 2064 6174 6120 2873 7263 3129 0a20 2020   data (src1).   
+00064e70: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00064e80: 2020 2066 6c6f 6174 202a 2063 6f6e 7374     float * const
+00064e90: 2077 6461 7461 203d 2028 666c 6f61 7420   wdata = (float 
+00064ea0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
+00064eb0: 202b 206e 6530 322a 6577 302a 6e65 3030   + ne02*ew0*ne00
+00064ec0: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
+00064ed0: 6f72 2028 696e 7436 345f 7420 6931 3120  or (int64_t i11 
+00064ee0: 3d20 303b 2069 3131 203c 206e 6531 313b  = 0; i11 < ne11;
+00064ef0: 2069 3131 2b2b 2920 7b0a 2020 2020 2020   i11++) {.      
+00064f00: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00064f10: 666c 6f61 7420 2a20 636f 6e73 7420 7372  float * const sr
+00064f20: 6320 3d20 2866 6c6f 6174 202a 2928 2863  c = (float *)((c
+00064f30: 6861 7220 2a29 2073 7263 312d 3e64 6174  har *) src1->dat
+00064f40: 6120 2b20 6931 312a 6e62 3131 293b 0a20  a + i11*nb11);. 
+00064f50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00064f60: 6c6f 6174 202a 2064 7374 5f64 6174 6120  loat * dst_data 
+00064f70: 3d20 7764 6174 613b 0a20 2020 2020 2020  = wdata;.       
+00064f80: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+00064f90: 7436 345f 7420 6931 3020 3d20 303b 2069  t64_t i10 = 0; i
+00064fa0: 3130 203c 206e 6531 303b 2069 3130 2b2b  10 < ne10; i10++
+00064fb0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00064fc0: 2020 2020 2020 2020 6473 745f 6461 7461          dst_data
+00064fd0: 5b28 6931 3020 2b20 6e68 292a 6577 3020  [(i10 + nh)*ew0 
+00064fe0: 2b20 6931 315d 203d 2073 7263 5b69 3130  + i11] = src[i10
+00064ff0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+00065000: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00065010: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
+00065020: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+00065030: 2020 7d0a 0a20 2020 2069 6620 2870 6172    }..    if (par
+00065040: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+00065050: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+00065060: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+00065070: 6e3b 0a20 2020 207d 0a0a 2020 2020 2f2f  n;.    }..    //
+00065080: 2074 6f74 616c 2072 6f77 7320 696e 2064   total rows in d
+00065090: 7374 0a20 2020 2063 6f6e 7374 2069 6e74  st.    const int
+000650a0: 206e 7220 3d20 6e65 3032 3b0a 0a20 2020   nr = ne02;..   
+000650b0: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
+000650c0: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
+000650d0: 7420 6472 203d 2028 6e72 202b 206e 7468  t dr = (nr + nth
+000650e0: 202d 2031 292f 6e74 683b 0a0a 2020 2020   - 1)/nth;..    
+000650f0: 2f2f 2072 6f77 2072 616e 6765 2066 6f72  // row range for
+00065100: 2074 6869 7320 7468 7265 6164 0a20 2020   this thread.   
+00065110: 2063 6f6e 7374 2069 6e74 2069 7230 203d   const int ir0 =
+00065120: 2064 722a 6974 683b 0a20 2020 2063 6f6e   dr*ith;.    con
+00065130: 7374 2069 6e74 2069 7231 203d 204d 494e  st int ir1 = MIN
+00065140: 2869 7230 202b 2064 722c 206e 7229 3b0a  (ir0 + dr, nr);.
+00065150: 0a20 2020 2066 6f72 2028 696e 7420 6931  .    for (int i1
+00065160: 203d 2069 7230 3b20 6931 203c 2069 7231   = ir0; i1 < ir1
+00065170: 3b20 6931 2b2b 2920 7b0a 2020 2020 2020  ; i1++) {.      
+00065180: 2020 666c 6f61 7420 2a20 6473 745f 6461    float * dst_da
+00065190: 7461 203d 2028 666c 6f61 7420 2a29 2828  ta = (float *)((
+000651a0: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+000651b0: 6120 2b20 6931 2a6e 6231 293b 0a20 2020  a + i1*nb1);.   
+000651c0: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
+000651d0: 7420 6930 203d 2030 3b20 6930 203c 206e  t i0 = 0; i0 < n
+000651e0: 6531 303b 2069 3020 2b3d 2032 2920 7b0a  e10; i0 += 2) {.
+000651f0: 2020 2020 2020 2020 2020 2020 6473 745f              dst_
+00065200: 6461 7461 5b69 302f 325d 203d 2030 3b0a  data[i0/2] = 0;.
+00065210: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00065220: 2869 6e74 206b 203d 202d 6e68 3b20 6b20  (int k = -nh; k 
+00065230: 3c3d 206e 683b 206b 2b2b 2920 7b0a 2020  <= nh; k++) {.  
+00065240: 2020 2020 2020 2020 2020 2020 2020 666c                fl
+00065250: 6f61 7420 7620 3d20 302e 3066 3b0a 2020  oat v = 0.0f;.  
+00065260: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00065270: 6d6c 5f76 6563 5f64 6f74 5f66 3332 2865  ml_vec_dot_f32(e
+00065280: 7730 2c20 2676 2c0a 2020 2020 2020 2020  w0, &v,.        
+00065290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000652a0: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
+000652b0: 2d3e 7764 6174 6120 2b20 2020 6931 2a65  ->wdata +   i1*e
+000652c0: 7730 2a6e 6530 3020 2b20 2020 2020 2028  w0*ne00 +      (
+000652d0: 6e68 202b 206b 292a 6577 302c 0a20 2020  nh + k)*ew0,.   
+000652e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000652f0: 2020 2020 2028 666c 6f61 7420 2a29 2070       (float *) p
+00065300: 6172 616d 732d 3e77 6461 7461 202b 206e  arams->wdata + n
+00065310: 6530 322a 6577 302a 6e65 3030 202b 2028  e02*ew0*ne00 + (
+00065320: 6930 202b 206e 6820 2b20 6b29 2a65 7730  i0 + nh + k)*ew0
+00065330: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00065340: 2020 2020 6473 745f 6461 7461 5b69 302f      dst_data[i0/
+00065350: 325d 202b 3d20 763b 0a20 2020 2020 2020  2] += v;.       
+00065360: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00065370: 0a20 2020 207d 0a7d 0a0a 7374 6174 6963  .    }.}..static
+00065380: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00065390: 7465 5f66 6f72 7761 7264 5f63 6f6e 765f  te_forward_conv_
+000653a0: 3164 5f73 325f 7068 280a 2020 2020 2020  1d_s2_ph(.      
+000653b0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000653c0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+000653d0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+000653e0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+000653f0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00065400: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
 00065410: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00065420: 7465 6e73 6f72 202a 2073 7263 302c 0a20  tensor * src0,. 
-00065430: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00065440: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-00065450: 6331 2c0a 2020 2020 636f 6e73 7420 7374  c1,.    const st
-00065460: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00065470: 202a 206f 7074 302c 0a20 2020 2073 7472   * opt0,.    str
-00065480: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00065490: 2a20 6473 7429 207b 0a20 2020 2063 6f6e  * dst) {.    con
-000654a0: 7374 2069 6e74 3332 5f74 2073 3020 3d20  st int32_t s0 = 
-000654b0: 2828 636f 6e73 7420 696e 7433 325f 742a  ((const int32_t*
-000654c0: 2928 6f70 7430 2d3e 6461 7461 2929 5b30  )(opt0->data))[0
-000654d0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-000654e0: 3332 5f74 2070 3020 3d20 2828 636f 6e73  32_t p0 = ((cons
-000654f0: 7420 696e 7433 325f 742a 2928 6f70 7430  t int32_t*)(opt0
-00065500: 2d3e 6461 7461 2929 5b31 5d3b 0a20 2020  ->data))[1];.   
-00065510: 2063 6f6e 7374 2069 6e74 3332 5f74 2064   const int32_t d
-00065520: 3020 3d20 2828 636f 6e73 7420 696e 7433  0 = ((const int3
-00065530: 325f 742a 2928 6f70 7430 2d3e 6461 7461  2_t*)(opt0->data
-00065540: 2929 5b32 5d3b 0a20 2020 2047 474d 4c5f  ))[2];.    GGML_
-00065550: 4153 5345 5254 2864 3020 3d3d 2031 293b  ASSERT(d0 == 1);
-00065560: 202f 2f20 6469 6c61 7469 6f6e 206e 6f74   // dilation not
-00065570: 2073 7570 706f 7274 6564 0a20 2020 2047   supported.    G
-00065580: 474d 4c5f 4153 5345 5254 2870 3020 3d3d  GML_ASSERT(p0 ==
-00065590: 2073 7263 302d 3e6e 655b 305d 2f32 293b   src0->ne[0]/2);
-000655a0: 202f 2f20 6f6e 6c79 2068 616c 6620 7061   // only half pa
-000655b0: 6464 696e 6720 7375 7070 6f72 7465 640a  dding supported.
-000655c0: 2020 2020 6966 2028 7330 203d 3d20 3129      if (s0 == 1)
-000655d0: 207b 0a20 2020 2020 2020 2067 676d 6c5f   {.        ggml_
-000655e0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000655f0: 636f 6e76 5f31 645f 7331 5f70 6828 7061  conv_1d_s1_ph(pa
-00065600: 7261 6d73 2c20 7372 6330 2c20 7372 6331  rams, src0, src1
-00065610: 2c20 6473 7429 3b0a 2020 2020 7d20 656c  , dst);.    } el
-00065620: 7365 2069 6620 2873 3020 3d3d 2032 2920  se if (s0 == 2) 
-00065630: 7b0a 2020 2020 2020 2020 6767 6d6c 5f63  {.        ggml_c
-00065640: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00065650: 6f6e 765f 3164 5f73 325f 7068 2870 6172  onv_1d_s2_ph(par
-00065660: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00065670: 2064 7374 293b 0a20 2020 207d 2065 6c73   dst);.    } els
-00065680: 6520 7b0a 2020 2020 2020 2020 4747 4d4c  e {.        GGML
-00065690: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-000656a0: 2f2f 206f 6e6c 7920 7374 7269 6465 2031  // only stride 1
-000656b0: 2061 6e64 2032 2073 7570 706f 7274 6564   and 2 supported
-000656c0: 0a20 2020 207d 3b0a 7d0a 0a2f 2f20 6767  .    };.}..// gg
-000656d0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-000656e0: 7264 5f63 6f6e 765f 3264 5f73 6b5f 7030  rd_conv_2d_sk_p0
-000656f0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00065700: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00065710: 7264 5f63 6f6e 765f 3264 5f73 6b5f 7030  rd_conv_2d_sk_p0
-00065720: 5f66 3136 5f66 3332 280a 2020 2020 2020  _f16_f32(.      
-00065730: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00065740: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00065750: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00065760: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00065770: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00065780: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00065790: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-000657a0: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-000657b0: 2020 2020 2020 2020 2020 2020 2073 7472               str
-000657c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000657d0: 2a20 6473 7429 207b 0a20 2020 2047 474d  * dst) {.    GGM
-000657e0: 4c5f 4153 5345 5254 2873 7263 302d 3e74  L_ASSERT(src0->t
-000657f0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00065800: 5f46 3136 293b 0a20 2020 2047 474d 4c5f  _F16);.    GGML_
-00065810: 4153 5345 5254 2873 7263 312d 3e74 7970  ASSERT(src1->typ
-00065820: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-00065830: 3332 293b 0a20 2020 2047 474d 4c5f 4153  32);.    GGML_AS
-00065840: 5345 5254 2820 6473 742d 3e74 7970 6520  SERT( dst->type 
-00065850: 3d3d 2047 474d 4c5f 5459 5045 5f46 3332  == GGML_TYPE_F32
-00065860: 293b 0a0a 2020 2020 696e 7436 345f 7420  );..    int64_t 
-00065870: 7430 203d 2067 676d 6c5f 7065 7266 5f74  t0 = ggml_perf_t
-00065880: 696d 655f 7573 2829 3b0a 2020 2020 554e  ime_us();.    UN
-00065890: 5553 4544 2874 3029 3b0a 0a20 2020 2047  USED(t0);..    G
-000658a0: 474d 4c5f 5445 4e53 4f52 5f42 494e 4152  GML_TENSOR_BINAR
-000658b0: 595f 4f50 5f4c 4f43 414c 533b 0a0a 2020  Y_OP_LOCALS;..  
-000658c0: 2020 636f 6e73 7420 696e 7420 6974 6820    const int ith 
-000658d0: 3d20 7061 7261 6d73 2d3e 6974 683b 0a20  = params->ith;. 
-000658e0: 2020 2063 6f6e 7374 2069 6e74 206e 7468     const int nth
-000658f0: 203d 2070 6172 616d 732d 3e6e 7468 3b0a   = params->nth;.
-00065900: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-00065910: 6b30 203d 206e 6530 303b 0a20 2020 2063  k0 = ne00;.    c
-00065920: 6f6e 7374 2069 6e74 206e 6b31 203d 206e  onst int nk1 = n
-00065930: 6530 313b 0a0a 2020 2020 2f2f 2073 697a  e01;..    // siz
-00065940: 6520 6f66 2074 6865 2063 6f6e 766f 6c75  e of the convolu
-00065950: 7469 6f6e 2072 6f77 202d 2074 6865 206b  tion row - the k
-00065960: 6572 6e65 6c20 7369 7a65 2075 6e72 6f6c  ernel size unrol
-00065970: 6c65 6420 6163 726f 7373 2061 6c6c 2063  led across all c
-00065980: 6861 6e6e 656c 730a 2020 2020 636f 6e73  hannels.    cons
-00065990: 7420 696e 7420 6577 3020 3d20 6e6b 302a  t int ew0 = nk0*
-000659a0: 6e6b 312a 6e65 3032 3b0a 0a20 2020 2047  nk1*ne02;..    G
-000659b0: 474d 4c5f 4153 5345 5254 286e 6230 3020  GML_ASSERT(nb00 
-000659c0: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-000659d0: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
-000659e0: 4c5f 4153 5345 5254 286e 6231 3020 3d3d  L_ASSERT(nb10 ==
-000659f0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00065a00: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
-00065a10: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00065a20: 4153 4b5f 494e 4954 2920 7b0a 2020 2020  ASK_INIT) {.    
-00065a30: 2020 2020 2f2f 2054 4f44 4f3a 2066 6978      // TODO: fix
-00065a40: 2074 6869 7320 6d65 6d73 6574 2028 7773   this memset (ws
-00065a50: 697a 6520 6973 206f 7665 7265 7374 696d  ize is overestim
-00065a60: 6174 6564 290a 2020 2020 2020 2020 6d65  ated).        me
-00065a70: 6d73 6574 2870 6172 616d 732d 3e77 6461  mset(params->wda
-00065a80: 7461 2c20 302c 2070 6172 616d 732d 3e77  ta, 0, params->w
-00065a90: 7369 7a65 293b 0a0a 2020 2020 2020 2020  size);..        
-00065aa0: 2f2f 2070 7265 7061 7265 2073 6f75 7263  // prepare sourc
-00065ab0: 6520 6461 7461 2028 7372 6331 290a 2020  e data (src1).  
-00065ac0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00065ad0: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-00065ae0: 2a20 636f 6e73 7420 7764 6174 6120 3d20  * const wdata = 
-00065af0: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
-00065b00: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
-00065b10: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
-00065b20: 666f 7220 2869 6e74 2069 3133 203d 2030  for (int i13 = 0
-00065b30: 3b20 6931 3320 3c20 6e65 3133 3b20 6931  ; i13 < ne13; i1
-00065b40: 332b 2b29 207b 0a20 2020 2020 2020 2020  3++) {.         
-00065b50: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00065b60: 6931 3220 3d20 303b 2069 3132 203c 206e  i12 = 0; i12 < n
-00065b70: 6531 323b 2069 3132 2b2b 2920 7b0a 2020  e12; i12++) {.  
-00065b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065b90: 2020 636f 6e73 7420 666c 6f61 7420 2a20    const float * 
-00065ba0: 636f 6e73 7420 7372 6320 3d20 2866 6c6f  const src = (flo
-00065bb0: 6174 202a 2928 2863 6861 7220 2a29 2073  at *)((char *) s
-00065bc0: 7263 312d 3e64 6174 6120 2b20 6931 332a  rc1->data + i13*
-00065bd0: 6e62 3133 202b 2069 3132 2a6e 6231 3229  nb13 + i12*nb12)
-00065be0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00065bf0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
-00065c00: 7420 2a20 6473 745f 6461 7461 203d 2077  t * dst_data = w
-00065c10: 6461 7461 202b 2069 3133 2a28 6e65 312a  data + i13*(ne1*
-00065c20: 6e65 302a 6577 3029 3b0a 0a20 2020 2020  ne0*ew0);..     
-00065c30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00065c40: 6f72 2028 696e 7420 6931 203d 2030 3b20  or (int i1 = 0; 
-00065c50: 6931 203c 206e 6531 3b20 6931 2b2b 2920  i1 < ne1; i1++) 
-00065c60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00065c70: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-00065c80: 6e74 2069 3020 3d20 303b 2069 3020 3c20  nt i0 = 0; i0 < 
-00065c90: 6e65 303b 2069 302b 2b29 207b 0a20 2020  ne0; i0++) {.   
-00065ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065cb0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00065cc0: 7420 696b 3120 3d20 303b 2069 6b31 203c  t ik1 = 0; ik1 <
-00065cd0: 206e 6b31 3b20 696b 312b 2b29 207b 0a20   nk1; ik1++) {. 
-00065ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065cf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00065d00: 6f72 2028 696e 7420 696b 3020 3d20 303b  or (int ik0 = 0;
-00065d10: 2069 6b30 203c 206e 6b30 3b20 696b 302b   ik0 < nk0; ik0+
-00065d20: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
-00065d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065d40: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
-00065d50: 615b 2869 312a 6e65 3020 2b20 6930 292a  a[(i1*ne0 + i0)*
-00065d60: 6577 3020 2b20 6931 322a 286e 6b30 2a6e  ew0 + i12*(nk0*n
-00065d70: 6b31 2920 2b20 696b 312a 6e6b 3020 2b20  k1) + ik1*nk0 + 
-00065d80: 696b 305d 203d 0a20 2020 2020 2020 2020  ik0] =.         
-00065d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065da0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00065db0: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
-00065dc0: 2873 7263 5b28 6931 2a6e 6b31 202b 2069  (src[(i1*nk1 + i
-00065dd0: 6b31 292a 6e65 3130 202b 2028 6930 2a6e  k1)*ne10 + (i0*n
-00065de0: 6b30 202b 2069 6b30 295d 293b 0a20 2020  k0 + ik0)]);.   
-00065df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065e00: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00065e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065e20: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00065e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00065e40: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00065e50: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00065e60: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00065e70: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00065e80: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-00065e90: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00065ea0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-00065eb0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-00065ec0: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
-00065ed0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-00065ee0: 207d 0a0a 2020 2020 2f2f 2074 6f74 616c   }..    // total
-00065ef0: 2070 6174 6368 6573 2069 6e20 6473 740a   patches in dst.
-00065f00: 2020 2020 636f 6e73 7420 696e 7420 6e70      const int np
-00065f10: 203d 206e 6532 3b0a 0a20 2020 202f 2f20   = ne2;..    // 
-00065f20: 7061 7463 6865 7320 7065 7220 7468 7265  patches per thre
-00065f30: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-00065f40: 2064 7020 3d20 286e 7020 2b20 6e74 6820   dp = (np + nth 
-00065f50: 2d20 3129 2f6e 7468 3b0a 0a20 2020 202f  - 1)/nth;..    /
-00065f60: 2f20 7061 7463 6820 7261 6e67 6520 666f  / patch range fo
-00065f70: 7220 7468 6973 2074 6872 6561 640a 2020  r this thread.  
-00065f80: 2020 636f 6e73 7420 696e 7420 6970 3020    const int ip0 
-00065f90: 3d20 6470 2a69 7468 3b0a 2020 2020 636f  = dp*ith;.    co
-00065fa0: 6e73 7420 696e 7420 6970 3120 3d20 4d49  nst int ip1 = MI
-00065fb0: 4e28 6970 3020 2b20 6470 2c20 6e70 293b  N(ip0 + dp, np);
-00065fc0: 0a0a 2020 2020 6767 6d6c 5f66 7031 365f  ..    ggml_fp16_
-00065fd0: 7420 2a20 636f 6e73 7420 7764 6174 6120  t * const wdata 
-00065fe0: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
-00065ff0: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
-00066000: 2b20 303b 0a0a 2020 2020 666f 7220 2869  + 0;..    for (i
-00066010: 6e74 2069 3320 3d20 303b 2069 3320 3c20  nt i3 = 0; i3 < 
-00066020: 6e65 333b 2069 332b 2b29 207b 0a20 2020  ne3; i3++) {.   
-00066030: 2020 2020 2066 6f72 2028 696e 7420 6932       for (int i2
-00066040: 203d 2069 7030 3b20 6932 203c 2069 7031   = ip0; i2 < ip1
-00066050: 3b20 6932 2b2b 2920 7b0a 2020 2020 2020  ; i2++) {.      
-00066060: 2020 2020 2020 666c 6f61 7420 2a20 6473        float * ds
-00066070: 745f 6461 7461 203d 2028 666c 6f61 7420  t_data = (float 
-00066080: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
-00066090: 3e64 6174 6120 2b20 6933 2a6e 6233 202b  >data + i3*nb3 +
-000660a0: 2069 322a 6e62 3229 3b0a 0a20 2020 2020   i2*nb2);..     
-000660b0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000660c0: 6931 203d 2030 3b20 6931 203c 206e 6531  i1 = 0; i1 < ne1
-000660d0: 3b20 2b2b 6931 2920 7b0a 2020 2020 2020  ; ++i1) {.      
-000660e0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-000660f0: 6e74 2069 3020 3d20 303b 2069 3020 3c20  nt i0 = 0; i0 < 
-00066100: 6e65 303b 202b 2b69 3029 207b 0a20 2020  ne0; ++i0) {.   
-00066110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066120: 2067 676d 6c5f 7665 635f 646f 745f 6631   ggml_vec_dot_f1
-00066130: 3628 6577 302c 2064 7374 5f64 6174 6120  6(ew0, dst_data 
-00066140: 2b20 6931 2a6e 6530 202b 2069 302c 0a20  + i1*ne0 + i0,. 
+00065420: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
+00065430: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+00065440: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00065450: 207b 0a20 2020 2073 7769 7463 6820 2873   {.    switch (s
+00065460: 7263 302d 3e74 7970 6529 207b 0a20 2020  rc0->type) {.   
+00065470: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00065480: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+00065490: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000654a0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+000654b0: 7574 655f 666f 7277 6172 645f 636f 6e76  ute_forward_conv
+000654c0: 5f31 645f 7332 5f70 685f 6631 365f 6633  _1d_s2_ph_f16_f3
+000654d0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+000654e0: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+000654f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00065500: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00065510: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+00065520: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00065530: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00065540: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00065550: 636f 6e76 5f31 645f 7332 5f70 685f 6633  conv_1d_s2_ph_f3
+00065560: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+00065570: 7372 6331 2c20 6473 7429 3b0a 2020 2020  src1, dst);.    
+00065580: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00065590: 0a20 2020 2020 2020 2064 6566 6175 6c74  .        default
+000655a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000655b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000655c0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+000655d0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+000655e0: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+000655f0: 0a0a 2f2f 2067 676d 6c5f 636f 6d70 7574  ..// ggml_comput
+00065600: 655f 666f 7277 6172 645f 636f 6e76 5f31  e_forward_conv_1
+00065610: 640a 0a73 7461 7469 6320 766f 6964 2067  d..static void g
+00065620: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00065630: 6172 645f 636f 6e76 5f31 6428 0a20 2020  ard_conv_1d(.   
+00065640: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00065650: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00065660: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00065670: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00065680: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+00065690: 0a20 2020 2063 6f6e 7374 2073 7472 7563  .    const struc
+000656a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+000656b0: 7372 6331 2c0a 2020 2020 636f 6e73 7420  src1,.    const 
+000656c0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000656d0: 6f72 202a 206f 7074 302c 0a20 2020 2073  or * opt0,.    s
+000656e0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000656f0: 7220 2a20 6473 7429 207b 0a20 2020 2063  r * dst) {.    c
+00065700: 6f6e 7374 2069 6e74 3332 5f74 2073 3020  onst int32_t s0 
+00065710: 3d20 2828 636f 6e73 7420 696e 7433 325f  = ((const int32_
+00065720: 742a 2928 6f70 7430 2d3e 6461 7461 2929  t*)(opt0->data))
+00065730: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00065740: 6e74 3332 5f74 2070 3020 3d20 2828 636f  nt32_t p0 = ((co
+00065750: 6e73 7420 696e 7433 325f 742a 2928 6f70  nst int32_t*)(op
+00065760: 7430 2d3e 6461 7461 2929 5b31 5d3b 0a20  t0->data))[1];. 
+00065770: 2020 2063 6f6e 7374 2069 6e74 3332 5f74     const int32_t
+00065780: 2064 3020 3d20 2828 636f 6e73 7420 696e   d0 = ((const in
+00065790: 7433 325f 742a 2928 6f70 7430 2d3e 6461  t32_t*)(opt0->da
+000657a0: 7461 2929 5b32 5d3b 0a20 2020 2047 474d  ta))[2];.    GGM
+000657b0: 4c5f 4153 5345 5254 2864 3020 3d3d 2031  L_ASSERT(d0 == 1
+000657c0: 293b 202f 2f20 6469 6c61 7469 6f6e 206e  ); // dilation n
+000657d0: 6f74 2073 7570 706f 7274 6564 0a20 2020  ot supported.   
+000657e0: 2047 474d 4c5f 4153 5345 5254 2870 3020   GGML_ASSERT(p0 
+000657f0: 3d3d 2073 7263 302d 3e6e 655b 305d 2f32  == src0->ne[0]/2
+00065800: 293b 202f 2f20 6f6e 6c79 2068 616c 6620  ); // only half 
+00065810: 7061 6464 696e 6720 7375 7070 6f72 7465  padding supporte
+00065820: 640a 2020 2020 6966 2028 7330 203d 3d20  d.    if (s0 == 
+00065830: 3129 207b 0a20 2020 2020 2020 2067 676d  1) {.        ggm
+00065840: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00065850: 645f 636f 6e76 5f31 645f 7331 5f70 6828  d_conv_1d_s1_ph(
+00065860: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
+00065870: 6331 2c20 6473 7429 3b0a 2020 2020 7d20  c1, dst);.    } 
+00065880: 656c 7365 2069 6620 2873 3020 3d3d 2032  else if (s0 == 2
+00065890: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
+000658a0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000658b0: 5f63 6f6e 765f 3164 5f73 325f 7068 2870  _conv_1d_s2_ph(p
+000658c0: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
+000658d0: 312c 2064 7374 293b 0a20 2020 207d 2065  1, dst);.    } e
+000658e0: 6c73 6520 7b0a 2020 2020 2020 2020 4747  lse {.        GG
+000658f0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00065900: 3b20 2f2f 206f 6e6c 7920 7374 7269 6465  ; // only stride
+00065910: 2031 2061 6e64 2032 2073 7570 706f 7274   1 and 2 support
+00065920: 6564 0a20 2020 207d 3b0a 7d0a 0a2f 2f20  ed.    };.}..// 
+00065930: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00065940: 7761 7264 5f63 6f6e 765f 3264 0a0a 7374  ward_conv_2d..st
+00065950: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00065960: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+00065970: 6f6e 765f 3264 5f66 3136 5f66 3332 280a  onv_2d_f16_f32(.
+00065980: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00065990: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+000659a0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+000659b0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+000659c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000659d0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
+000659e0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000659f0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00065a00: 7263 312c 0a20 2020 2020 2020 2063 6f6e  rc1,.        con
+00065a10: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00065a20: 656e 736f 7220 2a20 6f70 7430 2c0a 2020  ensor * opt0,.  
+00065a30: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+00065a40: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00065a50: 2064 7374 2920 7b0a 2020 2020 4747 4d4c   dst) {.    GGML
+00065a60: 5f41 5353 4552 5428 7372 6330 2d3e 7479  _ASSERT(src0->ty
+00065a70: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+00065a80: 4631 3629 3b0a 2020 2020 4747 4d4c 5f41  F16);.    GGML_A
+00065a90: 5353 4552 5428 7372 6331 2d3e 7479 7065  SSERT(src1->type
+00065aa0: 203d 3d20 4747 4d4c 5f54 5950 455f 4633   == GGML_TYPE_F3
+00065ab0: 3229 3b0a 2020 2020 4747 4d4c 5f41 5353  2);.    GGML_ASS
+00065ac0: 4552 5428 2064 7374 2d3e 7479 7065 203d  ERT( dst->type =
+00065ad0: 3d20 4747 4d4c 5f54 5950 455f 4633 3229  = GGML_TYPE_F32)
+00065ae0: 3b0a 0a20 2020 2069 6e74 3634 5f74 2074  ;..    int64_t t
+00065af0: 3020 3d20 6767 6d6c 5f70 6572 665f 7469  0 = ggml_perf_ti
+00065b00: 6d65 5f75 7328 293b 0a20 2020 2055 4e55  me_us();.    UNU
+00065b10: 5345 4428 7430 293b 0a0a 2020 2020 4747  SED(t0);..    GG
+00065b20: 4d4c 5f54 454e 534f 525f 4249 4e41 5259  ML_TENSOR_BINARY
+00065b30: 5f4f 505f 4c4f 4341 4c53 3b0a 0a20 2020  _OP_LOCALS;..   
+00065b40: 2063 6f6e 7374 2069 6e74 2069 7468 203d   const int ith =
+00065b50: 2070 6172 616d 732d 3e69 7468 3b0a 2020   params->ith;.  
+00065b60: 2020 636f 6e73 7420 696e 7420 6e74 6820    const int nth 
+00065b70: 3d20 7061 7261 6d73 2d3e 6e74 683b 0a0a  = params->nth;..
+00065b80: 2020 2020 636f 6e73 7420 696e 7420 6e6b      const int nk
+00065b90: 3020 3d20 6e65 3030 3b0a 2020 2020 636f  0 = ne00;.    co
+00065ba0: 6e73 7420 696e 7420 6e6b 3120 3d20 6e65  nst int nk1 = ne
+00065bb0: 3031 3b0a 0a20 2020 202f 2f20 7369 7a65  01;..    // size
+00065bc0: 206f 6620 7468 6520 636f 6e76 6f6c 7574   of the convolut
+00065bd0: 696f 6e20 726f 7720 2d20 7468 6520 6b65  ion row - the ke
+00065be0: 726e 656c 2073 697a 6520 756e 726f 6c6c  rnel size unroll
+00065bf0: 6564 2061 6372 6f73 7320 616c 6c20 6368  ed across all ch
+00065c00: 616e 6e65 6c73 0a20 2020 2063 6f6e 7374  annels.    const
+00065c10: 2069 6e74 2065 7730 203d 206e 6b30 2a6e   int ew0 = nk0*n
+00065c20: 6b31 2a6e 6530 323b 0a0a 2020 2020 636f  k1*ne02;..    co
+00065c30: 6e73 7420 696e 7433 325f 7420 7330 203d  nst int32_t s0 =
+00065c40: 2028 2863 6f6e 7374 2069 6e74 3332 5f74   ((const int32_t
+00065c50: 2a29 286f 7074 302d 3e64 6174 6129 295b  *)(opt0->data))[
+00065c60: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00065c70: 7433 325f 7420 7331 203d 2028 2863 6f6e  t32_t s1 = ((con
+00065c80: 7374 2069 6e74 3332 5f74 2a29 286f 7074  st int32_t*)(opt
+00065c90: 302d 3e64 6174 6129 295b 315d 3b0a 2020  0->data))[1];.  
+00065ca0: 2020 636f 6e73 7420 696e 7433 325f 7420    const int32_t 
+00065cb0: 7030 203d 2028 2863 6f6e 7374 2069 6e74  p0 = ((const int
+00065cc0: 3332 5f74 2a29 286f 7074 302d 3e64 6174  32_t*)(opt0->dat
+00065cd0: 6129 295b 325d 3b0a 2020 2020 636f 6e73  a))[2];.    cons
+00065ce0: 7420 696e 7433 325f 7420 7031 203d 2028  t int32_t p1 = (
+00065cf0: 2863 6f6e 7374 2069 6e74 3332 5f74 2a29  (const int32_t*)
+00065d00: 286f 7074 302d 3e64 6174 6129 295b 335d  (opt0->data))[3]
+00065d10: 3b0a 2020 2020 636f 6e73 7420 696e 7433  ;.    const int3
+00065d20: 325f 7420 6430 203d 2028 2863 6f6e 7374  2_t d0 = ((const
+00065d30: 2069 6e74 3332 5f74 2a29 286f 7074 302d   int32_t*)(opt0-
+00065d40: 3e64 6174 6129 295b 345d 3b0a 2020 2020  >data))[4];.    
+00065d50: 636f 6e73 7420 696e 7433 325f 7420 6431  const int32_t d1
+00065d60: 203d 2028 2863 6f6e 7374 2069 6e74 3332   = ((const int32
+00065d70: 5f74 2a29 286f 7074 302d 3e64 6174 6129  _t*)(opt0->data)
+00065d80: 295b 355d 3b0a 0a20 2020 2047 474d 4c5f  )[5];..    GGML_
+00065d90: 4153 5345 5254 286e 6230 3020 3d3d 2073  ASSERT(nb00 == s
+00065da0: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
+00065db0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+00065dc0: 5345 5254 286e 6231 3020 3d3d 2073 697a  SERT(nb10 == siz
+00065dd0: 656f 6628 666c 6f61 7429 293b 0a0a 2020  eof(float));..  
+00065de0: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00065df0: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00065e00: 494e 4954 2920 7b0a 2020 2020 2020 2020  INIT) {.        
+00065e10: 6d65 6d73 6574 2870 6172 616d 732d 3e77  memset(params->w
+00065e20: 6461 7461 2c20 302c 2070 6172 616d 732d  data, 0, params-
+00065e30: 3e77 7369 7a65 293b 0a0a 2020 2020 2020  >wsize);..      
+00065e40: 2020 2f2f 2070 7265 7061 7265 2073 6f75    // prepare sou
+00065e50: 7263 6520 6461 7461 2028 7372 6331 290a  rce data (src1).
+00065e60: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00065e70: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
+00065e80: 7420 2a20 636f 6e73 7420 7764 6174 6120  t * const wdata 
+00065e90: 3d20 2867 676d 6c5f 6670 3136 5f74 202a  = (ggml_fp16_t *
+00065ea0: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
+00065eb0: 2b20 303b 0a0a 2020 2020 2020 2020 2020  + 0;..          
+00065ec0: 2020 666f 7220 2869 6e74 2069 3132 203d    for (int i12 =
+00065ed0: 2030 3b20 6931 3220 3c20 6e65 3132 3b20   0; i12 < ne12; 
+00065ee0: 6931 322b 2b29 207b 0a20 2020 2020 2020  i12++) {.       
+00065ef0: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
+00065f00: 6c6f 6174 202a 2063 6f6e 7374 2073 7263  loat * const src
+00065f10: 203d 2028 666c 6f61 7420 2a29 2828 6368   = (float *)((ch
+00065f20: 6172 202a 2920 7372 6331 2d3e 6461 7461  ar *) src1->data
+00065f30: 202b 2069 3132 2a6e 6231 3229 3b0a 2020   + i12*nb12);.  
+00065f40: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00065f50: 6d6c 5f66 7031 365f 7420 2a20 6473 745f  ml_fp16_t * dst_
+00065f60: 6461 7461 203d 2077 6461 7461 3b0a 0a20  data = wdata;.. 
+00065f70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00065f80: 6f72 2028 696e 7420 6931 203d 2030 3b20  or (int i1 = 0; 
+00065f90: 6931 203c 206e 6531 3b20 6931 2b2b 2920  i1 < ne1; i1++) 
+00065fa0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00065fb0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00065fc0: 3020 3d20 303b 2069 3020 3c20 6e65 303b  0 = 0; i0 < ne0;
+00065fd0: 2069 302b 2b29 207b 0a20 2020 2020 2020   i0++) {.       
+00065fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00065ff0: 2066 6f72 2028 696e 7420 696b 3120 3d20   for (int ik1 = 
+00066000: 303b 2069 6b31 203c 206e 6b31 3b20 696b  0; ik1 < nk1; ik
+00066010: 312b 2b29 207b 0a20 2020 2020 2020 2020  1++) {.         
+00066020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066030: 2020 2066 6f72 2028 696e 7420 696b 3020     for (int ik0 
+00066040: 3d20 303b 2069 6b30 203c 206e 6b30 3b20  = 0; ik0 < nk0; 
+00066050: 696b 302b 2b29 207b 0a20 2020 2020 2020  ik0++) {.       
+00066060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066070: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00066080: 6e74 2069 6478 3020 3d20 6930 2a73 3020  nt idx0 = i0*s0 
+00066090: 2b20 696b 302a 6430 202d 2070 303b 0a20  + ik0*d0 - p0;. 
+000660a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000660b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000660c0: 6f6e 7374 2069 6e74 2069 6478 3120 3d20  onst int idx1 = 
+000660d0: 6931 2a73 3120 2b20 696b 312a 6431 202d  i1*s1 + ik1*d1 -
+000660e0: 2070 313b 0a0a 2020 2020 2020 2020 2020   p1;..          
+000660f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066100: 2020 2020 2020 6966 2028 2128 6964 7831        if (!(idx1
+00066110: 203c 2030 207c 7c20 6964 7831 203e 3d20   < 0 || idx1 >= 
+00066120: 6e65 3131 207c 7c20 6964 7830 203c 2030  ne11 || idx0 < 0
+00066130: 207c 7c20 6964 7830 203e 3d20 6e65 3130   || idx0 >= ne10
+00066140: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
 00066150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066160: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
-00066170: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
-00066180: 7220 2a29 2073 7263 302d 3e64 6174 6120  r *) src0->data 
-00066190: 2b20 6932 2a6e 6230 3329 2c0a 2020 2020  + i2*nb03),.    
-000661a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000661b0: 2020 2020 2020 2020 2867 676d 6c5f 6670          (ggml_fp
-000661c0: 3136 5f74 202a 2920 2020 2020 2020 2020  16_t *)         
-000661d0: 2020 2020 2020 2077 6461 7461 202b 2069         wdata + i
-000661e0: 332a 6e62 3320 2b20 2869 312a 6e65 3020  3*nb3 + (i1*ne0 
-000661f0: 2b20 6930 292a 6577 3029 3b0a 2020 2020  + i0)*ew0);.    
-00066200: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00066210: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00066220: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-00066230: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00066240: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00066250: 636f 6e76 5f32 645f 736b 5f70 3028 0a20  conv_2d_sk_p0(. 
-00066260: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00066270: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-00066280: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
-00066290: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-000662a0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000662b0: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
-000662c0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000662d0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
-000662e0: 6331 2c0a 2020 2020 2020 2020 7374 7275  c1,.        stru
-000662f0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00066300: 2064 7374 2920 7b0a 2020 2020 7377 6974   dst) {.    swit
-00066310: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00066320: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00066330: 474d 4c5f 5459 5045 5f46 3136 3a0a 2020  GML_TYPE_F16:.  
-00066340: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00066350: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00066360: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00066370: 5f63 6f6e 765f 3264 5f73 6b5f 7030 5f66  _conv_2d_sk_p0_f
-00066380: 3136 5f66 3332 2870 6172 616d 732c 2073  16_f32(params, s
-00066390: 7263 302c 2073 7263 312c 2064 7374 293b  rc0, src1, dst);
-000663a0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000663b0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-000663c0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
-000663d0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000663e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000663f0: 2f2f 6767 6d6c 5f63 6f6d 7075 7465 5f66  //ggml_compute_f
-00066400: 6f72 7761 7264 5f63 6f6e 765f 3264 5f73  orward_conv_2d_s
-00066410: 6b5f 7030 5f66 3332 2870 6172 616d 732c  k_p0_f32(params,
-00066420: 2073 7263 302c 2073 7263 312c 2064 7374   src0, src1, dst
-00066430: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00066440: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00066450: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-00066460: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00066470: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-00066480: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00066490: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000664a0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-000664b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000664c0: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-000664d0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000664e0: 7761 7264 5f63 6f6e 765f 3264 0a0a 7374  ward_conv_2d..st
-000664f0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00066500: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00066510: 6f6e 765f 3264 280a 2020 2020 636f 6e73  onv_2d(.    cons
-00066520: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00066530: 6d70 7574 655f 7061 7261 6d73 2a20 7061  mpute_params* pa
-00066540: 7261 6d73 2c0a 2020 2020 636f 6e73 7420  rams,.    const 
-00066550: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00066560: 6f72 2a20 7372 6330 2c0a 2020 2020 636f  or* src0,.    co
-00066570: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00066580: 7465 6e73 6f72 2a20 7372 6331 2c0a 2020  tensor* src1,.  
-00066590: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000665a0: 676d 6c5f 7465 6e73 6f72 2a20 6f70 7430  gml_tensor* opt0
-000665b0: 2c0a 2020 2020 7374 7275 6374 2067 676d  ,.    struct ggm
-000665c0: 6c5f 7465 6e73 6f72 2a20 6473 7429 207b  l_tensor* dst) {
-000665d0: 0a20 2020 2063 6f6e 7374 2069 6e74 3332  .    const int32
-000665e0: 5f74 2073 3020 3d20 2828 636f 6e73 7420  _t s0 = ((const 
-000665f0: 696e 7433 325f 742a 2928 6f70 7430 2d3e  int32_t*)(opt0->
-00066600: 6461 7461 2929 5b30 5d3b 0a20 2020 2063  data))[0];.    c
-00066610: 6f6e 7374 2069 6e74 3332 5f74 2073 3120  onst int32_t s1 
-00066620: 3d20 2828 636f 6e73 7420 696e 7433 325f  = ((const int32_
-00066630: 742a 2928 6f70 7430 2d3e 6461 7461 2929  t*)(opt0->data))
-00066640: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
-00066650: 6e74 3332 5f74 2070 3020 3d20 2828 636f  nt32_t p0 = ((co
-00066660: 6e73 7420 696e 7433 325f 742a 2928 6f70  nst int32_t*)(op
-00066670: 7430 2d3e 6461 7461 2929 5b32 5d3b 0a20  t0->data))[2];. 
-00066680: 2020 2063 6f6e 7374 2069 6e74 3332 5f74     const int32_t
-00066690: 2070 3120 3d20 2828 636f 6e73 7420 696e   p1 = ((const in
-000666a0: 7433 325f 742a 2928 6f70 7430 2d3e 6461  t32_t*)(opt0->da
-000666b0: 7461 2929 5b33 5d3b 0a20 2020 2063 6f6e  ta))[3];.    con
-000666c0: 7374 2069 6e74 3332 5f74 2064 3020 3d20  st int32_t d0 = 
-000666d0: 2828 636f 6e73 7420 696e 7433 325f 742a  ((const int32_t*
-000666e0: 2928 6f70 7430 2d3e 6461 7461 2929 5b34  )(opt0->data))[4
-000666f0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00066700: 3332 5f74 2064 3120 3d20 2828 636f 6e73  32_t d1 = ((cons
-00066710: 7420 696e 7433 325f 742a 2928 6f70 7430  t int32_t*)(opt0
-00066720: 2d3e 6461 7461 2929 5b35 5d3b 0a20 2020  ->data))[5];.   
-00066730: 2047 474d 4c5f 4153 5345 5254 2864 3020   GGML_ASSERT(d0 
-00066740: 3d3d 2031 293b 202f 2f20 6469 6c61 7469  == 1); // dilati
-00066750: 6f6e 206e 6f74 2073 7570 706f 7274 6564  on not supported
-00066760: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00066770: 2864 3120 3d3d 2031 293b 0a20 2020 2047  (d1 == 1);.    G
-00066780: 474d 4c5f 4153 5345 5254 2870 3020 3d3d  GML_ASSERT(p0 ==
-00066790: 2030 293b 202f 2f20 7061 6464 696e 6720   0); // padding 
-000667a0: 6e6f 7420 7375 7070 6f72 7465 640a 2020  not supported.  
-000667b0: 2020 4747 4d4c 5f41 5353 4552 5428 7031    GGML_ASSERT(p1
-000667c0: 203d 3d20 3029 3b0a 0a20 2020 2069 6620   == 0);..    if 
-000667d0: 2873 3020 3d3d 2073 7263 302d 3e6e 655b  (s0 == src0->ne[
-000667e0: 305d 2026 2620 7331 203d 3d20 7372 6330  0] && s1 == src0
-000667f0: 2d3e 6e65 5b31 5d29 207b 0a20 2020 2020  ->ne[1]) {.     
-00066800: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00066810: 666f 7277 6172 645f 636f 6e76 5f32 645f  forward_conv_2d_
-00066820: 736b 5f70 3028 7061 7261 6d73 2c20 7372  sk_p0(params, sr
-00066830: 6330 2c20 7372 6331 2c20 6473 7429 3b0a  c0, src1, dst);.
-00066840: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-00066850: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00066860: 2866 616c 7365 293b 202f 2f20 6f6e 6c79  (false); // only
-00066870: 2073 7472 6964 6520 6571 7561 6c20 746f   stride equal to
-00066880: 206b 6572 6e65 6c20 7369 7a65 2069 7320   kernel size is 
-00066890: 7375 7070 6f72 7465 640a 2020 2020 7d0a  supported.    }.
-000668a0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-000668b0: 7465 5f66 6f72 7761 7264 5f70 6f6f 6c5f  te_forward_pool_
-000668c0: 3164 5f73 6b5f 7030 0a0a 7374 6174 6963  1d_sk_p0..static
-000668d0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-000668e0: 7465 5f66 6f72 7761 7264 5f70 6f6f 6c5f  te_forward_pool_
-000668f0: 3164 5f73 6b5f 7030 280a 2020 2020 2020  1d_sk_p0(.      
-00066900: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00066910: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00066920: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00066930: 2020 2020 2063 6f6e 7374 2065 6e75 6d20       const enum 
-00066940: 6767 6d6c 5f6f 705f 706f 6f6c 206f 702c  ggml_op_pool op,
-00066950: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00066960: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00066970: 7220 2a20 7372 632c 0a20 2020 2020 2020  r * src,.       
-00066980: 2063 6f6e 7374 2069 6e74 206b 2c0a 2020   const int k,.  
-00066990: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-000669a0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-000669b0: 7b0a 2020 2020 6173 7365 7274 2873 7263  {.    assert(src
-000669c0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-000669d0: 5950 455f 4633 3229 3b0a 2020 2020 6173  YPE_F32);.    as
-000669e0: 7365 7274 2870 6172 616d 732d 3e69 7468  sert(params->ith
-000669f0: 203d 3d20 3029 3b0a 0a20 2020 2069 6620   == 0);..    if 
-00066a00: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00066a10: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00066a20: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00066a30: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00066a40: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00066a50: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00066a60: 2020 2020 636f 6e73 7420 6368 6172 202a      const char *
-00066a70: 2063 6461 7461 203d 2028 636f 6e73 7420   cdata = (const 
-00066a80: 6368 6172 202a 2973 7263 2d3e 6461 7461  char *)src->data
-00066a90: 3b0a 2020 2020 636f 6e73 7420 6368 6172  ;.    const char
-00066aa0: 202a 2063 6f6e 7374 2064 6174 615f 656e   * const data_en
-00066ab0: 6420 3d20 6364 6174 6120 2b20 6767 6d6c  d = cdata + ggml
-00066ac0: 5f6e 6279 7465 7328 7372 6329 3b0a 2020  _nbytes(src);.  
-00066ad0: 2020 666c 6f61 7420 2a20 6472 6f77 203d    float * drow =
-00066ae0: 2028 666c 6f61 7420 2a29 6473 742d 3e64   (float *)dst->d
-00066af0: 6174 613b 0a0a 2020 2020 636f 6e73 7420  ata;..    const 
-00066b00: 696e 7436 345f 7420 7273 203d 2064 7374  int64_t rs = dst
-00066b10: 2d3e 6e65 5b30 5d3b 0a0a 2020 2020 7768  ->ne[0];..    wh
-00066b20: 696c 6520 2863 6461 7461 203c 2064 6174  ile (cdata < dat
-00066b30: 615f 656e 6429 207b 0a20 2020 2020 2020  a_end) {.       
-00066b40: 2063 6f6e 7374 2066 6c6f 6174 202a 2063   const float * c
-00066b50: 6f6e 7374 2073 726f 7720 3d20 2863 6f6e  onst srow = (con
-00066b60: 7374 2066 6c6f 6174 202a 2963 6461 7461  st float *)cdata
-00066b70: 3b0a 0a20 2020 2020 2020 2069 6e74 206a  ;..        int j
-00066b80: 203d 2030 3b0a 0a20 2020 2020 2020 2066   = 0;..        f
-00066b90: 6f72 2028 696e 7436 345f 7420 6920 3d20  or (int64_t i = 
-00066ba0: 303b 2069 203c 2072 733b 202b 2b69 2920  0; i < rs; ++i) 
-00066bb0: 7b0a 2020 2020 2020 2020 2020 2020 7377  {.            sw
-00066bc0: 6974 6368 2028 6f70 2920 7b0a 2020 2020  itch (op) {.    
-00066bd0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00066be0: 2047 474d 4c5f 4f50 5f50 4f4f 4c5f 4156   GGML_OP_POOL_AV
-00066bf0: 473a 2020 2064 726f 775b 695d 203d 2030  G:   drow[i] = 0
-00066c00: 3b20 2020 2020 2020 2062 7265 616b 3b0a  ;        break;.
-00066c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066c20: 6361 7365 2047 474d 4c5f 4f50 5f50 4f4f  case GGML_OP_POO
-00066c30: 4c5f 4d41 583a 2020 2064 726f 775b 695d  L_MAX:   drow[i]
-00066c40: 203d 202d 464c 545f 4d41 583b 2062 7265   = -FLT_MAX; bre
-00066c50: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
-00066c60: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00066c70: 5f50 4f4f 4c5f 434f 554e 543a 2047 474d  _POOL_COUNT: GGM
-00066c80: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-00066c90: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00066ca0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00066cb0: 2020 666f 7220 2869 6e74 206b 6920 3d20    for (int ki = 
-00066cc0: 303b 206b 6920 3c20 6b3b 202b 2b6b 6929  0; ki < k; ++ki)
-00066cd0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00066ce0: 2020 2073 7769 7463 6820 286f 7029 207b     switch (op) {
-00066cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00066d00: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00066d10: 505f 504f 4f4c 5f41 5647 3a20 2020 2020  P_POOL_AVG:     
-00066d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066d30: 2020 2020 2064 726f 775b 695d 202b 3d20       drow[i] += 
-00066d40: 7372 6f77 5b6a 5d3b 2062 7265 616b 3b0a  srow[j]; break;.
-00066d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066d60: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00066d70: 5f50 4f4f 4c5f 4d41 583a 2020 2069 6620  _POOL_MAX:   if 
-00066d80: 2873 726f 775b 6a5d 203e 2064 726f 775b  (srow[j] > drow[
-00066d90: 695d 2920 6472 6f77 5b69 5d20 203d 2073  i]) drow[i]  = s
-00066da0: 726f 775b 6a5d 3b20 6272 6561 6b3b 0a20  row[j]; break;. 
-00066db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066dc0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00066dd0: 504f 4f4c 5f43 4f55 4e54 3a20 2020 2020  POOL_COUNT:     
-00066de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066df0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00066e00: 616c 7365 293b 2062 7265 616b 3b0a 2020  alse); break;.  
-00066e10: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00066e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00066e30: 2b2b 6a3b 0a20 2020 2020 2020 2020 2020  ++j;.           
-00066e40: 207d 0a20 2020 2020 2020 2020 2020 2073   }.            s
-00066e50: 7769 7463 6820 286f 7029 207b 0a20 2020  witch (op) {.   
-00066e60: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-00066e70: 6520 4747 4d4c 5f4f 505f 504f 4f4c 5f41  e GGML_OP_POOL_A
-00066e80: 5647 3a20 2020 2020 2020 2020 6472 6f77  VG:         drow
-00066e90: 5b69 5d20 2f3d 206b 3b20 6272 6561 6b3b  [i] /= k; break;
-00066ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00066eb0: 2063 6173 6520 4747 4d4c 5f4f 505f 504f   case GGML_OP_PO
-00066ec0: 4f4c 5f4d 4158 3a20 2020 2020 2020 2020  OL_MAX:         
-00066ed0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00066ee0: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-00066ef0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00066f00: 505f 504f 4f4c 5f43 4f55 4e54 3a20 4747  P_POOL_COUNT: GG
-00066f10: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00066f20: 3b20 6272 6561 6b3b 0a20 2020 2020 2020  ; break;.       
-00066f30: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
-00066f40: 0a0a 2020 2020 2020 2020 6364 6174 6120  ..        cdata 
-00066f50: 2b3d 2073 7263 2d3e 6e62 5b31 5d3b 0a20  += src->nb[1];. 
-00066f60: 2020 2020 2020 2064 726f 7720 202b 3d20         drow  += 
-00066f70: 7273 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  rs;.    }.}..// 
-00066f80: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00066f90: 7761 7264 5f70 6f6f 6c5f 3164 0a0a 7374  ward_pool_1d..st
-00066fa0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00066fb0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f70  ompute_forward_p
-00066fc0: 6f6f 6c5f 3164 280a 2020 2020 636f 6e73  ool_1d(.    cons
-00066fd0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00066fe0: 6d70 7574 655f 7061 7261 6d73 2a20 7061  mpute_params* pa
-00066ff0: 7261 6d73 2c0a 2020 2020 636f 6e73 7420  rams,.    const 
-00067000: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00067010: 6f72 2a20 7372 6330 2c0a 2020 2020 636f  or* src0,.    co
-00067020: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00067030: 7465 6e73 6f72 2a20 6f70 7430 2c0a 2020  tensor* opt0,.  
-00067040: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00067050: 6e73 6f72 2a20 6473 7429 207b 0a20 2020  nsor* dst) {.   
-00067060: 2047 474d 4c5f 4153 5345 5254 286f 7074   GGML_ASSERT(opt
-00067070: 302d 3e6e 655b 305d 203d 3d20 3429 3b0a  0->ne[0] == 4);.
-00067080: 2020 2020 636f 6e73 7420 696e 742a 206f      const int* o
-00067090: 7074 7320 3d20 2863 6f6e 7374 2069 6e74  pts = (const int
-000670a0: 2a29 6f70 7430 2d3e 6461 7461 3b0a 2020  *)opt0->data;.  
-000670b0: 2020 656e 756d 2067 676d 6c5f 6f70 5f70    enum ggml_op_p
-000670c0: 6f6f 6c20 6f70 203d 206f 7074 735b 305d  ool op = opts[0]
-000670d0: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-000670e0: 6b30 203d 206f 7074 735b 315d 3b0a 2020  k0 = opts[1];.  
-000670f0: 2020 636f 6e73 7420 696e 7420 7330 203d    const int s0 =
-00067100: 206f 7074 735b 325d 3b0a 2020 2020 636f   opts[2];.    co
-00067110: 6e73 7420 696e 7420 7030 203d 206f 7074  nst int p0 = opt
-00067120: 735b 335d 3b0a 2020 2020 4747 4d4c 5f41  s[3];.    GGML_A
-00067130: 5353 4552 5428 7030 203d 3d20 3029 3b20  SSERT(p0 == 0); 
-00067140: 2f2f 2070 6164 6469 6e67 206e 6f74 2073  // padding not s
-00067150: 7570 706f 7274 6564 0a20 2020 2047 474d  upported.    GGM
-00067160: 4c5f 4153 5345 5254 286b 3020 3d3d 2073  L_ASSERT(k0 == s
-00067170: 3029 3b20 2f2f 206f 6e6c 7920 7320 3d20  0); // only s = 
-00067180: 6b20 7375 7070 6f72 7465 640a 0a20 2020  k supported..   
-00067190: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-000671a0: 7277 6172 645f 706f 6f6c 5f31 645f 736b  rward_pool_1d_sk
-000671b0: 5f70 3028 7061 7261 6d73 2c20 6f70 2c20  _p0(params, op, 
-000671c0: 7372 6330 2c20 6b30 2c20 6473 7429 3b0a  src0, k0, dst);.
-000671d0: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-000671e0: 7465 5f66 6f72 7761 7264 5f70 6f6f 6c5f  te_forward_pool_
-000671f0: 3264 5f73 6b5f 7030 0a0a 7374 6174 6963  2d_sk_p0..static
-00067200: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00067210: 7465 5f66 6f72 7761 7264 5f70 6f6f 6c5f  te_forward_pool_
-00067220: 3264 5f73 6b5f 7030 280a 2020 2020 636f  2d_sk_p0(.    co
-00067230: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00067240: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-00067250: 2070 6172 616d 732c 0a20 2020 2063 6f6e   params,.    con
-00067260: 7374 2065 6e75 6d20 6767 6d6c 5f6f 705f  st enum ggml_op_
-00067270: 706f 6f6c 206f 702c 0a20 2020 2063 6f6e  pool op,.    con
-00067280: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00067290: 656e 736f 7220 2a20 7372 632c 0a20 2020  ensor * src,.   
-000672a0: 2063 6f6e 7374 2069 6e74 206b 302c 0a20   const int k0,. 
-000672b0: 2020 2063 6f6e 7374 2069 6e74 206b 312c     const int k1,
-000672c0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
-000672d0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
-000672e0: 0a20 2020 2061 7373 6572 7428 7372 632d  .    assert(src-
-000672f0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00067300: 5045 5f46 3332 293b 0a20 2020 2061 7373  PE_F32);.    ass
-00067310: 6572 7428 7061 7261 6d73 2d3e 6974 6820  ert(params->ith 
-00067320: 3d3d 2030 293b 0a0a 2020 2020 6966 2028  == 0);..    if (
-00067330: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00067340: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-00067350: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-00067360: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00067370: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00067380: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00067390: 2020 2063 6f6e 7374 2063 6861 7220 2a20     const char * 
-000673a0: 6364 6174 6120 3d20 2863 6f6e 7374 2063  cdata = (const c
-000673b0: 6861 722a 2973 7263 2d3e 6461 7461 3b0a  har*)src->data;.
-000673c0: 2020 2020 636f 6e73 7420 6368 6172 202a      const char *
-000673d0: 2063 6f6e 7374 2064 6174 615f 656e 6420   const data_end 
-000673e0: 3d20 6364 6174 6120 2b20 6767 6d6c 5f6e  = cdata + ggml_n
-000673f0: 6279 7465 7328 7372 6329 3b0a 0a20 2020  bytes(src);..   
-00067400: 2063 6f6e 7374 2069 6e74 3634 5f74 2070   const int64_t p
-00067410: 7820 3d20 6473 742d 3e6e 655b 305d 3b0a  x = dst->ne[0];.
-00067420: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-00067430: 7420 7079 203d 2064 7374 2d3e 6e65 5b31  t py = dst->ne[1
-00067440: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00067450: 3634 5f74 2070 6120 3d20 7078 202a 2070  64_t pa = px * p
-00067460: 793b 0a0a 2020 2020 666c 6f61 7420 2a20  y;..    float * 
-00067470: 6470 6c61 6e65 203d 2028 666c 6f61 7420  dplane = (float 
-00067480: 2a29 6473 742d 3e64 6174 613b 0a0a 2020  *)dst->data;..  
-00067490: 2020 636f 6e73 7420 696e 7420 6b61 203d    const int ka =
-000674a0: 206b 3020 2a20 6b31 3b0a 0a20 2020 2077   k0 * k1;..    w
-000674b0: 6869 6c65 2028 6364 6174 6120 3c20 6461  hile (cdata < da
-000674c0: 7461 5f65 6e64 2920 7b0a 2020 2020 2020  ta_end) {.      
-000674d0: 2020 666f 7220 2869 6e74 206f 7920 3d20    for (int oy = 
-000674e0: 303b 206f 7920 3c20 7079 3b20 2b2b 6f79  0; oy < py; ++oy
-000674f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00067500: 666c 6f61 7420 2a20 636f 6e73 7420 6472  float * const dr
-00067510: 6f77 203d 2064 706c 616e 6520 2b20 6f79  ow = dplane + oy
-00067520: 202a 2070 783b 0a20 2020 2020 2020 2020   * px;.         
-00067530: 2020 2066 6f72 2028 696e 7420 6f78 203d     for (int ox =
-00067540: 2030 3b20 6f78 203c 2070 783b 202b 2b6f   0; ox < px; ++o
-00067550: 7829 207b 0a20 2020 2020 2020 2020 2020  x) {.           
-00067560: 2020 2020 2066 6c6f 6174 202a 2063 6f6e       float * con
-00067570: 7374 206f 7574 203d 2020 6472 6f77 202b  st out =  drow +
-00067580: 206f 783b 0a20 2020 2020 2020 2020 2020   ox;.           
-00067590: 2020 2020 2073 7769 7463 6820 286f 7029       switch (op)
-000675a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000675b0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-000675c0: 5f4f 505f 504f 4f4c 5f41 5647 3a20 2020  _OP_POOL_AVG:   
-000675d0: 2020 2a6f 7574 203d 2030 3b20 2020 2020    *out = 0;     
-000675e0: 2020 2062 7265 616b 3b0a 2020 2020 2020     break;.      
-000675f0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00067600: 7365 2047 474d 4c5f 4f50 5f50 4f4f 4c5f  se GGML_OP_POOL_
-00067610: 4d41 583a 2020 2020 202a 6f75 7420 3d20  MAX:     *out = 
-00067620: 2d46 4c54 5f4d 4158 3b20 6272 6561 6b3b  -FLT_MAX; break;
-00067630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067640: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00067650: 505f 504f 4f4c 5f43 4f55 4e54 3a20 4747  P_POOL_COUNT: GG
-00067660: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00067670: 3b20 6272 6561 6b3b 0a20 2020 2020 2020  ; break;.       
-00067680: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00067690: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000676a0: 7420 696e 7420 6978 203d 206f 7820 2a20  t int ix = ox * 
-000676b0: 6b30 3b0a 2020 2020 2020 2020 2020 2020  k0;.            
-000676c0: 2020 2020 636f 6e73 7420 696e 7420 6979      const int iy
-000676d0: 203d 206f 7920 2a20 6b31 3b0a 0a20 2020   = oy * k1;..   
-000676e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000676f0: 2028 696e 7420 6b79 203d 2030 3b20 6b79   (int ky = 0; ky
-00067700: 203c 206b 313b 202b 2b6b 7929 207b 0a20   < k1; ++ky) {. 
-00067710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067720: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
-00067730: 2063 6f6e 7374 2073 726f 7720 3d20 2863   const srow = (c
-00067740: 6f6e 7374 2066 6c6f 6174 202a 2928 6364  onst float *)(cd
-00067750: 6174 6120 2b20 7372 632d 3e6e 625b 315d  ata + src->nb[1]
-00067760: 202a 2028 6979 202b 206b 7929 293b 0a20   * (iy + ky));. 
-00067770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067780: 2020 2066 6f72 2028 696e 7420 6b78 203d     for (int kx =
-00067790: 2030 3b20 6b78 203c 206b 303b 202b 2b6b   0; kx < k0; ++k
-000677a0: 7829 207b 0a20 2020 2020 2020 2020 2020  x) {.           
-000677b0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-000677c0: 206a 203d 2069 7820 2b20 6b78 3b0a 2020   j = ix + kx;.  
-000677d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000677e0: 2020 2020 2020 7377 6974 6368 2028 6f70        switch (op
-000677f0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00067800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00067810: 6361 7365 2047 474d 4c5f 4f50 5f50 4f4f  case GGML_OP_POO
-00067820: 4c5f 4156 473a 2020 2020 2020 2020 2020  L_AVG:          
-00067830: 2020 2020 2020 2020 2020 202a 6f75 7420             *out 
-00067840: 2b3d 2073 726f 775b 6a5d 3b20 6272 6561  += srow[j]; brea
-00067850: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00067860: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00067870: 6173 6520 4747 4d4c 5f4f 505f 504f 4f4c  ase GGML_OP_POOL
-00067880: 5f4d 4158 3a20 6966 2028 7372 6f77 5b6a  _MAX: if (srow[j
-00067890: 5d20 3e20 2a6f 7574 2920 2a6f 7574 2020  ] > *out) *out  
-000678a0: 3d20 7372 6f77 5b6a 5d3b 2062 7265 616b  = srow[j]; break
-000678b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000678c0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-000678d0: 7365 2047 474d 4c5f 4f50 5f50 4f4f 4c5f  se GGML_OP_POOL_
-000678e0: 434f 554e 543a 2020 2020 2020 2020 2020  COUNT:          
-000678f0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-00067900: 5428 6661 6c73 6529 3b20 6272 6561 6b3b  T(false); break;
-00067910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067920: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00067930: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00067940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067950: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
-00067960: 2020 2073 7769 7463 6820 286f 7029 207b     switch (op) {
-00067970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067980: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00067990: 505f 504f 4f4c 5f41 5647 3a20 2020 2020  P_POOL_AVG:     
-000679a0: 2020 2020 2020 2a6f 7574 202f 3d20 6b61        *out /= ka
-000679b0: 3b20 6272 6561 6b3b 0a20 2020 2020 2020  ; break;.       
-000679c0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-000679d0: 6520 4747 4d4c 5f4f 505f 504f 4f4c 5f4d  e GGML_OP_POOL_M
-000679e0: 4158 3a20 2020 2020 2020 2020 2020 2020  AX:             
-000679f0: 2020 2020 2020 2020 2020 6272 6561 6b3b            break;
-00067a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00067a10: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00067a20: 505f 504f 4f4c 5f43 4f55 4e54 3a20 4747  P_POOL_COUNT: GG
-00067a30: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00067a40: 3b20 6272 6561 6b3b 0a20 2020 2020 2020  ; break;.       
-00067a50: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00067a60: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00067a70: 207d 0a0a 2020 2020 2020 2020 6364 6174   }..        cdat
-00067a80: 6120 202b 3d20 7372 632d 3e6e 625b 325d  a  += src->nb[2]
-00067a90: 3b0a 2020 2020 2020 2020 6470 6c61 6e65  ;.        dplane
-00067aa0: 202b 3d20 7061 3b0a 2020 2020 7d0a 7d0a   += pa;.    }.}.
-00067ab0: 0a2f 2f20 6767 6d6c 5f63 6f6d 7075 7465  .// ggml_compute
-00067ac0: 5f66 6f72 7761 7264 5f70 6f6f 6c5f 3264  _forward_pool_2d
-00067ad0: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00067ae0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00067af0: 7264 5f70 6f6f 6c5f 3264 280a 2020 2020  rd_pool_2d(.    
-00067b00: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00067b10: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-00067b20: 202a 2070 6172 616d 732c 0a20 2020 2063   * params,.    c
-00067b30: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00067b40: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00067b50: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00067b60: 2067 676d 6c5f 7465 6e73 6f72 202a 206f   ggml_tensor * o
-00067b70: 7074 302c 0a20 2020 2073 7472 7563 7420  pt0,.    struct 
-00067b80: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00067b90: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
-00067ba0: 5345 5254 286f 7074 302d 3e6e 655b 305d  SERT(opt0->ne[0]
-00067bb0: 203d 3d20 3729 3b0a 2020 2020 636f 6e73   == 7);.    cons
-00067bc0: 7420 696e 742a 206f 7074 7320 3d20 2863  t int* opts = (c
-00067bd0: 6f6e 7374 2069 6e74 2a29 6f70 7430 2d3e  onst int*)opt0->
-00067be0: 6461 7461 3b0a 2020 2020 656e 756d 2067  data;.    enum g
-00067bf0: 676d 6c5f 6f70 5f70 6f6f 6c20 6f70 203d  gml_op_pool op =
-00067c00: 206f 7074 735b 305d 3b0a 2020 2020 636f   opts[0];.    co
-00067c10: 6e73 7420 696e 7420 6b30 203d 206f 7074  nst int k0 = opt
-00067c20: 735b 315d 3b0a 2020 2020 636f 6e73 7420  s[1];.    const 
-00067c30: 696e 7420 6b31 203d 206f 7074 735b 325d  int k1 = opts[2]
-00067c40: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00067c50: 7330 203d 206f 7074 735b 335d 3b0a 2020  s0 = opts[3];.  
-00067c60: 2020 636f 6e73 7420 696e 7420 7331 203d    const int s1 =
-00067c70: 206f 7074 735b 345d 3b0a 2020 2020 636f   opts[4];.    co
-00067c80: 6e73 7420 696e 7420 7030 203d 206f 7074  nst int p0 = opt
-00067c90: 735b 355d 3b0a 2020 2020 636f 6e73 7420  s[5];.    const 
-00067ca0: 696e 7420 7031 203d 206f 7074 735b 365d  int p1 = opts[6]
-00067cb0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-00067cc0: 5428 7030 203d 3d20 3029 3b0a 2020 2020  T(p0 == 0);.    
-00067cd0: 4747 4d4c 5f41 5353 4552 5428 7031 203d  GGML_ASSERT(p1 =
-00067ce0: 3d20 3029 3b20 2f2f 2070 6164 6469 6e67  = 0); // padding
-00067cf0: 206e 6f74 2073 7570 706f 7274 6564 0a20   not supported. 
-00067d00: 2020 2047 474d 4c5f 4153 5345 5254 286b     GGML_ASSERT(k
-00067d10: 3020 3d3d 2073 3029 3b0a 2020 2020 4747  0 == s0);.    GG
-00067d20: 4d4c 5f41 5353 4552 5428 6b31 203d 3d20  ML_ASSERT(k1 == 
-00067d30: 7331 293b 202f 2f20 6f6e 6c79 2073 203d  s1); // only s =
-00067d40: 206b 2073 7570 706f 7274 6564 0a0a 2020   k supported..  
-00067d50: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00067d60: 6f72 7761 7264 5f70 6f6f 6c5f 3264 5f73  orward_pool_2d_s
-00067d70: 6b5f 7030 2870 6172 616d 732c 206f 702c  k_p0(params, op,
-00067d80: 2073 7263 302c 206b 302c 206b 312c 2064   src0, k0, k1, d
-00067d90: 7374 293b 0a7d 0a0a 0a2f 2f20 6767 6d6c  st);.}...// ggml
-00067da0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00067db0: 5f66 6c61 7368 5f61 7474 6e0a 0a73 7461  _flash_attn..sta
-00067dc0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00067dd0: 6d70 7574 655f 666f 7277 6172 645f 666c  mpute_forward_fl
-00067de0: 6173 685f 6174 746e 5f66 3332 280a 2020  ash_attn_f32(.  
-00067df0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00067e00: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00067e10: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00067e20: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00067e30: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00067e40: 7220 2a20 712c 0a20 2020 2020 2020 2063  r * q,.        c
-00067e50: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00067e60: 5f74 656e 736f 7220 2a20 6b2c 0a20 2020  _tensor * k,.   
-00067e70: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00067e80: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00067e90: 762c 0a20 2020 2020 2020 2063 6f6e 7374  v,.        const
-00067ea0: 2062 6f6f 6c20 6d61 736b 6564 2c0a 2020   bool masked,.  
-00067eb0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00067ec0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00067ed0: 6473 7429 207b 0a20 2020 2069 6e74 3634  dst) {.    int64
-00067ee0: 5f74 2074 3020 3d20 6767 6d6c 5f70 6572  _t t0 = ggml_per
-00067ef0: 665f 7469 6d65 5f75 7328 293b 0a20 2020  f_time_us();.   
-00067f00: 2055 4e55 5345 4428 7430 293b 0a0a 2020   UNUSED(t0);..  
-00067f10: 2020 4747 4d4c 5f54 454e 534f 525f 4c4f    GGML_TENSOR_LO
-00067f20: 4341 4c53 2869 6e74 3634 5f74 2c20 6e65  CALS(int64_t, ne
-00067f30: 712c 2071 2c20 2020 6e65 293b 0a20 2020  q, q,   ne);.   
-00067f40: 2047 474d 4c5f 5445 4e53 4f52 5f4c 4f43   GGML_TENSOR_LOC
-00067f50: 414c 5328 7369 7a65 5f74 2c20 206e 6271  ALS(size_t,  nbq
-00067f60: 2c20 712c 2020 206e 6229 3b0a 2020 2020  , q,   nb);.    
-00067f70: 4747 4d4c 5f54 454e 534f 525f 4c4f 4341  GGML_TENSOR_LOCA
-00067f80: 4c53 2869 6e74 3634 5f74 2c20 6e65 6b2c  LS(int64_t, nek,
-00067f90: 206b 2c20 2020 6e65 293b 0a20 2020 2047   k,   ne);.    G
-00067fa0: 474d 4c5f 5445 4e53 4f52 5f4c 4f43 414c  GML_TENSOR_LOCAL
-00067fb0: 5328 7369 7a65 5f74 2c20 206e 626b 2c20  S(size_t,  nbk, 
-00067fc0: 6b2c 2020 206e 6229 3b0a 2020 2020 4747  k,   nb);.    GG
-00067fd0: 4d4c 5f54 454e 534f 525f 4c4f 4341 4c53  ML_TENSOR_LOCALS
-00067fe0: 2869 6e74 3634 5f74 2c20 6e65 762c 2076  (int64_t, nev, v
-00067ff0: 2c20 2020 6e65 293b 0a20 2020 2047 474d  ,   ne);.    GGM
-00068000: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
-00068010: 7369 7a65 5f74 2c20 206e 6276 2c20 762c  size_t,  nbv, v,
-00068020: 2020 206e 6229 3b0a 2020 2020 4747 4d4c     nb);.    GGML
-00068030: 5f54 454e 534f 525f 4c4f 4341 4c53 2869  _TENSOR_LOCALS(i
-00068040: 6e74 3634 5f74 2c20 6e65 2c20 2064 7374  nt64_t, ne,  dst
-00068050: 2c20 6e65 293b 0a20 2020 2047 474d 4c5f  , ne);.    GGML_
-00068060: 5445 4e53 4f52 5f4c 4f43 414c 5328 7369  TENSOR_LOCALS(si
-00068070: 7a65 5f74 2c20 206e 622c 2020 6473 742c  ze_t,  nb,  dst,
-00068080: 206e 6229 3b0a 0a20 2020 2063 6f6e 7374   nb);..    const
-00068090: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
-000680a0: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
-000680b0: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
-000680c0: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
-000680d0: 6e73 7420 696e 7436 345f 7420 4420 3d20  nst int64_t D = 
-000680e0: 6e65 7130 3b0a 2020 2020 636f 6e73 7420  neq0;.    const 
-000680f0: 696e 7436 345f 7420 4e20 3d20 6e65 7131  int64_t N = neq1
-00068100: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00068110: 345f 7420 5020 3d20 6e65 6b31 202d 204e  4_t P = nek1 - N
-00068120: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00068130: 345f 7420 4d20 3d20 5020 2b20 4e3b 0a0a  4_t M = P + N;..
-00068140: 2020 2020 636f 6e73 7420 696e 7420 4d75      const int Mu
-00068150: 7020 3d20 6767 6d6c 5f75 7028 4d2c 2047  p = ggml_up(M, G
-00068160: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-00068170: 4f4c 4c29 3b0a 0a20 2020 2047 474d 4c5f  OLL);..    GGML_
-00068180: 4153 5345 5254 286e 6530 203d 3d20 4429  ASSERT(ne0 == D)
-00068190: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000681a0: 5428 6e65 3120 3d3d 204e 293b 0a20 2020  T(ne1 == N);.   
-000681b0: 2047 474d 4c5f 4153 5345 5254 2850 203e   GGML_ASSERT(P >
-000681c0: 3d20 3029 3b0a 0a20 2020 2047 474d 4c5f  = 0);..    GGML_
-000681d0: 4153 5345 5254 286e 6271 3020 3d3d 2073  ASSERT(nbq0 == s
-000681e0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
-000681f0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-00068200: 626b 3020 3d3d 2073 697a 656f 6628 666c  bk0 == sizeof(fl
-00068210: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
-00068220: 4153 5345 5254 286e 6276 3020 3d3d 2073  ASSERT(nbv0 == s
-00068230: 697a 656f 6628 666c 6f61 7429 293b 0a0a  izeof(float));..
-00068240: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00068250: 6e65 7130 203d 3d20 4429 3b0a 2020 2020  neq0 == D);.    
-00068260: 4747 4d4c 5f41 5353 4552 5428 6e65 6b30  GGML_ASSERT(nek0
-00068270: 203d 3d20 4429 3b0a 2020 2020 4747 4d4c   == D);.    GGML
-00068280: 5f41 5353 4552 5428 6e65 7631 203d 3d20  _ASSERT(nev1 == 
-00068290: 4429 3b0a 0a20 2020 2047 474d 4c5f 4153  D);..    GGML_AS
-000682a0: 5345 5254 286e 6571 3120 3d3d 204e 293b  SERT(neq1 == N);
-000682b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000682c0: 286e 656b 3120 3d3d 204e 202b 2050 293b  (nek1 == N + P);
-000682d0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-000682e0: 286e 6576 3120 3d3d 2044 293b 0a0a 2020  (nev1 == D);..  
-000682f0: 2020 2f2f 2064 7374 2063 616e 6e6f 7420    // dst cannot 
-00068300: 6265 2074 7261 6e73 706f 7365 6420 6f72  be transposed or
-00068310: 2070 6572 6d75 7465 640a 2020 2020 4747   permuted.    GG
-00068320: 4d4c 5f41 5353 4552 5428 6e62 3020 3d3d  ML_ASSERT(nb0 ==
-00068330: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-00068340: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-00068350: 286e 6230 203c 3d20 6e62 3129 3b0a 2020  (nb0 <= nb1);.  
-00068360: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-00068370: 3120 3c3d 206e 6232 293b 0a20 2020 2047  1 <= nb2);.    G
-00068380: 474d 4c5f 4153 5345 5254 286e 6232 203c  GML_ASSERT(nb2 <
-00068390: 3d20 6e62 3329 3b0a 0a20 2020 2069 6620  = nb3);..    if 
-000683a0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-000683b0: 2047 474d 4c5f 5441 534b 5f49 4e49 5429   GGML_TASK_INIT)
-000683c0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
-000683d0: 6e3b 0a20 2020 207d 0a0a 2020 2020 6966  n;.    }..    if
-000683e0: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
-000683f0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00068400: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00068410: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00068420: 2020 202f 2f20 7061 7261 6c6c 656c 697a     // paralleliz
-00068430: 6520 6279 2071 2072 6f77 7320 7573 696e  e by q rows usin
-00068440: 6720 6767 6d6c 5f76 6563 5f64 6f74 5f66  g ggml_vec_dot_f
-00068450: 3332 0a0a 2020 2020 2f2f 2074 6f74 616c  32..    // total
-00068460: 2072 6f77 7320 696e 2071 0a20 2020 2063   rows in q.    c
-00068470: 6f6e 7374 2069 6e74 206e 7220 3d20 6e65  onst int nr = ne
-00068480: 7131 2a6e 6571 322a 6e65 7133 3b0a 0a20  q1*neq2*neq3;.. 
-00068490: 2020 202f 2f20 726f 7773 2070 6572 2074     // rows per t
-000684a0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
-000684b0: 696e 7420 6472 203d 2028 6e72 202b 206e  int dr = (nr + n
-000684c0: 7468 202d 2031 292f 6e74 683b 0a0a 2020  th - 1)/nth;..  
-000684d0: 2020 2f2f 2072 6f77 2072 616e 6765 2066    // row range f
-000684e0: 6f72 2074 6869 7320 7468 7265 6164 0a20  or this thread. 
-000684f0: 2020 2063 6f6e 7374 2069 6e74 2069 7230     const int ir0
-00068500: 203d 2064 722a 6974 683b 0a20 2020 2063   = dr*ith;.    c
-00068510: 6f6e 7374 2069 6e74 2069 7231 203d 204d  onst int ir1 = M
-00068520: 494e 2869 7230 202b 2064 722c 206e 7229  IN(ir0 + dr, nr)
-00068530: 3b0a 0a20 2020 2063 6f6e 7374 2066 6c6f  ;..    const flo
-00068540: 6174 2073 6361 6c65 203d 2031 2e30 662f  at scale = 1.0f/
-00068550: 7371 7274 6628 4429 3b0a 0a20 2020 202f  sqrtf(D);..    /
-00068560: 2f70 7269 6e74 6628 2250 3d25 6420 4e3d  /printf("P=%d N=
-00068570: 2564 2044 3d25 6420 6972 303d 2564 2069  %d D=%d ir0=%d i
-00068580: 7231 3d25 6420 7363 616c 6520 3d20 2566  r1=%d scale = %f
-00068590: 5c6e 222c 2050 2c20 4e2c 2044 2c20 6972  \n", P, N, D, ir
-000685a0: 302c 2069 7231 2c20 7363 616c 6529 3b0a  0, ir1, scale);.
-000685b0: 0a20 2020 2066 6f72 2028 696e 7420 6972  .    for (int ir
-000685c0: 203d 2069 7230 3b20 6972 203c 2069 7231   = ir0; ir < ir1
-000685d0: 3b20 2b2b 6972 2920 7b0a 2020 2020 2020  ; ++ir) {.      
-000685e0: 2020 2f2f 2071 2069 6e64 6963 6573 0a20    // q indices. 
-000685f0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00068600: 2069 7133 203d 2069 722f 286e 6571 322a   iq3 = ir/(neq2*
-00068610: 6e65 7131 293b 0a20 2020 2020 2020 2063  neq1);.        c
-00068620: 6f6e 7374 2069 6e74 2069 7132 203d 2028  onst int iq2 = (
-00068630: 6972 202d 2069 7133 2a6e 6571 322a 6e65  ir - iq3*neq2*ne
-00068640: 7131 292f 6e65 7131 3b0a 2020 2020 2020  q1)/neq1;.      
-00068650: 2020 636f 6e73 7420 696e 7420 6971 3120    const int iq1 
-00068660: 3d20 2869 7220 2d20 6971 332a 6e65 7132  = (ir - iq3*neq2
-00068670: 2a6e 6571 3120 2d20 6971 322a 6e65 7131  *neq1 - iq2*neq1
-00068680: 293b 0a0a 2020 2020 2020 2020 666c 6f61  );..        floa
-00068690: 7420 2a20 5320 3d20 2866 6c6f 6174 202a  t * S = (float *
-000686a0: 2920 7061 7261 6d73 2d3e 7764 6174 6120  ) params->wdata 
-000686b0: 2b20 6974 682a 284d 7570 202b 2043 4143  + ith*(Mup + CAC
-000686c0: 4845 5f4c 494e 455f 5349 5a45 5f46 3332  HE_LINE_SIZE_F32
-000686d0: 293b 0a0a 2020 2020 2020 2020 666f 7220  );..        for 
-000686e0: 2869 6e74 2069 203d 204d 3b20 6920 3c20  (int i = M; i < 
-000686f0: 4d75 703b 202b 2b69 2920 7b0a 2020 2020  Mup; ++i) {.    
-00068700: 2020 2020 2020 2020 535b 695d 203d 202d          S[i] = -
-00068710: 494e 4649 4e49 5459 3b0a 2020 2020 2020  INFINITY;.      
-00068720: 2020 7d0a 0a20 2020 2020 2020 2066 6f72    }..        for
-00068730: 2028 696e 7436 345f 7420 6963 203d 2030   (int64_t ic = 0
-00068740: 3b20 6963 203c 206e 656b 313b 202b 2b69  ; ic < nek1; ++i
-00068750: 6329 207b 0a20 2020 2020 2020 2020 2020  c) {.           
-00068760: 202f 2f20 6b20 696e 6469 6365 730a 2020   // k indices.  
-00068770: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00068780: 696e 7420 696b 3320 3d20 6971 333b 0a20  int ik3 = iq3;. 
-00068790: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000687a0: 2069 6e74 2069 6b32 203d 2069 7132 3b0a   int ik2 = iq2;.
-000687b0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-000687c0: 7420 696e 7420 696b 3120 3d20 6963 3b0a  t int ik1 = ic;.
-000687d0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-000687e0: 5320 696e 6469 6365 730a 2020 2020 2020  S indices.      
-000687f0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-00068800: 6931 203d 2069 6b31 3b0a 0a20 2020 2020  i1 = ik1;..     
-00068810: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-00068820: 646f 745f 6633 3228 6e65 7130 2c0a 2020  dot_f32(neq0,.  
-00068830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068840: 2020 5320 2b20 6931 2c0a 2020 2020 2020    S + i1,.      
-00068850: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-00068860: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-00068870: 2920 6b2d 3e64 6174 6120 2b20 2869 6b31  ) k->data + (ik1
-00068880: 2a6e 626b 3120 2b20 696b 322a 6e62 6b32  *nbk1 + ik2*nbk2
-00068890: 202b 2069 6b33 2a6e 626b 3329 292c 0a20   + ik3*nbk3)),. 
-000688a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000688b0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-000688c0: 6861 7220 2a29 2071 2d3e 6461 7461 202b  har *) q->data +
-000688d0: 2028 6971 312a 6e62 7131 202b 2069 7132   (iq1*nbq1 + iq2
-000688e0: 2a6e 6271 3220 2b20 6971 332a 6e62 7133  *nbq2 + iq3*nbq3
-000688f0: 2929 293b 0a20 2020 2020 2020 207d 0a0a  )));.        }..
-00068900: 2020 2020 2020 2020 2f2f 2073 6361 6c65          // scale
-00068910: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-00068920: 635f 7363 616c 655f 6633 3228 6e65 6b31  c_scale_f32(nek1
-00068930: 2c20 532c 2073 6361 6c65 293b 0a0a 2020  , S, scale);..  
-00068940: 2020 2020 2020 6966 2028 6d61 736b 6564        if (masked
-00068950: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00068960: 666f 7220 2869 6e74 3634 5f74 2069 203d  for (int64_t i =
-00068970: 2050 3b20 6920 3c20 4d3b 2069 2b2b 2920   P; i < M; i++) 
-00068980: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00068990: 2020 6966 2028 6920 3e20 5020 2b20 6971    if (i > P + iq
-000689a0: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-000689b0: 2020 2020 2020 2020 2053 5b69 5d20 3d20           S[i] = 
-000689c0: 2d49 4e46 494e 4954 593b 0a20 2020 2020  -INFINITY;.     
-000689d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000689e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000689f0: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-00068a00: 2073 6f66 746d 6178 0a20 2020 2020 2020   softmax.       
-00068a10: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-00068a20: 6c6f 6174 206d 6178 203d 202d 494e 4649  loat max = -INFI
-00068a30: 4e49 5459 3b0a 2020 2020 2020 2020 2020  NITY;.          
-00068a40: 2020 6767 6d6c 5f76 6563 5f6d 6178 5f66    ggml_vec_max_f
-00068a50: 3332 284d 2c20 266d 6178 2c20 5329 3b0a  32(M, &max, S);.
-00068a60: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-00068a70: 6c5f 666c 6f61 7420 7375 6d20 3d20 302e  l_float sum = 0.
-00068a80: 303b 0a20 2020 2020 2020 2020 2020 207b  0;.            {
-00068a90: 0a23 6966 6465 6620 4747 4d4c 5f53 4f46  .#ifdef GGML_SOF
-00068aa0: 545f 4d41 585f 4143 4345 4c45 5241 5445  T_MAX_ACCELERATE
-00068ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00068ac0: 206d 6178 203d 202d 6d61 783b 0a20 2020   max = -max;.   
-00068ad0: 2020 2020 2020 2020 2020 2020 2076 4453               vDS
-00068ae0: 505f 7673 6164 6428 532c 2031 2c20 266d  P_vsadd(S, 1, &m
-00068af0: 6178 2c20 532c 2031 2c20 4d75 7029 3b0a  ax, S, 1, Mup);.
-00068b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068b10: 7676 6578 7066 2853 2c20 532c 2026 4d75  vvexpf(S, S, &Mu
-00068b20: 7029 3b0a 2020 2020 2020 2020 2020 2020  p);.            
-00068b30: 2020 2020 6767 6d6c 5f76 6563 5f73 756d      ggml_vec_sum
-00068b40: 5f66 3332 284d 7570 2c20 2673 756d 2c20  _f32(Mup, &sum, 
-00068b50: 5329 3b0a 2365 6c73 650a 2020 2020 2020  S);.#else.      
-00068b60: 2020 2020 2020 2020 2020 7569 6e74 3136            uint16
-00068b70: 5f74 2020 2073 6376 745b 4747 4d4c 5f53  _t   scvt[GGML_S
-00068b80: 4f46 545f 4d41 585f 554e 524f 4c4c 5d3b  OFT_MAX_UNROLL];
-00068b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00068ba0: 2067 676d 6c5f 666c 6f61 7420 7375 6d70   ggml_float sump
-00068bb0: 5b47 474d 4c5f 534f 4654 5f4d 4158 5f55  [GGML_SOFT_MAX_U
-00068bc0: 4e52 4f4c 4c5d 203d 207b 2030 2e30 207d  NROLL] = { 0.0 }
-00068bd0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00068be0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00068bf0: 303b 2069 203c 204d 7570 3b20 6920 2b3d  0; i < Mup; i +=
-00068c00: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
-00068c10: 4e52 4f4c 4c29 207b 0a20 2020 2020 2020  NROLL) {.       
-00068c20: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
-00068c30: 6174 202a 2053 5320 3d20 5320 2b20 693b  at * SS = S + i;
-00068c40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00068c50: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-00068c60: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f53   = 0; j < GGML_S
-00068c70: 4f46 545f 4d41 585f 554e 524f 4c4c 3b20  OFT_MAX_UNROLL; 
-00068c80: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-00068c90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00068ca0: 6620 2853 535b 6a5d 203d 3d20 2d49 4e46  f (SS[j] == -INF
-00068cb0: 494e 4954 5929 207b 0a20 2020 2020 2020  INITY) {.       
-00068cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068cd0: 2020 2020 2053 535b 6a5d 203d 2030 2e30       SS[j] = 0.0
-00068ce0: 663b 0a20 2020 2020 2020 2020 2020 2020  f;.             
-00068cf0: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-00068d00: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-00068d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068d20: 6767 6d6c 5f66 7031 365f 7420 7320 3d20  ggml_fp16_t s = 
-00068d30: 4747 4d4c 5f46 5033 325f 544f 5f46 5031  GGML_FP32_TO_FP1
-00068d40: 3628 5353 5b6a 5d20 2d20 6d61 7829 3b0a  6(SS[j] - max);.
-00068d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068d60: 2020 2020 2020 2020 2020 2020 6d65 6d63              memc
-00068d70: 7079 2826 7363 7674 5b6a 5d2c 2026 732c  py(&scvt[j], &s,
-00068d80: 2073 697a 656f 6628 7569 6e74 3136 5f74   sizeof(uint16_t
-00068d90: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-00068da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068db0: 636f 6e73 7420 666c 6f61 7420 7661 6c20  const float val 
-00068dc0: 3d20 4747 4d4c 5f46 5031 365f 544f 5f46  = GGML_FP16_TO_F
-00068dd0: 5033 3228 7461 626c 655f 6578 705f 6631  P32(table_exp_f1
-00068de0: 365b 7363 7674 5b6a 5d5d 293b 0a20 2020  6[scvt[j]]);.   
-00068df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068e00: 2020 2020 2020 2020 2073 756d 705b 6a5d           sump[j]
-00068e10: 202b 3d20 2867 676d 6c5f 666c 6f61 7429   += (ggml_float)
-00068e20: 7661 6c3b 0a20 2020 2020 2020 2020 2020  val;.           
-00068e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068e40: 2053 535b 6a5d 203d 2076 616c 3b0a 2020   SS[j] = val;.  
+00066160: 2020 2020 2020 2020 2064 7374 5f64 6174           dst_dat
+00066170: 615b 2869 312a 6e65 3020 2b20 6930 292a  a[(i1*ne0 + i0)*
+00066180: 6577 3020 2b20 6931 322a 286e 6b30 2a6e  ew0 + i12*(nk0*n
+00066190: 6b31 2920 2b20 696b 312a 6e6b 3020 2b20  k1) + ik1*nk0 + 
+000661a0: 696b 305d 203d 0a20 2020 2020 2020 2020  ik0] =.         
+000661b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000661c0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+000661d0: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+000661e0: 2873 7263 5b69 6478 312a 6e65 3130 202b  (src[idx1*ne10 +
+000661f0: 2069 6478 305d 293b 0a20 2020 2020 2020   idx0]);.       
+00066200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066210: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00066220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066230: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00066240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066250: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00066260: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00066270: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00066280: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00066290: 207d 0a0a 2020 2020 2020 2020 7265 7475   }..        retu
+000662a0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
+000662b0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+000662c0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
+000662d0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
+000662e0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+000662f0: 2020 2020 2f2f 2074 6f74 616c 2070 6174      // total pat
+00066300: 6368 6573 2069 6e20 6473 740a 2020 2020  ches in dst.    
+00066310: 636f 6e73 7420 696e 7420 6e70 203d 206e  const int np = n
+00066320: 6532 3b0a 0a20 2020 202f 2f20 7061 7463  e2;..    // patc
+00066330: 6865 7320 7065 7220 7468 7265 6164 0a20  hes per thread. 
+00066340: 2020 2063 6f6e 7374 2069 6e74 2064 7020     const int dp 
+00066350: 3d20 286e 7020 2b20 6e74 6820 2d20 3129  = (np + nth - 1)
+00066360: 2f6e 7468 3b0a 0a20 2020 202f 2f20 7061  /nth;..    // pa
+00066370: 7463 6820 7261 6e67 6520 666f 7220 7468  tch range for th
+00066380: 6973 2074 6872 6561 640a 2020 2020 636f  is thread.    co
+00066390: 6e73 7420 696e 7420 6970 3020 3d20 6470  nst int ip0 = dp
+000663a0: 2a69 7468 3b0a 2020 2020 636f 6e73 7420  *ith;.    const 
+000663b0: 696e 7420 6970 3120 3d20 4d49 4e28 6970  int ip1 = MIN(ip
+000663c0: 3020 2b20 6470 2c20 6e70 293b 0a0a 2020  0 + dp, np);..  
+000663d0: 2020 6767 6d6c 5f66 7031 365f 7420 2a20    ggml_fp16_t * 
+000663e0: 636f 6e73 7420 7764 6174 6120 3d20 2867  const wdata = (g
+000663f0: 676d 6c5f 6670 3136 5f74 202a 2920 7061  gml_fp16_t *) pa
+00066400: 7261 6d73 2d3e 7764 6174 6120 2b20 303b  rams->wdata + 0;
+00066410: 0a0a 2020 2020 666f 7220 2869 6e74 2069  ..    for (int i
+00066420: 3320 3d20 303b 2069 3320 3c20 6e65 333b  3 = 0; i3 < ne3;
+00066430: 2069 332b 2b29 207b 0a20 2020 2020 2020   i3++) {.       
+00066440: 2066 6f72 2028 696e 7420 6932 203d 2069   for (int i2 = i
+00066450: 7030 3b20 6932 203c 2069 7031 3b20 6932  p0; i2 < ip1; i2
+00066460: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+00066470: 2020 666c 6f61 7420 2a20 6473 745f 6461    float * dst_da
+00066480: 7461 203d 2028 666c 6f61 7420 2a29 2828  ta = (float *)((
+00066490: 6368 6172 202a 2920 6473 742d 3e64 6174  char *) dst->dat
+000664a0: 6120 2b20 6933 2a6e 6233 202b 2069 322a  a + i3*nb3 + i2*
+000664b0: 6e62 3229 3b0a 0a20 2020 2020 2020 2020  nb2);..         
+000664c0: 2020 2066 6f72 2028 696e 7420 6931 203d     for (int i1 =
+000664d0: 2030 3b20 6931 203c 206e 6531 3b20 2b2b   0; i1 < ne1; ++
+000664e0: 6931 2920 7b0a 2020 2020 2020 2020 2020  i1) {.          
+000664f0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00066500: 3020 3d20 303b 2069 3020 3c20 6e65 303b  0 = 0; i0 < ne0;
+00066510: 202b 2b69 3029 207b 0a20 2020 2020 2020   ++i0) {.       
+00066520: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00066530: 6c5f 7665 635f 646f 745f 6631 3628 6577  l_vec_dot_f16(ew
+00066540: 302c 2064 7374 5f64 6174 6120 2b20 6931  0, dst_data + i1
+00066550: 2a6e 6530 202b 2069 302c 0a20 2020 2020  *ne0 + i0,.     
+00066560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066570: 2020 2020 2020 2028 6767 6d6c 5f66 7031         (ggml_fp1
+00066580: 365f 7420 2a29 2028 2863 6861 7220 2a29  6_t *) ((char *)
+00066590: 2073 7263 302d 3e64 6174 6120 2b20 6932   src0->data + i2
+000665a0: 2a6e 6230 3329 2c0a 2020 2020 2020 2020  *nb03),.        
+000665b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000665c0: 2020 2020 2867 676d 6c5f 6670 3136 5f74      (ggml_fp16_t
+000665d0: 202a 2920 2020 2020 2020 2020 2020 2020   *)             
+000665e0: 2020 2077 6461 7461 202b 2069 332a 6e62     wdata + i3*nb
+000665f0: 3320 2b20 2869 312a 6e65 3020 2b20 6930  3 + (i1*ne0 + i0
+00066600: 292a 6577 3029 3b0a 2020 2020 2020 2020  )*ew0);.        
+00066610: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00066620: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00066630: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+00066640: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+00066650: 7574 655f 666f 7277 6172 645f 636f 6e76  ute_forward_conv
+00066660: 5f32 6428 0a20 2020 2020 2020 2063 6f6e  _2d(.        con
+00066670: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00066680: 6f6d 7075 7465 5f70 6172 616d 7320 2a20  ompute_params * 
+00066690: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+000666a0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000666b0: 6c5f 7465 6e73 6f72 202a 2073 7263 302c  l_tensor * src0,
+000666c0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+000666d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+000666e0: 7220 2a20 7372 6331 2c0a 2020 2020 2020  r * src1,.      
+000666f0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00066700: 676d 6c5f 7465 6e73 6f72 202a 206f 7074  gml_tensor * opt
+00066710: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+00066720: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00066730: 6473 740a 2020 2020 2020 2020 2920 7b0a  dst.        ) {.
+00066740: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+00066750: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+00066760: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00066770: 5f46 3136 3a0a 2020 2020 2020 2020 2020  _F16:.          
+00066780: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00066790: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+000667a0: 5f66 6f72 7761 7264 5f63 6f6e 765f 3264  _forward_conv_2d
+000667b0: 5f66 3136 5f66 3332 2870 6172 616d 732c  _f16_f32(params,
+000667c0: 2073 7263 302c 2073 7263 312c 206f 7074   src0, src1, opt
+000667d0: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
+000667e0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000667f0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00066800: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00066810: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00066820: 2020 2020 2020 2020 2f2f 6767 6d6c 5f63          //ggml_c
+00066830: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+00066840: 6f6e 765f 3264 5f66 3332 2870 6172 616d  onv_2d_f32(param
+00066850: 732c 2073 7263 302c 2073 7263 312c 206f  s, src0, src1, o
+00066860: 7074 302c 2064 7374 293b 0a20 2020 2020  pt0, dst);.     
+00066870: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00066880: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+00066890: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000668a0: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
+000668b0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+000668c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000668d0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+000668e0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+000668f0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00066900: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
+00066910: 7075 7465 5f66 6f72 7761 7264 5f70 6f6f  pute_forward_poo
+00066920: 6c5f 3164 5f73 6b5f 7030 0a0a 7374 6174  l_1d_sk_p0..stat
+00066930: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00066940: 7075 7465 5f66 6f72 7761 7264 5f70 6f6f  pute_forward_poo
+00066950: 6c5f 3164 5f73 6b5f 7030 280a 2020 2020  l_1d_sk_p0(.    
+00066960: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00066970: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00066980: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00066990: 2020 2020 2020 2063 6f6e 7374 2065 6e75         const enu
+000669a0: 6d20 6767 6d6c 5f6f 705f 706f 6f6c 206f  m ggml_op_pool o
+000669b0: 702c 0a20 2020 2020 2020 2063 6f6e 7374  p,.        const
+000669c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000669d0: 736f 7220 2a20 7372 632c 0a20 2020 2020  sor * src,.     
+000669e0: 2020 2063 6f6e 7374 2069 6e74 206b 2c0a     const int k,.
+000669f0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00066a00: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00066a10: 2920 7b0a 2020 2020 6173 7365 7274 2873  ) {.    assert(s
+00066a20: 7263 2d3e 7479 7065 203d 3d20 4747 4d4c  rc->type == GGML
+00066a30: 5f54 5950 455f 4633 3229 3b0a 2020 2020  _TYPE_F32);.    
+00066a40: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
+00066a50: 7468 203d 3d20 3029 3b0a 0a20 2020 2069  th == 0);..    i
+00066a60: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00066a70: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+00066a80: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
+00066a90: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+00066aa0: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+00066ab0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00066ac0: 0a0a 2020 2020 636f 6e73 7420 6368 6172  ..    const char
+00066ad0: 202a 2063 6461 7461 203d 2028 636f 6e73   * cdata = (cons
+00066ae0: 7420 6368 6172 202a 2973 7263 2d3e 6461  t char *)src->da
+00066af0: 7461 3b0a 2020 2020 636f 6e73 7420 6368  ta;.    const ch
+00066b00: 6172 202a 2063 6f6e 7374 2064 6174 615f  ar * const data_
+00066b10: 656e 6420 3d20 6364 6174 6120 2b20 6767  end = cdata + gg
+00066b20: 6d6c 5f6e 6279 7465 7328 7372 6329 3b0a  ml_nbytes(src);.
+00066b30: 2020 2020 666c 6f61 7420 2a20 6472 6f77      float * drow
+00066b40: 203d 2028 666c 6f61 7420 2a29 6473 742d   = (float *)dst-
+00066b50: 3e64 6174 613b 0a0a 2020 2020 636f 6e73  >data;..    cons
+00066b60: 7420 696e 7436 345f 7420 7273 203d 2064  t int64_t rs = d
+00066b70: 7374 2d3e 6e65 5b30 5d3b 0a0a 2020 2020  st->ne[0];..    
+00066b80: 7768 696c 6520 2863 6461 7461 203c 2064  while (cdata < d
+00066b90: 6174 615f 656e 6429 207b 0a20 2020 2020  ata_end) {.     
+00066ba0: 2020 2063 6f6e 7374 2066 6c6f 6174 202a     const float *
+00066bb0: 2063 6f6e 7374 2073 726f 7720 3d20 2863   const srow = (c
+00066bc0: 6f6e 7374 2066 6c6f 6174 202a 2963 6461  onst float *)cda
+00066bd0: 7461 3b0a 0a20 2020 2020 2020 2069 6e74  ta;..        int
+00066be0: 206a 203d 2030 3b0a 0a20 2020 2020 2020   j = 0;..       
+00066bf0: 2066 6f72 2028 696e 7436 345f 7420 6920   for (int64_t i 
+00066c00: 3d20 303b 2069 203c 2072 733b 202b 2b69  = 0; i < rs; ++i
+00066c10: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00066c20: 7377 6974 6368 2028 6f70 2920 7b0a 2020  switch (op) {.  
+00066c30: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00066c40: 7365 2047 474d 4c5f 4f50 5f50 4f4f 4c5f  se GGML_OP_POOL_
+00066c50: 4156 473a 2020 2064 726f 775b 695d 203d  AVG:   drow[i] =
+00066c60: 2030 3b20 2020 2020 2020 2062 7265 616b   0;        break
+00066c70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00066c80: 2020 6361 7365 2047 474d 4c5f 4f50 5f50    case GGML_OP_P
+00066c90: 4f4f 4c5f 4d41 583a 2020 2064 726f 775b  OOL_MAX:   drow[
+00066ca0: 695d 203d 202d 464c 545f 4d41 583b 2062  i] = -FLT_MAX; b
+00066cb0: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+00066cc0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00066cd0: 4f50 5f50 4f4f 4c5f 434f 554e 543a 2047  OP_POOL_COUNT: G
+00066ce0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00066cf0: 293b 2062 7265 616b 3b0a 2020 2020 2020  ); break;.      
+00066d00: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00066d10: 2020 2020 666f 7220 2869 6e74 206b 6920      for (int ki 
+00066d20: 3d20 303b 206b 6920 3c20 6b3b 202b 2b6b  = 0; ki < k; ++k
+00066d30: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
+00066d40: 2020 2020 2073 7769 7463 6820 286f 7029       switch (op)
+00066d50: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00066d60: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00066d70: 5f4f 505f 504f 4f4c 5f41 5647 3a20 2020  _OP_POOL_AVG:   
+00066d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066d90: 2020 2020 2020 2064 726f 775b 695d 202b         drow[i] +
+00066da0: 3d20 7372 6f77 5b6a 5d3b 2062 7265 616b  = srow[j]; break
+00066db0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00066dc0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00066dd0: 4f50 5f50 4f4f 4c5f 4d41 583a 2020 2069  OP_POOL_MAX:   i
+00066de0: 6620 2873 726f 775b 6a5d 203e 2064 726f  f (srow[j] > dro
+00066df0: 775b 695d 2920 6472 6f77 5b69 5d20 203d  w[i]) drow[i]  =
+00066e00: 2073 726f 775b 6a5d 3b20 6272 6561 6b3b   srow[j]; break;
+00066e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00066e20: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00066e30: 505f 504f 4f4c 5f43 4f55 4e54 3a20 2020  P_POOL_COUNT:   
+00066e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066e50: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00066e60: 2866 616c 7365 293b 2062 7265 616b 3b0a  (false); break;.
+00066e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066e80: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00066e90: 2020 2b2b 6a3b 0a20 2020 2020 2020 2020    ++j;.         
+00066ea0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00066eb0: 2073 7769 7463 6820 286f 7029 207b 0a20   switch (op) {. 
+00066ec0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00066ed0: 6173 6520 4747 4d4c 5f4f 505f 504f 4f4c  ase GGML_OP_POOL
+00066ee0: 5f41 5647 3a20 2020 2020 2020 2020 6472  _AVG:         dr
+00066ef0: 6f77 5b69 5d20 2f3d 206b 3b20 6272 6561  ow[i] /= k; brea
+00066f00: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00066f10: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00066f20: 504f 4f4c 5f4d 4158 3a20 2020 2020 2020  POOL_MAX:       
+00066f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00066f40: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+00066f50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00066f60: 5f4f 505f 504f 4f4c 5f43 4f55 4e54 3a20  _OP_POOL_COUNT: 
+00066f70: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00066f80: 6529 3b20 6272 6561 6b3b 0a20 2020 2020  e); break;.     
+00066f90: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00066fa0: 207d 0a0a 2020 2020 2020 2020 6364 6174   }..        cdat
+00066fb0: 6120 2b3d 2073 7263 2d3e 6e62 5b31 5d3b  a += src->nb[1];
+00066fc0: 0a20 2020 2020 2020 2064 726f 7720 202b  .        drow  +
+00066fd0: 3d20 7273 3b0a 2020 2020 7d0a 7d0a 0a2f  = rs;.    }.}../
+00066fe0: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00066ff0: 6f72 7761 7264 5f70 6f6f 6c5f 3164 0a0a  orward_pool_1d..
+00067000: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00067010: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00067020: 5f70 6f6f 6c5f 3164 280a 2020 2020 636f  _pool_1d(.    co
+00067030: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00067040: 636f 6d70 7574 655f 7061 7261 6d73 2a20  compute_params* 
+00067050: 7061 7261 6d73 2c0a 2020 2020 636f 6e73  params,.    cons
+00067060: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+00067070: 6e73 6f72 2a20 7372 6330 2c0a 2020 2020  nsor* src0,.    
+00067080: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00067090: 6c5f 7465 6e73 6f72 2a20 6f70 7430 2c0a  l_tensor* opt0,.
+000670a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+000670b0: 7465 6e73 6f72 2a20 6473 7429 207b 0a20  tensor* dst) {. 
+000670c0: 2020 2047 474d 4c5f 4153 5345 5254 286f     GGML_ASSERT(o
+000670d0: 7074 302d 3e6e 655b 305d 203d 3d20 3429  pt0->ne[0] == 4)
+000670e0: 3b0a 2020 2020 636f 6e73 7420 696e 742a  ;.    const int*
+000670f0: 206f 7074 7320 3d20 2863 6f6e 7374 2069   opts = (const i
+00067100: 6e74 2a29 6f70 7430 2d3e 6461 7461 3b0a  nt*)opt0->data;.
+00067110: 2020 2020 656e 756d 2067 676d 6c5f 6f70      enum ggml_op
+00067120: 5f70 6f6f 6c20 6f70 203d 206f 7074 735b  _pool op = opts[
+00067130: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
+00067140: 7420 6b30 203d 206f 7074 735b 315d 3b0a  t k0 = opts[1];.
+00067150: 2020 2020 636f 6e73 7420 696e 7420 7330      const int s0
+00067160: 203d 206f 7074 735b 325d 3b0a 2020 2020   = opts[2];.    
+00067170: 636f 6e73 7420 696e 7420 7030 203d 206f  const int p0 = o
+00067180: 7074 735b 335d 3b0a 2020 2020 4747 4d4c  pts[3];.    GGML
+00067190: 5f41 5353 4552 5428 7030 203d 3d20 3029  _ASSERT(p0 == 0)
+000671a0: 3b20 2f2f 2070 6164 6469 6e67 206e 6f74  ; // padding not
+000671b0: 2073 7570 706f 7274 6564 0a20 2020 2047   supported.    G
+000671c0: 474d 4c5f 4153 5345 5254 286b 3020 3d3d  GML_ASSERT(k0 ==
+000671d0: 2073 3029 3b20 2f2f 206f 6e6c 7920 7320   s0); // only s 
+000671e0: 3d20 6b20 7375 7070 6f72 7465 640a 0a20  = k supported.. 
+000671f0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00067200: 666f 7277 6172 645f 706f 6f6c 5f31 645f  forward_pool_1d_
+00067210: 736b 5f70 3028 7061 7261 6d73 2c20 6f70  sk_p0(params, op
+00067220: 2c20 7372 6330 2c20 6b30 2c20 6473 7429  , src0, k0, dst)
+00067230: 3b0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  ;.}..// ggml_com
+00067240: 7075 7465 5f66 6f72 7761 7264 5f70 6f6f  pute_forward_poo
+00067250: 6c5f 3264 5f73 6b5f 7030 0a0a 7374 6174  l_2d_sk_p0..stat
+00067260: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00067270: 7075 7465 5f66 6f72 7761 7264 5f70 6f6f  pute_forward_poo
+00067280: 6c5f 3264 5f73 6b5f 7030 280a 2020 2020  l_2d_sk_p0(.    
+00067290: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000672a0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+000672b0: 202a 2070 6172 616d 732c 0a20 2020 2063   * params,.    c
+000672c0: 6f6e 7374 2065 6e75 6d20 6767 6d6c 5f6f  onst enum ggml_o
+000672d0: 705f 706f 6f6c 206f 702c 0a20 2020 2063  p_pool op,.    c
+000672e0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+000672f0: 5f74 656e 736f 7220 2a20 7372 632c 0a20  _tensor * src,. 
+00067300: 2020 2063 6f6e 7374 2069 6e74 206b 302c     const int k0,
+00067310: 0a20 2020 2063 6f6e 7374 2069 6e74 206b  .    const int k
+00067320: 312c 0a20 2020 2073 7472 7563 7420 6767  1,.    struct gg
+00067330: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
+00067340: 207b 0a20 2020 2061 7373 6572 7428 7372   {.    assert(sr
+00067350: 632d 3e74 7970 6520 3d3d 2047 474d 4c5f  c->type == GGML_
+00067360: 5459 5045 5f46 3332 293b 0a20 2020 2061  TYPE_F32);.    a
+00067370: 7373 6572 7428 7061 7261 6d73 2d3e 6974  ssert(params->it
+00067380: 6820 3d3d 2030 293b 0a0a 2020 2020 6966  h == 0);..    if
+00067390: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+000673a0: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+000673b0: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+000673c0: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+000673d0: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+000673e0: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+000673f0: 0a20 2020 2063 6f6e 7374 2063 6861 7220  .    const char 
+00067400: 2a20 6364 6174 6120 3d20 2863 6f6e 7374  * cdata = (const
+00067410: 2063 6861 722a 2973 7263 2d3e 6461 7461   char*)src->data
+00067420: 3b0a 2020 2020 636f 6e73 7420 6368 6172  ;.    const char
+00067430: 202a 2063 6f6e 7374 2064 6174 615f 656e   * const data_en
+00067440: 6420 3d20 6364 6174 6120 2b20 6767 6d6c  d = cdata + ggml
+00067450: 5f6e 6279 7465 7328 7372 6329 3b0a 0a20  _nbytes(src);.. 
+00067460: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+00067470: 2070 7820 3d20 6473 742d 3e6e 655b 305d   px = dst->ne[0]
+00067480: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
+00067490: 345f 7420 7079 203d 2064 7374 2d3e 6e65  4_t py = dst->ne
+000674a0: 5b31 5d3b 0a20 2020 2063 6f6e 7374 2069  [1];.    const i
+000674b0: 6e74 3634 5f74 2070 6120 3d20 7078 202a  nt64_t pa = px *
+000674c0: 2070 793b 0a0a 2020 2020 666c 6f61 7420   py;..    float 
+000674d0: 2a20 6470 6c61 6e65 203d 2028 666c 6f61  * dplane = (floa
+000674e0: 7420 2a29 6473 742d 3e64 6174 613b 0a0a  t *)dst->data;..
+000674f0: 2020 2020 636f 6e73 7420 696e 7420 6b61      const int ka
+00067500: 203d 206b 3020 2a20 6b31 3b0a 0a20 2020   = k0 * k1;..   
+00067510: 2077 6869 6c65 2028 6364 6174 6120 3c20   while (cdata < 
+00067520: 6461 7461 5f65 6e64 2920 7b0a 2020 2020  data_end) {.    
+00067530: 2020 2020 666f 7220 2869 6e74 206f 7920      for (int oy 
+00067540: 3d20 303b 206f 7920 3c20 7079 3b20 2b2b  = 0; oy < py; ++
+00067550: 6f79 2920 7b0a 2020 2020 2020 2020 2020  oy) {.          
+00067560: 2020 666c 6f61 7420 2a20 636f 6e73 7420    float * const 
+00067570: 6472 6f77 203d 2064 706c 616e 6520 2b20  drow = dplane + 
+00067580: 6f79 202a 2070 783b 0a20 2020 2020 2020  oy * px;.       
+00067590: 2020 2020 2066 6f72 2028 696e 7420 6f78       for (int ox
+000675a0: 203d 2030 3b20 6f78 203c 2070 783b 202b   = 0; ox < px; +
+000675b0: 2b6f 7829 207b 0a20 2020 2020 2020 2020  +ox) {.         
+000675c0: 2020 2020 2020 2066 6c6f 6174 202a 2063         float * c
+000675d0: 6f6e 7374 206f 7574 203d 2020 6472 6f77  onst out =  drow
+000675e0: 202b 206f 783b 0a20 2020 2020 2020 2020   + ox;.         
+000675f0: 2020 2020 2020 2073 7769 7463 6820 286f         switch (o
+00067600: 7029 207b 0a20 2020 2020 2020 2020 2020  p) {.           
+00067610: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00067620: 4d4c 5f4f 505f 504f 4f4c 5f41 5647 3a20  ML_OP_POOL_AVG: 
+00067630: 2020 2020 2a6f 7574 203d 2030 3b20 2020      *out = 0;   
+00067640: 2020 2020 2062 7265 616b 3b0a 2020 2020       break;.    
+00067650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067660: 6361 7365 2047 474d 4c5f 4f50 5f50 4f4f  case GGML_OP_POO
+00067670: 4c5f 4d41 583a 2020 2020 202a 6f75 7420  L_MAX:     *out 
+00067680: 3d20 2d46 4c54 5f4d 4158 3b20 6272 6561  = -FLT_MAX; brea
+00067690: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+000676a0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000676b0: 5f4f 505f 504f 4f4c 5f43 4f55 4e54 3a20  _OP_POOL_COUNT: 
+000676c0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+000676d0: 6529 3b20 6272 6561 6b3b 0a20 2020 2020  e); break;.     
+000676e0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+000676f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00067700: 6e73 7420 696e 7420 6978 203d 206f 7820  nst int ix = ox 
+00067710: 2a20 6b30 3b0a 2020 2020 2020 2020 2020  * k0;.          
+00067720: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00067730: 6979 203d 206f 7920 2a20 6b31 3b0a 0a20  iy = oy * k1;.. 
+00067740: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00067750: 6f72 2028 696e 7420 6b79 203d 2030 3b20  or (int ky = 0; 
+00067760: 6b79 203c 206b 313b 202b 2b6b 7929 207b  ky < k1; ++ky) {
+00067770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00067780: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+00067790: 202a 2063 6f6e 7374 2073 726f 7720 3d20   * const srow = 
+000677a0: 2863 6f6e 7374 2066 6c6f 6174 202a 2928  (const float *)(
+000677b0: 6364 6174 6120 2b20 7372 632d 3e6e 625b  cdata + src->nb[
+000677c0: 315d 202a 2028 6979 202b 206b 7929 293b  1] * (iy + ky));
+000677d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000677e0: 2020 2020 2066 6f72 2028 696e 7420 6b78       for (int kx
+000677f0: 203d 2030 3b20 6b78 203c 206b 303b 202b   = 0; kx < k0; +
+00067800: 2b6b 7829 207b 0a20 2020 2020 2020 2020  +kx) {.         
+00067810: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00067820: 6e74 206a 203d 2069 7820 2b20 6b78 3b0a  nt j = ix + kx;.
+00067830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067840: 2020 2020 2020 2020 7377 6974 6368 2028          switch (
+00067850: 6f70 2920 7b0a 2020 2020 2020 2020 2020  op) {.          
+00067860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067870: 2020 6361 7365 2047 474d 4c5f 4f50 5f50    case GGML_OP_P
+00067880: 4f4f 4c5f 4156 473a 2020 2020 2020 2020  OOL_AVG:        
+00067890: 2020 2020 2020 2020 2020 2020 202a 6f75               *ou
+000678a0: 7420 2b3d 2073 726f 775b 6a5d 3b20 6272  t += srow[j]; br
+000678b0: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+000678c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000678d0: 2063 6173 6520 4747 4d4c 5f4f 505f 504f   case GGML_OP_PO
+000678e0: 4f4c 5f4d 4158 3a20 6966 2028 7372 6f77  OL_MAX: if (srow
+000678f0: 5b6a 5d20 3e20 2a6f 7574 2920 2a6f 7574  [j] > *out) *out
+00067900: 2020 3d20 7372 6f77 5b6a 5d3b 2062 7265    = srow[j]; bre
+00067910: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
+00067920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00067930: 6361 7365 2047 474d 4c5f 4f50 5f50 4f4f  case GGML_OP_POO
+00067940: 4c5f 434f 554e 543a 2020 2020 2020 2020  L_COUNT:        
+00067950: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00067960: 4552 5428 6661 6c73 6529 3b20 6272 6561  ERT(false); brea
+00067970: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00067980: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00067990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000679a0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+000679b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+000679c0: 2020 2020 2073 7769 7463 6820 286f 7029       switch (op)
+000679d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000679e0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000679f0: 5f4f 505f 504f 4f4c 5f41 5647 3a20 2020  _OP_POOL_AVG:   
+00067a00: 2020 2020 2020 2020 2a6f 7574 202f 3d20          *out /= 
+00067a10: 6b61 3b20 6272 6561 6b3b 0a20 2020 2020  ka; break;.     
+00067a20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00067a30: 6173 6520 4747 4d4c 5f4f 505f 504f 4f4c  ase GGML_OP_POOL
+00067a40: 5f4d 4158 3a20 2020 2020 2020 2020 2020  _MAX:           
+00067a50: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00067a60: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00067a70: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00067a80: 5f4f 505f 504f 4f4c 5f43 4f55 4e54 3a20  _OP_POOL_COUNT: 
+00067a90: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00067aa0: 6529 3b20 6272 6561 6b3b 0a20 2020 2020  e); break;.     
+00067ab0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00067ac0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00067ad0: 2020 207d 0a0a 2020 2020 2020 2020 6364     }..        cd
+00067ae0: 6174 6120 202b 3d20 7372 632d 3e6e 625b  ata  += src->nb[
+00067af0: 325d 3b0a 2020 2020 2020 2020 6470 6c61  2];.        dpla
+00067b00: 6e65 202b 3d20 7061 3b0a 2020 2020 7d0a  ne += pa;.    }.
+00067b10: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
+00067b20: 7465 5f66 6f72 7761 7264 5f70 6f6f 6c5f  te_forward_pool_
+00067b30: 3264 0a0a 7374 6174 6963 2076 6f69 6420  2d..static void 
+00067b40: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00067b50: 7761 7264 5f70 6f6f 6c5f 3264 280a 2020  ward_pool_2d(.  
+00067b60: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00067b70: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+00067b80: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+00067b90: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00067ba0: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00067bb0: 2c0a 2020 2020 636f 6e73 7420 7374 7275  ,.    const stru
+00067bc0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00067bd0: 206f 7074 302c 0a20 2020 2073 7472 7563   opt0,.    struc
+00067be0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00067bf0: 6473 7429 207b 0a20 2020 2047 474d 4c5f  dst) {.    GGML_
+00067c00: 4153 5345 5254 286f 7074 302d 3e6e 655b  ASSERT(opt0->ne[
+00067c10: 305d 203d 3d20 3729 3b0a 2020 2020 636f  0] == 7);.    co
+00067c20: 6e73 7420 696e 742a 206f 7074 7320 3d20  nst int* opts = 
+00067c30: 2863 6f6e 7374 2069 6e74 2a29 6f70 7430  (const int*)opt0
+00067c40: 2d3e 6461 7461 3b0a 2020 2020 656e 756d  ->data;.    enum
+00067c50: 2067 676d 6c5f 6f70 5f70 6f6f 6c20 6f70   ggml_op_pool op
+00067c60: 203d 206f 7074 735b 305d 3b0a 2020 2020   = opts[0];.    
+00067c70: 636f 6e73 7420 696e 7420 6b30 203d 206f  const int k0 = o
+00067c80: 7074 735b 315d 3b0a 2020 2020 636f 6e73  pts[1];.    cons
+00067c90: 7420 696e 7420 6b31 203d 206f 7074 735b  t int k1 = opts[
+00067ca0: 325d 3b0a 2020 2020 636f 6e73 7420 696e  2];.    const in
+00067cb0: 7420 7330 203d 206f 7074 735b 335d 3b0a  t s0 = opts[3];.
+00067cc0: 2020 2020 636f 6e73 7420 696e 7420 7331      const int s1
+00067cd0: 203d 206f 7074 735b 345d 3b0a 2020 2020   = opts[4];.    
+00067ce0: 636f 6e73 7420 696e 7420 7030 203d 206f  const int p0 = o
+00067cf0: 7074 735b 355d 3b0a 2020 2020 636f 6e73  pts[5];.    cons
+00067d00: 7420 696e 7420 7031 203d 206f 7074 735b  t int p1 = opts[
+00067d10: 365d 3b0a 2020 2020 4747 4d4c 5f41 5353  6];.    GGML_ASS
+00067d20: 4552 5428 7030 203d 3d20 3029 3b0a 2020  ERT(p0 == 0);.  
+00067d30: 2020 4747 4d4c 5f41 5353 4552 5428 7031    GGML_ASSERT(p1
+00067d40: 203d 3d20 3029 3b20 2f2f 2070 6164 6469   == 0); // paddi
+00067d50: 6e67 206e 6f74 2073 7570 706f 7274 6564  ng not supported
+00067d60: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00067d70: 286b 3020 3d3d 2073 3029 3b0a 2020 2020  (k0 == s0);.    
+00067d80: 4747 4d4c 5f41 5353 4552 5428 6b31 203d  GGML_ASSERT(k1 =
+00067d90: 3d20 7331 293b 202f 2f20 6f6e 6c79 2073  = s1); // only s
+00067da0: 203d 206b 2073 7570 706f 7274 6564 0a0a   = k supported..
+00067db0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00067dc0: 5f66 6f72 7761 7264 5f70 6f6f 6c5f 3264  _forward_pool_2d
+00067dd0: 5f73 6b5f 7030 2870 6172 616d 732c 206f  _sk_p0(params, o
+00067de0: 702c 2073 7263 302c 206b 302c 206b 312c  p, src0, k0, k1,
+00067df0: 2064 7374 293b 0a7d 0a0a 0a2f 2f20 6767   dst);.}...// gg
+00067e00: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00067e10: 7264 5f66 6c61 7368 5f61 7474 6e0a 0a73  rd_flash_attn..s
+00067e20: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00067e30: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00067e40: 666c 6173 685f 6174 746e 5f66 3332 280a  flash_attn_f32(.
+00067e50: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00067e60: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00067e70: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+00067e80: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+00067e90: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00067ea0: 736f 7220 2a20 712c 0a20 2020 2020 2020  sor * q,.       
+00067eb0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00067ec0: 6d6c 5f74 656e 736f 7220 2a20 6b2c 0a20  ml_tensor * k,. 
+00067ed0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00067ee0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00067ef0: 2a20 762c 0a20 2020 2020 2020 2063 6f6e  * v,.        con
+00067f00: 7374 2062 6f6f 6c20 6d61 736b 6564 2c0a  st bool masked,.
+00067f10: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00067f20: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00067f30: 2a20 6473 7429 207b 0a20 2020 2069 6e74  * dst) {.    int
+00067f40: 3634 5f74 2074 3020 3d20 6767 6d6c 5f70  64_t t0 = ggml_p
+00067f50: 6572 665f 7469 6d65 5f75 7328 293b 0a20  erf_time_us();. 
+00067f60: 2020 2055 4e55 5345 4428 7430 293b 0a0a     UNUSED(t0);..
+00067f70: 2020 2020 4747 4d4c 5f54 454e 534f 525f      GGML_TENSOR_
+00067f80: 4c4f 4341 4c53 2869 6e74 3634 5f74 2c20  LOCALS(int64_t, 
+00067f90: 6e65 712c 2071 2c20 2020 6e65 293b 0a20  neq, q,   ne);. 
+00067fa0: 2020 2047 474d 4c5f 5445 4e53 4f52 5f4c     GGML_TENSOR_L
+00067fb0: 4f43 414c 5328 7369 7a65 5f74 2c20 206e  OCALS(size_t,  n
+00067fc0: 6271 2c20 712c 2020 206e 6229 3b0a 2020  bq, q,   nb);.  
+00067fd0: 2020 4747 4d4c 5f54 454e 534f 525f 4c4f    GGML_TENSOR_LO
+00067fe0: 4341 4c53 2869 6e74 3634 5f74 2c20 6e65  CALS(int64_t, ne
+00067ff0: 6b2c 206b 2c20 2020 6e65 293b 0a20 2020  k, k,   ne);.   
+00068000: 2047 474d 4c5f 5445 4e53 4f52 5f4c 4f43   GGML_TENSOR_LOC
+00068010: 414c 5328 7369 7a65 5f74 2c20 206e 626b  ALS(size_t,  nbk
+00068020: 2c20 6b2c 2020 206e 6229 3b0a 2020 2020  , k,   nb);.    
+00068030: 4747 4d4c 5f54 454e 534f 525f 4c4f 4341  GGML_TENSOR_LOCA
+00068040: 4c53 2869 6e74 3634 5f74 2c20 6e65 762c  LS(int64_t, nev,
+00068050: 2076 2c20 2020 6e65 293b 0a20 2020 2047   v,   ne);.    G
+00068060: 474d 4c5f 5445 4e53 4f52 5f4c 4f43 414c  GML_TENSOR_LOCAL
+00068070: 5328 7369 7a65 5f74 2c20 206e 6276 2c20  S(size_t,  nbv, 
+00068080: 762c 2020 206e 6229 3b0a 2020 2020 4747  v,   nb);.    GG
+00068090: 4d4c 5f54 454e 534f 525f 4c4f 4341 4c53  ML_TENSOR_LOCALS
+000680a0: 2869 6e74 3634 5f74 2c20 6e65 2c20 2064  (int64_t, ne,  d
+000680b0: 7374 2c20 6e65 293b 0a20 2020 2047 474d  st, ne);.    GGM
+000680c0: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
+000680d0: 7369 7a65 5f74 2c20 206e 622c 2020 6473  size_t,  nb,  ds
+000680e0: 742c 206e 6229 3b0a 0a20 2020 2063 6f6e  t, nb);..    con
+000680f0: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00068100: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00068110: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+00068120: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+00068130: 636f 6e73 7420 696e 7436 345f 7420 4420  const int64_t D 
+00068140: 3d20 6e65 7130 3b0a 2020 2020 636f 6e73  = neq0;.    cons
+00068150: 7420 696e 7436 345f 7420 4e20 3d20 6e65  t int64_t N = ne
+00068160: 7131 3b0a 2020 2020 636f 6e73 7420 696e  q1;.    const in
+00068170: 7436 345f 7420 5020 3d20 6e65 6b31 202d  t64_t P = nek1 -
+00068180: 204e 3b0a 2020 2020 636f 6e73 7420 696e   N;.    const in
+00068190: 7436 345f 7420 4d20 3d20 5020 2b20 4e3b  t64_t M = P + N;
+000681a0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+000681b0: 4d75 7020 3d20 6767 6d6c 5f75 7028 4d2c  Mup = ggml_up(M,
+000681c0: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
+000681d0: 4e52 4f4c 4c29 3b0a 0a20 2020 2047 474d  NROLL);..    GGM
+000681e0: 4c5f 4153 5345 5254 286e 6530 203d 3d20  L_ASSERT(ne0 == 
+000681f0: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
+00068200: 4552 5428 6e65 3120 3d3d 204e 293b 0a20  ERT(ne1 == N);. 
+00068210: 2020 2047 474d 4c5f 4153 5345 5254 2850     GGML_ASSERT(P
+00068220: 203e 3d20 3029 3b0a 0a20 2020 2047 474d   >= 0);..    GGM
+00068230: 4c5f 4153 5345 5254 286e 6271 3020 3d3d  L_ASSERT(nbq0 ==
+00068240: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00068250: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00068260: 286e 626b 3020 3d3d 2073 697a 656f 6628  (nbk0 == sizeof(
+00068270: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
+00068280: 4c5f 4153 5345 5254 286e 6276 3020 3d3d  L_ASSERT(nbv0 ==
+00068290: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+000682a0: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
+000682b0: 5428 6e65 7130 203d 3d20 4429 3b0a 2020  T(neq0 == D);.  
+000682c0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+000682d0: 6b30 203d 3d20 4429 3b0a 2020 2020 4747  k0 == D);.    GG
+000682e0: 4d4c 5f41 5353 4552 5428 6e65 7631 203d  ML_ASSERT(nev1 =
+000682f0: 3d20 4429 3b0a 0a20 2020 2047 474d 4c5f  = D);..    GGML_
+00068300: 4153 5345 5254 286e 6571 3120 3d3d 204e  ASSERT(neq1 == N
+00068310: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00068320: 5254 286e 656b 3120 3d3d 204e 202b 2050  RT(nek1 == N + P
+00068330: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+00068340: 5254 286e 6576 3120 3d3d 2044 293b 0a0a  RT(nev1 == D);..
+00068350: 2020 2020 2f2f 2064 7374 2063 616e 6e6f      // dst canno
+00068360: 7420 6265 2074 7261 6e73 706f 7365 6420  t be transposed 
+00068370: 6f72 2070 6572 6d75 7465 640a 2020 2020  or permuted.    
+00068380: 4747 4d4c 5f41 5353 4552 5428 6e62 3020  GGML_ASSERT(nb0 
+00068390: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+000683a0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+000683b0: 5254 286e 6230 203c 3d20 6e62 3129 3b0a  RT(nb0 <= nb1);.
+000683c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000683d0: 6e62 3120 3c3d 206e 6232 293b 0a20 2020  nb1 <= nb2);.   
+000683e0: 2047 474d 4c5f 4153 5345 5254 286e 6232   GGML_ASSERT(nb2
+000683f0: 203c 3d20 6e62 3329 3b0a 0a20 2020 2069   <= nb3);..    i
+00068400: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00068410: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+00068420: 5429 207b 0a20 2020 2020 2020 2072 6574  T) {.        ret
+00068430: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
+00068440: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
+00068450: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00068460: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00068470: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00068480: 0a20 2020 202f 2f20 7061 7261 6c6c 656c  .    // parallel
+00068490: 697a 6520 6279 2071 2072 6f77 7320 7573  ize by q rows us
+000684a0: 696e 6720 6767 6d6c 5f76 6563 5f64 6f74  ing ggml_vec_dot
+000684b0: 5f66 3332 0a0a 2020 2020 2f2f 2074 6f74  _f32..    // tot
+000684c0: 616c 2072 6f77 7320 696e 2071 0a20 2020  al rows in q.   
+000684d0: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
+000684e0: 6e65 7131 2a6e 6571 322a 6e65 7133 3b0a  neq1*neq2*neq3;.
+000684f0: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
+00068500: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
+00068510: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
+00068520: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
+00068530: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
+00068540: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
+00068550: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+00068560: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
+00068570: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
+00068580: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
+00068590: 7229 3b0a 0a20 2020 2063 6f6e 7374 2066  r);..    const f
+000685a0: 6c6f 6174 2073 6361 6c65 203d 2031 2e30  loat scale = 1.0
+000685b0: 662f 7371 7274 6628 4429 3b0a 0a20 2020  f/sqrtf(D);..   
+000685c0: 202f 2f70 7269 6e74 6628 2250 3d25 6420   //printf("P=%d 
+000685d0: 4e3d 2564 2044 3d25 6420 6972 303d 2564  N=%d D=%d ir0=%d
+000685e0: 2069 7231 3d25 6420 7363 616c 6520 3d20   ir1=%d scale = 
+000685f0: 2566 5c6e 222c 2050 2c20 4e2c 2044 2c20  %f\n", P, N, D, 
+00068600: 6972 302c 2069 7231 2c20 7363 616c 6529  ir0, ir1, scale)
+00068610: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00068620: 6972 203d 2069 7230 3b20 6972 203c 2069  ir = ir0; ir < i
+00068630: 7231 3b20 2b2b 6972 2920 7b0a 2020 2020  r1; ++ir) {.    
+00068640: 2020 2020 2f2f 2071 2069 6e64 6963 6573      // q indices
+00068650: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+00068660: 6e74 2069 7133 203d 2069 722f 286e 6571  nt iq3 = ir/(neq
+00068670: 322a 6e65 7131 293b 0a20 2020 2020 2020  2*neq1);.       
+00068680: 2063 6f6e 7374 2069 6e74 2069 7132 203d   const int iq2 =
+00068690: 2028 6972 202d 2069 7133 2a6e 6571 322a   (ir - iq3*neq2*
+000686a0: 6e65 7131 292f 6e65 7131 3b0a 2020 2020  neq1)/neq1;.    
+000686b0: 2020 2020 636f 6e73 7420 696e 7420 6971      const int iq
+000686c0: 3120 3d20 2869 7220 2d20 6971 332a 6e65  1 = (ir - iq3*ne
+000686d0: 7132 2a6e 6571 3120 2d20 6971 322a 6e65  q2*neq1 - iq2*ne
+000686e0: 7131 293b 0a0a 2020 2020 2020 2020 666c  q1);..        fl
+000686f0: 6f61 7420 2a20 5320 3d20 2866 6c6f 6174  oat * S = (float
+00068700: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+00068710: 6120 2b20 6974 682a 284d 7570 202b 2043  a + ith*(Mup + C
+00068720: 4143 4845 5f4c 494e 455f 5349 5a45 5f46  ACHE_LINE_SIZE_F
+00068730: 3332 293b 0a0a 2020 2020 2020 2020 666f  32);..        fo
+00068740: 7220 2869 6e74 2069 203d 204d 3b20 6920  r (int i = M; i 
+00068750: 3c20 4d75 703b 202b 2b69 2920 7b0a 2020  < Mup; ++i) {.  
+00068760: 2020 2020 2020 2020 2020 535b 695d 203d            S[i] =
+00068770: 202d 494e 4649 4e49 5459 3b0a 2020 2020   -INFINITY;.    
+00068780: 2020 2020 7d0a 0a20 2020 2020 2020 2066      }..        f
+00068790: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
+000687a0: 2030 3b20 6963 203c 206e 656b 313b 202b   0; ic < nek1; +
+000687b0: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
+000687c0: 2020 202f 2f20 6b20 696e 6469 6365 730a     // k indices.
+000687d0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+000687e0: 7420 696e 7420 696b 3320 3d20 6971 333b  t int ik3 = iq3;
+000687f0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00068800: 7374 2069 6e74 2069 6b32 203d 2069 7132  st int ik2 = iq2
+00068810: 3b0a 2020 2020 2020 2020 2020 2020 636f  ;.            co
+00068820: 6e73 7420 696e 7420 696b 3120 3d20 6963  nst int ik1 = ic
+00068830: 3b0a 0a20 2020 2020 2020 2020 2020 202f  ;..            /
+00068840: 2f20 5320 696e 6469 6365 730a 2020 2020  / S indices.    
+00068850: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00068860: 7420 6931 203d 2069 6b31 3b0a 0a20 2020  t i1 = ik1;..   
+00068870: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
+00068880: 635f 646f 745f 6633 3228 6e65 7130 2c0a  c_dot_f32(neq0,.
+00068890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000688a0: 2020 2020 5320 2b20 6931 2c0a 2020 2020      S + i1,.    
+000688b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000688c0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+000688d0: 202a 2920 6b2d 3e64 6174 6120 2b20 2869   *) k->data + (i
+000688e0: 6b31 2a6e 626b 3120 2b20 696b 322a 6e62  k1*nbk1 + ik2*nb
+000688f0: 6b32 202b 2069 6b33 2a6e 626b 3329 292c  k2 + ik3*nbk3)),
+00068900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00068910: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+00068920: 2863 6861 7220 2a29 2071 2d3e 6461 7461  (char *) q->data
+00068930: 202b 2028 6971 312a 6e62 7131 202b 2069   + (iq1*nbq1 + i
+00068940: 7132 2a6e 6271 3220 2b20 6971 332a 6e62  q2*nbq2 + iq3*nb
+00068950: 7133 2929 293b 0a20 2020 2020 2020 207d  q3)));.        }
+00068960: 0a0a 2020 2020 2020 2020 2f2f 2073 6361  ..        // sca
+00068970: 6c65 0a20 2020 2020 2020 2067 676d 6c5f  le.        ggml_
+00068980: 7665 635f 7363 616c 655f 6633 3228 6e65  vec_scale_f32(ne
+00068990: 6b31 2c20 532c 2073 6361 6c65 293b 0a0a  k1, S, scale);..
+000689a0: 2020 2020 2020 2020 6966 2028 6d61 736b          if (mask
+000689b0: 6564 2920 7b0a 2020 2020 2020 2020 2020  ed) {.          
+000689c0: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+000689d0: 203d 2050 3b20 6920 3c20 4d3b 2069 2b2b   = P; i < M; i++
+000689e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000689f0: 2020 2020 6966 2028 6920 3e20 5020 2b20      if (i > P + 
+00068a00: 6971 3129 207b 0a20 2020 2020 2020 2020  iq1) {.         
+00068a10: 2020 2020 2020 2020 2020 2053 5b69 5d20             S[i] 
+00068a20: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
+00068a30: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00068a40: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00068a50: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00068a60: 2f2f 2073 6f66 746d 6178 0a20 2020 2020  // softmax.     
+00068a70: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00068a80: 2066 6c6f 6174 206d 6178 203d 202d 494e   float max = -IN
+00068a90: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
+00068aa0: 2020 2020 6767 6d6c 5f76 6563 5f6d 6178      ggml_vec_max
+00068ab0: 5f66 3332 284d 2c20 266d 6178 2c20 5329  _f32(M, &max, S)
+00068ac0: 3b0a 0a20 2020 2020 2020 2020 2020 2067  ;..            g
+00068ad0: 676d 6c5f 666c 6f61 7420 7375 6d20 3d20  gml_float sum = 
+00068ae0: 302e 303b 0a20 2020 2020 2020 2020 2020  0.0;.           
+00068af0: 207b 0a23 6966 6465 6620 4747 4d4c 5f53   {.#ifdef GGML_S
+00068b00: 4f46 545f 4d41 585f 4143 4345 4c45 5241  OFT_MAX_ACCELERA
+00068b10: 5445 0a20 2020 2020 2020 2020 2020 2020  TE.             
+00068b20: 2020 206d 6178 203d 202d 6d61 783b 0a20     max = -max;. 
+00068b30: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00068b40: 4453 505f 7673 6164 6428 532c 2031 2c20  DSP_vsadd(S, 1, 
+00068b50: 266d 6178 2c20 532c 2031 2c20 4d75 7029  &max, S, 1, Mup)
+00068b60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00068b70: 2020 7676 6578 7066 2853 2c20 532c 2026    vvexpf(S, S, &
+00068b80: 4d75 7029 3b0a 2020 2020 2020 2020 2020  Mup);.          
+00068b90: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+00068ba0: 756d 5f66 3332 284d 7570 2c20 2673 756d  um_f32(Mup, &sum
+00068bb0: 2c20 5329 3b0a 2365 6c73 650a 2020 2020  , S);.#else.    
+00068bc0: 2020 2020 2020 2020 2020 2020 7569 6e74              uint
+00068bd0: 3136 5f74 2020 2073 6376 745b 4747 4d4c  16_t   scvt[GGML
+00068be0: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
+00068bf0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+00068c00: 2020 2067 676d 6c5f 666c 6f61 7420 7375     ggml_float su
+00068c10: 6d70 5b47 474d 4c5f 534f 4654 5f4d 4158  mp[GGML_SOFT_MAX
+00068c20: 5f55 4e52 4f4c 4c5d 203d 207b 2030 2e30  _UNROLL] = { 0.0
+00068c30: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
+00068c40: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
+00068c50: 3d20 303b 2069 203c 204d 7570 3b20 6920  = 0; i < Mup; i 
+00068c60: 2b3d 2047 474d 4c5f 534f 4654 5f4d 4158  += GGML_SOFT_MAX
+00068c70: 5f55 4e52 4f4c 4c29 207b 0a20 2020 2020  _UNROLL) {.     
+00068c80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00068c90: 6c6f 6174 202a 2053 5320 3d20 5320 2b20  loat * SS = S + 
+00068ca0: 693b 0a0a 2020 2020 2020 2020 2020 2020  i;..            
+00068cb0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00068cc0: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
+00068cd0: 5f53 4f46 545f 4d41 585f 554e 524f 4c4c  _SOFT_MAX_UNROLL
+00068ce0: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
+00068cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068d00: 2069 6620 2853 535b 6a5d 203d 3d20 2d49   if (SS[j] == -I
+00068d10: 4e46 494e 4954 5929 207b 0a20 2020 2020  NFINITY) {.     
+00068d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068d30: 2020 2020 2020 2053 535b 6a5d 203d 2030         SS[j] = 0
+00068d40: 2e30 663b 0a20 2020 2020 2020 2020 2020  .0f;.           
+00068d50: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+00068d60: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
+00068d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068d80: 2020 6767 6d6c 5f66 7031 365f 7420 7320    ggml_fp16_t s 
+00068d90: 3d20 4747 4d4c 5f46 5033 325f 544f 5f46  = GGML_FP32_TO_F
+00068da0: 5031 3628 5353 5b6a 5d20 2d20 6d61 7829  P16(SS[j] - max)
+00068db0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00068dc0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00068dd0: 6d63 7079 2826 7363 7674 5b6a 5d2c 2026  mcpy(&scvt[j], &
+00068de0: 732c 2073 697a 656f 6628 7569 6e74 3136  s, sizeof(uint16
+00068df0: 5f74 2929 3b0a 2020 2020 2020 2020 2020  _t));.          
+00068e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068e10: 2020 636f 6e73 7420 666c 6f61 7420 7661    const float va
+00068e20: 6c20 3d20 4747 4d4c 5f46 5031 365f 544f  l = GGML_FP16_TO
+00068e30: 5f46 5033 3228 7461 626c 655f 6578 705f  _FP32(table_exp_
+00068e40: 6631 365b 7363 7674 5b6a 5d5d 293b 0a20  f16[scvt[j]]);. 
 00068e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00068e60: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00068e70: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00068e80: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00068e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00068ea0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
-00068eb0: 2069 203c 2047 474d 4c5f 534f 4654 5f4d   i < GGML_SOFT_M
-00068ec0: 4158 5f55 4e52 4f4c 4c3b 2069 2b2b 2920  AX_UNROLL; i++) 
-00068ed0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00068ee0: 2020 2020 2020 7375 6d20 2b3d 2073 756d        sum += sum
-00068ef0: 705b 695d 3b0a 2020 2020 2020 2020 2020  p[i];.          
-00068f00: 2020 2020 2020 7d0a 2365 6e64 6966 0a20        }.#endif. 
-00068f10: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-00068f20: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00068f30: 2873 756d 203e 2030 2e30 293b 0a0a 2020  (sum > 0.0);..  
-00068f40: 2020 2020 2020 2020 2020 7375 6d20 3d20            sum = 
-00068f50: 312e 302f 7375 6d3b 0a20 2020 2020 2020  1.0/sum;.       
-00068f60: 2020 2020 2067 676d 6c5f 7665 635f 7363       ggml_vec_sc
-00068f70: 616c 655f 6633 3228 4d2c 2053 2c20 7375  ale_f32(M, S, su
-00068f80: 6d29 3b0a 0a23 6966 6e64 6566 204e 4445  m);..#ifndef NDE
-00068f90: 4255 470a 2020 2020 2020 2020 2020 2020  BUG.            
-00068fa0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-00068fb0: 6920 3c20 4d3b 202b 2b69 2920 7b0a 2020  i < M; ++i) {.  
-00068fc0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-00068fd0: 7365 7274 2821 6973 6e61 6e28 535b 695d  sert(!isnan(S[i]
-00068fe0: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-00068ff0: 2020 2020 6173 7365 7274 2821 6973 696e      assert(!isin
-00069000: 6628 535b 695d 2929 3b0a 2020 2020 2020  f(S[i]));.      
-00069010: 2020 2020 2020 7d0a 2365 6e64 6966 0a20        }.#endif. 
-00069020: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00069030: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-00069040: 6320 3d20 303b 2069 6320 3c20 6e65 7631  c = 0; ic < nev1
-00069050: 3b20 2b2b 6963 2920 7b0a 2020 2020 2020  ; ++ic) {.      
-00069060: 2020 2020 2020 2f2f 2064 7374 2069 6e64        // dst ind
-00069070: 6963 6573 0a20 2020 2020 2020 2020 2020  ices.           
-00069080: 2063 6f6e 7374 2069 6e74 2069 3120 3d20   const int i1 = 
-00069090: 6971 313b 0a20 2020 2020 2020 2020 2020  iq1;.           
-000690a0: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
-000690b0: 6971 323b 0a20 2020 2020 2020 2020 2020  iq2;.           
-000690c0: 2063 6f6e 7374 2069 6e74 2069 3320 3d20   const int i3 = 
-000690d0: 6971 333b 0a0a 2020 2020 2020 2020 2020  iq3;..          
-000690e0: 2020 6767 6d6c 5f76 6563 5f64 6f74 5f66    ggml_vec_dot_f
-000690f0: 3332 286e 656b 312c 0a20 2020 2020 2020  32(nek1,.       
-00069100: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-00069110: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00069120: 2064 7374 2d3e 6461 7461 202b 2028 6963   dst->data + (ic
-00069130: 2a6e 6230 202b 2069 312a 6e62 3120 202b  *nb0 + i1*nb1  +
-00069140: 2069 322a 6e62 3220 202b 2069 332a 6e62   i2*nb2  + i3*nb
-00069150: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
-00069160: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00069170: 2a29 2028 2863 6861 7220 2a29 2076 2d3e  *) ((char *) v->
-00069180: 6461 7461 2020 202b 2028 2020 2020 2020  data   + (      
-00069190: 2020 2069 632a 6e62 7631 202b 2069 322a     ic*nbv1 + i2*
-000691a0: 6e62 7632 202b 2069 332a 6e62 7633 2929  nbv2 + i3*nbv3))
-000691b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000691c0: 2020 2020 2020 5329 3b0a 2020 2020 2020        S);.      
-000691d0: 2020 7d0a 2020 2020 7d0a 7d0a 0a73 7461    }.    }.}..sta
-000691e0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-000691f0: 6d70 7574 655f 666f 7277 6172 645f 666c  mpute_forward_fl
-00069200: 6173 685f 6174 746e 5f66 3136 280a 2020  ash_attn_f16(.  
-00069210: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00069220: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
-00069230: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-00069240: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00069250: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00069260: 7220 2a20 712c 0a20 2020 2020 2020 2063  r * q,.        c
-00069270: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00069280: 5f74 656e 736f 7220 2a20 6b2c 0a20 2020  _tensor * k,.   
-00069290: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000692a0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000692b0: 762c 0a20 2020 2020 2020 2063 6f6e 7374  v,.        const
-000692c0: 2062 6f6f 6c20 6d61 736b 6564 2c0a 2020   bool masked,.  
-000692d0: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-000692e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-000692f0: 6473 7429 207b 0a20 2020 2069 6e74 3634  dst) {.    int64
-00069300: 5f74 2074 3020 3d20 6767 6d6c 5f70 6572  _t t0 = ggml_per
-00069310: 665f 7469 6d65 5f75 7328 293b 0a20 2020  f_time_us();.   
-00069320: 2055 4e55 5345 4428 7430 293b 0a0a 2020   UNUSED(t0);..  
-00069330: 2020 4747 4d4c 5f54 454e 534f 525f 4c4f    GGML_TENSOR_LO
-00069340: 4341 4c53 2869 6e74 3634 5f74 2c20 6e65  CALS(int64_t, ne
-00069350: 712c 2071 2c20 2020 6e65 293b 0a20 2020  q, q,   ne);.   
-00069360: 2047 474d 4c5f 5445 4e53 4f52 5f4c 4f43   GGML_TENSOR_LOC
-00069370: 414c 5328 7369 7a65 5f74 2c20 206e 6271  ALS(size_t,  nbq
-00069380: 2c20 712c 2020 206e 6229 3b0a 2020 2020  , q,   nb);.    
-00069390: 4747 4d4c 5f54 454e 534f 525f 4c4f 4341  GGML_TENSOR_LOCA
-000693a0: 4c53 2869 6e74 3634 5f74 2c20 6e65 6b2c  LS(int64_t, nek,
-000693b0: 206b 2c20 2020 6e65 293b 0a20 2020 2047   k,   ne);.    G
-000693c0: 474d 4c5f 5445 4e53 4f52 5f4c 4f43 414c  GML_TENSOR_LOCAL
-000693d0: 5328 7369 7a65 5f74 2c20 206e 626b 2c20  S(size_t,  nbk, 
-000693e0: 6b2c 2020 206e 6229 3b0a 2020 2020 4747  k,   nb);.    GG
-000693f0: 4d4c 5f54 454e 534f 525f 4c4f 4341 4c53  ML_TENSOR_LOCALS
-00069400: 2869 6e74 3634 5f74 2c20 6e65 762c 2076  (int64_t, nev, v
-00069410: 2c20 2020 6e65 293b 0a20 2020 2047 474d  ,   ne);.    GGM
-00069420: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
-00069430: 7369 7a65 5f74 2c20 206e 6276 2c20 762c  size_t,  nbv, v,
-00069440: 2020 206e 6229 3b0a 2020 2020 4747 4d4c     nb);.    GGML
-00069450: 5f54 454e 534f 525f 4c4f 4341 4c53 2869  _TENSOR_LOCALS(i
-00069460: 6e74 3634 5f74 2c20 6e65 2c20 2064 7374  nt64_t, ne,  dst
-00069470: 2c20 6e65 293b 0a20 2020 2047 474d 4c5f  , ne);.    GGML_
-00069480: 5445 4e53 4f52 5f4c 4f43 414c 5328 7369  TENSOR_LOCALS(si
-00069490: 7a65 5f74 2c20 206e 622c 2020 6473 742c  ze_t,  nb,  dst,
-000694a0: 206e 6229 3b0a 0a20 2020 2063 6f6e 7374   nb);..    const
-000694b0: 2069 6e74 2069 7468 203d 2070 6172 616d   int ith = param
-000694c0: 732d 3e69 7468 3b0a 2020 2020 636f 6e73  s->ith;.    cons
-000694d0: 7420 696e 7420 6e74 6820 3d20 7061 7261  t int nth = para
-000694e0: 6d73 2d3e 6e74 683b 0a0a 2020 2020 636f  ms->nth;..    co
-000694f0: 6e73 7420 696e 7436 345f 7420 4420 3d20  nst int64_t D = 
-00069500: 6e65 7130 3b0a 2020 2020 636f 6e73 7420  neq0;.    const 
-00069510: 696e 7436 345f 7420 4e20 3d20 6e65 7131  int64_t N = neq1
-00069520: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00069530: 345f 7420 5020 3d20 6e65 6b31 202d 204e  4_t P = nek1 - N
-00069540: 3b0a 2020 2020 636f 6e73 7420 696e 7436  ;.    const int6
-00069550: 345f 7420 4d20 3d20 5020 2b20 4e3b 0a0a  4_t M = P + N;..
-00069560: 2020 2020 636f 6e73 7420 696e 7420 4d75      const int Mu
-00069570: 7020 3d20 6767 6d6c 5f75 7028 4d2c 2047  p = ggml_up(M, G
-00069580: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-00069590: 4f4c 4c29 3b0a 0a20 2020 2047 474d 4c5f  OLL);..    GGML_
-000695a0: 4153 5345 5254 286e 6530 203d 3d20 4429  ASSERT(ne0 == D)
-000695b0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
-000695c0: 5428 6e65 3120 3d3d 204e 293b 0a20 2020  T(ne1 == N);.   
-000695d0: 2047 474d 4c5f 4153 5345 5254 2850 203e   GGML_ASSERT(P >
-000695e0: 3d20 3029 3b0a 0a20 2020 2047 474d 4c5f  = 0);..    GGML_
-000695f0: 4153 5345 5254 286e 6271 3020 3d3d 2073  ASSERT(nbq0 == s
-00069600: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
-00069610: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
-00069620: 5345 5254 286e 626b 3020 3d3d 2073 697a  SERT(nbk0 == siz
-00069630: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
-00069640: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00069650: 5254 286e 6276 3020 3d3d 2073 697a 656f  RT(nbv0 == sizeo
-00069660: 6628 6767 6d6c 5f66 7031 365f 7429 293b  f(ggml_fp16_t));
-00069670: 0a0a 2020 2020 4747 4d4c 5f41 5353 4552  ..    GGML_ASSER
-00069680: 5428 6e65 7130 203d 3d20 4429 3b0a 2020  T(neq0 == D);.  
-00069690: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
-000696a0: 6b30 203d 3d20 4429 3b0a 2020 2020 4747  k0 == D);.    GG
-000696b0: 4d4c 5f41 5353 4552 5428 6e65 7631 203d  ML_ASSERT(nev1 =
-000696c0: 3d20 4429 3b0a 0a20 2020 2047 474d 4c5f  = D);..    GGML_
-000696d0: 4153 5345 5254 286e 6571 3120 3d3d 204e  ASSERT(neq1 == N
-000696e0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-000696f0: 5254 286e 656b 3120 3d3d 204e 202b 2050  RT(nek1 == N + P
-00069700: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00069710: 5254 286e 6576 3120 3d3d 2044 293b 0a0a  RT(nev1 == D);..
-00069720: 2020 2020 2f2f 2064 7374 2063 616e 6e6f      // dst canno
-00069730: 7420 6265 2074 7261 6e73 706f 7365 6420  t be transposed 
-00069740: 6f72 2070 6572 6d75 7465 640a 2020 2020  or permuted.    
-00069750: 4747 4d4c 5f41 5353 4552 5428 6e62 3020  GGML_ASSERT(nb0 
-00069760: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-00069770: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00069780: 5254 286e 6230 203c 3d20 6e62 3129 3b0a  RT(nb0 <= nb1);.
-00069790: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-000697a0: 6e62 3120 3c3d 206e 6232 293b 0a20 2020  nb1 <= nb2);.   
-000697b0: 2047 474d 4c5f 4153 5345 5254 286e 6232   GGML_ASSERT(nb2
-000697c0: 203c 3d20 6e62 3329 3b0a 0a20 2020 2069   <= nb3);..    i
-000697d0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-000697e0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-000697f0: 5429 207b 0a20 2020 2020 2020 2072 6574  T) {.        ret
-00069800: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00069810: 6966 2028 7061 7261 6d73 2d3e 7479 7065  if (params->type
-00069820: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
-00069830: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
-00069840: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00069850: 0a20 2020 202f 2f20 7061 7261 6c6c 656c  .    // parallel
-00069860: 697a 6520 6279 2071 2072 6f77 7320 7573  ize by q rows us
-00069870: 696e 6720 6767 6d6c 5f76 6563 5f64 6f74  ing ggml_vec_dot
-00069880: 5f66 3332 0a0a 2020 2020 2f2f 2074 6f74  _f32..    // tot
-00069890: 616c 2072 6f77 7320 696e 2071 0a20 2020  al rows in q.   
-000698a0: 2063 6f6e 7374 2069 6e74 206e 7220 3d20   const int nr = 
-000698b0: 6e65 7131 2a6e 6571 322a 6e65 7133 3b0a  neq1*neq2*neq3;.
-000698c0: 0a20 2020 202f 2f20 726f 7773 2070 6572  .    // rows per
-000698d0: 2074 6872 6561 640a 2020 2020 636f 6e73   thread.    cons
-000698e0: 7420 696e 7420 6472 203d 2028 6e72 202b  t int dr = (nr +
-000698f0: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-00069900: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
-00069910: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
-00069920: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-00069930: 7230 203d 2064 722a 6974 683b 0a20 2020  r0 = dr*ith;.   
-00069940: 2063 6f6e 7374 2069 6e74 2069 7231 203d   const int ir1 =
-00069950: 204d 494e 2869 7230 202b 2064 722c 206e   MIN(ir0 + dr, n
-00069960: 7229 3b0a 0a20 2020 2063 6f6e 7374 2066  r);..    const f
-00069970: 6c6f 6174 2073 6361 6c65 203d 2031 2e30  loat scale = 1.0
-00069980: 662f 7371 7274 6628 4429 3b0a 0a20 2020  f/sqrtf(D);..   
-00069990: 202f 2f70 7269 6e74 6628 2250 3d25 6420   //printf("P=%d 
-000699a0: 4e3d 2564 2044 3d25 6420 6972 303d 2564  N=%d D=%d ir0=%d
-000699b0: 2069 7231 3d25 6420 7363 616c 6520 3d20   ir1=%d scale = 
-000699c0: 2566 5c6e 222c 2050 2c20 4e2c 2044 2c20  %f\n", P, N, D, 
-000699d0: 6972 302c 2069 7231 2c20 7363 616c 6529  ir0, ir1, scale)
-000699e0: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-000699f0: 6972 203d 2069 7230 3b20 6972 203c 2069  ir = ir0; ir < i
-00069a00: 7231 3b20 2b2b 6972 2920 7b0a 2020 2020  r1; ++ir) {.    
-00069a10: 2020 2020 2f2f 2071 2069 6e64 6963 6573      // q indices
-00069a20: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
-00069a30: 6e74 2069 7133 203d 2069 722f 286e 6571  nt iq3 = ir/(neq
-00069a40: 322a 6e65 7131 293b 0a20 2020 2020 2020  2*neq1);.       
-00069a50: 2063 6f6e 7374 2069 6e74 2069 7132 203d   const int iq2 =
-00069a60: 2028 6972 202d 2069 7133 2a6e 6571 322a   (ir - iq3*neq2*
-00069a70: 6e65 7131 292f 6e65 7131 3b0a 2020 2020  neq1)/neq1;.    
-00069a80: 2020 2020 636f 6e73 7420 696e 7420 6971      const int iq
-00069a90: 3120 3d20 2869 7220 2d20 6971 332a 6e65  1 = (ir - iq3*ne
-00069aa0: 7132 2a6e 6571 3120 2d20 6971 322a 6e65  q2*neq1 - iq2*ne
-00069ab0: 7131 293b 0a0a 2020 2020 2020 2020 666c  q1);..        fl
-00069ac0: 6f61 7420 2a20 5320 3d20 2866 6c6f 6174  oat * S = (float
-00069ad0: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
-00069ae0: 6120 2b20 6974 682a 2832 2a4d 7570 202b  a + ith*(2*Mup +
-00069af0: 2043 4143 4845 5f4c 494e 455f 5349 5a45   CACHE_LINE_SIZE
-00069b00: 5f46 3332 293b 0a0a 2020 2020 2020 2020  _F32);..        
-00069b10: 666f 7220 2869 6e74 2069 203d 204d 3b20  for (int i = M; 
-00069b20: 6920 3c20 4d75 703b 202b 2b69 2920 7b0a  i < Mup; ++i) {.
-00069b30: 2020 2020 2020 2020 2020 2020 535b 695d              S[i]
-00069b40: 203d 202d 494e 4649 4e49 5459 3b0a 2020   = -INFINITY;.  
-00069b50: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00069b60: 2069 6620 2847 474d 4c5f 5645 435f 444f   if (GGML_VEC_DO
-00069b70: 545f 554e 524f 4c4c 203e 2032 207c 7c20  T_UNROLL > 2 || 
-00069b80: 6e65 6b31 2025 2047 474d 4c5f 5645 435f  nek1 % GGML_VEC_
-00069b90: 444f 545f 554e 524f 4c4c 2021 3d20 3029  DOT_UNROLL != 0)
-00069ba0: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
-00069bb0: 6f72 2028 696e 7436 345f 7420 6963 203d  or (int64_t ic =
-00069bc0: 2030 3b20 6963 203c 206e 656b 313b 202b   0; ic < nek1; +
-00069bd0: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
-00069be0: 2020 2020 2020 202f 2f20 6b20 696e 6469         // k indi
-00069bf0: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
-00069c00: 2020 2020 636f 6e73 7420 696e 7420 696b      const int ik
-00069c10: 3320 3d20 6971 333b 0a20 2020 2020 2020  3 = iq3;.       
-00069c20: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00069c30: 6e74 2069 6b32 203d 2069 7132 3b0a 2020  nt ik2 = iq2;.  
-00069c40: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00069c50: 6e73 7420 696e 7420 696b 3120 3d20 6963  nst int ik1 = ic
-00069c60: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00069c70: 2020 202f 2f20 5320 696e 6469 6365 730a     // S indices.
-00069c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069c90: 636f 6e73 7420 696e 7420 6931 203d 2069  const int i1 = i
-00069ca0: 6b31 3b0a 0a20 2020 2020 2020 2020 2020  k1;..           
-00069cb0: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
-00069cc0: 745f 6631 3628 6e65 7130 2c0a 2020 2020  t_f16(neq0,.    
-00069cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069ce0: 2020 2020 5320 2b20 6931 2c0a 2020 2020      S + i1,.    
-00069cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069d00: 2020 2020 2867 676d 6c5f 6670 3136 5f74      (ggml_fp16_t
-00069d10: 202a 2920 2828 6368 6172 202a 2920 6b2d   *) ((char *) k-
-00069d20: 3e64 6174 6120 2b20 2869 6b31 2a6e 626b  >data + (ik1*nbk
-00069d30: 3120 2b20 696b 322a 6e62 6b32 202b 2069  1 + ik2*nbk2 + i
-00069d40: 6b33 2a6e 626b 3329 292c 0a20 2020 2020  k3*nbk3)),.     
+00068e60: 2020 2020 2020 2020 2020 2073 756d 705b             sump[
+00068e70: 6a5d 202b 3d20 2867 676d 6c5f 666c 6f61  j] += (ggml_floa
+00068e80: 7429 7661 6c3b 0a20 2020 2020 2020 2020  t)val;.         
+00068e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068ea0: 2020 2053 535b 6a5d 203d 2076 616c 3b0a     SS[j] = val;.
+00068eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068ec0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00068ed0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00068ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00068ef0: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00068f00: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+00068f10: 303b 2069 203c 2047 474d 4c5f 534f 4654  0; i < GGML_SOFT
+00068f20: 5f4d 4158 5f55 4e52 4f4c 4c3b 2069 2b2b  _MAX_UNROLL; i++
+00068f30: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00068f40: 2020 2020 2020 2020 7375 6d20 2b3d 2073          sum += s
+00068f50: 756d 705b 695d 3b0a 2020 2020 2020 2020  ump[i];.        
+00068f60: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
+00068f70: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+00068f80: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00068f90: 7274 2873 756d 203e 2030 2e30 293b 0a0a  rt(sum > 0.0);..
+00068fa0: 2020 2020 2020 2020 2020 2020 7375 6d20              sum 
+00068fb0: 3d20 312e 302f 7375 6d3b 0a20 2020 2020  = 1.0/sum;.     
+00068fc0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00068fd0: 7363 616c 655f 6633 3228 4d2c 2053 2c20  scale_f32(M, S, 
+00068fe0: 7375 6d29 3b0a 0a23 6966 6e64 6566 204e  sum);..#ifndef N
+00068ff0: 4445 4255 470a 2020 2020 2020 2020 2020  DEBUG.          
+00069000: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00069010: 3b20 6920 3c20 4d3b 202b 2b69 2920 7b0a  ; i < M; ++i) {.
+00069020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069030: 6173 7365 7274 2821 6973 6e61 6e28 535b  assert(!isnan(S[
+00069040: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+00069050: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
+00069060: 696e 6628 535b 695d 2929 3b0a 2020 2020  inf(S[i]));.    
+00069070: 2020 2020 2020 2020 7d0a 2365 6e64 6966          }.#endif
+00069080: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00069090: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+000690a0: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
+000690b0: 7631 3b20 2b2b 6963 2920 7b0a 2020 2020  v1; ++ic) {.    
+000690c0: 2020 2020 2020 2020 2f2f 2064 7374 2069          // dst i
+000690d0: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
+000690e0: 2020 2063 6f6e 7374 2069 6e74 2069 3120     const int i1 
+000690f0: 3d20 6971 313b 0a20 2020 2020 2020 2020  = iq1;.         
+00069100: 2020 2063 6f6e 7374 2069 6e74 2069 3220     const int i2 
+00069110: 3d20 6971 323b 0a20 2020 2020 2020 2020  = iq2;.         
+00069120: 2020 2063 6f6e 7374 2069 6e74 2069 3320     const int i3 
+00069130: 3d20 6971 333b 0a0a 2020 2020 2020 2020  = iq3;..        
+00069140: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+00069150: 5f66 3332 286e 656b 312c 0a20 2020 2020  _f32(nek1,.     
+00069160: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00069170: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+00069180: 2a29 2064 7374 2d3e 6461 7461 202b 2028  *) dst->data + (
+00069190: 6963 2a6e 6230 202b 2069 312a 6e62 3120  ic*nb0 + i1*nb1 
+000691a0: 202b 2069 322a 6e62 3220 202b 2069 332a   + i2*nb2  + i3*
+000691b0: 6e62 3329 292c 0a20 2020 2020 2020 2020  nb3)),.         
+000691c0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+000691d0: 7420 2a29 2028 2863 6861 7220 2a29 2076  t *) ((char *) v
+000691e0: 2d3e 6461 7461 2020 202b 2028 2020 2020  ->data   + (    
+000691f0: 2020 2020 2069 632a 6e62 7631 202b 2069       ic*nbv1 + i
+00069200: 322a 6e62 7632 202b 2069 332a 6e62 7633  2*nbv2 + i3*nbv3
+00069210: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00069220: 2020 2020 2020 2020 5329 3b0a 2020 2020          S);.    
+00069230: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
+00069240: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00069250: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00069260: 666c 6173 685f 6174 746e 5f66 3136 280a  flash_attn_f16(.
+00069270: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00069280: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
+00069290: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
+000692a0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
+000692b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000692c0: 736f 7220 2a20 712c 0a20 2020 2020 2020  sor * q,.       
+000692d0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+000692e0: 6d6c 5f74 656e 736f 7220 2a20 6b2c 0a20  ml_tensor * k,. 
+000692f0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00069300: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00069310: 2a20 762c 0a20 2020 2020 2020 2063 6f6e  * v,.        con
+00069320: 7374 2062 6f6f 6c20 6d61 736b 6564 2c0a  st bool masked,.
+00069330: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00069340: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00069350: 2a20 6473 7429 207b 0a20 2020 2069 6e74  * dst) {.    int
+00069360: 3634 5f74 2074 3020 3d20 6767 6d6c 5f70  64_t t0 = ggml_p
+00069370: 6572 665f 7469 6d65 5f75 7328 293b 0a20  erf_time_us();. 
+00069380: 2020 2055 4e55 5345 4428 7430 293b 0a0a     UNUSED(t0);..
+00069390: 2020 2020 4747 4d4c 5f54 454e 534f 525f      GGML_TENSOR_
+000693a0: 4c4f 4341 4c53 2869 6e74 3634 5f74 2c20  LOCALS(int64_t, 
+000693b0: 6e65 712c 2071 2c20 2020 6e65 293b 0a20  neq, q,   ne);. 
+000693c0: 2020 2047 474d 4c5f 5445 4e53 4f52 5f4c     GGML_TENSOR_L
+000693d0: 4f43 414c 5328 7369 7a65 5f74 2c20 206e  OCALS(size_t,  n
+000693e0: 6271 2c20 712c 2020 206e 6229 3b0a 2020  bq, q,   nb);.  
+000693f0: 2020 4747 4d4c 5f54 454e 534f 525f 4c4f    GGML_TENSOR_LO
+00069400: 4341 4c53 2869 6e74 3634 5f74 2c20 6e65  CALS(int64_t, ne
+00069410: 6b2c 206b 2c20 2020 6e65 293b 0a20 2020  k, k,   ne);.   
+00069420: 2047 474d 4c5f 5445 4e53 4f52 5f4c 4f43   GGML_TENSOR_LOC
+00069430: 414c 5328 7369 7a65 5f74 2c20 206e 626b  ALS(size_t,  nbk
+00069440: 2c20 6b2c 2020 206e 6229 3b0a 2020 2020  , k,   nb);.    
+00069450: 4747 4d4c 5f54 454e 534f 525f 4c4f 4341  GGML_TENSOR_LOCA
+00069460: 4c53 2869 6e74 3634 5f74 2c20 6e65 762c  LS(int64_t, nev,
+00069470: 2076 2c20 2020 6e65 293b 0a20 2020 2047   v,   ne);.    G
+00069480: 474d 4c5f 5445 4e53 4f52 5f4c 4f43 414c  GML_TENSOR_LOCAL
+00069490: 5328 7369 7a65 5f74 2c20 206e 6276 2c20  S(size_t,  nbv, 
+000694a0: 762c 2020 206e 6229 3b0a 2020 2020 4747  v,   nb);.    GG
+000694b0: 4d4c 5f54 454e 534f 525f 4c4f 4341 4c53  ML_TENSOR_LOCALS
+000694c0: 2869 6e74 3634 5f74 2c20 6e65 2c20 2064  (int64_t, ne,  d
+000694d0: 7374 2c20 6e65 293b 0a20 2020 2047 474d  st, ne);.    GGM
+000694e0: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
+000694f0: 7369 7a65 5f74 2c20 206e 622c 2020 6473  size_t,  nb,  ds
+00069500: 742c 206e 6229 3b0a 0a20 2020 2063 6f6e  t, nb);..    con
+00069510: 7374 2069 6e74 2069 7468 203d 2070 6172  st int ith = par
+00069520: 616d 732d 3e69 7468 3b0a 2020 2020 636f  ams->ith;.    co
+00069530: 6e73 7420 696e 7420 6e74 6820 3d20 7061  nst int nth = pa
+00069540: 7261 6d73 2d3e 6e74 683b 0a0a 2020 2020  rams->nth;..    
+00069550: 636f 6e73 7420 696e 7436 345f 7420 4420  const int64_t D 
+00069560: 3d20 6e65 7130 3b0a 2020 2020 636f 6e73  = neq0;.    cons
+00069570: 7420 696e 7436 345f 7420 4e20 3d20 6e65  t int64_t N = ne
+00069580: 7131 3b0a 2020 2020 636f 6e73 7420 696e  q1;.    const in
+00069590: 7436 345f 7420 5020 3d20 6e65 6b31 202d  t64_t P = nek1 -
+000695a0: 204e 3b0a 2020 2020 636f 6e73 7420 696e   N;.    const in
+000695b0: 7436 345f 7420 4d20 3d20 5020 2b20 4e3b  t64_t M = P + N;
+000695c0: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
+000695d0: 4d75 7020 3d20 6767 6d6c 5f75 7028 4d2c  Mup = ggml_up(M,
+000695e0: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
+000695f0: 4e52 4f4c 4c29 3b0a 0a20 2020 2047 474d  NROLL);..    GGM
+00069600: 4c5f 4153 5345 5254 286e 6530 203d 3d20  L_ASSERT(ne0 == 
+00069610: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
+00069620: 4552 5428 6e65 3120 3d3d 204e 293b 0a20  ERT(ne1 == N);. 
+00069630: 2020 2047 474d 4c5f 4153 5345 5254 2850     GGML_ASSERT(P
+00069640: 203e 3d20 3029 3b0a 0a20 2020 2047 474d   >= 0);..    GGM
+00069650: 4c5f 4153 5345 5254 286e 6271 3020 3d3d  L_ASSERT(nbq0 ==
+00069660: 2073 697a 656f 6628 6767 6d6c 5f66 7031   sizeof(ggml_fp1
+00069670: 365f 7429 293b 0a20 2020 2047 474d 4c5f  6_t));.    GGML_
+00069680: 4153 5345 5254 286e 626b 3020 3d3d 2073  ASSERT(nbk0 == s
+00069690: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
+000696a0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+000696b0: 5345 5254 286e 6276 3020 3d3d 2073 697a  SERT(nbv0 == siz
+000696c0: 656f 6628 6767 6d6c 5f66 7031 365f 7429  eof(ggml_fp16_t)
+000696d0: 293b 0a0a 2020 2020 4747 4d4c 5f41 5353  );..    GGML_ASS
+000696e0: 4552 5428 6e65 7130 203d 3d20 4429 3b0a  ERT(neq0 == D);.
+000696f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00069700: 6e65 6b30 203d 3d20 4429 3b0a 2020 2020  nek0 == D);.    
+00069710: 4747 4d4c 5f41 5353 4552 5428 6e65 7631  GGML_ASSERT(nev1
+00069720: 203d 3d20 4429 3b0a 0a20 2020 2047 474d   == D);..    GGM
+00069730: 4c5f 4153 5345 5254 286e 6571 3120 3d3d  L_ASSERT(neq1 ==
+00069740: 204e 293b 0a20 2020 2047 474d 4c5f 4153   N);.    GGML_AS
+00069750: 5345 5254 286e 656b 3120 3d3d 204e 202b  SERT(nek1 == N +
+00069760: 2050 293b 0a20 2020 2047 474d 4c5f 4153   P);.    GGML_AS
+00069770: 5345 5254 286e 6576 3120 3d3d 2044 293b  SERT(nev1 == D);
+00069780: 0a0a 2020 2020 2f2f 2064 7374 2063 616e  ..    // dst can
+00069790: 6e6f 7420 6265 2074 7261 6e73 706f 7365  not be transpose
+000697a0: 6420 6f72 2070 6572 6d75 7465 640a 2020  d or permuted.  
+000697b0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+000697c0: 3020 3d3d 2073 697a 656f 6628 666c 6f61  0 == sizeof(floa
+000697d0: 7429 293b 0a20 2020 2047 474d 4c5f 4153  t));.    GGML_AS
+000697e0: 5345 5254 286e 6230 203c 3d20 6e62 3129  SERT(nb0 <= nb1)
+000697f0: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+00069800: 5428 6e62 3120 3c3d 206e 6232 293b 0a20  T(nb1 <= nb2);. 
+00069810: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+00069820: 6232 203c 3d20 6e62 3329 3b0a 0a20 2020  b2 <= nb3);..   
+00069830: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00069840: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+00069850: 4e49 5429 207b 0a20 2020 2020 2020 2072  NIT) {.        r
+00069860: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+00069870: 2020 6966 2028 7061 7261 6d73 2d3e 7479    if (params->ty
+00069880: 7065 203d 3d20 4747 4d4c 5f54 4153 4b5f  pe == GGML_TASK_
+00069890: 4649 4e41 4c49 5a45 2920 7b0a 2020 2020  FINALIZE) {.    
+000698a0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+000698b0: 7d0a 0a20 2020 202f 2f20 7061 7261 6c6c  }..    // parall
+000698c0: 656c 697a 6520 6279 2071 2072 6f77 7320  elize by q rows 
+000698d0: 7573 696e 6720 6767 6d6c 5f76 6563 5f64  using ggml_vec_d
+000698e0: 6f74 5f66 3332 0a0a 2020 2020 2f2f 2074  ot_f32..    // t
+000698f0: 6f74 616c 2072 6f77 7320 696e 2071 0a20  otal rows in q. 
+00069900: 2020 2063 6f6e 7374 2069 6e74 206e 7220     const int nr 
+00069910: 3d20 6e65 7131 2a6e 6571 322a 6e65 7133  = neq1*neq2*neq3
+00069920: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
+00069930: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
+00069940: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
+00069950: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+00069960: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+00069970: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+00069980: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00069990: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
+000699a0: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
+000699b0: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
+000699c0: 206e 7229 3b0a 0a20 2020 2063 6f6e 7374   nr);..    const
+000699d0: 2066 6c6f 6174 2073 6361 6c65 203d 2031   float scale = 1
+000699e0: 2e30 662f 7371 7274 6628 4429 3b0a 0a20  .0f/sqrtf(D);.. 
+000699f0: 2020 202f 2f70 7269 6e74 6628 2250 3d25     //printf("P=%
+00069a00: 6420 4e3d 2564 2044 3d25 6420 6972 303d  d N=%d D=%d ir0=
+00069a10: 2564 2069 7231 3d25 6420 7363 616c 6520  %d ir1=%d scale 
+00069a20: 3d20 2566 5c6e 222c 2050 2c20 4e2c 2044  = %f\n", P, N, D
+00069a30: 2c20 6972 302c 2069 7231 2c20 7363 616c  , ir0, ir1, scal
+00069a40: 6529 3b0a 0a20 2020 2066 6f72 2028 696e  e);..    for (in
+00069a50: 7420 6972 203d 2069 7230 3b20 6972 203c  t ir = ir0; ir <
+00069a60: 2069 7231 3b20 2b2b 6972 2920 7b0a 2020   ir1; ++ir) {.  
+00069a70: 2020 2020 2020 2f2f 2071 2069 6e64 6963        // q indic
+00069a80: 6573 0a20 2020 2020 2020 2063 6f6e 7374  es.        const
+00069a90: 2069 6e74 2069 7133 203d 2069 722f 286e   int iq3 = ir/(n
+00069aa0: 6571 322a 6e65 7131 293b 0a20 2020 2020  eq2*neq1);.     
+00069ab0: 2020 2063 6f6e 7374 2069 6e74 2069 7132     const int iq2
+00069ac0: 203d 2028 6972 202d 2069 7133 2a6e 6571   = (ir - iq3*neq
+00069ad0: 322a 6e65 7131 292f 6e65 7131 3b0a 2020  2*neq1)/neq1;.  
+00069ae0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00069af0: 6971 3120 3d20 2869 7220 2d20 6971 332a  iq1 = (ir - iq3*
+00069b00: 6e65 7132 2a6e 6571 3120 2d20 6971 322a  neq2*neq1 - iq2*
+00069b10: 6e65 7131 293b 0a0a 2020 2020 2020 2020  neq1);..        
+00069b20: 666c 6f61 7420 2a20 5320 3d20 2866 6c6f  float * S = (flo
+00069b30: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
+00069b40: 6174 6120 2b20 6974 682a 2832 2a4d 7570  ata + ith*(2*Mup
+00069b50: 202b 2043 4143 4845 5f4c 494e 455f 5349   + CACHE_LINE_SI
+00069b60: 5a45 5f46 3332 293b 0a0a 2020 2020 2020  ZE_F32);..      
+00069b70: 2020 666f 7220 2869 6e74 2069 203d 204d    for (int i = M
+00069b80: 3b20 6920 3c20 4d75 703b 202b 2b69 2920  ; i < Mup; ++i) 
+00069b90: 7b0a 2020 2020 2020 2020 2020 2020 535b  {.            S[
+00069ba0: 695d 203d 202d 494e 4649 4e49 5459 3b0a  i] = -INFINITY;.
+00069bb0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00069bc0: 2020 2069 6620 2847 474d 4c5f 5645 435f     if (GGML_VEC_
+00069bd0: 444f 545f 554e 524f 4c4c 203e 2032 207c  DOT_UNROLL > 2 |
+00069be0: 7c20 6e65 6b31 2025 2047 474d 4c5f 5645  | nek1 % GGML_VE
+00069bf0: 435f 444f 545f 554e 524f 4c4c 2021 3d20  C_DOT_UNROLL != 
+00069c00: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+00069c10: 2066 6f72 2028 696e 7436 345f 7420 6963   for (int64_t ic
+00069c20: 203d 2030 3b20 6963 203c 206e 656b 313b   = 0; ic < nek1;
+00069c30: 202b 2b69 6329 207b 0a20 2020 2020 2020   ++ic) {.       
+00069c40: 2020 2020 2020 2020 202f 2f20 6b20 696e           // k in
+00069c50: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+00069c60: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00069c70: 696b 3320 3d20 6971 333b 0a20 2020 2020  ik3 = iq3;.     
+00069c80: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00069c90: 2069 6e74 2069 6b32 203d 2069 7132 3b0a   int ik2 = iq2;.
+00069ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069cb0: 636f 6e73 7420 696e 7420 696b 3120 3d20  const int ik1 = 
+00069cc0: 6963 3b0a 0a20 2020 2020 2020 2020 2020  ic;..           
+00069cd0: 2020 2020 202f 2f20 5320 696e 6469 6365       // S indice
+00069ce0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00069cf0: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
+00069d00: 2069 6b31 3b0a 0a20 2020 2020 2020 2020   ik1;..         
+00069d10: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+00069d20: 646f 745f 6631 3628 6e65 7130 2c0a 2020  dot_f16(neq0,.  
+00069d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069d40: 2020 2020 2020 5320 2b20 6931 2c0a 2020        S + i1,.  
 00069d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069d60: 2020 2028 6767 6d6c 5f66 7031 365f 7420     (ggml_fp16_t 
-00069d70: 2a29 2028 2863 6861 7220 2a29 2071 2d3e  *) ((char *) q->
-00069d80: 6461 7461 202b 2028 6971 312a 6e62 7131  data + (iq1*nbq1
-00069d90: 202b 2069 7132 2a6e 6271 3220 2b20 6971   + iq2*nbq2 + iq
-00069da0: 332a 6e62 7133 2929 293b 0a20 2020 2020  3*nbq3)));.     
-00069db0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00069dc0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-00069dd0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-00069de0: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
-00069df0: 6e65 6b31 3b20 6963 202b 3d20 4747 4d4c  nek1; ic += GGML
-00069e00: 5f56 4543 5f44 4f54 5f55 4e52 4f4c 4c29  _VEC_DOT_UNROLL)
-00069e10: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00069e20: 2020 202f 2f20 6b20 696e 6469 6365 730a     // k indices.
-00069e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00069e40: 636f 6e73 7420 696e 7420 696b 3320 3d20  const int ik3 = 
-00069e50: 6971 333b 0a20 2020 2020 2020 2020 2020  iq3;.           
-00069e60: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-00069e70: 6b32 203d 2069 7132 3b0a 2020 2020 2020  k2 = iq2;.      
-00069e80: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00069e90: 696e 7420 696b 3120 3d20 6963 3b0a 0a20  int ik1 = ic;.. 
-00069ea0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00069eb0: 2f20 5320 696e 6469 6365 730a 2020 2020  / S indices.    
-00069ec0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00069ed0: 7420 696e 7420 6931 203d 2069 6b31 3b0a  t int i1 = ik1;.
-00069ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00069ef0: 2067 676d 6c5f 7665 635f 646f 745f 6631   ggml_vec_dot_f1
-00069f00: 365f 756e 726f 6c6c 286e 6571 302c 206e  6_unroll(neq0, n
-00069f10: 626b 312c 0a20 2020 2020 2020 2020 2020  bk1,.           
-00069f20: 2020 2020 2020 2020 2020 2020 2053 202b               S +
-00069f30: 2069 312c 0a20 2020 2020 2020 2020 2020   i1,.           
-00069f40: 2020 2020 2020 2020 2020 2020 2028 2863               ((c
-00069f50: 6861 7220 2a29 206b 2d3e 6461 7461 202b  har *) k->data +
-00069f60: 2028 696b 312a 6e62 6b31 202b 2069 6b32   (ik1*nbk1 + ik2
-00069f70: 2a6e 626b 3220 2b20 696b 332a 6e62 6b33  *nbk2 + ik3*nbk3
-00069f80: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
-00069f90: 2020 2020 2020 2020 2020 2020 2867 676d              (ggm
-00069fa0: 6c5f 6670 3136 5f74 202a 2920 2828 6368  l_fp16_t *) ((ch
-00069fb0: 6172 202a 2920 712d 3e64 6174 6120 2b20  ar *) q->data + 
-00069fc0: 2869 7131 2a6e 6271 3120 2b20 6971 322a  (iq1*nbq1 + iq2*
-00069fd0: 6e62 7132 202b 2069 7133 2a6e 6271 3329  nbq2 + iq3*nbq3)
-00069fe0: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-00069ff0: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-0006a000: 2020 2020 202f 2f20 7363 616c 650a 2020       // scale.  
-0006a010: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
-0006a020: 6361 6c65 5f66 3332 286e 656b 312c 2053  cale_f32(nek1, S
-0006a030: 2c20 7363 616c 6529 3b0a 0a20 2020 2020  , scale);..     
-0006a040: 2020 2069 6620 286d 6173 6b65 6429 207b     if (masked) {
-0006a050: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0006a060: 2028 696e 7436 345f 7420 6920 3d20 503b   (int64_t i = P;
-0006a070: 2069 203c 204d 3b20 692b 2b29 207b 0a20   i < M; i++) {. 
-0006a080: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0006a090: 6620 2869 203e 2050 202b 2069 7131 2920  f (i > P + iq1) 
-0006a0a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0006a0b0: 2020 2020 2020 535b 695d 203d 202d 494e        S[i] = -IN
-0006a0c0: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
-0006a0d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0006a0e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0006a0f0: 7d0a 0a20 2020 2020 2020 202f 2f20 736f  }..        // so
-0006a100: 6674 6d61 780a 2020 2020 2020 2020 7b0a  ftmax.        {.
-0006a110: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
-0006a120: 7420 6d61 7820 3d20 2d49 4e46 494e 4954  t max = -INFINIT
-0006a130: 593b 0a20 2020 2020 2020 2020 2020 2067  Y;.            g
-0006a140: 676d 6c5f 7665 635f 6d61 785f 6633 3228  gml_vec_max_f32(
-0006a150: 4d2c 2026 6d61 782c 2053 293b 0a0a 2020  M, &max, S);..  
-0006a160: 2020 2020 2020 2020 2020 6767 6d6c 5f66            ggml_f
-0006a170: 6c6f 6174 2073 756d 203d 2030 2e30 3b0a  loat sum = 0.0;.
-0006a180: 2020 2020 2020 2020 2020 2020 7b0a 2369              {.#i
-0006a190: 6664 6566 2047 474d 4c5f 534f 4654 5f4d  fdef GGML_SOFT_M
-0006a1a0: 4158 5f41 4343 454c 4552 4154 450a 2020  AX_ACCELERATE.  
-0006a1b0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-0006a1c0: 7820 3d20 2d6d 6178 3b0a 2020 2020 2020  x = -max;.      
-0006a1d0: 2020 2020 2020 2020 2020 7644 5350 5f76            vDSP_v
-0006a1e0: 7361 6464 2853 2c20 312c 2026 6d61 782c  sadd(S, 1, &max,
-0006a1f0: 2053 2c20 312c 204d 7570 293b 0a20 2020   S, 1, Mup);.   
-0006a200: 2020 2020 2020 2020 2020 2020 2076 7665               vve
-0006a210: 7870 6628 532c 2053 2c20 264d 7570 293b  xpf(S, S, &Mup);
-0006a220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a230: 2067 676d 6c5f 7665 635f 7375 6d5f 6633   ggml_vec_sum_f3
-0006a240: 3228 4d75 702c 2026 7375 6d2c 2053 293b  2(Mup, &sum, S);
-0006a250: 0a23 656c 7365 0a20 2020 2020 2020 2020  .#else.         
-0006a260: 2020 2020 2020 2075 696e 7431 365f 7420         uint16_t 
-0006a270: 2020 7363 7674 5b47 474d 4c5f 534f 4654    scvt[GGML_SOFT
-0006a280: 5f4d 4158 5f55 4e52 4f4c 4c5d 3b0a 2020  _MAX_UNROLL];.  
-0006a290: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0006a2a0: 6d6c 5f66 6c6f 6174 2073 756d 705b 4747  ml_float sump[GG
-0006a2b0: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-0006a2c0: 4c4c 5d20 3d20 7b20 302e 3020 7d3b 0a0a  LL] = { 0.0 };..
-0006a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a2e0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0006a2f0: 6920 3c20 4d75 703b 2069 202b 3d20 4747  i < Mup; i += GG
-0006a300: 4d4c 5f53 4f46 545f 4d41 585f 554e 524f  ML_SOFT_MAX_UNRO
-0006a310: 4c4c 2920 7b0a 2020 2020 2020 2020 2020  LL) {.          
-0006a320: 2020 2020 2020 2020 2020 666c 6f61 7420            float 
-0006a330: 2a20 5353 203d 2053 202b 2069 3b0a 0a20  * SS = S + i;.. 
-0006a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a350: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-0006a360: 303b 206a 203c 2047 474d 4c5f 534f 4654  0; j < GGML_SOFT
-0006a370: 5f4d 4158 5f55 4e52 4f4c 4c3b 202b 2b6a  _MAX_UNROLL; ++j
-0006a380: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0006a390: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0006a3a0: 5353 5b6a 5d20 3d3d 202d 494e 4649 4e49  SS[j] == -INFINI
-0006a3b0: 5459 2920 7b0a 2020 2020 2020 2020 2020  TY) {.          
-0006a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a3d0: 2020 5353 5b6a 5d20 3d20 302e 3066 3b0a    SS[j] = 0.0f;.
-0006a3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a3f0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-0006a400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a410: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006a420: 6c5f 6670 3136 5f74 2073 203d 2047 474d  l_fp16_t s = GGM
-0006a430: 4c5f 4650 3332 5f54 4f5f 4650 3136 2853  L_FP32_TO_FP16(S
-0006a440: 535b 6a5d 202d 206d 6178 293b 0a20 2020  S[j] - max);.   
-0006a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a460: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
-0006a470: 2673 6376 745b 6a5d 2c20 2673 2c20 7369  &scvt[j], &s, si
-0006a480: 7a65 6f66 2875 696e 7431 365f 7429 293b  zeof(uint16_t));
-0006a490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a4a0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0006a4b0: 7374 2066 6c6f 6174 2076 616c 203d 2047  st float val = G
-0006a4c0: 474d 4c5f 4650 3136 5f54 4f5f 4650 3332  GML_FP16_TO_FP32
-0006a4d0: 2874 6162 6c65 5f65 7870 5f66 3136 5b73  (table_exp_f16[s
-0006a4e0: 6376 745b 6a5d 5d29 3b0a 2020 2020 2020  cvt[j]]);.      
-0006a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a500: 2020 2020 2020 7375 6d70 5b6a 5d20 2b3d        sump[j] +=
-0006a510: 2028 6767 6d6c 5f66 6c6f 6174 2976 616c   (ggml_float)val
-0006a520: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0006a530: 2020 2020 2020 2020 2020 2020 2020 5353                SS
-0006a540: 5b6a 5d20 3d20 7661 6c3b 0a20 2020 2020  [j] = val;.     
+00069d60: 2020 2020 2020 2867 676d 6c5f 6670 3136        (ggml_fp16
+00069d70: 5f74 202a 2920 2828 6368 6172 202a 2920  _t *) ((char *) 
+00069d80: 6b2d 3e64 6174 6120 2b20 2869 6b31 2a6e  k->data + (ik1*n
+00069d90: 626b 3120 2b20 696b 322a 6e62 6b32 202b  bk1 + ik2*nbk2 +
+00069da0: 2069 6b33 2a6e 626b 3329 292c 0a20 2020   ik3*nbk3)),.   
+00069db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00069dc0: 2020 2020 2028 6767 6d6c 5f66 7031 365f       (ggml_fp16_
+00069dd0: 7420 2a29 2028 2863 6861 7220 2a29 2071  t *) ((char *) q
+00069de0: 2d3e 6461 7461 202b 2028 6971 312a 6e62  ->data + (iq1*nb
+00069df0: 7131 202b 2069 7132 2a6e 6271 3220 2b20  q1 + iq2*nbq2 + 
+00069e00: 6971 332a 6e62 7133 2929 293b 0a20 2020  iq3*nbq3)));.   
+00069e10: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00069e20: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00069e30: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00069e40: 3634 5f74 2069 6320 3d20 303b 2069 6320  64_t ic = 0; ic 
+00069e50: 3c20 6e65 6b31 3b20 6963 202b 3d20 4747  < nek1; ic += GG
+00069e60: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
+00069e70: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
+00069e80: 2020 2020 202f 2f20 6b20 696e 6469 6365       // k indice
+00069e90: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00069ea0: 2020 636f 6e73 7420 696e 7420 696b 3320    const int ik3 
+00069eb0: 3d20 6971 333b 0a20 2020 2020 2020 2020  = iq3;.         
+00069ec0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00069ed0: 2069 6b32 203d 2069 7132 3b0a 2020 2020   ik2 = iq2;.    
+00069ee0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00069ef0: 7420 696e 7420 696b 3120 3d20 6963 3b0a  t int ik1 = ic;.
+00069f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00069f10: 202f 2f20 5320 696e 6469 6365 730a 2020   // S indices.  
+00069f20: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00069f30: 6e73 7420 696e 7420 6931 203d 2069 6b31  nst int i1 = ik1
+00069f40: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00069f50: 2020 2067 676d 6c5f 7665 635f 646f 745f     ggml_vec_dot_
+00069f60: 6631 365f 756e 726f 6c6c 286e 6571 302c  f16_unroll(neq0,
+00069f70: 206e 626b 312c 0a20 2020 2020 2020 2020   nbk1,.         
+00069f80: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+00069f90: 202b 2069 312c 0a20 2020 2020 2020 2020   + i1,.         
+00069fa0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00069fb0: 2863 6861 7220 2a29 206b 2d3e 6461 7461  (char *) k->data
+00069fc0: 202b 2028 696b 312a 6e62 6b31 202b 2069   + (ik1*nbk1 + i
+00069fd0: 6b32 2a6e 626b 3220 2b20 696b 332a 6e62  k2*nbk2 + ik3*nb
+00069fe0: 6b33 2929 2c0a 2020 2020 2020 2020 2020  k3)),.          
+00069ff0: 2020 2020 2020 2020 2020 2020 2020 2867                (g
+0006a000: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
+0006a010: 6368 6172 202a 2920 712d 3e64 6174 6120  char *) q->data 
+0006a020: 2b20 2869 7131 2a6e 6271 3120 2b20 6971  + (iq1*nbq1 + iq
+0006a030: 322a 6e62 7132 202b 2069 7133 2a6e 6271  2*nbq2 + iq3*nbq
+0006a040: 3329 2929 3b0a 2020 2020 2020 2020 2020  3)));.          
+0006a050: 2020 7d0a 2020 2020 2020 2020 7d0a 0a20    }.        }.. 
+0006a060: 2020 2020 2020 202f 2f20 7363 616c 650a         // scale.
+0006a070: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0006a080: 5f73 6361 6c65 5f66 3332 286e 656b 312c  _scale_f32(nek1,
+0006a090: 2053 2c20 7363 616c 6529 3b0a 0a20 2020   S, scale);..   
+0006a0a0: 2020 2020 2069 6620 286d 6173 6b65 6429       if (masked)
+0006a0b0: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+0006a0c0: 6f72 2028 696e 7436 345f 7420 6920 3d20  or (int64_t i = 
+0006a0d0: 503b 2069 203c 204d 3b20 692b 2b29 207b  P; i < M; i++) {
+0006a0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006a0f0: 2069 6620 2869 203e 2050 202b 2069 7131   if (i > P + iq1
+0006a100: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0006a110: 2020 2020 2020 2020 535b 695d 203d 202d          S[i] = -
+0006a120: 494e 4649 4e49 5459 3b0a 2020 2020 2020  INFINITY;.      
+0006a130: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0006a140: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0006a150: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+0006a160: 736f 6674 6d61 780a 2020 2020 2020 2020  softmax.        
+0006a170: 7b0a 2020 2020 2020 2020 2020 2020 666c  {.            fl
+0006a180: 6f61 7420 6d61 7820 3d20 2d49 4e46 494e  oat max = -INFIN
+0006a190: 4954 593b 0a20 2020 2020 2020 2020 2020  ITY;.           
+0006a1a0: 2067 676d 6c5f 7665 635f 6d61 785f 6633   ggml_vec_max_f3
+0006a1b0: 3228 4d2c 2026 6d61 782c 2053 293b 0a0a  2(M, &max, S);..
+0006a1c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0006a1d0: 5f66 6c6f 6174 2073 756d 203d 2030 2e30  _float sum = 0.0
+0006a1e0: 3b0a 2020 2020 2020 2020 2020 2020 7b0a  ;.            {.
+0006a1f0: 2369 6664 6566 2047 474d 4c5f 534f 4654  #ifdef GGML_SOFT
+0006a200: 5f4d 4158 5f41 4343 454c 4552 4154 450a  _MAX_ACCELERATE.
+0006a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a220: 6d61 7820 3d20 2d6d 6178 3b0a 2020 2020  max = -max;.    
+0006a230: 2020 2020 2020 2020 2020 2020 7644 5350              vDSP
+0006a240: 5f76 7361 6464 2853 2c20 312c 2026 6d61  _vsadd(S, 1, &ma
+0006a250: 782c 2053 2c20 312c 204d 7570 293b 0a20  x, S, 1, Mup);. 
+0006a260: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0006a270: 7665 7870 6628 532c 2053 2c20 264d 7570  vexpf(S, S, &Mup
+0006a280: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0006a290: 2020 2067 676d 6c5f 7665 635f 7375 6d5f     ggml_vec_sum_
+0006a2a0: 6633 3228 4d75 702c 2026 7375 6d2c 2053  f32(Mup, &sum, S
+0006a2b0: 293b 0a23 656c 7365 0a20 2020 2020 2020  );.#else.       
+0006a2c0: 2020 2020 2020 2020 2075 696e 7431 365f           uint16_
+0006a2d0: 7420 2020 7363 7674 5b47 474d 4c5f 534f  t   scvt[GGML_SO
+0006a2e0: 4654 5f4d 4158 5f55 4e52 4f4c 4c5d 3b0a  FT_MAX_UNROLL];.
+0006a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a300: 6767 6d6c 5f66 6c6f 6174 2073 756d 705b  ggml_float sump[
+0006a310: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
+0006a320: 524f 4c4c 5d20 3d20 7b20 302e 3020 7d3b  ROLL] = { 0.0 };
+0006a330: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0006a340: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0006a350: 3b20 6920 3c20 4d75 703b 2069 202b 3d20  ; i < Mup; i += 
+0006a360: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
+0006a370: 524f 4c4c 2920 7b0a 2020 2020 2020 2020  ROLL) {.        
+0006a380: 2020 2020 2020 2020 2020 2020 666c 6f61              floa
+0006a390: 7420 2a20 5353 203d 2053 202b 2069 3b0a  t * SS = S + i;.
+0006a3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006a3b0: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+0006a3c0: 3d20 303b 206a 203c 2047 474d 4c5f 534f  = 0; j < GGML_SO
+0006a3d0: 4654 5f4d 4158 5f55 4e52 4f4c 4c3b 202b  FT_MAX_UNROLL; +
+0006a3e0: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+0006a3f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0006a400: 2028 5353 5b6a 5d20 3d3d 202d 494e 4649   (SS[j] == -INFI
+0006a410: 4e49 5459 2920 7b0a 2020 2020 2020 2020  NITY) {.        
+0006a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a430: 2020 2020 5353 5b6a 5d20 3d20 302e 3066      SS[j] = 0.0f
+0006a440: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006a450: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+0006a460: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006a470: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006a480: 676d 6c5f 6670 3136 5f74 2073 203d 2047  gml_fp16_t s = G
+0006a490: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+0006a4a0: 2853 535b 6a5d 202d 206d 6178 293b 0a20  (SS[j] - max);. 
+0006a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a4c0: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
+0006a4d0: 7928 2673 6376 745b 6a5d 2c20 2673 2c20  y(&scvt[j], &s, 
+0006a4e0: 7369 7a65 6f66 2875 696e 7431 365f 7429  sizeof(uint16_t)
+0006a4f0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0006a500: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0006a510: 6f6e 7374 2066 6c6f 6174 2076 616c 203d  onst float val =
+0006a520: 2047 474d 4c5f 4650 3136 5f54 4f5f 4650   GGML_FP16_TO_FP
+0006a530: 3332 2874 6162 6c65 5f65 7870 5f66 3136  32(table_exp_f16
+0006a540: 5b73 6376 745b 6a5d 5d29 3b0a 2020 2020  [scvt[j]]);.    
 0006a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a560: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0006a570: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0006a580: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0006a590: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0006a5a0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0006a5b0: 3c20 4747 4d4c 5f53 4f46 545f 4d41 585f  < GGML_SOFT_MAX_
-0006a5c0: 554e 524f 4c4c 3b20 692b 2b29 207b 0a20  UNROLL; i++) {. 
-0006a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a5e0: 2020 2073 756d 202b 3d20 7375 6d70 5b69     sum += sump[i
-0006a5f0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0006a600: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
-0006a610: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0006a620: 2020 2020 2020 2061 7373 6572 7428 7375         assert(su
-0006a630: 6d20 3e20 302e 3029 3b0a 0a20 2020 2020  m > 0.0);..     
-0006a640: 2020 2020 2020 2073 756d 203d 2031 2e30         sum = 1.0
-0006a650: 2f73 756d 3b0a 2020 2020 2020 2020 2020  /sum;.          
-0006a660: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
-0006a670: 5f66 3332 284d 2c20 532c 2073 756d 293b  _f32(M, S, sum);
-0006a680: 0a0a 2369 666e 6465 6620 4e44 4542 5547  ..#ifndef NDEBUG
-0006a690: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0006a6a0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-0006a6b0: 204d 3b20 2b2b 6929 207b 0a20 2020 2020   M; ++i) {.     
-0006a6c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0006a6d0: 7428 2169 736e 616e 2853 5b69 5d29 293b  t(!isnan(S[i]));
-0006a6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006a6f0: 2061 7373 6572 7428 2169 7369 6e66 2853   assert(!isinf(S
-0006a700: 5b69 5d29 293b 0a20 2020 2020 2020 2020  [i]));.         
-0006a710: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
-0006a720: 2020 2020 7d0a 0a20 2020 2020 2020 2067      }..        g
-0006a730: 676d 6c5f 6670 3136 5f74 202a 2053 3136  gml_fp16_t * S16
-0006a740: 203d 2028 6767 6d6c 5f66 7031 365f 7420   = (ggml_fp16_t 
-0006a750: 2a29 2028 2866 6c6f 6174 202a 2920 7061  *) ((float *) pa
-0006a760: 7261 6d73 2d3e 7764 6174 6120 2b20 6974  rams->wdata + it
-0006a770: 682a 2832 2a4d 7570 202b 2043 4143 4845  h*(2*Mup + CACHE
-0006a780: 5f4c 494e 455f 5349 5a45 5f46 3332 2920  _LINE_SIZE_F32) 
-0006a790: 2b20 4d75 7029 3b0a 0a20 2020 2020 2020  + Mup);..       
-0006a7a0: 2066 6f72 2028 696e 7436 345f 7420 6920   for (int64_t i 
-0006a7b0: 3d20 303b 2069 203c 204d 3b20 692b 2b29  = 0; i < M; i++)
-0006a7c0: 207b 0a20 2020 2020 2020 2020 2020 2053   {.            S
-0006a7d0: 3136 5b69 5d20 3d20 4747 4d4c 5f46 5033  16[i] = GGML_FP3
-0006a7e0: 325f 544f 5f46 5031 3628 535b 695d 293b  2_TO_FP16(S[i]);
-0006a7f0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0006a800: 2020 2020 6966 2028 4747 4d4c 5f56 4543      if (GGML_VEC
-0006a810: 5f44 4f54 5f55 4e52 4f4c 4c20 3d3d 2031  _DOT_UNROLL == 1
-0006a820: 207c 7c20 286e 6576 3120 2520 4747 4d4c   || (nev1 % GGML
-0006a830: 5f56 4543 5f44 4f54 5f55 4e52 4f4c 4c20  _VEC_DOT_UNROLL 
-0006a840: 213d 2030 2929 207b 0a20 2020 2020 2020  != 0)) {.       
-0006a850: 2020 2020 2066 6f72 2028 696e 7436 345f       for (int64_
-0006a860: 7420 6963 203d 2030 3b20 6963 203c 206e  t ic = 0; ic < n
-0006a870: 6576 313b 202b 2b69 6329 207b 0a20 2020  ev1; ++ic) {.   
-0006a880: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006a890: 6473 7420 696e 6469 6365 730a 2020 2020  dst indices.    
-0006a8a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006a8b0: 7420 696e 7420 6931 203d 2069 7131 3b0a  t int i1 = iq1;.
-0006a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a8d0: 636f 6e73 7420 696e 7420 6932 203d 2069  const int i2 = i
-0006a8e0: 7132 3b0a 2020 2020 2020 2020 2020 2020  q2;.            
-0006a8f0: 2020 2020 636f 6e73 7420 696e 7420 6933      const int i3
-0006a900: 203d 2069 7133 3b0a 0a20 2020 2020 2020   = iq3;..       
-0006a910: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0006a920: 635f 646f 745f 6631 3628 6e65 6b31 2c0a  c_dot_f16(nek1,.
-0006a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006a940: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-0006a950: 2920 2020 2020 2020 2828 6368 6172 202a  )       ((char *
-0006a960: 2920 6473 742d 3e64 6174 6120 2b20 2869  ) dst->data + (i
-0006a970: 632a 6e62 3020 2b20 6931 2a6e 6231 2020  c*nb0 + i1*nb1  
-0006a980: 2b20 6932 2a6e 6232 2020 2b20 6933 2a6e  + i2*nb2  + i3*n
-0006a990: 6233 2929 2c0a 2020 2020 2020 2020 2020  b3)),.          
-0006a9a0: 2020 2020 2020 2020 2020 2020 2020 2867                (g
-0006a9b0: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
-0006a9c0: 6368 6172 202a 2920 762d 3e64 6174 6120  char *) v->data 
-0006a9d0: 2020 2b20 2820 2020 2020 2020 2020 6963    + (         ic
-0006a9e0: 2a6e 6276 3120 2b20 6932 2a6e 6276 3220  *nbv1 + i2*nbv2 
-0006a9f0: 2b20 6933 2a6e 6276 3329 292c 0a20 2020  + i3*nbv3)),.   
+0006a560: 2020 2020 2020 2020 7375 6d70 5b6a 5d20          sump[j] 
+0006a570: 2b3d 2028 6767 6d6c 5f66 6c6f 6174 2976  += (ggml_float)v
+0006a580: 616c 3b0a 2020 2020 2020 2020 2020 2020  al;.            
+0006a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a5a0: 5353 5b6a 5d20 3d20 7661 6c3b 0a20 2020  SS[j] = val;.   
+0006a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a5c0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0006a5d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0006a5e0: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
+0006a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006a600: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
+0006a610: 6920 3c20 4747 4d4c 5f53 4f46 545f 4d41  i < GGML_SOFT_MA
+0006a620: 585f 554e 524f 4c4c 3b20 692b 2b29 207b  X_UNROLL; i++) {
+0006a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006a640: 2020 2020 2073 756d 202b 3d20 7375 6d70       sum += sump
+0006a650: 5b69 5d3b 0a20 2020 2020 2020 2020 2020  [i];.           
+0006a660: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
+0006a670: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0006a680: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
+0006a690: 7375 6d20 3e20 302e 3029 3b0a 0a20 2020  sum > 0.0);..   
+0006a6a0: 2020 2020 2020 2020 2073 756d 203d 2031           sum = 1
+0006a6b0: 2e30 2f73 756d 3b0a 2020 2020 2020 2020  .0/sum;.        
+0006a6c0: 2020 2020 6767 6d6c 5f76 6563 5f73 6361      ggml_vec_sca
+0006a6d0: 6c65 5f66 3332 284d 2c20 532c 2073 756d  le_f32(M, S, sum
+0006a6e0: 293b 0a0a 2369 666e 6465 6620 4e44 4542  );..#ifndef NDEB
+0006a6f0: 5547 0a20 2020 2020 2020 2020 2020 2066  UG.            f
+0006a700: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0006a710: 203c 204d 3b20 2b2b 6929 207b 0a20 2020   < M; ++i) {.   
+0006a720: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0006a730: 6572 7428 2169 736e 616e 2853 5b69 5d29  ert(!isnan(S[i])
+0006a740: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0006a750: 2020 2061 7373 6572 7428 2169 7369 6e66     assert(!isinf
+0006a760: 2853 5b69 5d29 293b 0a20 2020 2020 2020  (S[i]));.       
+0006a770: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
+0006a780: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0006a790: 2067 676d 6c5f 6670 3136 5f74 202a 2053   ggml_fp16_t * S
+0006a7a0: 3136 203d 2028 6767 6d6c 5f66 7031 365f  16 = (ggml_fp16_
+0006a7b0: 7420 2a29 2028 2866 6c6f 6174 202a 2920  t *) ((float *) 
+0006a7c0: 7061 7261 6d73 2d3e 7764 6174 6120 2b20  params->wdata + 
+0006a7d0: 6974 682a 2832 2a4d 7570 202b 2043 4143  ith*(2*Mup + CAC
+0006a7e0: 4845 5f4c 494e 455f 5349 5a45 5f46 3332  HE_LINE_SIZE_F32
+0006a7f0: 2920 2b20 4d75 7029 3b0a 0a20 2020 2020  ) + Mup);..     
+0006a800: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+0006a810: 6920 3d20 303b 2069 203c 204d 3b20 692b  i = 0; i < M; i+
+0006a820: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+0006a830: 2053 3136 5b69 5d20 3d20 4747 4d4c 5f46   S16[i] = GGML_F
+0006a840: 5033 325f 544f 5f46 5031 3628 535b 695d  P32_TO_FP16(S[i]
+0006a850: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
+0006a860: 2020 2020 2020 6966 2028 4747 4d4c 5f56        if (GGML_V
+0006a870: 4543 5f44 4f54 5f55 4e52 4f4c 4c20 3d3d  EC_DOT_UNROLL ==
+0006a880: 2031 207c 7c20 286e 6576 3120 2520 4747   1 || (nev1 % GG
+0006a890: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
+0006a8a0: 4c20 213d 2030 2929 207b 0a20 2020 2020  L != 0)) {.     
+0006a8b0: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
+0006a8c0: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
+0006a8d0: 206e 6576 313b 202b 2b69 6329 207b 0a20   nev1; ++ic) {. 
+0006a8e0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006a8f0: 2f20 6473 7420 696e 6469 6365 730a 2020  / dst indices.  
+0006a900: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0006a910: 6e73 7420 696e 7420 6931 203d 2069 7131  nst int i1 = iq1
+0006a920: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006a930: 2020 636f 6e73 7420 696e 7420 6932 203d    const int i2 =
+0006a940: 2069 7132 3b0a 2020 2020 2020 2020 2020   iq2;.          
+0006a950: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0006a960: 6933 203d 2069 7133 3b0a 0a20 2020 2020  i3 = iq3;..     
+0006a970: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006a980: 7665 635f 646f 745f 6631 3628 6e65 6b31  vec_dot_f16(nek1
+0006a990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006a9a0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+0006a9b0: 202a 2920 2020 2020 2020 2828 6368 6172   *)       ((char
+0006a9c0: 202a 2920 6473 742d 3e64 6174 6120 2b20   *) dst->data + 
+0006a9d0: 2869 632a 6e62 3020 2b20 6931 2a6e 6231  (ic*nb0 + i1*nb1
+0006a9e0: 2020 2b20 6932 2a6e 6232 2020 2b20 6933    + i2*nb2  + i3
+0006a9f0: 2a6e 6233 2929 2c0a 2020 2020 2020 2020  *nb3)),.        
 0006aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006aa10: 2020 2020 2053 3136 293b 0a20 2020 2020       S16);.     
-0006aa20: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0006aa30: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-0006aa40: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-0006aa50: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
-0006aa60: 6e65 7631 3b20 6963 202b 3d20 4747 4d4c  nev1; ic += GGML
-0006aa70: 5f56 4543 5f44 4f54 5f55 4e52 4f4c 4c29  _VEC_DOT_UNROLL)
-0006aa80: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006aa90: 2020 202f 2f20 6473 7420 696e 6469 6365     // dst indice
-0006aaa0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0006aab0: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
-0006aac0: 2069 7131 3b0a 2020 2020 2020 2020 2020   iq1;.          
-0006aad0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0006aae0: 6932 203d 2069 7132 3b0a 2020 2020 2020  i2 = iq2;.      
-0006aaf0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006ab00: 696e 7420 6933 203d 2069 7133 3b0a 0a20  int i3 = iq3;.. 
-0006ab10: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0006ab20: 676d 6c5f 7665 635f 646f 745f 6631 365f  gml_vec_dot_f16_
-0006ab30: 756e 726f 6c6c 286e 656b 312c 206e 6276  unroll(nek1, nbv
-0006ab40: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-0006ab50: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
-0006ab60: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
-0006ab70: 7374 2d3e 6461 7461 202b 2028 6963 2a6e  st->data + (ic*n
-0006ab80: 6230 202b 2069 312a 6e62 3120 202b 2069  b0 + i1*nb1  + i
-0006ab90: 322a 6e62 3220 202b 2069 332a 6e62 3329  2*nb2  + i3*nb3)
-0006aba0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0006abb0: 2020 2020 2020 2020 2020 2028 2863 6861             ((cha
-0006abc0: 7220 2a29 2076 2d3e 6461 7461 2020 202b  r *) v->data   +
-0006abd0: 2028 2020 2020 2020 2020 2069 632a 6e62   (         ic*nb
-0006abe0: 7631 202b 2069 322a 6e62 7632 202b 2069  v1 + i2*nbv2 + i
-0006abf0: 332a 6e62 7633 2929 2c0a 2020 2020 2020  3*nbv3)),.      
-0006ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ac10: 2020 5331 3629 3b0a 2020 2020 2020 2020    S16);.        
-0006ac20: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-0006ac30: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-0006ac40: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
-0006ac50: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
-0006ac60: 6174 746e 280a 2020 2020 2020 2020 636f  attn(.        co
-0006ac70: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0006ac80: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-0006ac90: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-0006aca0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0006acb0: 6d6c 5f74 656e 736f 7220 2a20 712c 0a20  ml_tensor * q,. 
-0006acc0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-0006acd0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0006ace0: 2a20 6b2c 0a20 2020 2020 2020 2063 6f6e  * k,.        con
-0006acf0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-0006ad00: 656e 736f 7220 2a20 762c 0a20 2020 2020  ensor * v,.     
-0006ad10: 2020 2063 6f6e 7374 2062 6f6f 6c20 6d61     const bool ma
-0006ad20: 736b 6564 2c0a 2020 2020 2020 2020 7374  sked,.        st
-0006ad30: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0006ad40: 202a 2064 7374 2920 7b0a 2020 2020 7377   * dst) {.    sw
-0006ad50: 6974 6368 2028 712d 3e74 7970 6529 207b  itch (q->type) {
-0006ad60: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0006ad70: 4d4c 5f54 5950 455f 4631 363a 0a20 2020  ML_TYPE_F16:.   
-0006ad80: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0006ad90: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0006ada0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0006adb0: 666c 6173 685f 6174 746e 5f66 3136 2870  flash_attn_f16(p
-0006adc0: 6172 616d 732c 2071 2c20 6b2c 2076 2c20  arams, q, k, v, 
-0006add0: 6d61 736b 6564 2c20 6473 7429 3b0a 2020  masked, dst);.  
-0006ade0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0006adf0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0006ae00: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
-0006ae10: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0006ae20: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006ae30: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-0006ae40: 645f 666c 6173 685f 6174 746e 5f66 3332  d_flash_attn_f32
-0006ae50: 2870 6172 616d 732c 2071 2c20 6b2c 2076  (params, q, k, v
-0006ae60: 2c20 6d61 736b 6564 2c20 6473 7429 3b0a  , masked, dst);.
-0006ae70: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0006ae80: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
-0006ae90: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
-0006aea0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0006aeb0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0006aec0: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
-0006aed0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0006aee0: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
-0006aef0: 6d70 7574 655f 666f 7277 6172 645f 666c  mpute_forward_fl
-0006af00: 6173 685f 6666 0a0a 7374 6174 6963 2076  ash_ff..static v
-0006af10: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-0006af20: 5f66 6f72 7761 7264 5f66 6c61 7368 5f66  _forward_flash_f
-0006af30: 665f 6631 3628 0a20 2020 2020 2020 2063  f_f16(.        c
-0006af40: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0006af50: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-0006af60: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-0006af70: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0006af80: 676d 6c5f 7465 6e73 6f72 202a 2061 2c20  gml_tensor * a, 
-0006af90: 202f 2f20 4631 360a 2020 2020 2020 2020   // F16.        
-0006afa0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0006afb0: 6c5f 7465 6e73 6f72 202a 2062 302c 202f  l_tensor * b0, /
-0006afc0: 2f20 4631 3620 6663 5f77 0a20 2020 2020  / F16 fc_w.     
-0006afd0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0006afe0: 6767 6d6c 5f74 656e 736f 7220 2a20 6231  ggml_tensor * b1
-0006aff0: 2c20 2f2f 2046 3332 2066 635f 620a 2020  , // F32 fc_b.  
-0006b000: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0006b010: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0006b020: 2063 302c 202f 2f20 4631 3620 7072 6f6a   c0, // F16 proj
-0006b030: 5f77 0a20 2020 2020 2020 2063 6f6e 7374  _w.        const
-0006b040: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0006b050: 736f 7220 2a20 6331 2c20 2f2f 2046 3332  sor * c1, // F32
-0006b060: 2070 726f 6a5f 620a 2020 2020 2020 2020   proj_b.        
-0006b070: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0006b080: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
-0006b090: 696e 7436 345f 7420 7430 203d 2067 676d  int64_t t0 = ggm
-0006b0a0: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
-0006b0b0: 3b0a 2020 2020 554e 5553 4544 2874 3029  ;.    UNUSED(t0)
-0006b0c0: 3b0a 0a20 2020 2047 474d 4c5f 5445 4e53  ;..    GGML_TENS
-0006b0d0: 4f52 5f4c 4f43 414c 5328 696e 7436 345f  OR_LOCALS(int64_
-0006b0e0: 742c 206e 6561 2c20 2061 2c20 2020 6e65  t, nea,  a,   ne
-0006b0f0: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b100: 4f52 5f4c 4f43 414c 5328 7369 7a65 5f74  OR_LOCALS(size_t
-0006b110: 2c20 206e 6261 2c20 2061 2c20 2020 6e62  ,  nba,  a,   nb
-0006b120: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b130: 4f52 5f4c 4f43 414c 5328 696e 7436 345f  OR_LOCALS(int64_
-0006b140: 742c 206e 6562 302c 2062 302c 2020 6e65  t, neb0, b0,  ne
-0006b150: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b160: 4f52 5f4c 4f43 414c 5328 7369 7a65 5f74  OR_LOCALS(size_t
-0006b170: 2c20 206e 6262 302c 2062 302c 2020 6e62  ,  nbb0, b0,  nb
-0006b180: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b190: 4f52 5f4c 4f43 414c 5328 696e 7436 345f  OR_LOCALS(int64_
-0006b1a0: 742c 206e 6562 312c 2062 312c 2020 6e65  t, neb1, b1,  ne
-0006b1b0: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b1c0: 4f52 5f4c 4f43 414c 5328 7369 7a65 5f74  OR_LOCALS(size_t
-0006b1d0: 2c20 206e 6262 312c 2062 312c 2020 6e62  ,  nbb1, b1,  nb
-0006b1e0: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b1f0: 4f52 5f4c 4f43 414c 5328 696e 7436 345f  OR_LOCALS(int64_
-0006b200: 742c 206e 6563 302c 2063 302c 2020 6e65  t, nec0, c0,  ne
-0006b210: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b220: 4f52 5f4c 4f43 414c 5328 7369 7a65 5f74  OR_LOCALS(size_t
-0006b230: 2c20 206e 6263 302c 2063 302c 2020 6e62  ,  nbc0, c0,  nb
-0006b240: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b250: 4f52 5f4c 4f43 414c 5328 696e 7436 345f  OR_LOCALS(int64_
-0006b260: 742c 206e 6563 312c 2063 312c 2020 6e65  t, nec1, c1,  ne
-0006b270: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b280: 4f52 5f4c 4f43 414c 5328 7369 7a65 5f74  OR_LOCALS(size_t
-0006b290: 2c20 206e 6263 312c 2063 312c 2020 6e62  ,  nbc1, c1,  nb
-0006b2a0: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b2b0: 4f52 5f4c 4f43 414c 5328 696e 7436 345f  OR_LOCALS(int64_
-0006b2c0: 742c 206e 652c 2020 2064 7374 2c20 6e65  t, ne,   dst, ne
-0006b2d0: 293b 0a20 2020 2047 474d 4c5f 5445 4e53  );.    GGML_TENS
-0006b2e0: 4f52 5f4c 4f43 414c 5328 7369 7a65 5f74  OR_LOCALS(size_t
-0006b2f0: 2c20 206e 622c 2020 2064 7374 2c20 6e62  ,  nb,   dst, nb
-0006b300: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
-0006b310: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
-0006b320: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
-0006b330: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
-0006b340: 3e6e 7468 3b0a 0a20 2020 2063 6f6e 7374  >nth;..    const
-0006b350: 2069 6e74 3634 5f74 2044 203d 206e 6561   int64_t D = nea
-0006b360: 303b 0a20 2020 202f 2f63 6f6e 7374 2069  0;.    //const i
-0006b370: 6e74 3634 5f74 204e 203d 206e 6561 313b  nt64_t N = nea1;
-0006b380: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0006b390: 5f74 204d 203d 206e 6562 3031 3b0a 0a20  _t M = neb01;.. 
-0006b3a0: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0006b3b0: 6530 203d 3d20 6e65 6130 293b 0a20 2020  e0 == nea0);.   
-0006b3c0: 2047 474d 4c5f 4153 5345 5254 286e 6531   GGML_ASSERT(ne1
-0006b3d0: 203d 3d20 6e65 6131 293b 0a20 2020 2047   == nea1);.    G
-0006b3e0: 474d 4c5f 4153 5345 5254 286e 6532 203d  GML_ASSERT(ne2 =
-0006b3f0: 3d20 6e65 6132 293b 0a0a 2020 2020 4747  = nea2);..    GG
-0006b400: 4d4c 5f41 5353 4552 5428 6e62 6130 2020  ML_ASSERT(nba0  
-0006b410: 3d3d 2073 697a 656f 6628 6767 6d6c 5f66  == sizeof(ggml_f
-0006b420: 7031 365f 7429 293b 0a20 2020 2047 474d  p16_t));.    GGM
-0006b430: 4c5f 4153 5345 5254 286e 6262 3030 203d  L_ASSERT(nbb00 =
-0006b440: 3d20 7369 7a65 6f66 2867 676d 6c5f 6670  = sizeof(ggml_fp
-0006b450: 3136 5f74 2929 3b0a 2020 2020 4747 4d4c  16_t));.    GGML
-0006b460: 5f41 5353 4552 5428 6e62 6231 3020 3d3d  _ASSERT(nbb10 ==
-0006b470: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-0006b480: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0006b490: 286e 6263 3030 203d 3d20 7369 7a65 6f66  (nbc00 == sizeof
-0006b4a0: 2867 676d 6c5f 6670 3136 5f74 2929 3b0a  (ggml_fp16_t));.
-0006b4b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0006b4c0: 6e62 6331 3020 3d3d 2073 697a 656f 6628  nbc10 == sizeof(
-0006b4d0: 666c 6f61 7429 293b 0a0a 2020 2020 4747  float));..    GG
-0006b4e0: 4d4c 5f41 5353 4552 5428 6e65 6230 3020  ML_ASSERT(neb00 
-0006b4f0: 3d3d 2044 293b 0a20 2020 2047 474d 4c5f  == D);.    GGML_
-0006b500: 4153 5345 5254 286e 6562 3031 203d 3d20  ASSERT(neb01 == 
-0006b510: 4d29 3b0a 2020 2020 4747 4d4c 5f41 5353  M);.    GGML_ASS
-0006b520: 4552 5428 6e65 6231 3020 3d3d 204d 293b  ERT(neb10 == M);
-0006b530: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0006b540: 286e 6562 3131 203d 3d20 3129 3b0a 0a20  (neb11 == 1);.. 
-0006b550: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0006b560: 6563 3030 203d 3d20 4d29 3b0a 2020 2020  ec00 == M);.    
-0006b570: 4747 4d4c 5f41 5353 4552 5428 6e65 6330  GGML_ASSERT(nec0
-0006b580: 3120 3d3d 2044 293b 0a20 2020 2047 474d  1 == D);.    GGM
-0006b590: 4c5f 4153 5345 5254 286e 6563 3130 203d  L_ASSERT(nec10 =
-0006b5a0: 3d20 4429 3b0a 2020 2020 4747 4d4c 5f41  = D);.    GGML_A
-0006b5b0: 5353 4552 5428 6e65 6331 3120 3d3d 2031  SSERT(nec11 == 1
-0006b5c0: 293b 0a0a 2020 2020 2f2f 2064 7374 2063  );..    // dst c
-0006b5d0: 616e 6e6f 7420 6265 2074 7261 6e73 706f  annot be transpo
-0006b5e0: 7365 6420 6f72 2070 6572 6d75 7465 640a  sed or permuted.
-0006b5f0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0006b600: 6e62 3020 3d3d 2073 697a 656f 6628 666c  nb0 == sizeof(fl
-0006b610: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
-0006b620: 4153 5345 5254 286e 6230 203c 3d20 6e62  ASSERT(nb0 <= nb
-0006b630: 3129 3b0a 2020 2020 4747 4d4c 5f41 5353  1);.    GGML_ASS
-0006b640: 4552 5428 6e62 3120 3c3d 206e 6232 293b  ERT(nb1 <= nb2);
-0006b650: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0006b660: 286e 6232 203c 3d20 6e62 3329 3b0a 0a20  (nb2 <= nb3);.. 
-0006b670: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0006b680: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0006b690: 5f49 4e49 5429 207b 0a20 2020 2020 2020  _INIT) {.       
-0006b6a0: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-0006b6b0: 2020 2020 6966 2028 7061 7261 6d73 2d3e      if (params->
-0006b6c0: 7479 7065 203d 3d20 4747 4d4c 5f54 4153  type == GGML_TAS
-0006b6d0: 4b5f 4649 4e41 4c49 5a45 2920 7b0a 2020  K_FINALIZE) {.  
-0006b6e0: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
-0006b6f0: 2020 7d0a 0a20 2020 202f 2f20 7061 7261    }..    // para
-0006b700: 6c6c 656c 697a 6520 6279 2061 2072 6f77  llelize by a row
-0006b710: 7320 7573 696e 6720 6767 6d6c 5f76 6563  s using ggml_vec
-0006b720: 5f64 6f74 5f66 3332 0a0a 2020 2020 2f2f  _dot_f32..    //
-0006b730: 2074 6f74 616c 2072 6f77 7320 696e 2061   total rows in a
-0006b740: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
-0006b750: 7220 3d20 6e65 6131 2a6e 6561 322a 6e65  r = nea1*nea2*ne
-0006b760: 6133 3b0a 0a20 2020 202f 2f20 726f 7773  a3;..    // rows
-0006b770: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
-0006b780: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
-0006b790: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
-0006b7a0: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
-0006b7b0: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
-0006b7c0: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
-0006b7d0: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
-0006b7e0: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
-0006b7f0: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
-0006b800: 722c 206e 7229 3b0a 0a20 2020 2066 6f72  r, nr);..    for
-0006b810: 2028 696e 7420 6972 203d 2069 7230 3b20   (int ir = ir0; 
-0006b820: 6972 203c 2069 7231 3b20 2b2b 6972 2920  ir < ir1; ++ir) 
-0006b830: 7b0a 2020 2020 2020 2020 2f2f 2061 2069  {.        // a i
-0006b840: 6e64 6963 6573 0a20 2020 2020 2020 2063  ndices.        c
-0006b850: 6f6e 7374 2069 6e74 2069 6133 203d 2069  onst int ia3 = i
-0006b860: 722f 286e 6561 322a 6e65 6131 293b 0a20  r/(nea2*nea1);. 
-0006b870: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0006b880: 2069 6132 203d 2028 6972 202d 2069 6133   ia2 = (ir - ia3
-0006b890: 2a6e 6561 322a 6e65 6131 292f 6e65 6131  *nea2*nea1)/nea1
-0006b8a0: 3b0a 2020 2020 2020 2020 636f 6e73 7420  ;.        const 
-0006b8b0: 696e 7420 6961 3120 3d20 2869 7220 2d20  int ia1 = (ir - 
-0006b8c0: 6961 332a 6e65 6132 2a6e 6561 3120 2d20  ia3*nea2*nea1 - 
-0006b8d0: 6961 322a 6e65 6131 293b 0a0a 2020 2020  ia2*nea1);..    
-0006b8e0: 2020 2020 666c 6f61 7420 2a20 5320 3d20      float * S = 
-0006b8f0: 2866 6c6f 6174 202a 2920 7061 7261 6d73  (float *) params
-0006b900: 2d3e 7764 6174 6120 2b20 6974 682a 2832  ->wdata + ith*(2
-0006b910: 2a4d 202b 2043 4143 4845 5f4c 494e 455f  *M + CACHE_LINE_
-0006b920: 5349 5a45 5f46 3332 293b 0a0a 2020 2020  SIZE_F32);..    
-0006b930: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
-0006b940: 2069 6320 3d20 303b 2069 6320 3c20 6e65   ic = 0; ic < ne
-0006b950: 6230 313b 202b 2b69 6329 207b 0a20 2020  b01; ++ic) {.   
-0006b960: 2020 2020 2020 2020 202f 2f20 6230 2069           // b0 i
-0006b970: 6e64 6963 6573 0a20 2020 2020 2020 2020  ndices.         
-0006b980: 2020 2063 6f6e 7374 2069 6e74 2069 6230     const int ib0
-0006b990: 3320 3d20 6961 333b 0a20 2020 2020 2020  3 = ia3;.       
-0006b9a0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-0006b9b0: 6230 3220 3d20 6961 323b 0a20 2020 2020  b02 = ia2;.     
-0006b9c0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-0006b9d0: 2069 6230 3120 3d20 6963 3b0a 0a20 2020   ib01 = ic;..   
-0006b9e0: 2020 2020 2020 2020 202f 2f20 5320 696e           // S in
-0006b9f0: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
-0006ba00: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
-0006ba10: 2069 6230 313b 0a0a 2020 2020 2020 2020   ib01;..        
-0006ba20: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
-0006ba30: 5f66 3136 286e 6561 302c 0a20 2020 2020  _f16(nea0,.     
-0006ba40: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-0006ba50: 202b 2069 312c 0a20 2020 2020 2020 2020   + i1,.         
-0006ba60: 2020 2020 2020 2020 2020 2028 6767 6d6c             (ggml
-0006ba70: 5f66 7031 365f 7420 2a29 2028 2863 6861  _fp16_t *) ((cha
-0006ba80: 7220 2a29 2062 302d 3e64 6174 6120 2b20  r *) b0->data + 
-0006ba90: 2869 6230 312a 6e62 6230 3120 2b20 6962  (ib01*nbb01 + ib
-0006baa0: 3032 2a6e 6262 3032 202b 2069 6230 332a  02*nbb02 + ib03*
-0006bab0: 6e62 6230 3329 292c 0a20 2020 2020 2020  nbb03)),.       
+0006aa10: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+0006aa20: 2828 6368 6172 202a 2920 762d 3e64 6174  ((char *) v->dat
+0006aa30: 6120 2020 2b20 2820 2020 2020 2020 2020  a   + (         
+0006aa40: 6963 2a6e 6276 3120 2b20 6932 2a6e 6276  ic*nbv1 + i2*nbv
+0006aa50: 3220 2b20 6933 2a6e 6276 3329 292c 0a20  2 + i3*nbv3)),. 
+0006aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006aa70: 2020 2020 2020 2053 3136 293b 0a20 2020         S16);.   
+0006aa80: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0006aa90: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0006aaa0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0006aab0: 3634 5f74 2069 6320 3d20 303b 2069 6320  64_t ic = 0; ic 
+0006aac0: 3c20 6e65 7631 3b20 6963 202b 3d20 4747  < nev1; ic += GG
+0006aad0: 4d4c 5f56 4543 5f44 4f54 5f55 4e52 4f4c  ML_VEC_DOT_UNROL
+0006aae0: 4c29 207b 0a20 2020 2020 2020 2020 2020  L) {.           
+0006aaf0: 2020 2020 202f 2f20 6473 7420 696e 6469       // dst indi
+0006ab00: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+0006ab10: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
+0006ab20: 203d 2069 7131 3b0a 2020 2020 2020 2020   = iq1;.        
+0006ab30: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0006ab40: 7420 6932 203d 2069 7132 3b0a 2020 2020  t i2 = iq2;.    
+0006ab50: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0006ab60: 7420 696e 7420 6933 203d 2069 7133 3b0a  t int i3 = iq3;.
+0006ab70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006ab80: 2067 676d 6c5f 7665 635f 646f 745f 6631   ggml_vec_dot_f1
+0006ab90: 365f 756e 726f 6c6c 286e 656b 312c 206e  6_unroll(nek1, n
+0006aba0: 6276 312c 0a20 2020 2020 2020 2020 2020  bv1,.           
+0006abb0: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
+0006abc0: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0006abd0: 2064 7374 2d3e 6461 7461 202b 2028 6963   dst->data + (ic
+0006abe0: 2a6e 6230 202b 2069 312a 6e62 3120 202b  *nb0 + i1*nb1  +
+0006abf0: 2069 322a 6e62 3220 202b 2069 332a 6e62   i2*nb2  + i3*nb
+0006ac00: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
+0006ac10: 2020 2020 2020 2020 2020 2020 2028 2863               ((c
+0006ac20: 6861 7220 2a29 2076 2d3e 6461 7461 2020  har *) v->data  
+0006ac30: 202b 2028 2020 2020 2020 2020 2069 632a   + (         ic*
+0006ac40: 6e62 7631 202b 2069 322a 6e62 7632 202b  nbv1 + i2*nbv2 +
+0006ac50: 2069 332a 6e62 7633 2929 2c0a 2020 2020   i3*nbv3)),.    
+0006ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ac70: 2020 2020 5331 3629 3b0a 2020 2020 2020      S16);.      
+0006ac80: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0006ac90: 7d0a 2020 2020 7d0a 7d0a 0a73 7461 7469  }.    }.}..stati
+0006aca0: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
+0006acb0: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
+0006acc0: 685f 6174 746e 280a 2020 2020 2020 2020  h_attn(.        
+0006acd0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0006ace0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+0006acf0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+0006ad00: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0006ad10: 6767 6d6c 5f74 656e 736f 7220 2a20 712c  ggml_tensor * q,
+0006ad20: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0006ad30: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0006ad40: 7220 2a20 6b2c 0a20 2020 2020 2020 2063  r * k,.        c
+0006ad50: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+0006ad60: 5f74 656e 736f 7220 2a20 762c 0a20 2020  _tensor * v,.   
+0006ad70: 2020 2020 2063 6f6e 7374 2062 6f6f 6c20       const bool 
+0006ad80: 6d61 736b 6564 2c0a 2020 2020 2020 2020  masked,.        
+0006ad90: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0006ada0: 6f72 202a 2064 7374 2920 7b0a 2020 2020  or * dst) {.    
+0006adb0: 7377 6974 6368 2028 712d 3e74 7970 6529  switch (q->type)
+0006adc0: 207b 0a20 2020 2020 2020 2063 6173 6520   {.        case 
+0006add0: 4747 4d4c 5f54 5950 455f 4631 363a 0a20  GGML_TYPE_F16:. 
+0006ade0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0006adf0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006ae00: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0006ae10: 645f 666c 6173 685f 6174 746e 5f66 3136  d_flash_attn_f16
+0006ae20: 2870 6172 616d 732c 2071 2c20 6b2c 2076  (params, q, k, v
+0006ae30: 2c20 6d61 736b 6564 2c20 6473 7429 3b0a  , masked, dst);.
+0006ae40: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0006ae50: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0006ae60: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
+0006ae70: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0006ae80: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006ae90: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+0006aea0: 6172 645f 666c 6173 685f 6174 746e 5f66  ard_flash_attn_f
+0006aeb0: 3332 2870 6172 616d 732c 2071 2c20 6b2c  32(params, q, k,
+0006aec0: 2076 2c20 6d61 736b 6564 2c20 6473 7429   v, masked, dst)
+0006aed0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+0006aee0: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
+0006aef0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
+0006af00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0006af10: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0006af20: 5428 6661 6c73 6529 3b0a 2020 2020 2020  T(false);.      
+0006af30: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0006af40: 2020 207d 0a7d 0a0a 2f2f 2067 676d 6c5f     }.}..// ggml_
+0006af50: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+0006af60: 666c 6173 685f 6666 0a0a 7374 6174 6963  flash_ff..static
+0006af70: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+0006af80: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
+0006af90: 5f66 665f 6631 3628 0a20 2020 2020 2020  _ff_f16(.       
+0006afa0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0006afb0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+0006afc0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+0006afd0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0006afe0: 2067 676d 6c5f 7465 6e73 6f72 202a 2061   ggml_tensor * a
+0006aff0: 2c20 202f 2f20 4631 360a 2020 2020 2020  ,  // F16.      
+0006b000: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0006b010: 676d 6c5f 7465 6e73 6f72 202a 2062 302c  gml_tensor * b0,
+0006b020: 202f 2f20 4631 3620 6663 5f77 0a20 2020   // F16 fc_w.   
+0006b030: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0006b040: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0006b050: 6231 2c20 2f2f 2046 3332 2066 635f 620a  b1, // F32 fc_b.
+0006b060: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0006b070: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0006b080: 202a 2063 302c 202f 2f20 4631 3620 7072   * c0, // F16 pr
+0006b090: 6f6a 5f77 0a20 2020 2020 2020 2063 6f6e  oj_w.        con
+0006b0a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0006b0b0: 656e 736f 7220 2a20 6331 2c20 2f2f 2046  ensor * c1, // F
+0006b0c0: 3332 2070 726f 6a5f 620a 2020 2020 2020  32 proj_b.      
+0006b0d0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0006b0e0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
+0006b0f0: 2020 696e 7436 345f 7420 7430 203d 2067    int64_t t0 = g
+0006b100: 676d 6c5f 7065 7266 5f74 696d 655f 7573  gml_perf_time_us
+0006b110: 2829 3b0a 2020 2020 554e 5553 4544 2874  ();.    UNUSED(t
+0006b120: 3029 3b0a 0a20 2020 2047 474d 4c5f 5445  0);..    GGML_TE
+0006b130: 4e53 4f52 5f4c 4f43 414c 5328 696e 7436  NSOR_LOCALS(int6
+0006b140: 345f 742c 206e 6561 2c20 2061 2c20 2020  4_t, nea,  a,   
+0006b150: 6e65 293b 0a20 2020 2047 474d 4c5f 5445  ne);.    GGML_TE
+0006b160: 4e53 4f52 5f4c 4f43 414c 5328 7369 7a65  NSOR_LOCALS(size
+0006b170: 5f74 2c20 206e 6261 2c20 2061 2c20 2020  _t,  nba,  a,   
+0006b180: 6e62 293b 0a20 2020 2047 474d 4c5f 5445  nb);.    GGML_TE
+0006b190: 4e53 4f52 5f4c 4f43 414c 5328 696e 7436  NSOR_LOCALS(int6
+0006b1a0: 345f 742c 206e 6562 302c 2062 302c 2020  4_t, neb0, b0,  
+0006b1b0: 6e65 293b 0a20 2020 2047 474d 4c5f 5445  ne);.    GGML_TE
+0006b1c0: 4e53 4f52 5f4c 4f43 414c 5328 7369 7a65  NSOR_LOCALS(size
+0006b1d0: 5f74 2c20 206e 6262 302c 2062 302c 2020  _t,  nbb0, b0,  
+0006b1e0: 6e62 293b 0a20 2020 2047 474d 4c5f 5445  nb);.    GGML_TE
+0006b1f0: 4e53 4f52 5f4c 4f43 414c 5328 696e 7436  NSOR_LOCALS(int6
+0006b200: 345f 742c 206e 6562 312c 2062 312c 2020  4_t, neb1, b1,  
+0006b210: 6e65 293b 0a20 2020 2047 474d 4c5f 5445  ne);.    GGML_TE
+0006b220: 4e53 4f52 5f4c 4f43 414c 5328 7369 7a65  NSOR_LOCALS(size
+0006b230: 5f74 2c20 206e 6262 312c 2062 312c 2020  _t,  nbb1, b1,  
+0006b240: 6e62 293b 0a20 2020 2047 474d 4c5f 5445  nb);.    GGML_TE
+0006b250: 4e53 4f52 5f4c 4f43 414c 5328 696e 7436  NSOR_LOCALS(int6
+0006b260: 345f 742c 206e 6563 302c 2063 302c 2020  4_t, nec0, c0,  
+0006b270: 6e65 293b 0a20 2020 2047 474d 4c5f 5445  ne);.    GGML_TE
+0006b280: 4e53 4f52 5f4c 4f43 414c 5328 7369 7a65  NSOR_LOCALS(size
+0006b290: 5f74 2c20 206e 6263 302c 2063 302c 2020  _t,  nbc0, c0,  
+0006b2a0: 6e62 293b 0a20 2020 2047 474d 4c5f 5445  nb);.    GGML_TE
+0006b2b0: 4e53 4f52 5f4c 4f43 414c 5328 696e 7436  NSOR_LOCALS(int6
+0006b2c0: 345f 742c 206e 6563 312c 2063 312c 2020  4_t, nec1, c1,  
+0006b2d0: 6e65 293b 0a20 2020 2047 474d 4c5f 5445  ne);.    GGML_TE
+0006b2e0: 4e53 4f52 5f4c 4f43 414c 5328 7369 7a65  NSOR_LOCALS(size
+0006b2f0: 5f74 2c20 206e 6263 312c 2063 312c 2020  _t,  nbc1, c1,  
+0006b300: 6e62 293b 0a20 2020 2047 474d 4c5f 5445  nb);.    GGML_TE
+0006b310: 4e53 4f52 5f4c 4f43 414c 5328 696e 7436  NSOR_LOCALS(int6
+0006b320: 345f 742c 206e 652c 2020 2064 7374 2c20  4_t, ne,   dst, 
+0006b330: 6e65 293b 0a20 2020 2047 474d 4c5f 5445  ne);.    GGML_TE
+0006b340: 4e53 4f52 5f4c 4f43 414c 5328 7369 7a65  NSOR_LOCALS(size
+0006b350: 5f74 2c20 206e 622c 2020 2064 7374 2c20  _t,  nb,   dst, 
+0006b360: 6e62 293b 0a0a 2020 2020 636f 6e73 7420  nb);..    const 
+0006b370: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
+0006b380: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
+0006b390: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
+0006b3a0: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
+0006b3b0: 7374 2069 6e74 3634 5f74 2044 203d 206e  st int64_t D = n
+0006b3c0: 6561 303b 0a20 2020 202f 2f63 6f6e 7374  ea0;.    //const
+0006b3d0: 2069 6e74 3634 5f74 204e 203d 206e 6561   int64_t N = nea
+0006b3e0: 313b 0a20 2020 2063 6f6e 7374 2069 6e74  1;.    const int
+0006b3f0: 3634 5f74 204d 203d 206e 6562 3031 3b0a  64_t M = neb01;.
+0006b400: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0006b410: 286e 6530 203d 3d20 6e65 6130 293b 0a20  (ne0 == nea0);. 
+0006b420: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
+0006b430: 6531 203d 3d20 6e65 6131 293b 0a20 2020  e1 == nea1);.   
+0006b440: 2047 474d 4c5f 4153 5345 5254 286e 6532   GGML_ASSERT(ne2
+0006b450: 203d 3d20 6e65 6132 293b 0a0a 2020 2020   == nea2);..    
+0006b460: 4747 4d4c 5f41 5353 4552 5428 6e62 6130  GGML_ASSERT(nba0
+0006b470: 2020 3d3d 2073 697a 656f 6628 6767 6d6c    == sizeof(ggml
+0006b480: 5f66 7031 365f 7429 293b 0a20 2020 2047  _fp16_t));.    G
+0006b490: 474d 4c5f 4153 5345 5254 286e 6262 3030  GML_ASSERT(nbb00
+0006b4a0: 203d 3d20 7369 7a65 6f66 2867 676d 6c5f   == sizeof(ggml_
+0006b4b0: 6670 3136 5f74 2929 3b0a 2020 2020 4747  fp16_t));.    GG
+0006b4c0: 4d4c 5f41 5353 4552 5428 6e62 6231 3020  ML_ASSERT(nbb10 
+0006b4d0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+0006b4e0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0006b4f0: 5254 286e 6263 3030 203d 3d20 7369 7a65  RT(nbc00 == size
+0006b500: 6f66 2867 676d 6c5f 6670 3136 5f74 2929  of(ggml_fp16_t))
+0006b510: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0006b520: 5428 6e62 6331 3020 3d3d 2073 697a 656f  T(nbc10 == sizeo
+0006b530: 6628 666c 6f61 7429 293b 0a0a 2020 2020  f(float));..    
+0006b540: 4747 4d4c 5f41 5353 4552 5428 6e65 6230  GGML_ASSERT(neb0
+0006b550: 3020 3d3d 2044 293b 0a20 2020 2047 474d  0 == D);.    GGM
+0006b560: 4c5f 4153 5345 5254 286e 6562 3031 203d  L_ASSERT(neb01 =
+0006b570: 3d20 4d29 3b0a 2020 2020 4747 4d4c 5f41  = M);.    GGML_A
+0006b580: 5353 4552 5428 6e65 6231 3020 3d3d 204d  SSERT(neb10 == M
+0006b590: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0006b5a0: 5254 286e 6562 3131 203d 3d20 3129 3b0a  RT(neb11 == 1);.
+0006b5b0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0006b5c0: 286e 6563 3030 203d 3d20 4d29 3b0a 2020  (nec00 == M);.  
+0006b5d0: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+0006b5e0: 6330 3120 3d3d 2044 293b 0a20 2020 2047  c01 == D);.    G
+0006b5f0: 474d 4c5f 4153 5345 5254 286e 6563 3130  GML_ASSERT(nec10
+0006b600: 203d 3d20 4429 3b0a 2020 2020 4747 4d4c   == D);.    GGML
+0006b610: 5f41 5353 4552 5428 6e65 6331 3120 3d3d  _ASSERT(nec11 ==
+0006b620: 2031 293b 0a0a 2020 2020 2f2f 2064 7374   1);..    // dst
+0006b630: 2063 616e 6e6f 7420 6265 2074 7261 6e73   cannot be trans
+0006b640: 706f 7365 6420 6f72 2070 6572 6d75 7465  posed or permute
+0006b650: 640a 2020 2020 4747 4d4c 5f41 5353 4552  d.    GGML_ASSER
+0006b660: 5428 6e62 3020 3d3d 2073 697a 656f 6628  T(nb0 == sizeof(
+0006b670: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
+0006b680: 4c5f 4153 5345 5254 286e 6230 203c 3d20  L_ASSERT(nb0 <= 
+0006b690: 6e62 3129 3b0a 2020 2020 4747 4d4c 5f41  nb1);.    GGML_A
+0006b6a0: 5353 4552 5428 6e62 3120 3c3d 206e 6232  SSERT(nb1 <= nb2
+0006b6b0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0006b6c0: 5254 286e 6232 203c 3d20 6e62 3329 3b0a  RT(nb2 <= nb3);.
+0006b6d0: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+0006b6e0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0006b6f0: 534b 5f49 4e49 5429 207b 0a20 2020 2020  SK_INIT) {.     
+0006b700: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+0006b710: 0a0a 2020 2020 6966 2028 7061 7261 6d73  ..    if (params
+0006b720: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+0006b730: 4153 4b5f 4649 4e41 4c49 5a45 2920 7b0a  ASK_FINALIZE) {.
+0006b740: 2020 2020 2020 2020 7265 7475 726e 3b0a          return;.
+0006b750: 2020 2020 7d0a 0a20 2020 202f 2f20 7061      }..    // pa
+0006b760: 7261 6c6c 656c 697a 6520 6279 2061 2072  rallelize by a r
+0006b770: 6f77 7320 7573 696e 6720 6767 6d6c 5f76  ows using ggml_v
+0006b780: 6563 5f64 6f74 5f66 3332 0a0a 2020 2020  ec_dot_f32..    
+0006b790: 2f2f 2074 6f74 616c 2072 6f77 7320 696e  // total rows in
+0006b7a0: 2061 0a20 2020 2063 6f6e 7374 2069 6e74   a.    const int
+0006b7b0: 206e 7220 3d20 6e65 6131 2a6e 6561 322a   nr = nea1*nea2*
+0006b7c0: 6e65 6133 3b0a 0a20 2020 202f 2f20 726f  nea3;..    // ro
+0006b7d0: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
+0006b7e0: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
+0006b7f0: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
+0006b800: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
+0006b810: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
+0006b820: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
+0006b830: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
+0006b840: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+0006b850: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
+0006b860: 2064 722c 206e 7229 3b0a 0a20 2020 2066   dr, nr);..    f
+0006b870: 6f72 2028 696e 7420 6972 203d 2069 7230  or (int ir = ir0
+0006b880: 3b20 6972 203c 2069 7231 3b20 2b2b 6972  ; ir < ir1; ++ir
+0006b890: 2920 7b0a 2020 2020 2020 2020 2f2f 2061  ) {.        // a
+0006b8a0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+0006b8b0: 2063 6f6e 7374 2069 6e74 2069 6133 203d   const int ia3 =
+0006b8c0: 2069 722f 286e 6561 322a 6e65 6131 293b   ir/(nea2*nea1);
+0006b8d0: 0a20 2020 2020 2020 2063 6f6e 7374 2069  .        const i
+0006b8e0: 6e74 2069 6132 203d 2028 6972 202d 2069  nt ia2 = (ir - i
+0006b8f0: 6133 2a6e 6561 322a 6e65 6131 292f 6e65  a3*nea2*nea1)/ne
+0006b900: 6131 3b0a 2020 2020 2020 2020 636f 6e73  a1;.        cons
+0006b910: 7420 696e 7420 6961 3120 3d20 2869 7220  t int ia1 = (ir 
+0006b920: 2d20 6961 332a 6e65 6132 2a6e 6561 3120  - ia3*nea2*nea1 
+0006b930: 2d20 6961 322a 6e65 6131 293b 0a0a 2020  - ia2*nea1);..  
+0006b940: 2020 2020 2020 666c 6f61 7420 2a20 5320        float * S 
+0006b950: 3d20 2866 6c6f 6174 202a 2920 7061 7261  = (float *) para
+0006b960: 6d73 2d3e 7764 6174 6120 2b20 6974 682a  ms->wdata + ith*
+0006b970: 2832 2a4d 202b 2043 4143 4845 5f4c 494e  (2*M + CACHE_LIN
+0006b980: 455f 5349 5a45 5f46 3332 293b 0a0a 2020  E_SIZE_F32);..  
+0006b990: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
+0006b9a0: 5f74 2069 6320 3d20 303b 2069 6320 3c20  _t ic = 0; ic < 
+0006b9b0: 6e65 6230 313b 202b 2b69 6329 207b 0a20  neb01; ++ic) {. 
+0006b9c0: 2020 2020 2020 2020 2020 202f 2f20 6230             // b0
+0006b9d0: 2069 6e64 6963 6573 0a20 2020 2020 2020   indices.       
+0006b9e0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0006b9f0: 6230 3320 3d20 6961 333b 0a20 2020 2020  b03 = ia3;.     
+0006ba00: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0006ba10: 2069 6230 3220 3d20 6961 323b 0a20 2020   ib02 = ia2;.   
+0006ba20: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+0006ba30: 6e74 2069 6230 3120 3d20 6963 3b0a 0a20  nt ib01 = ic;.. 
+0006ba40: 2020 2020 2020 2020 2020 202f 2f20 5320             // S 
+0006ba50: 696e 6469 6365 730a 2020 2020 2020 2020  indices.        
+0006ba60: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
+0006ba70: 203d 2069 6230 313b 0a0a 2020 2020 2020   = ib01;..      
+0006ba80: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+0006ba90: 6f74 5f66 3136 286e 6561 302c 0a20 2020  ot_f16(nea0,.   
+0006baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bab0: 2053 202b 2069 312c 0a20 2020 2020 2020   S + i1,.       
 0006bac0: 2020 2020 2020 2020 2020 2020 2028 6767               (gg
 0006bad0: 6d6c 5f66 7031 365f 7420 2a29 2028 2863  ml_fp16_t *) ((c
-0006bae0: 6861 7220 2a29 2020 612d 3e64 6174 6120  har *)  a->data 
-0006baf0: 2b20 2820 6961 312a 6e62 6131 2020 2b20  + ( ia1*nba1  + 
-0006bb00: 2069 6132 2a6e 6261 3220 202b 2020 6961   ia2*nba2  +  ia
-0006bb10: 332a 6e62 6133 2929 293b 0a20 2020 2020  3*nba3)));.     
-0006bb20: 2020 207d 0a0a 2020 2020 2020 2020 6767     }..        gg
-0006bb30: 6d6c 5f76 6563 5f61 6464 5f66 3332 286e  ml_vec_add_f32(n
-0006bb40: 6562 3031 2c20 532c 2053 2c20 2866 6c6f  eb01, S, S, (flo
-0006bb50: 6174 202a 2920 6231 2d3e 6461 7461 293b  at *) b1->data);
-0006bb60: 0a20 2020 2020 2020 202f 2f67 676d 6c5f  .        //ggml_
-0006bb70: 7665 635f 6765 6c75 5f66 3332 286e 6562  vec_gelu_f32(neb
-0006bb80: 3031 2c20 532c 2053 293b 0a0a 2020 2020  01, S, S);..    
-0006bb90: 2020 2020 6767 6d6c 5f66 7031 365f 7420      ggml_fp16_t 
-0006bba0: 2a20 5331 3620 3d20 2867 676d 6c5f 6670  * S16 = (ggml_fp
-0006bbb0: 3136 5f74 202a 2920 2828 666c 6f61 7420  16_t *) ((float 
-0006bbc0: 2a29 2070 6172 616d 732d 3e77 6461 7461  *) params->wdata
-0006bbd0: 202b 2069 7468 2a28 322a 4d20 2b20 4341   + ith*(2*M + CA
-0006bbe0: 4348 455f 4c49 4e45 5f53 495a 455f 4633  CHE_LINE_SIZE_F3
-0006bbf0: 3229 202b 204d 293b 0a0a 2020 2020 2020  2) + M);..      
-0006bc00: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
-0006bc10: 203d 2030 3b20 6920 3c20 4d3b 2069 2b2b   = 0; i < M; i++
-0006bc20: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0006bc30: 5331 365b 695d 203d 2047 474d 4c5f 4650  S16[i] = GGML_FP
-0006bc40: 3332 5f54 4f5f 4650 3136 2853 5b69 5d29  32_TO_FP16(S[i])
-0006bc50: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-0006bc60: 2020 2020 2067 676d 6c5f 7665 635f 6765       ggml_vec_ge
-0006bc70: 6c75 5f66 3136 286e 6562 3031 2c20 5331  lu_f16(neb01, S1
-0006bc80: 362c 2053 3136 293b 0a0a 2020 2020 2020  6, S16);..      
-0006bc90: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0006bca0: 2f2f 2064 7374 2069 6e64 6963 6573 0a20  // dst indices. 
-0006bcb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006bcc0: 2069 6e74 2069 3120 3d20 6961 313b 0a20   int i1 = ia1;. 
-0006bcd0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006bce0: 2069 6e74 2069 3220 3d20 6961 323b 0a20   int i2 = ia2;. 
-0006bcf0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006bd00: 2069 6e74 2069 3320 3d20 6961 333b 0a0a   int i3 = ia3;..
-0006bd10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0006bd20: 2869 6e74 3634 5f74 2069 6320 3d20 303b  (int64_t ic = 0;
-0006bd30: 2069 6320 3c20 6e65 6330 313b 202b 2b69   ic < nec01; ++i
-0006bd40: 6329 207b 0a0a 2020 2020 2020 2020 2020  c) {..          
-0006bd50: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
-0006bd60: 6f74 5f66 3136 286e 6562 3031 2c0a 2020  ot_f16(neb01,.  
-0006bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006bd80: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-0006bd90: 2020 2020 2020 2828 6368 6172 202a 2920        ((char *) 
-0006bda0: 6473 742d 3e64 6174 6120 2b20 2869 632a  dst->data + (ic*
-0006bdb0: 6e62 3020 2b20 6931 2a6e 6231 2020 202b  nb0 + i1*nb1   +
-0006bdc0: 2069 322a 6e62 3220 2020 2b20 6933 2a6e   i2*nb2   + i3*n
-0006bdd0: 6233 2929 2c0a 2020 2020 2020 2020 2020  b3)),.          
-0006bde0: 2020 2020 2020 2020 2020 2020 2020 2867                (g
-0006bdf0: 676d 6c5f 6670 3136 5f74 202a 2920 2828  gml_fp16_t *) ((
-0006be00: 6368 6172 202a 2920 6330 2d3e 6461 7461  char *) c0->data
-0006be10: 2020 2b20 2820 2020 2020 2020 2020 6963    + (         ic
-0006be20: 2a6e 6263 3031 202b 2069 322a 6e62 6330  *nbc01 + i2*nbc0
-0006be30: 3220 2b20 6933 2a6e 6263 3033 2929 2c0a  2 + i3*nbc03)),.
+0006bae0: 6861 7220 2a29 2062 302d 3e64 6174 6120  har *) b0->data 
+0006baf0: 2b20 2869 6230 312a 6e62 6230 3120 2b20  + (ib01*nbb01 + 
+0006bb00: 6962 3032 2a6e 6262 3032 202b 2069 6230  ib02*nbb02 + ib0
+0006bb10: 332a 6e62 6230 3329 292c 0a20 2020 2020  3*nbb03)),.     
+0006bb20: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0006bb30: 6767 6d6c 5f66 7031 365f 7420 2a29 2028  ggml_fp16_t *) (
+0006bb40: 2863 6861 7220 2a29 2020 612d 3e64 6174  (char *)  a->dat
+0006bb50: 6120 2b20 2820 6961 312a 6e62 6131 2020  a + ( ia1*nba1  
+0006bb60: 2b20 2069 6132 2a6e 6261 3220 202b 2020  +  ia2*nba2  +  
+0006bb70: 6961 332a 6e62 6133 2929 293b 0a20 2020  ia3*nba3)));.   
+0006bb80: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0006bb90: 6767 6d6c 5f76 6563 5f61 6464 5f66 3332  ggml_vec_add_f32
+0006bba0: 286e 6562 3031 2c20 532c 2053 2c20 2866  (neb01, S, S, (f
+0006bbb0: 6c6f 6174 202a 2920 6231 2d3e 6461 7461  loat *) b1->data
+0006bbc0: 293b 0a20 2020 2020 2020 202f 2f67 676d  );.        //ggm
+0006bbd0: 6c5f 7665 635f 6765 6c75 5f66 3332 286e  l_vec_gelu_f32(n
+0006bbe0: 6562 3031 2c20 532c 2053 293b 0a0a 2020  eb01, S, S);..  
+0006bbf0: 2020 2020 2020 6767 6d6c 5f66 7031 365f        ggml_fp16_
+0006bc00: 7420 2a20 5331 3620 3d20 2867 676d 6c5f  t * S16 = (ggml_
+0006bc10: 6670 3136 5f74 202a 2920 2828 666c 6f61  fp16_t *) ((floa
+0006bc20: 7420 2a29 2070 6172 616d 732d 3e77 6461  t *) params->wda
+0006bc30: 7461 202b 2069 7468 2a28 322a 4d20 2b20  ta + ith*(2*M + 
+0006bc40: 4341 4348 455f 4c49 4e45 5f53 495a 455f  CACHE_LINE_SIZE_
+0006bc50: 4633 3229 202b 204d 293b 0a0a 2020 2020  F32) + M);..    
+0006bc60: 2020 2020 666f 7220 2869 6e74 3634 5f74      for (int64_t
+0006bc70: 2069 203d 2030 3b20 6920 3c20 4d3b 2069   i = 0; i < M; i
+0006bc80: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
+0006bc90: 2020 5331 365b 695d 203d 2047 474d 4c5f    S16[i] = GGML_
+0006bca0: 4650 3332 5f54 4f5f 4650 3136 2853 5b69  FP32_TO_FP16(S[i
+0006bcb0: 5d29 3b0a 2020 2020 2020 2020 7d0a 0a20  ]);.        }.. 
+0006bcc0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0006bcd0: 6765 6c75 5f66 3136 286e 6562 3031 2c20  gelu_f16(neb01, 
+0006bce0: 5331 362c 2053 3136 293b 0a0a 2020 2020  S16, S16);..    
+0006bcf0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0006bd00: 2020 2f2f 2064 7374 2069 6e64 6963 6573    // dst indices
+0006bd10: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0006bd20: 7374 2069 6e74 2069 3120 3d20 6961 313b  st int i1 = ia1;
+0006bd30: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0006bd40: 7374 2069 6e74 2069 3220 3d20 6961 323b  st int i2 = ia2;
+0006bd50: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0006bd60: 7374 2069 6e74 2069 3320 3d20 6961 333b  st int i3 = ia3;
+0006bd70: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0006bd80: 7220 2869 6e74 3634 5f74 2069 6320 3d20  r (int64_t ic = 
+0006bd90: 303b 2069 6320 3c20 6e65 6330 313b 202b  0; ic < nec01; +
+0006bda0: 2b69 6329 207b 0a0a 2020 2020 2020 2020  +ic) {..        
+0006bdb0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0006bdc0: 5f64 6f74 5f66 3136 286e 6562 3031 2c0a  _dot_f16(neb01,.
+0006bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006bde0: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+0006bdf0: 2920 2020 2020 2020 2828 6368 6172 202a  )       ((char *
+0006be00: 2920 6473 742d 3e64 6174 6120 2b20 2869  ) dst->data + (i
+0006be10: 632a 6e62 3020 2b20 6931 2a6e 6231 2020  c*nb0 + i1*nb1  
+0006be20: 202b 2069 322a 6e62 3220 2020 2b20 6933   + i2*nb2   + i3
+0006be30: 2a6e 6233 2929 2c0a 2020 2020 2020 2020  *nb3)),.        
 0006be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006be50: 2020 2020 2020 2020 5331 3629 3b0a 2020          S16);.  
-0006be60: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0006be70: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0006be80: 635f 6164 645f 6633 3228 6e65 6330 312c  c_add_f32(nec01,
-0006be90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006bea0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-0006beb0: 2863 6861 7220 2a29 2064 7374 2d3e 6461  (char *) dst->da
-0006bec0: 7461 202b 2028 6931 2a6e 6231 202b 2069  ta + (i1*nb1 + i
-0006bed0: 322a 6e62 3220 2b20 6933 2a6e 6233 2929  2*nb2 + i3*nb3))
-0006bee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006bef0: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-0006bf00: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
-0006bf10: 6174 6120 2b20 2869 312a 6e62 3120 2b20  ata + (i1*nb1 + 
-0006bf20: 6932 2a6e 6232 202b 2069 332a 6e62 3329  i2*nb2 + i3*nb3)
-0006bf30: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0006bf40: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-0006bf50: 2063 312d 3e64 6174 6129 3b0a 2020 2020   c1->data);.    
-0006bf60: 2020 2020 7d0a 2020 2020 7d0a 7d0a 0a73      }.    }.}..s
-0006bf70: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-0006bf80: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-0006bf90: 666c 6173 685f 6666 280a 2020 2020 2020  flash_ff(.      
-0006bfa0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0006bfb0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-0006bfc0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-0006bfd0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0006bfe0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0006bff0: 612c 0a20 2020 2020 2020 2063 6f6e 7374  a,.        const
-0006c000: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0006c010: 736f 7220 2a20 6230 2c0a 2020 2020 2020  sor * b0,.      
-0006c020: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-0006c030: 676d 6c5f 7465 6e73 6f72 202a 2062 312c  gml_tensor * b1,
-0006c040: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0006c050: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0006c060: 7220 2a20 6330 2c0a 2020 2020 2020 2020  r * c0,.        
-0006c070: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0006c080: 6c5f 7465 6e73 6f72 202a 2063 312c 0a20  l_tensor * c1,. 
-0006c090: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0006c0a0: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0006c0b0: 207b 0a20 2020 2073 7769 7463 6820 2862   {.    switch (b
-0006c0c0: 302d 3e74 7970 6529 207b 0a20 2020 2020  0->type) {.     
-0006c0d0: 2020 2063 6173 6520 4747 4d4c 5f54 5950     case GGML_TYP
-0006c0e0: 455f 4631 363a 0a20 2020 2020 2020 2020  E_F16:.         
-0006c0f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0006c100: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-0006c110: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
-0006c120: 6666 5f66 3136 2870 6172 616d 732c 2061  ff_f16(params, a
-0006c130: 2c20 6230 2c20 6231 2c20 6330 2c20 6331  , b0, b1, c0, c1
-0006c140: 2c20 6473 7429 3b0a 2020 2020 2020 2020  , dst);.        
-0006c150: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0006c160: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-0006c170: 5950 455f 4633 323a 0a20 2020 2020 2020  YPE_F32:.       
-0006c180: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006c190: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0006c1a0: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
-0006c1b0: 444f 0a20 2020 2020 2020 2020 2020 207d  DO.            }
-0006c1c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0006c1d0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-0006c1e0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006c1f0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0006c200: 5254 2866 616c 7365 293b 0a20 2020 2020  RT(false);.     
-0006c210: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0006c220: 2020 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c      }.}..// ggml
-0006c230: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-0006c240: 5f66 6c61 7368 5f61 7474 6e5f 6261 636b  _flash_attn_back
-0006c250: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-0006c260: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-0006c270: 7264 5f66 6c61 7368 5f61 7474 6e5f 6261  rd_flash_attn_ba
-0006c280: 636b 5f66 3332 280a 2020 2020 2020 2020  ck_f32(.        
-0006c290: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0006c2a0: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
-0006c2b0: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
-0006c2c0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-0006c2d0: 6767 6d6c 5f74 656e 736f 7220 2a20 712c  ggml_tensor * q,
-0006c2e0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-0006c2f0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0006c300: 7220 2a20 6b2c 0a20 2020 2020 2020 2063  r * k,.        c
-0006c310: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0006c320: 5f74 656e 736f 7220 2a20 762c 0a20 2020  _tensor * v,.   
-0006c330: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-0006c340: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0006c350: 642c 0a20 2020 2020 2020 2063 6f6e 7374  d,.        const
-0006c360: 2062 6f6f 6c20 6d61 736b 6564 2c0a 2020   bool masked,.  
-0006c370: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-0006c380: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0006c390: 2064 7374 2920 7b0a 2020 2020 696e 7436   dst) {.    int6
-0006c3a0: 345f 7420 7430 203d 2067 676d 6c5f 7065  4_t t0 = ggml_pe
-0006c3b0: 7266 5f74 696d 655f 7573 2829 3b0a 2020  rf_time_us();.  
-0006c3c0: 2020 554e 5553 4544 2874 3029 3b0a 0a20    UNUSED(t0);.. 
-0006c3d0: 2020 2047 474d 4c5f 5445 4e53 4f52 5f4c     GGML_TENSOR_L
-0006c3e0: 4f43 414c 5328 696e 7436 345f 742c 206e  OCALS(int64_t, n
-0006c3f0: 6571 2c20 712c 2020 206e 6529 3b0a 2020  eq, q,   ne);.  
-0006c400: 2020 4747 4d4c 5f54 454e 534f 525f 4c4f    GGML_TENSOR_LO
-0006c410: 4341 4c53 2873 697a 655f 742c 2020 6e62  CALS(size_t,  nb
-0006c420: 712c 2071 2c20 2020 6e62 293b 0a20 2020  q, q,   nb);.   
-0006c430: 2047 474d 4c5f 5445 4e53 4f52 5f4c 4f43   GGML_TENSOR_LOC
-0006c440: 414c 5328 696e 7436 345f 742c 206e 656b  ALS(int64_t, nek
-0006c450: 2c20 6b2c 2020 206e 6529 3b0a 2020 2020  , k,   ne);.    
-0006c460: 4747 4d4c 5f54 454e 534f 525f 4c4f 4341  GGML_TENSOR_LOCA
-0006c470: 4c53 2873 697a 655f 742c 2020 6e62 6b2c  LS(size_t,  nbk,
-0006c480: 206b 2c20 2020 6e62 293b 0a20 2020 2047   k,   nb);.    G
-0006c490: 474d 4c5f 5445 4e53 4f52 5f4c 4f43 414c  GML_TENSOR_LOCAL
-0006c4a0: 5328 696e 7436 345f 742c 206e 6576 2c20  S(int64_t, nev, 
-0006c4b0: 762c 2020 206e 6529 3b0a 2020 2020 4747  v,   ne);.    GG
-0006c4c0: 4d4c 5f54 454e 534f 525f 4c4f 4341 4c53  ML_TENSOR_LOCALS
-0006c4d0: 2873 697a 655f 742c 2020 6e62 762c 2076  (size_t,  nbv, v
-0006c4e0: 2c20 2020 6e62 293b 0a20 2020 2047 474d  ,   nb);.    GGM
-0006c4f0: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
-0006c500: 696e 7436 345f 742c 206e 6564 2c20 642c  int64_t, ned, d,
-0006c510: 2020 206e 6529 3b0a 2020 2020 4747 4d4c     ne);.    GGML
-0006c520: 5f54 454e 534f 525f 4c4f 4341 4c53 2873  _TENSOR_LOCALS(s
-0006c530: 697a 655f 742c 2020 6e62 642c 2064 2c20  ize_t,  nbd, d, 
-0006c540: 2020 6e62 293b 0a20 2020 2047 474d 4c5f    nb);.    GGML_
-0006c550: 5445 4e53 4f52 5f4c 4f43 414c 5328 696e  TENSOR_LOCALS(in
-0006c560: 7436 345f 742c 206e 652c 2020 6473 742c  t64_t, ne,  dst,
-0006c570: 206e 6529 3b0a 2020 2020 4747 4d4c 5f54   ne);.    GGML_T
-0006c580: 454e 534f 525f 4c4f 4341 4c53 2873 697a  ENSOR_LOCALS(siz
-0006c590: 655f 742c 2020 6e62 2c20 2064 7374 2c20  e_t,  nb,  dst, 
-0006c5a0: 6e62 293b 0a0a 2020 2020 636f 6e73 7420  nb);..    const 
-0006c5b0: 696e 7420 6974 6820 3d20 7061 7261 6d73  int ith = params
-0006c5c0: 2d3e 6974 683b 0a20 2020 2063 6f6e 7374  ->ith;.    const
-0006c5d0: 2069 6e74 206e 7468 203d 2070 6172 616d   int nth = param
-0006c5e0: 732d 3e6e 7468 3b0a 0a20 2020 2063 6f6e  s->nth;..    con
-0006c5f0: 7374 2069 6e74 3634 5f74 2044 203d 206e  st int64_t D = n
-0006c600: 6571 303b 0a20 2020 2063 6f6e 7374 2069  eq0;.    const i
-0006c610: 6e74 3634 5f74 204e 203d 206e 6571 313b  nt64_t N = neq1;
-0006c620: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0006c630: 5f74 2050 203d 206e 656b 3120 2d20 4e3b  _t P = nek1 - N;
-0006c640: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-0006c650: 5f74 204d 203d 2050 202b 204e 3b0a 0a20  _t M = P + N;.. 
-0006c660: 2020 2063 6f6e 7374 2069 6e74 204d 7570     const int Mup
-0006c670: 2020 3d20 6767 6d6c 5f75 7028 4d2c 2047    = ggml_up(M, G
-0006c680: 474d 4c5f 534f 4654 5f4d 4158 5f55 4e52  GML_SOFT_MAX_UNR
-0006c690: 4f4c 4c29 3b0a 2020 2020 636f 6e73 7420  OLL);.    const 
-0006c6a0: 696e 7420 6d78 444d 203d 204d 4158 2844  int mxDM = MAX(D
-0006c6b0: 2c20 4d75 7029 3b0a 0a20 2020 202f 2f20  , Mup);..    // 
-0006c6c0: 4747 4d4c 5f41 5353 4552 5428 6e65 3020  GGML_ASSERT(ne0 
-0006c6d0: 3d3d 2044 293b 0a20 2020 202f 2f20 4747  == D);.    // GG
-0006c6e0: 4d4c 5f41 5353 4552 5428 6e65 3120 3d3d  ML_ASSERT(ne1 ==
-0006c6f0: 204e 293b 0a20 2020 2047 474d 4c5f 4153   N);.    GGML_AS
-0006c700: 5345 5254 2850 203e 3d20 3029 3b0a 0a20  SERT(P >= 0);.. 
-0006c710: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0006c720: 6271 3020 3d3d 2073 697a 656f 6628 666c  bq0 == sizeof(fl
-0006c730: 6f61 7429 293b 0a20 2020 2047 474d 4c5f  oat));.    GGML_
-0006c740: 4153 5345 5254 286e 626b 3020 3d3d 2073  ASSERT(nbk0 == s
-0006c750: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
-0006c760: 2020 2047 474d 4c5f 4153 5345 5254 286e     GGML_ASSERT(n
-0006c770: 6276 3020 3d3d 2073 697a 656f 6628 666c  bv0 == sizeof(fl
-0006c780: 6f61 7429 293b 0a0a 2020 2020 4747 4d4c  oat));..    GGML
-0006c790: 5f41 5353 4552 5428 6e65 7130 203d 3d20  _ASSERT(neq0 == 
-0006c7a0: 4429 3b0a 2020 2020 4747 4d4c 5f41 5353  D);.    GGML_ASS
-0006c7b0: 4552 5428 6e65 6b30 203d 3d20 4429 3b0a  ERT(nek0 == D);.
-0006c7c0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0006c7d0: 6e65 7631 203d 3d20 4429 3b0a 2020 2020  nev1 == D);.    
-0006c7e0: 4747 4d4c 5f41 5353 4552 5428 6e65 6430  GGML_ASSERT(ned0
-0006c7f0: 203d 3d20 4429 3b0a 0a20 2020 2047 474d   == D);..    GGM
-0006c800: 4c5f 4153 5345 5254 286e 6571 3120 3d3d  L_ASSERT(neq1 ==
-0006c810: 204e 293b 0a20 2020 2047 474d 4c5f 4153   N);.    GGML_AS
-0006c820: 5345 5254 286e 656b 3120 3d3d 204e 202b  SERT(nek1 == N +
-0006c830: 2050 293b 0a20 2020 2047 474d 4c5f 4153   P);.    GGML_AS
-0006c840: 5345 5254 286e 6576 3120 3d3d 2044 293b  SERT(nev1 == D);
-0006c850: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0006c860: 286e 6564 3120 3d3d 204e 293b 0a0a 2020  (ned1 == N);..  
-0006c870: 2020 2f2f 2064 7374 2063 616e 6e6f 7420    // dst cannot 
-0006c880: 6265 2074 7261 6e73 706f 7365 6420 6f72  be transposed or
-0006c890: 2070 6572 6d75 7465 640a 2020 2020 4747   permuted.    GG
-0006c8a0: 4d4c 5f41 5353 4552 5428 6e62 3020 3d3d  ML_ASSERT(nb0 ==
-0006c8b0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
-0006c8c0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0006c8d0: 286e 6230 203c 3d20 6e62 3129 3b0a 2020  (nb0 <= nb1);.  
-0006c8e0: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
-0006c8f0: 3120 3c3d 206e 6232 293b 0a20 2020 2047  1 <= nb2);.    G
-0006c900: 474d 4c5f 4153 5345 5254 286e 6232 203c  GML_ASSERT(nb2 <
-0006c910: 3d20 6e62 3329 3b0a 0a20 2020 2069 6620  = nb3);..    if 
-0006c920: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-0006c930: 2047 474d 4c5f 5441 534b 5f49 4e49 5429   GGML_TASK_INIT)
-0006c940: 207b 0a20 2020 2020 2020 2069 6620 2869   {.        if (i
-0006c950: 7468 203d 3d20 3029 207b 0a20 2020 2020  th == 0) {.     
-0006c960: 2020 2020 2020 206d 656d 7365 7428 6473         memset(ds
-0006c970: 742d 3e64 6174 612c 2030 2c20 6e62 302a  t->data, 0, nb0*
-0006c980: 6e65 302a 6e65 312a 6e65 322a 6e65 3329  ne0*ne1*ne2*ne3)
-0006c990: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
-0006c9a0: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-0006c9b0: 7d0a 0a20 2020 2069 6620 2870 6172 616d  }..    if (param
-0006c9c0: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-0006c9d0: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-0006c9e0: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-0006c9f0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2070  .    }..    // p
-0006ca00: 6172 616c 6c65 6c69 7a65 2062 7920 7120  arallelize by q 
-0006ca10: 726f 7773 2075 7369 6e67 2067 676d 6c5f  rows using ggml_
-0006ca20: 7665 635f 646f 745f 6633 320a 0a20 2020  vec_dot_f32..   
-0006ca30: 202f 2f20 746f 7461 6c20 726f 7773 2069   // total rows i
-0006ca40: 6e20 710a 2020 2020 636f 6e73 7420 696e  n q.    const in
-0006ca50: 7420 6e72 203d 206e 6571 322a 6e65 7133  t nr = neq2*neq3
-0006ca60: 3b0a 0a20 2020 202f 2f20 726f 7773 2070  ;..    // rows p
-0006ca70: 6572 2074 6872 6561 640a 2020 2020 636f  er thread.    co
-0006ca80: 6e73 7420 696e 7420 6472 203d 2028 6e72  nst int dr = (nr
-0006ca90: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
-0006caa0: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
-0006cab0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
-0006cac0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
-0006cad0: 2069 7230 203d 2064 722a 6974 683b 0a20   ir0 = dr*ith;. 
-0006cae0: 2020 2063 6f6e 7374 2069 6e74 2069 7231     const int ir1
-0006caf0: 203d 204d 494e 2869 7230 202b 2064 722c   = MIN(ir0 + dr,
-0006cb00: 206e 7229 3b0a 0a20 2020 2063 6f6e 7374   nr);..    const
-0006cb10: 2066 6c6f 6174 2073 6361 6c65 203d 2031   float scale = 1
-0006cb20: 2e30 662f 7371 7274 6628 4429 3b0a 0a20  .0f/sqrtf(D);.. 
-0006cb30: 2020 202f 2f70 7269 6e74 6628 2250 3d25     //printf("P=%
-0006cb40: 6420 4e3d 2564 2044 3d25 6420 6972 303d  d N=%d D=%d ir0=
-0006cb50: 2564 2069 7231 3d25 6420 7363 616c 6520  %d ir1=%d scale 
-0006cb60: 3d20 2566 5c6e 222c 2050 2c20 4e2c 2044  = %f\n", P, N, D
-0006cb70: 2c20 6972 302c 2069 7231 2c20 7363 616c  , ir0, ir1, scal
-0006cb80: 6529 3b0a 0a20 2020 2066 6f72 2028 696e  e);..    for (in
-0006cb90: 7420 6972 203d 2069 7230 3b20 6972 203c  t ir = ir0; ir <
-0006cba0: 2069 7231 3b20 2b2b 6972 2920 7b0a 2020   ir1; ++ir) {.  
-0006cbb0: 2020 2020 2020 2f2f 2071 2069 6e64 6963        // q indic
-0006cbc0: 6573 0a20 2020 2020 2020 2063 6f6e 7374  es.        const
-0006cbd0: 2069 6e74 2069 7133 203d 2069 722f 286e   int iq3 = ir/(n
-0006cbe0: 6571 3229 3b0a 2020 2020 2020 2020 636f  eq2);.        co
-0006cbf0: 6e73 7420 696e 7420 6971 3220 3d20 6972  nst int iq2 = ir
-0006cc00: 202d 2069 7133 2a6e 6571 323b 0a20 2020   - iq3*neq2;.   
-0006cc10: 2020 2020 2066 6f72 2028 2069 6e74 2069       for ( int i
-0006cc20: 7131 203d 2030 3b20 6971 3120 3c20 6e65  q1 = 0; iq1 < ne
-0006cc30: 7131 3b20 2b2b 6971 3129 207b 0a0a 0a20  q1; ++iq1) {... 
-0006cc40: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
-0006cc50: 7420 7375 7265 2061 626f 7574 2043 4143  t sure about CAC
-0006cc60: 4845 5f4c 494e 455f 5349 5a45 5f46 3332  HE_LINE_SIZE_F32
-0006cc70: 2e2e 0a20 2020 2020 2020 2020 2020 202f  ...            /
-0006cc80: 2f20 2d20 6d61 7962 6520 6974 206d 7573  / - maybe it mus
-0006cc90: 7420 6e6f 7420 6265 206d 756c 7469 706c  t not be multipl
-0006cca0: 6965 6420 6279 2032 2061 6e64 2065 7863  ied by 2 and exc
-0006ccb0: 6c75 6465 6420 6672 6f6d 202e 2e20 696e  luded from .. in
-0006ccc0: 2053 4d20 312a 282e 2e29 206f 6666 7365   SM 1*(..) offse
-0006ccd0: 743f 0a20 2020 2020 2020 2020 2020 2066  t?.            f
-0006cce0: 6c6f 6174 202a 2053 2020 3d20 2866 6c6f  loat * S  = (flo
-0006ccf0: 6174 202a 2920 7061 7261 6d73 2d3e 7764  at *) params->wd
-0006cd00: 6174 6120 2b20 6974 682a 322a 286d 7844  ata + ith*2*(mxD
-0006cd10: 4d20 2b20 4341 4348 455f 4c49 4e45 5f53  M + CACHE_LINE_S
-0006cd20: 495a 455f 4633 3229 202b 2030 2a28 6d78  IZE_F32) + 0*(mx
-0006cd30: 444d 2b43 4143 4845 5f4c 494e 455f 5349  DM+CACHE_LINE_SI
-0006cd40: 5a45 5f46 3332 293b 0a20 2020 2020 2020  ZE_F32);.       
-0006cd50: 2020 2020 2066 6c6f 6174 202a 2053 4d20       float * SM 
-0006cd60: 3d20 2866 6c6f 6174 202a 2920 7061 7261  = (float *) para
-0006cd70: 6d73 2d3e 7764 6174 6120 2b20 6974 682a  ms->wdata + ith*
-0006cd80: 322a 286d 7844 4d20 2b20 4341 4348 455f  2*(mxDM + CACHE_
-0006cd90: 4c49 4e45 5f53 495a 455f 4633 3229 202b  LINE_SIZE_F32) +
-0006cda0: 2031 2a28 6d78 444d 2b43 4143 4845 5f4c   1*(mxDM+CACHE_L
-0006cdb0: 494e 455f 5349 5a45 5f46 3332 293b 0a0a  INE_SIZE_F32);..
-0006cdc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0006cdd0: 2869 6e74 2069 203d 204d 3b20 6920 3c20  (int i = M; i < 
-0006cde0: 4d75 703b 202b 2b69 2920 7b0a 2020 2020  Mup; ++i) {.    
-0006cdf0: 2020 2020 2020 2020 2020 2020 535b 695d              S[i]
-0006ce00: 203d 202d 494e 4649 4e49 5459 3b0a 2020   = -INFINITY;.  
-0006ce10: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-0006ce20: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-0006ce30: 7436 345f 7420 6963 203d 2030 3b20 6963  t64_t ic = 0; ic
-0006ce40: 203c 206e 656b 313b 202b 2b69 6329 207b   < nek1; ++ic) {
-0006ce50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ce60: 202f 2f20 6b20 696e 6469 6365 730a 2020   // k indices.  
-0006ce70: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0006ce80: 6e73 7420 696e 7420 696b 3320 3d20 6971  nst int ik3 = iq
-0006ce90: 333b 0a20 2020 2020 2020 2020 2020 2020  3;.             
-0006cea0: 2020 2063 6f6e 7374 2069 6e74 2069 6b32     const int ik2
-0006ceb0: 203d 2069 7132 3b0a 2020 2020 2020 2020   = iq2;.        
-0006cec0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0006ced0: 7420 696b 3120 3d20 6963 3b0a 0a20 2020  t ik1 = ic;..   
-0006cee0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006cef0: 5320 696e 6469 6365 730a 2020 2020 2020  S indices.      
-0006cf00: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006cf10: 696e 7420 6931 203d 2069 6b31 3b0a 0a20  int i1 = ik1;.. 
-0006cf20: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0006cf30: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
-0006cf40: 6e65 7130 2c0a 2020 2020 2020 2020 2020  neq0,.          
-0006cf50: 2020 2020 2020 2020 2020 2020 2020 5320                S 
-0006cf60: 2b20 6931 2c0a 2020 2020 2020 2020 2020  + i1,.          
-0006cf70: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-0006cf80: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
-0006cf90: 2920 6b2d 3e64 6174 6120 2b20 2869 6b31  ) k->data + (ik1
-0006cfa0: 2a6e 626b 3120 2b20 696b 322a 6e62 6b32  *nbk1 + ik2*nbk2
-0006cfb0: 202b 2069 6b33 2a6e 626b 3329 292c 0a20   + ik3*nbk3)),. 
-0006cfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006cfd0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
-0006cfe0: 2028 2863 6861 7220 2a29 2071 2d3e 6461   ((char *) q->da
-0006cff0: 7461 202b 2028 6971 312a 6e62 7131 202b  ta + (iq1*nbq1 +
-0006d000: 2069 7132 2a6e 6271 3220 2b20 6971 332a   iq2*nbq2 + iq3*
-0006d010: 6e62 7133 2929 293b 0a20 2020 2020 2020  nbq3)));.       
-0006d020: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0006d030: 2020 2020 2f2f 2073 6361 6c65 0a20 2020      // scale.   
-0006d040: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0006d050: 635f 7363 616c 655f 6633 3228 6e65 6b31  c_scale_f32(nek1
-0006d060: 2c20 532c 2073 6361 6c65 293b 0a0a 2020  , S, scale);..  
-0006d070: 2020 2020 2020 2020 2020 6966 2028 6d61            if (ma
-0006d080: 736b 6564 2920 7b0a 2020 2020 2020 2020  sked) {.        
-0006d090: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0006d0a0: 3634 5f74 2069 203d 2050 3b20 6920 3c20  64_t i = P; i < 
-0006d0b0: 4d3b 2069 2b2b 2920 7b0a 2020 2020 2020  M; i++) {.      
-0006d0c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0006d0d0: 2028 6920 3e20 5020 2b20 6971 3129 207b   (i > P + iq1) {
-0006d0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d0f0: 2020 2020 2020 2020 2053 5b69 5d20 3d20           S[i] = 
-0006d100: 2d49 4e46 494e 4954 593b 0a20 2020 2020  -INFINITY;.     
-0006d110: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0006d120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d130: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0006d140: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-0006d150: 2073 6f66 746d 6178 0a20 2020 2020 2020   softmax.       
-0006d160: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0006d170: 2020 2020 2020 2066 6c6f 6174 206d 6178         float max
-0006d180: 203d 202d 494e 4649 4e49 5459 3b0a 2020   = -INFINITY;.  
-0006d190: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0006d1a0: 6d6c 5f76 6563 5f6d 6178 5f66 3332 284d  ml_vec_max_f32(M
-0006d1b0: 2c20 266d 6178 2c20 5329 3b0a 0a20 2020  , &max, S);..   
-0006d1c0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006d1d0: 6c5f 666c 6f61 7420 7375 6d20 3d20 302e  l_float sum = 0.
-0006d1e0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
-0006d1f0: 2020 207b 0a23 6966 6465 6620 4747 4d4c     {.#ifdef GGML
-0006d200: 5f53 4f46 545f 4d41 585f 4143 4345 4c45  _SOFT_MAX_ACCELE
-0006d210: 5241 5445 0a20 2020 2020 2020 2020 2020  RATE.           
-0006d220: 2020 2020 2020 2020 206d 6178 203d 202d           max = -
-0006d230: 6d61 783b 0a20 2020 2020 2020 2020 2020  max;.           
-0006d240: 2020 2020 2020 2020 2076 4453 505f 7673           vDSP_vs
-0006d250: 6164 6428 534d 2c20 312c 2026 6d61 782c  add(SM, 1, &max,
-0006d260: 2053 4d2c 2031 2c20 4d75 7029 3b0a 2020   SM, 1, Mup);.  
-0006d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d280: 2020 7676 6578 7066 2853 4d2c 2053 4d2c    vvexpf(SM, SM,
-0006d290: 2026 4d75 7029 3b0a 2020 2020 2020 2020   &Mup);.        
-0006d2a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006d2b0: 5f76 6563 5f73 756d 5f66 3332 284d 7570  _vec_sum_f32(Mup
-0006d2c0: 2c20 2673 756d 2c20 534d 293b 0a23 656c  , &sum, SM);.#el
-0006d2d0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0006d2e0: 2020 2020 2020 2075 696e 7431 365f 7420         uint16_t 
-0006d2f0: 2020 7363 7674 5b47 474d 4c5f 534f 4654    scvt[GGML_SOFT
-0006d300: 5f4d 4158 5f55 4e52 4f4c 4c5d 3b0a 2020  _MAX_UNROLL];.  
-0006d310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d320: 2020 6767 6d6c 5f66 6c6f 6174 2073 756d    ggml_float sum
-0006d330: 705b 4747 4d4c 5f53 4f46 545f 4d41 585f  p[GGML_SOFT_MAX_
-0006d340: 554e 524f 4c4c 5d20 3d20 7b20 302e 3020  UNROLL] = { 0.0 
-0006d350: 7d3b 0a0a 2020 2020 2020 2020 2020 2020  };..            
-0006d360: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0006d370: 2069 203d 2030 3b20 6920 3c20 4d75 703b   i = 0; i < Mup;
-0006d380: 2069 202b 3d20 4747 4d4c 5f53 4f46 545f   i += GGML_SOFT_
-0006d390: 4d41 585f 554e 524f 4c4c 2920 7b0a 2020  MAX_UNROLL) {.  
-0006d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d3b0: 2020 2020 2020 666c 6f61 7420 2a20 5352        float * SR
-0006d3c0: 203d 2020 5320 2b20 693b 0a20 2020 2020   =  S + i;.     
-0006d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d3e0: 2020 2066 6c6f 6174 202a 2053 5720 3d20     float * SW = 
-0006d3f0: 534d 202b 2069 3b0a 0a20 2020 2020 2020  SM + i;..       
+0006be50: 2867 676d 6c5f 6670 3136 5f74 202a 2920  (ggml_fp16_t *) 
+0006be60: 2828 6368 6172 202a 2920 6330 2d3e 6461  ((char *) c0->da
+0006be70: 7461 2020 2b20 2820 2020 2020 2020 2020  ta  + (         
+0006be80: 6963 2a6e 6263 3031 202b 2069 322a 6e62  ic*nbc01 + i2*nb
+0006be90: 6330 3220 2b20 6933 2a6e 6263 3033 2929  c02 + i3*nbc03))
+0006bea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006beb0: 2020 2020 2020 2020 2020 5331 3629 3b0a            S16);.
+0006bec0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0006bed0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006bee0: 7665 635f 6164 645f 6633 3228 6e65 6330  vec_add_f32(nec0
+0006bef0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+0006bf00: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+0006bf10: 2028 2863 6861 7220 2a29 2064 7374 2d3e   ((char *) dst->
+0006bf20: 6461 7461 202b 2028 6931 2a6e 6231 202b  data + (i1*nb1 +
+0006bf30: 2069 322a 6e62 3220 2b20 6933 2a6e 6233   i2*nb2 + i3*nb3
+0006bf40: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0006bf50: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+0006bf60: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
+0006bf70: 3e64 6174 6120 2b20 2869 312a 6e62 3120  >data + (i1*nb1 
+0006bf80: 2b20 6932 2a6e 6232 202b 2069 332a 6e62  + i2*nb2 + i3*nb
+0006bf90: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
+0006bfa0: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+0006bfb0: 2a29 2063 312d 3e64 6174 6129 3b0a 2020  *) c1->data);.  
+0006bfc0: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
+0006bfd0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+0006bfe0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+0006bff0: 645f 666c 6173 685f 6666 280a 2020 2020  d_flash_ff(.    
+0006c000: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0006c010: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+0006c020: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+0006c030: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0006c040: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0006c050: 2a20 612c 0a20 2020 2020 2020 2063 6f6e  * a,.        con
+0006c060: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+0006c070: 656e 736f 7220 2a20 6230 2c0a 2020 2020  ensor * b0,.    
+0006c080: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+0006c090: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
+0006c0a0: 312c 0a20 2020 2020 2020 2063 6f6e 7374  1,.        const
+0006c0b0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0006c0c0: 736f 7220 2a20 6330 2c0a 2020 2020 2020  sor * c0,.      
+0006c0d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0006c0e0: 676d 6c5f 7465 6e73 6f72 202a 2063 312c  gml_tensor * c1,
+0006c0f0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0006c100: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0006c110: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+0006c120: 2862 302d 3e74 7970 6529 207b 0a20 2020  (b0->type) {.   
+0006c130: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+0006c140: 5950 455f 4631 363a 0a20 2020 2020 2020  YPE_F16:.       
+0006c150: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0006c160: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+0006c170: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
+0006c180: 685f 6666 5f66 3136 2870 6172 616d 732c  h_ff_f16(params,
+0006c190: 2061 2c20 6230 2c20 6231 2c20 6330 2c20   a, b0, b1, c0, 
+0006c1a0: 6331 2c20 6473 7429 3b0a 2020 2020 2020  c1, dst);.      
+0006c1b0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0006c1c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0006c1d0: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
+0006c1e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0006c1f0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0006c200: 5345 5254 2866 616c 7365 293b 202f 2f20  SERT(false); // 
+0006c210: 544f 444f 0a20 2020 2020 2020 2020 2020  TODO.           
+0006c220: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0006c230: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
+0006c240: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0006c250: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0006c260: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
+0006c270: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0006c280: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
+0006c290: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+0006c2a0: 7264 5f66 6c61 7368 5f61 7474 6e5f 6261  rd_flash_attn_ba
+0006c2b0: 636b 0a0a 7374 6174 6963 2076 6f69 6420  ck..static void 
+0006c2c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+0006c2d0: 7761 7264 5f66 6c61 7368 5f61 7474 6e5f  ward_flash_attn_
+0006c2e0: 6261 636b 5f66 3332 280a 2020 2020 2020  back_f32(.      
+0006c2f0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0006c300: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
+0006c310: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
+0006c320: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+0006c330: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0006c340: 712c 0a20 2020 2020 2020 2063 6f6e 7374  q,.        const
+0006c350: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0006c360: 736f 7220 2a20 6b2c 0a20 2020 2020 2020  sor * k,.       
+0006c370: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+0006c380: 6d6c 5f74 656e 736f 7220 2a20 762c 0a20  ml_tensor * v,. 
+0006c390: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+0006c3a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0006c3b0: 2a20 642c 0a20 2020 2020 2020 2063 6f6e  * d,.        con
+0006c3c0: 7374 2062 6f6f 6c20 6d61 736b 6564 2c0a  st bool masked,.
+0006c3d0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0006c3e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0006c3f0: 202a 2064 7374 2920 7b0a 2020 2020 696e   * dst) {.    in
+0006c400: 7436 345f 7420 7430 203d 2067 676d 6c5f  t64_t t0 = ggml_
+0006c410: 7065 7266 5f74 696d 655f 7573 2829 3b0a  perf_time_us();.
+0006c420: 2020 2020 554e 5553 4544 2874 3029 3b0a      UNUSED(t0);.
+0006c430: 0a20 2020 2047 474d 4c5f 5445 4e53 4f52  .    GGML_TENSOR
+0006c440: 5f4c 4f43 414c 5328 696e 7436 345f 742c  _LOCALS(int64_t,
+0006c450: 206e 6571 2c20 712c 2020 206e 6529 3b0a   neq, q,   ne);.
+0006c460: 2020 2020 4747 4d4c 5f54 454e 534f 525f      GGML_TENSOR_
+0006c470: 4c4f 4341 4c53 2873 697a 655f 742c 2020  LOCALS(size_t,  
+0006c480: 6e62 712c 2071 2c20 2020 6e62 293b 0a20  nbq, q,   nb);. 
+0006c490: 2020 2047 474d 4c5f 5445 4e53 4f52 5f4c     GGML_TENSOR_L
+0006c4a0: 4f43 414c 5328 696e 7436 345f 742c 206e  OCALS(int64_t, n
+0006c4b0: 656b 2c20 6b2c 2020 206e 6529 3b0a 2020  ek, k,   ne);.  
+0006c4c0: 2020 4747 4d4c 5f54 454e 534f 525f 4c4f    GGML_TENSOR_LO
+0006c4d0: 4341 4c53 2873 697a 655f 742c 2020 6e62  CALS(size_t,  nb
+0006c4e0: 6b2c 206b 2c20 2020 6e62 293b 0a20 2020  k, k,   nb);.   
+0006c4f0: 2047 474d 4c5f 5445 4e53 4f52 5f4c 4f43   GGML_TENSOR_LOC
+0006c500: 414c 5328 696e 7436 345f 742c 206e 6576  ALS(int64_t, nev
+0006c510: 2c20 762c 2020 206e 6529 3b0a 2020 2020  , v,   ne);.    
+0006c520: 4747 4d4c 5f54 454e 534f 525f 4c4f 4341  GGML_TENSOR_LOCA
+0006c530: 4c53 2873 697a 655f 742c 2020 6e62 762c  LS(size_t,  nbv,
+0006c540: 2076 2c20 2020 6e62 293b 0a20 2020 2047   v,   nb);.    G
+0006c550: 474d 4c5f 5445 4e53 4f52 5f4c 4f43 414c  GML_TENSOR_LOCAL
+0006c560: 5328 696e 7436 345f 742c 206e 6564 2c20  S(int64_t, ned, 
+0006c570: 642c 2020 206e 6529 3b0a 2020 2020 4747  d,   ne);.    GG
+0006c580: 4d4c 5f54 454e 534f 525f 4c4f 4341 4c53  ML_TENSOR_LOCALS
+0006c590: 2873 697a 655f 742c 2020 6e62 642c 2064  (size_t,  nbd, d
+0006c5a0: 2c20 2020 6e62 293b 0a20 2020 2047 474d  ,   nb);.    GGM
+0006c5b0: 4c5f 5445 4e53 4f52 5f4c 4f43 414c 5328  L_TENSOR_LOCALS(
+0006c5c0: 696e 7436 345f 742c 206e 652c 2020 6473  int64_t, ne,  ds
+0006c5d0: 742c 206e 6529 3b0a 2020 2020 4747 4d4c  t, ne);.    GGML
+0006c5e0: 5f54 454e 534f 525f 4c4f 4341 4c53 2873  _TENSOR_LOCALS(s
+0006c5f0: 697a 655f 742c 2020 6e62 2c20 2064 7374  ize_t,  nb,  dst
+0006c600: 2c20 6e62 293b 0a0a 2020 2020 636f 6e73  , nb);..    cons
+0006c610: 7420 696e 7420 6974 6820 3d20 7061 7261  t int ith = para
+0006c620: 6d73 2d3e 6974 683b 0a20 2020 2063 6f6e  ms->ith;.    con
+0006c630: 7374 2069 6e74 206e 7468 203d 2070 6172  st int nth = par
+0006c640: 616d 732d 3e6e 7468 3b0a 0a20 2020 2063  ams->nth;..    c
+0006c650: 6f6e 7374 2069 6e74 3634 5f74 2044 203d  onst int64_t D =
+0006c660: 206e 6571 303b 0a20 2020 2063 6f6e 7374   neq0;.    const
+0006c670: 2069 6e74 3634 5f74 204e 203d 206e 6571   int64_t N = neq
+0006c680: 313b 0a20 2020 2063 6f6e 7374 2069 6e74  1;.    const int
+0006c690: 3634 5f74 2050 203d 206e 656b 3120 2d20  64_t P = nek1 - 
+0006c6a0: 4e3b 0a20 2020 2063 6f6e 7374 2069 6e74  N;.    const int
+0006c6b0: 3634 5f74 204d 203d 2050 202b 204e 3b0a  64_t M = P + N;.
+0006c6c0: 0a20 2020 2063 6f6e 7374 2069 6e74 204d  .    const int M
+0006c6d0: 7570 2020 3d20 6767 6d6c 5f75 7028 4d2c  up  = ggml_up(M,
+0006c6e0: 2047 474d 4c5f 534f 4654 5f4d 4158 5f55   GGML_SOFT_MAX_U
+0006c6f0: 4e52 4f4c 4c29 3b0a 2020 2020 636f 6e73  NROLL);.    cons
+0006c700: 7420 696e 7420 6d78 444d 203d 204d 4158  t int mxDM = MAX
+0006c710: 2844 2c20 4d75 7029 3b0a 0a20 2020 202f  (D, Mup);..    /
+0006c720: 2f20 4747 4d4c 5f41 5353 4552 5428 6e65  / GGML_ASSERT(ne
+0006c730: 3020 3d3d 2044 293b 0a20 2020 202f 2f20  0 == D);.    // 
+0006c740: 4747 4d4c 5f41 5353 4552 5428 6e65 3120  GGML_ASSERT(ne1 
+0006c750: 3d3d 204e 293b 0a20 2020 2047 474d 4c5f  == N);.    GGML_
+0006c760: 4153 5345 5254 2850 203e 3d20 3029 3b0a  ASSERT(P >= 0);.
+0006c770: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0006c780: 286e 6271 3020 3d3d 2073 697a 656f 6628  (nbq0 == sizeof(
+0006c790: 666c 6f61 7429 293b 0a20 2020 2047 474d  float));.    GGM
+0006c7a0: 4c5f 4153 5345 5254 286e 626b 3020 3d3d  L_ASSERT(nbk0 ==
+0006c7b0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+0006c7c0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+0006c7d0: 286e 6276 3020 3d3d 2073 697a 656f 6628  (nbv0 == sizeof(
+0006c7e0: 666c 6f61 7429 293b 0a0a 2020 2020 4747  float));..    GG
+0006c7f0: 4d4c 5f41 5353 4552 5428 6e65 7130 203d  ML_ASSERT(neq0 =
+0006c800: 3d20 4429 3b0a 2020 2020 4747 4d4c 5f41  = D);.    GGML_A
+0006c810: 5353 4552 5428 6e65 6b30 203d 3d20 4429  SSERT(nek0 == D)
+0006c820: 3b0a 2020 2020 4747 4d4c 5f41 5353 4552  ;.    GGML_ASSER
+0006c830: 5428 6e65 7631 203d 3d20 4429 3b0a 2020  T(nev1 == D);.  
+0006c840: 2020 4747 4d4c 5f41 5353 4552 5428 6e65    GGML_ASSERT(ne
+0006c850: 6430 203d 3d20 4429 3b0a 0a20 2020 2047  d0 == D);..    G
+0006c860: 474d 4c5f 4153 5345 5254 286e 6571 3120  GML_ASSERT(neq1 
+0006c870: 3d3d 204e 293b 0a20 2020 2047 474d 4c5f  == N);.    GGML_
+0006c880: 4153 5345 5254 286e 656b 3120 3d3d 204e  ASSERT(nek1 == N
+0006c890: 202b 2050 293b 0a20 2020 2047 474d 4c5f   + P);.    GGML_
+0006c8a0: 4153 5345 5254 286e 6576 3120 3d3d 2044  ASSERT(nev1 == D
+0006c8b0: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0006c8c0: 5254 286e 6564 3120 3d3d 204e 293b 0a0a  RT(ned1 == N);..
+0006c8d0: 2020 2020 2f2f 2064 7374 2063 616e 6e6f      // dst canno
+0006c8e0: 7420 6265 2074 7261 6e73 706f 7365 6420  t be transposed 
+0006c8f0: 6f72 2070 6572 6d75 7465 640a 2020 2020  or permuted.    
+0006c900: 4747 4d4c 5f41 5353 4552 5428 6e62 3020  GGML_ASSERT(nb0 
+0006c910: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
+0006c920: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
+0006c930: 5254 286e 6230 203c 3d20 6e62 3129 3b0a  RT(nb0 <= nb1);.
+0006c940: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0006c950: 6e62 3120 3c3d 206e 6232 293b 0a20 2020  nb1 <= nb2);.   
+0006c960: 2047 474d 4c5f 4153 5345 5254 286e 6232   GGML_ASSERT(nb2
+0006c970: 203c 3d20 6e62 3329 3b0a 0a20 2020 2069   <= nb3);..    i
+0006c980: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+0006c990: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+0006c9a0: 5429 207b 0a20 2020 2020 2020 2069 6620  T) {.        if 
+0006c9b0: 2869 7468 203d 3d20 3029 207b 0a20 2020  (ith == 0) {.   
+0006c9c0: 2020 2020 2020 2020 206d 656d 7365 7428           memset(
+0006c9d0: 6473 742d 3e64 6174 612c 2030 2c20 6e62  dst->data, 0, nb
+0006c9e0: 302a 6e65 302a 6e65 312a 6e65 322a 6e65  0*ne0*ne1*ne2*ne
+0006c9f0: 3329 3b0a 2020 2020 2020 2020 7d0a 2020  3);.        }.  
+0006ca00: 2020 2020 2020 7265 7475 726e 3b0a 2020        return;.  
+0006ca10: 2020 7d0a 0a20 2020 2069 6620 2870 6172    }..    if (par
+0006ca20: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+0006ca30: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+0006ca40: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+0006ca50: 6e3b 0a20 2020 207d 0a0a 2020 2020 2f2f  n;.    }..    //
+0006ca60: 2070 6172 616c 6c65 6c69 7a65 2062 7920   parallelize by 
+0006ca70: 7120 726f 7773 2075 7369 6e67 2067 676d  q rows using ggm
+0006ca80: 6c5f 7665 635f 646f 745f 6633 320a 0a20  l_vec_dot_f32.. 
+0006ca90: 2020 202f 2f20 746f 7461 6c20 726f 7773     // total rows
+0006caa0: 2069 6e20 710a 2020 2020 636f 6e73 7420   in q.    const 
+0006cab0: 696e 7420 6e72 203d 206e 6571 322a 6e65  int nr = neq2*ne
+0006cac0: 7133 3b0a 0a20 2020 202f 2f20 726f 7773  q3;..    // rows
+0006cad0: 2070 6572 2074 6872 6561 640a 2020 2020   per thread.    
+0006cae0: 636f 6e73 7420 696e 7420 6472 203d 2028  const int dr = (
+0006caf0: 6e72 202b 206e 7468 202d 2031 292f 6e74  nr + nth - 1)/nt
+0006cb00: 683b 0a0a 2020 2020 2f2f 2072 6f77 2072  h;..    // row r
+0006cb10: 616e 6765 2066 6f72 2074 6869 7320 7468  ange for this th
+0006cb20: 7265 6164 0a20 2020 2063 6f6e 7374 2069  read.    const i
+0006cb30: 6e74 2069 7230 203d 2064 722a 6974 683b  nt ir0 = dr*ith;
+0006cb40: 0a20 2020 2063 6f6e 7374 2069 6e74 2069  .    const int i
+0006cb50: 7231 203d 204d 494e 2869 7230 202b 2064  r1 = MIN(ir0 + d
+0006cb60: 722c 206e 7229 3b0a 0a20 2020 2063 6f6e  r, nr);..    con
+0006cb70: 7374 2066 6c6f 6174 2073 6361 6c65 203d  st float scale =
+0006cb80: 2031 2e30 662f 7371 7274 6628 4429 3b0a   1.0f/sqrtf(D);.
+0006cb90: 0a20 2020 202f 2f70 7269 6e74 6628 2250  .    //printf("P
+0006cba0: 3d25 6420 4e3d 2564 2044 3d25 6420 6972  =%d N=%d D=%d ir
+0006cbb0: 303d 2564 2069 7231 3d25 6420 7363 616c  0=%d ir1=%d scal
+0006cbc0: 6520 3d20 2566 5c6e 222c 2050 2c20 4e2c  e = %f\n", P, N,
+0006cbd0: 2044 2c20 6972 302c 2069 7231 2c20 7363   D, ir0, ir1, sc
+0006cbe0: 616c 6529 3b0a 0a20 2020 2066 6f72 2028  ale);..    for (
+0006cbf0: 696e 7420 6972 203d 2069 7230 3b20 6972  int ir = ir0; ir
+0006cc00: 203c 2069 7231 3b20 2b2b 6972 2920 7b0a   < ir1; ++ir) {.
+0006cc10: 2020 2020 2020 2020 2f2f 2071 2069 6e64          // q ind
+0006cc20: 6963 6573 0a20 2020 2020 2020 2063 6f6e  ices.        con
+0006cc30: 7374 2069 6e74 2069 7133 203d 2069 722f  st int iq3 = ir/
+0006cc40: 286e 6571 3229 3b0a 2020 2020 2020 2020  (neq2);.        
+0006cc50: 636f 6e73 7420 696e 7420 6971 3220 3d20  const int iq2 = 
+0006cc60: 6972 202d 2069 7133 2a6e 6571 323b 0a20  ir - iq3*neq2;. 
+0006cc70: 2020 2020 2020 2066 6f72 2028 2069 6e74         for ( int
+0006cc80: 2069 7131 203d 2030 3b20 6971 3120 3c20   iq1 = 0; iq1 < 
+0006cc90: 6e65 7131 3b20 2b2b 6971 3129 207b 0a0a  neq1; ++iq1) {..
+0006cca0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0006ccb0: 6e6f 7420 7375 7265 2061 626f 7574 2043  not sure about C
+0006ccc0: 4143 4845 5f4c 494e 455f 5349 5a45 5f46  ACHE_LINE_SIZE_F
+0006ccd0: 3332 2e2e 0a20 2020 2020 2020 2020 2020  32...           
+0006cce0: 202f 2f20 2d20 6d61 7962 6520 6974 206d   // - maybe it m
+0006ccf0: 7573 7420 6e6f 7420 6265 206d 756c 7469  ust not be multi
+0006cd00: 706c 6965 6420 6279 2032 2061 6e64 2065  plied by 2 and e
+0006cd10: 7863 6c75 6465 6420 6672 6f6d 202e 2e20  xcluded from .. 
+0006cd20: 696e 2053 4d20 312a 282e 2e29 206f 6666  in SM 1*(..) off
+0006cd30: 7365 743f 0a20 2020 2020 2020 2020 2020  set?.           
+0006cd40: 2066 6c6f 6174 202a 2053 2020 3d20 2866   float * S  = (f
+0006cd50: 6c6f 6174 202a 2920 7061 7261 6d73 2d3e  loat *) params->
+0006cd60: 7764 6174 6120 2b20 6974 682a 322a 286d  wdata + ith*2*(m
+0006cd70: 7844 4d20 2b20 4341 4348 455f 4c49 4e45  xDM + CACHE_LINE
+0006cd80: 5f53 495a 455f 4633 3229 202b 2030 2a28  _SIZE_F32) + 0*(
+0006cd90: 6d78 444d 2b43 4143 4845 5f4c 494e 455f  mxDM+CACHE_LINE_
+0006cda0: 5349 5a45 5f46 3332 293b 0a20 2020 2020  SIZE_F32);.     
+0006cdb0: 2020 2020 2020 2066 6c6f 6174 202a 2053         float * S
+0006cdc0: 4d20 3d20 2866 6c6f 6174 202a 2920 7061  M = (float *) pa
+0006cdd0: 7261 6d73 2d3e 7764 6174 6120 2b20 6974  rams->wdata + it
+0006cde0: 682a 322a 286d 7844 4d20 2b20 4341 4348  h*2*(mxDM + CACH
+0006cdf0: 455f 4c49 4e45 5f53 495a 455f 4633 3229  E_LINE_SIZE_F32)
+0006ce00: 202b 2031 2a28 6d78 444d 2b43 4143 4845   + 1*(mxDM+CACHE
+0006ce10: 5f4c 494e 455f 5349 5a45 5f46 3332 293b  _LINE_SIZE_F32);
+0006ce20: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0006ce30: 7220 2869 6e74 2069 203d 204d 3b20 6920  r (int i = M; i 
+0006ce40: 3c20 4d75 703b 202b 2b69 2920 7b0a 2020  < Mup; ++i) {.  
+0006ce50: 2020 2020 2020 2020 2020 2020 2020 535b                S[
+0006ce60: 695d 203d 202d 494e 4649 4e49 5459 3b0a  i] = -INFINITY;.
+0006ce70: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0006ce80: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+0006ce90: 696e 7436 345f 7420 6963 203d 2030 3b20  int64_t ic = 0; 
+0006cea0: 6963 203c 206e 656b 313b 202b 2b69 6329  ic < nek1; ++ic)
+0006ceb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006cec0: 2020 202f 2f20 6b20 696e 6469 6365 730a     // k indices.
+0006ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cee0: 636f 6e73 7420 696e 7420 696b 3320 3d20  const int ik3 = 
+0006cef0: 6971 333b 0a20 2020 2020 2020 2020 2020  iq3;.           
+0006cf00: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0006cf10: 6b32 203d 2069 7132 3b0a 2020 2020 2020  k2 = iq2;.      
+0006cf20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006cf30: 696e 7420 696b 3120 3d20 6963 3b0a 0a20  int ik1 = ic;.. 
+0006cf40: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006cf50: 2f20 5320 696e 6469 6365 730a 2020 2020  / S indices.    
+0006cf60: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0006cf70: 7420 696e 7420 6931 203d 2069 6b31 3b0a  t int i1 = ik1;.
+0006cf80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006cf90: 2067 676d 6c5f 7665 635f 646f 745f 6633   ggml_vec_dot_f3
+0006cfa0: 3228 6e65 7130 2c0a 2020 2020 2020 2020  2(neq0,.        
+0006cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cfc0: 5320 2b20 6931 2c0a 2020 2020 2020 2020  S + i1,.        
+0006cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006cfe0: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
+0006cff0: 202a 2920 6b2d 3e64 6174 6120 2b20 2869   *) k->data + (i
+0006d000: 6b31 2a6e 626b 3120 2b20 696b 322a 6e62  k1*nbk1 + ik2*nb
+0006d010: 6b32 202b 2069 6b33 2a6e 626b 3329 292c  k2 + ik3*nbk3)),
+0006d020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d030: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
+0006d040: 2a29 2028 2863 6861 7220 2a29 2071 2d3e  *) ((char *) q->
+0006d050: 6461 7461 202b 2028 6971 312a 6e62 7131  data + (iq1*nbq1
+0006d060: 202b 2069 7132 2a6e 6271 3220 2b20 6971   + iq2*nbq2 + iq
+0006d070: 332a 6e62 7133 2929 293b 0a20 2020 2020  3*nbq3)));.     
+0006d080: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0006d090: 2020 2020 2020 2f2f 2073 6361 6c65 0a20        // scale. 
+0006d0a0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006d0b0: 7665 635f 7363 616c 655f 6633 3228 6e65  vec_scale_f32(ne
+0006d0c0: 6b31 2c20 532c 2073 6361 6c65 293b 0a0a  k1, S, scale);..
+0006d0d0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0006d0e0: 6d61 736b 6564 2920 7b0a 2020 2020 2020  masked) {.      
+0006d0f0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0006d100: 6e74 3634 5f74 2069 203d 2050 3b20 6920  nt64_t i = P; i 
+0006d110: 3c20 4d3b 2069 2b2b 2920 7b0a 2020 2020  < M; i++) {.    
+0006d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d130: 6966 2028 6920 3e20 5020 2b20 6971 3129  if (i > P + iq1)
+0006d140: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006d150: 2020 2020 2020 2020 2020 2053 5b69 5d20             S[i] 
+0006d160: 3d20 2d49 4e46 494e 4954 593b 0a20 2020  = -INFINITY;.   
+0006d170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d180: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0006d190: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0006d1a0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0006d1b0: 2f2f 2073 6f66 746d 6178 0a20 2020 2020  // softmax.     
+0006d1c0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0006d1d0: 2020 2020 2020 2020 2066 6c6f 6174 206d           float m
+0006d1e0: 6178 203d 202d 494e 4649 4e49 5459 3b0a  ax = -INFINITY;.
+0006d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d200: 6767 6d6c 5f76 6563 5f6d 6178 5f66 3332  ggml_vec_max_f32
+0006d210: 284d 2c20 266d 6178 2c20 5329 3b0a 0a20  (M, &max, S);.. 
+0006d220: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006d230: 676d 6c5f 666c 6f61 7420 7375 6d20 3d20  gml_float sum = 
+0006d240: 302e 303b 0a20 2020 2020 2020 2020 2020  0.0;.           
+0006d250: 2020 2020 207b 0a23 6966 6465 6620 4747       {.#ifdef GG
+0006d260: 4d4c 5f53 4f46 545f 4d41 585f 4143 4345  ML_SOFT_MAX_ACCE
+0006d270: 4c45 5241 5445 0a20 2020 2020 2020 2020  LERATE.         
+0006d280: 2020 2020 2020 2020 2020 206d 6178 203d             max =
+0006d290: 202d 6d61 783b 0a20 2020 2020 2020 2020   -max;.         
+0006d2a0: 2020 2020 2020 2020 2020 2076 4453 505f             vDSP_
+0006d2b0: 7673 6164 6428 534d 2c20 312c 2026 6d61  vsadd(SM, 1, &ma
+0006d2c0: 782c 2053 4d2c 2031 2c20 4d75 7029 3b0a  x, SM, 1, Mup);.
+0006d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d2e0: 2020 2020 7676 6578 7066 2853 4d2c 2053      vvexpf(SM, S
+0006d2f0: 4d2c 2026 4d75 7029 3b0a 2020 2020 2020  M, &Mup);.      
+0006d300: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006d310: 6d6c 5f76 6563 5f73 756d 5f66 3332 284d  ml_vec_sum_f32(M
+0006d320: 7570 2c20 2673 756d 2c20 534d 293b 0a23  up, &sum, SM);.#
+0006d330: 656c 7365 0a20 2020 2020 2020 2020 2020  else.           
+0006d340: 2020 2020 2020 2020 2075 696e 7431 365f           uint16_
+0006d350: 7420 2020 7363 7674 5b47 474d 4c5f 534f  t   scvt[GGML_SO
+0006d360: 4654 5f4d 4158 5f55 4e52 4f4c 4c5d 3b0a  FT_MAX_UNROLL];.
+0006d370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d380: 2020 2020 6767 6d6c 5f66 6c6f 6174 2073      ggml_float s
+0006d390: 756d 705b 4747 4d4c 5f53 4f46 545f 4d41  ump[GGML_SOFT_MA
+0006d3a0: 585f 554e 524f 4c4c 5d20 3d20 7b20 302e  X_UNROLL] = { 0.
+0006d3b0: 3020 7d3b 0a0a 2020 2020 2020 2020 2020  0 };..          
+0006d3c0: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0006d3d0: 6e74 2069 203d 2030 3b20 6920 3c20 4d75  nt i = 0; i < Mu
+0006d3e0: 703b 2069 202b 3d20 4747 4d4c 5f53 4f46  p; i += GGML_SOF
+0006d3f0: 545f 4d41 585f 554e 524f 4c4c 2920 7b0a  T_MAX_UNROLL) {.
 0006d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d410: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
-0006d420: 206a 203c 2047 474d 4c5f 534f 4654 5f4d   j < GGML_SOFT_M
-0006d430: 4158 5f55 4e52 4f4c 4c3b 202b 2b6a 2920  AX_UNROLL; ++j) 
-0006d440: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0006d450: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0006d460: 2028 5352 5b6a 5d20 3d3d 202d 494e 4649   (SR[j] == -INFI
-0006d470: 4e49 5459 2920 7b0a 2020 2020 2020 2020  NITY) {.        
-0006d480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d490: 2020 2020 2020 2020 5357 5b6a 5d20 3d20          SW[j] = 
-0006d4a0: 302e 3066 3b0a 2020 2020 2020 2020 2020  0.0f;.          
+0006d410: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+0006d420: 5352 203d 2020 5320 2b20 693b 0a20 2020  SR =  S + i;.   
+0006d430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d440: 2020 2020 2066 6c6f 6174 202a 2053 5720       float * SW 
+0006d450: 3d20 534d 202b 2069 3b0a 0a20 2020 2020  = SM + i;..     
+0006d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d470: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
+0006d480: 303b 206a 203c 2047 474d 4c5f 534f 4654  0; j < GGML_SOFT
+0006d490: 5f4d 4158 5f55 4e52 4f4c 4c3b 202b 2b6a  _MAX_UNROLL; ++j
+0006d4a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
 0006d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d4c0: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-0006d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d4e0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0006d4f0: 6670 3136 5f74 2073 203d 2047 474d 4c5f  fp16_t s = GGML_
-0006d500: 4650 3332 5f54 4f5f 4650 3136 2853 525b  FP32_TO_FP16(SR[
-0006d510: 6a5d 202d 206d 6178 293b 0a20 2020 2020  j] - max);.     
-0006d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d530: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
-0006d540: 7928 2673 6376 745b 6a5d 2c20 2673 2c20  y(&scvt[j], &s, 
-0006d550: 7369 7a65 6f66 2875 696e 7431 365f 7429  sizeof(uint16_t)
-0006d560: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0006d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d580: 2020 2063 6f6e 7374 2066 6c6f 6174 2076     const float v
-0006d590: 616c 203d 2047 474d 4c5f 4650 3136 5f54  al = GGML_FP16_T
-0006d5a0: 4f5f 4650 3332 2874 6162 6c65 5f65 7870  O_FP32(table_exp
-0006d5b0: 5f66 3136 5b73 6376 745b 6a5d 5d29 3b0a  _f16[scvt[j]]);.
-0006d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d4c0: 6966 2028 5352 5b6a 5d20 3d3d 202d 494e  if (SR[j] == -IN
+0006d4d0: 4649 4e49 5459 2920 7b0a 2020 2020 2020  FINITY) {.      
+0006d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d4f0: 2020 2020 2020 2020 2020 5357 5b6a 5d20            SW[j] 
+0006d500: 3d20 302e 3066 3b0a 2020 2020 2020 2020  = 0.0f;.        
+0006d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d520: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+0006d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d540: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0006d550: 6c5f 6670 3136 5f74 2073 203d 2047 474d  l_fp16_t s = GGM
+0006d560: 4c5f 4650 3332 5f54 4f5f 4650 3136 2853  L_FP32_TO_FP16(S
+0006d570: 525b 6a5d 202d 206d 6178 293b 0a20 2020  R[j] - max);.   
+0006d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d590: 2020 2020 2020 2020 2020 2020 206d 656d               mem
+0006d5a0: 6370 7928 2673 6376 745b 6a5d 2c20 2673  cpy(&scvt[j], &s
+0006d5b0: 2c20 7369 7a65 6f66 2875 696e 7431 365f  , sizeof(uint16_
+0006d5c0: 7429 293b 0a20 2020 2020 2020 2020 2020  t));.           
 0006d5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d5e0: 7375 6d70 5b6a 5d20 2b3d 2028 6767 6d6c  sump[j] += (ggml
-0006d5f0: 5f66 6c6f 6174 2976 616c 3b0a 2020 2020  _float)val;.    
-0006d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d610: 2020 2020 2020 2020 2020 2020 5357 5b6a              SW[j
-0006d620: 5d20 3d20 7661 6c3b 0a20 2020 2020 2020  ] = val;.       
+0006d5e0: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
+0006d5f0: 2076 616c 203d 2047 474d 4c5f 4650 3136   val = GGML_FP16
+0006d600: 5f54 4f5f 4650 3332 2874 6162 6c65 5f65  _TO_FP32(table_e
+0006d610: 7870 5f66 3136 5b73 6376 745b 6a5d 5d29  xp_f16[scvt[j]])
+0006d620: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
 0006d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d640: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006d650: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0006d660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006d670: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0006d680: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0006d690: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-0006d6a0: 4747 4d4c 5f53 4f46 545f 4d41 585f 554e  GGML_SOFT_MAX_UN
-0006d6b0: 524f 4c4c 3b20 692b 2b29 207b 0a20 2020  ROLL; i++) {.   
-0006d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d6d0: 2020 2020 2073 756d 202b 3d20 7375 6d70       sum += sump
-0006d6e0: 5b69 5d3b 0a20 2020 2020 2020 2020 2020  [i];.           
-0006d6f0: 2020 2020 2020 2020 207d 0a23 656e 6469           }.#endi
-0006d700: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-0006d710: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-0006d720: 2020 2020 2061 7373 6572 7428 7375 6d20       assert(sum 
-0006d730: 3e20 302e 3029 3b0a 0a20 2020 2020 2020  > 0.0);..       
-0006d740: 2020 2020 2020 2020 2073 756d 203d 2031           sum = 1
-0006d750: 2e30 2f73 756d 3b0a 2020 2020 2020 2020  .0/sum;.        
-0006d760: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0006d770: 5f73 6361 6c65 5f66 3332 284d 2c20 534d  _scale_f32(M, SM
-0006d780: 2c20 7375 6d29 3b0a 0a20 2020 2020 2020  , sum);..       
-0006d790: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0006d7a0: 2020 2020 2f2f 2073 7465 702d 6279 2d73      // step-by-s
-0006d7b0: 7465 7020 6578 706c 616e 6174 696f 6e0a  tep explanation.
-0006d7c0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0006d7d0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006d7e0: 2066 6f72 7761 7264 2d70 726f 6365 7373   forward-process
-0006d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d800: 2020 2073 6861 7065 2020 2020 2020 6772     shape      gr
-0006d810: 6164 7320 6672 6f6d 2062 6163 6b77 6172  ads from backwar
-0006d820: 6420 7072 6f63 6573 730a 2020 2020 2020  d process.      
-0006d830: 2020 2020 2020 2020 2020 2f2f 2070 6172            // par
-0006d840: 616c 6c65 6c5f 666f 7220 6971 322c 6971  allel_for iq2,iq
-0006d850: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
-0006d860: 2020 202f 2f20 206b 5b3a 442c 3a4d 2c3a     //  k[:D,:M,:
-0006d870: 2c3a 5d20 2020 2020 2020 2020 2020 2020  ,:]             
-0006d880: 2020 2020 2020 2020 5b44 2c4d 2c3a 2c3a          [D,M,:,:
-0006d890: 5d20 2067 7261 645b 6b5d 5b3a 442c 3a4d  ]  grad[k][:D,:M
-0006d8a0: 2c69 7132 2c69 7133 5d20 202b 3d20 6772  ,iq2,iq3]  += gr
-0006d8b0: 6164 5b6b 6375 725d 0a20 2020 2020 2020  ad[kcur].       
-0006d8c0: 2020 2020 2020 2020 202f 2f20 2071 5b3a           //  q[:
-0006d8d0: 442c 3a4e 2c3a 2c3a 5d20 2020 2020 2020  D,:N,:,:]       
-0006d8e0: 2020 2020 2020 2020 2020 2020 2020 5b44                [D
-0006d8f0: 2c4e 2c3a 2c3a 5d20 2067 7261 645b 715d  ,N,:,:]  grad[q]
-0006d900: 5b3a 442c 6971 312c 6971 322c 6971 335d  [:D,iq1,iq2,iq3]
-0006d910: 202b 3d20 6772 6164 5b71 6375 725d 0a20   += grad[qcur]. 
-0006d920: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006d930: 2f20 2076 5b3a 4d2c 3a44 2c3a 2c3a 5d20  /  v[:M,:D,:,:] 
+0006d640: 2020 7375 6d70 5b6a 5d20 2b3d 2028 6767    sump[j] += (gg
+0006d650: 6d6c 5f66 6c6f 6174 2976 616c 3b0a 2020  ml_float)val;.  
+0006d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d670: 2020 2020 2020 2020 2020 2020 2020 5357                SW
+0006d680: 5b6a 5d20 3d20 7661 6c3b 0a20 2020 2020  [j] = val;.     
+0006d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d6a0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0006d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d6c0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0006d6d0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0006d6e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0006d6f0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+0006d700: 3c20 4747 4d4c 5f53 4f46 545f 4d41 585f  < GGML_SOFT_MAX_
+0006d710: 554e 524f 4c4c 3b20 692b 2b29 207b 0a20  UNROLL; i++) {. 
+0006d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d730: 2020 2020 2020 2073 756d 202b 3d20 7375         sum += su
+0006d740: 6d70 5b69 5d3b 0a20 2020 2020 2020 2020  mp[i];.         
+0006d750: 2020 2020 2020 2020 2020 207d 0a23 656e             }.#en
+0006d760: 6469 660a 2020 2020 2020 2020 2020 2020  dif.            
+0006d770: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0006d780: 2020 2020 2020 2061 7373 6572 7428 7375         assert(su
+0006d790: 6d20 3e20 302e 3029 3b0a 0a20 2020 2020  m > 0.0);..     
+0006d7a0: 2020 2020 2020 2020 2020 2073 756d 203d             sum =
+0006d7b0: 2031 2e30 2f73 756d 3b0a 2020 2020 2020   1.0/sum;.      
+0006d7c0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+0006d7d0: 6563 5f73 6361 6c65 5f66 3332 284d 2c20  ec_scale_f32(M, 
+0006d7e0: 534d 2c20 7375 6d29 3b0a 0a20 2020 2020  SM, sum);..     
+0006d7f0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0006d800: 2020 2020 2020 2f2f 2073 7465 702d 6279        // step-by
+0006d810: 2d73 7465 7020 6578 706c 616e 6174 696f  -step explanatio
+0006d820: 6e0a 2020 2020 2020 2020 2020 2020 7b0a  n.            {.
+0006d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006d840: 2f2f 2066 6f72 7761 7264 2d70 726f 6365  // forward-proce
+0006d850: 7373 2020 2020 2020 2020 2020 2020 2020  ss              
+0006d860: 2020 2020 2073 6861 7065 2020 2020 2020       shape      
+0006d870: 6772 6164 7320 6672 6f6d 2062 6163 6b77  grads from backw
+0006d880: 6172 6420 7072 6f63 6573 730a 2020 2020  ard process.    
+0006d890: 2020 2020 2020 2020 2020 2020 2f2f 2070              // p
+0006d8a0: 6172 616c 6c65 6c5f 666f 7220 6971 322c  arallel_for iq2,
+0006d8b0: 6971 333a 0a20 2020 2020 2020 2020 2020  iq3:.           
+0006d8c0: 2020 2020 202f 2f20 206b 5b3a 442c 3a4d       //  k[:D,:M
+0006d8d0: 2c3a 2c3a 5d20 2020 2020 2020 2020 2020  ,:,:]           
+0006d8e0: 2020 2020 2020 2020 2020 5b44 2c4d 2c3a            [D,M,:
+0006d8f0: 2c3a 5d20 2067 7261 645b 6b5d 5b3a 442c  ,:]  grad[k][:D,
+0006d900: 3a4d 2c69 7132 2c69 7133 5d20 202b 3d20  :M,iq2,iq3]  += 
+0006d910: 6772 6164 5b6b 6375 725d 0a20 2020 2020  grad[kcur].     
+0006d920: 2020 2020 2020 2020 2020 202f 2f20 2071             //  q
+0006d930: 5b3a 442c 3a4e 2c3a 2c3a 5d20 2020 2020  [:D,:N,:,:]     
 0006d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006d950: 2020 2020 5b4d 2c44 2c3a 2c3a 5d20 2067      [M,D,:,:]  g
-0006d960: 7261 645b 765d 5b3a 4d2c 3a44 2c69 7132  rad[v][:M,:D,iq2
-0006d970: 2c69 7133 5d20 202b 3d20 6772 6164 5b76  ,iq3]  += grad[v
-0006d980: 6375 725d 0a20 2020 2020 2020 2020 2020  cur].           
-0006d990: 2020 2020 202f 2f20 2066 6f72 2069 7131       //  for iq1
-0006d9a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0006d9b0: 2020 2f2f 2020 206b 6375 7220 2020 3d20    //   kcur   = 
-0006d9c0: 6b5b 3a44 2c3a 4d2c 6971 322c 6971 335d  k[:D,:M,iq2,iq3]
-0006d9d0: 2020 2020 2020 205b 442c 4d2c 312c 315d         [D,M,1,1]
-0006d9e0: 2020 6772 6164 5b6b 6375 725d 203d 2067    grad[kcur] = g
-0006d9f0: 7261 645b 5331 5d2e 5420 4020 7163 7572  rad[S1].T @ qcur
-0006da00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006da10: 202f 2f20 2020 7163 7572 2020 203d 2071   //   qcur   = q
-0006da20: 5b3a 442c 6971 312c 6971 322c 6971 335d  [:D,iq1,iq2,iq3]
-0006da30: 2020 2020 2020 5b44 2c31 2c31 2c31 5d20        [D,1,1,1] 
-0006da40: 2067 7261 645b 7163 7572 5d20 3d20 6772   grad[qcur] = gr
-0006da50: 6164 5b53 315d 2020 2040 206b 6375 720a  ad[S1]   @ kcur.
-0006da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006da70: 2f2f 2020 2076 6375 7220 2020 3d20 765b  //   vcur   = v[
-0006da80: 3a4d 2c3a 442c 6971 322c 6971 335d 2020  :M,:D,iq2,iq3]  
-0006da90: 2020 2020 205b 4d2c 442c 312c 315d 2020       [M,D,1,1]  
-0006daa0: 6772 6164 5b76 6375 725d 203d 2067 7261  grad[vcur] = gra
-0006dab0: 645b 5335 5d2e 5420 4020 5334 0a20 2020  d[S5].T @ S4.   
-0006dac0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006dad0: 2020 5330 2020 2020 203d 202d 496e 6620    S0     = -Inf 
-0006dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006daf0: 2020 5b44 2c31 2c31 2c31 5d0a 2020 2020    [D,1,1,1].    
-0006db00: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
-0006db10: 7e53 315b 695d 2020 3d20 646f 7428 6b63  ~S1[i]  = dot(kc
-0006db20: 7572 5b3a 442c 695d 2c20 7163 7572 290a  ur[:D,i], qcur).
-0006db30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006db40: 2f2f 2020 2053 3120 2020 2020 3d20 7163  //   S1     = qc
-0006db50: 7572 2040 206b 6375 722e 5420 2020 2020  ur @ kcur.T     
-0006db60: 2020 2020 205b 4d2c 312c 312c 315d 2020       [M,1,1,1]  
-0006db70: 6772 6164 5b53 315d 2020 203d 2067 7261  grad[S1]   = gra
-0006db80: 645b 5332 5d20 2a20 7363 616c 650a 2020  d[S2] * scale.  
-0006db90: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006dba0: 2020 2053 3220 2020 2020 3d20 5331 202a     S2     = S1 *
-0006dbb0: 2073 6361 6c65 2020 2020 2020 2020 2020   scale          
-0006dbc0: 2020 205b 4d2c 312c 312c 315d 2020 6772     [M,1,1,1]  gr
-0006dbd0: 6164 5b53 325d 2020 203d 2064 6961 675f  ad[S2]   = diag_
-0006dbe0: 6d61 736b 5f7a 6572 6f28 6772 6164 5b53  mask_zero(grad[S
-0006dbf0: 335d 2c20 5029 0a20 2020 2020 2020 2020  3], P).         
-0006dc00: 2020 2020 2020 202f 2f20 2020 5333 2020         //   S3  
-0006dc10: 2020 203d 2064 6961 675f 6d61 736b 5f69     = diag_mask_i
-0006dc20: 6e66 2853 322c 2050 2920 2020 5b4d 2c31  nf(S2, P)   [M,1
-0006dc30: 2c31 2c31 5d20 2067 7261 645b 5333 5d20  ,1,1]  grad[S3] 
-0006dc40: 2020 3d20 5334 202a 2028 6772 6164 5b53    = S4 * (grad[S
-0006dc50: 345d 202d 2064 6f74 2853 342c 2067 7261  4] - dot(S4, gra
-0006dc60: 645b 5334 5d29 290a 2020 2020 2020 2020  d[S4])).        
-0006dc70: 2020 2020 2020 2020 2f2f 2020 2053 3420          //   S4 
-0006dc80: 2020 2020 3d20 736f 6674 6d61 7828 5333      = softmax(S3
-0006dc90: 2920 2020 2020 2020 2020 2020 205b 4d2c  )            [M,
-0006dca0: 312c 312c 315d 2020 6772 6164 5b53 345d  1,1,1]  grad[S4]
-0006dcb0: 2020 203d 2067 7261 645b 5335 5d20 4020     = grad[S5] @ 
-0006dcc0: 7663 7572 0a20 2020 2020 2020 2020 2020  vcur.           
-0006dcd0: 2020 2020 202f 2f20 207e 5335 5b69 5d20       //  ~S5[i] 
-0006dce0: 203d 2064 6f74 2876 6375 725b 3a2c 695d   = dot(vcur[:,i]
-0006dcf0: 2c20 5334 290a 2020 2020 2020 2020 2020  , S4).          
-0006dd00: 2020 2020 2020 2f2f 2020 2053 3520 2020        //   S5   
-0006dd10: 2020 3d20 5334 2040 2076 6375 722e 5420    = S4 @ vcur.T 
-0006dd20: 2020 2020 2020 2020 2020 205b 442c 312c             [D,1,
-0006dd30: 312c 315d 2020 6772 6164 5b53 355d 2020  1,1]  grad[S5]  
-0006dd40: 203d 2064 5b3a 442c 6971 312c 6971 322c   = d[:D,iq1,iq2,
-0006dd50: 6971 335d 0a20 2020 2020 2020 2020 2020  iq3].           
-0006dd60: 2020 2020 202f 2f20 207e 6473 745b 692c       //  ~dst[i,
-0006dd70: 6971 312c 6971 322c 6971 335d 2020 3d20  iq1,iq2,iq3]  = 
-0006dd80: 5335 5b69 5d20 2020 2020 2020 2020 2020  S5[i]           
-0006dd90: 2020 205e 0a20 2020 2020 2020 2020 2020     ^.           
-0006dda0: 2020 2020 202f 2f20 2020 6473 745b 3a44       //   dst[:D
-0006ddb0: 2c69 7131 2c69 7132 2c69 7133 5d20 3d20  ,iq1,iq2,iq3] = 
-0006ddc0: 5335 2020 2020 2020 2020 2020 2020 2020  S5              
-0006ddd0: 2020 207c 2067 7261 645b 6473 745b 3a44     | grad[dst[:D
-0006dde0: 2c69 7131 2c69 7132 2c69 7133 5d5d 203d  ,iq1,iq2,iq3]] =
-0006ddf0: 2064 5b3a 442c 6971 312c 6971 322c 6971   d[:D,iq1,iq2,iq
-0006de00: 335d 0a20 2020 2020 2020 2020 2020 2020  3].             
-0006de10: 2020 202f 2f20 6473 7420 2020 2020 2020     // dst       
-0006de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006de30: 2020 2020 2020 2020 6261 636b 7761 7264          backward
-0006de40: 2d2f 2067 7261 645b 6473 745d 2020 2020  -/ grad[dst]    
-0006de50: 2020 2020 2020 2020 2020 2020 203d 2064               = d
-0006de60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006de70: 202f 2f0a 2020 2020 2020 2020 2020 2020   //.            
-0006de80: 2020 2020 2f2f 206f 7574 7075 7420 6772      // output gr
-0006de90: 6164 6965 6e74 7320 7769 7468 2074 6865  adients with the
-0006dea0: 6972 2064 6570 656e 6465 6e63 6965 733a  ir dependencies:
-0006deb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006dec0: 202f 2f0a 2020 2020 2020 2020 2020 2020   //.            
-0006ded0: 2020 2020 2f2f 2067 7261 645b 6b63 7572      // grad[kcur
-0006dee0: 5d20 3d20 6772 6164 5b53 315d 2e54 2040  ] = grad[S1].T @
-0006def0: 2071 6375 720a 2020 2020 2020 2020 2020   qcur.          
-0006df00: 2020 2020 2020 2f2f 2067 7261 645b 5331        // grad[S1
-0006df10: 5d20 2020 3d20 6469 6167 5f6d 6173 6b5f  ]   = diag_mask_
-0006df20: 7a65 726f 2867 7261 645b 5333 5d2c 2050  zero(grad[S3], P
-0006df30: 2920 2a20 7363 616c 650a 2020 2020 2020  ) * scale.      
-0006df40: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0006df50: 645b 5333 5d20 2020 3d20 5334 202a 2028  d[S3]   = S4 * (
-0006df60: 6772 6164 5b53 345d 202d 2064 6f74 2853  grad[S4] - dot(S
-0006df70: 342c 2067 7261 645b 5334 5d29 290a 2020  4, grad[S4])).  
-0006df80: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006df90: 2067 7261 645b 5334 5d20 2020 3d20 6772   grad[S4]   = gr
-0006dfa0: 6164 5b53 355d 2040 2076 6375 720a 2020  ad[S5] @ vcur.  
-0006dfb0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006dfc0: 2067 7261 645b 5334 5d20 2020 3d20 645b   grad[S4]   = d[
-0006dfd0: 3a44 2c69 7131 2c69 7132 2c69 7133 5d20  :D,iq1,iq2,iq3] 
-0006dfe0: 4020 7663 7572 0a20 2020 2020 2020 2020  @ vcur.         
-0006dff0: 2020 2020 2020 202f 2f20 6772 6164 5b71         // grad[q
-0006e000: 6375 725d 203d 2067 7261 645b 5331 5d20  cur] = grad[S1] 
-0006e010: 2020 4020 6b63 7572 0a20 2020 2020 2020    @ kcur.       
-0006e020: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
-0006e030: 5b76 6375 725d 203d 2067 7261 645b 5335  [vcur] = grad[S5
-0006e040: 5d2e 5420 4020 5334 0a20 2020 2020 2020  ].T @ S4.       
+0006d950: 5b44 2c4e 2c3a 2c3a 5d20 2067 7261 645b  [D,N,:,:]  grad[
+0006d960: 715d 5b3a 442c 6971 312c 6971 322c 6971  q][:D,iq1,iq2,iq
+0006d970: 335d 202b 3d20 6772 6164 5b71 6375 725d  3] += grad[qcur]
+0006d980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006d990: 202f 2f20 2076 5b3a 4d2c 3a44 2c3a 2c3a   //  v[:M,:D,:,:
+0006d9a0: 5d20 2020 2020 2020 2020 2020 2020 2020  ]               
+0006d9b0: 2020 2020 2020 5b4d 2c44 2c3a 2c3a 5d20        [M,D,:,:] 
+0006d9c0: 2067 7261 645b 765d 5b3a 4d2c 3a44 2c69   grad[v][:M,:D,i
+0006d9d0: 7132 2c69 7133 5d20 202b 3d20 6772 6164  q2,iq3]  += grad
+0006d9e0: 5b76 6375 725d 0a20 2020 2020 2020 2020  [vcur].         
+0006d9f0: 2020 2020 2020 202f 2f20 2066 6f72 2069         //  for i
+0006da00: 7131 3a0a 2020 2020 2020 2020 2020 2020  q1:.            
+0006da10: 2020 2020 2f2f 2020 206b 6375 7220 2020      //   kcur   
+0006da20: 3d20 6b5b 3a44 2c3a 4d2c 6971 322c 6971  = k[:D,:M,iq2,iq
+0006da30: 335d 2020 2020 2020 205b 442c 4d2c 312c  3]       [D,M,1,
+0006da40: 315d 2020 6772 6164 5b6b 6375 725d 203d  1]  grad[kcur] =
+0006da50: 2067 7261 645b 5331 5d2e 5420 4020 7163   grad[S1].T @ qc
+0006da60: 7572 0a20 2020 2020 2020 2020 2020 2020  ur.             
+0006da70: 2020 202f 2f20 2020 7163 7572 2020 203d     //   qcur   =
+0006da80: 2071 5b3a 442c 6971 312c 6971 322c 6971   q[:D,iq1,iq2,iq
+0006da90: 335d 2020 2020 2020 5b44 2c31 2c31 2c31  3]      [D,1,1,1
+0006daa0: 5d20 2067 7261 645b 7163 7572 5d20 3d20  ]  grad[qcur] = 
+0006dab0: 6772 6164 5b53 315d 2020 2040 206b 6375  grad[S1]   @ kcu
+0006dac0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0006dad0: 2020 2f2f 2020 2076 6375 7220 2020 3d20    //   vcur   = 
+0006dae0: 765b 3a4d 2c3a 442c 6971 322c 6971 335d  v[:M,:D,iq2,iq3]
+0006daf0: 2020 2020 2020 205b 4d2c 442c 312c 315d         [M,D,1,1]
+0006db00: 2020 6772 6164 5b76 6375 725d 203d 2067    grad[vcur] = g
+0006db10: 7261 645b 5335 5d2e 5420 4020 5334 0a20  rad[S5].T @ S4. 
+0006db20: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006db30: 2f20 2020 5330 2020 2020 203d 202d 496e  /   S0     = -In
+0006db40: 6620 2020 2020 2020 2020 2020 2020 2020  f               
+0006db50: 2020 2020 5b44 2c31 2c31 2c31 5d0a 2020      [D,1,1,1].  
+0006db60: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006db70: 2020 7e53 315b 695d 2020 3d20 646f 7428    ~S1[i]  = dot(
+0006db80: 6b63 7572 5b3a 442c 695d 2c20 7163 7572  kcur[:D,i], qcur
+0006db90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0006dba0: 2020 2f2f 2020 2053 3120 2020 2020 3d20    //   S1     = 
+0006dbb0: 7163 7572 2040 206b 6375 722e 5420 2020  qcur @ kcur.T   
+0006dbc0: 2020 2020 2020 205b 4d2c 312c 312c 315d         [M,1,1,1]
+0006dbd0: 2020 6772 6164 5b53 315d 2020 203d 2067    grad[S1]   = g
+0006dbe0: 7261 645b 5332 5d20 2a20 7363 616c 650a  rad[S2] * scale.
+0006dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dc00: 2f2f 2020 2053 3220 2020 2020 3d20 5331  //   S2     = S1
+0006dc10: 202a 2073 6361 6c65 2020 2020 2020 2020   * scale        
+0006dc20: 2020 2020 205b 4d2c 312c 312c 315d 2020       [M,1,1,1]  
+0006dc30: 6772 6164 5b53 325d 2020 203d 2064 6961  grad[S2]   = dia
+0006dc40: 675f 6d61 736b 5f7a 6572 6f28 6772 6164  g_mask_zero(grad
+0006dc50: 5b53 335d 2c20 5029 0a20 2020 2020 2020  [S3], P).       
+0006dc60: 2020 2020 2020 2020 202f 2f20 2020 5333           //   S3
+0006dc70: 2020 2020 203d 2064 6961 675f 6d61 736b       = diag_mask
+0006dc80: 5f69 6e66 2853 322c 2050 2920 2020 5b4d  _inf(S2, P)   [M
+0006dc90: 2c31 2c31 2c31 5d20 2067 7261 645b 5333  ,1,1,1]  grad[S3
+0006dca0: 5d20 2020 3d20 5334 202a 2028 6772 6164  ]   = S4 * (grad
+0006dcb0: 5b53 345d 202d 2064 6f74 2853 342c 2067  [S4] - dot(S4, g
+0006dcc0: 7261 645b 5334 5d29 290a 2020 2020 2020  rad[S4])).      
+0006dcd0: 2020 2020 2020 2020 2020 2f2f 2020 2053            //   S
+0006dce0: 3420 2020 2020 3d20 736f 6674 6d61 7828  4     = softmax(
+0006dcf0: 5333 2920 2020 2020 2020 2020 2020 205b  S3)            [
+0006dd00: 4d2c 312c 312c 315d 2020 6772 6164 5b53  M,1,1,1]  grad[S
+0006dd10: 345d 2020 203d 2067 7261 645b 5335 5d20  4]   = grad[S5] 
+0006dd20: 4020 7663 7572 0a20 2020 2020 2020 2020  @ vcur.         
+0006dd30: 2020 2020 2020 202f 2f20 207e 5335 5b69         //  ~S5[i
+0006dd40: 5d20 203d 2064 6f74 2876 6375 725b 3a2c  ]  = dot(vcur[:,
+0006dd50: 695d 2c20 5334 290a 2020 2020 2020 2020  i], S4).        
+0006dd60: 2020 2020 2020 2020 2f2f 2020 2053 3520          //   S5 
+0006dd70: 2020 2020 3d20 5334 2040 2076 6375 722e      = S4 @ vcur.
+0006dd80: 5420 2020 2020 2020 2020 2020 205b 442c  T            [D,
+0006dd90: 312c 312c 315d 2020 6772 6164 5b53 355d  1,1,1]  grad[S5]
+0006dda0: 2020 203d 2064 5b3a 442c 6971 312c 6971     = d[:D,iq1,iq
+0006ddb0: 322c 6971 335d 0a20 2020 2020 2020 2020  2,iq3].         
+0006ddc0: 2020 2020 2020 202f 2f20 207e 6473 745b         //  ~dst[
+0006ddd0: 692c 6971 312c 6971 322c 6971 335d 2020  i,iq1,iq2,iq3]  
+0006dde0: 3d20 5335 5b69 5d20 2020 2020 2020 2020  = S5[i]         
+0006ddf0: 2020 2020 205e 0a20 2020 2020 2020 2020       ^.         
+0006de00: 2020 2020 2020 202f 2f20 2020 6473 745b         //   dst[
+0006de10: 3a44 2c69 7131 2c69 7132 2c69 7133 5d20  :D,iq1,iq2,iq3] 
+0006de20: 3d20 5335 2020 2020 2020 2020 2020 2020  = S5            
+0006de30: 2020 2020 207c 2067 7261 645b 6473 745b       | grad[dst[
+0006de40: 3a44 2c69 7131 2c69 7132 2c69 7133 5d5d  :D,iq1,iq2,iq3]]
+0006de50: 203d 2064 5b3a 442c 6971 312c 6971 322c   = d[:D,iq1,iq2,
+0006de60: 6971 335d 0a20 2020 2020 2020 2020 2020  iq3].           
+0006de70: 2020 2020 202f 2f20 6473 7420 2020 2020       // dst     
+0006de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006de90: 2020 2020 2020 2020 2020 6261 636b 7761            backwa
+0006dea0: 7264 2d2f 2067 7261 645b 6473 745d 2020  rd-/ grad[dst]  
+0006deb0: 2020 2020 2020 2020 2020 2020 2020 203d                 =
+0006dec0: 2064 0a20 2020 2020 2020 2020 2020 2020   d.             
+0006ded0: 2020 202f 2f0a 2020 2020 2020 2020 2020     //.          
+0006dee0: 2020 2020 2020 2f2f 206f 7574 7075 7420        // output 
+0006def0: 6772 6164 6965 6e74 7320 7769 7468 2074  gradients with t
+0006df00: 6865 6972 2064 6570 656e 6465 6e63 6965  heir dependencie
+0006df10: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0006df20: 2020 202f 2f0a 2020 2020 2020 2020 2020     //.          
+0006df30: 2020 2020 2020 2f2f 2067 7261 645b 6b63        // grad[kc
+0006df40: 7572 5d20 3d20 6772 6164 5b53 315d 2e54  ur] = grad[S1].T
+0006df50: 2040 2071 6375 720a 2020 2020 2020 2020   @ qcur.        
+0006df60: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+0006df70: 5331 5d20 2020 3d20 6469 6167 5f6d 6173  S1]   = diag_mas
+0006df80: 6b5f 7a65 726f 2867 7261 645b 5333 5d2c  k_zero(grad[S3],
+0006df90: 2050 2920 2a20 7363 616c 650a 2020 2020   P) * scale.    
+0006dfa0: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0006dfb0: 7261 645b 5333 5d20 2020 3d20 5334 202a  rad[S3]   = S4 *
+0006dfc0: 2028 6772 6164 5b53 345d 202d 2064 6f74   (grad[S4] - dot
+0006dfd0: 2853 342c 2067 7261 645b 5334 5d29 290a  (S4, grad[S4])).
+0006dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006dff0: 2f2f 2067 7261 645b 5334 5d20 2020 3d20  // grad[S4]   = 
+0006e000: 6772 6164 5b53 355d 2040 2076 6375 720a  grad[S5] @ vcur.
+0006e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e020: 2f2f 2067 7261 645b 5334 5d20 2020 3d20  // grad[S4]   = 
+0006e030: 645b 3a44 2c69 7131 2c69 7132 2c69 7133  d[:D,iq1,iq2,iq3
+0006e040: 5d20 4020 7663 7572 0a20 2020 2020 2020  ] @ vcur.       
 0006e050: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
-0006e060: 5b76 6375 725d 203d 2064 5b3a 442c 6971  [vcur] = d[:D,iq
-0006e070: 312c 6971 322c 6971 335d 2e54 2040 2053  1,iq2,iq3].T @ S
-0006e080: 340a 2020 2020 2020 2020 2020 2020 2020  4.              
-0006e090: 2020 2f2f 0a20 2020 2020 2020 2020 2020    //.           
-0006e0a0: 2020 2020 202f 2f20 696e 2070 6f73 742d       // in post-
-0006e0b0: 6f72 6465 723a 0a20 2020 2020 2020 2020  order:.         
-0006e0c0: 2020 2020 2020 202f 2f0a 2020 2020 2020         //.      
-0006e0d0: 2020 2020 2020 2020 2020 2f2f 2053 3120            // S1 
-0006e0e0: 2020 2020 2020 2020 3d20 7163 7572 2040          = qcur @
-0006e0f0: 206b 6375 722e 540a 2020 2020 2020 2020   kcur.T.        
-0006e100: 2020 2020 2020 2020 2f2f 2053 3220 2020          // S2   
-0006e110: 2020 2020 2020 3d20 5331 202a 2073 6361        = S1 * sca
-0006e120: 6c65 0a20 2020 2020 2020 2020 2020 2020  le.             
-0006e130: 2020 202f 2f20 5333 2020 2020 2020 2020     // S3        
-0006e140: 203d 2064 6961 675f 6d61 736b 5f69 6e66   = diag_mask_inf
-0006e150: 2853 322c 2050 290a 2020 2020 2020 2020  (S2, P).        
-0006e160: 2020 2020 2020 2020 2f2f 2053 3420 2020          // S4   
-0006e170: 2020 2020 2020 3d20 736f 6674 6d61 7828        = softmax(
-0006e180: 5333 290a 2020 2020 2020 2020 2020 2020  S3).            
-0006e190: 2020 2020 2f2f 2067 7261 645b 5334 5d20      // grad[S4] 
-0006e1a0: 2020 3d20 645b 3a44 2c69 7131 2c69 7132    = d[:D,iq1,iq2
-0006e1b0: 2c69 7133 5d20 4020 7663 7572 0a20 2020  ,iq3] @ vcur.   
-0006e1c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006e1d0: 6772 6164 5b53 335d 2020 203d 2053 3420  grad[S3]   = S4 
-0006e1e0: 2a20 2867 7261 645b 5334 5d20 2d20 646f  * (grad[S4] - do
-0006e1f0: 7428 5334 2c20 6772 6164 5b53 345d 2929  t(S4, grad[S4]))
-0006e200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e210: 202f 2f20 6772 6164 5b53 315d 2020 203d   // grad[S1]   =
-0006e220: 2064 6961 675f 6d61 736b 5f7a 6572 6f28   diag_mask_zero(
-0006e230: 6772 6164 5b53 335d 2c20 5029 202a 2073  grad[S3], P) * s
-0006e240: 6361 6c65 0a20 2020 2020 2020 2020 2020  cale.           
-0006e250: 2020 2020 202f 2f20 6772 6164 5b71 6375       // grad[qcu
-0006e260: 725d 203d 2067 7261 645b 5331 5d20 2020  r] = grad[S1]   
-0006e270: 4020 6b63 7572 0a20 2020 2020 2020 2020  @ kcur.         
-0006e280: 2020 2020 2020 202f 2f20 6772 6164 5b6b         // grad[k
-0006e290: 6375 725d 203d 2067 7261 645b 5331 5d2e  cur] = grad[S1].
-0006e2a0: 5420 4020 7163 7572 0a20 2020 2020 2020  T @ qcur.       
-0006e2b0: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
-0006e2c0: 5b76 6375 725d 203d 2064 5b3a 442c 6971  [vcur] = d[:D,iq
-0006e2d0: 312c 6971 322c 6971 335d 2e54 2040 2053  1,iq2,iq3].T @ S
-0006e2e0: 340a 2020 2020 2020 2020 2020 2020 2020  4.              
-0006e2f0: 2020 2f2f 0a20 2020 2020 2020 2020 2020    //.           
-0006e300: 2020 2020 202f 2f20 7573 696e 6720 6c65       // using le
-0006e310: 7373 2076 6172 6961 626c 6573 2028 534d  ss variables (SM
-0006e320: 3d53 3429 3a0a 2020 2020 2020 2020 2020  =S4):.          
-0006e330: 2020 2020 2020 2f2f 0a20 2020 2020 2020        //.       
-0006e340: 2020 2020 2020 2020 202f 2f20 5320 2020           // S   
-0006e350: 2020 2020 2020 2020 2020 3d20 6469 6167            = diag
-0006e360: 5f6d 6173 6b5f 696e 6628 7163 7572 2040  _mask_inf(qcur @
-0006e370: 206b 6375 722e 5420 2a20 7363 616c 652c   kcur.T * scale,
-0006e380: 2050 290a 2020 2020 2020 2020 2020 2020   P).            
-0006e390: 2020 2020 2f2f 2053 4d20 2020 2020 2020      // SM       
-0006e3a0: 2020 2020 203d 2073 6f66 746d 6178 2853       = softmax(S
-0006e3b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0006e3c0: 2020 2f2f 2053 2020 2020 2020 2020 2020    // S          
-0006e3d0: 2020 203d 2064 5b3a 442c 6971 312c 6971     = d[:D,iq1,iq
-0006e3e0: 322c 6971 335d 2040 2076 6375 720a 2020  2,iq3] @ vcur.  
-0006e3f0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0006e400: 2064 6f74 5f53 4d5f 6772 6164 534d 203d   dot_SM_gradSM =
-0006e410: 2064 6f74 2853 4d2c 2053 290a 2020 2020   dot(SM, S).    
-0006e420: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
-0006e430: 2020 2020 2020 2020 2020 2020 203d 2053               = S
-0006e440: 4d20 2a20 2853 202d 2064 6f74 2853 4d2c  M * (S - dot(SM,
-0006e450: 2053 2929 0a20 2020 2020 2020 2020 2020   S)).           
-0006e460: 2020 2020 202f 2f20 5320 2020 2020 2020       // S       
-0006e470: 2020 2020 2020 3d20 6469 6167 5f6d 6173        = diag_mas
-0006e480: 6b5f 7a65 726f 2853 2c20 5029 202a 2073  k_zero(S, P) * s
-0006e490: 6361 6c65 0a20 2020 2020 2020 2020 2020  cale.           
-0006e4a0: 2020 2020 202f 2f0a 2020 2020 2020 2020       //.        
-0006e4b0: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
-0006e4c0: 715d 5b3a 442c 6971 312c 6971 322c 6971  q][:D,iq1,iq2,iq
-0006e4d0: 335d 202b 3d20 5320 2020 4020 6b63 7572  3] += S   @ kcur
-0006e4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e4f0: 202f 2f20 6772 6164 5b6b 5d5b 3a44 2c3a   // grad[k][:D,:
-0006e500: 4d2c 6971 322c 6971 335d 2020 2b3d 2053  M,iq2,iq3]  += S
-0006e510: 2e54 2040 2071 6375 720a 2020 2020 2020  .T @ qcur.      
-0006e520: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
-0006e530: 645b 765d 5b3a 4d2c 3a44 2c69 7132 2c69  d[v][:M,:D,iq2,i
-0006e540: 7133 5d20 202b 3d20 645b 3a44 2c69 7131  q3]  += d[:D,iq1
-0006e550: 2c69 7132 2c69 7133 5d2e 5420 4020 534d  ,iq2,iq3].T @ SM
-0006e560: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-0006e570: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
-0006e580: 203d 2067 7261 6453 4d20 3d20 645b 3a44   = gradSM = d[:D
-0006e590: 2c69 7131 2c69 7132 2c69 7133 5d20 4020  ,iq1,iq2,iq3] @ 
-0006e5a0: 7663 7572 0a20 2020 2020 2020 2020 2020  vcur.           
-0006e5b0: 202f 2f20 5320 3d20 645b 3a44 2c69 7131   // S = d[:D,iq1
-0006e5c0: 2c69 7132 2c69 7133 5d20 4020 7663 7572  ,iq2,iq3] @ vcur
-0006e5d0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006e5e0: 535b 3a4d 5d20 2b3d 2076 6375 725b 3a4d  S[:M] += vcur[:M
-0006e5f0: 2c69 635d 202a 2064 5b69 632c 6971 312c  ,ic] * d[ic,iq1,
-0006e600: 6971 322c 6971 335d 0a20 2020 2020 2020  iq2,iq3].       
-0006e610: 2020 2020 2067 676d 6c5f 7665 635f 7365       ggml_vec_se
-0006e620: 745f 6633 3228 4d2c 2053 2c20 3029 3b0a  t_f32(M, S, 0);.
-0006e630: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0006e640: 2869 6e74 3634 5f74 2069 6320 3d20 303b  (int64_t ic = 0;
-0006e650: 2069 6320 3c20 443b 202b 2b69 6329 207b   ic < D; ++ic) {
-0006e660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e670: 202f 2f20 6473 7420 696e 6469 6365 730a   // dst indices.
-0006e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e690: 636f 6e73 7420 696e 7420 6931 203d 2069  const int i1 = i
-0006e6a0: 7131 3b0a 2020 2020 2020 2020 2020 2020  q1;.            
-0006e6b0: 2020 2020 636f 6e73 7420 696e 7420 6932      const int i2
-0006e6c0: 203d 2069 7132 3b0a 2020 2020 2020 2020   = iq2;.        
-0006e6d0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0006e6e0: 7420 6933 203d 2069 7133 3b0a 0a20 2020  t i3 = iq3;..   
-0006e6f0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0006e700: 6c5f 7665 635f 6d61 645f 6633 3228 4d2c  l_vec_mad_f32(M,
-0006e710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e720: 2020 2020 2020 2020 2053 2c0a 2020 2020           S,.    
-0006e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e740: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-0006e750: 2863 6861 7220 2a29 2076 2d3e 6461 7461  (char *) v->data
-0006e760: 202b 2028 2020 2020 2020 2020 2020 6963   + (          ic
-0006e770: 2a6e 6276 3120 2b20 6932 2a6e 6276 3220  *nbv1 + i2*nbv2 
-0006e780: 2b20 6933 2a6e 6276 3329 292c 0a20 2020  + i3*nbv3)),.   
+0006e060: 5b71 6375 725d 203d 2067 7261 645b 5331  [qcur] = grad[S1
+0006e070: 5d20 2020 4020 6b63 7572 0a20 2020 2020  ]   @ kcur.     
+0006e080: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0006e090: 6164 5b76 6375 725d 203d 2067 7261 645b  ad[vcur] = grad[
+0006e0a0: 5335 5d2e 5420 4020 5334 0a20 2020 2020  S5].T @ S4.     
+0006e0b0: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0006e0c0: 6164 5b76 6375 725d 203d 2064 5b3a 442c  ad[vcur] = d[:D,
+0006e0d0: 6971 312c 6971 322c 6971 335d 2e54 2040  iq1,iq2,iq3].T @
+0006e0e0: 2053 340a 2020 2020 2020 2020 2020 2020   S4.            
+0006e0f0: 2020 2020 2f2f 0a20 2020 2020 2020 2020      //.         
+0006e100: 2020 2020 2020 202f 2f20 696e 2070 6f73         // in pos
+0006e110: 742d 6f72 6465 723a 0a20 2020 2020 2020  t-order:.       
+0006e120: 2020 2020 2020 2020 202f 2f0a 2020 2020           //.    
+0006e130: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
+0006e140: 3120 2020 2020 2020 2020 3d20 7163 7572  1         = qcur
+0006e150: 2040 206b 6375 722e 540a 2020 2020 2020   @ kcur.T.      
+0006e160: 2020 2020 2020 2020 2020 2f2f 2053 3220            // S2 
+0006e170: 2020 2020 2020 2020 3d20 5331 202a 2073          = S1 * s
+0006e180: 6361 6c65 0a20 2020 2020 2020 2020 2020  cale.           
+0006e190: 2020 2020 202f 2f20 5333 2020 2020 2020       // S3      
+0006e1a0: 2020 203d 2064 6961 675f 6d61 736b 5f69     = diag_mask_i
+0006e1b0: 6e66 2853 322c 2050 290a 2020 2020 2020  nf(S2, P).      
+0006e1c0: 2020 2020 2020 2020 2020 2f2f 2053 3420            // S4 
+0006e1d0: 2020 2020 2020 2020 3d20 736f 6674 6d61          = softma
+0006e1e0: 7828 5333 290a 2020 2020 2020 2020 2020  x(S3).          
+0006e1f0: 2020 2020 2020 2f2f 2067 7261 645b 5334        // grad[S4
+0006e200: 5d20 2020 3d20 645b 3a44 2c69 7131 2c69  ]   = d[:D,iq1,i
+0006e210: 7132 2c69 7133 5d20 4020 7663 7572 0a20  q2,iq3] @ vcur. 
+0006e220: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006e230: 2f20 6772 6164 5b53 335d 2020 203d 2053  / grad[S3]   = S
+0006e240: 3420 2a20 2867 7261 645b 5334 5d20 2d20  4 * (grad[S4] - 
+0006e250: 646f 7428 5334 2c20 6772 6164 5b53 345d  dot(S4, grad[S4]
+0006e260: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0006e270: 2020 202f 2f20 6772 6164 5b53 315d 2020     // grad[S1]  
+0006e280: 203d 2064 6961 675f 6d61 736b 5f7a 6572   = diag_mask_zer
+0006e290: 6f28 6772 6164 5b53 335d 2c20 5029 202a  o(grad[S3], P) *
+0006e2a0: 2073 6361 6c65 0a20 2020 2020 2020 2020   scale.         
+0006e2b0: 2020 2020 2020 202f 2f20 6772 6164 5b71         // grad[q
+0006e2c0: 6375 725d 203d 2067 7261 645b 5331 5d20  cur] = grad[S1] 
+0006e2d0: 2020 4020 6b63 7572 0a20 2020 2020 2020    @ kcur.       
+0006e2e0: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
+0006e2f0: 5b6b 6375 725d 203d 2067 7261 645b 5331  [kcur] = grad[S1
+0006e300: 5d2e 5420 4020 7163 7572 0a20 2020 2020  ].T @ qcur.     
+0006e310: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
+0006e320: 6164 5b76 6375 725d 203d 2064 5b3a 442c  ad[vcur] = d[:D,
+0006e330: 6971 312c 6971 322c 6971 335d 2e54 2040  iq1,iq2,iq3].T @
+0006e340: 2053 340a 2020 2020 2020 2020 2020 2020   S4.            
+0006e350: 2020 2020 2f2f 0a20 2020 2020 2020 2020      //.         
+0006e360: 2020 2020 2020 202f 2f20 7573 696e 6720         // using 
+0006e370: 6c65 7373 2076 6172 6961 626c 6573 2028  less variables (
+0006e380: 534d 3d53 3429 3a0a 2020 2020 2020 2020  SM=S4):.        
+0006e390: 2020 2020 2020 2020 2f2f 0a20 2020 2020          //.     
+0006e3a0: 2020 2020 2020 2020 2020 202f 2f20 5320             // S 
+0006e3b0: 2020 2020 2020 2020 2020 2020 3d20 6469              = di
+0006e3c0: 6167 5f6d 6173 6b5f 696e 6628 7163 7572  ag_mask_inf(qcur
+0006e3d0: 2040 206b 6375 722e 5420 2a20 7363 616c   @ kcur.T * scal
+0006e3e0: 652c 2050 290a 2020 2020 2020 2020 2020  e, P).          
+0006e3f0: 2020 2020 2020 2f2f 2053 4d20 2020 2020        // SM     
+0006e400: 2020 2020 2020 203d 2073 6f66 746d 6178         = softmax
+0006e410: 2853 290a 2020 2020 2020 2020 2020 2020  (S).            
+0006e420: 2020 2020 2f2f 2053 2020 2020 2020 2020      // S        
+0006e430: 2020 2020 203d 2064 5b3a 442c 6971 312c       = d[:D,iq1,
+0006e440: 6971 322c 6971 335d 2040 2076 6375 720a  iq2,iq3] @ vcur.
+0006e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e460: 2f2f 2064 6f74 5f53 4d5f 6772 6164 534d  // dot_SM_gradSM
+0006e470: 203d 2064 6f74 2853 4d2c 2053 290a 2020   = dot(SM, S).  
+0006e480: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006e490: 2053 2020 2020 2020 2020 2020 2020 203d   S             =
+0006e4a0: 2053 4d20 2a20 2853 202d 2064 6f74 2853   SM * (S - dot(S
+0006e4b0: 4d2c 2053 2929 0a20 2020 2020 2020 2020  M, S)).         
+0006e4c0: 2020 2020 2020 202f 2f20 5320 2020 2020         // S     
+0006e4d0: 2020 2020 2020 2020 3d20 6469 6167 5f6d          = diag_m
+0006e4e0: 6173 6b5f 7a65 726f 2853 2c20 5029 202a  ask_zero(S, P) *
+0006e4f0: 2073 6361 6c65 0a20 2020 2020 2020 2020   scale.         
+0006e500: 2020 2020 2020 202f 2f0a 2020 2020 2020         //.      
+0006e510: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
+0006e520: 645b 715d 5b3a 442c 6971 312c 6971 322c  d[q][:D,iq1,iq2,
+0006e530: 6971 335d 202b 3d20 5320 2020 4020 6b63  iq3] += S   @ kc
+0006e540: 7572 0a20 2020 2020 2020 2020 2020 2020  ur.             
+0006e550: 2020 202f 2f20 6772 6164 5b6b 5d5b 3a44     // grad[k][:D
+0006e560: 2c3a 4d2c 6971 322c 6971 335d 2020 2b3d  ,:M,iq2,iq3]  +=
+0006e570: 2053 2e54 2040 2071 6375 720a 2020 2020   S.T @ qcur.    
+0006e580: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
+0006e590: 7261 645b 765d 5b3a 4d2c 3a44 2c69 7132  rad[v][:M,:D,iq2
+0006e5a0: 2c69 7133 5d20 202b 3d20 645b 3a44 2c69  ,iq3]  += d[:D,i
+0006e5b0: 7131 2c69 7132 2c69 7133 5d2e 5420 4020  q1,iq2,iq3].T @ 
+0006e5c0: 534d 0a20 2020 2020 2020 2020 2020 207d  SM.            }
+0006e5d0: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
+0006e5e0: 2053 203d 2067 7261 6453 4d20 3d20 645b   S = gradSM = d[
+0006e5f0: 3a44 2c69 7131 2c69 7132 2c69 7133 5d20  :D,iq1,iq2,iq3] 
+0006e600: 4020 7663 7572 0a20 2020 2020 2020 2020  @ vcur.         
+0006e610: 2020 202f 2f20 5320 3d20 645b 3a44 2c69     // S = d[:D,i
+0006e620: 7131 2c69 7132 2c69 7133 5d20 4020 7663  q1,iq2,iq3] @ vc
+0006e630: 7572 0a20 2020 2020 2020 2020 2020 202f  ur.            /
+0006e640: 2f20 535b 3a4d 5d20 2b3d 2076 6375 725b  / S[:M] += vcur[
+0006e650: 3a4d 2c69 635d 202a 2064 5b69 632c 6971  :M,ic] * d[ic,iq
+0006e660: 312c 6971 322c 6971 335d 0a20 2020 2020  1,iq2,iq3].     
+0006e670: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0006e680: 7365 745f 6633 3228 4d2c 2053 2c20 3029  set_f32(M, S, 0)
+0006e690: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
+0006e6a0: 7220 2869 6e74 3634 5f74 2069 6320 3d20  r (int64_t ic = 
+0006e6b0: 303b 2069 6320 3c20 443b 202b 2b69 6329  0; ic < D; ++ic)
+0006e6c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006e6d0: 2020 202f 2f20 6473 7420 696e 6469 6365     // dst indice
+0006e6e0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0006e6f0: 2020 636f 6e73 7420 696e 7420 6931 203d    const int i1 =
+0006e700: 2069 7131 3b0a 2020 2020 2020 2020 2020   iq1;.          
+0006e710: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0006e720: 6932 203d 2069 7132 3b0a 2020 2020 2020  i2 = iq2;.      
+0006e730: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006e740: 696e 7420 6933 203d 2069 7133 3b0a 0a20  int i3 = iq3;.. 
+0006e750: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0006e760: 676d 6c5f 7665 635f 6d61 645f 6633 3228  gml_vec_mad_f32(
+0006e770: 4d2c 0a20 2020 2020 2020 2020 2020 2020  M,.             
+0006e780: 2020 2020 2020 2020 2020 2053 2c0a 2020             S,.  
 0006e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e7a0: 2020 2020 202a 2866 6c6f 6174 202a 2920       *(float *) 
-0006e7b0: 2828 6368 6172 202a 2920 642d 3e64 6174  ((char *) d->dat
-0006e7c0: 6120 2b20 2869 632a 6e62 6430 202b 2069  a + (ic*nbd0 + i
-0006e7d0: 312a 6e62 6431 202b 2069 322a 6e62 6432  1*nbd1 + i2*nbd2
-0006e7e0: 202b 2069 332a 6e62 6433 2929 293b 0a20   + i3*nbd3)));. 
-0006e7f0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0006e800: 2020 2020 2020 2020 2020 2f2f 2053 203d            // S =
-0006e810: 2053 4d20 2a20 2853 202d 2064 6f74 2853   SM * (S - dot(S
-0006e820: 4d2c 2053 2929 0a20 2020 2020 2020 2020  M, S)).         
-0006e830: 2020 2066 6c6f 6174 2064 6f74 5f53 4d5f     float dot_SM_
-0006e840: 6772 6164 534d 203d 2030 3b0a 2020 2020  gradSM = 0;.    
-0006e850: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0006e860: 5f64 6f74 5f66 3332 2028 4d2c 2026 646f  _dot_f32 (M, &do
-0006e870: 745f 534d 5f67 7261 6453 4d2c 2053 4d2c  t_SM_gradSM, SM,
-0006e880: 2053 293b 0a20 2020 2020 2020 2020 2020   S);.           
-0006e890: 2067 676d 6c5f 7665 635f 6163 6331 5f66   ggml_vec_acc1_f
-0006e8a0: 3332 284d 2c20 532c 202d 646f 745f 534d  32(M, S, -dot_SM
-0006e8b0: 5f67 7261 6453 4d29 3b0a 2020 2020 2020  _gradSM);.      
-0006e8c0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
-0006e8d0: 756c 5f66 3332 2028 4d2c 2053 2c20 532c  ul_f32 (M, S, S,
-0006e8e0: 2053 4d29 3b0a 0a20 2020 2020 2020 2020   SM);..         
-0006e8f0: 2020 202f 2f20 5320 3d20 6469 6167 5f6d     // S = diag_m
-0006e900: 6173 6b5f 7a65 726f 2853 2c20 5029 202a  ask_zero(S, P) *
-0006e910: 2073 6361 6c65 0a20 2020 2020 2020 2020   scale.         
-0006e920: 2020 2069 6620 286d 6173 6b65 6429 207b     if (masked) {
-0006e930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e940: 202f 2f20 666f 7220 2869 6e74 3634 5f74   // for (int64_t
-0006e950: 2069 203d 2050 202b 2069 7131 202b 2031   i = P + iq1 + 1
-0006e960: 3b20 6920 3c20 4d3b 2069 2b2b 2920 7b0a  ; i < M; i++) {.
-0006e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006e980: 2f2f 2020 2020 2053 5b69 5d20 3d20 303b  //     S[i] = 0;
-0006e990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006e9a0: 202f 2f20 7d0a 2020 2020 2020 2020 2020   // }.          
-0006e9b0: 2020 2020 2020 666f 7220 2869 6e74 3634        for (int64
-0006e9c0: 5f74 2069 203d 2050 3b20 6920 3c20 4d3b  _t i = P; i < M;
-0006e9d0: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-0006e9e0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0006e9f0: 6920 3e20 5020 2b20 6971 3129 207b 0a20  i > P + iq1) {. 
-0006ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ea10: 2020 2020 2020 2053 5b69 5d20 3d20 303b         S[i] = 0;
-0006ea20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006ea30: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006ea40: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0006ea50: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0006ea60: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
-0006ea70: 655f 6633 3228 4d2c 2053 2c20 7363 616c  e_f32(M, S, scal
-0006ea80: 6529 3b0a 0a20 2020 2020 2020 2020 2020  e);..           
-0006ea90: 2076 6f69 6420 2a20 6772 6164 5f71 203d   void * grad_q =
-0006eaa0: 2028 6368 6172 202a 2920 6473 742d 3e64   (char *) dst->d
-0006eab0: 6174 613b 0a20 2020 2020 2020 2020 2020  ata;.           
-0006eac0: 2076 6f69 6420 2a20 6772 6164 5f6b 203d   void * grad_k =
-0006ead0: 2028 6368 6172 202a 2920 6473 742d 3e64   (char *) dst->d
-0006eae0: 6174 6120 2b20 6e62 302a 442a 4e2a 6e65  ata + nb0*D*N*ne
-0006eaf0: 7132 2a6e 6571 333b 0a20 2020 2020 2020  q2*neq3;.       
-0006eb00: 2020 2020 2076 6f69 6420 2a20 6772 6164       void * grad
-0006eb10: 5f76 203d 2028 6368 6172 202a 2920 6473  _v = (char *) ds
-0006eb20: 742d 3e64 6174 6120 2b20 6e62 302a 442a  t->data + nb0*D*
-0006eb30: 4e2a 6e65 7132 2a6e 6571 3320 2b20 6e62  N*neq2*neq3 + nb
-0006eb40: 302a 442a 4d2a 6e65 7132 2a6e 6571 333b  0*D*M*neq2*neq3;
-0006eb50: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-0006eb60: 6e73 7420 7369 7a65 5f74 206e 6267 7131  nst size_t nbgq1
-0006eb70: 203d 206e 6230 2a6e 6571 303b 0a20 2020   = nb0*neq0;.   
-0006eb80: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-0006eb90: 697a 655f 7420 6e62 6771 3220 3d20 6e62  ize_t nbgq2 = nb
-0006eba0: 302a 6e65 7130 2a6e 6571 313b 0a20 2020  0*neq0*neq1;.   
-0006ebb0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-0006ebc0: 697a 655f 7420 6e62 6771 3320 3d20 6e62  ize_t nbgq3 = nb
-0006ebd0: 302a 6e65 7130 2a6e 6571 312a 6e65 7132  0*neq0*neq1*neq2
-0006ebe0: 3b0a 0a20 2020 2020 2020 2020 2020 2063  ;..            c
-0006ebf0: 6f6e 7374 2073 697a 655f 7420 6e62 676b  onst size_t nbgk
-0006ec00: 3120 3d20 6e62 302a 6e65 6b30 3b0a 2020  1 = nb0*nek0;.  
-0006ec10: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006ec20: 7369 7a65 5f74 206e 6267 6b32 203d 206e  size_t nbgk2 = n
-0006ec30: 6230 2a6e 656b 302a 6e65 6b31 3b0a 2020  b0*nek0*nek1;.  
-0006ec40: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006ec50: 7369 7a65 5f74 206e 6267 6b33 203d 206e  size_t nbgk3 = n
-0006ec60: 6230 2a6e 656b 302a 6e65 6b31 2a6e 6571  b0*nek0*nek1*neq
-0006ec70: 323b 0a0a 2020 2020 2020 2020 2020 2020  2;..            
-0006ec80: 636f 6e73 7420 7369 7a65 5f74 206e 6267  const size_t nbg
-0006ec90: 7631 203d 206e 6230 2a6e 6576 303b 0a20  v1 = nb0*nev0;. 
-0006eca0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006ecb0: 2073 697a 655f 7420 6e62 6776 3220 3d20   size_t nbgv2 = 
-0006ecc0: 6e62 302a 6e65 7630 2a6e 6576 313b 0a20  nb0*nev0*nev1;. 
-0006ecd0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006ece0: 2073 697a 655f 7420 6e62 6776 3320 3d20   size_t nbgv3 = 
-0006ecf0: 6e62 302a 6e65 7630 2a6e 6576 312a 6e65  nb0*nev0*nev1*ne
-0006ed00: 7132 3b0a 0a20 2020 2020 2020 2020 2020  q2;..           
-0006ed10: 202f 2f20 5320 2020 2073 6861 7065 205b   // S    shape [
-0006ed20: 4d2c 315d 0a20 2020 2020 2020 2020 2020  M,1].           
-0006ed30: 202f 2f20 534d 2020 2073 6861 7065 205b   // SM   shape [
-0006ed40: 4d2c 315d 0a20 2020 2020 2020 2020 2020  M,1].           
-0006ed50: 202f 2f20 6b63 7572 2073 6861 7065 205b   // kcur shape [
-0006ed60: 442c 4d5d 0a20 2020 2020 2020 2020 2020  D,M].           
-0006ed70: 202f 2f20 7163 7572 2073 6861 7065 205b   // qcur shape [
-0006ed80: 442c 315d 0a20 2020 2020 2020 2020 2020  D,1].           
-0006ed90: 202f 2f20 7663 7572 2073 6861 7065 205b   // vcur shape [
-0006eda0: 4d2c 445d 0a20 2020 2020 2020 2020 2020  M,D].           
-0006edb0: 202f 2f0a 2020 2020 2020 2020 2020 2020   //.            
-0006edc0: 2f2f 2067 7261 645b 715d 5b3a 442c 6971  // grad[q][:D,iq
-0006edd0: 312c 6971 322c 6971 335d 202b 3d20 5320  1,iq2,iq3] += S 
-0006ede0: 4020 6b63 7572 0a20 2020 2020 2020 2020  @ kcur.         
-0006edf0: 2020 202f 2f20 6772 6164 5b71 5d5b 3a44     // grad[q][:D
-0006ee00: 2c69 7131 2c69 7132 2c69 7133 5d20 2b3d  ,iq1,iq2,iq3] +=
-0006ee10: 2073 6861 7065 5b4d 2c31 5d20 4020 7368   shape[M,1] @ sh
-0006ee20: 6170 655b 442c 4d5d 0a20 2020 2020 2020  ape[D,M].       
-0006ee30: 2020 2020 202f 2f20 6772 6164 5b71 5d5b       // grad[q][
-0006ee40: 3a44 2c69 7131 2c69 7132 2c69 7133 5d20  :D,iq1,iq2,iq3] 
-0006ee50: 2b3d 2053 5b69 635d 202a 206b 6375 725b  += S[ic] * kcur[
-0006ee60: 3a44 2c69 635d 0a20 2020 2020 2020 2020  :D,ic].         
-0006ee70: 2020 202f 2f0a 2020 2020 2020 2020 2020     //.          
-0006ee80: 2020 2f2f 2f2f 2067 7261 645b 715d 5b69    //// grad[q][i
-0006ee90: 632c 6971 312c 6971 322c 6971 335d 202b  c,iq1,iq2,iq3] +
-0006eea0: 3d20 646f 7428 6b63 7572 5b3a 2c69 635d  = dot(kcur[:,ic]
-0006eeb0: 2c53 2e54 290a 2020 2020 2020 2020 2020  ,S.T).          
-0006eec0: 2020 2f2f 2f2f 2067 7261 645b 715d 5b69    //// grad[q][i
-0006eed0: 632c 6971 312c 6971 322c 6971 335d 202b  c,iq1,iq2,iq3] +
-0006eee0: 3d20 646f 7428 6b5b 3a44 2c69 632c 6971  = dot(k[:D,ic,iq
-0006eef0: 322c 6971 335d 2c53 2e54 290a 2020 2020  2,iq3],S.T).    
-0006ef00: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-0006ef10: 3634 5f74 2069 6320 3d20 303b 2069 6320  64_t ic = 0; ic 
-0006ef20: 3c20 4d3b 202b 2b69 6329 207b 0a20 2020  < M; ++ic) {.   
-0006ef30: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006ef40: 6473 7420 696e 6469 6365 730a 2020 2020  dst indices.    
-0006ef50: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006ef60: 7420 696e 7420 6931 203d 2069 7131 3b0a  t int i1 = iq1;.
-0006ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ef80: 636f 6e73 7420 696e 7420 6932 203d 2069  const int i2 = i
-0006ef90: 7132 3b0a 2020 2020 2020 2020 2020 2020  q2;.            
-0006efa0: 2020 2020 636f 6e73 7420 696e 7420 6933      const int i3
-0006efb0: 203d 2069 7133 3b0a 0a20 2020 2020 2020   = iq3;..       
-0006efc0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0006efd0: 635f 6d61 645f 6633 3228 442c 0a20 2020  c_mad_f32(D,.   
-0006efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006eff0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
-0006f000: 2863 6861 7220 2a29 2067 7261 645f 7120  (char *) grad_q 
-0006f010: 202b 2028 6931 2a6e 6267 7131 2020 2b20   + (i1*nbgq1  + 
-0006f020: 6932 2a6e 6267 7132 2020 2b20 6933 2a6e  i2*nbgq2  + i3*n
-0006f030: 6267 7133 2929 2c0a 2020 2020 2020 2020  bgq3)),.        
+0006e7a0: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+0006e7b0: 2028 2863 6861 7220 2a29 2076 2d3e 6461   ((char *) v->da
+0006e7c0: 7461 202b 2028 2020 2020 2020 2020 2020  ta + (          
+0006e7d0: 6963 2a6e 6276 3120 2b20 6932 2a6e 6276  ic*nbv1 + i2*nbv
+0006e7e0: 3220 2b20 6933 2a6e 6276 3329 292c 0a20  2 + i3*nbv3)),. 
+0006e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006e800: 2020 2020 2020 202a 2866 6c6f 6174 202a         *(float *
+0006e810: 2920 2828 6368 6172 202a 2920 642d 3e64  ) ((char *) d->d
+0006e820: 6174 6120 2b20 2869 632a 6e62 6430 202b  ata + (ic*nbd0 +
+0006e830: 2069 312a 6e62 6431 202b 2069 322a 6e62   i1*nbd1 + i2*nb
+0006e840: 6432 202b 2069 332a 6e62 6433 2929 293b  d2 + i3*nbd3)));
+0006e850: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+0006e860: 2020 2020 2020 2020 2020 2020 2f2f 2053              // S
+0006e870: 203d 2053 4d20 2a20 2853 202d 2064 6f74   = SM * (S - dot
+0006e880: 2853 4d2c 2053 2929 0a20 2020 2020 2020  (SM, S)).       
+0006e890: 2020 2020 2066 6c6f 6174 2064 6f74 5f53       float dot_S
+0006e8a0: 4d5f 6772 6164 534d 203d 2030 3b0a 2020  M_gradSM = 0;.  
+0006e8b0: 2020 2020 2020 2020 2020 6767 6d6c 5f76            ggml_v
+0006e8c0: 6563 5f64 6f74 5f66 3332 2028 4d2c 2026  ec_dot_f32 (M, &
+0006e8d0: 646f 745f 534d 5f67 7261 6453 4d2c 2053  dot_SM_gradSM, S
+0006e8e0: 4d2c 2053 293b 0a20 2020 2020 2020 2020  M, S);.         
+0006e8f0: 2020 2067 676d 6c5f 7665 635f 6163 6331     ggml_vec_acc1
+0006e900: 5f66 3332 284d 2c20 532c 202d 646f 745f  _f32(M, S, -dot_
+0006e910: 534d 5f67 7261 6453 4d29 3b0a 2020 2020  SM_gradSM);.    
+0006e920: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0006e930: 5f6d 756c 5f66 3332 2028 4d2c 2053 2c20  _mul_f32 (M, S, 
+0006e940: 532c 2053 4d29 3b0a 0a20 2020 2020 2020  S, SM);..       
+0006e950: 2020 2020 202f 2f20 5320 3d20 6469 6167       // S = diag
+0006e960: 5f6d 6173 6b5f 7a65 726f 2853 2c20 5029  _mask_zero(S, P)
+0006e970: 202a 2073 6361 6c65 0a20 2020 2020 2020   * scale.       
+0006e980: 2020 2020 2069 6620 286d 6173 6b65 6429       if (masked)
+0006e990: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006e9a0: 2020 202f 2f20 666f 7220 2869 6e74 3634     // for (int64
+0006e9b0: 5f74 2069 203d 2050 202b 2069 7131 202b  _t i = P + iq1 +
+0006e9c0: 2031 3b20 6920 3c20 4d3b 2069 2b2b 2920   1; i < M; i++) 
+0006e9d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0006e9e0: 2020 2f2f 2020 2020 2053 5b69 5d20 3d20    //     S[i] = 
+0006e9f0: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+0006ea00: 2020 202f 2f20 7d0a 2020 2020 2020 2020     // }.        
+0006ea10: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+0006ea20: 3634 5f74 2069 203d 2050 3b20 6920 3c20  64_t i = P; i < 
+0006ea30: 4d3b 2069 2b2b 2920 7b0a 2020 2020 2020  M; i++) {.      
+0006ea40: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0006ea50: 2028 6920 3e20 5020 2b20 6971 3129 207b   (i > P + iq1) {
+0006ea60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006ea70: 2020 2020 2020 2020 2053 5b69 5d20 3d20           S[i] = 
+0006ea80: 303b 0a20 2020 2020 2020 2020 2020 2020  0;.             
+0006ea90: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0006eaa0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0006eab0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0006eac0: 2020 2020 2067 676d 6c5f 7665 635f 7363       ggml_vec_sc
+0006ead0: 616c 655f 6633 3228 4d2c 2053 2c20 7363  ale_f32(M, S, sc
+0006eae0: 616c 6529 3b0a 0a20 2020 2020 2020 2020  ale);..         
+0006eaf0: 2020 2076 6f69 6420 2a20 6772 6164 5f71     void * grad_q
+0006eb00: 203d 2028 6368 6172 202a 2920 6473 742d   = (char *) dst-
+0006eb10: 3e64 6174 613b 0a20 2020 2020 2020 2020  >data;.         
+0006eb20: 2020 2076 6f69 6420 2a20 6772 6164 5f6b     void * grad_k
+0006eb30: 203d 2028 6368 6172 202a 2920 6473 742d   = (char *) dst-
+0006eb40: 3e64 6174 6120 2b20 6e62 302a 442a 4e2a  >data + nb0*D*N*
+0006eb50: 6e65 7132 2a6e 6571 333b 0a20 2020 2020  neq2*neq3;.     
+0006eb60: 2020 2020 2020 2076 6f69 6420 2a20 6772         void * gr
+0006eb70: 6164 5f76 203d 2028 6368 6172 202a 2920  ad_v = (char *) 
+0006eb80: 6473 742d 3e64 6174 6120 2b20 6e62 302a  dst->data + nb0*
+0006eb90: 442a 4e2a 6e65 7132 2a6e 6571 3320 2b20  D*N*neq2*neq3 + 
+0006eba0: 6e62 302a 442a 4d2a 6e65 7132 2a6e 6571  nb0*D*M*neq2*neq
+0006ebb0: 333b 0a0a 2020 2020 2020 2020 2020 2020  3;..            
+0006ebc0: 636f 6e73 7420 7369 7a65 5f74 206e 6267  const size_t nbg
+0006ebd0: 7131 203d 206e 6230 2a6e 6571 303b 0a20  q1 = nb0*neq0;. 
+0006ebe0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0006ebf0: 2073 697a 655f 7420 6e62 6771 3220 3d20   size_t nbgq2 = 
+0006ec00: 6e62 302a 6e65 7130 2a6e 6571 313b 0a20  nb0*neq0*neq1;. 
+0006ec10: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0006ec20: 2073 697a 655f 7420 6e62 6771 3320 3d20   size_t nbgq3 = 
+0006ec30: 6e62 302a 6e65 7130 2a6e 6571 312a 6e65  nb0*neq0*neq1*ne
+0006ec40: 7132 3b0a 0a20 2020 2020 2020 2020 2020  q2;..           
+0006ec50: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+0006ec60: 676b 3120 3d20 6e62 302a 6e65 6b30 3b0a  gk1 = nb0*nek0;.
+0006ec70: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0006ec80: 7420 7369 7a65 5f74 206e 6267 6b32 203d  t size_t nbgk2 =
+0006ec90: 206e 6230 2a6e 656b 302a 6e65 6b31 3b0a   nb0*nek0*nek1;.
+0006eca0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0006ecb0: 7420 7369 7a65 5f74 206e 6267 6b33 203d  t size_t nbgk3 =
+0006ecc0: 206e 6230 2a6e 656b 302a 6e65 6b31 2a6e   nb0*nek0*nek1*n
+0006ecd0: 6571 323b 0a0a 2020 2020 2020 2020 2020  eq2;..          
+0006ece0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0006ecf0: 6267 7631 203d 206e 6230 2a6e 6576 303b  bgv1 = nb0*nev0;
+0006ed00: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0006ed10: 7374 2073 697a 655f 7420 6e62 6776 3220  st size_t nbgv2 
+0006ed20: 3d20 6e62 302a 6e65 7630 2a6e 6576 313b  = nb0*nev0*nev1;
+0006ed30: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0006ed40: 7374 2073 697a 655f 7420 6e62 6776 3320  st size_t nbgv3 
+0006ed50: 3d20 6e62 302a 6e65 7630 2a6e 6576 312a  = nb0*nev0*nev1*
+0006ed60: 6e65 7132 3b0a 0a20 2020 2020 2020 2020  neq2;..         
+0006ed70: 2020 202f 2f20 5320 2020 2073 6861 7065     // S    shape
+0006ed80: 205b 4d2c 315d 0a20 2020 2020 2020 2020   [M,1].         
+0006ed90: 2020 202f 2f20 534d 2020 2073 6861 7065     // SM   shape
+0006eda0: 205b 4d2c 315d 0a20 2020 2020 2020 2020   [M,1].         
+0006edb0: 2020 202f 2f20 6b63 7572 2073 6861 7065     // kcur shape
+0006edc0: 205b 442c 4d5d 0a20 2020 2020 2020 2020   [D,M].         
+0006edd0: 2020 202f 2f20 7163 7572 2073 6861 7065     // qcur shape
+0006ede0: 205b 442c 315d 0a20 2020 2020 2020 2020   [D,1].         
+0006edf0: 2020 202f 2f20 7663 7572 2073 6861 7065     // vcur shape
+0006ee00: 205b 4d2c 445d 0a20 2020 2020 2020 2020   [M,D].         
+0006ee10: 2020 202f 2f0a 2020 2020 2020 2020 2020     //.          
+0006ee20: 2020 2f2f 2067 7261 645b 715d 5b3a 442c    // grad[q][:D,
+0006ee30: 6971 312c 6971 322c 6971 335d 202b 3d20  iq1,iq2,iq3] += 
+0006ee40: 5320 4020 6b63 7572 0a20 2020 2020 2020  S @ kcur.       
+0006ee50: 2020 2020 202f 2f20 6772 6164 5b71 5d5b       // grad[q][
+0006ee60: 3a44 2c69 7131 2c69 7132 2c69 7133 5d20  :D,iq1,iq2,iq3] 
+0006ee70: 2b3d 2073 6861 7065 5b4d 2c31 5d20 4020  += shape[M,1] @ 
+0006ee80: 7368 6170 655b 442c 4d5d 0a20 2020 2020  shape[D,M].     
+0006ee90: 2020 2020 2020 202f 2f20 6772 6164 5b71         // grad[q
+0006eea0: 5d5b 3a44 2c69 7131 2c69 7132 2c69 7133  ][:D,iq1,iq2,iq3
+0006eeb0: 5d20 2b3d 2053 5b69 635d 202a 206b 6375  ] += S[ic] * kcu
+0006eec0: 725b 3a44 2c69 635d 0a20 2020 2020 2020  r[:D,ic].       
+0006eed0: 2020 2020 202f 2f0a 2020 2020 2020 2020       //.        
+0006eee0: 2020 2020 2f2f 2f2f 2067 7261 645b 715d      //// grad[q]
+0006eef0: 5b69 632c 6971 312c 6971 322c 6971 335d  [ic,iq1,iq2,iq3]
+0006ef00: 202b 3d20 646f 7428 6b63 7572 5b3a 2c69   += dot(kcur[:,i
+0006ef10: 635d 2c53 2e54 290a 2020 2020 2020 2020  c],S.T).        
+0006ef20: 2020 2020 2f2f 2f2f 2067 7261 645b 715d      //// grad[q]
+0006ef30: 5b69 632c 6971 312c 6971 322c 6971 335d  [ic,iq1,iq2,iq3]
+0006ef40: 202b 3d20 646f 7428 6b5b 3a44 2c69 632c   += dot(k[:D,ic,
+0006ef50: 6971 322c 6971 335d 2c53 2e54 290a 2020  iq2,iq3],S.T).  
+0006ef60: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+0006ef70: 6e74 3634 5f74 2069 6320 3d20 303b 2069  nt64_t ic = 0; i
+0006ef80: 6320 3c20 4d3b 202b 2b69 6329 207b 0a20  c < M; ++ic) {. 
+0006ef90: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006efa0: 2f20 6473 7420 696e 6469 6365 730a 2020  / dst indices.  
+0006efb0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0006efc0: 6e73 7420 696e 7420 6931 203d 2069 7131  nst int i1 = iq1
+0006efd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0006efe0: 2020 636f 6e73 7420 696e 7420 6932 203d    const int i2 =
+0006eff0: 2069 7132 3b0a 2020 2020 2020 2020 2020   iq2;.          
+0006f000: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0006f010: 6933 203d 2069 7133 3b0a 0a20 2020 2020  i3 = iq3;..     
+0006f020: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0006f030: 7665 635f 6d61 645f 6633 3228 442c 0a20  vec_mad_f32(D,. 
 0006f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f050: 2866 6c6f 6174 202a 2920 2828 6368 6172  (float *) ((char
-0006f060: 202a 2920 6b2d 3e64 6174 6120 2b20 2869   *) k->data + (i
-0006f070: 632a 6e62 6b31 2020 202b 2069 322a 6e62  c*nbk1   + i2*nb
-0006f080: 6b32 2020 202b 2069 332a 6e62 6b33 2929  k2   + i3*nbk3))
-0006f090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006f0a0: 2020 2020 2020 2020 2020 535b 6963 5d29            S[ic])
-0006f0b0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-0006f0c0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0006f0d0: 6772 6164 5b6b 5d5b 3a44 2c3a 4d2c 6971  grad[k][:D,:M,iq
-0006f0e0: 322c 6971 335d 202b 3d20 532e 5420 2020  2,iq3] += S.T   
-0006f0f0: 2020 2020 4020 7163 7572 0a20 2020 2020      @ qcur.     
-0006f100: 2020 2020 2020 202f 2f20 6772 6164 5b6b         // grad[k
-0006f110: 5d5b 3a44 2c69 632c 6971 322c 6971 335d  ][:D,ic,iq2,iq3]
-0006f120: 202b 3d20 532e 545b 302c 6963 5d20 2a20   += S.T[0,ic] * 
-0006f130: 7163 7572 5b3a 442c 305d 0a20 2020 2020  qcur[:D,0].     
-0006f140: 2020 2020 2020 202f 2f20 6772 6164 5b6b         // grad[k
-0006f150: 5d5b 3a44 2c69 632c 6971 322c 6971 335d  ][:D,ic,iq2,iq3]
-0006f160: 202b 3d20 535b 6963 5d20 2020 2020 2a20   += S[ic]     * 
-0006f170: 7163 7572 5b3a 442c 305d 0a20 2020 2020  qcur[:D,0].     
-0006f180: 2020 2020 2020 2066 6f72 2028 696e 7436         for (int6
-0006f190: 345f 7420 6963 203d 2030 3b20 6963 203c  4_t ic = 0; ic <
-0006f1a0: 204d 3b20 2b2b 6963 2920 7b0a 2020 2020   M; ++ic) {.    
-0006f1b0: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
-0006f1c0: 7374 2069 6e64 6963 6573 0a20 2020 2020  st indices.     
-0006f1d0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006f1e0: 2069 6e74 2069 3120 3d20 6971 313b 0a20   int i1 = iq1;. 
-0006f1f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0006f200: 6f6e 7374 2069 6e74 2069 3220 3d20 6971  onst int i2 = iq
-0006f210: 323b 0a20 2020 2020 2020 2020 2020 2020  2;.             
-0006f220: 2020 2063 6f6e 7374 2069 6e74 2069 3320     const int i3 
-0006f230: 3d20 6971 333b 0a0a 2020 2020 2020 2020  = iq3;..        
-0006f240: 2020 2020 2020 2020 2f2f 2067 676d 6c5f          // ggml_
-0006f250: 7665 635f 7365 745f 6633 3228 442c 0a20  vec_set_f32(D,. 
-0006f260: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006f270: 2f20 2020 2020 2020 2020 2866 6c6f 6174  /         (float
-0006f280: 202a 2920 2828 6368 6172 202a 2920 6772   *) ((char *) gr
-0006f290: 6164 5f6b 2020 2b20 2869 632a 6e62 676b  ad_k  + (ic*nbgk
-0006f2a0: 3120 202b 2069 322a 6e62 676b 3220 202b  1  + i2*nbgk2  +
-0006f2b0: 2069 332a 6e62 676b 3329 292c 0a20 2020   i3*nbgk3)),.   
-0006f2c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0006f2d0: 2020 2020 2020 2020 3029 3b0a 2020 2020          0);.    
-0006f2e0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0006f2f0: 5f76 6563 5f6d 6164 5f66 3332 2844 2c0a  _vec_mad_f32(D,.
-0006f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f310: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
-0006f320: 2920 2828 6368 6172 202a 2920 6772 6164  ) ((char *) grad
-0006f330: 5f6b 2020 2b20 2869 632a 6e62 676b 3120  _k  + (ic*nbgk1 
-0006f340: 202b 2069 322a 6e62 676b 3220 202b 2069   + i2*nbgk2  + i
-0006f350: 332a 6e62 676b 3329 292c 0a20 2020 2020  3*nbgk3)),.     
-0006f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006f370: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-0006f380: 6861 7220 2a29 2071 2d3e 6461 7461 202b  har *) q->data +
-0006f390: 2028 6931 2a6e 6271 3120 2020 2b20 6932   (i1*nbq1   + i2
-0006f3a0: 2a6e 6271 3220 2020 2b20 6933 2a6e 6271  *nbq2   + i3*nbq
-0006f3b0: 3329 292c 0a20 2020 2020 2020 2020 2020  3)),.           
-0006f3c0: 2020 2020 2020 2020 2020 2020 2053 5b69               S[i
-0006f3d0: 635d 293b 0a20 2020 2020 2020 2020 2020  c]);.           
-0006f3e0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
-0006f3f0: 2f2f 2067 7261 645b 765d 5b3a 4d2c 3a44  // grad[v][:M,:D
-0006f400: 2c69 7132 2c69 7133 5d20 2b3d 2064 5b3a  ,iq2,iq3] += d[:
-0006f410: 442c 6971 312c 6971 322c 6971 335d 2e54  D,iq1,iq2,iq3].T
-0006f420: 2020 2020 2020 2040 2053 4d0a 2020 2020         @ SM.    
-0006f430: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
-0006f440: 765d 5b3a 4d2c 6963 2c69 7132 2c69 7133  v][:M,ic,iq2,iq3
-0006f450: 5d20 2b3d 2064 5b3a 442c 6971 312c 6971  ] += d[:D,iq1,iq
-0006f460: 322c 6971 335d 2e54 5b30 2c69 635d 202a  2,iq3].T[0,ic] *
-0006f470: 2053 4d5b 3a4d 5d0a 2020 2020 2020 2020   SM[:M].        
-0006f480: 2020 2020 2f2f 2067 7261 645b 765d 5b3a      // grad[v][:
-0006f490: 4d2c 6963 2c69 7132 2c69 7133 5d20 2b3d  M,ic,iq2,iq3] +=
-0006f4a0: 2064 5b69 632c 6971 312c 6971 322c 6971   d[ic,iq1,iq2,iq
-0006f4b0: 335d 2020 2020 2020 2020 202a 2053 4d5b  3]         * SM[
-0006f4c0: 3a4d 5d0a 2020 2020 2020 2020 2020 2020  :M].            
-0006f4d0: 666f 7220 2869 6e74 3634 5f74 2069 6320  for (int64_t ic 
-0006f4e0: 3d20 303b 2069 6320 3c20 443b 202b 2b69  = 0; ic < D; ++i
-0006f4f0: 6329 207b 0a20 2020 2020 2020 2020 2020  c) {.           
-0006f500: 2020 2020 202f 2f20 6473 7420 696e 6469       // dst indi
-0006f510: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
-0006f520: 2020 2020 636f 6e73 7420 696e 7420 6931      const int i1
-0006f530: 203d 2069 7131 3b0a 2020 2020 2020 2020   = iq1;.        
-0006f540: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0006f550: 7420 6932 203d 2069 7132 3b0a 2020 2020  t i2 = iq2;.    
-0006f560: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-0006f570: 7420 696e 7420 6933 203d 2069 7133 3b0a  t int i3 = iq3;.
-0006f580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006f590: 202f 2f20 6767 6d6c 5f76 6563 5f73 6574   // ggml_vec_set
-0006f5a0: 5f66 3332 284d 2c0a 2020 2020 2020 2020  _f32(M,.        
-0006f5b0: 2020 2020 2020 2020 2f2f 2020 2020 2020          //      
-0006f5c0: 2020 2028 666c 6f61 7420 2a29 2028 2863     (float *) ((c
-0006f5d0: 6861 7220 2a29 2067 7261 645f 7620 2020  har *) grad_v   
-0006f5e0: 2b20 2820 2020 2020 2020 2020 2069 632a  + (          ic*
-0006f5f0: 6e62 6776 3120 2b20 6932 2a6e 6267 7632  nbgv1 + i2*nbgv2
-0006f600: 202b 2069 332a 6e62 6776 3329 292c 0a20   + i3*nbgv3)),. 
-0006f610: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0006f620: 2f20 2020 2020 2020 2020 3029 3b0a 2020  /         0);.  
-0006f630: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0006f640: 6d6c 5f76 6563 5f6d 6164 5f66 3332 284d  ml_vec_mad_f32(M
-0006f650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006f660: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-0006f670: 202a 2920 2828 6368 6172 202a 2920 6772   *) ((char *) gr
-0006f680: 6164 5f76 2020 202b 2028 2020 2020 2020  ad_v   + (      
-0006f690: 2020 2020 6963 2a6e 6267 7631 202b 2069      ic*nbgv1 + i
-0006f6a0: 322a 6e62 6776 3220 2b20 6933 2a6e 6267  2*nbgv2 + i3*nbg
-0006f6b0: 7633 2929 2c0a 2020 2020 2020 2020 2020  v3)),.          
-0006f6c0: 2020 2020 2020 2020 2020 2020 2020 534d                SM
-0006f6d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0006f6e0: 2020 2020 2020 2020 2020 2a28 666c 6f61            *(floa
-0006f6f0: 7420 2a29 2028 2863 6861 7220 2a29 2064  t *) ((char *) d
-0006f700: 2d3e 6461 7461 202b 2028 6963 2a6e 6264  ->data + (ic*nbd
-0006f710: 3020 2b20 6931 2a6e 6264 3120 202b 2069  0 + i1*nbd1  + i
-0006f720: 322a 6e62 6432 2020 2b20 6933 2a6e 6264  2*nbd2  + i3*nbd
-0006f730: 3329 2929 3b0a 2020 2020 2020 2020 2020  3)));.          
-0006f740: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-0006f750: 2020 7d0a 7d0a 0a73 7461 7469 6320 766f    }.}..static vo
-0006f760: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-0006f770: 666f 7277 6172 645f 666c 6173 685f 6174  forward_flash_at
-0006f780: 746e 5f62 6163 6b28 0a20 2020 2020 2020  tn_back(.       
-0006f790: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0006f7a0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-0006f7b0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-0006f7c0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-0006f7d0: 2067 676d 6c5f 7465 6e73 6f72 202a 2071   ggml_tensor * q
-0006f7e0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-0006f7f0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0006f800: 6f72 202a 206b 2c0a 2020 2020 2020 2020  or * k,.        
-0006f810: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-0006f820: 6c5f 7465 6e73 6f72 202a 2076 2c0a 2020  l_tensor * v,.  
-0006f830: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-0006f840: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0006f850: 2064 2c0a 2020 2020 2020 2020 636f 6e73   d,.        cons
-0006f860: 7420 626f 6f6c 206d 6173 6b65 642c 0a20  t bool masked,. 
-0006f870: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0006f880: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-0006f890: 207b 0a20 2020 2073 7769 7463 6820 2871   {.    switch (q
-0006f8a0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
-0006f8b0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-0006f8c0: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
-0006f8d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0006f8e0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-0006f8f0: 5f66 6f72 7761 7264 5f66 6c61 7368 5f61  _forward_flash_a
-0006f900: 7474 6e5f 6261 636b 5f66 3332 2870 6172  ttn_back_f32(par
-0006f910: 616d 732c 2071 2c20 6b2c 2076 2c20 642c  ams, q, k, v, d,
-0006f920: 206d 6173 6b65 642c 2064 7374 293b 0a20   masked, dst);. 
-0006f930: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0006f940: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-0006f950: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-0006f960: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006f970: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-0006f980: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-0006f990: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0006f9a0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
-0006f9b0: 7075 7465 5f66 6f72 7761 7264 5f77 696e  pute_forward_win
-0006f9c0: 5f70 6172 740a 0a73 7461 7469 6320 766f  _part..static vo
-0006f9d0: 6964 2067 676d 6c5f 636f 6d70 7574 655f  id ggml_compute_
-0006f9e0: 666f 7277 6172 645f 7769 6e5f 7061 7274  forward_win_part
-0006f9f0: 5f66 3332 280a 2020 2020 2020 2020 636f  _f32(.        co
-0006fa00: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0006fa10: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
-0006fa20: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-0006fa30: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0006fa40: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
-0006fa50: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-0006fa60: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0006fa70: 6f72 202a 206f 7074 302c 0a20 2020 2020  or * opt0,.     
-0006fa80: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0006fa90: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
-0006faa0: 2020 2069 6620 2870 6172 616d 732d 3e74     if (params->t
-0006fab0: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
-0006fac0: 5f49 4e49 5420 7c7c 2070 6172 616d 732d  _INIT || params-
-0006fad0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-0006fae0: 534b 5f46 494e 414c 495a 4529 207b 0a20  SK_FINALIZE) {. 
-0006faf0: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
-0006fb00: 2020 207d 0a0a 2020 2020 4747 4d4c 5f54     }..    GGML_T
-0006fb10: 454e 534f 525f 4c4f 4341 4c53 2869 6e74  ENSOR_LOCALS(int
-0006fb20: 3634 5f74 2c20 6e65 302c 2073 7263 302c  64_t, ne0, src0,
-0006fb30: 206e 6529 3b0a 2020 2020 4747 4d4c 5f54   ne);.    GGML_T
-0006fb40: 454e 534f 525f 4c4f 4341 4c53 2869 6e74  ENSOR_LOCALS(int
-0006fb50: 3634 5f74 2c20 6e65 2c20 2064 7374 2c20  64_t, ne,  dst, 
-0006fb60: 206e 6529 3b0a 0a20 2020 2063 6f6e 7374   ne);..    const
-0006fb70: 2069 6e74 3332 5f74 206e 6570 3020 3d20   int32_t nep0 = 
-0006fb80: 2828 636f 6e73 7420 696e 7433 325f 7420  ((const int32_t 
-0006fb90: 2a29 286f 7074 302d 3e64 6174 6129 295b  *)(opt0->data))[
-0006fba0: 305d 3b0a 2020 2020 636f 6e73 7420 696e  0];.    const in
-0006fbb0: 7433 325f 7420 6e65 7031 203d 2028 2863  t32_t nep1 = ((c
-0006fbc0: 6f6e 7374 2069 6e74 3332 5f74 202a 2928  onst int32_t *)(
-0006fbd0: 6f70 7430 2d3e 6461 7461 2929 5b31 5d3b  opt0->data))[1];
-0006fbe0: 0a20 2020 2063 6f6e 7374 2069 6e74 3332  .    const int32
-0006fbf0: 5f74 2077 2020 2020 3d20 2828 636f 6e73  _t w    = ((cons
-0006fc00: 7420 696e 7433 325f 7420 2a29 286f 7074  t int32_t *)(opt
-0006fc10: 302d 3e64 6174 6129 295b 325d 3b0a 0a20  0->data))[2];.. 
-0006fc20: 2020 2061 7373 6572 7428 6e65 3030 203d     assert(ne00 =
-0006fc30: 3d20 6e65 3029 3b0a 2020 2020 6173 7365  = ne0);.    asse
-0006fc40: 7274 286e 6533 2020 3d3d 206e 6570 302a  rt(ne3  == nep0*
-0006fc50: 6e65 7031 293b 0a0a 2020 2020 2f2f 2054  nep1);..    // T
-0006fc60: 4f44 4f3a 206f 7074 696d 697a 6520 2f20  ODO: optimize / 
-0006fc70: 6d75 6c74 692d 7468 7265 6164 0a20 2020  multi-thread.   
-0006fc80: 2066 6f72 2028 696e 7420 7079 203d 2030   for (int py = 0
-0006fc90: 3b20 7079 203c 206e 6570 313b 202b 2b70  ; py < nep1; ++p
-0006fca0: 7929 207b 0a20 2020 2020 2020 2066 6f72  y) {.        for
-0006fcb0: 2028 696e 7420 7078 203d 2030 3b20 7078   (int px = 0; px
-0006fcc0: 203c 206e 6570 303b 202b 2b70 7829 207b   < nep0; ++px) {
-0006fcd0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0006fce0: 7374 2069 6e74 3634 5f74 2069 3320 3d20  st int64_t i3 = 
-0006fcf0: 7079 2a6e 6570 3020 2b20 7078 3b0a 2020  py*nep0 + px;.  
-0006fd00: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
-0006fd10: 6e74 3634 5f74 2069 3220 3d20 303b 2069  nt64_t i2 = 0; i
-0006fd20: 3220 3c20 6e65 323b 202b 2b69 3229 207b  2 < ne2; ++i2) {
-0006fd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006fd40: 2066 6f72 2028 696e 7436 345f 7420 6931   for (int64_t i1
-0006fd50: 203d 2030 3b20 6931 203c 206e 6531 3b20   = 0; i1 < ne1; 
-0006fd60: 2b2b 6931 2920 7b0a 2020 2020 2020 2020  ++i1) {.        
-0006fd70: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0006fd80: 2869 6e74 3634 5f74 2069 3020 3d20 303b  (int64_t i0 = 0;
-0006fd90: 2069 3020 3c20 6e65 303b 202b 2b69 3029   i0 < ne0; ++i0)
-0006fda0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0006fdb0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-0006fdc0: 2069 6e74 3634 5f74 2069 3032 203d 2070   int64_t i02 = p
-0006fdd0: 792a 7720 2b20 6932 3b0a 2020 2020 2020  y*w + i2;.      
-0006fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006fdf0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0006fe00: 6930 3120 3d20 7078 2a77 202b 2069 313b  i01 = px*w + i1;
-0006fe10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0006fe20: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-0006fe30: 6e74 3634 5f74 2069 3030 203d 2069 303b  nt64_t i00 = i0;
-0006fe40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0006fe50: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0006fe60: 696e 7436 345f 7420 6920 3d20 6933 2a6e  int64_t i = i3*n
-0006fe70: 6532 2a6e 6531 2a6e 6530 202b 2069 322a  e2*ne1*ne0 + i2*
-0006fe80: 6e65 312a 6e65 3020 2020 202b 2069 312a  ne1*ne0    + i1*
-0006fe90: 6e65 3020 2020 2b20 6930 3b0a 2020 2020  ne0   + i0;.    
-0006fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006feb0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
-0006fec0: 7420 6a20 3d20 2020 2020 2020 2020 2020  t j =           
-0006fed0: 2020 2020 2020 2069 3032 2a6e 6530 312a         i02*ne01*
-0006fee0: 6e65 3030 202b 2069 3031 2a6e 6530 3020  ne00 + i01*ne00 
-0006fef0: 2b20 6930 303b 0a0a 2020 2020 2020 2020  + i00;..        
+0006f050: 2020 2020 2020 2028 666c 6f61 7420 2a29         (float *)
+0006f060: 2028 2863 6861 7220 2a29 2067 7261 645f   ((char *) grad_
+0006f070: 7120 202b 2028 6931 2a6e 6267 7131 2020  q  + (i1*nbgq1  
+0006f080: 2b20 6932 2a6e 6267 7132 2020 2b20 6933  + i2*nbgq2  + i3
+0006f090: 2a6e 6267 7133 2929 2c0a 2020 2020 2020  *nbgq3)),.      
+0006f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f0b0: 2020 2866 6c6f 6174 202a 2920 2828 6368    (float *) ((ch
+0006f0c0: 6172 202a 2920 6b2d 3e64 6174 6120 2b20  ar *) k->data + 
+0006f0d0: 2869 632a 6e62 6b31 2020 202b 2069 322a  (ic*nbk1   + i2*
+0006f0e0: 6e62 6b32 2020 202b 2069 332a 6e62 6b33  nbk2   + i3*nbk3
+0006f0f0: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+0006f100: 2020 2020 2020 2020 2020 2020 535b 6963              S[ic
+0006f110: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
+0006f120: 7d0a 0a20 2020 2020 2020 2020 2020 202f  }..            /
+0006f130: 2f20 6772 6164 5b6b 5d5b 3a44 2c3a 4d2c  / grad[k][:D,:M,
+0006f140: 6971 322c 6971 335d 202b 3d20 532e 5420  iq2,iq3] += S.T 
+0006f150: 2020 2020 2020 4020 7163 7572 0a20 2020        @ qcur.   
+0006f160: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
+0006f170: 5b6b 5d5b 3a44 2c69 632c 6971 322c 6971  [k][:D,ic,iq2,iq
+0006f180: 335d 202b 3d20 532e 545b 302c 6963 5d20  3] += S.T[0,ic] 
+0006f190: 2a20 7163 7572 5b3a 442c 305d 0a20 2020  * qcur[:D,0].   
+0006f1a0: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
+0006f1b0: 5b6b 5d5b 3a44 2c69 632c 6971 322c 6971  [k][:D,ic,iq2,iq
+0006f1c0: 335d 202b 3d20 535b 6963 5d20 2020 2020  3] += S[ic]     
+0006f1d0: 2a20 7163 7572 5b3a 442c 305d 0a20 2020  * qcur[:D,0].   
+0006f1e0: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
+0006f1f0: 7436 345f 7420 6963 203d 2030 3b20 6963  t64_t ic = 0; ic
+0006f200: 203c 204d 3b20 2b2b 6963 2920 7b0a 2020   < M; ++ic) {.  
+0006f210: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0006f220: 2064 7374 2069 6e64 6963 6573 0a20 2020   dst indices.   
+0006f230: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0006f240: 7374 2069 6e74 2069 3120 3d20 6971 313b  st int i1 = iq1;
+0006f250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f260: 2063 6f6e 7374 2069 6e74 2069 3220 3d20   const int i2 = 
+0006f270: 6971 323b 0a20 2020 2020 2020 2020 2020  iq2;.           
+0006f280: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
+0006f290: 3320 3d20 6971 333b 0a0a 2020 2020 2020  3 = iq3;..      
+0006f2a0: 2020 2020 2020 2020 2020 2f2f 2067 676d            // ggm
+0006f2b0: 6c5f 7665 635f 7365 745f 6633 3228 442c  l_vec_set_f32(D,
+0006f2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f2d0: 202f 2f20 2020 2020 2020 2020 2866 6c6f   //         (flo
+0006f2e0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+0006f2f0: 6772 6164 5f6b 2020 2b20 2869 632a 6e62  grad_k  + (ic*nb
+0006f300: 676b 3120 202b 2069 322a 6e62 676b 3220  gk1  + i2*nbgk2 
+0006f310: 202b 2069 332a 6e62 676b 3329 292c 0a20   + i3*nbgk3)),. 
+0006f320: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0006f330: 2f20 2020 2020 2020 2020 3029 3b0a 2020  /         0);.  
+0006f340: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0006f350: 6d6c 5f76 6563 5f6d 6164 5f66 3332 2844  ml_vec_mad_f32(D
+0006f360: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0006f370: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
+0006f380: 202a 2920 2828 6368 6172 202a 2920 6772   *) ((char *) gr
+0006f390: 6164 5f6b 2020 2b20 2869 632a 6e62 676b  ad_k  + (ic*nbgk
+0006f3a0: 3120 202b 2069 322a 6e62 676b 3220 202b  1  + i2*nbgk2  +
+0006f3b0: 2069 332a 6e62 676b 3329 292c 0a20 2020   i3*nbgk3)),.   
+0006f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f3d0: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+0006f3e0: 2863 6861 7220 2a29 2071 2d3e 6461 7461  (char *) q->data
+0006f3f0: 202b 2028 6931 2a6e 6271 3120 2020 2b20   + (i1*nbq1   + 
+0006f400: 6932 2a6e 6271 3220 2020 2b20 6933 2a6e  i2*nbq2   + i3*n
+0006f410: 6271 3329 292c 0a20 2020 2020 2020 2020  bq3)),.         
+0006f420: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+0006f430: 5b69 635d 293b 0a20 2020 2020 2020 2020  [ic]);.         
+0006f440: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+0006f450: 2020 2f2f 2067 7261 645b 765d 5b3a 4d2c    // grad[v][:M,
+0006f460: 3a44 2c69 7132 2c69 7133 5d20 2b3d 2064  :D,iq2,iq3] += d
+0006f470: 5b3a 442c 6971 312c 6971 322c 6971 335d  [:D,iq1,iq2,iq3]
+0006f480: 2e54 2020 2020 2020 2040 2053 4d0a 2020  .T       @ SM.  
+0006f490: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
+0006f4a0: 645b 765d 5b3a 4d2c 6963 2c69 7132 2c69  d[v][:M,ic,iq2,i
+0006f4b0: 7133 5d20 2b3d 2064 5b3a 442c 6971 312c  q3] += d[:D,iq1,
+0006f4c0: 6971 322c 6971 335d 2e54 5b30 2c69 635d  iq2,iq3].T[0,ic]
+0006f4d0: 202a 2053 4d5b 3a4d 5d0a 2020 2020 2020   * SM[:M].      
+0006f4e0: 2020 2020 2020 2f2f 2067 7261 645b 765d        // grad[v]
+0006f4f0: 5b3a 4d2c 6963 2c69 7132 2c69 7133 5d20  [:M,ic,iq2,iq3] 
+0006f500: 2b3d 2064 5b69 632c 6971 312c 6971 322c  += d[ic,iq1,iq2,
+0006f510: 6971 335d 2020 2020 2020 2020 202a 2053  iq3]         * S
+0006f520: 4d5b 3a4d 5d0a 2020 2020 2020 2020 2020  M[:M].          
+0006f530: 2020 666f 7220 2869 6e74 3634 5f74 2069    for (int64_t i
+0006f540: 6320 3d20 303b 2069 6320 3c20 443b 202b  c = 0; ic < D; +
+0006f550: 2b69 6329 207b 0a20 2020 2020 2020 2020  +ic) {.         
+0006f560: 2020 2020 2020 202f 2f20 6473 7420 696e         // dst in
+0006f570: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+0006f580: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0006f590: 6931 203d 2069 7131 3b0a 2020 2020 2020  i1 = iq1;.      
+0006f5a0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0006f5b0: 696e 7420 6932 203d 2069 7132 3b0a 2020  int i2 = iq2;.  
+0006f5c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0006f5d0: 6e73 7420 696e 7420 6933 203d 2069 7133  nst int i3 = iq3
+0006f5e0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0006f5f0: 2020 202f 2f20 6767 6d6c 5f76 6563 5f73     // ggml_vec_s
+0006f600: 6574 5f66 3332 284d 2c0a 2020 2020 2020  et_f32(M,.      
+0006f610: 2020 2020 2020 2020 2020 2f2f 2020 2020            //    
+0006f620: 2020 2020 2028 666c 6f61 7420 2a29 2028       (float *) (
+0006f630: 2863 6861 7220 2a29 2067 7261 645f 7620  (char *) grad_v 
+0006f640: 2020 2b20 2820 2020 2020 2020 2020 2069    + (          i
+0006f650: 632a 6e62 6776 3120 2b20 6932 2a6e 6267  c*nbgv1 + i2*nbg
+0006f660: 7632 202b 2069 332a 6e62 6776 3329 292c  v2 + i3*nbgv3)),
+0006f670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0006f680: 202f 2f20 2020 2020 2020 2020 3029 3b0a   //         0);.
+0006f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f6a0: 6767 6d6c 5f76 6563 5f6d 6164 5f66 3332  ggml_vec_mad_f32
+0006f6b0: 284d 2c0a 2020 2020 2020 2020 2020 2020  (M,.            
+0006f6c0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+0006f6d0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+0006f6e0: 6772 6164 5f76 2020 202b 2028 2020 2020  grad_v   + (    
+0006f6f0: 2020 2020 2020 6963 2a6e 6267 7631 202b        ic*nbgv1 +
+0006f700: 2069 322a 6e62 6776 3220 2b20 6933 2a6e   i2*nbgv2 + i3*n
+0006f710: 6267 7633 2929 2c0a 2020 2020 2020 2020  bgv3)),.        
+0006f720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006f730: 534d 2c0a 2020 2020 2020 2020 2020 2020  SM,.            
+0006f740: 2020 2020 2020 2020 2020 2020 2a28 666c              *(fl
+0006f750: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
+0006f760: 2064 2d3e 6461 7461 202b 2028 6963 2a6e   d->data + (ic*n
+0006f770: 6264 3020 2b20 6931 2a6e 6264 3120 202b  bd0 + i1*nbd1  +
+0006f780: 2069 322a 6e62 6432 2020 2b20 6933 2a6e   i2*nbd2  + i3*n
+0006f790: 6264 3329 2929 3b0a 2020 2020 2020 2020  bd3)));.        
+0006f7a0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
+0006f7b0: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
+0006f7c0: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+0006f7d0: 655f 666f 7277 6172 645f 666c 6173 685f  e_forward_flash_
+0006f7e0: 6174 746e 5f62 6163 6b28 0a20 2020 2020  attn_back(.     
+0006f7f0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0006f800: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+0006f810: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+0006f820: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+0006f830: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0006f840: 2071 2c0a 2020 2020 2020 2020 636f 6e73   q,.        cons
+0006f850: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0006f860: 6e73 6f72 202a 206b 2c0a 2020 2020 2020  nsor * k,.      
+0006f870: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+0006f880: 676d 6c5f 7465 6e73 6f72 202a 2076 2c0a  gml_tensor * v,.
+0006f890: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+0006f8a0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0006f8b0: 202a 2064 2c0a 2020 2020 2020 2020 636f   * d,.        co
+0006f8c0: 6e73 7420 626f 6f6c 206d 6173 6b65 642c  nst bool masked,
+0006f8d0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0006f8e0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+0006f8f0: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
+0006f900: 2871 2d3e 7479 7065 2920 7b0a 2020 2020  (q->type) {.    
+0006f910: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+0006f920: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
+0006f930: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0006f940: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+0006f950: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
+0006f960: 5f61 7474 6e5f 6261 636b 5f66 3332 2870  _attn_back_f32(p
+0006f970: 6172 616d 732c 2071 2c20 6b2c 2076 2c20  arams, q, k, v, 
+0006f980: 642c 206d 6173 6b65 642c 2064 7374 293b  d, masked, dst);
+0006f990: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+0006f9a0: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
+0006f9b0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+0006f9c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0006f9d0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0006f9e0: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+0006f9f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0006fa00: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
+0006fa10: 6f6d 7075 7465 5f66 6f72 7761 7264 5f77  ompute_forward_w
+0006fa20: 696e 5f70 6172 740a 0a73 7461 7469 6320  in_part..static 
+0006fa30: 766f 6964 2067 676d 6c5f 636f 6d70 7574  void ggml_comput
+0006fa40: 655f 666f 7277 6172 645f 7769 6e5f 7061  e_forward_win_pa
+0006fa50: 7274 5f66 3332 280a 2020 2020 2020 2020  rt_f32(.        
+0006fa60: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0006fa70: 6c5f 636f 6d70 7574 655f 7061 7261 6d73  l_compute_params
+0006fa80: 202a 2070 6172 616d 732c 0a20 2020 2020   * params,.     
+0006fa90: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+0006faa0: 6767 6d6c 5f74 656e 736f 7220 2a20 7372  ggml_tensor * sr
+0006fab0: 6330 2c0a 2020 2020 2020 2020 636f 6e73  c0,.        cons
+0006fac0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
+0006fad0: 6e73 6f72 202a 206f 7074 302c 0a20 2020  nsor * opt0,.   
+0006fae0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0006faf0: 5f74 656e 736f 7220 2a20 6473 7429 207b  _tensor * dst) {
+0006fb00: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
+0006fb10: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
+0006fb20: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
+0006fb30: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+0006fb40: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
+0006fb50: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
+0006fb60: 0a20 2020 207d 0a0a 2020 2020 4747 4d4c  .    }..    GGML
+0006fb70: 5f54 454e 534f 525f 4c4f 4341 4c53 2869  _TENSOR_LOCALS(i
+0006fb80: 6e74 3634 5f74 2c20 6e65 302c 2073 7263  nt64_t, ne0, src
+0006fb90: 302c 206e 6529 3b0a 2020 2020 4747 4d4c  0, ne);.    GGML
+0006fba0: 5f54 454e 534f 525f 4c4f 4341 4c53 2869  _TENSOR_LOCALS(i
+0006fbb0: 6e74 3634 5f74 2c20 6e65 2c20 2064 7374  nt64_t, ne,  dst
+0006fbc0: 2c20 206e 6529 3b0a 0a20 2020 2063 6f6e  ,  ne);..    con
+0006fbd0: 7374 2069 6e74 3332 5f74 206e 6570 3020  st int32_t nep0 
+0006fbe0: 3d20 2828 636f 6e73 7420 696e 7433 325f  = ((const int32_
+0006fbf0: 7420 2a29 286f 7074 302d 3e64 6174 6129  t *)(opt0->data)
+0006fc00: 295b 305d 3b0a 2020 2020 636f 6e73 7420  )[0];.    const 
+0006fc10: 696e 7433 325f 7420 6e65 7031 203d 2028  int32_t nep1 = (
+0006fc20: 2863 6f6e 7374 2069 6e74 3332 5f74 202a  (const int32_t *
+0006fc30: 2928 6f70 7430 2d3e 6461 7461 2929 5b31  )(opt0->data))[1
+0006fc40: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
+0006fc50: 3332 5f74 2077 2020 2020 3d20 2828 636f  32_t w    = ((co
+0006fc60: 6e73 7420 696e 7433 325f 7420 2a29 286f  nst int32_t *)(o
+0006fc70: 7074 302d 3e64 6174 6129 295b 325d 3b0a  pt0->data))[2];.
+0006fc80: 0a20 2020 2061 7373 6572 7428 6e65 3030  .    assert(ne00
+0006fc90: 203d 3d20 6e65 3029 3b0a 2020 2020 6173   == ne0);.    as
+0006fca0: 7365 7274 286e 6533 2020 3d3d 206e 6570  sert(ne3  == nep
+0006fcb0: 302a 6e65 7031 293b 0a0a 2020 2020 2f2f  0*nep1);..    //
+0006fcc0: 2054 4f44 4f3a 206f 7074 696d 697a 6520   TODO: optimize 
+0006fcd0: 2f20 6d75 6c74 692d 7468 7265 6164 0a20  / multi-thread. 
+0006fce0: 2020 2066 6f72 2028 696e 7420 7079 203d     for (int py =
+0006fcf0: 2030 3b20 7079 203c 206e 6570 313b 202b   0; py < nep1; +
+0006fd00: 2b70 7929 207b 0a20 2020 2020 2020 2066  +py) {.        f
+0006fd10: 6f72 2028 696e 7420 7078 203d 2030 3b20  or (int px = 0; 
+0006fd20: 7078 203c 206e 6570 303b 202b 2b70 7829  px < nep0; ++px)
+0006fd30: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
+0006fd40: 6f6e 7374 2069 6e74 3634 5f74 2069 3320  onst int64_t i3 
+0006fd50: 3d20 7079 2a6e 6570 3020 2b20 7078 3b0a  = py*nep0 + px;.
+0006fd60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0006fd70: 2869 6e74 3634 5f74 2069 3220 3d20 303b  (int64_t i2 = 0;
+0006fd80: 2069 3220 3c20 6e65 323b 202b 2b69 3229   i2 < ne2; ++i2)
+0006fd90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0006fda0: 2020 2066 6f72 2028 696e 7436 345f 7420     for (int64_t 
+0006fdb0: 6931 203d 2030 3b20 6931 203c 206e 6531  i1 = 0; i1 < ne1
+0006fdc0: 3b20 2b2b 6931 2920 7b0a 2020 2020 2020  ; ++i1) {.      
+0006fdd0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0006fde0: 7220 2869 6e74 3634 5f74 2069 3020 3d20  r (int64_t i0 = 
+0006fdf0: 303b 2069 3020 3c20 6e65 303b 202b 2b69  0; i0 < ne0; ++i
+0006fe00: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
+0006fe10: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0006fe20: 7374 2069 6e74 3634 5f74 2069 3032 203d  st int64_t i02 =
+0006fe30: 2070 792a 7720 2b20 6932 3b0a 2020 2020   py*w + i2;.    
+0006fe40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006fe50: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+0006fe60: 7420 6930 3120 3d20 7078 2a77 202b 2069  t i01 = px*w + i
+0006fe70: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
+0006fe80: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0006fe90: 2069 6e74 3634 5f74 2069 3030 203d 2069   int64_t i00 = i
+0006fea0: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
+0006feb0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0006fec0: 7420 696e 7436 345f 7420 6920 3d20 6933  t int64_t i = i3
+0006fed0: 2a6e 6532 2a6e 6531 2a6e 6530 202b 2069  *ne2*ne1*ne0 + i
+0006fee0: 322a 6e65 312a 6e65 3020 2020 202b 2069  2*ne1*ne0    + i
+0006fef0: 312a 6e65 3020 2020 2b20 6930 3b0a 2020  1*ne0   + i0;.  
 0006ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ff10: 6966 2028 7079 2a77 202b 2069 3220 3e3d  if (py*w + i2 >=
-0006ff20: 206e 6530 3220 7c7c 2070 782a 7720 2b20   ne02 || px*w + 
-0006ff30: 6931 203e 3d20 6e65 3031 2920 7b0a 2020  i1 >= ne01) {.  
-0006ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ff50: 2020 2020 2020 2020 2020 2828 666c 6f61            ((floa
-0006ff60: 7420 2a29 2064 7374 2d3e 6461 7461 295b  t *) dst->data)[
-0006ff70: 695d 203d 2030 2e30 663b 0a20 2020 2020  i] = 0.0f;.     
-0006ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ff90: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+0006ff10: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+0006ff20: 345f 7420 6a20 3d20 2020 2020 2020 2020  4_t j =         
+0006ff30: 2020 2020 2020 2020 2069 3032 2a6e 6530           i02*ne0
+0006ff40: 312a 6e65 3030 202b 2069 3031 2a6e 6530  1*ne00 + i01*ne0
+0006ff50: 3020 2b20 6930 303b 0a0a 2020 2020 2020  0 + i00;..      
+0006ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006ff70: 2020 6966 2028 7079 2a77 202b 2069 3220    if (py*w + i2 
+0006ff80: 3e3d 206e 6530 3220 7c7c 2070 782a 7720  >= ne02 || px*w 
+0006ff90: 2b20 6931 203e 3d20 6e65 3031 2920 7b0a  + i1 >= ne01) {.
 0006ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0006ffb0: 2020 2020 2020 2020 2828 666c 6f61 7420          ((float 
-0006ffc0: 2a29 2064 7374 2d3e 6461 7461 295b 695d  *) dst->data)[i]
-0006ffd0: 203d 2028 2866 6c6f 6174 202a 2920 7372   = ((float *) sr
-0006ffe0: 6330 2d3e 6461 7461 295b 6a5d 3b0a 2020  c0->data)[j];.  
-0006fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070000: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00070010: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00070020: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00070030: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00070040: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-00070050: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00070060: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00070070: 645f 7769 6e5f 7061 7274 280a 2020 2020  d_win_part(.    
-00070080: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00070090: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-000700a0: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-000700b0: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000700c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000700d0: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-000700e0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-000700f0: 6c5f 7465 6e73 6f72 202a 206f 7074 302c  l_tensor * opt0,
-00070100: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00070110: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00070120: 7429 207b 0a20 2020 2073 7769 7463 6820  t) {.    switch 
-00070130: 2873 7263 302d 3e74 7970 6529 207b 0a20  (src0->type) {. 
-00070140: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00070150: 5f54 5950 455f 4633 323a 0a20 2020 2020  _TYPE_F32:.     
-00070160: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00070170: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00070180: 6d70 7574 655f 666f 7277 6172 645f 7769  mpute_forward_wi
-00070190: 6e5f 7061 7274 5f66 3332 2870 6172 616d  n_part_f32(param
-000701a0: 732c 2073 7263 302c 206f 7074 302c 2064  s, src0, opt0, d
-000701b0: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-000701c0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000701d0: 2020 6465 6661 756c 743a 0a20 2020 2020    default:.     
-000701e0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000701f0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00070200: 5345 5254 2866 616c 7365 293b 0a20 2020  SERT(false);.   
-00070210: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00070220: 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20 6767  ;.    }.}..// gg
-00070230: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00070240: 7264 5f77 696e 5f75 6e70 6172 740a 0a73  rd_win_unpart..s
-00070250: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00070260: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00070270: 7769 6e5f 756e 7061 7274 5f66 3332 280a  win_unpart_f32(.
-00070280: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00070290: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000702a0: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-000702b0: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-000702c0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000702d0: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-000702e0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-000702f0: 2067 676d 6c5f 7465 6e73 6f72 202a 206f   ggml_tensor * o
-00070300: 7074 302c 0a20 2020 2020 2020 2073 7472  pt0,.        str
-00070310: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00070320: 2a20 6473 7429 207b 0a20 2020 2069 6620  * dst) {.    if 
-00070330: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00070340: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00070350: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00070360: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00070370: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00070380: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00070390: 2020 2020 4747 4d4c 5f54 454e 534f 525f      GGML_TENSOR_
-000703a0: 4c4f 4341 4c53 2869 6e74 3634 5f74 2c20  LOCALS(int64_t, 
-000703b0: 6e65 302c 2073 7263 302c 206e 6529 3b0a  ne0, src0, ne);.
-000703c0: 2020 2020 4747 4d4c 5f54 454e 534f 525f      GGML_TENSOR_
-000703d0: 4c4f 4341 4c53 2869 6e74 3634 5f74 2c20  LOCALS(int64_t, 
-000703e0: 6e65 2c20 2064 7374 2c20 206e 6529 3b0a  ne,  dst,  ne);.
-000703f0: 0a20 2020 2063 6f6e 7374 2069 6e74 3332  .    const int32
-00070400: 5f74 2077 203d 2028 2863 6f6e 7374 2069  _t w = ((const i
-00070410: 6e74 3332 5f74 202a 2928 6f70 7430 2d3e  nt32_t *)(opt0->
-00070420: 6461 7461 2929 5b30 5d3b 0a0a 2020 2020  data))[0];..    
-00070430: 2f2f 2070 6164 6469 6e67 0a20 2020 2063  // padding.    c
-00070440: 6f6e 7374 2069 6e74 2070 7820 3d20 2877  onst int px = (w
-00070450: 202d 206e 6531 2577 2925 773b 0a20 2020   - ne1%w)%w;.   
-00070460: 202f 2f63 6f6e 7374 2069 6e74 2070 7920   //const int py 
-00070470: 3d20 2877 202d 206e 6532 2577 2925 773b  = (w - ne2%w)%w;
-00070480: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00070490: 6e70 7820 3d20 2870 7820 2b20 6e65 3129  npx = (px + ne1)
-000704a0: 2f77 3b0a 2020 2020 2f2f 636f 6e73 7420  /w;.    //const 
-000704b0: 696e 7420 6e70 7920 3d20 2870 7920 2b20  int npy = (py + 
-000704c0: 6e65 3229 2f77 3b0a 0a20 2020 2061 7373  ne2)/w;..    ass
-000704d0: 6572 7428 6e65 3020 3d3d 206e 6530 3029  ert(ne0 == ne00)
-000704e0: 3b0a 0a20 2020 202f 2f20 544f 444f 3a20  ;..    // TODO: 
-000704f0: 6f70 7469 6d69 7a65 202f 206d 756c 7469  optimize / multi
-00070500: 2d74 6872 6561 640a 2020 2020 666f 7220  -thread.    for 
-00070510: 2869 6e74 3634 5f74 2069 3220 3d20 303b  (int64_t i2 = 0;
-00070520: 2069 3220 3c20 6e65 323b 202b 2b69 3229   i2 < ne2; ++i2)
-00070530: 207b 0a20 2020 2020 2020 2066 6f72 2028   {.        for (
-00070540: 696e 7436 345f 7420 6931 203d 2030 3b20  int64_t i1 = 0; 
-00070550: 6931 203c 206e 6531 3b20 2b2b 6931 2920  i1 < ne1; ++i1) 
-00070560: 7b0a 2020 2020 2020 2020 2020 2020 666f  {.            fo
-00070570: 7220 2869 6e74 3634 5f74 2069 3020 3d20  r (int64_t i0 = 
-00070580: 303b 2069 3020 3c20 6e65 303b 202b 2b69  0; i0 < ne0; ++i
-00070590: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-000705a0: 2020 2020 2063 6f6e 7374 2069 6e74 2069       const int i
-000705b0: 7032 203d 2069 322f 773b 0a20 2020 2020  p2 = i2/w;.     
-000705c0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000705d0: 2069 6e74 2069 7031 203d 2069 312f 773b   int ip1 = i1/w;
-000705e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000705f0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00070600: 6930 3220 3d20 6932 2577 3b0a 2020 2020  i02 = i2%w;.    
-00070610: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00070620: 7420 696e 7436 345f 7420 6930 3120 3d20  t int64_t i01 = 
-00070630: 6931 2577 3b0a 2020 2020 2020 2020 2020  i1%w;.          
-00070640: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-00070650: 345f 7420 6930 3020 3d20 6930 3b0a 0a20  4_t i00 = i0;.. 
-00070660: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00070670: 6f6e 7374 2069 6e74 3634 5f74 2069 203d  onst int64_t i =
-00070680: 2028 6970 322a 6e70 7820 2b20 6970 3129   (ip2*npx + ip1)
-00070690: 2a6e 6530 322a 6e65 3031 2a6e 6530 3020  *ne02*ne01*ne00 
-000706a0: 2b20 6930 322a 6e65 3031 2a6e 6530 3020  + i02*ne01*ne00 
-000706b0: 2b20 6930 312a 6e65 3030 202b 2069 3030  + i01*ne00 + i00
-000706c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000706d0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-000706e0: 6a20 3d20 2020 2020 2020 2020 2020 2020  j =             
-000706f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00070700: 2020 2020 2069 322a 6e65 312a 6e65 3020       i2*ne1*ne0 
-00070710: 2020 202b 2069 312a 6e65 3020 2020 2b20     + i1*ne0   + 
-00070720: 6930 3b0a 0a20 2020 2020 2020 2020 2020  i0;..           
-00070730: 2020 2020 2028 2866 6c6f 6174 202a 2920       ((float *) 
-00070740: 6473 742d 3e64 6174 6129 5b6a 5d20 3d20  dst->data)[j] = 
-00070750: 2828 666c 6f61 7420 2a29 2073 7263 302d  ((float *) src0-
-00070760: 3e64 6174 6129 5b69 5d3b 0a20 2020 2020  >data)[i];.     
-00070770: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00070780: 207d 0a20 2020 207d 0a7d 0a0a 7374 6174   }.    }.}..stat
-00070790: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
-000707a0: 7075 7465 5f66 6f72 7761 7264 5f77 696e  pute_forward_win
-000707b0: 5f75 6e70 6172 7428 0a20 2020 2020 2020  _unpart(.       
-000707c0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-000707d0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-000707e0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-000707f0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00070800: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00070810: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00070820: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00070830: 656e 736f 7220 2a20 6f70 7430 2c0a 2020  ensor * opt0,.  
-00070840: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00070850: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-00070860: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
-00070870: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
-00070880: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00070890: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-000708a0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000708b0: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-000708c0: 7465 5f66 6f72 7761 7264 5f77 696e 5f75  te_forward_win_u
-000708d0: 6e70 6172 745f 6633 3228 7061 7261 6d73  npart_f32(params
-000708e0: 2c20 7372 6330 2c20 6f70 7430 2c20 6473  , src0, opt0, ds
-000708f0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-00070900: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00070910: 2064 6566 6175 6c74 3a0a 2020 2020 2020   default:.      
-00070920: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00070930: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00070940: 4552 5428 6661 6c73 6529 3b0a 2020 2020  ERT(false);.    
-00070950: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00070960: 0a20 2020 207d 0a7d 0a0a 2f2f 2067 676d  .    }.}..// ggm
-00070970: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00070980: 645f 6d61 705f 756e 6172 790a 0a73 7461  d_map_unary..sta
-00070990: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-000709a0: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
-000709b0: 705f 756e 6172 795f 6633 3228 0a20 2020  p_unary_f32(.   
-000709c0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-000709d0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
-000709e0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
-000709f0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00070a00: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00070a10: 202a 2073 7263 302c 0a20 2020 2020 2020   * src0,.       
-00070a20: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00070a30: 736f 7220 2a20 6473 742c 0a20 2020 2020  sor * dst,.     
-00070a40: 2020 2063 6f6e 7374 2067 676d 6c5f 756e     const ggml_un
-00070a50: 6172 795f 6f70 5f66 3332 5f74 2066 756e  ary_op_f32_t fun
-00070a60: 2920 7b0a 2020 2020 4747 4d4c 5f41 5353  ) {.    GGML_ASS
-00070a70: 4552 5428 6767 6d6c 5f61 7265 5f73 616d  ERT(ggml_are_sam
-00070a80: 655f 7368 6170 6528 7372 6330 2c20 6473  e_shape(src0, ds
-00070a90: 7429 293b 0a0a 2020 2020 6966 2028 7061  t));..    if (pa
-00070aa0: 7261 6d73 2d3e 7479 7065 203d 3d20 4747  rams->type == GG
-00070ab0: 4d4c 5f54 4153 4b5f 494e 4954 207c 7c20  ML_TASK_INIT || 
-00070ac0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00070ad0: 4747 4d4c 5f54 4153 4b5f 4649 4e41 4c49  GGML_TASK_FINALI
-00070ae0: 5a45 2920 7b0a 2020 2020 2020 2020 7265  ZE) {.        re
-00070af0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00070b00: 2063 6f6e 7374 2069 6e74 206e 2020 3d20   const int n  = 
-00070b10: 6767 6d6c 5f6e 726f 7773 2873 7263 3029  ggml_nrows(src0)
-00070b20: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00070b30: 6e63 203d 2073 7263 302d 3e6e 655b 305d  nc = src0->ne[0]
-00070b40: 3b0a 0a20 2020 2061 7373 6572 7428 2064  ;..    assert( d
-00070b50: 7374 2d3e 6e62 5b30 5d20 3d3d 2073 697a  st->nb[0] == siz
-00070b60: 656f 6628 666c 6f61 7429 293b 0a20 2020  eof(float));.   
-00070b70: 2061 7373 6572 7428 7372 6330 2d3e 6e62   assert(src0->nb
-00070b80: 5b30 5d20 3d3d 2073 697a 656f 6628 666c  [0] == sizeof(fl
-00070b90: 6f61 7429 293b 0a0a 2020 2020 666f 7220  oat));..    for 
-00070ba0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00070bb0: 6e3b 2069 2b2b 2920 7b0a 2020 2020 2020  n; i++) {.      
-00070bc0: 2020 6675 6e28 6e63 2c0a 2020 2020 2020    fun(nc,.      
-00070bd0: 2020 2020 2020 2020 2020 2866 6c6f 6174            (float
-00070be0: 202a 2920 2828 6368 6172 202a 2920 6473   *) ((char *) ds
-00070bf0: 742d 3e64 6174 6120 202b 2069 2a28 2064  t->data  + i*( d
-00070c00: 7374 2d3e 6e62 5b31 5d29 292c 0a20 2020  st->nb[1])),.   
-00070c10: 2020 2020 2020 2020 2020 2020 2028 666c               (fl
-00070c20: 6f61 7420 2a29 2028 2863 6861 7220 2a29  oat *) ((char *)
-00070c30: 2073 7263 302d 3e64 6174 6120 2b20 692a   src0->data + i*
-00070c40: 2873 7263 302d 3e6e 625b 315d 2929 293b  (src0->nb[1])));
-00070c50: 0a20 2020 207d 0a7d 0a0a 0a73 7461 7469  .    }.}...stati
-00070c60: 6320 766f 6964 2067 676d 6c5f 636f 6d70  c void ggml_comp
-00070c70: 7574 655f 666f 7277 6172 645f 6d61 705f  ute_forward_map_
-00070c80: 756e 6172 7928 0a20 2020 2020 2020 2063  unary(.        c
-00070c90: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00070ca0: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00070cb0: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00070cc0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00070cd0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00070ce0: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
-00070cf0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00070d00: 6473 742c 0a20 2020 2020 2020 2063 6f6e  dst,.        con
-00070d10: 7374 2067 676d 6c5f 756e 6172 795f 6f70  st ggml_unary_op
-00070d20: 5f66 3332 5f74 2066 756e 2920 7b0a 2020  _f32_t fun) {.  
-00070d30: 2020 7377 6974 6368 2028 7372 6330 2d3e    switch (src0->
-00070d40: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00070d50: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-00070d60: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-00070d70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00070d80: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00070d90: 6f72 7761 7264 5f6d 6170 5f75 6e61 7279  orward_map_unary
-00070da0: 5f66 3332 2870 6172 616d 732c 2073 7263  _f32(params, src
-00070db0: 302c 2064 7374 2c20 6675 6e29 3b0a 2020  0, dst, fun);.  
-00070dc0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00070dd0: 6b3b 0a20 2020 2020 2020 2064 6566 6175  k;.        defau
-00070de0: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
-00070df0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00070e00: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00070e10: 6c73 6529 3b0a 2020 2020 2020 2020 2020  lse);.          
-00070e20: 2020 7d20 6272 6561 6b3b 0a20 2020 207d    } break;.    }
-00070e30: 0a7d 0a0a 2f2f 2067 676d 6c5f 636f 6d70  .}..// ggml_comp
-00070e40: 7574 655f 666f 7277 6172 645f 6d61 705f  ute_forward_map_
-00070e50: 6269 6e61 7279 0a0a 7374 6174 6963 2076  binary..static v
-00070e60: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00070e70: 5f66 6f72 7761 7264 5f6d 6170 5f62 696e  _forward_map_bin
-00070e80: 6172 795f 6633 3228 0a20 2020 2020 2020  ary_f32(.       
-00070e90: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00070ea0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-00070eb0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
-00070ec0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00070ed0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00070ee0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
-00070ef0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-00070f00: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
-00070f10: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00070f20: 6c5f 7465 6e73 6f72 202a 2064 7374 2c0a  l_tensor * dst,.
-00070f30: 2020 2020 2020 2020 636f 6e73 7420 6767          const gg
-00070f40: 6d6c 5f62 696e 6172 795f 6f70 5f66 3332  ml_binary_op_f32
-00070f50: 5f74 2066 756e 2920 7b0a 2020 2020 6173  _t fun) {.    as
-00070f60: 7365 7274 2870 6172 616d 732d 3e69 7468  sert(params->ith
-00070f70: 203d 3d20 3029 3b0a 2020 2020 6173 7365   == 0);.    asse
-00070f80: 7274 2867 676d 6c5f 6172 655f 7361 6d65  rt(ggml_are_same
-00070f90: 5f73 6861 7065 2873 7263 302c 2073 7263  _shape(src0, src
-00070fa0: 3129 2026 2620 6767 6d6c 5f61 7265 5f73  1) && ggml_are_s
-00070fb0: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
-00070fc0: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
-00070fd0: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
-00070fe0: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
-00070ff0: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
-00071000: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00071010: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
-00071020: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
-00071030: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
-00071040: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
-00071050: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
-00071060: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
-00071070: 305d 3b0a 0a20 2020 2061 7373 6572 7428  0];..    assert(
-00071080: 2064 7374 2d3e 6e62 5b30 5d20 3d3d 2073   dst->nb[0] == s
-00071090: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
-000710a0: 2020 2061 7373 6572 7428 7372 6330 2d3e     assert(src0->
-000710b0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
-000710c0: 666c 6f61 7429 293b 0a20 2020 2061 7373  float));.    ass
-000710d0: 6572 7428 7372 6331 2d3e 6e62 5b30 5d20  ert(src1->nb[0] 
-000710e0: 3d3d 2073 697a 656f 6628 666c 6f61 7429  == sizeof(float)
-000710f0: 293b 0a0a 2020 2020 666f 7220 2869 6e74  );..    for (int
-00071100: 2069 203d 2030 3b20 6920 3c20 6e3b 2069   i = 0; i < n; i
-00071110: 2b2b 2920 7b0a 2020 2020 2020 2020 6675  ++) {.        fu
-00071120: 6e28 6e63 2c0a 2020 2020 2020 2020 2020  n(nc,.          
-00071130: 2020 2020 2020 2866 6c6f 6174 202a 2920        (float *) 
-00071140: 2828 6368 6172 202a 2920 6473 742d 3e64  ((char *) dst->d
-00071150: 6174 6120 202b 2069 2a28 2064 7374 2d3e  ata  + i*( dst->
-00071160: 6e62 5b31 5d29 292c 0a20 2020 2020 2020  nb[1])),.       
-00071170: 2020 2020 2020 2020 2028 666c 6f61 7420           (float 
-00071180: 2a29 2028 2863 6861 7220 2a29 2073 7263  *) ((char *) src
-00071190: 302d 3e64 6174 6120 2b20 692a 2873 7263  0->data + i*(src
-000711a0: 302d 3e6e 625b 315d 2929 2c0a 2020 2020  0->nb[1])),.    
-000711b0: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
-000711c0: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
-000711d0: 7372 6331 2d3e 6461 7461 202b 2069 2a28  src1->data + i*(
-000711e0: 7372 6331 2d3e 6e62 5b31 5d29 2929 3b0a  src1->nb[1])));.
-000711f0: 2020 2020 7d0a 7d0a 0a0a 7374 6174 6963      }.}...static
-00071200: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00071210: 7465 5f66 6f72 7761 7264 5f6d 6170 5f62  te_forward_map_b
-00071220: 696e 6172 7928 0a20 2020 2020 2020 2063  inary(.        c
-00071230: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00071240: 5f63 6f6d 7075 7465 5f70 6172 616d 7320  _compute_params 
-00071250: 2a20 7061 7261 6d73 2c0a 2020 2020 2020  * params,.      
-00071260: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00071270: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
-00071280: 302c 0a20 2020 2020 2020 2063 6f6e 7374  0,.        const
-00071290: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000712a0: 736f 7220 2a20 7372 6331 2c0a 2020 2020  sor * src1,.    
-000712b0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000712c0: 7465 6e73 6f72 202a 2064 7374 2c0a 2020  tensor * dst,.  
-000712d0: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
-000712e0: 5f62 696e 6172 795f 6f70 5f66 3332 5f74  _binary_op_f32_t
-000712f0: 2066 756e 2920 7b0a 2020 2020 7377 6974   fun) {.    swit
-00071300: 6368 2028 7372 6330 2d3e 7479 7065 2920  ch (src0->type) 
-00071310: 7b0a 2020 2020 2020 2020 6361 7365 2047  {.        case G
-00071320: 474d 4c5f 5459 5045 5f46 3332 3a0a 2020  GML_TYPE_F32:.  
-00071330: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00071340: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00071350: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00071360: 5f6d 6170 5f62 696e 6172 795f 6633 3228  _map_binary_f32(
-00071370: 7061 7261 6d73 2c20 7372 6330 2c20 7372  params, src0, sr
-00071380: 6331 2c20 6473 742c 2066 756e 293b 0a20  c1, dst, fun);. 
-00071390: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000713a0: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-000713b0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-000713c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000713d0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-000713e0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-000713f0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00071400: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
-00071410: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
-00071420: 5f63 7573 746f 6d31 0a0a 7374 6174 6963  _custom1..static
-00071430: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
-00071440: 7465 5f66 6f72 7761 7264 5f6d 6170 5f63  te_forward_map_c
-00071450: 7573 746f 6d31 5f66 3332 280a 2020 2020  ustom1_f32(.    
-00071460: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00071470: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00071480: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00071490: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-000714a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000714b0: 2a20 612c 0a20 2020 2020 2020 2073 7472  * a,.        str
-000714c0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-000714d0: 2a20 6473 742c 0a20 2020 2020 2020 2063  * dst,.        c
-000714e0: 6f6e 7374 2067 676d 6c5f 6375 7374 6f6d  onst ggml_custom
-000714f0: 315f 6f70 5f66 3332 5f74 2066 756e 2920  1_op_f32_t fun) 
-00071500: 7b0a 2020 2020 6173 7365 7274 2870 6172  {.    assert(par
-00071510: 616d 732d 3e69 7468 203d 3d20 3029 3b0a  ams->ith == 0);.
-00071520: 0a20 2020 2069 6620 2870 6172 616d 732d  .    if (params-
-00071530: 3e74 7970 6520 3d3d 2047 474d 4c5f 5441  >type == GGML_TA
-00071540: 534b 5f49 4e49 5420 7c7c 2070 6172 616d  SK_INIT || param
-00071550: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
-00071560: 5441 534b 5f46 494e 414c 495a 4529 207b  TASK_FINALIZE) {
-00071570: 0a20 2020 2020 2020 2072 6574 7572 6e3b  .        return;
-00071580: 0a20 2020 207d 0a0a 2020 2020 6675 6e28  .    }..    fun(
-00071590: 6473 742c 2061 293b 0a7d 0a0a 0a73 7461  dst, a);.}...sta
-000715a0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-000715b0: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
-000715c0: 705f 6375 7374 6f6d 3128 0a20 2020 2020  p_custom1(.     
-000715d0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000715e0: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-000715f0: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00071600: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00071610: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00071620: 2061 2c0a 2020 2020 2020 2020 7374 7275   a,.        stru
-00071630: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00071640: 2064 7374 2c0a 2020 2020 2020 2020 636f   dst,.        co
-00071650: 6e73 7420 6767 6d6c 5f63 7573 746f 6d31  nst ggml_custom1
-00071660: 5f6f 705f 6633 325f 7420 6675 6e29 207b  _op_f32_t fun) {
-00071670: 0a20 2020 2073 7769 7463 6820 2861 2d3e  .    switch (a->
-00071680: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
-00071690: 6361 7365 2047 474d 4c5f 5459 5045 5f46  case GGML_TYPE_F
-000716a0: 3332 3a0a 2020 2020 2020 2020 2020 2020  32:.            
-000716b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000716c0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-000716d0: 6f72 7761 7264 5f6d 6170 5f63 7573 746f  orward_map_custo
-000716e0: 6d31 5f66 3332 2870 6172 616d 732c 2061  m1_f32(params, a
-000716f0: 2c20 6473 742c 2066 756e 293b 0a20 2020  , dst, fun);.   
-00071700: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00071710: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-00071720: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-00071730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00071740: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00071750: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00071760: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00071770: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-00071780: 7465 5f66 6f72 7761 7264 5f6d 6170 5f63  te_forward_map_c
-00071790: 7573 746f 6d32 0a0a 7374 6174 6963 2076  ustom2..static v
-000717a0: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-000717b0: 5f66 6f72 7761 7264 5f6d 6170 5f63 7573  _forward_map_cus
-000717c0: 746f 6d32 5f66 3332 280a 2020 2020 2020  tom2_f32(.      
-000717d0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-000717e0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-000717f0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00071800: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00071810: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00071820: 612c 0a20 2020 2020 2020 2063 6f6e 7374  a,.        const
-00071830: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00071840: 736f 7220 2a20 622c 0a20 2020 2020 2020  sor * b,.       
-00071850: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00071860: 736f 7220 2a20 6473 742c 0a20 2020 2020  sor * dst,.     
-00071870: 2020 2063 6f6e 7374 2067 676d 6c5f 6375     const ggml_cu
-00071880: 7374 6f6d 325f 6f70 5f66 3332 5f74 2066  stom2_op_f32_t f
-00071890: 756e 2920 7b0a 2020 2020 6173 7365 7274  un) {.    assert
-000718a0: 2870 6172 616d 732d 3e69 7468 203d 3d20  (params->ith == 
-000718b0: 3029 3b0a 0a20 2020 2069 6620 2870 6172  0);..    if (par
-000718c0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
-000718d0: 4c5f 5441 534b 5f49 4e49 5420 7c7c 2070  L_TASK_INIT || p
-000718e0: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
-000718f0: 474d 4c5f 5441 534b 5f46 494e 414c 495a  GML_TASK_FINALIZ
-00071900: 4529 207b 0a20 2020 2020 2020 2072 6574  E) {.        ret
-00071910: 7572 6e3b 0a20 2020 207d 0a0a 2020 2020  urn;.    }..    
-00071920: 6675 6e28 6473 742c 2061 2c20 6229 3b0a  fun(dst, a, b);.
-00071930: 7d0a 0a0a 7374 6174 6963 2076 6f69 6420  }...static void 
-00071940: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00071950: 7761 7264 5f6d 6170 5f63 7573 746f 6d32  ward_map_custom2
-00071960: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
-00071970: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
-00071980: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
-00071990: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
-000719a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000719b0: 656e 736f 7220 2a20 612c 0a20 2020 2020  ensor * a,.     
-000719c0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-000719d0: 6767 6d6c 5f74 656e 736f 7220 2a20 622c  ggml_tensor * b,
-000719e0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-000719f0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
-00071a00: 742c 0a20 2020 2020 2020 2063 6f6e 7374  t,.        const
-00071a10: 2067 676d 6c5f 6375 7374 6f6d 325f 6f70   ggml_custom2_op
-00071a20: 5f66 3332 5f74 2066 756e 2920 7b0a 2020  _f32_t fun) {.  
-00071a30: 2020 7377 6974 6368 2028 612d 3e74 7970    switch (a->typ
-00071a40: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
-00071a50: 6520 4747 4d4c 5f54 5950 455f 4633 323a  e GGML_TYPE_F32:
-00071a60: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00071a70: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00071a80: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00071a90: 6172 645f 6d61 705f 6375 7374 6f6d 325f  ard_map_custom2_
-00071aa0: 6633 3228 7061 7261 6d73 2c20 612c 2062  f32(params, a, b
-00071ab0: 2c20 6473 742c 2066 756e 293b 0a20 2020  , dst, fun);.   
-00071ac0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00071ad0: 3b0a 2020 2020 2020 2020 6465 6661 756c  ;.        defaul
-00071ae0: 743a 0a20 2020 2020 2020 2020 2020 207b  t:.            {
-00071af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00071b00: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00071b10: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
-00071b20: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00071b30: 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d 7075  }..// ggml_compu
-00071b40: 7465 5f66 6f72 7761 7264 5f6d 6170 5f63  te_forward_map_c
-00071b50: 7573 746f 6d33 0a0a 7374 6174 6963 2076  ustom3..static v
-00071b60: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
-00071b70: 5f66 6f72 7761 7264 5f6d 6170 5f63 7573  _forward_map_cus
-00071b80: 746f 6d33 5f66 3332 280a 2020 2020 2020  tom3_f32(.      
-00071b90: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00071ba0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00071bb0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00071bc0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00071bd0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00071be0: 612c 0a20 2020 2020 2020 2063 6f6e 7374  a,.        const
-00071bf0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00071c00: 736f 7220 2a20 622c 0a20 2020 2020 2020  sor * b,.       
-00071c10: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00071c20: 6d6c 5f74 656e 736f 7220 2a20 632c 0a20  ml_tensor * c,. 
-00071c30: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00071c40: 6d6c 5f74 656e 736f 7220 2a20 6473 742c  ml_tensor * dst,
-00071c50: 0a20 2020 2020 2020 2063 6f6e 7374 2067  .        const g
-00071c60: 676d 6c5f 6375 7374 6f6d 335f 6f70 5f66  gml_custom3_op_f
-00071c70: 3332 5f74 2066 756e 2920 7b0a 2020 2020  32_t fun) {.    
-00071c80: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
-00071c90: 7468 203d 3d20 3029 3b0a 0a20 2020 2069  th == 0);..    i
-00071ca0: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-00071cb0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
-00071cc0: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
-00071cd0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
-00071ce0: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
-00071cf0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
-00071d00: 0a0a 2020 2020 6675 6e28 6473 742c 2061  ..    fun(dst, a
-00071d10: 2c20 622c 2063 293b 0a7d 0a0a 0a73 7461  , b, c);.}...sta
-00071d20: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
-00071d30: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
-00071d40: 705f 6375 7374 6f6d 3328 0a20 2020 2020  p_custom3(.     
-00071d50: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00071d60: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
-00071d70: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
-00071d80: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
-00071d90: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00071da0: 2061 2c0a 2020 2020 2020 2020 636f 6e73   a,.        cons
-00071db0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-00071dc0: 6e73 6f72 202a 2062 2c0a 2020 2020 2020  nsor * b,.      
-00071dd0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00071de0: 676d 6c5f 7465 6e73 6f72 202a 2063 2c0a  gml_tensor * c,.
-00071df0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-00071e00: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
-00071e10: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-00071e20: 6767 6d6c 5f63 7573 746f 6d33 5f6f 705f  ggml_custom3_op_
-00071e30: 6633 325f 7420 6675 6e29 207b 0a20 2020  f32_t fun) {.   
-00071e40: 2073 7769 7463 6820 2861 2d3e 7479 7065   switch (a->type
-00071e50: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
-00071e60: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-00071e70: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00071e80: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00071e90: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00071ea0: 7264 5f6d 6170 5f63 7573 746f 6d33 5f66  rd_map_custom3_f
-00071eb0: 3332 2870 6172 616d 732c 2061 2c20 622c  32(params, a, b,
-00071ec0: 2063 2c20 6473 742c 2066 756e 293b 0a20   c, dst, fun);. 
-00071ed0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00071ee0: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
-00071ef0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-00071f00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00071f10: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
-00071f20: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
-00071f30: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00071f40: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
-00071f50: 7075 7465 5f66 6f72 7761 7264 5f63 726f  pute_forward_cro
-00071f60: 7373 5f65 6e74 726f 7079 5f6c 6f73 730a  ss_entropy_loss.
-00071f70: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00071f80: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00071f90: 645f 6372 6f73 735f 656e 7472 6f70 795f  d_cross_entropy_
-00071fa0: 6c6f 7373 5f66 3332 280a 2020 2020 2020  loss_f32(.      
-00071fb0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
-00071fc0: 676d 6c5f 636f 6d70 7574 655f 7061 7261  gml_compute_para
-00071fd0: 6d73 202a 2070 6172 616d 732c 0a20 2020  ms * params,.   
-00071fe0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
-00071ff0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00072000: 7372 6330 2c0a 2020 2020 2020 2020 636f  src0,.        co
-00072010: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-00072020: 7465 6e73 6f72 202a 2073 7263 312c 0a20  tensor * src1,. 
-00072030: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00072040: 6d6c 5f74 656e 736f 7220 2a20 6473 7429  ml_tensor * dst)
-00072050: 207b 0a20 2020 2047 474d 4c5f 4153 5345   {.    GGML_ASSE
-00072060: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
-00072070: 6775 6f75 7328 7372 6330 2929 3b0a 2020  guous(src0));.  
-00072080: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00072090: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-000720a0: 2873 7263 3129 293b 0a20 2020 2047 474d  (src1));.    GGM
-000720b0: 4c5f 4153 5345 5254 2867 676d 6c5f 6973  L_ASSERT(ggml_is
-000720c0: 5f73 6361 6c61 7228 6473 7429 293b 0a20  _scalar(dst));. 
-000720d0: 2020 2047 474d 4c5f 4153 5345 5254 2867     GGML_ASSERT(g
-000720e0: 676d 6c5f 6172 655f 7361 6d65 5f73 6861  gml_are_same_sha
-000720f0: 7065 2873 7263 302c 2073 7263 3129 293b  pe(src0, src1));
-00072100: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-00072110: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-00072120: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00072130: 206e 7468 203d 2070 6172 616d 732d 3e6e   nth = params->n
-00072140: 7468 3b0a 0a20 2020 2066 6c6f 6174 202a  th;..    float *
-00072150: 2073 756d 7320 3d20 2866 6c6f 6174 202a   sums = (float *
-00072160: 2920 7061 7261 6d73 2d3e 7764 6174 613b  ) params->wdata;
-00072170: 0a0a 2020 2020 2f2f 2054 4f44 4f3a 2068  ..    // TODO: h
-00072180: 616e 646c 6520 7472 616e 7370 6f73 6564  andle transposed
-00072190: 2f70 6572 6d75 7465 6420 6d61 7472 6963  /permuted matric
-000721a0: 6573 0a20 2020 2063 6f6e 7374 2069 6e74  es.    const int
-000721b0: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
-000721c0: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-000721d0: 206e 7220 3d20 6767 6d6c 5f6e 726f 7773   nr = ggml_nrows
-000721e0: 2873 7263 3029 3b0a 0a20 2020 2069 6620  (src0);..    if 
-000721f0: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00072200: 2047 474d 4c5f 5441 534b 5f49 4e49 5429   GGML_TASK_INIT)
-00072210: 207b 0a20 2020 2020 2020 2069 6620 2869   {.        if (i
-00072220: 7468 203d 3d20 3029 207b 0a20 2020 2020  th == 0) {.     
-00072230: 2020 2020 2020 206d 656d 7365 7428 7375         memset(su
-00072240: 6d73 2c20 302c 2073 697a 656f 6628 666c  ms, 0, sizeof(fl
-00072250: 6f61 7429 202a 2028 6e74 6820 2b20 6e74  oat) * (nth + nt
-00072260: 6820 2a20 6e63 2929 3b0a 2020 2020 2020  h * nc));.      
-00072270: 2020 7d0a 2020 2020 2020 2020 7265 7475    }.        retu
-00072280: 726e 3b0a 2020 2020 7d0a 0a20 2020 2069  rn;.    }..    i
-00072290: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
-000722a0: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-000722b0: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-000722c0: 2069 6620 2869 7468 203d 3d20 3029 207b   if (ith == 0) {
-000722d0: 0a20 2020 2020 2020 2020 2020 2066 6c6f  .            flo
-000722e0: 6174 202a 2064 7020 3d20 2866 6c6f 6174  at * dp = (float
-000722f0: 202a 2920 6473 742d 3e64 6174 613b 0a20   *) dst->data;. 
-00072300: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00072310: 7665 635f 7375 6d5f 6633 3228 6e74 682c  vec_sum_f32(nth,
-00072320: 2064 702c 2073 756d 7329 3b0a 2020 2020   dp, sums);.    
-00072330: 2020 2020 2020 2020 6470 5b30 5d20 2a3d          dp[0] *=
-00072340: 202d 312e 3066 3b0a 2020 2020 2020 2020   -1.0f;.        
-00072350: 7d0a 2020 2020 2020 2020 7265 7475 726e  }.        return
-00072360: 3b0a 2020 2020 7d0a 0a20 2020 2063 6f6e  ;.    }..    con
-00072370: 7374 2064 6f75 626c 6520 6570 7320 3d20  st double eps = 
-00072380: 3165 2d39 3b0a 0a20 2020 202f 2f20 726f  1e-9;..    // ro
-00072390: 7773 2070 6572 2074 6872 6561 640a 2020  ws per thread.  
-000723a0: 2020 636f 6e73 7420 696e 7420 6472 203d    const int dr =
-000723b0: 2028 6e72 202b 206e 7468 202d 2031 292f   (nr + nth - 1)/
-000723c0: 6e74 683b 0a0a 2020 2020 2f2f 2072 6f77  nth;..    // row
-000723d0: 2072 616e 6765 2066 6f72 2074 6869 7320   range for this 
-000723e0: 7468 7265 6164 0a20 2020 2063 6f6e 7374  thread.    const
-000723f0: 2069 6e74 2069 7230 203d 2064 722a 6974   int ir0 = dr*it
-00072400: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00072410: 2069 7231 203d 204d 494e 2869 7230 202b   ir1 = MIN(ir0 +
-00072420: 2064 722c 206e 7229 3b0a 0a20 2020 2066   dr, nr);..    f
-00072430: 6f72 2028 696e 7420 6931 203d 2069 7230  or (int i1 = ir0
-00072440: 3b20 6931 203c 2069 7231 3b20 6931 2b2b  ; i1 < ir1; i1++
-00072450: 2920 7b0a 2020 2020 2020 2020 666c 6f61  ) {.        floa
-00072460: 7420 2a20 7330 203d 2028 666c 6f61 7420  t * s0 = (float 
-00072470: 2a29 2828 6368 6172 202a 2920 7372 6330  *)((char *) src0
-00072480: 2d3e 6461 7461 202b 2069 312a 7372 6330  ->data + i1*src0
-00072490: 2d3e 6e62 5b31 5d29 3b0a 2020 2020 2020  ->nb[1]);.      
-000724a0: 2020 666c 6f61 7420 2a20 7331 203d 2028    float * s1 = (
-000724b0: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-000724c0: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
-000724d0: 312a 7372 6331 2d3e 6e62 5b31 5d29 3b0a  1*src1->nb[1]);.
-000724e0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-000724f0: 7374 203d 2028 666c 6f61 7420 2a29 2070  st = (float *) p
-00072500: 6172 616d 732d 3e77 6461 7461 202b 206e  arams->wdata + n
-00072510: 7468 202b 2069 7468 2a6e 633b 0a0a 2369  th + ith*nc;..#i
-00072520: 666e 6465 6620 4e44 4542 5547 0a20 2020  fndef NDEBUG.   
-00072530: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-00072540: 3d20 303b 2069 203c 206e 633b 202b 2b69  = 0; i < nc; ++i
-00072550: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00072560: 2f2f 7072 696e 7466 2822 705b 2564 5d20  //printf("p[%d] 
-00072570: 3d20 2566 5c6e 222c 2069 2c20 705b 695d  = %f\n", i, p[i]
-00072580: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
-00072590: 7373 6572 7428 2169 736e 616e 2873 305b  ssert(!isnan(s0[
-000725a0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
-000725b0: 2020 6173 7365 7274 2821 6973 6e61 6e28    assert(!isnan(
-000725c0: 7331 5b69 5d29 293b 0a20 2020 2020 2020  s1[i]));.       
-000725d0: 207d 0a23 656e 6469 660a 2020 2020 2020   }.#endif.      
-000725e0: 2020 2f2f 2073 6f66 745f 6d61 780a 2020    // soft_max.  
-000725f0: 2020 2020 2020 6767 6d6c 5f66 6c6f 6174        ggml_float
-00072600: 2073 756d 203d 2030 2e30 3b0a 2020 2020   sum = 0.0;.    
-00072610: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00072620: 2020 666c 6f61 7420 6d61 7820 3d20 2d49    float max = -I
-00072630: 4e46 494e 4954 593b 0a20 2020 2020 2020  NFINITY;.       
-00072640: 2020 2020 2067 676d 6c5f 7665 635f 6d61       ggml_vec_ma
-00072650: 785f 6633 3228 6e63 2c20 266d 6178 2c20  x_f32(nc, &max, 
-00072660: 7330 293b 0a0a 2020 2020 2020 2020 2020  s0);..          
-00072670: 2020 7569 6e74 3136 5f74 2073 6376 743b    uint16_t scvt;
-00072680: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00072690: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-000726a0: 206e 633b 2069 2b2b 2920 7b0a 2020 2020   nc; i++) {.    
-000726b0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000726c0: 7330 5b69 5d20 3d3d 202d 494e 4649 4e49  s0[i] == -INFINI
-000726d0: 5459 2920 7b0a 2020 2020 2020 2020 2020  TY) {.          
-000726e0: 2020 2020 2020 2020 2020 7374 5b69 5d20            st[i] 
-000726f0: 3d20 302e 3066 3b0a 2020 2020 2020 2020  = 0.0f;.        
-00072700: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
-00072710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00072720: 2020 2020 202f 2f20 636f 6e73 7420 666c       // const fl
-00072730: 6f61 7420 7661 6c20 3d20 2873 305b 695d  oat val = (s0[i]
-00072740: 203d 3d20 2d49 4e46 494e 4954 5929 203f   == -INFINITY) ?
-00072750: 2030 2e30 203a 2065 7870 2873 305b 695d   0.0 : exp(s0[i]
-00072760: 202d 206d 6178 293b 0a20 2020 2020 2020   - max);.       
-00072770: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00072780: 6c5f 6670 3136 5f74 2073 203d 2047 474d  l_fp16_t s = GGM
-00072790: 4c5f 4650 3332 5f54 4f5f 4650 3136 2873  L_FP32_TO_FP16(s
-000727a0: 305b 695d 202d 206d 6178 293b 0a20 2020  0[i] - max);.   
-000727b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000727c0: 206d 656d 6370 7928 2673 6376 742c 2026   memcpy(&scvt, &
-000727d0: 732c 2073 697a 656f 6628 7363 7674 2929  s, sizeof(scvt))
-000727e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000727f0: 2020 2020 2020 636f 6e73 7420 666c 6f61        const floa
-00072800: 7420 7661 6c20 3d20 4747 4d4c 5f46 5031  t val = GGML_FP1
-00072810: 365f 544f 5f46 5033 3228 7461 626c 655f  6_TO_FP32(table_
-00072820: 6578 705f 6631 365b 7363 7674 5d29 3b0a  exp_f16[scvt]);.
-00072830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072840: 2020 2020 7375 6d20 2b3d 2028 6767 6d6c      sum += (ggml
-00072850: 5f66 6c6f 6174 2976 616c 3b0a 2020 2020  _float)val;.    
-00072860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00072870: 7374 5b69 5d20 3d20 7661 6c3b 0a20 2020  st[i] = val;.   
-00072880: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00072890: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-000728a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000728b0: 2873 756d 203e 2030 2e30 293b 0a20 2020  (sum > 0.0);.   
-000728c0: 2020 2020 2020 2020 202f 2f20 7375 6d20           // sum 
-000728d0: 3d20 312e 302f 7375 6d3b 0a20 2020 2020  = 1.0/sum;.     
-000728e0: 2020 207d 0a20 2020 2020 2020 202f 2f20     }.        // 
-000728f0: 6176 6f69 6420 6c6f 6728 3029 2062 7920  avoid log(0) by 
-00072900: 7265 7363 616c 696e 6720 6672 6f6d 205b  rescaling from [
-00072910: 302e 2e31 5d20 746f 205b 6570 732e 2e31  0..1] to [eps..1
-00072920: 5d0a 2020 2020 2020 2020 7375 6d20 3d20  ].        sum = 
-00072930: 2831 2e30 202d 2065 7073 2920 2f20 7375  (1.0 - eps) / su
-00072940: 6d3b 0a20 2020 2020 2020 2067 676d 6c5f  m;.        ggml_
-00072950: 7665 635f 7363 616c 655f 6633 3228 6e63  vec_scale_f32(nc
-00072960: 2c20 7374 2c20 7375 6d29 3b0a 2020 2020  , st, sum);.    
-00072970: 2020 2020 6767 6d6c 5f76 6563 5f61 6464      ggml_vec_add
-00072980: 315f 6633 3228 6e63 2c20 7374 2c20 7374  1_f32(nc, st, st
-00072990: 2c20 6570 7329 3b0a 2020 2020 2020 2020  , eps);.        
-000729a0: 6767 6d6c 5f76 6563 5f6c 6f67 5f66 3332  ggml_vec_log_f32
-000729b0: 286e 632c 2073 742c 2073 7429 3b0a 2020  (nc, st, st);.  
-000729c0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
-000729d0: 756c 5f66 3332 286e 632c 2073 742c 2073  ul_f32(nc, st, s
-000729e0: 742c 2073 3129 3b0a 0a20 2020 2020 2020  t, s1);..       
-000729f0: 2067 676d 6c5f 7665 635f 7375 6d5f 6633   ggml_vec_sum_f3
-00072a00: 3228 6e63 2c20 7375 6d73 202b 2069 7468  2(nc, sums + ith
-00072a10: 2c20 7374 293b 0a0a 2369 666e 6465 6620  , st);..#ifndef 
-00072a20: 4e44 4542 5547 0a20 2020 2020 2020 2066  NDEBUG.        f
-00072a30: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00072a40: 203c 206e 633b 202b 2b69 2920 7b0a 2020   < nc; ++i) {.  
-00072a50: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00072a60: 2821 6973 6e61 6e28 7374 5b69 5d29 293b  (!isnan(st[i]));
-00072a70: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00072a80: 6572 7428 2169 7369 6e66 2873 745b 695d  ert(!isinf(st[i]
-00072a90: 2929 3b0a 2020 2020 2020 2020 7d0a 2365  ));.        }.#e
-00072aa0: 6e64 6966 0a20 2020 207d 0a0a 7d0a 0a73  ndif.    }..}..s
-00072ab0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
-00072ac0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00072ad0: 6372 6f73 735f 656e 7472 6f70 795f 6c6f  cross_entropy_lo
-00072ae0: 7373 280a 2020 2020 2020 2020 636f 6e73  ss(.        cons
-00072af0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
-00072b00: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00072b10: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
-00072b20: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-00072b30: 5f74 656e 736f 7220 2a20 7372 6330 2c0a  _tensor * src0,.
-00072b40: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00072b50: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00072b60: 202a 2073 7263 312c 0a20 2020 2020 2020   * src1,.       
-00072b70: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00072b80: 736f 7220 2a20 6473 7429 207b 0a20 2020  sor * dst) {.   
-00072b90: 2073 7769 7463 6820 2873 7263 302d 3e74   switch (src0->t
-00072ba0: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
-00072bb0: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
-00072bc0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
-00072bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00072be0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00072bf0: 7277 6172 645f 6372 6f73 735f 656e 7472  rward_cross_entr
-00072c00: 6f70 795f 6c6f 7373 5f66 3332 2870 6172  opy_loss_f32(par
-00072c10: 616d 732c 2073 7263 302c 2073 7263 312c  ams, src0, src1,
-00072c20: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00072c30: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00072c40: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-00072c50: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00072c60: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-00072c70: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-00072c80: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00072c90: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
-00072ca0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00072cb0: 7761 7264 5f63 726f 7373 5f65 6e74 726f  ward_cross_entro
-00072cc0: 7079 5f6c 6f73 735f 6261 636b 0a0a 7374  py_loss_back..st
-00072cd0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
-00072ce0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-00072cf0: 726f 7373 5f65 6e74 726f 7079 5f6c 6f73  ross_entropy_los
-00072d00: 735f 6261 636b 5f66 3332 280a 2020 2020  s_back_f32(.    
-00072d10: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00072d20: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
-00072d30: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
-00072d40: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
-00072d50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-00072d60: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
-00072d70: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00072d80: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
-00072d90: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
-00072da0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00072db0: 7220 2a20 6f70 7430 2c0a 2020 2020 2020  r * opt0,.      
-00072dc0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-00072dd0: 6e73 6f72 202a 2064 7374 2920 7b0a 2020  nsor * dst) {.  
-00072de0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00072df0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-00072e00: 2864 7374 2929 3b0a 2020 2020 4747 4d4c  (dst));.    GGML
-00072e10: 5f41 5353 4552 5428 6767 6d6c 5f69 735f  _ASSERT(ggml_is_
-00072e20: 636f 6e74 6967 756f 7573 2873 7263 3029  contiguous(src0)
-00072e30: 293b 0a20 2020 2047 474d 4c5f 4153 5345  );.    GGML_ASSE
-00072e40: 5254 2867 676d 6c5f 6973 5f63 6f6e 7469  RT(ggml_is_conti
-00072e50: 6775 6f75 7328 7372 6331 2929 3b0a 2020  guous(src1));.  
-00072e60: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
-00072e70: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
-00072e80: 286f 7074 3029 293b 0a20 2020 2047 474d  (opt0));.    GGM
-00072e90: 4c5f 4153 5345 5254 2867 676d 6c5f 6172  L_ASSERT(ggml_ar
-00072ea0: 655f 7361 6d65 5f73 6861 7065 2873 7263  e_same_shape(src
-00072eb0: 302c 2073 7263 3129 2026 2620 6767 6d6c  0, src1) && ggml
-00072ec0: 5f61 7265 5f73 616d 655f 7368 6170 6528  _are_same_shape(
-00072ed0: 7372 6330 2c20 6473 7429 293b 0a0a 2020  src0, dst));..  
-00072ee0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-00072ef0: 6974 6820 3d20 7061 7261 6d73 2d3e 6974  ith = params->it
-00072f00: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
-00072f10: 3634 5f74 206e 7468 203d 2070 6172 616d  64_t nth = param
-00072f20: 732d 3e6e 7468 3b0a 0a20 2020 2069 6620  s->nth;..    if 
-00072f30: 2870 6172 616d 732d 3e74 7970 6520 3d3d  (params->type ==
-00072f40: 2047 474d 4c5f 5441 534b 5f49 4e49 5420   GGML_TASK_INIT 
-00072f50: 7c7c 2070 6172 616d 732d 3e74 7970 6520  || params->type 
-00072f60: 3d3d 2047 474d 4c5f 5441 534b 5f46 494e  == GGML_TASK_FIN
-00072f70: 414c 495a 4529 207b 0a20 2020 2020 2020  ALIZE) {.       
-00072f80: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
-00072f90: 2020 2020 636f 6e73 7420 666c 6f61 7420      const float 
-00072fa0: 6570 7320 3d20 3165 2d39 663b 0a0a 2020  eps = 1e-9f;..  
-00072fb0: 2020 2f2f 2054 4f44 4f3a 2068 616e 646c    // TODO: handl
-00072fc0: 6520 7472 616e 7370 6f73 6564 2f70 6572  e transposed/per
-00072fd0: 6d75 7465 6420 6d61 7472 6963 6573 0a20  muted matrices. 
-00072fe0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00072ff0: 206e 6320 3d20 7372 6330 2d3e 6e65 5b30   nc = src0->ne[0
-00073000: 5d3b 0a20 2020 2063 6f6e 7374 2069 6e74  ];.    const int
-00073010: 3634 5f74 206e 7220 3d20 6767 6d6c 5f6e  64_t nr = ggml_n
-00073020: 726f 7773 2873 7263 3029 3b0a 0a20 2020  rows(src0);..   
-00073030: 202f 2f20 726f 7773 2070 6572 2074 6872   // rows per thr
-00073040: 6561 640a 2020 2020 636f 6e73 7420 696e  ead.    const in
-00073050: 7436 345f 7420 6472 203d 2028 6e72 202b  t64_t dr = (nr +
-00073060: 206e 7468 202d 2031 292f 6e74 683b 0a0a   nth - 1)/nth;..
-00073070: 2020 2020 2f2f 2072 6f77 2072 616e 6765      // row range
-00073080: 2066 6f72 2074 6869 7320 7468 7265 6164   for this thread
-00073090: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-000730a0: 5f74 2069 7230 203d 2064 722a 6974 683b  _t ir0 = dr*ith;
-000730b0: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
-000730c0: 5f74 2069 7231 203d 204d 494e 2869 7230  _t ir1 = MIN(ir0
-000730d0: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
-000730e0: 2066 6c6f 6174 202a 2064 2020 203d 2028   float * d   = (
-000730f0: 666c 6f61 7420 2a29 206f 7074 302d 3e64  float *) opt0->d
-00073100: 6174 613b 0a0a 2020 2020 666f 7220 2869  ata;..    for (i
-00073110: 6e74 3634 5f74 2069 3120 3d20 6972 303b  nt64_t i1 = ir0;
-00073120: 2069 3120 3c20 6972 313b 2069 312b 2b29   i1 < ir1; i1++)
-00073130: 207b 0a20 2020 2020 2020 2066 6c6f 6174   {.        float
-00073140: 202a 2064 7330 203d 2028 666c 6f61 7420   * ds0 = (float 
-00073150: 2a29 2828 6368 6172 202a 2920 6473 742d  *)((char *) dst-
-00073160: 3e64 6174 6120 202b 2069 312a 6473 742d  >data  + i1*dst-
-00073170: 3e6e 625b 315d 293b 0a20 2020 2020 2020  >nb[1]);.       
-00073180: 2066 6c6f 6174 202a 2073 3020 203d 2028   float * s0  = (
-00073190: 666c 6f61 7420 2a29 2828 6368 6172 202a  float *)((char *
-000731a0: 2920 7372 6330 2d3e 6461 7461 202b 2069  ) src0->data + i
-000731b0: 312a 7372 6330 2d3e 6e62 5b31 5d29 3b0a  1*src0->nb[1]);.
-000731c0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
-000731d0: 7331 2020 3d20 2866 6c6f 6174 202a 2928  s1  = (float *)(
-000731e0: 2863 6861 7220 2a29 2073 7263 312d 3e64  (char *) src1->d
-000731f0: 6174 6120 2b20 6931 2a73 7263 312d 3e6e  ata + i1*src1->n
-00073200: 625b 315d 293b 0a20 2020 2020 2020 2066  b[1]);.        f
-00073210: 6c6f 6174 202a 2073 6d20 203d 2028 666c  loat * sm  = (fl
-00073220: 6f61 7420 2a29 2070 6172 616d 732d 3e77  oat *) params->w
-00073230: 6461 7461 202b 2069 7468 2a6e 633b 0a0a  data + ith*nc;..
-00073240: 2369 666e 6465 6620 4e44 4542 5547 0a20  #ifndef NDEBUG. 
-00073250: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00073260: 6920 3d20 303b 2069 203c 206e 633b 202b  i = 0; i < nc; +
-00073270: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
-00073280: 2020 2f2f 7072 696e 7466 2822 705b 2564    //printf("p[%d
-00073290: 5d20 3d20 2566 5c6e 222c 2069 2c20 705b  ] = %f\n", i, p[
-000732a0: 695d 293b 0a20 2020 2020 2020 2020 2020  i]);.           
-000732b0: 2061 7373 6572 7428 2169 736e 616e 2873   assert(!isnan(s
-000732c0: 305b 695d 2929 3b0a 2020 2020 2020 2020  0[i]));.        
-000732d0: 2020 2020 6173 7365 7274 2821 6973 6e61      assert(!isna
-000732e0: 6e28 7331 5b69 5d29 293b 0a20 2020 2020  n(s1[i]));.     
-000732f0: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
-00073300: 2020 2020 2f2f 2073 7465 7020 6279 2073      // step by s
-00073310: 7465 7020 6578 706c 616e 6174 696f 6e3a  tep explanation:
-00073320: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-00073330: 2020 2020 2020 202f 2f66 6c6f 6174 202a         //float *
-00073340: 2073 756d 7320 3d20 2866 6c6f 6174 202a   sums = (float *
-00073350: 2920 7061 7261 6d73 2d3e 7764 6174 613b  ) params->wdata;
-00073360: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-00073370: 2066 6f72 7761 7264 2070 6173 7320 7769   forward pass wi
-00073380: 7468 2061 6e6e 6f74 6174 6564 2067 7261  th annotated gra
-00073390: 6469 656e 7473 2066 726f 6d20 6261 636b  dients from back
-000733a0: 7761 7264 2070 6173 730a 2020 2020 2020  ward pass.      
-000733b0: 2020 2020 2020 2f2f 2028 6275 696c 7420        // (built 
-000733c0: 6279 2067 6f69 6e67 2069 6e20 7265 7665  by going in reve
-000733d0: 7273 6520 6f70 6572 6174 696f 6e20 6f72  rse operation or
-000733e0: 6465 722c 2061 6464 696e 6720 746f 2067  der, adding to g
-000733f0: 7261 6469 656e 7473 206f 6620 6375 7272  radients of curr
-00073400: 656e 7420 6f70 6572 6174 696f 6e20 6172  ent operation ar
-00073410: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00073420: 2f2f 2073 7430 203d 2065 7870 2873 302d  // st0 = exp(s0-
-00073430: 6d61 7828 7330 2929 2020 2020 2020 2020  max(s0))        
-00073440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073460: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00073470: 7261 645b 7374 305d 203d 2067 7261 645b  rad[st0] = grad[
-00073480: 7374 315d 2a28 312e 3020 2d20 6570 7329  st1]*(1.0 - eps)
-00073490: 2f73 756d 0a20 2020 2020 2020 2020 2020  /sum.           
+0006ffb0: 2020 2020 2020 2020 2020 2020 2828 666c              ((fl
+0006ffc0: 6f61 7420 2a29 2064 7374 2d3e 6461 7461  oat *) dst->data
+0006ffd0: 295b 695d 203d 2030 2e30 663b 0a20 2020  )[i] = 0.0f;.   
+0006ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0006fff0: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
+00070000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070010: 2020 2020 2020 2020 2020 2828 666c 6f61            ((floa
+00070020: 7420 2a29 2064 7374 2d3e 6461 7461 295b  t *) dst->data)[
+00070030: 695d 203d 2028 2866 6c6f 6174 202a 2920  i] = ((float *) 
+00070040: 7372 6330 2d3e 6461 7461 295b 6a5d 3b0a  src0->data)[j];.
+00070050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070060: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00070070: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00070080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070090: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+000700a0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+000700b0: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+000700c0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000700d0: 6172 645f 7769 6e5f 7061 7274 280a 2020  ard_win_part(.  
+000700e0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000700f0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00070100: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00070110: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00070120: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00070130: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00070140: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00070150: 676d 6c5f 7465 6e73 6f72 202a 206f 7074  gml_tensor * opt
+00070160: 302c 0a20 2020 2020 2020 2073 7472 7563  0,.        struc
+00070170: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00070180: 6473 7429 207b 0a20 2020 2073 7769 7463  dst) {.    switc
+00070190: 6820 2873 7263 302d 3e74 7970 6529 207b  h (src0->type) {
+000701a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000701b0: 4d4c 5f54 5950 455f 4633 323a 0a20 2020  ML_TYPE_F32:.   
+000701c0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+000701d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000701e0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000701f0: 7769 6e5f 7061 7274 5f66 3332 2870 6172  win_part_f32(par
+00070200: 616d 732c 2073 7263 302c 206f 7074 302c  ams, src0, opt0,
+00070210: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
+00070220: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00070230: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
+00070240: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00070250: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00070260: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
+00070270: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00070280: 616b 3b0a 2020 2020 7d0a 7d0a 0a2f 2f20  ak;.    }.}..// 
+00070290: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000702a0: 7761 7264 5f77 696e 5f75 6e70 6172 740a  ward_win_unpart.
+000702b0: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+000702c0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000702d0: 645f 7769 6e5f 756e 7061 7274 5f66 3332  d_win_unpart_f32
+000702e0: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+000702f0: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00070300: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00070310: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+00070320: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00070330: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+00070340: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00070350: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00070360: 206f 7074 302c 0a20 2020 2020 2020 2073   opt0,.        s
+00070370: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00070380: 7220 2a20 6473 7429 207b 0a20 2020 2069  r * dst) {.    i
+00070390: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+000703a0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+000703b0: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
+000703c0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+000703d0: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+000703e0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+000703f0: 0a0a 2020 2020 4747 4d4c 5f54 454e 534f  ..    GGML_TENSO
+00070400: 525f 4c4f 4341 4c53 2869 6e74 3634 5f74  R_LOCALS(int64_t
+00070410: 2c20 6e65 302c 2073 7263 302c 206e 6529  , ne0, src0, ne)
+00070420: 3b0a 2020 2020 4747 4d4c 5f54 454e 534f  ;.    GGML_TENSO
+00070430: 525f 4c4f 4341 4c53 2869 6e74 3634 5f74  R_LOCALS(int64_t
+00070440: 2c20 6e65 2c20 2064 7374 2c20 206e 6529  , ne,  dst,  ne)
+00070450: 3b0a 0a20 2020 2063 6f6e 7374 2069 6e74  ;..    const int
+00070460: 3332 5f74 2077 203d 2028 2863 6f6e 7374  32_t w = ((const
+00070470: 2069 6e74 3332 5f74 202a 2928 6f70 7430   int32_t *)(opt0
+00070480: 2d3e 6461 7461 2929 5b30 5d3b 0a0a 2020  ->data))[0];..  
+00070490: 2020 2f2f 2070 6164 6469 6e67 0a20 2020    // padding.   
+000704a0: 2063 6f6e 7374 2069 6e74 2070 7820 3d20   const int px = 
+000704b0: 2877 202d 206e 6531 2577 2925 773b 0a20  (w - ne1%w)%w;. 
+000704c0: 2020 202f 2f63 6f6e 7374 2069 6e74 2070     //const int p
+000704d0: 7920 3d20 2877 202d 206e 6532 2577 2925  y = (w - ne2%w)%
+000704e0: 773b 0a0a 2020 2020 636f 6e73 7420 696e  w;..    const in
+000704f0: 7420 6e70 7820 3d20 2870 7820 2b20 6e65  t npx = (px + ne
+00070500: 3129 2f77 3b0a 2020 2020 2f2f 636f 6e73  1)/w;.    //cons
+00070510: 7420 696e 7420 6e70 7920 3d20 2870 7920  t int npy = (py 
+00070520: 2b20 6e65 3229 2f77 3b0a 0a20 2020 2061  + ne2)/w;..    a
+00070530: 7373 6572 7428 6e65 3020 3d3d 206e 6530  ssert(ne0 == ne0
+00070540: 3029 3b0a 0a20 2020 202f 2f20 544f 444f  0);..    // TODO
+00070550: 3a20 6f70 7469 6d69 7a65 202f 206d 756c  : optimize / mul
+00070560: 7469 2d74 6872 6561 640a 2020 2020 666f  ti-thread.    fo
+00070570: 7220 2869 6e74 3634 5f74 2069 3220 3d20  r (int64_t i2 = 
+00070580: 303b 2069 3220 3c20 6e65 323b 202b 2b69  0; i2 < ne2; ++i
+00070590: 3229 207b 0a20 2020 2020 2020 2066 6f72  2) {.        for
+000705a0: 2028 696e 7436 345f 7420 6931 203d 2030   (int64_t i1 = 0
+000705b0: 3b20 6931 203c 206e 6531 3b20 2b2b 6931  ; i1 < ne1; ++i1
+000705c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000705d0: 666f 7220 2869 6e74 3634 5f74 2069 3020  for (int64_t i0 
+000705e0: 3d20 303b 2069 3020 3c20 6e65 303b 202b  = 0; i0 < ne0; +
+000705f0: 2b69 3029 207b 0a20 2020 2020 2020 2020  +i0) {.         
+00070600: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00070610: 2069 7032 203d 2069 322f 773b 0a20 2020   ip2 = i2/w;.   
+00070620: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00070630: 7374 2069 6e74 2069 7031 203d 2069 312f  st int ip1 = i1/
+00070640: 773b 0a0a 2020 2020 2020 2020 2020 2020  w;..            
+00070650: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00070660: 7420 6930 3220 3d20 6932 2577 3b0a 2020  t i02 = i2%w;.  
+00070670: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00070680: 6e73 7420 696e 7436 345f 7420 6930 3120  nst int64_t i01 
+00070690: 3d20 6931 2577 3b0a 2020 2020 2020 2020  = i1%w;.        
+000706a0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+000706b0: 7436 345f 7420 6930 3020 3d20 6930 3b0a  t64_t i00 = i0;.
+000706c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000706d0: 2063 6f6e 7374 2069 6e74 3634 5f74 2069   const int64_t i
+000706e0: 203d 2028 6970 322a 6e70 7820 2b20 6970   = (ip2*npx + ip
+000706f0: 3129 2a6e 6530 322a 6e65 3031 2a6e 6530  1)*ne02*ne01*ne0
+00070700: 3020 2b20 6930 322a 6e65 3031 2a6e 6530  0 + i02*ne01*ne0
+00070710: 3020 2b20 6930 312a 6e65 3030 202b 2069  0 + i01*ne00 + i
+00070720: 3030 3b0a 2020 2020 2020 2020 2020 2020  00;.            
+00070730: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00070740: 7420 6a20 3d20 2020 2020 2020 2020 2020  t j =           
+00070750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00070760: 2020 2020 2020 2069 322a 6e65 312a 6e65         i2*ne1*ne
+00070770: 3020 2020 202b 2069 312a 6e65 3020 2020  0    + i1*ne0   
+00070780: 2b20 6930 3b0a 0a20 2020 2020 2020 2020  + i0;..         
+00070790: 2020 2020 2020 2028 2866 6c6f 6174 202a         ((float *
+000707a0: 2920 6473 742d 3e64 6174 6129 5b6a 5d20  ) dst->data)[j] 
+000707b0: 3d20 2828 666c 6f61 7420 2a29 2073 7263  = ((float *) src
+000707c0: 302d 3e64 6174 6129 5b69 5d3b 0a20 2020  0->data)[i];.   
+000707d0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000707e0: 2020 207d 0a20 2020 207d 0a7d 0a0a 7374     }.    }.}..st
+000707f0: 6174 6963 2076 6f69 6420 6767 6d6c 5f63  atic void ggml_c
+00070800: 6f6d 7075 7465 5f66 6f72 7761 7264 5f77  ompute_forward_w
+00070810: 696e 5f75 6e70 6172 7428 0a20 2020 2020  in_unpart(.     
+00070820: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00070830: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00070840: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00070850: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00070860: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00070870: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00070880: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00070890: 5f74 656e 736f 7220 2a20 6f70 7430 2c0a  _tensor * opt0,.
+000708a0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+000708b0: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+000708c0: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+000708d0: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+000708e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000708f0: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00070900: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00070910: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00070920: 7075 7465 5f66 6f72 7761 7264 5f77 696e  pute_forward_win
+00070930: 5f75 6e70 6172 745f 6633 3228 7061 7261  _unpart_f32(para
+00070940: 6d73 2c20 7372 6330 2c20 6f70 7430 2c20  ms, src0, opt0, 
+00070950: 6473 7429 3b0a 2020 2020 2020 2020 2020  dst);.          
+00070960: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00070970: 2020 2064 6566 6175 6c74 3a0a 2020 2020     default:.    
+00070980: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00070990: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+000709a0: 5353 4552 5428 6661 6c73 6529 3b0a 2020  SSERT(false);.  
+000709b0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000709c0: 6b3b 0a20 2020 207d 0a7d 0a0a 2f2f 2067  k;.    }.}..// g
+000709d0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000709e0: 6172 645f 6d61 705f 756e 6172 790a 0a73  ard_map_unary..s
+000709f0: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00070a00: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00070a10: 6d61 705f 756e 6172 795f 6633 3228 0a20  map_unary_f32(. 
+00070a20: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00070a30: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00070a40: 5f70 6172 616d 7320 2a20 7061 7261 6d73  _params * params
+00070a50: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00070a60: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00070a70: 6f72 202a 2073 7263 302c 0a20 2020 2020  or * src0,.     
+00070a80: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00070a90: 656e 736f 7220 2a20 6473 742c 0a20 2020  ensor * dst,.   
+00070aa0: 2020 2020 2063 6f6e 7374 2067 676d 6c5f       const ggml_
+00070ab0: 756e 6172 795f 6f70 5f66 3332 5f74 2066  unary_op_f32_t f
+00070ac0: 756e 2920 7b0a 2020 2020 4747 4d4c 5f41  un) {.    GGML_A
+00070ad0: 5353 4552 5428 6767 6d6c 5f61 7265 5f73  SSERT(ggml_are_s
+00070ae0: 616d 655f 7368 6170 6528 7372 6330 2c20  ame_shape(src0, 
+00070af0: 6473 7429 293b 0a0a 2020 2020 6966 2028  dst));..    if (
+00070b00: 7061 7261 6d73 2d3e 7479 7065 203d 3d20  params->type == 
+00070b10: 4747 4d4c 5f54 4153 4b5f 494e 4954 207c  GGML_TASK_INIT |
+00070b20: 7c20 7061 7261 6d73 2d3e 7479 7065 203d  | params->type =
+00070b30: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
+00070b40: 4c49 5a45 2920 7b0a 2020 2020 2020 2020  LIZE) {.        
+00070b50: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00070b60: 2020 2063 6f6e 7374 2069 6e74 206e 2020     const int n  
+00070b70: 3d20 6767 6d6c 5f6e 726f 7773 2873 7263  = ggml_nrows(src
+00070b80: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+00070b90: 7420 6e63 203d 2073 7263 302d 3e6e 655b  t nc = src0->ne[
+00070ba0: 305d 3b0a 0a20 2020 2061 7373 6572 7428  0];..    assert(
+00070bb0: 2064 7374 2d3e 6e62 5b30 5d20 3d3d 2073   dst->nb[0] == s
+00070bc0: 697a 656f 6628 666c 6f61 7429 293b 0a20  izeof(float));. 
+00070bd0: 2020 2061 7373 6572 7428 7372 6330 2d3e     assert(src0->
+00070be0: 6e62 5b30 5d20 3d3d 2073 697a 656f 6628  nb[0] == sizeof(
+00070bf0: 666c 6f61 7429 293b 0a0a 2020 2020 666f  float));..    fo
+00070c00: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00070c10: 3c20 6e3b 2069 2b2b 2920 7b0a 2020 2020  < n; i++) {.    
+00070c20: 2020 2020 6675 6e28 6e63 2c0a 2020 2020      fun(nc,.    
+00070c30: 2020 2020 2020 2020 2020 2020 2866 6c6f              (flo
+00070c40: 6174 202a 2920 2828 6368 6172 202a 2920  at *) ((char *) 
+00070c50: 6473 742d 3e64 6174 6120 202b 2069 2a28  dst->data  + i*(
+00070c60: 2064 7374 2d3e 6e62 5b31 5d29 292c 0a20   dst->nb[1])),. 
+00070c70: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00070c80: 666c 6f61 7420 2a29 2028 2863 6861 7220  float *) ((char 
+00070c90: 2a29 2073 7263 302d 3e64 6174 6120 2b20  *) src0->data + 
+00070ca0: 692a 2873 7263 302d 3e6e 625b 315d 2929  i*(src0->nb[1]))
+00070cb0: 293b 0a20 2020 207d 0a7d 0a0a 0a73 7461  );.    }.}...sta
+00070cc0: 7469 6320 766f 6964 2067 676d 6c5f 636f  tic void ggml_co
+00070cd0: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
+00070ce0: 705f 756e 6172 7928 0a20 2020 2020 2020  p_unary(.       
+00070cf0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00070d00: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+00070d10: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+00070d20: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00070d30: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+00070d40: 7263 302c 0a20 2020 2020 2020 2073 7472  rc0,.        str
+00070d50: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00070d60: 2a20 6473 742c 0a20 2020 2020 2020 2063  * dst,.        c
+00070d70: 6f6e 7374 2067 676d 6c5f 756e 6172 795f  onst ggml_unary_
+00070d80: 6f70 5f66 3332 5f74 2066 756e 2920 7b0a  op_f32_t fun) {.
+00070d90: 2020 2020 7377 6974 6368 2028 7372 6330      switch (src0
+00070da0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+00070db0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00070dc0: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
+00070dd0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00070de0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00070df0: 5f66 6f72 7761 7264 5f6d 6170 5f75 6e61  _forward_map_una
+00070e00: 7279 5f66 3332 2870 6172 616d 732c 2073  ry_f32(params, s
+00070e10: 7263 302c 2064 7374 2c20 6675 6e29 3b0a  rc0, dst, fun);.
+00070e20: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00070e30: 6561 6b3b 0a20 2020 2020 2020 2064 6566  eak;.        def
+00070e40: 6175 6c74 3a0a 2020 2020 2020 2020 2020  ault:.          
+00070e50: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00070e60: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00070e70: 6661 6c73 6529 3b0a 2020 2020 2020 2020  false);.        
+00070e80: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00070e90: 207d 0a7d 0a0a 2f2f 2067 676d 6c5f 636f   }.}..// ggml_co
+00070ea0: 6d70 7574 655f 666f 7277 6172 645f 6d61  mpute_forward_ma
+00070eb0: 705f 6269 6e61 7279 0a0a 7374 6174 6963  p_binary..static
+00070ec0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00070ed0: 7465 5f66 6f72 7761 7264 5f6d 6170 5f62  te_forward_map_b
+00070ee0: 696e 6172 795f 6633 3228 0a20 2020 2020  inary_f32(.     
+00070ef0: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00070f00: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00070f10: 616d 7320 2a20 7061 7261 6d73 2c0a 2020  ams * params,.  
+00070f20: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00070f30: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00070f40: 2073 7263 302c 0a20 2020 2020 2020 2063   src0,.        c
+00070f50: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00070f60: 5f74 656e 736f 7220 2a20 7372 6331 2c0a  _tensor * src1,.
+00070f70: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00070f80: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00070f90: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00070fa0: 6767 6d6c 5f62 696e 6172 795f 6f70 5f66  ggml_binary_op_f
+00070fb0: 3332 5f74 2066 756e 2920 7b0a 2020 2020  32_t fun) {.    
+00070fc0: 6173 7365 7274 2870 6172 616d 732d 3e69  assert(params->i
+00070fd0: 7468 203d 3d20 3029 3b0a 2020 2020 6173  th == 0);.    as
+00070fe0: 7365 7274 2867 676d 6c5f 6172 655f 7361  sert(ggml_are_sa
+00070ff0: 6d65 5f73 6861 7065 2873 7263 302c 2073  me_shape(src0, s
+00071000: 7263 3129 2026 2620 6767 6d6c 5f61 7265  rc1) && ggml_are
+00071010: 5f73 616d 655f 7368 6170 6528 7372 6330  _same_shape(src0
+00071020: 2c20 6473 7429 293b 0a0a 2020 2020 6966  , dst));..    if
+00071030: 2028 7061 7261 6d73 2d3e 7479 7065 203d   (params->type =
+00071040: 3d20 4747 4d4c 5f54 4153 4b5f 494e 4954  = GGML_TASK_INIT
+00071050: 207c 7c20 7061 7261 6d73 2d3e 7479 7065   || params->type
+00071060: 203d 3d20 4747 4d4c 5f54 4153 4b5f 4649   == GGML_TASK_FI
+00071070: 4e41 4c49 5a45 2920 7b0a 2020 2020 2020  NALIZE) {.      
+00071080: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
+00071090: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000710a0: 2020 3d20 6767 6d6c 5f6e 726f 7773 2873    = ggml_nrows(s
+000710b0: 7263 3029 3b0a 2020 2020 636f 6e73 7420  rc0);.    const 
+000710c0: 696e 7420 6e63 203d 2073 7263 302d 3e6e  int nc = src0->n
+000710d0: 655b 305d 3b0a 0a20 2020 2061 7373 6572  e[0];..    asser
+000710e0: 7428 2064 7374 2d3e 6e62 5b30 5d20 3d3d  t( dst->nb[0] ==
+000710f0: 2073 697a 656f 6628 666c 6f61 7429 293b   sizeof(float));
+00071100: 0a20 2020 2061 7373 6572 7428 7372 6330  .    assert(src0
+00071110: 2d3e 6e62 5b30 5d20 3d3d 2073 697a 656f  ->nb[0] == sizeo
+00071120: 6628 666c 6f61 7429 293b 0a20 2020 2061  f(float));.    a
+00071130: 7373 6572 7428 7372 6331 2d3e 6e62 5b30  ssert(src1->nb[0
+00071140: 5d20 3d3d 2073 697a 656f 6628 666c 6f61  ] == sizeof(floa
+00071150: 7429 293b 0a0a 2020 2020 666f 7220 2869  t));..    for (i
+00071160: 6e74 2069 203d 2030 3b20 6920 3c20 6e3b  nt i = 0; i < n;
+00071170: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00071180: 6675 6e28 6e63 2c0a 2020 2020 2020 2020  fun(nc,.        
+00071190: 2020 2020 2020 2020 2866 6c6f 6174 202a          (float *
+000711a0: 2920 2828 6368 6172 202a 2920 6473 742d  ) ((char *) dst-
+000711b0: 3e64 6174 6120 202b 2069 2a28 2064 7374  >data  + i*( dst
+000711c0: 2d3e 6e62 5b31 5d29 292c 0a20 2020 2020  ->nb[1])),.     
+000711d0: 2020 2020 2020 2020 2020 2028 666c 6f61             (floa
+000711e0: 7420 2a29 2028 2863 6861 7220 2a29 2073  t *) ((char *) s
+000711f0: 7263 302d 3e64 6174 6120 2b20 692a 2873  rc0->data + i*(s
+00071200: 7263 302d 3e6e 625b 315d 2929 2c0a 2020  rc0->nb[1])),.  
+00071210: 2020 2020 2020 2020 2020 2020 2020 2866                (f
+00071220: 6c6f 6174 202a 2920 2828 6368 6172 202a  loat *) ((char *
+00071230: 2920 7372 6331 2d3e 6461 7461 202b 2069  ) src1->data + i
+00071240: 2a28 7372 6331 2d3e 6e62 5b31 5d29 2929  *(src1->nb[1])))
+00071250: 3b0a 2020 2020 7d0a 7d0a 0a0a 7374 6174  ;.    }.}...stat
+00071260: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+00071270: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
+00071280: 5f62 696e 6172 7928 0a20 2020 2020 2020  _binary(.       
+00071290: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+000712a0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
+000712b0: 7320 2a20 7061 7261 6d73 2c0a 2020 2020  s * params,.    
+000712c0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+000712d0: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
+000712e0: 7263 302c 0a20 2020 2020 2020 2063 6f6e  rc0,.        con
+000712f0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00071300: 656e 736f 7220 2a20 7372 6331 2c0a 2020  ensor * src1,.  
+00071310: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00071320: 6c5f 7465 6e73 6f72 202a 2064 7374 2c0a  l_tensor * dst,.
+00071330: 2020 2020 2020 2020 636f 6e73 7420 6767          const gg
+00071340: 6d6c 5f62 696e 6172 795f 6f70 5f66 3332  ml_binary_op_f32
+00071350: 5f74 2066 756e 2920 7b0a 2020 2020 7377  _t fun) {.    sw
+00071360: 6974 6368 2028 7372 6330 2d3e 7479 7065  itch (src0->type
+00071370: 2920 7b0a 2020 2020 2020 2020 6361 7365  ) {.        case
+00071380: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
+00071390: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000713a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000713b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000713c0: 7264 5f6d 6170 5f62 696e 6172 795f 6633  rd_map_binary_f3
+000713d0: 3228 7061 7261 6d73 2c20 7372 6330 2c20  2(params, src0, 
+000713e0: 7372 6331 2c20 6473 742c 2066 756e 293b  src1, dst, fun);
+000713f0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00071400: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
+00071410: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+00071420: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00071430: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00071440: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00071450: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00071460: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
+00071470: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+00071480: 6170 5f63 7573 746f 6d31 0a0a 7374 6174  ap_custom1..stat
+00071490: 6963 2076 6f69 6420 6767 6d6c 5f63 6f6d  ic void ggml_com
+000714a0: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
+000714b0: 5f63 7573 746f 6d31 5f66 3332 280a 2020  _custom1_f32(.  
+000714c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000714d0: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+000714e0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+000714f0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00071500: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00071510: 7220 2a20 612c 0a20 2020 2020 2020 2073  r * a,.        s
+00071520: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00071530: 7220 2a20 6473 742c 0a20 2020 2020 2020  r * dst,.       
+00071540: 2063 6f6e 7374 2067 676d 6c5f 6375 7374   const ggml_cust
+00071550: 6f6d 315f 6f70 5f66 3332 5f74 2066 756e  om1_op_f32_t fun
+00071560: 2920 7b0a 2020 2020 6173 7365 7274 2870  ) {.    assert(p
+00071570: 6172 616d 732d 3e69 7468 203d 3d20 3029  arams->ith == 0)
+00071580: 3b0a 0a20 2020 2069 6620 2870 6172 616d  ;..    if (param
+00071590: 732d 3e74 7970 6520 3d3d 2047 474d 4c5f  s->type == GGML_
+000715a0: 5441 534b 5f49 4e49 5420 7c7c 2070 6172  TASK_INIT || par
+000715b0: 616d 732d 3e74 7970 6520 3d3d 2047 474d  ams->type == GGM
+000715c0: 4c5f 5441 534b 5f46 494e 414c 495a 4529  L_TASK_FINALIZE)
+000715d0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+000715e0: 6e3b 0a20 2020 207d 0a0a 2020 2020 6675  n;.    }..    fu
+000715f0: 6e28 6473 742c 2061 293b 0a7d 0a0a 0a73  n(dst, a);.}...s
+00071600: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00071610: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00071620: 6d61 705f 6375 7374 6f6d 3128 0a20 2020  map_custom1(.   
+00071630: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00071640: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00071650: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00071660: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00071670: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00071680: 202a 2061 2c0a 2020 2020 2020 2020 7374   * a,.        st
+00071690: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+000716a0: 202a 2064 7374 2c0a 2020 2020 2020 2020   * dst,.        
+000716b0: 636f 6e73 7420 6767 6d6c 5f63 7573 746f  const ggml_custo
+000716c0: 6d31 5f6f 705f 6633 325f 7420 6675 6e29  m1_op_f32_t fun)
+000716d0: 207b 0a20 2020 2073 7769 7463 6820 2861   {.    switch (a
+000716e0: 2d3e 7479 7065 2920 7b0a 2020 2020 2020  ->type) {.      
+000716f0: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
+00071700: 5f46 3332 3a0a 2020 2020 2020 2020 2020  _F32:.          
+00071710: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00071720: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00071730: 5f66 6f72 7761 7264 5f6d 6170 5f63 7573  _forward_map_cus
+00071740: 746f 6d31 5f66 3332 2870 6172 616d 732c  tom1_f32(params,
+00071750: 2061 2c20 6473 742c 2066 756e 293b 0a20   a, dst, fun);. 
+00071760: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00071770: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
+00071780: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+00071790: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000717a0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+000717b0: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+000717c0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+000717d0: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
+000717e0: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
+000717f0: 5f63 7573 746f 6d32 0a0a 7374 6174 6963  _custom2..static
+00071800: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00071810: 7465 5f66 6f72 7761 7264 5f6d 6170 5f63  te_forward_map_c
+00071820: 7573 746f 6d32 5f66 3332 280a 2020 2020  ustom2_f32(.    
+00071830: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00071840: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00071850: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00071860: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00071870: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00071880: 2a20 612c 0a20 2020 2020 2020 2063 6f6e  * a,.        con
+00071890: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000718a0: 656e 736f 7220 2a20 622c 0a20 2020 2020  ensor * b,.     
+000718b0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+000718c0: 656e 736f 7220 2a20 6473 742c 0a20 2020  ensor * dst,.   
+000718d0: 2020 2020 2063 6f6e 7374 2067 676d 6c5f       const ggml_
+000718e0: 6375 7374 6f6d 325f 6f70 5f66 3332 5f74  custom2_op_f32_t
+000718f0: 2066 756e 2920 7b0a 2020 2020 6173 7365   fun) {.    asse
+00071900: 7274 2870 6172 616d 732d 3e69 7468 203d  rt(params->ith =
+00071910: 3d20 3029 3b0a 0a20 2020 2069 6620 2870  = 0);..    if (p
+00071920: 6172 616d 732d 3e74 7970 6520 3d3d 2047  arams->type == G
+00071930: 474d 4c5f 5441 534b 5f49 4e49 5420 7c7c  GML_TASK_INIT ||
+00071940: 2070 6172 616d 732d 3e74 7970 6520 3d3d   params->type ==
+00071950: 2047 474d 4c5f 5441 534b 5f46 494e 414c   GGML_TASK_FINAL
+00071960: 495a 4529 207b 0a20 2020 2020 2020 2072  IZE) {.        r
+00071970: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
+00071980: 2020 6675 6e28 6473 742c 2061 2c20 6229    fun(dst, a, b)
+00071990: 3b0a 7d0a 0a0a 7374 6174 6963 2076 6f69  ;.}...static voi
+000719a0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
+000719b0: 6f72 7761 7264 5f6d 6170 5f63 7573 746f  orward_map_custo
+000719c0: 6d32 280a 2020 2020 2020 2020 636f 6e73  m2(.        cons
+000719d0: 7420 7374 7275 6374 2067 676d 6c5f 636f  t struct ggml_co
+000719e0: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
+000719f0: 6172 616d 732c 0a20 2020 2020 2020 2063  arams,.        c
+00071a00: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00071a10: 5f74 656e 736f 7220 2a20 612c 0a20 2020  _tensor * a,.   
+00071a20: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00071a30: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00071a40: 622c 0a20 2020 2020 2020 2073 7472 7563  b,.        struc
+00071a50: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00071a60: 6473 742c 0a20 2020 2020 2020 2063 6f6e  dst,.        con
+00071a70: 7374 2067 676d 6c5f 6375 7374 6f6d 325f  st ggml_custom2_
+00071a80: 6f70 5f66 3332 5f74 2066 756e 2920 7b0a  op_f32_t fun) {.
+00071a90: 2020 2020 7377 6974 6368 2028 612d 3e74      switch (a->t
+00071aa0: 7970 6529 207b 0a20 2020 2020 2020 2063  ype) {.        c
+00071ab0: 6173 6520 4747 4d4c 5f54 5950 455f 4633  ase GGML_TYPE_F3
+00071ac0: 323a 0a20 2020 2020 2020 2020 2020 207b  2:.            {
+00071ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00071ae0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00071af0: 7277 6172 645f 6d61 705f 6375 7374 6f6d  rward_map_custom
+00071b00: 325f 6633 3228 7061 7261 6d73 2c20 612c  2_f32(params, a,
+00071b10: 2062 2c20 6473 742c 2066 756e 293b 0a20   b, dst, fun);. 
+00071b20: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00071b30: 616b 3b0a 2020 2020 2020 2020 6465 6661  ak;.        defa
+00071b40: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
+00071b50: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00071b60: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00071b70: 616c 7365 293b 0a20 2020 2020 2020 2020  alse);.         
+00071b80: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00071b90: 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63 6f6d  }.}..// ggml_com
+00071ba0: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
+00071bb0: 5f63 7573 746f 6d33 0a0a 7374 6174 6963  _custom3..static
+00071bc0: 2076 6f69 6420 6767 6d6c 5f63 6f6d 7075   void ggml_compu
+00071bd0: 7465 5f66 6f72 7761 7264 5f6d 6170 5f63  te_forward_map_c
+00071be0: 7573 746f 6d33 5f66 3332 280a 2020 2020  ustom3_f32(.    
+00071bf0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00071c00: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00071c10: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00071c20: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00071c30: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00071c40: 2a20 612c 0a20 2020 2020 2020 2063 6f6e  * a,.        con
+00071c50: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+00071c60: 656e 736f 7220 2a20 622c 0a20 2020 2020  ensor * b,.     
+00071c70: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00071c80: 6767 6d6c 5f74 656e 736f 7220 2a20 632c  ggml_tensor * c,
+00071c90: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00071ca0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+00071cb0: 742c 0a20 2020 2020 2020 2063 6f6e 7374  t,.        const
+00071cc0: 2067 676d 6c5f 6375 7374 6f6d 335f 6f70   ggml_custom3_op
+00071cd0: 5f66 3332 5f74 2066 756e 2920 7b0a 2020  _f32_t fun) {.  
+00071ce0: 2020 6173 7365 7274 2870 6172 616d 732d    assert(params-
+00071cf0: 3e69 7468 203d 3d20 3029 3b0a 0a20 2020  >ith == 0);..   
+00071d00: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00071d10: 6520 3d3d 2047 474d 4c5f 5441 534b 5f49  e == GGML_TASK_I
+00071d20: 4e49 5420 7c7c 2070 6172 616d 732d 3e74  NIT || params->t
+00071d30: 7970 6520 3d3d 2047 474d 4c5f 5441 534b  ype == GGML_TASK
+00071d40: 5f46 494e 414c 495a 4529 207b 0a20 2020  _FINALIZE) {.   
+00071d50: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
+00071d60: 207d 0a0a 2020 2020 6675 6e28 6473 742c   }..    fun(dst,
+00071d70: 2061 2c20 622c 2063 293b 0a7d 0a0a 0a73   a, b, c);.}...s
+00071d80: 7461 7469 6320 766f 6964 2067 676d 6c5f  tatic void ggml_
+00071d90: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00071da0: 6d61 705f 6375 7374 6f6d 3328 0a20 2020  map_custom3(.   
+00071db0: 2020 2020 2063 6f6e 7374 2073 7472 7563       const struc
+00071dc0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f70  t ggml_compute_p
+00071dd0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+00071de0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00071df0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00071e00: 202a 2061 2c0a 2020 2020 2020 2020 636f   * a,.        co
+00071e10: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00071e20: 7465 6e73 6f72 202a 2062 2c0a 2020 2020  tensor * b,.    
+00071e30: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00071e40: 2067 676d 6c5f 7465 6e73 6f72 202a 2063   ggml_tensor * c
+00071e50: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+00071e60: 2067 676d 6c5f 7465 6e73 6f72 202a 2064   ggml_tensor * d
+00071e70: 7374 2c0a 2020 2020 2020 2020 636f 6e73  st,.        cons
+00071e80: 7420 6767 6d6c 5f63 7573 746f 6d33 5f6f  t ggml_custom3_o
+00071e90: 705f 6633 325f 7420 6675 6e29 207b 0a20  p_f32_t fun) {. 
+00071ea0: 2020 2073 7769 7463 6820 2861 2d3e 7479     switch (a->ty
+00071eb0: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
+00071ec0: 7365 2047 474d 4c5f 5459 5045 5f46 3332  se GGML_TYPE_F32
+00071ed0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00071ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00071ef0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00071f00: 7761 7264 5f6d 6170 5f63 7573 746f 6d33  ward_map_custom3
+00071f10: 5f66 3332 2870 6172 616d 732c 2061 2c20  _f32(params, a, 
+00071f20: 622c 2063 2c20 6473 742c 2066 756e 293b  b, c, dst, fun);
+00071f30: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00071f40: 7265 616b 3b0a 2020 2020 2020 2020 6465  reak;.        de
+00071f50: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+00071f60: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00071f70: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00071f80: 2866 616c 7365 293b 0a20 2020 2020 2020  (false);.       
+00071f90: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00071fa0: 2020 7d0a 7d0a 0a2f 2f20 6767 6d6c 5f63    }.}..// ggml_c
+00071fb0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
+00071fc0: 726f 7373 5f65 6e74 726f 7079 5f6c 6f73  ross_entropy_los
+00071fd0: 730a 0a73 7461 7469 6320 766f 6964 2067  s..static void g
+00071fe0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00071ff0: 6172 645f 6372 6f73 735f 656e 7472 6f70  ard_cross_entrop
+00072000: 795f 6c6f 7373 5f66 3332 280a 2020 2020  y_loss_f32(.    
+00072010: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
+00072020: 2067 676d 6c5f 636f 6d70 7574 655f 7061   ggml_compute_pa
+00072030: 7261 6d73 202a 2070 6172 616d 732c 0a20  rams * params,. 
+00072040: 2020 2020 2020 2063 6f6e 7374 2073 7472         const str
+00072050: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00072060: 2a20 7372 6330 2c0a 2020 2020 2020 2020  * src0,.        
+00072070: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+00072080: 6c5f 7465 6e73 6f72 202a 2073 7263 312c  l_tensor * src1,
+00072090: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000720a0: 6767 6d6c 5f74 656e 736f 7220 2a20 6473  ggml_tensor * ds
+000720b0: 7429 207b 0a20 2020 2047 474d 4c5f 4153  t) {.    GGML_AS
+000720c0: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
+000720d0: 7469 6775 6f75 7328 7372 6330 2929 3b0a  tiguous(src0));.
+000720e0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+000720f0: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
+00072100: 7573 2873 7263 3129 293b 0a20 2020 2047  us(src1));.    G
+00072110: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+00072120: 6973 5f73 6361 6c61 7228 6473 7429 293b  is_scalar(dst));
+00072130: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
+00072140: 2867 676d 6c5f 6172 655f 7361 6d65 5f73  (ggml_are_same_s
+00072150: 6861 7065 2873 7263 302c 2073 7263 3129  hape(src0, src1)
+00072160: 293b 0a0a 2020 2020 636f 6e73 7420 696e  );..    const in
+00072170: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+00072180: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+00072190: 6e74 206e 7468 203d 2070 6172 616d 732d  nt nth = params-
+000721a0: 3e6e 7468 3b0a 0a20 2020 2066 6c6f 6174  >nth;..    float
+000721b0: 202a 2073 756d 7320 3d20 2866 6c6f 6174   * sums = (float
+000721c0: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+000721d0: 613b 0a0a 2020 2020 2f2f 2054 4f44 4f3a  a;..    // TODO:
+000721e0: 2068 616e 646c 6520 7472 616e 7370 6f73   handle transpos
+000721f0: 6564 2f70 6572 6d75 7465 6420 6d61 7472  ed/permuted matr
+00072200: 6963 6573 0a20 2020 2063 6f6e 7374 2069  ices.    const i
+00072210: 6e74 206e 6320 3d20 7372 6330 2d3e 6e65  nt nc = src0->ne
+00072220: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00072230: 6e74 206e 7220 3d20 6767 6d6c 5f6e 726f  nt nr = ggml_nro
+00072240: 7773 2873 7263 3029 3b0a 0a20 2020 2069  ws(src0);..    i
+00072250: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00072260: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+00072270: 5429 207b 0a20 2020 2020 2020 2069 6620  T) {.        if 
+00072280: 2869 7468 203d 3d20 3029 207b 0a20 2020  (ith == 0) {.   
+00072290: 2020 2020 2020 2020 206d 656d 7365 7428           memset(
+000722a0: 7375 6d73 2c20 302c 2073 697a 656f 6628  sums, 0, sizeof(
+000722b0: 666c 6f61 7429 202a 2028 6e74 6820 2b20  float) * (nth + 
+000722c0: 6e74 6820 2a20 6e63 2929 3b0a 2020 2020  nth * nc));.    
+000722d0: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
+000722e0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
+000722f0: 2069 6620 2870 6172 616d 732d 3e74 7970   if (params->typ
+00072300: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+00072310: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+00072320: 2020 2069 6620 2869 7468 203d 3d20 3029     if (ith == 0)
+00072330: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+00072340: 6c6f 6174 202a 2064 7020 3d20 2866 6c6f  loat * dp = (flo
+00072350: 6174 202a 2920 6473 742d 3e64 6174 613b  at *) dst->data;
+00072360: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+00072370: 6c5f 7665 635f 7375 6d5f 6633 3228 6e74  l_vec_sum_f32(nt
+00072380: 682c 2064 702c 2073 756d 7329 3b0a 2020  h, dp, sums);.  
+00072390: 2020 2020 2020 2020 2020 6470 5b30 5d20            dp[0] 
+000723a0: 2a3d 202d 312e 3066 3b0a 2020 2020 2020  *= -1.0f;.      
+000723b0: 2020 7d0a 2020 2020 2020 2020 7265 7475    }.        retu
+000723c0: 726e 3b0a 2020 2020 7d0a 0a20 2020 2063  rn;.    }..    c
+000723d0: 6f6e 7374 2064 6f75 626c 6520 6570 7320  onst double eps 
+000723e0: 3d20 3165 2d39 3b0a 0a20 2020 202f 2f20  = 1e-9;..    // 
+000723f0: 726f 7773 2070 6572 2074 6872 6561 640a  rows per thread.
+00072400: 2020 2020 636f 6e73 7420 696e 7420 6472      const int dr
+00072410: 203d 2028 6e72 202b 206e 7468 202d 2031   = (nr + nth - 1
+00072420: 292f 6e74 683b 0a0a 2020 2020 2f2f 2072  )/nth;..    // r
+00072430: 6f77 2072 616e 6765 2066 6f72 2074 6869  ow range for thi
+00072440: 7320 7468 7265 6164 0a20 2020 2063 6f6e  s thread.    con
+00072450: 7374 2069 6e74 2069 7230 203d 2064 722a  st int ir0 = dr*
+00072460: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+00072470: 6e74 2069 7231 203d 204d 494e 2869 7230  nt ir1 = MIN(ir0
+00072480: 202b 2064 722c 206e 7229 3b0a 0a20 2020   + dr, nr);..   
+00072490: 2066 6f72 2028 696e 7420 6931 203d 2069   for (int i1 = i
+000724a0: 7230 3b20 6931 203c 2069 7231 3b20 6931  r0; i1 < ir1; i1
+000724b0: 2b2b 2920 7b0a 2020 2020 2020 2020 666c  ++) {.        fl
+000724c0: 6f61 7420 2a20 7330 203d 2028 666c 6f61  oat * s0 = (floa
+000724d0: 7420 2a29 2828 6368 6172 202a 2920 7372  t *)((char *) sr
+000724e0: 6330 2d3e 6461 7461 202b 2069 312a 7372  c0->data + i1*sr
+000724f0: 6330 2d3e 6e62 5b31 5d29 3b0a 2020 2020  c0->nb[1]);.    
+00072500: 2020 2020 666c 6f61 7420 2a20 7331 203d      float * s1 =
+00072510: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+00072520: 202a 2920 7372 6331 2d3e 6461 7461 202b   *) src1->data +
+00072530: 2069 312a 7372 6331 2d3e 6e62 5b31 5d29   i1*src1->nb[1])
+00072540: 3b0a 2020 2020 2020 2020 666c 6f61 7420  ;.        float 
+00072550: 2a20 7374 203d 2028 666c 6f61 7420 2a29  * st = (float *)
+00072560: 2070 6172 616d 732d 3e77 6461 7461 202b   params->wdata +
+00072570: 206e 7468 202b 2069 7468 2a6e 633b 0a0a   nth + ith*nc;..
+00072580: 2369 666e 6465 6620 4e44 4542 5547 0a20  #ifndef NDEBUG. 
+00072590: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+000725a0: 6920 3d20 303b 2069 203c 206e 633b 202b  i = 0; i < nc; +
+000725b0: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
+000725c0: 2020 2f2f 7072 696e 7466 2822 705b 2564    //printf("p[%d
+000725d0: 5d20 3d20 2566 5c6e 222c 2069 2c20 705b  ] = %f\n", i, p[
+000725e0: 695d 293b 0a20 2020 2020 2020 2020 2020  i]);.           
+000725f0: 2061 7373 6572 7428 2169 736e 616e 2873   assert(!isnan(s
+00072600: 305b 695d 2929 3b0a 2020 2020 2020 2020  0[i]));.        
+00072610: 2020 2020 6173 7365 7274 2821 6973 6e61      assert(!isna
+00072620: 6e28 7331 5b69 5d29 293b 0a20 2020 2020  n(s1[i]));.     
+00072630: 2020 207d 0a23 656e 6469 660a 2020 2020     }.#endif.    
+00072640: 2020 2020 2f2f 2073 6f66 745f 6d61 780a      // soft_max.
+00072650: 2020 2020 2020 2020 6767 6d6c 5f66 6c6f          ggml_flo
+00072660: 6174 2073 756d 203d 2030 2e30 3b0a 2020  at sum = 0.0;.  
+00072670: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00072680: 2020 2020 666c 6f61 7420 6d61 7820 3d20      float max = 
+00072690: 2d49 4e46 494e 4954 593b 0a20 2020 2020  -INFINITY;.     
+000726a0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+000726b0: 6d61 785f 6633 3228 6e63 2c20 266d 6178  max_f32(nc, &max
+000726c0: 2c20 7330 293b 0a0a 2020 2020 2020 2020  , s0);..        
+000726d0: 2020 2020 7569 6e74 3136 5f74 2073 6376      uint16_t scv
+000726e0: 743b 0a20 2020 2020 2020 2020 2020 2066  t;.            f
+000726f0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+00072700: 203c 206e 633b 2069 2b2b 2920 7b0a 2020   < nc; i++) {.  
+00072710: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00072720: 2028 7330 5b69 5d20 3d3d 202d 494e 4649   (s0[i] == -INFI
+00072730: 4e49 5459 2920 7b0a 2020 2020 2020 2020  NITY) {.        
+00072740: 2020 2020 2020 2020 2020 2020 7374 5b69              st[i
+00072750: 5d20 3d20 302e 3066 3b0a 2020 2020 2020  ] = 0.0f;.      
+00072760: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+00072770: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00072780: 2020 2020 2020 202f 2f20 636f 6e73 7420         // const 
+00072790: 666c 6f61 7420 7661 6c20 3d20 2873 305b  float val = (s0[
+000727a0: 695d 203d 3d20 2d49 4e46 494e 4954 5929  i] == -INFINITY)
+000727b0: 203f 2030 2e30 203a 2065 7870 2873 305b   ? 0.0 : exp(s0[
+000727c0: 695d 202d 206d 6178 293b 0a20 2020 2020  i] - max);.     
+000727d0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+000727e0: 676d 6c5f 6670 3136 5f74 2073 203d 2047  gml_fp16_t s = G
+000727f0: 474d 4c5f 4650 3332 5f54 4f5f 4650 3136  GML_FP32_TO_FP16
+00072800: 2873 305b 695d 202d 206d 6178 293b 0a20  (s0[i] - max);. 
+00072810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00072820: 2020 206d 656d 6370 7928 2673 6376 742c     memcpy(&scvt,
+00072830: 2026 732c 2073 697a 656f 6628 7363 7674   &s, sizeof(scvt
+00072840: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+00072850: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+00072860: 6f61 7420 7661 6c20 3d20 4747 4d4c 5f46  oat val = GGML_F
+00072870: 5031 365f 544f 5f46 5033 3228 7461 626c  P16_TO_FP32(tabl
+00072880: 655f 6578 705f 6631 365b 7363 7674 5d29  e_exp_f16[scvt])
+00072890: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000728a0: 2020 2020 2020 7375 6d20 2b3d 2028 6767        sum += (gg
+000728b0: 6d6c 5f66 6c6f 6174 2976 616c 3b0a 2020  ml_float)val;.  
+000728c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000728d0: 2020 7374 5b69 5d20 3d20 7661 6c3b 0a20    st[i] = val;. 
+000728e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000728f0: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+00072900: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00072910: 7274 2873 756d 203e 2030 2e30 293b 0a20  rt(sum > 0.0);. 
+00072920: 2020 2020 2020 2020 2020 202f 2f20 7375             // su
+00072930: 6d20 3d20 312e 302f 7375 6d3b 0a20 2020  m = 1.0/sum;.   
+00072940: 2020 2020 207d 0a20 2020 2020 2020 202f       }.        /
+00072950: 2f20 6176 6f69 6420 6c6f 6728 3029 2062  / avoid log(0) b
+00072960: 7920 7265 7363 616c 696e 6720 6672 6f6d  y rescaling from
+00072970: 205b 302e 2e31 5d20 746f 205b 6570 732e   [0..1] to [eps.
+00072980: 2e31 5d0a 2020 2020 2020 2020 7375 6d20  .1].        sum 
+00072990: 3d20 2831 2e30 202d 2065 7073 2920 2f20  = (1.0 - eps) / 
+000729a0: 7375 6d3b 0a20 2020 2020 2020 2067 676d  sum;.        ggm
+000729b0: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
+000729c0: 6e63 2c20 7374 2c20 7375 6d29 3b0a 2020  nc, st, sum);.  
+000729d0: 2020 2020 2020 6767 6d6c 5f76 6563 5f61        ggml_vec_a
+000729e0: 6464 315f 6633 3228 6e63 2c20 7374 2c20  dd1_f32(nc, st, 
+000729f0: 7374 2c20 6570 7329 3b0a 2020 2020 2020  st, eps);.      
+00072a00: 2020 6767 6d6c 5f76 6563 5f6c 6f67 5f66    ggml_vec_log_f
+00072a10: 3332 286e 632c 2073 742c 2073 7429 3b0a  32(nc, st, st);.
+00072a20: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00072a30: 5f6d 756c 5f66 3332 286e 632c 2073 742c  _mul_f32(nc, st,
+00072a40: 2073 742c 2073 3129 3b0a 0a20 2020 2020   st, s1);..     
+00072a50: 2020 2067 676d 6c5f 7665 635f 7375 6d5f     ggml_vec_sum_
+00072a60: 6633 3228 6e63 2c20 7375 6d73 202b 2069  f32(nc, sums + i
+00072a70: 7468 2c20 7374 293b 0a0a 2369 666e 6465  th, st);..#ifnde
+00072a80: 6620 4e44 4542 5547 0a20 2020 2020 2020  f NDEBUG.       
+00072a90: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00072aa0: 2069 203c 206e 633b 202b 2b69 2920 7b0a   i < nc; ++i) {.
+00072ab0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00072ac0: 7274 2821 6973 6e61 6e28 7374 5b69 5d29  rt(!isnan(st[i])
+00072ad0: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
+00072ae0: 7373 6572 7428 2169 7369 6e66 2873 745b  ssert(!isinf(st[
+00072af0: 695d 2929 3b0a 2020 2020 2020 2020 7d0a  i]));.        }.
+00072b00: 2365 6e64 6966 0a20 2020 207d 0a0a 7d0a  #endif.    }..}.
+00072b10: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
+00072b20: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00072b30: 645f 6372 6f73 735f 656e 7472 6f70 795f  d_cross_entropy_
+00072b40: 6c6f 7373 280a 2020 2020 2020 2020 636f  loss(.        co
+00072b50: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+00072b60: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+00072b70: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
+00072b80: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
+00072b90: 6d6c 5f74 656e 736f 7220 2a20 7372 6330  ml_tensor * src0
+00072ba0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
+00072bb0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00072bc0: 6f72 202a 2073 7263 312c 0a20 2020 2020  or * src1,.     
+00072bd0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+00072be0: 656e 736f 7220 2a20 6473 7429 207b 0a20  ensor * dst) {. 
+00072bf0: 2020 2073 7769 7463 6820 2873 7263 302d     switch (src0-
+00072c00: 3e74 7970 6529 207b 0a20 2020 2020 2020  >type) {.       
+00072c10: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00072c20: 4633 323a 0a20 2020 2020 2020 2020 2020  F32:.           
+00072c30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00072c40: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00072c50: 666f 7277 6172 645f 6372 6f73 735f 656e  forward_cross_en
+00072c60: 7472 6f70 795f 6c6f 7373 5f66 3332 2870  tropy_loss_f32(p
+00072c70: 6172 616d 732c 2073 7263 302c 2073 7263  arams, src0, src
+00072c80: 312c 2064 7374 293b 0a20 2020 2020 2020  1, dst);.       
+00072c90: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00072ca0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+00072cb0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00072cc0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00072cd0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00072ce0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00072cf0: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a2f  reak;.    }.}../
+00072d00: 2f20 6767 6d6c 5f63 6f6d 7075 7465 5f66  / ggml_compute_f
+00072d10: 6f72 7761 7264 5f63 726f 7373 5f65 6e74  orward_cross_ent
+00072d20: 726f 7079 5f6c 6f73 735f 6261 636b 0a0a  ropy_loss_back..
+00072d30: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+00072d40: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00072d50: 5f63 726f 7373 5f65 6e74 726f 7079 5f6c  _cross_entropy_l
+00072d60: 6f73 735f 6261 636b 5f66 3332 280a 2020  oss_back_f32(.  
+00072d70: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+00072d80: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00072d90: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
+00072da0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+00072db0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+00072dc0: 7220 2a20 7372 6330 2c0a 2020 2020 2020  r * src0,.      
+00072dd0: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00072de0: 676d 6c5f 7465 6e73 6f72 202a 2073 7263  gml_tensor * src
+00072df0: 312c 0a20 2020 2020 2020 2063 6f6e 7374  1,.        const
+00072e00: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+00072e10: 736f 7220 2a20 6f70 7430 2c0a 2020 2020  sor * opt0,.    
+00072e20: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00072e30: 7465 6e73 6f72 202a 2064 7374 2920 7b0a  tensor * dst) {.
+00072e40: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00072e50: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
+00072e60: 7573 2864 7374 2929 3b0a 2020 2020 4747  us(dst));.    GG
+00072e70: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+00072e80: 735f 636f 6e74 6967 756f 7573 2873 7263  s_contiguous(src
+00072e90: 3029 293b 0a20 2020 2047 474d 4c5f 4153  0));.    GGML_AS
+00072ea0: 5345 5254 2867 676d 6c5f 6973 5f63 6f6e  SERT(ggml_is_con
+00072eb0: 7469 6775 6f75 7328 7372 6331 2929 3b0a  tiguous(src1));.
+00072ec0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00072ed0: 6767 6d6c 5f69 735f 636f 6e74 6967 756f  ggml_is_contiguo
+00072ee0: 7573 286f 7074 3029 293b 0a20 2020 2047  us(opt0));.    G
+00072ef0: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+00072f00: 6172 655f 7361 6d65 5f73 6861 7065 2873  are_same_shape(s
+00072f10: 7263 302c 2073 7263 3129 2026 2620 6767  rc0, src1) && gg
+00072f20: 6d6c 5f61 7265 5f73 616d 655f 7368 6170  ml_are_same_shap
+00072f30: 6528 7372 6330 2c20 6473 7429 293b 0a0a  e(src0, dst));..
+00072f40: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+00072f50: 7420 6974 6820 3d20 7061 7261 6d73 2d3e  t ith = params->
+00072f60: 6974 683b 0a20 2020 2063 6f6e 7374 2069  ith;.    const i
+00072f70: 6e74 3634 5f74 206e 7468 203d 2070 6172  nt64_t nth = par
+00072f80: 616d 732d 3e6e 7468 3b0a 0a20 2020 2069  ams->nth;..    i
+00072f90: 6620 2870 6172 616d 732d 3e74 7970 6520  f (params->type 
+00072fa0: 3d3d 2047 474d 4c5f 5441 534b 5f49 4e49  == GGML_TASK_INI
+00072fb0: 5420 7c7c 2070 6172 616d 732d 3e74 7970  T || params->typ
+00072fc0: 6520 3d3d 2047 474d 4c5f 5441 534b 5f46  e == GGML_TASK_F
+00072fd0: 494e 414c 495a 4529 207b 0a20 2020 2020  INALIZE) {.     
+00072fe0: 2020 2072 6574 7572 6e3b 0a20 2020 207d     return;.    }
+00072ff0: 0a0a 2020 2020 636f 6e73 7420 666c 6f61  ..    const floa
+00073000: 7420 6570 7320 3d20 3165 2d39 663b 0a0a  t eps = 1e-9f;..
+00073010: 2020 2020 2f2f 2054 4f44 4f3a 2068 616e      // TODO: han
+00073020: 646c 6520 7472 616e 7370 6f73 6564 2f70  dle transposed/p
+00073030: 6572 6d75 7465 6420 6d61 7472 6963 6573  ermuted matrices
+00073040: 0a20 2020 2063 6f6e 7374 2069 6e74 3634  .    const int64
+00073050: 5f74 206e 6320 3d20 7372 6330 2d3e 6e65  _t nc = src0->ne
+00073060: 5b30 5d3b 0a20 2020 2063 6f6e 7374 2069  [0];.    const i
+00073070: 6e74 3634 5f74 206e 7220 3d20 6767 6d6c  nt64_t nr = ggml
+00073080: 5f6e 726f 7773 2873 7263 3029 3b0a 0a20  _nrows(src0);.. 
+00073090: 2020 202f 2f20 726f 7773 2070 6572 2074     // rows per t
+000730a0: 6872 6561 640a 2020 2020 636f 6e73 7420  hread.    const 
+000730b0: 696e 7436 345f 7420 6472 203d 2028 6e72  int64_t dr = (nr
+000730c0: 202b 206e 7468 202d 2031 292f 6e74 683b   + nth - 1)/nth;
+000730d0: 0a0a 2020 2020 2f2f 2072 6f77 2072 616e  ..    // row ran
+000730e0: 6765 2066 6f72 2074 6869 7320 7468 7265  ge for this thre
+000730f0: 6164 0a20 2020 2063 6f6e 7374 2069 6e74  ad.    const int
+00073100: 3634 5f74 2069 7230 203d 2064 722a 6974  64_t ir0 = dr*it
+00073110: 683b 0a20 2020 2063 6f6e 7374 2069 6e74  h;.    const int
+00073120: 3634 5f74 2069 7231 203d 204d 494e 2869  64_t ir1 = MIN(i
+00073130: 7230 202b 2064 722c 206e 7229 3b0a 0a20  r0 + dr, nr);.. 
+00073140: 2020 2066 6c6f 6174 202a 2064 2020 203d     float * d   =
+00073150: 2028 666c 6f61 7420 2a29 206f 7074 302d   (float *) opt0-
+00073160: 3e64 6174 613b 0a0a 2020 2020 666f 7220  >data;..    for 
+00073170: 2869 6e74 3634 5f74 2069 3120 3d20 6972  (int64_t i1 = ir
+00073180: 303b 2069 3120 3c20 6972 313b 2069 312b  0; i1 < ir1; i1+
+00073190: 2b29 207b 0a20 2020 2020 2020 2066 6c6f  +) {.        flo
+000731a0: 6174 202a 2064 7330 203d 2028 666c 6f61  at * ds0 = (floa
+000731b0: 7420 2a29 2828 6368 6172 202a 2920 6473  t *)((char *) ds
+000731c0: 742d 3e64 6174 6120 202b 2069 312a 6473  t->data  + i1*ds
+000731d0: 742d 3e6e 625b 315d 293b 0a20 2020 2020  t->nb[1]);.     
+000731e0: 2020 2066 6c6f 6174 202a 2073 3020 203d     float * s0  =
+000731f0: 2028 666c 6f61 7420 2a29 2828 6368 6172   (float *)((char
+00073200: 202a 2920 7372 6330 2d3e 6461 7461 202b   *) src0->data +
+00073210: 2069 312a 7372 6330 2d3e 6e62 5b31 5d29   i1*src0->nb[1])
+00073220: 3b0a 2020 2020 2020 2020 666c 6f61 7420  ;.        float 
+00073230: 2a20 7331 2020 3d20 2866 6c6f 6174 202a  * s1  = (float *
+00073240: 2928 2863 6861 7220 2a29 2073 7263 312d  )((char *) src1-
+00073250: 3e64 6174 6120 2b20 6931 2a73 7263 312d  >data + i1*src1-
+00073260: 3e6e 625b 315d 293b 0a20 2020 2020 2020  >nb[1]);.       
+00073270: 2066 6c6f 6174 202a 2073 6d20 203d 2028   float * sm  = (
+00073280: 666c 6f61 7420 2a29 2070 6172 616d 732d  float *) params-
+00073290: 3e77 6461 7461 202b 2069 7468 2a6e 633b  >wdata + ith*nc;
+000732a0: 0a0a 2369 666e 6465 6620 4e44 4542 5547  ..#ifndef NDEBUG
+000732b0: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+000732c0: 7420 6920 3d20 303b 2069 203c 206e 633b  t i = 0; i < nc;
+000732d0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+000732e0: 2020 2020 2f2f 7072 696e 7466 2822 705b      //printf("p[
+000732f0: 2564 5d20 3d20 2566 5c6e 222c 2069 2c20  %d] = %f\n", i, 
+00073300: 705b 695d 293b 0a20 2020 2020 2020 2020  p[i]);.         
+00073310: 2020 2061 7373 6572 7428 2169 736e 616e     assert(!isnan
+00073320: 2873 305b 695d 2929 3b0a 2020 2020 2020  (s0[i]));.      
+00073330: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
+00073340: 6e61 6e28 7331 5b69 5d29 293b 0a20 2020  nan(s1[i]));.   
+00073350: 2020 2020 207d 0a23 656e 6469 660a 2020       }.#endif.  
+00073360: 2020 2020 2020 2f2f 2073 7465 7020 6279        // step by
+00073370: 2073 7465 7020 6578 706c 616e 6174 696f   step explanatio
+00073380: 6e3a 0a20 2020 2020 2020 207b 0a20 2020  n:.        {.   
+00073390: 2020 2020 2020 2020 202f 2f66 6c6f 6174           //float
+000733a0: 202a 2073 756d 7320 3d20 2866 6c6f 6174   * sums = (float
+000733b0: 202a 2920 7061 7261 6d73 2d3e 7764 6174   *) params->wdat
+000733c0: 613b 0a0a 2020 2020 2020 2020 2020 2020  a;..            
+000733d0: 2f2f 2066 6f72 7761 7264 2070 6173 7320  // forward pass 
+000733e0: 7769 7468 2061 6e6e 6f74 6174 6564 2067  with annotated g
+000733f0: 7261 6469 656e 7473 2066 726f 6d20 6261  radients from ba
+00073400: 636b 7761 7264 2070 6173 730a 2020 2020  ckward pass.    
+00073410: 2020 2020 2020 2020 2f2f 2028 6275 696c          // (buil
+00073420: 7420 6279 2067 6f69 6e67 2069 6e20 7265  t by going in re
+00073430: 7665 7273 6520 6f70 6572 6174 696f 6e20  verse operation 
+00073440: 6f72 6465 722c 2061 6464 696e 6720 746f  order, adding to
+00073450: 2067 7261 6469 656e 7473 206f 6620 6375   gradients of cu
+00073460: 7272 656e 7420 6f70 6572 6174 696f 6e20  rrent operation 
+00073470: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
+00073480: 2020 2f2f 2073 7430 203d 2065 7870 2873    // st0 = exp(s
+00073490: 302d 6d61 7828 7330 2929 2020 2020 2020  0-max(s0))      
 000734a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000734b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000734c0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-000734d0: 2f20 6672 6f6d 2073 6f66 746d 6178 5f62  / from softmax_b
-000734e0: 6163 6b3a 2020 2020 2020 2020 2020 2020  ack:            
-000734f0: 6772 6164 5b73 305d 2020 3d20 7374 315f  grad[s0]  = st1_
-00073500: 6b20 2a20 2867 7261 645b 7374 315d 5f6b  k * (grad[st1]_k
-00073510: 202d 2064 6f74 2873 7431 2c20 6772 6164   - dot(st1, grad
-00073520: 5b73 7431 5d29 290a 2020 2020 2020 2020  [st1])).        
-00073530: 2020 2020 2f2f 2067 676d 6c5f 7665 635f      // ggml_vec_
-00073540: 7363 616c 655f 6633 3228 6e63 2c20 7374  scale_f32(nc, st
-00073550: 2c20 7375 6d29 3b20 2020 2020 2020 2020  , sum);         
-00073560: 2020 2f2f 2073 7431 203d 2073 7430 2a2f    // st1 = st0*/
-00073570: 7375 6d20 3d20 736f 6674 6d61 7828 7330  sum = softmax(s0
-00073580: 2920 2067 7261 645b 7374 315d 203d 2067  )  grad[st1] = g
-00073590: 7261 645b 7374 325d 2a28 312e 3020 2d20  rad[st2]*(1.0 - 
-000735a0: 6570 7329 0a20 2020 2020 2020 2020 2020  eps).           
-000735b0: 202f 2f20 6767 6d6c 5f76 6563 5f73 6361   // ggml_vec_sca
-000735c0: 6c65 5f66 3332 286e 632c 2073 742c 2028  le_f32(nc, st, (
-000735d0: 312e 3066 202d 2065 7073 2929 3b20 202f  1.0f - eps));  /
-000735e0: 2f20 7374 3220 3d20 7374 312a 2831 2e30  / st2 = st1*(1.0
-000735f0: 202d 2065 7073 2920 2020 2020 2020 2020   - eps)         
-00073600: 6772 6164 5b73 7432 5d20 3d20 6772 6164  grad[st2] = grad
-00073610: 5b73 7433 5d0a 2020 2020 2020 2020 2020  [st3].          
-00073620: 2020 2f2f 2067 676d 6c5f 7665 635f 6164    // ggml_vec_ad
-00073630: 6431 5f66 3332 286e 632c 2073 742c 2073  d1_f32(nc, st, s
-00073640: 742c 2065 7073 293b 2020 2020 2020 2020  t, eps);        
-00073650: 2f2f 2073 7433 203d 2073 7432 202b 2065  // st3 = st2 + e
-00073660: 7073 2020 2020 2020 2020 2020 2020 2020  ps              
-00073670: 2067 7261 645b 7374 335d 203d 2067 7261   grad[st3] = gra
-00073680: 645b 7374 345d 2f73 7433 0a20 2020 2020  d[st4]/st3.     
-00073690: 2020 2020 2020 202f 2f20 6767 6d6c 5f76         // ggml_v
-000736a0: 6563 5f6c 6f67 5f66 3332 286e 632c 2073  ec_log_f32(nc, s
-000736b0: 742c 2073 7429 3b20 2020 2020 2020 2020  t, st);         
-000736c0: 2020 2020 202f 2f20 7374 3420 3d20 6c6f       // st4 = lo
-000736d0: 6728 7374 3329 2020 2020 2020 2020 2020  g(st3)          
-000736e0: 2020 2020 2020 6772 6164 5b73 7434 5d20        grad[st4] 
-000736f0: 3d20 6772 6164 5b73 7435 5d20 2a20 7331  = grad[st5] * s1
-00073700: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-00073710: 6767 6d6c 5f76 6563 5f6d 756c 5f66 3332  ggml_vec_mul_f32
-00073720: 286e 632c 2073 742c 2073 742c 2073 3129  (nc, st, st, s1)
-00073730: 3b20 2020 2020 2020 2020 202f 2f20 7374  ;          // st
-00073740: 3520 3d20 7374 3420 2a20 7331 2020 2020  5 = st4 * s1    
-00073750: 2020 2020 2020 2020 2020 2020 6772 6164              grad
-00073760: 5b73 7435 5d20 3d20 6772 6164 5b73 756d  [st5] = grad[sum
-00073770: 735b 6974 685d 5d0a 2020 2020 2020 2020  s[ith]].        
-00073780: 2020 2020 2f2f 2067 676d 6c5f 7665 635f      // ggml_vec_
-00073790: 7375 6d5f 6633 3228 6e63 2c20 7375 6d73  sum_f32(nc, sums
-000737a0: 202b 2069 7468 2c20 7374 293b 2020 2020   + ith, st);    
-000737b0: 2020 2f2f 2073 756d 735b 6974 685d 203d    // sums[ith] =
-000737c0: 2073 7435 2020 2020 2020 2020 2020 2020   st5            
-000737d0: 2020 2067 7261 645b 7375 6d73 5b69 7468     grad[sums[ith
-000737e0: 5d5d 203d 2067 7261 645b 6372 6f73 735f  ]] = grad[cross_
-000737f0: 656e 7472 6f70 795f 6c6f 7373 5d20 3d20  entropy_loss] = 
-00073800: 2d67 7261 645b 6365 6c5d 0a0a 2020 2020  -grad[cel]..    
-00073810: 2020 2020 2020 2020 2f2f 2073 7562 7374          // subst
-00073820: 6974 7574 6520 696e 746f 2067 7261 645b  itute into grad[
-00073830: 7374 315d 2c20 6265 6361 7573 6520 7765  st1], because we
-00073840: 2063 616e 2072 6575 7365 2073 6f66 746d   can reuse softm
-00073850: 6178 5f62 6163 6b20 6672 6f6d 2074 6869  ax_back from thi
-00073860: 7320 706f 696e 7420 6f6e 0a20 2020 2020  s point on.     
-00073870: 2020 2020 2020 202f 2f20 6772 6164 5b73         // grad[s
-00073880: 7431 5d20 3d20 2d67 7261 645b 6365 6c5d  t1] = -grad[cel]
-00073890: 2a73 312a 2831 2e30 202d 2065 7073 292f  *s1*(1.0 - eps)/
-000738a0: 2865 7073 202b 2073 6f66 746d 6178 2873  (eps + softmax(s
-000738b0: 3029 2a28 312e 3020 2d20 6570 7329 290a  0)*(1.0 - eps)).
-000738c0: 2020 2020 2020 2020 2020 2020 2f2f 2070              // p
-000738d0: 6f73 746f 7264 6572 3a0a 2020 2020 2020  ostorder:.      
-000738e0: 2020 2020 2020 2f2f 2067 7261 645b 7374        // grad[st
-000738f0: 315d 203a 3d20 736f 6674 6d61 7828 7330  1] := softmax(s0
-00073900: 290a 2020 2020 2020 2020 2020 2020 2f2f  ).            //
-00073910: 2067 7261 645b 7374 315d 203a 3d20 6772   grad[st1] := gr
-00073920: 6164 5b73 7431 5d2a 2831 2e30 202d 2065  ad[st1]*(1.0 - e
-00073930: 7073 290a 2020 2020 2020 2020 2020 2020  ps).            
-00073940: 2f2f 2067 7261 645b 7374 315d 203a 3d20  // grad[st1] := 
-00073950: 6772 6164 5b73 7431 5d20 2b20 6570 730a  grad[st1] + eps.
-00073960: 2020 2020 2020 2020 2020 2020 2f2f 2067              // g
-00073970: 7261 645b 7374 315d 203a 3d20 7331 202f  rad[st1] := s1 /
-00073980: 2067 7261 645b 7374 315d 0a20 2020 2020   grad[st1].     
-00073990: 2020 2020 2020 202f 2f20 6772 6164 5b73         // grad[s
-000739a0: 7431 5d20 3a3d 2067 7261 645b 7374 315d  t1] := grad[st1]
-000739b0: 2a28 312e 302d 6570 7329 2a2d 6772 6164  *(1.0-eps)*-grad
-000739c0: 5b63 656c 5d0a 0a20 2020 2020 2020 2020  [cel]..         
-000739d0: 2020 202f 2f20 7372 6330 2067 7261 6469     // src0 gradi
-000739e0: 656e 7473 2062 7920 676f 696e 6720 7468  ents by going th
-000739f0: 726f 7567 6820 736f 6674 6d61 785f 6261  rough softmax_ba
-00073a00: 636b 0a20 2020 2020 2020 2020 2020 202f  ck.            /
-00073a10: 2f20 6772 6164 5b73 305d 203d 2073 7431  / grad[s0] = st1
-00073a20: 5f6b 202a 2028 6772 6164 5b73 7431 5d5f  _k * (grad[st1]_
-00073a30: 6b20 2d20 646f 7428 7374 312c 2067 7261  k - dot(st1, gra
-00073a40: 645b 7374 315d 2929 0a20 2020 2020 2020  d[st1])).       
-00073a50: 2020 2020 202f 2f20 2020 6672 6f6d 2073       //   from s
-00073a60: 6f66 746d 6178 5f62 6163 6b3a 0a20 2020  oftmax_back:.   
-00073a70: 2020 2020 2020 2020 202f 2f20 2020 6478           //   dx
-00073a80: 6b20 3d20 796b 202a 2028 6479 6b20 2d20  k = yk * (dyk - 
-00073a90: 646f 7428 792c 2064 7929 290a 2020 2020  dot(y, dy)).    
-00073aa0: 2020 2020 2020 2020 2f2f 2020 2064 6f74          //   dot
-00073ab0: 5f79 5f64 7920 3a3d 2064 6f74 2879 2c20  _y_dy := dot(y, 
-00073ac0: 6479 290a 2020 2020 2020 2020 2020 2020  dy).            
-00073ad0: 2f2f 2020 2064 7820 3a3d 2064 790a 2020  //   dx := dy.  
-00073ae0: 2020 2020 2020 2020 2020 2f2f 2020 2064            //   d
-00073af0: 7820 3a3d 2064 7820 2d20 646f 745f 795f  x := dx - dot_y_
-00073b00: 6479 0a20 2020 2020 2020 2020 2020 202f  dy.            /
-00073b10: 2f20 2020 6478 203a 3d20 6478 202a 2079  /   dx := dx * y
-00073b20: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-00073b30: 2020 706f 7374 6f72 6465 723a 0a20 2020    postorder:.   
-00073b40: 2020 2020 2020 2020 202f 2f20 2020 646f           //   do
-00073b50: 745f 7374 315f 6473 7431 203a 3d20 646f  t_st1_dst1 := do
-00073b60: 7428 7374 312c 2067 7261 645b 7374 315d  t(st1, grad[st1]
-00073b70: 290a 2020 2020 2020 2020 2020 2020 2f2f  ).            //
-00073b80: 2020 2067 7261 645b 7330 5d20 3a3d 2067     grad[s0] := g
-00073b90: 7261 645b 7374 315d 0a20 2020 2020 2020  rad[st1].       
-00073ba0: 2020 2020 202f 2f20 2020 6772 6164 5b73       //   grad[s
-00073bb0: 305d 203a 3d20 6772 6164 5b73 305d 202d  0] := grad[s0] -
-00073bc0: 2064 6f74 5f73 7431 5f64 7374 310a 2020   dot_st1_dst1.  
-00073bd0: 2020 2020 2020 2020 2020 2f2f 2020 2067            //   g
-00073be0: 7261 645b 7330 5d20 3a3d 2067 7261 645b  rad[s0] := grad[
-00073bf0: 7330 5d20 2a20 7374 310a 0a20 2020 2020  s0] * st1..     
-00073c00: 2020 2020 2020 202f 2f20 7072 6570 656e         // prepen
-00073c10: 6420 706f 7374 6f72 6465 7220 6672 6f6d  d postorder from
-00073c20: 2067 7261 645b 7374 315d 2064 6972 6563   grad[st1] direc
-00073c30: 746c 7920 7573 696e 6720 6772 6164 5b73  tly using grad[s
-00073c40: 305d 2061 7320 6d65 6d6f 7279 206c 6f63  0] as memory loc
-00073c50: 6174 696f 6e2c 2061 7320 7765 2077 696c  ation, as we wil
-00073c60: 6c20 6772 6164 5b73 305d 203a 3d20 6772  l grad[s0] := gr
-00073c70: 6164 5b73 7431 5d0a 2020 2020 2020 2020  ad[st1].        
-00073c80: 2020 2020 2f2f 2073 6d20 2020 2020 2020      // sm       
-00073c90: 2020 2020 3a3d 2073 6f66 746d 6178 2873      := softmax(s
-00073ca0: 3029 0a20 2020 2020 2020 2020 2020 202f  0).            /
-00073cb0: 2f20 6772 6164 5b73 305d 2020 2020 203a  / grad[s0]     :
-00073cc0: 3d20 736d 2a28 312e 3020 2d20 6570 7329  = sm*(1.0 - eps)
-00073cd0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-00073ce0: 6772 6164 5b73 305d 2020 2020 203a 3d20  grad[s0]     := 
-00073cf0: 6772 6164 5b73 305d 202b 2065 7073 0a20  grad[s0] + eps. 
-00073d00: 2020 2020 2020 2020 2020 202f 2f20 6772             // gr
-00073d10: 6164 5b73 305d 2020 2020 203a 3d20 7331  ad[s0]     := s1
-00073d20: 202f 2067 7261 645b 7330 5d0a 2020 2020   / grad[s0].    
-00073d30: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
-00073d40: 7330 5d20 2020 2020 3a3d 2067 7261 645b  s0]     := grad[
-00073d50: 7330 5d2a 2831 2e30 2d65 7073 292a 2d67  s0]*(1.0-eps)*-g
-00073d60: 7261 645b 6365 6c5d 0a20 2020 2020 2020  rad[cel].       
-00073d70: 2020 2020 202f 2f20 646f 745f 7374 315f       // dot_st1_
-00073d80: 6473 7431 203a 3d20 646f 7428 736d 2c20  dst1 := dot(sm, 
-00073d90: 6772 6164 5b73 305d 290a 2020 2020 2020  grad[s0]).      
-00073da0: 2020 2020 2020 2f2f 2067 7261 645b 7330        // grad[s0
-00073db0: 5d20 2020 2020 3a3d 2067 7261 645b 7330  ]     := grad[s0
-00073dc0: 5d20 2d20 646f 745f 7374 315f 6473 7431  ] - dot_st1_dst1
-00073dd0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-00073de0: 6772 6164 5b73 305d 2020 2020 203a 3d20  grad[s0]     := 
-00073df0: 6772 6164 5b73 305d 202a 2073 6d0a 2020  grad[s0] * sm.  
-00073e00: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00073e10: 202f 2f20 736f 6674 5f6d 6178 0a20 2020   // soft_max.   
-00073e20: 2020 2020 2067 676d 6c5f 666c 6f61 7420       ggml_float 
-00073e30: 7375 6d20 3d20 302e 303b 0a20 2020 2020  sum = 0.0;.     
-00073e40: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00073e50: 2066 6c6f 6174 206d 6178 203d 202d 494e   float max = -IN
-00073e60: 4649 4e49 5459 3b0a 2020 2020 2020 2020  FINITY;.        
-00073e70: 2020 2020 6767 6d6c 5f76 6563 5f6d 6178      ggml_vec_max
-00073e80: 5f66 3332 286e 632c 2026 6d61 782c 2073  _f32(nc, &max, s
-00073e90: 3029 3b0a 0a20 2020 2020 2020 2020 2020  0);..           
-00073ea0: 2075 696e 7431 365f 7420 7363 7674 3b0a   uint16_t scvt;.
-00073eb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00073ec0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00073ed0: 6e63 3b20 692b 2b29 207b 0a20 2020 2020  nc; i++) {.     
-00073ee0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-00073ef0: 305b 695d 203d 3d20 2d49 4e46 494e 4954  0[i] == -INFINIT
-00073f00: 5929 207b 0a20 2020 2020 2020 2020 2020  Y) {.           
-00073f10: 2020 2020 2020 2020 2073 6d5b 695d 203d           sm[i] =
-00073f20: 2030 2e30 663b 0a20 2020 2020 2020 2020   0.0f;.         
-00073f30: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-00073f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073f50: 2020 2020 2f2f 2063 6f6e 7374 2066 6c6f      // const flo
-00073f60: 6174 2076 616c 203d 2028 7330 5b69 5d20  at val = (s0[i] 
-00073f70: 3d3d 202d 494e 4649 4e49 5459 2920 3f20  == -INFINITY) ? 
-00073f80: 302e 3020 3a20 6578 7028 7330 5b69 5d20  0.0 : exp(s0[i] 
-00073f90: 2d20 6d61 7829 3b0a 2020 2020 2020 2020  - max);.        
-00073fa0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00073fb0: 5f66 7031 365f 7420 7320 3d20 4747 4d4c  _fp16_t s = GGML
-00073fc0: 5f46 5033 325f 544f 5f46 5031 3628 7330  _FP32_TO_FP16(s0
-00073fd0: 5b69 5d20 2d20 6d61 7829 3b0a 2020 2020  [i] - max);.    
-00073fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00073ff0: 6d65 6d63 7079 2826 7363 7674 2c20 2673  memcpy(&scvt, &s
-00074000: 2c20 7369 7a65 6f66 2873 6376 7429 293b  , sizeof(scvt));
-00074010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00074020: 2020 2020 2063 6f6e 7374 2066 6c6f 6174       const float
-00074030: 2076 616c 203d 2047 474d 4c5f 4650 3136   val = GGML_FP16
-00074040: 5f54 4f5f 4650 3332 2874 6162 6c65 5f65  _TO_FP32(table_e
-00074050: 7870 5f66 3136 5b73 6376 745d 293b 0a20  xp_f16[scvt]);. 
-00074060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074070: 2020 2073 756d 202b 3d20 2867 676d 6c5f     sum += (ggml_
-00074080: 666c 6f61 7429 7661 6c3b 0a20 2020 2020  float)val;.     
-00074090: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000740a0: 6d5b 695d 203d 2076 616c 3b0a 2020 2020  m[i] = val;.    
-000740b0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000740c0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-000740d0: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-000740e0: 7375 6d20 3e20 302e 3029 3b0a 2020 2020  sum > 0.0);.    
-000740f0: 2020 2020 2020 2020 7375 6d20 3d20 312e          sum = 1.
-00074100: 302f 7375 6d3b 0a20 2020 2020 2020 207d  0/sum;.        }
-00074110: 0a0a 2020 2020 2020 2020 666c 6f61 7420  ..        float 
-00074120: 646f 745f 7374 315f 6473 7431 203d 2030  dot_st1_dst1 = 0
-00074130: 3b0a 2020 2020 2020 2020 6767 6d6c 5f76  ;.        ggml_v
-00074140: 6563 5f73 6361 6c65 5f66 3332 286e 632c  ec_scale_f32(nc,
-00074150: 2073 6d2c 2073 756d 293b 0a20 2020 2020   sm, sum);.     
-00074160: 2020 2067 676d 6c5f 7665 635f 6370 795f     ggml_vec_cpy_
-00074170: 6633 3220 2028 6e63 2c20 6473 302c 2073  f32  (nc, ds0, s
-00074180: 6d29 3b0a 2020 2020 2020 2020 6767 6d6c  m);.        ggml
-00074190: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
-000741a0: 632c 2064 7330 2c20 2831 2e30 6620 2d20  c, ds0, (1.0f - 
-000741b0: 6570 7329 293b 0a20 2020 2020 2020 2067  eps));.        g
-000741c0: 676d 6c5f 7665 635f 6164 6431 5f66 3332  gml_vec_add1_f32
-000741d0: 2028 6e63 2c20 6473 302c 2064 7330 2c20   (nc, ds0, ds0, 
-000741e0: 6570 7329 3b0a 2020 2020 2020 2020 6767  eps);.        gg
-000741f0: 6d6c 5f76 6563 5f64 6976 5f66 3332 2020  ml_vec_div_f32  
-00074200: 286e 632c 2064 7330 2c20 7331 2c20 6473  (nc, ds0, s1, ds
-00074210: 3029 3b0a 2020 2020 2020 2020 6767 6d6c  0);.        ggml
-00074220: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
-00074230: 632c 2064 7330 2c20 2d28 312e 3066 202d  c, ds0, -(1.0f -
-00074240: 2065 7073 292a 645b 305d 293b 0a20 2020   eps)*d[0]);.   
-00074250: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
-00074260: 745f 6633 3220 2028 6e63 2c20 2664 6f74  t_f32  (nc, &dot
-00074270: 5f73 7431 5f64 7374 312c 2073 6d2c 2064  _st1_dst1, sm, d
-00074280: 7330 293b 0a20 2020 2020 2020 2067 676d  s0);.        ggm
-00074290: 6c5f 7665 635f 6163 6331 5f66 3332 2028  l_vec_acc1_f32 (
-000742a0: 6e63 2c20 6473 302c 202d 646f 745f 7374  nc, ds0, -dot_st
-000742b0: 315f 6473 7431 293b 0a20 2020 2020 2020  1_dst1);.       
-000742c0: 2067 676d 6c5f 7665 635f 6d75 6c5f 6633   ggml_vec_mul_f3
-000742d0: 3220 2028 6e63 2c20 6473 302c 2064 7330  2  (nc, ds0, ds0
-000742e0: 2c20 736d 293b 0a0a 2369 666e 6465 6620  , sm);..#ifndef 
-000742f0: 4e44 4542 5547 0a20 2020 2020 2020 2066  NDEBUG.        f
-00074300: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-00074310: 203c 206e 633b 202b 2b69 2920 7b0a 2020   < nc; ++i) {.  
-00074320: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00074330: 2821 6973 6e61 6e28 736d 5b69 5d29 293b  (!isnan(sm[i]));
-00074340: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00074350: 6572 7428 2169 7369 6e66 2873 6d5b 695d  ert(!isinf(sm[i]
-00074360: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
-00074370: 6173 7365 7274 2821 6973 6e61 6e28 6473  assert(!isnan(ds
-00074380: 305b 695d 2929 3b0a 2020 2020 2020 2020  0[i]));.        
-00074390: 2020 2020 6173 7365 7274 2821 6973 696e      assert(!isin
-000743a0: 6628 6473 305b 695d 2929 3b0a 2020 2020  f(ds0[i]));.    
-000743b0: 2020 2020 7d0a 2365 6e64 6966 0a20 2020      }.#endif.   
-000743c0: 207d 0a7d 0a0a 7374 6174 6963 2076 6f69   }.}..static voi
-000743d0: 6420 6767 6d6c 5f63 6f6d 7075 7465 5f66  d ggml_compute_f
-000743e0: 6f72 7761 7264 5f63 726f 7373 5f65 6e74  orward_cross_ent
-000743f0: 726f 7079 5f6c 6f73 735f 6261 636b 280a  ropy_loss_back(.
-00074400: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
-00074410: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00074420: 655f 7061 7261 6d73 202a 2070 6172 616d  e_params * param
-00074430: 732c 0a20 2020 2020 2020 2063 6f6e 7374  s,.        const
-00074440: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00074450: 736f 7220 2a20 7372 6330 2c0a 2020 2020  sor * src0,.    
-00074460: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-00074470: 2067 676d 6c5f 7465 6e73 6f72 202a 2073   ggml_tensor * s
-00074480: 7263 312c 0a20 2020 2020 2020 2063 6f6e  rc1,.        con
-00074490: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
-000744a0: 656e 736f 7220 2a20 6f70 7430 2c0a 2020  ensor * opt0,.  
-000744b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-000744c0: 6c5f 7465 6e73 6f72 202a 2064 7374 2920  l_tensor * dst) 
-000744d0: 7b0a 2020 2020 7377 6974 6368 2028 7372  {.    switch (sr
-000744e0: 6330 2d3e 7479 7065 2920 7b0a 2020 2020  c0->type) {.    
-000744f0: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
-00074500: 5045 5f46 3332 3a0a 2020 2020 2020 2020  PE_F32:.        
-00074510: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00074520: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
-00074530: 7465 5f66 6f72 7761 7264 5f63 726f 7373  te_forward_cross
-00074540: 5f65 6e74 726f 7079 5f6c 6f73 735f 6261  _entropy_loss_ba
-00074550: 636b 5f66 3332 2870 6172 616d 732c 2073  ck_f32(params, s
-00074560: 7263 302c 2073 7263 312c 206f 7074 302c  rc0, src1, opt0,
-00074570: 2064 7374 293b 0a20 2020 2020 2020 2020   dst);.         
-00074580: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00074590: 2020 2020 6465 6661 756c 743a 0a20 2020      default:.   
-000745a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000745b0: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
-000745c0: 4153 5345 5254 2866 616c 7365 293b 0a20  ASSERT(false);. 
-000745d0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000745e0: 616b 3b0a 2020 2020 7d0a 7d0a 0a0a 2f2f  ak;.    }.}...//
-000745f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00074600: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
-00074610: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-00074620: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00074630: 6428 7374 7275 6374 2067 676d 6c5f 636f  d(struct ggml_co
-00074640: 6d70 7574 655f 7061 7261 6d73 202a 2070  mpute_params * p
-00074650: 6172 616d 732c 2073 7472 7563 7420 6767  arams, struct gg
-00074660: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
-00074670: 6f72 2920 7b0a 2020 2020 4747 4d4c 5f41  or) {.    GGML_A
-00074680: 5353 4552 5428 7061 7261 6d73 293b 0a0a  SSERT(params);..
-00074690: 2369 6664 6566 2047 474d 4c5f 5553 455f  #ifdef GGML_USE_
-000746a0: 4355 424c 4153 0a20 2020 2062 6f6f 6c20  CUBLAS.    bool 
-000746b0: 736b 6970 5f63 7075 203d 2067 676d 6c5f  skip_cpu = ggml_
-000746c0: 6375 6461 5f63 6f6d 7075 7465 5f66 6f72  cuda_compute_for
-000746d0: 7761 7264 2870 6172 616d 732c 2074 656e  ward(params, ten
-000746e0: 736f 7229 3b0a 2020 2020 6966 2028 736b  sor);.    if (sk
-000746f0: 6970 5f63 7075 2920 7b0a 2020 2020 2020  ip_cpu) {.      
-00074700: 2020 7265 7475 726e 3b0a 2020 2020 7d0a    return;.    }.
-00074710: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00074720: 7465 6e73 6f72 2d3e 7372 635b 305d 203d  tensor->src[0] =
-00074730: 3d20 4e55 4c4c 207c 7c20 7465 6e73 6f72  = NULL || tensor
-00074740: 2d3e 7372 635b 305d 2d3e 6261 636b 656e  ->src[0]->backen
-00074750: 6420 3d3d 2047 474d 4c5f 4241 434b 454e  d == GGML_BACKEN
-00074760: 445f 4350 5529 3b0a 2020 2020 4747 4d4c  D_CPU);.    GGML
-00074770: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
-00074780: 7372 635b 315d 203d 3d20 4e55 4c4c 207c  src[1] == NULL |
-00074790: 7c20 7465 6e73 6f72 2d3e 7372 635b 315d  | tensor->src[1]
-000747a0: 2d3e 6261 636b 656e 6420 3d3d 2047 474d  ->backend == GGM
-000747b0: 4c5f 4241 434b 454e 445f 4350 5529 3b0a  L_BACKEND_CPU);.
-000747c0: 2365 6e64 6966 202f 2f20 4747 4d4c 5f55  #endif // GGML_U
-000747d0: 5345 5f43 5542 4c41 530a 0a20 2020 2073  SE_CUBLAS..    s
-000747e0: 7769 7463 6820 2874 656e 736f 722d 3e6f  witch (tensor->o
-000747f0: 7029 207b 0a20 2020 2020 2020 2063 6173  p) {.        cas
-00074800: 6520 4747 4d4c 5f4f 505f 4455 503a 0a20  e GGML_OP_DUP:. 
-00074810: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00074820: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00074830: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00074840: 645f 6475 7028 7061 7261 6d73 2c20 7465  d_dup(params, te
-00074850: 6e73 6f72 2d3e 7372 635b 305d 2c20 7465  nsor->src[0], te
-00074860: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00074870: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00074880: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00074890: 5f41 4444 3a0a 2020 2020 2020 2020 2020  _ADD:.          
-000748a0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000748b0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-000748c0: 5f66 6f72 7761 7264 5f61 6464 2870 6172  _forward_add(par
-000748d0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-000748e0: 5b30 5d2c 2074 656e 736f 722d 3e73 7263  [0], tensor->src
-000748f0: 5b31 5d2c 2074 656e 736f 7229 3b0a 2020  [1], tensor);.  
-00074900: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00074910: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00074920: 4747 4d4c 5f4f 505f 4144 4431 3a0a 2020  GGML_OP_ADD1:.  
-00074930: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00074940: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00074950: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00074960: 5f61 6464 3128 7061 7261 6d73 2c20 7465  _add1(params, te
-00074970: 6e73 6f72 2d3e 7372 635b 305d 2c20 7465  nsor->src[0], te
-00074980: 6e73 6f72 2d3e 7372 635b 315d 2c20 7465  nsor->src[1], te
-00074990: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-000749a0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000749b0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000749c0: 5f41 4343 3a0a 2020 2020 2020 2020 2020  _ACC:.          
-000749d0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000749e0: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
-000749f0: 5f66 6f72 7761 7264 5f61 6363 2870 6172  _forward_acc(par
-00074a00: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00074a10: 5b30 5d2c 2074 656e 736f 722d 3e73 7263  [0], tensor->src
-00074a20: 5b31 5d2c 2074 656e 736f 722d 3e73 7263  [1], tensor->src
-00074a30: 5b32 5d2c 2074 656e 736f 7229 3b0a 2020  [2], tensor);.  
-00074a40: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00074a50: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00074a60: 4747 4d4c 5f4f 505f 5355 423a 0a20 2020  GGML_OP_SUB:.   
-00074a70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00074a80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00074a90: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00074aa0: 7375 6228 7061 7261 6d73 2c20 7465 6e73  sub(params, tens
-00074ab0: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
-00074ac0: 6f72 2d3e 7372 635b 315d 2c20 7465 6e73  or->src[1], tens
-00074ad0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00074ae0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00074af0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-00074b00: 554c 3a0a 2020 2020 2020 2020 2020 2020  UL:.            
-00074b10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00074b20: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-00074b30: 6f72 7761 7264 5f6d 756c 2870 6172 616d  orward_mul(param
-00074b40: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
-00074b50: 5d2c 2074 656e 736f 722d 3e73 7263 5b31  ], tensor->src[1
-00074b60: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
-00074b70: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00074b80: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00074b90: 4d4c 5f4f 505f 4449 563a 0a20 2020 2020  ML_OP_DIV:.     
-00074ba0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00074bb0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00074bc0: 6d70 7574 655f 666f 7277 6172 645f 6469  mpute_forward_di
-00074bd0: 7628 7061 7261 6d73 2c20 7465 6e73 6f72  v(params, tensor
-00074be0: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-00074bf0: 2d3e 7372 635b 315d 2c20 7465 6e73 6f72  ->src[1], tensor
-00074c00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00074c10: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00074c20: 6361 7365 2047 474d 4c5f 4f50 5f53 5152  case GGML_OP_SQR
-00074c30: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00074c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074c50: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00074c60: 7761 7264 5f73 7172 2870 6172 616d 732c  ward_sqr(params,
-00074c70: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
-00074c80: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00074c90: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00074ca0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00074cb0: 5f4f 505f 5351 5254 3a0a 2020 2020 2020  _OP_SQRT:.      
-00074cc0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00074cd0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00074ce0: 7075 7465 5f66 6f72 7761 7264 5f73 7172  pute_forward_sqr
-00074cf0: 7428 7061 7261 6d73 2c20 7465 6e73 6f72  t(params, tensor
-00074d00: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-00074d10: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00074d20: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00074d30: 6361 7365 2047 474d 4c5f 4f50 5f4c 4f47  case GGML_OP_LOG
-00074d40: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00074d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074d60: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00074d70: 7761 7264 5f6c 6f67 2870 6172 616d 732c  ward_log(params,
-00074d80: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
-00074d90: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00074da0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00074db0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00074dc0: 5f4f 505f 5355 4d3a 0a20 2020 2020 2020  _OP_SUM:.       
-00074dd0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00074de0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00074df0: 7574 655f 666f 7277 6172 645f 7375 6d28  ute_forward_sum(
-00074e00: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00074e10: 7372 635b 305d 2c20 7465 6e73 6f72 293b  src[0], tensor);
-00074e20: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00074e30: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00074e40: 7365 2047 474d 4c5f 4f50 5f53 554d 5f52  se GGML_OP_SUM_R
-00074e50: 4f57 533a 0a20 2020 2020 2020 2020 2020  OWS:.           
-00074e60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00074e70: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00074e80: 666f 7277 6172 645f 7375 6d5f 726f 7773  forward_sum_rows
-00074e90: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00074ea0: 3e73 7263 5b30 5d2c 2074 656e 736f 7229  >src[0], tensor)
-00074eb0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00074ec0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00074ed0: 6173 6520 4747 4d4c 5f4f 505f 4d45 414e  ase GGML_OP_MEAN
-00074ee0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00074ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00074f00: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00074f10: 7761 7264 5f6d 6561 6e28 7061 7261 6d73  ward_mean(params
-00074f20: 2c20 7465 6e73 6f72 2d3e 7372 635b 305d  , tensor->src[0]
-00074f30: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00074f40: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00074f50: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00074f60: 4c5f 4f50 5f41 5247 4d41 583a 0a20 2020  L_OP_ARGMAX:.   
-00074f70: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00074f80: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00074f90: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00074fa0: 6172 676d 6178 2870 6172 616d 732c 2074  argmax(params, t
-00074fb0: 656e 736f 722d 3e73 7263 5b30 5d2c 2074  ensor->src[0], t
-00074fc0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00074fd0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00074fe0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00074ff0: 505f 5245 5045 4154 3a0a 2020 2020 2020  P_REPEAT:.      
-00075000: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00075010: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00075020: 7075 7465 5f66 6f72 7761 7264 5f72 6570  pute_forward_rep
-00075030: 6561 7428 7061 7261 6d73 2c20 7465 6e73  eat(params, tens
-00075040: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
-00075050: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
-00075060: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00075070: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-00075080: 4550 4541 545f 4241 434b 3a0a 2020 2020  EPEAT_BACK:.    
-00075090: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000750a0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-000750b0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
-000750c0: 6570 6561 745f 6261 636b 2870 6172 616d  epeat_back(param
-000750d0: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
-000750e0: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
-000750f0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00075100: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00075110: 4d4c 5f4f 505f 4142 533a 0a20 2020 2020  ML_OP_ABS:.     
-00075120: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00075130: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00075140: 6d70 7574 655f 666f 7277 6172 645f 6162  mpute_forward_ab
-00075150: 7328 7061 7261 6d73 2c20 7465 6e73 6f72  s(params, tensor
-00075160: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-00075170: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00075180: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00075190: 6361 7365 2047 474d 4c5f 4f50 5f53 474e  case GGML_OP_SGN
-000751a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000751b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000751c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000751d0: 7761 7264 5f73 676e 2870 6172 616d 732c  ward_sgn(params,
-000751e0: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
-000751f0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00075200: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00075210: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00075220: 5f4f 505f 4e45 473a 0a20 2020 2020 2020  _OP_NEG:.       
-00075230: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00075240: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
-00075250: 7574 655f 666f 7277 6172 645f 6e65 6728  ute_forward_neg(
-00075260: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00075270: 7372 635b 305d 2c20 7465 6e73 6f72 293b  src[0], tensor);
-00075280: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00075290: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-000752a0: 7365 2047 474d 4c5f 4f50 5f53 5445 503a  se GGML_OP_STEP:
-000752b0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-000752c0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000752d0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000752e0: 6172 645f 7374 6570 2870 6172 616d 732c  ard_step(params,
-000752f0: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
-00075300: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00075310: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00075320: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00075330: 5f4f 505f 5441 4e48 3a0a 2020 2020 2020  _OP_TANH:.      
-00075340: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00075350: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00075360: 7075 7465 5f66 6f72 7761 7264 5f74 616e  pute_forward_tan
-00075370: 6828 7061 7261 6d73 2c20 7465 6e73 6f72  h(params, tensor
-00075380: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-00075390: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000753a0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000753b0: 6361 7365 2047 474d 4c5f 4f50 5f45 4c55  case GGML_OP_ELU
-000753c0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000753d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000753e0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-000753f0: 7761 7264 5f65 6c75 2870 6172 616d 732c  ward_elu(params,
-00075400: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
-00075410: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00075420: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00075430: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00075440: 5f4f 505f 5245 4c55 3a0a 2020 2020 2020  _OP_RELU:.      
-00075450: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00075460: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00075470: 7075 7465 5f66 6f72 7761 7264 5f72 656c  pute_forward_rel
-00075480: 7528 7061 7261 6d73 2c20 7465 6e73 6f72  u(params, tensor
-00075490: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-000754a0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000754b0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000754c0: 6361 7365 2047 474d 4c5f 4f50 5f47 454c  case GGML_OP_GEL
-000754d0: 553a 0a20 2020 2020 2020 2020 2020 207b  U:.            {
-000754e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000754f0: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00075500: 7277 6172 645f 6765 6c75 2870 6172 616d  rward_gelu(param
-00075510: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
-00075520: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
-00075530: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00075540: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00075550: 4d4c 5f4f 505f 4745 4c55 5f51 5549 434b  ML_OP_GELU_QUICK
-00075560: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00075570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00075580: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00075590: 7761 7264 5f67 656c 755f 7175 6963 6b28  ward_gelu_quick(
-000755a0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-000755b0: 7372 635b 305d 2c20 7465 6e73 6f72 293b  src[0], tensor);
-000755c0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-000755d0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-000755e0: 7365 2047 474d 4c5f 4f50 5f53 494c 553a  se GGML_OP_SILU:
-000755f0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00075600: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00075610: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-00075620: 6172 645f 7369 6c75 2870 6172 616d 732c  ard_silu(params,
-00075630: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
-00075640: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
-00075650: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00075660: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00075670: 5f4f 505f 5349 4c55 5f42 4143 4b3a 0a20  _OP_SILU_BACK:. 
-00075680: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00075690: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000756a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000756b0: 645f 7369 6c75 5f62 6163 6b28 7061 7261  d_silu_back(para
-000756c0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
-000756d0: 305d 2c20 7465 6e73 6f72 2d3e 7372 635b  0], tensor->src[
-000756e0: 315d 2c20 7465 6e73 6f72 293b 0a20 2020  1], tensor);.   
-000756f0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00075700: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00075710: 474d 4c5f 4f50 5f4e 4f52 4d3a 0a20 2020  GML_OP_NORM:.   
-00075720: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00075730: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00075740: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-00075750: 6e6f 726d 2870 6172 616d 732c 2074 656e  norm(params, ten
-00075760: 736f 722d 3e73 7263 5b30 5d2c 2074 656e  sor->src[0], ten
-00075770: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00075780: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00075790: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000757a0: 524d 535f 4e4f 524d 3a0a 2020 2020 2020  RMS_NORM:.      
-000757b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000757c0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-000757d0: 7075 7465 5f66 6f72 7761 7264 5f72 6d73  pute_forward_rms
-000757e0: 5f6e 6f72 6d28 7061 7261 6d73 2c20 7465  _norm(params, te
-000757f0: 6e73 6f72 2d3e 7372 635b 305d 2c20 7465  nsor->src[0], te
-00075800: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00075810: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00075820: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00075830: 5f52 4d53 5f4e 4f52 4d5f 4241 434b 3a0a  _RMS_NORM_BACK:.
-00075840: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00075850: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00075860: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00075870: 7264 5f72 6d73 5f6e 6f72 6d5f 6261 636b  rd_rms_norm_back
-00075880: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00075890: 3e73 7263 5b30 5d2c 2074 656e 736f 722d  >src[0], tensor-
-000758a0: 3e73 7263 5b31 5d2c 2074 656e 736f 7229  >src[1], tensor)
-000758b0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000758c0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000758d0: 6173 6520 4747 4d4c 5f4f 505f 4d55 4c5f  ase GGML_OP_MUL_
-000758e0: 4d41 543a 0a20 2020 2020 2020 2020 2020  MAT:.           
-000758f0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00075900: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00075910: 666f 7277 6172 645f 6d75 6c5f 6d61 7428  forward_mul_mat(
-00075920: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00075930: 7372 635b 305d 2c20 7465 6e73 6f72 2d3e  src[0], tensor->
-00075940: 7372 635b 315d 2c20 7465 6e73 6f72 293b  src[1], tensor);
-00075950: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00075960: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00075970: 7365 2047 474d 4c5f 4f50 5f4f 5554 5f50  se GGML_OP_OUT_P
-00075980: 524f 443a 0a20 2020 2020 2020 2020 2020  ROD:.           
-00075990: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000759a0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-000759b0: 666f 7277 6172 645f 6f75 745f 7072 6f64  forward_out_prod
-000759c0: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-000759d0: 3e73 7263 5b30 5d2c 2074 656e 736f 722d  >src[0], tensor-
-000759e0: 3e73 7263 5b31 5d2c 2074 656e 736f 7229  >src[1], tensor)
-000759f0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00075a00: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00075a10: 6173 6520 4747 4d4c 5f4f 505f 5343 414c  ase GGML_OP_SCAL
-00075a20: 453a 0a20 2020 2020 2020 2020 2020 207b  E:.            {
-00075a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075a40: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00075a50: 7277 6172 645f 7363 616c 6528 7061 7261  rward_scale(para
-00075a60: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
-00075a70: 305d 2c20 7465 6e73 6f72 2d3e 7372 635b  0], tensor->src[
-00075a80: 315d 2c20 7465 6e73 6f72 293b 0a20 2020  1], tensor);.   
-00075a90: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00075aa0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00075ab0: 474d 4c5f 4f50 5f53 4554 3a0a 2020 2020  GML_OP_SET:.    
-00075ac0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00075ad0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00075ae0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
-00075af0: 6574 2870 6172 616d 732c 2074 656e 736f  et(params, tenso
-00075b00: 722d 3e73 7263 5b30 5d2c 2074 656e 736f  r->src[0], tenso
-00075b10: 722d 3e73 7263 5b31 5d2c 2074 656e 736f  r->src[1], tenso
-00075b20: 722d 3e73 7263 5b32 5d2c 2074 656e 736f  r->src[2], tenso
-00075b30: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00075b40: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00075b50: 2063 6173 6520 4747 4d4c 5f4f 505f 4350   case GGML_OP_CP
-00075b60: 593a 0a20 2020 2020 2020 2020 2020 207b  Y:.            {
-00075b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075b80: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00075b90: 7277 6172 645f 6370 7928 7061 7261 6d73  rward_cpy(params
-00075ba0: 2c20 7465 6e73 6f72 2d3e 7372 635b 305d  , tensor->src[0]
-00075bb0: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00075bc0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00075bd0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00075be0: 4c5f 4f50 5f43 4f4e 543a 0a20 2020 2020  L_OP_CONT:.     
-00075bf0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00075c00: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00075c10: 6d70 7574 655f 666f 7277 6172 645f 636f  mpute_forward_co
-00075c20: 6e74 2870 6172 616d 732c 2074 656e 736f  nt(params, tenso
-00075c30: 722d 3e73 7263 5b30 5d2c 2074 656e 736f  r->src[0], tenso
-00075c40: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00075c50: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00075c60: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
-00075c70: 5348 4150 453a 0a20 2020 2020 2020 2020  SHAPE:.         
-00075c80: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00075c90: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00075ca0: 655f 666f 7277 6172 645f 7265 7368 6170  e_forward_reshap
-00075cb0: 6528 7061 7261 6d73 2c20 7465 6e73 6f72  e(params, tensor
-00075cc0: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-00075cd0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00075ce0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00075cf0: 6361 7365 2047 474d 4c5f 4f50 5f56 4945  case GGML_OP_VIE
-00075d00: 573a 0a20 2020 2020 2020 2020 2020 207b  W:.            {
-00075d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00075d20: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00075d30: 7277 6172 645f 7669 6577 2870 6172 616d  rward_view(param
-00075d40: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
-00075d50: 5d29 3b0a 2020 2020 2020 2020 2020 2020  ]);.            
-00075d60: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00075d70: 2063 6173 6520 4747 4d4c 5f4f 505f 5045   case GGML_OP_PE
-00075d80: 524d 5554 453a 0a20 2020 2020 2020 2020  RMUTE:.         
-00075d90: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00075da0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00075db0: 655f 666f 7277 6172 645f 7065 726d 7574  e_forward_permut
-00075dc0: 6528 7061 7261 6d73 2c20 7465 6e73 6f72  e(params, tensor
-00075dd0: 2d3e 7372 635b 305d 293b 0a20 2020 2020  ->src[0]);.     
-00075de0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00075df0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00075e00: 4c5f 4f50 5f54 5241 4e53 504f 5345 3a0a  L_OP_TRANSPOSE:.
-00075e10: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00075e20: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00075e30: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00075e40: 7264 5f74 7261 6e73 706f 7365 2870 6172  rd_transpose(par
-00075e50: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00075e60: 5b30 5d29 3b0a 2020 2020 2020 2020 2020  [0]);.          
-00075e70: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00075e80: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00075e90: 4745 545f 524f 5753 3a0a 2020 2020 2020  GET_ROWS:.      
-00075ea0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00075eb0: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00075ec0: 7075 7465 5f66 6f72 7761 7264 5f67 6574  pute_forward_get
-00075ed0: 5f72 6f77 7328 7061 7261 6d73 2c20 7465  _rows(params, te
-00075ee0: 6e73 6f72 2d3e 7372 635b 305d 2c20 7465  nsor->src[0], te
-00075ef0: 6e73 6f72 2d3e 7372 635b 315d 2c20 7465  nsor->src[1], te
-00075f00: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
-00075f10: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00075f20: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00075f30: 5f47 4554 5f52 4f57 535f 4241 434b 3a0a  _GET_ROWS_BACK:.
-00075f40: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00075f50: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00075f60: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00075f70: 7264 5f67 6574 5f72 6f77 735f 6261 636b  rd_get_rows_back
-00075f80: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
-00075f90: 3e73 7263 5b30 5d2c 2074 656e 736f 722d  >src[0], tensor-
-00075fa0: 3e73 7263 5b31 5d2c 2074 656e 736f 722d  >src[1], tensor-
-00075fb0: 3e73 7263 5b32 5d2c 2074 656e 736f 7229  >src[2], tensor)
-00075fc0: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00075fd0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00075fe0: 6173 6520 4747 4d4c 5f4f 505f 4449 4147  ase GGML_OP_DIAG
-00075ff0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00076000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076010: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00076020: 7761 7264 5f64 6961 6728 7061 7261 6d73  ward_diag(params
-00076030: 2c20 7465 6e73 6f72 2d3e 7372 635b 305d  , tensor->src[0]
-00076040: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00076050: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00076060: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00076070: 4c5f 4f50 5f44 4941 475f 4d41 534b 5f49  L_OP_DIAG_MASK_I
-00076080: 4e46 3a0a 2020 2020 2020 2020 2020 2020  NF:.            
-00076090: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000760a0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-000760b0: 6f72 7761 7264 5f64 6961 675f 6d61 736b  orward_diag_mask
-000760c0: 5f69 6e66 2870 6172 616d 732c 2074 656e  _inf(params, ten
-000760d0: 736f 722d 3e73 7263 5b30 5d2c 2074 656e  sor->src[0], ten
-000760e0: 736f 722d 3e73 7263 5b31 5d2c 2074 656e  sor->src[1], ten
-000760f0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-00076100: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00076110: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00076120: 4449 4147 5f4d 4153 4b5f 5a45 524f 3a0a  DIAG_MASK_ZERO:.
-00076130: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00076140: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00076150: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00076160: 7264 5f64 6961 675f 6d61 736b 5f7a 6572  rd_diag_mask_zer
-00076170: 6f28 7061 7261 6d73 2c20 7465 6e73 6f72  o(params, tensor
-00076180: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-00076190: 2d3e 7372 635b 315d 2c20 7465 6e73 6f72  ->src[1], tensor
-000761a0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-000761b0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000761c0: 6361 7365 2047 474d 4c5f 4f50 5f53 4f46  case GGML_OP_SOF
-000761d0: 545f 4d41 583a 0a20 2020 2020 2020 2020  T_MAX:.         
-000761e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000761f0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00076200: 655f 666f 7277 6172 645f 736f 6674 5f6d  e_forward_soft_m
-00076210: 6178 2870 6172 616d 732c 2074 656e 736f  ax(params, tenso
-00076220: 722d 3e73 7263 5b30 5d2c 2074 656e 736f  r->src[0], tenso
-00076230: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-00076240: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00076250: 2063 6173 6520 4747 4d4c 5f4f 505f 534f   case GGML_OP_SO
-00076260: 4654 5f4d 4158 5f42 4143 4b3a 0a20 2020  FT_MAX_BACK:.   
-00076270: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00076280: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00076290: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000762a0: 736f 6674 5f6d 6178 5f62 6163 6b28 7061  soft_max_back(pa
-000762b0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-000762c0: 635b 305d 2c20 7465 6e73 6f72 2d3e 7372  c[0], tensor->sr
-000762d0: 635b 315d 2c20 7465 6e73 6f72 293b 0a20  c[1], tensor);. 
-000762e0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000762f0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00076300: 2047 474d 4c5f 4f50 5f52 4f50 453a 0a20   GGML_OP_ROPE:. 
-00076310: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00076320: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00076330: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00076340: 645f 726f 7065 2870 6172 616d 732c 2074  d_rope(params, t
-00076350: 656e 736f 722d 3e73 7263 5b30 5d2c 2074  ensor->src[0], t
-00076360: 656e 736f 722d 3e73 7263 5b31 5d2c 2074  ensor->src[1], t
-00076370: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00076380: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00076390: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000763a0: 505f 524f 5045 5f42 4143 4b3a 0a20 2020  P_ROPE_BACK:.   
-000763b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000763c0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000763d0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000763e0: 726f 7065 5f62 6163 6b28 7061 7261 6d73  rope_back(params
-000763f0: 2c20 7465 6e73 6f72 2d3e 7372 635b 305d  , tensor->src[0]
-00076400: 2c20 7465 6e73 6f72 2d3e 7372 635b 315d  , tensor->src[1]
-00076410: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00076420: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00076430: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00076440: 4c5f 4f50 5f41 4c49 4249 3a0a 2020 2020  L_OP_ALIBI:.    
-00076450: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00076460: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00076470: 6f6d 7075 7465 5f66 6f72 7761 7264 5f61  ompute_forward_a
-00076480: 6c69 6269 2870 6172 616d 732c 2074 656e  libi(params, ten
-00076490: 736f 722d 3e73 7263 5b30 5d2c 2074 656e  sor->src[0], ten
-000764a0: 736f 722d 3e73 7263 5b31 5d2c 2074 656e  sor->src[1], ten
-000764b0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
-000764c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000764d0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000764e0: 434c 414d 503a 0a20 2020 2020 2020 2020  CLAMP:.         
-000764f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00076500: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
-00076510: 655f 666f 7277 6172 645f 636c 616d 7028  e_forward_clamp(
-00076520: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00076530: 7372 635b 305d 2c20 7465 6e73 6f72 2d3e  src[0], tensor->
-00076540: 7372 635b 315d 2c20 7465 6e73 6f72 293b  src[1], tensor);
-00076550: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00076560: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00076570: 7365 2047 474d 4c5f 4f50 5f43 4f4e 565f  se GGML_OP_CONV_
-00076580: 3144 3a0a 2020 2020 2020 2020 2020 2020  1D:.            
-00076590: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000765a0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-000765b0: 6f72 7761 7264 5f63 6f6e 765f 3164 2870  orward_conv_1d(p
-000765c0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-000765d0: 7263 5b30 5d2c 2074 656e 736f 722d 3e73  rc[0], tensor->s
-000765e0: 7263 5b31 5d2c 2074 656e 736f 722d 3e73  rc[1], tensor->s
-000765f0: 7263 5b32 5d2c 2074 656e 736f 7229 3b0a  rc[2], tensor);.
-00076600: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00076610: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00076620: 6520 4747 4d4c 5f4f 505f 434f 4e56 5f32  e GGML_OP_CONV_2
-00076630: 443a 0a20 2020 2020 2020 2020 2020 207b  D:.            {
-00076640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076650: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00076660: 7277 6172 645f 636f 6e76 5f32 6428 7061  rward_conv_2d(pa
-00076670: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
-00076680: 635b 305d 2c20 7465 6e73 6f72 2d3e 7372  c[0], tensor->sr
-00076690: 635b 315d 2c20 7465 6e73 6f72 2d3e 7372  c[1], tensor->sr
-000766a0: 635b 325d 2c20 7465 6e73 6f72 293b 0a20  c[2], tensor);. 
-000766b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-000766c0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-000766d0: 2047 474d 4c5f 4f50 5f50 4f4f 4c5f 3144   GGML_OP_POOL_1D
-000766e0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000766f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00076700: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00076710: 7761 7264 5f70 6f6f 6c5f 3164 2870 6172  ward_pool_1d(par
-00076720: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00076730: 5b30 5d2c 2074 656e 736f 722d 3e73 7263  [0], tensor->src
-00076740: 5b31 5d2c 2074 656e 736f 7229 3b0a 2020  [1], tensor);.  
-00076750: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00076760: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00076770: 4747 4d4c 5f4f 505f 504f 4f4c 5f32 443a  GGML_OP_POOL_2D:
-00076780: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00076790: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000767a0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000767b0: 6172 645f 706f 6f6c 5f32 6428 7061 7261  ard_pool_2d(para
-000767c0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
-000767d0: 305d 2c20 7465 6e73 6f72 2d3e 7372 635b  0], tensor->src[
-000767e0: 315d 2c20 7465 6e73 6f72 293b 0a20 2020  1], tensor);.   
-000767f0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00076800: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00076810: 474d 4c5f 4f50 5f46 4c41 5348 5f41 5454  GML_OP_FLASH_ATT
-00076820: 4e3a 0a20 2020 2020 2020 2020 2020 207b  N:.            {
-00076830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076840: 2063 6f6e 7374 2069 6e74 3332 5f74 2074   const int32_t t
-00076850: 203d 2067 676d 6c5f 6765 745f 6933 325f   = ggml_get_i32_
-00076860: 3164 2874 656e 736f 722d 3e73 7263 5b33  1d(tensor->src[3
-00076870: 5d2c 2030 293b 0a20 2020 2020 2020 2020  ], 0);.         
-00076880: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00076890: 5254 2874 203d 3d20 3020 7c7c 2074 203d  RT(t == 0 || t =
-000768a0: 3d20 3129 3b0a 2020 2020 2020 2020 2020  = 1);.          
-000768b0: 2020 2020 2020 636f 6e73 7420 626f 6f6c        const bool
-000768c0: 206d 6173 6b65 6420 3d20 7420 213d 2030   masked = t != 0
-000768d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000768e0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
-000768f0: 6f72 7761 7264 5f66 6c61 7368 5f61 7474  orward_flash_att
-00076900: 6e28 7061 7261 6d73 2c20 7465 6e73 6f72  n(params, tensor
-00076910: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-00076920: 2d3e 7372 635b 315d 2c20 7465 6e73 6f72  ->src[1], tensor
-00076930: 2d3e 7372 635b 325d 2c20 6d61 736b 6564  ->src[2], masked
-00076940: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
-00076950: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00076960: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00076970: 4c5f 4f50 5f46 4c41 5348 5f46 463a 0a20  L_OP_FLASH_FF:. 
-00076980: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00076990: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000769a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000769b0: 645f 666c 6173 685f 6666 2870 6172 616d  d_flash_ff(param
-000769c0: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
-000769d0: 5d2c 2074 656e 736f 722d 3e73 7263 5b31  ], tensor->src[1
-000769e0: 5d2c 2074 656e 736f 722d 3e73 7263 5b32  ], tensor->src[2
-000769f0: 5d2c 2074 656e 736f 722d 3e73 7263 5b33  ], tensor->src[3
-00076a00: 5d2c 2074 656e 736f 722d 3e73 7263 5b34  ], tensor->src[4
-00076a10: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
-00076a20: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-00076a30: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00076a40: 4d4c 5f4f 505f 464c 4153 485f 4154 544e  ML_OP_FLASH_ATTN
-00076a50: 5f42 4143 4b3a 0a20 2020 2020 2020 2020  _BACK:.         
-00076a60: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00076a70: 2020 2020 2069 6e74 3332 5f74 2074 203d       int32_t t =
-00076a80: 2067 676d 6c5f 6765 745f 6933 325f 3164   ggml_get_i32_1d
-00076a90: 2874 656e 736f 722d 3e73 7263 5b34 5d2c  (tensor->src[4],
-00076aa0: 2030 293b 0a20 2020 2020 2020 2020 2020   0);.           
-00076ab0: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00076ac0: 2874 203d 3d20 3020 7c7c 2074 203d 3d20  (t == 0 || t == 
-00076ad0: 3129 3b0a 2020 2020 2020 2020 2020 2020  1);.            
-00076ae0: 2020 2020 626f 6f6c 206d 6173 6b65 6420      bool masked 
-00076af0: 3d20 7420 213d 2030 3b0a 2020 2020 2020  = t != 0;.      
-00076b00: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00076b10: 6f6d 7075 7465 5f66 6f72 7761 7264 5f66  ompute_forward_f
-00076b20: 6c61 7368 5f61 7474 6e5f 6261 636b 2870  lash_attn_back(p
-00076b30: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
-00076b40: 7263 5b30 5d2c 2074 656e 736f 722d 3e73  rc[0], tensor->s
-00076b50: 7263 5b31 5d2c 2074 656e 736f 722d 3e73  rc[1], tensor->s
-00076b60: 7263 5b32 5d2c 2074 656e 736f 722d 3e73  rc[2], tensor->s
-00076b70: 7263 5b33 5d2c 206d 6173 6b65 642c 2074  rc[3], masked, t
-00076b80: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
-00076b90: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00076ba0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00076bb0: 505f 5749 4e5f 5041 5254 3a0a 2020 2020  P_WIN_PART:.    
-00076bc0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00076bd0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-00076be0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f77  ompute_forward_w
-00076bf0: 696e 5f70 6172 7428 7061 7261 6d73 2c20  in_part(params, 
-00076c00: 7465 6e73 6f72 2d3e 7372 635b 305d 2c20  tensor->src[0], 
-00076c10: 7465 6e73 6f72 2d3e 7372 635b 325d 2c20  tensor->src[2], 
-00076c20: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
-00076c30: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00076c40: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00076c50: 4f50 5f57 494e 5f55 4e50 4152 543a 0a20  OP_WIN_UNPART:. 
-00076c60: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00076c70: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00076c80: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-00076c90: 645f 7769 6e5f 756e 7061 7274 2870 6172  d_win_unpart(par
-00076ca0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-00076cb0: 5b30 5d2c 2074 656e 736f 722d 3e73 7263  [0], tensor->src
-00076cc0: 5b32 5d2c 2074 656e 736f 7229 3b0a 2020  [2], tensor);.  
-00076cd0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00076ce0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00076cf0: 4747 4d4c 5f4f 505f 4d41 505f 554e 4152  GGML_OP_MAP_UNAR
-00076d00: 593a 0a20 2020 2020 2020 2020 2020 207b  Y:.            {
-00076d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076d20: 2063 6f6e 7374 2067 676d 6c5f 756e 6172   const ggml_unar
-00076d30: 795f 6f70 5f66 3332 5f74 2066 756e 203d  y_op_f32_t fun =
-00076d40: 202a 2828 6767 6d6c 5f75 6e61 7279 5f6f   *((ggml_unary_o
-00076d50: 705f 6633 325f 7420 2a29 7465 6e73 6f72  p_f32_t *)tensor
-00076d60: 2d3e 7372 635b 325d 2d3e 6461 7461 293b  ->src[2]->data);
-00076d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00076d80: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
-00076d90: 7277 6172 645f 6d61 705f 756e 6172 7928  rward_map_unary(
-00076da0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-00076db0: 7372 635b 305d 2c20 7465 6e73 6f72 2c20  src[0], tensor, 
-00076dc0: 6675 6e29 3b0a 2020 2020 2020 2020 2020  fun);.          
-00076dd0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00076de0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00076df0: 6173 6520 4747 4d4c 5f4f 505f 4d41 505f  ase GGML_OP_MAP_
-00076e00: 4249 4e41 5259 3a0a 2020 2020 2020 2020  BINARY:.        
-00076e10: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00076e20: 2020 2020 2020 636f 6e73 7420 6767 6d6c        const ggml
-00076e30: 5f62 696e 6172 795f 6f70 5f66 3332 5f74  _binary_op_f32_t
-00076e40: 2066 756e 203d 202a 2828 6767 6d6c 5f62   fun = *((ggml_b
-00076e50: 696e 6172 795f 6f70 5f66 3332 5f74 202a  inary_op_f32_t *
-00076e60: 2974 656e 736f 722d 3e73 7263 5b32 5d2d  )tensor->src[2]-
-00076e70: 3e64 6174 6129 3b0a 2020 2020 2020 2020  >data);.        
-00076e80: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00076e90: 7075 7465 5f66 6f72 7761 7264 5f6d 6170  pute_forward_map
-00076ea0: 5f62 696e 6172 7928 7061 7261 6d73 2c20  _binary(params, 
-00076eb0: 7465 6e73 6f72 2d3e 7372 635b 305d 2c20  tensor->src[0], 
-00076ec0: 7465 6e73 6f72 2d3e 7372 635b 315d 2c20  tensor->src[1], 
-00076ed0: 7465 6e73 6f72 2c20 6675 6e29 3b0a 2020  tensor, fun);.  
-00076ee0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00076ef0: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-00076f00: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00076f10: 5f4f 505f 4d41 505f 4355 5354 4f4d 313a  _OP_MAP_CUSTOM1:
-00076f20: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00076f30: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00076f40: 6f6e 7374 2067 676d 6c5f 6375 7374 6f6d  onst ggml_custom
-00076f50: 315f 6f70 5f66 3332 5f74 2066 756e 203d  1_op_f32_t fun =
-00076f60: 202a 2828 6767 6d6c 5f63 7573 746f 6d31   *((ggml_custom1
-00076f70: 5f6f 705f 6633 325f 7420 2a29 7465 6e73  _op_f32_t *)tens
-00076f80: 6f72 2d3e 7372 635b 325d 2d3e 6461 7461  or->src[2]->data
-00076f90: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00076fa0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
-00076fb0: 666f 7277 6172 645f 6d61 705f 6375 7374  forward_map_cust
-00076fc0: 6f6d 3128 7061 7261 6d73 2c20 7465 6e73  om1(params, tens
-00076fd0: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
-00076fe0: 6f72 2c20 6675 6e29 3b0a 2020 2020 2020  or, fun);.      
-00076ff0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00077000: 2020 2020 6272 6561 6b3b 0a20 2020 2020      break;.     
-00077010: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00077020: 4d41 505f 4355 5354 4f4d 323a 0a20 2020  MAP_CUSTOM2:.   
-00077030: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00077040: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00077050: 2067 676d 6c5f 6375 7374 6f6d 325f 6f70   ggml_custom2_op
-00077060: 5f66 3332 5f74 2066 756e 203d 202a 2828  _f32_t fun = *((
-00077070: 6767 6d6c 5f63 7573 746f 6d32 5f6f 705f  ggml_custom2_op_
-00077080: 6633 325f 7420 2a29 7465 6e73 6f72 2d3e  f32_t *)tensor->
-00077090: 7372 635b 325d 2d3e 6461 7461 293b 0a20  src[2]->data);. 
-000770a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000770b0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
-000770c0: 6172 645f 6d61 705f 6375 7374 6f6d 3228  ard_map_custom2(
-000770d0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
-000770e0: 7372 635b 305d 2c20 7465 6e73 6f72 2d3e  src[0], tensor->
-000770f0: 7372 635b 315d 2c20 7465 6e73 6f72 2c20  src[1], tensor, 
-00077100: 6675 6e29 3b0a 2020 2020 2020 2020 2020  fun);.          
-00077110: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00077120: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00077130: 6173 6520 4747 4d4c 5f4f 505f 4d41 505f  ase GGML_OP_MAP_
-00077140: 4355 5354 4f4d 333a 0a20 2020 2020 2020  CUSTOM3:.       
-00077150: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00077160: 2020 2020 2020 2063 6f6e 7374 2067 676d         const ggm
-00077170: 6c5f 6375 7374 6f6d 335f 6f70 5f66 3332  l_custom3_op_f32
-00077180: 5f74 2066 756e 203d 202a 2828 6767 6d6c  _t fun = *((ggml
-00077190: 5f63 7573 746f 6d33 5f6f 705f 6633 325f  _custom3_op_f32_
-000771a0: 7420 2a29 7465 6e73 6f72 2d3e 7372 635b  t *)tensor->src[
-000771b0: 325d 2d3e 6461 7461 293b 0a20 2020 2020  2]->data);.     
-000771c0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000771d0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
-000771e0: 6d61 705f 6375 7374 6f6d 3328 7061 7261  map_custom3(para
-000771f0: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
-00077200: 305d 2c20 7465 6e73 6f72 2d3e 7372 635b  0], tensor->src[
-00077210: 315d 2c20 7465 6e73 6f72 2d3e 7372 635b  1], tensor->src[
-00077220: 335d 2c20 7465 6e73 6f72 2c20 6675 6e29  3], tensor, fun)
-00077230: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00077240: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00077250: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00077260: 4747 4d4c 5f4f 505f 4352 4f53 535f 454e  GGML_OP_CROSS_EN
-00077270: 5452 4f50 595f 4c4f 5353 3a0a 2020 2020  TROPY_LOSS:.    
-00077280: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00077290: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
-000772a0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f63  ompute_forward_c
-000772b0: 726f 7373 5f65 6e74 726f 7079 5f6c 6f73  ross_entropy_los
-000772c0: 7328 7061 7261 6d73 2c20 7465 6e73 6f72  s(params, tensor
-000772d0: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
-000772e0: 2d3e 7372 635b 315d 2c20 7465 6e73 6f72  ->src[1], tensor
-000772f0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00077300: 0a20 2020 2020 2020 2020 2020 2062 7265  .            bre
-00077310: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00077320: 2047 474d 4c5f 4f50 5f43 524f 5353 5f45   GGML_OP_CROSS_E
-00077330: 4e54 524f 5059 5f4c 4f53 535f 4241 434b  NTROPY_LOSS_BACK
-00077340: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00077350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077360: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00077370: 7761 7264 5f63 726f 7373 5f65 6e74 726f  ward_cross_entro
-00077380: 7079 5f6c 6f73 735f 6261 636b 2870 6172  py_loss_back(par
-00077390: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
-000773a0: 5b30 5d2c 2074 656e 736f 722d 3e73 7263  [0], tensor->src
-000773b0: 5b31 5d2c 2074 656e 736f 722d 3e73 7263  [1], tensor->src
-000773c0: 5b32 5d2c 2074 656e 736f 7229 3b0a 2020  [2], tensor);.  
-000773d0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000773e0: 2020 2020 2020 2020 6272 6561 6b3b 0a20          break;. 
-000773f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00077400: 5f4f 505f 4e4f 4e45 3a0a 2020 2020 2020  _OP_NONE:.      
-00077410: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00077420: 2020 2020 2020 2020 2f2f 206e 6f70 0a20          // nop. 
-00077430: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00077440: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00077450: 2047 474d 4c5f 4f50 5f43 4f55 4e54 3a0a   GGML_OP_COUNT:.
-00077460: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00077470: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00077480: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00077490: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-000774a0: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-000774b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000774c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000774d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000774e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000774f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00077500: 0a0a 7374 6174 6963 2076 6f69 6420 6767  ..static void gg
-00077510: 6d6c 5f63 6f6d 7075 7465 5f62 6163 6b77  ml_compute_backw
-00077520: 6172 6428 7374 7275 6374 2067 676d 6c5f  ard(struct ggml_
-00077530: 636f 6e74 6578 7420 2a20 6374 782c 2073  context * ctx, s
-00077540: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00077550: 7220 2a20 7465 6e73 6f72 2c20 626f 6f6c  r * tensor, bool
-00077560: 2069 6e70 6c61 6365 2920 7b0a 2020 2020   inplace) {.    
-00077570: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-00077580: 6f72 202a 2073 7263 3020 3d20 7465 6e73  or * src0 = tens
-00077590: 6f72 2d3e 7372 635b 305d 3b0a 2020 2020  or->src[0];.    
-000775a0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-000775b0: 6f72 202a 2073 7263 3120 3d20 7465 6e73  or * src1 = tens
-000775c0: 6f72 2d3e 7372 635b 315d 3b0a 0a20 2020  or->src[1];..   
-000775d0: 2073 7769 7463 6820 2874 656e 736f 722d   switch (tensor-
-000775e0: 3e6f 7029 207b 0a20 2020 2020 2020 2063  >op) {.        c
-000775f0: 6173 6520 4747 4d4c 5f4f 505f 4455 503a  ase GGML_OP_DUP:
-00077600: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00077610: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00077620: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-00077630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00077640: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-00077650: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
-00077660: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-00077670: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
-00077680: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-00077690: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000776a0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-000776b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-000776c0: 4c5f 4f50 5f41 4444 3a0a 2020 2020 2020  L_OP_ADD:.      
-000776d0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000776e0: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
-000776f0: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-00077700: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00077710: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
-00077720: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
-00077730: 6330 2d3e 6772 6164 2c20 7465 6e73 6f72  c0->grad, tensor
-00077740: 2d3e 6772 6164 2c20 696e 706c 6163 6529  ->grad, inplace)
-00077750: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00077760: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00077770: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
-00077780: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-00077790: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-000777a0: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
-000777b0: 696d 706c 2863 7478 2c20 7372 6331 2d3e  impl(ctx, src1->
-000777c0: 6772 6164 2c20 7465 6e73 6f72 2d3e 6772  grad, tensor->gr
-000777d0: 6164 2c20 696e 706c 6163 6529 3b0a 2020  ad, inplace);.  
-000777e0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-000777f0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00077800: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-00077810: 6520 4747 4d4c 5f4f 505f 4144 4431 3a0a  e GGML_OP_ADD1:.
-00077820: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00077830: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00077840: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-00077850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077860: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-00077870: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-00077880: 7478 2c20 7372 6330 2d3e 6772 6164 2c20  tx, src0->grad, 
-00077890: 7465 6e73 6f72 2d3e 6772 6164 2c20 696e  tensor->grad, in
-000778a0: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-000778b0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000778c0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000778d0: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
-000778e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000778f0: 7372 6331 2d3e 6772 6164 203d 2067 676d  src1->grad = ggm
-00077900: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
-00077910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077920: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-00077930: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-00077940: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00077950: 5f6d 6561 6e28 6374 782c 2074 656e 736f  _mean(ctx, tenso
-00077960: 722d 3e67 7261 6429 2c20 2f2f 2054 4f44  r->grad), // TOD
-00077970: 4f3a 2073 686f 756c 6420 7072 6f62 6162  O: should probab
-00077980: 6c79 2062 6520 7375 6d20 696e 7374 6561  ly be sum instea
-00077990: 6420 6f66 206d 6561 6e0a 2020 2020 2020  d of mean.      
-000779a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000779b0: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-000779c0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-000779d0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000779e0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000779f0: 4747 4d4c 5f4f 505f 4143 433a 0a20 2020  GGML_OP_ACC:.   
-00077a00: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00077a10: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-00077a20: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-00077a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077a40: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
-00077a50: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-00077a60: 2073 7263 302d 3e67 7261 642c 2074 656e   src0->grad, ten
-00077a70: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
-00077a80: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00077a90: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00077aa0: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
-00077ab0: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-00077ac0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-00077ad0: 4c5f 4153 5345 5254 2867 676d 6c5f 6e65  L_ASSERT(ggml_ne
-00077ae0: 6c65 6d65 6e74 7328 7465 6e73 6f72 2d3e  lements(tensor->
-00077af0: 7372 635b 325d 2920 3d3d 2035 293b 0a20  src[2]) == 5);. 
-00077b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077b10: 2020 2047 474d 4c5f 4153 5345 5254 2874     GGML_ASSERT(t
-00077b20: 656e 736f 722d 3e73 7263 5b32 5d2d 3e74  ensor->src[2]->t
-00077b30: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00077b40: 5f49 3332 293b 0a20 2020 2020 2020 2020  _I32);.         
-00077b50: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00077b60: 2073 697a 655f 7420 6e62 3120 2020 2020   size_t nb1     
-00077b70: 3d20 2828 2069 6e74 3332 5f74 202a 2029  = (( int32_t * )
-00077b80: 2074 656e 736f 722d 3e73 7263 5b32 5d2d   tensor->src[2]-
-00077b90: 3e64 6174 6129 5b30 5d3b 0a20 2020 2020  >data)[0];.     
-00077ba0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00077bb0: 6f6e 7374 2073 697a 655f 7420 6e62 3220  onst size_t nb2 
-00077bc0: 2020 2020 3d20 2828 2069 6e74 3332 5f74      = (( int32_t
-00077bd0: 202a 2029 2074 656e 736f 722d 3e73 7263   * ) tensor->src
-00077be0: 5b32 5d2d 3e64 6174 6129 5b31 5d3b 0a20  [2]->data)[1];. 
-00077bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077c00: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00077c10: 6e62 3320 2020 2020 3d20 2828 2069 6e74  nb3     = (( int
-00077c20: 3332 5f74 202a 2029 2074 656e 736f 722d  32_t * ) tensor-
-00077c30: 3e73 7263 5b32 5d2d 3e64 6174 6129 5b32  >src[2]->data)[2
-00077c40: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-00077c50: 2020 2020 2020 2063 6f6e 7374 2073 697a         const siz
-00077c60: 655f 7420 6f66 6673 6574 2020 3d20 2828  e_t offset  = ((
-00077c70: 2069 6e74 3332 5f74 202a 2029 2074 656e   int32_t * ) ten
-00077c80: 736f 722d 3e73 7263 5b32 5d2d 3e64 6174  sor->src[2]->dat
-00077c90: 6129 5b33 5d3b 0a0a 2020 2020 2020 2020  a)[3];..        
-00077ca0: 2020 2020 2020 2020 2020 2020 7374 7275              stru
-00077cb0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00077cc0: 2074 656e 736f 725f 6772 6164 5f76 6965   tensor_grad_vie
-00077cd0: 7720 3d20 6767 6d6c 5f76 6965 775f 3464  w = ggml_view_4d
-00077ce0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-00077cf0: 2020 2020 2020 2020 2020 2020 2020 7465                te
-00077d00: 6e73 6f72 2d3e 6772 6164 2c0a 2020 2020  nsor->grad,.    
-00077d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077d20: 2020 2020 7372 6331 2d3e 6772 6164 2d3e      src1->grad->
-00077d30: 6e65 5b30 5d2c 0a20 2020 2020 2020 2020  ne[0],.         
-00077d40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00077d50: 7263 312d 3e67 7261 642d 3e6e 655b 315d  rc1->grad->ne[1]
-00077d60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00077d70: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-00077d80: 6772 6164 2d3e 6e65 5b32 5d2c 0a20 2020  grad->ne[2],.   
-00077d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077da0: 2020 2020 2073 7263 312d 3e67 7261 642d       src1->grad-
-00077db0: 3e6e 655b 335d 2c0a 2020 2020 2020 2020  >ne[3],.        
-00077dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077dd0: 6e62 312c 206e 6232 2c20 6e62 332c 206f  nb1, nb2, nb3, o
-00077de0: 6666 7365 7429 3b0a 0a20 2020 2020 2020  ffset);..       
-00077df0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00077e00: 312d 3e67 7261 6420 3d0a 2020 2020 2020  1->grad =.      
-00077e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077e20: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-00077e30: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00077e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077e50: 2073 7263 312d 3e67 7261 642c 0a20 2020   src1->grad,.   
-00077e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077e70: 2020 2020 2020 2020 2067 676d 6c5f 7265           ggml_re
-00077e80: 7368 6170 6528 6374 782c 0a20 2020 2020  shape(ctx,.     
-00077e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077ea0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00077eb0: 636f 6e74 2863 7478 2c20 7465 6e73 6f72  cont(ctx, tensor
-00077ec0: 5f67 7261 645f 7669 6577 292c 0a20 2020  _grad_view),.   
-00077ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077ee0: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00077ef0: 312d 3e67 7261 6429 2c0a 2020 2020 2020  1->grad),.      
-00077f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077f10: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-00077f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00077f30: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-00077f40: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00077f50: 6173 6520 4747 4d4c 5f4f 505f 5355 423a  ase GGML_OP_SUB:
-00077f60: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00077f70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00077f80: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
-00077f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00077fa0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-00077fb0: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
-00077fc0: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-00077fd0: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
-00077fe0: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-00077ff0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00078000: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-00078010: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
-00078020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078030: 2073 7263 312d 3e67 7261 6420 3d20 6767   src1->grad = gg
-00078040: 6d6c 5f73 7562 5f69 6d70 6c28 6374 782c  ml_sub_impl(ctx,
-00078050: 2073 7263 312d 3e67 7261 642c 2074 656e   src1->grad, ten
-00078060: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
-00078070: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00078080: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00078090: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000780a0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000780b0: 5f4d 554c 3a0a 2020 2020 2020 2020 2020  _MUL:.          
-000780c0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000780d0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-000780e0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-000780f0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00078100: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-00078110: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00078120: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-00078130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00078140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078150: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
-00078160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078170: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00078180: 6d6c 5f6d 756c 2863 7478 2c20 7372 6331  ml_mul(ctx, src1
-00078190: 2c20 7465 6e73 6f72 2d3e 6772 6164 292c  , tensor->grad),
-000781a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000781b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000781c0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-000781d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000781e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000781f0: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
-00078200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078210: 2020 2073 7263 312d 3e67 7261 6420 3d0a     src1->grad =.
-00078220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078230: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
-00078240: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
-00078250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078260: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
-00078270: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
-00078280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078290: 2020 2020 2020 2067 676d 6c5f 6d75 6c28         ggml_mul(
-000782a0: 6374 782c 2073 7263 302c 2074 656e 736f  ctx, src0, tenso
-000782b0: 722d 3e67 7261 6429 2c0a 2020 2020 2020  r->grad),.      
-000782c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000782d0: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-000782e0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-000782f0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00078300: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00078310: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00078320: 4449 563a 0a20 2020 2020 2020 2020 2020  DIV:.           
-00078330: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00078340: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-00078350: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-00078360: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-00078370: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
-00078380: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00078390: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-000783a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000783b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000783c0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-000783d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000783e0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000783f0: 6c5f 6469 7628 6374 782c 2074 656e 736f  l_div(ctx, tenso
-00078400: 722d 3e67 7261 642c 2073 7263 3129 2c0a  r->grad, src1),.
+000734c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000734d0: 2067 7261 645b 7374 305d 203d 2067 7261   grad[st0] = gra
+000734e0: 645b 7374 315d 2a28 312e 3020 2d20 6570  d[st1]*(1.0 - ep
+000734f0: 7329 2f73 756d 0a20 2020 2020 2020 2020  s)/sum.         
+00073500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00073530: 202f 2f20 6672 6f6d 2073 6f66 746d 6178   // from softmax
+00073540: 5f62 6163 6b3a 2020 2020 2020 2020 2020  _back:          
+00073550: 2020 6772 6164 5b73 305d 2020 3d20 7374    grad[s0]  = st
+00073560: 315f 6b20 2a20 2867 7261 645b 7374 315d  1_k * (grad[st1]
+00073570: 5f6b 202d 2064 6f74 2873 7431 2c20 6772  _k - dot(st1, gr
+00073580: 6164 5b73 7431 5d29 290a 2020 2020 2020  ad[st1])).      
+00073590: 2020 2020 2020 2f2f 2067 676d 6c5f 7665        // ggml_ve
+000735a0: 635f 7363 616c 655f 6633 3228 6e63 2c20  c_scale_f32(nc, 
+000735b0: 7374 2c20 7375 6d29 3b20 2020 2020 2020  st, sum);       
+000735c0: 2020 2020 2f2f 2073 7431 203d 2073 7430      // st1 = st0
+000735d0: 2a2f 7375 6d20 3d20 736f 6674 6d61 7828  */sum = softmax(
+000735e0: 7330 2920 2067 7261 645b 7374 315d 203d  s0)  grad[st1] =
+000735f0: 2067 7261 645b 7374 325d 2a28 312e 3020   grad[st2]*(1.0 
+00073600: 2d20 6570 7329 0a20 2020 2020 2020 2020  - eps).         
+00073610: 2020 202f 2f20 6767 6d6c 5f76 6563 5f73     // ggml_vec_s
+00073620: 6361 6c65 5f66 3332 286e 632c 2073 742c  cale_f32(nc, st,
+00073630: 2028 312e 3066 202d 2065 7073 2929 3b20   (1.0f - eps)); 
+00073640: 202f 2f20 7374 3220 3d20 7374 312a 2831   // st2 = st1*(1
+00073650: 2e30 202d 2065 7073 2920 2020 2020 2020  .0 - eps)       
+00073660: 2020 6772 6164 5b73 7432 5d20 3d20 6772    grad[st2] = gr
+00073670: 6164 5b73 7433 5d0a 2020 2020 2020 2020  ad[st3].        
+00073680: 2020 2020 2f2f 2067 676d 6c5f 7665 635f      // ggml_vec_
+00073690: 6164 6431 5f66 3332 286e 632c 2073 742c  add1_f32(nc, st,
+000736a0: 2073 742c 2065 7073 293b 2020 2020 2020   st, eps);      
+000736b0: 2020 2f2f 2073 7433 203d 2073 7432 202b    // st3 = st2 +
+000736c0: 2065 7073 2020 2020 2020 2020 2020 2020   eps            
+000736d0: 2020 2067 7261 645b 7374 335d 203d 2067     grad[st3] = g
+000736e0: 7261 645b 7374 345d 2f73 7433 0a20 2020  rad[st4]/st3.   
+000736f0: 2020 2020 2020 2020 202f 2f20 6767 6d6c           // ggml
+00073700: 5f76 6563 5f6c 6f67 5f66 3332 286e 632c  _vec_log_f32(nc,
+00073710: 2073 742c 2073 7429 3b20 2020 2020 2020   st, st);       
+00073720: 2020 2020 2020 202f 2f20 7374 3420 3d20         // st4 = 
+00073730: 6c6f 6728 7374 3329 2020 2020 2020 2020  log(st3)        
+00073740: 2020 2020 2020 2020 6772 6164 5b73 7434          grad[st4
+00073750: 5d20 3d20 6772 6164 5b73 7435 5d20 2a20  ] = grad[st5] * 
+00073760: 7331 0a20 2020 2020 2020 2020 2020 202f  s1.            /
+00073770: 2f20 6767 6d6c 5f76 6563 5f6d 756c 5f66  / ggml_vec_mul_f
+00073780: 3332 286e 632c 2073 742c 2073 742c 2073  32(nc, st, st, s
+00073790: 3129 3b20 2020 2020 2020 2020 202f 2f20  1);          // 
+000737a0: 7374 3520 3d20 7374 3420 2a20 7331 2020  st5 = st4 * s1  
+000737b0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
+000737c0: 6164 5b73 7435 5d20 3d20 6772 6164 5b73  ad[st5] = grad[s
+000737d0: 756d 735b 6974 685d 5d0a 2020 2020 2020  ums[ith]].      
+000737e0: 2020 2020 2020 2f2f 2067 676d 6c5f 7665        // ggml_ve
+000737f0: 635f 7375 6d5f 6633 3228 6e63 2c20 7375  c_sum_f32(nc, su
+00073800: 6d73 202b 2069 7468 2c20 7374 293b 2020  ms + ith, st);  
+00073810: 2020 2020 2f2f 2073 756d 735b 6974 685d      // sums[ith]
+00073820: 203d 2073 7435 2020 2020 2020 2020 2020   = st5          
+00073830: 2020 2020 2067 7261 645b 7375 6d73 5b69       grad[sums[i
+00073840: 7468 5d5d 203d 2067 7261 645b 6372 6f73  th]] = grad[cros
+00073850: 735f 656e 7472 6f70 795f 6c6f 7373 5d20  s_entropy_loss] 
+00073860: 3d20 2d67 7261 645b 6365 6c5d 0a0a 2020  = -grad[cel]..  
+00073870: 2020 2020 2020 2020 2020 2f2f 2073 7562            // sub
+00073880: 7374 6974 7574 6520 696e 746f 2067 7261  stitute into gra
+00073890: 645b 7374 315d 2c20 6265 6361 7573 6520  d[st1], because 
+000738a0: 7765 2063 616e 2072 6575 7365 2073 6f66  we can reuse sof
+000738b0: 746d 6178 5f62 6163 6b20 6672 6f6d 2074  tmax_back from t
+000738c0: 6869 7320 706f 696e 7420 6f6e 0a20 2020  his point on.   
+000738d0: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
+000738e0: 5b73 7431 5d20 3d20 2d67 7261 645b 6365  [st1] = -grad[ce
+000738f0: 6c5d 2a73 312a 2831 2e30 202d 2065 7073  l]*s1*(1.0 - eps
+00073900: 292f 2865 7073 202b 2073 6f66 746d 6178  )/(eps + softmax
+00073910: 2873 3029 2a28 312e 3020 2d20 6570 7329  (s0)*(1.0 - eps)
+00073920: 290a 2020 2020 2020 2020 2020 2020 2f2f  ).            //
+00073930: 2070 6f73 746f 7264 6572 3a0a 2020 2020   postorder:.    
+00073940: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+00073950: 7374 315d 203a 3d20 736f 6674 6d61 7828  st1] := softmax(
+00073960: 7330 290a 2020 2020 2020 2020 2020 2020  s0).            
+00073970: 2f2f 2067 7261 645b 7374 315d 203a 3d20  // grad[st1] := 
+00073980: 6772 6164 5b73 7431 5d2a 2831 2e30 202d  grad[st1]*(1.0 -
+00073990: 2065 7073 290a 2020 2020 2020 2020 2020   eps).          
+000739a0: 2020 2f2f 2067 7261 645b 7374 315d 203a    // grad[st1] :
+000739b0: 3d20 6772 6164 5b73 7431 5d20 2b20 6570  = grad[st1] + ep
+000739c0: 730a 2020 2020 2020 2020 2020 2020 2f2f  s.            //
+000739d0: 2067 7261 645b 7374 315d 203a 3d20 7331   grad[st1] := s1
+000739e0: 202f 2067 7261 645b 7374 315d 0a20 2020   / grad[st1].   
+000739f0: 2020 2020 2020 2020 202f 2f20 6772 6164           // grad
+00073a00: 5b73 7431 5d20 3a3d 2067 7261 645b 7374  [st1] := grad[st
+00073a10: 315d 2a28 312e 302d 6570 7329 2a2d 6772  1]*(1.0-eps)*-gr
+00073a20: 6164 5b63 656c 5d0a 0a20 2020 2020 2020  ad[cel]..       
+00073a30: 2020 2020 202f 2f20 7372 6330 2067 7261       // src0 gra
+00073a40: 6469 656e 7473 2062 7920 676f 696e 6720  dients by going 
+00073a50: 7468 726f 7567 6820 736f 6674 6d61 785f  through softmax_
+00073a60: 6261 636b 0a20 2020 2020 2020 2020 2020  back.           
+00073a70: 202f 2f20 6772 6164 5b73 305d 203d 2073   // grad[s0] = s
+00073a80: 7431 5f6b 202a 2028 6772 6164 5b73 7431  t1_k * (grad[st1
+00073a90: 5d5f 6b20 2d20 646f 7428 7374 312c 2067  ]_k - dot(st1, g
+00073aa0: 7261 645b 7374 315d 2929 0a20 2020 2020  rad[st1])).     
+00073ab0: 2020 2020 2020 202f 2f20 2020 6672 6f6d         //   from
+00073ac0: 2073 6f66 746d 6178 5f62 6163 6b3a 0a20   softmax_back:. 
+00073ad0: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
+00073ae0: 6478 6b20 3d20 796b 202a 2028 6479 6b20  dxk = yk * (dyk 
+00073af0: 2d20 646f 7428 792c 2064 7929 290a 2020  - dot(y, dy)).  
+00073b00: 2020 2020 2020 2020 2020 2f2f 2020 2064            //   d
+00073b10: 6f74 5f79 5f64 7920 3a3d 2064 6f74 2879  ot_y_dy := dot(y
+00073b20: 2c20 6479 290a 2020 2020 2020 2020 2020  , dy).          
+00073b30: 2020 2f2f 2020 2064 7820 3a3d 2064 790a    //   dx := dy.
+00073b40: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
+00073b50: 2064 7820 3a3d 2064 7820 2d20 646f 745f   dx := dx - dot_
+00073b60: 795f 6479 0a20 2020 2020 2020 2020 2020  y_dy.           
+00073b70: 202f 2f20 2020 6478 203a 3d20 6478 202a   //   dx := dx *
+00073b80: 2079 0a20 2020 2020 2020 2020 2020 202f   y.            /
+00073b90: 2f20 2020 706f 7374 6f72 6465 723a 0a20  /   postorder:. 
+00073ba0: 2020 2020 2020 2020 2020 202f 2f20 2020             //   
+00073bb0: 646f 745f 7374 315f 6473 7431 203a 3d20  dot_st1_dst1 := 
+00073bc0: 646f 7428 7374 312c 2067 7261 645b 7374  dot(st1, grad[st
+00073bd0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+00073be0: 2f2f 2020 2067 7261 645b 7330 5d20 3a3d  //   grad[s0] :=
+00073bf0: 2067 7261 645b 7374 315d 0a20 2020 2020   grad[st1].     
+00073c00: 2020 2020 2020 202f 2f20 2020 6772 6164         //   grad
+00073c10: 5b73 305d 203a 3d20 6772 6164 5b73 305d  [s0] := grad[s0]
+00073c20: 202d 2064 6f74 5f73 7431 5f64 7374 310a   - dot_st1_dst1.
+00073c30: 2020 2020 2020 2020 2020 2020 2f2f 2020              //  
+00073c40: 2067 7261 645b 7330 5d20 3a3d 2067 7261   grad[s0] := gra
+00073c50: 645b 7330 5d20 2a20 7374 310a 0a20 2020  d[s0] * st1..   
+00073c60: 2020 2020 2020 2020 202f 2f20 7072 6570           // prep
+00073c70: 656e 6420 706f 7374 6f72 6465 7220 6672  end postorder fr
+00073c80: 6f6d 2067 7261 645b 7374 315d 2064 6972  om grad[st1] dir
+00073c90: 6563 746c 7920 7573 696e 6720 6772 6164  ectly using grad
+00073ca0: 5b73 305d 2061 7320 6d65 6d6f 7279 206c  [s0] as memory l
+00073cb0: 6f63 6174 696f 6e2c 2061 7320 7765 2077  ocation, as we w
+00073cc0: 696c 6c20 6772 6164 5b73 305d 203a 3d20  ill grad[s0] := 
+00073cd0: 6772 6164 5b73 7431 5d0a 2020 2020 2020  grad[st1].      
+00073ce0: 2020 2020 2020 2f2f 2073 6d20 2020 2020        // sm     
+00073cf0: 2020 2020 2020 3a3d 2073 6f66 746d 6178        := softmax
+00073d00: 2873 3029 0a20 2020 2020 2020 2020 2020  (s0).           
+00073d10: 202f 2f20 6772 6164 5b73 305d 2020 2020   // grad[s0]    
+00073d20: 203a 3d20 736d 2a28 312e 3020 2d20 6570   := sm*(1.0 - ep
+00073d30: 7329 0a20 2020 2020 2020 2020 2020 202f  s).            /
+00073d40: 2f20 6772 6164 5b73 305d 2020 2020 203a  / grad[s0]     :
+00073d50: 3d20 6772 6164 5b73 305d 202b 2065 7073  = grad[s0] + eps
+00073d60: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+00073d70: 6772 6164 5b73 305d 2020 2020 203a 3d20  grad[s0]     := 
+00073d80: 7331 202f 2067 7261 645b 7330 5d0a 2020  s1 / grad[s0].  
+00073d90: 2020 2020 2020 2020 2020 2f2f 2067 7261            // gra
+00073da0: 645b 7330 5d20 2020 2020 3a3d 2067 7261  d[s0]     := gra
+00073db0: 645b 7330 5d2a 2831 2e30 2d65 7073 292a  d[s0]*(1.0-eps)*
+00073dc0: 2d67 7261 645b 6365 6c5d 0a20 2020 2020  -grad[cel].     
+00073dd0: 2020 2020 2020 202f 2f20 646f 745f 7374         // dot_st
+00073de0: 315f 6473 7431 203a 3d20 646f 7428 736d  1_dst1 := dot(sm
+00073df0: 2c20 6772 6164 5b73 305d 290a 2020 2020  , grad[s0]).    
+00073e00: 2020 2020 2020 2020 2f2f 2067 7261 645b          // grad[
+00073e10: 7330 5d20 2020 2020 3a3d 2067 7261 645b  s0]     := grad[
+00073e20: 7330 5d20 2d20 646f 745f 7374 315f 6473  s0] - dot_st1_ds
+00073e30: 7431 0a20 2020 2020 2020 2020 2020 202f  t1.            /
+00073e40: 2f20 6772 6164 5b73 305d 2020 2020 203a  / grad[s0]     :
+00073e50: 3d20 6772 6164 5b73 305d 202a 2073 6d0a  = grad[s0] * sm.
+00073e60: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00073e70: 2020 202f 2f20 736f 6674 5f6d 6178 0a20     // soft_max. 
+00073e80: 2020 2020 2020 2067 676d 6c5f 666c 6f61         ggml_floa
+00073e90: 7420 7375 6d20 3d20 302e 303b 0a20 2020  t sum = 0.0;.   
+00073ea0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00073eb0: 2020 2066 6c6f 6174 206d 6178 203d 202d     float max = -
+00073ec0: 494e 4649 4e49 5459 3b0a 2020 2020 2020  INFINITY;.      
+00073ed0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
+00073ee0: 6178 5f66 3332 286e 632c 2026 6d61 782c  ax_f32(nc, &max,
+00073ef0: 2073 3029 3b0a 0a20 2020 2020 2020 2020   s0);..         
+00073f00: 2020 2075 696e 7431 365f 7420 7363 7674     uint16_t scvt
+00073f10: 3b0a 2020 2020 2020 2020 2020 2020 666f  ;.            fo
+00073f20: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
+00073f30: 3c20 6e63 3b20 692b 2b29 207b 0a20 2020  < nc; i++) {.   
+00073f40: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00073f50: 2873 305b 695d 203d 3d20 2d49 4e46 494e  (s0[i] == -INFIN
+00073f60: 4954 5929 207b 0a20 2020 2020 2020 2020  ITY) {.         
+00073f70: 2020 2020 2020 2020 2020 2073 6d5b 695d             sm[i]
+00073f80: 203d 2030 2e30 663b 0a20 2020 2020 2020   = 0.0f;.       
+00073f90: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
+00073fa0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00073fb0: 2020 2020 2020 2f2f 2063 6f6e 7374 2066        // const f
+00073fc0: 6c6f 6174 2076 616c 203d 2028 7330 5b69  loat val = (s0[i
+00073fd0: 5d20 3d3d 202d 494e 4649 4e49 5459 2920  ] == -INFINITY) 
+00073fe0: 3f20 302e 3020 3a20 6578 7028 7330 5b69  ? 0.0 : exp(s0[i
+00073ff0: 5d20 2d20 6d61 7829 3b0a 2020 2020 2020  ] - max);.      
+00074000: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00074010: 6d6c 5f66 7031 365f 7420 7320 3d20 4747  ml_fp16_t s = GG
+00074020: 4d4c 5f46 5033 325f 544f 5f46 5031 3628  ML_FP32_TO_FP16(
+00074030: 7330 5b69 5d20 2d20 6d61 7829 3b0a 2020  s0[i] - max);.  
+00074040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074050: 2020 6d65 6d63 7079 2826 7363 7674 2c20    memcpy(&scvt, 
+00074060: 2673 2c20 7369 7a65 6f66 2873 6376 7429  &s, sizeof(scvt)
+00074070: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00074080: 2020 2020 2020 2063 6f6e 7374 2066 6c6f         const flo
+00074090: 6174 2076 616c 203d 2047 474d 4c5f 4650  at val = GGML_FP
+000740a0: 3136 5f54 4f5f 4650 3332 2874 6162 6c65  16_TO_FP32(table
+000740b0: 5f65 7870 5f66 3136 5b73 6376 745d 293b  _exp_f16[scvt]);
+000740c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000740d0: 2020 2020 2073 756d 202b 3d20 2867 676d       sum += (ggm
+000740e0: 6c5f 666c 6f61 7429 7661 6c3b 0a20 2020  l_float)val;.   
+000740f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00074100: 2073 6d5b 695d 203d 2076 616c 3b0a 2020   sm[i] = val;.  
+00074110: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00074120: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00074130: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00074140: 7428 7375 6d20 3e20 302e 3029 3b0a 2020  t(sum > 0.0);.  
+00074150: 2020 2020 2020 2020 2020 7375 6d20 3d20            sum = 
+00074160: 312e 302f 7375 6d3b 0a20 2020 2020 2020  1.0/sum;.       
+00074170: 207d 0a0a 2020 2020 2020 2020 666c 6f61   }..        floa
+00074180: 7420 646f 745f 7374 315f 6473 7431 203d  t dot_st1_dst1 =
+00074190: 2030 3b0a 2020 2020 2020 2020 6767 6d6c   0;.        ggml
+000741a0: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
+000741b0: 632c 2073 6d2c 2073 756d 293b 0a20 2020  c, sm, sum);.   
+000741c0: 2020 2020 2067 676d 6c5f 7665 635f 6370       ggml_vec_cp
+000741d0: 795f 6633 3220 2028 6e63 2c20 6473 302c  y_f32  (nc, ds0,
+000741e0: 2073 6d29 3b0a 2020 2020 2020 2020 6767   sm);.        gg
+000741f0: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+00074200: 286e 632c 2064 7330 2c20 2831 2e30 6620  (nc, ds0, (1.0f 
+00074210: 2d20 6570 7329 293b 0a20 2020 2020 2020  - eps));.       
+00074220: 2067 676d 6c5f 7665 635f 6164 6431 5f66   ggml_vec_add1_f
+00074230: 3332 2028 6e63 2c20 6473 302c 2064 7330  32 (nc, ds0, ds0
+00074240: 2c20 6570 7329 3b0a 2020 2020 2020 2020  , eps);.        
+00074250: 6767 6d6c 5f76 6563 5f64 6976 5f66 3332  ggml_vec_div_f32
+00074260: 2020 286e 632c 2064 7330 2c20 7331 2c20    (nc, ds0, s1, 
+00074270: 6473 3029 3b0a 2020 2020 2020 2020 6767  ds0);.        gg
+00074280: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
+00074290: 286e 632c 2064 7330 2c20 2d28 312e 3066  (nc, ds0, -(1.0f
+000742a0: 202d 2065 7073 292a 645b 305d 293b 0a20   - eps)*d[0]);. 
+000742b0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+000742c0: 646f 745f 6633 3220 2028 6e63 2c20 2664  dot_f32  (nc, &d
+000742d0: 6f74 5f73 7431 5f64 7374 312c 2073 6d2c  ot_st1_dst1, sm,
+000742e0: 2064 7330 293b 0a20 2020 2020 2020 2067   ds0);.        g
+000742f0: 676d 6c5f 7665 635f 6163 6331 5f66 3332  gml_vec_acc1_f32
+00074300: 2028 6e63 2c20 6473 302c 202d 646f 745f   (nc, ds0, -dot_
+00074310: 7374 315f 6473 7431 293b 0a20 2020 2020  st1_dst1);.     
+00074320: 2020 2067 676d 6c5f 7665 635f 6d75 6c5f     ggml_vec_mul_
+00074330: 6633 3220 2028 6e63 2c20 6473 302c 2064  f32  (nc, ds0, d
+00074340: 7330 2c20 736d 293b 0a0a 2369 666e 6465  s0, sm);..#ifnde
+00074350: 6620 4e44 4542 5547 0a20 2020 2020 2020  f NDEBUG.       
+00074360: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00074370: 2069 203c 206e 633b 202b 2b69 2920 7b0a   i < nc; ++i) {.
+00074380: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00074390: 7274 2821 6973 6e61 6e28 736d 5b69 5d29  rt(!isnan(sm[i])
+000743a0: 293b 0a20 2020 2020 2020 2020 2020 2061  );.            a
+000743b0: 7373 6572 7428 2169 7369 6e66 2873 6d5b  ssert(!isinf(sm[
+000743c0: 695d 2929 3b0a 2020 2020 2020 2020 2020  i]));.          
+000743d0: 2020 6173 7365 7274 2821 6973 6e61 6e28    assert(!isnan(
+000743e0: 6473 305b 695d 2929 3b0a 2020 2020 2020  ds0[i]));.      
+000743f0: 2020 2020 2020 6173 7365 7274 2821 6973        assert(!is
+00074400: 696e 6628 6473 305b 695d 2929 3b0a 2020  inf(ds0[i]));.  
+00074410: 2020 2020 2020 7d0a 2365 6e64 6966 0a20        }.#endif. 
+00074420: 2020 207d 0a7d 0a0a 7374 6174 6963 2076     }.}..static v
+00074430: 6f69 6420 6767 6d6c 5f63 6f6d 7075 7465  oid ggml_compute
+00074440: 5f66 6f72 7761 7264 5f63 726f 7373 5f65  _forward_cross_e
+00074450: 6e74 726f 7079 5f6c 6f73 735f 6261 636b  ntropy_loss_back
+00074460: 280a 2020 2020 2020 2020 636f 6e73 7420  (.        const 
+00074470: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00074480: 7574 655f 7061 7261 6d73 202a 2070 6172  ute_params * par
+00074490: 616d 732c 0a20 2020 2020 2020 2063 6f6e  ams,.        con
+000744a0: 7374 2073 7472 7563 7420 6767 6d6c 5f74  st struct ggml_t
+000744b0: 656e 736f 7220 2a20 7372 6330 2c0a 2020  ensor * src0,.  
+000744c0: 2020 2020 2020 636f 6e73 7420 7374 7275        const stru
+000744d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000744e0: 2073 7263 312c 0a20 2020 2020 2020 2063   src1,.        c
+000744f0: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
+00074500: 5f74 656e 736f 7220 2a20 6f70 7430 2c0a  _tensor * opt0,.
+00074510: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00074520: 676d 6c5f 7465 6e73 6f72 202a 2064 7374  gml_tensor * dst
+00074530: 2920 7b0a 2020 2020 7377 6974 6368 2028  ) {.    switch (
+00074540: 7372 6330 2d3e 7479 7065 2920 7b0a 2020  src0->type) {.  
+00074550: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00074560: 5459 5045 5f46 3332 3a0a 2020 2020 2020  TYPE_F32:.      
+00074570: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00074580: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
+00074590: 7075 7465 5f66 6f72 7761 7264 5f63 726f  pute_forward_cro
+000745a0: 7373 5f65 6e74 726f 7079 5f6c 6f73 735f  ss_entropy_loss_
+000745b0: 6261 636b 5f66 3332 2870 6172 616d 732c  back_f32(params,
+000745c0: 2073 7263 302c 2073 7263 312c 206f 7074   src0, src1, opt
+000745d0: 302c 2064 7374 293b 0a20 2020 2020 2020  0, dst);.       
+000745e0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000745f0: 2020 2020 2020 6465 6661 756c 743a 0a20        default:. 
+00074600: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00074610: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00074620: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
+00074630: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00074640: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a0a  reak;.    }.}...
+00074650: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00074660: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00074670: 2f0a 0a73 7461 7469 6320 766f 6964 2067  /..static void g
+00074680: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00074690: 6172 6428 7374 7275 6374 2067 676d 6c5f  ard(struct ggml_
+000746a0: 636f 6d70 7574 655f 7061 7261 6d73 202a  compute_params *
+000746b0: 2070 6172 616d 732c 2073 7472 7563 7420   params, struct 
+000746c0: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+000746d0: 6e73 6f72 2920 7b0a 2020 2020 4747 4d4c  nsor) {.    GGML
+000746e0: 5f41 5353 4552 5428 7061 7261 6d73 293b  _ASSERT(params);
+000746f0: 0a0a 2369 6664 6566 2047 474d 4c5f 5553  ..#ifdef GGML_US
+00074700: 455f 4355 424c 4153 0a20 2020 2062 6f6f  E_CUBLAS.    boo
+00074710: 6c20 736b 6970 5f63 7075 203d 2067 676d  l skip_cpu = ggm
+00074720: 6c5f 6375 6461 5f63 6f6d 7075 7465 5f66  l_cuda_compute_f
+00074730: 6f72 7761 7264 2870 6172 616d 732c 2074  orward(params, t
+00074740: 656e 736f 7229 3b0a 2020 2020 6966 2028  ensor);.    if (
+00074750: 736b 6970 5f63 7075 2920 7b0a 2020 2020  skip_cpu) {.    
+00074760: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+00074770: 7d0a 2020 2020 4747 4d4c 5f41 5353 4552  }.    GGML_ASSER
+00074780: 5428 7465 6e73 6f72 2d3e 7372 635b 305d  T(tensor->src[0]
+00074790: 203d 3d20 4e55 4c4c 207c 7c20 7465 6e73   == NULL || tens
+000747a0: 6f72 2d3e 7372 635b 305d 2d3e 6261 636b  or->src[0]->back
+000747b0: 656e 6420 3d3d 2047 474d 4c5f 4241 434b  end == GGML_BACK
+000747c0: 454e 445f 4350 5529 3b0a 2020 2020 4747  END_CPU);.    GG
+000747d0: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
+000747e0: 2d3e 7372 635b 315d 203d 3d20 4e55 4c4c  ->src[1] == NULL
+000747f0: 207c 7c20 7465 6e73 6f72 2d3e 7372 635b   || tensor->src[
+00074800: 315d 2d3e 6261 636b 656e 6420 3d3d 2047  1]->backend == G
+00074810: 474d 4c5f 4241 434b 454e 445f 4350 5529  GML_BACKEND_CPU)
+00074820: 3b0a 2365 6e64 6966 202f 2f20 4747 4d4c  ;.#endif // GGML
+00074830: 5f55 5345 5f43 5542 4c41 530a 0a20 2020  _USE_CUBLAS..   
+00074840: 2073 7769 7463 6820 2874 656e 736f 722d   switch (tensor-
+00074850: 3e6f 7029 207b 0a20 2020 2020 2020 2063  >op) {.        c
+00074860: 6173 6520 4747 4d4c 5f4f 505f 4455 503a  ase GGML_OP_DUP:
+00074870: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00074880: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00074890: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000748a0: 6172 645f 6475 7028 7061 7261 6d73 2c20  ard_dup(params, 
+000748b0: 7465 6e73 6f72 2d3e 7372 635b 305d 2c20  tensor->src[0], 
+000748c0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+000748d0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+000748e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000748f0: 4f50 5f41 4444 3a0a 2020 2020 2020 2020  OP_ADD:.        
+00074900: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00074910: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00074920: 7465 5f66 6f72 7761 7264 5f61 6464 2870  te_forward_add(p
+00074930: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00074940: 7263 5b30 5d2c 2074 656e 736f 722d 3e73  rc[0], tensor->s
+00074950: 7263 5b31 5d2c 2074 656e 736f 7229 3b0a  rc[1], tensor);.
+00074960: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00074970: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00074980: 6520 4747 4d4c 5f4f 505f 4144 4431 3a0a  e GGML_OP_ADD1:.
+00074990: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000749a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000749b0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+000749c0: 7264 5f61 6464 3128 7061 7261 6d73 2c20  rd_add1(params, 
+000749d0: 7465 6e73 6f72 2d3e 7372 635b 305d 2c20  tensor->src[0], 
+000749e0: 7465 6e73 6f72 2d3e 7372 635b 315d 2c20  tensor->src[1], 
+000749f0: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00074a00: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00074a10: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00074a20: 4f50 5f41 4343 3a0a 2020 2020 2020 2020  OP_ACC:.        
+00074a30: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00074a40: 2020 2020 2020 6767 6d6c 5f63 6f6d 7075        ggml_compu
+00074a50: 7465 5f66 6f72 7761 7264 5f61 6363 2870  te_forward_acc(p
+00074a60: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00074a70: 7263 5b30 5d2c 2074 656e 736f 722d 3e73  rc[0], tensor->s
+00074a80: 7263 5b31 5d2c 2074 656e 736f 722d 3e73  rc[1], tensor->s
+00074a90: 7263 5b32 5d2c 2074 656e 736f 7229 3b0a  rc[2], tensor);.
+00074aa0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00074ab0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00074ac0: 6520 4747 4d4c 5f4f 505f 5355 423a 0a20  e GGML_OP_SUB:. 
+00074ad0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00074ae0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00074af0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00074b00: 645f 7375 6228 7061 7261 6d73 2c20 7465  d_sub(params, te
+00074b10: 6e73 6f72 2d3e 7372 635b 305d 2c20 7465  nsor->src[0], te
+00074b20: 6e73 6f72 2d3e 7372 635b 315d 2c20 7465  nsor->src[1], te
+00074b30: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+00074b40: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00074b50: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00074b60: 5f4d 554c 3a0a 2020 2020 2020 2020 2020  _MUL:.          
+00074b70: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00074b80: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00074b90: 5f66 6f72 7761 7264 5f6d 756c 2870 6172  _forward_mul(par
+00074ba0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00074bb0: 5b30 5d2c 2074 656e 736f 722d 3e73 7263  [0], tensor->src
+00074bc0: 5b31 5d2c 2074 656e 736f 7229 3b0a 2020  [1], tensor);.  
+00074bd0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00074be0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00074bf0: 4747 4d4c 5f4f 505f 4449 563a 0a20 2020  GGML_OP_DIV:.   
+00074c00: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00074c10: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00074c20: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00074c30: 6469 7628 7061 7261 6d73 2c20 7465 6e73  div(params, tens
+00074c40: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+00074c50: 6f72 2d3e 7372 635b 315d 2c20 7465 6e73  or->src[1], tens
+00074c60: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00074c70: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00074c80: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00074c90: 5152 3a0a 2020 2020 2020 2020 2020 2020  QR:.            
+00074ca0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00074cb0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00074cc0: 6f72 7761 7264 5f73 7172 2870 6172 616d  orward_sqr(param
+00074cd0: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
+00074ce0: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
+00074cf0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00074d00: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00074d10: 4d4c 5f4f 505f 5351 5254 3a0a 2020 2020  ML_OP_SQRT:.    
+00074d20: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00074d30: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00074d40: 6f6d 7075 7465 5f66 6f72 7761 7264 5f73  ompute_forward_s
+00074d50: 7172 7428 7061 7261 6d73 2c20 7465 6e73  qrt(params, tens
+00074d60: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+00074d70: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00074d80: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00074d90: 2020 6361 7365 2047 474d 4c5f 4f50 5f4c    case GGML_OP_L
+00074da0: 4f47 3a0a 2020 2020 2020 2020 2020 2020  OG:.            
+00074db0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00074dc0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00074dd0: 6f72 7761 7264 5f6c 6f67 2870 6172 616d  orward_log(param
+00074de0: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
+00074df0: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
+00074e00: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00074e10: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00074e20: 4d4c 5f4f 505f 5355 4d3a 0a20 2020 2020  ML_OP_SUM:.     
+00074e30: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00074e40: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+00074e50: 6d70 7574 655f 666f 7277 6172 645f 7375  mpute_forward_su
+00074e60: 6d28 7061 7261 6d73 2c20 7465 6e73 6f72  m(params, tensor
+00074e70: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
+00074e80: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00074e90: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00074ea0: 6361 7365 2047 474d 4c5f 4f50 5f53 554d  case GGML_OP_SUM
+00074eb0: 5f52 4f57 533a 0a20 2020 2020 2020 2020  _ROWS:.         
+00074ec0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00074ed0: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00074ee0: 655f 666f 7277 6172 645f 7375 6d5f 726f  e_forward_sum_ro
+00074ef0: 7773 2870 6172 616d 732c 2074 656e 736f  ws(params, tenso
+00074f00: 722d 3e73 7263 5b30 5d2c 2074 656e 736f  r->src[0], tenso
+00074f10: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00074f20: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00074f30: 2063 6173 6520 4747 4d4c 5f4f 505f 4d45   case GGML_OP_ME
+00074f40: 414e 3a0a 2020 2020 2020 2020 2020 2020  AN:.            
+00074f50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00074f60: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00074f70: 6f72 7761 7264 5f6d 6561 6e28 7061 7261  orward_mean(para
+00074f80: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
+00074f90: 305d 2c20 7465 6e73 6f72 293b 0a20 2020  0], tensor);.   
+00074fa0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00074fb0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00074fc0: 474d 4c5f 4f50 5f41 5247 4d41 583a 0a20  GML_OP_ARGMAX:. 
+00074fd0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00074fe0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00074ff0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00075000: 645f 6172 676d 6178 2870 6172 616d 732c  d_argmax(params,
+00075010: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
+00075020: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00075030: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00075040: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00075050: 5f4f 505f 5245 5045 4154 3a0a 2020 2020  _OP_REPEAT:.    
+00075060: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00075070: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00075080: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+00075090: 6570 6561 7428 7061 7261 6d73 2c20 7465  epeat(params, te
+000750a0: 6e73 6f72 2d3e 7372 635b 305d 2c20 7465  nsor->src[0], te
+000750b0: 6e73 6f72 293b 0a20 2020 2020 2020 2020  nsor);.         
+000750c0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+000750d0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000750e0: 5f52 4550 4541 545f 4241 434b 3a0a 2020  _REPEAT_BACK:.  
+000750f0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00075100: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00075110: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00075120: 5f72 6570 6561 745f 6261 636b 2870 6172  _repeat_back(par
+00075130: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00075140: 5b30 5d2c 2074 656e 736f 7229 3b0a 2020  [0], tensor);.  
+00075150: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00075160: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00075170: 4747 4d4c 5f4f 505f 4142 533a 0a20 2020  GGML_OP_ABS:.   
+00075180: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00075190: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000751a0: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+000751b0: 6162 7328 7061 7261 6d73 2c20 7465 6e73  abs(params, tens
+000751c0: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+000751d0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+000751e0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+000751f0: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00075200: 474e 3a0a 2020 2020 2020 2020 2020 2020  GN:.            
+00075210: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00075220: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00075230: 6f72 7761 7264 5f73 676e 2870 6172 616d  orward_sgn(param
+00075240: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
+00075250: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
+00075260: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00075270: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00075280: 4d4c 5f4f 505f 4e45 473a 0a20 2020 2020  ML_OP_NEG:.     
+00075290: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000752a0: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
+000752b0: 6d70 7574 655f 666f 7277 6172 645f 6e65  mpute_forward_ne
+000752c0: 6728 7061 7261 6d73 2c20 7465 6e73 6f72  g(params, tensor
+000752d0: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
+000752e0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000752f0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00075300: 6361 7365 2047 474d 4c5f 4f50 5f53 5445  case GGML_OP_STE
+00075310: 503a 0a20 2020 2020 2020 2020 2020 207b  P:.            {
+00075320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00075330: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00075340: 7277 6172 645f 7374 6570 2870 6172 616d  rward_step(param
+00075350: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
+00075360: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
+00075370: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00075380: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00075390: 4d4c 5f4f 505f 5441 4e48 3a0a 2020 2020  ML_OP_TANH:.    
+000753a0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000753b0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+000753c0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f74  ompute_forward_t
+000753d0: 616e 6828 7061 7261 6d73 2c20 7465 6e73  anh(params, tens
+000753e0: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+000753f0: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00075400: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00075410: 2020 6361 7365 2047 474d 4c5f 4f50 5f45    case GGML_OP_E
+00075420: 4c55 3a0a 2020 2020 2020 2020 2020 2020  LU:.            
+00075430: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00075440: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00075450: 6f72 7761 7264 5f65 6c75 2870 6172 616d  orward_elu(param
+00075460: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
+00075470: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
+00075480: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+00075490: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000754a0: 4d4c 5f4f 505f 5245 4c55 3a0a 2020 2020  ML_OP_RELU:.    
+000754b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000754c0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+000754d0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+000754e0: 656c 7528 7061 7261 6d73 2c20 7465 6e73  elu(params, tens
+000754f0: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+00075500: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00075510: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00075520: 2020 6361 7365 2047 474d 4c5f 4f50 5f47    case GGML_OP_G
+00075530: 454c 553a 0a20 2020 2020 2020 2020 2020  ELU:.           
+00075540: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00075550: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00075560: 666f 7277 6172 645f 6765 6c75 2870 6172  forward_gelu(par
+00075570: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00075580: 5b30 5d2c 2074 656e 736f 7229 3b0a 2020  [0], tensor);.  
+00075590: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+000755a0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+000755b0: 4747 4d4c 5f4f 505f 4745 4c55 5f51 5549  GGML_OP_GELU_QUI
+000755c0: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+000755d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000755e0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+000755f0: 6f72 7761 7264 5f67 656c 755f 7175 6963  orward_gelu_quic
+00075600: 6b28 7061 7261 6d73 2c20 7465 6e73 6f72  k(params, tensor
+00075610: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
+00075620: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00075630: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00075640: 6361 7365 2047 474d 4c5f 4f50 5f53 494c  case GGML_OP_SIL
+00075650: 553a 0a20 2020 2020 2020 2020 2020 207b  U:.            {
+00075660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00075670: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00075680: 7277 6172 645f 7369 6c75 2870 6172 616d  rward_silu(param
+00075690: 732c 2074 656e 736f 722d 3e73 7263 5b30  s, tensor->src[0
+000756a0: 5d2c 2074 656e 736f 7229 3b0a 2020 2020  ], tensor);.    
+000756b0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000756c0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000756d0: 4d4c 5f4f 505f 5349 4c55 5f42 4143 4b3a  ML_OP_SILU_BACK:
+000756e0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000756f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00075700: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00075710: 6172 645f 7369 6c75 5f62 6163 6b28 7061  ard_silu_back(pa
+00075720: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00075730: 635b 305d 2c20 7465 6e73 6f72 2d3e 7372  c[0], tensor->sr
+00075740: 635b 315d 2c20 7465 6e73 6f72 293b 0a20  c[1], tensor);. 
+00075750: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00075760: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00075770: 2047 474d 4c5f 4f50 5f4e 4f52 4d3a 0a20   GGML_OP_NORM:. 
+00075780: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00075790: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000757a0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+000757b0: 645f 6e6f 726d 2870 6172 616d 732c 2074  d_norm(params, t
+000757c0: 656e 736f 722d 3e73 7263 5b30 5d2c 2074  ensor->src[0], t
+000757d0: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+000757e0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000757f0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00075800: 505f 524d 535f 4e4f 524d 3a0a 2020 2020  P_RMS_NORM:.    
+00075810: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00075820: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00075830: 6f6d 7075 7465 5f66 6f72 7761 7264 5f72  ompute_forward_r
+00075840: 6d73 5f6e 6f72 6d28 7061 7261 6d73 2c20  ms_norm(params, 
+00075850: 7465 6e73 6f72 2d3e 7372 635b 305d 2c20  tensor->src[0], 
+00075860: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00075870: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00075880: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00075890: 4f50 5f52 4d53 5f4e 4f52 4d5f 4241 434b  OP_RMS_NORM_BACK
+000758a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000758b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000758c0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000758d0: 7761 7264 5f72 6d73 5f6e 6f72 6d5f 6261  ward_rms_norm_ba
+000758e0: 636b 2870 6172 616d 732c 2074 656e 736f  ck(params, tenso
+000758f0: 722d 3e73 7263 5b30 5d2c 2074 656e 736f  r->src[0], tenso
+00075900: 722d 3e73 7263 5b31 5d2c 2074 656e 736f  r->src[1], tenso
+00075910: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00075920: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00075930: 2063 6173 6520 4747 4d4c 5f4f 505f 4d55   case GGML_OP_MU
+00075940: 4c5f 4d41 543a 0a20 2020 2020 2020 2020  L_MAT:.         
+00075950: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00075960: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00075970: 655f 666f 7277 6172 645f 6d75 6c5f 6d61  e_forward_mul_ma
+00075980: 7428 7061 7261 6d73 2c20 7465 6e73 6f72  t(params, tensor
+00075990: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
+000759a0: 2d3e 7372 635b 315d 2c20 7465 6e73 6f72  ->src[1], tensor
+000759b0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000759c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000759d0: 6361 7365 2047 474d 4c5f 4f50 5f4f 5554  case GGML_OP_OUT
+000759e0: 5f50 524f 443a 0a20 2020 2020 2020 2020  _PROD:.         
+000759f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00075a00: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00075a10: 655f 666f 7277 6172 645f 6f75 745f 7072  e_forward_out_pr
+00075a20: 6f64 2870 6172 616d 732c 2074 656e 736f  od(params, tenso
+00075a30: 722d 3e73 7263 5b30 5d2c 2074 656e 736f  r->src[0], tenso
+00075a40: 722d 3e73 7263 5b31 5d2c 2074 656e 736f  r->src[1], tenso
+00075a50: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00075a60: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00075a70: 2063 6173 6520 4747 4d4c 5f4f 505f 5343   case GGML_OP_SC
+00075a80: 414c 453a 0a20 2020 2020 2020 2020 2020  ALE:.           
+00075a90: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00075aa0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00075ab0: 666f 7277 6172 645f 7363 616c 6528 7061  forward_scale(pa
+00075ac0: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00075ad0: 635b 305d 2c20 7465 6e73 6f72 2d3e 7372  c[0], tensor->sr
+00075ae0: 635b 315d 2c20 7465 6e73 6f72 293b 0a20  c[1], tensor);. 
+00075af0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00075b00: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00075b10: 2047 474d 4c5f 4f50 5f53 4554 3a0a 2020   GGML_OP_SET:.  
+00075b20: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00075b30: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00075b40: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00075b50: 5f73 6574 2870 6172 616d 732c 2074 656e  _set(params, ten
+00075b60: 736f 722d 3e73 7263 5b30 5d2c 2074 656e  sor->src[0], ten
+00075b70: 736f 722d 3e73 7263 5b31 5d2c 2074 656e  sor->src[1], ten
+00075b80: 736f 722d 3e73 7263 5b32 5d2c 2074 656e  sor->src[2], ten
+00075b90: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+00075ba0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00075bb0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00075bc0: 4350 593a 0a20 2020 2020 2020 2020 2020  CPY:.           
+00075bd0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00075be0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00075bf0: 666f 7277 6172 645f 6370 7928 7061 7261  forward_cpy(para
+00075c00: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
+00075c10: 305d 2c20 7465 6e73 6f72 293b 0a20 2020  0], tensor);.   
+00075c20: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00075c30: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00075c40: 474d 4c5f 4f50 5f43 4f4e 543a 0a20 2020  GML_OP_CONT:.   
+00075c50: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00075c60: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00075c70: 636f 6d70 7574 655f 666f 7277 6172 645f  compute_forward_
+00075c80: 636f 6e74 2870 6172 616d 732c 2074 656e  cont(params, ten
+00075c90: 736f 722d 3e73 7263 5b30 5d2c 2074 656e  sor->src[0], ten
+00075ca0: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+00075cb0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00075cc0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00075cd0: 5245 5348 4150 453a 0a20 2020 2020 2020  RESHAPE:.       
+00075ce0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00075cf0: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00075d00: 7574 655f 666f 7277 6172 645f 7265 7368  ute_forward_resh
+00075d10: 6170 6528 7061 7261 6d73 2c20 7465 6e73  ape(params, tens
+00075d20: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+00075d30: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00075d40: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00075d50: 2020 6361 7365 2047 474d 4c5f 4f50 5f56    case GGML_OP_V
+00075d60: 4945 573a 0a20 2020 2020 2020 2020 2020  IEW:.           
+00075d70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00075d80: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00075d90: 666f 7277 6172 645f 7669 6577 2870 6172  forward_view(par
+00075da0: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00075db0: 5b30 5d29 3b0a 2020 2020 2020 2020 2020  [0]);.          
+00075dc0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00075dd0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00075de0: 5045 524d 5554 453a 0a20 2020 2020 2020  PERMUTE:.       
+00075df0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00075e00: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00075e10: 7574 655f 666f 7277 6172 645f 7065 726d  ute_forward_perm
+00075e20: 7574 6528 7061 7261 6d73 2c20 7465 6e73  ute(params, tens
+00075e30: 6f72 2d3e 7372 635b 305d 293b 0a20 2020  or->src[0]);.   
+00075e40: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00075e50: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00075e60: 474d 4c5f 4f50 5f54 5241 4e53 504f 5345  GML_OP_TRANSPOSE
+00075e70: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00075e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075e90: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00075ea0: 7761 7264 5f74 7261 6e73 706f 7365 2870  ward_transpose(p
+00075eb0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00075ec0: 7263 5b30 5d29 3b0a 2020 2020 2020 2020  rc[0]);.        
+00075ed0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00075ee0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00075ef0: 505f 4745 545f 524f 5753 3a0a 2020 2020  P_GET_ROWS:.    
+00075f00: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00075f10: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00075f20: 6f6d 7075 7465 5f66 6f72 7761 7264 5f67  ompute_forward_g
+00075f30: 6574 5f72 6f77 7328 7061 7261 6d73 2c20  et_rows(params, 
+00075f40: 7465 6e73 6f72 2d3e 7372 635b 305d 2c20  tensor->src[0], 
+00075f50: 7465 6e73 6f72 2d3e 7372 635b 315d 2c20  tensor->src[1], 
+00075f60: 7465 6e73 6f72 293b 0a20 2020 2020 2020  tensor);.       
+00075f70: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00075f80: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00075f90: 4f50 5f47 4554 5f52 4f57 535f 4241 434b  OP_GET_ROWS_BACK
+00075fa0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00075fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00075fc0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00075fd0: 7761 7264 5f67 6574 5f72 6f77 735f 6261  ward_get_rows_ba
+00075fe0: 636b 2870 6172 616d 732c 2074 656e 736f  ck(params, tenso
+00075ff0: 722d 3e73 7263 5b30 5d2c 2074 656e 736f  r->src[0], tenso
+00076000: 722d 3e73 7263 5b31 5d2c 2074 656e 736f  r->src[1], tenso
+00076010: 722d 3e73 7263 5b32 5d2c 2074 656e 736f  r->src[2], tenso
+00076020: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00076030: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00076040: 2063 6173 6520 4747 4d4c 5f4f 505f 4449   case GGML_OP_DI
+00076050: 4147 3a0a 2020 2020 2020 2020 2020 2020  AG:.            
+00076060: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00076070: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00076080: 6f72 7761 7264 5f64 6961 6728 7061 7261  orward_diag(para
+00076090: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
+000760a0: 305d 2c20 7465 6e73 6f72 293b 0a20 2020  0], tensor);.   
+000760b0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000760c0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000760d0: 474d 4c5f 4f50 5f44 4941 475f 4d41 534b  GML_OP_DIAG_MASK
+000760e0: 5f49 4e46 3a0a 2020 2020 2020 2020 2020  _INF:.          
+000760f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00076100: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00076110: 5f66 6f72 7761 7264 5f64 6961 675f 6d61  _forward_diag_ma
+00076120: 736b 5f69 6e66 2870 6172 616d 732c 2074  sk_inf(params, t
+00076130: 656e 736f 722d 3e73 7263 5b30 5d2c 2074  ensor->src[0], t
+00076140: 656e 736f 722d 3e73 7263 5b31 5d2c 2074  ensor->src[1], t
+00076150: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00076160: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00076170: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00076180: 505f 4449 4147 5f4d 4153 4b5f 5a45 524f  P_DIAG_MASK_ZERO
+00076190: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000761a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000761b0: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+000761c0: 7761 7264 5f64 6961 675f 6d61 736b 5f7a  ward_diag_mask_z
+000761d0: 6572 6f28 7061 7261 6d73 2c20 7465 6e73  ero(params, tens
+000761e0: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+000761f0: 6f72 2d3e 7372 635b 315d 2c20 7465 6e73  or->src[1], tens
+00076200: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00076210: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00076220: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00076230: 4f46 545f 4d41 583a 0a20 2020 2020 2020  OFT_MAX:.       
+00076240: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00076250: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00076260: 7574 655f 666f 7277 6172 645f 736f 6674  ute_forward_soft
+00076270: 5f6d 6178 2870 6172 616d 732c 2074 656e  _max(params, ten
+00076280: 736f 722d 3e73 7263 5b30 5d2c 2074 656e  sor->src[0], ten
+00076290: 736f 7229 3b0a 2020 2020 2020 2020 2020  sor);.          
+000762a0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000762b0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+000762c0: 534f 4654 5f4d 4158 5f42 4143 4b3a 0a20  SOFT_MAX_BACK:. 
+000762d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000762e0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+000762f0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00076300: 645f 736f 6674 5f6d 6178 5f62 6163 6b28  d_soft_max_back(
+00076310: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+00076320: 7372 635b 305d 2c20 7465 6e73 6f72 2d3e  src[0], tensor->
+00076330: 7372 635b 315d 2c20 7465 6e73 6f72 293b  src[1], tensor);
+00076340: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00076350: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00076360: 7365 2047 474d 4c5f 4f50 5f52 4f50 453a  se GGML_OP_ROPE:
+00076370: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00076380: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00076390: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+000763a0: 6172 645f 726f 7065 2870 6172 616d 732c  ard_rope(params,
+000763b0: 2074 656e 736f 722d 3e73 7263 5b30 5d2c   tensor->src[0],
+000763c0: 2074 656e 736f 722d 3e73 7263 5b31 5d2c   tensor->src[1],
+000763d0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+000763e0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+000763f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00076400: 5f4f 505f 524f 5045 5f42 4143 4b3a 0a20  _OP_ROPE_BACK:. 
+00076410: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00076420: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00076430: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00076440: 645f 726f 7065 5f62 6163 6b28 7061 7261  d_rope_back(para
+00076450: 6d73 2c20 7465 6e73 6f72 2d3e 7372 635b  ms, tensor->src[
+00076460: 305d 2c20 7465 6e73 6f72 2d3e 7372 635b  0], tensor->src[
+00076470: 315d 2c20 7465 6e73 6f72 293b 0a20 2020  1], tensor);.   
+00076480: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00076490: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000764a0: 474d 4c5f 4f50 5f41 4c49 4249 3a0a 2020  GML_OP_ALIBI:.  
+000764b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000764c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000764d0: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+000764e0: 5f61 6c69 6269 2870 6172 616d 732c 2074  _alibi(params, t
+000764f0: 656e 736f 722d 3e73 7263 5b30 5d2c 2074  ensor->src[0], t
+00076500: 656e 736f 722d 3e73 7263 5b31 5d2c 2074  ensor->src[1], t
+00076510: 656e 736f 7229 3b0a 2020 2020 2020 2020  ensor);.        
+00076520: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00076530: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00076540: 505f 434c 414d 503a 0a20 2020 2020 2020  P_CLAMP:.       
+00076550: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00076560: 2020 2020 2020 2067 676d 6c5f 636f 6d70         ggml_comp
+00076570: 7574 655f 666f 7277 6172 645f 636c 616d  ute_forward_clam
+00076580: 7028 7061 7261 6d73 2c20 7465 6e73 6f72  p(params, tensor
+00076590: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
+000765a0: 2d3e 7372 635b 315d 2c20 7465 6e73 6f72  ->src[1], tensor
+000765b0: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+000765c0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000765d0: 6361 7365 2047 474d 4c5f 4f50 5f43 4f4e  case GGML_OP_CON
+000765e0: 565f 3144 3a0a 2020 2020 2020 2020 2020  V_1D:.          
+000765f0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00076600: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00076610: 5f66 6f72 7761 7264 5f63 6f6e 765f 3164  _forward_conv_1d
+00076620: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00076630: 3e73 7263 5b30 5d2c 2074 656e 736f 722d  >src[0], tensor-
+00076640: 3e73 7263 5b31 5d2c 2074 656e 736f 722d  >src[1], tensor-
+00076650: 3e73 7263 5b32 5d2c 2074 656e 736f 7229  >src[2], tensor)
+00076660: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00076670: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00076680: 6173 6520 4747 4d4c 5f4f 505f 434f 4e56  ase GGML_OP_CONV
+00076690: 5f32 443a 0a20 2020 2020 2020 2020 2020  _2D:.           
+000766a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000766b0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+000766c0: 666f 7277 6172 645f 636f 6e76 5f32 6428  forward_conv_2d(
+000766d0: 7061 7261 6d73 2c20 7465 6e73 6f72 2d3e  params, tensor->
+000766e0: 7372 635b 305d 2c20 7465 6e73 6f72 2d3e  src[0], tensor->
+000766f0: 7372 635b 315d 2c20 7465 6e73 6f72 2d3e  src[1], tensor->
+00076700: 7372 635b 325d 2c20 7465 6e73 6f72 293b  src[2], tensor);
+00076710: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00076720: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00076730: 7365 2047 474d 4c5f 4f50 5f50 4f4f 4c5f  se GGML_OP_POOL_
+00076740: 3144 3a0a 2020 2020 2020 2020 2020 2020  1D:.            
+00076750: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00076760: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+00076770: 6f72 7761 7264 5f70 6f6f 6c5f 3164 2870  orward_pool_1d(p
+00076780: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00076790: 7263 5b30 5d2c 2074 656e 736f 722d 3e73  rc[0], tensor->s
+000767a0: 7263 5b31 5d2c 2074 656e 736f 7229 3b0a  rc[1], tensor);.
+000767b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000767c0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000767d0: 6520 4747 4d4c 5f4f 505f 504f 4f4c 5f32  e GGML_OP_POOL_2
+000767e0: 443a 0a20 2020 2020 2020 2020 2020 207b  D:.            {
+000767f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076800: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00076810: 7277 6172 645f 706f 6f6c 5f32 6428 7061  rward_pool_2d(pa
+00076820: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00076830: 635b 305d 2c20 7465 6e73 6f72 2d3e 7372  c[0], tensor->sr
+00076840: 635b 315d 2c20 7465 6e73 6f72 293b 0a20  c[1], tensor);. 
+00076850: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00076860: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+00076870: 2047 474d 4c5f 4f50 5f46 4c41 5348 5f41   GGML_OP_FLASH_A
+00076880: 5454 4e3a 0a20 2020 2020 2020 2020 2020  TTN:.           
+00076890: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000768a0: 2020 2063 6f6e 7374 2069 6e74 3332 5f74     const int32_t
+000768b0: 2074 203d 2067 676d 6c5f 6765 745f 6933   t = ggml_get_i3
+000768c0: 325f 3164 2874 656e 736f 722d 3e73 7263  2_1d(tensor->src
+000768d0: 5b33 5d2c 2030 293b 0a20 2020 2020 2020  [3], 0);.       
+000768e0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+000768f0: 5345 5254 2874 203d 3d20 3020 7c7c 2074  SERT(t == 0 || t
+00076900: 203d 3d20 3129 3b0a 2020 2020 2020 2020   == 1);.        
+00076910: 2020 2020 2020 2020 636f 6e73 7420 626f          const bo
+00076920: 6f6c 206d 6173 6b65 6420 3d20 7420 213d  ol masked = t !=
+00076930: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00076940: 2020 2020 6767 6d6c 5f63 6f6d 7075 7465      ggml_compute
+00076950: 5f66 6f72 7761 7264 5f66 6c61 7368 5f61  _forward_flash_a
+00076960: 7474 6e28 7061 7261 6d73 2c20 7465 6e73  ttn(params, tens
+00076970: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+00076980: 6f72 2d3e 7372 635b 315d 2c20 7465 6e73  or->src[1], tens
+00076990: 6f72 2d3e 7372 635b 325d 2c20 6d61 736b  or->src[2], mask
+000769a0: 6564 2c20 7465 6e73 6f72 293b 0a20 2020  ed, tensor);.   
+000769b0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+000769c0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+000769d0: 474d 4c5f 4f50 5f46 4c41 5348 5f46 463a  GML_OP_FLASH_FF:
+000769e0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000769f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00076a00: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00076a10: 6172 645f 666c 6173 685f 6666 2870 6172  ard_flash_ff(par
+00076a20: 616d 732c 2074 656e 736f 722d 3e73 7263  ams, tensor->src
+00076a30: 5b30 5d2c 2074 656e 736f 722d 3e73 7263  [0], tensor->src
+00076a40: 5b31 5d2c 2074 656e 736f 722d 3e73 7263  [1], tensor->src
+00076a50: 5b32 5d2c 2074 656e 736f 722d 3e73 7263  [2], tensor->src
+00076a60: 5b33 5d2c 2074 656e 736f 722d 3e73 7263  [3], tensor->src
+00076a70: 5b34 5d2c 2074 656e 736f 7229 3b0a 2020  [4], tensor);.  
+00076a80: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00076a90: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00076aa0: 4747 4d4c 5f4f 505f 464c 4153 485f 4154  GGML_OP_FLASH_AT
+00076ab0: 544e 5f42 4143 4b3a 0a20 2020 2020 2020  TN_BACK:.       
+00076ac0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00076ad0: 2020 2020 2020 2069 6e74 3332 5f74 2074         int32_t t
+00076ae0: 203d 2067 676d 6c5f 6765 745f 6933 325f   = ggml_get_i32_
+00076af0: 3164 2874 656e 736f 722d 3e73 7263 5b34  1d(tensor->src[4
+00076b00: 5d2c 2030 293b 0a20 2020 2020 2020 2020  ], 0);.         
+00076b10: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00076b20: 5254 2874 203d 3d20 3020 7c7c 2074 203d  RT(t == 0 || t =
+00076b30: 3d20 3129 3b0a 2020 2020 2020 2020 2020  = 1);.          
+00076b40: 2020 2020 2020 626f 6f6c 206d 6173 6b65        bool maske
+00076b50: 6420 3d20 7420 213d 2030 3b0a 2020 2020  d = t != 0;.    
+00076b60: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00076b70: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00076b80: 5f66 6c61 7368 5f61 7474 6e5f 6261 636b  _flash_attn_back
+00076b90: 2870 6172 616d 732c 2074 656e 736f 722d  (params, tensor-
+00076ba0: 3e73 7263 5b30 5d2c 2074 656e 736f 722d  >src[0], tensor-
+00076bb0: 3e73 7263 5b31 5d2c 2074 656e 736f 722d  >src[1], tensor-
+00076bc0: 3e73 7263 5b32 5d2c 2074 656e 736f 722d  >src[2], tensor-
+00076bd0: 3e73 7263 5b33 5d2c 206d 6173 6b65 642c  >src[3], masked,
+00076be0: 2074 656e 736f 7229 3b0a 2020 2020 2020   tensor);.      
+00076bf0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00076c00: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00076c10: 5f4f 505f 5749 4e5f 5041 5254 3a0a 2020  _OP_WIN_PART:.  
+00076c20: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00076c30: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00076c40: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00076c50: 5f77 696e 5f70 6172 7428 7061 7261 6d73  _win_part(params
+00076c60: 2c20 7465 6e73 6f72 2d3e 7372 635b 305d  , tensor->src[0]
+00076c70: 2c20 7465 6e73 6f72 2d3e 7372 635b 325d  , tensor->src[2]
+00076c80: 2c20 7465 6e73 6f72 293b 0a20 2020 2020  , tensor);.     
+00076c90: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00076ca0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00076cb0: 4c5f 4f50 5f57 494e 5f55 4e50 4152 543a  L_OP_WIN_UNPART:
+00076cc0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00076cd0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00076ce0: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00076cf0: 6172 645f 7769 6e5f 756e 7061 7274 2870  ard_win_unpart(p
+00076d00: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00076d10: 7263 5b30 5d2c 2074 656e 736f 722d 3e73  rc[0], tensor->s
+00076d20: 7263 5b32 5d2c 2074 656e 736f 7229 3b0a  rc[2], tensor);.
+00076d30: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00076d40: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00076d50: 6520 4747 4d4c 5f4f 505f 4d41 505f 554e  e GGML_OP_MAP_UN
+00076d60: 4152 593a 0a20 2020 2020 2020 2020 2020  ARY:.           
+00076d70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00076d80: 2020 2063 6f6e 7374 2067 676d 6c5f 756e     const ggml_un
+00076d90: 6172 795f 6f70 5f66 3332 5f74 2066 756e  ary_op_f32_t fun
+00076da0: 203d 202a 2828 6767 6d6c 5f75 6e61 7279   = *((ggml_unary
+00076db0: 5f6f 705f 6633 325f 7420 2a29 7465 6e73  _op_f32_t *)tens
+00076dc0: 6f72 2d3e 7372 635b 325d 2d3e 6461 7461  or->src[2]->data
+00076dd0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00076de0: 2020 2067 676d 6c5f 636f 6d70 7574 655f     ggml_compute_
+00076df0: 666f 7277 6172 645f 6d61 705f 756e 6172  forward_map_unar
+00076e00: 7928 7061 7261 6d73 2c20 7465 6e73 6f72  y(params, tensor
+00076e10: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
+00076e20: 2c20 6675 6e29 3b0a 2020 2020 2020 2020  , fun);.        
+00076e30: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00076e40: 2020 6272 6561 6b3b 0a20 2020 2020 2020    break;.       
+00076e50: 2063 6173 6520 4747 4d4c 5f4f 505f 4d41   case GGML_OP_MA
+00076e60: 505f 4249 4e41 5259 3a0a 2020 2020 2020  P_BINARY:.      
+00076e70: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00076e80: 2020 2020 2020 2020 636f 6e73 7420 6767          const gg
+00076e90: 6d6c 5f62 696e 6172 795f 6f70 5f66 3332  ml_binary_op_f32
+00076ea0: 5f74 2066 756e 203d 202a 2828 6767 6d6c  _t fun = *((ggml
+00076eb0: 5f62 696e 6172 795f 6f70 5f66 3332 5f74  _binary_op_f32_t
+00076ec0: 202a 2974 656e 736f 722d 3e73 7263 5b32   *)tensor->src[2
+00076ed0: 5d2d 3e64 6174 6129 3b0a 2020 2020 2020  ]->data);.      
+00076ee0: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+00076ef0: 6f6d 7075 7465 5f66 6f72 7761 7264 5f6d  ompute_forward_m
+00076f00: 6170 5f62 696e 6172 7928 7061 7261 6d73  ap_binary(params
+00076f10: 2c20 7465 6e73 6f72 2d3e 7372 635b 305d  , tensor->src[0]
+00076f20: 2c20 7465 6e73 6f72 2d3e 7372 635b 315d  , tensor->src[1]
+00076f30: 2c20 7465 6e73 6f72 2c20 6675 6e29 3b0a  , tensor, fun);.
+00076f40: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00076f50: 2020 2020 2020 2020 2020 6272 6561 6b3b            break;
+00076f60: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00076f70: 4d4c 5f4f 505f 4d41 505f 4355 5354 4f4d  ML_OP_MAP_CUSTOM
+00076f80: 313a 0a20 2020 2020 2020 2020 2020 207b  1:.            {
+00076f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00076fa0: 2063 6f6e 7374 2067 676d 6c5f 6375 7374   const ggml_cust
+00076fb0: 6f6d 315f 6f70 5f66 3332 5f74 2066 756e  om1_op_f32_t fun
+00076fc0: 203d 202a 2828 6767 6d6c 5f63 7573 746f   = *((ggml_custo
+00076fd0: 6d31 5f6f 705f 6633 325f 7420 2a29 7465  m1_op_f32_t *)te
+00076fe0: 6e73 6f72 2d3e 7372 635b 325d 2d3e 6461  nsor->src[2]->da
+00076ff0: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
+00077000: 2020 2020 2067 676d 6c5f 636f 6d70 7574       ggml_comput
+00077010: 655f 666f 7277 6172 645f 6d61 705f 6375  e_forward_map_cu
+00077020: 7374 6f6d 3128 7061 7261 6d73 2c20 7465  stom1(params, te
+00077030: 6e73 6f72 2d3e 7372 635b 305d 2c20 7465  nsor->src[0], te
+00077040: 6e73 6f72 2c20 6675 6e29 3b0a 2020 2020  nsor, fun);.    
+00077050: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00077060: 2020 2020 2020 6272 6561 6b3b 0a20 2020        break;.   
+00077070: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00077080: 505f 4d41 505f 4355 5354 4f4d 323a 0a20  P_MAP_CUSTOM2:. 
+00077090: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+000770a0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000770b0: 7374 2067 676d 6c5f 6375 7374 6f6d 325f  st ggml_custom2_
+000770c0: 6f70 5f66 3332 5f74 2066 756e 203d 202a  op_f32_t fun = *
+000770d0: 2828 6767 6d6c 5f63 7573 746f 6d32 5f6f  ((ggml_custom2_o
+000770e0: 705f 6633 325f 7420 2a29 7465 6e73 6f72  p_f32_t *)tensor
+000770f0: 2d3e 7372 635b 325d 2d3e 6461 7461 293b  ->src[2]->data);
+00077100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077110: 2067 676d 6c5f 636f 6d70 7574 655f 666f   ggml_compute_fo
+00077120: 7277 6172 645f 6d61 705f 6375 7374 6f6d  rward_map_custom
+00077130: 3228 7061 7261 6d73 2c20 7465 6e73 6f72  2(params, tensor
+00077140: 2d3e 7372 635b 305d 2c20 7465 6e73 6f72  ->src[0], tensor
+00077150: 2d3e 7372 635b 315d 2c20 7465 6e73 6f72  ->src[1], tensor
+00077160: 2c20 6675 6e29 3b0a 2020 2020 2020 2020  , fun);.        
+00077170: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00077180: 2020 6272 6561 6b3b 0a20 2020 2020 2020    break;.       
+00077190: 2063 6173 6520 4747 4d4c 5f4f 505f 4d41   case GGML_OP_MA
+000771a0: 505f 4355 5354 4f4d 333a 0a20 2020 2020  P_CUSTOM3:.     
+000771b0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000771c0: 2020 2020 2020 2020 2063 6f6e 7374 2067           const g
+000771d0: 676d 6c5f 6375 7374 6f6d 335f 6f70 5f66  gml_custom3_op_f
+000771e0: 3332 5f74 2066 756e 203d 202a 2828 6767  32_t fun = *((gg
+000771f0: 6d6c 5f63 7573 746f 6d33 5f6f 705f 6633  ml_custom3_op_f3
+00077200: 325f 7420 2a29 7465 6e73 6f72 2d3e 7372  2_t *)tensor->sr
+00077210: 635b 325d 2d3e 6461 7461 293b 0a20 2020  c[2]->data);.   
+00077220: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00077230: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
+00077240: 645f 6d61 705f 6375 7374 6f6d 3328 7061  d_map_custom3(pa
+00077250: 7261 6d73 2c20 7465 6e73 6f72 2d3e 7372  rams, tensor->sr
+00077260: 635b 305d 2c20 7465 6e73 6f72 2d3e 7372  c[0], tensor->sr
+00077270: 635b 315d 2c20 7465 6e73 6f72 2d3e 7372  c[1], tensor->sr
+00077280: 635b 335d 2c20 7465 6e73 6f72 2c20 6675  c[3], tensor, fu
+00077290: 6e29 3b0a 2020 2020 2020 2020 2020 2020  n);.            
+000772a0: 7d0a 2020 2020 2020 2020 2020 2020 6272  }.            br
+000772b0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+000772c0: 6520 4747 4d4c 5f4f 505f 4352 4f53 535f  e GGML_OP_CROSS_
+000772d0: 454e 5452 4f50 595f 4c4f 5353 3a0a 2020  ENTROPY_LOSS:.  
+000772e0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000772f0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+00077300: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
+00077310: 5f63 726f 7373 5f65 6e74 726f 7079 5f6c  _cross_entropy_l
+00077320: 6f73 7328 7061 7261 6d73 2c20 7465 6e73  oss(params, tens
+00077330: 6f72 2d3e 7372 635b 305d 2c20 7465 6e73  or->src[0], tens
+00077340: 6f72 2d3e 7372 635b 315d 2c20 7465 6e73  or->src[1], tens
+00077350: 6f72 293b 0a20 2020 2020 2020 2020 2020  or);.           
+00077360: 207d 0a20 2020 2020 2020 2020 2020 2062   }.            b
+00077370: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00077380: 7365 2047 474d 4c5f 4f50 5f43 524f 5353  se GGML_OP_CROSS
+00077390: 5f45 4e54 524f 5059 5f4c 4f53 535f 4241  _ENTROPY_LOSS_BA
+000773a0: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+000773b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000773c0: 2020 6767 6d6c 5f63 6f6d 7075 7465 5f66    ggml_compute_f
+000773d0: 6f72 7761 7264 5f63 726f 7373 5f65 6e74  orward_cross_ent
+000773e0: 726f 7079 5f6c 6f73 735f 6261 636b 2870  ropy_loss_back(p
+000773f0: 6172 616d 732c 2074 656e 736f 722d 3e73  arams, tensor->s
+00077400: 7263 5b30 5d2c 2074 656e 736f 722d 3e73  rc[0], tensor->s
+00077410: 7263 5b31 5d2c 2074 656e 736f 722d 3e73  rc[1], tensor->s
+00077420: 7263 5b32 5d2c 2074 656e 736f 7229 3b0a  rc[2], tensor);.
+00077430: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00077440: 2020 2020 2020 2020 2020 6272 6561 6b3b            break;
+00077450: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+00077460: 4d4c 5f4f 505f 4e4f 4e45 3a0a 2020 2020  ML_OP_NONE:.    
+00077470: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00077480: 2020 2020 2020 2020 2020 2f2f 206e 6f70            // nop
+00077490: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000774a0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000774b0: 7365 2047 474d 4c5f 4f50 5f43 4f55 4e54  se GGML_OP_COUNT
+000774c0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+000774d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000774e0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+000774f0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00077500: 7d20 6272 6561 6b3b 0a20 2020 207d 0a7d  } break;.    }.}
+00077510: 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ..//////////////
+00077520: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00077530: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00077540: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00077550: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00077560: 2f2f 0a0a 7374 6174 6963 2076 6f69 6420  //..static void 
+00077570: 6767 6d6c 5f63 6f6d 7075 7465 5f62 6163  ggml_compute_bac
+00077580: 6b77 6172 6428 7374 7275 6374 2067 676d  kward(struct ggm
+00077590: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+000775a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000775b0: 736f 7220 2a20 7465 6e73 6f72 2c20 626f  sor * tensor, bo
+000775c0: 6f6c 2069 6e70 6c61 6365 2920 7b0a 2020  ol inplace) {.  
+000775d0: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+000775e0: 6e73 6f72 202a 2073 7263 3020 3d20 7465  nsor * src0 = te
+000775f0: 6e73 6f72 2d3e 7372 635b 305d 3b0a 2020  nsor->src[0];.  
+00077600: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00077610: 6e73 6f72 202a 2073 7263 3120 3d20 7465  nsor * src1 = te
+00077620: 6e73 6f72 2d3e 7372 635b 315d 3b0a 0a20  nsor->src[1];.. 
+00077630: 2020 2073 7769 7463 6820 2874 656e 736f     switch (tenso
+00077640: 722d 3e6f 7029 207b 0a20 2020 2020 2020  r->op) {.       
+00077650: 2063 6173 6520 4747 4d4c 5f4f 505f 4455   case GGML_OP_DU
+00077660: 503a 0a20 2020 2020 2020 2020 2020 207b  P:.            {
+00077670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077680: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+00077690: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000776a0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+000776b0: 6420 3d20 6767 6d6c 5f61 6464 5f69 6d70  d = ggml_add_imp
+000776c0: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
+000776d0: 642c 2074 656e 736f 722d 3e67 7261 642c  d, tensor->grad,
+000776e0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+000776f0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00077700: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00077710: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00077720: 474d 4c5f 4f50 5f41 4444 3a0a 2020 2020  GML_OP_ADD:.    
+00077730: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00077740: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
+00077750: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
+00077760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077770: 7372 6330 2d3e 6772 6164 203d 2067 676d  src0->grad = ggm
+00077780: 6c5f 6164 645f 696d 706c 2863 7478 2c20  l_add_impl(ctx, 
+00077790: 7372 6330 2d3e 6772 6164 2c20 7465 6e73  src0->grad, tens
+000777a0: 6f72 2d3e 6772 6164 2c20 696e 706c 6163  or->grad, inplac
+000777b0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+000777c0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000777d0: 2020 2020 2020 6966 2028 7372 6331 2d3e        if (src1->
+000777e0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+000777f0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00077800: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
+00077810: 645f 696d 706c 2863 7478 2c20 7372 6331  d_impl(ctx, src1
+00077820: 2d3e 6772 6164 2c20 7465 6e73 6f72 2d3e  ->grad, tensor->
+00077830: 6772 6164 2c20 696e 706c 6163 6529 3b0a  grad, inplace);.
+00077840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077850: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
+00077860: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+00077870: 6173 6520 4747 4d4c 5f4f 505f 4144 4431  ase GGML_OP_ADD1
+00077880: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00077890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000778a0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+000778b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000778c0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+000778d0: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
+000778e0: 2863 7478 2c20 7372 6330 2d3e 6772 6164  (ctx, src0->grad
+000778f0: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
+00077900: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+00077910: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00077920: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00077930: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
+00077940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077950: 2020 7372 6331 2d3e 6772 6164 203d 2067    src1->grad = g
+00077960: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
+00077970: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00077980: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+00077990: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+000779a0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000779b0: 6d6c 5f6d 6561 6e28 6374 782c 2074 656e  ml_mean(ctx, ten
+000779c0: 736f 722d 3e67 7261 6429 2c20 2f2f 2054  sor->grad), // T
+000779d0: 4f44 4f3a 2073 686f 756c 6420 7072 6f62  ODO: should prob
+000779e0: 6162 6c79 2062 6520 7375 6d20 696e 7374  ably be sum inst
+000779f0: 6561 6420 6f66 206d 6561 6e0a 2020 2020  ead of mean.    
+00077a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077a10: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+00077a20: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00077a30: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00077a40: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00077a50: 6520 4747 4d4c 5f4f 505f 4143 433a 0a20  e GGML_OP_ACC:. 
+00077a60: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00077a70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00077a80: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+00077a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077aa0: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
+00077ab0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+00077ac0: 782c 2073 7263 302d 3e67 7261 642c 2074  x, src0->grad, t
+00077ad0: 656e 736f 722d 3e67 7261 642c 2069 6e70  ensor->grad, inp
+00077ae0: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+00077af0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00077b00: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+00077b10: 312d 3e67 7261 6429 207b 0a20 2020 2020  1->grad) {.     
+00077b20: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00077b30: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
+00077b40: 6e65 6c65 6d65 6e74 7328 7465 6e73 6f72  nelements(tensor
+00077b50: 2d3e 7372 635b 325d 2920 3d3d 2035 293b  ->src[2]) == 5);
+00077b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077b70: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+00077b80: 2874 656e 736f 722d 3e73 7263 5b32 5d2d  (tensor->src[2]-
+00077b90: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00077ba0: 5045 5f49 3332 293b 0a20 2020 2020 2020  PE_I32);.       
+00077bb0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00077bc0: 7374 2073 697a 655f 7420 6e62 3120 2020  st size_t nb1   
+00077bd0: 2020 3d20 2828 2069 6e74 3332 5f74 202a    = (( int32_t *
+00077be0: 2029 2074 656e 736f 722d 3e73 7263 5b32   ) tensor->src[2
+00077bf0: 5d2d 3e64 6174 6129 5b30 5d3b 0a20 2020  ]->data)[0];.   
+00077c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077c10: 2063 6f6e 7374 2073 697a 655f 7420 6e62   const size_t nb
+00077c20: 3220 2020 2020 3d20 2828 2069 6e74 3332  2     = (( int32
+00077c30: 5f74 202a 2029 2074 656e 736f 722d 3e73  _t * ) tensor->s
+00077c40: 7263 5b32 5d2d 3e64 6174 6129 5b31 5d3b  rc[2]->data)[1];
+00077c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077c60: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+00077c70: 7420 6e62 3320 2020 2020 3d20 2828 2069  t nb3     = (( i
+00077c80: 6e74 3332 5f74 202a 2029 2074 656e 736f  nt32_t * ) tenso
+00077c90: 722d 3e73 7263 5b32 5d2d 3e64 6174 6129  r->src[2]->data)
+00077ca0: 5b32 5d3b 0a20 2020 2020 2020 2020 2020  [2];.           
+00077cb0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
+00077cc0: 697a 655f 7420 6f66 6673 6574 2020 3d20  ize_t offset  = 
+00077cd0: 2828 2069 6e74 3332 5f74 202a 2029 2074  (( int32_t * ) t
+00077ce0: 656e 736f 722d 3e73 7263 5b32 5d2d 3e64  ensor->src[2]->d
+00077cf0: 6174 6129 5b33 5d3b 0a0a 2020 2020 2020  ata)[3];..      
+00077d00: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00077d10: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00077d20: 202a 2074 656e 736f 725f 6772 6164 5f76   * tensor_grad_v
+00077d30: 6965 7720 3d20 6767 6d6c 5f76 6965 775f  iew = ggml_view_
+00077d40: 3464 2863 7478 2c0a 2020 2020 2020 2020  4d(ctx,.        
+00077d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077d60: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
+00077d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077d80: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
+00077d90: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
+00077da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077db0: 2073 7263 312d 3e67 7261 642d 3e6e 655b   src1->grad->ne[
+00077dc0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+00077dd0: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00077de0: 2d3e 6772 6164 2d3e 6e65 5b32 5d2c 0a20  ->grad->ne[2],. 
+00077df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077e00: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+00077e10: 642d 3e6e 655b 335d 2c0a 2020 2020 2020  d->ne[3],.      
+00077e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077e30: 2020 6e62 312c 206e 6232 2c20 6e62 332c    nb1, nb2, nb3,
+00077e40: 206f 6666 7365 7429 3b0a 0a20 2020 2020   offset);..     
+00077e50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00077e60: 7263 312d 3e67 7261 6420 3d0a 2020 2020  rc1->grad =.    
+00077e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077e80: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+00077e90: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
+00077ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077eb0: 2020 2073 7263 312d 3e67 7261 642c 0a20     src1->grad,. 
+00077ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077ed0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00077ee0: 7265 7368 6170 6528 6374 782c 0a20 2020  reshape(ctx,.   
+00077ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077f00: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00077f10: 6c5f 636f 6e74 2863 7478 2c20 7465 6e73  l_cont(ctx, tens
+00077f20: 6f72 5f67 7261 645f 7669 6577 292c 0a20  or_grad_view),. 
+00077f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077f40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00077f50: 7263 312d 3e67 7261 6429 2c0a 2020 2020  rc1->grad),.    
+00077f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00077f70: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+00077f80: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00077f90: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00077fa0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00077fb0: 2063 6173 6520 4747 4d4c 5f4f 505f 5355   case GGML_OP_SU
+00077fc0: 423a 0a20 2020 2020 2020 2020 2020 207b  B:.            {
+00077fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00077fe0: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
+00077ff0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00078000: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+00078010: 6420 3d20 6767 6d6c 5f61 6464 5f69 6d70  d = ggml_add_imp
+00078020: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
+00078030: 642c 2074 656e 736f 722d 3e67 7261 642c  d, tensor->grad,
+00078040: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+00078050: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00078060: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00078070: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
+00078080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078090: 2020 2073 7263 312d 3e67 7261 6420 3d20     src1->grad = 
+000780a0: 6767 6d6c 5f73 7562 5f69 6d70 6c28 6374  ggml_sub_impl(ct
+000780b0: 782c 2073 7263 312d 3e67 7261 642c 2074  x, src1->grad, t
+000780c0: 656e 736f 722d 3e67 7261 642c 2069 6e70  ensor->grad, inp
+000780d0: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+000780e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000780f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00078100: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00078110: 4f50 5f4d 554c 3a0a 2020 2020 2020 2020  OP_MUL:.        
+00078120: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00078130: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00078140: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00078150: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00078160: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+00078170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078180: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+00078190: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+000781a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000781b0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
+000781c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000781d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000781e0: 6767 6d6c 5f6d 756c 2863 7478 2c20 7372  ggml_mul(ctx, sr
+000781f0: 6331 2c20 7465 6e73 6f72 2d3e 6772 6164  c1, tensor->grad
+00078200: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00078210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078220: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+00078230: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00078240: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00078250: 6620 2873 7263 312d 3e67 7261 6429 207b  f (src1->grad) {
+00078260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00078270: 2020 2020 2073 7263 312d 3e67 7261 6420       src1->grad 
+00078280: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
+00078290: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
+000782a0: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
+000782b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000782c0: 2020 2020 2020 2020 2020 2020 2073 7263               src
+000782d0: 312d 3e67 7261 642c 0a20 2020 2020 2020  1->grad,.       
+000782e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000782f0: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
+00078300: 6c28 6374 782c 2073 7263 302c 2074 656e  l(ctx, src0, ten
+00078310: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
+00078320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078330: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+00078340: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+00078350: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00078360: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00078370: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00078380: 505f 4449 563a 0a20 2020 2020 2020 2020  P_DIV:.         
+00078390: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000783a0: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+000783b0: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+000783c0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+000783d0: 3e67 7261 6420 3d0a 2020 2020 2020 2020  >grad =.        
+000783e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000783f0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+00078400: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
 00078410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078430: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-00078440: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00078450: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00078460: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
-00078470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078480: 2020 7372 6331 2d3e 6772 6164 203d 0a20    src1->grad =. 
-00078490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000784a0: 2020 2020 2020 2067 676d 6c5f 7375 625f         ggml_sub_
-000784b0: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-000784c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000784d0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-000784e0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-000784f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078500: 2020 2020 2020 6767 6d6c 5f6d 756c 2863        ggml_mul(c
-00078510: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+00078420: 2020 2073 7263 302d 3e67 7261 642c 0a20     src0->grad,. 
+00078430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078440: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00078450: 676d 6c5f 6469 7628 6374 782c 2074 656e  gml_div(ctx, ten
+00078460: 736f 722d 3e67 7261 642c 2073 7263 3129  sor->grad, src1)
+00078470: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00078480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078490: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
+000784a0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+000784b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000784c0: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
+000784d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000784e0: 2020 2020 7372 6331 2d3e 6772 6164 203d      src1->grad =
+000784f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00078500: 2020 2020 2020 2020 2067 676d 6c5f 7375           ggml_su
+00078510: 625f 696d 706c 2863 7478 2c0a 2020 2020  b_impl(ctx,.    
 00078520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078530: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-00078540: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+00078530: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+00078540: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
 00078550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078560: 2020 2020 2020 2020 2020 6767 6d6c 5f64            ggml_d
-00078570: 6976 2863 7478 2c20 7465 6e73 6f72 2c20  iv(ctx, tensor, 
-00078580: 7372 6331 2929 2c0a 2020 2020 2020 2020  src1)),.        
-00078590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000785a0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
-000785b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000785c0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000785d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000785e0: 2063 6173 6520 4747 4d4c 5f4f 505f 5351   case GGML_OP_SQ
-000785f0: 523a 0a20 2020 2020 2020 2020 2020 207b  R:.            {
-00078600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078610: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-00078620: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00078630: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-00078640: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
-00078650: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00078660: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
-00078670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078680: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00078690: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
-000786a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000786b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-000786c0: 7363 616c 6528 6374 782c 0a20 2020 2020  scale(ctx,.     
-000786d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000786e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000786f0: 676d 6c5f 6d75 6c28 6374 782c 2073 7263  gml_mul(ctx, src
-00078700: 302c 2074 656e 736f 722d 3e67 7261 6429  0, tensor->grad)
-00078710: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00078720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078730: 2020 2020 2020 6767 6d6c 5f6e 6577 5f66        ggml_new_f
-00078740: 3332 2863 7478 2c20 322e 3066 2929 2c0a  32(ctx, 2.0f)),.
-00078750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078770: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-00078780: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00078790: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000787a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000787b0: 4d4c 5f4f 505f 5351 5254 3a0a 2020 2020  ML_OP_SQRT:.    
-000787c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000787d0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000787e0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-000787f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078800: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
-00078810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078820: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
-00078830: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-00078840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078850: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00078860: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+00078560: 2020 2020 2020 2020 6767 6d6c 5f6d 756c          ggml_mul
+00078570: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+00078580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078590: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+000785a0: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+000785b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000785c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000785d0: 5f64 6976 2863 7478 2c20 7465 6e73 6f72  _div(ctx, tensor
+000785e0: 2c20 7372 6331 2929 2c0a 2020 2020 2020  , src1)),.      
+000785f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078600: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
+00078610: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00078620: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00078630: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00078640: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00078650: 5351 523a 0a20 2020 2020 2020 2020 2020  SQR:.           
+00078660: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00078670: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+00078680: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00078690: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+000786a0: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
+000786b0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+000786c0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+000786d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000786e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000786f0: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
+00078700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078710: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00078720: 6c5f 7363 616c 6528 6374 782c 0a20 2020  l_scale(ctx,.   
+00078730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078750: 2067 676d 6c5f 6d75 6c28 6374 782c 2073   ggml_mul(ctx, s
+00078760: 7263 302c 2074 656e 736f 722d 3e67 7261  rc0, tensor->gra
+00078770: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+00078780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078790: 2020 2020 2020 2020 6767 6d6c 5f6e 6577          ggml_new
+000787a0: 5f66 3332 2863 7478 2c20 322e 3066 2929  _f32(ctx, 2.0f))
+000787b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000787c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000787d0: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
+000787e0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+000787f0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00078800: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00078810: 4747 4d4c 5f4f 505f 5351 5254 3a0a 2020  GGML_OP_SQRT:.  
+00078820: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00078830: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00078840: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+00078850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078860: 2020 7372 6330 2d3e 6772 6164 203d 0a20    src0->grad =. 
 00078870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078880: 2020 2020 6767 6d6c 5f73 6361 6c65 2863      ggml_scale(c
-00078890: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+00078880: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
+00078890: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
 000788a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000788b0: 2020 2020 2020 2020 6767 6d6c 5f64 6976          ggml_div
-000788c0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+000788b0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+000788c0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
 000788d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000788e0: 2020 2020 2020 2020 2020 2020 2020 7465                te
-000788f0: 6e73 6f72 2d3e 6772 6164 2c0a 2020 2020  nsor->grad,.    
+000788e0: 2020 2020 2020 6767 6d6c 5f73 6361 6c65        ggml_scale
+000788f0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
 00078900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078920: 2020 2020 7465 6e73 6f72 292c 0a20 2020      tensor),.   
+00078910: 2020 2020 2020 2020 2020 6767 6d6c 5f64            ggml_d
+00078920: 6976 2863 7478 2c0a 2020 2020 2020 2020  iv(ctx,.        
 00078930: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00078940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078950: 2067 676d 6c5f 6e65 775f 6633 3228 6374   ggml_new_f32(ct
-00078960: 782c 2030 2e35 6629 292c 0a20 2020 2020  x, 0.5f)),.     
+00078950: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
+00078960: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00078970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078980: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-00078990: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-000789a0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000789b0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-000789c0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000789d0: 5f4c 4f47 3a0a 2020 2020 2020 2020 2020  _LOG:.          
-000789e0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-000789f0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-00078a00: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-00078a10: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00078a20: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-00078a30: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-00078a40: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-00078a50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00078a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078a70: 2020 7372 6330 2d3e 6772 6164 2c0a 2020    src0->grad,.  
-00078a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078a90: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00078aa0: 6d6c 5f64 6976 2863 7478 2c0a 2020 2020  ml_div(ctx,.    
-00078ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078980: 2020 2020 2020 7465 6e73 6f72 292c 0a20        tensor),. 
+00078990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000789a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000789b0: 2020 2067 676d 6c5f 6e65 775f 6633 3228     ggml_new_f32(
+000789c0: 6374 782c 2030 2e35 6629 292c 0a20 2020  ctx, 0.5f)),.   
+000789d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000789e0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+000789f0: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+00078a00: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00078a10: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00078a20: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00078a30: 4f50 5f4c 4f47 3a0a 2020 2020 2020 2020  OP_LOG:.        
+00078a40: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00078a50: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+00078a60: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00078a70: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00078a80: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
+00078a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078aa0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+00078ab0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
 00078ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078ad0: 7465 6e73 6f72 2d3e 6772 6164 2c0a 2020  tensor->grad,.  
+00078ad0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
 00078ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00078af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078b00: 2020 7372 6330 292c 0a20 2020 2020 2020    src0),.       
+00078b00: 6767 6d6c 5f64 6976 2863 7478 2c0a 2020  ggml_div(ctx,.  
 00078b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078b20: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-00078b30: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00078b40: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00078b50: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00078b60: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
-00078b70: 554d 3a0a 2020 2020 2020 2020 2020 2020  UM:.            
-00078b80: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00078b90: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00078ba0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00078bb0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00078bc0: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
-00078bd0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00078be0: 6c5f 6164 6431 5f69 6d70 6c28 6374 782c  l_add1_impl(ctx,
-00078bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c10: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
-00078c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c30: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-00078c40: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
-00078c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078c60: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-00078c70: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-00078c80: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-00078c90: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00078ca0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00078cb0: 5f53 554d 5f52 4f57 533a 0a20 2020 2020  _SUM_ROWS:.     
-00078cc0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00078cd0: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-00078ce0: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-00078cf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00078d00: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
-00078d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d20: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
-00078d30: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
-00078d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d50: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-00078d60: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00078b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078b30: 2020 7465 6e73 6f72 2d3e 6772 6164 2c0a    tensor->grad,.
+00078b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078b60: 2020 2020 7372 6330 292c 0a20 2020 2020      src0),.     
+00078b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078b80: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+00078b90: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+00078ba0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00078bb0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00078bc0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00078bd0: 5f53 554d 3a0a 2020 2020 2020 2020 2020  _SUM:.          
+00078be0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00078bf0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+00078c00: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00078c10: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00078c20: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
+00078c30: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00078c40: 676d 6c5f 6164 6431 5f69 6d70 6c28 6374  gml_add1_impl(ct
+00078c50: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00078c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078c70: 2020 2073 7263 302d 3e67 7261 642c 0a20     src0->grad,. 
+00078c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078c90: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00078ca0: 656e 736f 722d 3e67 7261 642c 0a20 2020  ensor->grad,.   
+00078cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078cc0: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+00078cd0: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+00078ce0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00078cf0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00078d00: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00078d10: 4f50 5f53 554d 5f52 4f57 533a 0a20 2020  OP_SUM_ROWS:.   
+00078d20: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00078d30: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+00078d40: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
+00078d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078d60: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
 00078d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078d80: 2020 2067 676d 6c5f 7265 7065 6174 2863     ggml_repeat(c
-00078d90: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+00078d80: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
+00078d90: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
 00078da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078db0: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
-00078dc0: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+00078db0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+00078dc0: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
 00078dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078de0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-00078df0: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
+00078de0: 2020 2020 2067 676d 6c5f 7265 7065 6174       ggml_repeat
+00078df0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
 00078e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078e10: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
-00078e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00078e30: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-00078e40: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00078e50: 6361 7365 2047 474d 4c5f 4f50 5f4d 4541  case GGML_OP_MEA
-00078e60: 4e3a 0a20 2020 2020 2020 2063 6173 6520  N:.        case 
-00078e70: 4747 4d4c 5f4f 505f 4152 474d 4158 3a0a  GGML_OP_ARGMAX:.
-00078e80: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00078e90: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00078ea0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-00078eb0: 3b20 2f2f 2054 4f44 4f3a 2069 6d70 6c65  ; // TODO: imple
-00078ec0: 6d65 6e74 0a20 2020 2020 2020 2020 2020  ment.           
-00078ed0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00078ee0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-00078ef0: 4550 4541 543a 0a20 2020 2020 2020 2020  EPEAT:.         
-00078f00: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00078f10: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
-00078f20: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
-00078f30: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00078f40: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
-00078f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078f60: 2020 7372 6330 2d3e 6772 6164 203d 2067    src0->grad = g
-00078f70: 676d 6c5f 6164 645f 696d 706c 2863 7478  gml_add_impl(ctx
-00078f80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00078f90: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-00078fa0: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
+00078e10: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+00078e20: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+00078e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078e40: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+00078e50: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
+00078e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078e70: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+00078e80: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00078e90: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00078ea0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00078eb0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
+00078ec0: 4541 4e3a 0a20 2020 2020 2020 2063 6173  EAN:.        cas
+00078ed0: 6520 4747 4d4c 5f4f 505f 4152 474d 4158  e GGML_OP_ARGMAX
+00078ee0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00078ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00078f00: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+00078f10: 6529 3b20 2f2f 2054 4f44 4f3a 2069 6d70  e); // TODO: imp
+00078f20: 6c65 6d65 6e74 0a20 2020 2020 2020 2020  lement.         
+00078f30: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00078f40: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00078f50: 5f52 4550 4541 543a 0a20 2020 2020 2020  _REPEAT:.       
+00078f60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00078f70: 2020 2020 2020 202f 2f20 6e65 6365 7373         // necess
+00078f80: 6172 7920 666f 7220 6c6c 616d 610a 2020  ary for llama.  
+00078f90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00078fa0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
 00078fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00078fc0: 2020 2020 2020 6767 6d6c 5f72 6570 6561        ggml_repea
-00078fd0: 745f 6261 636b 2863 7478 2c20 7465 6e73  t_back(ctx, tens
-00078fe0: 6f72 2d3e 6772 6164 2c20 7372 6330 2d3e  or->grad, src0->
-00078ff0: 6772 6164 292c 0a20 2020 2020 2020 2020  grad),.         
-00079000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079010: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
-00079020: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-00079030: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00079040: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00079050: 2047 474d 4c5f 4f50 5f52 4550 4541 545f   GGML_OP_REPEAT_
-00079060: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-00079070: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00079080: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-00079090: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-000790a0: 2020 2020 2020 2020 2020 2f2f 2054 4f44            // TOD
-000790b0: 4f3a 2074 6573 7420 7468 6973 0a20 2020  O: test this.   
-000790c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000790d0: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
-000790e0: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
-000790f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079100: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00079110: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
+00078fc0: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
+00078fd0: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
+00078fe0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+00078ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079000: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+00079010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079020: 2020 2020 2020 2020 6767 6d6c 5f72 6570          ggml_rep
+00079030: 6561 745f 6261 636b 2863 7478 2c20 7465  eat_back(ctx, te
+00079040: 6e73 6f72 2d3e 6772 6164 2c20 7372 6330  nsor->grad, src0
+00079050: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
+00079060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079070: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
+00079080: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00079090: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+000790a0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000790b0: 7365 2047 474d 4c5f 4f50 5f52 4550 4541  se GGML_OP_REPEA
+000790c0: 545f 4241 434b 3a0a 2020 2020 2020 2020  T_BACK:.        
+000790d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000790e0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+000790f0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+00079100: 2020 2020 2020 2020 2020 2020 2f2f 2054              // T
+00079110: 4f44 4f3a 2074 6573 7420 7468 6973 0a20  ODO: test this. 
 00079120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079130: 2020 2020 2067 676d 6c5f 7265 7065 6174       ggml_repeat
-00079140: 2863 7478 2c20 7465 6e73 6f72 2d3e 6772  (ctx, tensor->gr
-00079150: 6164 2c20 7372 6330 2d3e 6772 6164 292c  ad, src0->grad),
-00079160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079170: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
-00079180: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-00079190: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000791a0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-000791b0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-000791c0: 4f50 5f41 4253 3a0a 2020 2020 2020 2020  OP_ABS:.        
-000791d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000791e0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-000791f0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
-00079200: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-00079210: 2d3e 6772 6164 203d 0a20 2020 2020 2020  ->grad =.       
-00079220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079230: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-00079240: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
-00079250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079260: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-00079270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079130: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
+00079140: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
+00079150: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+00079160: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00079170: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+00079180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079190: 2020 2020 2020 2067 676d 6c5f 7265 7065         ggml_repe
+000791a0: 6174 2863 7478 2c20 7465 6e73 6f72 2d3e  at(ctx, tensor->
+000791b0: 6772 6164 2c20 7372 6330 2d3e 6772 6164  grad, src0->grad
+000791c0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000791d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000791e0: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+000791f0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00079200: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00079210: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00079220: 4c5f 4f50 5f41 4253 3a0a 2020 2020 2020  L_OP_ABS:.      
+00079230: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00079240: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+00079250: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
+00079260: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+00079270: 6330 2d3e 6772 6164 203d 0a20 2020 2020  c0->grad =.     
 00079280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079290: 6767 6d6c 5f6d 756c 2863 7478 2c0a 2020  ggml_mul(ctx,.  
-000792a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079290: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
+000792a0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
 000792b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000792c0: 2020 6767 6d6c 5f73 676e 2863 7478 2c20    ggml_sgn(ctx, 
-000792d0: 7372 6330 292c 0a20 2020 2020 2020 2020  src0),.         
+000792c0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+000792d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 000792e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000792f0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-00079300: 722d 3e67 7261 6429 2c0a 2020 2020 2020  r->grad),.      
+000792f0: 2020 6767 6d6c 5f6d 756c 2863 7478 2c0a    ggml_mul(ctx,.
+00079300: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00079310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079320: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-00079330: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00079340: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00079350: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00079360: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00079370: 5347 4e3a 0a20 2020 2020 2020 2020 2020  SGN:.           
-00079380: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00079390: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-000793a0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-000793b0: 2020 2020 2020 2020 202f 2f20 6e6f 6f70           // noop
-000793c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000793d0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-000793e0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000793f0: 6361 7365 2047 474d 4c5f 4f50 5f4e 4547  case GGML_OP_NEG
-00079400: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00079410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079420: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-00079430: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00079440: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-00079450: 203d 2067 676d 6c5f 7375 625f 696d 706c   = ggml_sub_impl
-00079460: 2863 7478 2c20 7372 6330 2d3e 6772 6164  (ctx, src0->grad
-00079470: 2c20 7465 6e73 6f72 2d3e 6772 6164 2c20  , tensor->grad, 
-00079480: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
-00079490: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-000794a0: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-000794b0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-000794c0: 4d4c 5f4f 505f 5354 4550 3a0a 2020 2020  ML_OP_STEP:.    
-000794d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-000794e0: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-000794f0: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-00079500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079510: 2f2f 206e 6f6f 700a 2020 2020 2020 2020  // noop.        
-00079520: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00079530: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-00079540: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00079550: 5f4f 505f 5441 4e48 3a0a 2020 2020 2020  _OP_TANH:.      
-00079560: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00079570: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00079580: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-00079590: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
-000795a0: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
-000795b0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000795c0: 2020 6361 7365 2047 474d 4c5f 4f50 5f45    case GGML_OP_E
-000795d0: 4c55 3a0a 2020 2020 2020 2020 2020 2020  LU:.            
-000795e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000795f0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
-00079600: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
-00079610: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
-00079620: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00079630: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00079640: 2047 474d 4c5f 4f50 5f52 454c 553a 0a20   GGML_OP_RELU:. 
-00079650: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00079660: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00079670: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-00079680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079690: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
-000796a0: 6767 6d6c 5f73 7562 5f69 6d70 6c28 6374  ggml_sub_impl(ct
-000796b0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-000796c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000796d0: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
-000796e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000796f0: 2020 2020 2020 2067 676d 6c5f 6d75 6c28         ggml_mul(
-00079700: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-00079710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079720: 2020 2020 2067 676d 6c5f 7374 6570 2863       ggml_step(c
-00079730: 7478 2c20 7372 6330 292c 0a20 2020 2020  tx, src0),.     
+00079320: 2020 2020 6767 6d6c 5f73 676e 2863 7478      ggml_sgn(ctx
+00079330: 2c20 7372 6330 292c 0a20 2020 2020 2020  , src0),.       
+00079340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079350: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+00079360: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
+00079370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079380: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+00079390: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+000793a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000793b0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+000793c0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000793d0: 505f 5347 4e3a 0a20 2020 2020 2020 2020  P_SGN:.         
+000793e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000793f0: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+00079400: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+00079410: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
+00079420: 6f70 0a20 2020 2020 2020 2020 2020 2020  op.             
+00079430: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00079440: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00079450: 2020 6361 7365 2047 474d 4c5f 4f50 5f4e    case GGML_OP_N
+00079460: 4547 3a0a 2020 2020 2020 2020 2020 2020  EG:.            
+00079470: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00079480: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+00079490: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000794a0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+000794b0: 6164 203d 2067 676d 6c5f 7375 625f 696d  ad = ggml_sub_im
+000794c0: 706c 2863 7478 2c20 7372 6330 2d3e 6772  pl(ctx, src0->gr
+000794d0: 6164 2c20 7465 6e73 6f72 2d3e 6772 6164  ad, tensor->grad
+000794e0: 2c20 696e 706c 6163 6529 3b0a 2020 2020  , inplace);.    
+000794f0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00079500: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00079510: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00079520: 4747 4d4c 5f4f 505f 5354 4550 3a0a 2020  GGML_OP_STEP:.  
+00079530: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00079540: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00079550: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+00079560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079570: 2020 2f2f 206e 6f6f 700a 2020 2020 2020    // noop.      
+00079580: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00079590: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+000795a0: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+000795b0: 4d4c 5f4f 505f 5441 4e48 3a0a 2020 2020  ML_OP_TANH:.    
+000795c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000795d0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+000795e0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+000795f0: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+00079600: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+00079610: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00079620: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00079630: 5f45 4c55 3a0a 2020 2020 2020 2020 2020  _ELU:.          
+00079640: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00079650: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00079660: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
+00079670: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+00079680: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00079690: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+000796a0: 7365 2047 474d 4c5f 4f50 5f52 454c 553a  se GGML_OP_RELU:
+000796b0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000796c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000796d0: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+000796e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000796f0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+00079700: 3d20 6767 6d6c 5f73 7562 5f69 6d70 6c28  = ggml_sub_impl(
+00079710: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+00079720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079730: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
 00079740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079750: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-00079760: 722d 3e67 7261 6429 2c0a 2020 2020 2020  r->grad),.      
+00079750: 2020 2020 2020 2020 2067 676d 6c5f 6d75           ggml_mu
+00079760: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
 00079770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079780: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
-00079790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000797a0: 7d0a 2020 2020 2020 2020 2020 2020 7d20  }.            } 
-000797b0: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-000797c0: 6173 6520 4747 4d4c 5f4f 505f 4745 4c55  ase GGML_OP_GELU
-000797d0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-000797e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000797f0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-00079800: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
-00079810: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
-00079820: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-00079830: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-00079840: 474d 4c5f 4f50 5f47 454c 555f 5155 4943  GML_OP_GELU_QUIC
-00079850: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
-00079860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079870: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00079880: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
-00079890: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
-000798a0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-000798b0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-000798c0: 4747 4d4c 5f4f 505f 5349 4c55 3a0a 2020  GGML_OP_SILU:.  
-000798d0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-000798e0: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
-000798f0: 6563 6573 7361 7279 2066 6f72 206c 6c61  ecessary for lla
-00079900: 6d61 0a20 2020 2020 2020 2020 2020 2020  ma.             
-00079910: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
-00079920: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-00079930: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-00079940: 7261 6420 3d20 6767 6d6c 5f61 6464 5f69  rad = ggml_add_i
-00079950: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
-00079960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079970: 2020 2020 2073 7263 302d 3e67 7261 642c       src0->grad,
-00079980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079990: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000799a0: 6c5f 7369 6c75 5f62 6163 6b28 6374 782c  l_silu_back(ctx,
-000799b0: 2073 7263 302c 2074 656e 736f 722d 3e67   src0, tensor->g
-000799c0: 7261 6429 2c0a 2020 2020 2020 2020 2020  rad),.          
-000799d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000799e0: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-000799f0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00079a00: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00079a10: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00079a20: 4747 4d4c 5f4f 505f 5349 4c55 5f42 4143  GGML_OP_SILU_BAC
-00079a30: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
-00079a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00079a50: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
-00079a60: 7365 293b 202f 2f20 544f 444f 3a20 6e6f  se); // TODO: no
-00079a70: 7420 696d 706c 656d 656e 7465 640a 2020  t implemented.  
-00079a80: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00079a90: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00079aa0: 4747 4d4c 5f4f 505f 4e4f 524d 3a0a 2020  GGML_OP_NORM:.  
-00079ab0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00079ac0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00079ad0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-00079ae0: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
-00079af0: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
-00079b00: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00079b10: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00079b20: 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20 2020  OP_RMS_NORM:.   
-00079b30: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00079b40: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
-00079b50: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
-00079b60: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
-00079b70: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
-00079b80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00079b90: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-00079ba0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
-00079bb0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-00079bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079bd0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-00079be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079bf0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00079c00: 5f72 6d73 5f6e 6f72 6d5f 6261 636b 2863  _rms_norm_back(c
-00079c10: 7478 2c20 7372 6330 2c20 7465 6e73 6f72  tx, src0, tensor
-00079c20: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
-00079c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079c40: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-00079c50: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00079c60: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-00079c70: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-00079c80: 7365 2047 474d 4c5f 4f50 5f52 4d53 5f4e  se GGML_OP_RMS_N
-00079c90: 4f52 4d5f 4241 434b 3a0a 2020 2020 2020  ORM_BACK:.      
-00079ca0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00079cb0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00079cc0: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-00079cd0: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
-00079ce0: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
-00079cf0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00079d00: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-00079d10: 554c 5f4d 4154 3a0a 2020 2020 2020 2020  UL_MAT:.        
-00079d20: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00079d30: 2020 2020 2020 2f2f 2068 7474 7073 3a2f        // https:/
-00079d40: 2f63 7332 3331 6e2e 6769 7468 7562 2e69  /cs231n.github.i
-00079d50: 6f2f 6f70 7469 6d69 7a61 7469 6f6e 2d32  o/optimization-2
-00079d60: 2f23 7374 6167 6564 0a20 2020 2020 2020  /#staged.       
-00079d70: 2020 2020 2020 2020 202f 2f20 2320 666f           // # fo
-00079d80: 7277 6172 6420 7061 7373 0a20 2020 2020  rward pass.     
-00079d90: 2020 2020 2020 2020 2020 202f 2f20 7330             // s0
-00079da0: 203d 206e 702e 7261 6e64 6f6d 2e72 616e   = np.random.ran
-00079db0: 646e 2835 2c20 3130 290a 2020 2020 2020  dn(5, 10).      
-00079dc0: 2020 2020 2020 2020 2020 2f2f 2073 3120            // s1 
-00079dd0: 3d20 6e70 2e72 616e 646f 6d2e 7261 6e64  = np.random.rand
-00079de0: 6e28 3130 2c20 3329 0a20 2020 2020 2020  n(10, 3).       
-00079df0: 2020 2020 2020 2020 202f 2f20 7420 3d20           // t = 
-00079e00: 7330 2e64 6f74 2873 3129 0a0a 2020 2020  s0.dot(s1)..    
-00079e10: 2020 2020 2020 2020 2020 2020 2f2f 2023              // #
-00079e20: 206e 6f77 2073 7570 706f 7365 2077 6520   now suppose we 
-00079e30: 6861 6420 7468 6520 6772 6164 6965 6e74  had the gradient
-00079e40: 206f 6e20 7420 6672 6f6d 2061 626f 7665   on t from above
-00079e50: 2069 6e20 7468 6520 6369 7263 7569 740a   in the circuit.
-00079e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079e70: 2f2f 2064 7420 3d20 6e70 2e72 616e 646f  // dt = np.rando
-00079e80: 6d2e 7261 6e64 6e28 2a74 2e73 6861 7065  m.randn(*t.shape
-00079e90: 2920 2320 7361 6d65 2073 6861 7065 2061  ) # same shape a
-00079ea0: 7320 740a 2020 2020 2020 2020 2020 2020  s t.            
-00079eb0: 2020 2020 2f2f 2064 7330 203d 2064 742e      // ds0 = dt.
-00079ec0: 646f 7428 7331 2e54 2920 232e 5420 6769  dot(s1.T) #.T gi
-00079ed0: 7665 7320 7468 6520 7472 616e 7370 6f73  ves the transpos
-00079ee0: 6520 6f66 2074 6865 206d 6174 7269 780a  e of the matrix.
-00079ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079f00: 2f2f 2064 7331 203d 2074 2e54 2e64 6f74  // ds1 = t.T.dot
-00079f10: 2864 7429 0a0a 2020 2020 2020 2020 2020  (dt)..          
-00079f20: 2020 2020 2020 2f2f 2074 656e 736f 722e        // tensor.
-00079f30: 7368 6170 6520 5b6d 2c70 5d0a 2020 2020  shape [m,p].    
-00079f40: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
-00079f50: 7263 302e 7368 6170 6520 2020 5b6e 2c6d  rc0.shape   [n,m
-00079f60: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00079f70: 2020 2f2f 2073 7263 312e 7368 6170 6520    // src1.shape 
-00079f80: 2020 5b6e 2c70 5d0a 0a20 2020 2020 2020    [n,p]..       
-00079f90: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
-00079fa0: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
-00079fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00079fc0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-00079fd0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00079fe0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-00079ff0: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-0007a000: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007a010: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-0007a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a030: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0007a040: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
-0007a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a060: 2020 2020 2020 2020 2020 6767 6d6c 5f6f            ggml_o
-0007a070: 7574 5f70 726f 6428 6374 782c 202f 2f20  ut_prod(ctx, // 
-0007a080: 5b6e 2c6d 5d0a 2020 2020 2020 2020 2020  [n,m].          
+00079780: 2020 2020 2020 2067 676d 6c5f 7374 6570         ggml_step
+00079790: 2863 7478 2c20 7372 6330 292c 0a20 2020  (ctx, src0),.   
+000797a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000797b0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+000797c0: 736f 722d 3e67 7261 6429 2c0a 2020 2020  sor->grad),.    
+000797d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000797e0: 2020 2020 2020 2020 696e 706c 6163 6529          inplace)
+000797f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00079800: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00079810: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00079820: 2063 6173 6520 4747 4d4c 5f4f 505f 4745   case GGML_OP_GE
+00079830: 4c55 3a0a 2020 2020 2020 2020 2020 2020  LU:.            
+00079840: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00079850: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+00079860: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+00079870: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+00079880: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+00079890: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+000798a0: 2047 474d 4c5f 4f50 5f47 454c 555f 5155   GGML_OP_GELU_QU
+000798b0: 4943 4b3a 0a20 2020 2020 2020 2020 2020  ICK:.           
+000798c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000798d0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+000798e0: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+000798f0: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+00079900: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00079910: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00079920: 6520 4747 4d4c 5f4f 505f 5349 4c55 3a0a  e GGML_OP_SILU:.
+00079930: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00079940: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00079950: 206e 6563 6573 7361 7279 2066 6f72 206c   necessary for l
+00079960: 6c61 6d61 0a20 2020 2020 2020 2020 2020  lama.           
+00079970: 2020 2020 2069 6620 2873 7263 302d 3e67       if (src0->g
+00079980: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+00079990: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+000799a0: 3e67 7261 6420 3d20 6767 6d6c 5f61 6464  >grad = ggml_add
+000799b0: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+000799c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000799d0: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+000799e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000799f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00079a00: 676d 6c5f 7369 6c75 5f62 6163 6b28 6374  gml_silu_back(ct
+00079a10: 782c 2073 7263 302c 2074 656e 736f 722d  x, src0, tensor-
+00079a20: 3e67 7261 6429 2c0a 2020 2020 2020 2020  >grad),.        
+00079a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079a40: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+00079a50: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00079a60: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00079a70: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00079a80: 6520 4747 4d4c 5f4f 505f 5349 4c55 5f42  e GGML_OP_SILU_B
+00079a90: 4143 4b3a 0a20 2020 2020 2020 2020 2020  ACK:.           
+00079aa0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00079ab0: 2020 2047 474d 4c5f 4153 5345 5254 2866     GGML_ASSERT(f
+00079ac0: 616c 7365 293b 202f 2f20 544f 444f 3a20  alse); // TODO: 
+00079ad0: 6e6f 7420 696d 706c 656d 656e 7465 640a  not implemented.
+00079ae0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+00079af0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+00079b00: 6520 4747 4d4c 5f4f 505f 4e4f 524d 3a0a  e GGML_OP_NORM:.
+00079b10: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00079b20: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00079b30: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+00079b40: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
+00079b50: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
+00079b60: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00079b70: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00079b80: 4c5f 4f50 5f52 4d53 5f4e 4f52 4d3a 0a20  L_OP_RMS_NORM:. 
+00079b90: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00079ba0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00079bb0: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
+00079bc0: 616d 610a 2020 2020 2020 2020 2020 2020  ama.            
+00079bd0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
+00079be0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+00079bf0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+00079c00: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
+00079c10: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
+00079c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079c30: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+00079c40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00079c50: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00079c60: 6d6c 5f72 6d73 5f6e 6f72 6d5f 6261 636b  ml_rms_norm_back
+00079c70: 2863 7478 2c20 7372 6330 2c20 7465 6e73  (ctx, src0, tens
+00079c80: 6f72 2d3e 6772 6164 292c 0a20 2020 2020  or->grad),.     
+00079c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00079ca0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+00079cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00079cc0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00079cd0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00079ce0: 6361 7365 2047 474d 4c5f 4f50 5f52 4d53  case GGML_OP_RMS
+00079cf0: 5f4e 4f52 4d5f 4241 434b 3a0a 2020 2020  _NORM_BACK:.    
+00079d00: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00079d10: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+00079d20: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+00079d30: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+00079d40: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+00079d50: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00079d60: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00079d70: 5f4d 554c 5f4d 4154 3a0a 2020 2020 2020  _MUL_MAT:.      
+00079d80: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00079d90: 2020 2020 2020 2020 2f2f 2068 7474 7073          // https
+00079da0: 3a2f 2f63 7332 3331 6e2e 6769 7468 7562  ://cs231n.github
+00079db0: 2e69 6f2f 6f70 7469 6d69 7a61 7469 6f6e  .io/optimization
+00079dc0: 2d32 2f23 7374 6167 6564 0a20 2020 2020  -2/#staged.     
+00079dd0: 2020 2020 2020 2020 2020 202f 2f20 2320             // # 
+00079de0: 666f 7277 6172 6420 7061 7373 0a20 2020  forward pass.   
+00079df0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+00079e00: 7330 203d 206e 702e 7261 6e64 6f6d 2e72  s0 = np.random.r
+00079e10: 616e 646e 2835 2c20 3130 290a 2020 2020  andn(5, 10).    
+00079e20: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+00079e30: 3120 3d20 6e70 2e72 616e 646f 6d2e 7261  1 = np.random.ra
+00079e40: 6e64 6e28 3130 2c20 3329 0a20 2020 2020  ndn(10, 3).     
+00079e50: 2020 2020 2020 2020 2020 202f 2f20 7420             // t 
+00079e60: 3d20 7330 2e64 6f74 2873 3129 0a0a 2020  = s0.dot(s1)..  
+00079e70: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00079e80: 2023 206e 6f77 2073 7570 706f 7365 2077   # now suppose w
+00079e90: 6520 6861 6420 7468 6520 6772 6164 6965  e had the gradie
+00079ea0: 6e74 206f 6e20 7420 6672 6f6d 2061 626f  nt on t from abo
+00079eb0: 7665 2069 6e20 7468 6520 6369 7263 7569  ve in the circui
+00079ec0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00079ed0: 2020 2f2f 2064 7420 3d20 6e70 2e72 616e    // dt = np.ran
+00079ee0: 646f 6d2e 7261 6e64 6e28 2a74 2e73 6861  dom.randn(*t.sha
+00079ef0: 7065 2920 2320 7361 6d65 2073 6861 7065  pe) # same shape
+00079f00: 2061 7320 740a 2020 2020 2020 2020 2020   as t.          
+00079f10: 2020 2020 2020 2f2f 2064 7330 203d 2064        // ds0 = d
+00079f20: 742e 646f 7428 7331 2e54 2920 232e 5420  t.dot(s1.T) #.T 
+00079f30: 6769 7665 7320 7468 6520 7472 616e 7370  gives the transp
+00079f40: 6f73 6520 6f66 2074 6865 206d 6174 7269  ose of the matri
+00079f50: 780a 2020 2020 2020 2020 2020 2020 2020  x.              
+00079f60: 2020 2f2f 2064 7331 203d 2074 2e54 2e64    // ds1 = t.T.d
+00079f70: 6f74 2864 7429 0a0a 2020 2020 2020 2020  ot(dt)..        
+00079f80: 2020 2020 2020 2020 2f2f 2074 656e 736f          // tenso
+00079f90: 722e 7368 6170 6520 5b6d 2c70 5d0a 2020  r.shape [m,p].  
+00079fa0: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00079fb0: 2073 7263 302e 7368 6170 6520 2020 5b6e   src0.shape   [n
+00079fc0: 2c6d 5d0a 2020 2020 2020 2020 2020 2020  ,m].            
+00079fd0: 2020 2020 2f2f 2073 7263 312e 7368 6170      // src1.shap
+00079fe0: 6520 2020 5b6e 2c70 5d0a 0a20 2020 2020  e   [n,p]..     
+00079ff0: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+0007a000: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+0007a010: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0007a020: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0007a030: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007a040: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007a050: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+0007a060: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007a070: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+0007a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007a090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a0a0: 2020 2020 2020 2020 2020 7372 6331 2c20            src1, 
-0007a0b0: 2020 2020 2020 2020 202f 2f20 5b6e 2c70           // [n,p
-0007a0c0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0007a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a0e0: 2020 2020 2020 7465 6e73 6f72 2d3e 6772        tensor->gr
-0007a0f0: 6164 292c 202f 2f20 5b6d 2c70 5d0a 2020  ad), // [m,p].  
-0007a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a110: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0007a120: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-0007a130: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0007a140: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-0007a150: 6331 2d3e 6772 6164 2920 7b0a 2020 2020  c1->grad) {.    
+0007a0a0: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+0007a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a0c0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007a0d0: 5f6f 7574 5f70 726f 6428 6374 782c 202f  _out_prod(ctx, /
+0007a0e0: 2f20 5b6e 2c6d 5d0a 2020 2020 2020 2020  / [n,m].        
+0007a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a100: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+0007a110: 2c20 2020 2020 2020 2020 202f 2f20 5b6e  ,          // [n
+0007a120: 2c70 5d0a 2020 2020 2020 2020 2020 2020  ,p].            
+0007a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a140: 2020 2020 2020 2020 7465 6e73 6f72 2d3e          tensor->
+0007a150: 6772 6164 292c 202f 2f20 5b6d 2c70 5d0a  grad), // [m,p].
 0007a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a170: 7372 6331 2d3e 6772 6164 203d 0a20 2020  src1->grad =.   
-0007a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a190: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
-0007a1a0: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
-0007a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a1c0: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
-0007a1d0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a180: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+0007a190: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0007a1a0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0007a1b0: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
+0007a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a1d0: 2020 7372 6331 2d3e 6772 6164 203d 0a20    src1->grad =. 
 0007a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a1f0: 2020 2020 2f2f 2067 676d 6c5f 6d75 6c5f      // ggml_mul_
-0007a200: 6d61 7428 6374 782c 2020 2020 2020 2020  mat(ctx,        
-0007a210: 2020 2020 2020 2020 2020 202f 2f20 5b6e             // [n
-0007a220: 2c70 5d0a 2020 2020 2020 2020 2020 2020  ,p].            
-0007a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a240: 2020 2020 2f2f 2020 2020 2067 676d 6c5f      //     ggml_
-0007a250: 636f 6e74 2863 7478 2c20 2020 2020 2020  cont(ctx,       
-0007a260: 2020 2020 2020 2020 2020 202f 2f20 5b6d             // [m
-0007a270: 2c6e 5d0a 2020 2020 2020 2020 2020 2020  ,n].            
-0007a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a290: 2020 2020 2f2f 2020 2020 2020 2020 2067      //         g
-0007a2a0: 676d 6c5f 7472 616e 7370 6f73 6528 6374  gml_transpose(ct
-0007a2b0: 782c 2073 7263 3029 292c 202f 2f20 5b6d  x, src0)), // [m
-0007a2c0: 2c6e 5d0a 2020 2020 2020 2020 2020 2020  ,n].            
-0007a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a2e0: 2020 2020 2f2f 2020 2020 2074 656e 736f      //     tenso
-0007a2f0: 722d 3e67 7261 6429 2c20 2020 2020 2020  r->grad),       
-0007a300: 2020 2020 2020 2020 2020 202f 2f20 5b6d             // [m
-0007a310: 2c70 5d0a 0a20 2020 2020 2020 2020 2020  ,p]..           
-0007a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a330: 2020 2020 202f 2f20 2f2f 2077 6865 6e20       // // when 
-0007a340: 7372 6330 2069 7320 6269 6767 6572 2074  src0 is bigger t
-0007a350: 6861 6e20 7465 6e73 6f72 2d3e 6772 6164  han tensor->grad
-0007a360: 2028 7468 6973 2069 7320 6d6f 7374 6c79   (this is mostly
-0007a370: 2074 6865 2063 6173 6520 696e 206c 6c61   the case in lla
-0007a380: 6d61 292c 0a20 2020 2020 2020 2020 2020  ma),.           
-0007a390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a3a0: 2020 2020 202f 2f20 2f2f 2061 766f 6964       // // avoid
-0007a3b0: 2074 7261 6e73 706f 7365 206f 6620 7372   transpose of sr
-0007a3c0: 6330 2c20 7261 7468 6572 2074 7261 6e73  c0, rather trans
-0007a3d0: 706f 7365 2073 6d61 6c6c 6572 2074 656e  pose smaller ten
-0007a3e0: 736f 722d 3e67 7261 640a 2020 2020 2020  sor->grad.      
+0007a1f0: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
+0007a200: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
+0007a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a220: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+0007a230: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
+0007a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a250: 2020 2020 2020 2f2f 2067 676d 6c5f 6d75        // ggml_mu
+0007a260: 6c5f 6d61 7428 6374 782c 2020 2020 2020  l_mat(ctx,      
+0007a270: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0007a280: 5b6e 2c70 5d0a 2020 2020 2020 2020 2020  [n,p].          
+0007a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a2a0: 2020 2020 2020 2f2f 2020 2020 2067 676d        //     ggm
+0007a2b0: 6c5f 636f 6e74 2863 7478 2c20 2020 2020  l_cont(ctx,     
+0007a2c0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0007a2d0: 5b6d 2c6e 5d0a 2020 2020 2020 2020 2020  [m,n].          
+0007a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a2f0: 2020 2020 2020 2f2f 2020 2020 2020 2020        //        
+0007a300: 2067 676d 6c5f 7472 616e 7370 6f73 6528   ggml_transpose(
+0007a310: 6374 782c 2073 7263 3029 292c 202f 2f20  ctx, src0)), // 
+0007a320: 5b6d 2c6e 5d0a 2020 2020 2020 2020 2020  [m,n].          
+0007a330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a340: 2020 2020 2020 2f2f 2020 2020 2074 656e        //     ten
+0007a350: 736f 722d 3e67 7261 6429 2c20 2020 2020  sor->grad),     
+0007a360: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0007a370: 5b6d 2c70 5d0a 0a20 2020 2020 2020 2020  [m,p]..         
+0007a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a390: 2020 2020 2020 202f 2f20 2f2f 2077 6865         // // whe
+0007a3a0: 6e20 7372 6330 2069 7320 6269 6767 6572  n src0 is bigger
+0007a3b0: 2074 6861 6e20 7465 6e73 6f72 2d3e 6772   than tensor->gr
+0007a3c0: 6164 2028 7468 6973 2069 7320 6d6f 7374  ad (this is most
+0007a3d0: 6c79 2074 6865 2063 6173 6520 696e 206c  ly the case in l
+0007a3e0: 6c61 6d61 292c 0a20 2020 2020 2020 2020  lama),.         
 0007a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a400: 2020 2020 2020 2020 2020 2f2f 202f 2f20            // // 
-0007a410: 616e 6420 7468 656e 2075 7365 2067 676d  and then use ggm
-0007a420: 6c5f 6f75 745f 7072 6f64 0a20 2020 2020  l_out_prod.     
-0007a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a440: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007a450: 6f75 745f 7072 6f64 2863 7478 2c20 2020  out_prod(ctx,   
-0007a460: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007a470: 2f20 5b6e 2c70 5d0a 2020 2020 2020 2020  / [n,p].        
-0007a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a490: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0007a4a0: 2c20 2020 2020 2020 2020 2020 2020 2020  ,               
-0007a4b0: 2020 2020 2020 2020 2020 2020 2f2f 205b              // [
-0007a4c0: 6e2c 6d5d 0a20 2020 2020 2020 2020 2020  n,m].           
-0007a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a4e0: 2020 2020 2020 2020 2067 676d 6c5f 7472           ggml_tr
-0007a4f0: 616e 7370 6f73 6528 6374 782c 2020 2020  anspose(ctx,    
-0007a500: 2020 2020 2020 2020 202f 2f20 5b70 2c6d           // [p,m
-0007a510: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0007a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a530: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-0007a540: 2d3e 6772 6164 2929 2c20 2020 2020 2020  ->grad)),       
-0007a550: 2020 2020 2020 2f2f 205b 6d2c 705d 0a20        // [m,p]. 
-0007a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a570: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007a580: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0007a590: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007a5a0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007a5b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007a5c0: 4c5f 4f50 5f4f 5554 5f50 524f 443a 0a20  L_OP_OUT_PROD:. 
-0007a5d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0007a5e0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-0007a5f0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-0007a600: 202f 2f20 544f 444f 3a20 6e6f 7420 696d   // TODO: not im
-0007a610: 706c 656d 656e 7465 640a 2020 2020 2020  plemented.      
-0007a620: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0007a630: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-0007a640: 5f4f 505f 5343 414c 453a 0a20 2020 2020  _OP_SCALE:.     
-0007a650: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0007a660: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
-0007a670: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
-0007a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a690: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-0007a6a0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007a6b0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-0007a6c0: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-0007a6d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007a6e0: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
-0007a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a700: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0007a710: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-0007a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a730: 2020 6767 6d6c 5f73 6361 6c65 5f69 6d70    ggml_scale_imp
-0007a740: 6c28 6374 782c 2074 656e 736f 722d 3e67  l(ctx, tensor->g
-0007a750: 7261 642c 2073 7263 312c 2066 616c 7365  rad, src1, false
-0007a760: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0007a770: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007a780: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0007a790: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0007a7a0: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007a7b0: 7263 312d 3e67 7261 6429 207b 0a20 2020  rc1->grad) {.   
-0007a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a7d0: 2073 7263 312d 3e67 7261 6420 3d0a 2020   src1->grad =.  
-0007a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a7f0: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
-0007a800: 6d70 6c28 6374 782c 0a20 2020 2020 2020  mpl(ctx,.       
-0007a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a820: 2020 2020 2073 7263 312d 3e67 7261 642c       src1->grad,
-0007a830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007a840: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007a850: 6c5f 7375 6d28 6374 782c 2067 676d 6c5f  l_sum(ctx, ggml_
-0007a860: 6d75 6c5f 696d 706c 2863 7478 2c20 7465  mul_impl(ctx, te
-0007a870: 6e73 6f72 2d3e 6772 6164 2c20 7372 6330  nsor->grad, src0
-0007a880: 2c20 6661 6c73 6529 292c 0a20 2020 2020  , false)),.     
-0007a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a8a0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
-0007a8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007a8c0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
-0007a8d0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007a8e0: 6361 7365 2047 474d 4c5f 4f50 5f53 4554  case GGML_OP_SET
-0007a8f0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007a910: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0007a920: 5f6e 656c 656d 656e 7473 2874 656e 736f  _nelements(tenso
-0007a930: 722d 3e73 7263 5b32 5d29 203d 3d20 3529  r->src[2]) == 5)
-0007a940: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007a950: 2020 4747 4d4c 5f41 5353 4552 5428 7465    GGML_ASSERT(te
-0007a960: 6e73 6f72 2d3e 7372 635b 325d 2d3e 7479  nsor->src[2]->ty
-0007a970: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-0007a980: 4933 3229 3b0a 2020 2020 2020 2020 2020  I32);.          
-0007a990: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-0007a9a0: 5f74 206e 6231 2020 2020 203d 2028 2820  _t nb1     = (( 
-0007a9b0: 696e 7433 325f 7420 2a20 2920 7465 6e73  int32_t * ) tens
-0007a9c0: 6f72 2d3e 7372 635b 325d 2d3e 6461 7461  or->src[2]->data
-0007a9d0: 295b 305d 3b0a 2020 2020 2020 2020 2020  )[0];.          
-0007a9e0: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-0007a9f0: 5f74 206e 6232 2020 2020 203d 2028 2820  _t nb2     = (( 
-0007aa00: 696e 7433 325f 7420 2a20 2920 7465 6e73  int32_t * ) tens
-0007aa10: 6f72 2d3e 7372 635b 325d 2d3e 6461 7461  or->src[2]->data
-0007aa20: 295b 315d 3b0a 2020 2020 2020 2020 2020  )[1];.          
-0007aa30: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-0007aa40: 5f74 206e 6233 2020 2020 203d 2028 2820  _t nb3     = (( 
-0007aa50: 696e 7433 325f 7420 2a20 2920 7465 6e73  int32_t * ) tens
-0007aa60: 6f72 2d3e 7372 635b 325d 2d3e 6461 7461  or->src[2]->data
-0007aa70: 295b 325d 3b0a 2020 2020 2020 2020 2020  )[2];.          
-0007aa80: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-0007aa90: 5f74 206f 6666 7365 7420 203d 2028 2820  _t offset  = (( 
-0007aaa0: 696e 7433 325f 7420 2a20 2920 7465 6e73  int32_t * ) tens
-0007aab0: 6f72 2d3e 7372 635b 325d 2d3e 6461 7461  or->src[2]->data
-0007aac0: 295b 335d 3b0a 0a20 2020 2020 2020 2020  )[3];..         
-0007aad0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0007aae0: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
-0007aaf0: 6f72 5f67 7261 645f 7669 6577 203d 204e  or_grad_view = N
-0007ab00: 554c 4c3b 0a0a 2020 2020 2020 2020 2020  ULL;..          
-0007ab10: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
-0007ab20: 6772 6164 207c 7c20 7372 6331 2d3e 6772  grad || src1->gr
-0007ab30: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007ab40: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-0007ab50: 5353 4552 5428 7372 6330 2d3e 7479 7065  SSERT(src0->type
-0007ab60: 203d 3d20 7465 6e73 6f72 2d3e 7479 7065   == tensor->type
-0007ab70: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007ab80: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0007ab90: 5254 2874 656e 736f 722d 3e67 7261 642d  RT(tensor->grad-
-0007aba0: 3e74 7970 6520 3d3d 2074 656e 736f 722d  >type == tensor-
-0007abb0: 3e74 7970 6529 3b0a 2020 2020 2020 2020  >type);.        
-0007abc0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0007abd0: 5f41 5353 4552 5428 7465 6e73 6f72 2d3e  _ASSERT(tensor->
-0007abe0: 6772 6164 2d3e 7479 7065 203d 3d20 7372  grad->type == sr
-0007abf0: 6331 2d3e 6772 6164 2d3e 7479 7065 293b  c1->grad->type);
-0007ac00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007ac10: 2020 2020 2020 7465 6e73 6f72 5f67 7261        tensor_gra
-0007ac20: 645f 7669 6577 203d 2067 676d 6c5f 7669  d_view = ggml_vi
-0007ac30: 6577 5f34 6428 6374 782c 0a20 2020 2020  ew_4d(ctx,.     
-0007ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ac50: 2020 2074 656e 736f 722d 3e67 7261 642c     tensor->grad,
-0007ac60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ac70: 2020 2020 2020 2020 2073 7263 312d 3e67           src1->g
-0007ac80: 7261 642d 3e6e 655b 305d 2c0a 2020 2020  rad->ne[0],.    
-0007ac90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007aca0: 2020 2020 7372 6331 2d3e 6772 6164 2d3e      src1->grad->
-0007acb0: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
-0007acc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007acd0: 7263 312d 3e67 7261 642d 3e6e 655b 325d  rc1->grad->ne[2]
-0007ace0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007acf0: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
-0007ad00: 6772 6164 2d3e 6e65 5b33 5d2c 0a20 2020  grad->ne[3],.   
-0007ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ad20: 2020 2020 206e 6231 2c20 6e62 322c 206e       nb1, nb2, n
-0007ad30: 6233 2c20 6f66 6673 6574 293b 0a20 2020  b3, offset);.   
-0007ad40: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-0007ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ad60: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-0007ad70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007ad80: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-0007ad90: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
-0007ada0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-0007adb0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0007adc0: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
-0007add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ade0: 2020 6767 6d6c 5f61 6363 5f69 6d70 6c28    ggml_acc_impl(
-0007adf0: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
-0007ae00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ae10: 2074 656e 736f 722d 3e67 7261 642c 0a20   tensor->grad,. 
-0007ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ae30: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007ae40: 6e65 6728 6374 782c 2074 656e 736f 725f  neg(ctx, tensor_
-0007ae50: 6772 6164 5f76 6965 7729 2c0a 2020 2020  grad_view),.    
+0007a400: 2020 2020 2020 202f 2f20 2f2f 2061 766f         // // avo
+0007a410: 6964 2074 7261 6e73 706f 7365 206f 6620  id transpose of 
+0007a420: 7372 6330 2c20 7261 7468 6572 2074 7261  src0, rather tra
+0007a430: 6e73 706f 7365 2073 6d61 6c6c 6572 2074  nspose smaller t
+0007a440: 656e 736f 722d 3e67 7261 640a 2020 2020  ensor->grad.    
+0007a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a460: 2020 2020 2020 2020 2020 2020 2f2f 202f              // /
+0007a470: 2f20 616e 6420 7468 656e 2075 7365 2067  / and then use g
+0007a480: 676d 6c5f 6f75 745f 7072 6f64 0a20 2020  gml_out_prod.   
+0007a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a4a0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007a4b0: 6c5f 6f75 745f 7072 6f64 2863 7478 2c20  l_out_prod(ctx, 
+0007a4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a4d0: 202f 2f20 5b6e 2c70 5d0a 2020 2020 2020   // [n,p].      
+0007a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a4f0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007a500: 6330 2c20 2020 2020 2020 2020 2020 2020  c0,             
+0007a510: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+0007a520: 205b 6e2c 6d5d 0a20 2020 2020 2020 2020   [n,m].         
+0007a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a540: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0007a550: 7472 616e 7370 6f73 6528 6374 782c 2020  transpose(ctx,  
+0007a560: 2020 2020 2020 2020 2020 202f 2f20 5b70             // [p
+0007a570: 2c6d 5d0a 2020 2020 2020 2020 2020 2020  ,m].            
+0007a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a590: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+0007a5a0: 6f72 2d3e 6772 6164 2929 2c20 2020 2020  or->grad)),     
+0007a5b0: 2020 2020 2020 2020 2f2f 205b 6d2c 705d          // [m,p]
+0007a5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a5e0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+0007a5f0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0007a600: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0007a610: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0007a620: 474d 4c5f 4f50 5f4f 5554 5f50 524f 443a  GML_OP_OUT_PROD:
+0007a630: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007a640: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0007a650: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0007a660: 293b 202f 2f20 544f 444f 3a20 6e6f 7420  ); // TODO: not 
+0007a670: 696d 706c 656d 656e 7465 640a 2020 2020  implemented.    
+0007a680: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0007a690: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
+0007a6a0: 4d4c 5f4f 505f 5343 414c 453a 0a20 2020  ML_OP_SCALE:.   
+0007a6b0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007a6c0: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+0007a6d0: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+0007a6e0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0007a6f0: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0007a700: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007a710: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007a720: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+0007a730: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007a740: 6c5f 6164 645f 696d 706c 2863 7478 2c0a  l_add_impl(ctx,.
+0007a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a760: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0007a770: 2d3e 6772 6164 2c0a 2020 2020 2020 2020  ->grad,.        
+0007a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a790: 2020 2020 6767 6d6c 5f73 6361 6c65 5f69      ggml_scale_i
+0007a7a0: 6d70 6c28 6374 782c 2074 656e 736f 722d  mpl(ctx, tensor-
+0007a7b0: 3e67 7261 642c 2073 7263 312c 2066 616c  >grad, src1, fal
+0007a7c0: 7365 292c 0a20 2020 2020 2020 2020 2020  se),.           
+0007a7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a7e0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+0007a7f0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+0007a800: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007a810: 2873 7263 312d 3e67 7261 6429 207b 0a20  (src1->grad) {. 
+0007a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a830: 2020 2073 7263 312d 3e67 7261 6420 3d0a     src1->grad =.
+0007a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a850: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+0007a860: 5f69 6d70 6c28 6374 782c 0a20 2020 2020  _impl(ctx,.     
+0007a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a880: 2020 2020 2020 2073 7263 312d 3e67 7261         src1->gra
+0007a890: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0007a8a0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007a8b0: 676d 6c5f 7375 6d28 6374 782c 2067 676d  gml_sum(ctx, ggm
+0007a8c0: 6c5f 6d75 6c5f 696d 706c 2863 7478 2c20  l_mul_impl(ctx, 
+0007a8d0: 7465 6e73 6f72 2d3e 6772 6164 2c20 7372  tensor->grad, sr
+0007a8e0: 6330 2c20 6661 6c73 6529 292c 0a20 2020  c0, false)),.   
+0007a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007a900: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
+0007a910: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+0007a920: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0007a930: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0007a940: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+0007a950: 4554 3a0a 2020 2020 2020 2020 2020 2020  ET:.            
+0007a960: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007a970: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0007a980: 6d6c 5f6e 656c 656d 656e 7473 2874 656e  ml_nelements(ten
+0007a990: 736f 722d 3e73 7263 5b32 5d29 203d 3d20  sor->src[2]) == 
+0007a9a0: 3529 3b0a 2020 2020 2020 2020 2020 2020  5);.            
+0007a9b0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0007a9c0: 7465 6e73 6f72 2d3e 7372 635b 325d 2d3e  tensor->src[2]->
+0007a9d0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+0007a9e0: 455f 4933 3229 3b0a 2020 2020 2020 2020  E_I32);.        
+0007a9f0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0007aa00: 7a65 5f74 206e 6231 2020 2020 203d 2028  ze_t nb1     = (
+0007aa10: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+0007aa20: 6e73 6f72 2d3e 7372 635b 325d 2d3e 6461  nsor->src[2]->da
+0007aa30: 7461 295b 305d 3b0a 2020 2020 2020 2020  ta)[0];.        
+0007aa40: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0007aa50: 7a65 5f74 206e 6232 2020 2020 203d 2028  ze_t nb2     = (
+0007aa60: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+0007aa70: 6e73 6f72 2d3e 7372 635b 325d 2d3e 6461  nsor->src[2]->da
+0007aa80: 7461 295b 315d 3b0a 2020 2020 2020 2020  ta)[1];.        
+0007aa90: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0007aaa0: 7a65 5f74 206e 6233 2020 2020 203d 2028  ze_t nb3     = (
+0007aab0: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+0007aac0: 6e73 6f72 2d3e 7372 635b 325d 2d3e 6461  nsor->src[2]->da
+0007aad0: 7461 295b 325d 3b0a 2020 2020 2020 2020  ta)[2];.        
+0007aae0: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0007aaf0: 7a65 5f74 206f 6666 7365 7420 203d 2028  ze_t offset  = (
+0007ab00: 2820 696e 7433 325f 7420 2a20 2920 7465  ( int32_t * ) te
+0007ab10: 6e73 6f72 2d3e 7372 635b 325d 2d3e 6461  nsor->src[2]->da
+0007ab20: 7461 295b 335d 3b0a 0a20 2020 2020 2020  ta)[3];..       
+0007ab30: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+0007ab40: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
+0007ab50: 6e73 6f72 5f67 7261 645f 7669 6577 203d  nsor_grad_view =
+0007ab60: 204e 554c 4c3b 0a0a 2020 2020 2020 2020   NULL;..        
+0007ab70: 2020 2020 2020 2020 6966 2028 7372 6330          if (src0
+0007ab80: 2d3e 6772 6164 207c 7c20 7372 6331 2d3e  ->grad || src1->
+0007ab90: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0007aba0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0007abb0: 5f41 5353 4552 5428 7372 6330 2d3e 7479  _ASSERT(src0->ty
+0007abc0: 7065 203d 3d20 7465 6e73 6f72 2d3e 7479  pe == tensor->ty
+0007abd0: 7065 293b 0a20 2020 2020 2020 2020 2020  pe);.           
+0007abe0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0007abf0: 5345 5254 2874 656e 736f 722d 3e67 7261  SERT(tensor->gra
+0007ac00: 642d 3e74 7970 6520 3d3d 2074 656e 736f  d->type == tenso
+0007ac10: 722d 3e74 7970 6529 3b0a 2020 2020 2020  r->type);.      
+0007ac20: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0007ac30: 4d4c 5f41 5353 4552 5428 7465 6e73 6f72  ML_ASSERT(tensor
+0007ac40: 2d3e 6772 6164 2d3e 7479 7065 203d 3d20  ->grad->type == 
+0007ac50: 7372 6331 2d3e 6772 6164 2d3e 7479 7065  src1->grad->type
+0007ac60: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+0007ac70: 2020 2020 2020 2020 7465 6e73 6f72 5f67          tensor_g
+0007ac80: 7261 645f 7669 6577 203d 2067 676d 6c5f  rad_view = ggml_
+0007ac90: 7669 6577 5f34 6428 6374 782c 0a20 2020  view_4d(ctx,.   
+0007aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007acb0: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
+0007acc0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0007acd0: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
+0007ace0: 3e67 7261 642d 3e6e 655b 305d 2c0a 2020  >grad->ne[0],.  
+0007acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ad00: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
+0007ad10: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
+0007ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ad30: 2073 7263 312d 3e67 7261 642d 3e6e 655b   src1->grad->ne[
+0007ad40: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
+0007ad50: 2020 2020 2020 2020 2020 2020 7372 6331              src1
+0007ad60: 2d3e 6772 6164 2d3e 6e65 5b33 5d2c 0a20  ->grad->ne[3],. 
+0007ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ad80: 2020 2020 2020 206e 6231 2c20 6e62 322c         nb1, nb2,
+0007ad90: 206e 6233 2c20 6f66 6673 6574 293b 0a20   nb3, offset);. 
+0007ada0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0007adb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0007adc0: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0007add0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007ade0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007adf0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+0007ae00: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0007ae10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ae20: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+0007ae30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ae40: 2020 2020 6767 6d6c 5f61 6363 5f69 6d70      ggml_acc_imp
+0007ae50: 6c28 6374 782c 0a20 2020 2020 2020 2020  l(ctx,.         
 0007ae60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ae70: 2020 2020 2020 2020 6e62 312c 206e 6232          nb1, nb2
-0007ae80: 2c20 6e62 332c 206f 6666 7365 742c 2066  , nb3, offset, f
-0007ae90: 616c 7365 292c 0a20 2020 2020 2020 2020  alse),.         
-0007aea0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0007aeb0: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
-0007aec0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-0007aed0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0007aee0: 7372 6331 2d3e 6772 6164 2920 7b0a 2020  src1->grad) {.  
-0007aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007af00: 2020 7372 6331 2d3e 6772 6164 203d 0a20    src1->grad =. 
-0007af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007af20: 2020 2020 2020 2067 676d 6c5f 6164 645f         ggml_add_
-0007af30: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-0007af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007af50: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
-0007af60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007af70: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007af80: 6d6c 5f72 6573 6861 7065 2863 7478 2c0a  ml_reshape(ctx,.
-0007af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ae70: 2020 2074 656e 736f 722d 3e67 7261 642c     tensor->grad,
+0007ae80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ae90: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007aea0: 6c5f 6e65 6728 6374 782c 2074 656e 736f  l_neg(ctx, tenso
+0007aeb0: 725f 6772 6164 5f76 6965 7729 2c0a 2020  r_grad_view),.  
+0007aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007aed0: 2020 2020 2020 2020 2020 6e62 312c 206e            nb1, n
+0007aee0: 6232 2c20 6e62 332c 206f 6666 7365 742c  b2, nb3, offset,
+0007aef0: 2066 616c 7365 292c 0a20 2020 2020 2020   false),.       
+0007af00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007af10: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
+0007af20: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+0007af30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0007af40: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
+0007af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007af60: 2020 2020 7372 6331 2d3e 6772 6164 203d      src1->grad =
+0007af70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007af80: 2020 2020 2020 2020 2067 676d 6c5f 6164           ggml_ad
+0007af90: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
 0007afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007afb0: 6767 6d6c 5f63 6f6e 7428 6374 782c 2074  ggml_cont(ctx, t
-0007afc0: 656e 736f 725f 6772 6164 5f76 6965 7729  ensor_grad_view)
-0007afd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007aff0: 2020 7372 6331 2d3e 6772 6164 292c 0a20    src1->grad),. 
+0007afb0: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+0007afc0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007afe0: 6767 6d6c 5f72 6573 6861 7065 2863 7478  ggml_reshape(ctx
+0007aff0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0007b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b010: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
-0007b020: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
-0007b030: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0007b040: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007b050: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007b060: 5f43 5059 3a0a 2020 2020 2020 2020 2020  _CPY:.          
-0007b070: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0007b080: 2020 2020 2f2f 206e 6563 6573 7361 7279      // necessary
-0007b090: 2066 6f72 206c 6c61 6d61 0a20 2020 2020   for llama.     
-0007b0a0: 2020 2020 2020 2020 2020 202f 2f20 6370             // cp
-0007b0b0: 7920 6f76 6572 7772 6974 6573 2076 616c  y overwrites val
-0007b0c0: 7565 206f 6620 7372 6331 2062 7920 7372  ue of src1 by sr
-0007b0d0: 6330 2061 6e64 2072 6574 7572 6e73 2076  c0 and returns v
-0007b0e0: 6965 7728 7372 6331 290a 2020 2020 2020  iew(src1).      
-0007b0f0: 2020 2020 2020 2020 2020 2f2f 2074 6865            // the
-0007b100: 206f 7665 7277 7269 7469 6e67 2069 7320   overwriting is 
-0007b110: 6d61 7468 656d 6174 6963 616c 6c79 2065  mathematically e
-0007b120: 7175 6976 616c 656e 7420 746f 3a0a 2020  quivalent to:.  
-0007b130: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0007b140: 2074 656e 736f 7220 3d20 7372 6330 202a   tensor = src0 *
-0007b150: 2031 202b 2073 7263 3120 2a20 300a 2020   1 + src1 * 0.  
-0007b160: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0007b170: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-0007b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b190: 2020 2020 2f2f 2064 7372 6330 203d 2064      // dsrc0 = d
-0007b1a0: 7465 6e73 6f72 202a 2031 0a20 2020 2020  tensor * 1.     
-0007b1b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007b1c0: 7263 302d 3e67 7261 6420 3d20 6767 6d6c  rc0->grad = ggml
-0007b1d0: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
-0007b1e0: 7263 302d 3e67 7261 642c 2074 656e 736f  rc0->grad, tenso
-0007b1f0: 722d 3e67 7261 642c 2069 6e70 6c61 6365  r->grad, inplace
-0007b200: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007b210: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0007b220: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
-0007b230: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-0007b240: 2020 2020 2020 2020 2020 202f 2f20 6473             // ds
-0007b250: 7263 3120 3d20 6474 656e 736f 7220 2a20  rc1 = dtensor * 
-0007b260: 3020 2d3e 206e 6f6f 700a 2020 2020 2020  0 -> noop.      
-0007b270: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0007b280: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
-0007b290: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-0007b2a0: 4d4c 5f4f 505f 434f 4e54 3a0a 2020 2020  ML_OP_CONT:.    
-0007b2b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007b2c0: 2020 2020 2020 2020 2020 2f2f 2073 616d            // sam
-0007b2d0: 6520 6173 2063 7079 0a20 2020 2020 2020  e as cpy.       
-0007b2e0: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
-0007b2f0: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
-0007b300: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-0007b310: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-0007b320: 6973 5f63 6f6e 7469 6775 6f75 7328 7372  is_contiguous(sr
-0007b330: 6330 2d3e 6772 6164 2929 3b0a 2020 2020  c0->grad));.    
-0007b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b350: 4747 4d4c 5f41 5353 4552 5428 6767 6d6c  GGML_ASSERT(ggml
-0007b360: 5f69 735f 636f 6e74 6967 756f 7573 2874  _is_contiguous(t
-0007b370: 656e 736f 722d 3e67 7261 6429 293b 0a20  ensor->grad));. 
-0007b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b390: 2020 2073 7263 302d 3e67 7261 6420 3d20     src0->grad = 
-0007b3a0: 6767 6d6c 5f61 6464 5f69 6d70 6c28 6374  ggml_add_impl(ct
-0007b3b0: 782c 2073 7263 302d 3e67 7261 642c 2074  x, src0->grad, t
-0007b3c0: 656e 736f 722d 3e67 7261 642c 2069 6e70  ensor->grad, inp
-0007b3d0: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
-0007b3e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0007b3f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0007b400: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007b410: 4f50 5f52 4553 4841 5045 3a0a 2020 2020  OP_RESHAPE:.    
-0007b420: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007b430: 2020 2020 2020 2020 2020 2f2f 206e 6563            // nec
-0007b440: 6573 7361 7279 2066 6f72 206c 6c61 6d61  essary for llama
-0007b450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007b460: 2069 6620 2873 7263 302d 3e67 7261 6429   if (src0->grad)
-0007b470: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007b480: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
-0007b490: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
-0007b4a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0007b4b0: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
-0007b4c0: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
-0007b4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b4e0: 2020 2020 2020 2067 676d 6c5f 7265 7368         ggml_resh
-0007b4f0: 6170 6528 6374 782c 2074 656e 736f 722d  ape(ctx, tensor-
-0007b500: 3e67 7261 642c 2073 7263 302d 3e67 7261  >grad, src0->gra
-0007b510: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-0007b520: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
-0007b530: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
-0007b540: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0007b550: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007b560: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007b570: 505f 5649 4557 3a0a 2020 2020 2020 2020  P_VIEW:.        
-0007b580: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007b590: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
-0007b5a0: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
-0007b5b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0007b5c0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
-0007b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b5e0: 2020 2073 697a 655f 7420 6f66 6673 6574     size_t offset
-0007b5f0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0007b600: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-0007b610: 5254 2873 697a 656f 6628 6f66 6673 6574  RT(sizeof(offset
-0007b620: 2920 3c3d 2067 676d 6c5f 6e62 7974 6573  ) <= ggml_nbytes
-0007b630: 2874 656e 736f 722d 3e73 7263 5b32 5d29  (tensor->src[2])
-0007b640: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007b650: 2020 2020 2020 206d 656d 6370 7928 266f         memcpy(&o
-0007b660: 6666 7365 742c 2074 656e 736f 722d 3e73  ffset, tensor->s
-0007b670: 7263 5b32 5d2d 3e64 6174 612c 2073 697a  rc[2]->data, siz
-0007b680: 656f 6628 6f66 6673 6574 2929 3b0a 0a20  eof(offset));.. 
-0007b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b6a0: 2020 2073 697a 655f 7420 6e62 3120 2020     size_t nb1   
-0007b6b0: 2020 3d20 7465 6e73 6f72 2d3e 6e62 5b31    = tensor->nb[1
-0007b6c0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-0007b6d0: 2020 2020 2020 2073 697a 655f 7420 6e62         size_t nb
-0007b6e0: 3220 2020 2020 3d20 7465 6e73 6f72 2d3e  2     = tensor->
-0007b6f0: 6e62 5b32 5d3b 0a20 2020 2020 2020 2020  nb[2];.         
-0007b700: 2020 2020 2020 2020 2020 2073 697a 655f             size_
-0007b710: 7420 6e62 3320 2020 2020 3d20 7465 6e73  t nb3     = tens
-0007b720: 6f72 2d3e 6e62 5b33 5d3b 0a0a 2020 2020  or->nb[3];..    
-0007b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b740: 6966 2028 7372 6330 2d3e 7479 7065 2021  if (src0->type !
-0007b750: 3d20 7372 6330 2d3e 6772 6164 2d3e 7479  = src0->grad->ty
-0007b760: 7065 2920 7b0a 2020 2020 2020 2020 2020  pe) {.          
-0007b770: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-0007b780: 2067 7261 6469 656e 7420 6973 2074 7970   gradient is typ
-0007b790: 6963 616c 6c79 2046 3332 2c20 6275 7420  ically F32, but 
-0007b7a0: 7372 6330 2063 6f75 6c64 2062 6520 6f74  src0 could be ot
-0007b7b0: 6865 7220 7479 7065 0a20 2020 2020 2020  her type.       
-0007b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b7d0: 2073 697a 655f 7420 6e67 203d 2067 676d   size_t ng = ggm
-0007b7e0: 6c5f 656c 656d 656e 745f 7369 7a65 2873  l_element_size(s
-0007b7f0: 7263 302d 3e67 7261 6429 3b0a 2020 2020  rc0->grad);.    
-0007b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b810: 2020 2020 7369 7a65 5f74 206e 3020 3d20      size_t n0 = 
-0007b820: 6767 6d6c 5f65 6c65 6d65 6e74 5f73 697a  ggml_element_siz
-0007b830: 6528 7372 6330 293b 0a20 2020 2020 2020  e(src0);.       
-0007b840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b850: 2047 474d 4c5f 4153 5345 5254 286f 6666   GGML_ASSERT(off
-0007b860: 7365 7420 2520 6e30 203d 3d20 3029 3b0a  set % n0 == 0);.
-0007b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b880: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0007b890: 4552 5428 6e62 3120 2520 6e30 203d 3d20  ERT(nb1 % n0 == 
-0007b8a0: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
-0007b8b0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0007b8c0: 5f41 5353 4552 5428 6e62 3220 2520 6e30  _ASSERT(nb2 % n0
-0007b8d0: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
-0007b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b8f0: 4747 4d4c 5f41 5353 4552 5428 6e62 3320  GGML_ASSERT(nb3 
-0007b900: 2520 6e30 203d 3d20 3029 3b0a 2020 2020  % n0 == 0);.    
-0007b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b920: 2020 2020 6f66 6673 6574 203d 2028 6f66      offset = (of
-0007b930: 6673 6574 202f 206e 3029 202a 206e 673b  fset / n0) * ng;
-0007b940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007b950: 2020 2020 2020 2020 206e 6231 203d 2028           nb1 = (
-0007b960: 6e62 3120 2f20 6e30 2920 2a20 6e67 3b0a  nb1 / n0) * ng;.
+0007b010: 2020 6767 6d6c 5f63 6f6e 7428 6374 782c    ggml_cont(ctx,
+0007b020: 2074 656e 736f 725f 6772 6164 5f76 6965   tensor_grad_vie
+0007b030: 7729 2c0a 2020 2020 2020 2020 2020 2020  w),.            
+0007b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b050: 2020 2020 7372 6331 2d3e 6772 6164 292c      src1->grad),
+0007b060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b070: 2020 2020 2020 2020 2020 2020 2069 6e70               inp
+0007b080: 6c61 6365 293b 0a20 2020 2020 2020 2020  lace);.         
+0007b090: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0007b0a0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0007b0b0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0007b0c0: 4f50 5f43 5059 3a0a 2020 2020 2020 2020  OP_CPY:.        
+0007b0d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007b0e0: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
+0007b0f0: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
+0007b100: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0007b110: 6370 7920 6f76 6572 7772 6974 6573 2076  cpy overwrites v
+0007b120: 616c 7565 206f 6620 7372 6331 2062 7920  alue of src1 by 
+0007b130: 7372 6330 2061 6e64 2072 6574 7572 6e73  src0 and returns
+0007b140: 2076 6965 7728 7372 6331 290a 2020 2020   view(src1).    
+0007b150: 2020 2020 2020 2020 2020 2020 2f2f 2074              // t
+0007b160: 6865 206f 7665 7277 7269 7469 6e67 2069  he overwriting i
+0007b170: 7320 6d61 7468 656d 6174 6963 616c 6c79  s mathematically
+0007b180: 2065 7175 6976 616c 656e 7420 746f 3a0a   equivalent to:.
+0007b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b1a0: 2f2f 2074 656e 736f 7220 3d20 7372 6330  // tensor = src0
+0007b1b0: 202a 2031 202b 2073 7263 3120 2a20 300a   * 1 + src1 * 0.
+0007b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b1d0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+0007b1e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007b1f0: 2020 2020 2020 2f2f 2064 7372 6330 203d        // dsrc0 =
+0007b200: 2064 7465 6e73 6f72 202a 2031 0a20 2020   dtensor * 1.   
+0007b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b220: 2073 7263 302d 3e67 7261 6420 3d20 6767   src0->grad = gg
+0007b230: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+0007b240: 2073 7263 302d 3e67 7261 642c 2074 656e   src0->grad, ten
+0007b250: 736f 722d 3e67 7261 642c 2069 6e70 6c61  sor->grad, inpla
+0007b260: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+0007b270: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0007b280: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
+0007b290: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0007b2a0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0007b2b0: 6473 7263 3120 3d20 6474 656e 736f 7220  dsrc1 = dtensor 
+0007b2c0: 2a20 3020 2d3e 206e 6f6f 700a 2020 2020  * 0 -> noop.    
+0007b2d0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0007b2e0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0007b2f0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+0007b300: 4747 4d4c 5f4f 505f 434f 4e54 3a0a 2020  GGML_OP_CONT:.  
+0007b310: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007b320: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+0007b330: 616d 6520 6173 2063 7079 0a20 2020 2020  ame as cpy.     
+0007b340: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
+0007b350: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
+0007b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b370: 2047 474d 4c5f 4153 5345 5254 2867 676d   GGML_ASSERT(ggm
+0007b380: 6c5f 6973 5f63 6f6e 7469 6775 6f75 7328  l_is_contiguous(
+0007b390: 7372 6330 2d3e 6772 6164 2929 3b0a 2020  src0->grad));.  
+0007b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b3b0: 2020 4747 4d4c 5f41 5353 4552 5428 6767    GGML_ASSERT(gg
+0007b3c0: 6d6c 5f69 735f 636f 6e74 6967 756f 7573  ml_is_contiguous
+0007b3d0: 2874 656e 736f 722d 3e67 7261 6429 293b  (tensor->grad));
+0007b3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b3f0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
+0007b400: 3d20 6767 6d6c 5f61 6464 5f69 6d70 6c28  = ggml_add_impl(
+0007b410: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
+0007b420: 2074 656e 736f 722d 3e67 7261 642c 2069   tensor->grad, i
+0007b430: 6e70 6c61 6365 293b 0a20 2020 2020 2020  nplace);.       
+0007b440: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0007b450: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007b460: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007b470: 4c5f 4f50 5f52 4553 4841 5045 3a0a 2020  L_OP_RESHAPE:.  
+0007b480: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007b490: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
+0007b4a0: 6563 6573 7361 7279 2066 6f72 206c 6c61  ecessary for lla
+0007b4b0: 6d61 0a20 2020 2020 2020 2020 2020 2020  ma.             
+0007b4c0: 2020 2069 6620 2873 7263 302d 3e67 7261     if (src0->gra
+0007b4d0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007b4e0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
+0007b4f0: 7261 6420 3d0a 2020 2020 2020 2020 2020  rad =.          
+0007b500: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+0007b510: 6d6c 5f61 6464 5f69 6d70 6c28 6374 782c  ml_add_impl(ctx,
+0007b520: 2073 7263 302d 3e67 7261 642c 0a20 2020   src0->grad,.   
+0007b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b540: 2020 2020 2020 2020 2067 676d 6c5f 7265           ggml_re
+0007b550: 7368 6170 6528 6374 782c 2074 656e 736f  shape(ctx, tenso
+0007b560: 722d 3e67 7261 642c 2073 7263 302d 3e67  r->grad, src0->g
+0007b570: 7261 6429 2c0a 2020 2020 2020 2020 2020  rad),.          
+0007b580: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0007b590: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
+0007b5a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0007b5b0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0007b5c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007b5d0: 5f4f 505f 5649 4557 3a0a 2020 2020 2020  _OP_VIEW:.      
+0007b5e0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0007b5f0: 2020 2020 2020 2020 2f2f 206e 6563 6573          // neces
+0007b600: 7361 7279 2066 6f72 206c 6c61 6d61 0a20  sary for llama. 
+0007b610: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007b620: 6620 2873 7263 302d 3e67 7261 6429 207b  f (src0->grad) {
+0007b630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b640: 2020 2020 2073 697a 655f 7420 6f66 6673       size_t offs
+0007b650: 6574 3b0a 0a20 2020 2020 2020 2020 2020  et;..           
+0007b660: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+0007b670: 5345 5254 2873 697a 656f 6628 6f66 6673  SERT(sizeof(offs
+0007b680: 6574 2920 3c3d 2067 676d 6c5f 6e62 7974  et) <= ggml_nbyt
+0007b690: 6573 2874 656e 736f 722d 3e73 7263 5b32  es(tensor->src[2
+0007b6a0: 5d29 293b 0a20 2020 2020 2020 2020 2020  ]));.           
+0007b6b0: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
+0007b6c0: 266f 6666 7365 742c 2074 656e 736f 722d  &offset, tensor-
+0007b6d0: 3e73 7263 5b32 5d2d 3e64 6174 612c 2073  >src[2]->data, s
+0007b6e0: 697a 656f 6628 6f66 6673 6574 2929 3b0a  izeof(offset));.
+0007b6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007b700: 2020 2020 2073 697a 655f 7420 6e62 3120       size_t nb1 
+0007b710: 2020 2020 3d20 7465 6e73 6f72 2d3e 6e62      = tensor->nb
+0007b720: 5b31 5d3b 0a20 2020 2020 2020 2020 2020  [1];.           
+0007b730: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+0007b740: 6e62 3220 2020 2020 3d20 7465 6e73 6f72  nb2     = tensor
+0007b750: 2d3e 6e62 5b32 5d3b 0a20 2020 2020 2020  ->nb[2];.       
+0007b760: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+0007b770: 655f 7420 6e62 3320 2020 2020 3d20 7465  e_t nb3     = te
+0007b780: 6e73 6f72 2d3e 6e62 5b33 5d3b 0a0a 2020  nsor->nb[3];..  
+0007b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b7a0: 2020 6966 2028 7372 6330 2d3e 7479 7065    if (src0->type
+0007b7b0: 2021 3d20 7372 6330 2d3e 6772 6164 2d3e   != src0->grad->
+0007b7c0: 7479 7065 2920 7b0a 2020 2020 2020 2020  type) {.        
+0007b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b7e0: 2f2f 2067 7261 6469 656e 7420 6973 2074  // gradient is t
+0007b7f0: 7970 6963 616c 6c79 2046 3332 2c20 6275  ypically F32, bu
+0007b800: 7420 7372 6330 2063 6f75 6c64 2062 6520  t src0 could be 
+0007b810: 6f74 6865 7220 7479 7065 0a20 2020 2020  other type.     
+0007b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b830: 2020 2073 697a 655f 7420 6e67 203d 2067     size_t ng = g
+0007b840: 676d 6c5f 656c 656d 656e 745f 7369 7a65  gml_element_size
+0007b850: 2873 7263 302d 3e67 7261 6429 3b0a 2020  (src0->grad);.  
+0007b860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b870: 2020 2020 2020 7369 7a65 5f74 206e 3020        size_t n0 
+0007b880: 3d20 6767 6d6c 5f65 6c65 6d65 6e74 5f73  = ggml_element_s
+0007b890: 697a 6528 7372 6330 293b 0a20 2020 2020  ize(src0);.     
+0007b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b8b0: 2020 2047 474d 4c5f 4153 5345 5254 286f     GGML_ASSERT(o
+0007b8c0: 6666 7365 7420 2520 6e30 203d 3d20 3029  ffset % n0 == 0)
+0007b8d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007b8e0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007b8f0: 5353 4552 5428 6e62 3120 2520 6e30 203d  SSERT(nb1 % n0 =
+0007b900: 3d20 3029 3b0a 2020 2020 2020 2020 2020  = 0);.          
+0007b910: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0007b920: 4d4c 5f41 5353 4552 5428 6e62 3220 2520  ML_ASSERT(nb2 % 
+0007b930: 6e30 203d 3d20 3029 3b0a 2020 2020 2020  n0 == 0);.      
+0007b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007b950: 2020 4747 4d4c 5f41 5353 4552 5428 6e62    GGML_ASSERT(nb
+0007b960: 3320 2520 6e30 203d 3d20 3029 3b0a 2020  3 % n0 == 0);.  
 0007b970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b980: 2020 2020 2020 2020 6e62 3220 3d20 286e          nb2 = (n
-0007b990: 6232 202f 206e 3029 202a 206e 673b 0a20  b2 / n0) * ng;. 
-0007b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b9b0: 2020 2020 2020 206e 6233 203d 2028 6e62         nb3 = (nb
-0007b9c0: 3320 2f20 6e30 2920 2a20 6e67 3b0a 2020  3 / n0) * ng;.  
-0007b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007b9e0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-0007b9f0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-0007ba00: 7261 6420 3d20 6767 6d6c 5f61 6363 5f69  rad = ggml_acc_i
-0007ba10: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-0007ba20: 7261 642c 2074 656e 736f 722d 3e67 7261  rad, tensor->gra
-0007ba30: 642c 206e 6231 2c20 6e62 322c 206e 6233  d, nb1, nb2, nb3
-0007ba40: 2c20 6f66 6673 6574 2c20 696e 706c 6163  , offset, inplac
-0007ba50: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0007ba60: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0007ba70: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0007ba80: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007ba90: 5045 524d 5554 453a 0a20 2020 2020 2020  PERMUTE:.       
-0007baa0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0007bab0: 2020 2020 2020 202f 2f20 6e65 6365 7373         // necess
-0007bac0: 6172 7920 666f 7220 6c6c 616d 610a 2020  ary for llama.  
-0007bad0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0007bae0: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-0007baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bb00: 2020 2020 696e 7433 325f 7420 2a20 6178      int32_t * ax
-0007bb10: 6573 203d 2028 696e 7433 325f 7420 2a29  es = (int32_t *)
-0007bb20: 2074 656e 736f 722d 3e73 7263 5b32 5d2d   tensor->src[2]-
-0007bb30: 3e64 6174 613b 0a20 2020 2020 2020 2020  >data;.         
-0007bb40: 2020 2020 2020 2020 2020 2069 6e74 2061             int a
-0007bb50: 7869 7330 203d 2061 7865 735b 305d 2026  xis0 = axes[0] &
-0007bb60: 2030 7833 3b0a 2020 2020 2020 2020 2020   0x3;.          
-0007bb70: 2020 2020 2020 2020 2020 696e 7420 6178            int ax
-0007bb80: 6973 3120 3d20 6178 6573 5b31 5d20 2620  is1 = axes[1] & 
-0007bb90: 3078 333b 0a20 2020 2020 2020 2020 2020  0x3;.           
-0007bba0: 2020 2020 2020 2020 2069 6e74 2061 7869           int axi
-0007bbb0: 7332 203d 2061 7865 735b 325d 2026 2030  s2 = axes[2] & 0
-0007bbc0: 7833 3b0a 2020 2020 2020 2020 2020 2020  x3;.            
-0007bbd0: 2020 2020 2020 2020 696e 7420 6178 6973          int axis
-0007bbe0: 3320 3d20 6178 6573 5b33 5d20 2620 3078  3 = axes[3] & 0x
-0007bbf0: 333b 0a20 2020 2020 2020 2020 2020 2020  3;.             
-0007bc00: 2020 2020 2020 2069 6e74 2061 7865 735f         int axes_
-0007bc10: 6261 636b 7761 7264 5b34 5d20 3d20 7b30  backward[4] = {0
-0007bc20: 2c30 2c30 2c30 7d3b 0a20 2020 2020 2020  ,0,0,0};.       
-0007bc30: 2020 2020 2020 2020 2020 2020 2061 7865               axe
-0007bc40: 735f 6261 636b 7761 7264 5b61 7869 7330  s_backward[axis0
-0007bc50: 5d20 3d20 303b 0a20 2020 2020 2020 2020  ] = 0;.         
-0007bc60: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
-0007bc70: 6261 636b 7761 7264 5b61 7869 7331 5d20  backward[axis1] 
-0007bc80: 3d20 313b 0a20 2020 2020 2020 2020 2020  = 1;.           
-0007bc90: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
-0007bca0: 636b 7761 7264 5b61 7869 7332 5d20 3d20  ckward[axis2] = 
-0007bcb0: 323b 0a20 2020 2020 2020 2020 2020 2020  2;.             
-0007bcc0: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
-0007bcd0: 7761 7264 5b61 7869 7333 5d20 3d20 333b  ward[axis3] = 3;
-0007bce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007bcf0: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-0007bd00: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
-0007bd10: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
-0007bd20: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
-0007bd30: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
-0007bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bd50: 2020 2020 2067 676d 6c5f 7065 726d 7574       ggml_permut
-0007bd60: 6528 6374 782c 0a20 2020 2020 2020 2020  e(ctx,.         
-0007bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bd80: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
-0007bd90: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0007b980: 2020 2020 2020 6f66 6673 6574 203d 2028        offset = (
+0007b990: 6f66 6673 6574 202f 206e 3029 202a 206e  offset / n0) * n
+0007b9a0: 673b 0a20 2020 2020 2020 2020 2020 2020  g;.             
+0007b9b0: 2020 2020 2020 2020 2020 206e 6231 203d             nb1 =
+0007b9c0: 2028 6e62 3120 2f20 6e30 2920 2a20 6e67   (nb1 / n0) * ng
+0007b9d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007b9e0: 2020 2020 2020 2020 2020 6e62 3220 3d20            nb2 = 
+0007b9f0: 286e 6232 202f 206e 3029 202a 206e 673b  (nb2 / n0) * ng;
+0007ba00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ba10: 2020 2020 2020 2020 206e 6233 203d 2028           nb3 = (
+0007ba20: 6e62 3320 2f20 6e30 2920 2a20 6e67 3b0a  nb3 / n0) * ng;.
+0007ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ba40: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0007ba50: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0007ba60: 3e67 7261 6420 3d20 6767 6d6c 5f61 6363  >grad = ggml_acc
+0007ba70: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
+0007ba80: 3e67 7261 642c 2074 656e 736f 722d 3e67  >grad, tensor->g
+0007ba90: 7261 642c 206e 6231 2c20 6e62 322c 206e  rad, nb1, nb2, n
+0007baa0: 6233 2c20 6f66 6673 6574 2c20 696e 706c  b3, offset, inpl
+0007bab0: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0007bac0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007bad0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007bae0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007baf0: 505f 5045 524d 5554 453a 0a20 2020 2020  P_PERMUTE:.     
+0007bb00: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0007bb10: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
+0007bb20: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
+0007bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bb40: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+0007bb50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007bb60: 2020 2020 2020 696e 7433 325f 7420 2a20        int32_t * 
+0007bb70: 6178 6573 203d 2028 696e 7433 325f 7420  axes = (int32_t 
+0007bb80: 2a29 2074 656e 736f 722d 3e73 7263 5b32  *) tensor->src[2
+0007bb90: 5d2d 3e64 6174 613b 0a20 2020 2020 2020  ]->data;.       
+0007bba0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0007bbb0: 2061 7869 7330 203d 2061 7865 735b 305d   axis0 = axes[0]
+0007bbc0: 2026 2030 7833 3b0a 2020 2020 2020 2020   & 0x3;.        
+0007bbd0: 2020 2020 2020 2020 2020 2020 696e 7420              int 
+0007bbe0: 6178 6973 3120 3d20 6178 6573 5b31 5d20  axis1 = axes[1] 
+0007bbf0: 2620 3078 333b 0a20 2020 2020 2020 2020  & 0x3;.         
+0007bc00: 2020 2020 2020 2020 2020 2069 6e74 2061             int a
+0007bc10: 7869 7332 203d 2061 7865 735b 325d 2026  xis2 = axes[2] &
+0007bc20: 2030 7833 3b0a 2020 2020 2020 2020 2020   0x3;.          
+0007bc30: 2020 2020 2020 2020 2020 696e 7420 6178            int ax
+0007bc40: 6973 3320 3d20 6178 6573 5b33 5d20 2620  is3 = axes[3] & 
+0007bc50: 3078 333b 0a20 2020 2020 2020 2020 2020  0x3;.           
+0007bc60: 2020 2020 2020 2020 2069 6e74 2061 7865           int axe
+0007bc70: 735f 6261 636b 7761 7264 5b34 5d20 3d20  s_backward[4] = 
+0007bc80: 7b30 2c30 2c30 2c30 7d3b 0a20 2020 2020  {0,0,0,0};.     
+0007bc90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0007bca0: 7865 735f 6261 636b 7761 7264 5b61 7869  xes_backward[axi
+0007bcb0: 7330 5d20 3d20 303b 0a20 2020 2020 2020  s0] = 0;.       
+0007bcc0: 2020 2020 2020 2020 2020 2020 2061 7865               axe
+0007bcd0: 735f 6261 636b 7761 7264 5b61 7869 7331  s_backward[axis1
+0007bce0: 5d20 3d20 313b 0a20 2020 2020 2020 2020  ] = 1;.         
+0007bcf0: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
+0007bd00: 6261 636b 7761 7264 5b61 7869 7332 5d20  backward[axis2] 
+0007bd10: 3d20 323b 0a20 2020 2020 2020 2020 2020  = 2;.           
+0007bd20: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
+0007bd30: 636b 7761 7264 5b61 7869 7333 5d20 3d20  ckward[axis3] = 
+0007bd40: 333b 0a20 2020 2020 2020 2020 2020 2020  3;.             
+0007bd50: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0007bd60: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+0007bd70: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007bd80: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
+0007bd90: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
 0007bda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bdb0: 2020 2020 2061 7865 735f 6261 636b 7761       axes_backwa
-0007bdc0: 7264 5b30 5d2c 0a20 2020 2020 2020 2020  rd[0],.         
+0007bdb0: 2020 2020 2020 2067 676d 6c5f 7065 726d         ggml_perm
+0007bdc0: 7574 6528 6374 782c 0a20 2020 2020 2020  ute(ctx,.       
 0007bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bde0: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
-0007bdf0: 7761 7264 5b31 5d2c 0a20 2020 2020 2020  ward[1],.       
+0007bde0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+0007bdf0: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
 0007be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007be10: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
-0007be20: 636b 7761 7264 5b32 5d2c 0a20 2020 2020  ckward[2],.     
+0007be10: 2020 2020 2020 2061 7865 735f 6261 636b         axes_back
+0007be20: 7761 7264 5b30 5d2c 0a20 2020 2020 2020  ward[0],.       
 0007be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007be40: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
-0007be50: 6261 636b 7761 7264 5b33 5d29 2c0a 2020  backward[3]),.  
+0007be40: 2020 2020 2020 2020 2061 7865 735f 6261           axes_ba
+0007be50: 636b 7761 7264 5b31 5d2c 0a20 2020 2020  ckward[1],.     
 0007be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007be70: 2020 2020 2020 2020 2020 696e 706c 6163            inplac
-0007be80: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-0007be90: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-0007bea0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0007beb0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007bec0: 5452 414e 5350 4f53 453a 0a20 2020 2020  TRANSPOSE:.     
-0007bed0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0007bee0: 2020 2020 2020 2020 202f 2f20 6e65 6365           // nece
-0007bef0: 7373 6172 7920 666f 7220 6c6c 616d 610a  ssary for llama.
-0007bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bf10: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
-0007bf20: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0007bf30: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-0007bf40: 203d 0a20 2020 2020 2020 2020 2020 2020   =.             
-0007bf50: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0007bf60: 6164 645f 696d 706c 2863 7478 2c20 7372  add_impl(ctx, sr
-0007bf70: 6330 2d3e 6772 6164 2c0a 2020 2020 2020  c0->grad,.      
-0007bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bf90: 2020 2020 2020 6767 6d6c 5f74 7261 6e73        ggml_trans
-0007bfa0: 706f 7365 2863 7478 2c20 7465 6e73 6f72  pose(ctx, tensor
-0007bfb0: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
-0007bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007bfd0: 2069 6e70 6c61 6365 293b 0a20 2020 2020   inplace);.     
-0007bfe0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-0007bff0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007c000: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0007c010: 474d 4c5f 4f50 5f47 4554 5f52 4f57 533a  GML_OP_GET_ROWS:
-0007c020: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007c030: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-0007c040: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
-0007c050: 6c6c 616d 6120 286f 6e6c 7920 666f 7220  llama (only for 
-0007c060: 746f 6b65 6e69 7a65 7229 0a20 2020 2020  tokenizer).     
-0007c070: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007c080: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0007c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c0a0: 2073 7263 302d 3e67 7261 6420 3d0a 2020   src0->grad =.  
-0007c0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c0c0: 2020 2020 2020 6767 6d6c 5f61 6464 5f69        ggml_add_i
-0007c0d0: 6d70 6c28 6374 782c 2073 7263 302d 3e67  mpl(ctx, src0->g
-0007c0e0: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0007be70: 2020 2020 2020 2020 2020 2061 7865 735f             axes_
+0007be80: 6261 636b 7761 7264 5b32 5d2c 0a20 2020  backward[2],.   
+0007be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bea0: 2020 2020 2020 2020 2020 2020 2061 7865               axe
+0007beb0: 735f 6261 636b 7761 7264 5b33 5d29 2c0a  s_backward[3]),.
+0007bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bed0: 2020 2020 2020 2020 2020 2020 696e 706c              inpl
+0007bee0: 6163 6529 3b0a 2020 2020 2020 2020 2020  ace);.          
+0007bef0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0007bf00: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007bf10: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007bf20: 505f 5452 414e 5350 4f53 453a 0a20 2020  P_TRANSPOSE:.   
+0007bf30: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007bf40: 2020 2020 2020 2020 2020 202f 2f20 6e65             // ne
+0007bf50: 6365 7373 6172 7920 666f 7220 6c6c 616d  cessary for llam
+0007bf60: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0007bf70: 2020 6966 2028 7372 6330 2d3e 6772 6164    if (src0->grad
+0007bf80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0007bf90: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007bfa0: 6164 203d 0a20 2020 2020 2020 2020 2020  ad =.           
+0007bfb0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+0007bfc0: 6c5f 6164 645f 696d 706c 2863 7478 2c20  l_add_impl(ctx, 
+0007bfd0: 7372 6330 2d3e 6772 6164 2c0a 2020 2020  src0->grad,.    
+0007bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007bff0: 2020 2020 2020 2020 6767 6d6c 5f74 7261          ggml_tra
+0007c000: 6e73 706f 7365 2863 7478 2c20 7465 6e73  nspose(ctx, tens
+0007c010: 6f72 2d3e 6772 6164 292c 0a20 2020 2020  or->grad),.     
+0007c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c030: 2020 2069 6e70 6c61 6365 293b 0a20 2020     inplace);.   
+0007c040: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0007c050: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007c060: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0007c070: 2047 474d 4c5f 4f50 5f47 4554 5f52 4f57   GGML_OP_GET_ROW
+0007c080: 533a 0a20 2020 2020 2020 2020 2020 207b  S:.            {
+0007c090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c0a0: 202f 2f20 6e65 6365 7373 6172 7920 666f   // necessary fo
+0007c0b0: 7220 6c6c 616d 6120 286f 6e6c 7920 666f  r llama (only fo
+0007c0c0: 7220 746f 6b65 6e69 7a65 7229 0a20 2020  r tokenizer).   
+0007c0d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007c0e0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
 0007c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c100: 2067 676d 6c5f 6765 745f 726f 7773 5f62   ggml_get_rows_b
-0007c110: 6163 6b28 6374 782c 2074 656e 736f 722d  ack(ctx, tensor-
-0007c120: 3e67 7261 642c 2073 7263 312c 2073 7263  >grad, src1, src
-0007c130: 302d 3e67 7261 6429 2c0a 2020 2020 2020  0->grad),.      
-0007c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c150: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0007c160: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007c170: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0007c180: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
-0007c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c1a0: 2020 2020 2f2f 206e 6f6f 700a 2020 2020      // noop.    
-0007c1b0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007c1c0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007c1d0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0007c1e0: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
-0007c1f0: 5f42 4143 4b3a 0a20 2020 2020 2020 2020  _BACK:.         
-0007c200: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0007c210: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-0007c220: 2866 616c 7365 293b 202f 2f20 544f 444f  (false); // TODO
-0007c230: 3a20 6e6f 7420 696d 706c 656d 656e 7465  : not implemente
-0007c240: 640a 2020 2020 2020 2020 2020 2020 7d20  d.            } 
-0007c250: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0007c260: 6173 6520 4747 4d4c 5f4f 505f 4449 4147  ase GGML_OP_DIAG
-0007c270: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c290: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0007c2a0: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
-0007c2b0: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
-0007c2c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007c2d0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0007c2e0: 474d 4c5f 4f50 5f44 4941 475f 4d41 534b  GML_OP_DIAG_MASK
-0007c2f0: 5f49 4e46 3a0a 2020 2020 2020 2020 2020  _INF:.          
-0007c300: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0007c310: 2020 2020 2f2f 206e 6563 6573 7361 7279      // necessary
-0007c320: 2066 6f72 206c 6c61 6d61 0a20 2020 2020   for llama.     
-0007c330: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007c340: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0007c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c360: 2061 7373 6572 7428 7372 6331 2d3e 7479   assert(src1->ty
-0007c370: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-0007c380: 4933 3229 3b0a 2020 2020 2020 2020 2020  I32);.          
-0007c390: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0007c3a0: 2867 676d 6c5f 6e65 6c65 6d65 6e74 7328  (ggml_nelements(
-0007c3b0: 7372 6331 2920 3d3d 2032 293b 0a20 2020  src1) == 2);.   
-0007c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c3d0: 2063 6f6e 7374 2069 6e74 206e 5f70 6173   const int n_pas
-0007c3e0: 7420 3d20 2828 696e 7433 325f 7420 2a29  t = ((int32_t *)
-0007c3f0: 2073 7263 312d 3e64 6174 6129 5b30 5d3b   src1->data)[0];
-0007c400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c410: 2020 2020 2073 7263 302d 3e67 7261 6420       src0->grad 
-0007c420: 3d0a 2020 2020 2020 2020 2020 2020 2020  =.              
-0007c430: 2020 2020 2020 2020 2020 6767 6d6c 5f61            ggml_a
-0007c440: 6464 5f69 6d70 6c28 6374 782c 2073 7263  dd_impl(ctx, src
-0007c450: 302d 3e67 7261 642c 0a20 2020 2020 2020  0->grad,.       
-0007c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c470: 2020 2020 2067 676d 6c5f 6469 6167 5f6d       ggml_diag_m
-0007c480: 6173 6b5f 7a65 726f 5f69 6d70 6c28 6374  ask_zero_impl(ct
-0007c490: 782c 2074 656e 736f 722d 3e67 7261 642c  x, tensor->grad,
-0007c4a0: 206e 5f70 6173 742c 2066 616c 7365 292c   n_past, false),
-0007c4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c4c0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-0007c4d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007c4e0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0007c4f0: 2020 2020 2069 6620 2873 7263 312d 3e67       if (src1->g
-0007c500: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
-0007c510: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
-0007c520: 6f70 0a20 2020 2020 2020 2020 2020 2020  op.             
-0007c530: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0007c540: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007c550: 2020 6361 7365 2047 474d 4c5f 4f50 5f44    case GGML_OP_D
-0007c560: 4941 475f 4d41 534b 5f5a 4552 4f3a 0a20  IAG_MASK_ZERO:. 
-0007c570: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0007c580: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0007c590: 6e65 6365 7373 6172 7920 666f 7220 6c6c  necessary for ll
-0007c5a0: 616d 610a 2020 2020 2020 2020 2020 2020  ama.            
-0007c5b0: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0007c5c0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007c5d0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0007c5e0: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
-0007c5f0: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
-0007c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c610: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
-0007c620: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
-0007c630: 3d20 3229 3b0a 2020 2020 2020 2020 2020  = 2);.          
-0007c640: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0007c650: 696e 7420 6e5f 7061 7374 203d 2028 2869  int n_past = ((i
-0007c660: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-0007c670: 6461 7461 295b 305d 3b0a 2020 2020 2020  data)[0];.      
-0007c680: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0007c690: 6330 2d3e 6772 6164 203d 0a20 2020 2020  c0->grad =.     
-0007c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c6b0: 2020 2067 676d 6c5f 6164 645f 696d 706c     ggml_add_impl
-0007c6c0: 2863 7478 2c20 7372 6330 2d3e 6772 6164  (ctx, src0->grad
-0007c6d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007c6e0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007c6f0: 6d6c 5f64 6961 675f 6d61 736b 5f7a 6572  ml_diag_mask_zer
-0007c700: 6f5f 696d 706c 2863 7478 2c20 7465 6e73  o_impl(ctx, tens
-0007c710: 6f72 2d3e 6772 6164 2c20 6e5f 7061 7374  or->grad, n_past
-0007c720: 2c20 6661 6c73 6529 2c0a 2020 2020 2020  , false),.      
-0007c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c740: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0007c750: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007c760: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0007c770: 2028 7372 6331 2d3e 6772 6164 2920 7b0a   (src1->grad) {.
-0007c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c790: 2020 2020 2f2f 206e 6f6f 700a 2020 2020      // noop.    
-0007c7a0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007c7b0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007c7c0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0007c7d0: 4747 4d4c 5f4f 505f 534f 4654 5f4d 4158  GGML_OP_SOFT_MAX
-0007c7e0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c800: 2f2f 206e 6563 6573 7361 7279 2066 6f72  // necessary for
-0007c810: 206c 6c61 6d61 0a20 2020 2020 2020 2020   llama.         
-0007c820: 2020 2020 2020 2069 6620 2873 7263 302d         if (src0-
-0007c830: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
-0007c840: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007c850: 302d 3e67 7261 6420 3d0a 2020 2020 2020  0->grad =.      
-0007c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c870: 2020 6767 6d6c 5f61 6464 5f69 6d70 6c28    ggml_add_impl(
-0007c880: 6374 782c 2073 7263 302d 3e67 7261 642c  ctx, src0->grad,
-0007c890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007c8a0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-0007c8b0: 6c5f 736f 6674 5f6d 6178 5f62 6163 6b28  l_soft_max_back(
-0007c8c0: 6374 782c 2074 656e 736f 722d 3e67 7261  ctx, tensor->gra
-0007c8d0: 642c 2074 656e 736f 7229 2c0a 2020 2020  d, tensor),.    
-0007c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007c8f0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
-0007c900: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-0007c910: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0007c920: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0007c930: 7365 2047 474d 4c5f 4f50 5f53 4f46 545f  se GGML_OP_SOFT_
-0007c940: 4d41 585f 4241 434b 3a0a 2020 2020 2020  MAX_BACK:.      
-0007c950: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0007c960: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0007c970: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-0007c980: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
-0007c990: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
-0007c9a0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007c9b0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-0007c9c0: 4f50 453a 0a20 2020 2020 2020 2020 2020  OPE:.           
-0007c9d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007c9e0: 2020 202f 2f20 6e65 6365 7373 6172 7920     // necessary 
-0007c9f0: 666f 7220 6c6c 616d 610a 2020 2020 2020  for llama.      
-0007ca00: 2020 2020 2020 2020 2020 6966 2028 7372            if (sr
-0007ca10: 6330 2d3e 6772 6164 2920 7b0a 2020 2020  c0->grad) {.    
-0007ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ca30: 6173 7365 7274 2873 7263 312d 3e74 7970  assert(src1->typ
-0007ca40: 6520 3d3d 2047 474d 4c5f 5459 5045 5f49  e == GGML_TYPE_I
-0007ca50: 3332 293b 0a20 2020 2020 2020 2020 2020  32);.           
-0007ca60: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-0007ca70: 6767 6d6c 5f6e 656c 656d 656e 7473 2873  ggml_nelements(s
-0007ca80: 7263 3129 203d 3d20 3429 3b0a 2020 2020  rc1) == 4);.    
-0007ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007caa0: 636f 6e73 7420 696e 7420 6e5f 7061 7374  const int n_past
-0007cab0: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
-0007cac0: 7372 6331 2d3e 6461 7461 295b 305d 3b0a  src1->data)[0];.
-0007cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cae0: 2020 2020 636f 6e73 7420 696e 7420 6e5f      const int n_
-0007caf0: 6469 6d73 203d 2028 2869 6e74 3332 5f74  dims = ((int32_t
-0007cb00: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
-0007cb10: 315d 3b0a 2020 2020 2020 2020 2020 2020  1];.            
-0007cb20: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0007cb30: 7420 6d6f 6465 2020 203d 2028 2869 6e74  t mode   = ((int
-0007cb40: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
-0007cb50: 7461 295b 325d 3b0a 2020 2020 2020 2020  ta)[2];.        
-0007cb60: 2020 2020 2020 2020 2020 2020 7372 6330              src0
-0007cb70: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
-0007cb80: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
-0007cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cba0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
-0007cbb0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
-0007cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cbd0: 6767 6d6c 5f72 6f70 655f 6261 636b 2863  ggml_rope_back(c
-0007cbe0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0007c100: 2020 2073 7263 302d 3e67 7261 6420 3d0a     src0->grad =.
+0007c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c120: 2020 2020 2020 2020 6767 6d6c 5f61 6464          ggml_add
+0007c130: 5f69 6d70 6c28 6374 782c 2073 7263 302d  _impl(ctx, src0-
+0007c140: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0007c150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c160: 2020 2067 676d 6c5f 6765 745f 726f 7773     ggml_get_rows
+0007c170: 5f62 6163 6b28 6374 782c 2074 656e 736f  _back(ctx, tenso
+0007c180: 722d 3e67 7261 642c 2073 7263 312c 2073  r->grad, src1, s
+0007c190: 7263 302d 3e67 7261 6429 2c0a 2020 2020  rc0->grad),.    
+0007c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c1b0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0007c1c0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c1e0: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
+0007c1f0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007c200: 2020 2020 2020 2f2f 206e 6f6f 700a 2020        // noop.  
+0007c210: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007c220: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007c230: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007c240: 6520 4747 4d4c 5f4f 505f 4745 545f 524f  e GGML_OP_GET_RO
+0007c250: 5753 5f42 4143 4b3a 0a20 2020 2020 2020  WS_BACK:.       
+0007c260: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007c270: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+0007c280: 5254 2866 616c 7365 293b 202f 2f20 544f  RT(false); // TO
+0007c290: 444f 3a20 6e6f 7420 696d 706c 656d 656e  DO: not implemen
+0007c2a0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0007c2b0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007c2c0: 2063 6173 6520 4747 4d4c 5f4f 505f 4449   case GGML_OP_DI
+0007c2d0: 4147 3a0a 2020 2020 2020 2020 2020 2020  AG:.            
+0007c2e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007c2f0: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0007c300: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+0007c310: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+0007c320: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007c330: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0007c340: 2047 474d 4c5f 4f50 5f44 4941 475f 4d41   GGML_OP_DIAG_MA
+0007c350: 534b 5f49 4e46 3a0a 2020 2020 2020 2020  SK_INF:.        
+0007c360: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007c370: 2020 2020 2020 2f2f 206e 6563 6573 7361        // necessa
+0007c380: 7279 2066 6f72 206c 6c61 6d61 0a20 2020  ry for llama.   
+0007c390: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007c3a0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+0007c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c3c0: 2020 2061 7373 6572 7428 7372 6331 2d3e     assert(src1->
+0007c3d0: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+0007c3e0: 455f 4933 3229 3b0a 2020 2020 2020 2020  E_I32);.        
+0007c3f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0007c400: 7274 2867 676d 6c5f 6e65 6c65 6d65 6e74  rt(ggml_nelement
+0007c410: 7328 7372 6331 2920 3d3d 2032 293b 0a20  s(src1) == 2);. 
+0007c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c430: 2020 2063 6f6e 7374 2069 6e74 206e 5f70     const int n_p
+0007c440: 6173 7420 3d20 2828 696e 7433 325f 7420  ast = ((int32_t 
+0007c450: 2a29 2073 7263 312d 3e64 6174 6129 5b30  *) src1->data)[0
+0007c460: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+0007c470: 2020 2020 2020 2073 7263 302d 3e67 7261         src0->gra
+0007c480: 6420 3d0a 2020 2020 2020 2020 2020 2020  d =.            
+0007c490: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0007c4a0: 5f61 6464 5f69 6d70 6c28 6374 782c 2073  _add_impl(ctx, s
+0007c4b0: 7263 302d 3e67 7261 642c 0a20 2020 2020  rc0->grad,.     
+0007c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c4d0: 2020 2020 2020 2067 676d 6c5f 6469 6167         ggml_diag
+0007c4e0: 5f6d 6173 6b5f 7a65 726f 5f69 6d70 6c28  _mask_zero_impl(
+0007c4f0: 6374 782c 2074 656e 736f 722d 3e67 7261  ctx, tensor->gra
+0007c500: 642c 206e 5f70 6173 742c 2066 616c 7365  d, n_past, false
+0007c510: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0007c520: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+0007c530: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+0007c540: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0007c550: 2020 2020 2020 2069 6620 2873 7263 312d         if (src1-
+0007c560: 3e67 7261 6429 207b 0a20 2020 2020 2020  >grad) {.       
+0007c570: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
+0007c580: 6e6f 6f70 0a20 2020 2020 2020 2020 2020  noop.           
+0007c590: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0007c5a0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007c5b0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007c5c0: 5f44 4941 475f 4d41 534b 5f5a 4552 4f3a  _DIAG_MASK_ZERO:
+0007c5d0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007c5e0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+0007c5f0: 2f20 6e65 6365 7373 6172 7920 666f 7220  / necessary for 
+0007c600: 6c6c 616d 610a 2020 2020 2020 2020 2020  llama.          
+0007c610: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+0007c620: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0007c630: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0007c640: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
+0007c650: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
+0007c660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007c670: 2020 2020 2061 7373 6572 7428 6767 6d6c       assert(ggml
+0007c680: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
+0007c690: 203d 3d20 3229 3b0a 2020 2020 2020 2020   == 2);.        
+0007c6a0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0007c6b0: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
+0007c6c0: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+0007c6d0: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
+0007c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c6f0: 7372 6330 2d3e 6772 6164 203d 0a20 2020  src0->grad =.   
+0007c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c710: 2020 2020 2067 676d 6c5f 6164 645f 696d       ggml_add_im
+0007c720: 706c 2863 7478 2c20 7372 6330 2d3e 6772  pl(ctx, src0->gr
+0007c730: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007c740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c750: 6767 6d6c 5f64 6961 675f 6d61 736b 5f7a  ggml_diag_mask_z
+0007c760: 6572 6f5f 696d 706c 2863 7478 2c20 7465  ero_impl(ctx, te
+0007c770: 6e73 6f72 2d3e 6772 6164 2c20 6e5f 7061  nsor->grad, n_pa
+0007c780: 7374 2c20 6661 6c73 6529 2c0a 2020 2020  st, false),.    
+0007c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c7a0: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0007c7b0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c7d0: 6966 2028 7372 6331 2d3e 6772 6164 2920  if (src1->grad) 
+0007c7e0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007c7f0: 2020 2020 2020 2f2f 206e 6f6f 700a 2020        // noop.  
+0007c800: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007c810: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007c820: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007c830: 6520 4747 4d4c 5f4f 505f 534f 4654 5f4d  e GGML_OP_SOFT_M
+0007c840: 4158 3a0a 2020 2020 2020 2020 2020 2020  AX:.            
+0007c850: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007c860: 2020 2f2f 206e 6563 6573 7361 7279 2066    // necessary f
+0007c870: 6f72 206c 6c61 6d61 0a20 2020 2020 2020  or llama.       
+0007c880: 2020 2020 2020 2020 2069 6620 2873 7263           if (src
+0007c890: 302d 3e67 7261 6429 207b 0a20 2020 2020  0->grad) {.     
+0007c8a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007c8b0: 7263 302d 3e67 7261 6420 3d0a 2020 2020  rc0->grad =.    
+0007c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c8d0: 2020 2020 6767 6d6c 5f61 6464 5f69 6d70      ggml_add_imp
+0007c8e0: 6c28 6374 782c 2073 7263 302d 3e67 7261  l(ctx, src0->gra
+0007c8f0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0007c900: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0007c910: 676d 6c5f 736f 6674 5f6d 6178 5f62 6163  gml_soft_max_bac
+0007c920: 6b28 6374 782c 2074 656e 736f 722d 3e67  k(ctx, tensor->g
+0007c930: 7261 642c 2074 656e 736f 7229 2c0a 2020  rad, tensor),.  
+0007c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c950: 2020 2020 2020 696e 706c 6163 6529 3b0a        inplace);.
+0007c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007c970: 7d0a 0a20 2020 2020 2020 2020 2020 207d  }..            }
+0007c980: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007c990: 6361 7365 2047 474d 4c5f 4f50 5f53 4f46  case GGML_OP_SOF
+0007c9a0: 545f 4d41 585f 4241 434b 3a0a 2020 2020  T_MAX_BACK:.    
+0007c9b0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007c9c0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007c9d0: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+0007c9e0: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+0007c9f0: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+0007ca00: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007ca10: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007ca20: 5f52 4f50 453a 0a20 2020 2020 2020 2020  _ROPE:.         
+0007ca30: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0007ca40: 2020 2020 202f 2f20 6e65 6365 7373 6172       // necessar
+0007ca50: 7920 666f 7220 6c6c 616d 610a 2020 2020  y for llama.    
+0007ca60: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0007ca70: 7372 6330 2d3e 6772 6164 2920 7b0a 2020  src0->grad) {.  
+0007ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ca90: 2020 6173 7365 7274 2873 7263 312d 3e74    assert(src1->t
+0007caa0: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0007cab0: 5f49 3332 293b 0a20 2020 2020 2020 2020  _I32);.         
+0007cac0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0007cad0: 7428 6767 6d6c 5f6e 656c 656d 656e 7473  t(ggml_nelements
+0007cae0: 2873 7263 3129 203d 3d20 3429 3b0a 2020  (src1) == 4);.  
+0007caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cb00: 2020 636f 6e73 7420 696e 7420 6e5f 7061    const int n_pa
+0007cb10: 7374 203d 2028 2869 6e74 3332 5f74 202a  st = ((int32_t *
+0007cb20: 2920 7372 6331 2d3e 6461 7461 295b 305d  ) src1->data)[0]
+0007cb30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007cb40: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+0007cb50: 6e5f 6469 6d73 203d 2028 2869 6e74 3332  n_dims = ((int32
+0007cb60: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
+0007cb70: 295b 315d 3b0a 2020 2020 2020 2020 2020  )[1];.          
+0007cb80: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+0007cb90: 696e 7420 6d6f 6465 2020 203d 2028 2869  int mode   = ((i
+0007cba0: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
+0007cbb0: 6461 7461 295b 325d 3b0a 2020 2020 2020  data)[2];.      
+0007cbc0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
+0007cbd0: 6330 2d3e 6772 6164 203d 2067 676d 6c5f  c0->grad = ggml_
+0007cbe0: 6164 645f 696d 706c 2863 7478 2c0a 2020  add_impl(ctx,.  
 0007cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cc00: 2020 2020 7465 6e73 6f72 2d3e 6772 6164      tensor->grad
-0007cc10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007cc00: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+0007cc10: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
 0007cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cc30: 2020 6e5f 7061 7374 2c0a 2020 2020 2020    n_past,.      
-0007cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cc50: 2020 2020 2020 2020 2020 6e5f 6469 6d73            n_dims
-0007cc60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007cc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cc80: 2020 6d6f 6465 292c 0a20 2020 2020 2020    mode),.       
-0007cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cca0: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-0007ccb0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007ccc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007ccd0: 2069 6620 2873 7263 312d 3e67 7261 6429   if (src1->grad)
-0007cce0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007ccf0: 2020 2020 2020 202f 2f20 6e6f 6f70 0a20         // noop. 
-0007cd00: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007cd10: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0007cd20: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0007cd30: 7365 2047 474d 4c5f 4f50 5f52 4f50 455f  se GGML_OP_ROPE_
-0007cd40: 4241 434b 3a0a 2020 2020 2020 2020 2020  BACK:.          
-0007cd50: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0007cd60: 2020 2020 6966 2028 7372 6330 2d3e 6772      if (src0->gr
-0007cd70: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
-0007cd80: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0007cd90: 2873 7263 312d 3e74 7970 6520 3d3d 2047  (src1->type == G
-0007cda0: 474d 4c5f 5459 5045 5f49 3332 293b 0a20  GML_TYPE_I32);. 
-0007cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cdc0: 2020 2061 7373 6572 7428 6767 6d6c 5f6e     assert(ggml_n
-0007cdd0: 656c 656d 656e 7473 2873 7263 3129 203d  elements(src1) =
-0007cde0: 3d20 3429 3b0a 2020 2020 2020 2020 2020  = 4);.          
-0007cdf0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-0007ce00: 696e 7420 6e5f 7061 7374 203d 2028 2869  int n_past = ((i
-0007ce10: 6e74 3332 5f74 202a 2920 7372 6331 2d3e  nt32_t *) src1->
-0007ce20: 6461 7461 295b 305d 3b0a 2020 2020 2020  data)[0];.      
-0007ce30: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0007ce40: 6e73 7420 696e 7420 6e5f 6469 6d73 203d  nst int n_dims =
-0007ce50: 2028 2869 6e74 3332 5f74 202a 2920 7372   ((int32_t *) sr
-0007ce60: 6331 2d3e 6461 7461 295b 315d 3b0a 2020  c1->data)[1];.  
-0007ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ce80: 2020 636f 6e73 7420 696e 7420 6d6f 6465    const int mode
-0007ce90: 2020 203d 2028 2869 6e74 3332 5f74 202a     = ((int32_t *
-0007cea0: 2920 7372 6331 2d3e 6461 7461 295b 325d  ) src1->data)[2]
-0007ceb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007cec0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
-0007ced0: 6e5f 6374 7820 203d 2028 2869 6e74 3332  n_ctx  = ((int32
-0007cee0: 5f74 202a 2920 7372 6331 2d3e 6461 7461  _t *) src1->data
-0007cef0: 295b 335d 3b0a 2020 2020 2020 2020 2020  )[3];.          
-0007cf00: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0007cf10: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
-0007cf20: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-0007cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cf40: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
-0007cf50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007cf60: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-0007cf70: 6d6c 5f72 6f70 6528 6374 782c 0a20 2020  ml_rope(ctx,.   
-0007cf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cf90: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-0007cfa0: 736f 722d 3e67 7261 642c 0a20 2020 2020  sor->grad,.     
-0007cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cfc0: 2020 2020 2020 2020 2020 206e 5f70 6173             n_pas
-0007cfd0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0007cc30: 2020 6767 6d6c 5f72 6f70 655f 6261 636b    ggml_rope_back
+0007cc40: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+0007cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cc60: 2020 2020 2020 7465 6e73 6f72 2d3e 6772        tensor->gr
+0007cc70: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cc90: 2020 2020 6e5f 7061 7374 2c0a 2020 2020      n_past,.    
+0007cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ccb0: 2020 2020 2020 2020 2020 2020 6e5f 6469              n_di
+0007ccc0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+0007ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cce0: 2020 2020 6d6f 6465 292c 0a20 2020 2020      mode),.     
+0007ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cd00: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+0007cd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007cd20: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0007cd30: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
+0007cd40: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007cd50: 2020 2020 2020 2020 202f 2f20 6e6f 6f70           // noop
+0007cd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007cd70: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0007cd80: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007cd90: 6361 7365 2047 474d 4c5f 4f50 5f52 4f50  case GGML_OP_ROP
+0007cda0: 455f 4241 434b 3a0a 2020 2020 2020 2020  E_BACK:.        
+0007cdb0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007cdc0: 2020 2020 2020 6966 2028 7372 6330 2d3e        if (src0->
+0007cdd0: 6772 6164 2920 7b0a 2020 2020 2020 2020  grad) {.        
+0007cde0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0007cdf0: 7274 2873 7263 312d 3e74 7970 6520 3d3d  rt(src1->type ==
+0007ce00: 2047 474d 4c5f 5459 5045 5f49 3332 293b   GGML_TYPE_I32);
+0007ce10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ce20: 2020 2020 2061 7373 6572 7428 6767 6d6c       assert(ggml
+0007ce30: 5f6e 656c 656d 656e 7473 2873 7263 3129  _nelements(src1)
+0007ce40: 203d 3d20 3429 3b0a 2020 2020 2020 2020   == 4);.        
+0007ce50: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+0007ce60: 7420 696e 7420 6e5f 7061 7374 203d 2028  t int n_past = (
+0007ce70: 2869 6e74 3332 5f74 202a 2920 7372 6331  (int32_t *) src1
+0007ce80: 2d3e 6461 7461 295b 305d 3b0a 2020 2020  ->data)[0];.    
+0007ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cea0: 636f 6e73 7420 696e 7420 6e5f 6469 6d73  const int n_dims
+0007ceb0: 203d 2028 2869 6e74 3332 5f74 202a 2920   = ((int32_t *) 
+0007cec0: 7372 6331 2d3e 6461 7461 295b 315d 3b0a  src1->data)[1];.
+0007ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cee0: 2020 2020 636f 6e73 7420 696e 7420 6d6f      const int mo
+0007cef0: 6465 2020 203d 2028 2869 6e74 3332 5f74  de   = ((int32_t
+0007cf00: 202a 2920 7372 6331 2d3e 6461 7461 295b   *) src1->data)[
+0007cf10: 325d 3b0a 2020 2020 2020 2020 2020 2020  2];.            
+0007cf20: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+0007cf30: 7420 6e5f 6374 7820 203d 2028 2869 6e74  t n_ctx  = ((int
+0007cf40: 3332 5f74 202a 2920 7372 6331 2d3e 6461  32_t *) src1->da
+0007cf50: 7461 295b 335d 3b0a 2020 2020 2020 2020  ta)[3];.        
+0007cf60: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0007cf70: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
+0007cf80: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+0007cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cfa0: 2020 2020 2020 2020 7372 6330 2d3e 6772          src0->gr
+0007cfb0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007cfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007cfd0: 6767 6d6c 5f72 6f70 6528 6374 782c 0a20  ggml_rope(ctx,. 
 0007cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007cff0: 2020 206e 5f64 696d 732c 0a20 2020 2020     n_dims,.     
-0007d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d010: 2020 2020 2020 2020 2020 206d 6f64 652c             mode,
-0007d020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d040: 206e 5f63 7478 292c 0a20 2020 2020 2020   n_ctx),.       
-0007d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d060: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-0007d070: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007d080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007d090: 2069 6620 2873 7263 312d 3e67 7261 6429   if (src1->grad)
-0007d0a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007d0b0: 2020 2020 2020 202f 2f20 6e6f 6f70 0a20         // noop. 
-0007d0c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007d0d0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0007d0e0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0007d0f0: 7365 2047 474d 4c5f 4f50 5f41 4c49 4249  se GGML_OP_ALIBI
-0007d100: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d120: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0007d130: 6529 3b20 2f2f 2054 4f44 4f3a 206e 6f74  e); // TODO: not
-0007d140: 2069 6d70 6c65 6d65 6e74 6564 0a20 2020   implemented.   
-0007d150: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007d160: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
-0007d170: 474d 4c5f 4f50 5f43 4c41 4d50 3a0a 2020  GML_OP_CLAMP:.  
-0007d180: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-0007d190: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-0007d1a0: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
-0007d1b0: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
-0007d1c0: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
-0007d1d0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-0007d1e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-0007d1f0: 4f50 5f43 4f4e 565f 3144 3a0a 2020 2020  OP_CONV_1D:.    
-0007d200: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0007d210: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-0007d220: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
-0007d230: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
-0007d240: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
-0007d250: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007d260: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-0007d270: 5f43 4f4e 565f 3244 3a0a 2020 2020 2020  _CONV_2D:.      
-0007d280: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0007d290: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-0007d2a0: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
-0007d2b0: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
-0007d2c0: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
-0007d2d0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007d2e0: 2020 6361 7365 2047 474d 4c5f 4f50 5f50    case GGML_OP_P
-0007d2f0: 4f4f 4c5f 3144 3a0a 2020 2020 2020 2020  OOL_1D:.        
-0007d300: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007d310: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007d320: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
-0007d330: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
-0007d340: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
-0007d350: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007d360: 6361 7365 2047 474d 4c5f 4f50 5f50 4f4f  case GGML_OP_POO
-0007d370: 4c5f 3244 3a0a 2020 2020 2020 2020 2020  L_2D:.          
-0007d380: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0007d390: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-0007d3a0: 6661 6c73 6529 3b20 2f2f 2054 4f44 4f3a  false); // TODO:
-0007d3b0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
-0007d3c0: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
-0007d3d0: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
-0007d3e0: 7365 2047 474d 4c5f 4f50 5f46 4c41 5348  se GGML_OP_FLASH
-0007d3f0: 5f41 5454 4e3a 0a20 2020 2020 2020 2020  _ATTN:.         
-0007d400: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0007d410: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-0007d420: 5f74 656e 736f 7220 2a20 666c 6173 685f  _tensor * flash_
-0007d430: 6772 6164 203d 204e 554c 4c3b 0a20 2020  grad = NULL;.   
-0007d440: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0007d450: 2873 7263 302d 3e67 7261 6420 7c7c 2073  (src0->grad || s
-0007d460: 7263 312d 3e67 7261 6420 7c7c 2074 656e  rc1->grad || ten
-0007d470: 736f 722d 3e73 7263 5b32 5d2d 3e67 7261  sor->src[2]->gra
-0007d480: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-0007d490: 2020 2020 2020 2020 2069 6e74 3332 5f74           int32_t
-0007d4a0: 2074 203d 2067 676d 6c5f 6765 745f 6933   t = ggml_get_i3
-0007d4b0: 325f 3164 2874 656e 736f 722d 3e73 7263  2_1d(tensor->src
-0007d4c0: 5b33 5d2c 2030 293b 0a20 2020 2020 2020  [3], 0);.       
-0007d4d0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-0007d4e0: 4c5f 4153 5345 5254 2874 203d 3d20 3020  L_ASSERT(t == 0 
-0007d4f0: 7c7c 2074 203d 3d20 3129 3b0a 2020 2020  || t == 1);.    
-0007d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d510: 626f 6f6c 206d 6173 6b65 6420 3d20 7420  bool masked = t 
-0007d520: 213d 2030 3b0a 2020 2020 2020 2020 2020  != 0;.          
-0007d530: 2020 2020 2020 2020 2020 666c 6173 685f            flash_
-0007d540: 6772 6164 203d 0a20 2020 2020 2020 2020  grad =.         
-0007d550: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0007d560: 676d 6c5f 666c 6173 685f 6174 746e 5f62  gml_flash_attn_b
-0007d570: 6163 6b28 6374 782c 0a20 2020 2020 2020  ack(ctx,.       
-0007d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d590: 2020 2020 2073 7263 302c 0a20 2020 2020       src0,.     
-0007d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d5b0: 2020 2020 2020 2073 7263 312c 0a20 2020         src1,.   
-0007d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d5d0: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
-0007d5e0: 3e73 7263 5b32 5d2c 0a20 2020 2020 2020  >src[2],.       
-0007d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d600: 2020 2020 2074 656e 736f 722d 3e67 7261       tensor->gra
-0007d610: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0007d620: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0007d630: 6173 6b65 6429 3b0a 2020 2020 2020 2020  asked);.        
-0007d640: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0007d650: 2020 2020 2020 2020 2020 2069 6620 2873             if (s
-0007d660: 7263 302d 3e67 7261 6429 207b 0a20 2020  rc0->grad) {.   
-0007d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d680: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0007d690: 736f 7220 2a20 6772 6164 5f71 203d 204e  sor * grad_q = N
-0007d6a0: 554c 4c3b 0a20 2020 2020 2020 2020 2020  ULL;.           
-0007d6b0: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-0007d6c0: 697a 655f 7420 6e62 3020 2020 203d 2066  ize_t nb0    = f
-0007d6d0: 6c61 7368 5f67 7261 642d 3e6e 625b 305d  lash_grad->nb[0]
-0007d6e0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007d6f0: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-0007d700: 5f74 206f 6666 7365 7420 3d20 303b 0a20  _t offset = 0;. 
-0007d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d720: 2020 2073 7769 7463 6828 7372 6330 2d3e     switch(src0->
-0007d730: 6e5f 6469 6d73 2920 7b0a 2020 2020 2020  n_dims) {.      
-0007d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d750: 2020 6361 7365 2032 3a0a 2020 2020 2020    case 2:.      
-0007d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d770: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0007d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d790: 2020 2020 2020 2020 6772 6164 5f71 203d          grad_q =
-0007d7a0: 2067 676d 6c5f 7669 6577 5f32 6428 6374   ggml_view_2d(ct
-0007d7b0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0007cff0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0007d000: 656e 736f 722d 3e67 7261 642c 0a20 2020  ensor->grad,.   
+0007d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d020: 2020 2020 2020 2020 2020 2020 206e 5f70               n_p
+0007d030: 6173 742c 0a20 2020 2020 2020 2020 2020  ast,.           
+0007d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d050: 2020 2020 206e 5f64 696d 732c 0a20 2020       n_dims,.   
+0007d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d070: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+0007d080: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0007d090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d0a0: 2020 206e 5f63 7478 292c 0a20 2020 2020     n_ctx),.     
+0007d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d0c0: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+0007d0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007d0e0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0007d0f0: 2020 2069 6620 2873 7263 312d 3e67 7261     if (src1->gra
+0007d100: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+0007d110: 2020 2020 2020 2020 202f 2f20 6e6f 6f70           // noop
+0007d120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007d130: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+0007d140: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007d150: 6361 7365 2047 474d 4c5f 4f50 5f41 4c49  case GGML_OP_ALI
+0007d160: 4249 3a0a 2020 2020 2020 2020 2020 2020  BI:.            
+0007d170: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007d180: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0007d190: 6c73 6529 3b20 2f2f 2054 4f44 4f3a 206e  lse); // TODO: n
+0007d1a0: 6f74 2069 6d70 6c65 6d65 6e74 6564 0a20  ot implemented. 
+0007d1b0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007d1c0: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
+0007d1d0: 2047 474d 4c5f 4f50 5f43 4c41 4d50 3a0a   GGML_OP_CLAMP:.
+0007d1e0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0007d1f0: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+0007d200: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
+0007d210: 3b20 2f2f 2054 4f44 4f3a 206e 6f74 2069  ; // TODO: not i
+0007d220: 6d70 6c65 6d65 6e74 6564 0a20 2020 2020  mplemented.     
+0007d230: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+0007d240: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+0007d250: 4c5f 4f50 5f43 4f4e 565f 3144 3a0a 2020  L_OP_CONV_1D:.  
+0007d260: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007d270: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+0007d280: 5f41 5353 4552 5428 6661 6c73 6529 3b20  _ASSERT(false); 
+0007d290: 2f2f 2054 4f44 4f3a 206e 6f74 2069 6d70  // TODO: not imp
+0007d2a0: 6c65 6d65 6e74 6564 0a20 2020 2020 2020  lemented.       
+0007d2b0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0007d2c0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+0007d2d0: 4f50 5f43 4f4e 565f 3244 3a0a 2020 2020  OP_CONV_2D:.    
+0007d2e0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007d2f0: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
+0007d300: 5353 4552 5428 6661 6c73 6529 3b20 2f2f  SSERT(false); //
+0007d310: 2054 4f44 4f3a 206e 6f74 2069 6d70 6c65   TODO: not imple
+0007d320: 6d65 6e74 6564 0a20 2020 2020 2020 2020  mented.         
+0007d330: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007d340: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007d350: 5f50 4f4f 4c5f 3144 3a0a 2020 2020 2020  _POOL_1D:.      
+0007d360: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0007d370: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0007d380: 4552 5428 6661 6c73 6529 3b20 2f2f 2054  ERT(false); // T
+0007d390: 4f44 4f3a 206e 6f74 2069 6d70 6c65 6d65  ODO: not impleme
+0007d3a0: 6e74 6564 0a20 2020 2020 2020 2020 2020  nted.           
+0007d3b0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0007d3c0: 2020 6361 7365 2047 474d 4c5f 4f50 5f50    case GGML_OP_P
+0007d3d0: 4f4f 4c5f 3244 3a0a 2020 2020 2020 2020  OOL_2D:.        
+0007d3e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0007d3f0: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+0007d400: 5428 6661 6c73 6529 3b20 2f2f 2054 4f44  T(false); // TOD
+0007d410: 4f3a 206e 6f74 2069 6d70 6c65 6d65 6e74  O: not implement
+0007d420: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
+0007d430: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+0007d440: 6361 7365 2047 474d 4c5f 4f50 5f46 4c41  case GGML_OP_FLA
+0007d450: 5348 5f41 5454 4e3a 0a20 2020 2020 2020  SH_ATTN:.       
+0007d460: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007d470: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0007d480: 6d6c 5f74 656e 736f 7220 2a20 666c 6173  ml_tensor * flas
+0007d490: 685f 6772 6164 203d 204e 554c 4c3b 0a20  h_grad = NULL;. 
+0007d4a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0007d4b0: 6620 2873 7263 302d 3e67 7261 6420 7c7c  f (src0->grad ||
+0007d4c0: 2073 7263 312d 3e67 7261 6420 7c7c 2074   src1->grad || t
+0007d4d0: 656e 736f 722d 3e73 7263 5b32 5d2d 3e67  ensor->src[2]->g
+0007d4e0: 7261 6429 207b 0a20 2020 2020 2020 2020  rad) {.         
+0007d4f0: 2020 2020 2020 2020 2020 2069 6e74 3332             int32
+0007d500: 5f74 2074 203d 2067 676d 6c5f 6765 745f  _t t = ggml_get_
+0007d510: 6933 325f 3164 2874 656e 736f 722d 3e73  i32_1d(tensor->s
+0007d520: 7263 5b33 5d2c 2030 293b 0a20 2020 2020  rc[3], 0);.     
+0007d530: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0007d540: 474d 4c5f 4153 5345 5254 2874 203d 3d20  GML_ASSERT(t == 
+0007d550: 3020 7c7c 2074 203d 3d20 3129 3b0a 2020  0 || t == 1);.  
+0007d560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d570: 2020 626f 6f6c 206d 6173 6b65 6420 3d20    bool masked = 
+0007d580: 7420 213d 2030 3b0a 2020 2020 2020 2020  t != 0;.        
+0007d590: 2020 2020 2020 2020 2020 2020 666c 6173              flas
+0007d5a0: 685f 6772 6164 203d 0a20 2020 2020 2020  h_grad =.       
+0007d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d5c0: 2067 676d 6c5f 666c 6173 685f 6174 746e   ggml_flash_attn
+0007d5d0: 5f62 6163 6b28 6374 782c 0a20 2020 2020  _back(ctx,.     
+0007d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d5f0: 2020 2020 2020 2073 7263 302c 0a20 2020         src0,.   
+0007d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d610: 2020 2020 2020 2020 2073 7263 312c 0a20           src1,. 
+0007d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d630: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0007d640: 722d 3e73 7263 5b32 5d2c 0a20 2020 2020  r->src[2],.     
+0007d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d660: 2020 2020 2020 2074 656e 736f 722d 3e67         tensor->g
+0007d670: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
+0007d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d690: 206d 6173 6b65 6429 3b0a 2020 2020 2020   masked);.      
+0007d6a0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0007d6b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0007d6c0: 2873 7263 302d 3e67 7261 6429 207b 0a20  (src0->grad) {. 
+0007d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d6e0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+0007d6f0: 656e 736f 7220 2a20 6772 6164 5f71 203d  ensor * grad_q =
+0007d700: 204e 554c 4c3b 0a20 2020 2020 2020 2020   NULL;.         
+0007d710: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+0007d720: 2073 697a 655f 7420 6e62 3020 2020 203d   size_t nb0    =
+0007d730: 2066 6c61 7368 5f67 7261 642d 3e6e 625b   flash_grad->nb[
+0007d740: 305d 3b0a 2020 2020 2020 2020 2020 2020  0];.            
+0007d750: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0007d760: 7a65 5f74 206f 6666 7365 7420 3d20 303b  ze_t offset = 0;
+0007d770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007d780: 2020 2020 2073 7769 7463 6828 7372 6330       switch(src0
+0007d790: 2d3e 6e5f 6469 6d73 2920 7b0a 2020 2020  ->n_dims) {.    
+0007d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d7b0: 2020 2020 6361 7365 2032 3a0a 2020 2020      case 2:.    
 0007d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d7d0: 2020 2020 2020 2066 6c61 7368 5f67 7261         flash_gra
-0007d7e0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0007d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d800: 2020 2020 2020 2073 7263 302d 3e6e 655b         src0->ne[
-0007d810: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0007d7d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d7f0: 2020 2020 2020 2020 2020 6772 6164 5f71            grad_q
+0007d800: 203d 2067 676d 6c5f 7669 6577 5f32 6428   = ggml_view_2d(
+0007d810: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
 0007d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d830: 2020 2020 2020 2020 7372 6330 2d3e 6e65          src0->ne
-0007d840: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
+0007d830: 2020 2020 2020 2020 2066 6c61 7368 5f67           flash_g
+0007d840: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
 0007d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d860: 2020 2020 2020 2020 206e 6230 2a73 7263           nb0*src
-0007d870: 302d 3e6e 655b 305d 2c0a 2020 2020 2020  0->ne[0],.      
+0007d860: 2020 2020 2020 2020 2073 7263 302d 3e6e           src0->n
+0007d870: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
 0007d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d890: 2020 2020 2020 2020 2020 2020 2020 6f66                of
-0007d8a0: 6673 6574 293b 0a20 2020 2020 2020 2020  fset);.         
+0007d890: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
+0007d8a0: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
 0007d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d8c0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-0007d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d8e0: 2020 2020 6361 7365 2033 3a0a 2020 2020      case 3:.    
+0007d8c0: 2020 2020 2020 2020 2020 206e 6230 2a73             nb0*s
+0007d8d0: 7263 302d 3e6e 655b 305d 2c0a 2020 2020  rc0->ne[0],.    
+0007d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d900: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0007d900: 6f66 6673 6574 293b 0a20 2020 2020 2020  offset);.       
 0007d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d920: 2020 2020 2020 2020 2020 6772 6164 5f71            grad_q
-0007d930: 203d 2067 676d 6c5f 7669 6577 5f33 6428   = ggml_view_3d(
-0007d940: 6374 782c 0a20 2020 2020 2020 2020 2020  ctx,.           
+0007d920: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+0007d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d940: 2020 2020 2020 6361 7365 2033 3a0a 2020        case 3:.  
 0007d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d960: 2020 2020 2020 2020 2066 6c61 7368 5f67           flash_g
-0007d970: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-0007d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d990: 2020 2020 2020 2020 2073 7263 302d 3e6e           src0->n
-0007d9a0: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+0007d960: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0007d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007d980: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+0007d990: 5f71 203d 2067 676d 6c5f 7669 6577 5f33  _q = ggml_view_3
+0007d9a0: 6428 6374 782c 0a20 2020 2020 2020 2020  d(ctx,.         
 0007d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007d9c0: 2020 2020 2020 2020 2020 7372 6330 2d3e            src0->
-0007d9d0: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
+0007d9c0: 2020 2020 2020 2020 2020 2066 6c61 7368             flash
+0007d9d0: 5f67 7261 642c 0a20 2020 2020 2020 2020  _grad,.         
 0007d9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007d9f0: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
-0007da00: 3e6e 655b 325d 2c0a 2020 2020 2020 2020  >ne[2],.        
+0007da00: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
 0007da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da20: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
-0007da30: 7372 6330 2d3e 6e65 5b30 5d2c 0a20 2020  src0->ne[0],.   
+0007da20: 2020 2020 2020 2020 2020 2020 7372 6330              src0
+0007da30: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
 0007da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da60: 206e 6230 2a73 7263 302d 3e6e 655b 305d   nb0*src0->ne[0]
-0007da70: 2a73 7263 302d 3e6e 655b 315d 2c0a 2020  *src0->ne[1],.  
-0007da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007daa0: 2020 6f66 6673 6574 293b 0a20 2020 2020    offset);.     
+0007da50: 2020 2020 2020 2020 2020 2020 2073 7263               src
+0007da60: 302d 3e6e 655b 325d 2c0a 2020 2020 2020  0->ne[2],.      
+0007da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007da80: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
+0007da90: 302a 7372 6330 2d3e 6e65 5b30 5d2c 0a20  0*src0->ne[0],. 
+0007daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dac0: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dae0: 2020 2020 2020 2020 6361 7365 2034 3a0a          case 4:.
+0007dac0: 2020 206e 6230 2a73 7263 302d 3e6e 655b     nb0*src0->ne[
+0007dad0: 305d 2a73 7263 302d 3e6e 655b 315d 2c0a  0]*src0->ne[1],.
+0007dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007daf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007db00: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0007db00: 2020 2020 6f66 6673 6574 293b 0a20 2020      offset);.   
 0007db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007db20: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-0007db30: 6164 5f71 203d 2067 676d 6c5f 7669 6577  ad_q = ggml_view
-0007db40: 5f34 6428 6374 782c 0a20 2020 2020 2020  _4d(ctx,.       
-0007db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007db60: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
-0007db70: 7368 5f67 7261 642c 0a20 2020 2020 2020  sh_grad,.       
+0007db20: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0007db30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007db40: 2020 2020 2020 2020 2020 6361 7365 2034            case 4
+0007db50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0007db60: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0007db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007db90: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007dba0: 302d 3e6e 655b 305d 2c0a 2020 2020 2020  0->ne[0],.      
+0007db90: 6772 6164 5f71 203d 2067 676d 6c5f 7669  grad_q = ggml_vi
+0007dba0: 6577 5f34 6428 6374 782c 0a20 2020 2020  ew_4d(ctx,.     
 0007dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dbc0: 2020 2020 2020 2020 2020 2020 2020 7372                sr
-0007dbd0: 6330 2d3e 6e65 5b31 5d2c 0a20 2020 2020  c0->ne[1],.     
+0007dbc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0007dbd0: 6c61 7368 5f67 7261 642c 0a20 2020 2020  lash_grad,.     
 0007dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007dbf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0007dc00: 7263 302d 3e6e 655b 325d 2c0a 2020 2020  rc0->ne[2],.    
+0007dc00: 7263 302d 3e6e 655b 305d 2c0a 2020 2020  rc0->ne[0],.    
 0007dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc30: 7372 6330 2d3e 6e65 5b33 5d2c 0a20 2020  src0->ne[3],.   
+0007dc30: 7372 6330 2d3e 6e65 5b31 5d2c 0a20 2020  src0->ne[1],.   
 0007dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc60: 206e 6230 2a73 7263 302d 3e6e 655b 305d   nb0*src0->ne[0]
-0007dc70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007dc60: 2073 7263 302d 3e6e 655b 325d 2c0a 2020   src0->ne[2],.  
+0007dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dc90: 2020 2020 2020 6e62 302a 7372 6330 2d3e        nb0*src0->
-0007dca0: 6e65 5b30 5d2a 7372 6330 2d3e 6e65 5b31  ne[0]*src0->ne[1
-0007dcb0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0007dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dcd0: 2020 2020 2020 206e 6230 2a73 7263 302d         nb0*src0-
-0007dce0: 3e6e 655b 305d 2a73 7263 302d 3e6e 655b  >ne[0]*src0->ne[
-0007dcf0: 315d 2a73 7263 302d 3e6e 655b 325d 2c0a  1]*src0->ne[2],.
-0007dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dd20: 2020 2020 6f66 6673 6574 293b 0a20 2020      offset);.   
-0007dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dd40: 2020 2020 2020 2020 207d 2062 7265 616b           } break
-0007dd50: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007dd60: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0007dd70: 2020 2020 2020 2020 2020 2020 2073 7263               src
-0007dd80: 302d 3e67 7261 6420 3d20 6767 6d6c 5f61  0->grad = ggml_a
-0007dd90: 6464 5f69 6d70 6c28 6374 782c 0a20 2020  dd_impl(ctx,.   
-0007dda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ddb0: 2020 2020 2020 2020 2073 7263 302d 3e67           src0->g
-0007ddc0: 7261 642c 0a20 2020 2020 2020 2020 2020  rad,.           
-0007ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dde0: 2067 7261 645f 712c 0a20 2020 2020 2020   grad_q,.       
-0007ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de00: 2020 2020 2069 6e70 6c61 6365 293b 0a20       inplace);. 
-0007de10: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007de20: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007de30: 2020 6966 2028 7372 6331 2d3e 6772 6164    if (src1->grad
-0007de40: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007de50: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0007de60: 676d 6c5f 7465 6e73 6f72 202a 2067 7261  gml_tensor * gra
-0007de70: 645f 6b20 3d20 4e55 4c4c 3b0a 2020 2020  d_k = NULL;.    
-0007de80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007de90: 636f 6e73 7420 7369 7a65 5f74 206e 6230  const size_t nb0
-0007dea0: 2020 2020 3d20 666c 6173 685f 6772 6164      = flash_grad
-0007deb0: 2d3e 6e62 5b30 5d3b 0a20 2020 2020 2020  ->nb[0];.       
-0007dec0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0007ded0: 7374 2073 697a 655f 7420 6f66 6673 6574  st size_t offset
-0007dee0: 203d 206e 6230 2a73 7263 302d 3e6e 655b   = nb0*src0->ne[
-0007def0: 305d 2a73 7263 302d 3e6e 655b 315d 2a73  0]*src0->ne[1]*s
-0007df00: 7263 302d 3e6e 655b 325d 2a73 7263 302d  rc0->ne[2]*src0-
-0007df10: 3e6e 655b 335d 3b0a 2020 2020 2020 2020  >ne[3];.        
-0007df20: 2020 2020 2020 2020 2020 2020 7377 6974              swit
-0007df30: 6368 2873 7263 312d 3e6e 5f64 696d 7329  ch(src1->n_dims)
-0007df40: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007df50: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-0007df60: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-0007df70: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0007df80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0007df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dfa0: 2067 7261 645f 6b20 3d20 6767 6d6c 5f76   grad_k = ggml_v
-0007dfb0: 6965 775f 3264 2863 7478 2c0a 2020 2020  iew_2d(ctx,.    
-0007dfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dc90: 2020 7372 6330 2d3e 6e65 5b33 5d2c 0a20    src0->ne[3],. 
+0007dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dcc0: 2020 206e 6230 2a73 7263 302d 3e6e 655b     nb0*src0->ne[
+0007dcd0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0007dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dcf0: 2020 2020 2020 2020 6e62 302a 7372 6330          nb0*src0
+0007dd00: 2d3e 6e65 5b30 5d2a 7372 6330 2d3e 6e65  ->ne[0]*src0->ne
+0007dd10: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
+0007dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dd30: 2020 2020 2020 2020 206e 6230 2a73 7263           nb0*src
+0007dd40: 302d 3e6e 655b 305d 2a73 7263 302d 3e6e  0->ne[0]*src0->n
+0007dd50: 655b 315d 2a73 7263 302d 3e6e 655b 325d  e[1]*src0->ne[2]
+0007dd60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dd80: 2020 2020 2020 6f66 6673 6574 293b 0a20        offset);. 
+0007dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007dda0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+0007ddb0: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
+0007ddc0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+0007ddd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0007dde0: 7263 302d 3e67 7261 6420 3d20 6767 6d6c  rc0->grad = ggml
+0007ddf0: 5f61 6464 5f69 6d70 6c28 6374 782c 0a20  _add_impl(ctx,. 
+0007de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007de10: 2020 2020 2020 2020 2020 2073 7263 302d             src0-
+0007de20: 3e67 7261 642c 0a20 2020 2020 2020 2020  >grad,.         
+0007de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007de40: 2020 2067 7261 645f 712c 0a20 2020 2020     grad_q,.     
+0007de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007de60: 2020 2020 2020 2069 6e70 6c61 6365 293b         inplace);
+0007de70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007de80: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0007de90: 2020 2020 6966 2028 7372 6331 2d3e 6772      if (src1->gr
+0007dea0: 6164 2920 7b0a 2020 2020 2020 2020 2020  ad) {.          
+0007deb0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
+0007dec0: 2067 676d 6c5f 7465 6e73 6f72 202a 2067   ggml_tensor * g
+0007ded0: 7261 645f 6b20 3d20 4e55 4c4c 3b0a 2020  rad_k = NULL;.  
+0007dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007def0: 2020 636f 6e73 7420 7369 7a65 5f74 206e    const size_t n
+0007df00: 6230 2020 2020 3d20 666c 6173 685f 6772  b0    = flash_gr
+0007df10: 6164 2d3e 6e62 5b30 5d3b 0a20 2020 2020  ad->nb[0];.     
+0007df20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007df30: 6f6e 7374 2073 697a 655f 7420 6f66 6673  onst size_t offs
+0007df40: 6574 203d 206e 6230 2a73 7263 302d 3e6e  et = nb0*src0->n
+0007df50: 655b 305d 2a73 7263 302d 3e6e 655b 315d  e[0]*src0->ne[1]
+0007df60: 2a73 7263 302d 3e6e 655b 325d 2a73 7263  *src0->ne[2]*src
+0007df70: 302d 3e6e 655b 335d 3b0a 2020 2020 2020  0->ne[3];.      
+0007df80: 2020 2020 2020 2020 2020 2020 2020 7377                sw
+0007df90: 6974 6368 2873 7263 312d 3e6e 5f64 696d  itch(src1->n_dim
+0007dfa0: 7329 207b 0a20 2020 2020 2020 2020 2020  s) {.           
+0007dfb0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
+0007dfc0: 6520 323a 0a20 2020 2020 2020 2020 2020  e 2:.           
 0007dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007dfe0: 666c 6173 685f 6772 6164 2c0a 2020 2020  flash_grad,.    
+0007dfe0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
 0007dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e010: 7372 6331 2d3e 6e65 5b30 5d2c 0a20 2020  src1->ne[0],.   
+0007e000: 2020 2067 7261 645f 6b20 3d20 6767 6d6c     grad_k = ggml
+0007e010: 5f76 6965 775f 3264 2863 7478 2c0a 2020  _view_2d(ctx,.  
 0007e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e040: 2073 7263 312d 3e6e 655b 315d 2c0a 2020   src1->ne[1],.  
+0007e040: 2020 666c 6173 685f 6772 6164 2c0a 2020    flash_grad,.  
 0007e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007e060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e070: 2020 6e62 302a 7372 6331 2d3e 6e65 5b30    nb0*src1->ne[0
-0007e080: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0007e070: 2020 7372 6331 2d3e 6e65 5b30 5d2c 0a20    src1->ne[0],. 
+0007e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007e090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e0a0: 2020 2020 2020 206f 6666 7365 7429 3b0a         offset);.
+0007e0a0: 2020 2073 7263 312d 3e6e 655b 315d 2c0a     src1->ne[1],.
 0007e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e0c0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0007e0d0: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
-0007e0e0: 2020 2020 2020 2020 2020 2020 2063 6173               cas
-0007e0f0: 6520 333a 0a20 2020 2020 2020 2020 2020  e 3:.           
-0007e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e110: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0007e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e130: 2020 2067 7261 645f 6b20 3d20 6767 6d6c     grad_k = ggml
-0007e140: 5f76 6965 775f 3364 2863 7478 2c0a 2020  _view_3d(ctx,.  
-0007e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e0d0: 2020 2020 6e62 302a 7372 6331 2d3e 6e65      nb0*src1->ne
+0007e0e0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+0007e0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e100: 2020 2020 2020 2020 206f 6666 7365 7429           offset)
+0007e110: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0007e120: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+0007e130: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+0007e140: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0007e150: 6173 6520 333a 0a20 2020 2020 2020 2020  ase 3:.         
 0007e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e170: 2020 666c 6173 685f 6772 6164 2c0a 2020    flash_grad,.  
+0007e170: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
 0007e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e1a0: 2020 7372 6331 2d3e 6e65 5b30 5d2c 0a20    src1->ne[0],. 
+0007e190: 2020 2020 2067 7261 645f 6b20 3d20 6767       grad_k = gg
+0007e1a0: 6d6c 5f76 6965 775f 3364 2863 7478 2c0a  ml_view_3d(ctx,.
 0007e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e1d0: 2020 2073 7263 312d 3e6e 655b 315d 2c0a     src1->ne[1],.
+0007e1d0: 2020 2020 666c 6173 685f 6772 6164 2c0a      flash_grad,.
 0007e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e200: 2020 2020 7372 6331 2d3e 6e65 5b32 5d2c      src1->ne[2],
+0007e200: 2020 2020 7372 6331 2d3e 6e65 5b30 5d2c      src1->ne[0],
 0007e210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0007e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e230: 2020 2020 206e 6230 2a73 7263 312d 3e6e       nb0*src1->n
-0007e240: 655b 305d 2c0a 2020 2020 2020 2020 2020  e[0],.          
+0007e230: 2020 2020 2073 7263 312d 3e6e 655b 315d       src1->ne[1]
+0007e240: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0007e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e260: 2020 2020 2020 2020 2020 6e62 302a 7372            nb0*sr
-0007e270: 6331 2d3e 6e65 5b30 5d2a 7372 6331 2d3e  c1->ne[0]*src1->
-0007e280: 6e65 5b31 5d2c 0a20 2020 2020 2020 2020  ne[1],.         
-0007e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e2a0: 2020 2020 2020 2020 2020 206f 6666 7365             offse
-0007e2b0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-0007e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e2d0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007e2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e2f0: 2063 6173 6520 343a 0a20 2020 2020 2020   case 4:.       
-0007e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e310: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007e260: 2020 2020 2020 7372 6331 2d3e 6e65 5b32        src1->ne[2
+0007e270: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0007e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e290: 2020 2020 2020 206e 6230 2a73 7263 312d         nb0*src1-
+0007e2a0: 3e6e 655b 305d 2c0a 2020 2020 2020 2020  >ne[0],.        
+0007e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e2c0: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
+0007e2d0: 7372 6331 2d3e 6e65 5b30 5d2a 7372 6331  src1->ne[0]*src1
+0007e2e0: 2d3e 6e65 5b31 5d2c 0a20 2020 2020 2020  ->ne[1],.       
+0007e2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e300: 2020 2020 2020 2020 2020 2020 206f 6666               off
+0007e310: 7365 7429 3b0a 2020 2020 2020 2020 2020  set);.          
 0007e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e330: 2020 2020 2020 2067 7261 645f 6b20 3d20         grad_k = 
-0007e340: 6767 6d6c 5f76 6965 775f 3464 2863 7478  ggml_view_4d(ctx
-0007e350: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007e330: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0007e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e350: 2020 2063 6173 6520 343a 0a20 2020 2020     case 4:.     
 0007e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e370: 2020 2020 2020 666c 6173 685f 6772 6164        flash_grad
-0007e380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e3a0: 2020 2020 2020 7372 6331 2d3e 6e65 5b30        src1->ne[0
-0007e3b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0007e370: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0007e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e390: 2020 2020 2020 2020 2067 7261 645f 6b20           grad_k 
+0007e3a0: 3d20 6767 6d6c 5f76 6965 775f 3464 2863  = ggml_view_4d(c
+0007e3b0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
 0007e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e3d0: 2020 2020 2020 2073 7263 312d 3e6e 655b         src1->ne[
-0007e3e0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+0007e3d0: 2020 2020 2020 2020 666c 6173 685f 6772          flash_gr
+0007e3e0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
 0007e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007e400: 2020 2020 2020 2020 7372 6331 2d3e 6e65          src1->ne
-0007e410: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+0007e410: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
 0007e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007e430: 2020 2020 2020 2020 2073 7263 312d 3e6e           src1->n
-0007e440: 655b 335d 2c0a 2020 2020 2020 2020 2020  e[3],.          
+0007e440: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
 0007e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e460: 2020 2020 2020 2020 2020 6e62 302a 7372            nb0*sr
-0007e470: 6331 2d3e 6e65 5b30 5d2c 0a20 2020 2020  c1->ne[0],.     
+0007e460: 2020 2020 2020 2020 2020 7372 6331 2d3e            src1->
+0007e470: 6e65 5b32 5d2c 0a20 2020 2020 2020 2020  ne[2],.         
 0007e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e490: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0007e4a0: 6230 2a73 7263 312d 3e6e 655b 305d 2a73  b0*src1->ne[0]*s
-0007e4b0: 7263 312d 3e6e 655b 315d 2c0a 2020 2020  rc1->ne[1],.    
-0007e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e4e0: 6e62 302a 7372 6331 2d3e 6e65 5b30 5d2a  nb0*src1->ne[0]*
-0007e4f0: 7372 6331 2d3e 6e65 5b31 5d2a 7372 6331  src1->ne[1]*src1
-0007e500: 2d3e 6e65 5b32 5d2c 0a20 2020 2020 2020  ->ne[2],.       
-0007e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e520: 2020 2020 2020 2020 2020 2020 206f 6666               off
-0007e530: 7365 7429 3b0a 2020 2020 2020 2020 2020  set);.          
-0007e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e550: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-0007e560: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0007e570: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0007e580: 2020 2020 2020 7372 6331 2d3e 6772 6164        src1->grad
-0007e590: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
-0007e5a0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
-0007e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e5c0: 2020 7372 6331 2d3e 6772 6164 2c0a 2020    src1->grad,.  
-0007e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e5e0: 2020 2020 2020 2020 2020 6772 6164 5f6b            grad_k
-0007e5f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007e600: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0007e610: 706c 6163 6529 3b0a 2020 2020 2020 2020  place);.        
-0007e620: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0007e630: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-0007e640: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0007e650: 6f70 7430 203d 2074 656e 736f 722d 3e73  opt0 = tensor->s
-0007e660: 7263 5b32 5d3b 0a0a 2020 2020 2020 2020  rc[2];..        
-0007e670: 2020 2020 2020 2020 6966 2028 6f70 7430          if (opt0
-0007e680: 2d3e 6772 6164 2920 7b0a 2020 2020 2020  ->grad) {.      
-0007e690: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0007e6a0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0007e6b0: 202a 2067 7261 645f 7620 3d20 4e55 4c4c   * grad_v = NULL
-0007e6c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0007e6d0: 2020 2020 2020 636f 6e73 7420 7369 7a65        const size
-0007e6e0: 5f74 206e 6230 2020 2020 3d20 666c 6173  _t nb0    = flas
-0007e6f0: 685f 6772 6164 2d3e 6e62 5b30 5d3b 0a20  h_grad->nb[0];. 
-0007e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e710: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-0007e720: 6f66 6673 6574 203d 206e 6230 2a73 7263  offset = nb0*src
-0007e730: 302d 3e6e 655b 305d 2a73 7263 302d 3e6e  0->ne[0]*src0->n
-0007e740: 655b 315d 2a73 7263 302d 3e6e 655b 325d  e[1]*src0->ne[2]
-0007e750: 2a73 7263 302d 3e6e 655b 335d 0a20 2020  *src0->ne[3].   
-0007e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e780: 2020 2020 202b 206e 6230 2a73 7263 312d       + nb0*src1-
-0007e790: 3e6e 655b 305d 2a73 7263 312d 3e6e 655b  >ne[0]*src1->ne[
-0007e7a0: 315d 2a73 7263 312d 3e6e 655b 325d 2a73  1]*src1->ne[2]*s
-0007e7b0: 7263 312d 3e6e 655b 335d 3b0a 2020 2020  rc1->ne[3];.    
+0007e490: 2020 2020 2020 2020 2020 2073 7263 312d             src1-
+0007e4a0: 3e6e 655b 335d 2c0a 2020 2020 2020 2020  >ne[3],.        
+0007e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e4c0: 2020 2020 2020 2020 2020 2020 6e62 302a              nb0*
+0007e4d0: 7372 6331 2d3e 6e65 5b30 5d2c 0a20 2020  src1->ne[0],.   
+0007e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e500: 206e 6230 2a73 7263 312d 3e6e 655b 305d   nb0*src1->ne[0]
+0007e510: 2a73 7263 312d 3e6e 655b 315d 2c0a 2020  *src1->ne[1],.  
+0007e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e540: 2020 6e62 302a 7372 6331 2d3e 6e65 5b30    nb0*src1->ne[0
+0007e550: 5d2a 7372 6331 2d3e 6e65 5b31 5d2a 7372  ]*src1->ne[1]*sr
+0007e560: 6331 2d3e 6e65 5b32 5d2c 0a20 2020 2020  c1->ne[2],.     
+0007e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e580: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0007e590: 6666 7365 7429 3b0a 2020 2020 2020 2020  ffset);.        
+0007e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e5b0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+0007e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e5d0: 207d 0a0a 2020 2020 2020 2020 2020 2020   }..            
+0007e5e0: 2020 2020 2020 2020 7372 6331 2d3e 6772          src1->gr
+0007e5f0: 6164 203d 2067 676d 6c5f 6164 645f 696d  ad = ggml_add_im
+0007e600: 706c 2863 7478 2c0a 2020 2020 2020 2020  pl(ctx,.        
+0007e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e620: 2020 2020 7372 6331 2d3e 6772 6164 2c0a      src1->grad,.
+0007e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e640: 2020 2020 2020 2020 2020 2020 6772 6164              grad
+0007e650: 5f6b 2c0a 2020 2020 2020 2020 2020 2020  _k,.            
+0007e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e670: 696e 706c 6163 6529 3b0a 2020 2020 2020  inplace);.      
+0007e680: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0007e690: 2020 2020 2020 2020 2020 2020 2073 7472               str
+0007e6a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0007e6b0: 2a20 6f70 7430 203d 2074 656e 736f 722d  * opt0 = tensor-
+0007e6c0: 3e73 7263 5b32 5d3b 0a0a 2020 2020 2020  >src[2];..      
+0007e6d0: 2020 2020 2020 2020 2020 6966 2028 6f70            if (op
+0007e6e0: 7430 2d3e 6772 6164 2920 7b0a 2020 2020  t0->grad) {.    
+0007e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e700: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0007e710: 6f72 202a 2067 7261 645f 7620 3d20 4e55  or * grad_v = NU
+0007e720: 4c4c 3b0a 2020 2020 2020 2020 2020 2020  LL;.            
+0007e730: 2020 2020 2020 2020 636f 6e73 7420 7369          const si
+0007e740: 7a65 5f74 206e 6230 2020 2020 3d20 666c  ze_t nb0    = fl
+0007e750: 6173 685f 6772 6164 2d3e 6e62 5b30 5d3b  ash_grad->nb[0];
+0007e760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007e770: 2020 2020 2063 6f6e 7374 2073 697a 655f       const size_
+0007e780: 7420 6f66 6673 6574 203d 206e 6230 2a73  t offset = nb0*s
+0007e790: 7263 302d 3e6e 655b 305d 2a73 7263 302d  rc0->ne[0]*src0-
+0007e7a0: 3e6e 655b 315d 2a73 7263 302d 3e6e 655b  >ne[1]*src0->ne[
+0007e7b0: 325d 2a73 7263 302d 3e6e 655b 335d 0a20  2]*src0->ne[3]. 
 0007e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e7d0: 7377 6974 6368 286f 7074 302d 3e6e 5f64  switch(opt0->n_d
-0007e7e0: 696d 7329 207b 0a20 2020 2020 2020 2020  ims) {.         
-0007e7f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0007e800: 6173 6520 323a 0a20 2020 2020 2020 2020  ase 2:.         
-0007e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e820: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0007e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e840: 2020 2020 2067 7261 645f 7620 3d20 6767       grad_v = gg
-0007e850: 6d6c 5f76 6965 775f 3264 2863 7478 2c0a  ml_view_2d(ctx,.
-0007e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e7e0: 2020 2020 2020 202b 206e 6230 2a73 7263         + nb0*src
+0007e7f0: 312d 3e6e 655b 305d 2a73 7263 312d 3e6e  1->ne[0]*src1->n
+0007e800: 655b 315d 2a73 7263 312d 3e6e 655b 325d  e[1]*src1->ne[2]
+0007e810: 2a73 7263 312d 3e6e 655b 335d 3b0a 2020  *src1->ne[3];.  
+0007e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e830: 2020 7377 6974 6368 286f 7074 302d 3e6e    switch(opt0->n
+0007e840: 5f64 696d 7329 207b 0a20 2020 2020 2020  _dims) {.       
+0007e850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e860: 2063 6173 6520 323a 0a20 2020 2020 2020   case 2:.       
 0007e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e880: 2020 2020 666c 6173 685f 6772 6164 2c0a      flash_grad,.
+0007e880: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
 0007e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e8b0: 2020 2020 6f70 7430 2d3e 6e65 5b30 5d2c      opt0->ne[0],
-0007e8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007e8a0: 2020 2020 2020 2067 7261 645f 7620 3d20         grad_v = 
+0007e8b0: 6767 6d6c 5f76 6965 775f 3264 2863 7478  ggml_view_2d(ctx
+0007e8c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0007e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e8e0: 2020 2020 206f 7074 302d 3e6e 655b 315d       opt0->ne[1]
+0007e8e0: 2020 2020 2020 666c 6173 685f 6772 6164        flash_grad
 0007e8f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0007e900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e910: 2020 2020 2020 6e62 302a 6f70 7430 2d3e        nb0*opt0->
-0007e920: 6e65 5b30 5d2c 0a20 2020 2020 2020 2020  ne[0],.         
+0007e910: 2020 2020 2020 6f70 7430 2d3e 6e65 5b30        opt0->ne[0
+0007e920: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
 0007e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e940: 2020 2020 2020 2020 2020 206f 6666 7365             offse
-0007e950: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+0007e940: 2020 2020 2020 206f 7074 302d 3e6e 655b         opt0->ne[
+0007e950: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
 0007e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e970: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-0007e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e990: 2063 6173 6520 333a 0a20 2020 2020 2020   case 3:.       
-0007e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e9b0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0007e970: 2020 2020 2020 2020 6e62 302a 6f70 7430          nb0*opt0
+0007e980: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
+0007e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e9a0: 2020 2020 2020 2020 2020 2020 206f 6666               off
+0007e9b0: 7365 7429 3b0a 2020 2020 2020 2020 2020  set);.          
 0007e9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007e9d0: 2020 2020 2020 2067 7261 645f 7620 3d20         grad_v = 
-0007e9e0: 6767 6d6c 5f76 6965 775f 3364 2863 7478  ggml_view_3d(ctx
-0007e9f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007e9d0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+0007e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007e9f0: 2020 2063 6173 6520 333a 0a20 2020 2020     case 3:.     
 0007ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ea10: 2020 2020 2020 666c 6173 685f 6772 6164        flash_grad
-0007ea20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007ea30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ea40: 2020 2020 2020 6f70 7430 2d3e 6e65 5b30        opt0->ne[0
-0007ea50: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0007ea10: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0007ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ea30: 2020 2020 2020 2020 2067 7261 645f 7620           grad_v 
+0007ea40: 3d20 6767 6d6c 5f76 6965 775f 3364 2863  = ggml_view_3d(c
+0007ea50: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
 0007ea60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ea70: 2020 2020 2020 206f 7074 302d 3e6e 655b         opt0->ne[
-0007ea80: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+0007ea70: 2020 2020 2020 2020 666c 6173 685f 6772          flash_gr
+0007ea80: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
 0007ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007eaa0: 2020 2020 2020 2020 6f70 7430 2d3e 6e65          opt0->ne
-0007eab0: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+0007eab0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
 0007eac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ead0: 2020 2020 2020 2020 206e 6230 2a6f 7074           nb0*opt
-0007eae0: 302d 3e6e 655b 305d 2c0a 2020 2020 2020  0->ne[0],.      
+0007ead0: 2020 2020 2020 2020 206f 7074 302d 3e6e           opt0->n
+0007eae0: 655b 315d 2c0a 2020 2020 2020 2020 2020  e[1],.          
 0007eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eb00: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0007eb10: 302a 6f70 7430 2d3e 6e65 5b30 5d2a 6f70  0*opt0->ne[0]*op
-0007eb20: 7430 2d3e 6e65 5b31 5d2c 0a20 2020 2020  t0->ne[1],.     
-0007eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eb40: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0007eb50: 6666 7365 7429 3b0a 2020 2020 2020 2020  ffset);.        
+0007eb00: 2020 2020 2020 2020 2020 6f70 7430 2d3e            opt0->
+0007eb10: 6e65 5b32 5d2c 0a20 2020 2020 2020 2020  ne[2],.         
+0007eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007eb30: 2020 2020 2020 2020 2020 206e 6230 2a6f             nb0*o
+0007eb40: 7074 302d 3e6e 655b 305d 2c0a 2020 2020  pt0->ne[0],.    
+0007eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eb70: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-0007eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eb90: 2020 2020 2063 6173 6520 343a 0a20 2020       case 4:.   
+0007eb70: 6e62 302a 6f70 7430 2d3e 6e65 5b30 5d2a  nb0*opt0->ne[0]*
+0007eb80: 6f70 7430 2d3e 6e65 5b31 5d2c 0a20 2020  opt0->ne[1],.   
+0007eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ebb0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007ebb0: 206f 6666 7365 7429 3b0a 2020 2020 2020   offset);.      
 0007ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ebd0: 2020 2020 2020 2020 2020 2067 7261 645f             grad_
-0007ebe0: 7620 3d20 6767 6d6c 5f76 6965 775f 3464  v = ggml_view_4d
-0007ebf0: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+0007ebd0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+0007ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ebf0: 2020 2020 2020 2063 6173 6520 343a 0a20         case 4:. 
 0007ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ec10: 2020 2020 2020 2020 2020 666c 6173 685f            flash_
-0007ec20: 6772 6164 2c0a 2020 2020 2020 2020 2020  grad,.          
-0007ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ec40: 2020 2020 2020 2020 2020 6f70 7430 2d3e            opt0->
-0007ec50: 6e65 5b30 5d2c 0a20 2020 2020 2020 2020  ne[0],.         
+0007ec10: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0007ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ec30: 2020 2020 2020 2020 2020 2020 2067 7261               gra
+0007ec40: 645f 7620 3d20 6767 6d6c 5f76 6965 775f  d_v = ggml_view_
+0007ec50: 3464 2863 7478 2c0a 2020 2020 2020 2020  4d(ctx,.        
 0007ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ec70: 2020 2020 2020 2020 2020 206f 7074 302d             opt0-
-0007ec80: 3e6e 655b 315d 2c0a 2020 2020 2020 2020  >ne[1],.        
+0007ec70: 2020 2020 2020 2020 2020 2020 666c 6173              flas
+0007ec80: 685f 6772 6164 2c0a 2020 2020 2020 2020  h_grad,.        
 0007ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007eca0: 2020 2020 2020 2020 2020 2020 6f70 7430              opt0
-0007ecb0: 2d3e 6e65 5b32 5d2c 0a20 2020 2020 2020  ->ne[2],.       
+0007ecb0: 2d3e 6e65 5b30 5d2c 0a20 2020 2020 2020  ->ne[0],.       
 0007ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007ecd0: 2020 2020 2020 2020 2020 2020 206f 7074               opt
-0007ece0: 302d 3e6e 655b 335d 2c0a 2020 2020 2020  0->ne[3],.      
+0007ece0: 302d 3e6e 655b 315d 2c0a 2020 2020 2020  0->ne[1],.      
 0007ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ed00: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-0007ed10: 302a 6f70 7430 2d3e 6e65 5b30 5d2c 0a20  0*opt0->ne[0],. 
+0007ed00: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+0007ed10: 7430 2d3e 6e65 5b32 5d2c 0a20 2020 2020  t0->ne[2],.     
 0007ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ed40: 2020 206e 6230 2a6f 7074 302d 3e6e 655b     nb0*opt0->ne[
-0007ed50: 305d 2a6f 7074 302d 3e6e 655b 315d 2c0a  0]*opt0->ne[1],.
+0007ed30: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0007ed40: 7074 302d 3e6e 655b 335d 2c0a 2020 2020  pt0->ne[3],.    
+0007ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0007ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ed80: 2020 2020 6e62 302a 6f70 7430 2d3e 6e65      nb0*opt0->ne
-0007ed90: 5b30 5d2a 6f70 7430 2d3e 6e65 5b31 5d2a  [0]*opt0->ne[1]*
-0007eda0: 6f70 7430 2d3e 6e65 5b32 5d2c 0a20 2020  opt0->ne[2],.   
-0007edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007edd0: 206f 6666 7365 7429 3b0a 2020 2020 2020   offset);.      
-0007ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007edf0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-0007ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ee10: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0007ee20: 2020 2020 2020 2020 2020 6f70 7430 2d3e            opt0->
-0007ee30: 6772 6164 203d 2067 676d 6c5f 6164 645f  grad = ggml_add_
-0007ee40: 696d 706c 2863 7478 2c0a 2020 2020 2020  impl(ctx,.      
-0007ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ee60: 2020 2020 2020 6f70 7430 2d3e 6772 6164        opt0->grad
-0007ee70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007ee80: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-0007ee90: 6164 5f76 2c0a 2020 2020 2020 2020 2020  ad_v,.          
-0007eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007eeb0: 2020 696e 706c 6163 6529 3b0a 2020 2020    inplace);.    
-0007eec0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-0007eed0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0007eee0: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-0007eef0: 4747 4d4c 5f4f 505f 464c 4153 485f 4646  GGML_OP_FLASH_FF
-0007ef00: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-0007ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007ef20: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-0007ef30: 6529 3b20 2f2f 206e 6f74 2073 7570 706f  e); // not suppo
-0007ef40: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
-0007ef50: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007ef60: 2020 6361 7365 2047 474d 4c5f 4f50 5f46    case GGML_OP_F
-0007ef70: 4c41 5348 5f41 5454 4e5f 4241 434b 3a0a  LASH_ATTN_BACK:.
-0007ef80: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0007ef90: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-0007efa0: 4d4c 5f41 5353 4552 5428 6661 6c73 6529  ML_ASSERT(false)
-0007efb0: 3b20 2f2f 206e 6f74 2073 7570 706f 7274  ; // not support
-0007efc0: 6564 0a20 2020 2020 2020 2020 2020 207d  ed.            }
-0007efd0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0007efe0: 6361 7365 2047 474d 4c5f 4f50 5f57 494e  case GGML_OP_WIN
-0007eff0: 5f50 4152 543a 0a20 2020 2020 2020 2063  _PART:.        c
-0007f000: 6173 6520 4747 4d4c 5f4f 505f 5749 4e5f  ase GGML_OP_WIN_
-0007f010: 554e 5041 5254 3a0a 2020 2020 2020 2020  UNPART:.        
-0007f020: 6361 7365 2047 474d 4c5f 4f50 5f4d 4150  case GGML_OP_MAP
-0007f030: 5f55 4e41 5259 3a0a 2020 2020 2020 2020  _UNARY:.        
-0007f040: 6361 7365 2047 474d 4c5f 4f50 5f4d 4150  case GGML_OP_MAP
-0007f050: 5f42 494e 4152 593a 0a20 2020 2020 2020  _BINARY:.       
-0007f060: 2063 6173 6520 4747 4d4c 5f4f 505f 4d41   case GGML_OP_MA
-0007f070: 505f 4355 5354 4f4d 313a 0a20 2020 2020  P_CUSTOM1:.     
-0007f080: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-0007f090: 4d41 505f 4355 5354 4f4d 323a 0a20 2020  MAP_CUSTOM2:.   
-0007f0a0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-0007f0b0: 505f 4d41 505f 4355 5354 4f4d 333a 0a20  P_MAP_CUSTOM3:. 
-0007f0c0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0007f0d0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-0007f0e0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-0007f0f0: 202f 2f20 6e6f 7420 7375 7070 6f72 7465   // not supporte
-0007f100: 640a 2020 2020 2020 2020 2020 2020 7d20  d.            } 
-0007f110: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-0007f120: 6173 6520 4747 4d4c 5f4f 505f 4352 4f53  ase GGML_OP_CROS
-0007f130: 535f 454e 5452 4f50 595f 4c4f 5353 3a0a  S_ENTROPY_LOSS:.
-0007f140: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0007f150: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0007f160: 2028 7372 6330 2d3e 6772 6164 2920 7b0a   (src0->grad) {.
-0007f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f180: 2020 2020 7372 6330 2d3e 6772 6164 203d      src0->grad =
-0007f190: 2067 676d 6c5f 6164 645f 696d 706c 2863   ggml_add_impl(c
-0007f1a0: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0007ed70: 6e62 302a 6f70 7430 2d3e 6e65 5b30 5d2c  nb0*opt0->ne[0],
+0007ed80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ed90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007eda0: 2020 2020 206e 6230 2a6f 7074 302d 3e6e       nb0*opt0->n
+0007edb0: 655b 305d 2a6f 7074 302d 3e6e 655b 315d  e[0]*opt0->ne[1]
+0007edc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0007edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ede0: 2020 2020 2020 6e62 302a 6f70 7430 2d3e        nb0*opt0->
+0007edf0: 6e65 5b30 5d2a 6f70 7430 2d3e 6e65 5b31  ne[0]*opt0->ne[1
+0007ee00: 5d2a 6f70 7430 2d3e 6e65 5b32 5d2c 0a20  ]*opt0->ne[2],. 
+0007ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee30: 2020 206f 6666 7365 7429 3b0a 2020 2020     offset);.    
+0007ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ee50: 2020 2020 2020 2020 7d20 6272 6561 6b3b          } break;
+0007ee60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007ee70: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0007ee80: 2020 2020 2020 2020 2020 2020 6f70 7430              opt0
+0007ee90: 2d3e 6772 6164 203d 2067 676d 6c5f 6164  ->grad = ggml_ad
+0007eea0: 645f 696d 706c 2863 7478 2c0a 2020 2020  d_impl(ctx,.    
+0007eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007eec0: 2020 2020 2020 2020 6f70 7430 2d3e 6772          opt0->gr
+0007eed0: 6164 2c0a 2020 2020 2020 2020 2020 2020  ad,.            
+0007eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007eef0: 6772 6164 5f76 2c0a 2020 2020 2020 2020  grad_v,.        
+0007ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007ef10: 2020 2020 696e 706c 6163 6529 3b0a 2020      inplace);.  
+0007ef20: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0007ef30: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+0007ef40: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
+0007ef50: 6520 4747 4d4c 5f4f 505f 464c 4153 485f  e GGML_OP_FLASH_
+0007ef60: 4646 3a0a 2020 2020 2020 2020 2020 2020  FF:.            
+0007ef70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007ef80: 2020 4747 4d4c 5f41 5353 4552 5428 6661    GGML_ASSERT(fa
+0007ef90: 6c73 6529 3b20 2f2f 206e 6f74 2073 7570  lse); // not sup
+0007efa0: 706f 7274 6564 0a20 2020 2020 2020 2020  ported.         
+0007efb0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007efc0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007efd0: 5f46 4c41 5348 5f41 5454 4e5f 4241 434b  _FLASH_ATTN_BACK
+0007efe0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+0007eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f000: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
+0007f010: 6529 3b20 2f2f 206e 6f74 2073 7570 706f  e); // not suppo
+0007f020: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
+0007f030: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+0007f040: 2020 6361 7365 2047 474d 4c5f 4f50 5f57    case GGML_OP_W
+0007f050: 494e 5f50 4152 543a 0a20 2020 2020 2020  IN_PART:.       
+0007f060: 2063 6173 6520 4747 4d4c 5f4f 505f 5749   case GGML_OP_WI
+0007f070: 4e5f 554e 5041 5254 3a0a 2020 2020 2020  N_UNPART:.      
+0007f080: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
+0007f090: 4150 5f55 4e41 5259 3a0a 2020 2020 2020  AP_UNARY:.      
+0007f0a0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
+0007f0b0: 4150 5f42 494e 4152 593a 0a20 2020 2020  AP_BINARY:.     
+0007f0c0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+0007f0d0: 4d41 505f 4355 5354 4f4d 313a 0a20 2020  MAP_CUSTOM1:.   
+0007f0e0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+0007f0f0: 505f 4d41 505f 4355 5354 4f4d 323a 0a20  P_MAP_CUSTOM2:. 
+0007f100: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0007f110: 5f4f 505f 4d41 505f 4355 5354 4f4d 333a  _OP_MAP_CUSTOM3:
+0007f120: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+0007f130: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+0007f140: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+0007f150: 293b 202f 2f20 6e6f 7420 7375 7070 6f72  ); // not suppor
+0007f160: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0007f170: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+0007f180: 2063 6173 6520 4747 4d4c 5f4f 505f 4352   case GGML_OP_CR
+0007f190: 4f53 535f 454e 5452 4f50 595f 4c4f 5353  OSS_ENTROPY_LOSS
+0007f1a0: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
 0007f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f1c0: 2020 2020 7372 6330 2d3e 6772 6164 2c0a      src0->grad,.
-0007f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f1f0: 6767 6d6c 5f63 726f 7373 5f65 6e74 726f  ggml_cross_entro
-0007f200: 7079 5f6c 6f73 735f 6261 636b 2863 7478  py_loss_back(ctx
-0007f210: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0007f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f230: 2020 2020 2020 7372 6330 2c0a 2020 2020        src0,.    
+0007f1c0: 6966 2028 7372 6330 2d3e 6772 6164 2920  if (src0->grad) 
+0007f1d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0007f1e0: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0007f1f0: 203d 2067 676d 6c5f 6164 645f 696d 706c   = ggml_add_impl
+0007f200: 2863 7478 2c0a 2020 2020 2020 2020 2020  (ctx,.          
+0007f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f220: 2020 2020 2020 7372 6330 2d3e 6772 6164        src0->grad
+0007f230: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0007f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f260: 7372 6331 2c0a 2020 2020 2020 2020 2020  src1,.          
-0007f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f280: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-0007f290: 2d3e 6772 6164 292c 0a20 2020 2020 2020  ->grad),.       
+0007f250: 2020 6767 6d6c 5f63 726f 7373 5f65 6e74    ggml_cross_ent
+0007f260: 726f 7079 5f6c 6f73 735f 6261 636b 2863  ropy_loss_back(c
+0007f270: 7478 2c0a 2020 2020 2020 2020 2020 2020  tx,.            
+0007f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f290: 2020 2020 2020 2020 7372 6330 2c0a 2020          src0,.  
 0007f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0007f2b0: 2020 2020 2020 2020 2069 6e70 6c61 6365           inplace
-0007f2c0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0007f2d0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0007f2e0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-0007f2f0: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
-0007f300: 524f 5353 5f45 4e54 524f 5059 5f4c 4f53  ROSS_ENTROPY_LOS
-0007f310: 535f 4241 434b 3a0a 2020 2020 2020 2020  S_BACK:.        
-0007f320: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0007f330: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007f340: 5428 6661 6c73 6529 3b20 2f2f 206e 6f74  T(false); // not
-0007f350: 2073 7570 706f 7274 6564 0a20 2020 2020   supported.     
-0007f360: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-0007f370: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0007f380: 4c5f 4f50 5f4e 4f4e 453a 0a20 2020 2020  L_OP_NONE:.     
-0007f390: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0007f3a0: 2020 2020 2020 2020 202f 2f20 6e6f 700a           // nop.
-0007f3b0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-0007f3c0: 6561 6b3b 0a20 2020 2020 2020 2063 6173  eak;.        cas
-0007f3d0: 6520 4747 4d4c 5f4f 505f 434f 554e 543a  e GGML_OP_COUNT:
-0007f3e0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0007f3f0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-0007f400: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
-0007f410: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-0007f420: 2062 7265 616b 3b0a 2020 2020 7d0a 7d0a   break;.    }.}.
-0007f430: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-0007f440: 6c5f 7669 7369 745f 7061 7265 6e74 7328  l_visit_parents(
-0007f450: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-0007f460: 7068 202a 2063 6772 6170 682c 2073 7472  ph * cgraph, str
-0007f470: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0007f480: 2a20 6e6f 6465 2920 7b0a 2020 2020 6966  * node) {.    if
-0007f490: 2028 6e6f 6465 2d3e 6772 6164 203d 3d20   (node->grad == 
-0007f4a0: 4e55 4c4c 2920 7b0a 2020 2020 2020 2020  NULL) {.        
-0007f4b0: 2f2f 2074 6869 7320 7573 7561 6c6c 7920  // this usually 
-0007f4c0: 6861 7070 656e 7320 7768 656e 2077 6520  happens when we 
-0007f4d0: 6765 6e65 7261 7465 2069 6e74 6572 6d65  generate interme
-0007f4e0: 6469 6174 6520 6e6f 6465 7320 6672 6f6d  diate nodes from
-0007f4f0: 2063 6f6e 7374 616e 7473 2069 6e20 7468   constants in th
-0007f500: 6520 6261 636b 7761 7264 2070 6173 730a  e backward pass.
-0007f510: 2020 2020 2020 2020 2f2f 2069 7420 6361          // it ca
-0007f520: 6e20 616c 736f 2068 6170 7065 6e20 6475  n also happen du
-0007f530: 7269 6e67 2066 6f72 7761 7264 2070 6173  ring forward pas
-0007f540: 732c 2069 6620 7468 6520 7573 6572 2070  s, if the user p
-0007f550: 6572 666f 726d 7320 636f 6d70 7574 6174  erforms computat
-0007f560: 696f 6e73 2077 6974 6820 636f 6e73 7461  ions with consta
-0007f570: 6e74 730a 2020 2020 2020 2020 6966 2028  nts.        if (
-0007f580: 6e6f 6465 2d3e 6f70 2021 3d20 4747 4d4c  node->op != GGML
-0007f590: 5f4f 505f 4e4f 4e45 2920 7b0a 2020 2020  _OP_NONE) {.    
-0007f5a0: 2020 2020 2020 2020 2f2f 4747 4d4c 5f50          //GGML_P
-0007f5b0: 5249 4e54 5f44 4542 5547 2822 2573 3a20  RINT_DEBUG("%s: 
-0007f5c0: 7761 726e 696e 673a 206e 6f64 6520 2570  warning: node %p
-0007f5d0: 2068 6173 206e 6f20 6772 6164 2c20 6275   has no grad, bu
-0007f5e0: 7420 6f70 2025 645c 6e22 2c20 5f5f 6675  t op %d\n", __fu
-0007f5f0: 6e63 5f5f 2c20 2876 6f69 6420 2a29 206e  nc__, (void *) n
-0007f600: 6f64 652c 206e 6f64 652d 3e6f 7029 3b0a  ode, node->op);.
-0007f610: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0007f620: 0a20 2020 202f 2f20 6368 6563 6b20 6966  .    // check if
-0007f630: 2061 6c72 6561 6479 2076 6973 6974 6564   already visited
-0007f640: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-0007f650: 3d20 303b 2069 203c 2063 6772 6170 682d  = 0; i < cgraph-
-0007f660: 3e6e 5f6e 6f64 6573 3b20 692b 2b29 207b  >n_nodes; i++) {
-0007f670: 0a20 2020 2020 2020 2069 6620 2863 6772  .        if (cgr
-0007f680: 6170 682d 3e6e 6f64 6573 5b69 5d20 3d3d  aph->nodes[i] ==
-0007f690: 206e 6f64 6529 207b 0a20 2020 2020 2020   node) {.       
-0007f6a0: 2020 2020 2072 6574 7572 6e3b 0a20 2020       return;.   
-0007f6b0: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-0007f6c0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0007f6d0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
-0007f6e0: 6c65 6166 733b 2069 2b2b 2920 7b0a 2020  leafs; i++) {.  
-0007f6f0: 2020 2020 2020 6966 2028 6367 7261 7068        if (cgraph
-0007f700: 2d3e 6c65 6166 735b 695d 203d 3d20 6e6f  ->leafs[i] == no
-0007f710: 6465 2920 7b0a 2020 2020 2020 2020 2020  de) {.          
-0007f720: 2020 7265 7475 726e 3b0a 2020 2020 2020    return;.      
-0007f730: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
-0007f740: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
-0007f750: 203c 2047 474d 4c5f 4d41 585f 5352 433b   < GGML_MAX_SRC;
-0007f760: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-0007f770: 6966 2028 6e6f 6465 2d3e 7372 635b 695d  if (node->src[i]
-0007f780: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0007f790: 6767 6d6c 5f76 6973 6974 5f70 6172 656e  ggml_visit_paren
-0007f7a0: 7473 2863 6772 6170 682c 206e 6f64 652d  ts(cgraph, node-
-0007f7b0: 3e73 7263 5b69 5d29 3b0a 2020 2020 2020  >src[i]);.      
-0007f7c0: 2020 7d0a 2020 2020 7d0a 0a20 2020 2069    }.    }..    i
-0007f7d0: 6620 286e 6f64 652d 3e6f 7020 3d3d 2047  f (node->op == G
-0007f7e0: 474d 4c5f 4f50 5f4e 4f4e 4520 2626 206e  GML_OP_NONE && n
-0007f7f0: 6f64 652d 3e67 7261 6420 3d3d 204e 554c  ode->grad == NUL
-0007f800: 4c29 207b 0a20 2020 2020 2020 202f 2f20  L) {.        // 
-0007f810: 7265 6163 6865 6420 6120 6c65 6166 206e  reached a leaf n
-0007f820: 6f64 652c 206e 6f74 2070 6172 7420 6f66  ode, not part of
-0007f830: 2074 6865 2067 7261 6469 656e 7420 6772   the gradient gr
-0007f840: 6170 6820 2865 2e67 2e20 6120 636f 6e73  aph (e.g. a cons
-0007f850: 7461 6e74 290a 2020 2020 2020 2020 4747  tant).        GG
-0007f860: 4d4c 5f41 5353 4552 5428 6367 7261 7068  ML_ASSERT(cgraph
-0007f870: 2d3e 6e5f 6c65 6166 7320 3c20 4747 4d4c  ->n_leafs < GGML
-0007f880: 5f4d 4158 5f4e 4f44 4553 293b 0a0a 2020  _MAX_NODES);..  
-0007f890: 2020 2020 2020 6966 2028 7374 726c 656e        if (strlen
-0007f8a0: 286e 6f64 652d 3e6e 616d 6529 203d 3d20  (node->name) == 
-0007f8b0: 3029 207b 0a20 2020 2020 2020 2020 2020  0) {.           
-0007f8c0: 2067 676d 6c5f 666f 726d 6174 5f6e 616d   ggml_format_nam
-0007f8d0: 6528 6e6f 6465 2c20 226c 6561 665f 2564  e(node, "leaf_%d
-0007f8e0: 222c 2063 6772 6170 682d 3e6e 5f6c 6561  ", cgraph->n_lea
-0007f8f0: 6673 293b 0a20 2020 2020 2020 207d 0a0a  fs);.        }..
-0007f900: 2020 2020 2020 2020 6367 7261 7068 2d3e          cgraph->
-0007f910: 6c65 6166 735b 6367 7261 7068 2d3e 6e5f  leafs[cgraph->n_
-0007f920: 6c65 6166 735d 203d 206e 6f64 653b 0a20  leafs] = node;. 
-0007f930: 2020 2020 2020 2063 6772 6170 682d 3e6e         cgraph->n
-0007f940: 5f6c 6561 6673 2b2b 3b0a 2020 2020 7d20  _leafs++;.    } 
-0007f950: 656c 7365 207b 0a20 2020 2020 2020 2047  else {.        G
-0007f960: 474d 4c5f 4153 5345 5254 2863 6772 6170  GML_ASSERT(cgrap
-0007f970: 682d 3e6e 5f6e 6f64 6573 203c 2047 474d  h->n_nodes < GGM
-0007f980: 4c5f 4d41 585f 4e4f 4445 5329 3b0a 0a20  L_MAX_NODES);.. 
-0007f990: 2020 2020 2020 2069 6620 2873 7472 6c65         if (strle
-0007f9a0: 6e28 6e6f 6465 2d3e 6e61 6d65 2920 3d3d  n(node->name) ==
-0007f9b0: 2030 2920 7b0a 2020 2020 2020 2020 2020   0) {.          
-0007f9c0: 2020 6767 6d6c 5f66 6f72 6d61 745f 6e61    ggml_format_na
-0007f9d0: 6d65 286e 6f64 652c 2022 6e6f 6465 5f25  me(node, "node_%
-0007f9e0: 6422 2c20 6367 7261 7068 2d3e 6e5f 6e6f  d", cgraph->n_no
-0007f9f0: 6465 7329 3b0a 2020 2020 2020 2020 7d0a  des);.        }.
-0007fa00: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
-0007fa10: 3e6e 6f64 6573 5b63 6772 6170 682d 3e6e  >nodes[cgraph->n
-0007fa20: 5f6e 6f64 6573 5d20 3d20 6e6f 6465 3b0a  _nodes] = node;.
-0007fa30: 2020 2020 2020 2020 6367 7261 7068 2d3e          cgraph->
-0007fa40: 6772 6164 735b 6367 7261 7068 2d3e 6e5f  grads[cgraph->n_
-0007fa50: 6e6f 6465 735d 203d 206e 6f64 652d 3e67  nodes] = node->g
-0007fa60: 7261 643b 0a20 2020 2020 2020 2063 6772  rad;.        cgr
-0007fa70: 6170 682d 3e6e 5f6e 6f64 6573 2b2b 3b0a  aph->n_nodes++;.
-0007fa80: 2020 2020 7d0a 7d0a 0a73 7461 7469 6320      }.}..static 
-0007fa90: 766f 6964 2067 676d 6c5f 6275 696c 645f  void ggml_build_
-0007faa0: 666f 7277 6172 645f 696d 706c 2873 7472  forward_impl(str
-0007fab0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
-0007fac0: 2a20 6367 7261 7068 2c20 7374 7275 6374  * cgraph, struct
-0007fad0: 2067 676d 6c5f 7465 6e73 6f72 202a 2074   ggml_tensor * t
-0007fae0: 656e 736f 722c 2062 6f6f 6c20 6578 7061  ensor, bool expa
-0007faf0: 6e64 2920 7b0a 2020 2020 6966 2028 2165  nd) {.    if (!e
-0007fb00: 7870 616e 6429 207b 0a20 2020 2020 2020  xpand) {.       
-0007fb10: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
-0007fb20: 203d 2030 3b0a 2020 2020 2020 2020 6367   = 0;.        cg
-0007fb30: 7261 7068 2d3e 6e5f 6c65 6166 7320 3d20  raph->n_leafs = 
-0007fb40: 303b 0a20 2020 207d 0a0a 2020 2020 636f  0;.    }..    co
-0007fb50: 6e73 7420 696e 7420 6e30 203d 2063 6772  nst int n0 = cgr
-0007fb60: 6170 682d 3e6e 5f6e 6f64 6573 3b0a 2020  aph->n_nodes;.  
-0007fb70: 2020 554e 5553 4544 286e 3029 3b0a 0a20    UNUSED(n0);.. 
-0007fb80: 2020 2067 676d 6c5f 7669 7369 745f 7061     ggml_visit_pa
-0007fb90: 7265 6e74 7328 6367 7261 7068 2c20 7465  rents(cgraph, te
-0007fba0: 6e73 6f72 293b 0a0a 2020 2020 636f 6e73  nsor);..    cons
-0007fbb0: 7420 696e 7420 6e5f 6e65 7720 3d20 6367  t int n_new = cg
-0007fbc0: 7261 7068 2d3e 6e5f 6e6f 6465 7320 2d20  raph->n_nodes - 
-0007fbd0: 6e30 3b0a 2020 2020 4747 4d4c 5f50 5249  n0;.    GGML_PRI
-0007fbe0: 4e54 5f44 4542 5547 2822 2573 3a20 7669  NT_DEBUG("%s: vi
-0007fbf0: 7369 7465 6420 2564 206e 6577 206e 6f64  sited %d new nod
-0007fc00: 6573 5c6e 222c 205f 5f66 756e 635f 5f2c  es\n", __func__,
-0007fc10: 206e 5f6e 6577 293b 0a0a 2020 2020 6966   n_new);..    if
-0007fc20: 2028 6e5f 6e65 7720 3e20 3029 207b 0a20   (n_new > 0) {. 
-0007fc30: 2020 2020 2020 202f 2f20 7468 6520 6c61         // the la
-0007fc40: 7374 2061 6464 6564 206e 6f64 6520 7368  st added node sh
-0007fc50: 6f75 6c64 2061 6c77 6179 7320 6265 2073  ould always be s
-0007fc60: 7461 7274 696e 6720 706f 696e 740a 2020  tarting point.  
-0007fc70: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0007fc80: 5428 6367 7261 7068 2d3e 6e6f 6465 735b  T(cgraph->nodes[
-0007fc90: 6367 7261 7068 2d3e 6e5f 6e6f 6465 7320  cgraph->n_nodes 
-0007fca0: 2d20 315d 203d 3d20 7465 6e73 6f72 293b  - 1] == tensor);
-0007fcb0: 0a20 2020 207d 0a7d 0a0a 766f 6964 2067  .    }.}..void g
-0007fcc0: 676d 6c5f 6275 696c 645f 666f 7277 6172  gml_build_forwar
-0007fcd0: 645f 6578 7061 6e64 2873 7472 7563 7420  d_expand(struct 
-0007fce0: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
-0007fcf0: 7261 7068 2c20 7374 7275 6374 2067 676d  raph, struct ggm
-0007fd00: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
-0007fd10: 7229 207b 0a20 2020 2067 676d 6c5f 6275  r) {.    ggml_bu
-0007fd20: 696c 645f 666f 7277 6172 645f 696d 706c  ild_forward_impl
-0007fd30: 2863 6772 6170 682c 2074 656e 736f 722c  (cgraph, tensor,
-0007fd40: 2074 7275 6529 3b0a 7d0a 0a73 7472 7563   true);.}..struc
-0007fd50: 7420 6767 6d6c 5f63 6772 6170 6820 6767  t ggml_cgraph gg
-0007fd60: 6d6c 5f62 7569 6c64 5f66 6f72 7761 7264  ml_build_forward
-0007fd70: 2873 7472 7563 7420 6767 6d6c 5f74 656e  (struct ggml_ten
-0007fd80: 736f 7220 2a20 7465 6e73 6f72 2920 7b0a  sor * tensor) {.
-0007fd90: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-0007fda0: 6367 7261 7068 2072 6573 756c 7420 3d20  cgraph result = 
-0007fdb0: 7b0a 2020 2020 2020 2020 2f2a 2e6e 5f6e  {.        /*.n_n
-0007fdc0: 6f64 6573 2020 2020 2020 3d2a 2f20 302c  odes      =*/ 0,
-0007fdd0: 0a20 2020 2020 2020 202f 2a2e 6e5f 6c65  .        /*.n_le
-0007fde0: 6166 7320 2020 2020 203d 2a2f 2030 2c0a  afs      =*/ 0,.
-0007fdf0: 2020 2020 2020 2020 2f2a 2e6e 6f64 6573          /*.nodes
-0007fe00: 2020 2020 2020 2020 3d2a 2f20 7b20 4e55          =*/ { NU
-0007fe10: 4c4c 207d 2c0a 2020 2020 2020 2020 2f2a  LL },.        /*
-0007fe20: 2e67 7261 6473 2020 2020 2020 2020 3d2a  .grads        =*
-0007fe30: 2f20 7b20 4e55 4c4c 207d 2c0a 2020 2020  / { NULL },.    
-0007fe40: 2020 2020 2f2a 2e6c 6561 6673 2020 2020      /*.leafs    
-0007fe50: 2020 2020 3d2a 2f20 7b20 4e55 4c4c 207d      =*/ { NULL }
-0007fe60: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
-0007fe70: 665f 7275 6e73 2020 2020 3d2a 2f20 302c  f_runs    =*/ 0,
-0007fe80: 0a20 2020 2020 2020 202f 2a2e 7065 7266  .        /*.perf
-0007fe90: 5f63 7963 6c65 7320 203d 2a2f 2030 2c0a  _cycles  =*/ 0,.
-0007fea0: 2020 2020 2020 2020 2f2a 2e70 6572 665f          /*.perf_
-0007feb0: 7469 6d65 5f75 7320 3d2a 2f20 302c 0a20  time_us =*/ 0,. 
-0007fec0: 2020 207d 3b0a 0a20 2020 2067 676d 6c5f     };..    ggml_
-0007fed0: 6275 696c 645f 666f 7277 6172 645f 696d  build_forward_im
-0007fee0: 706c 2826 7265 7375 6c74 2c20 7465 6e73  pl(&result, tens
-0007fef0: 6f72 2c20 6661 6c73 6529 3b0a 0a20 2020  or, false);..   
-0007ff00: 2072 6574 7572 6e20 7265 7375 6c74 3b0a   return result;.
-0007ff10: 7d0a 0a73 7472 7563 7420 6767 6d6c 5f63  }..struct ggml_c
-0007ff20: 6772 6170 6820 6767 6d6c 5f62 7569 6c64  graph ggml_build
-0007ff30: 5f62 6163 6b77 6172 6428 7374 7275 6374  _backward(struct
-0007ff40: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-0007ff50: 6374 782c 2073 7472 7563 7420 6767 6d6c  ctx, struct ggml
-0007ff60: 5f63 6772 6170 6820 2a20 6766 2c20 626f  _cgraph * gf, bo
-0007ff70: 6f6c 206b 6565 7029 207b 0a20 2020 2073  ol keep) {.    s
-0007ff80: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-0007ff90: 6820 7265 7375 6c74 203d 202a 6766 3b0a  h result = *gf;.
-0007ffa0: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0007ffb0: 2867 662d 3e6e 5f6e 6f64 6573 203e 2030  (gf->n_nodes > 0
-0007ffc0: 293b 0a0a 2020 2020 2f2f 2069 6620 7765  );..    // if we
-0007ffd0: 2061 7265 206b 6565 7069 6e67 2074 6865   are keeping the
-0007ffe0: 2067 7261 6469 656e 7420 6772 6170 682c   gradient graph,
-0007fff0: 2077 6520 6861 7665 2074 6f20 6465 7461   we have to deta
-00080000: 6368 2074 6865 2067 7261 6469 656e 7420  ch the gradient 
-00080010: 6e6f 6465 7320 6672 6f6d 2074 6865 206f  nodes from the o
-00080020: 7269 6769 6e61 6c20 6772 6170 680a 2020  riginal graph.  
-00080030: 2020 6966 2028 6b65 6570 2920 7b0a 2020    if (keep) {.  
-00080040: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
-00080050: 203d 2030 3b20 6920 3c20 6766 2d3e 6e5f   = 0; i < gf->n_
-00080060: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
-00080070: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-00080080: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
-00080090: 6f64 6520 3d20 6766 2d3e 6e6f 6465 735b  ode = gf->nodes[
-000800a0: 695d 3b0a 0a20 2020 2020 2020 2020 2020  i];..           
-000800b0: 2069 6620 286e 6f64 652d 3e67 7261 6429   if (node->grad)
-000800c0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000800d0: 2020 206e 6f64 652d 3e67 7261 6420 3d20     node->grad = 
-000800e0: 6767 6d6c 5f64 7570 5f74 656e 736f 7228  ggml_dup_tensor(
-000800f0: 6374 782c 206e 6f64 6529 3b0a 2020 2020  ctx, node);.    
-00080100: 2020 2020 2020 2020 2020 2020 6766 2d3e              gf->
-00080110: 6772 6164 735b 695d 203d 206e 6f64 652d  grads[i] = node-
-00080120: 3e67 7261 643b 0a20 2020 2020 2020 2020  >grad;.         
-00080130: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-00080140: 2020 207d 0a0a 2020 2020 666f 7220 2869     }..    for (i
-00080150: 6e74 2069 203d 2067 662d 3e6e 5f6e 6f64  nt i = gf->n_nod
-00080160: 6573 202d 2031 3b20 6920 3e3d 2030 3b20  es - 1; i >= 0; 
-00080170: 692d 2d29 207b 0a20 2020 2020 2020 2073  i--) {.        s
-00080180: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00080190: 7220 2a20 6e6f 6465 203d 2067 662d 3e6e  r * node = gf->n
-000801a0: 6f64 6573 5b69 5d3b 0a0a 2020 2020 2020  odes[i];..      
-000801b0: 2020 2f2f 2062 6563 6175 7365 2077 6520    // because we 
-000801c0: 6465 7461 6368 6564 2074 6865 2067 7261  detached the gra
-000801d0: 6420 6e6f 6465 7320 6672 6f6d 2074 6865  d nodes from the
-000801e0: 206f 7269 6769 6e61 6c20 6772 6170 682c   original graph,
-000801f0: 2077 6520 6361 6e20 6166 666f 7264 2069   we can afford i
-00080200: 6e70 6c61 6365 206f 7065 7261 7469 6f6e  nplace operation
-00080210: 730a 2020 2020 2020 2020 6966 2028 6e6f  s.        if (no
-00080220: 6465 2d3e 6772 6164 2920 7b0a 2020 2020  de->grad) {.    
-00080230: 2020 2020 2020 2020 6767 6d6c 5f63 6f6d          ggml_com
-00080240: 7075 7465 5f62 6163 6b77 6172 6428 6374  pute_backward(ct
-00080250: 782c 206e 6f64 652c 206b 6565 7029 3b0a  x, node, keep);.
-00080260: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00080270: 0a20 2020 2066 6f72 2028 696e 7420 6920  .    for (int i 
-00080280: 3d20 6766 2d3e 6e5f 6e6f 6465 7320 2d20  = gf->n_nodes - 
-00080290: 313b 2069 203e 3d20 303b 2069 2d2d 2920  1; i >= 0; i--) 
-000802a0: 7b0a 2020 2020 2020 2020 7374 7275 6374  {.        struct
-000802b0: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
-000802c0: 6f64 6520 3d20 6766 2d3e 6e6f 6465 735b  ode = gf->nodes[
-000802d0: 695d 3b0a 0a20 2020 2020 2020 2069 6620  i];..        if 
-000802e0: 286e 6f64 652d 3e69 735f 7061 7261 6d29  (node->is_param)
-000802f0: 207b 0a20 2020 2020 2020 2020 2020 2047   {.            G
-00080300: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-00080310: 2225 733a 2066 6f75 6e64 2072 6f6f 7420  "%s: found root 
-00080320: 6e6f 6465 2025 705c 6e22 2c20 5f5f 6675  node %p\n", __fu
-00080330: 6e63 5f5f 2c20 2876 6f69 6420 2a29 206e  nc__, (void *) n
-00080340: 6f64 6529 3b0a 2020 2020 2020 2020 2020  ode);.          
-00080350: 2020 6767 6d6c 5f62 7569 6c64 5f66 6f72    ggml_build_for
-00080360: 7761 7264 5f69 6d70 6c28 2672 6573 756c  ward_impl(&resul
-00080370: 742c 206e 6f64 652d 3e67 7261 642c 2074  t, node->grad, t
-00080380: 7275 6529 3b0a 2020 2020 2020 2020 7d0a  rue);.        }.
-00080390: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
-000803a0: 6e20 7265 7375 6c74 3b0a 7d0a 0a2f 2f0a  n result;.}..//.
-000803b0: 2f2f 2074 6872 6561 6420 6461 7461 0a2f  // thread data./
-000803c0: 2f0a 2f2f 2073 796e 6368 726f 6e69 7a61  /.// synchroniza
-000803d0: 7469 6f6e 2069 7320 646f 6e65 2076 6961  tion is done via
-000803e0: 2062 7573 7920 6c6f 6f70 730a 2f2f 2049   busy loops.// I
-000803f0: 2074 7269 6564 2075 7369 6e67 2073 7069   tried using spi
-00080400: 6e20 6c6f 636b 732c 2062 7574 206e 6f74  n locks, but not
-00080410: 2073 7572 6520 686f 7720 746f 2075 7365   sure how to use
-00080420: 2074 6865 6d20 636f 7272 6563 746c 7920   them correctly 
-00080430: 2d20 7468 6520 7468 696e 6773 2049 2074  - the things I t
-00080440: 7269 6564 2077 6572 6520 736c 6f77 6572  ried were slower
-00080450: 2074 6861 6e20 6275 7379 206c 6f6f 7073   than busy loops
-00080460: 0a2f 2f0a 0a23 6966 6465 6620 5f5f 4150  .//..#ifdef __AP
-00080470: 504c 455f 5f0a 0a2f 2f23 696e 636c 7564  PLE__..//#includ
-00080480: 6520 3c6f 732f 6c6f 636b 2e68 3e0a 2f2f  e <os/lock.h>.//
-00080490: 0a2f 2f74 7970 6564 6566 206f 735f 756e  .//typedef os_un
-000804a0: 6661 6972 5f6c 6f63 6b20 6767 6d6c 5f6c  fair_lock ggml_l
-000804b0: 6f63 6b5f 743b 0a2f 2f0a 2f2f 2364 6566  ock_t;.//.//#def
-000804c0: 696e 6520 6767 6d6c 5f6c 6f63 6b5f 696e  ine ggml_lock_in
-000804d0: 6974 2878 2920 2020 2055 4e55 5345 4428  it(x)    UNUSED(
-000804e0: 7829 0a2f 2f23 6465 6669 6e65 2067 676d  x).//#define ggm
-000804f0: 6c5f 6c6f 636b 5f64 6573 7472 6f79 2878  l_lock_destroy(x
-00080500: 2920 554e 5553 4544 2878 290a 2f2f 2364  ) UNUSED(x).//#d
-00080510: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00080520: 6c6f 636b 2020 2020 2020 206f 735f 756e  lock       os_un
-00080530: 6661 6972 5f6c 6f63 6b5f 6c6f 636b 0a2f  fair_lock_lock./
-00080540: 2f23 6465 6669 6e65 2067 676d 6c5f 6c6f  /#define ggml_lo
-00080550: 636b 5f75 6e6c 6f63 6b20 2020 2020 6f73  ck_unlock     os
-00080560: 5f75 6e66 6169 725f 6c6f 636b 5f75 6e6c  _unfair_lock_unl
-00080570: 6f63 6b0a 2f2f 0a2f 2f23 6465 6669 6e65  ock.//.//#define
-00080580: 2047 474d 4c5f 4c4f 434b 5f49 4e49 5449   GGML_LOCK_INITI
-00080590: 414c 495a 4552 204f 535f 554e 4641 4952  ALIZER OS_UNFAIR
-000805a0: 5f4c 4f43 4b5f 494e 4954 0a0a 7479 7065  _LOCK_INIT..type
-000805b0: 6465 6620 696e 7420 6767 6d6c 5f6c 6f63  def int ggml_loc
-000805c0: 6b5f 743b 0a0a 2364 6566 696e 6520 6767  k_t;..#define gg
-000805d0: 6d6c 5f6c 6f63 6b5f 696e 6974 2878 2920  ml_lock_init(x) 
-000805e0: 2020 2055 4e55 5345 4428 7829 0a23 6465     UNUSED(x).#de
-000805f0: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f64  fine ggml_lock_d
-00080600: 6573 7472 6f79 2878 2920 554e 5553 4544  estroy(x) UNUSED
-00080610: 2878 290a 2364 6566 696e 6520 6767 6d6c  (x).#define ggml
-00080620: 5f6c 6f63 6b5f 6c6f 636b 2878 2920 2020  _lock_lock(x)   
-00080630: 2055 4e55 5345 4428 7829 0a23 6465 6669   UNUSED(x).#defi
-00080640: 6e65 2067 676d 6c5f 6c6f 636b 5f75 6e6c  ne ggml_lock_unl
-00080650: 6f63 6b28 7829 2020 554e 5553 4544 2878  ock(x)  UNUSED(x
-00080660: 290a 0a23 6465 6669 6e65 2047 474d 4c5f  )..#define GGML_
-00080670: 4c4f 434b 5f49 4e49 5449 414c 495a 4552  LOCK_INITIALIZER
-00080680: 2030 0a0a 7479 7065 6465 6620 7074 6872   0..typedef pthr
-00080690: 6561 645f 7420 6767 6d6c 5f74 6872 6561  ead_t ggml_threa
-000806a0: 645f 743b 0a0a 2364 6566 696e 6520 6767  d_t;..#define gg
-000806b0: 6d6c 5f74 6872 6561 645f 6372 6561 7465  ml_thread_create
-000806c0: 2070 7468 7265 6164 5f63 7265 6174 650a   pthread_create.
-000806d0: 2364 6566 696e 6520 6767 6d6c 5f74 6872  #define ggml_thr
-000806e0: 6561 645f 6a6f 696e 2020 2070 7468 7265  ead_join   pthre
-000806f0: 6164 5f6a 6f69 6e0a 0a23 656c 7365 0a0a  ad_join..#else..
-00080700: 2f2f 7479 7065 6465 6620 7074 6872 6561  //typedef pthrea
-00080710: 645f 7370 696e 6c6f 636b 5f74 2067 676d  d_spinlock_t ggm
-00080720: 6c5f 6c6f 636b 5f74 3b0a 0a2f 2f23 6465  l_lock_t;..//#de
-00080730: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f69  fine ggml_lock_i
-00080740: 6e69 7428 7829 2070 7468 7265 6164 5f73  nit(x) pthread_s
-00080750: 7069 6e5f 696e 6974 2878 2c20 5054 4852  pin_init(x, PTHR
-00080760: 4541 445f 5052 4f43 4553 535f 5052 4956  EAD_PROCESS_PRIV
-00080770: 4154 4529 0a2f 2f23 6465 6669 6e65 2067  ATE).//#define g
-00080780: 676d 6c5f 6c6f 636b 5f64 6573 7472 6f79  gml_lock_destroy
-00080790: 2070 7468 7265 6164 5f73 7069 6e5f 6465   pthread_spin_de
-000807a0: 7374 726f 790a 2f2f 2364 6566 696e 6520  stroy.//#define 
-000807b0: 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b 2020  ggml_lock_lock  
-000807c0: 2020 7074 6872 6561 645f 7370 696e 5f6c    pthread_spin_l
-000807d0: 6f63 6b0a 2f2f 2364 6566 696e 6520 6767  ock.//#define gg
-000807e0: 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b 2020  ml_lock_unlock  
-000807f0: 7074 6872 6561 645f 7370 696e 5f75 6e6c  pthread_spin_unl
-00080800: 6f63 6b0a 0a74 7970 6564 6566 2069 6e74  ock..typedef int
-00080810: 2067 676d 6c5f 6c6f 636b 5f74 3b0a 0a23   ggml_lock_t;..#
-00080820: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
-00080830: 5f69 6e69 7428 7829 2020 2020 554e 5553  _init(x)    UNUS
-00080840: 4544 2878 290a 2364 6566 696e 6520 6767  ED(x).#define gg
-00080850: 6d6c 5f6c 6f63 6b5f 6465 7374 726f 7928  ml_lock_destroy(
-00080860: 7829 2055 4e55 5345 4428 7829 0a23 6966  x) UNUSED(x).#if
-00080870: 2064 6566 696e 6564 285f 5f78 3836 5f36   defined(__x86_6
-00080880: 345f 5f29 207c 7c20 2864 6566 696e 6564  4__) || (defined
-00080890: 285f 4d53 435f 5645 5229 2026 2620 6465  (_MSC_VER) && de
-000808a0: 6669 6e65 6428 5f4d 5f41 4d44 3634 2929  fined(_M_AMD64))
-000808b0: 0a23 6465 6669 6e65 2067 676d 6c5f 6c6f  .#define ggml_lo
-000808c0: 636b 5f6c 6f63 6b28 7829 2020 2020 5f6d  ck_lock(x)    _m
-000808d0: 6d5f 7061 7573 6528 290a 2365 6c73 650a  m_pause().#else.
-000808e0: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
-000808f0: 6b5f 6c6f 636b 2878 2920 2020 2055 4e55  k_lock(x)    UNU
-00080900: 5345 4428 7829 0a23 656e 6469 660a 2364  SED(x).#endif.#d
-00080910: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
-00080920: 756e 6c6f 636b 2878 2920 2055 4e55 5345  unlock(x)  UNUSE
-00080930: 4428 7829 0a0a 2364 6566 696e 6520 4747  D(x)..#define GG
-00080940: 4d4c 5f4c 4f43 4b5f 494e 4954 4941 4c49  ML_LOCK_INITIALI
-00080950: 5a45 5220 300a 0a74 7970 6564 6566 2070  ZER 0..typedef p
-00080960: 7468 7265 6164 5f74 2067 676d 6c5f 7468  thread_t ggml_th
-00080970: 7265 6164 5f74 3b0a 0a23 6465 6669 6e65  read_t;..#define
-00080980: 2067 676d 6c5f 7468 7265 6164 5f63 7265   ggml_thread_cre
-00080990: 6174 6520 7074 6872 6561 645f 6372 6561  ate pthread_crea
-000809a0: 7465 0a23 6465 6669 6e65 2067 676d 6c5f  te.#define ggml_
-000809b0: 7468 7265 6164 5f6a 6f69 6e20 2020 7074  thread_join   pt
-000809c0: 6872 6561 645f 6a6f 696e 0a0a 2365 6e64  hread_join..#end
-000809d0: 6966 0a0a 2f2f 2041 6e64 726f 6964 2773  if..// Android's
-000809e0: 206c 6962 6320 696d 706c 656d 656e 7461   libc implementa
-000809f0: 7469 6f6e 2022 6269 6f6e 6963 2220 646f  tion "bionic" do
-00080a00: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00080a10: 6574 7469 6e67 2061 6666 696e 6974 790a  etting affinity.
-00080a20: 2369 6620 6465 6669 6e65 6428 5f5f 6c69  #if defined(__li
-00080a30: 6e75 785f 5f29 2026 2620 2164 6566 696e  nux__) && !defin
-00080a40: 6564 285f 5f42 494f 4e49 435f 5f29 0a76  ed(__BIONIC__).v
-00080a50: 6f69 6420 7365 745f 6e75 6d61 5f74 6872  oid set_numa_thr
-00080a60: 6561 645f 6166 6669 6e69 7479 2869 6e74  ead_affinity(int
-00080a70: 2074 6872 6561 645f 6e2c 2069 6e74 206e   thread_n, int n
-00080a80: 5f74 6872 6561 6473 2920 7b0a 2020 2020  _threads) {.    
-00080a90: 6966 2028 2167 676d 6c5f 6973 5f6e 756d  if (!ggml_is_num
-00080aa0: 6128 2929 207b 0a20 2020 2020 2020 2072  a()) {.        r
-00080ab0: 6574 7572 6e3b 0a20 2020 207d 0a0a 2020  eturn;.    }..  
-00080ac0: 2020 2f2f 2072 756e 2074 6872 6561 6420    // run thread 
-00080ad0: 6f6e 206e 6f64 655f 6e75 6d20 7468 7265  on node_num thre
-00080ae0: 6164 5f6e 202f 2028 7468 7265 6164 7320  ad_n / (threads 
-00080af0: 7065 7220 6e6f 6465 290a 2020 2020 636f  per node).    co
-00080b00: 6e73 7420 696e 7420 6e6f 6465 5f6e 756d  nst int node_num
-00080b10: 203d 2074 6872 6561 645f 6e20 2f20 2828   = thread_n / ((
-00080b20: 6e5f 7468 7265 6164 7320 2b20 675f 7374  n_threads + g_st
-00080b30: 6174 652e 6e75 6d61 2e6e 5f6e 6f64 6573  ate.numa.n_nodes
-00080b40: 202d 2031 2920 2f20 675f 7374 6174 652e   - 1) / g_state.
-00080b50: 6e75 6d61 2e6e 5f6e 6f64 6573 293b 0a20  numa.n_nodes);. 
-00080b60: 2020 2073 7472 7563 7420 6767 6d6c 5f6e     struct ggml_n
-00080b70: 756d 615f 6e6f 6465 202a 206e 6f64 6520  uma_node * node 
-00080b80: 3d20 2667 5f73 7461 7465 2e6e 756d 612e  = &g_state.numa.
-00080b90: 6e6f 6465 735b 6e6f 6465 5f6e 756d 5d3b  nodes[node_num];
-00080ba0: 0a20 2020 2073 697a 655f 7420 7365 7473  .    size_t sets
-00080bb0: 697a 6520 3d20 4350 555f 414c 4c4f 435f  ize = CPU_ALLOC_
-00080bc0: 5349 5a45 2867 5f73 7461 7465 2e6e 756d  SIZE(g_state.num
-00080bd0: 612e 746f 7461 6c5f 6370 7573 293b 0a0a  a.total_cpus);..
-00080be0: 2020 2020 6370 755f 7365 745f 7420 2a20      cpu_set_t * 
-00080bf0: 6370 7573 203d 2043 5055 5f41 4c4c 4f43  cpus = CPU_ALLOC
-00080c00: 2867 5f73 7461 7465 2e6e 756d 612e 746f  (g_state.numa.to
-00080c10: 7461 6c5f 6370 7573 293b 0a20 2020 2043  tal_cpus);.    C
-00080c20: 5055 5f5a 4552 4f5f 5328 7365 7473 697a  PU_ZERO_S(setsiz
-00080c30: 652c 2063 7075 7329 3b0a 2020 2020 666f  e, cpus);.    fo
-00080c40: 7220 2873 697a 655f 7420 6920 3d20 303b  r (size_t i = 0;
-00080c50: 2069 203c 206e 6f64 652d 3e6e 5f63 7075   i < node->n_cpu
-00080c60: 733b 202b 2b69 2920 7b0a 2020 2020 2020  s; ++i) {.      
-00080c70: 2020 4350 555f 5345 545f 5328 6e6f 6465    CPU_SET_S(node
-00080c80: 2d3e 6370 7573 5b69 5d2c 2073 6574 7369  ->cpus[i], setsi
-00080c90: 7a65 2c20 6370 7573 293b 0a20 2020 207d  ze, cpus);.    }
-00080ca0: 0a0a 2020 2020 696e 7420 7276 203d 2070  ..    int rv = p
-00080cb0: 7468 7265 6164 5f73 6574 6166 6669 6e69  thread_setaffini
-00080cc0: 7479 5f6e 7028 7074 6872 6561 645f 7365  ty_np(pthread_se
-00080cd0: 6c66 2829 2c20 7365 7473 697a 652c 2063  lf(), setsize, c
-00080ce0: 7075 7329 3b0a 2020 2020 6966 2028 7276  pus);.    if (rv
-00080cf0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00080d00: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
-00080d10: 2277 6172 6e69 6e67 3a20 7074 6872 6561  "warning: pthrea
-00080d20: 645f 7365 7461 6666 696e 6974 795f 6e70  d_setaffinity_np
-00080d30: 2829 2066 6169 6c65 643a 2025 735c 6e22  () failed: %s\n"
-00080d40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00080d50: 2020 2020 2020 7374 7265 7272 6f72 2872        strerror(r
-00080d60: 7629 293b 0a20 2020 207d 0a0a 2020 2020  v));.    }..    
-00080d70: 4350 555f 4652 4545 2863 7075 7329 3b0a  CPU_FREE(cpus);.
-00080d80: 7d0a 0a76 6f69 6420 636c 6561 725f 6e75  }..void clear_nu
-00080d90: 6d61 5f74 6872 6561 645f 6166 6669 6e69  ma_thread_affini
-00080da0: 7479 2876 6f69 6429 207b 0a20 2020 2069  ty(void) {.    i
-00080db0: 6620 2821 6767 6d6c 5f69 735f 6e75 6d61  f (!ggml_is_numa
-00080dc0: 2829 2920 7b0a 2020 2020 2020 2020 7265  ()) {.        re
-00080dd0: 7475 726e 3b0a 2020 2020 7d0a 0a20 2020  turn;.    }..   
-00080de0: 2073 697a 655f 7420 7365 7473 697a 6520   size_t setsize 
-00080df0: 3d20 4350 555f 414c 4c4f 435f 5349 5a45  = CPU_ALLOC_SIZE
-00080e00: 2867 5f73 7461 7465 2e6e 756d 612e 746f  (g_state.numa.to
-00080e10: 7461 6c5f 6370 7573 293b 0a0a 2020 2020  tal_cpus);..    
-00080e20: 6370 755f 7365 745f 7420 2a20 6370 7573  cpu_set_t * cpus
-00080e30: 203d 2043 5055 5f41 4c4c 4f43 2867 5f73   = CPU_ALLOC(g_s
-00080e40: 7461 7465 2e6e 756d 612e 746f 7461 6c5f  tate.numa.total_
-00080e50: 6370 7573 293b 0a20 2020 2043 5055 5f5a  cpus);.    CPU_Z
-00080e60: 4552 4f5f 5328 7365 7473 697a 652c 2063  ERO_S(setsize, c
-00080e70: 7075 7329 3b0a 2020 2020 666f 7220 2875  pus);.    for (u
-00080e80: 6e73 6967 6e65 6420 6920 3d20 303b 2069  nsigned i = 0; i
-00080e90: 203c 2067 5f73 7461 7465 2e6e 756d 612e   < g_state.numa.
-00080ea0: 746f 7461 6c5f 6370 7573 3b20 2b2b 6929  total_cpus; ++i)
-00080eb0: 207b 0a20 2020 2020 2020 2043 5055 5f53   {.        CPU_S
-00080ec0: 4554 5f53 2869 2c20 7365 7473 697a 652c  ET_S(i, setsize,
-00080ed0: 2063 7075 7329 3b0a 2020 2020 7d0a 0a20   cpus);.    }.. 
-00080ee0: 2020 2069 6e74 2072 7620 3d20 7074 6872     int rv = pthr
-00080ef0: 6561 645f 7365 7461 6666 696e 6974 795f  ead_setaffinity_
-00080f00: 6e70 2870 7468 7265 6164 5f73 656c 6628  np(pthread_self(
-00080f10: 292c 2073 6574 7369 7a65 2c20 6370 7573  ), setsize, cpus
-00080f20: 293b 0a20 2020 2069 6620 2872 7629 207b  );.    if (rv) {
-00080f30: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
-00080f40: 2873 7464 6572 722c 2022 7761 726e 696e  (stderr, "warnin
-00080f50: 673a 2070 7468 7265 6164 5f73 6574 6166  g: pthread_setaf
-00080f60: 6669 6e69 7479 5f6e 7028 2920 6661 696c  finity_np() fail
-00080f70: 6564 3a20 2573 5c6e 222c 0a20 2020 2020  ed: %s\n",.     
-00080f80: 2020 2020 2020 2073 7472 6572 726f 7228         strerror(
-00080f90: 7276 2929 3b0a 2020 2020 7d0a 0a20 2020  rv));.    }..   
-00080fa0: 2043 5055 5f46 5245 4528 6370 7573 293b   CPU_FREE(cpus);
-00080fb0: 0a7d 0a23 656c 7365 0a2f 2f20 544f 444f  .}.#else.// TODO
-00080fc0: 3a20 5769 6e64 6f77 7320 6574 632e 0a2f  : Windows etc../
-00080fd0: 2f20 2874 6865 206c 696e 7578 2069 6d70  / (the linux imp
-00080fe0: 6c65 6d65 6e74 6174 696f 6e20 6d61 7920  lementation may 
-00080ff0: 616c 736f 2077 6f72 6b20 6f6e 2042 5344  also work on BSD
-00081000: 2c20 736f 6d65 6f6e 6520 7368 6f75 6c64  , someone should
-00081010: 2074 6573 7429 0a76 6f69 6420 7365 745f   test).void set_
-00081020: 6e75 6d61 5f74 6872 6561 645f 6166 6669  numa_thread_affi
-00081030: 6e69 7479 2869 6e74 2074 6872 6561 645f  nity(int thread_
-00081040: 6e2c 2069 6e74 206e 5f74 6872 6561 6473  n, int n_threads
-00081050: 2920 7b20 554e 5553 4544 2874 6872 6561  ) { UNUSED(threa
-00081060: 645f 6e29 3b20 554e 5553 4544 286e 5f74  d_n); UNUSED(n_t
-00081070: 6872 6561 6473 293b 2020 7d0a 766f 6964  hreads);  }.void
-00081080: 2063 6c65 6172 5f6e 756d 615f 7468 7265   clear_numa_thre
-00081090: 6164 5f61 6666 696e 6974 7928 766f 6964  ad_affinity(void
-000810a0: 2920 7b7d 0a23 656e 6469 660a 0a73 7472  ) {}.#endif..str
-000810b0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
-000810c0: 5f73 7461 7465 5f73 6861 7265 6420 7b0a  _state_shared {.
-000810d0: 2020 2020 636f 6e73 7420 7374 7275 6374      const struct
-000810e0: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
-000810f0: 6772 6170 683b 0a20 2020 2063 6f6e 7374  graph;.    const
-00081100: 2073 7472 7563 7420 6767 6d6c 5f63 706c   struct ggml_cpl
-00081110: 616e 2020 2a20 6370 6c61 6e3b 0a0a 2020  an  * cplan;..  
-00081120: 2020 696e 7436 345f 7420 7065 7266 5f6e    int64_t perf_n
-00081130: 6f64 655f 7374 6172 745f 6379 636c 6573  ode_start_cycles
-00081140: 3b0a 2020 2020 696e 7436 345f 7420 7065  ;.    int64_t pe
-00081150: 7266 5f6e 6f64 655f 7374 6172 745f 7469  rf_node_start_ti
-00081160: 6d65 5f75 733b 0a0a 2020 2020 636f 6e73  me_us;..    cons
-00081170: 7420 696e 7420 6e5f 7468 7265 6164 733b  t int n_threads;
-00081180: 0a0a 2020 2020 2f2f 2073 796e 6368 726f  ..    // synchro
-00081190: 6e69 7a61 7469 6f6e 2070 7269 6d69 7469  nization primiti
-000811a0: 7665 730a 2020 2020 6174 6f6d 6963 5f69  ves.    atomic_i
-000811b0: 6e74 206e 5f61 6374 6976 653b 202f 2f20  nt n_active; // 
-000811c0: 6e75 6d20 6163 7469 7665 2074 6872 6561  num active threa
-000811d0: 6473 0a20 2020 2061 746f 6d69 635f 696e  ds.    atomic_in
-000811e0: 7420 6e6f 6465 5f6e 3b20 2020 2f2f 2061  t node_n;   // a
-000811f0: 6374 6976 6520 6772 6170 6820 6e6f 6465  ctive graph node
-00081200: 0a0a 2020 2020 626f 6f6c 2028 2a61 626f  ..    bool (*abo
-00081210: 7274 5f63 616c 6c62 6163 6b29 2876 6f69  rt_callback)(voi
-00081220: 6420 2a20 6461 7461 293b 202f 2f20 6162  d * data); // ab
-00081230: 6f72 7420 6767 6d6c 5f67 7261 7068 5f63  ort ggml_graph_c
-00081240: 6f6d 7075 7465 2077 6865 6e20 7472 7565  ompute when true
-00081250: 0a20 2020 2076 6f69 6420 2a20 6162 6f72  .    void * abor
-00081260: 745f 6361 6c6c 6261 636b 5f64 6174 613b  t_callback_data;
-00081270: 0a7d 3b0a 0a73 7472 7563 7420 6767 6d6c  .};..struct ggml
-00081280: 5f63 6f6d 7075 7465 5f73 7461 7465 207b  _compute_state {
-00081290: 0a20 2020 2067 676d 6c5f 7468 7265 6164  .    ggml_thread
-000812a0: 5f74 2074 6872 643b 0a20 2020 2069 6e74  _t thrd;.    int
-000812b0: 2069 7468 3b0a 2020 2020 7374 7275 6374   ith;.    struct
-000812c0: 2067 676d 6c5f 636f 6d70 7574 655f 7374   ggml_compute_st
-000812d0: 6174 655f 7368 6172 6564 202a 2073 6861  ate_shared * sha
-000812e0: 7265 643b 0a7d 3b0a 0a73 7461 7469 6320  red;.};..static 
-000812f0: 766f 6964 2067 676d 6c5f 6772 6170 685f  void ggml_graph_
-00081300: 636f 6d70 7574 655f 7065 7266 5f73 7461  compute_perf_sta
-00081310: 7473 5f6e 6f64 6528 7374 7275 6374 2067  ts_node(struct g
-00081320: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
-00081330: 652c 2063 6f6e 7374 2073 7472 7563 7420  e, const struct 
-00081340: 6767 6d6c 5f63 6f6d 7075 7465 5f73 7461  ggml_compute_sta
-00081350: 7465 5f73 6861 7265 6420 2a20 7374 2920  te_shared * st) 
-00081360: 7b0a 2020 2020 696e 7436 345f 7420 6379  {.    int64_t cy
-00081370: 636c 6573 5f63 7572 2020 3d20 6767 6d6c  cles_cur  = ggml
-00081380: 5f70 6572 665f 6379 636c 6573 2829 2020  _perf_cycles()  
-00081390: 2d20 7374 2d3e 7065 7266 5f6e 6f64 655f  - st->perf_node_
-000813a0: 7374 6172 745f 6379 636c 6573 3b0a 2020  start_cycles;.  
-000813b0: 2020 696e 7436 345f 7420 7469 6d65 5f75    int64_t time_u
-000813c0: 735f 6375 7220 3d20 6767 6d6c 5f70 6572  s_cur = ggml_per
-000813d0: 665f 7469 6d65 5f75 7328 2920 2d20 7374  f_time_us() - st
-000813e0: 2d3e 7065 7266 5f6e 6f64 655f 7374 6172  ->perf_node_star
-000813f0: 745f 7469 6d65 5f75 733b 0a0a 2020 2020  t_time_us;..    
-00081400: 6e6f 6465 2d3e 7065 7266 5f72 756e 732b  node->perf_runs+
-00081410: 2b3b 0a20 2020 206e 6f64 652d 3e70 6572  +;.    node->per
-00081420: 665f 6379 636c 6573 2020 2b3d 2063 7963  f_cycles  += cyc
-00081430: 6c65 735f 6375 723b 0a20 2020 206e 6f64  les_cur;.    nod
-00081440: 652d 3e70 6572 665f 7469 6d65 5f75 7320  e->perf_time_us 
-00081450: 2b3d 2074 696d 655f 7573 5f63 7572 3b0a  += time_us_cur;.
-00081460: 7d0a 0a73 7461 7469 6320 7468 7265 6164  }..static thread
-00081470: 5f72 6574 5f74 2067 676d 6c5f 6772 6170  _ret_t ggml_grap
-00081480: 685f 636f 6d70 7574 655f 7468 7265 6164  h_compute_thread
-00081490: 2876 6f69 6420 2a20 6461 7461 2920 7b0a  (void * data) {.
-000814a0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000814b0: 636f 6d70 7574 655f 7374 6174 6520 2a20  compute_state * 
-000814c0: 7374 6174 6520 3d20 2873 7472 7563 7420  state = (struct 
-000814d0: 6767 6d6c 5f63 6f6d 7075 7465 5f73 7461  ggml_compute_sta
-000814e0: 7465 202a 2920 6461 7461 3b0a 0a20 2020  te *) data;..   
-000814f0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-00081500: 6d6c 5f63 6772 6170 6820 2a20 6367 7261  ml_cgraph * cgra
-00081510: 7068 203d 2073 7461 7465 2d3e 7368 6172  ph = state->shar
-00081520: 6564 2d3e 6367 7261 7068 3b0a 2020 2020  ed->cgraph;.    
-00081530: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
-00081540: 6c5f 6370 6c61 6e20 202a 2063 706c 616e  l_cplan  * cplan
-00081550: 2020 3d20 7374 6174 652d 3e73 6861 7265    = state->share
-00081560: 642d 3e63 706c 616e 3b0a 0a20 2020 2063  d->cplan;..    c
-00081570: 6f6e 7374 2069 6e74 202a 206e 5f74 6173  onst int * n_tas
-00081580: 6b73 5f61 7272 203d 2063 706c 616e 2d3e  ks_arr = cplan->
-00081590: 6e5f 7461 736b 733b 0a20 2020 2063 6f6e  n_tasks;.    con
-000815a0: 7374 2069 6e74 2020 206e 5f74 6872 6561  st int   n_threa
-000815b0: 6473 2020 203d 2073 7461 7465 2d3e 7368  ds   = state->sh
-000815c0: 6172 6564 2d3e 6e5f 7468 7265 6164 733b  ared->n_threads;
-000815d0: 0a0a 2020 2020 7365 745f 6e75 6d61 5f74  ..    set_numa_t
-000815e0: 6872 6561 645f 6166 6669 6e69 7479 2873  hread_affinity(s
-000815f0: 7461 7465 2d3e 6974 682c 206e 5f74 6872  tate->ith, n_thr
-00081600: 6561 6473 293b 0a0a 2020 2020 696e 7420  eads);..    int 
-00081610: 6e6f 6465 5f6e 203d 202d 313b 0a0a 2020  node_n = -1;..  
-00081620: 2020 7768 696c 6520 2874 7275 6529 207b    while (true) {
-00081630: 0a20 2020 2020 2020 2069 6620 2863 706c  .        if (cpl
-00081640: 616e 2d3e 6162 6f72 745f 6361 6c6c 6261  an->abort_callba
-00081650: 636b 2026 2620 6370 6c61 6e2d 3e61 626f  ck && cplan->abo
-00081660: 7274 5f63 616c 6c62 6163 6b28 6370 6c61  rt_callback(cpla
-00081670: 6e2d 3e61 626f 7274 5f63 616c 6c62 6163  n->abort_callbac
-00081680: 6b5f 6461 7461 2929 207b 0a20 2020 2020  k_data)) {.     
-00081690: 2020 2020 2020 2073 7461 7465 2d3e 7368         state->sh
-000816a0: 6172 6564 2d3e 6e6f 6465 5f6e 202b 3d20  ared->node_n += 
-000816b0: 313b 0a20 2020 2020 2020 2020 2020 2072  1;.            r
-000816c0: 6574 7572 6e20 2874 6872 6561 645f 7265  eturn (thread_re
-000816d0: 745f 7429 2047 474d 4c5f 4558 4954 5f41  t_t) GGML_EXIT_A
-000816e0: 424f 5254 4544 3b0a 2020 2020 2020 2020  BORTED;.        
-000816f0: 7d0a 2020 2020 2020 2020 6966 2028 6174  }.        if (at
-00081700: 6f6d 6963 5f66 6574 6368 5f73 7562 2826  omic_fetch_sub(&
-00081710: 7374 6174 652d 3e73 6861 7265 642d 3e6e  state->shared->n
-00081720: 5f61 6374 6976 652c 2031 2920 3d3d 2031  _active, 1) == 1
-00081730: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00081740: 2f2f 2061 6c6c 206f 7468 6572 2074 6872  // all other thr
-00081750: 6561 6473 2061 7265 2066 696e 6973 6865  eads are finishe
-00081760: 6420 616e 6420 7370 696e 6e69 6e67 0a20  d and spinning. 
-00081770: 2020 2020 2020 2020 2020 202f 2f20 646f             // do
-00081780: 2066 696e 616c 697a 6520 616e 6420 696e   finalize and in
-00081790: 6974 2068 6572 6520 736f 2077 6520 646f  it here so we do
-000817a0: 6e27 7420 6861 7665 2073 796e 6368 726f  n't have synchro
-000817b0: 6e69 7a65 2061 6761 696e 0a20 2020 2020  nize again.     
-000817c0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-000817d0: 6d6c 5f63 6f6d 7075 7465 5f70 6172 616d  ml_compute_param
-000817e0: 7320 7061 7261 6d73 203d 207b 0a20 2020  s params = {.   
-000817f0: 2020 2020 2020 2020 2020 2020 202f 2a2e               /*.
-00081800: 7479 7065 2020 3d2a 2f20 4747 4d4c 5f54  type  =*/ GGML_T
-00081810: 4153 4b5f 4649 4e41 4c49 5a45 2c0a 2020  ASK_FINALIZE,.  
-00081820: 2020 2020 2020 2020 2020 2020 2020 2f2a                /*
-00081830: 2e69 7468 2020 203d 2a2f 2030 2c0a 2020  .ith   =*/ 0,.  
-00081840: 2020 2020 2020 2020 2020 2020 2020 2f2a                /*
-00081850: 2e6e 7468 2020 203d 2a2f 2030 2c0a 2020  .nth   =*/ 0,.  
-00081860: 2020 2020 2020 2020 2020 2020 2020 2f2a                /*
-00081870: 2e77 7369 7a65 203d 2a2f 2063 706c 616e  .wsize =*/ cplan
-00081880: 2d3e 776f 726b 5f73 697a 652c 0a20 2020  ->work_size,.   
-00081890: 2020 2020 2020 2020 2020 2020 202f 2a2e               /*.
-000818a0: 7764 6174 6120 3d2a 2f20 6370 6c61 6e2d  wdata =*/ cplan-
-000818b0: 3e77 6f72 6b5f 6461 7461 2c0a 2020 2020  >work_data,.    
-000818c0: 2020 2020 2020 2020 7d3b 0a0a 2020 2020          };..    
-000818d0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-000818e0: 5f6e 2021 3d20 2d31 2920 7b0a 2020 2020  _n != -1) {.    
-000818f0: 2020 2020 2020 2020 2020 2020 2f2a 2046              /* F
-00081900: 494e 414c 495a 4520 2a2f 0a20 2020 2020  INALIZE */.     
-00081910: 2020 2020 2020 2020 2020 2073 7472 7563             struc
-00081920: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-00081930: 6e6f 6465 203d 2073 7461 7465 2d3e 7368  node = state->sh
-00081940: 6172 6564 2d3e 6367 7261 7068 2d3e 6e6f  ared->cgraph->no
-00081950: 6465 735b 6e6f 6465 5f6e 5d3b 0a20 2020  des[node_n];.   
-00081960: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00081970: 2847 474d 4c5f 4f50 5f48 4153 5f46 494e  (GGML_OP_HAS_FIN
-00081980: 414c 495a 455b 6e6f 6465 2d3e 6f70 5d29  ALIZE[node->op])
-00081990: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000819a0: 2020 2020 2020 2070 6172 616d 732e 6e74         params.nt
-000819b0: 6820 3d20 6e5f 7461 736b 735f 6172 725b  h = n_tasks_arr[
-000819c0: 6e6f 6465 5f6e 5d3b 0a20 2020 2020 2020  node_n];.       
-000819d0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-000819e0: 6c5f 636f 6d70 7574 655f 666f 7277 6172  l_compute_forwar
-000819f0: 6428 2670 6172 616d 732c 206e 6f64 6529  d(&params, node)
-00081a00: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00081a10: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-00081a20: 5f63 6f6d 7075 7465 5f70 6572 665f 7374  _compute_perf_st
-00081a30: 6174 735f 6e6f 6465 286e 6f64 652c 2073  ats_node(node, s
-00081a40: 7461 7465 2d3e 7368 6172 6564 293b 0a20  tate->shared);. 
-00081a50: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00081a60: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00081a70: 2020 2020 2020 2020 2020 2020 2f2f 2064              // d
-00081a80: 6973 7472 6962 7574 6520 6e65 7720 776f  istribute new wo
-00081a90: 726b 206f 7220 6578 6563 7574 6520 6974  rk or execute it
-00081aa0: 2064 6972 6563 7420 6966 2031 540a 2020   direct if 1T.  
-00081ab0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00081ac0: 282b 2b6e 6f64 655f 6e20 3c20 6367 7261  (++node_n < cgra
-00081ad0: 7068 2d3e 6e5f 6e6f 6465 7329 207b 0a20  ph->n_nodes) {. 
-00081ae0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00081af0: 474d 4c5f 5052 494e 545f 4445 4255 475f  GML_PRINT_DEBUG_
-00081b00: 3528 2225 733a 2025 642f 2564 5c6e 222c  5("%s: %d/%d\n",
-00081b10: 205f 5f66 756e 635f 5f2c 206e 6f64 655f   __func__, node_
-00081b20: 6e2c 2063 6772 6170 682d 3e6e 5f6e 6f64  n, cgraph->n_nod
-00081b30: 6573 293b 0a0a 2020 2020 2020 2020 2020  es);..          
-00081b40: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00081b50: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
-00081b60: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
-00081b70: 6e6f 6465 5f6e 5d3b 0a20 2020 2020 2020  node_n];.       
-00081b80: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00081b90: 6e74 206e 5f74 6173 6b73 203d 206e 5f74  nt n_tasks = n_t
-00081ba0: 6173 6b73 5f61 7272 5b6e 6f64 655f 6e5d  asks_arr[node_n]
-00081bb0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00081bc0: 2020 2073 7461 7465 2d3e 7368 6172 6564     state->shared
-00081bd0: 2d3e 7065 7266 5f6e 6f64 655f 7374 6172  ->perf_node_star
-00081be0: 745f 6379 636c 6573 2020 3d20 6767 6d6c  t_cycles  = ggml
-00081bf0: 5f70 6572 665f 6379 636c 6573 2829 3b0a  _perf_cycles();.
-00081c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081c10: 7374 6174 652d 3e73 6861 7265 642d 3e70  state->shared->p
-00081c20: 6572 665f 6e6f 6465 5f73 7461 7274 5f74  erf_node_start_t
-00081c30: 696d 655f 7573 203d 2067 676d 6c5f 7065  ime_us = ggml_pe
-00081c40: 7266 5f74 696d 655f 7573 2829 3b0a 0a20  rf_time_us();.. 
-00081c50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00081c60: 6172 616d 732e 6e74 6820 3d20 6e5f 7461  arams.nth = n_ta
-00081c70: 736b 733b 0a0a 2020 2020 2020 2020 2020  sks;..          
-00081c80: 2020 2020 2020 2f2a 2049 4e49 5420 2a2f        /* INIT */
-00081c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00081ca0: 2069 6620 2847 474d 4c5f 4f50 5f48 4153   if (GGML_OP_HAS
-00081cb0: 5f49 4e49 545b 6e6f 6465 2d3e 6f70 5d29  _INIT[node->op])
-00081cc0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00081cd0: 2020 2020 2020 2070 6172 616d 732e 7479         params.ty
-00081ce0: 7065 203d 2047 474d 4c5f 5441 534b 5f49  pe = GGML_TASK_I
-00081cf0: 4e49 543b 0a20 2020 2020 2020 2020 2020  NIT;.           
-00081d00: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00081d10: 6d70 7574 655f 666f 7277 6172 6428 2670  mpute_forward(&p
-00081d20: 6172 616d 732c 206e 6f64 6529 3b0a 2020  arams, node);.  
-00081d30: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00081d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00081d50: 2069 6620 286e 5f74 6173 6b73 203d 3d20   if (n_tasks == 
-00081d60: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00081d70: 2020 2020 2020 2020 202f 2f20 544f 444f           // TODO
-00081d80: 3a20 6d61 7962 6520 7075 7368 206e 6f64  : maybe push nod
-00081d90: 655f 6e20 746f 2074 6865 2061 746f 6d69  e_n to the atomi
-00081da0: 6320 6275 7420 6966 206f 7468 6572 2074  c but if other t
-00081db0: 6872 6561 6473 2073 6565 206e 5f74 6173  hreads see n_tas
-00081dc0: 6b73 2069 7320 312c 0a20 2020 2020 2020  ks is 1,.       
-00081dd0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00081de0: 7468 6579 2064 6f20 736f 6d65 7468 696e  they do somethin
-00081df0: 6720 6d6f 7265 2065 6666 6963 6965 6e74  g more efficient
-00081e00: 2074 6861 6e20 7370 696e 6e69 6e67 2028   than spinning (
-00081e10: 3f29 0a20 2020 2020 2020 2020 2020 2020  ?).             
-00081e20: 2020 2020 2020 2070 6172 616d 732e 7479         params.ty
-00081e30: 7065 203d 2047 474d 4c5f 5441 534b 5f43  pe = GGML_TASK_C
-00081e40: 4f4d 5055 5445 3b0a 2020 2020 2020 2020  OMPUTE;.        
-00081e50: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00081e60: 5f63 6f6d 7075 7465 5f66 6f72 7761 7264  _compute_forward
-00081e70: 2826 7061 7261 6d73 2c20 6e6f 6465 293b  (&params, node);
-00081e80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00081e90: 2020 2020 2020 6966 2028 4747 4d4c 5f4f        if (GGML_O
-00081ea0: 505f 4841 535f 4649 4e41 4c49 5a45 5b6e  P_HAS_FINALIZE[n
-00081eb0: 6f64 652d 3e6f 705d 2920 7b0a 2020 2020  ode->op]) {.    
-00081ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00081ed0: 2020 2020 7061 7261 6d73 2e74 7970 6520      params.type 
-00081ee0: 3d20 4747 4d4c 5f54 4153 4b5f 4649 4e41  = GGML_TASK_FINA
-00081ef0: 4c49 5a45 3b0a 2020 2020 2020 2020 2020  LIZE;.          
-00081f00: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00081f10: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
-00081f20: 7264 2826 7061 7261 6d73 2c20 6e6f 6465  rd(&params, node
-00081f30: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00081f40: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-00081f50: 6772 6170 685f 636f 6d70 7574 655f 7065  graph_compute_pe
-00081f60: 7266 5f73 7461 7473 5f6e 6f64 6528 6e6f  rf_stats_node(no
-00081f70: 6465 2c20 7374 6174 652d 3e73 6861 7265  de, state->share
-00081f80: 6429 3b0a 2020 2020 2020 2020 2020 2020  d);.            
-00081f90: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00081fa0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-00081fb0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00081fc0: 2020 2020 2020 2062 7265 616b 3b0a 2020         break;.  
-00081fd0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00081fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00081ff0: 2069 6620 2863 706c 616e 2d3e 6162 6f72   if (cplan->abor
-00082000: 745f 6361 6c6c 6261 636b 2026 2620 6370  t_callback && cp
-00082010: 6c61 6e2d 3e61 626f 7274 5f63 616c 6c62  lan->abort_callb
-00082020: 6163 6b28 6370 6c61 6e2d 3e61 626f 7274  ack(cplan->abort
-00082030: 5f63 616c 6c62 6163 6b5f 6461 7461 2929  _callback_data))
-00082040: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00082050: 2020 2020 2020 2062 7265 616b 3b0a 2020         break;.  
-00082060: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00082070: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-00082080: 2020 2020 2020 2020 2020 2061 746f 6d69             atomi
-00082090: 635f 7374 6f72 6528 2673 7461 7465 2d3e  c_store(&state->
-000820a0: 7368 6172 6564 2d3e 6e5f 6163 7469 7665  shared->n_active
-000820b0: 2c20 6e5f 7468 7265 6164 7329 3b0a 2020  , n_threads);.  
-000820c0: 2020 2020 2020 2020 2020 6174 6f6d 6963            atomic
-000820d0: 5f73 746f 7265 2826 7374 6174 652d 3e73  _store(&state->s
-000820e0: 6861 7265 642d 3e6e 6f64 655f 6e2c 2020  hared->node_n,  
-000820f0: 206e 6f64 655f 6e29 3b0a 2020 2020 2020   node_n);.      
-00082100: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-00082110: 2020 2020 2020 202f 2f20 7761 6974 2066         // wait f
-00082120: 6f72 206f 7468 6572 2074 6872 6561 6473  or other threads
-00082130: 2074 6f20 6669 6e69 7368 0a20 2020 2020   to finish.     
-00082140: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
-00082150: 206c 6173 7420 3d20 6e6f 6465 5f6e 3b0a   last = node_n;.
-00082160: 2020 2020 2020 2020 2020 2020 646f 207b              do {
-00082170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082180: 202f 2f73 6368 6564 5f79 6965 6c64 2829   //sched_yield()
-00082190: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000821a0: 2020 6e6f 6465 5f6e 203d 2061 746f 6d69    node_n = atomi
-000821b0: 635f 6c6f 6164 2826 7374 6174 652d 3e73  c_load(&state->s
-000821c0: 6861 7265 642d 3e6e 6f64 655f 6e29 3b0a  hared->node_n);.
-000821d0: 2020 2020 2020 2020 2020 2020 7d20 7768              } wh
-000821e0: 696c 6520 286e 6f64 655f 6e20 3d3d 206c  ile (node_n == l
-000821f0: 6173 7429 3b0a 2020 2020 2020 2020 7d0a  ast);.        }.
-00082200: 0a20 2020 2020 2020 202f 2f20 6368 6563  .        // chec
-00082210: 6b20 6966 2077 6520 7368 6f75 6c64 2073  k if we should s
-00082220: 746f 700a 2020 2020 2020 2020 6966 2028  top.        if (
-00082230: 6e6f 6465 5f6e 203e 3d20 6367 7261 7068  node_n >= cgraph
-00082240: 2d3e 6e5f 6e6f 6465 7329 2062 7265 616b  ->n_nodes) break
-00082250: 3b0a 0a20 2020 2020 2020 202f 2a20 434f  ;..        /* CO
-00082260: 4d50 5554 4520 2a2f 0a20 2020 2020 2020  MPUTE */.       
-00082270: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00082280: 736f 7220 2a20 6e6f 6465 203d 2063 6772  sor * node = cgr
-00082290: 6170 682d 3e6e 6f64 6573 5b6e 6f64 655f  aph->nodes[node_
-000822a0: 6e5d 3b0a 2020 2020 2020 2020 636f 6e73  n];.        cons
-000822b0: 7420 696e 7420 6e5f 7461 736b 7320 3d20  t int n_tasks = 
-000822c0: 6e5f 7461 736b 735f 6172 725b 6e6f 6465  n_tasks_arr[node
-000822d0: 5f6e 5d3b 0a0a 2020 2020 2020 2020 7374  _n];..        st
-000822e0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-000822f0: 655f 7061 7261 6d73 2070 6172 616d 7320  e_params params 
-00082300: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00082310: 2f2a 2e74 7970 6520 203d 2a2f 2047 474d  /*.type  =*/ GGM
-00082320: 4c5f 5441 534b 5f43 4f4d 5055 5445 2c0a  L_TASK_COMPUTE,.
-00082330: 2020 2020 2020 2020 2020 2020 2f2a 2e69              /*.i
-00082340: 7468 2020 203d 2a2f 2073 7461 7465 2d3e  th   =*/ state->
-00082350: 6974 682c 0a20 2020 2020 2020 2020 2020  ith,.           
-00082360: 202f 2a2e 6e74 6820 2020 3d2a 2f20 6e5f   /*.nth   =*/ n_
-00082370: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
-00082380: 2020 202f 2a2e 7773 697a 6520 3d2a 2f20     /*.wsize =*/ 
-00082390: 6370 6c61 6e2d 3e77 6f72 6b5f 7369 7a65  cplan->work_size
-000823a0: 2c0a 2020 2020 2020 2020 2020 2020 2f2a  ,.            /*
-000823b0: 2e77 6461 7461 203d 2a2f 2063 706c 616e  .wdata =*/ cplan
-000823c0: 2d3e 776f 726b 5f64 6174 612c 0a20 2020  ->work_data,.   
-000823d0: 2020 2020 207d 3b0a 0a20 2020 2020 2020       };..       
-000823e0: 2069 6620 2873 7461 7465 2d3e 6974 6820   if (state->ith 
-000823f0: 3c20 6e5f 7461 736b 7329 207b 0a20 2020  < n_tasks) {.   
-00082400: 2020 2020 2020 2020 2067 676d 6c5f 636f           ggml_co
-00082410: 6d70 7574 655f 666f 7277 6172 6428 2670  mpute_forward(&p
-00082420: 6172 616d 732c 206e 6f64 6529 3b0a 2020  arams, node);.  
-00082430: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
-00082440: 2020 2072 6574 7572 6e20 4747 4d4c 5f45     return GGML_E
-00082450: 5849 545f 5355 4343 4553 533b 0a7d 0a0a  XIT_SUCCESS;.}..
-00082460: 7374 7275 6374 2067 676d 6c5f 6370 6c61  struct ggml_cpla
-00082470: 6e20 6767 6d6c 5f67 7261 7068 5f70 6c61  n ggml_graph_pla
-00082480: 6e28 7374 7275 6374 2067 676d 6c5f 6367  n(struct ggml_cg
-00082490: 7261 7068 202a 2063 6772 6170 682c 2069  raph * cgraph, i
-000824a0: 6e74 206e 5f74 6872 6561 6473 2920 7b0a  nt n_threads) {.
-000824b0: 2020 2020 6966 2028 6e5f 7468 7265 6164      if (n_thread
-000824c0: 7320 3c3d 2030 2920 7b0a 2020 2020 2020  s <= 0) {.      
-000824d0: 2020 6e5f 7468 7265 6164 7320 3d20 4747    n_threads = GG
-000824e0: 4d4c 5f44 4546 4155 4c54 5f4e 5f54 4852  ML_DEFAULT_N_THR
-000824f0: 4541 4453 3b0a 2020 2020 7d0a 0a20 2020  EADS;.    }..   
-00082500: 2073 697a 655f 7420 776f 726b 5f73 697a   size_t work_siz
-00082510: 6520 3d20 303b 0a0a 2020 2020 7374 7275  e = 0;..    stru
-00082520: 6374 2067 676d 6c5f 6370 6c61 6e20 6370  ct ggml_cplan cp
-00082530: 6c61 6e3b 0a20 2020 206d 656d 7365 7428  lan;.    memset(
-00082540: 2663 706c 616e 2c20 302c 2073 697a 656f  &cplan, 0, sizeo
-00082550: 6628 7374 7275 6374 2067 676d 6c5f 6370  f(struct ggml_cp
-00082560: 6c61 6e29 293b 0a0a 2020 2020 2f2f 2074  lan));..    // t
-00082570: 6872 6561 6420 7363 6865 6475 6c69 6e67  hread scheduling
-00082580: 2066 6f72 2074 6865 2064 6966 6665 7265   for the differe
-00082590: 6e74 206f 7065 7261 7469 6f6e 7320 2b20  nt operations + 
-000825a0: 776f 726b 2062 7566 6665 7220 7369 7a65  work buffer size
-000825b0: 2065 7374 696d 6174 696f 6e0a 2020 2020   estimation.    
-000825c0: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000825d0: 6920 3c20 6367 7261 7068 2d3e 6e5f 6e6f  i < cgraph->n_no
-000825e0: 6465 733b 2069 2b2b 2920 7b0a 2020 2020  des; i++) {.    
-000825f0: 2020 2020 696e 7420 6e5f 7461 736b 7320      int n_tasks 
-00082600: 3d20 313b 0a0a 2020 2020 2020 2020 7374  = 1;..        st
-00082610: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00082620: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
-00082630: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-00082640: 2020 2020 2073 7769 7463 6820 286e 6f64       switch (nod
-00082650: 652d 3e6f 7029 207b 0a20 2020 2020 2020  e->op) {.       
-00082660: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00082670: 505f 4350 593a 0a20 2020 2020 2020 2020  P_CPY:.         
-00082680: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00082690: 4455 503a 0a20 2020 2020 2020 2020 2020  DUP:.           
-000826a0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000826b0: 2020 2020 2020 2020 2020 206e 5f74 6173             n_tas
-000826c0: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
-000826d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000826e0: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
-000826f0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-00082700: 2020 2020 2020 2020 2069 6620 2867 676d           if (ggm
-00082710: 6c5f 6973 5f71 7561 6e74 697a 6564 286e  l_is_quantized(n
-00082720: 6f64 652d 3e74 7970 6529 2920 7b0a 2020  ode->type)) {.  
-00082730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082740: 2020 2020 2020 6375 7220 3d20 4747 4d4c        cur = GGML
-00082750: 5f54 5950 455f 5349 5a45 5b47 474d 4c5f  _TYPE_SIZE[GGML_
-00082760: 5459 5045 5f46 3332 5d20 2a20 6e6f 6465  TYPE_F32] * node
-00082770: 2d3e 6e65 5b30 5d20 2a20 6e5f 7461 736b  ->ne[0] * n_task
-00082780: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
-00082790: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-000827a0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-000827b0: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
-000827c0: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
-000827d0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000827e0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-000827f0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00082800: 5f41 4444 3a0a 2020 2020 2020 2020 2020  _ADD:.          
-00082810: 2020 6361 7365 2047 474d 4c5f 4f50 5f41    case GGML_OP_A
-00082820: 4444 313a 0a20 2020 2020 2020 2020 2020  DD1:.           
-00082830: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00082840: 2020 2020 2020 2020 2020 206e 5f74 6173             n_tas
-00082850: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
-00082860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082870: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
-00082880: 3d20 303b 0a0a 2020 2020 2020 2020 2020  = 0;..          
-00082890: 2020 2020 2020 2020 2020 6966 2028 6767            if (gg
-000828a0: 6d6c 5f69 735f 7175 616e 7469 7a65 6428  ml_is_quantized(
-000828b0: 6e6f 6465 2d3e 7372 635b 305d 2d3e 7479  node->src[0]->ty
-000828c0: 7065 2929 207b 0a20 2020 2020 2020 2020  pe)) {.         
-000828d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000828e0: 7572 203d 2047 474d 4c5f 5459 5045 5f53  ur = GGML_TYPE_S
-000828f0: 495a 455b 4747 4d4c 5f54 5950 455f 4633  IZE[GGML_TYPE_F3
-00082900: 325d 202a 206e 6f64 652d 3e73 7263 5b30  2] * node->src[0
-00082910: 5d2d 3e6e 655b 305d 202a 206e 5f74 6173  ]->ne[0] * n_tas
-00082920: 6b73 3b0a 2020 2020 2020 2020 2020 2020  ks;.            
-00082930: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00082940: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00082950: 6f72 6b5f 7369 7a65 203d 204d 4158 2877  ork_size = MAX(w
-00082960: 6f72 6b5f 7369 7a65 2c20 6375 7229 3b0a  ork_size, cur);.
-00082970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082980: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00082990: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000829a0: 505f 4143 433a 0a20 2020 2020 2020 2020  P_ACC:.         
-000829b0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000829c0: 2020 2020 2020 2020 2020 2020 206e 5f74               n_t
-000829d0: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
-000829e0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-000829f0: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-00082a00: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
-00082a10: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00082a20: 6767 6d6c 5f69 735f 7175 616e 7469 7a65  ggml_is_quantize
-00082a30: 6428 6e6f 6465 2d3e 7372 635b 305d 2d3e  d(node->src[0]->
-00082a40: 7479 7065 2929 207b 0a20 2020 2020 2020  type)) {.       
-00082a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082a60: 2063 7572 203d 2047 474d 4c5f 5459 5045   cur = GGML_TYPE
-00082a70: 5f53 495a 455b 4747 4d4c 5f54 5950 455f  _SIZE[GGML_TYPE_
-00082a80: 4633 325d 202a 206e 6f64 652d 3e73 7263  F32] * node->src
-00082a90: 5b31 5d2d 3e6e 655b 305d 202a 206e 5f74  [1]->ne[0] * n_t
-00082aa0: 6173 6b73 3b0a 2020 2020 2020 2020 2020  asks;.          
-00082ab0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00082ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082ad0: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
-00082ae0: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
-00082af0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00082b00: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00082b10: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00082b20: 5f4f 505f 5355 423a 0a20 2020 2020 2020  _OP_SUB:.       
-00082b30: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00082b40: 505f 4449 563a 0a20 2020 2020 2020 2020  P_DIV:.         
-00082b50: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00082b60: 5351 523a 0a20 2020 2020 2020 2020 2020  SQR:.           
-00082b70: 2063 6173 6520 4747 4d4c 5f4f 505f 5351   case GGML_OP_SQ
-00082b80: 5254 3a0a 2020 2020 2020 2020 2020 2020  RT:.            
-00082b90: 6361 7365 2047 474d 4c5f 4f50 5f4c 4f47  case GGML_OP_LOG
-00082ba0: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
-00082bb0: 7365 2047 474d 4c5f 4f50 5f53 554d 3a0a  se GGML_OP_SUM:.
-00082bc0: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00082bd0: 2047 474d 4c5f 4f50 5f53 554d 5f52 4f57   GGML_OP_SUM_ROW
-00082be0: 533a 0a20 2020 2020 2020 2020 2020 2063  S:.            c
-00082bf0: 6173 6520 4747 4d4c 5f4f 505f 4d45 414e  ase GGML_OP_MEAN
-00082c00: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
-00082c10: 7365 2047 474d 4c5f 4f50 5f41 5247 4d41  se GGML_OP_ARGMA
-00082c20: 583a 0a20 2020 2020 2020 2020 2020 2063  X:.            c
-00082c30: 6173 6520 4747 4d4c 5f4f 505f 5245 5045  ase GGML_OP_REPE
-00082c40: 4154 3a0a 2020 2020 2020 2020 2020 2020  AT:.            
-00082c50: 6361 7365 2047 474d 4c5f 4f50 5f52 4550  case GGML_OP_REP
-00082c60: 4541 545f 4241 434b 3a0a 2020 2020 2020  EAT_BACK:.      
-00082c70: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00082c80: 4f50 5f41 4253 3a0a 2020 2020 2020 2020  OP_ABS:.        
-00082c90: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00082ca0: 5f53 474e 3a0a 2020 2020 2020 2020 2020  _SGN:.          
-00082cb0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4e    case GGML_OP_N
-00082cc0: 4547 3a0a 2020 2020 2020 2020 2020 2020  EG:.            
-00082cd0: 6361 7365 2047 474d 4c5f 4f50 5f53 5445  case GGML_OP_STE
-00082ce0: 503a 0a20 2020 2020 2020 2020 2020 2063  P:.            c
-00082cf0: 6173 6520 4747 4d4c 5f4f 505f 5441 4e48  ase GGML_OP_TANH
-00082d00: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
-00082d10: 7365 2047 474d 4c5f 4f50 5f45 4c55 3a0a  se GGML_OP_ELU:.
-00082d20: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00082d30: 2047 474d 4c5f 4f50 5f52 454c 553a 0a20   GGML_OP_RELU:. 
-00082d40: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-00082d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00082d60: 2020 2020 206e 5f74 6173 6b73 203d 2031       n_tasks = 1
-00082d70: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00082d80: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00082d90: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00082da0: 5f4f 505f 4d55 4c3a 0a20 2020 2020 2020  _OP_MUL:.       
-00082db0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00082dc0: 505f 4745 4c55 3a0a 2020 2020 2020 2020  P_GELU:.        
-00082dd0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00082de0: 5f47 454c 555f 5155 4943 4b3a 0a20 2020  _GELU_QUICK:.   
+0007f2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f2c0: 2020 7372 6331 2c0a 2020 2020 2020 2020    src1,.        
+0007f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f2e0: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+0007f2f0: 6f72 2d3e 6772 6164 292c 0a20 2020 2020  or->grad),.     
+0007f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0007f310: 2020 2020 2020 2020 2020 2069 6e70 6c61             inpla
+0007f320: 6365 293b 0a20 2020 2020 2020 2020 2020  ce);.           
+0007f330: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0007f340: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+0007f350: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+0007f360: 5f43 524f 5353 5f45 4e54 524f 5059 5f4c  _CROSS_ENTROPY_L
+0007f370: 4f53 535f 4241 434b 3a0a 2020 2020 2020  OSS_BACK:.      
+0007f380: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0007f390: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0007f3a0: 4552 5428 6661 6c73 6529 3b20 2f2f 206e  ERT(false); // n
+0007f3b0: 6f74 2073 7570 706f 7274 6564 0a20 2020  ot supported.   
+0007f3c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0007f3d0: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+0007f3e0: 474d 4c5f 4f50 5f4e 4f4e 453a 0a20 2020  GML_OP_NONE:.   
+0007f3f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0007f400: 2020 2020 2020 2020 2020 202f 2f20 6e6f             // no
+0007f410: 700a 2020 2020 2020 2020 2020 2020 7d20  p.            } 
+0007f420: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
+0007f430: 6173 6520 4747 4d4c 5f4f 505f 434f 554e  ase GGML_OP_COUN
+0007f440: 543a 0a20 2020 2020 2020 2020 2020 207b  T:.            {
+0007f450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0007f460: 2047 474d 4c5f 4153 5345 5254 2866 616c   GGML_ASSERT(fal
+0007f470: 7365 293b 0a20 2020 2020 2020 2020 2020  se);.           
+0007f480: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
+0007f490: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+0007f4a0: 676d 6c5f 7669 7369 745f 7061 7265 6e74  gml_visit_parent
+0007f4b0: 7328 7374 7275 6374 2067 676d 6c5f 6367  s(struct ggml_cg
+0007f4c0: 7261 7068 202a 2063 6772 6170 682c 2073  raph * cgraph, s
+0007f4d0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0007f4e0: 7220 2a20 6e6f 6465 2920 7b0a 2020 2020  r * node) {.    
+0007f4f0: 6966 2028 6e6f 6465 2d3e 6772 6164 203d  if (node->grad =
+0007f500: 3d20 4e55 4c4c 2920 7b0a 2020 2020 2020  = NULL) {.      
+0007f510: 2020 2f2f 2074 6869 7320 7573 7561 6c6c    // this usuall
+0007f520: 7920 6861 7070 656e 7320 7768 656e 2077  y happens when w
+0007f530: 6520 6765 6e65 7261 7465 2069 6e74 6572  e generate inter
+0007f540: 6d65 6469 6174 6520 6e6f 6465 7320 6672  mediate nodes fr
+0007f550: 6f6d 2063 6f6e 7374 616e 7473 2069 6e20  om constants in 
+0007f560: 7468 6520 6261 636b 7761 7264 2070 6173  the backward pas
+0007f570: 730a 2020 2020 2020 2020 2f2f 2069 7420  s.        // it 
+0007f580: 6361 6e20 616c 736f 2068 6170 7065 6e20  can also happen 
+0007f590: 6475 7269 6e67 2066 6f72 7761 7264 2070  during forward p
+0007f5a0: 6173 732c 2069 6620 7468 6520 7573 6572  ass, if the user
+0007f5b0: 2070 6572 666f 726d 7320 636f 6d70 7574   performs comput
+0007f5c0: 6174 696f 6e73 2077 6974 6820 636f 6e73  ations with cons
+0007f5d0: 7461 6e74 730a 2020 2020 2020 2020 6966  tants.        if
+0007f5e0: 2028 6e6f 6465 2d3e 6f70 2021 3d20 4747   (node->op != GG
+0007f5f0: 4d4c 5f4f 505f 4e4f 4e45 2920 7b0a 2020  ML_OP_NONE) {.  
+0007f600: 2020 2020 2020 2020 2020 2f2f 4747 4d4c            //GGML
+0007f610: 5f50 5249 4e54 5f44 4542 5547 2822 2573  _PRINT_DEBUG("%s
+0007f620: 3a20 7761 726e 696e 673a 206e 6f64 6520  : warning: node 
+0007f630: 2570 2068 6173 206e 6f20 6772 6164 2c20  %p has no grad, 
+0007f640: 6275 7420 6f70 2025 645c 6e22 2c20 5f5f  but op %d\n", __
+0007f650: 6675 6e63 5f5f 2c20 2876 6f69 6420 2a29  func__, (void *)
+0007f660: 206e 6f64 652c 206e 6f64 652d 3e6f 7029   node, node->op)
+0007f670: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+0007f680: 7d0a 0a20 2020 202f 2f20 6368 6563 6b20  }..    // check 
+0007f690: 6966 2061 6c72 6561 6479 2076 6973 6974  if already visit
+0007f6a0: 6564 0a20 2020 2066 6f72 2028 696e 7420  ed.    for (int 
+0007f6b0: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
+0007f6c0: 682d 3e6e 5f6e 6f64 6573 3b20 692b 2b29  h->n_nodes; i++)
+0007f6d0: 207b 0a20 2020 2020 2020 2069 6620 2863   {.        if (c
+0007f6e0: 6772 6170 682d 3e6e 6f64 6573 5b69 5d20  graph->nodes[i] 
+0007f6f0: 3d3d 206e 6f64 6529 207b 0a20 2020 2020  == node) {.     
+0007f700: 2020 2020 2020 2072 6574 7572 6e3b 0a20         return;. 
+0007f710: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+0007f720: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+0007f730: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
+0007f740: 6e5f 6c65 6166 733b 2069 2b2b 2920 7b0a  n_leafs; i++) {.
+0007f750: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
+0007f760: 7068 2d3e 6c65 6166 735b 695d 203d 3d20  ph->leafs[i] == 
+0007f770: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
+0007f780: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
+0007f790: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+0007f7a0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0007f7b0: 2069 203c 2047 474d 4c5f 4d41 585f 5352   i < GGML_MAX_SR
+0007f7c0: 433b 202b 2b69 2920 7b0a 2020 2020 2020  C; ++i) {.      
+0007f7d0: 2020 6966 2028 6e6f 6465 2d3e 7372 635b    if (node->src[
+0007f7e0: 695d 2920 7b0a 2020 2020 2020 2020 2020  i]) {.          
+0007f7f0: 2020 6767 6d6c 5f76 6973 6974 5f70 6172    ggml_visit_par
+0007f800: 656e 7473 2863 6772 6170 682c 206e 6f64  ents(cgraph, nod
+0007f810: 652d 3e73 7263 5b69 5d29 3b0a 2020 2020  e->src[i]);.    
+0007f820: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+0007f830: 2069 6620 286e 6f64 652d 3e6f 7020 3d3d   if (node->op ==
+0007f840: 2047 474d 4c5f 4f50 5f4e 4f4e 4520 2626   GGML_OP_NONE &&
+0007f850: 206e 6f64 652d 3e67 7261 6420 3d3d 204e   node->grad == N
+0007f860: 554c 4c29 207b 0a20 2020 2020 2020 202f  ULL) {.        /
+0007f870: 2f20 7265 6163 6865 6420 6120 6c65 6166  / reached a leaf
+0007f880: 206e 6f64 652c 206e 6f74 2070 6172 7420   node, not part 
+0007f890: 6f66 2074 6865 2067 7261 6469 656e 7420  of the gradient 
+0007f8a0: 6772 6170 6820 2865 2e67 2e20 6120 636f  graph (e.g. a co
+0007f8b0: 6e73 7461 6e74 290a 2020 2020 2020 2020  nstant).        
+0007f8c0: 4747 4d4c 5f41 5353 4552 5428 6367 7261  GGML_ASSERT(cgra
+0007f8d0: 7068 2d3e 6e5f 6c65 6166 7320 3c20 4747  ph->n_leafs < GG
+0007f8e0: 4d4c 5f4d 4158 5f4e 4f44 4553 293b 0a0a  ML_MAX_NODES);..
+0007f8f0: 2020 2020 2020 2020 6966 2028 7374 726c          if (strl
+0007f900: 656e 286e 6f64 652d 3e6e 616d 6529 203d  en(node->name) =
+0007f910: 3d20 3029 207b 0a20 2020 2020 2020 2020  = 0) {.         
+0007f920: 2020 2067 676d 6c5f 666f 726d 6174 5f6e     ggml_format_n
+0007f930: 616d 6528 6e6f 6465 2c20 226c 6561 665f  ame(node, "leaf_
+0007f940: 2564 222c 2063 6772 6170 682d 3e6e 5f6c  %d", cgraph->n_l
+0007f950: 6561 6673 293b 0a20 2020 2020 2020 207d  eafs);.        }
+0007f960: 0a0a 2020 2020 2020 2020 6367 7261 7068  ..        cgraph
+0007f970: 2d3e 6c65 6166 735b 6367 7261 7068 2d3e  ->leafs[cgraph->
+0007f980: 6e5f 6c65 6166 735d 203d 206e 6f64 653b  n_leafs] = node;
+0007f990: 0a20 2020 2020 2020 2063 6772 6170 682d  .        cgraph-
+0007f9a0: 3e6e 5f6c 6561 6673 2b2b 3b0a 2020 2020  >n_leafs++;.    
+0007f9b0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+0007f9c0: 2047 474d 4c5f 4153 5345 5254 2863 6772   GGML_ASSERT(cgr
+0007f9d0: 6170 682d 3e6e 5f6e 6f64 6573 203c 2047  aph->n_nodes < G
+0007f9e0: 474d 4c5f 4d41 585f 4e4f 4445 5329 3b0a  GML_MAX_NODES);.
+0007f9f0: 0a20 2020 2020 2020 2069 6620 2873 7472  .        if (str
+0007fa00: 6c65 6e28 6e6f 6465 2d3e 6e61 6d65 2920  len(node->name) 
+0007fa10: 3d3d 2030 2920 7b0a 2020 2020 2020 2020  == 0) {.        
+0007fa20: 2020 2020 6767 6d6c 5f66 6f72 6d61 745f      ggml_format_
+0007fa30: 6e61 6d65 286e 6f64 652c 2022 6e6f 6465  name(node, "node
+0007fa40: 5f25 6422 2c20 6367 7261 7068 2d3e 6e5f  _%d", cgraph->n_
+0007fa50: 6e6f 6465 7329 3b0a 2020 2020 2020 2020  nodes);.        
+0007fa60: 7d0a 0a20 2020 2020 2020 2063 6772 6170  }..        cgrap
+0007fa70: 682d 3e6e 6f64 6573 5b63 6772 6170 682d  h->nodes[cgraph-
+0007fa80: 3e6e 5f6e 6f64 6573 5d20 3d20 6e6f 6465  >n_nodes] = node
+0007fa90: 3b0a 2020 2020 2020 2020 6367 7261 7068  ;.        cgraph
+0007faa0: 2d3e 6772 6164 735b 6367 7261 7068 2d3e  ->grads[cgraph->
+0007fab0: 6e5f 6e6f 6465 735d 203d 206e 6f64 652d  n_nodes] = node-
+0007fac0: 3e67 7261 643b 0a20 2020 2020 2020 2063  >grad;.        c
+0007fad0: 6772 6170 682d 3e6e 5f6e 6f64 6573 2b2b  graph->n_nodes++
+0007fae0: 3b0a 2020 2020 7d0a 7d0a 0a73 7461 7469  ;.    }.}..stati
+0007faf0: 6320 766f 6964 2067 676d 6c5f 6275 696c  c void ggml_buil
+0007fb00: 645f 666f 7277 6172 645f 696d 706c 2873  d_forward_impl(s
+0007fb10: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+0007fb20: 6820 2a20 6367 7261 7068 2c20 7374 7275  h * cgraph, stru
+0007fb30: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0007fb40: 2074 656e 736f 722c 2062 6f6f 6c20 6578   tensor, bool ex
+0007fb50: 7061 6e64 2920 7b0a 2020 2020 6966 2028  pand) {.    if (
+0007fb60: 2165 7870 616e 6429 207b 0a20 2020 2020  !expand) {.     
+0007fb70: 2020 2063 6772 6170 682d 3e6e 5f6e 6f64     cgraph->n_nod
+0007fb80: 6573 203d 2030 3b0a 2020 2020 2020 2020  es = 0;.        
+0007fb90: 6367 7261 7068 2d3e 6e5f 6c65 6166 7320  cgraph->n_leafs 
+0007fba0: 3d20 303b 0a20 2020 207d 0a0a 2020 2020  = 0;.    }..    
+0007fbb0: 636f 6e73 7420 696e 7420 6e30 203d 2063  const int n0 = c
+0007fbc0: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b0a  graph->n_nodes;.
+0007fbd0: 2020 2020 554e 5553 4544 286e 3029 3b0a      UNUSED(n0);.
+0007fbe0: 0a20 2020 2067 676d 6c5f 7669 7369 745f  .    ggml_visit_
+0007fbf0: 7061 7265 6e74 7328 6367 7261 7068 2c20  parents(cgraph, 
+0007fc00: 7465 6e73 6f72 293b 0a0a 2020 2020 636f  tensor);..    co
+0007fc10: 6e73 7420 696e 7420 6e5f 6e65 7720 3d20  nst int n_new = 
+0007fc20: 6367 7261 7068 2d3e 6e5f 6e6f 6465 7320  cgraph->n_nodes 
+0007fc30: 2d20 6e30 3b0a 2020 2020 4747 4d4c 5f50  - n0;.    GGML_P
+0007fc40: 5249 4e54 5f44 4542 5547 2822 2573 3a20  RINT_DEBUG("%s: 
+0007fc50: 7669 7369 7465 6420 2564 206e 6577 206e  visited %d new n
+0007fc60: 6f64 6573 5c6e 222c 205f 5f66 756e 635f  odes\n", __func_
+0007fc70: 5f2c 206e 5f6e 6577 293b 0a0a 2020 2020  _, n_new);..    
+0007fc80: 6966 2028 6e5f 6e65 7720 3e20 3029 207b  if (n_new > 0) {
+0007fc90: 0a20 2020 2020 2020 202f 2f20 7468 6520  .        // the 
+0007fca0: 6c61 7374 2061 6464 6564 206e 6f64 6520  last added node 
+0007fcb0: 7368 6f75 6c64 2061 6c77 6179 7320 6265  should always be
+0007fcc0: 2073 7461 7274 696e 6720 706f 696e 740a   starting point.
+0007fcd0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+0007fce0: 4552 5428 6367 7261 7068 2d3e 6e6f 6465  ERT(cgraph->node
+0007fcf0: 735b 6367 7261 7068 2d3e 6e5f 6e6f 6465  s[cgraph->n_node
+0007fd00: 7320 2d20 315d 203d 3d20 7465 6e73 6f72  s - 1] == tensor
+0007fd10: 293b 0a20 2020 207d 0a7d 0a0a 766f 6964  );.    }.}..void
+0007fd20: 2067 676d 6c5f 6275 696c 645f 666f 7277   ggml_build_forw
+0007fd30: 6172 645f 6578 7061 6e64 2873 7472 7563  ard_expand(struc
+0007fd40: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+0007fd50: 6367 7261 7068 2c20 7374 7275 6374 2067  cgraph, struct g
+0007fd60: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+0007fd70: 736f 7229 207b 0a20 2020 2067 676d 6c5f  sor) {.    ggml_
+0007fd80: 6275 696c 645f 666f 7277 6172 645f 696d  build_forward_im
+0007fd90: 706c 2863 6772 6170 682c 2074 656e 736f  pl(cgraph, tenso
+0007fda0: 722c 2074 7275 6529 3b0a 7d0a 0a73 7472  r, true);.}..str
+0007fdb0: 7563 7420 6767 6d6c 5f63 6772 6170 6820  uct ggml_cgraph 
+0007fdc0: 6767 6d6c 5f62 7569 6c64 5f66 6f72 7761  ggml_build_forwa
+0007fdd0: 7264 2873 7472 7563 7420 6767 6d6c 5f74  rd(struct ggml_t
+0007fde0: 656e 736f 7220 2a20 7465 6e73 6f72 2920  ensor * tensor) 
+0007fdf0: 7b0a 2020 2020 7374 7275 6374 2067 676d  {.    struct ggm
+0007fe00: 6c5f 6367 7261 7068 2072 6573 756c 7420  l_cgraph result 
+0007fe10: 3d20 7b0a 2020 2020 2020 2020 2f2a 2e6e  = {.        /*.n
+0007fe20: 5f6e 6f64 6573 2020 2020 2020 3d2a 2f20  _nodes      =*/ 
+0007fe30: 302c 0a20 2020 2020 2020 202f 2a2e 6e5f  0,.        /*.n_
+0007fe40: 6c65 6166 7320 2020 2020 203d 2a2f 2030  leafs      =*/ 0
+0007fe50: 2c0a 2020 2020 2020 2020 2f2a 2e6e 6f64  ,.        /*.nod
+0007fe60: 6573 2020 2020 2020 2020 3d2a 2f20 7b20  es        =*/ { 
+0007fe70: 4e55 4c4c 207d 2c0a 2020 2020 2020 2020  NULL },.        
+0007fe80: 2f2a 2e67 7261 6473 2020 2020 2020 2020  /*.grads        
+0007fe90: 3d2a 2f20 7b20 4e55 4c4c 207d 2c0a 2020  =*/ { NULL },.  
+0007fea0: 2020 2020 2020 2f2a 2e6c 6561 6673 2020        /*.leafs  
+0007feb0: 2020 2020 2020 3d2a 2f20 7b20 4e55 4c4c        =*/ { NULL
+0007fec0: 207d 2c0a 2020 2020 2020 2020 2f2a 2e70   },.        /*.p
+0007fed0: 6572 665f 7275 6e73 2020 2020 3d2a 2f20  erf_runs    =*/ 
+0007fee0: 302c 0a20 2020 2020 2020 202f 2a2e 7065  0,.        /*.pe
+0007fef0: 7266 5f63 7963 6c65 7320 203d 2a2f 2030  rf_cycles  =*/ 0
+0007ff00: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
+0007ff10: 665f 7469 6d65 5f75 7320 3d2a 2f20 302c  f_time_us =*/ 0,
+0007ff20: 0a20 2020 207d 3b0a 0a20 2020 2067 676d  .    };..    ggm
+0007ff30: 6c5f 6275 696c 645f 666f 7277 6172 645f  l_build_forward_
+0007ff40: 696d 706c 2826 7265 7375 6c74 2c20 7465  impl(&result, te
+0007ff50: 6e73 6f72 2c20 6661 6c73 6529 3b0a 0a20  nsor, false);.. 
+0007ff60: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0007ff70: 3b0a 7d0a 0a73 7472 7563 7420 6767 6d6c  ;.}..struct ggml
+0007ff80: 5f63 6772 6170 6820 6767 6d6c 5f62 7569  _cgraph ggml_bui
+0007ff90: 6c64 5f62 6163 6b77 6172 6428 7374 7275  ld_backward(stru
+0007ffa0: 6374 2067 676d 6c5f 636f 6e74 6578 7420  ct ggml_context 
+0007ffb0: 2a20 6374 782c 2073 7472 7563 7420 6767  * ctx, struct gg
+0007ffc0: 6d6c 5f63 6772 6170 6820 2a20 6766 2c20  ml_cgraph * gf, 
+0007ffd0: 626f 6f6c 206b 6565 7029 207b 0a20 2020  bool keep) {.   
+0007ffe0: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+0007fff0: 6170 6820 7265 7375 6c74 203d 202a 6766  aph result = *gf
+00080000: 3b0a 0a20 2020 2047 474d 4c5f 4153 5345  ;..    GGML_ASSE
+00080010: 5254 2867 662d 3e6e 5f6e 6f64 6573 203e  RT(gf->n_nodes >
+00080020: 2030 293b 0a0a 2020 2020 2f2f 2069 6620   0);..    // if 
+00080030: 7765 2061 7265 206b 6565 7069 6e67 2074  we are keeping t
+00080040: 6865 2067 7261 6469 656e 7420 6772 6170  he gradient grap
+00080050: 682c 2077 6520 6861 7665 2074 6f20 6465  h, we have to de
+00080060: 7461 6368 2074 6865 2067 7261 6469 656e  tach the gradien
+00080070: 7420 6e6f 6465 7320 6672 6f6d 2074 6865  t nodes from the
+00080080: 206f 7269 6769 6e61 6c20 6772 6170 680a   original graph.
+00080090: 2020 2020 6966 2028 6b65 6570 2920 7b0a      if (keep) {.
+000800a0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+000800b0: 2069 203d 2030 3b20 6920 3c20 6766 2d3e   i = 0; i < gf->
+000800c0: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
+000800d0: 2020 2020 2020 2020 2020 2020 7374 7275              stru
+000800e0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+000800f0: 206e 6f64 6520 3d20 6766 2d3e 6e6f 6465   node = gf->node
+00080100: 735b 695d 3b0a 0a20 2020 2020 2020 2020  s[i];..         
+00080110: 2020 2069 6620 286e 6f64 652d 3e67 7261     if (node->gra
+00080120: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
+00080130: 2020 2020 206e 6f64 652d 3e67 7261 6420       node->grad 
+00080140: 3d20 6767 6d6c 5f64 7570 5f74 656e 736f  = ggml_dup_tenso
+00080150: 7228 6374 782c 206e 6f64 6529 3b0a 2020  r(ctx, node);.  
+00080160: 2020 2020 2020 2020 2020 2020 2020 6766                gf
+00080170: 2d3e 6772 6164 735b 695d 203d 206e 6f64  ->grads[i] = nod
+00080180: 652d 3e67 7261 643b 0a20 2020 2020 2020  e->grad;.       
+00080190: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+000801a0: 0a20 2020 207d 0a0a 2020 2020 666f 7220  .    }..    for 
+000801b0: 2869 6e74 2069 203d 2067 662d 3e6e 5f6e  (int i = gf->n_n
+000801c0: 6f64 6573 202d 2031 3b20 6920 3e3d 2030  odes - 1; i >= 0
+000801d0: 3b20 692d 2d29 207b 0a20 2020 2020 2020  ; i--) {.       
+000801e0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000801f0: 736f 7220 2a20 6e6f 6465 203d 2067 662d  sor * node = gf-
+00080200: 3e6e 6f64 6573 5b69 5d3b 0a0a 2020 2020  >nodes[i];..    
+00080210: 2020 2020 2f2f 2062 6563 6175 7365 2077      // because w
+00080220: 6520 6465 7461 6368 6564 2074 6865 2067  e detached the g
+00080230: 7261 6420 6e6f 6465 7320 6672 6f6d 2074  rad nodes from t
+00080240: 6865 206f 7269 6769 6e61 6c20 6772 6170  he original grap
+00080250: 682c 2077 6520 6361 6e20 6166 666f 7264  h, we can afford
+00080260: 2069 6e70 6c61 6365 206f 7065 7261 7469   inplace operati
+00080270: 6f6e 730a 2020 2020 2020 2020 6966 2028  ons.        if (
+00080280: 6e6f 6465 2d3e 6772 6164 2920 7b0a 2020  node->grad) {.  
+00080290: 2020 2020 2020 2020 2020 6767 6d6c 5f63            ggml_c
+000802a0: 6f6d 7075 7465 5f62 6163 6b77 6172 6428  ompute_backward(
+000802b0: 6374 782c 206e 6f64 652c 206b 6565 7029  ctx, node, keep)
+000802c0: 3b0a 2020 2020 2020 2020 7d0a 2020 2020  ;.        }.    
+000802d0: 7d0a 0a20 2020 2066 6f72 2028 696e 7420  }..    for (int 
+000802e0: 6920 3d20 6766 2d3e 6e5f 6e6f 6465 7320  i = gf->n_nodes 
+000802f0: 2d20 313b 2069 203e 3d20 303b 2069 2d2d  - 1; i >= 0; i--
+00080300: 2920 7b0a 2020 2020 2020 2020 7374 7275  ) {.        stru
+00080310: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+00080320: 206e 6f64 6520 3d20 6766 2d3e 6e6f 6465   node = gf->node
+00080330: 735b 695d 3b0a 0a20 2020 2020 2020 2069  s[i];..        i
+00080340: 6620 286e 6f64 652d 3e69 735f 7061 7261  f (node->is_para
+00080350: 6d29 207b 0a20 2020 2020 2020 2020 2020  m) {.           
+00080360: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+00080370: 4728 2225 733a 2066 6f75 6e64 2072 6f6f  G("%s: found roo
+00080380: 7420 6e6f 6465 2025 705c 6e22 2c20 5f5f  t node %p\n", __
+00080390: 6675 6e63 5f5f 2c20 2876 6f69 6420 2a29  func__, (void *)
+000803a0: 206e 6f64 6529 3b0a 2020 2020 2020 2020   node);.        
+000803b0: 2020 2020 6767 6d6c 5f62 7569 6c64 5f66      ggml_build_f
+000803c0: 6f72 7761 7264 5f69 6d70 6c28 2672 6573  orward_impl(&res
+000803d0: 756c 742c 206e 6f64 652d 3e67 7261 642c  ult, node->grad,
+000803e0: 2074 7275 6529 3b0a 2020 2020 2020 2020   true);.        
+000803f0: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
+00080400: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+00080410: 2f0a 2f2f 2074 6872 6561 6420 6461 7461  /.// thread data
+00080420: 0a2f 2f0a 2f2f 2073 796e 6368 726f 6e69  .//.// synchroni
+00080430: 7a61 7469 6f6e 2069 7320 646f 6e65 2076  zation is done v
+00080440: 6961 2062 7573 7920 6c6f 6f70 730a 2f2f  ia busy loops.//
+00080450: 2049 2074 7269 6564 2075 7369 6e67 2073   I tried using s
+00080460: 7069 6e20 6c6f 636b 732c 2062 7574 206e  pin locks, but n
+00080470: 6f74 2073 7572 6520 686f 7720 746f 2075  ot sure how to u
+00080480: 7365 2074 6865 6d20 636f 7272 6563 746c  se them correctl
+00080490: 7920 2d20 7468 6520 7468 696e 6773 2049  y - the things I
+000804a0: 2074 7269 6564 2077 6572 6520 736c 6f77   tried were slow
+000804b0: 6572 2074 6861 6e20 6275 7379 206c 6f6f  er than busy loo
+000804c0: 7073 0a2f 2f0a 0a23 6966 6465 6620 5f5f  ps.//..#ifdef __
+000804d0: 4150 504c 455f 5f0a 0a2f 2f23 696e 636c  APPLE__..//#incl
+000804e0: 7564 6520 3c6f 732f 6c6f 636b 2e68 3e0a  ude <os/lock.h>.
+000804f0: 2f2f 0a2f 2f74 7970 6564 6566 206f 735f  //.//typedef os_
+00080500: 756e 6661 6972 5f6c 6f63 6b20 6767 6d6c  unfair_lock ggml
+00080510: 5f6c 6f63 6b5f 743b 0a2f 2f0a 2f2f 2364  _lock_t;.//.//#d
+00080520: 6566 696e 6520 6767 6d6c 5f6c 6f63 6b5f  efine ggml_lock_
+00080530: 696e 6974 2878 2920 2020 2055 4e55 5345  init(x)    UNUSE
+00080540: 4428 7829 0a2f 2f23 6465 6669 6e65 2067  D(x).//#define g
+00080550: 676d 6c5f 6c6f 636b 5f64 6573 7472 6f79  gml_lock_destroy
+00080560: 2878 2920 554e 5553 4544 2878 290a 2f2f  (x) UNUSED(x).//
+00080570: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+00080580: 6b5f 6c6f 636b 2020 2020 2020 206f 735f  k_lock       os_
+00080590: 756e 6661 6972 5f6c 6f63 6b5f 6c6f 636b  unfair_lock_lock
+000805a0: 0a2f 2f23 6465 6669 6e65 2067 676d 6c5f  .//#define ggml_
+000805b0: 6c6f 636b 5f75 6e6c 6f63 6b20 2020 2020  lock_unlock     
+000805c0: 6f73 5f75 6e66 6169 725f 6c6f 636b 5f75  os_unfair_lock_u
+000805d0: 6e6c 6f63 6b0a 2f2f 0a2f 2f23 6465 6669  nlock.//.//#defi
+000805e0: 6e65 2047 474d 4c5f 4c4f 434b 5f49 4e49  ne GGML_LOCK_INI
+000805f0: 5449 414c 495a 4552 204f 535f 554e 4641  TIALIZER OS_UNFA
+00080600: 4952 5f4c 4f43 4b5f 494e 4954 0a0a 7479  IR_LOCK_INIT..ty
+00080610: 7065 6465 6620 696e 7420 6767 6d6c 5f6c  pedef int ggml_l
+00080620: 6f63 6b5f 743b 0a0a 2364 6566 696e 6520  ock_t;..#define 
+00080630: 6767 6d6c 5f6c 6f63 6b5f 696e 6974 2878  ggml_lock_init(x
+00080640: 2920 2020 2055 4e55 5345 4428 7829 0a23  )    UNUSED(x).#
+00080650: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
+00080660: 5f64 6573 7472 6f79 2878 2920 554e 5553  _destroy(x) UNUS
+00080670: 4544 2878 290a 2364 6566 696e 6520 6767  ED(x).#define gg
+00080680: 6d6c 5f6c 6f63 6b5f 6c6f 636b 2878 2920  ml_lock_lock(x) 
+00080690: 2020 2055 4e55 5345 4428 7829 0a23 6465     UNUSED(x).#de
+000806a0: 6669 6e65 2067 676d 6c5f 6c6f 636b 5f75  fine ggml_lock_u
+000806b0: 6e6c 6f63 6b28 7829 2020 554e 5553 4544  nlock(x)  UNUSED
+000806c0: 2878 290a 0a23 6465 6669 6e65 2047 474d  (x)..#define GGM
+000806d0: 4c5f 4c4f 434b 5f49 4e49 5449 414c 495a  L_LOCK_INITIALIZ
+000806e0: 4552 2030 0a0a 7479 7065 6465 6620 7074  ER 0..typedef pt
+000806f0: 6872 6561 645f 7420 6767 6d6c 5f74 6872  hread_t ggml_thr
+00080700: 6561 645f 743b 0a0a 2364 6566 696e 6520  ead_t;..#define 
+00080710: 6767 6d6c 5f74 6872 6561 645f 6372 6561  ggml_thread_crea
+00080720: 7465 2070 7468 7265 6164 5f63 7265 6174  te pthread_creat
+00080730: 650a 2364 6566 696e 6520 6767 6d6c 5f74  e.#define ggml_t
+00080740: 6872 6561 645f 6a6f 696e 2020 2070 7468  hread_join   pth
+00080750: 7265 6164 5f6a 6f69 6e0a 0a23 656c 7365  read_join..#else
+00080760: 0a0a 2f2f 7479 7065 6465 6620 7074 6872  ..//typedef pthr
+00080770: 6561 645f 7370 696e 6c6f 636b 5f74 2067  ead_spinlock_t g
+00080780: 676d 6c5f 6c6f 636b 5f74 3b0a 0a2f 2f23  gml_lock_t;..//#
+00080790: 6465 6669 6e65 2067 676d 6c5f 6c6f 636b  define ggml_lock
+000807a0: 5f69 6e69 7428 7829 2070 7468 7265 6164  _init(x) pthread
+000807b0: 5f73 7069 6e5f 696e 6974 2878 2c20 5054  _spin_init(x, PT
+000807c0: 4852 4541 445f 5052 4f43 4553 535f 5052  HREAD_PROCESS_PR
+000807d0: 4956 4154 4529 0a2f 2f23 6465 6669 6e65  IVATE).//#define
+000807e0: 2067 676d 6c5f 6c6f 636b 5f64 6573 7472   ggml_lock_destr
+000807f0: 6f79 2070 7468 7265 6164 5f73 7069 6e5f  oy pthread_spin_
+00080800: 6465 7374 726f 790a 2f2f 2364 6566 696e  destroy.//#defin
+00080810: 6520 6767 6d6c 5f6c 6f63 6b5f 6c6f 636b  e ggml_lock_lock
+00080820: 2020 2020 7074 6872 6561 645f 7370 696e      pthread_spin
+00080830: 5f6c 6f63 6b0a 2f2f 2364 6566 696e 6520  _lock.//#define 
+00080840: 6767 6d6c 5f6c 6f63 6b5f 756e 6c6f 636b  ggml_lock_unlock
+00080850: 2020 7074 6872 6561 645f 7370 696e 5f75    pthread_spin_u
+00080860: 6e6c 6f63 6b0a 0a74 7970 6564 6566 2069  nlock..typedef i
+00080870: 6e74 2067 676d 6c5f 6c6f 636b 5f74 3b0a  nt ggml_lock_t;.
+00080880: 0a23 6465 6669 6e65 2067 676d 6c5f 6c6f  .#define ggml_lo
+00080890: 636b 5f69 6e69 7428 7829 2020 2020 554e  ck_init(x)    UN
+000808a0: 5553 4544 2878 290a 2364 6566 696e 6520  USED(x).#define 
+000808b0: 6767 6d6c 5f6c 6f63 6b5f 6465 7374 726f  ggml_lock_destro
+000808c0: 7928 7829 2055 4e55 5345 4428 7829 0a23  y(x) UNUSED(x).#
+000808d0: 6966 2064 6566 696e 6564 285f 5f78 3836  if defined(__x86
+000808e0: 5f36 345f 5f29 207c 7c20 2864 6566 696e  _64__) || (defin
+000808f0: 6564 285f 4d53 435f 5645 5229 2026 2620  ed(_MSC_VER) && 
+00080900: 6465 6669 6e65 6428 5f4d 5f41 4d44 3634  defined(_M_AMD64
+00080910: 2929 0a23 6465 6669 6e65 2067 676d 6c5f  )).#define ggml_
+00080920: 6c6f 636b 5f6c 6f63 6b28 7829 2020 2020  lock_lock(x)    
+00080930: 5f6d 6d5f 7061 7573 6528 290a 2365 6c73  _mm_pause().#els
+00080940: 650a 2364 6566 696e 6520 6767 6d6c 5f6c  e.#define ggml_l
+00080950: 6f63 6b5f 6c6f 636b 2878 2920 2020 2055  ock_lock(x)    U
+00080960: 4e55 5345 4428 7829 0a23 656e 6469 660a  NUSED(x).#endif.
+00080970: 2364 6566 696e 6520 6767 6d6c 5f6c 6f63  #define ggml_loc
+00080980: 6b5f 756e 6c6f 636b 2878 2920 2055 4e55  k_unlock(x)  UNU
+00080990: 5345 4428 7829 0a0a 2364 6566 696e 6520  SED(x)..#define 
+000809a0: 4747 4d4c 5f4c 4f43 4b5f 494e 4954 4941  GGML_LOCK_INITIA
+000809b0: 4c49 5a45 5220 300a 0a74 7970 6564 6566  LIZER 0..typedef
+000809c0: 2070 7468 7265 6164 5f74 2067 676d 6c5f   pthread_t ggml_
+000809d0: 7468 7265 6164 5f74 3b0a 0a23 6465 6669  thread_t;..#defi
+000809e0: 6e65 2067 676d 6c5f 7468 7265 6164 5f63  ne ggml_thread_c
+000809f0: 7265 6174 6520 7074 6872 6561 645f 6372  reate pthread_cr
+00080a00: 6561 7465 0a23 6465 6669 6e65 2067 676d  eate.#define ggm
+00080a10: 6c5f 7468 7265 6164 5f6a 6f69 6e20 2020  l_thread_join   
+00080a20: 7074 6872 6561 645f 6a6f 696e 0a0a 2365  pthread_join..#e
+00080a30: 6e64 6966 0a0a 2f2f 2041 6e64 726f 6964  ndif..// Android
+00080a40: 2773 206c 6962 6320 696d 706c 656d 656e  's libc implemen
+00080a50: 7461 7469 6f6e 2022 6269 6f6e 6963 2220  tation "bionic" 
+00080a60: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00080a70: 2073 6574 7469 6e67 2061 6666 696e 6974   setting affinit
+00080a80: 790a 2369 6620 6465 6669 6e65 6428 5f5f  y.#if defined(__
+00080a90: 6c69 6e75 785f 5f29 2026 2620 2164 6566  linux__) && !def
+00080aa0: 696e 6564 285f 5f42 494f 4e49 435f 5f29  ined(__BIONIC__)
+00080ab0: 0a76 6f69 6420 7365 745f 6e75 6d61 5f74  .void set_numa_t
+00080ac0: 6872 6561 645f 6166 6669 6e69 7479 2869  hread_affinity(i
+00080ad0: 6e74 2074 6872 6561 645f 6e2c 2069 6e74  nt thread_n, int
+00080ae0: 206e 5f74 6872 6561 6473 2920 7b0a 2020   n_threads) {.  
+00080af0: 2020 6966 2028 2167 676d 6c5f 6973 5f6e    if (!ggml_is_n
+00080b00: 756d 6128 2929 207b 0a20 2020 2020 2020  uma()) {.       
+00080b10: 2072 6574 7572 6e3b 0a20 2020 207d 0a0a   return;.    }..
+00080b20: 2020 2020 2f2f 2072 756e 2074 6872 6561      // run threa
+00080b30: 6420 6f6e 206e 6f64 655f 6e75 6d20 7468  d on node_num th
+00080b40: 7265 6164 5f6e 202f 2028 7468 7265 6164  read_n / (thread
+00080b50: 7320 7065 7220 6e6f 6465 290a 2020 2020  s per node).    
+00080b60: 636f 6e73 7420 696e 7420 6e6f 6465 5f6e  const int node_n
+00080b70: 756d 203d 2074 6872 6561 645f 6e20 2f20  um = thread_n / 
+00080b80: 2828 6e5f 7468 7265 6164 7320 2b20 675f  ((n_threads + g_
+00080b90: 7374 6174 652e 6e75 6d61 2e6e 5f6e 6f64  state.numa.n_nod
+00080ba0: 6573 202d 2031 2920 2f20 675f 7374 6174  es - 1) / g_stat
+00080bb0: 652e 6e75 6d61 2e6e 5f6e 6f64 6573 293b  e.numa.n_nodes);
+00080bc0: 0a20 2020 2073 7472 7563 7420 6767 6d6c  .    struct ggml
+00080bd0: 5f6e 756d 615f 6e6f 6465 202a 206e 6f64  _numa_node * nod
+00080be0: 6520 3d20 2667 5f73 7461 7465 2e6e 756d  e = &g_state.num
+00080bf0: 612e 6e6f 6465 735b 6e6f 6465 5f6e 756d  a.nodes[node_num
+00080c00: 5d3b 0a20 2020 2073 697a 655f 7420 7365  ];.    size_t se
+00080c10: 7473 697a 6520 3d20 4350 555f 414c 4c4f  tsize = CPU_ALLO
+00080c20: 435f 5349 5a45 2867 5f73 7461 7465 2e6e  C_SIZE(g_state.n
+00080c30: 756d 612e 746f 7461 6c5f 6370 7573 293b  uma.total_cpus);
+00080c40: 0a0a 2020 2020 6370 755f 7365 745f 7420  ..    cpu_set_t 
+00080c50: 2a20 6370 7573 203d 2043 5055 5f41 4c4c  * cpus = CPU_ALL
+00080c60: 4f43 2867 5f73 7461 7465 2e6e 756d 612e  OC(g_state.numa.
+00080c70: 746f 7461 6c5f 6370 7573 293b 0a20 2020  total_cpus);.   
+00080c80: 2043 5055 5f5a 4552 4f5f 5328 7365 7473   CPU_ZERO_S(sets
+00080c90: 697a 652c 2063 7075 7329 3b0a 2020 2020  ize, cpus);.    
+00080ca0: 666f 7220 2873 697a 655f 7420 6920 3d20  for (size_t i = 
+00080cb0: 303b 2069 203c 206e 6f64 652d 3e6e 5f63  0; i < node->n_c
+00080cc0: 7075 733b 202b 2b69 2920 7b0a 2020 2020  pus; ++i) {.    
+00080cd0: 2020 2020 4350 555f 5345 545f 5328 6e6f      CPU_SET_S(no
+00080ce0: 6465 2d3e 6370 7573 5b69 5d2c 2073 6574  de->cpus[i], set
+00080cf0: 7369 7a65 2c20 6370 7573 293b 0a20 2020  size, cpus);.   
+00080d00: 207d 0a0a 2020 2020 696e 7420 7276 203d   }..    int rv =
+00080d10: 2070 7468 7265 6164 5f73 6574 6166 6669   pthread_setaffi
+00080d20: 6e69 7479 5f6e 7028 7074 6872 6561 645f  nity_np(pthread_
+00080d30: 7365 6c66 2829 2c20 7365 7473 697a 652c  self(), setsize,
+00080d40: 2063 7075 7329 3b0a 2020 2020 6966 2028   cpus);.    if (
+00080d50: 7276 2920 7b0a 2020 2020 2020 2020 2020  rv) {.          
+00080d60: 2020 6670 7269 6e74 6628 7374 6465 7272    fprintf(stderr
+00080d70: 2c20 2277 6172 6e69 6e67 3a20 7074 6872  , "warning: pthr
+00080d80: 6561 645f 7365 7461 6666 696e 6974 795f  ead_setaffinity_
+00080d90: 6e70 2829 2066 6169 6c65 643a 2025 735c  np() failed: %s\
+00080da0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
+00080db0: 2020 2020 2020 2020 7374 7265 7272 6f72          strerror
+00080dc0: 2872 7629 293b 0a20 2020 207d 0a0a 2020  (rv));.    }..  
+00080dd0: 2020 4350 555f 4652 4545 2863 7075 7329    CPU_FREE(cpus)
+00080de0: 3b0a 7d0a 0a76 6f69 6420 636c 6561 725f  ;.}..void clear_
+00080df0: 6e75 6d61 5f74 6872 6561 645f 6166 6669  numa_thread_affi
+00080e00: 6e69 7479 2876 6f69 6429 207b 0a20 2020  nity(void) {.   
+00080e10: 2069 6620 2821 6767 6d6c 5f69 735f 6e75   if (!ggml_is_nu
+00080e20: 6d61 2829 2920 7b0a 2020 2020 2020 2020  ma()) {.        
+00080e30: 7265 7475 726e 3b0a 2020 2020 7d0a 0a20  return;.    }.. 
+00080e40: 2020 2073 697a 655f 7420 7365 7473 697a     size_t setsiz
+00080e50: 6520 3d20 4350 555f 414c 4c4f 435f 5349  e = CPU_ALLOC_SI
+00080e60: 5a45 2867 5f73 7461 7465 2e6e 756d 612e  ZE(g_state.numa.
+00080e70: 746f 7461 6c5f 6370 7573 293b 0a0a 2020  total_cpus);..  
+00080e80: 2020 6370 755f 7365 745f 7420 2a20 6370    cpu_set_t * cp
+00080e90: 7573 203d 2043 5055 5f41 4c4c 4f43 2867  us = CPU_ALLOC(g
+00080ea0: 5f73 7461 7465 2e6e 756d 612e 746f 7461  _state.numa.tota
+00080eb0: 6c5f 6370 7573 293b 0a20 2020 2043 5055  l_cpus);.    CPU
+00080ec0: 5f5a 4552 4f5f 5328 7365 7473 697a 652c  _ZERO_S(setsize,
+00080ed0: 2063 7075 7329 3b0a 2020 2020 666f 7220   cpus);.    for 
+00080ee0: 2875 6e73 6967 6e65 6420 6920 3d20 303b  (unsigned i = 0;
+00080ef0: 2069 203c 2067 5f73 7461 7465 2e6e 756d   i < g_state.num
+00080f00: 612e 746f 7461 6c5f 6370 7573 3b20 2b2b  a.total_cpus; ++
+00080f10: 6929 207b 0a20 2020 2020 2020 2043 5055  i) {.        CPU
+00080f20: 5f53 4554 5f53 2869 2c20 7365 7473 697a  _SET_S(i, setsiz
+00080f30: 652c 2063 7075 7329 3b0a 2020 2020 7d0a  e, cpus);.    }.
+00080f40: 0a20 2020 2069 6e74 2072 7620 3d20 7074  .    int rv = pt
+00080f50: 6872 6561 645f 7365 7461 6666 696e 6974  hread_setaffinit
+00080f60: 795f 6e70 2870 7468 7265 6164 5f73 656c  y_np(pthread_sel
+00080f70: 6628 292c 2073 6574 7369 7a65 2c20 6370  f(), setsize, cp
+00080f80: 7573 293b 0a20 2020 2069 6620 2872 7629  us);.    if (rv)
+00080f90: 207b 0a20 2020 2020 2020 2066 7072 696e   {.        fprin
+00080fa0: 7466 2873 7464 6572 722c 2022 7761 726e  tf(stderr, "warn
+00080fb0: 696e 673a 2070 7468 7265 6164 5f73 6574  ing: pthread_set
+00080fc0: 6166 6669 6e69 7479 5f6e 7028 2920 6661  affinity_np() fa
+00080fd0: 696c 6564 3a20 2573 5c6e 222c 0a20 2020  iled: %s\n",.   
+00080fe0: 2020 2020 2020 2020 2073 7472 6572 726f           strerro
+00080ff0: 7228 7276 2929 3b0a 2020 2020 7d0a 0a20  r(rv));.    }.. 
+00081000: 2020 2043 5055 5f46 5245 4528 6370 7573     CPU_FREE(cpus
+00081010: 293b 0a7d 0a23 656c 7365 0a2f 2f20 544f  );.}.#else.// TO
+00081020: 444f 3a20 5769 6e64 6f77 7320 6574 632e  DO: Windows etc.
+00081030: 0a2f 2f20 2874 6865 206c 696e 7578 2069  .// (the linux i
+00081040: 6d70 6c65 6d65 6e74 6174 696f 6e20 6d61  mplementation ma
+00081050: 7920 616c 736f 2077 6f72 6b20 6f6e 2042  y also work on B
+00081060: 5344 2c20 736f 6d65 6f6e 6520 7368 6f75  SD, someone shou
+00081070: 6c64 2074 6573 7429 0a76 6f69 6420 7365  ld test).void se
+00081080: 745f 6e75 6d61 5f74 6872 6561 645f 6166  t_numa_thread_af
+00081090: 6669 6e69 7479 2869 6e74 2074 6872 6561  finity(int threa
+000810a0: 645f 6e2c 2069 6e74 206e 5f74 6872 6561  d_n, int n_threa
+000810b0: 6473 2920 7b20 554e 5553 4544 2874 6872  ds) { UNUSED(thr
+000810c0: 6561 645f 6e29 3b20 554e 5553 4544 286e  ead_n); UNUSED(n
+000810d0: 5f74 6872 6561 6473 293b 2020 7d0a 766f  _threads);  }.vo
+000810e0: 6964 2063 6c65 6172 5f6e 756d 615f 7468  id clear_numa_th
+000810f0: 7265 6164 5f61 6666 696e 6974 7928 766f  read_affinity(vo
+00081100: 6964 2920 7b7d 0a23 656e 6469 660a 0a73  id) {}.#endif..s
+00081110: 7472 7563 7420 6767 6d6c 5f63 6f6d 7075  truct ggml_compu
+00081120: 7465 5f73 7461 7465 5f73 6861 7265 6420  te_state_shared 
+00081130: 7b0a 2020 2020 636f 6e73 7420 7374 7275  {.    const stru
+00081140: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
+00081150: 2063 6772 6170 683b 0a20 2020 2063 6f6e   cgraph;.    con
+00081160: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+00081170: 706c 616e 2020 2a20 6370 6c61 6e3b 0a0a  plan  * cplan;..
+00081180: 2020 2020 696e 7436 345f 7420 7065 7266      int64_t perf
+00081190: 5f6e 6f64 655f 7374 6172 745f 6379 636c  _node_start_cycl
+000811a0: 6573 3b0a 2020 2020 696e 7436 345f 7420  es;.    int64_t 
+000811b0: 7065 7266 5f6e 6f64 655f 7374 6172 745f  perf_node_start_
+000811c0: 7469 6d65 5f75 733b 0a0a 2020 2020 636f  time_us;..    co
+000811d0: 6e73 7420 696e 7420 6e5f 7468 7265 6164  nst int n_thread
+000811e0: 733b 0a0a 2020 2020 2f2f 2073 796e 6368  s;..    // synch
+000811f0: 726f 6e69 7a61 7469 6f6e 2070 7269 6d69  ronization primi
+00081200: 7469 7665 730a 2020 2020 6174 6f6d 6963  tives.    atomic
+00081210: 5f69 6e74 206e 5f61 6374 6976 653b 202f  _int n_active; /
+00081220: 2f20 6e75 6d20 6163 7469 7665 2074 6872  / num active thr
+00081230: 6561 6473 0a20 2020 2061 746f 6d69 635f  eads.    atomic_
+00081240: 696e 7420 6e6f 6465 5f6e 3b20 2020 2f2f  int node_n;   //
+00081250: 2061 6374 6976 6520 6772 6170 6820 6e6f   active graph no
+00081260: 6465 0a0a 2020 2020 626f 6f6c 2028 2a61  de..    bool (*a
+00081270: 626f 7274 5f63 616c 6c62 6163 6b29 2876  bort_callback)(v
+00081280: 6f69 6420 2a20 6461 7461 293b 202f 2f20  oid * data); // 
+00081290: 6162 6f72 7420 6767 6d6c 5f67 7261 7068  abort ggml_graph
+000812a0: 5f63 6f6d 7075 7465 2077 6865 6e20 7472  _compute when tr
+000812b0: 7565 0a20 2020 2076 6f69 6420 2a20 6162  ue.    void * ab
+000812c0: 6f72 745f 6361 6c6c 6261 636b 5f64 6174  ort_callback_dat
+000812d0: 613b 0a7d 3b0a 0a73 7472 7563 7420 6767  a;.};..struct gg
+000812e0: 6d6c 5f63 6f6d 7075 7465 5f73 7461 7465  ml_compute_state
+000812f0: 207b 0a20 2020 2067 676d 6c5f 7468 7265   {.    ggml_thre
+00081300: 6164 5f74 2074 6872 643b 0a20 2020 2069  ad_t thrd;.    i
+00081310: 6e74 2069 7468 3b0a 2020 2020 7374 7275  nt ith;.    stru
+00081320: 6374 2067 676d 6c5f 636f 6d70 7574 655f  ct ggml_compute_
+00081330: 7374 6174 655f 7368 6172 6564 202a 2073  state_shared * s
+00081340: 6861 7265 643b 0a7d 3b0a 0a73 7461 7469  hared;.};..stati
+00081350: 6320 766f 6964 2067 676d 6c5f 6772 6170  c void ggml_grap
+00081360: 685f 636f 6d70 7574 655f 7065 7266 5f73  h_compute_perf_s
+00081370: 7461 7473 5f6e 6f64 6528 7374 7275 6374  tats_node(struct
+00081380: 2067 676d 6c5f 7465 6e73 6f72 202a 206e   ggml_tensor * n
+00081390: 6f64 652c 2063 6f6e 7374 2073 7472 7563  ode, const struc
+000813a0: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f73  t ggml_compute_s
+000813b0: 7461 7465 5f73 6861 7265 6420 2a20 7374  tate_shared * st
+000813c0: 2920 7b0a 2020 2020 696e 7436 345f 7420  ) {.    int64_t 
+000813d0: 6379 636c 6573 5f63 7572 2020 3d20 6767  cycles_cur  = gg
+000813e0: 6d6c 5f70 6572 665f 6379 636c 6573 2829  ml_perf_cycles()
+000813f0: 2020 2d20 7374 2d3e 7065 7266 5f6e 6f64    - st->perf_nod
+00081400: 655f 7374 6172 745f 6379 636c 6573 3b0a  e_start_cycles;.
+00081410: 2020 2020 696e 7436 345f 7420 7469 6d65      int64_t time
+00081420: 5f75 735f 6375 7220 3d20 6767 6d6c 5f70  _us_cur = ggml_p
+00081430: 6572 665f 7469 6d65 5f75 7328 2920 2d20  erf_time_us() - 
+00081440: 7374 2d3e 7065 7266 5f6e 6f64 655f 7374  st->perf_node_st
+00081450: 6172 745f 7469 6d65 5f75 733b 0a0a 2020  art_time_us;..  
+00081460: 2020 6e6f 6465 2d3e 7065 7266 5f72 756e    node->perf_run
+00081470: 732b 2b3b 0a20 2020 206e 6f64 652d 3e70  s++;.    node->p
+00081480: 6572 665f 6379 636c 6573 2020 2b3d 2063  erf_cycles  += c
+00081490: 7963 6c65 735f 6375 723b 0a20 2020 206e  ycles_cur;.    n
+000814a0: 6f64 652d 3e70 6572 665f 7469 6d65 5f75  ode->perf_time_u
+000814b0: 7320 2b3d 2074 696d 655f 7573 5f63 7572  s += time_us_cur
+000814c0: 3b0a 7d0a 0a73 7461 7469 6320 7468 7265  ;.}..static thre
+000814d0: 6164 5f72 6574 5f74 2067 676d 6c5f 6772  ad_ret_t ggml_gr
+000814e0: 6170 685f 636f 6d70 7574 655f 7468 7265  aph_compute_thre
+000814f0: 6164 2876 6f69 6420 2a20 6461 7461 2920  ad(void * data) 
+00081500: 7b0a 2020 2020 7374 7275 6374 2067 676d  {.    struct ggm
+00081510: 6c5f 636f 6d70 7574 655f 7374 6174 6520  l_compute_state 
+00081520: 2a20 7374 6174 6520 3d20 2873 7472 7563  * state = (struc
+00081530: 7420 6767 6d6c 5f63 6f6d 7075 7465 5f73  t ggml_compute_s
+00081540: 7461 7465 202a 2920 6461 7461 3b0a 0a20  tate *) data;.. 
+00081550: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
+00081560: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
+00081570: 7261 7068 203d 2073 7461 7465 2d3e 7368  raph = state->sh
+00081580: 6172 6564 2d3e 6367 7261 7068 3b0a 2020  ared->cgraph;.  
+00081590: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+000815a0: 676d 6c5f 6370 6c61 6e20 202a 2063 706c  gml_cplan  * cpl
+000815b0: 616e 2020 3d20 7374 6174 652d 3e73 6861  an  = state->sha
+000815c0: 7265 642d 3e63 706c 616e 3b0a 0a20 2020  red->cplan;..   
+000815d0: 2063 6f6e 7374 2069 6e74 202a 206e 5f74   const int * n_t
+000815e0: 6173 6b73 5f61 7272 203d 2063 706c 616e  asks_arr = cplan
+000815f0: 2d3e 6e5f 7461 736b 733b 0a20 2020 2063  ->n_tasks;.    c
+00081600: 6f6e 7374 2069 6e74 2020 206e 5f74 6872  onst int   n_thr
+00081610: 6561 6473 2020 203d 2073 7461 7465 2d3e  eads   = state->
+00081620: 7368 6172 6564 2d3e 6e5f 7468 7265 6164  shared->n_thread
+00081630: 733b 0a0a 2020 2020 7365 745f 6e75 6d61  s;..    set_numa
+00081640: 5f74 6872 6561 645f 6166 6669 6e69 7479  _thread_affinity
+00081650: 2873 7461 7465 2d3e 6974 682c 206e 5f74  (state->ith, n_t
+00081660: 6872 6561 6473 293b 0a0a 2020 2020 696e  hreads);..    in
+00081670: 7420 6e6f 6465 5f6e 203d 202d 313b 0a0a  t node_n = -1;..
+00081680: 2020 2020 7768 696c 6520 2874 7275 6529      while (true)
+00081690: 207b 0a20 2020 2020 2020 2069 6620 2863   {.        if (c
+000816a0: 706c 616e 2d3e 6162 6f72 745f 6361 6c6c  plan->abort_call
+000816b0: 6261 636b 2026 2620 6370 6c61 6e2d 3e61  back && cplan->a
+000816c0: 626f 7274 5f63 616c 6c62 6163 6b28 6370  bort_callback(cp
+000816d0: 6c61 6e2d 3e61 626f 7274 5f63 616c 6c62  lan->abort_callb
+000816e0: 6163 6b5f 6461 7461 2929 207b 0a20 2020  ack_data)) {.   
+000816f0: 2020 2020 2020 2020 2073 7461 7465 2d3e           state->
+00081700: 7368 6172 6564 2d3e 6e6f 6465 5f6e 202b  shared->node_n +
+00081710: 3d20 313b 0a20 2020 2020 2020 2020 2020  = 1;.           
+00081720: 2072 6574 7572 6e20 2874 6872 6561 645f   return (thread_
+00081730: 7265 745f 7429 2047 474d 4c5f 4558 4954  ret_t) GGML_EXIT
+00081740: 5f41 424f 5254 4544 3b0a 2020 2020 2020  _ABORTED;.      
+00081750: 2020 7d0a 2020 2020 2020 2020 6966 2028    }.        if (
+00081760: 6174 6f6d 6963 5f66 6574 6368 5f73 7562  atomic_fetch_sub
+00081770: 2826 7374 6174 652d 3e73 6861 7265 642d  (&state->shared-
+00081780: 3e6e 5f61 6374 6976 652c 2031 2920 3d3d  >n_active, 1) ==
+00081790: 2031 2920 7b0a 2020 2020 2020 2020 2020   1) {.          
+000817a0: 2020 2f2f 2061 6c6c 206f 7468 6572 2074    // all other t
+000817b0: 6872 6561 6473 2061 7265 2066 696e 6973  hreads are finis
+000817c0: 6865 6420 616e 6420 7370 696e 6e69 6e67  hed and spinning
+000817d0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+000817e0: 646f 2066 696e 616c 697a 6520 616e 6420  do finalize and 
+000817f0: 696e 6974 2068 6572 6520 736f 2077 6520  init here so we 
+00081800: 646f 6e27 7420 6861 7665 2073 796e 6368  don't have synch
+00081810: 726f 6e69 7a65 2061 6761 696e 0a20 2020  ronize again.   
+00081820: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+00081830: 6767 6d6c 5f63 6f6d 7075 7465 5f70 6172  ggml_compute_par
+00081840: 616d 7320 7061 7261 6d73 203d 207b 0a20  ams params = {. 
+00081850: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00081860: 2a2e 7479 7065 2020 3d2a 2f20 4747 4d4c  *.type  =*/ GGML
+00081870: 5f54 4153 4b5f 4649 4e41 4c49 5a45 2c0a  _TASK_FINALIZE,.
+00081880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081890: 2f2a 2e69 7468 2020 203d 2a2f 2030 2c0a  /*.ith   =*/ 0,.
+000818a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000818b0: 2f2a 2e6e 7468 2020 203d 2a2f 2030 2c0a  /*.nth   =*/ 0,.
+000818c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000818d0: 2f2a 2e77 7369 7a65 203d 2a2f 2063 706c  /*.wsize =*/ cpl
+000818e0: 616e 2d3e 776f 726b 5f73 697a 652c 0a20  an->work_size,. 
+000818f0: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00081900: 2a2e 7764 6174 6120 3d2a 2f20 6370 6c61  *.wdata =*/ cpla
+00081910: 6e2d 3e77 6f72 6b5f 6461 7461 2c0a 2020  n->work_data,.  
+00081920: 2020 2020 2020 2020 2020 7d3b 0a0a 2020            };..  
+00081930: 2020 2020 2020 2020 2020 6966 2028 6e6f            if (no
+00081940: 6465 5f6e 2021 3d20 2d31 2920 7b0a 2020  de_n != -1) {.  
+00081950: 2020 2020 2020 2020 2020 2020 2020 2f2a                /*
+00081960: 2046 494e 414c 495a 4520 2a2f 0a20 2020   FINALIZE */.   
+00081970: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00081980: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00081990: 2a20 6e6f 6465 203d 2073 7461 7465 2d3e  * node = state->
+000819a0: 7368 6172 6564 2d3e 6367 7261 7068 2d3e  shared->cgraph->
+000819b0: 6e6f 6465 735b 6e6f 6465 5f6e 5d3b 0a20  nodes[node_n];. 
+000819c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000819d0: 6620 2847 474d 4c5f 4f50 5f48 4153 5f46  f (GGML_OP_HAS_F
+000819e0: 494e 414c 495a 455b 6e6f 6465 2d3e 6f70  INALIZE[node->op
+000819f0: 5d29 207b 0a20 2020 2020 2020 2020 2020  ]) {.           
+00081a00: 2020 2020 2020 2020 2070 6172 616d 732e           params.
+00081a10: 6e74 6820 3d20 6e5f 7461 736b 735f 6172  nth = n_tasks_ar
+00081a20: 725b 6e6f 6465 5f6e 5d3b 0a20 2020 2020  r[node_n];.     
+00081a30: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00081a40: 676d 6c5f 636f 6d70 7574 655f 666f 7277  gml_compute_forw
+00081a50: 6172 6428 2670 6172 616d 732c 206e 6f64  ard(&params, nod
+00081a60: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
+00081a70: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
+00081a80: 7068 5f63 6f6d 7075 7465 5f70 6572 665f  ph_compute_perf_
+00081a90: 7374 6174 735f 6e6f 6465 286e 6f64 652c  stats_node(node,
+00081aa0: 2073 7461 7465 2d3e 7368 6172 6564 293b   state->shared);
+00081ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081ac0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+00081ad0: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
+00081ae0: 2064 6973 7472 6962 7574 6520 6e65 7720   distribute new 
+00081af0: 776f 726b 206f 7220 6578 6563 7574 6520  work or execute 
+00081b00: 6974 2064 6972 6563 7420 6966 2031 540a  it direct if 1T.
+00081b10: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00081b20: 6520 282b 2b6e 6f64 655f 6e20 3c20 6367  e (++node_n < cg
+00081b30: 7261 7068 2d3e 6e5f 6e6f 6465 7329 207b  raph->n_nodes) {
+00081b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081b50: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+00081b60: 475f 3528 2225 733a 2025 642f 2564 5c6e  G_5("%s: %d/%d\n
+00081b70: 222c 205f 5f66 756e 635f 5f2c 206e 6f64  ", __func__, nod
+00081b80: 655f 6e2c 2063 6772 6170 682d 3e6e 5f6e  e_n, cgraph->n_n
+00081b90: 6f64 6573 293b 0a0a 2020 2020 2020 2020  odes);..        
+00081ba0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00081bb0: 676d 6c5f 7465 6e73 6f72 202a 206e 6f64  gml_tensor * nod
+00081bc0: 6520 3d20 6367 7261 7068 2d3e 6e6f 6465  e = cgraph->node
+00081bd0: 735b 6e6f 6465 5f6e 5d3b 0a20 2020 2020  s[node_n];.     
+00081be0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00081bf0: 2069 6e74 206e 5f74 6173 6b73 203d 206e   int n_tasks = n
+00081c00: 5f74 6173 6b73 5f61 7272 5b6e 6f64 655f  _tasks_arr[node_
+00081c10: 6e5d 3b0a 0a20 2020 2020 2020 2020 2020  n];..           
+00081c20: 2020 2020 2073 7461 7465 2d3e 7368 6172       state->shar
+00081c30: 6564 2d3e 7065 7266 5f6e 6f64 655f 7374  ed->perf_node_st
+00081c40: 6172 745f 6379 636c 6573 2020 3d20 6767  art_cycles  = gg
+00081c50: 6d6c 5f70 6572 665f 6379 636c 6573 2829  ml_perf_cycles()
+00081c60: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00081c70: 2020 7374 6174 652d 3e73 6861 7265 642d    state->shared-
+00081c80: 3e70 6572 665f 6e6f 6465 5f73 7461 7274  >perf_node_start
+00081c90: 5f74 696d 655f 7573 203d 2067 676d 6c5f  _time_us = ggml_
+00081ca0: 7065 7266 5f74 696d 655f 7573 2829 3b0a  perf_time_us();.
+00081cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00081cc0: 2070 6172 616d 732e 6e74 6820 3d20 6e5f   params.nth = n_
+00081cd0: 7461 736b 733b 0a0a 2020 2020 2020 2020  tasks;..        
+00081ce0: 2020 2020 2020 2020 2f2a 2049 4e49 5420          /* INIT 
+00081cf0: 2a2f 0a20 2020 2020 2020 2020 2020 2020  */.             
+00081d00: 2020 2069 6620 2847 474d 4c5f 4f50 5f48     if (GGML_OP_H
+00081d10: 4153 5f49 4e49 545b 6e6f 6465 2d3e 6f70  AS_INIT[node->op
+00081d20: 5d29 207b 0a20 2020 2020 2020 2020 2020  ]) {.           
+00081d30: 2020 2020 2020 2020 2070 6172 616d 732e           params.
+00081d40: 7479 7065 203d 2047 474d 4c5f 5441 534b  type = GGML_TASK
+00081d50: 5f49 4e49 543b 0a20 2020 2020 2020 2020  _INIT;.         
+00081d60: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00081d70: 636f 6d70 7574 655f 666f 7277 6172 6428  compute_forward(
+00081d80: 2670 6172 616d 732c 206e 6f64 6529 3b0a  &params, node);.
+00081d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081da0: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00081db0: 2020 2069 6620 286e 5f74 6173 6b73 203d     if (n_tasks =
+00081dc0: 3d20 3129 207b 0a20 2020 2020 2020 2020  = 1) {.         
+00081dd0: 2020 2020 2020 2020 2020 202f 2f20 544f             // TO
+00081de0: 444f 3a20 6d61 7962 6520 7075 7368 206e  DO: maybe push n
+00081df0: 6f64 655f 6e20 746f 2074 6865 2061 746f  ode_n to the ato
+00081e00: 6d69 6320 6275 7420 6966 206f 7468 6572  mic but if other
+00081e10: 2074 6872 6561 6473 2073 6565 206e 5f74   threads see n_t
+00081e20: 6173 6b73 2069 7320 312c 0a20 2020 2020  asks is 1,.     
+00081e30: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00081e40: 2f20 7468 6579 2064 6f20 736f 6d65 7468  / they do someth
+00081e50: 696e 6720 6d6f 7265 2065 6666 6963 6965  ing more efficie
+00081e60: 6e74 2074 6861 6e20 7370 696e 6e69 6e67  nt than spinning
+00081e70: 2028 3f29 0a20 2020 2020 2020 2020 2020   (?).           
+00081e80: 2020 2020 2020 2020 2070 6172 616d 732e           params.
+00081e90: 7479 7065 203d 2047 474d 4c5f 5441 534b  type = GGML_TASK
+00081ea0: 5f43 4f4d 5055 5445 3b0a 2020 2020 2020  _COMPUTE;.      
+00081eb0: 2020 2020 2020 2020 2020 2020 2020 6767                gg
+00081ec0: 6d6c 5f63 6f6d 7075 7465 5f66 6f72 7761  ml_compute_forwa
+00081ed0: 7264 2826 7061 7261 6d73 2c20 6e6f 6465  rd(&params, node
+00081ee0: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00081ef0: 2020 2020 2020 2020 6966 2028 4747 4d4c          if (GGML
+00081f00: 5f4f 505f 4841 535f 4649 4e41 4c49 5a45  _OP_HAS_FINALIZE
+00081f10: 5b6e 6f64 652d 3e6f 705d 2920 7b0a 2020  [node->op]) {.  
+00081f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081f30: 2020 2020 2020 7061 7261 6d73 2e74 7970        params.typ
+00081f40: 6520 3d20 4747 4d4c 5f54 4153 4b5f 4649  e = GGML_TASK_FI
+00081f50: 4e41 4c49 5a45 3b0a 2020 2020 2020 2020  NALIZE;.        
+00081f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00081f70: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
+00081f80: 7761 7264 2826 7061 7261 6d73 2c20 6e6f  ward(&params, no
+00081f90: 6465 293b 0a20 2020 2020 2020 2020 2020  de);.           
+00081fa0: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00081fb0: 6c5f 6772 6170 685f 636f 6d70 7574 655f  l_graph_compute_
+00081fc0: 7065 7266 5f73 7461 7473 5f6e 6f64 6528  perf_stats_node(
+00081fd0: 6e6f 6465 2c20 7374 6174 652d 3e73 6861  node, state->sha
+00081fe0: 7265 6429 3b0a 2020 2020 2020 2020 2020  red);.          
+00081ff0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00082000: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00082010: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+00082020: 2020 2020 2020 2020 2062 7265 616b 3b0a           break;.
+00082030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082040: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00082050: 2020 2069 6620 2863 706c 616e 2d3e 6162     if (cplan->ab
+00082060: 6f72 745f 6361 6c6c 6261 636b 2026 2620  ort_callback && 
+00082070: 6370 6c61 6e2d 3e61 626f 7274 5f63 616c  cplan->abort_cal
+00082080: 6c62 6163 6b28 6370 6c61 6e2d 3e61 626f  lback(cplan->abo
+00082090: 7274 5f63 616c 6c62 6163 6b5f 6461 7461  rt_callback_data
+000820a0: 2929 207b 0a20 2020 2020 2020 2020 2020  )) {.           
+000820b0: 2020 2020 2020 2020 2062 7265 616b 3b0a           break;.
+000820c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000820d0: 7d0a 2020 2020 2020 2020 2020 2020 7d0a  }.            }.
+000820e0: 0a20 2020 2020 2020 2020 2020 2061 746f  .            ato
+000820f0: 6d69 635f 7374 6f72 6528 2673 7461 7465  mic_store(&state
+00082100: 2d3e 7368 6172 6564 2d3e 6e5f 6163 7469  ->shared->n_acti
+00082110: 7665 2c20 6e5f 7468 7265 6164 7329 3b0a  ve, n_threads);.
+00082120: 2020 2020 2020 2020 2020 2020 6174 6f6d              atom
+00082130: 6963 5f73 746f 7265 2826 7374 6174 652d  ic_store(&state-
+00082140: 3e73 6861 7265 642d 3e6e 6f64 655f 6e2c  >shared->node_n,
+00082150: 2020 206e 6f64 655f 6e29 3b0a 2020 2020     node_n);.    
+00082160: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+00082170: 2020 2020 2020 2020 202f 2f20 7761 6974           // wait
+00082180: 2066 6f72 206f 7468 6572 2074 6872 6561   for other threa
+00082190: 6473 2074 6f20 6669 6e69 7368 0a20 2020  ds to finish.   
+000821a0: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+000821b0: 6e74 206c 6173 7420 3d20 6e6f 6465 5f6e  nt last = node_n
+000821c0: 3b0a 2020 2020 2020 2020 2020 2020 646f  ;.            do
+000821d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000821e0: 2020 202f 2f73 6368 6564 5f79 6965 6c64     //sched_yield
+000821f0: 2829 3b0a 2020 2020 2020 2020 2020 2020  ();.            
+00082200: 2020 2020 6e6f 6465 5f6e 203d 2061 746f      node_n = ato
+00082210: 6d69 635f 6c6f 6164 2826 7374 6174 652d  mic_load(&state-
+00082220: 3e73 6861 7265 642d 3e6e 6f64 655f 6e29  >shared->node_n)
+00082230: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00082240: 7768 696c 6520 286e 6f64 655f 6e20 3d3d  while (node_n ==
+00082250: 206c 6173 7429 3b0a 2020 2020 2020 2020   last);.        
+00082260: 7d0a 0a20 2020 2020 2020 202f 2f20 6368  }..        // ch
+00082270: 6563 6b20 6966 2077 6520 7368 6f75 6c64  eck if we should
+00082280: 2073 746f 700a 2020 2020 2020 2020 6966   stop.        if
+00082290: 2028 6e6f 6465 5f6e 203e 3d20 6367 7261   (node_n >= cgra
+000822a0: 7068 2d3e 6e5f 6e6f 6465 7329 2062 7265  ph->n_nodes) bre
+000822b0: 616b 3b0a 0a20 2020 2020 2020 202f 2a20  ak;..        /* 
+000822c0: 434f 4d50 5554 4520 2a2f 0a20 2020 2020  COMPUTE */.     
+000822d0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+000822e0: 656e 736f 7220 2a20 6e6f 6465 203d 2063  ensor * node = c
+000822f0: 6772 6170 682d 3e6e 6f64 6573 5b6e 6f64  graph->nodes[nod
+00082300: 655f 6e5d 3b0a 2020 2020 2020 2020 636f  e_n];.        co
+00082310: 6e73 7420 696e 7420 6e5f 7461 736b 7320  nst int n_tasks 
+00082320: 3d20 6e5f 7461 736b 735f 6172 725b 6e6f  = n_tasks_arr[no
+00082330: 6465 5f6e 5d3b 0a0a 2020 2020 2020 2020  de_n];..        
+00082340: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00082350: 7574 655f 7061 7261 6d73 2070 6172 616d  ute_params param
+00082360: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+00082370: 2020 2f2a 2e74 7970 6520 203d 2a2f 2047    /*.type  =*/ G
+00082380: 474d 4c5f 5441 534b 5f43 4f4d 5055 5445  GML_TASK_COMPUTE
+00082390: 2c0a 2020 2020 2020 2020 2020 2020 2f2a  ,.            /*
+000823a0: 2e69 7468 2020 203d 2a2f 2073 7461 7465  .ith   =*/ state
+000823b0: 2d3e 6974 682c 0a20 2020 2020 2020 2020  ->ith,.         
+000823c0: 2020 202f 2a2e 6e74 6820 2020 3d2a 2f20     /*.nth   =*/ 
+000823d0: 6e5f 7461 736b 732c 0a20 2020 2020 2020  n_tasks,.       
+000823e0: 2020 2020 202f 2a2e 7773 697a 6520 3d2a       /*.wsize =*
+000823f0: 2f20 6370 6c61 6e2d 3e77 6f72 6b5f 7369  / cplan->work_si
+00082400: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+00082410: 2f2a 2e77 6461 7461 203d 2a2f 2063 706c  /*.wdata =*/ cpl
+00082420: 616e 2d3e 776f 726b 5f64 6174 612c 0a20  an->work_data,. 
+00082430: 2020 2020 2020 207d 3b0a 0a20 2020 2020         };..     
+00082440: 2020 2069 6620 2873 7461 7465 2d3e 6974     if (state->it
+00082450: 6820 3c20 6e5f 7461 736b 7329 207b 0a20  h < n_tasks) {. 
+00082460: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00082470: 636f 6d70 7574 655f 666f 7277 6172 6428  compute_forward(
+00082480: 2670 6172 616d 732c 206e 6f64 6529 3b0a  &params, node);.
+00082490: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+000824a0: 0a20 2020 2072 6574 7572 6e20 4747 4d4c  .    return GGML
+000824b0: 5f45 5849 545f 5355 4343 4553 533b 0a7d  _EXIT_SUCCESS;.}
+000824c0: 0a0a 7374 7275 6374 2067 676d 6c5f 6370  ..struct ggml_cp
+000824d0: 6c61 6e20 6767 6d6c 5f67 7261 7068 5f70  lan ggml_graph_p
+000824e0: 6c61 6e28 7374 7275 6374 2067 676d 6c5f  lan(struct ggml_
+000824f0: 6367 7261 7068 202a 2063 6772 6170 682c  cgraph * cgraph,
+00082500: 2069 6e74 206e 5f74 6872 6561 6473 2920   int n_threads) 
+00082510: 7b0a 2020 2020 6966 2028 6e5f 7468 7265  {.    if (n_thre
+00082520: 6164 7320 3c3d 2030 2920 7b0a 2020 2020  ads <= 0) {.    
+00082530: 2020 2020 6e5f 7468 7265 6164 7320 3d20      n_threads = 
+00082540: 4747 4d4c 5f44 4546 4155 4c54 5f4e 5f54  GGML_DEFAULT_N_T
+00082550: 4852 4541 4453 3b0a 2020 2020 7d0a 0a20  HREADS;.    }.. 
+00082560: 2020 2073 697a 655f 7420 776f 726b 5f73     size_t work_s
+00082570: 697a 6520 3d20 303b 0a0a 2020 2020 7374  ize = 0;..    st
+00082580: 7275 6374 2067 676d 6c5f 6370 6c61 6e20  ruct ggml_cplan 
+00082590: 6370 6c61 6e3b 0a20 2020 206d 656d 7365  cplan;.    memse
+000825a0: 7428 2663 706c 616e 2c20 302c 2073 697a  t(&cplan, 0, siz
+000825b0: 656f 6628 7374 7275 6374 2067 676d 6c5f  eof(struct ggml_
+000825c0: 6370 6c61 6e29 293b 0a0a 2020 2020 2f2f  cplan));..    //
+000825d0: 2074 6872 6561 6420 7363 6865 6475 6c69   thread scheduli
+000825e0: 6e67 2066 6f72 2074 6865 2064 6966 6665  ng for the diffe
+000825f0: 7265 6e74 206f 7065 7261 7469 6f6e 7320  rent operations 
+00082600: 2b20 776f 726b 2062 7566 6665 7220 7369  + work buffer si
+00082610: 7a65 2065 7374 696d 6174 696f 6e0a 2020  ze estimation.  
+00082620: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00082630: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+00082640: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
+00082650: 2020 2020 2020 696e 7420 6e5f 7461 736b        int n_task
+00082660: 7320 3d20 313b 0a0a 2020 2020 2020 2020  s = 1;..        
+00082670: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00082680: 6f72 202a 206e 6f64 6520 3d20 6367 7261  or * node = cgra
+00082690: 7068 2d3e 6e6f 6465 735b 695d 3b0a 0a20  ph->nodes[i];.. 
+000826a0: 2020 2020 2020 2073 7769 7463 6820 286e         switch (n
+000826b0: 6f64 652d 3e6f 7029 207b 0a20 2020 2020  ode->op) {.     
+000826c0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000826d0: 5f4f 505f 4350 593a 0a20 2020 2020 2020  _OP_CPY:.       
+000826e0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000826f0: 505f 4455 503a 0a20 2020 2020 2020 2020  P_DUP:.         
+00082700: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00082710: 2020 2020 2020 2020 2020 2020 206e 5f74               n_t
+00082720: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
+00082730: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00082740: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
+00082750: 7220 3d20 303b 0a20 2020 2020 2020 2020  r = 0;.         
+00082760: 2020 2020 2020 2020 2020 2069 6620 2867             if (g
+00082770: 676d 6c5f 6973 5f71 7561 6e74 697a 6564  gml_is_quantized
+00082780: 286e 6f64 652d 3e74 7970 6529 2920 7b0a  (node->type)) {.
+00082790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000827a0: 2020 2020 2020 2020 6375 7220 3d20 4747          cur = GG
+000827b0: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
+000827c0: 4c5f 5459 5045 5f46 3332 5d20 2a20 6e6f  L_TYPE_F32] * no
+000827d0: 6465 2d3e 6e65 5b30 5d20 2a20 6e5f 7461  de->ne[0] * n_ta
+000827e0: 736b 733b 0a20 2020 2020 2020 2020 2020  sks;.           
+000827f0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00082800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082810: 776f 726b 5f73 697a 6520 3d20 4d41 5828  work_size = MAX(
+00082820: 776f 726b 5f73 697a 652c 2063 7572 293b  work_size, cur);
+00082830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082840: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00082850: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00082860: 4f50 5f41 4444 3a0a 2020 2020 2020 2020  OP_ADD:.        
+00082870: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00082880: 5f41 4444 313a 0a20 2020 2020 2020 2020  _ADD1:.         
+00082890: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+000828a0: 2020 2020 2020 2020 2020 2020 206e 5f74               n_t
+000828b0: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
+000828c0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000828d0: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
+000828e0: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
+000828f0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00082900: 6767 6d6c 5f69 735f 7175 616e 7469 7a65  ggml_is_quantize
+00082910: 6428 6e6f 6465 2d3e 7372 635b 305d 2d3e  d(node->src[0]->
+00082920: 7479 7065 2929 207b 0a20 2020 2020 2020  type)) {.       
+00082930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082940: 2063 7572 203d 2047 474d 4c5f 5459 5045   cur = GGML_TYPE
+00082950: 5f53 495a 455b 4747 4d4c 5f54 5950 455f  _SIZE[GGML_TYPE_
+00082960: 4633 325d 202a 206e 6f64 652d 3e73 7263  F32] * node->src
+00082970: 5b30 5d2d 3e6e 655b 305d 202a 206e 5f74  [0]->ne[0] * n_t
+00082980: 6173 6b73 3b0a 2020 2020 2020 2020 2020  asks;.          
+00082990: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+000829a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000829b0: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
+000829c0: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
+000829d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000829e0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000829f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00082a00: 5f4f 505f 4143 433a 0a20 2020 2020 2020  _OP_ACC:.       
+00082a10: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00082a20: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00082a30: 5f74 6173 6b73 203d 206e 5f74 6872 6561  _tasks = n_threa
+00082a40: 6473 3b0a 0a20 2020 2020 2020 2020 2020  ds;..           
+00082a50: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+00082a60: 6375 7220 3d20 303b 0a0a 2020 2020 2020  cur = 0;..      
+00082a70: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00082a80: 2028 6767 6d6c 5f69 735f 7175 616e 7469   (ggml_is_quanti
+00082a90: 7a65 6428 6e6f 6465 2d3e 7372 635b 305d  zed(node->src[0]
+00082aa0: 2d3e 7479 7065 2929 207b 0a20 2020 2020  ->type)) {.     
+00082ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082ac0: 2020 2063 7572 203d 2047 474d 4c5f 5459     cur = GGML_TY
+00082ad0: 5045 5f53 495a 455b 4747 4d4c 5f54 5950  PE_SIZE[GGML_TYP
+00082ae0: 455f 4633 325d 202a 206e 6f64 652d 3e73  E_F32] * node->s
+00082af0: 7263 5b31 5d2d 3e6e 655b 305d 202a 206e  rc[1]->ne[0] * n
+00082b00: 5f74 6173 6b73 3b0a 2020 2020 2020 2020  _tasks;.        
+00082b10: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00082b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082b30: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
+00082b40: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
+00082b50: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
+00082b60: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00082b70: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
+00082b80: 4d4c 5f4f 505f 5355 423a 0a20 2020 2020  ML_OP_SUB:.     
+00082b90: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00082ba0: 5f4f 505f 4449 563a 0a20 2020 2020 2020  _OP_DIV:.       
+00082bb0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00082bc0: 505f 5351 523a 0a20 2020 2020 2020 2020  P_SQR:.         
+00082bd0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
+00082be0: 5351 5254 3a0a 2020 2020 2020 2020 2020  SQRT:.          
+00082bf0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4c    case GGML_OP_L
+00082c00: 4f47 3a0a 2020 2020 2020 2020 2020 2020  OG:.            
+00082c10: 6361 7365 2047 474d 4c5f 4f50 5f53 554d  case GGML_OP_SUM
+00082c20: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
+00082c30: 7365 2047 474d 4c5f 4f50 5f53 554d 5f52  se GGML_OP_SUM_R
+00082c40: 4f57 533a 0a20 2020 2020 2020 2020 2020  OWS:.           
+00082c50: 2063 6173 6520 4747 4d4c 5f4f 505f 4d45   case GGML_OP_ME
+00082c60: 414e 3a0a 2020 2020 2020 2020 2020 2020  AN:.            
+00082c70: 6361 7365 2047 474d 4c5f 4f50 5f41 5247  case GGML_OP_ARG
+00082c80: 4d41 583a 0a20 2020 2020 2020 2020 2020  MAX:.           
+00082c90: 2063 6173 6520 4747 4d4c 5f4f 505f 5245   case GGML_OP_RE
+00082ca0: 5045 4154 3a0a 2020 2020 2020 2020 2020  PEAT:.          
+00082cb0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
+00082cc0: 4550 4541 545f 4241 434b 3a0a 2020 2020  EPEAT_BACK:.    
+00082cd0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00082ce0: 4c5f 4f50 5f41 4253 3a0a 2020 2020 2020  L_OP_ABS:.      
+00082cf0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00082d00: 4f50 5f53 474e 3a0a 2020 2020 2020 2020  OP_SGN:.        
+00082d10: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00082d20: 5f4e 4547 3a0a 2020 2020 2020 2020 2020  _NEG:.          
+00082d30: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00082d40: 5445 503a 0a20 2020 2020 2020 2020 2020  TEP:.           
+00082d50: 2063 6173 6520 4747 4d4c 5f4f 505f 5441   case GGML_OP_TA
+00082d60: 4e48 3a0a 2020 2020 2020 2020 2020 2020  NH:.            
+00082d70: 6361 7365 2047 474d 4c5f 4f50 5f45 4c55  case GGML_OP_ELU
+00082d80: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
+00082d90: 7365 2047 474d 4c5f 4f50 5f52 454c 553a  se GGML_OP_RELU:
+00082da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082db0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00082dc0: 2020 2020 2020 206e 5f74 6173 6b73 203d         n_tasks =
+00082dd0: 2031 3b0a 2020 2020 2020 2020 2020 2020   1;.            
+00082de0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
 00082df0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00082e00: 4d4c 5f4f 505f 5349 4c55 3a0a 2020 2020  ML_OP_SILU:.    
-00082e10: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00082e20: 4c5f 4f50 5f53 494c 555f 4241 434b 3a0a  L_OP_SILU_BACK:.
-00082e30: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00082e40: 2047 474d 4c5f 4f50 5f4e 4f52 4d3a 0a20   GGML_OP_NORM:. 
+00082e00: 4d4c 5f4f 505f 4d55 4c3a 0a20 2020 2020  ML_OP_MUL:.     
+00082e10: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00082e20: 5f4f 505f 4745 4c55 3a0a 2020 2020 2020  _OP_GELU:.      
+00082e30: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00082e40: 4f50 5f47 454c 555f 5155 4943 4b3a 0a20  OP_GELU_QUICK:. 
 00082e50: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00082e60: 4747 4d4c 5f4f 505f 524d 535f 4e4f 524d  GGML_OP_RMS_NORM
-00082e70: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
-00082e80: 7365 2047 474d 4c5f 4f50 5f52 4d53 5f4e  se GGML_OP_RMS_N
-00082e90: 4f52 4d5f 4241 434b 3a0a 2020 2020 2020  ORM_BACK:.      
-00082ea0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00082eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082ec0: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
-00082ed0: 6164 733b 0a20 2020 2020 2020 2020 2020  ads;.           
-00082ee0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00082ef0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00082f00: 474d 4c5f 4f50 5f4d 554c 5f4d 4154 3a0a  GML_OP_MUL_MAT:.
-00082f10: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00082f20: 2047 474d 4c5f 4f50 5f4f 5554 5f50 524f   GGML_OP_OUT_PRO
-00082f30: 443a 0a20 2020 2020 2020 2020 2020 2020  D:.             
-00082f40: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00082f50: 2020 2020 2020 2020 206e 5f74 6173 6b73           n_tasks
-00082f60: 203d 206e 5f74 6872 6561 6473 3b0a 0a20   = n_threads;.. 
-00082f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082f80: 2020 202f 2f20 544f 444f 3a20 7573 6520     // TODO: use 
-00082f90: 6469 6666 6572 656e 7420 7363 6865 6475  different schedu
-00082fa0: 6c69 6e67 2066 6f72 2064 6966 6665 7265  ling for differe
-00082fb0: 6e74 206d 6174 7269 7820 7369 7a65 730a  nt matrix sizes.
-00082fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00082fd0: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-00082fe0: 6e72 3020 3d20 6767 6d6c 5f6e 726f 7773  nr0 = ggml_nrows
-00082ff0: 286e 6f64 652d 3e73 7263 5b30 5d29 3b0a  (node->src[0]);.
-00083000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083010: 2020 2020 2f2f 636f 6e73 7420 696e 7420      //const int 
-00083020: 6e72 3120 3d20 6767 6d6c 5f6e 726f 7773  nr1 = ggml_nrows
-00083030: 286e 6f64 652d 3e73 7263 5b31 5d29 3b0a  (node->src[1]);.
-00083040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083050: 2020 2020 202f 2f6e 5f74 6173 6b73 203d       //n_tasks =
-00083060: 204d 494e 286e 5f74 6872 6561 6473 2c20   MIN(n_threads, 
-00083070: 4d41 5828 312c 206e 7230 2f31 3238 2929  MAX(1, nr0/128))
-00083080: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00083090: 2020 2020 2020 2f2f 7072 696e 7466 2822        //printf("
-000830a0: 6e72 3020 3d20 2538 642c 206e 7231 203d  nr0 = %8d, nr1 =
-000830b0: 2025 3864 2c20 6e72 302a 6e72 3120 3d20   %8d, nr0*nr1 = 
-000830c0: 2538 642c 206e 5f74 6173 6b73 2564 5c6e  %8d, n_tasks%d\n
-000830d0: 222c 206e 7230 2c20 6e72 312c 206e 7230  ", nr0, nr1, nr0
-000830e0: 2a6e 7231 2c20 6e5f 7461 736b 7329 3b0a  *nr1, n_tasks);.
-000830f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00083100: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
-00083110: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-00083120: 2020 2020 2020 2020 2063 6f6e 7374 2065           const e
-00083130: 6e75 6d20 6767 6d6c 5f74 7970 6520 7665  num ggml_type ve
-00083140: 635f 646f 745f 7479 7065 203d 2074 7970  c_dot_type = typ
-00083150: 655f 7472 6169 7473 5b6e 6f64 652d 3e73  e_traits[node->s
-00083160: 7263 5b30 5d2d 3e74 7970 655d 2e76 6563  rc[0]->type].vec
-00083170: 5f64 6f74 5f74 7970 653b 0a0a 2369 6620  _dot_type;..#if 
-00083180: 6465 6669 6e65 6428 4747 4d4c 5f55 5345  defined(GGML_USE
-00083190: 5f43 5542 4c41 5329 0a20 2020 2020 2020  _CUBLAS).       
-000831a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000831b0: 2867 676d 6c5f 6375 6461 5f63 616e 5f6d  (ggml_cuda_can_m
-000831c0: 756c 5f6d 6174 286e 6f64 652d 3e73 7263  ul_mat(node->src
-000831d0: 5b30 5d2c 206e 6f64 652d 3e73 7263 5b31  [0], node->src[1
-000831e0: 5d2c 206e 6f64 6529 2920 7b0a 2020 2020  ], node)) {.    
-000831f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083200: 2020 2020 6e5f 7461 736b 7320 3d20 313b      n_tasks = 1;
-00083210: 202f 2f20 544f 444f 3a20 7468 6973 2061   // TODO: this a
-00083220: 6374 7561 6c6c 7920 6973 2064 6f69 6e67  ctually is doing
-00083230: 206e 6f74 6869 6e67 0a20 2020 2020 2020   nothing.       
-00083240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083250: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
-00083260: 2020 2020 2020 2074 6865 2074 6872 6561         the threa
-00083270: 6473 2061 7265 2073 7469 6c6c 2073 7069  ds are still spi
-00083280: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-00083290: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
-000832a0: 0a23 656c 6966 2064 6566 696e 6564 2847  .#elif defined(G
-000832b0: 474d 4c5f 5553 455f 434c 424c 4153 5429  GML_USE_CLBLAST)
-000832c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000832d0: 2020 2020 2069 6620 2867 676d 6c5f 636c       if (ggml_cl
-000832e0: 5f63 616e 5f6d 756c 5f6d 6174 286e 6f64  _can_mul_mat(nod
-000832f0: 652d 3e73 7263 5b30 5d2c 206e 6f64 652d  e->src[0], node-
-00083300: 3e73 7263 5b31 5d2c 206e 6f64 6529 2920  >src[1], node)) 
-00083310: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00083320: 2020 2020 2020 2020 2020 6e5f 7461 736b            n_task
-00083330: 7320 3d20 313b 202f 2f20 544f 444f 3a20  s = 1; // TODO: 
-00083340: 7468 6973 2061 6374 7561 6c6c 7920 6973  this actually is
-00083350: 2064 6f69 6e67 206e 6f74 6869 6e67 0a20   doing nothing. 
-00083360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083380: 2020 2020 2f2f 2020 2020 2020 2074 6865      //       the
-00083390: 2074 6872 6561 6473 2061 7265 2073 7469   threads are sti
-000833a0: 6c6c 2073 7069 6e6e 696e 670a 2020 2020  ll spinning.    
-000833b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000833c0: 2020 2020 6375 7220 3d20 6767 6d6c 5f63      cur = ggml_c
-000833d0: 6c5f 6d75 6c5f 6d61 745f 6765 745f 7773  l_mul_mat_get_ws
-000833e0: 697a 6528 6e6f 6465 2d3e 7372 635b 305d  ize(node->src[0]
-000833f0: 2c20 6e6f 6465 2d3e 7372 635b 315d 2c20  , node->src[1], 
-00083400: 6e6f 6465 293b 0a20 2020 2020 2020 2020  node);.         
-00083410: 2020 2020 2020 2020 2020 207d 2065 6c73             } els
-00083420: 650a 2365 6e64 6966 0a23 6966 2064 6566  e.#endif.#if def
-00083430: 696e 6564 2847 474d 4c5f 5553 455f 4143  ined(GGML_USE_AC
-00083440: 4345 4c45 5241 5445 2920 7c7c 2064 6566  CELERATE) || def
-00083450: 696e 6564 2847 474d 4c5f 5553 455f 4f50  ined(GGML_USE_OP
-00083460: 454e 424c 4153 290a 2020 2020 2020 2020  ENBLAS).        
-00083470: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00083480: 6767 6d6c 5f63 6f6d 7075 7465 5f66 6f72  ggml_compute_for
-00083490: 7761 7264 5f6d 756c 5f6d 6174 5f75 7365  ward_mul_mat_use
-000834a0: 5f62 6c61 7328 6e6f 6465 2d3e 7372 635b  _blas(node->src[
-000834b0: 305d 2c20 6e6f 6465 2d3e 7372 635b 315d  0], node->src[1]
-000834c0: 2c20 6e6f 6465 2929 207b 0a20 2020 2020  , node)) {.     
-000834d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000834e0: 2020 206e 5f74 6173 6b73 203d 2031 3b20     n_tasks = 1; 
-000834f0: 2f2f 2054 4f44 4f3a 2074 6869 7320 6163  // TODO: this ac
-00083500: 7475 616c 6c79 2069 7320 646f 696e 6720  tually is doing 
-00083510: 6e6f 7468 696e 670a 2020 2020 2020 2020  nothing.        
-00083520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083530: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00083540: 2020 2020 2020 7468 6520 7468 7265 6164        the thread
-00083550: 7320 6172 6520 7374 696c 6c20 7370 696e  s are still spin
-00083560: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
-00083570: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00083580: 286e 6f64 652d 3e73 7263 5b30 5d2d 3e74  (node->src[0]->t
-00083590: 7970 6520 213d 2047 474d 4c5f 5459 5045  ype != GGML_TYPE
-000835a0: 5f46 3332 2920 7b0a 2020 2020 2020 2020  _F32) {.        
-000835b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000835c0: 2020 2020 2f2f 2068 6572 6520 7765 206e      // here we n
-000835d0: 6565 6420 6d65 6d6f 7279 206a 7573 7420  eed memory just 
-000835e0: 666f 7220 7369 6e67 6c65 2032 4420 6d61  for single 2D ma
-000835f0: 7472 6978 2066 726f 6d20 7372 6330 0a20  trix from src0. 
-00083600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083610: 2020 2020 2020 2020 2020 2063 7572 203d             cur =
-00083620: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
-00083630: 4747 4d4c 5f54 5950 455f 4633 325d 2a28  GGML_TYPE_F32]*(
-00083640: 6e6f 6465 2d3e 7372 635b 305d 2d3e 6e65  node->src[0]->ne
-00083650: 5b30 5d2a 6e6f 6465 2d3e 7372 635b 305d  [0]*node->src[0]
-00083660: 2d3e 6e65 5b31 5d29 3b0a 2020 2020 2020  ->ne[1]);.      
-00083670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083680: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00083690: 2020 2020 2020 2020 7d20 656c 7365 0a23          } else.#
-000836a0: 656e 6469 660a 2020 2020 2020 2020 2020  endif.          
-000836b0: 2020 2020 2020 2020 2020 6966 2028 6e6f            if (no
-000836c0: 6465 2d3e 7372 635b 315d 2d3e 7479 7065  de->src[1]->type
-000836d0: 2021 3d20 7665 635f 646f 745f 7479 7065   != vec_dot_type
-000836e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000836f0: 2020 2020 2020 2020 2020 2020 6375 7220              cur 
-00083700: 3d20 4747 4d4c 5f54 5950 455f 5349 5a45  = GGML_TYPE_SIZE
-00083710: 5b76 6563 5f64 6f74 5f74 7970 655d 2a67  [vec_dot_type]*g
-00083720: 676d 6c5f 6e65 6c65 6d65 6e74 7328 6e6f  gml_nelements(no
-00083730: 6465 2d3e 7372 635b 315d 292f 4747 4d4c  de->src[1])/GGML
-00083740: 5f42 4c43 4b5f 5349 5a45 5b76 6563 5f64  _BLCK_SIZE[vec_d
-00083750: 6f74 5f74 7970 655d 3b0a 2020 2020 2020  ot_type];.      
-00083760: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00083770: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
-00083780: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00083790: 7572 203d 2030 3b0a 2020 2020 2020 2020  ur = 0;.        
-000837a0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
-000837b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000837c0: 2020 2077 6f72 6b5f 7369 7a65 203d 204d     work_size = M
-000837d0: 4158 2877 6f72 6b5f 7369 7a65 2c20 6375  AX(work_size, cu
-000837e0: 7229 3b0a 2020 2020 2020 2020 2020 2020  r);.            
-000837f0: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00083800: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00083810: 4d4c 5f4f 505f 5343 414c 453a 0a20 2020  ML_OP_SCALE:.   
-00083820: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00083830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083840: 2020 206e 5f74 6173 6b73 203d 2031 3b0a     n_tasks = 1;.
-00083850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083860: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00083870: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00083880: 505f 5345 543a 0a20 2020 2020 2020 2020  P_SET:.         
-00083890: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000838a0: 434f 4e54 3a0a 2020 2020 2020 2020 2020  CONT:.          
-000838b0: 2020 6361 7365 2047 474d 4c5f 4f50 5f52    case GGML_OP_R
-000838c0: 4553 4841 5045 3a0a 2020 2020 2020 2020  ESHAPE:.        
-000838d0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-000838e0: 5f56 4945 573a 0a20 2020 2020 2020 2020  _VIEW:.         
-000838f0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00083900: 5045 524d 5554 453a 0a20 2020 2020 2020  PERMUTE:.       
-00083910: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00083920: 505f 5452 414e 5350 4f53 453a 0a20 2020  P_TRANSPOSE:.   
-00083930: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-00083940: 4d4c 5f4f 505f 4745 545f 524f 5753 3a0a  ML_OP_GET_ROWS:.
-00083950: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00083960: 2047 474d 4c5f 4f50 5f47 4554 5f52 4f57   GGML_OP_GET_ROW
-00083970: 535f 4241 434b 3a0a 2020 2020 2020 2020  S_BACK:.        
-00083980: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
-00083990: 5f44 4941 473a 0a20 2020 2020 2020 2020  _DIAG:.         
-000839a0: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-000839b0: 4449 4147 5f4d 4153 4b5f 5a45 524f 3a0a  DIAG_MASK_ZERO:.
-000839c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000839d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000839e0: 2020 2020 2020 6e5f 7461 736b 7320 3d20        n_tasks = 
-000839f0: 313b 0a20 2020 2020 2020 2020 2020 2020  1;.             
-00083a00: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00083a10: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00083a20: 4c5f 4f50 5f44 4941 475f 4d41 534b 5f49  L_OP_DIAG_MASK_I
-00083a30: 4e46 3a0a 2020 2020 2020 2020 2020 2020  NF:.            
-00083a40: 6361 7365 2047 474d 4c5f 4f50 5f53 4f46  case GGML_OP_SOF
-00083a50: 545f 4d41 583a 0a20 2020 2020 2020 2020  T_MAX:.         
-00083a60: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00083a70: 534f 4654 5f4d 4158 5f42 4143 4b3a 0a20  SOFT_MAX_BACK:. 
-00083a80: 2020 2020 2020 2020 2020 2063 6173 6520             case 
-00083a90: 4747 4d4c 5f4f 505f 524f 5045 3a0a 2020  GGML_OP_ROPE:.  
-00083aa0: 2020 2020 2020 2020 2020 6361 7365 2047            case G
-00083ab0: 474d 4c5f 4f50 5f52 4f50 455f 4241 434b  GML_OP_ROPE_BACK
-00083ac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00083ad0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00083ae0: 2020 2020 2020 2020 6e5f 7461 736b 7320          n_tasks 
-00083af0: 3d20 6e5f 7468 7265 6164 733b 0a20 2020  = n_threads;.   
-00083b00: 2020 2020 2020 2020 2020 2020 207d 2062               } b
-00083b10: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
-00083b20: 2020 6361 7365 2047 474d 4c5f 4f50 5f41    case GGML_OP_A
-00083b30: 4c49 4249 3a0a 2020 2020 2020 2020 2020  LIBI:.          
-00083b40: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00083b50: 2020 2020 2020 2020 2020 2020 6e5f 7461              n_ta
-00083b60: 736b 7320 3d20 313b 202f 2f54 4f44 4f0a  sks = 1; //TODO.
-00083b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083b80: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00083b90: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00083ba0: 505f 434c 414d 503a 0a20 2020 2020 2020  P_CLAMP:.       
-00083bb0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00083bc0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00083bd0: 5f74 6173 6b73 203d 2031 3b20 2f2f 544f  _tasks = 1; //TO
-00083be0: 444f 0a20 2020 2020 2020 2020 2020 2020  DO.             
-00083bf0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00083c00: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00083c10: 4c5f 4f50 5f43 4f4e 565f 3144 3a0a 2020  L_OP_CONV_1D:.  
-00083c20: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00083c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083c40: 2020 2020 6e5f 7461 736b 7320 3d20 6e5f      n_tasks = n_
-00083c50: 7468 7265 6164 733b 0a0a 2020 2020 2020  threads;..      
-00083c60: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00083c70: 4d4c 5f41 5353 4552 5428 6e6f 6465 2d3e  ML_ASSERT(node->
-00083c80: 7372 635b 305d 2d3e 6e65 5b33 5d20 3d3d  src[0]->ne[3] ==
-00083c90: 2031 293b 0a20 2020 2020 2020 2020 2020   1);.           
-00083ca0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00083cb0: 5345 5254 286e 6f64 652d 3e73 7263 5b31  SERT(node->src[1
-00083cc0: 5d2d 3e6e 655b 325d 203d 3d20 3129 3b0a  ]->ne[2] == 1);.
-00083cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083ce0: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00083cf0: 6e6f 6465 2d3e 7372 635b 315d 2d3e 6e65  node->src[1]->ne
-00083d00: 5b33 5d20 3d3d 2031 293b 0a0a 2020 2020  [3] == 1);..    
-00083d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083d20: 7369 7a65 5f74 2063 7572 203d 2030 3b0a  size_t cur = 0;.
-00083d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083d40: 2020 2020 636f 6e73 7420 696e 7420 6e6b      const int nk
-00083d50: 203d 206e 6f64 652d 3e73 7263 5b30 5d2d   = node->src[0]-
-00083d60: 3e6e 655b 305d 3b0a 0a20 2020 2020 2020  >ne[0];..       
-00083d70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00083d80: 286e 6f64 652d 3e73 7263 5b30 5d2d 3e74  (node->src[0]->t
-00083d90: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-00083da0: 5f46 3136 2026 260a 2020 2020 2020 2020  _F16 &&.        
-00083db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083dc0: 2020 2020 6e6f 6465 2d3e 7372 635b 315d      node->src[1]
-00083dd0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00083de0: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
-00083df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083e00: 2020 2063 7572 203d 2073 697a 656f 6628     cur = sizeof(
-00083e10: 6767 6d6c 5f66 7031 365f 7429 2a28 0a20  ggml_fp16_t)*(. 
-00083e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083e30: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00083e40: 6b2a 6767 6d6c 5f75 7033 3228 6e6f 6465  k*ggml_up32(node
-00083e50: 2d3e 7372 635b 305d 2d3e 6e65 5b31 5d29  ->src[0]->ne[1])
-00083e60: 2a6e 6f64 652d 3e73 7263 5b30 5d2d 3e6e  *node->src[0]->n
-00083e70: 655b 325d 202b 0a20 2020 2020 2020 2020  e[2] +.         
-00083e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083e90: 2020 2020 2020 2028 2032 2a28 6e6b 2f32         ( 2*(nk/2
-00083ea0: 2920 2b20 6e6f 6465 2d3e 7372 635b 315d  ) + node->src[1]
-00083eb0: 2d3e 6e65 5b30 5d29 2a6e 6f64 652d 3e73  ->ne[0])*node->s
-00083ec0: 7263 5b31 5d2d 3e6e 655b 315d 0a20 2020  rc[1]->ne[1].   
-00083ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083ee0: 2020 2020 2020 2020 2020 2020 2029 3b0a               );.
-00083ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083f00: 2020 2020 7d20 656c 7365 2069 6620 286e      } else if (n
-00083f10: 6f64 652d 3e73 7263 5b30 5d2d 3e74 7970  ode->src[0]->typ
-00083f20: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
-00083f30: 3332 2026 260a 2020 2020 2020 2020 2020  32 &&.          
-00083f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083f50: 2020 6e6f 6465 2d3e 7372 635b 315d 2d3e    node->src[1]->
-00083f60: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-00083f70: 455f 4633 3229 207b 0a20 2020 2020 2020  E_F32) {.       
-00083f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083f90: 2063 7572 203d 2073 697a 656f 6628 666c   cur = sizeof(fl
-00083fa0: 6f61 7429 2a28 0a20 2020 2020 2020 2020  oat)*(.         
-00083fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00083fc0: 2020 2020 2020 206e 6b2a 6767 6d6c 5f75         nk*ggml_u
-00083fd0: 7033 3228 6e6f 6465 2d3e 7372 635b 305d  p32(node->src[0]
-00083fe0: 2d3e 6e65 5b31 5d29 2a6e 6f64 652d 3e73  ->ne[1])*node->s
-00083ff0: 7263 5b30 5d2d 3e6e 655b 325d 202b 0a20  rc[0]->ne[2] +. 
-00084000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084010: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00084020: 2032 2a28 6e6b 2f32 2920 2b20 6e6f 6465   2*(nk/2) + node
-00084030: 2d3e 7372 635b 315d 2d3e 6e65 5b30 5d29  ->src[1]->ne[0])
-00084040: 2a6e 6f64 652d 3e73 7263 5b31 5d2d 3e6e  *node->src[1]->n
-00084050: 655b 315d 0a20 2020 2020 2020 2020 2020  e[1].           
-00084060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084070: 2020 2020 2029 3b0a 2020 2020 2020 2020       );.        
-00084080: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
-00084090: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
-000840a0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-000840b0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-000840c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000840d0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-000840e0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000840f0: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
-00084100: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
-00084110: 2020 2020 2020 2020 2020 2020 207d 2062               } b
-00084120: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
-00084130: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
-00084140: 4f4e 565f 3244 3a0a 2020 2020 2020 2020  ONV_2D:.        
-00084150: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00084160: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-00084170: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
-00084180: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-00084190: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000841a0: 7436 345f 7420 6e65 3030 203d 206e 6f64  t64_t ne00 = nod
-000841b0: 652d 3e73 7263 5b30 5d2d 3e6e 655b 305d  e->src[0]->ne[0]
-000841c0: 3b20 2f2f 2057 0a20 2020 2020 2020 2020  ; // W.         
-000841d0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000841e0: 2069 6e74 3634 5f74 206e 6530 3120 3d20   int64_t ne01 = 
-000841f0: 6e6f 6465 2d3e 7372 635b 305d 2d3e 6e65  node->src[0]->ne
-00084200: 5b31 5d3b 202f 2f20 480a 2020 2020 2020  [1]; // H.      
-00084210: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00084220: 6e73 7420 696e 7436 345f 7420 6e65 3032  nst int64_t ne02
-00084230: 203d 206e 6f64 652d 3e73 7263 5b30 5d2d   = node->src[0]-
-00084240: 3e6e 655b 325d 3b20 2f2f 2043 0a20 2020  >ne[2]; // C.   
-00084250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084260: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-00084270: 6530 3320 3d20 6e6f 6465 2d3e 7372 635b  e03 = node->src[
-00084280: 305d 2d3e 6e65 5b33 5d3b 202f 2f20 4e0a  0]->ne[3]; // N.
-00084290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000842a0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-000842b0: 5f74 206e 6531 3020 3d20 6e6f 6465 2d3e  _t ne10 = node->
-000842c0: 7372 635b 315d 2d3e 6e65 5b30 5d3b 202f  src[1]->ne[0]; /
-000842d0: 2f20 570a 2020 2020 2020 2020 2020 2020  / W.            
-000842e0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-000842f0: 7436 345f 7420 6e65 3131 203d 206e 6f64  t64_t ne11 = nod
-00084300: 652d 3e73 7263 5b31 5d2d 3e6e 655b 315d  e->src[1]->ne[1]
-00084310: 3b20 2f2f 2048 0a20 2020 2020 2020 2020  ; // H.         
-00084320: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00084330: 2069 6e74 3634 5f74 206e 6531 3220 3d20   int64_t ne12 = 
-00084340: 6e6f 6465 2d3e 7372 635b 315d 2d3e 6e65  node->src[1]->ne
-00084350: 5b32 5d3b 202f 2f20 430a 0a20 2020 2020  [2]; // C..     
-00084360: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00084370: 6f6e 7374 2069 6e74 3634 5f74 206e 6b20  onst int64_t nk 
-00084380: 3d20 6e65 3030 2a6e 6530 313b 0a0a 2020  = ne00*ne01;..  
-00084390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000843a0: 2020 554e 5553 4544 286e 6530 3229 3b0a    UNUSED(ne02);.
-000843b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000843c0: 2020 2020 554e 5553 4544 286e 6530 3329      UNUSED(ne03)
-000843d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000843e0: 2020 2020 2020 554e 5553 4544 286e 6b29        UNUSED(nk)
-000843f0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00084400: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
-00084410: 7220 3d20 303b 0a0a 2020 2020 2020 2020  r = 0;..        
-00084420: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00084430: 6e6f 6465 2d3e 7372 635b 305d 2d3e 7479  node->src[0]->ty
-00084440: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-00084450: 4631 3620 2626 0a20 2020 2020 2020 2020  F16 &&.         
+00082e60: 4747 4d4c 5f4f 505f 5349 4c55 3a0a 2020  GGML_OP_SILU:.  
+00082e70: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00082e80: 474d 4c5f 4f50 5f53 494c 555f 4241 434b  GML_OP_SILU_BACK
+00082e90: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
+00082ea0: 7365 2047 474d 4c5f 4f50 5f4e 4f52 4d3a  se GGML_OP_NORM:
+00082eb0: 0a20 2020 2020 2020 2020 2020 2063 6173  .            cas
+00082ec0: 6520 4747 4d4c 5f4f 505f 524d 535f 4e4f  e GGML_OP_RMS_NO
+00082ed0: 524d 3a0a 2020 2020 2020 2020 2020 2020  RM:.            
+00082ee0: 6361 7365 2047 474d 4c5f 4f50 5f52 4d53  case GGML_OP_RMS
+00082ef0: 5f4e 4f52 4d5f 4241 434b 3a0a 2020 2020  _NORM_BACK:.    
+00082f00: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00082f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00082f20: 2020 6e5f 7461 736b 7320 3d20 6e5f 7468    n_tasks = n_th
+00082f30: 7265 6164 733b 0a20 2020 2020 2020 2020  reads;.         
+00082f40: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
+00082f50: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00082f60: 2047 474d 4c5f 4f50 5f4d 554c 5f4d 4154   GGML_OP_MUL_MAT
+00082f70: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
+00082f80: 7365 2047 474d 4c5f 4f50 5f4f 5554 5f50  se GGML_OP_OUT_P
+00082f90: 524f 443a 0a20 2020 2020 2020 2020 2020  ROD:.           
+00082fa0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00082fb0: 2020 2020 2020 2020 2020 206e 5f74 6173             n_tas
+00082fc0: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
+00082fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00082fe0: 2020 2020 202f 2f20 544f 444f 3a20 7573       // TODO: us
+00082ff0: 6520 6469 6666 6572 656e 7420 7363 6865  e different sche
+00083000: 6475 6c69 6e67 2066 6f72 2064 6966 6665  duling for diffe
+00083010: 7265 6e74 206d 6174 7269 7820 7369 7a65  rent matrix size
+00083020: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00083030: 2020 2020 2020 2f2f 636f 6e73 7420 696e        //const in
+00083040: 7420 6e72 3020 3d20 6767 6d6c 5f6e 726f  t nr0 = ggml_nro
+00083050: 7773 286e 6f64 652d 3e73 7263 5b30 5d29  ws(node->src[0])
+00083060: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00083070: 2020 2020 2020 2f2f 636f 6e73 7420 696e        //const in
+00083080: 7420 6e72 3120 3d20 6767 6d6c 5f6e 726f  t nr1 = ggml_nro
+00083090: 7773 286e 6f64 652d 3e73 7263 5b31 5d29  ws(node->src[1])
+000830a0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+000830b0: 2020 2020 2020 202f 2f6e 5f74 6173 6b73         //n_tasks
+000830c0: 203d 204d 494e 286e 5f74 6872 6561 6473   = MIN(n_threads
+000830d0: 2c20 4d41 5828 312c 206e 7230 2f31 3238  , MAX(1, nr0/128
+000830e0: 2929 3b0a 2020 2020 2020 2020 2020 2020  ));.            
+000830f0: 2020 2020 2020 2020 2f2f 7072 696e 7466          //printf
+00083100: 2822 6e72 3020 3d20 2538 642c 206e 7231  ("nr0 = %8d, nr1
+00083110: 203d 2025 3864 2c20 6e72 302a 6e72 3120   = %8d, nr0*nr1 
+00083120: 3d20 2538 642c 206e 5f74 6173 6b73 2564  = %8d, n_tasks%d
+00083130: 5c6e 222c 206e 7230 2c20 6e72 312c 206e  \n", nr0, nr1, n
+00083140: 7230 2a6e 7231 2c20 6e5f 7461 736b 7329  r0*nr1, n_tasks)
+00083150: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00083160: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
+00083170: 7220 3d20 303b 0a20 2020 2020 2020 2020  r = 0;.         
+00083180: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00083190: 2065 6e75 6d20 6767 6d6c 5f74 7970 6520   enum ggml_type 
+000831a0: 7665 635f 646f 745f 7479 7065 203d 2074  vec_dot_type = t
+000831b0: 7970 655f 7472 6169 7473 5b6e 6f64 652d  ype_traits[node-
+000831c0: 3e73 7263 5b30 5d2d 3e74 7970 655d 2e76  >src[0]->type].v
+000831d0: 6563 5f64 6f74 5f74 7970 653b 0a0a 2369  ec_dot_type;..#i
+000831e0: 6620 6465 6669 6e65 6428 4747 4d4c 5f55  f defined(GGML_U
+000831f0: 5345 5f43 5542 4c41 5329 0a20 2020 2020  SE_CUBLAS).     
+00083200: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00083210: 6620 2867 676d 6c5f 6375 6461 5f63 616e  f (ggml_cuda_can
+00083220: 5f6d 756c 5f6d 6174 286e 6f64 652d 3e73  _mul_mat(node->s
+00083230: 7263 5b30 5d2c 206e 6f64 652d 3e73 7263  rc[0], node->src
+00083240: 5b31 5d2c 206e 6f64 6529 2920 7b0a 2020  [1], node)) {.  
+00083250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083260: 2020 2020 2020 6e5f 7461 736b 7320 3d20        n_tasks = 
+00083270: 313b 202f 2f20 544f 444f 3a20 7468 6973  1; // TODO: this
+00083280: 2061 6374 7561 6c6c 7920 6973 2064 6f69   actually is doi
+00083290: 6e67 206e 6f74 6869 6e67 0a20 2020 2020  ng nothing.     
+000832a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000832b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000832c0: 2f2f 2020 2020 2020 2074 6865 2074 6872  //       the thr
+000832d0: 6561 6473 2061 7265 2073 7469 6c6c 2073  eads are still s
+000832e0: 7069 6e6e 696e 670a 2020 2020 2020 2020  pinning.        
+000832f0: 2020 2020 2020 2020 2020 2020 7d20 656c              } el
+00083300: 7365 0a23 656c 6966 2064 6566 696e 6564  se.#elif defined
+00083310: 2847 474d 4c5f 5553 455f 434c 424c 4153  (GGML_USE_CLBLAS
+00083320: 5429 0a20 2020 2020 2020 2020 2020 2020  T).             
+00083330: 2020 2020 2020 2069 6620 2867 676d 6c5f         if (ggml_
+00083340: 636c 5f63 616e 5f6d 756c 5f6d 6174 286e  cl_can_mul_mat(n
+00083350: 6f64 652d 3e73 7263 5b30 5d2c 206e 6f64  ode->src[0], nod
+00083360: 652d 3e73 7263 5b31 5d2c 206e 6f64 6529  e->src[1], node)
+00083370: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00083380: 2020 2020 2020 2020 2020 2020 6e5f 7461              n_ta
+00083390: 736b 7320 3d20 313b 202f 2f20 544f 444f  sks = 1; // TODO
+000833a0: 3a20 7468 6973 2061 6374 7561 6c6c 7920  : this actually 
+000833b0: 6973 2064 6f69 6e67 206e 6f74 6869 6e67  is doing nothing
+000833c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000833d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000833e0: 2020 2020 2020 2f2f 2020 2020 2020 2074        //       t
+000833f0: 6865 2074 6872 6561 6473 2061 7265 2073  he threads are s
+00083400: 7469 6c6c 2073 7069 6e6e 696e 670a 2020  till spinning.  
+00083410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083420: 2020 2020 2020 6375 7220 3d20 6767 6d6c        cur = ggml
+00083430: 5f63 6c5f 6d75 6c5f 6d61 745f 6765 745f  _cl_mul_mat_get_
+00083440: 7773 697a 6528 6e6f 6465 2d3e 7372 635b  wsize(node->src[
+00083450: 305d 2c20 6e6f 6465 2d3e 7372 635b 315d  0], node->src[1]
+00083460: 2c20 6e6f 6465 293b 0a20 2020 2020 2020  , node);.       
+00083470: 2020 2020 2020 2020 2020 2020 207d 2065               } e
+00083480: 6c73 650a 2365 6e64 6966 0a23 6966 2064  lse.#endif.#if d
+00083490: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
+000834a0: 4143 4345 4c45 5241 5445 2920 7c7c 2064  ACCELERATE) || d
+000834b0: 6566 696e 6564 2847 474d 4c5f 5553 455f  efined(GGML_USE_
+000834c0: 4f50 454e 424c 4153 290a 2020 2020 2020  OPENBLAS).      
+000834d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000834e0: 2028 6767 6d6c 5f63 6f6d 7075 7465 5f66   (ggml_compute_f
+000834f0: 6f72 7761 7264 5f6d 756c 5f6d 6174 5f75  orward_mul_mat_u
+00083500: 7365 5f62 6c61 7328 6e6f 6465 2d3e 7372  se_blas(node->sr
+00083510: 635b 305d 2c20 6e6f 6465 2d3e 7372 635b  c[0], node->src[
+00083520: 315d 2c20 6e6f 6465 2929 207b 0a20 2020  1], node)) {.   
+00083530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083540: 2020 2020 206e 5f74 6173 6b73 203d 2031       n_tasks = 1
+00083550: 3b20 2f2f 2054 4f44 4f3a 2074 6869 7320  ; // TODO: this 
+00083560: 6163 7475 616c 6c79 2069 7320 646f 696e  actually is doin
+00083570: 6720 6e6f 7468 696e 670a 2020 2020 2020  g nothing.      
+00083580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083590: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+000835a0: 2f20 2020 2020 2020 7468 6520 7468 7265  /       the thre
+000835b0: 6164 7320 6172 6520 7374 696c 6c20 7370  ads are still sp
+000835c0: 696e 6e69 6e67 0a20 2020 2020 2020 2020  inning.         
+000835d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000835e0: 6620 286e 6f64 652d 3e73 7263 5b30 5d2d  f (node->src[0]-
+000835f0: 3e74 7970 6520 213d 2047 474d 4c5f 5459  >type != GGML_TY
+00083600: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
+00083610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083620: 2020 2020 2020 2f2f 2068 6572 6520 7765        // here we
+00083630: 206e 6565 6420 6d65 6d6f 7279 206a 7573   need memory jus
+00083640: 7420 666f 7220 7369 6e67 6c65 2032 4420  t for single 2D 
+00083650: 6d61 7472 6978 2066 726f 6d20 7372 6330  matrix from src0
+00083660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00083670: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00083680: 203d 2047 474d 4c5f 5459 5045 5f53 495a   = GGML_TYPE_SIZ
+00083690: 455b 4747 4d4c 5f54 5950 455f 4633 325d  E[GGML_TYPE_F32]
+000836a0: 2a28 6e6f 6465 2d3e 7372 635b 305d 2d3e  *(node->src[0]->
+000836b0: 6e65 5b30 5d2a 6e6f 6465 2d3e 7372 635b  ne[0]*node->src[
+000836c0: 305d 2d3e 6e65 5b31 5d29 3b0a 2020 2020  0]->ne[1]);.    
+000836d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000836e0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+000836f0: 2020 2020 2020 2020 2020 7d20 656c 7365            } else
+00083700: 0a23 656e 6469 660a 2020 2020 2020 2020  .#endif.        
+00083710: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00083720: 6e6f 6465 2d3e 7372 635b 315d 2d3e 7479  node->src[1]->ty
+00083730: 7065 2021 3d20 7665 635f 646f 745f 7479  pe != vec_dot_ty
+00083740: 7065 2920 7b0a 2020 2020 2020 2020 2020  pe) {.          
+00083750: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00083760: 7220 3d20 4747 4d4c 5f54 5950 455f 5349  r = GGML_TYPE_SI
+00083770: 5a45 5b76 6563 5f64 6f74 5f74 7970 655d  ZE[vec_dot_type]
+00083780: 2a67 676d 6c5f 6e65 6c65 6d65 6e74 7328  *ggml_nelements(
+00083790: 6e6f 6465 2d3e 7372 635b 315d 292f 4747  node->src[1])/GG
+000837a0: 4d4c 5f42 4c43 4b5f 5349 5a45 5b76 6563  ML_BLCK_SIZE[vec
+000837b0: 5f64 6f74 5f74 7970 655d 3b0a 2020 2020  _dot_type];.    
+000837c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000837d0: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+000837e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000837f0: 2063 7572 203d 2030 3b0a 2020 2020 2020   cur = 0;.      
+00083800: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00083810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00083820: 2020 2020 2077 6f72 6b5f 7369 7a65 203d       work_size =
+00083830: 204d 4158 2877 6f72 6b5f 7369 7a65 2c20   MAX(work_size, 
+00083840: 6375 7229 3b0a 2020 2020 2020 2020 2020  cur);.          
+00083850: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00083860: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00083870: 4747 4d4c 5f4f 505f 5343 414c 453a 0a20  GGML_OP_SCALE:. 
+00083880: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00083890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000838a0: 2020 2020 206e 5f74 6173 6b73 203d 2031       n_tasks = 1
+000838b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000838c0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+000838d0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+000838e0: 5f4f 505f 5345 543a 0a20 2020 2020 2020  _OP_SET:.       
+000838f0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00083900: 505f 434f 4e54 3a0a 2020 2020 2020 2020  P_CONT:.        
+00083910: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00083920: 5f52 4553 4841 5045 3a0a 2020 2020 2020  _RESHAPE:.      
+00083930: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00083940: 4f50 5f56 4945 573a 0a20 2020 2020 2020  OP_VIEW:.       
+00083950: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00083960: 505f 5045 524d 5554 453a 0a20 2020 2020  P_PERMUTE:.     
+00083970: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00083980: 5f4f 505f 5452 414e 5350 4f53 453a 0a20  _OP_TRANSPOSE:. 
+00083990: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+000839a0: 4747 4d4c 5f4f 505f 4745 545f 524f 5753  GGML_OP_GET_ROWS
+000839b0: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
+000839c0: 7365 2047 474d 4c5f 4f50 5f47 4554 5f52  se GGML_OP_GET_R
+000839d0: 4f57 535f 4241 434b 3a0a 2020 2020 2020  OWS_BACK:.      
+000839e0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000839f0: 4f50 5f44 4941 473a 0a20 2020 2020 2020  OP_DIAG:.       
+00083a00: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00083a10: 505f 4449 4147 5f4d 4153 4b5f 5a45 524f  P_DIAG_MASK_ZERO
+00083a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00083a30: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00083a40: 2020 2020 2020 2020 6e5f 7461 736b 7320          n_tasks 
+00083a50: 3d20 313b 0a20 2020 2020 2020 2020 2020  = 1;.           
+00083a60: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00083a70: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00083a80: 474d 4c5f 4f50 5f44 4941 475f 4d41 534b  GML_OP_DIAG_MASK
+00083a90: 5f49 4e46 3a0a 2020 2020 2020 2020 2020  _INF:.          
+00083aa0: 2020 6361 7365 2047 474d 4c5f 4f50 5f53    case GGML_OP_S
+00083ab0: 4f46 545f 4d41 583a 0a20 2020 2020 2020  OFT_MAX:.       
+00083ac0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+00083ad0: 505f 534f 4654 5f4d 4158 5f42 4143 4b3a  P_SOFT_MAX_BACK:
+00083ae0: 0a20 2020 2020 2020 2020 2020 2063 6173  .            cas
+00083af0: 6520 4747 4d4c 5f4f 505f 524f 5045 3a0a  e GGML_OP_ROPE:.
+00083b00: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00083b10: 2047 474d 4c5f 4f50 5f52 4f50 455f 4241   GGML_OP_ROPE_BA
+00083b20: 434b 3a0a 2020 2020 2020 2020 2020 2020  CK:.            
+00083b30: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00083b40: 2020 2020 2020 2020 2020 6e5f 7461 736b            n_task
+00083b50: 7320 3d20 6e5f 7468 7265 6164 733b 0a20  s = n_threads;. 
+00083b60: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00083b70: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00083b80: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00083b90: 5f41 4c49 4249 3a0a 2020 2020 2020 2020  _ALIBI:.        
+00083ba0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00083bb0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+00083bc0: 7461 736b 7320 3d20 313b 202f 2f54 4f44  tasks = 1; //TOD
+00083bd0: 4f0a 2020 2020 2020 2020 2020 2020 2020  O.              
+00083be0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00083bf0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00083c00: 5f4f 505f 434c 414d 503a 0a20 2020 2020  _OP_CLAMP:.     
+00083c10: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00083c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083c30: 206e 5f74 6173 6b73 203d 2031 3b20 2f2f   n_tasks = 1; //
+00083c40: 544f 444f 0a20 2020 2020 2020 2020 2020  TODO.           
+00083c50: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00083c60: 2020 2020 2020 2020 2020 6361 7365 2047            case G
+00083c70: 474d 4c5f 4f50 5f43 4f4e 565f 3144 3a0a  GML_OP_CONV_1D:.
+00083c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083c90: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00083ca0: 2020 2020 2020 6e5f 7461 736b 7320 3d20        n_tasks = 
+00083cb0: 6e5f 7468 7265 6164 733b 0a0a 2020 2020  n_threads;..    
+00083cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083cd0: 4747 4d4c 5f41 5353 4552 5428 6e6f 6465  GGML_ASSERT(node
+00083ce0: 2d3e 7372 635b 305d 2d3e 6e65 5b33 5d20  ->src[0]->ne[3] 
+00083cf0: 3d3d 2031 293b 0a20 2020 2020 2020 2020  == 1);.         
+00083d00: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00083d10: 4153 5345 5254 286e 6f64 652d 3e73 7263  ASSERT(node->src
+00083d20: 5b31 5d2d 3e6e 655b 325d 203d 3d20 3129  [1]->ne[2] == 1)
+00083d30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00083d40: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00083d50: 5428 6e6f 6465 2d3e 7372 635b 315d 2d3e  T(node->src[1]->
+00083d60: 6e65 5b33 5d20 3d3d 2031 293b 0a0a 2020  ne[3] == 1);..  
+00083d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083d80: 2020 7369 7a65 5f74 2063 7572 203d 2030    size_t cur = 0
+00083d90: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00083da0: 2020 2020 2020 636f 6e73 7420 696e 7420        const int 
+00083db0: 6e6b 203d 206e 6f64 652d 3e73 7263 5b30  nk = node->src[0
+00083dc0: 5d2d 3e6e 655b 305d 3b0a 0a20 2020 2020  ]->ne[0];..     
+00083dd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00083de0: 6620 286e 6f64 652d 3e73 7263 5b30 5d2d  f (node->src[0]-
+00083df0: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00083e00: 5045 5f46 3136 2026 260a 2020 2020 2020  PE_F16 &&.      
+00083e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083e20: 2020 2020 2020 6e6f 6465 2d3e 7372 635b        node->src[
+00083e30: 315d 2d3e 7479 7065 203d 3d20 4747 4d4c  1]->type == GGML
+00083e40: 5f54 5950 455f 4633 3229 207b 0a20 2020  _TYPE_F32) {.   
+00083e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083e60: 2020 2020 2063 7572 203d 2073 697a 656f       cur = sizeo
+00083e70: 6628 6767 6d6c 5f66 7031 365f 7429 2a28  f(ggml_fp16_t)*(
+00083e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00083e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083ea0: 206e 6b2a 6767 6d6c 5f75 7033 3228 6e6f   nk*ggml_up32(no
+00083eb0: 6465 2d3e 7372 635b 305d 2d3e 6e65 5b31  de->src[0]->ne[1
+00083ec0: 5d29 2a6e 6f64 652d 3e73 7263 5b30 5d2d  ])*node->src[0]-
+00083ed0: 3e6e 655b 325d 202b 0a20 2020 2020 2020  >ne[2] +.       
+00083ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083ef0: 2020 2020 2020 2020 2028 2032 2a28 6e6b           ( 2*(nk
+00083f00: 2f32 2920 2b20 6e6f 6465 2d3e 7372 635b  /2) + node->src[
+00083f10: 315d 2d3e 6e65 5b30 5d29 2a6e 6f64 652d  1]->ne[0])*node-
+00083f20: 3e73 7263 5b31 5d2d 3e6e 655b 315d 0a20  >src[1]->ne[1]. 
+00083f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083f40: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00083f50: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00083f60: 2020 2020 2020 7d20 656c 7365 2069 6620        } else if 
+00083f70: 286e 6f64 652d 3e73 7263 5b30 5d2d 3e74  (node->src[0]->t
+00083f80: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+00083f90: 5f46 3332 2026 260a 2020 2020 2020 2020  _F32 &&.        
+00083fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083fb0: 2020 2020 6e6f 6465 2d3e 7372 635b 315d      node->src[1]
+00083fc0: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00083fd0: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
+00083fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00083ff0: 2020 2063 7572 203d 2073 697a 656f 6628     cur = sizeof(
+00084000: 666c 6f61 7429 2a28 0a20 2020 2020 2020  float)*(.       
+00084010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084020: 2020 2020 2020 2020 206e 6b2a 6767 6d6c           nk*ggml
+00084030: 5f75 7033 3228 6e6f 6465 2d3e 7372 635b  _up32(node->src[
+00084040: 305d 2d3e 6e65 5b31 5d29 2a6e 6f64 652d  0]->ne[1])*node-
+00084050: 3e73 7263 5b30 5d2d 3e6e 655b 325d 202b  >src[0]->ne[2] +
+00084060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00084070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084080: 2028 2032 2a28 6e6b 2f32 2920 2b20 6e6f   ( 2*(nk/2) + no
+00084090: 6465 2d3e 7372 635b 315d 2d3e 6e65 5b30  de->src[1]->ne[0
+000840a0: 5d29 2a6e 6f64 652d 3e73 7263 5b31 5d2d  ])*node->src[1]-
+000840b0: 3e6e 655b 315d 0a20 2020 2020 2020 2020  >ne[1].         
+000840c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000840d0: 2020 2020 2020 2029 3b0a 2020 2020 2020         );.      
+000840e0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+000840f0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+00084100: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+00084110: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00084120: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00084130: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00084140: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+00084150: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
+00084160: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
+00084170: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00084180: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00084190: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000841a0: 5f43 4f4e 565f 3244 3a0a 2020 2020 2020  _CONV_2D:.      
+000841b0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000841c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000841d0: 6e5f 7461 736b 7320 3d20 6e5f 7468 7265  n_tasks = n_thre
+000841e0: 6164 733b 0a0a 2020 2020 2020 2020 2020  ads;..          
+000841f0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00084200: 696e 7436 345f 7420 6e65 3030 203d 206e  int64_t ne00 = n
+00084210: 6f64 652d 3e73 7263 5b30 5d2d 3e6e 655b  ode->src[0]->ne[
+00084220: 305d 3b20 2f2f 2057 0a20 2020 2020 2020  0]; // W.       
+00084230: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00084240: 7374 2069 6e74 3634 5f74 206e 6530 3120  st int64_t ne01 
+00084250: 3d20 6e6f 6465 2d3e 7372 635b 305d 2d3e  = node->src[0]->
+00084260: 6e65 5b31 5d3b 202f 2f20 480a 2020 2020  ne[1]; // H.    
+00084270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084280: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+00084290: 3032 203d 206e 6f64 652d 3e73 7263 5b30  02 = node->src[0
+000842a0: 5d2d 3e6e 655b 325d 3b20 2f2f 2043 0a20  ]->ne[2]; // C. 
+000842b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000842c0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
+000842d0: 206e 6530 3320 3d20 6e6f 6465 2d3e 7372   ne03 = node->sr
+000842e0: 635b 305d 2d3e 6e65 5b33 5d3b 202f 2f20  c[0]->ne[3]; // 
+000842f0: 4e0a 0a20 2020 2020 2020 2020 2020 2020  N..             
+00084300: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00084310: 3634 5f74 206e 6531 3020 3d20 6e6f 6465  64_t ne10 = node
+00084320: 2d3e 7372 635b 315d 2d3e 6e65 5b30 5d3b  ->src[1]->ne[0];
+00084330: 202f 2f20 570a 2020 2020 2020 2020 2020   // W.          
+00084340: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00084350: 696e 7436 345f 7420 6e65 3131 203d 206e  int64_t ne11 = n
+00084360: 6f64 652d 3e73 7263 5b31 5d2d 3e6e 655b  ode->src[1]->ne[
+00084370: 315d 3b20 2f2f 2048 0a20 2020 2020 2020  1]; // H.       
+00084380: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00084390: 7374 2069 6e74 3634 5f74 206e 6531 3220  st int64_t ne12 
+000843a0: 3d20 6e6f 6465 2d3e 7372 635b 315d 2d3e  = node->src[1]->
+000843b0: 6e65 5b32 5d3b 202f 2f20 430a 0a20 2020  ne[2]; // C..   
+000843c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000843d0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+000843e0: 6530 203d 206e 6f64 652d 3e6e 655b 305d  e0 = node->ne[0]
+000843f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00084400: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
+00084410: 345f 7420 6e65 3120 3d20 6e6f 6465 2d3e  4_t ne1 = node->
+00084420: 6e65 5b31 5d3b 0a20 2020 2020 2020 2020  ne[1];.         
+00084430: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00084440: 2069 6e74 3634 5f74 206e 6532 203d 206e   int64_t ne2 = n
+00084450: 6f64 652d 3e6e 655b 325d 3b0a 2020 2020  ode->ne[2];.    
 00084460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084470: 2020 206e 6f64 652d 3e73 7263 5b31 5d2d     node->src[1]-
-00084480: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
-00084490: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
-000844a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000844b0: 2020 6375 7220 3d20 7369 7a65 6f66 2867    cur = sizeof(g
-000844c0: 676d 6c5f 6670 3136 5f74 292a 286e 6531  gml_fp16_t)*(ne1
-000844d0: 302a 6e65 3131 2a6e 6531 3229 3b0a 2020  0*ne11*ne12);.  
-000844e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000844f0: 2020 7d20 656c 7365 2069 6620 286e 6f64    } else if (nod
-00084500: 652d 3e73 7263 5b30 5d2d 3e74 7970 6520  e->src[0]->type 
-00084510: 3d3d 2047 474d 4c5f 5459 5045 5f46 3332  == GGML_TYPE_F32
-00084520: 2026 260a 2020 2020 2020 2020 2020 2020   &&.            
-00084530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084540: 6e6f 6465 2d3e 7372 635b 315d 2d3e 7479  node->src[1]->ty
-00084550: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
-00084560: 4633 3229 207b 0a20 2020 2020 2020 2020  F32) {.         
-00084570: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00084580: 7572 203d 2073 697a 656f 6628 666c 6f61  ur = sizeof(floa
-00084590: 7429 2a20 2020 2020 2028 6e65 3130 2a6e  t)*      (ne10*n
-000845a0: 6531 312a 6e65 3132 293b 0a20 2020 2020  e11*ne12);.     
-000845b0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-000845c0: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
-000845d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000845e0: 4747 4d4c 5f41 5353 4552 5428 6661 6c73  GGML_ASSERT(fals
-000845f0: 6529 3b0a 2020 2020 2020 2020 2020 2020  e);.            
-00084600: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00084610: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00084620: 6f72 6b5f 7369 7a65 203d 204d 4158 2877  ork_size = MAX(w
-00084630: 6f72 6b5f 7369 7a65 2c20 6375 7229 3b0a  ork_size, cur);.
-00084640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084650: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00084660: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00084670: 505f 504f 4f4c 5f31 443a 0a20 2020 2020  P_POOL_1D:.     
-00084680: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00084690: 5f4f 505f 504f 4f4c 5f32 443a 0a20 2020  _OP_POOL_2D:.   
-000846a0: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-000846b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000846c0: 2020 206e 5f74 6173 6b73 203d 2031 3b0a     n_tasks = 1;.
-000846d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000846e0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000846f0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00084700: 505f 464c 4153 485f 4154 544e 3a0a 2020  P_FLASH_ATTN:.  
-00084710: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00084720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084730: 2020 2020 6e5f 7461 736b 7320 3d20 6e5f      n_tasks = n_
-00084740: 7468 7265 6164 733b 0a0a 2020 2020 2020  threads;..      
-00084750: 2020 2020 2020 2020 2020 2020 2020 7369                si
-00084760: 7a65 5f74 2063 7572 203d 2030 3b0a 0a20  ze_t cur = 0;.. 
-00084770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084780: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00084790: 206e 6531 3120 3d20 6767 6d6c 5f75 7028   ne11 = ggml_up(
-000847a0: 6e6f 6465 2d3e 7372 635b 315d 2d3e 6e65  node->src[1]->ne
-000847b0: 5b31 5d2c 2047 474d 4c5f 534f 4654 5f4d  [1], GGML_SOFT_M
-000847c0: 4158 5f55 4e52 4f4c 4c29 3b0a 0a20 2020  AX_UNROLL);..   
-000847d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000847e0: 2069 6620 286e 6f64 652d 3e73 7263 5b31   if (node->src[1
-000847f0: 5d2d 3e74 7970 6520 3d3d 2047 474d 4c5f  ]->type == GGML_
-00084800: 5459 5045 5f46 3332 2920 7b0a 2020 2020  TYPE_F32) {.    
-00084810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084820: 2020 2020 6375 7220 203d 2073 697a 656f      cur  = sizeo
-00084830: 6628 666c 6f61 7429 2a6e 6531 312a 6e5f  f(float)*ne11*n_
-00084840: 7461 736b 733b 202f 2f20 544f 444f 3a20  tasks; // TODO: 
-00084850: 7468 6973 2063 616e 2062 6563 6f6d 6520  this can become 
-00084860: 286e 5f74 6173 6b73 2d31 290a 2020 2020  (n_tasks-1).    
-00084870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084880: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
-00084890: 6628 666c 6f61 7429 2a6e 6531 312a 6e5f  f(float)*ne11*n_
-000848a0: 7461 736b 733b 202f 2f20 7468 6973 2069  tasks; // this i
-000848b0: 7320 6f76 6572 6573 7469 6d61 7465 6420  s overestimated 
-000848c0: 6279 2078 320a 2020 2020 2020 2020 2020  by x2.          
-000848d0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00084470: 636f 6e73 7420 696e 7436 345f 7420 6e6b  const int64_t nk
+00084480: 203d 206e 6530 302a 6e65 3031 3b0a 2020   = ne00*ne01;.  
+00084490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000844a0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+000844b0: 6577 3020 3d20 6e6b 202a 206e 6530 323b  ew0 = nk * ne02;
+000844c0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000844d0: 2020 2020 2020 554e 5553 4544 286e 6530        UNUSED(ne0
+000844e0: 3329 3b0a 2020 2020 2020 2020 2020 2020  3);.            
+000844f0: 2020 2020 2020 2020 554e 5553 4544 286e          UNUSED(n
+00084500: 6532 293b 0a0a 2020 2020 2020 2020 2020  e2);..          
+00084510: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
+00084520: 2063 7572 203d 2030 3b0a 0a20 2020 2020   cur = 0;..     
+00084530: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00084540: 6620 286e 6f64 652d 3e73 7263 5b30 5d2d  f (node->src[0]-
+00084550: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00084560: 5045 5f46 3136 2026 260a 2020 2020 2020  PE_F16 &&.      
+00084570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084580: 2020 6e6f 6465 2d3e 7372 635b 315d 2d3e    node->src[1]->
+00084590: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
+000845a0: 455f 4633 3229 207b 0a20 2020 2020 2020  E_F32) {.       
+000845b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000845c0: 2063 7572 203d 2073 697a 656f 6628 6767   cur = sizeof(gg
+000845d0: 6d6c 5f66 7031 365f 7429 2a28 6e65 302a  ml_fp16_t)*(ne0*
+000845e0: 6e65 312a 6577 3029 3b0a 2020 2020 2020  ne1*ew0);.      
+000845f0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+00084600: 656c 7365 2069 6620 286e 6f64 652d 3e73  else if (node->s
+00084610: 7263 5b30 5d2d 3e74 7970 6520 3d3d 2047  rc[0]->type == G
+00084620: 474d 4c5f 5459 5045 5f46 3332 2026 260a  GML_TYPE_F32 &&.
+00084630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084640: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00084650: 6f64 652d 3e73 7263 5b31 5d2d 3e74 7970  ode->src[1]->typ
+00084660: 6520 3d3d 2047 474d 4c5f 5459 5045 5f46  e == GGML_TYPE_F
+00084670: 3332 2920 7b0a 2020 2020 2020 2020 2020  32) {.          
+00084680: 2020 2020 2020 2020 2020 2020 2020 6375                cu
+00084690: 7220 3d20 7369 7a65 6f66 2866 6c6f 6174  r = sizeof(float
+000846a0: 292a 2020 2020 2020 286e 6531 302a 6e65  )*      (ne10*ne
+000846b0: 3131 2a6e 6531 3229 3b0a 2020 2020 2020  11*ne12);.      
+000846c0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+000846d0: 656c 7365 207b 0a20 2020 2020 2020 2020  else {.         
+000846e0: 2020 2020 2020 2020 2020 2020 2020 2047                 G
+000846f0: 474d 4c5f 4153 5345 5254 2866 616c 7365  GML_ASSERT(false
+00084700: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00084710: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00084720: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+00084730: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
+00084740: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
+00084750: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00084760: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00084770: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00084780: 5f50 4f4f 4c5f 3144 3a0a 2020 2020 2020  _POOL_1D:.      
+00084790: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+000847a0: 4f50 5f50 4f4f 4c5f 3244 3a0a 2020 2020  OP_POOL_2D:.    
+000847b0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000847c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000847d0: 2020 6e5f 7461 736b 7320 3d20 313b 0a20    n_tasks = 1;. 
+000847e0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000847f0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00084800: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00084810: 5f46 4c41 5348 5f41 5454 4e3a 0a20 2020  _FLASH_ATTN:.   
+00084820: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00084830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084840: 2020 206e 5f74 6173 6b73 203d 206e 5f74     n_tasks = n_t
+00084850: 6872 6561 6473 3b0a 0a20 2020 2020 2020  hreads;..       
+00084860: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+00084870: 655f 7420 6375 7220 3d20 303b 0a0a 2020  e_t cur = 0;..  
+00084880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084890: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+000848a0: 6e65 3131 203d 2067 676d 6c5f 7570 286e  ne11 = ggml_up(n
+000848b0: 6f64 652d 3e73 7263 5b31 5d2d 3e6e 655b  ode->src[1]->ne[
+000848c0: 315d 2c20 4747 4d4c 5f53 4f46 545f 4d41  1], GGML_SOFT_MA
+000848d0: 585f 554e 524f 4c4c 293b 0a0a 2020 2020  X_UNROLL);..    
 000848e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000848f0: 2069 6620 286e 6f64 652d 3e73 7263 5b31   if (node->src[1
-00084900: 5d2d 3e74 7970 6520 3d3d 2047 474d 4c5f  ]->type == GGML_
-00084910: 5459 5045 5f46 3136 2920 7b0a 2020 2020  TYPE_F16) {.    
+000848f0: 6966 2028 6e6f 6465 2d3e 7372 635b 315d  if (node->src[1]
+00084900: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00084910: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
 00084920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084930: 2020 2020 6375 7220 203d 2073 697a 656f      cur  = sizeo
-00084940: 6628 666c 6f61 7429 2a6e 6531 312a 6e5f  f(float)*ne11*n_
-00084950: 7461 736b 733b 202f 2f20 544f 444f 3a20  tasks; // TODO: 
-00084960: 7468 6973 2063 616e 2062 6563 6f6d 6520  this can become 
-00084970: 286e 5f74 6173 6b73 2d31 290a 2020 2020  (n_tasks-1).    
+00084930: 2020 2063 7572 2020 3d20 7369 7a65 6f66     cur  = sizeof
+00084940: 2866 6c6f 6174 292a 6e65 3131 2a6e 5f74  (float)*ne11*n_t
+00084950: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
+00084960: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
+00084970: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
 00084980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084990: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
-000849a0: 6628 666c 6f61 7429 2a6e 6531 312a 6e5f  f(float)*ne11*n_
-000849b0: 7461 736b 733b 202f 2f20 7468 6973 2069  tasks; // this i
-000849c0: 7320 6f76 6572 6573 7469 6d61 7465 6420  s overestimated 
-000849d0: 6279 2078 320a 2020 2020 2020 2020 2020  by x2.          
-000849e0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00084990: 2020 2063 7572 202b 3d20 7369 7a65 6f66     cur += sizeof
+000849a0: 2866 6c6f 6174 292a 6e65 3131 2a6e 5f74  (float)*ne11*n_t
+000849b0: 6173 6b73 3b20 2f2f 2074 6869 7320 6973  asks; // this is
+000849c0: 206f 7665 7265 7374 696d 6174 6564 2062   overestimated b
+000849d0: 7920 7832 0a20 2020 2020 2020 2020 2020  y x2.           
+000849e0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
 000849f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084a00: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
-00084a10: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
-00084a20: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00084a30: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-00084a40: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00084a50: 5f4f 505f 464c 4153 485f 4646 3a0a 2020  _OP_FLASH_FF:.  
-00084a60: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00084a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084a80: 2020 2020 6e5f 7461 736b 7320 3d20 6e5f      n_tasks = n_
-00084a90: 7468 7265 6164 733b 0a0a 2020 2020 2020  threads;..      
-00084aa0: 2020 2020 2020 2020 2020 2020 2020 7369                si
-00084ab0: 7a65 5f74 2063 7572 203d 2030 3b0a 0a20  ze_t cur = 0;.. 
-00084ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084ad0: 2020 2069 6620 286e 6f64 652d 3e73 7263     if (node->src
-00084ae0: 5b31 5d2d 3e74 7970 6520 3d3d 2047 474d  [1]->type == GGM
-00084af0: 4c5f 5459 5045 5f46 3332 2920 7b0a 2020  L_TYPE_F32) {.  
+00084a00: 6966 2028 6e6f 6465 2d3e 7372 635b 315d  if (node->src[1]
+00084a10: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00084a20: 5950 455f 4631 3629 207b 0a20 2020 2020  YPE_F16) {.     
+00084a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084a40: 2020 2063 7572 2020 3d20 7369 7a65 6f66     cur  = sizeof
+00084a50: 2866 6c6f 6174 292a 6e65 3131 2a6e 5f74  (float)*ne11*n_t
+00084a60: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
+00084a70: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
+00084a80: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
+00084a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084aa0: 2020 2063 7572 202b 3d20 7369 7a65 6f66     cur += sizeof
+00084ab0: 2866 6c6f 6174 292a 6e65 3131 2a6e 5f74  (float)*ne11*n_t
+00084ac0: 6173 6b73 3b20 2f2f 2074 6869 7320 6973  asks; // this is
+00084ad0: 206f 7665 7265 7374 696d 6174 6564 2062   overestimated b
+00084ae0: 7920 7832 0a20 2020 2020 2020 2020 2020  y x2.           
+00084af0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
 00084b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084b10: 2020 2020 2020 6375 7220 203d 2073 697a        cur  = siz
-00084b20: 656f 6628 666c 6f61 7429 2a6e 6f64 652d  eof(float)*node-
-00084b30: 3e73 7263 5b31 5d2d 3e6e 655b 315d 2a6e  >src[1]->ne[1]*n
-00084b40: 5f74 6173 6b73 3b20 2f2f 2054 4f44 4f3a  _tasks; // TODO:
-00084b50: 2074 6869 7320 6361 6e20 6265 636f 6d65   this can become
-00084b60: 2028 6e5f 7461 736b 732d 3129 0a20 2020   (n_tasks-1).   
-00084b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084b80: 2020 2020 2063 7572 202b 3d20 7369 7a65       cur += size
-00084b90: 6f66 2866 6c6f 6174 292a 6e6f 6465 2d3e  of(float)*node->
-00084ba0: 7372 635b 315d 2d3e 6e65 5b31 5d2a 6e5f  src[1]->ne[1]*n_
-00084bb0: 7461 736b 733b 202f 2f20 7468 6973 2069  tasks; // this i
-00084bc0: 7320 6f76 6572 6573 7469 6d61 7465 6420  s overestimated 
-00084bd0: 6279 2078 320a 2020 2020 2020 2020 2020  by x2.          
-00084be0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00084bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084c00: 2069 6620 286e 6f64 652d 3e73 7263 5b31   if (node->src[1
-00084c10: 5d2d 3e74 7970 6520 3d3d 2047 474d 4c5f  ]->type == GGML_
-00084c20: 5459 5045 5f46 3136 2920 7b0a 2020 2020  TYPE_F16) {.    
-00084c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084c40: 2020 2020 6375 7220 203d 2073 697a 656f      cur  = sizeo
-00084c50: 6628 666c 6f61 7429 2a6e 6f64 652d 3e73  f(float)*node->s
-00084c60: 7263 5b31 5d2d 3e6e 655b 315d 2a6e 5f74  rc[1]->ne[1]*n_t
-00084c70: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
-00084c80: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
-00084c90: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
-00084ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084cb0: 2020 2063 7572 202b 3d20 7369 7a65 6f66     cur += sizeof
-00084cc0: 2866 6c6f 6174 292a 6e6f 6465 2d3e 7372  (float)*node->sr
-00084cd0: 635b 315d 2d3e 6e65 5b31 5d2a 6e5f 7461  c[1]->ne[1]*n_ta
-00084ce0: 736b 733b 202f 2f20 7468 6973 2069 7320  sks; // this is 
-00084cf0: 6f76 6572 6573 7469 6d61 7465 6420 6279  overestimated by
-00084d00: 2078 320a 2020 2020 2020 2020 2020 2020   x2.            
-00084d10: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00084d20: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00084d30: 6f72 6b5f 7369 7a65 203d 204d 4158 2877  ork_size = MAX(w
-00084d40: 6f72 6b5f 7369 7a65 2c20 6375 7229 3b0a  ork_size, cur);.
-00084d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084d60: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00084d70: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-00084d80: 505f 464c 4153 485f 4154 544e 5f42 4143  P_FLASH_ATTN_BAC
-00084d90: 4b3a 0a20 2020 2020 2020 2020 2020 2020  K:.             
-00084da0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00084db0: 2020 2020 2020 2020 206e 5f74 6173 6b73           n_tasks
-00084dc0: 203d 206e 5f74 6872 6561 6473 3b0a 0a20   = n_threads;.. 
-00084dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084de0: 2020 2073 697a 655f 7420 6375 7220 3d20     size_t cur = 
-00084df0: 303b 0a0a 2020 2020 2020 2020 2020 2020  0;..            
-00084e00: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-00084e10: 7436 345f 7420 2020 2044 203d 206e 6f64  t64_t    D = nod
-00084e20: 652d 3e73 7263 5b30 5d2d 3e6e 655b 305d  e->src[0]->ne[0]
-00084e30: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00084e40: 2020 2020 2020 636f 6e73 7420 696e 7436        const int6
-00084e50: 345f 7420 6e65 3131 203d 2067 676d 6c5f  4_t ne11 = ggml_
-00084e60: 7570 286e 6f64 652d 3e73 7263 5b31 5d2d  up(node->src[1]-
-00084e70: 3e6e 655b 315d 2c20 4747 4d4c 5f53 4f46  >ne[1], GGML_SOF
-00084e80: 545f 4d41 585f 554e 524f 4c4c 293b 0a20  T_MAX_UNROLL);. 
-00084e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084ea0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00084eb0: 206d 7844 6e20 3d20 4d41 5828 442c 206e   mxDn = MAX(D, n
-00084ec0: 6531 3129 202a 2032 3b20 2f2f 202a 3220  e11) * 2; // *2 
-00084ed0: 6265 6361 7573 6520 6f66 2053 2061 6e64  because of S and
-00084ee0: 2053 4d20 696e 2067 676d 6c5f 636f 6d70   SM in ggml_comp
-00084ef0: 7574 655f 666f 7277 6172 645f 666c 6173  ute_forward_flas
-00084f00: 685f 6174 746e 5f62 6163 6b0a 2020 2020  h_attn_back.    
-00084f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084f20: 6966 2028 6e6f 6465 2d3e 7372 635b 315d  if (node->src[1]
-00084f30: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00084f40: 5950 455f 4633 3229 207b 0a20 2020 2020  YPE_F32) {.     
-00084f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084f60: 2020 2063 7572 2020 3d20 7369 7a65 6f66     cur  = sizeof
-00084f70: 2866 6c6f 6174 292a 6d78 446e 2a6e 5f74  (float)*mxDn*n_t
-00084f80: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
-00084f90: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
-00084fa0: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
-00084fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00084fc0: 2020 2063 7572 202b 3d20 7369 7a65 6f66     cur += sizeof
-00084fd0: 2866 6c6f 6174 292a 6d78 446e 2a6e 5f74  (float)*mxDn*n_t
-00084fe0: 6173 6b73 3b20 2f2f 2074 6869 7320 6973  asks; // this is
-00084ff0: 206f 7665 7265 7374 696d 6174 6564 2062   overestimated b
-00085000: 7920 7832 0a20 2020 2020 2020 2020 2020  y x2.           
-00085010: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00085020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085030: 6966 2028 6e6f 6465 2d3e 7372 635b 315d  if (node->src[1]
-00085040: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
-00085050: 5950 455f 4631 3629 207b 0a20 2020 2020  YPE_F16) {.     
+00084b10: 776f 726b 5f73 697a 6520 3d20 4d41 5828  work_size = MAX(
+00084b20: 776f 726b 5f73 697a 652c 2063 7572 293b  work_size, cur);
+00084b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00084b40: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+00084b50: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00084b60: 4f50 5f46 4c41 5348 5f46 463a 0a20 2020  OP_FLASH_FF:.   
+00084b70: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+00084b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084b90: 2020 206e 5f74 6173 6b73 203d 206e 5f74     n_tasks = n_t
+00084ba0: 6872 6561 6473 3b0a 0a20 2020 2020 2020  hreads;..       
+00084bb0: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+00084bc0: 655f 7420 6375 7220 3d20 303b 0a0a 2020  e_t cur = 0;..  
+00084bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084be0: 2020 6966 2028 6e6f 6465 2d3e 7372 635b    if (node->src[
+00084bf0: 315d 2d3e 7479 7065 203d 3d20 4747 4d4c  1]->type == GGML
+00084c00: 5f54 5950 455f 4633 3229 207b 0a20 2020  _TYPE_F32) {.   
+00084c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084c20: 2020 2020 2063 7572 2020 3d20 7369 7a65       cur  = size
+00084c30: 6f66 2866 6c6f 6174 292a 6e6f 6465 2d3e  of(float)*node->
+00084c40: 7372 635b 315d 2d3e 6e65 5b31 5d2a 6e5f  src[1]->ne[1]*n_
+00084c50: 7461 736b 733b 202f 2f20 544f 444f 3a20  tasks; // TODO: 
+00084c60: 7468 6973 2063 616e 2062 6563 6f6d 6520  this can become 
+00084c70: 286e 5f74 6173 6b73 2d31 290a 2020 2020  (n_tasks-1).    
+00084c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084c90: 2020 2020 6375 7220 2b3d 2073 697a 656f      cur += sizeo
+00084ca0: 6628 666c 6f61 7429 2a6e 6f64 652d 3e73  f(float)*node->s
+00084cb0: 7263 5b31 5d2d 3e6e 655b 315d 2a6e 5f74  rc[1]->ne[1]*n_t
+00084cc0: 6173 6b73 3b20 2f2f 2074 6869 7320 6973  asks; // this is
+00084cd0: 206f 7665 7265 7374 696d 6174 6564 2062   overestimated b
+00084ce0: 7920 7832 0a20 2020 2020 2020 2020 2020  y x2.           
+00084cf0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00084d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084d10: 6966 2028 6e6f 6465 2d3e 7372 635b 315d  if (node->src[1]
+00084d20: 2d3e 7479 7065 203d 3d20 4747 4d4c 5f54  ->type == GGML_T
+00084d30: 5950 455f 4631 3629 207b 0a20 2020 2020  YPE_F16) {.     
+00084d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084d50: 2020 2063 7572 2020 3d20 7369 7a65 6f66     cur  = sizeof
+00084d60: 2866 6c6f 6174 292a 6e6f 6465 2d3e 7372  (float)*node->sr
+00084d70: 635b 315d 2d3e 6e65 5b31 5d2a 6e5f 7461  c[1]->ne[1]*n_ta
+00084d80: 736b 733b 202f 2f20 544f 444f 3a20 7468  sks; // TODO: th
+00084d90: 6973 2063 616e 2062 6563 6f6d 6520 286e  is can become (n
+00084da0: 5f74 6173 6b73 2d31 290a 2020 2020 2020  _tasks-1).      
+00084db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084dc0: 2020 6375 7220 2b3d 2073 697a 656f 6628    cur += sizeof(
+00084dd0: 666c 6f61 7429 2a6e 6f64 652d 3e73 7263  float)*node->src
+00084de0: 5b31 5d2d 3e6e 655b 315d 2a6e 5f74 6173  [1]->ne[1]*n_tas
+00084df0: 6b73 3b20 2f2f 2074 6869 7320 6973 206f  ks; // this is o
+00084e00: 7665 7265 7374 696d 6174 6564 2062 7920  verestimated by 
+00084e10: 7832 0a20 2020 2020 2020 2020 2020 2020  x2.             
+00084e20: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00084e30: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+00084e40: 726b 5f73 697a 6520 3d20 4d41 5828 776f  rk_size = MAX(wo
+00084e50: 726b 5f73 697a 652c 2063 7572 293b 0a20  rk_size, cur);. 
+00084e60: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00084e70: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00084e80: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+00084e90: 5f46 4c41 5348 5f41 5454 4e5f 4241 434b  _FLASH_ATTN_BACK
+00084ea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00084eb0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00084ec0: 2020 2020 2020 2020 6e5f 7461 736b 7320          n_tasks 
+00084ed0: 3d20 6e5f 7468 7265 6164 733b 0a0a 2020  = n_threads;..  
+00084ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084ef0: 2020 7369 7a65 5f74 2063 7572 203d 2030    size_t cur = 0
+00084f00: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00084f10: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+00084f20: 3634 5f74 2020 2020 4420 3d20 6e6f 6465  64_t    D = node
+00084f30: 2d3e 7372 635b 305d 2d3e 6e65 5b30 5d3b  ->src[0]->ne[0];
+00084f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00084f50: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
+00084f60: 5f74 206e 6531 3120 3d20 6767 6d6c 5f75  _t ne11 = ggml_u
+00084f70: 7028 6e6f 6465 2d3e 7372 635b 315d 2d3e  p(node->src[1]->
+00084f80: 6e65 5b31 5d2c 2047 474d 4c5f 534f 4654  ne[1], GGML_SOFT
+00084f90: 5f4d 4158 5f55 4e52 4f4c 4c29 3b0a 2020  _MAX_UNROLL);.  
+00084fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00084fb0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00084fc0: 6d78 446e 203d 204d 4158 2844 2c20 6e65  mxDn = MAX(D, ne
+00084fd0: 3131 2920 2a20 323b 202f 2f20 2a32 2062  11) * 2; // *2 b
+00084fe0: 6563 6175 7365 206f 6620 5320 616e 6420  ecause of S and 
+00084ff0: 534d 2069 6e20 6767 6d6c 5f63 6f6d 7075  SM in ggml_compu
+00085000: 7465 5f66 6f72 7761 7264 5f66 6c61 7368  te_forward_flash
+00085010: 5f61 7474 6e5f 6261 636b 0a20 2020 2020  _attn_back.     
+00085020: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00085030: 6620 286e 6f64 652d 3e73 7263 5b31 5d2d  f (node->src[1]-
+00085040: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00085050: 5045 5f46 3332 2920 7b0a 2020 2020 2020  PE_F32) {.      
 00085060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085070: 2020 2063 7572 2020 3d20 7369 7a65 6f66     cur  = sizeof
-00085080: 2866 6c6f 6174 292a 6d78 446e 2a6e 5f74  (float)*mxDn*n_t
-00085090: 6173 6b73 3b20 2f2f 2054 4f44 4f3a 2074  asks; // TODO: t
-000850a0: 6869 7320 6361 6e20 6265 636f 6d65 2028  his can become (
-000850b0: 6e5f 7461 736b 732d 3129 0a20 2020 2020  n_tasks-1).     
+00085070: 2020 6375 7220 203d 2073 697a 656f 6628    cur  = sizeof(
+00085080: 666c 6f61 7429 2a6d 7844 6e2a 6e5f 7461  float)*mxDn*n_ta
+00085090: 736b 733b 202f 2f20 544f 444f 3a20 7468  sks; // TODO: th
+000850a0: 6973 2063 616e 2062 6563 6f6d 6520 286e  is can become (n
+000850b0: 5f74 6173 6b73 2d31 290a 2020 2020 2020  _tasks-1).      
 000850c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000850d0: 2020 2063 7572 202b 3d20 7369 7a65 6f66     cur += sizeof
-000850e0: 2866 6c6f 6174 292a 6d78 446e 2a6e 5f74  (float)*mxDn*n_t
-000850f0: 6173 6b73 3b20 2f2f 2074 6869 7320 6973  asks; // this is
-00085100: 206f 7665 7265 7374 696d 6174 6564 2062   overestimated b
-00085110: 7920 7832 0a20 2020 2020 2020 2020 2020  y x2.           
-00085120: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00085130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085140: 776f 726b 5f73 697a 6520 3d20 4d41 5828  work_size = MAX(
-00085150: 776f 726b 5f73 697a 652c 2063 7572 293b  work_size, cur);
-00085160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00085170: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00085180: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00085190: 4f50 5f57 494e 5f50 4152 543a 0a20 2020  OP_WIN_PART:.   
-000851a0: 2020 2020 2020 2020 2063 6173 6520 4747           case GG
-000851b0: 4d4c 5f4f 505f 5749 4e5f 554e 5041 5254  ML_OP_WIN_UNPART
-000851c0: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
-000851d0: 7365 2047 474d 4c5f 4f50 5f4d 4150 5f55  se GGML_OP_MAP_U
-000851e0: 4e41 5259 3a0a 2020 2020 2020 2020 2020  NARY:.          
-000851f0: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
-00085200: 4150 5f42 494e 4152 593a 0a20 2020 2020  AP_BINARY:.     
-00085210: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00085220: 5f4f 505f 4d41 505f 4355 5354 4f4d 313a  _OP_MAP_CUSTOM1:
-00085230: 0a20 2020 2020 2020 2020 2020 2063 6173  .            cas
-00085240: 6520 4747 4d4c 5f4f 505f 4d41 505f 4355  e GGML_OP_MAP_CU
-00085250: 5354 4f4d 323a 0a20 2020 2020 2020 2020  STOM2:.         
-00085260: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00085270: 4d41 505f 4355 5354 4f4d 333a 0a20 2020  MAP_CUSTOM3:.   
-00085280: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-00085290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000852a0: 2020 206e 5f74 6173 6b73 203d 2031 3b0a     n_tasks = 1;.
-000852b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000852c0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-000852d0: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
-000852e0: 505f 4352 4f53 535f 454e 5452 4f50 595f  P_CROSS_ENTROPY_
-000852f0: 4c4f 5353 3a0a 2020 2020 2020 2020 2020  LOSS:.          
-00085300: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00085310: 2020 2020 2020 2020 2020 2020 6e5f 7461              n_ta
-00085320: 736b 7320 3d20 6e5f 7468 7265 6164 733b  sks = n_threads;
-00085330: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00085340: 2020 2020 2020 7369 7a65 5f74 2063 7572        size_t cur
-00085350: 203d 2067 676d 6c5f 7479 7065 5f73 697a   = ggml_type_siz
-00085360: 6528 6e6f 6465 2d3e 7479 7065 292a 286e  e(node->type)*(n
-00085370: 5f74 6173 6b73 202b 206e 6f64 652d 3e73  _tasks + node->s
-00085380: 7263 5b30 5d2d 3e6e 655b 305d 2a6e 5f74  rc[0]->ne[0]*n_t
-00085390: 6173 6b73 293b 0a0a 2020 2020 2020 2020  asks);..        
-000853a0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000853b0: 5f73 697a 6520 3d20 4d41 5828 776f 726b  _size = MAX(work
-000853c0: 5f73 697a 652c 2063 7572 293b 0a20 2020  _size, cur);.   
-000853d0: 2020 2020 2020 2020 2020 2020 207d 2062               } b
-000853e0: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
-000853f0: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
-00085400: 524f 5353 5f45 4e54 524f 5059 5f4c 4f53  ROSS_ENTROPY_LOS
-00085410: 535f 4241 434b 3a0a 2020 2020 2020 2020  S_BACK:.        
-00085420: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00085430: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-00085440: 7461 736b 7320 3d20 6e5f 7468 7265 6164  tasks = n_thread
-00085450: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-00085460: 2020 2020 2020 2020 7369 7a65 5f74 2063          size_t c
-00085470: 7572 203d 2067 676d 6c5f 7479 7065 5f73  ur = ggml_type_s
-00085480: 697a 6528 6e6f 6465 2d3e 7479 7065 292a  ize(node->type)*
-00085490: 6e6f 6465 2d3e 7372 635b 305d 2d3e 6e65  node->src[0]->ne
-000854a0: 5b30 5d2a 6e5f 7461 736b 733b 0a0a 2020  [0]*n_tasks;..  
-000854b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000854c0: 2020 776f 726b 5f73 697a 6520 3d20 4d41    work_size = MA
-000854d0: 5828 776f 726b 5f73 697a 652c 2063 7572  X(work_size, cur
-000854e0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000854f0: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
-00085500: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00085510: 4c5f 4f50 5f4e 4f4e 453a 0a20 2020 2020  L_OP_NONE:.     
-00085520: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00085530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00085540: 206e 5f74 6173 6b73 203d 2031 3b0a 2020   n_tasks = 1;.  
-00085550: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
-00085560: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
-00085570: 2020 2063 6173 6520 4747 4d4c 5f4f 505f     case GGML_OP_
-00085580: 434f 554e 543a 0a20 2020 2020 2020 2020  COUNT:.         
-00085590: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000855a0: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
-000855b0: 4c5f 4153 5345 5254 2866 616c 7365 293b  L_ASSERT(false);
-000855c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000855d0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-000855e0: 2020 7d0a 0a20 2020 2020 2020 2063 706c    }..        cpl
-000855f0: 616e 2e6e 5f74 6173 6b73 5b69 5d20 3d20  an.n_tasks[i] = 
-00085600: 6e5f 7461 736b 733b 0a20 2020 207d 0a0a  n_tasks;.    }..
-00085610: 2020 2020 6966 2028 776f 726b 5f73 697a      if (work_siz
-00085620: 6520 3e20 3029 207b 0a20 2020 2020 2020  e > 0) {.       
-00085630: 2077 6f72 6b5f 7369 7a65 202b 3d20 4341   work_size += CA
-00085640: 4348 455f 4c49 4e45 5f53 495a 452a 286e  CHE_LINE_SIZE*(n
-00085650: 5f74 6872 6561 6473 202d 2031 293b 0a20  _threads - 1);. 
-00085660: 2020 207d 0a0a 2020 2020 6370 6c61 6e2e     }..    cplan.
-00085670: 6e5f 7468 7265 6164 7320 3d20 6e5f 7468  n_threads = n_th
-00085680: 7265 6164 733b 0a20 2020 2063 706c 616e  reads;.    cplan
-00085690: 2e77 6f72 6b5f 7369 7a65 203d 2077 6f72  .work_size = wor
-000856a0: 6b5f 7369 7a65 3b0a 2020 2020 6370 6c61  k_size;.    cpla
-000856b0: 6e2e 776f 726b 5f64 6174 6120 3d20 4e55  n.work_data = NU
-000856c0: 4c4c 3b0a 0a20 2020 2072 6574 7572 6e20  LL;..    return 
-000856d0: 6370 6c61 6e3b 0a7d 0a0a 696e 7420 6767  cplan;.}..int gg
-000856e0: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
-000856f0: 2873 7472 7563 7420 6767 6d6c 5f63 6772  (struct ggml_cgr
-00085700: 6170 6820 2a20 6367 7261 7068 2c20 7374  aph * cgraph, st
-00085710: 7275 6374 2067 676d 6c5f 6370 6c61 6e20  ruct ggml_cplan 
-00085720: 2a20 6370 6c61 6e29 207b 0a20 2020 207b  * cplan) {.    {
-00085730: 0a20 2020 2020 2020 2047 474d 4c5f 4153  .        GGML_AS
-00085740: 5345 5254 2863 706c 616e 293b 0a20 2020  SERT(cplan);.   
-00085750: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00085760: 2863 706c 616e 2d3e 6e5f 7468 7265 6164  (cplan->n_thread
-00085770: 7320 3e20 3029 3b0a 0a20 2020 2020 2020  s > 0);..       
-00085780: 2069 6620 2863 706c 616e 2d3e 776f 726b   if (cplan->work
-00085790: 5f73 697a 6520 3e20 3029 207b 0a20 2020  _size > 0) {.   
-000857a0: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-000857b0: 5345 5254 2863 706c 616e 2d3e 776f 726b  SERT(cplan->work
-000857c0: 5f64 6174 6129 3b0a 2020 2020 2020 2020  _data);.        
-000857d0: 7d0a 0a20 2020 2020 2020 2066 6f72 2028  }..        for (
-000857e0: 696e 7420 6920 3d20 303b 2069 203c 2063  int i = 0; i < c
-000857f0: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b20  graph->n_nodes; 
-00085800: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
-00085810: 2020 2069 6620 2863 6772 6170 682d 3e6e     if (cgraph->n
-00085820: 6f64 6573 5b69 5d2d 3e6f 7020 213d 2047  odes[i]->op != G
-00085830: 474d 4c5f 4f50 5f4e 4f4e 4529 207b 0a20  GML_OP_NONE) {. 
-00085840: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00085850: 474d 4c5f 4153 5345 5254 2863 706c 616e  GML_ASSERT(cplan
-00085860: 2d3e 6e5f 7461 736b 735b 695d 203e 2030  ->n_tasks[i] > 0
-00085870: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00085880: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-00085890: 0a0a 2020 2020 636f 6e73 7420 696e 7420  ..    const int 
-000858a0: 6e5f 7468 7265 6164 7320 3d20 6370 6c61  n_threads = cpla
-000858b0: 6e2d 3e6e 5f74 6872 6561 6473 3b0a 0a20  n->n_threads;.. 
-000858c0: 2020 2073 7472 7563 7420 6767 6d6c 5f63     struct ggml_c
-000858d0: 6f6d 7075 7465 5f73 7461 7465 5f73 6861  ompute_state_sha
-000858e0: 7265 6420 7374 6174 655f 7368 6172 6564  red state_shared
-000858f0: 203d 207b 0a20 2020 2020 2020 202f 2a2e   = {.        /*.
-00085900: 6367 7261 7068 2020 2020 2020 2020 2020  cgraph          
-00085910: 2020 2020 2020 2020 3d2a 2f20 6367 7261          =*/ cgra
-00085920: 7068 2c0a 2020 2020 2020 2020 2f2a 2e63  ph,.        /*.c
-00085930: 6772 6170 685f 706c 616e 2020 2020 2020  graph_plan      
-00085940: 2020 2020 2020 203d 2a2f 2063 706c 616e         =*/ cplan
-00085950: 2c0a 2020 2020 2020 2020 2f2a 2e70 6572  ,.        /*.per
-00085960: 665f 6e6f 6465 5f73 7461 7274 5f63 7963  f_node_start_cyc
-00085970: 6c65 7320 203d 2a2f 2030 2c0a 2020 2020  les  =*/ 0,.    
-00085980: 2020 2020 2f2a 2e70 6572 665f 6e6f 6465      /*.perf_node
-00085990: 5f73 7461 7274 5f74 696d 655f 7573 203d  _start_time_us =
-000859a0: 2a2f 2030 2c0a 2020 2020 2020 2020 2f2a  */ 0,.        /*
-000859b0: 2e6e 5f74 6872 6561 6473 2020 2020 2020  .n_threads      
-000859c0: 2020 2020 2020 2020 203d 2a2f 206e 5f74           =*/ n_t
-000859d0: 6872 6561 6473 2c0a 2020 2020 2020 2020  hreads,.        
-000859e0: 2f2a 2e6e 5f61 6374 6976 6520 2020 2020  /*.n_active     
-000859f0: 2020 2020 2020 2020 2020 203d 2a2f 206e             =*/ n
-00085a00: 5f74 6872 6561 6473 2c0a 2020 2020 2020  _threads,.      
-00085a10: 2020 2f2a 2e6e 6f64 655f 6e20 2020 2020    /*.node_n     
-00085a20: 2020 2020 2020 2020 2020 2020 203d 2a2f               =*/
-00085a30: 202d 312c 0a20 2020 2020 2020 202f 2a2e   -1,.        /*.
-00085a40: 6162 6f72 745f 6361 6c6c 6261 636b 2020  abort_callback  
-00085a50: 2020 2020 2020 2020 3d2a 2f20 4e55 4c4c          =*/ NULL
-00085a60: 2c0a 2020 2020 2020 2020 2f2a 2e61 626f  ,.        /*.abo
-00085a70: 7274 5f63 616c 6c62 6163 6b5f 6461 7461  rt_callback_data
-00085a80: 2020 2020 203d 2a2f 204e 554c 4c2c 0a20       =*/ NULL,. 
-00085a90: 2020 207d 3b0a 2020 2020 7374 7275 6374     };.    struct
-00085aa0: 2067 676d 6c5f 636f 6d70 7574 655f 7374   ggml_compute_st
-00085ab0: 6174 6520 2a20 776f 726b 6572 7320 3d20  ate * workers = 
-00085ac0: 616c 6c6f 6361 2873 697a 656f 6628 7374  alloca(sizeof(st
-00085ad0: 7275 6374 2067 676d 6c5f 636f 6d70 7574  ruct ggml_comput
-00085ae0: 655f 7374 6174 6529 2a6e 5f74 6872 6561  e_state)*n_threa
-00085af0: 6473 293b 0a0a 2020 2020 2f2f 2063 7265  ds);..    // cre
-00085b00: 6174 6520 7468 7265 6164 2070 6f6f 6c0a  ate thread pool.
-00085b10: 2020 2020 6966 2028 6e5f 7468 7265 6164      if (n_thread
-00085b20: 7320 3e20 3129 207b 0a20 2020 2020 2020  s > 1) {.       
-00085b30: 2066 6f72 2028 696e 7420 6a20 3d20 313b   for (int j = 1;
-00085b40: 206a 203c 206e 5f74 6872 6561 6473 3b20   j < n_threads; 
-00085b50: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-00085b60: 2020 2077 6f72 6b65 7273 5b6a 5d20 3d20     workers[j] = 
-00085b70: 2873 7472 7563 7420 6767 6d6c 5f63 6f6d  (struct ggml_com
-00085b80: 7075 7465 5f73 7461 7465 2920 7b0a 2020  pute_state) {.  
-00085b90: 2020 2020 2020 2020 2020 2020 2020 2e74                .t
-00085ba0: 6872 6420 2020 3d20 302c 0a20 2020 2020  hrd   = 0,.     
-00085bb0: 2020 2020 2020 2020 2020 202e 6974 6820             .ith 
-00085bc0: 3d20 6a2c 0a20 2020 2020 2020 2020 2020  = j,.           
-00085bd0: 2020 2020 202e 7368 6172 6564 203d 2026       .shared = &
-00085be0: 7374 6174 655f 7368 6172 6564 2c0a 2020  state_shared,.  
-00085bf0: 2020 2020 2020 2020 2020 7d3b 0a0a 2020            };..  
-00085c00: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00085c10: 696e 7420 7263 203d 2067 676d 6c5f 7468  int rc = ggml_th
-00085c20: 7265 6164 5f63 7265 6174 6528 2677 6f72  read_create(&wor
-00085c30: 6b65 7273 5b6a 5d2e 7468 7264 2c20 4e55  kers[j].thrd, NU
-00085c40: 4c4c 2c20 6767 6d6c 5f67 7261 7068 5f63  LL, ggml_graph_c
-00085c50: 6f6d 7075 7465 5f74 6872 6561 642c 2026  ompute_thread, &
-00085c60: 776f 726b 6572 735b 6a5d 293b 0a20 2020  workers[j]);.   
-00085c70: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00085c80: 5345 5254 2872 6320 3d3d 2030 293b 0a20  SERT(rc == 0);. 
-00085c90: 2020 2020 2020 207d 0a20 2020 207d 0a20         }.    }. 
-00085ca0: 2020 2077 6f72 6b65 7273 5b30 5d2e 6974     workers[0].it
-00085cb0: 6820 3d20 303b 0a20 2020 2077 6f72 6b65  h = 0;.    worke
-00085cc0: 7273 5b30 5d2e 7368 6172 6564 203d 2026  rs[0].shared = &
-00085cd0: 7374 6174 655f 7368 6172 6564 3b0a 0a20  state_shared;.. 
-00085ce0: 2020 2063 6f6e 7374 2069 6e74 3634 5f74     const int64_t
-00085cf0: 2070 6572 665f 7374 6172 745f 6379 636c   perf_start_cycl
-00085d00: 6573 2020 3d20 6767 6d6c 5f70 6572 665f  es  = ggml_perf_
-00085d10: 6379 636c 6573 2829 3b0a 2020 2020 636f  cycles();.    co
-00085d20: 6e73 7420 696e 7436 345f 7420 7065 7266  nst int64_t perf
-00085d30: 5f73 7461 7274 5f74 696d 655f 7573 203d  _start_time_us =
-00085d40: 2067 676d 6c5f 7065 7266 5f74 696d 655f   ggml_perf_time_
-00085d50: 7573 2829 3b0a 0a20 2020 202f 2f20 7468  us();..    // th
-00085d60: 6973 2069 7320 6120 776f 726b 2074 6872  is is a work thr
-00085d70: 6561 6420 746f 6f0a 2020 2020 696e 7420  ead too.    int 
-00085d80: 636f 6d70 7574 655f 7374 6174 7573 203d  compute_status =
-00085d90: 2028 7369 7a65 5f74 2920 6767 6d6c 5f67   (size_t) ggml_g
-00085da0: 7261 7068 5f63 6f6d 7075 7465 5f74 6872  raph_compute_thr
-00085db0: 6561 6428 2677 6f72 6b65 7273 5b30 5d29  ead(&workers[0])
-00085dc0: 3b0a 0a20 2020 202f 2f20 646f 6e27 7420  ;..    // don't 
-00085dd0: 6c65 6176 6520 6166 6669 6e69 7479 2073  leave affinity s
-00085de0: 6574 206f 6e20 7468 6520 6d61 696e 2074  et on the main t
-00085df0: 6872 6561 640a 2020 2020 636c 6561 725f  hread.    clear_
-00085e00: 6e75 6d61 5f74 6872 6561 645f 6166 6669  numa_thread_affi
-00085e10: 6e69 7479 2829 3b0a 0a20 2020 202f 2f20  nity();..    // 
-00085e20: 6a6f 696e 206f 7220 6b69 6c6c 2074 6872  join or kill thr
-00085e30: 6561 6420 706f 6f6c 0a20 2020 2069 6620  ead pool.    if 
-00085e40: 286e 5f74 6872 6561 6473 203e 2031 2920  (n_threads > 1) 
-00085e50: 7b0a 2020 2020 2020 2020 666f 7220 2869  {.        for (i
-00085e60: 6e74 206a 203d 2031 3b20 6a20 3c20 6e5f  nt j = 1; j < n_
-00085e70: 7468 7265 6164 733b 206a 2b2b 2920 7b0a  threads; j++) {.
-00085e80: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00085e90: 7420 696e 7420 7263 203d 2067 676d 6c5f  t int rc = ggml_
-00085ea0: 7468 7265 6164 5f6a 6f69 6e28 776f 726b  thread_join(work
-00085eb0: 6572 735b 6a5d 2e74 6872 642c 204e 554c  ers[j].thrd, NUL
-00085ec0: 4c29 3b0a 2020 2020 2020 2020 2020 2020  L);.            
-00085ed0: 4747 4d4c 5f41 5353 4552 5428 7263 203d  GGML_ASSERT(rc =
-00085ee0: 3d20 3029 3b0a 2020 2020 2020 2020 7d0a  = 0);.        }.
-00085ef0: 2020 2020 7d0a 0a20 2020 202f 2f20 7065      }..    // pe
-00085f00: 7266 6f72 6d61 6e63 6520 7374 6174 7320  rformance stats 
-00085f10: 2867 7261 7068 290a 2020 2020 7b0a 2020  (graph).    {.  
-00085f20: 2020 2020 2020 696e 7436 345f 7420 7065        int64_t pe
-00085f30: 7266 5f63 7963 6c65 735f 6375 7220 203d  rf_cycles_cur  =
-00085f40: 2067 676d 6c5f 7065 7266 5f63 7963 6c65   ggml_perf_cycle
-00085f50: 7328 2920 202d 2070 6572 665f 7374 6172  s()  - perf_star
-00085f60: 745f 6379 636c 6573 3b0a 2020 2020 2020  t_cycles;.      
-00085f70: 2020 696e 7436 345f 7420 7065 7266 5f74    int64_t perf_t
-00085f80: 696d 655f 7573 5f63 7572 203d 2067 676d  ime_us_cur = ggm
-00085f90: 6c5f 7065 7266 5f74 696d 655f 7573 2829  l_perf_time_us()
-00085fa0: 202d 2070 6572 665f 7374 6172 745f 7469   - perf_start_ti
-00085fb0: 6d65 5f75 733b 0a0a 2020 2020 2020 2020  me_us;..        
-00085fc0: 6367 7261 7068 2d3e 7065 7266 5f72 756e  cgraph->perf_run
-00085fd0: 732b 2b3b 0a20 2020 2020 2020 2063 6772  s++;.        cgr
-00085fe0: 6170 682d 3e70 6572 665f 6379 636c 6573  aph->perf_cycles
-00085ff0: 2020 2b3d 2070 6572 665f 6379 636c 6573    += perf_cycles
-00086000: 5f63 7572 3b0a 2020 2020 2020 2020 6367  _cur;.        cg
-00086010: 7261 7068 2d3e 7065 7266 5f74 696d 655f  raph->perf_time_
-00086020: 7573 202b 3d20 7065 7266 5f74 696d 655f  us += perf_time_
-00086030: 7573 5f63 7572 3b0a 0a20 2020 2020 2020  us_cur;..       
-00086040: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
-00086050: 4728 2225 733a 2070 6572 6620 2825 6429  G("%s: perf (%d)
-00086060: 202d 2063 7075 203d 2025 2e33 6620 2f20   - cpu = %.3f / 
-00086070: 252e 3366 206d 732c 2077 616c 6c20 3d20  %.3f ms, wall = 
-00086080: 252e 3366 202f 2025 2e33 6620 6d73 5c6e  %.3f / %.3f ms\n
-00086090: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000860a0: 2020 205f 5f66 756e 635f 5f2c 2063 6772     __func__, cgr
-000860b0: 6170 682d 3e70 6572 665f 7275 6e73 2c0a  aph->perf_runs,.
-000860c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000860d0: 2864 6f75 626c 6529 2070 6572 665f 6379  (double) perf_cy
-000860e0: 636c 6573 5f63 7572 2020 2020 2020 2f20  cles_cur      / 
-000860f0: 2864 6f75 626c 6529 2067 676d 6c5f 6379  (double) ggml_cy
-00086100: 636c 6573 5f70 6572 5f6d 7328 292c 0a20  cles_per_ms(),. 
-00086110: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00086120: 646f 7562 6c65 2920 6367 7261 7068 2d3e  double) cgraph->
-00086130: 7065 7266 5f63 7963 6c65 7320 202f 2028  perf_cycles  / (
-00086140: 646f 7562 6c65 2920 6767 6d6c 5f63 7963  double) ggml_cyc
-00086150: 6c65 735f 7065 725f 6d73 2829 202f 2028  les_per_ms() / (
-00086160: 646f 7562 6c65 2920 6367 7261 7068 2d3e  double) cgraph->
-00086170: 7065 7266 5f72 756e 732c 0a20 2020 2020  perf_runs,.     
-00086180: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
-00086190: 6c65 2920 7065 7266 5f74 696d 655f 7573  le) perf_time_us
-000861a0: 5f63 7572 2020 2020 202f 2031 3030 302e  _cur     / 1000.
-000861b0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-000861c0: 2020 2028 646f 7562 6c65 2920 6367 7261     (double) cgra
-000861d0: 7068 2d3e 7065 7266 5f74 696d 655f 7573  ph->perf_time_us
-000861e0: 202f 2031 3030 302e 3020 2f20 6367 7261   / 1000.0 / cgra
-000861f0: 7068 2d3e 7065 7266 5f72 756e 7329 3b0a  ph->perf_runs);.
-00086200: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
-00086210: 6e20 636f 6d70 7574 655f 7374 6174 7573  n compute_status
-00086220: 3b0a 7d0a 0a76 6f69 6420 6767 6d6c 5f67  ;.}..void ggml_g
-00086230: 7261 7068 5f72 6573 6574 2873 7472 7563  raph_reset(struc
-00086240: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-00086250: 6367 7261 7068 2920 7b0a 2020 2020 666f  cgraph) {.    fo
-00086260: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-00086270: 3c20 6367 7261 7068 2d3e 6e5f 6e6f 6465  < cgraph->n_node
-00086280: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-00086290: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-000862a0: 6e73 6f72 202a 2067 7261 6420 3d20 6367  nsor * grad = cg
-000862b0: 7261 7068 2d3e 6772 6164 735b 695d 3b0a  raph->grads[i];.
-000862c0: 0a20 2020 2020 2020 2069 6620 2867 7261  .        if (gra
-000862d0: 6429 207b 0a20 2020 2020 2020 2020 2020  d) {.           
-000862e0: 2067 676d 6c5f 7365 745f 7a65 726f 2867   ggml_set_zero(g
-000862f0: 7261 6429 3b0a 2020 2020 2020 2020 7d0a  rad);.        }.
-00086300: 2020 2020 7d0a 7d0a 0a76 6f69 6420 6767      }.}..void gg
-00086310: 6d6c 5f67 7261 7068 5f63 6f6d 7075 7465  ml_graph_compute
-00086320: 5f77 6974 685f 6374 7828 7374 7275 6374  _with_ctx(struct
-00086330: 2067 676d 6c5f 636f 6e74 6578 7420 2a20   ggml_context * 
-00086340: 6374 782c 2073 7472 7563 7420 6767 6d6c  ctx, struct ggml
-00086350: 5f63 6772 6170 6820 2a20 6367 7261 7068  _cgraph * cgraph
-00086360: 2c20 696e 7420 6e5f 7468 7265 6164 7329  , int n_threads)
-00086370: 207b 0a20 2020 2073 7472 7563 7420 6767   {.    struct gg
-00086380: 6d6c 5f63 706c 616e 2063 706c 616e 203d  ml_cplan cplan =
-00086390: 2067 676d 6c5f 6772 6170 685f 706c 616e   ggml_graph_plan
-000863a0: 2863 6772 6170 682c 206e 5f74 6872 6561  (cgraph, n_threa
-000863b0: 6473 293b 0a0a 2020 2020 7374 7275 6374  ds);..    struct
-000863c0: 2067 676d 6c5f 7465 6e73 6f72 202a 2062   ggml_tensor * b
-000863d0: 7566 203d 2067 676d 6c5f 6e65 775f 7465  uf = ggml_new_te
-000863e0: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-000863f0: 4c5f 5459 5045 5f49 382c 2063 706c 616e  L_TYPE_I8, cplan
-00086400: 2e77 6f72 6b5f 7369 7a65 293b 0a20 2020  .work_size);.   
-00086410: 2047 474d 4c5f 4153 5345 5254 2862 7566   GGML_ASSERT(buf
-00086420: 293b 0a0a 2020 2020 6370 6c61 6e2e 776f  );..    cplan.wo
-00086430: 726b 5f64 6174 6120 3d20 6275 662d 3e64  rk_data = buf->d
-00086440: 6174 613b 0a0a 2020 2020 6767 6d6c 5f67  ata;..    ggml_g
-00086450: 7261 7068 5f63 6f6d 7075 7465 2863 6772  raph_compute(cgr
-00086460: 6170 682c 2026 6370 6c61 6e29 3b0a 7d0a  aph, &cplan);.}.
-00086470: 0a73 7472 7563 7420 6767 6d6c 5f74 656e  .struct ggml_ten
-00086480: 736f 7220 2a20 6767 6d6c 5f67 7261 7068  sor * ggml_graph
-00086490: 5f67 6574 5f74 656e 736f 7228 7374 7275  _get_tensor(stru
-000864a0: 6374 2067 676d 6c5f 6367 7261 7068 202a  ct ggml_cgraph *
-000864b0: 2063 6772 6170 682c 2063 6f6e 7374 2063   cgraph, const c
-000864c0: 6861 7220 2a20 6e61 6d65 2920 7b0a 2020  har * name) {.  
-000864d0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-000864e0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
-000864f0: 6c65 6166 733b 2069 2b2b 2920 7b0a 2020  leafs; i++) {.  
-00086500: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-00086510: 6c5f 7465 6e73 6f72 202a 206c 6561 6620  l_tensor * leaf 
-00086520: 3d20 6367 7261 7068 2d3e 6c65 6166 735b  = cgraph->leafs[
-00086530: 695d 3b0a 0a20 2020 2020 2020 2069 6620  i];..        if 
-00086540: 2873 7472 636d 7028 6c65 6166 2d3e 6e61  (strcmp(leaf->na
-00086550: 6d65 2c20 6e61 6d65 2920 3d3d 2030 2920  me, name) == 0) 
-00086560: 7b0a 2020 2020 2020 2020 2020 2020 7265  {.            re
-00086570: 7475 726e 206c 6561 663b 0a20 2020 2020  turn leaf;.     
-00086580: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
-00086590: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-000865a0: 6920 3c20 6367 7261 7068 2d3e 6e5f 6e6f  i < cgraph->n_no
-000865b0: 6465 733b 2069 2b2b 2920 7b0a 2020 2020  des; i++) {.    
-000865c0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-000865d0: 7465 6e73 6f72 202a 206e 6f64 6520 3d20  tensor * node = 
-000865e0: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
-000865f0: 3b0a 0a20 2020 2020 2020 2069 6620 2873  ;..        if (s
-00086600: 7472 636d 7028 6e6f 6465 2d3e 6e61 6d65  trcmp(node->name
-00086610: 2c20 6e61 6d65 2920 3d3d 2030 2920 7b0a  , name) == 0) {.
-00086620: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00086630: 726e 206e 6f64 653b 0a20 2020 2020 2020  rn node;.       
-00086640: 207d 0a20 2020 207d 0a0a 2020 2020 7265   }.    }..    re
-00086650: 7475 726e 204e 554c 4c3b 0a7d 0a0a 7374  turn NULL;.}..st
-00086660: 6174 6963 2076 6f69 6420 6767 6d6c 5f67  atic void ggml_g
-00086670: 7261 7068 5f65 7870 6f72 745f 6c65 6166  raph_export_leaf
-00086680: 2863 6f6e 7374 2073 7472 7563 7420 6767  (const struct gg
-00086690: 6d6c 5f74 656e 736f 7220 2a20 7465 6e73  ml_tensor * tens
-000866a0: 6f72 2c20 4649 4c45 202a 2066 6f75 7429  or, FILE * fout)
-000866b0: 207b 0a20 2020 2063 6f6e 7374 2069 6e74   {.    const int
-000866c0: 3634 5f74 202a 206e 6520 3d20 7465 6e73  64_t * ne = tens
-000866d0: 6f72 2d3e 6e65 3b0a 2020 2020 636f 6e73  or->ne;.    cons
-000866e0: 7420 7369 7a65 5f74 2020 2a20 6e62 203d  t size_t  * nb =
-000866f0: 2074 656e 736f 722d 3e6e 623b 0a0a 2020   tensor->nb;..  
-00086700: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
-00086710: 2225 2d36 7320 252d 3132 7320 2538 6420  "%-6s %-12s %8d 
-00086720: 2522 2050 5249 6436 3420 2220 2522 2050  %" PRId64 " %" P
-00086730: 5249 6436 3420 2220 2522 2050 5249 6436  RId64 " %" PRId6
-00086740: 3420 2220 2522 2050 5249 6436 3420 2220  4 " %" PRId64 " 
-00086750: 2531 367a 7520 2531 367a 7520 2531 367a  %16zu %16zu %16z
-00086760: 7520 2531 367a 7520 2531 3670 2025 3332  u %16zu %16p %32
-00086770: 735c 6e22 2c0a 2020 2020 2020 2020 2020  s\n",.          
-00086780: 2020 6767 6d6c 5f74 7970 655f 6e61 6d65    ggml_type_name
-00086790: 2874 656e 736f 722d 3e74 7970 6529 2c0a  (tensor->type),.
-000867a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-000867b0: 5f6f 705f 6e61 6d65 2020 2874 656e 736f  _op_name  (tenso
-000867c0: 722d 3e6f 7029 2c0a 2020 2020 2020 2020  r->op),.        
-000867d0: 2020 2020 7465 6e73 6f72 2d3e 6e5f 6469      tensor->n_di
-000867e0: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
-000867f0: 6e65 5b30 5d2c 206e 655b 315d 2c20 6e65  ne[0], ne[1], ne
-00086800: 5b32 5d2c 206e 655b 335d 2c0a 2020 2020  [2], ne[3],.    
-00086810: 2020 2020 2020 2020 6e62 5b30 5d2c 206e          nb[0], n
-00086820: 625b 315d 2c20 6e62 5b32 5d2c 206e 625b  b[1], nb[2], nb[
-00086830: 335d 2c0a 2020 2020 2020 2020 2020 2020  3],.            
-00086840: 7465 6e73 6f72 2d3e 6461 7461 2c0a 2020  tensor->data,.  
-00086850: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00086860: 2d3e 6e61 6d65 293b 0a7d 0a0a 7374 6174  ->name);.}..stat
-00086870: 6963 2076 6f69 6420 6767 6d6c 5f67 7261  ic void ggml_gra
-00086880: 7068 5f65 7870 6f72 745f 6e6f 6465 2863  ph_export_node(c
-00086890: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-000868a0: 5f74 656e 736f 7220 2a20 7465 6e73 6f72  _tensor * tensor
-000868b0: 2c20 636f 6e73 7420 6368 6172 202a 2061  , const char * a
-000868c0: 7267 2c20 4649 4c45 202a 2066 6f75 7429  rg, FILE * fout)
-000868d0: 207b 0a20 2020 2063 6f6e 7374 2069 6e74   {.    const int
-000868e0: 3634 5f74 202a 206e 6520 3d20 7465 6e73  64_t * ne = tens
-000868f0: 6f72 2d3e 6e65 3b0a 2020 2020 636f 6e73  or->ne;.    cons
-00086900: 7420 7369 7a65 5f74 2020 2a20 6e62 203d  t size_t  * nb =
-00086910: 2074 656e 736f 722d 3e6e 623b 0a0a 2020   tensor->nb;..  
-00086920: 2020 6670 7269 6e74 6628 666f 7574 2c20    fprintf(fout, 
-00086930: 2225 2d36 7320 252d 3673 2025 2d31 3273  "%-6s %-6s %-12s
-00086940: 2025 3864 2025 2220 5052 4964 3634 2022   %8d %" PRId64 "
-00086950: 2025 2220 5052 4964 3634 2022 2025 2220   %" PRId64 " %" 
-00086960: 5052 4964 3634 2022 2025 2220 5052 4964  PRId64 " %" PRId
-00086970: 3634 2022 2025 3136 7a75 2025 3136 7a75  64 " %16zu %16zu
-00086980: 2025 3136 7a75 2025 3136 7a75 2025 3136   %16zu %16zu %16
-00086990: 7020 2533 3273 5c6e 222c 0a20 2020 2020  p %32s\n",.     
-000869a0: 2020 2020 2020 2061 7267 2c0a 2020 2020         arg,.    
-000869b0: 2020 2020 2020 2020 6767 6d6c 5f74 7970          ggml_typ
-000869c0: 655f 6e61 6d65 2874 656e 736f 722d 3e74  e_name(tensor->t
-000869d0: 7970 6529 2c0a 2020 2020 2020 2020 2020  ype),.          
-000869e0: 2020 6767 6d6c 5f6f 705f 6e61 6d65 2020    ggml_op_name  
-000869f0: 2874 656e 736f 722d 3e6f 7029 2c0a 2020  (tensor->op),.  
-00086a00: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
-00086a10: 2d3e 6e5f 6469 6d73 2c0a 2020 2020 2020  ->n_dims,.      
-00086a20: 2020 2020 2020 6e65 5b30 5d2c 206e 655b        ne[0], ne[
-00086a30: 315d 2c20 6e65 5b32 5d2c 206e 655b 335d  1], ne[2], ne[3]
-00086a40: 2c0a 2020 2020 2020 2020 2020 2020 6e62  ,.            nb
-00086a50: 5b30 5d2c 206e 625b 315d 2c20 6e62 5b32  [0], nb[1], nb[2
-00086a60: 5d2c 206e 625b 335d 2c0a 2020 2020 2020  ], nb[3],.      
-00086a70: 2020 2020 2020 7465 6e73 6f72 2d3e 6461        tensor->da
-00086a80: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-00086a90: 7465 6e73 6f72 2d3e 6e61 6d65 293b 0a7d  tensor->name);.}
-00086aa0: 0a0a 766f 6964 2067 676d 6c5f 6772 6170  ..void ggml_grap
-00086ab0: 685f 6578 706f 7274 2863 6f6e 7374 2073  h_export(const s
-00086ac0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-00086ad0: 6820 2a20 6367 7261 7068 2c20 636f 6e73  h * cgraph, cons
-00086ae0: 7420 6368 6172 202a 2066 6e61 6d65 2920  t char * fname) 
-00086af0: 7b0a 2020 2020 2f2f 6173 7365 7274 2863  {.    //assert(c
-00086b00: 6772 6170 682d 3e77 6f72 6b20 2020 2020  graph->work     
-00086b10: 203d 3d20 4e55 4c4c 293b 0a20 2020 202f   == NULL);.    /
-00086b20: 2f61 7373 6572 7428 6367 7261 7068 2d3e  /assert(cgraph->
-00086b30: 776f 726b 5f73 697a 6520 3d3d 2030 293b  work_size == 0);
-00086b40: 0a0a 2020 2020 7569 6e74 3634 5f74 2073  ..    uint64_t s
-00086b50: 697a 655f 6576 616c 203d 2030 3b0a 0a20  ize_eval = 0;.. 
-00086b60: 2020 202f 2f20 636f 6d70 7574 6520 7369     // compute si
-00086b70: 7a65 206f 6620 696e 7465 726d 6564 6961  ze of intermedia
-00086b80: 7465 2072 6573 756c 7473 0a20 2020 202f  te results.    /
-00086b90: 2f20 544f 444f 3a20 646f 6573 206e 6f74  / TODO: does not
-00086ba0: 2074 616b 6520 696e 746f 2061 6363 6f75   take into accou
-00086bb0: 6e74 2073 6372 6174 6368 2062 7566 6665  nt scratch buffe
-00086bc0: 7273 2021 2121 210a 2020 2020 666f 7220  rs !!!!.    for 
-00086bd0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-00086be0: 6367 7261 7068 2d3e 6e5f 6e6f 6465 733b  cgraph->n_nodes;
-00086bf0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
-00086c00: 7369 7a65 5f65 7661 6c20 2b3d 2067 676d  size_eval += ggm
-00086c10: 6c5f 6e62 7974 6573 2863 6772 6170 682d  l_nbytes(cgraph-
-00086c20: 3e6e 6f64 6573 5b69 5d29 3b0a 2020 2020  >nodes[i]);.    
-00086c30: 7d0a 0a20 2020 202f 2f20 7072 696e 740a  }..    // print.
-00086c40: 2020 2020 7b0a 2020 2020 2020 2020 4649      {.        FI
-00086c50: 4c45 202a 2066 6f75 7420 3d20 7374 646f  LE * fout = stdo
-00086c60: 7574 3b0a 0a20 2020 2020 2020 2066 7072  ut;..        fpr
-00086c70: 696e 7466 2866 6f75 742c 2022 5c6e 2229  intf(fout, "\n")
-00086c80: 3b0a 2020 2020 2020 2020 6670 7269 6e74  ;.        fprint
-00086c90: 6628 666f 7574 2c20 2225 2d31 3673 2025  f(fout, "%-16s %
-00086ca0: 3878 5c6e 222c 2022 6d61 6769 6322 2c20  8x\n", "magic", 
-00086cb0: 2020 2020 2020 2047 474d 4c5f 4649 4c45         GGML_FILE
-00086cc0: 5f4d 4147 4943 293b 0a20 2020 2020 2020  _MAGIC);.       
-00086cd0: 2066 7072 696e 7466 2866 6f75 742c 2022   fprintf(fout, "
-00086ce0: 252d 3136 7320 2538 645c 6e22 2c20 2276  %-16s %8d\n", "v
-00086cf0: 6572 7369 6f6e 222c 2020 2020 2020 4747  ersion",      GG
-00086d00: 4d4c 5f46 494c 455f 5645 5253 494f 4e29  ML_FILE_VERSION)
-00086d10: 3b0a 2020 2020 2020 2020 6670 7269 6e74  ;.        fprint
-00086d20: 6628 666f 7574 2c20 2225 2d31 3673 2025  f(fout, "%-16s %
-00086d30: 3864 5c6e 222c 2022 6c65 6166 7322 2c20  8d\n", "leafs", 
-00086d40: 2020 2020 2020 2063 6772 6170 682d 3e6e         cgraph->n
-00086d50: 5f6c 6561 6673 293b 0a20 2020 2020 2020  _leafs);.       
-00086d60: 2066 7072 696e 7466 2866 6f75 742c 2022   fprintf(fout, "
-00086d70: 252d 3136 7320 2538 645c 6e22 2c20 226e  %-16s %8d\n", "n
-00086d80: 6f64 6573 222c 2020 2020 2020 2020 6367  odes",        cg
-00086d90: 7261 7068 2d3e 6e5f 6e6f 6465 7329 3b0a  raph->n_nodes);.
-00086da0: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-00086db0: 666f 7574 2c20 2225 2d31 3673 2025 2220  fout, "%-16s %" 
-00086dc0: 5052 4975 3634 2022 5c6e 222c 2022 6576  PRIu64 "\n", "ev
-00086dd0: 616c 222c 2073 697a 655f 6576 616c 293b  al", size_eval);
-00086de0: 0a0a 2020 2020 2020 2020 2f2f 2068 6561  ..        // hea
-00086df0: 6465 720a 2020 2020 2020 2020 6670 7269  der.        fpri
-00086e00: 6e74 6628 666f 7574 2c20 225c 6e22 293b  ntf(fout, "\n");
-00086e10: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
-00086e20: 2866 6f75 742c 2022 252d 3673 2025 2d31  (fout, "%-6s %-1
-00086e30: 3273 2025 3873 2025 3873 2025 3873 2025  2s %8s %8s %8s %
-00086e40: 3873 2025 3873 2025 3136 7320 2531 3673  8s %8s %16s %16s
-00086e50: 2025 3136 7320 2531 3673 2025 3136 7320   %16s %16s %16s 
-00086e60: 2531 3673 5c6e 222c 0a20 2020 2020 2020  %16s\n",.       
-00086e70: 2020 2020 2020 2020 2022 5459 5045 222c           "TYPE",
-00086e80: 2022 4f50 222c 2022 4e44 494d 5322 2c20   "OP", "NDIMS", 
-00086e90: 224e 4530 222c 2022 4e45 3122 2c20 224e  "NE0", "NE1", "N
-00086ea0: 4532 222c 2022 4e45 3322 2c20 224e 4230  E2", "NE3", "NB0
-00086eb0: 222c 2022 4e42 3122 2c20 224e 4232 222c  ", "NB1", "NB2",
-00086ec0: 2022 4e42 3322 2c20 2244 4154 4122 2c20   "NB3", "DATA", 
-00086ed0: 224e 414d 4522 293b 0a0a 2020 2020 2020  "NAME");..      
-00086ee0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-00086ef0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
-00086f00: 6c65 6166 733b 202b 2b69 2920 7b0a 2020  leafs; ++i) {.  
-00086f10: 2020 2020 2020 2020 2020 6767 6d6c 5f67            ggml_g
-00086f20: 7261 7068 5f65 7870 6f72 745f 6c65 6166  raph_export_leaf
-00086f30: 2863 6772 6170 682d 3e6c 6561 6673 5b69  (cgraph->leafs[i
-00086f40: 5d2c 2066 6f75 7429 3b0a 0a20 2020 2020  ], fout);..     
-00086f50: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
-00086f60: 5254 2863 6772 6170 682d 3e6c 6561 6673  RT(cgraph->leafs
-00086f70: 5b69 5d2d 3e6f 7020 2020 3d3d 2047 474d  [i]->op   == GGM
-00086f80: 4c5f 4f50 5f4e 4f4e 4529 3b0a 2020 2020  L_OP_NONE);.    
-00086f90: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00086fa0: 4552 5428 6367 7261 7068 2d3e 6c65 6166  ERT(cgraph->leaf
-00086fb0: 735b 695d 2d3e 7372 635b 305d 203d 3d20  s[i]->src[0] == 
-00086fc0: 4e55 4c4c 293b 0a20 2020 2020 2020 2020  NULL);.         
-00086fd0: 2020 2047 474d 4c5f 4153 5345 5254 2863     GGML_ASSERT(c
-00086fe0: 6772 6170 682d 3e6c 6561 6673 5b69 5d2d  graph->leafs[i]-
-00086ff0: 3e73 7263 5b31 5d20 3d3d 204e 554c 4c29  >src[1] == NULL)
-00087000: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
-00087010: 2020 2020 202f 2f20 6865 6164 6572 0a20       // header. 
-00087020: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
-00087030: 6f75 742c 2022 5c6e 2229 3b0a 2020 2020  out, "\n");.    
-00087040: 2020 2020 6670 7269 6e74 6628 666f 7574      fprintf(fout
-00087050: 2c20 2225 2d36 7320 252d 3673 2025 2d31  , "%-6s %-6s %-1
-00087060: 3273 2025 3873 2025 3873 2025 3873 2025  2s %8s %8s %8s %
-00087070: 3873 2025 3873 2025 3136 7320 2531 3673  8s %8s %16s %16s
-00087080: 2025 3136 7320 2531 3673 2025 3873 2025   %16s %16s %8s %
-00087090: 3136 7320 2531 3673 5c6e 222c 0a20 2020  16s %16s\n",.   
-000870a0: 2020 2020 2020 2020 2020 2020 2022 4152               "AR
-000870b0: 4722 2c20 2254 5950 4522 2c20 224f 5022  G", "TYPE", "OP"
-000870c0: 2c20 224e 4449 4d53 222c 2022 4e45 3022  , "NDIMS", "NE0"
-000870d0: 2c20 224e 4531 222c 2022 4e45 3222 2c20  , "NE1", "NE2", 
-000870e0: 224e 4533 222c 2022 4e42 3022 2c20 224e  "NE3", "NB0", "N
-000870f0: 4231 222c 2022 4e42 3222 2c20 224e 4233  B1", "NB2", "NB3
-00087100: 222c 2022 4e54 4153 4b53 222c 2022 4441  ", "NTASKS", "DA
-00087110: 5441 222c 2022 4e41 4d45 2229 3b0a 0a20  TA", "NAME");.. 
-00087120: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00087130: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
-00087140: 682d 3e6e 5f6e 6f64 6573 3b20 2b2b 6929  h->n_nodes; ++i)
-00087150: 207b 0a20 2020 2020 2020 2020 2020 2067   {.            g
-00087160: 676d 6c5f 6772 6170 685f 6578 706f 7274  gml_graph_export
-00087170: 5f6e 6f64 6528 6367 7261 7068 2d3e 6e6f  _node(cgraph->no
-00087180: 6465 735b 695d 2c20 2244 5354 222c 2066  des[i], "DST", f
-00087190: 6f75 7429 3b0a 0a20 2020 2020 2020 2020  out);..         
-000871a0: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-000871b0: 303b 206a 203c 2047 474d 4c5f 4d41 585f  0; j < GGML_MAX_
-000871c0: 5352 433b 202b 2b6a 2920 7b0a 2020 2020  SRC; ++j) {.    
-000871d0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-000871e0: 6367 7261 7068 2d3e 6e6f 6465 735b 695d  cgraph->nodes[i]
-000871f0: 2d3e 7372 635b 6a5d 2920 7b0a 2020 2020  ->src[j]) {.    
-00087200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087210: 6767 6d6c 5f67 7261 7068 5f65 7870 6f72  ggml_graph_expor
-00087220: 745f 6e6f 6465 2863 6772 6170 682d 3e6e  t_node(cgraph->n
-00087230: 6f64 6573 5b69 5d2d 3e73 7263 5b6a 5d2c  odes[i]->src[j],
-00087240: 2022 5352 4322 2c20 666f 7574 293b 0a20   "SRC", fout);. 
-00087250: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00087260: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-00087270: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-00087280: 6e74 6628 666f 7574 2c20 225c 6e22 293b  ntf(fout, "\n");
-00087290: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-000872a0: 2020 2020 6670 7269 6e74 6628 666f 7574      fprintf(fout
-000872b0: 2c20 225c 6e22 293b 0a20 2020 207d 0a0a  , "\n");.    }..
-000872c0: 2020 2020 2f2f 2077 7269 7465 2062 696e      // write bin
-000872d0: 6172 7920 6461 7461 0a20 2020 207b 0a20  ary data.    {. 
-000872e0: 2020 2020 2020 2046 494c 4520 2a20 666f         FILE * fo
-000872f0: 7574 203d 2066 6f70 656e 2866 6e61 6d65  ut = fopen(fname
-00087300: 2c20 2277 6222 293b 0a0a 2020 2020 2020  , "wb");..      
-00087310: 2020 6966 2028 2166 6f75 7429 207b 0a20    if (!fout) {. 
-00087320: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-00087330: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
-00087340: 6661 696c 6564 2074 6f20 6f70 656e 2025  failed to open %
-00087350: 735c 6e22 2c20 5f5f 6675 6e63 5f5f 2c20  s\n", __func__, 
-00087360: 666e 616d 6529 3b0a 2020 2020 2020 2020  fname);.        
-00087370: 2020 2020 7265 7475 726e 3b0a 2020 2020      return;.    
-00087380: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-00087390: 2f20 6865 6164 6572 0a20 2020 2020 2020  / header.       
-000873a0: 207b 0a20 2020 2020 2020 2020 2020 2063   {.            c
-000873b0: 6f6e 7374 2075 696e 7433 325f 7420 6d61  onst uint32_t ma
-000873c0: 6769 6320 2020 3d20 4747 4d4c 5f46 494c  gic   = GGML_FIL
-000873d0: 455f 4d41 4749 433b 0a20 2020 2020 2020  E_MAGIC;.       
-000873e0: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
-000873f0: 325f 7420 7665 7273 696f 6e20 3d20 4747  2_t version = GG
-00087400: 4d4c 5f46 494c 455f 5645 5253 494f 4e3b  ML_FILE_VERSION;
-00087410: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00087420: 7374 2075 696e 7433 325f 7420 6e5f 6c65  st uint32_t n_le
-00087430: 6166 7320 3d20 6367 7261 7068 2d3e 6e5f  afs = cgraph->n_
-00087440: 6c65 6166 733b 0a20 2020 2020 2020 2020  leafs;.         
-00087450: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
-00087460: 7420 6e6f 6465 7320 2020 3d20 6367 7261  t nodes   = cgra
-00087470: 7068 2d3e 6e5f 6e6f 6465 733b 0a0a 2020  ph->n_nodes;..  
-00087480: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
-00087490: 2826 6d61 6769 632c 2020 2020 2073 697a  (&magic,     siz
-000874a0: 656f 6628 7569 6e74 3332 5f74 292c 2031  eof(uint32_t), 1
-000874b0: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
-000874c0: 2020 2020 2066 7772 6974 6528 2676 6572       fwrite(&ver
-000874d0: 7369 6f6e 2c20 2020 7369 7a65 6f66 2875  sion,   sizeof(u
-000874e0: 696e 7433 325f 7429 2c20 312c 2066 6f75  int32_t), 1, fou
-000874f0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-00087500: 6677 7269 7465 2826 6e5f 6c65 6166 732c  fwrite(&n_leafs,
-00087510: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
-00087520: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
-00087530: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-00087540: 6528 266e 6f64 6573 2c20 2020 2020 7369  e(&nodes,     si
-00087550: 7a65 6f66 2875 696e 7433 325f 7429 2c20  zeof(uint32_t), 
-00087560: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
-00087570: 2020 2020 2020 6677 7269 7465 2826 7369        fwrite(&si
-00087580: 7a65 5f65 7661 6c2c 2073 697a 656f 6628  ze_eval, sizeof(
-00087590: 7569 6e74 3634 5f74 292c 2031 2c20 666f  uint64_t), 1, fo
-000875a0: 7574 293b 0a20 2020 2020 2020 207d 0a0a  ut);.        }..
-000875b0: 2020 2020 2020 2020 2f2f 206c 6561 6673          // leafs
-000875c0: 0a20 2020 2020 2020 207b 0a20 2020 2020  .        {.     
-000875d0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000875e0: 6920 3d20 303b 2069 203c 2063 6772 6170  i = 0; i < cgrap
-000875f0: 682d 3e6e 5f6c 6561 6673 3b20 2b2b 6929  h->n_leafs; ++i)
-00087600: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00087610: 2020 2063 6f6e 7374 2073 7472 7563 7420     const struct 
-00087620: 6767 6d6c 5f74 656e 736f 7220 2a20 7465  ggml_tensor * te
-00087630: 6e73 6f72 203d 2063 6772 6170 682d 3e6c  nsor = cgraph->l
-00087640: 6561 6673 5b69 5d3b 0a0a 2020 2020 2020  eafs[i];..      
-00087650: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00087660: 7569 6e74 3332 5f74 2074 7970 6520 2020  uint32_t type   
-00087670: 3d20 7465 6e73 6f72 2d3e 7479 7065 3b0a  = tensor->type;.
-00087680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087690: 636f 6e73 7420 7569 6e74 3332 5f74 206f  const uint32_t o
-000876a0: 7020 2020 2020 3d20 7465 6e73 6f72 2d3e  p     = tensor->
-000876b0: 6f70 3b0a 2020 2020 2020 2020 2020 2020  op;.            
-000876c0: 2020 2020 636f 6e73 7420 7569 6e74 3332      const uint32
-000876d0: 5f74 206e 5f64 696d 7320 3d20 7465 6e73  _t n_dims = tens
-000876e0: 6f72 2d3e 6e5f 6469 6d73 3b0a 0a20 2020  or->n_dims;..   
-000876f0: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
-00087700: 6974 6528 2674 7970 652c 2020 2073 697a  ite(&type,   siz
-00087710: 656f 6628 7569 6e74 3332 5f74 292c 2031  eof(uint32_t), 1
-00087720: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
-00087730: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
-00087740: 266f 702c 2020 2020 2073 697a 656f 6628  &op,     sizeof(
-00087750: 7569 6e74 3332 5f74 292c 2031 2c20 666f  uint32_t), 1, fo
-00087760: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
-00087770: 2020 2020 2066 7772 6974 6528 266e 5f64       fwrite(&n_d
-00087780: 696d 732c 2073 697a 656f 6628 7569 6e74  ims, sizeof(uint
-00087790: 3332 5f74 292c 2031 2c20 666f 7574 293b  32_t), 1, fout);
-000877a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000877b0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
-000877c0: 3b20 6a20 3c20 4747 4d4c 5f4d 4158 5f44  ; j < GGML_MAX_D
-000877d0: 494d 533b 202b 2b6a 2920 7b0a 2020 2020  IMS; ++j) {.    
-000877e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000877f0: 636f 6e73 7420 7569 6e74 3634 5f74 206e  const uint64_t n
-00087800: 6520 3d20 7465 6e73 6f72 2d3e 6e65 5b6a  e = tensor->ne[j
-00087810: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
-00087820: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-00087830: 7436 345f 7420 6e62 203d 2074 656e 736f  t64_t nb = tenso
-00087840: 722d 3e6e 625b 6a5d 3b0a 0a20 2020 2020  r->nb[j];..     
-00087850: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00087860: 7772 6974 6528 266e 652c 2073 697a 656f  write(&ne, sizeo
-00087870: 6628 7569 6e74 3634 5f74 292c 2031 2c20  f(uint64_t), 1, 
-00087880: 666f 7574 293b 0a20 2020 2020 2020 2020  fout);.         
-00087890: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-000878a0: 6528 266e 622c 2073 697a 656f 6628 7569  e(&nb, sizeof(ui
-000878b0: 6e74 3634 5f74 292c 2031 2c20 666f 7574  nt64_t), 1, fout
-000878c0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000878d0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-000878e0: 2020 2020 2020 6677 7269 7465 2874 656e        fwrite(ten
-000878f0: 736f 722d 3e6e 616d 652c 2073 697a 656f  sor->name, sizeo
-00087900: 6628 6368 6172 292c 2047 474d 4c5f 4d41  f(char), GGML_MA
-00087910: 585f 4e41 4d45 2c20 666f 7574 293b 0a0a  X_NAME, fout);..
-00087920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087930: 2f2f 2064 756d 7020 7468 6520 6461 7461  // dump the data
-00087940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00087950: 202f 2f20 544f 444f 3a20 7061 6420 7468   // TODO: pad th
-00087960: 6973 2074 6f20 3332 2062 7974 6520 626f  is to 32 byte bo
-00087970: 756e 6461 7279 0a20 2020 2020 2020 2020  undary.         
-00087980: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00087990: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000879a0: 7374 2073 697a 655f 7420 7369 7a65 203d  st size_t size =
-000879b0: 2067 676d 6c5f 6e62 7974 6573 2874 656e   ggml_nbytes(ten
-000879c0: 736f 7229 3b0a 0a20 2020 2020 2020 2020  sor);..         
-000879d0: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-000879e0: 6528 7465 6e73 6f72 2d3e 6461 7461 2c20  e(tensor->data, 
-000879f0: 7369 7a65 6f66 2863 6861 7229 2c20 7369  sizeof(char), si
-00087a00: 7a65 2c20 666f 7574 293b 0a20 2020 2020  ze, fout);.     
-00087a10: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-00087a20: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00087a30: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-00087a40: 206e 6f64 6573 0a20 2020 2020 2020 207b   nodes.        {
-00087a50: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00087a60: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
-00087a70: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
-00087a80: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00087a90: 2020 2020 2020 2020 2063 6f6e 7374 2073           const s
-00087aa0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-00087ab0: 7220 2a20 7465 6e73 6f72 203d 2063 6772  r * tensor = cgr
-00087ac0: 6170 682d 3e6e 6f64 6573 5b69 5d3b 0a0a  aph->nodes[i];..
-00087ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087ae0: 636f 6e73 7420 7569 6e74 3332 5f74 2074  const uint32_t t
-00087af0: 7970 6520 2020 3d20 7465 6e73 6f72 2d3e  ype   = tensor->
-00087b00: 7479 7065 3b0a 2020 2020 2020 2020 2020  type;.          
-00087b10: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-00087b20: 3332 5f74 206f 7020 2020 2020 3d20 7465  32_t op     = te
-00087b30: 6e73 6f72 2d3e 6f70 3b0a 2020 2020 2020  nsor->op;.      
-00087b40: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00087b50: 7569 6e74 3332 5f74 206e 5f64 696d 7320  uint32_t n_dims 
-00087b60: 3d20 7465 6e73 6f72 2d3e 6e5f 6469 6d73  = tensor->n_dims
-00087b70: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00087b80: 2020 2066 7772 6974 6528 2674 7970 652c     fwrite(&type,
-00087b90: 2020 2073 697a 656f 6628 7569 6e74 3332     sizeof(uint32
-00087ba0: 5f74 292c 2031 2c20 666f 7574 293b 0a20  _t), 1, fout);. 
-00087bb0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00087bc0: 7772 6974 6528 266f 702c 2020 2020 2073  write(&op,     s
-00087bd0: 697a 656f 6628 7569 6e74 3332 5f74 292c  izeof(uint32_t),
-00087be0: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
-00087bf0: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
-00087c00: 6528 266e 5f64 696d 732c 2073 697a 656f  e(&n_dims, sizeo
-00087c10: 6628 7569 6e74 3332 5f74 292c 2031 2c20  f(uint32_t), 1, 
-00087c20: 666f 7574 293b 0a0a 2020 2020 2020 2020  fout);..        
-00087c30: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00087c40: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
-00087c50: 5f4d 4158 5f44 494d 533b 202b 2b6a 2920  _MAX_DIMS; ++j) 
-00087c60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00087c70: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-00087c80: 3634 5f74 206e 6520 3d20 7465 6e73 6f72  64_t ne = tensor
-00087c90: 2d3e 6e65 5b6a 5d3b 0a20 2020 2020 2020  ->ne[j];.       
-00087ca0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00087cb0: 7374 2075 696e 7436 345f 7420 6e62 203d  st uint64_t nb =
-00087cc0: 2074 656e 736f 722d 3e6e 625b 6a5d 3b0a   tensor->nb[j];.
-00087cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00087ce0: 2020 2020 2066 7772 6974 6528 266e 652c       fwrite(&ne,
-00087cf0: 2073 697a 656f 6628 7569 6e74 3634 5f74   sizeof(uint64_t
-00087d00: 292c 2031 2c20 666f 7574 293b 0a20 2020  ), 1, fout);.   
-00087d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087d20: 2066 7772 6974 6528 266e 622c 2073 697a   fwrite(&nb, siz
-00087d30: 656f 6628 7569 6e74 3634 5f74 292c 2031  eof(uint64_t), 1
-00087d40: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
-00087d50: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00087d60: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
-00087d70: 7465 2874 656e 736f 722d 3e6e 616d 652c  te(tensor->name,
-00087d80: 2073 697a 656f 6628 6368 6172 292c 2047   sizeof(char), G
-00087d90: 474d 4c5f 4d41 585f 4e41 4d45 2c20 666f  GML_MAX_NAME, fo
-00087da0: 7574 293b 0a0a 2020 2020 2020 2020 2020  ut);..          
-00087db0: 2020 2020 2020 2f2f 206f 7574 7075 7420        // output 
-00087dc0: 7468 6520 6f70 2061 7267 756d 656e 7473  the op arguments
-00087dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00087de0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00087df0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00087e00: 6d6c 5f74 656e 736f 7220 2a20 6172 6773  ml_tensor * args
-00087e10: 5b47 474d 4c5f 4d41 585f 5352 435d 203d  [GGML_MAX_SRC] =
-00087e20: 207b 204e 554c 4c20 7d3b 0a0a 2020 2020   { NULL };..    
-00087e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087e40: 666f 7220 2869 6e74 206a 203d 2030 3b20  for (int j = 0; 
-00087e50: 6a20 3c20 4747 4d4c 5f4d 4158 5f53 5243  j < GGML_MAX_SRC
-00087e60: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
-00087e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087e80: 2061 7267 735b 6a5d 203d 2074 656e 736f   args[j] = tenso
-00087e90: 722d 3e73 7263 5b6a 5d3b 0a20 2020 2020  r->src[j];.     
-00087ea0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00087eb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00087ec0: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-00087ed0: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f4d   = 0; j < GGML_M
-00087ee0: 4158 5f53 5243 3b20 2b2b 6a29 207b 0a20  AX_SRC; ++j) {. 
-00087ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087f00: 2020 2020 2020 2069 6620 2861 7267 735b         if (args[
-00087f10: 6a5d 2920 7b0a 2020 2020 2020 2020 2020  j]) {.          
-00087f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087f30: 2020 696e 7433 325f 7420 6964 7820 3d20    int32_t idx = 
-00087f40: 2d31 3b0a 0a20 2020 2020 2020 2020 2020  -1;..           
-00087f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087f60: 202f 2f20 6368 6563 6b20 6966 206c 6561   // check if lea
-00087f70: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-00087f80: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00087f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087fb0: 666f 7220 2869 6e74 206b 203d 2030 3b20  for (int k = 0; 
-00087fc0: 6b20 3c20 6367 7261 7068 2d3e 6e5f 6c65  k < cgraph->n_le
-00087fd0: 6166 733b 202b 2b6b 2920 7b0a 2020 2020  afs; ++k) {.    
-00087fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00087ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088000: 6966 2028 6172 6773 5b6a 5d20 3d3d 2063  if (args[j] == c
-00088010: 6772 6170 682d 3e6c 6561 6673 5b6b 5d29  graph->leafs[k])
-00088020: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000850d0: 2020 6375 7220 2b3d 2073 697a 656f 6628    cur += sizeof(
+000850e0: 666c 6f61 7429 2a6d 7844 6e2a 6e5f 7461  float)*mxDn*n_ta
+000850f0: 736b 733b 202f 2f20 7468 6973 2069 7320  sks; // this is 
+00085100: 6f76 6572 6573 7469 6d61 7465 6420 6279  overestimated by
+00085110: 2078 320a 2020 2020 2020 2020 2020 2020   x2.            
+00085120: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00085130: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00085140: 6620 286e 6f64 652d 3e73 7263 5b31 5d2d  f (node->src[1]-
+00085150: 3e74 7970 6520 3d3d 2047 474d 4c5f 5459  >type == GGML_TY
+00085160: 5045 5f46 3136 2920 7b0a 2020 2020 2020  PE_F16) {.      
+00085170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085180: 2020 6375 7220 203d 2073 697a 656f 6628    cur  = sizeof(
+00085190: 666c 6f61 7429 2a6d 7844 6e2a 6e5f 7461  float)*mxDn*n_ta
+000851a0: 736b 733b 202f 2f20 544f 444f 3a20 7468  sks; // TODO: th
+000851b0: 6973 2063 616e 2062 6563 6f6d 6520 286e  is can become (n
+000851c0: 5f74 6173 6b73 2d31 290a 2020 2020 2020  _tasks-1).      
+000851d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000851e0: 2020 6375 7220 2b3d 2073 697a 656f 6628    cur += sizeof(
+000851f0: 666c 6f61 7429 2a6d 7844 6e2a 6e5f 7461  float)*mxDn*n_ta
+00085200: 736b 733b 202f 2f20 7468 6973 2069 7320  sks; // this is 
+00085210: 6f76 6572 6573 7469 6d61 7465 6420 6279  overestimated by
+00085220: 2078 320a 2020 2020 2020 2020 2020 2020   x2.            
+00085230: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00085240: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00085250: 6f72 6b5f 7369 7a65 203d 204d 4158 2877  ork_size = MAX(w
+00085260: 6f72 6b5f 7369 7a65 2c20 6375 7229 3b0a  ork_size, cur);.
+00085270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085280: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00085290: 2020 2020 2063 6173 6520 4747 4d4c 5f4f       case GGML_O
+000852a0: 505f 5749 4e5f 5041 5254 3a0a 2020 2020  P_WIN_PART:.    
+000852b0: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+000852c0: 4c5f 4f50 5f57 494e 5f55 4e50 4152 543a  L_OP_WIN_UNPART:
+000852d0: 0a20 2020 2020 2020 2020 2020 2063 6173  .            cas
+000852e0: 6520 4747 4d4c 5f4f 505f 4d41 505f 554e  e GGML_OP_MAP_UN
+000852f0: 4152 593a 0a20 2020 2020 2020 2020 2020  ARY:.           
+00085300: 2063 6173 6520 4747 4d4c 5f4f 505f 4d41   case GGML_OP_MA
+00085310: 505f 4249 4e41 5259 3a0a 2020 2020 2020  P_BINARY:.      
+00085320: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00085330: 4f50 5f4d 4150 5f43 5553 544f 4d31 3a0a  OP_MAP_CUSTOM1:.
+00085340: 2020 2020 2020 2020 2020 2020 6361 7365              case
+00085350: 2047 474d 4c5f 4f50 5f4d 4150 5f43 5553   GGML_OP_MAP_CUS
+00085360: 544f 4d32 3a0a 2020 2020 2020 2020 2020  TOM2:.          
+00085370: 2020 6361 7365 2047 474d 4c5f 4f50 5f4d    case GGML_OP_M
+00085380: 4150 5f43 5553 544f 4d33 3a0a 2020 2020  AP_CUSTOM3:.    
+00085390: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+000853a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000853b0: 2020 6e5f 7461 736b 7320 3d20 313b 0a20    n_tasks = 1;. 
+000853c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+000853d0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+000853e0: 2020 2020 6361 7365 2047 474d 4c5f 4f50      case GGML_OP
+000853f0: 5f43 524f 5353 5f45 4e54 524f 5059 5f4c  _CROSS_ENTROPY_L
+00085400: 4f53 533a 0a20 2020 2020 2020 2020 2020  OSS:.           
+00085410: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00085420: 2020 2020 2020 2020 2020 206e 5f74 6173             n_tas
+00085430: 6b73 203d 206e 5f74 6872 6561 6473 3b0a  ks = n_threads;.
+00085440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00085450: 2020 2020 2073 697a 655f 7420 6375 7220       size_t cur 
+00085460: 3d20 6767 6d6c 5f74 7970 655f 7369 7a65  = ggml_type_size
+00085470: 286e 6f64 652d 3e74 7970 6529 2a28 6e5f  (node->type)*(n_
+00085480: 7461 736b 7320 2b20 6e6f 6465 2d3e 7372  tasks + node->sr
+00085490: 635b 305d 2d3e 6e65 5b30 5d2a 6e5f 7461  c[0]->ne[0]*n_ta
+000854a0: 736b 7329 3b0a 0a20 2020 2020 2020 2020  sks);..         
+000854b0: 2020 2020 2020 2020 2020 2077 6f72 6b5f             work_
+000854c0: 7369 7a65 203d 204d 4158 2877 6f72 6b5f  size = MAX(work_
+000854d0: 7369 7a65 2c20 6375 7229 3b0a 2020 2020  size, cur);.    
+000854e0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
+000854f0: 6561 6b3b 0a20 2020 2020 2020 2020 2020  eak;.           
+00085500: 2063 6173 6520 4747 4d4c 5f4f 505f 4352   case GGML_OP_CR
+00085510: 4f53 535f 454e 5452 4f50 595f 4c4f 5353  OSS_ENTROPY_LOSS
+00085520: 5f42 4143 4b3a 0a20 2020 2020 2020 2020  _BACK:.         
+00085530: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00085540: 2020 2020 2020 2020 2020 2020 206e 5f74               n_t
+00085550: 6173 6b73 203d 206e 5f74 6872 6561 6473  asks = n_threads
+00085560: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00085570: 2020 2020 2020 2073 697a 655f 7420 6375         size_t cu
+00085580: 7220 3d20 6767 6d6c 5f74 7970 655f 7369  r = ggml_type_si
+00085590: 7a65 286e 6f64 652d 3e74 7970 6529 2a6e  ze(node->type)*n
+000855a0: 6f64 652d 3e73 7263 5b30 5d2d 3e6e 655b  ode->src[0]->ne[
+000855b0: 305d 2a6e 5f74 6173 6b73 3b0a 0a20 2020  0]*n_tasks;..   
+000855c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000855d0: 2077 6f72 6b5f 7369 7a65 203d 204d 4158   work_size = MAX
+000855e0: 2877 6f72 6b5f 7369 7a65 2c20 6375 7229  (work_size, cur)
+000855f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00085600: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
+00085610: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00085620: 5f4f 505f 4e4f 4e45 3a0a 2020 2020 2020  _OP_NONE:.      
+00085630: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+00085640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00085650: 6e5f 7461 736b 7320 3d20 313b 0a20 2020  n_tasks = 1;.   
+00085660: 2020 2020 2020 2020 2020 2020 207d 2062               } b
+00085670: 7265 616b 3b0a 2020 2020 2020 2020 2020  reak;.          
+00085680: 2020 6361 7365 2047 474d 4c5f 4f50 5f43    case GGML_OP_C
+00085690: 4f55 4e54 3a0a 2020 2020 2020 2020 2020  OUNT:.          
+000856a0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+000856b0: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
+000856c0: 5f41 5353 4552 5428 6661 6c73 6529 3b0a  _ASSERT(false);.
+000856d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000856e0: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+000856f0: 207d 0a0a 2020 2020 2020 2020 6370 6c61   }..        cpla
+00085700: 6e2e 6e5f 7461 736b 735b 695d 203d 206e  n.n_tasks[i] = n
+00085710: 5f74 6173 6b73 3b0a 2020 2020 7d0a 0a20  _tasks;.    }.. 
+00085720: 2020 2069 6620 2877 6f72 6b5f 7369 7a65     if (work_size
+00085730: 203e 2030 2920 7b0a 2020 2020 2020 2020   > 0) {.        
+00085740: 776f 726b 5f73 697a 6520 2b3d 2043 4143  work_size += CAC
+00085750: 4845 5f4c 494e 455f 5349 5a45 2a28 6e5f  HE_LINE_SIZE*(n_
+00085760: 7468 7265 6164 7320 2d20 3129 3b0a 2020  threads - 1);.  
+00085770: 2020 7d0a 0a20 2020 2063 706c 616e 2e6e    }..    cplan.n
+00085780: 5f74 6872 6561 6473 203d 206e 5f74 6872  _threads = n_thr
+00085790: 6561 6473 3b0a 2020 2020 6370 6c61 6e2e  eads;.    cplan.
+000857a0: 776f 726b 5f73 697a 6520 3d20 776f 726b  work_size = work
+000857b0: 5f73 697a 653b 0a20 2020 2063 706c 616e  _size;.    cplan
+000857c0: 2e77 6f72 6b5f 6461 7461 203d 204e 554c  .work_data = NUL
+000857d0: 4c3b 0a0a 2020 2020 7265 7475 726e 2063  L;..    return c
+000857e0: 706c 616e 3b0a 7d0a 0a69 6e74 2067 676d  plan;.}..int ggm
+000857f0: 6c5f 6772 6170 685f 636f 6d70 7574 6528  l_graph_compute(
+00085800: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+00085810: 7068 202a 2063 6772 6170 682c 2073 7472  ph * cgraph, str
+00085820: 7563 7420 6767 6d6c 5f63 706c 616e 202a  uct ggml_cplan *
+00085830: 2063 706c 616e 2920 7b0a 2020 2020 7b0a   cplan) {.    {.
+00085840: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00085850: 4552 5428 6370 6c61 6e29 3b0a 2020 2020  ERT(cplan);.    
+00085860: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00085870: 6370 6c61 6e2d 3e6e 5f74 6872 6561 6473  cplan->n_threads
+00085880: 203e 2030 293b 0a0a 2020 2020 2020 2020   > 0);..        
+00085890: 6966 2028 6370 6c61 6e2d 3e77 6f72 6b5f  if (cplan->work_
+000858a0: 7369 7a65 203e 2030 2920 7b0a 2020 2020  size > 0) {.    
+000858b0: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+000858c0: 4552 5428 6370 6c61 6e2d 3e77 6f72 6b5f  ERT(cplan->work_
+000858d0: 6461 7461 293b 0a20 2020 2020 2020 207d  data);.        }
+000858e0: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
+000858f0: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
+00085900: 7261 7068 2d3e 6e5f 6e6f 6465 733b 202b  raph->n_nodes; +
+00085910: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
+00085920: 2020 6966 2028 6367 7261 7068 2d3e 6e6f    if (cgraph->no
+00085930: 6465 735b 695d 2d3e 6f70 2021 3d20 4747  des[i]->op != GG
+00085940: 4d4c 5f4f 505f 4e4f 4e45 2920 7b0a 2020  ML_OP_NONE) {.  
+00085950: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00085960: 4d4c 5f41 5353 4552 5428 6370 6c61 6e2d  ML_ASSERT(cplan-
+00085970: 3e6e 5f74 6173 6b73 5b69 5d20 3e20 3029  >n_tasks[i] > 0)
+00085980: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
+00085990: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+000859a0: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+000859b0: 5f74 6872 6561 6473 203d 2063 706c 616e  _threads = cplan
+000859c0: 2d3e 6e5f 7468 7265 6164 733b 0a0a 2020  ->n_threads;..  
+000859d0: 2020 7374 7275 6374 2067 676d 6c5f 636f    struct ggml_co
+000859e0: 6d70 7574 655f 7374 6174 655f 7368 6172  mpute_state_shar
+000859f0: 6564 2073 7461 7465 5f73 6861 7265 6420  ed state_shared 
+00085a00: 3d20 7b0a 2020 2020 2020 2020 2f2a 2e63  = {.        /*.c
+00085a10: 6772 6170 6820 2020 2020 2020 2020 2020  graph           
+00085a20: 2020 2020 2020 203d 2a2f 2063 6772 6170         =*/ cgrap
+00085a30: 682c 0a20 2020 2020 2020 202f 2a2e 6367  h,.        /*.cg
+00085a40: 7261 7068 5f70 6c61 6e20 2020 2020 2020  raph_plan       
+00085a50: 2020 2020 2020 3d2a 2f20 6370 6c61 6e2c        =*/ cplan,
+00085a60: 0a20 2020 2020 2020 202f 2a2e 7065 7266  .        /*.perf
+00085a70: 5f6e 6f64 655f 7374 6172 745f 6379 636c  _node_start_cycl
+00085a80: 6573 2020 3d2a 2f20 302c 0a20 2020 2020  es  =*/ 0,.     
+00085a90: 2020 202f 2a2e 7065 7266 5f6e 6f64 655f     /*.perf_node_
+00085aa0: 7374 6172 745f 7469 6d65 5f75 7320 3d2a  start_time_us =*
+00085ab0: 2f20 302c 0a20 2020 2020 2020 202f 2a2e  / 0,.        /*.
+00085ac0: 6e5f 7468 7265 6164 7320 2020 2020 2020  n_threads       
+00085ad0: 2020 2020 2020 2020 3d2a 2f20 6e5f 7468          =*/ n_th
+00085ae0: 7265 6164 732c 0a20 2020 2020 2020 202f  reads,.        /
+00085af0: 2a2e 6e5f 6163 7469 7665 2020 2020 2020  *.n_active      
+00085b00: 2020 2020 2020 2020 2020 3d2a 2f20 6e5f            =*/ n_
+00085b10: 7468 7265 6164 732c 0a20 2020 2020 2020  threads,.       
+00085b20: 202f 2a2e 6e6f 6465 5f6e 2020 2020 2020   /*.node_n      
+00085b30: 2020 2020 2020 2020 2020 2020 3d2a 2f20              =*/ 
+00085b40: 2d31 2c0a 2020 2020 2020 2020 2f2a 2e61  -1,.        /*.a
+00085b50: 626f 7274 5f63 616c 6c62 6163 6b20 2020  bort_callback   
+00085b60: 2020 2020 2020 203d 2a2f 204e 554c 4c2c         =*/ NULL,
+00085b70: 0a20 2020 2020 2020 202f 2a2e 6162 6f72  .        /*.abor
+00085b80: 745f 6361 6c6c 6261 636b 5f64 6174 6120  t_callback_data 
+00085b90: 2020 2020 3d2a 2f20 4e55 4c4c 2c0a 2020      =*/ NULL,.  
+00085ba0: 2020 7d3b 0a20 2020 2073 7472 7563 7420    };.    struct 
+00085bb0: 6767 6d6c 5f63 6f6d 7075 7465 5f73 7461  ggml_compute_sta
+00085bc0: 7465 202a 2077 6f72 6b65 7273 203d 2061  te * workers = a
+00085bd0: 6c6c 6f63 6128 7369 7a65 6f66 2873 7472  lloca(sizeof(str
+00085be0: 7563 7420 6767 6d6c 5f63 6f6d 7075 7465  uct ggml_compute
+00085bf0: 5f73 7461 7465 292a 6e5f 7468 7265 6164  _state)*n_thread
+00085c00: 7329 3b0a 0a20 2020 202f 2f20 6372 6561  s);..    // crea
+00085c10: 7465 2074 6872 6561 6420 706f 6f6c 0a20  te thread pool. 
+00085c20: 2020 2069 6620 286e 5f74 6872 6561 6473     if (n_threads
+00085c30: 203e 2031 2920 7b0a 2020 2020 2020 2020   > 1) {.        
+00085c40: 666f 7220 2869 6e74 206a 203d 2031 3b20  for (int j = 1; 
+00085c50: 6a20 3c20 6e5f 7468 7265 6164 733b 202b  j < n_threads; +
+00085c60: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+00085c70: 2020 776f 726b 6572 735b 6a5d 203d 2028    workers[j] = (
+00085c80: 7374 7275 6374 2067 676d 6c5f 636f 6d70  struct ggml_comp
+00085c90: 7574 655f 7374 6174 6529 207b 0a20 2020  ute_state) {.   
+00085ca0: 2020 2020 2020 2020 2020 2020 202e 7468               .th
+00085cb0: 7264 2020 203d 2030 2c0a 2020 2020 2020  rd   = 0,.      
+00085cc0: 2020 2020 2020 2020 2020 2e69 7468 203d            .ith =
+00085cd0: 206a 2c0a 2020 2020 2020 2020 2020 2020   j,.            
+00085ce0: 2020 2020 2e73 6861 7265 6420 3d20 2673      .shared = &s
+00085cf0: 7461 7465 5f73 6861 7265 642c 0a20 2020  tate_shared,.   
+00085d00: 2020 2020 2020 2020 207d 3b0a 0a20 2020           };..   
+00085d10: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00085d20: 6e74 2072 6320 3d20 6767 6d6c 5f74 6872  nt rc = ggml_thr
+00085d30: 6561 645f 6372 6561 7465 2826 776f 726b  ead_create(&work
+00085d40: 6572 735b 6a5d 2e74 6872 642c 204e 554c  ers[j].thrd, NUL
+00085d50: 4c2c 2067 676d 6c5f 6772 6170 685f 636f  L, ggml_graph_co
+00085d60: 6d70 7574 655f 7468 7265 6164 2c20 2677  mpute_thread, &w
+00085d70: 6f72 6b65 7273 5b6a 5d29 3b0a 2020 2020  orkers[j]);.    
+00085d80: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00085d90: 4552 5428 7263 203d 3d20 3029 3b0a 2020  ERT(rc == 0);.  
+00085da0: 2020 2020 2020 7d0a 2020 2020 7d0a 2020        }.    }.  
+00085db0: 2020 776f 726b 6572 735b 305d 2e69 7468    workers[0].ith
+00085dc0: 203d 2030 3b0a 2020 2020 776f 726b 6572   = 0;.    worker
+00085dd0: 735b 305d 2e73 6861 7265 6420 3d20 2673  s[0].shared = &s
+00085de0: 7461 7465 5f73 6861 7265 643b 0a0a 2020  tate_shared;..  
+00085df0: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
+00085e00: 7065 7266 5f73 7461 7274 5f63 7963 6c65  perf_start_cycle
+00085e10: 7320 203d 2067 676d 6c5f 7065 7266 5f63  s  = ggml_perf_c
+00085e20: 7963 6c65 7328 293b 0a20 2020 2063 6f6e  ycles();.    con
+00085e30: 7374 2069 6e74 3634 5f74 2070 6572 665f  st int64_t perf_
+00085e40: 7374 6172 745f 7469 6d65 5f75 7320 3d20  start_time_us = 
+00085e50: 6767 6d6c 5f70 6572 665f 7469 6d65 5f75  ggml_perf_time_u
+00085e60: 7328 293b 0a0a 2020 2020 2f2f 2074 6869  s();..    // thi
+00085e70: 7320 6973 2061 2077 6f72 6b20 7468 7265  s is a work thre
+00085e80: 6164 2074 6f6f 0a20 2020 2069 6e74 2063  ad too.    int c
+00085e90: 6f6d 7075 7465 5f73 7461 7475 7320 3d20  ompute_status = 
+00085ea0: 2873 697a 655f 7429 2067 676d 6c5f 6772  (size_t) ggml_gr
+00085eb0: 6170 685f 636f 6d70 7574 655f 7468 7265  aph_compute_thre
+00085ec0: 6164 2826 776f 726b 6572 735b 305d 293b  ad(&workers[0]);
+00085ed0: 0a0a 2020 2020 2f2f 2064 6f6e 2774 206c  ..    // don't l
+00085ee0: 6561 7665 2061 6666 696e 6974 7920 7365  eave affinity se
+00085ef0: 7420 6f6e 2074 6865 206d 6169 6e20 7468  t on the main th
+00085f00: 7265 6164 0a20 2020 2063 6c65 6172 5f6e  read.    clear_n
+00085f10: 756d 615f 7468 7265 6164 5f61 6666 696e  uma_thread_affin
+00085f20: 6974 7928 293b 0a0a 2020 2020 2f2f 206a  ity();..    // j
+00085f30: 6f69 6e20 6f72 206b 696c 6c20 7468 7265  oin or kill thre
+00085f40: 6164 2070 6f6f 6c0a 2020 2020 6966 2028  ad pool.    if (
+00085f50: 6e5f 7468 7265 6164 7320 3e20 3129 207b  n_threads > 1) {
+00085f60: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00085f70: 7420 6a20 3d20 313b 206a 203c 206e 5f74  t j = 1; j < n_t
+00085f80: 6872 6561 6473 3b20 6a2b 2b29 207b 0a20  hreads; j++) {. 
+00085f90: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00085fa0: 2069 6e74 2072 6320 3d20 6767 6d6c 5f74   int rc = ggml_t
+00085fb0: 6872 6561 645f 6a6f 696e 2877 6f72 6b65  hread_join(worke
+00085fc0: 7273 5b6a 5d2e 7468 7264 2c20 4e55 4c4c  rs[j].thrd, NULL
+00085fd0: 293b 0a20 2020 2020 2020 2020 2020 2047  );.            G
+00085fe0: 474d 4c5f 4153 5345 5254 2872 6320 3d3d  GML_ASSERT(rc ==
+00085ff0: 2030 293b 0a20 2020 2020 2020 207d 0a20   0);.        }. 
+00086000: 2020 207d 0a0a 2020 2020 2f2f 2070 6572     }..    // per
+00086010: 666f 726d 616e 6365 2073 7461 7473 2028  formance stats (
+00086020: 6772 6170 6829 0a20 2020 207b 0a20 2020  graph).    {.   
+00086030: 2020 2020 2069 6e74 3634 5f74 2070 6572       int64_t per
+00086040: 665f 6379 636c 6573 5f63 7572 2020 3d20  f_cycles_cur  = 
+00086050: 6767 6d6c 5f70 6572 665f 6379 636c 6573  ggml_perf_cycles
+00086060: 2829 2020 2d20 7065 7266 5f73 7461 7274  ()  - perf_start
+00086070: 5f63 7963 6c65 733b 0a20 2020 2020 2020  _cycles;.       
+00086080: 2069 6e74 3634 5f74 2070 6572 665f 7469   int64_t perf_ti
+00086090: 6d65 5f75 735f 6375 7220 3d20 6767 6d6c  me_us_cur = ggml
+000860a0: 5f70 6572 665f 7469 6d65 5f75 7328 2920  _perf_time_us() 
+000860b0: 2d20 7065 7266 5f73 7461 7274 5f74 696d  - perf_start_tim
+000860c0: 655f 7573 3b0a 0a20 2020 2020 2020 2063  e_us;..        c
+000860d0: 6772 6170 682d 3e70 6572 665f 7275 6e73  graph->perf_runs
+000860e0: 2b2b 3b0a 2020 2020 2020 2020 6367 7261  ++;.        cgra
+000860f0: 7068 2d3e 7065 7266 5f63 7963 6c65 7320  ph->perf_cycles 
+00086100: 202b 3d20 7065 7266 5f63 7963 6c65 735f   += perf_cycles_
+00086110: 6375 723b 0a20 2020 2020 2020 2063 6772  cur;.        cgr
+00086120: 6170 682d 3e70 6572 665f 7469 6d65 5f75  aph->perf_time_u
+00086130: 7320 2b3d 2070 6572 665f 7469 6d65 5f75  s += perf_time_u
+00086140: 735f 6375 723b 0a0a 2020 2020 2020 2020  s_cur;..        
+00086150: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+00086160: 2822 2573 3a20 7065 7266 2028 2564 2920  ("%s: perf (%d) 
+00086170: 2d20 6370 7520 3d20 252e 3366 202f 2025  - cpu = %.3f / %
+00086180: 2e33 6620 6d73 2c20 7761 6c6c 203d 2025  .3f ms, wall = %
+00086190: 2e33 6620 2f20 252e 3366 206d 735c 6e22  .3f / %.3f ms\n"
+000861a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000861b0: 2020 5f5f 6675 6e63 5f5f 2c20 6367 7261    __func__, cgra
+000861c0: 7068 2d3e 7065 7266 5f72 756e 732c 0a20  ph->perf_runs,. 
+000861d0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000861e0: 646f 7562 6c65 2920 7065 7266 5f63 7963  double) perf_cyc
+000861f0: 6c65 735f 6375 7220 2020 2020 202f 2028  les_cur      / (
+00086200: 646f 7562 6c65 2920 6767 6d6c 5f63 7963  double) ggml_cyc
+00086210: 6c65 735f 7065 725f 6d73 2829 2c0a 2020  les_per_ms(),.  
+00086220: 2020 2020 2020 2020 2020 2020 2020 2864                (d
+00086230: 6f75 626c 6529 2063 6772 6170 682d 3e70  ouble) cgraph->p
+00086240: 6572 665f 6379 636c 6573 2020 2f20 2864  erf_cycles  / (d
+00086250: 6f75 626c 6529 2067 676d 6c5f 6379 636c  ouble) ggml_cycl
+00086260: 6573 5f70 6572 5f6d 7328 2920 2f20 2864  es_per_ms() / (d
+00086270: 6f75 626c 6529 2063 6772 6170 682d 3e70  ouble) cgraph->p
+00086280: 6572 665f 7275 6e73 2c0a 2020 2020 2020  erf_runs,.      
+00086290: 2020 2020 2020 2020 2020 2864 6f75 626c            (doubl
+000862a0: 6529 2070 6572 665f 7469 6d65 5f75 735f  e) perf_time_us_
+000862b0: 6375 7220 2020 2020 2f20 3130 3030 2e30  cur     / 1000.0
+000862c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000862d0: 2020 2864 6f75 626c 6529 2063 6772 6170    (double) cgrap
+000862e0: 682d 3e70 6572 665f 7469 6d65 5f75 7320  h->perf_time_us 
+000862f0: 2f20 3130 3030 2e30 202f 2063 6772 6170  / 1000.0 / cgrap
+00086300: 682d 3e70 6572 665f 7275 6e73 293b 0a20  h->perf_runs);. 
+00086310: 2020 207d 0a0a 2020 2020 7265 7475 726e     }..    return
+00086320: 2063 6f6d 7075 7465 5f73 7461 7475 733b   compute_status;
+00086330: 0a7d 0a0a 766f 6964 2067 676d 6c5f 6772  .}..void ggml_gr
+00086340: 6170 685f 7265 7365 7428 7374 7275 6374  aph_reset(struct
+00086350: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
+00086360: 6772 6170 6829 207b 0a20 2020 2066 6f72  graph) {.    for
+00086370: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+00086380: 2063 6772 6170 682d 3e6e 5f6e 6f64 6573   cgraph->n_nodes
+00086390: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+000863a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+000863b0: 736f 7220 2a20 6772 6164 203d 2063 6772  sor * grad = cgr
+000863c0: 6170 682d 3e67 7261 6473 5b69 5d3b 0a0a  aph->grads[i];..
+000863d0: 2020 2020 2020 2020 6966 2028 6772 6164          if (grad
+000863e0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000863f0: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6772  ggml_set_zero(gr
+00086400: 6164 293b 0a20 2020 2020 2020 207d 0a20  ad);.        }. 
+00086410: 2020 207d 0a7d 0a0a 766f 6964 2067 676d     }.}..void ggm
+00086420: 6c5f 6772 6170 685f 636f 6d70 7574 655f  l_graph_compute_
+00086430: 7769 7468 5f63 7478 2873 7472 7563 7420  with_ctx(struct 
+00086440: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
+00086450: 7478 2c20 7374 7275 6374 2067 676d 6c5f  tx, struct ggml_
+00086460: 6367 7261 7068 202a 2063 6772 6170 682c  cgraph * cgraph,
+00086470: 2069 6e74 206e 5f74 6872 6561 6473 2920   int n_threads) 
+00086480: 7b0a 2020 2020 7374 7275 6374 2067 676d  {.    struct ggm
+00086490: 6c5f 6370 6c61 6e20 6370 6c61 6e20 3d20  l_cplan cplan = 
+000864a0: 6767 6d6c 5f67 7261 7068 5f70 6c61 6e28  ggml_graph_plan(
+000864b0: 6367 7261 7068 2c20 6e5f 7468 7265 6164  cgraph, n_thread
+000864c0: 7329 3b0a 0a20 2020 2073 7472 7563 7420  s);..    struct 
+000864d0: 6767 6d6c 5f74 656e 736f 7220 2a20 6275  ggml_tensor * bu
+000864e0: 6620 3d20 6767 6d6c 5f6e 6577 5f74 656e  f = ggml_new_ten
+000864f0: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+00086500: 5f54 5950 455f 4938 2c20 6370 6c61 6e2e  _TYPE_I8, cplan.
+00086510: 776f 726b 5f73 697a 6529 3b0a 2020 2020  work_size);.    
+00086520: 4747 4d4c 5f41 5353 4552 5428 6275 6629  GGML_ASSERT(buf)
+00086530: 3b0a 0a20 2020 2063 706c 616e 2e77 6f72  ;..    cplan.wor
+00086540: 6b5f 6461 7461 203d 2062 7566 2d3e 6461  k_data = buf->da
+00086550: 7461 3b0a 0a20 2020 2067 676d 6c5f 6772  ta;..    ggml_gr
+00086560: 6170 685f 636f 6d70 7574 6528 6367 7261  aph_compute(cgra
+00086570: 7068 2c20 2663 706c 616e 293b 0a7d 0a0a  ph, &cplan);.}..
+00086580: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00086590: 6f72 202a 2067 676d 6c5f 6772 6170 685f  or * ggml_graph_
+000865a0: 6765 745f 7465 6e73 6f72 2873 7472 7563  get_tensor(struc
+000865b0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
+000865c0: 6367 7261 7068 2c20 636f 6e73 7420 6368  cgraph, const ch
+000865d0: 6172 202a 206e 616d 6529 207b 0a20 2020  ar * name) {.   
+000865e0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+000865f0: 2069 203c 2063 6772 6170 682d 3e6e 5f6c   i < cgraph->n_l
+00086600: 6561 6673 3b20 692b 2b29 207b 0a20 2020  eafs; i++) {.   
+00086610: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+00086620: 5f74 656e 736f 7220 2a20 6c65 6166 203d  _tensor * leaf =
+00086630: 2063 6772 6170 682d 3e6c 6561 6673 5b69   cgraph->leafs[i
+00086640: 5d3b 0a0a 2020 2020 2020 2020 6966 2028  ];..        if (
+00086650: 7374 7263 6d70 286c 6561 662d 3e6e 616d  strcmp(leaf->nam
+00086660: 652c 206e 616d 6529 203d 3d20 3029 207b  e, name) == 0) {
+00086670: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00086680: 7572 6e20 6c65 6166 3b0a 2020 2020 2020  urn leaf;.      
+00086690: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
+000866a0: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+000866b0: 203c 2063 6772 6170 682d 3e6e 5f6e 6f64   < cgraph->n_nod
+000866c0: 6573 3b20 692b 2b29 207b 0a20 2020 2020  es; i++) {.     
+000866d0: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
+000866e0: 656e 736f 7220 2a20 6e6f 6465 203d 2063  ensor * node = c
+000866f0: 6772 6170 682d 3e6e 6f64 6573 5b69 5d3b  graph->nodes[i];
+00086700: 0a0a 2020 2020 2020 2020 6966 2028 7374  ..        if (st
+00086710: 7263 6d70 286e 6f64 652d 3e6e 616d 652c  rcmp(node->name,
+00086720: 206e 616d 6529 203d 3d20 3029 207b 0a20   name) == 0) {. 
+00086730: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00086740: 6e20 6e6f 6465 3b0a 2020 2020 2020 2020  n node;.        
+00086750: 7d0a 2020 2020 7d0a 0a20 2020 2072 6574  }.    }..    ret
+00086760: 7572 6e20 4e55 4c4c 3b0a 7d0a 0a73 7461  urn NULL;.}..sta
+00086770: 7469 6320 766f 6964 2067 676d 6c5f 6772  tic void ggml_gr
+00086780: 6170 685f 6578 706f 7274 5f6c 6561 6628  aph_export_leaf(
+00086790: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+000867a0: 6c5f 7465 6e73 6f72 202a 2074 656e 736f  l_tensor * tenso
+000867b0: 722c 2046 494c 4520 2a20 666f 7574 2920  r, FILE * fout) 
+000867c0: 7b0a 2020 2020 636f 6e73 7420 696e 7436  {.    const int6
+000867d0: 345f 7420 2a20 6e65 203d 2074 656e 736f  4_t * ne = tenso
+000867e0: 722d 3e6e 653b 0a20 2020 2063 6f6e 7374  r->ne;.    const
+000867f0: 2073 697a 655f 7420 202a 206e 6220 3d20   size_t  * nb = 
+00086800: 7465 6e73 6f72 2d3e 6e62 3b0a 0a20 2020  tensor->nb;..   
+00086810: 2066 7072 696e 7466 2866 6f75 742c 2022   fprintf(fout, "
+00086820: 252d 3673 2025 2d31 3273 2025 3864 2025  %-6s %-12s %8d %
+00086830: 2220 5052 4964 3634 2022 2025 2220 5052  " PRId64 " %" PR
+00086840: 4964 3634 2022 2025 2220 5052 4964 3634  Id64 " %" PRId64
+00086850: 2022 2025 2220 5052 4964 3634 2022 2025   " %" PRId64 " %
+00086860: 3136 7a75 2025 3136 7a75 2025 3136 7a75  16zu %16zu %16zu
+00086870: 2025 3136 7a75 2025 3136 7020 2533 3273   %16zu %16p %32s
+00086880: 5c6e 222c 0a20 2020 2020 2020 2020 2020  \n",.           
+00086890: 2067 676d 6c5f 7479 7065 5f6e 616d 6528   ggml_type_name(
+000868a0: 7465 6e73 6f72 2d3e 7479 7065 292c 0a20  tensor->type),. 
+000868b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+000868c0: 6f70 5f6e 616d 6520 2028 7465 6e73 6f72  op_name  (tensor
+000868d0: 2d3e 6f70 292c 0a20 2020 2020 2020 2020  ->op),.         
+000868e0: 2020 2074 656e 736f 722d 3e6e 5f64 696d     tensor->n_dim
+000868f0: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
+00086900: 655b 305d 2c20 6e65 5b31 5d2c 206e 655b  e[0], ne[1], ne[
+00086910: 325d 2c20 6e65 5b33 5d2c 0a20 2020 2020  2], ne[3],.     
+00086920: 2020 2020 2020 206e 625b 305d 2c20 6e62         nb[0], nb
+00086930: 5b31 5d2c 206e 625b 325d 2c20 6e62 5b33  [1], nb[2], nb[3
+00086940: 5d2c 0a20 2020 2020 2020 2020 2020 2074  ],.            t
+00086950: 656e 736f 722d 3e64 6174 612c 0a20 2020  ensor->data,.   
+00086960: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+00086970: 3e6e 616d 6529 3b0a 7d0a 0a73 7461 7469  >name);.}..stati
+00086980: 6320 766f 6964 2067 676d 6c5f 6772 6170  c void ggml_grap
+00086990: 685f 6578 706f 7274 5f6e 6f64 6528 636f  h_export_node(co
+000869a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+000869b0: 7465 6e73 6f72 202a 2074 656e 736f 722c  tensor * tensor,
+000869c0: 2063 6f6e 7374 2063 6861 7220 2a20 6172   const char * ar
+000869d0: 672c 2046 494c 4520 2a20 666f 7574 2920  g, FILE * fout) 
+000869e0: 7b0a 2020 2020 636f 6e73 7420 696e 7436  {.    const int6
+000869f0: 345f 7420 2a20 6e65 203d 2074 656e 736f  4_t * ne = tenso
+00086a00: 722d 3e6e 653b 0a20 2020 2063 6f6e 7374  r->ne;.    const
+00086a10: 2073 697a 655f 7420 202a 206e 6220 3d20   size_t  * nb = 
+00086a20: 7465 6e73 6f72 2d3e 6e62 3b0a 0a20 2020  tensor->nb;..   
+00086a30: 2066 7072 696e 7466 2866 6f75 742c 2022   fprintf(fout, "
+00086a40: 252d 3673 2025 2d36 7320 252d 3132 7320  %-6s %-6s %-12s 
+00086a50: 2538 6420 2522 2050 5249 6436 3420 2220  %8d %" PRId64 " 
+00086a60: 2522 2050 5249 6436 3420 2220 2522 2050  %" PRId64 " %" P
+00086a70: 5249 6436 3420 2220 2522 2050 5249 6436  RId64 " %" PRId6
+00086a80: 3420 2220 2531 367a 7520 2531 367a 7520  4 " %16zu %16zu 
+00086a90: 2531 367a 7520 2531 367a 7520 2531 3670  %16zu %16zu %16p
+00086aa0: 2025 3332 735c 6e22 2c0a 2020 2020 2020   %32s\n",.      
+00086ab0: 2020 2020 2020 6172 672c 0a20 2020 2020        arg,.     
+00086ac0: 2020 2020 2020 2067 676d 6c5f 7479 7065         ggml_type
+00086ad0: 5f6e 616d 6528 7465 6e73 6f72 2d3e 7479  _name(tensor->ty
+00086ae0: 7065 292c 0a20 2020 2020 2020 2020 2020  pe),.           
+00086af0: 2067 676d 6c5f 6f70 5f6e 616d 6520 2028   ggml_op_name  (
+00086b00: 7465 6e73 6f72 2d3e 6f70 292c 0a20 2020  tensor->op),.   
+00086b10: 2020 2020 2020 2020 2074 656e 736f 722d           tensor-
+00086b20: 3e6e 5f64 696d 732c 0a20 2020 2020 2020  >n_dims,.       
+00086b30: 2020 2020 206e 655b 305d 2c20 6e65 5b31       ne[0], ne[1
+00086b40: 5d2c 206e 655b 325d 2c20 6e65 5b33 5d2c  ], ne[2], ne[3],
+00086b50: 0a20 2020 2020 2020 2020 2020 206e 625b  .            nb[
+00086b60: 305d 2c20 6e62 5b31 5d2c 206e 625b 325d  0], nb[1], nb[2]
+00086b70: 2c20 6e62 5b33 5d2c 0a20 2020 2020 2020  , nb[3],.       
+00086b80: 2020 2020 2074 656e 736f 722d 3e64 6174       tensor->dat
+00086b90: 612c 0a20 2020 2020 2020 2020 2020 2074  a,.            t
+00086ba0: 656e 736f 722d 3e6e 616d 6529 3b0a 7d0a  ensor->name);.}.
+00086bb0: 0a76 6f69 6420 6767 6d6c 5f67 7261 7068  .void ggml_graph
+00086bc0: 5f65 7870 6f72 7428 636f 6e73 7420 7374  _export(const st
+00086bd0: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+00086be0: 202a 2063 6772 6170 682c 2063 6f6e 7374   * cgraph, const
+00086bf0: 2063 6861 7220 2a20 666e 616d 6529 207b   char * fname) {
+00086c00: 0a20 2020 202f 2f61 7373 6572 7428 6367  .    //assert(cg
+00086c10: 7261 7068 2d3e 776f 726b 2020 2020 2020  raph->work      
+00086c20: 3d3d 204e 554c 4c29 3b0a 2020 2020 2f2f  == NULL);.    //
+00086c30: 6173 7365 7274 2863 6772 6170 682d 3e77  assert(cgraph->w
+00086c40: 6f72 6b5f 7369 7a65 203d 3d20 3029 3b0a  ork_size == 0);.
+00086c50: 0a20 2020 2075 696e 7436 345f 7420 7369  .    uint64_t si
+00086c60: 7a65 5f65 7661 6c20 3d20 303b 0a0a 2020  ze_eval = 0;..  
+00086c70: 2020 2f2f 2063 6f6d 7075 7465 2073 697a    // compute siz
+00086c80: 6520 6f66 2069 6e74 6572 6d65 6469 6174  e of intermediat
+00086c90: 6520 7265 7375 6c74 730a 2020 2020 2f2f  e results.    //
+00086ca0: 2054 4f44 4f3a 2064 6f65 7320 6e6f 7420   TODO: does not 
+00086cb0: 7461 6b65 2069 6e74 6f20 6163 636f 756e  take into accoun
+00086cc0: 7420 7363 7261 7463 6820 6275 6666 6572  t scratch buffer
+00086cd0: 7320 2121 2121 0a20 2020 2066 6f72 2028  s !!!!.    for (
+00086ce0: 696e 7420 6920 3d20 303b 2069 203c 2063  int i = 0; i < c
+00086cf0: 6772 6170 682d 3e6e 5f6e 6f64 6573 3b20  graph->n_nodes; 
+00086d00: 2b2b 6929 207b 0a20 2020 2020 2020 2073  ++i) {.        s
+00086d10: 697a 655f 6576 616c 202b 3d20 6767 6d6c  ize_eval += ggml
+00086d20: 5f6e 6279 7465 7328 6367 7261 7068 2d3e  _nbytes(cgraph->
+00086d30: 6e6f 6465 735b 695d 293b 0a20 2020 207d  nodes[i]);.    }
+00086d40: 0a0a 2020 2020 2f2f 2070 7269 6e74 0a20  ..    // print. 
+00086d50: 2020 207b 0a20 2020 2020 2020 2046 494c     {.        FIL
+00086d60: 4520 2a20 666f 7574 203d 2073 7464 6f75  E * fout = stdou
+00086d70: 743b 0a0a 2020 2020 2020 2020 6670 7269  t;..        fpri
+00086d80: 6e74 6628 666f 7574 2c20 225c 6e22 293b  ntf(fout, "\n");
+00086d90: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
+00086da0: 2866 6f75 742c 2022 252d 3136 7320 2538  (fout, "%-16s %8
+00086db0: 785c 6e22 2c20 226d 6167 6963 222c 2020  x\n", "magic",  
+00086dc0: 2020 2020 2020 4747 4d4c 5f46 494c 455f        GGML_FILE_
+00086dd0: 4d41 4749 4329 3b0a 2020 2020 2020 2020  MAGIC);.        
+00086de0: 6670 7269 6e74 6628 666f 7574 2c20 2225  fprintf(fout, "%
+00086df0: 2d31 3673 2025 3864 5c6e 222c 2022 7665  -16s %8d\n", "ve
+00086e00: 7273 696f 6e22 2c20 2020 2020 2047 474d  rsion",      GGM
+00086e10: 4c5f 4649 4c45 5f56 4552 5349 4f4e 293b  L_FILE_VERSION);
+00086e20: 0a20 2020 2020 2020 2066 7072 696e 7466  .        fprintf
+00086e30: 2866 6f75 742c 2022 252d 3136 7320 2538  (fout, "%-16s %8
+00086e40: 645c 6e22 2c20 226c 6561 6673 222c 2020  d\n", "leafs",  
+00086e50: 2020 2020 2020 6367 7261 7068 2d3e 6e5f        cgraph->n_
+00086e60: 6c65 6166 7329 3b0a 2020 2020 2020 2020  leafs);.        
+00086e70: 6670 7269 6e74 6628 666f 7574 2c20 2225  fprintf(fout, "%
+00086e80: 2d31 3673 2025 3864 5c6e 222c 2022 6e6f  -16s %8d\n", "no
+00086e90: 6465 7322 2c20 2020 2020 2020 2063 6772  des",        cgr
+00086ea0: 6170 682d 3e6e 5f6e 6f64 6573 293b 0a20  aph->n_nodes);. 
+00086eb0: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
+00086ec0: 6f75 742c 2022 252d 3136 7320 2522 2050  out, "%-16s %" P
+00086ed0: 5249 7536 3420 225c 6e22 2c20 2265 7661  RIu64 "\n", "eva
+00086ee0: 6c22 2c20 7369 7a65 5f65 7661 6c29 3b0a  l", size_eval);.
+00086ef0: 0a20 2020 2020 2020 202f 2f20 6865 6164  .        // head
+00086f00: 6572 0a20 2020 2020 2020 2066 7072 696e  er.        fprin
+00086f10: 7466 2866 6f75 742c 2022 5c6e 2229 3b0a  tf(fout, "\n");.
+00086f20: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
+00086f30: 666f 7574 2c20 2225 2d36 7320 252d 3132  fout, "%-6s %-12
+00086f40: 7320 2538 7320 2538 7320 2538 7320 2538  s %8s %8s %8s %8
+00086f50: 7320 2538 7320 2531 3673 2025 3136 7320  s %8s %16s %16s 
+00086f60: 2531 3673 2025 3136 7320 2531 3673 2025  %16s %16s %16s %
+00086f70: 3136 735c 6e22 2c0a 2020 2020 2020 2020  16s\n",.        
+00086f80: 2020 2020 2020 2020 2254 5950 4522 2c20          "TYPE", 
+00086f90: 224f 5022 2c20 224e 4449 4d53 222c 2022  "OP", "NDIMS", "
+00086fa0: 4e45 3022 2c20 224e 4531 222c 2022 4e45  NE0", "NE1", "NE
+00086fb0: 3222 2c20 224e 4533 222c 2022 4e42 3022  2", "NE3", "NB0"
+00086fc0: 2c20 224e 4231 222c 2022 4e42 3222 2c20  , "NB1", "NB2", 
+00086fd0: 224e 4233 222c 2022 4441 5441 222c 2022  "NB3", "DATA", "
+00086fe0: 4e41 4d45 2229 3b0a 0a20 2020 2020 2020  NAME");..       
+00086ff0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+00087000: 2069 203c 2063 6772 6170 682d 3e6e 5f6c   i < cgraph->n_l
+00087010: 6561 6673 3b20 2b2b 6929 207b 0a20 2020  eafs; ++i) {.   
+00087020: 2020 2020 2020 2020 2067 676d 6c5f 6772           ggml_gr
+00087030: 6170 685f 6578 706f 7274 5f6c 6561 6628  aph_export_leaf(
+00087040: 6367 7261 7068 2d3e 6c65 6166 735b 695d  cgraph->leafs[i]
+00087050: 2c20 666f 7574 293b 0a0a 2020 2020 2020  , fout);..      
+00087060: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
+00087070: 5428 6367 7261 7068 2d3e 6c65 6166 735b  T(cgraph->leafs[
+00087080: 695d 2d3e 6f70 2020 203d 3d20 4747 4d4c  i]->op   == GGML
+00087090: 5f4f 505f 4e4f 4e45 293b 0a20 2020 2020  _OP_NONE);.     
+000870a0: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+000870b0: 5254 2863 6772 6170 682d 3e6c 6561 6673  RT(cgraph->leafs
+000870c0: 5b69 5d2d 3e73 7263 5b30 5d20 3d3d 204e  [i]->src[0] == N
+000870d0: 554c 4c29 3b0a 2020 2020 2020 2020 2020  ULL);.          
+000870e0: 2020 4747 4d4c 5f41 5353 4552 5428 6367    GGML_ASSERT(cg
+000870f0: 7261 7068 2d3e 6c65 6166 735b 695d 2d3e  raph->leafs[i]->
+00087100: 7372 635b 315d 203d 3d20 4e55 4c4c 293b  src[1] == NULL);
+00087110: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00087120: 2020 2020 2f2f 2068 6561 6465 720a 2020      // header.  
+00087130: 2020 2020 2020 6670 7269 6e74 6628 666f        fprintf(fo
+00087140: 7574 2c20 225c 6e22 293b 0a20 2020 2020  ut, "\n");.     
+00087150: 2020 2066 7072 696e 7466 2866 6f75 742c     fprintf(fout,
+00087160: 2022 252d 3673 2025 2d36 7320 252d 3132   "%-6s %-6s %-12
+00087170: 7320 2538 7320 2538 7320 2538 7320 2538  s %8s %8s %8s %8
+00087180: 7320 2538 7320 2531 3673 2025 3136 7320  s %8s %16s %16s 
+00087190: 2531 3673 2025 3136 7320 2538 7320 2531  %16s %16s %8s %1
+000871a0: 3673 2025 3136 735c 6e22 2c0a 2020 2020  6s %16s\n",.    
+000871b0: 2020 2020 2020 2020 2020 2020 2241 5247              "ARG
+000871c0: 222c 2022 5459 5045 222c 2022 4f50 222c  ", "TYPE", "OP",
+000871d0: 2022 4e44 494d 5322 2c20 224e 4530 222c   "NDIMS", "NE0",
+000871e0: 2022 4e45 3122 2c20 224e 4532 222c 2022   "NE1", "NE2", "
+000871f0: 4e45 3322 2c20 224e 4230 222c 2022 4e42  NE3", "NB0", "NB
+00087200: 3122 2c20 224e 4232 222c 2022 4e42 3322  1", "NB2", "NB3"
+00087210: 2c20 224e 5441 534b 5322 2c20 2244 4154  , "NTASKS", "DAT
+00087220: 4122 2c20 224e 414d 4522 293b 0a0a 2020  A", "NAME");..  
+00087230: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00087240: 203d 2030 3b20 6920 3c20 6367 7261 7068   = 0; i < cgraph
+00087250: 2d3e 6e5f 6e6f 6465 733b 202b 2b69 2920  ->n_nodes; ++i) 
+00087260: 7b0a 2020 2020 2020 2020 2020 2020 6767  {.            gg
+00087270: 6d6c 5f67 7261 7068 5f65 7870 6f72 745f  ml_graph_export_
+00087280: 6e6f 6465 2863 6772 6170 682d 3e6e 6f64  node(cgraph->nod
+00087290: 6573 5b69 5d2c 2022 4453 5422 2c20 666f  es[i], "DST", fo
+000872a0: 7574 293b 0a0a 2020 2020 2020 2020 2020  ut);..          
+000872b0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
+000872c0: 3b20 6a20 3c20 4747 4d4c 5f4d 4158 5f53  ; j < GGML_MAX_S
+000872d0: 5243 3b20 2b2b 6a29 207b 0a20 2020 2020  RC; ++j) {.     
+000872e0: 2020 2020 2020 2020 2020 2069 6620 2863             if (c
+000872f0: 6772 6170 682d 3e6e 6f64 6573 5b69 5d2d  graph->nodes[i]-
+00087300: 3e73 7263 5b6a 5d29 207b 0a20 2020 2020  >src[j]) {.     
+00087310: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00087320: 676d 6c5f 6772 6170 685f 6578 706f 7274  gml_graph_export
+00087330: 5f6e 6f64 6528 6367 7261 7068 2d3e 6e6f  _node(cgraph->no
+00087340: 6465 735b 695d 2d3e 7372 635b 6a5d 2c20  des[i]->src[j], 
+00087350: 2253 5243 222c 2066 6f75 7429 3b0a 2020  "SRC", fout);.  
+00087360: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00087370: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00087380: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+00087390: 7466 2866 6f75 742c 2022 5c6e 2229 3b0a  tf(fout, "\n");.
+000873a0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+000873b0: 2020 2066 7072 696e 7466 2866 6f75 742c     fprintf(fout,
+000873c0: 2022 5c6e 2229 3b0a 2020 2020 7d0a 0a20   "\n");.    }.. 
+000873d0: 2020 202f 2f20 7772 6974 6520 6269 6e61     // write bina
+000873e0: 7279 2064 6174 610a 2020 2020 7b0a 2020  ry data.    {.  
+000873f0: 2020 2020 2020 4649 4c45 202a 2066 6f75        FILE * fou
+00087400: 7420 3d20 666f 7065 6e28 666e 616d 652c  t = fopen(fname,
+00087410: 2022 7762 2229 3b0a 0a20 2020 2020 2020   "wb");..       
+00087420: 2069 6620 2821 666f 7574 2920 7b0a 2020   if (!fout) {.  
+00087430: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+00087440: 6628 7374 6465 7272 2c20 2225 733a 2066  f(stderr, "%s: f
+00087450: 6169 6c65 6420 746f 206f 7065 6e20 2573  ailed to open %s
+00087460: 5c6e 222c 205f 5f66 756e 635f 5f2c 2066  \n", __func__, f
+00087470: 6e61 6d65 293b 0a20 2020 2020 2020 2020  name);.         
+00087480: 2020 2072 6574 7572 6e3b 0a20 2020 2020     return;.     
+00087490: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
+000874a0: 2068 6561 6465 720a 2020 2020 2020 2020   header.        
+000874b0: 7b0a 2020 2020 2020 2020 2020 2020 636f  {.            co
+000874c0: 6e73 7420 7569 6e74 3332 5f74 206d 6167  nst uint32_t mag
+000874d0: 6963 2020 203d 2047 474d 4c5f 4649 4c45  ic   = GGML_FILE
+000874e0: 5f4d 4147 4943 3b0a 2020 2020 2020 2020  _MAGIC;.        
+000874f0: 2020 2020 636f 6e73 7420 7569 6e74 3332      const uint32
+00087500: 5f74 2076 6572 7369 6f6e 203d 2047 474d  _t version = GGM
+00087510: 4c5f 4649 4c45 5f56 4552 5349 4f4e 3b0a  L_FILE_VERSION;.
+00087520: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00087530: 7420 7569 6e74 3332 5f74 206e 5f6c 6561  t uint32_t n_lea
+00087540: 6673 203d 2063 6772 6170 682d 3e6e 5f6c  fs = cgraph->n_l
+00087550: 6561 6673 3b0a 2020 2020 2020 2020 2020  eafs;.          
+00087560: 2020 636f 6e73 7420 7569 6e74 3332 5f74    const uint32_t
+00087570: 206e 6f64 6573 2020 203d 2063 6772 6170   nodes   = cgrap
+00087580: 682d 3e6e 5f6e 6f64 6573 3b0a 0a20 2020  h->n_nodes;..   
+00087590: 2020 2020 2020 2020 2066 7772 6974 6528           fwrite(
+000875a0: 266d 6167 6963 2c20 2020 2020 7369 7a65  &magic,     size
+000875b0: 6f66 2875 696e 7433 325f 7429 2c20 312c  of(uint32_t), 1,
+000875c0: 2066 6f75 7429 3b0a 2020 2020 2020 2020   fout);.        
+000875d0: 2020 2020 6677 7269 7465 2826 7665 7273      fwrite(&vers
+000875e0: 696f 6e2c 2020 2073 697a 656f 6628 7569  ion,   sizeof(ui
+000875f0: 6e74 3332 5f74 292c 2031 2c20 666f 7574  nt32_t), 1, fout
+00087600: 293b 0a20 2020 2020 2020 2020 2020 2066  );.            f
+00087610: 7772 6974 6528 266e 5f6c 6561 6673 2c20  write(&n_leafs, 
+00087620: 2020 7369 7a65 6f66 2875 696e 7433 325f    sizeof(uint32_
+00087630: 7429 2c20 312c 2066 6f75 7429 3b0a 2020  t), 1, fout);.  
+00087640: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
+00087650: 2826 6e6f 6465 732c 2020 2020 2073 697a  (&nodes,     siz
+00087660: 656f 6628 7569 6e74 3332 5f74 292c 2031  eof(uint32_t), 1
+00087670: 2c20 666f 7574 293b 0a20 2020 2020 2020  , fout);.       
+00087680: 2020 2020 2066 7772 6974 6528 2673 697a       fwrite(&siz
+00087690: 655f 6576 616c 2c20 7369 7a65 6f66 2875  e_eval, sizeof(u
+000876a0: 696e 7436 345f 7429 2c20 312c 2066 6f75  int64_t), 1, fou
+000876b0: 7429 3b0a 2020 2020 2020 2020 7d0a 0a20  t);.        }.. 
+000876c0: 2020 2020 2020 202f 2f20 6c65 6166 730a         // leafs.
+000876d0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000876e0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+000876f0: 203d 2030 3b20 6920 3c20 6367 7261 7068   = 0; i < cgraph
+00087700: 2d3e 6e5f 6c65 6166 733b 202b 2b69 2920  ->n_leafs; ++i) 
+00087710: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00087720: 2020 636f 6e73 7420 7374 7275 6374 2067    const struct g
+00087730: 676d 6c5f 7465 6e73 6f72 202a 2074 656e  gml_tensor * ten
+00087740: 736f 7220 3d20 6367 7261 7068 2d3e 6c65  sor = cgraph->le
+00087750: 6166 735b 695d 3b0a 0a20 2020 2020 2020  afs[i];..       
+00087760: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+00087770: 696e 7433 325f 7420 7479 7065 2020 203d  int32_t type   =
+00087780: 2074 656e 736f 722d 3e74 7970 653b 0a20   tensor->type;. 
+00087790: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000877a0: 6f6e 7374 2075 696e 7433 325f 7420 6f70  onst uint32_t op
+000877b0: 2020 2020 203d 2074 656e 736f 722d 3e6f       = tensor->o
+000877c0: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+000877d0: 2020 2063 6f6e 7374 2075 696e 7433 325f     const uint32_
+000877e0: 7420 6e5f 6469 6d73 203d 2074 656e 736f  t n_dims = tenso
+000877f0: 722d 3e6e 5f64 696d 733b 0a0a 2020 2020  r->n_dims;..    
+00087800: 2020 2020 2020 2020 2020 2020 6677 7269              fwri
+00087810: 7465 2826 7479 7065 2c20 2020 7369 7a65  te(&type,   size
+00087820: 6f66 2875 696e 7433 325f 7429 2c20 312c  of(uint32_t), 1,
+00087830: 2066 6f75 7429 3b0a 2020 2020 2020 2020   fout);.        
+00087840: 2020 2020 2020 2020 6677 7269 7465 2826          fwrite(&
+00087850: 6f70 2c20 2020 2020 7369 7a65 6f66 2875  op,     sizeof(u
+00087860: 696e 7433 325f 7429 2c20 312c 2066 6f75  int32_t), 1, fou
+00087870: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00087880: 2020 2020 6677 7269 7465 2826 6e5f 6469      fwrite(&n_di
+00087890: 6d73 2c20 7369 7a65 6f66 2875 696e 7433  ms, sizeof(uint3
+000878a0: 325f 7429 2c20 312c 2066 6f75 7429 3b0a  2_t), 1, fout);.
+000878b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000878c0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+000878d0: 206a 203c 2047 474d 4c5f 4d41 585f 4449   j < GGML_MAX_DI
+000878e0: 4d53 3b20 2b2b 6a29 207b 0a20 2020 2020  MS; ++j) {.     
+000878f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00087900: 6f6e 7374 2075 696e 7436 345f 7420 6e65  onst uint64_t ne
+00087910: 203d 2074 656e 736f 722d 3e6e 655b 6a5d   = tensor->ne[j]
+00087920: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00087930: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+00087940: 3634 5f74 206e 6220 3d20 7465 6e73 6f72  64_t nb = tensor
+00087950: 2d3e 6e62 5b6a 5d3b 0a0a 2020 2020 2020  ->nb[j];..      
+00087960: 2020 2020 2020 2020 2020 2020 2020 6677                fw
+00087970: 7269 7465 2826 6e65 2c20 7369 7a65 6f66  rite(&ne, sizeof
+00087980: 2875 696e 7436 345f 7429 2c20 312c 2066  (uint64_t), 1, f
+00087990: 6f75 7429 3b0a 2020 2020 2020 2020 2020  out);.          
+000879a0: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
+000879b0: 2826 6e62 2c20 7369 7a65 6f66 2875 696e  (&nb, sizeof(uin
+000879c0: 7436 345f 7429 2c20 312c 2066 6f75 7429  t64_t), 1, fout)
+000879d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000879e0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+000879f0: 2020 2020 2066 7772 6974 6528 7465 6e73       fwrite(tens
+00087a00: 6f72 2d3e 6e61 6d65 2c20 7369 7a65 6f66  or->name, sizeof
+00087a10: 2863 6861 7229 2c20 4747 4d4c 5f4d 4158  (char), GGML_MAX
+00087a20: 5f4e 414d 452c 2066 6f75 7429 3b0a 0a20  _NAME, fout);.. 
+00087a30: 2020 2020 2020 2020 2020 2020 2020 202f                 /
+00087a40: 2f20 6475 6d70 2074 6865 2064 6174 610a  / dump the data.
+00087a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087a60: 2f2f 2054 4f44 4f3a 2070 6164 2074 6869  // TODO: pad thi
+00087a70: 7320 746f 2033 3220 6279 7465 2062 6f75  s to 32 byte bou
+00087a80: 6e64 6172 790a 2020 2020 2020 2020 2020  ndary.          
+00087a90: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00087aa0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00087ab0: 7420 7369 7a65 5f74 2073 697a 6520 3d20  t size_t size = 
+00087ac0: 6767 6d6c 5f6e 6279 7465 7328 7465 6e73  ggml_nbytes(tens
+00087ad0: 6f72 293b 0a0a 2020 2020 2020 2020 2020  or);..          
+00087ae0: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
+00087af0: 2874 656e 736f 722d 3e64 6174 612c 2073  (tensor->data, s
+00087b00: 697a 656f 6628 6368 6172 292c 2073 697a  izeof(char), siz
+00087b10: 652c 2066 6f75 7429 3b0a 2020 2020 2020  e, fout);.      
+00087b20: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00087b30: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00087b40: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+00087b50: 6e6f 6465 730a 2020 2020 2020 2020 7b0a  nodes.        {.
+00087b60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00087b70: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
+00087b80: 6367 7261 7068 2d3e 6e5f 6e6f 6465 733b  cgraph->n_nodes;
+00087b90: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+00087ba0: 2020 2020 2020 2020 636f 6e73 7420 7374          const st
+00087bb0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+00087bc0: 202a 2074 656e 736f 7220 3d20 6367 7261   * tensor = cgra
+00087bd0: 7068 2d3e 6e6f 6465 735b 695d 3b0a 0a20  ph->nodes[i];.. 
+00087be0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00087bf0: 6f6e 7374 2075 696e 7433 325f 7420 7479  onst uint32_t ty
+00087c00: 7065 2020 203d 2074 656e 736f 722d 3e74  pe   = tensor->t
+00087c10: 7970 653b 0a20 2020 2020 2020 2020 2020  ype;.           
+00087c20: 2020 2020 2063 6f6e 7374 2075 696e 7433       const uint3
+00087c30: 325f 7420 6f70 2020 2020 203d 2074 656e  2_t op     = ten
+00087c40: 736f 722d 3e6f 703b 0a20 2020 2020 2020  sor->op;.       
+00087c50: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+00087c60: 696e 7433 325f 7420 6e5f 6469 6d73 203d  int32_t n_dims =
+00087c70: 2074 656e 736f 722d 3e6e 5f64 696d 733b   tensor->n_dims;
+00087c80: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00087c90: 2020 6677 7269 7465 2826 7479 7065 2c20    fwrite(&type, 
+00087ca0: 2020 7369 7a65 6f66 2875 696e 7433 325f    sizeof(uint32_
+00087cb0: 7429 2c20 312c 2066 6f75 7429 3b0a 2020  t), 1, fout);.  
+00087cc0: 2020 2020 2020 2020 2020 2020 2020 6677                fw
+00087cd0: 7269 7465 2826 6f70 2c20 2020 2020 7369  rite(&op,     si
+00087ce0: 7a65 6f66 2875 696e 7433 325f 7429 2c20  zeof(uint32_t), 
+00087cf0: 312c 2066 6f75 7429 3b0a 2020 2020 2020  1, fout);.      
+00087d00: 2020 2020 2020 2020 2020 6677 7269 7465            fwrite
+00087d10: 2826 6e5f 6469 6d73 2c20 7369 7a65 6f66  (&n_dims, sizeof
+00087d20: 2875 696e 7433 325f 7429 2c20 312c 2066  (uint32_t), 1, f
+00087d30: 6f75 7429 3b0a 0a20 2020 2020 2020 2020  out);..         
+00087d40: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00087d50: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
+00087d60: 4d41 585f 4449 4d53 3b20 2b2b 6a29 207b  MAX_DIMS; ++j) {
+00087d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00087d80: 2020 2020 2063 6f6e 7374 2075 696e 7436       const uint6
+00087d90: 345f 7420 6e65 203d 2074 656e 736f 722d  4_t ne = tensor-
+00087da0: 3e6e 655b 6a5d 3b0a 2020 2020 2020 2020  >ne[j];.        
+00087db0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00087dc0: 7420 7569 6e74 3634 5f74 206e 6220 3d20  t uint64_t nb = 
+00087dd0: 7465 6e73 6f72 2d3e 6e62 5b6a 5d3b 0a0a  tensor->nb[j];..
+00087de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087df0: 2020 2020 6677 7269 7465 2826 6e65 2c20      fwrite(&ne, 
+00087e00: 7369 7a65 6f66 2875 696e 7436 345f 7429  sizeof(uint64_t)
+00087e10: 2c20 312c 2066 6f75 7429 3b0a 2020 2020  , 1, fout);.    
+00087e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087e30: 6677 7269 7465 2826 6e62 2c20 7369 7a65  fwrite(&nb, size
+00087e40: 6f66 2875 696e 7436 345f 7429 2c20 312c  of(uint64_t), 1,
+00087e50: 2066 6f75 7429 3b0a 2020 2020 2020 2020   fout);.        
+00087e60: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00087e70: 2020 2020 2020 2020 2020 2066 7772 6974             fwrit
+00087e80: 6528 7465 6e73 6f72 2d3e 6e61 6d65 2c20  e(tensor->name, 
+00087e90: 7369 7a65 6f66 2863 6861 7229 2c20 4747  sizeof(char), GG
+00087ea0: 4d4c 5f4d 4158 5f4e 414d 452c 2066 6f75  ML_MAX_NAME, fou
+00087eb0: 7429 3b0a 0a20 2020 2020 2020 2020 2020  t);..           
+00087ec0: 2020 2020 202f 2f20 6f75 7470 7574 2074       // output t
+00087ed0: 6865 206f 7020 6172 6775 6d65 6e74 730a  he op arguments.
+00087ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087ef0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00087f00: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00087f10: 6c5f 7465 6e73 6f72 202a 2061 7267 735b  l_tensor * args[
+00087f20: 4747 4d4c 5f4d 4158 5f53 5243 5d20 3d20  GGML_MAX_SRC] = 
+00087f30: 7b20 4e55 4c4c 207d 3b0a 0a20 2020 2020  { NULL };..     
+00087f40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00087f50: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
+00087f60: 203c 2047 474d 4c5f 4d41 585f 5352 433b   < GGML_MAX_SRC;
+00087f70: 202b 2b6a 2920 7b0a 2020 2020 2020 2020   ++j) {.        
+00087f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00087f90: 6172 6773 5b6a 5d20 3d20 7465 6e73 6f72  args[j] = tensor
+00087fa0: 2d3e 7372 635b 6a5d 3b0a 2020 2020 2020  ->src[j];.      
+00087fb0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00087fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00087fd0: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+00087fe0: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
+00087ff0: 585f 5352 433b 202b 2b6a 2920 7b0a 2020  X_SRC; ++j) {.  
+00088000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088010: 2020 2020 2020 6966 2028 6172 6773 5b6a        if (args[j
+00088020: 5d29 207b 0a20 2020 2020 2020 2020 2020  ]) {.           
 00088030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088040: 2020 2020 2020 2020 2020 2069 6478 203d             idx =
-00088050: 206b 3b0a 2020 2020 2020 2020 2020 2020   k;.            
+00088040: 2069 6e74 3332 5f74 2069 6478 203d 202d   int32_t idx = -
+00088050: 313b 0a0a 2020 2020 2020 2020 2020 2020  1;..            
 00088060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088070: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00088080: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00088090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000880a0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000880b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000880c0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-000880d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000880e0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00088070: 2f2f 2063 6865 636b 2069 6620 6c65 6166  // check if leaf
+00088080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00088090: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
+000880a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000880b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000880c0: 6f72 2028 696e 7420 6b20 3d20 303b 206b  or (int k = 0; k
+000880d0: 203c 2063 6772 6170 682d 3e6e 5f6c 6561   < cgraph->n_lea
+000880e0: 6673 3b20 2b2b 6b29 207b 0a20 2020 2020  fs; ++k) {.     
 000880f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088100: 2020 2020 2020 2f2f 2063 6865 636b 2069        // check i
-00088110: 6620 6e6f 6465 0a20 2020 2020 2020 2020  f node.         
-00088120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088130: 2020 2069 6620 2869 6478 203d 3d20 2d31     if (idx == -1
-00088140: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00088150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088160: 2020 2020 666f 7220 2869 6e74 206b 203d      for (int k =
-00088170: 2030 3b20 6b20 3c20 6367 7261 7068 2d3e   0; k < cgraph->
-00088180: 6e5f 6e6f 6465 733b 202b 2b6b 2920 7b0a  n_nodes; ++k) {.
-00088190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088100: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00088110: 6620 2861 7267 735b 6a5d 203d 3d20 6367  f (args[j] == cg
+00088120: 7261 7068 2d3e 6c65 6166 735b 6b5d 2920  raph->leafs[k]) 
+00088130: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00088140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088150: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
+00088160: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+00088170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088180: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00088190: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
 000881a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000881b0: 2020 2020 6966 2028 6172 6773 5b6a 5d20      if (args[j] 
-000881c0: 3d3d 2063 6772 6170 682d 3e6e 6f64 6573  == cgraph->nodes
-000881d0: 5b6b 5d29 207b 0a20 2020 2020 2020 2020  [k]) {.         
+000881b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000881c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000881d0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
 000881e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000881f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00088200: 6478 203d 2047 474d 4c5f 4d41 585f 4e4f  dx = GGML_MAX_NO
-00088210: 4445 5320 2b20 6b3b 0a20 2020 2020 2020  DES + k;.       
-00088220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000881f0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00088200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088210: 2020 2020 202f 2f20 6368 6563 6b20 6966       // check if
+00088220: 206e 6f64 650a 2020 2020 2020 2020 2020   node.          
 00088230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088240: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00088250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088260: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00088270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088280: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00088290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000882a0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00088240: 2020 6966 2028 6964 7820 3d3d 202d 3129    if (idx == -1)
+00088250: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00088260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088270: 2020 2066 6f72 2028 696e 7420 6b20 3d20     for (int k = 
+00088280: 303b 206b 203c 2063 6772 6170 682d 3e6e  0; k < cgraph->n
+00088290: 5f6e 6f64 6573 3b20 2b2b 6b29 207b 0a20  _nodes; ++k) {. 
+000882a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000882b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000882c0: 2020 2020 2020 2020 2020 2069 6620 2869             if (i
-000882d0: 6478 203d 3d20 2d31 2920 7b0a 2020 2020  dx == -1) {.    
-000882e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000882f0: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-00088300: 6e74 6628 7374 6465 7272 2c20 2225 733a  ntf(stderr, "%s:
-00088310: 2066 6169 6c65 6420 746f 2066 696e 6420   failed to find 
-00088320: 7465 6e73 6f72 2c20 6172 6720 3d20 2564  tensor, arg = %d
-00088330: 2c20 6e6f 6465 203d 2025 645c 6e22 2c20  , node = %d\n", 
-00088340: 5f5f 6675 6e63 5f5f 2c20 6a2c 2069 293b  __func__, j, i);
-00088350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000882c0: 2020 2069 6620 2861 7267 735b 6a5d 203d     if (args[j] =
+000882d0: 3d20 6367 7261 7068 2d3e 6e6f 6465 735b  = cgraph->nodes[
+000882e0: 6b5d 2920 7b0a 2020 2020 2020 2020 2020  k]) {.          
+000882f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088300: 2020 2020 2020 2020 2020 2020 2020 6964                id
+00088310: 7820 3d20 4747 4d4c 5f4d 4158 5f4e 4f44  x = GGML_MAX_NOD
+00088320: 4553 202b 206b 3b0a 2020 2020 2020 2020  ES + k;.        
+00088330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088350: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
 00088360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088370: 2072 6574 7572 6e3b 0a20 2020 2020 2020   return;.       
+00088370: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
 00088380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088390: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00088390: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
 000883a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000883b0: 2020 2020 6677 7269 7465 2826 6964 782c      fwrite(&idx,
-000883c0: 2073 697a 656f 6628 696e 7433 325f 7429   sizeof(int32_t)
-000883d0: 2c20 312c 2066 6f75 7429 3b0a 2020 2020  , 1, fout);.    
-000883e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000883f0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
-00088400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00088410: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
-00088420: 6e74 3332 5f74 206e 756c 203d 202d 313b  nt32_t nul = -1;
-00088430: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00088440: 2020 2020 2020 2020 2020 2020 2020 6677                fw
-00088450: 7269 7465 2826 6e75 6c2c 2073 697a 656f  rite(&nul, sizeo
-00088460: 6628 696e 7433 325f 7429 2c20 312c 2066  f(int32_t), 1, f
-00088470: 6f75 7429 3b0a 2020 2020 2020 2020 2020  out);.          
-00088480: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+000883b0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
+000883c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000883d0: 2020 2020 2020 2020 2020 6966 2028 6964            if (id
+000883e0: 7820 3d3d 202d 3129 207b 0a20 2020 2020  x == -1) {.     
+000883f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088400: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+00088410: 7466 2873 7464 6572 722c 2022 2573 3a20  tf(stderr, "%s: 
+00088420: 6661 696c 6564 2074 6f20 6669 6e64 2074  failed to find t
+00088430: 656e 736f 722c 2061 7267 203d 2025 642c  ensor, arg = %d,
+00088440: 206e 6f64 6520 3d20 2564 5c6e 222c 205f   node = %d\n", _
+00088450: 5f66 756e 635f 5f2c 206a 2c20 6929 3b0a  _func__, j, i);.
+00088460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088480: 7265 7475 726e 3b0a 2020 2020 2020 2020  return;.        
 00088490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000884a0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000884b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000884c0: 2020 2020 7d0a 2020 2020 2020 2020 7d0a      }.        }.
-000884d0: 0a20 2020 2020 2020 2066 636c 6f73 6528  .        fclose(
-000884e0: 666f 7574 293b 0a20 2020 207d 0a7d 0a0a  fout);.    }.}..
-000884f0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-00088500: 7068 2067 676d 6c5f 6772 6170 685f 696d  ph ggml_graph_im
-00088510: 706f 7274 2863 6f6e 7374 2063 6861 7220  port(const char 
-00088520: 2a20 666e 616d 652c 2073 7472 7563 7420  * fname, struct 
-00088530: 6767 6d6c 5f63 6f6e 7465 7874 202a 2a20  ggml_context ** 
-00088540: 6374 785f 6461 7461 2c20 7374 7275 6374  ctx_data, struct
-00088550: 2067 676d 6c5f 636f 6e74 6578 7420 2a2a   ggml_context **
-00088560: 2063 7478 5f65 7661 6c29 207b 0a20 2020   ctx_eval) {.   
-00088570: 2061 7373 6572 7428 2a63 7478 5f64 6174   assert(*ctx_dat
-00088580: 6120 3d3d 204e 554c 4c29 3b0a 2020 2020  a == NULL);.    
-00088590: 6173 7365 7274 282a 6374 785f 6576 616c  assert(*ctx_eval
-000885a0: 203d 3d20 4e55 4c4c 293b 0a0a 2020 2020   == NULL);..    
-000885b0: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-000885c0: 7068 2072 6573 756c 7420 3d20 7b20 3020  ph result = { 0 
-000885d0: 7d3b 0a0a 2020 2020 7374 7275 6374 2067  };..    struct g
-000885e0: 676d 6c5f 7465 6e73 6f72 202a 2064 6174  gml_tensor * dat
-000885f0: 6120 3d20 4e55 4c4c 3b0a 0a20 2020 202f  a = NULL;..    /
-00088600: 2f20 7265 6164 2066 696c 6520 696e 746f  / read file into
-00088610: 2064 6174 610a 2020 2020 7b0a 2020 2020   data.    {.    
-00088620: 2020 2020 4649 4c45 202a 2066 696e 203d      FILE * fin =
-00088630: 2066 6f70 656e 2866 6e61 6d65 2c20 2272   fopen(fname, "r
-00088640: 6222 293b 0a20 2020 2020 2020 2069 6620  b");.        if 
-00088650: 2821 6669 6e29 207b 0a20 2020 2020 2020  (!fin) {.       
-00088660: 2020 2020 2066 7072 696e 7466 2873 7464       fprintf(std
-00088670: 6572 722c 2022 2573 3a20 6661 696c 6564  err, "%s: failed
-00088680: 2074 6f20 6f70 656e 2025 735c 6e22 2c20   to open %s\n", 
-00088690: 5f5f 6675 6e63 5f5f 2c20 666e 616d 6529  __func__, fname)
-000886a0: 3b0a 2020 2020 2020 2020 2020 2020 7265  ;.            re
-000886b0: 7475 726e 2072 6573 756c 743b 0a20 2020  turn result;.   
-000886c0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-000886d0: 7369 7a65 5f74 2066 7369 7a65 203d 2030  size_t fsize = 0
-000886e0: 3b0a 0a20 2020 2020 2020 2066 7365 656b  ;..        fseek
-000886f0: 2866 696e 2c20 302c 2053 4545 4b5f 454e  (fin, 0, SEEK_EN
-00088700: 4429 3b0a 2020 2020 2020 2020 6673 697a  D);.        fsiz
-00088710: 6520 3d20 6674 656c 6c28 6669 6e29 3b0a  e = ftell(fin);.
-00088720: 2020 2020 2020 2020 6673 6565 6b28 6669          fseek(fi
-00088730: 6e2c 2030 2c20 5345 454b 5f53 4554 293b  n, 0, SEEK_SET);
-00088740: 0a0a 2020 2020 2020 2020 2f2f 2063 7265  ..        // cre
-00088750: 6174 6520 7468 6520 6461 7461 2063 6f6e  ate the data con
-00088760: 7465 7874 0a20 2020 2020 2020 207b 0a20  text.        {. 
-00088770: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00088780: 2073 697a 655f 7420 6f76 6572 6865 6164   size_t overhead
-00088790: 203d 2031 2a67 676d 6c5f 7465 6e73 6f72   = 1*ggml_tensor
-000887a0: 5f6f 7665 7268 6561 6428 293b 0a0a 2020  _overhead();..  
-000887b0: 2020 2020 2020 2020 2020 7374 7275 6374            struct
-000887c0: 2067 676d 6c5f 696e 6974 5f70 6172 616d   ggml_init_param
-000887d0: 7320 7061 7261 6d73 203d 207b 0a20 2020  s params = {.   
-000887e0: 2020 2020 2020 2020 2020 2020 202e 6d65               .me
-000887f0: 6d5f 7369 7a65 2020 203d 2066 7369 7a65  m_size   = fsize
-00088800: 202b 206f 7665 7268 6561 642c 0a20 2020   + overhead,.   
-00088810: 2020 2020 2020 2020 2020 2020 202e 6d65               .me
-00088820: 6d5f 6275 6666 6572 203d 204e 554c 4c2c  m_buffer = NULL,
-00088830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00088840: 202e 6e6f 5f61 6c6c 6f63 2020 203d 2066   .no_alloc   = f
-00088850: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00088860: 2020 7d3b 0a0a 2020 2020 2020 2020 2020    };..          
-00088870: 2020 2a63 7478 5f64 6174 6120 3d20 6767    *ctx_data = gg
-00088880: 6d6c 5f69 6e69 7428 7061 7261 6d73 293b  ml_init(params);
-00088890: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-000888a0: 2028 212a 6374 785f 6461 7461 2920 7b0a   (!*ctx_data) {.
-000888b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000888c0: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
-000888d0: 2225 733a 2066 6169 6c65 6420 746f 2063  "%s: failed to c
-000888e0: 7265 6174 6520 6767 6d6c 2063 6f6e 7465  reate ggml conte
-000888f0: 7874 5c6e 222c 205f 5f66 756e 635f 5f29  xt\n", __func__)
-00088900: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00088910: 2020 6663 6c6f 7365 2866 696e 293b 0a20    fclose(fin);. 
-00088920: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00088930: 6574 7572 6e20 7265 7375 6c74 3b0a 2020  eturn result;.  
-00088940: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00088950: 2020 2020 7d0a 0a20 2020 2020 2020 2064      }..        d
-00088960: 6174 6120 3d20 6767 6d6c 5f6e 6577 5f74  ata = ggml_new_t
-00088970: 656e 736f 725f 3164 282a 6374 785f 6461  ensor_1d(*ctx_da
-00088980: 7461 2c20 4747 4d4c 5f54 5950 455f 4938  ta, GGML_TYPE_I8
-00088990: 2c20 6673 697a 6529 3b0a 0a20 2020 2020  , fsize);..     
-000889a0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-000889b0: 2063 6f6e 7374 2073 697a 655f 7420 7265   const size_t re
-000889c0: 7420 3d20 6672 6561 6428 6461 7461 2d3e  t = fread(data->
-000889d0: 6461 7461 2c20 7369 7a65 6f66 2863 6861  data, sizeof(cha
-000889e0: 7229 2c20 6673 697a 652c 2066 696e 293b  r), fsize, fin);
-000889f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00088a00: 2872 6574 2021 3d20 6673 697a 6529 207b  (ret != fsize) {
+000884a0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+000884b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000884c0: 2020 2066 7772 6974 6528 2669 6478 2c20     fwrite(&idx, 
+000884d0: 7369 7a65 6f66 2869 6e74 3332 5f74 292c  sizeof(int32_t),
+000884e0: 2031 2c20 666f 7574 293b 0a20 2020 2020   1, fout);.     
+000884f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088500: 2020 207d 2065 6c73 6520 7b0a 2020 2020     } else {.    
+00088510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088520: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
+00088530: 7433 325f 7420 6e75 6c20 3d20 2d31 3b0a  t32_t nul = -1;.
+00088540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00088550: 2020 2020 2020 2020 2020 2020 2066 7772               fwr
+00088560: 6974 6528 266e 756c 2c20 7369 7a65 6f66  ite(&nul, sizeof
+00088570: 2869 6e74 3332 5f74 292c 2031 2c20 666f  (int32_t), 1, fo
+00088580: 7574 293b 0a20 2020 2020 2020 2020 2020  ut);.           
+00088590: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000885a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000885b0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+000885c0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000885d0: 2020 207d 0a20 2020 2020 2020 207d 0a0a     }.        }..
+000885e0: 2020 2020 2020 2020 6663 6c6f 7365 2866          fclose(f
+000885f0: 6f75 7429 3b0a 2020 2020 7d0a 7d0a 0a73  out);.    }.}..s
+00088600: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+00088610: 6820 6767 6d6c 5f67 7261 7068 5f69 6d70  h ggml_graph_imp
+00088620: 6f72 7428 636f 6e73 7420 6368 6172 202a  ort(const char *
+00088630: 2066 6e61 6d65 2c20 7374 7275 6374 2067   fname, struct g
+00088640: 676d 6c5f 636f 6e74 6578 7420 2a2a 2063  gml_context ** c
+00088650: 7478 5f64 6174 612c 2073 7472 7563 7420  tx_data, struct 
+00088660: 6767 6d6c 5f63 6f6e 7465 7874 202a 2a20  ggml_context ** 
+00088670: 6374 785f 6576 616c 2920 7b0a 2020 2020  ctx_eval) {.    
+00088680: 6173 7365 7274 282a 6374 785f 6461 7461  assert(*ctx_data
+00088690: 203d 3d20 4e55 4c4c 293b 0a20 2020 2061   == NULL);.    a
+000886a0: 7373 6572 7428 2a63 7478 5f65 7661 6c20  ssert(*ctx_eval 
+000886b0: 3d3d 204e 554c 4c29 3b0a 0a20 2020 2073  == NULL);..    s
+000886c0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+000886d0: 6820 7265 7375 6c74 203d 207b 2030 207d  h result = { 0 }
+000886e0: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+000886f0: 6d6c 5f74 656e 736f 7220 2a20 6461 7461  ml_tensor * data
+00088700: 203d 204e 554c 4c3b 0a0a 2020 2020 2f2f   = NULL;..    //
+00088710: 2072 6561 6420 6669 6c65 2069 6e74 6f20   read file into 
+00088720: 6461 7461 0a20 2020 207b 0a20 2020 2020  data.    {.     
+00088730: 2020 2046 494c 4520 2a20 6669 6e20 3d20     FILE * fin = 
+00088740: 666f 7065 6e28 666e 616d 652c 2022 7262  fopen(fname, "rb
+00088750: 2229 3b0a 2020 2020 2020 2020 6966 2028  ");.        if (
+00088760: 2166 696e 2920 7b0a 2020 2020 2020 2020  !fin) {.        
+00088770: 2020 2020 6670 7269 6e74 6628 7374 6465      fprintf(stde
+00088780: 7272 2c20 2225 733a 2066 6169 6c65 6420  rr, "%s: failed 
+00088790: 746f 206f 7065 6e20 2573 5c6e 222c 205f  to open %s\n", _
+000887a0: 5f66 756e 635f 5f2c 2066 6e61 6d65 293b  _func__, fname);
+000887b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000887c0: 7572 6e20 7265 7375 6c74 3b0a 2020 2020  urn result;.    
+000887d0: 2020 2020 7d0a 0a20 2020 2020 2020 2073      }..        s
+000887e0: 697a 655f 7420 6673 697a 6520 3d20 303b  ize_t fsize = 0;
+000887f0: 0a0a 2020 2020 2020 2020 6673 6565 6b28  ..        fseek(
+00088800: 6669 6e2c 2030 2c20 5345 454b 5f45 4e44  fin, 0, SEEK_END
+00088810: 293b 0a20 2020 2020 2020 2066 7369 7a65  );.        fsize
+00088820: 203d 2066 7465 6c6c 2866 696e 293b 0a20   = ftell(fin);. 
+00088830: 2020 2020 2020 2066 7365 656b 2866 696e         fseek(fin
+00088840: 2c20 302c 2053 4545 4b5f 5345 5429 3b0a  , 0, SEEK_SET);.
+00088850: 0a20 2020 2020 2020 202f 2f20 6372 6561  .        // crea
+00088860: 7465 2074 6865 2064 6174 6120 636f 6e74  te the data cont
+00088870: 6578 740a 2020 2020 2020 2020 7b0a 2020  ext.        {.  
+00088880: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00088890: 7369 7a65 5f74 206f 7665 7268 6561 6420  size_t overhead 
+000888a0: 3d20 312a 6767 6d6c 5f74 656e 736f 725f  = 1*ggml_tensor_
+000888b0: 6f76 6572 6865 6164 2829 3b0a 0a20 2020  overhead();..   
+000888c0: 2020 2020 2020 2020 2073 7472 7563 7420           struct 
+000888d0: 6767 6d6c 5f69 6e69 745f 7061 7261 6d73  ggml_init_params
+000888e0: 2070 6172 616d 7320 3d20 7b0a 2020 2020   params = {.    
+000888f0: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
+00088900: 5f73 697a 6520 2020 3d20 6673 697a 6520  _size   = fsize 
+00088910: 2b20 6f76 6572 6865 6164 2c0a 2020 2020  + overhead,.    
+00088920: 2020 2020 2020 2020 2020 2020 2e6d 656d              .mem
+00088930: 5f62 7566 6665 7220 3d20 4e55 4c4c 2c0a  _buffer = NULL,.
+00088940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088950: 2e6e 6f5f 616c 6c6f 6320 2020 3d20 6661  .no_alloc   = fa
+00088960: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
+00088970: 207d 3b0a 0a20 2020 2020 2020 2020 2020   };..           
+00088980: 202a 6374 785f 6461 7461 203d 2067 676d   *ctx_data = ggm
+00088990: 6c5f 696e 6974 2870 6172 616d 7329 3b0a  l_init(params);.
+000889a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000889b0: 2821 2a63 7478 5f64 6174 6129 207b 0a20  (!*ctx_data) {. 
+000889c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000889d0: 7072 696e 7466 2873 7464 6572 722c 2022  printf(stderr, "
+000889e0: 2573 3a20 6661 696c 6564 2074 6f20 6372  %s: failed to cr
+000889f0: 6561 7465 2067 676d 6c20 636f 6e74 6578  eate ggml contex
+00088a00: 745c 6e22 2c20 5f5f 6675 6e63 5f5f 293b  t\n", __func__);
 00088a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00088a20: 2066 7072 696e 7466 2873 7464 6572 722c   fprintf(stderr,
-00088a30: 2022 2573 3a20 6661 696c 6564 2074 6f20   "%s: failed to 
-00088a40: 7265 6164 2025 735c 6e22 2c20 5f5f 6675  read %s\n", __fu
-00088a50: 6e63 5f5f 2c20 666e 616d 6529 3b0a 2020  nc__, fname);.  
-00088a60: 2020 2020 2020 2020 2020 2020 2020 6663                fc
-00088a70: 6c6f 7365 2866 696e 293b 0a20 2020 2020  lose(fin);.     
-00088a80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00088a90: 6e20 7265 7375 6c74 3b0a 2020 2020 2020  n result;.      
-00088aa0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00088ab0: 7d0a 0a20 2020 2020 2020 2066 636c 6f73  }..        fclos
-00088ac0: 6528 6669 6e29 3b0a 2020 2020 7d0a 0a20  e(fin);.    }.. 
-00088ad0: 2020 202f 2f20 706f 7075 6c61 7465 2072     // populate r
-00088ae0: 6573 756c 740a 2020 2020 7b0a 2020 2020  esult.    {.    
-00088af0: 2020 2020 6368 6172 202a 2070 7472 203d      char * ptr =
-00088b00: 2028 6368 6172 202a 2920 6461 7461 2d3e   (char *) data->
-00088b10: 6461 7461 3b0a 0a20 2020 2020 2020 2063  data;..        c
-00088b20: 6f6e 7374 2075 696e 7433 325f 7420 6d61  onst uint32_t ma
-00088b30: 6769 6320 3d20 2a28 636f 6e73 7420 7569  gic = *(const ui
-00088b40: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
-00088b50: 7472 202b 3d20 7369 7a65 6f66 286d 6167  tr += sizeof(mag
-00088b60: 6963 293b 0a0a 2020 2020 2020 2020 6966  ic);..        if
-00088b70: 2028 6d61 6769 6320 213d 2047 474d 4c5f   (magic != GGML_
-00088b80: 4649 4c45 5f4d 4147 4943 2920 7b0a 2020  FILE_MAGIC) {.  
-00088b90: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
-00088ba0: 6628 7374 6465 7272 2c20 2225 733a 2069  f(stderr, "%s: i
-00088bb0: 6e76 616c 6964 206d 6167 6963 206e 756d  nvalid magic num
-00088bc0: 6265 722c 2067 6f74 2025 3038 785c 6e22  ber, got %08x\n"
-00088bd0: 2c20 5f5f 6675 6e63 5f5f 2c20 6d61 6769  , __func__, magi
-00088be0: 6329 3b0a 2020 2020 2020 2020 2020 2020  c);.            
-00088bf0: 7265 7475 726e 2072 6573 756c 743b 0a20  return result;. 
-00088c00: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00088c10: 2020 636f 6e73 7420 7569 6e74 3332 5f74    const uint32_t
-00088c20: 2076 6572 7369 6f6e 203d 202a 2863 6f6e   version = *(con
-00088c30: 7374 2075 696e 7433 325f 7420 2a29 2070  st uint32_t *) p
-00088c40: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
-00088c50: 6628 7665 7273 696f 6e29 3b0a 0a20 2020  f(version);..   
-00088c60: 2020 2020 2069 6620 2876 6572 7369 6f6e       if (version
-00088c70: 2021 3d20 4747 4d4c 5f46 494c 455f 5645   != GGML_FILE_VE
-00088c80: 5253 494f 4e29 207b 0a20 2020 2020 2020  RSION) {.       
-00088c90: 2020 2020 2066 7072 696e 7466 2873 7464       fprintf(std
-00088ca0: 6572 722c 2022 2573 3a20 696e 7661 6c69  err, "%s: invali
-00088cb0: 6420 7665 7273 696f 6e20 6e75 6d62 6572  d version number
-00088cc0: 5c6e 222c 205f 5f66 756e 635f 5f29 3b0a  \n", __func__);.
-00088cd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00088ce0: 726e 2072 6573 756c 743b 0a20 2020 2020  rn result;.     
-00088cf0: 2020 207d 0a0a 2020 2020 2020 2020 636f     }..        co
-00088d00: 6e73 7420 7569 6e74 3332 5f74 206e 5f6c  nst uint32_t n_l
-00088d10: 6561 6673 2020 203d 202a 2863 6f6e 7374  eafs   = *(const
-00088d20: 2075 696e 7433 325f 7420 2a29 2070 7472   uint32_t *) ptr
-00088d30: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
-00088d40: 6e5f 6c65 6166 7329 3b0a 2020 2020 2020  n_leafs);.      
-00088d50: 2020 636f 6e73 7420 7569 6e74 3332 5f74    const uint32_t
-00088d60: 206e 5f6e 6f64 6573 2020 203d 202a 2863   n_nodes   = *(c
-00088d70: 6f6e 7374 2075 696e 7433 325f 7420 2a29  onst uint32_t *)
-00088d80: 2070 7472 3b20 7074 7220 2b3d 2073 697a   ptr; ptr += siz
-00088d90: 656f 6628 6e5f 6e6f 6465 7329 3b0a 2020  eof(n_nodes);.  
-00088da0: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
-00088db0: 3634 5f74 2073 697a 655f 6576 616c 203d  64_t size_eval =
-00088dc0: 202a 2863 6f6e 7374 2075 696e 7436 345f   *(const uint64_
-00088dd0: 7420 2a29 2070 7472 3b20 7074 7220 2b3d  t *) ptr; ptr +=
-00088de0: 2073 697a 656f 6628 7369 7a65 5f65 7661   sizeof(size_eva
-00088df0: 6c29 3b0a 0a20 2020 2020 2020 2072 6573  l);..        res
-00088e00: 756c 742e 6e5f 6c65 6166 7320 3d20 6e5f  ult.n_leafs = n_
-00088e10: 6c65 6166 733b 0a20 2020 2020 2020 2072  leafs;.        r
-00088e20: 6573 756c 742e 6e5f 6e6f 6465 7320 3d20  esult.n_nodes = 
-00088e30: 6e5f 6e6f 6465 733b 0a0a 2020 2020 2020  n_nodes;..      
-00088e40: 2020 2f2f 2063 7265 6174 6520 7468 6520    // create the 
-00088e50: 6461 7461 2063 6f6e 7465 7874 0a20 2020  data context.   
-00088e60: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00088e70: 2020 2063 6f6e 7374 2073 697a 655f 7420     const size_t 
-00088e80: 6f76 6572 6865 6164 203d 2028 6e5f 6c65  overhead = (n_le
-00088e90: 6166 7320 2b20 6e5f 6e6f 6465 7329 2a67  afs + n_nodes)*g
-00088ea0: 676d 6c5f 7465 6e73 6f72 5f6f 7665 7268  gml_tensor_overh
-00088eb0: 6561 6428 293b 0a0a 2020 2020 2020 2020  ead();..        
-00088ec0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
-00088ed0: 696e 6974 5f70 6172 616d 7320 7061 7261  init_params para
-00088ee0: 6d73 203d 207b 0a20 2020 2020 2020 2020  ms = {.         
-00088ef0: 2020 2020 2020 202e 6d65 6d5f 7369 7a65         .mem_size
-00088f00: 2020 203d 2073 697a 655f 6576 616c 202b     = size_eval +
-00088f10: 206f 7665 7268 6561 642c 0a20 2020 2020   overhead,.     
-00088f20: 2020 2020 2020 2020 2020 202e 6d65 6d5f             .mem_
-00088f30: 6275 6666 6572 203d 204e 554c 4c2c 0a20  buffer = NULL,. 
-00088f40: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-00088f50: 6e6f 5f61 6c6c 6f63 2020 203d 2074 7275  no_alloc   = tru
-00088f60: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
-00088f70: 3b0a 0a20 2020 2020 2020 2020 2020 202a  ;..            *
-00088f80: 6374 785f 6576 616c 203d 2067 676d 6c5f  ctx_eval = ggml_
-00088f90: 696e 6974 2870 6172 616d 7329 3b0a 0a20  init(params);.. 
-00088fa0: 2020 2020 2020 2020 2020 2069 6620 2821             if (!
-00088fb0: 2a63 7478 5f65 7661 6c29 207b 0a20 2020  *ctx_eval) {.   
-00088fc0: 2020 2020 2020 2020 2020 2020 2066 7072               fpr
-00088fd0: 696e 7466 2873 7464 6572 722c 2022 2573  intf(stderr, "%s
-00088fe0: 3a20 6661 696c 6564 2074 6f20 6372 6561  : failed to crea
-00088ff0: 7465 2067 676d 6c20 636f 6e74 6578 745c  te ggml context\
-00089000: 6e22 2c20 5f5f 6675 6e63 5f5f 293b 0a20  n", __func__);. 
-00089010: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00089020: 6574 7572 6e20 7265 7375 6c74 3b0a 2020  eturn result;.  
-00089030: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00089040: 2020 2020 7d0a 0a20 2020 2020 2020 202f      }..        /
-00089050: 2f20 6c65 6166 730a 2020 2020 2020 2020  / leafs.        
-00089060: 7b0a 2020 2020 2020 2020 2020 2020 7569  {.            ui
-00089070: 6e74 3332 5f74 2074 7970 653b 0a20 2020  nt32_t type;.   
-00089080: 2020 2020 2020 2020 2075 696e 7433 325f           uint32_
-00089090: 7420 6f70 3b0a 2020 2020 2020 2020 2020  t op;.          
-000890a0: 2020 7569 6e74 3332 5f74 206e 5f64 696d    uint32_t n_dim
-000890b0: 733b 0a0a 2020 2020 2020 2020 2020 2020  s;..            
-000890c0: 666f 7220 2875 696e 7433 325f 7420 6920  for (uint32_t i 
-000890d0: 3d20 303b 2069 203c 206e 5f6c 6561 6673  = 0; i < n_leafs
-000890e0: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-000890f0: 2020 2020 2020 2020 2074 7970 6520 2020           type   
-00089100: 3d20 2a28 636f 6e73 7420 7569 6e74 3332  = *(const uint32
-00089110: 5f74 202a 2920 7074 723b 2070 7472 202b  _t *) ptr; ptr +
-00089120: 3d20 7369 7a65 6f66 2874 7970 6529 3b0a  = sizeof(type);.
-00089130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089140: 6f70 2020 2020 203d 202a 2863 6f6e 7374  op     = *(const
-00089150: 2075 696e 7433 325f 7420 2a29 2070 7472   uint32_t *) ptr
-00089160: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
-00089170: 6f70 293b 0a20 2020 2020 2020 2020 2020  op);.           
-00089180: 2020 2020 206e 5f64 696d 7320 3d20 2a28       n_dims = *(
-00089190: 636f 6e73 7420 7569 6e74 3332 5f74 202a  const uint32_t *
-000891a0: 2920 7074 723b 2070 7472 202b 3d20 7369  ) ptr; ptr += si
-000891b0: 7a65 6f66 286e 5f64 696d 7329 3b0a 0a20  zeof(n_dims);.. 
-000891c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000891d0: 6e74 3634 5f74 206e 655b 4747 4d4c 5f4d  nt64_t ne[GGML_M
-000891e0: 4158 5f44 494d 535d 3b0a 2020 2020 2020  AX_DIMS];.      
-000891f0: 2020 2020 2020 2020 2020 7369 7a65 5f74            size_t
-00089200: 2020 6e62 5b47 474d 4c5f 4d41 585f 4449    nb[GGML_MAX_DI
-00089210: 4d53 5d3b 0a0a 2020 2020 2020 2020 2020  MS];..          
-00089220: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-00089230: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f4d   = 0; j < GGML_M
-00089240: 4158 5f44 494d 533b 202b 2b6a 2920 7b0a  AX_DIMS; ++j) {.
-00089250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089260: 2020 2020 7569 6e74 3634 5f74 206e 655f      uint64_t ne_
-00089270: 6375 723b 0a20 2020 2020 2020 2020 2020  cur;.           
-00089280: 2020 2020 2020 2020 2075 696e 7436 345f           uint64_
-00089290: 7420 6e62 5f63 7572 3b0a 0a20 2020 2020  t nb_cur;..     
-000892a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000892b0: 655f 6375 7220 3d20 2a28 636f 6e73 7420  e_cur = *(const 
-000892c0: 7569 6e74 3634 5f74 202a 2920 7074 723b  uint64_t *) ptr;
-000892d0: 2070 7472 202b 3d20 7369 7a65 6f66 286e   ptr += sizeof(n
-000892e0: 655f 6375 7229 3b0a 2020 2020 2020 2020  e_cur);.        
-000892f0: 2020 2020 2020 2020 2020 2020 6e62 5f63              nb_c
-00089300: 7572 203d 202a 2863 6f6e 7374 2075 696e  ur = *(const uin
-00089310: 7436 345f 7420 2a29 2070 7472 3b20 7074  t64_t *) ptr; pt
-00089320: 7220 2b3d 2073 697a 656f 6628 6e62 5f63  r += sizeof(nb_c
-00089330: 7572 293b 0a0a 2020 2020 2020 2020 2020  ur);..          
-00089340: 2020 2020 2020 2020 2020 6e65 5b6a 5d20            ne[j] 
-00089350: 3d20 6e65 5f63 7572 3b0a 2020 2020 2020  = ne_cur;.      
-00089360: 2020 2020 2020 2020 2020 2020 2020 6e62                nb
-00089370: 5b6a 5d20 3d20 6e62 5f63 7572 3b0a 2020  [j] = nb_cur;.  
-00089380: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00089390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000893a0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-000893b0: 736f 7220 2a20 7465 6e73 6f72 203d 2067  sor * tensor = g
-000893c0: 676d 6c5f 6e65 775f 7465 6e73 6f72 282a  gml_new_tensor(*
-000893d0: 6374 785f 6576 616c 2c20 2865 6e75 6d20  ctx_eval, (enum 
-000893e0: 6767 6d6c 5f74 7970 6529 2074 7970 652c  ggml_type) type,
-000893f0: 206e 5f64 696d 732c 206e 6529 3b0a 0a20   n_dims, ne);.. 
-00089400: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00089410: 656e 736f 722d 3e6f 7020 3d20 2865 6e75  ensor->op = (enu
-00089420: 6d20 6767 6d6c 5f6f 7029 206f 703b 0a0a  m ggml_op) op;..
-00089430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089440: 6d65 6d63 7079 2874 656e 736f 722d 3e6e  memcpy(tensor->n
-00089450: 616d 652c 2070 7472 2c20 4747 4d4c 5f4d  ame, ptr, GGML_M
-00089460: 4158 5f4e 414d 4529 3b20 7074 7220 2b3d  AX_NAME); ptr +=
-00089470: 2047 474d 4c5f 4d41 585f 4e41 4d45 3b0a   GGML_MAX_NAME;.
-00089480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00089490: 2074 656e 736f 722d 3e64 6174 6120 3d20   tensor->data = 
-000894a0: 2876 6f69 6420 2a29 2070 7472 3b0a 0a20  (void *) ptr;.. 
-000894b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000894c0: 6f72 2028 696e 7420 6a20 3d20 303b 206a  or (int j = 0; j
-000894d0: 203c 2047 474d 4c5f 4d41 585f 4449 4d53   < GGML_MAX_DIMS
-000894e0: 3b20 2b2b 6a29 207b 0a20 2020 2020 2020  ; ++j) {.       
-000894f0: 2020 2020 2020 2020 2020 2020 2074 656e               ten
-00089500: 736f 722d 3e6e 625b 6a5d 203d 206e 625b  sor->nb[j] = nb[
-00089510: 6a5d 3b0a 2020 2020 2020 2020 2020 2020  j];.            
-00089520: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
-00089530: 2020 2020 2020 2072 6573 756c 742e 6c65         result.le
-00089540: 6166 735b 695d 203d 2074 656e 736f 723b  afs[i] = tensor;
-00089550: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00089560: 2020 7074 7220 2b3d 2067 676d 6c5f 6e62    ptr += ggml_nb
-00089570: 7974 6573 2874 656e 736f 7229 3b0a 0a20  ytes(tensor);.. 
-00089580: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00089590: 7072 696e 7466 2873 7464 6572 722c 2022  printf(stderr, "
-000895a0: 2573 3a20 6c6f 6164 6564 206c 6561 6620  %s: loaded leaf 
-000895b0: 2564 3a20 2725 3136 7327 2c20 2533 6420  %d: '%16s', %3d 
-000895c0: 6469 6d73 2c20 2539 7a75 2062 7974 6573  dims, %9zu bytes
-000895d0: 5c6e 222c 205f 5f66 756e 635f 5f2c 2069  \n", __func__, i
-000895e0: 2c20 7465 6e73 6f72 2d3e 6e61 6d65 2c20  , tensor->name, 
-000895f0: 6e5f 6469 6d73 2c20 6767 6d6c 5f6e 6279  n_dims, ggml_nby
-00089600: 7465 7328 7465 6e73 6f72 2929 3b0a 2020  tes(tensor));.  
-00089610: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00089620: 2020 2020 7d0a 0a20 2020 2020 2020 2067      }..        g
-00089630: 676d 6c5f 7365 745f 6e6f 5f61 6c6c 6f63  gml_set_no_alloc
-00089640: 282a 6374 785f 6576 616c 2c20 6661 6c73  (*ctx_eval, fals
-00089650: 6529 3b0a 0a20 2020 2020 2020 202f 2f20  e);..        // 
-00089660: 6e6f 6465 730a 2020 2020 2020 2020 7b0a  nodes.        {.
-00089670: 2020 2020 2020 2020 2020 2020 7569 6e74              uint
-00089680: 3332 5f74 2074 7970 653b 0a20 2020 2020  32_t type;.     
-00089690: 2020 2020 2020 2075 696e 7433 325f 7420         uint32_t 
-000896a0: 6f70 3b0a 2020 2020 2020 2020 2020 2020  op;.            
-000896b0: 7569 6e74 3332 5f74 206e 5f64 696d 733b  uint32_t n_dims;
-000896c0: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-000896d0: 7220 2875 696e 7433 325f 7420 6920 3d20  r (uint32_t i = 
-000896e0: 303b 2069 203c 206e 5f6e 6f64 6573 3b20  0; i < n_nodes; 
-000896f0: 2b2b 6929 207b 0a20 2020 2020 2020 2020  ++i) {.         
-00089700: 2020 2020 2020 2074 7970 6520 2020 3d20         type   = 
-00089710: 2a28 636f 6e73 7420 7569 6e74 3332 5f74  *(const uint32_t
-00089720: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
-00089730: 7369 7a65 6f66 2874 7970 6529 3b0a 2020  sizeof(type);.  
-00089740: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-00089750: 2020 2020 203d 202a 2863 6f6e 7374 2075       = *(const u
-00089760: 696e 7433 325f 7420 2a29 2070 7472 3b20  int32_t *) ptr; 
-00089770: 7074 7220 2b3d 2073 697a 656f 6628 6f70  ptr += sizeof(op
-00089780: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00089790: 2020 206e 5f64 696d 7320 3d20 2a28 636f     n_dims = *(co
-000897a0: 6e73 7420 7569 6e74 3332 5f74 202a 2920  nst uint32_t *) 
-000897b0: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
-000897c0: 6f66 286e 5f64 696d 7329 3b0a 0a20 2020  of(n_dims);..   
-000897d0: 2020 2020 2020 2020 2020 2020 2065 6e75               enu
-000897e0: 6d20 6767 6d6c 5f6f 7020 656f 7020 3d20  m ggml_op eop = 
-000897f0: 2865 6e75 6d20 6767 6d6c 5f6f 7029 206f  (enum ggml_op) o
-00089800: 703b 0a0a 2020 2020 2020 2020 2020 2020  p;..            
-00089810: 2020 2020 696e 7436 345f 7420 6e65 5b47      int64_t ne[G
-00089820: 474d 4c5f 4d41 585f 4449 4d53 5d3b 0a20  GML_MAX_DIMS];. 
-00089830: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00089840: 697a 655f 7420 206e 625b 4747 4d4c 5f4d  ize_t  nb[GGML_M
-00089850: 4158 5f44 494d 535d 3b0a 0a20 2020 2020  AX_DIMS];..     
-00089860: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-00089870: 696e 7420 6a20 3d20 303b 206a 203c 2047  int j = 0; j < G
-00089880: 474d 4c5f 4d41 585f 4449 4d53 3b20 2b2b  GML_MAX_DIMS; ++
-00089890: 6a29 207b 0a20 2020 2020 2020 2020 2020  j) {.           
-000898a0: 2020 2020 2020 2020 2075 696e 7436 345f           uint64_
-000898b0: 7420 6e65 5f63 7572 3b0a 2020 2020 2020  t ne_cur;.      
-000898c0: 2020 2020 2020 2020 2020 2020 2020 7569                ui
-000898d0: 6e74 3634 5f74 206e 625f 6375 723b 0a0a  nt64_t nb_cur;..
-000898e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000898f0: 2020 2020 6e65 5f63 7572 203d 202a 2863      ne_cur = *(c
-00089900: 6f6e 7374 2075 696e 7436 345f 7420 2a29  onst uint64_t *)
-00089910: 2070 7472 3b20 7074 7220 2b3d 2073 697a   ptr; ptr += siz
-00089920: 656f 6628 6e65 5f63 7572 293b 0a20 2020  eof(ne_cur);.   
-00089930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089940: 206e 625f 6375 7220 3d20 2a28 636f 6e73   nb_cur = *(cons
-00089950: 7420 7569 6e74 3634 5f74 202a 2920 7074  t uint64_t *) pt
-00089960: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
-00089970: 286e 625f 6375 7229 3b0a 0a20 2020 2020  (nb_cur);..     
-00089980: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00089990: 655b 6a5d 203d 206e 655f 6375 723b 0a20  e[j] = ne_cur;. 
-000899a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000899b0: 2020 206e 625b 6a5d 203d 206e 625f 6375     nb[j] = nb_cu
-000899c0: 723b 0a20 2020 2020 2020 2020 2020 2020  r;.             
-000899d0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-000899e0: 2020 2020 2020 636f 6e73 7420 6368 6172        const char
-000899f0: 202a 2070 7472 5f6e 616d 6520 3d20 7074   * ptr_name = pt
-00089a00: 723b 2070 7472 202b 3d20 4747 4d4c 5f4d  r; ptr += GGML_M
-00089a10: 4158 5f4e 414d 453b 0a0a 2020 2020 2020  AX_NAME;..      
-00089a20: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00089a30: 696e 7433 325f 7420 2a20 7074 725f 6172  int32_t * ptr_ar
-00089a40: 675f 6964 7820 3d20 2863 6f6e 7374 2069  g_idx = (const i
-00089a50: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
-00089a60: 7472 202b 3d20 4747 4d4c 5f4d 4158 5f53  tr += GGML_MAX_S
-00089a70: 5243 2a73 697a 656f 6628 696e 7433 325f  RC*sizeof(int32_
-00089a80: 7429 3b0a 0a20 2020 2020 2020 2020 2020  t);..           
-00089a90: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00089aa0: 5f74 656e 736f 7220 2a20 6172 6773 5b47  _tensor * args[G
-00089ab0: 474d 4c5f 4d41 585f 5352 435d 203d 207b  GML_MAX_SRC] = {
-00089ac0: 204e 554c 4c20 7d3b 0a0a 2020 2020 2020   NULL };..      
-00089ad0: 2020 2020 2020 2020 2020 2f2f 2070 6172            // par
-00089ae0: 7365 2061 7267 730a 2020 2020 2020 2020  se args.        
-00089af0: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
-00089b00: 206a 203d 2030 3b20 6a20 3c20 4747 4d4c   j = 0; j < GGML
-00089b10: 5f4d 4158 5f53 5243 3b20 2b2b 6a29 207b  _MAX_SRC; ++j) {
-00089b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00089b30: 2020 2020 2063 6f6e 7374 2069 6e74 3332       const int32
-00089b40: 5f74 2061 7267 5f69 6478 203d 2070 7472  _t arg_idx = ptr
-00089b50: 5f61 7267 5f69 6478 5b6a 5d3b 0a0a 2020  _arg_idx[j];..  
-00089b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089b70: 2020 6966 2028 6172 675f 6964 7820 3d3d    if (arg_idx ==
-00089b80: 202d 3129 207b 0a20 2020 2020 2020 2020   -1) {.         
-00089b90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00089ba0: 6f6e 7469 6e75 653b 0a20 2020 2020 2020  ontinue;.       
-00089bb0: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
-00089bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089bd0: 2020 2020 6966 2028 6172 675f 6964 7820      if (arg_idx 
-00089be0: 3c20 4747 4d4c 5f4d 4158 5f4e 4f44 4553  < GGML_MAX_NODES
-00089bf0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00089c00: 2020 2020 2020 2020 2020 2020 6172 6773              args
-00089c10: 5b6a 5d20 3d20 7265 7375 6c74 2e6c 6561  [j] = result.lea
-00089c20: 6673 5b61 7267 5f69 6478 5d3b 0a20 2020  fs[arg_idx];.   
+00088a20: 2066 636c 6f73 6528 6669 6e29 3b0a 2020   fclose(fin);.  
+00088a30: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00088a40: 7475 726e 2072 6573 756c 743b 0a20 2020  turn result;.   
+00088a50: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00088a60: 2020 207d 0a0a 2020 2020 2020 2020 6461     }..        da
+00088a70: 7461 203d 2067 676d 6c5f 6e65 775f 7465  ta = ggml_new_te
+00088a80: 6e73 6f72 5f31 6428 2a63 7478 5f64 6174  nsor_1d(*ctx_dat
+00088a90: 612c 2047 474d 4c5f 5459 5045 5f49 382c  a, GGML_TYPE_I8,
+00088aa0: 2066 7369 7a65 293b 0a0a 2020 2020 2020   fsize);..      
+00088ab0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00088ac0: 636f 6e73 7420 7369 7a65 5f74 2072 6574  const size_t ret
+00088ad0: 203d 2066 7265 6164 2864 6174 612d 3e64   = fread(data->d
+00088ae0: 6174 612c 2073 697a 656f 6628 6368 6172  ata, sizeof(char
+00088af0: 292c 2066 7369 7a65 2c20 6669 6e29 3b0a  ), fsize, fin);.
+00088b00: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00088b10: 7265 7420 213d 2066 7369 7a65 2920 7b0a  ret != fsize) {.
+00088b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00088b30: 6670 7269 6e74 6628 7374 6465 7272 2c20  fprintf(stderr, 
+00088b40: 2225 733a 2066 6169 6c65 6420 746f 2072  "%s: failed to r
+00088b50: 6561 6420 2573 5c6e 222c 205f 5f66 756e  ead %s\n", __fun
+00088b60: 635f 5f2c 2066 6e61 6d65 293b 0a20 2020  c__, fname);.   
+00088b70: 2020 2020 2020 2020 2020 2020 2066 636c               fcl
+00088b80: 6f73 6528 6669 6e29 3b0a 2020 2020 2020  ose(fin);.      
+00088b90: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00088ba0: 2072 6573 756c 743b 0a20 2020 2020 2020   result;.       
+00088bb0: 2020 2020 207d 0a20 2020 2020 2020 207d       }.        }
+00088bc0: 0a0a 2020 2020 2020 2020 6663 6c6f 7365  ..        fclose
+00088bd0: 2866 696e 293b 0a20 2020 207d 0a0a 2020  (fin);.    }..  
+00088be0: 2020 2f2f 2070 6f70 756c 6174 6520 7265    // populate re
+00088bf0: 7375 6c74 0a20 2020 207b 0a20 2020 2020  sult.    {.     
+00088c00: 2020 2063 6861 7220 2a20 7074 7220 3d20     char * ptr = 
+00088c10: 2863 6861 7220 2a29 2064 6174 612d 3e64  (char *) data->d
+00088c20: 6174 613b 0a0a 2020 2020 2020 2020 636f  ata;..        co
+00088c30: 6e73 7420 7569 6e74 3332 5f74 206d 6167  nst uint32_t mag
+00088c40: 6963 203d 202a 2863 6f6e 7374 2075 696e  ic = *(const uin
+00088c50: 7433 325f 7420 2a29 2070 7472 3b20 7074  t32_t *) ptr; pt
+00088c60: 7220 2b3d 2073 697a 656f 6628 6d61 6769  r += sizeof(magi
+00088c70: 6329 3b0a 0a20 2020 2020 2020 2069 6620  c);..        if 
+00088c80: 286d 6167 6963 2021 3d20 4747 4d4c 5f46  (magic != GGML_F
+00088c90: 494c 455f 4d41 4749 4329 207b 0a20 2020  ILE_MAGIC) {.   
+00088ca0: 2020 2020 2020 2020 2066 7072 696e 7466           fprintf
+00088cb0: 2873 7464 6572 722c 2022 2573 3a20 696e  (stderr, "%s: in
+00088cc0: 7661 6c69 6420 6d61 6769 6320 6e75 6d62  valid magic numb
+00088cd0: 6572 2c20 676f 7420 2530 3878 5c6e 222c  er, got %08x\n",
+00088ce0: 205f 5f66 756e 635f 5f2c 206d 6167 6963   __func__, magic
+00088cf0: 293b 0a20 2020 2020 2020 2020 2020 2072  );.            r
+00088d00: 6574 7572 6e20 7265 7375 6c74 3b0a 2020  eturn result;.  
+00088d10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00088d20: 2063 6f6e 7374 2075 696e 7433 325f 7420   const uint32_t 
+00088d30: 7665 7273 696f 6e20 3d20 2a28 636f 6e73  version = *(cons
+00088d40: 7420 7569 6e74 3332 5f74 202a 2920 7074  t uint32_t *) pt
+00088d50: 723b 2070 7472 202b 3d20 7369 7a65 6f66  r; ptr += sizeof
+00088d60: 2876 6572 7369 6f6e 293b 0a0a 2020 2020  (version);..    
+00088d70: 2020 2020 6966 2028 7665 7273 696f 6e20      if (version 
+00088d80: 213d 2047 474d 4c5f 4649 4c45 5f56 4552  != GGML_FILE_VER
+00088d90: 5349 4f4e 2920 7b0a 2020 2020 2020 2020  SION) {.        
+00088da0: 2020 2020 6670 7269 6e74 6628 7374 6465      fprintf(stde
+00088db0: 7272 2c20 2225 733a 2069 6e76 616c 6964  rr, "%s: invalid
+00088dc0: 2076 6572 7369 6f6e 206e 756d 6265 725c   version number\
+00088dd0: 6e22 2c20 5f5f 6675 6e63 5f5f 293b 0a20  n", __func__);. 
+00088de0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00088df0: 6e20 7265 7375 6c74 3b0a 2020 2020 2020  n result;.      
+00088e00: 2020 7d0a 0a20 2020 2020 2020 2063 6f6e    }..        con
+00088e10: 7374 2075 696e 7433 325f 7420 6e5f 6c65  st uint32_t n_le
+00088e20: 6166 7320 2020 3d20 2a28 636f 6e73 7420  afs   = *(const 
+00088e30: 7569 6e74 3332 5f74 202a 2920 7074 723b  uint32_t *) ptr;
+00088e40: 2070 7472 202b 3d20 7369 7a65 6f66 286e   ptr += sizeof(n
+00088e50: 5f6c 6561 6673 293b 0a20 2020 2020 2020  _leafs);.       
+00088e60: 2063 6f6e 7374 2075 696e 7433 325f 7420   const uint32_t 
+00088e70: 6e5f 6e6f 6465 7320 2020 3d20 2a28 636f  n_nodes   = *(co
+00088e80: 6e73 7420 7569 6e74 3332 5f74 202a 2920  nst uint32_t *) 
+00088e90: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
+00088ea0: 6f66 286e 5f6e 6f64 6573 293b 0a20 2020  of(n_nodes);.   
+00088eb0: 2020 2020 2063 6f6e 7374 2075 696e 7436       const uint6
+00088ec0: 345f 7420 7369 7a65 5f65 7661 6c20 3d20  4_t size_eval = 
+00088ed0: 2a28 636f 6e73 7420 7569 6e74 3634 5f74  *(const uint64_t
+00088ee0: 202a 2920 7074 723b 2070 7472 202b 3d20   *) ptr; ptr += 
+00088ef0: 7369 7a65 6f66 2873 697a 655f 6576 616c  sizeof(size_eval
+00088f00: 293b 0a0a 2020 2020 2020 2020 7265 7375  );..        resu
+00088f10: 6c74 2e6e 5f6c 6561 6673 203d 206e 5f6c  lt.n_leafs = n_l
+00088f20: 6561 6673 3b0a 2020 2020 2020 2020 7265  eafs;.        re
+00088f30: 7375 6c74 2e6e 5f6e 6f64 6573 203d 206e  sult.n_nodes = n
+00088f40: 5f6e 6f64 6573 3b0a 0a20 2020 2020 2020  _nodes;..       
+00088f50: 202f 2f20 6372 6561 7465 2074 6865 2064   // create the d
+00088f60: 6174 6120 636f 6e74 6578 740a 2020 2020  ata context.    
+00088f70: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00088f80: 2020 636f 6e73 7420 7369 7a65 5f74 206f    const size_t o
+00088f90: 7665 7268 6561 6420 3d20 286e 5f6c 6561  verhead = (n_lea
+00088fa0: 6673 202b 206e 5f6e 6f64 6573 292a 6767  fs + n_nodes)*gg
+00088fb0: 6d6c 5f74 656e 736f 725f 6f76 6572 6865  ml_tensor_overhe
+00088fc0: 6164 2829 3b0a 0a20 2020 2020 2020 2020  ad();..         
+00088fd0: 2020 2073 7472 7563 7420 6767 6d6c 5f69     struct ggml_i
+00088fe0: 6e69 745f 7061 7261 6d73 2070 6172 616d  nit_params param
+00088ff0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+00089000: 2020 2020 2020 2e6d 656d 5f73 697a 6520        .mem_size 
+00089010: 2020 3d20 7369 7a65 5f65 7661 6c20 2b20    = size_eval + 
+00089020: 6f76 6572 6865 6164 2c0a 2020 2020 2020  overhead,.      
+00089030: 2020 2020 2020 2020 2020 2e6d 656d 5f62            .mem_b
+00089040: 7566 6665 7220 3d20 4e55 4c4c 2c0a 2020  uffer = NULL,.  
+00089050: 2020 2020 2020 2020 2020 2020 2020 2e6e                .n
+00089060: 6f5f 616c 6c6f 6320 2020 3d20 7472 7565  o_alloc   = true
+00089070: 2c0a 2020 2020 2020 2020 2020 2020 7d3b  ,.            };
+00089080: 0a0a 2020 2020 2020 2020 2020 2020 2a63  ..            *c
+00089090: 7478 5f65 7661 6c20 3d20 6767 6d6c 5f69  tx_eval = ggml_i
+000890a0: 6e69 7428 7061 7261 6d73 293b 0a0a 2020  nit(params);..  
+000890b0: 2020 2020 2020 2020 2020 6966 2028 212a            if (!*
+000890c0: 6374 785f 6576 616c 2920 7b0a 2020 2020  ctx_eval) {.    
+000890d0: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
+000890e0: 6e74 6628 7374 6465 7272 2c20 2225 733a  ntf(stderr, "%s:
+000890f0: 2066 6169 6c65 6420 746f 2063 7265 6174   failed to creat
+00089100: 6520 6767 6d6c 2063 6f6e 7465 7874 5c6e  e ggml context\n
+00089110: 222c 205f 5f66 756e 635f 5f29 3b0a 2020  ", __func__);.  
+00089120: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00089130: 7475 726e 2072 6573 756c 743b 0a20 2020  turn result;.   
+00089140: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00089150: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
+00089160: 206c 6561 6673 0a20 2020 2020 2020 207b   leafs.        {
+00089170: 0a20 2020 2020 2020 2020 2020 2075 696e  .            uin
+00089180: 7433 325f 7420 7479 7065 3b0a 2020 2020  t32_t type;.    
+00089190: 2020 2020 2020 2020 7569 6e74 3332 5f74          uint32_t
+000891a0: 206f 703b 0a20 2020 2020 2020 2020 2020   op;.           
+000891b0: 2075 696e 7433 325f 7420 6e5f 6469 6d73   uint32_t n_dims
+000891c0: 3b0a 0a20 2020 2020 2020 2020 2020 2066  ;..            f
+000891d0: 6f72 2028 7569 6e74 3332 5f74 2069 203d  or (uint32_t i =
+000891e0: 2030 3b20 6920 3c20 6e5f 6c65 6166 733b   0; i < n_leafs;
+000891f0: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+00089200: 2020 2020 2020 2020 7479 7065 2020 203d          type   =
+00089210: 202a 2863 6f6e 7374 2075 696e 7433 325f   *(const uint32_
+00089220: 7420 2a29 2070 7472 3b20 7074 7220 2b3d  t *) ptr; ptr +=
+00089230: 2073 697a 656f 6628 7479 7065 293b 0a20   sizeof(type);. 
+00089240: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00089250: 7020 2020 2020 3d20 2a28 636f 6e73 7420  p     = *(const 
+00089260: 7569 6e74 3332 5f74 202a 2920 7074 723b  uint32_t *) ptr;
+00089270: 2070 7472 202b 3d20 7369 7a65 6f66 286f   ptr += sizeof(o
+00089280: 7029 3b0a 2020 2020 2020 2020 2020 2020  p);.            
+00089290: 2020 2020 6e5f 6469 6d73 203d 202a 2863      n_dims = *(c
+000892a0: 6f6e 7374 2075 696e 7433 325f 7420 2a29  onst uint32_t *)
+000892b0: 2070 7472 3b20 7074 7220 2b3d 2073 697a   ptr; ptr += siz
+000892c0: 656f 6628 6e5f 6469 6d73 293b 0a0a 2020  eof(n_dims);..  
+000892d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000892e0: 7436 345f 7420 6e65 5b47 474d 4c5f 4d41  t64_t ne[GGML_MA
+000892f0: 585f 4449 4d53 5d3b 0a20 2020 2020 2020  X_DIMS];.       
+00089300: 2020 2020 2020 2020 2073 697a 655f 7420           size_t 
+00089310: 206e 625b 4747 4d4c 5f4d 4158 5f44 494d   nb[GGML_MAX_DIM
+00089320: 535d 3b0a 0a20 2020 2020 2020 2020 2020  S];..           
+00089330: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+00089340: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
+00089350: 585f 4449 4d53 3b20 2b2b 6a29 207b 0a20  X_DIMS; ++j) {. 
+00089360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089370: 2020 2075 696e 7436 345f 7420 6e65 5f63     uint64_t ne_c
+00089380: 7572 3b0a 2020 2020 2020 2020 2020 2020  ur;.            
+00089390: 2020 2020 2020 2020 7569 6e74 3634 5f74          uint64_t
+000893a0: 206e 625f 6375 723b 0a0a 2020 2020 2020   nb_cur;..      
+000893b0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+000893c0: 5f63 7572 203d 202a 2863 6f6e 7374 2075  _cur = *(const u
+000893d0: 696e 7436 345f 7420 2a29 2070 7472 3b20  int64_t *) ptr; 
+000893e0: 7074 7220 2b3d 2073 697a 656f 6628 6e65  ptr += sizeof(ne
+000893f0: 5f63 7572 293b 0a20 2020 2020 2020 2020  _cur);.         
+00089400: 2020 2020 2020 2020 2020 206e 625f 6375             nb_cu
+00089410: 7220 3d20 2a28 636f 6e73 7420 7569 6e74  r = *(const uint
+00089420: 3634 5f74 202a 2920 7074 723b 2070 7472  64_t *) ptr; ptr
+00089430: 202b 3d20 7369 7a65 6f66 286e 625f 6375   += sizeof(nb_cu
+00089440: 7229 3b0a 0a20 2020 2020 2020 2020 2020  r);..           
+00089450: 2020 2020 2020 2020 206e 655b 6a5d 203d           ne[j] =
+00089460: 206e 655f 6375 723b 0a20 2020 2020 2020   ne_cur;.       
+00089470: 2020 2020 2020 2020 2020 2020 206e 625b               nb[
+00089480: 6a5d 203d 206e 625f 6375 723b 0a20 2020  j] = nb_cur;.   
+00089490: 2020 2020 2020 2020 2020 2020 207d 0a0a               }..
+000894a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000894b0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+000894c0: 6f72 202a 2074 656e 736f 7220 3d20 6767  or * tensor = gg
+000894d0: 6d6c 5f6e 6577 5f74 656e 736f 7228 2a63  ml_new_tensor(*c
+000894e0: 7478 5f65 7661 6c2c 2028 656e 756d 2067  tx_eval, (enum g
+000894f0: 676d 6c5f 7479 7065 2920 7479 7065 2c20  gml_type) type, 
+00089500: 6e5f 6469 6d73 2c20 6e65 293b 0a0a 2020  n_dims, ne);..  
+00089510: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00089520: 6e73 6f72 2d3e 6f70 203d 2028 656e 756d  nsor->op = (enum
+00089530: 2067 676d 6c5f 6f70 2920 6f70 3b0a 0a20   ggml_op) op;.. 
+00089540: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00089550: 656d 6370 7928 7465 6e73 6f72 2d3e 6e61  emcpy(tensor->na
+00089560: 6d65 2c20 7074 722c 2047 474d 4c5f 4d41  me, ptr, GGML_MA
+00089570: 585f 4e41 4d45 293b 2070 7472 202b 3d20  X_NAME); ptr += 
+00089580: 4747 4d4c 5f4d 4158 5f4e 414d 453b 0a0a  GGML_MAX_NAME;..
+00089590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000895a0: 7465 6e73 6f72 2d3e 6461 7461 203d 2028  tensor->data = (
+000895b0: 766f 6964 202a 2920 7074 723b 0a0a 2020  void *) ptr;..  
+000895c0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000895d0: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
+000895e0: 3c20 4747 4d4c 5f4d 4158 5f44 494d 533b  < GGML_MAX_DIMS;
+000895f0: 202b 2b6a 2920 7b0a 2020 2020 2020 2020   ++j) {.        
+00089600: 2020 2020 2020 2020 2020 2020 7465 6e73              tens
+00089610: 6f72 2d3e 6e62 5b6a 5d20 3d20 6e62 5b6a  or->nb[j] = nb[j
+00089620: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+00089630: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
+00089640: 2020 2020 2020 7265 7375 6c74 2e6c 6561        result.lea
+00089650: 6673 5b69 5d20 3d20 7465 6e73 6f72 3b0a  fs[i] = tensor;.
+00089660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00089670: 2070 7472 202b 3d20 6767 6d6c 5f6e 6279   ptr += ggml_nby
+00089680: 7465 7328 7465 6e73 6f72 293b 0a0a 2020  tes(tensor);..  
+00089690: 2020 2020 2020 2020 2020 2020 2020 6670                fp
+000896a0: 7269 6e74 6628 7374 6465 7272 2c20 2225  rintf(stderr, "%
+000896b0: 733a 206c 6f61 6465 6420 6c65 6166 2025  s: loaded leaf %
+000896c0: 643a 2027 2531 3673 272c 2025 3364 2064  d: '%16s', %3d d
+000896d0: 696d 732c 2025 397a 7520 6279 7465 735c  ims, %9zu bytes\
+000896e0: 6e22 2c20 5f5f 6675 6e63 5f5f 2c20 692c  n", __func__, i,
+000896f0: 2074 656e 736f 722d 3e6e 616d 652c 206e   tensor->name, n
+00089700: 5f64 696d 732c 2067 676d 6c5f 6e62 7974  _dims, ggml_nbyt
+00089710: 6573 2874 656e 736f 7229 293b 0a20 2020  es(tensor));.   
+00089720: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00089730: 2020 207d 0a0a 2020 2020 2020 2020 6767     }..        gg
+00089740: 6d6c 5f73 6574 5f6e 6f5f 616c 6c6f 6328  ml_set_no_alloc(
+00089750: 2a63 7478 5f65 7661 6c2c 2066 616c 7365  *ctx_eval, false
+00089760: 293b 0a0a 2020 2020 2020 2020 2f2f 206e  );..        // n
+00089770: 6f64 6573 0a20 2020 2020 2020 207b 0a20  odes.        {. 
+00089780: 2020 2020 2020 2020 2020 2075 696e 7433             uint3
+00089790: 325f 7420 7479 7065 3b0a 2020 2020 2020  2_t type;.      
+000897a0: 2020 2020 2020 7569 6e74 3332 5f74 206f        uint32_t o
+000897b0: 703b 0a20 2020 2020 2020 2020 2020 2075  p;.            u
+000897c0: 696e 7433 325f 7420 6e5f 6469 6d73 3b0a  int32_t n_dims;.
+000897d0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000897e0: 2028 7569 6e74 3332 5f74 2069 203d 2030   (uint32_t i = 0
+000897f0: 3b20 6920 3c20 6e5f 6e6f 6465 733b 202b  ; i < n_nodes; +
+00089800: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
+00089810: 2020 2020 2020 7479 7065 2020 203d 202a        type   = *
+00089820: 2863 6f6e 7374 2075 696e 7433 325f 7420  (const uint32_t 
+00089830: 2a29 2070 7472 3b20 7074 7220 2b3d 2073  *) ptr; ptr += s
+00089840: 697a 656f 6628 7479 7065 293b 0a20 2020  izeof(type);.   
+00089850: 2020 2020 2020 2020 2020 2020 206f 7020               op 
+00089860: 2020 2020 3d20 2a28 636f 6e73 7420 7569      = *(const ui
+00089870: 6e74 3332 5f74 202a 2920 7074 723b 2070  nt32_t *) ptr; p
+00089880: 7472 202b 3d20 7369 7a65 6f66 286f 7029  tr += sizeof(op)
+00089890: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000898a0: 2020 6e5f 6469 6d73 203d 202a 2863 6f6e    n_dims = *(con
+000898b0: 7374 2075 696e 7433 325f 7420 2a29 2070  st uint32_t *) p
+000898c0: 7472 3b20 7074 7220 2b3d 2073 697a 656f  tr; ptr += sizeo
+000898d0: 6628 6e5f 6469 6d73 293b 0a0a 2020 2020  f(n_dims);..    
+000898e0: 2020 2020 2020 2020 2020 2020 656e 756d              enum
+000898f0: 2067 676d 6c5f 6f70 2065 6f70 203d 2028   ggml_op eop = (
+00089900: 656e 756d 2067 676d 6c5f 6f70 2920 6f70  enum ggml_op) op
+00089910: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+00089920: 2020 2069 6e74 3634 5f74 206e 655b 4747     int64_t ne[GG
+00089930: 4d4c 5f4d 4158 5f44 494d 535d 3b0a 2020  ML_MAX_DIMS];.  
+00089940: 2020 2020 2020 2020 2020 2020 2020 7369                si
+00089950: 7a65 5f74 2020 6e62 5b47 474d 4c5f 4d41  ze_t  nb[GGML_MA
+00089960: 585f 4449 4d53 5d3b 0a0a 2020 2020 2020  X_DIMS];..      
+00089970: 2020 2020 2020 2020 2020 666f 7220 2869            for (i
+00089980: 6e74 206a 203d 2030 3b20 6a20 3c20 4747  nt j = 0; j < GG
+00089990: 4d4c 5f4d 4158 5f44 494d 533b 202b 2b6a  ML_MAX_DIMS; ++j
+000899a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+000899b0: 2020 2020 2020 2020 7569 6e74 3634 5f74          uint64_t
+000899c0: 206e 655f 6375 723b 0a20 2020 2020 2020   ne_cur;.       
+000899d0: 2020 2020 2020 2020 2020 2020 2075 696e               uin
+000899e0: 7436 345f 7420 6e62 5f63 7572 3b0a 0a20  t64_t nb_cur;.. 
+000899f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089a00: 2020 206e 655f 6375 7220 3d20 2a28 636f     ne_cur = *(co
+00089a10: 6e73 7420 7569 6e74 3634 5f74 202a 2920  nst uint64_t *) 
+00089a20: 7074 723b 2070 7472 202b 3d20 7369 7a65  ptr; ptr += size
+00089a30: 6f66 286e 655f 6375 7229 3b0a 2020 2020  of(ne_cur);.    
+00089a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089a50: 6e62 5f63 7572 203d 202a 2863 6f6e 7374  nb_cur = *(const
+00089a60: 2075 696e 7436 345f 7420 2a29 2070 7472   uint64_t *) ptr
+00089a70: 3b20 7074 7220 2b3d 2073 697a 656f 6628  ; ptr += sizeof(
+00089a80: 6e62 5f63 7572 293b 0a0a 2020 2020 2020  nb_cur);..      
+00089a90: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00089aa0: 5b6a 5d20 3d20 6e65 5f63 7572 3b0a 2020  [j] = ne_cur;.  
+00089ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089ac0: 2020 6e62 5b6a 5d20 3d20 6e62 5f63 7572    nb[j] = nb_cur
+00089ad0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00089ae0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+00089af0: 2020 2020 2063 6f6e 7374 2063 6861 7220       const char 
+00089b00: 2a20 7074 725f 6e61 6d65 203d 2070 7472  * ptr_name = ptr
+00089b10: 3b20 7074 7220 2b3d 2047 474d 4c5f 4d41  ; ptr += GGML_MA
+00089b20: 585f 4e41 4d45 3b0a 0a20 2020 2020 2020  X_NAME;..       
+00089b30: 2020 2020 2020 2020 2063 6f6e 7374 2069           const i
+00089b40: 6e74 3332 5f74 202a 2070 7472 5f61 7267  nt32_t * ptr_arg
+00089b50: 5f69 6478 203d 2028 636f 6e73 7420 696e  _idx = (const in
+00089b60: 7433 325f 7420 2a29 2070 7472 3b20 7074  t32_t *) ptr; pt
+00089b70: 7220 2b3d 2047 474d 4c5f 4d41 585f 5352  r += GGML_MAX_SR
+00089b80: 432a 7369 7a65 6f66 2869 6e74 3332 5f74  C*sizeof(int32_t
+00089b90: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
+00089ba0: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00089bb0: 7465 6e73 6f72 202a 2061 7267 735b 4747  tensor * args[GG
+00089bc0: 4d4c 5f4d 4158 5f53 5243 5d20 3d20 7b20  ML_MAX_SRC] = { 
+00089bd0: 4e55 4c4c 207d 3b0a 0a20 2020 2020 2020  NULL };..       
+00089be0: 2020 2020 2020 2020 202f 2f20 7061 7273           // pars
+00089bf0: 6520 6172 6773 0a20 2020 2020 2020 2020  e args.         
+00089c00: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
+00089c10: 6a20 3d20 303b 206a 203c 2047 474d 4c5f  j = 0; j < GGML_
+00089c20: 4d41 585f 5352 433b 202b 2b6a 2920 7b0a  MAX_SRC; ++j) {.
 00089c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089c40: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-00089c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089c60: 2020 6172 6773 5b6a 5d20 3d20 7265 7375    args[j] = resu
-00089c70: 6c74 2e6e 6f64 6573 5b61 7267 5f69 6478  lt.nodes[arg_idx
-00089c80: 202d 2047 474d 4c5f 4d41 585f 4e4f 4445   - GGML_MAX_NODE
-00089c90: 535d 3b0a 2020 2020 2020 2020 2020 2020  S];.            
-00089ca0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00089cb0: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
-00089cc0: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-00089cd0: 6372 6561 7465 2074 6865 2074 656e 736f  create the tenso
-00089ce0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00089cf0: 2020 2f2f 2022 7669 6577 2220 6f70 6572    // "view" oper
-00089d00: 6174 696f 6e73 2061 7265 2068 616e 646c  ations are handl
-00089d10: 6564 2064 6966 6665 7265 6e74 6c79 0a20  ed differently. 
-00089d20: 2020 2020 2020 2020 2020 2020 2020 202f                 /
-00089d30: 2f20 544f 444f 3a20 6861 6e64 6c65 2069  / TODO: handle i
-00089d40: 6e70 6c61 6365 206f 7073 202d 2063 7572  nplace ops - cur
-00089d50: 7265 6e74 6c79 2061 2063 6f70 7920 6973  rently a copy is
-00089d60: 2061 6c77 6179 7320 6d61 6465 0a0a 2020   always made..  
-00089d70: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00089d80: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-00089d90: 202a 2074 656e 736f 7220 3d20 4e55 4c4c   * tensor = NULL
-00089da0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00089db0: 2020 2073 7769 7463 6820 2865 6f70 2920     switch (eop) 
-00089dc0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00089dd0: 2020 2020 2020 2f2f 2054 4f44 4f3a 2069        // TODO: i
-00089de0: 6d70 6c65 6d65 6e74 206f 7468 6572 2076  mplement other v
-00089df0: 6965 7720 6f70 730a 2020 2020 2020 2020  iew ops.        
-00089e00: 2020 2020 2020 2020 2020 2020 6361 7365              case
-00089e10: 2047 474d 4c5f 4f50 5f52 4553 4841 5045   GGML_OP_RESHAPE
-00089e20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00089e30: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00089e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089e50: 2020 2020 2020 2020 7465 6e73 6f72 203d          tensor =
-00089e60: 2067 676d 6c5f 7265 7368 6170 655f 3464   ggml_reshape_4d
-00089e70: 282a 6374 785f 6576 616c 2c20 6172 6773  (*ctx_eval, args
-00089e80: 5b30 5d2c 206e 655b 305d 2c20 6e65 5b31  [0], ne[0], ne[1
-00089e90: 5d2c 206e 655b 325d 2c20 6e65 5b33 5d29  ], ne[2], ne[3])
-00089ea0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00089eb0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00089ec0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-00089ed0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00089ee0: 5f4f 505f 5649 4557 3a0a 2020 2020 2020  _OP_VIEW:.      
-00089ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089f00: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00089f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089f20: 7465 6e73 6f72 203d 2067 676d 6c5f 7669  tensor = ggml_vi
-00089f30: 6577 5f34 6428 2a63 7478 5f65 7661 6c2c  ew_4d(*ctx_eval,
-00089f40: 2061 7267 735b 305d 2c20 6e65 5b30 5d2c   args[0], ne[0],
-00089f50: 206e 655b 315d 2c20 6e65 5b32 5d2c 206e   ne[1], ne[2], n
-00089f60: 655b 335d 2c20 302c 2030 2c20 302c 2030  e[3], 0, 0, 0, 0
-00089f70: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-00089f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089f90: 7569 6e74 3634 5f74 206f 6666 733b 0a20  uint64_t offs;. 
-00089fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00089fb0: 2020 2020 2020 2020 2020 206d 656d 6370             memcp
-00089fc0: 7928 266f 6666 732c 2061 7267 735b 325d  y(&offs, args[2]
-00089fd0: 2d3e 6461 7461 2c20 7369 7a65 6f66 286f  ->data, sizeof(o
-00089fe0: 6666 7329 293b 0a0a 2020 2020 2020 2020  ffs));..        
-00089ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a000: 2020 2020 7465 6e73 6f72 2d3e 6461 7461      tensor->data
-0008a010: 203d 2028 2863 6861 7220 2a29 2074 656e   = ((char *) ten
-0008a020: 736f 722d 3e64 6174 6129 202b 206f 6666  sor->data) + off
-0008a030: 733b 0a20 2020 2020 2020 2020 2020 2020  s;.             
-0008a040: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0008a050: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
-0008a060: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0008a070: 4c5f 4f50 5f54 5241 4e53 504f 5345 3a0a  L_OP_TRANSPOSE:.
-0008a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a090: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0008a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a0b0: 2020 2020 2020 7465 6e73 6f72 203d 2067        tensor = g
-0008a0c0: 676d 6c5f 7472 616e 7370 6f73 6528 2a63  gml_transpose(*c
-0008a0d0: 7478 5f65 7661 6c2c 2061 7267 735b 305d  tx_eval, args[0]
-0008a0e0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008a0f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-0008a100: 616b 3b0a 2020 2020 2020 2020 2020 2020  ak;.            
-0008a110: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-0008a120: 4c5f 4f50 5f50 4552 4d55 5445 3a0a 2020  L_OP_PERMUTE:.  
-0008a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a140: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0008a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a160: 2020 2020 7465 6e73 6f72 203d 2067 676d      tensor = ggm
-0008a170: 6c5f 7669 6577 5f34 6428 2a63 7478 5f65  l_view_4d(*ctx_e
-0008a180: 7661 6c2c 2061 7267 735b 305d 2c20 6e65  val, args[0], ne
-0008a190: 5b30 5d2c 206e 655b 315d 2c20 6e65 5b32  [0], ne[1], ne[2
-0008a1a0: 5d2c 206e 655b 335d 2c20 302c 2030 2c20  ], ne[3], 0, 0, 
-0008a1b0: 302c 2030 293b 0a20 2020 2020 2020 2020  0, 0);.         
-0008a1c0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0008a1d0: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-0008a1e0: 2020 2020 2020 2020 2020 2020 6465 6661              defa
-0008a1f0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-0008a200: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
-0008a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a220: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0008a230: 7220 3d20 6767 6d6c 5f6e 6577 5f74 656e  r = ggml_new_ten
-0008a240: 736f 7228 2a63 7478 5f65 7661 6c2c 2028  sor(*ctx_eval, (
-0008a250: 656e 756d 2067 676d 6c5f 7479 7065 2920  enum ggml_type) 
-0008a260: 7479 7065 2c20 6e5f 6469 6d73 2c20 6e65  type, n_dims, ne
-0008a270: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0008a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a290: 7465 6e73 6f72 2d3e 6f70 203d 2065 6f70  tensor->op = eop
-0008a2a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008a2b0: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-0008a2c0: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
-0008a2d0: 2020 207d 0a0a 2020 2020 2020 2020 2020     }..          
-0008a2e0: 2020 2020 2020 6d65 6d63 7079 2874 656e        memcpy(ten
-0008a2f0: 736f 722d 3e6e 616d 652c 2070 7472 5f6e  sor->name, ptr_n
-0008a300: 616d 652c 2047 474d 4c5f 4d41 585f 4e41  ame, GGML_MAX_NA
-0008a310: 4d45 293b 0a0a 2020 2020 2020 2020 2020  ME);..          
-0008a320: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
-0008a330: 203d 2030 3b20 6a20 3c20 4747 4d4c 5f4d   = 0; j < GGML_M
-0008a340: 4158 5f44 494d 533b 202b 2b6a 2920 7b0a  AX_DIMS; ++j) {.
-0008a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a360: 2020 2020 7465 6e73 6f72 2d3e 6e62 5b6a      tensor->nb[j
-0008a370: 5d20 3d20 6e62 5b6a 5d3b 0a20 2020 2020  ] = nb[j];.     
-0008a380: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-0008a390: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0008a3a0: 7220 2869 6e74 206a 203d 2030 3b20 6a20  r (int j = 0; j 
-0008a3b0: 3c20 4747 4d4c 5f4d 4158 5f53 5243 3b20  < GGML_MAX_SRC; 
-0008a3c0: 2b2b 6a29 207b 0a20 2020 2020 2020 2020  ++j) {.         
-0008a3d0: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
-0008a3e0: 722d 3e73 7263 5b6a 5d20 3d20 6172 6773  r->src[j] = args
-0008a3f0: 5b6a 5d3b 0a20 2020 2020 2020 2020 2020  [j];.           
-0008a400: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008a410: 2020 2020 2020 2020 7265 7375 6c74 2e6e          result.n
-0008a420: 6f64 6573 5b69 5d20 3d20 7465 6e73 6f72  odes[i] = tensor
-0008a430: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-0008a440: 2020 2066 7072 696e 7466 2873 7464 6572     fprintf(stder
-0008a450: 722c 2022 2573 3a20 6c6f 6164 6564 206e  r, "%s: loaded n
-0008a460: 6f64 6520 2564 3a20 2725 3136 7327 2c20  ode %d: '%16s', 
-0008a470: 2533 6420 6469 6d73 2c20 2539 7a75 2062  %3d dims, %9zu b
-0008a480: 7974 6573 5c6e 222c 205f 5f66 756e 635f  ytes\n", __func_
-0008a490: 5f2c 2069 2c20 7465 6e73 6f72 2d3e 6e61  _, i, tensor->na
-0008a4a0: 6d65 2c20 6e5f 6469 6d73 2c20 6767 6d6c  me, n_dims, ggml
-0008a4b0: 5f6e 6279 7465 7328 7465 6e73 6f72 2929  _nbytes(tensor))
-0008a4c0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-0008a4d0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-0008a4e0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-0008a4f0: 6c74 3b0a 7d0a 0a76 6f69 6420 6767 6d6c  lt;.}..void ggml
-0008a500: 5f67 7261 7068 5f70 7269 6e74 2863 6f6e  _graph_print(con
-0008a510: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
-0008a520: 6772 6170 6820 2a20 6367 7261 7068 2920  graph * cgraph) 
-0008a530: 7b0a 2020 2020 696e 7436 345f 7420 7065  {.    int64_t pe
-0008a540: 7266 5f74 6f74 616c 5f70 6572 5f6f 705f  rf_total_per_op_
-0008a550: 7573 5b47 474d 4c5f 4f50 5f43 4f55 4e54  us[GGML_OP_COUNT
-0008a560: 5d20 3d20 7b30 7d3b 0a0a 2020 2020 4747  ] = {0};..    GG
-0008a570: 4d4c 5f50 5249 4e54 2822 3d3d 3d20 4752  ML_PRINT("=== GR
-0008a580: 4150 4820 3d3d 3d5c 6e22 293b 0a0a 2020  APH ===\n");..  
-0008a590: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
-0008a5a0: 5547 2822 6e5f 7468 7265 6164 7320 2020  UG("n_threads   
-0008a5b0: 2020 2020 3d20 2564 5c6e 222c 2020 2020      = %d\n",    
-0008a5c0: 2020 2020 6367 7261 7068 2d3e 6e5f 7468      cgraph->n_th
-0008a5d0: 7265 6164 7329 3b0a 2020 2020 4747 4d4c  reads);.    GGML
-0008a5e0: 5f50 5249 4e54 5f44 4542 5547 2822 746f  _PRINT_DEBUG("to
-0008a5f0: 7461 6c20 776f 726b 2073 697a 6520 3d20  tal work size = 
-0008a600: 257a 7520 6279 7465 735c 6e22 2c20 6367  %zu bytes\n", cg
-0008a610: 7261 7068 2d3e 776f 726b 5f73 697a 6529  raph->work_size)
-0008a620: 3b0a 0a20 2020 2047 474d 4c5f 5052 494e  ;..    GGML_PRIN
-0008a630: 5428 226e 5f6e 6f64 6573 203d 2025 645c  T("n_nodes = %d\
-0008a640: 6e22 2c20 6367 7261 7068 2d3e 6e5f 6e6f  n", cgraph->n_no
-0008a650: 6465 7329 3b0a 2020 2020 666f 7220 2869  des);.    for (i
-0008a660: 6e74 2069 203d 2030 3b20 6920 3c20 6367  nt i = 0; i < cg
-0008a670: 7261 7068 2d3e 6e5f 6e6f 6465 733b 2069  raph->n_nodes; i
-0008a680: 2b2b 2920 7b0a 2020 2020 2020 2020 7374  ++) {.        st
-0008a690: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0008a6a0: 202a 206e 6f64 6520 3d20 6367 7261 7068   * node = cgraph
-0008a6b0: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-0008a6c0: 2020 2020 2070 6572 665f 746f 7461 6c5f       perf_total_
-0008a6d0: 7065 725f 6f70 5f75 735b 6e6f 6465 2d3e  per_op_us[node->
-0008a6e0: 6f70 5d20 2b3d 204d 4158 2831 2c20 6e6f  op] += MAX(1, no
-0008a6f0: 6465 2d3e 7065 7266 5f74 696d 655f 7573  de->perf_time_us
-0008a700: 293b 0a0a 2020 2020 2020 2020 4747 4d4c  );..        GGML
-0008a710: 5f50 5249 4e54 2822 202d 2025 3364 3a20  _PRINT(" - %3d: 
-0008a720: 5b20 2535 2220 5052 4964 3634 2022 2c20  [ %5" PRId64 ", 
-0008a730: 2535 2220 5052 4964 3634 2022 2c20 2535  %5" PRId64 ", %5
-0008a740: 2220 5052 4964 3634 2022 5d20 2531 3673  " PRId64 "] %16s
-0008a750: 2025 7320 2825 3364 2920 6370 7520 3d20   %s (%3d) cpu = 
-0008a760: 2537 2e33 6620 2f20 2537 2e33 6620 6d73  %7.3f / %7.3f ms
-0008a770: 2c20 7761 6c6c 203d 2025 372e 3366 202f  , wall = %7.3f /
-0008a780: 2025 372e 3366 206d 735c 6e22 2c0a 2020   %7.3f ms\n",.  
-0008a790: 2020 2020 2020 2020 2020 2020 2020 692c                i,
-0008a7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008a7b0: 206e 6f64 652d 3e6e 655b 305d 2c20 6e6f   node->ne[0], no
-0008a7c0: 6465 2d3e 6e65 5b31 5d2c 206e 6f64 652d  de->ne[1], node-
-0008a7d0: 3e6e 655b 325d 2c0a 2020 2020 2020 2020  >ne[2],.        
-0008a7e0: 2020 2020 2020 2020 4747 4d4c 5f4f 505f          GGML_OP_
-0008a7f0: 4e41 4d45 5b6e 6f64 652d 3e6f 705d 2c20  NAME[node->op], 
-0008a800: 6e6f 6465 2d3e 6973 5f70 6172 616d 203f  node->is_param ?
-0008a810: 2022 7822 203a 206e 6f64 652d 3e67 7261   "x" : node->gra
-0008a820: 6420 3f20 2267 2220 3a20 2220 222c 206e  d ? "g" : " ", n
-0008a830: 6f64 652d 3e70 6572 665f 7275 6e73 2c0a  ode->perf_runs,.
-0008a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008a850: 2864 6f75 626c 6529 206e 6f64 652d 3e70  (double) node->p
-0008a860: 6572 665f 6379 636c 6573 2020 2f20 2864  erf_cycles  / (d
-0008a870: 6f75 626c 6529 2067 676d 6c5f 6379 636c  ouble) ggml_cycl
-0008a880: 6573 5f70 6572 5f6d 7328 292c 0a20 2020  es_per_ms(),.   
-0008a890: 2020 2020 2020 2020 2020 2020 2028 646f               (do
-0008a8a0: 7562 6c65 2920 6e6f 6465 2d3e 7065 7266  uble) node->perf
-0008a8b0: 5f63 7963 6c65 7320 202f 2028 646f 7562  _cycles  / (doub
-0008a8c0: 6c65 2920 6767 6d6c 5f63 7963 6c65 735f  le) ggml_cycles_
-0008a8d0: 7065 725f 6d73 2829 202f 2028 646f 7562  per_ms() / (doub
-0008a8e0: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f72  le) node->perf_r
-0008a8f0: 756e 732c 0a20 2020 2020 2020 2020 2020  uns,.           
-0008a900: 2020 2020 2028 646f 7562 6c65 2920 6e6f       (double) no
-0008a910: 6465 2d3e 7065 7266 5f74 696d 655f 7573  de->perf_time_us
-0008a920: 202f 2031 3030 302e 302c 0a20 2020 2020   / 1000.0,.     
-0008a930: 2020 2020 2020 2020 2020 2028 646f 7562             (doub
-0008a940: 6c65 2920 6e6f 6465 2d3e 7065 7266 5f74  le) node->perf_t
-0008a950: 696d 655f 7573 202f 2031 3030 302e 3020  ime_us / 1000.0 
-0008a960: 2f20 6e6f 6465 2d3e 7065 7266 5f72 756e  / node->perf_run
-0008a970: 7329 3b0a 2020 2020 7d0a 0a20 2020 2047  s);.    }..    G
-0008a980: 474d 4c5f 5052 494e 5428 226e 5f6c 6561  GML_PRINT("n_lea
-0008a990: 6673 203d 2025 645c 6e22 2c20 6367 7261  fs = %d\n", cgra
-0008a9a0: 7068 2d3e 6e5f 6c65 6166 7329 3b0a 2020  ph->n_leafs);.  
-0008a9b0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0008a9c0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
-0008a9d0: 6c65 6166 733b 2069 2b2b 2920 7b0a 2020  leafs; i++) {.  
-0008a9e0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008a9f0: 6c5f 7465 6e73 6f72 202a 206e 6f64 6520  l_tensor * node 
-0008aa00: 3d20 6367 7261 7068 2d3e 6c65 6166 735b  = cgraph->leafs[
-0008aa10: 695d 3b0a 0a20 2020 2020 2020 2047 474d  i];..        GGM
-0008aa20: 4c5f 5052 494e 5428 2220 2d20 2533 643a  L_PRINT(" - %3d:
-0008aa30: 205b 2025 3522 2050 5249 6436 3420 222c   [ %5" PRId64 ",
-0008aa40: 2025 3522 2050 5249 6436 3420 225d 2025   %5" PRId64 "] %
-0008aa50: 3873 5c6e 222c 0a20 2020 2020 2020 2020  8s\n",.         
-0008aa60: 2020 2020 2020 2069 2c0a 2020 2020 2020         i,.      
-0008aa70: 2020 2020 2020 2020 2020 6e6f 6465 2d3e            node->
-0008aa80: 6e65 5b30 5d2c 206e 6f64 652d 3e6e 655b  ne[0], node->ne[
-0008aa90: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-0008aaa0: 2020 2020 4747 4d4c 5f4f 505f 4e41 4d45      GGML_OP_NAME
-0008aab0: 5b6e 6f64 652d 3e6f 705d 293b 0a20 2020  [node->op]);.   
-0008aac0: 207d 0a0a 2020 2020 666f 7220 2869 6e74   }..    for (int
-0008aad0: 2069 203d 2030 3b20 6920 3c20 4747 4d4c   i = 0; i < GGML
-0008aae0: 5f4f 505f 434f 554e 543b 2069 2b2b 2920  _OP_COUNT; i++) 
-0008aaf0: 7b0a 2020 2020 2020 2020 6966 2028 7065  {.        if (pe
-0008ab00: 7266 5f74 6f74 616c 5f70 6572 5f6f 705f  rf_total_per_op_
-0008ab10: 7573 5b69 5d20 3d3d 2030 2920 7b0a 2020  us[i] == 0) {.  
-0008ab20: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0008ab30: 7565 3b0a 2020 2020 2020 2020 7d0a 0a20  ue;.        }.. 
-0008ab40: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
-0008ab50: 5428 2270 6572 665f 746f 7461 6c5f 7065  T("perf_total_pe
-0008ab60: 725f 6f70 5f75 735b 2531 3673 5d20 3d20  r_op_us[%16s] = 
-0008ab70: 2537 2e33 6620 6d73 5c6e 222c 2047 474d  %7.3f ms\n", GGM
-0008ab80: 4c5f 4f50 5f4e 414d 455b 695d 2c20 2864  L_OP_NAME[i], (d
-0008ab90: 6f75 626c 6529 2070 6572 665f 746f 7461  ouble) perf_tota
-0008aba0: 6c5f 7065 725f 6f70 5f75 735b 695d 202f  l_per_op_us[i] /
-0008abb0: 2031 3030 302e 3029 3b0a 2020 2020 7d0a   1000.0);.    }.
-0008abc0: 0a20 2020 2047 474d 4c5f 5052 494e 5428  .    GGML_PRINT(
-0008abd0: 223d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  "===============
-0008abe0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0008abf0: 3d3d 3d3d 3d3d 3d3d 3d5c 6e22 293b 0a7d  =========\n");.}
-0008ac00: 0a0a 2f2f 2063 6865 636b 2069 6620 6e6f  ..// check if no
-0008ac10: 6465 2069 7320 7061 7274 206f 6620 7468  de is part of th
-0008ac20: 6520 6772 6170 680a 7374 6174 6963 2062  e graph.static b
-0008ac30: 6f6f 6c20 6767 6d6c 5f67 7261 7068 5f66  ool ggml_graph_f
-0008ac40: 696e 6428 636f 6e73 7420 7374 7275 6374  ind(const struct
-0008ac50: 2067 676d 6c5f 6367 7261 7068 202a 2063   ggml_cgraph * c
-0008ac60: 6772 6170 682c 2063 6f6e 7374 2073 7472  graph, const str
-0008ac70: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
-0008ac80: 2a20 6e6f 6465 2920 7b0a 2020 2020 6966  * node) {.    if
-0008ac90: 2028 6367 7261 7068 203d 3d20 4e55 4c4c   (cgraph == NULL
-0008aca0: 2920 7b0a 2020 2020 2020 2020 7265 7475  ) {.        retu
-0008acb0: 726e 2074 7275 653b 0a20 2020 207d 0a0a  rn true;.    }..
-0008acc0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-0008acd0: 2030 3b20 6920 3c20 6367 7261 7068 2d3e   0; i < cgraph->
-0008ace0: 6e5f 6e6f 6465 733b 2069 2b2b 2920 7b0a  n_nodes; i++) {.
-0008acf0: 2020 2020 2020 2020 6966 2028 6367 7261          if (cgra
-0008ad00: 7068 2d3e 6e6f 6465 735b 695d 203d 3d20  ph->nodes[i] == 
-0008ad10: 6e6f 6465 2920 7b0a 2020 2020 2020 2020  node) {.        
-0008ad20: 2020 2020 7265 7475 726e 2074 7275 653b      return true;
-0008ad30: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0008ad40: 0a0a 2020 2020 7265 7475 726e 2066 616c  ..    return fal
-0008ad50: 7365 3b0a 7d0a 0a73 7461 7469 6320 7374  se;.}..static st
-0008ad60: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0008ad70: 202a 2067 676d 6c5f 6772 6170 685f 6765   * ggml_graph_ge
-0008ad80: 745f 7061 7265 6e74 2863 6f6e 7374 2073  t_parent(const s
-0008ad90: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-0008ada0: 6820 2a20 6367 7261 7068 2c20 636f 6e73  h * cgraph, cons
-0008adb0: 7420 7374 7275 6374 2067 676d 6c5f 7465  t struct ggml_te
-0008adc0: 6e73 6f72 202a 206e 6f64 6529 207b 0a20  nsor * node) {. 
+00089c40: 2020 2020 636f 6e73 7420 696e 7433 325f      const int32_
+00089c50: 7420 6172 675f 6964 7820 3d20 7074 725f  t arg_idx = ptr_
+00089c60: 6172 675f 6964 785b 6a5d 3b0a 0a20 2020  arg_idx[j];..   
+00089c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089c80: 2069 6620 2861 7267 5f69 6478 203d 3d20   if (arg_idx == 
+00089c90: 2d31 2920 7b0a 2020 2020 2020 2020 2020  -1) {.          
+00089ca0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00089cb0: 6e74 696e 7565 3b0a 2020 2020 2020 2020  ntinue;.        
+00089cc0: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+00089cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089ce0: 2020 2069 6620 2861 7267 5f69 6478 203c     if (arg_idx <
+00089cf0: 2047 474d 4c5f 4d41 585f 4e4f 4445 5329   GGML_MAX_NODES)
+00089d00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00089d10: 2020 2020 2020 2020 2020 2061 7267 735b             args[
+00089d20: 6a5d 203d 2072 6573 756c 742e 6c65 6166  j] = result.leaf
+00089d30: 735b 6172 675f 6964 785d 3b0a 2020 2020  s[arg_idx];.    
+00089d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089d50: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+00089d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089d70: 2061 7267 735b 6a5d 203d 2072 6573 756c   args[j] = resul
+00089d80: 742e 6e6f 6465 735b 6172 675f 6964 7820  t.nodes[arg_idx 
+00089d90: 2d20 4747 4d4c 5f4d 4158 5f4e 4f44 4553  - GGML_MAX_NODES
+00089da0: 5d3b 0a20 2020 2020 2020 2020 2020 2020  ];.             
+00089db0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00089dc0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
+00089dd0: 2020 2020 2020 2020 2020 2020 2f2f 2063              // c
+00089de0: 7265 6174 6520 7468 6520 7465 6e73 6f72  reate the tensor
+00089df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00089e00: 202f 2f20 2276 6965 7722 206f 7065 7261   // "view" opera
+00089e10: 7469 6f6e 7320 6172 6520 6861 6e64 6c65  tions are handle
+00089e20: 6420 6469 6666 6572 656e 746c 790a 2020  d differently.  
+00089e30: 2020 2020 2020 2020 2020 2020 2020 2f2f                //
+00089e40: 2054 4f44 4f3a 2068 616e 646c 6520 696e   TODO: handle in
+00089e50: 706c 6163 6520 6f70 7320 2d20 6375 7272  place ops - curr
+00089e60: 656e 746c 7920 6120 636f 7079 2069 7320  ently a copy is 
+00089e70: 616c 7761 7973 206d 6164 650a 0a20 2020  always made..   
+00089e80: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00089e90: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+00089ea0: 2a20 7465 6e73 6f72 203d 204e 554c 4c3b  * tensor = NULL;
+00089eb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00089ec0: 2020 7377 6974 6368 2028 656f 7029 207b    switch (eop) {
+00089ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00089ee0: 2020 2020 202f 2f20 544f 444f 3a20 696d       // TODO: im
+00089ef0: 706c 656d 656e 7420 6f74 6865 7220 7669  plement other vi
+00089f00: 6577 206f 7073 0a20 2020 2020 2020 2020  ew ops.         
+00089f10: 2020 2020 2020 2020 2020 2063 6173 6520             case 
+00089f20: 4747 4d4c 5f4f 505f 5245 5348 4150 453a  GGML_OP_RESHAPE:
+00089f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00089f40: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00089f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00089f60: 2020 2020 2020 2074 656e 736f 7220 3d20         tensor = 
+00089f70: 6767 6d6c 5f72 6573 6861 7065 5f34 6428  ggml_reshape_4d(
+00089f80: 2a63 7478 5f65 7661 6c2c 2061 7267 735b  *ctx_eval, args[
+00089f90: 305d 2c20 6e65 5b30 5d2c 206e 655b 315d  0], ne[0], ne[1]
+00089fa0: 2c20 6e65 5b32 5d2c 206e 655b 335d 293b  , ne[2], ne[3]);
+00089fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00089fc0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00089fd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00089fe0: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00089ff0: 4f50 5f56 4945 573a 0a20 2020 2020 2020  OP_VIEW:.       
+0008a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a010: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0008a020: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0008a030: 656e 736f 7220 3d20 6767 6d6c 5f76 6965  ensor = ggml_vie
+0008a040: 775f 3464 282a 6374 785f 6576 616c 2c20  w_4d(*ctx_eval, 
+0008a050: 6172 6773 5b30 5d2c 206e 655b 305d 2c20  args[0], ne[0], 
+0008a060: 6e65 5b31 5d2c 206e 655b 325d 2c20 6e65  ne[1], ne[2], ne
+0008a070: 5b33 5d2c 2030 2c20 302c 2030 2c20 3029  [3], 0, 0, 0, 0)
+0008a080: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0008a090: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+0008a0a0: 696e 7436 345f 7420 6f66 6673 3b0a 2020  int64_t offs;.  
+0008a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a0c0: 2020 2020 2020 2020 2020 6d65 6d63 7079            memcpy
+0008a0d0: 2826 6f66 6673 2c20 6172 6773 5b32 5d2d  (&offs, args[2]-
+0008a0e0: 3e64 6174 612c 2073 697a 656f 6628 6f66  >data, sizeof(of
+0008a0f0: 6673 2929 3b0a 0a20 2020 2020 2020 2020  fs));..         
+0008a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a110: 2020 2074 656e 736f 722d 3e64 6174 6120     tensor->data 
+0008a120: 3d20 2828 6368 6172 202a 2920 7465 6e73  = ((char *) tens
+0008a130: 6f72 2d3e 6461 7461 2920 2b20 6f66 6673  or->data) + offs
+0008a140: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008a150: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0008a160: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+0008a170: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0008a180: 5f4f 505f 5452 414e 5350 4f53 453a 0a20  _OP_TRANSPOSE:. 
+0008a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a1a0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0008a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a1c0: 2020 2020 2074 656e 736f 7220 3d20 6767       tensor = gg
+0008a1d0: 6d6c 5f74 7261 6e73 706f 7365 282a 6374  ml_transpose(*ct
+0008a1e0: 785f 6576 616c 2c20 6172 6773 5b30 5d29  x_eval, args[0])
+0008a1f0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008a200: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+0008a210: 6b3b 0a20 2020 2020 2020 2020 2020 2020  k;.             
+0008a220: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+0008a230: 5f4f 505f 5045 524d 5554 453a 0a20 2020  _OP_PERMUTE:.   
+0008a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a250: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+0008a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a270: 2020 2074 656e 736f 7220 3d20 6767 6d6c     tensor = ggml
+0008a280: 5f76 6965 775f 3464 282a 6374 785f 6576  _view_4d(*ctx_ev
+0008a290: 616c 2c20 6172 6773 5b30 5d2c 206e 655b  al, args[0], ne[
+0008a2a0: 305d 2c20 6e65 5b31 5d2c 206e 655b 325d  0], ne[1], ne[2]
+0008a2b0: 2c20 6e65 5b33 5d2c 2030 2c20 302c 2030  , ne[3], 0, 0, 0
+0008a2c0: 2c20 3029 3b0a 2020 2020 2020 2020 2020  , 0);.          
+0008a2d0: 2020 2020 2020 2020 2020 2020 2020 7d20                } 
+0008a2e0: 6272 6561 6b3b 0a20 2020 2020 2020 2020  break;.         
+0008a2f0: 2020 2020 2020 2020 2020 2064 6566 6175             defau
+0008a300: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+0008a310: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0008a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a330: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+0008a340: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+0008a350: 6f72 282a 6374 785f 6576 616c 2c20 2865  or(*ctx_eval, (e
+0008a360: 6e75 6d20 6767 6d6c 5f74 7970 6529 2074  num ggml_type) t
+0008a370: 7970 652c 206e 5f64 696d 732c 206e 6529  ype, n_dims, ne)
+0008a380: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
+0008a390: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0008a3a0: 656e 736f 722d 3e6f 7020 3d20 656f 703b  ensor->op = eop;
+0008a3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008a3c0: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+0008a3d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008a3e0: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
+0008a3f0: 2020 2020 206d 656d 6370 7928 7465 6e73       memcpy(tens
+0008a400: 6f72 2d3e 6e61 6d65 2c20 7074 725f 6e61  or->name, ptr_na
+0008a410: 6d65 2c20 4747 4d4c 5f4d 4158 5f4e 414d  me, GGML_MAX_NAM
+0008a420: 4529 3b0a 0a20 2020 2020 2020 2020 2020  E);..           
+0008a430: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
+0008a440: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
+0008a450: 585f 4449 4d53 3b20 2b2b 6a29 207b 0a20  X_DIMS; ++j) {. 
+0008a460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a470: 2020 2074 656e 736f 722d 3e6e 625b 6a5d     tensor->nb[j]
+0008a480: 203d 206e 625b 6a5d 3b0a 2020 2020 2020   = nb[j];.      
+0008a490: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+0008a4a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0008a4b0: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
+0008a4c0: 2047 474d 4c5f 4d41 585f 5352 433b 202b   GGML_MAX_SRC; +
+0008a4d0: 2b6a 2920 7b0a 2020 2020 2020 2020 2020  +j) {.          
+0008a4e0: 2020 2020 2020 2020 2020 7465 6e73 6f72            tensor
+0008a4f0: 2d3e 7372 635b 6a5d 203d 2061 7267 735b  ->src[j] = args[
+0008a500: 6a5d 3b0a 2020 2020 2020 2020 2020 2020  j];.            
+0008a510: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0008a520: 2020 2020 2020 2072 6573 756c 742e 6e6f         result.no
+0008a530: 6465 735b 695d 203d 2074 656e 736f 723b  des[i] = tensor;
+0008a540: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0008a550: 2020 6670 7269 6e74 6628 7374 6465 7272    fprintf(stderr
+0008a560: 2c20 2225 733a 206c 6f61 6465 6420 6e6f  , "%s: loaded no
+0008a570: 6465 2025 643a 2027 2531 3673 272c 2025  de %d: '%16s', %
+0008a580: 3364 2064 696d 732c 2025 397a 7520 6279  3d dims, %9zu by
+0008a590: 7465 735c 6e22 2c20 5f5f 6675 6e63 5f5f  tes\n", __func__
+0008a5a0: 2c20 692c 2074 656e 736f 722d 3e6e 616d  , i, tensor->nam
+0008a5b0: 652c 206e 5f64 696d 732c 2067 676d 6c5f  e, n_dims, ggml_
+0008a5c0: 6e62 7974 6573 2874 656e 736f 7229 293b  nbytes(tensor));
+0008a5d0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+0008a5e0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+0008a5f0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+0008a600: 743b 0a7d 0a0a 766f 6964 2067 676d 6c5f  t;.}..void ggml_
+0008a610: 6772 6170 685f 7072 696e 7428 636f 6e73  graph_print(cons
+0008a620: 7420 7374 7275 6374 2067 676d 6c5f 6367  t struct ggml_cg
+0008a630: 7261 7068 202a 2063 6772 6170 6829 207b  raph * cgraph) {
+0008a640: 0a20 2020 2069 6e74 3634 5f74 2070 6572  .    int64_t per
+0008a650: 665f 746f 7461 6c5f 7065 725f 6f70 5f75  f_total_per_op_u
+0008a660: 735b 4747 4d4c 5f4f 505f 434f 554e 545d  s[GGML_OP_COUNT]
+0008a670: 203d 207b 307d 3b0a 0a20 2020 2047 474d   = {0};..    GGM
+0008a680: 4c5f 5052 494e 5428 223d 3d3d 2047 5241  L_PRINT("=== GRA
+0008a690: 5048 203d 3d3d 5c6e 2229 3b0a 0a20 2020  PH ===\n");..   
+0008a6a0: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+0008a6b0: 4728 226e 5f74 6872 6561 6473 2020 2020  G("n_threads    
+0008a6c0: 2020 203d 2025 645c 6e22 2c20 2020 2020     = %d\n",     
+0008a6d0: 2020 2063 6772 6170 682d 3e6e 5f74 6872     cgraph->n_thr
+0008a6e0: 6561 6473 293b 0a20 2020 2047 474d 4c5f  eads);.    GGML_
+0008a6f0: 5052 494e 545f 4445 4255 4728 2274 6f74  PRINT_DEBUG("tot
+0008a700: 616c 2077 6f72 6b20 7369 7a65 203d 2025  al work size = %
+0008a710: 7a75 2062 7974 6573 5c6e 222c 2063 6772  zu bytes\n", cgr
+0008a720: 6170 682d 3e77 6f72 6b5f 7369 7a65 293b  aph->work_size);
+0008a730: 0a0a 2020 2020 4747 4d4c 5f50 5249 4e54  ..    GGML_PRINT
+0008a740: 2822 6e5f 6e6f 6465 7320 3d20 2564 5c6e  ("n_nodes = %d\n
+0008a750: 222c 2063 6772 6170 682d 3e6e 5f6e 6f64  ", cgraph->n_nod
+0008a760: 6573 293b 0a20 2020 2066 6f72 2028 696e  es);.    for (in
+0008a770: 7420 6920 3d20 303b 2069 203c 2063 6772  t i = 0; i < cgr
+0008a780: 6170 682d 3e6e 5f6e 6f64 6573 3b20 692b  aph->n_nodes; i+
+0008a790: 2b29 207b 0a20 2020 2020 2020 2073 7472  +) {.        str
+0008a7a0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0008a7b0: 2a20 6e6f 6465 203d 2063 6772 6170 682d  * node = cgraph-
+0008a7c0: 3e6e 6f64 6573 5b69 5d3b 0a0a 2020 2020  >nodes[i];..    
+0008a7d0: 2020 2020 7065 7266 5f74 6f74 616c 5f70      perf_total_p
+0008a7e0: 6572 5f6f 705f 7573 5b6e 6f64 652d 3e6f  er_op_us[node->o
+0008a7f0: 705d 202b 3d20 4d41 5828 312c 206e 6f64  p] += MAX(1, nod
+0008a800: 652d 3e70 6572 665f 7469 6d65 5f75 7329  e->perf_time_us)
+0008a810: 3b0a 0a20 2020 2020 2020 2047 474d 4c5f  ;..        GGML_
+0008a820: 5052 494e 5428 2220 2d20 2533 643a 205b  PRINT(" - %3d: [
+0008a830: 2025 3522 2050 5249 6436 3420 222c 2025   %5" PRId64 ", %
+0008a840: 3522 2050 5249 6436 3420 222c 2025 3522  5" PRId64 ", %5"
+0008a850: 2050 5249 6436 3420 225d 2025 3136 7320   PRId64 "] %16s 
+0008a860: 2573 2028 2533 6429 2063 7075 203d 2025  %s (%3d) cpu = %
+0008a870: 372e 3366 202f 2025 372e 3366 206d 732c  7.3f / %7.3f ms,
+0008a880: 2077 616c 6c20 3d20 2537 2e33 6620 2f20   wall = %7.3f / 
+0008a890: 2537 2e33 6620 6d73 5c6e 222c 0a20 2020  %7.3f ms\n",.   
+0008a8a0: 2020 2020 2020 2020 2020 2020 2069 2c0a               i,.
+0008a8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008a8c0: 6e6f 6465 2d3e 6e65 5b30 5d2c 206e 6f64  node->ne[0], nod
+0008a8d0: 652d 3e6e 655b 315d 2c20 6e6f 6465 2d3e  e->ne[1], node->
+0008a8e0: 6e65 5b32 5d2c 0a20 2020 2020 2020 2020  ne[2],.         
+0008a8f0: 2020 2020 2020 2047 474d 4c5f 4f50 5f4e         GGML_OP_N
+0008a900: 414d 455b 6e6f 6465 2d3e 6f70 5d2c 206e  AME[node->op], n
+0008a910: 6f64 652d 3e69 735f 7061 7261 6d20 3f20  ode->is_param ? 
+0008a920: 2278 2220 3a20 6e6f 6465 2d3e 6772 6164  "x" : node->grad
+0008a930: 203f 2022 6722 203a 2022 2022 2c20 6e6f   ? "g" : " ", no
+0008a940: 6465 2d3e 7065 7266 5f72 756e 732c 0a20  de->perf_runs,. 
+0008a950: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0008a960: 646f 7562 6c65 2920 6e6f 6465 2d3e 7065  double) node->pe
+0008a970: 7266 5f63 7963 6c65 7320 202f 2028 646f  rf_cycles  / (do
+0008a980: 7562 6c65 2920 6767 6d6c 5f63 7963 6c65  uble) ggml_cycle
+0008a990: 735f 7065 725f 6d73 2829 2c0a 2020 2020  s_per_ms(),.    
+0008a9a0: 2020 2020 2020 2020 2020 2020 2864 6f75              (dou
+0008a9b0: 626c 6529 206e 6f64 652d 3e70 6572 665f  ble) node->perf_
+0008a9c0: 6379 636c 6573 2020 2f20 2864 6f75 626c  cycles  / (doubl
+0008a9d0: 6529 2067 676d 6c5f 6379 636c 6573 5f70  e) ggml_cycles_p
+0008a9e0: 6572 5f6d 7328 2920 2f20 2864 6f75 626c  er_ms() / (doubl
+0008a9f0: 6529 206e 6f64 652d 3e70 6572 665f 7275  e) node->perf_ru
+0008aa00: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+0008aa10: 2020 2020 2864 6f75 626c 6529 206e 6f64      (double) nod
+0008aa20: 652d 3e70 6572 665f 7469 6d65 5f75 7320  e->perf_time_us 
+0008aa30: 2f20 3130 3030 2e30 2c0a 2020 2020 2020  / 1000.0,.      
+0008aa40: 2020 2020 2020 2020 2020 2864 6f75 626c            (doubl
+0008aa50: 6529 206e 6f64 652d 3e70 6572 665f 7469  e) node->perf_ti
+0008aa60: 6d65 5f75 7320 2f20 3130 3030 2e30 202f  me_us / 1000.0 /
+0008aa70: 206e 6f64 652d 3e70 6572 665f 7275 6e73   node->perf_runs
+0008aa80: 293b 0a20 2020 207d 0a0a 2020 2020 4747  );.    }..    GG
+0008aa90: 4d4c 5f50 5249 4e54 2822 6e5f 6c65 6166  ML_PRINT("n_leaf
+0008aaa0: 7320 3d20 2564 5c6e 222c 2063 6772 6170  s = %d\n", cgrap
+0008aab0: 682d 3e6e 5f6c 6561 6673 293b 0a20 2020  h->n_leafs);.   
+0008aac0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0008aad0: 2069 203c 2063 6772 6170 682d 3e6e 5f6c   i < cgraph->n_l
+0008aae0: 6561 6673 3b20 692b 2b29 207b 0a20 2020  eafs; i++) {.   
+0008aaf0: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0008ab00: 5f74 656e 736f 7220 2a20 6e6f 6465 203d  _tensor * node =
+0008ab10: 2063 6772 6170 682d 3e6c 6561 6673 5b69   cgraph->leafs[i
+0008ab20: 5d3b 0a0a 2020 2020 2020 2020 4747 4d4c  ];..        GGML
+0008ab30: 5f50 5249 4e54 2822 202d 2025 3364 3a20  _PRINT(" - %3d: 
+0008ab40: 5b20 2535 2220 5052 4964 3634 2022 2c20  [ %5" PRId64 ", 
+0008ab50: 2535 2220 5052 4964 3634 2022 5d20 2538  %5" PRId64 "] %8
+0008ab60: 735c 6e22 2c0a 2020 2020 2020 2020 2020  s\n",.          
+0008ab70: 2020 2020 2020 692c 0a20 2020 2020 2020        i,.       
+0008ab80: 2020 2020 2020 2020 206e 6f64 652d 3e6e           node->n
+0008ab90: 655b 305d 2c20 6e6f 6465 2d3e 6e65 5b31  e[0], node->ne[1
+0008aba0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0008abb0: 2020 2047 474d 4c5f 4f50 5f4e 414d 455b     GGML_OP_NAME[
+0008abc0: 6e6f 6465 2d3e 6f70 5d29 3b0a 2020 2020  node->op]);.    
+0008abd0: 7d0a 0a20 2020 2066 6f72 2028 696e 7420  }..    for (int 
+0008abe0: 6920 3d20 303b 2069 203c 2047 474d 4c5f  i = 0; i < GGML_
+0008abf0: 4f50 5f43 4f55 4e54 3b20 692b 2b29 207b  OP_COUNT; i++) {
+0008ac00: 0a20 2020 2020 2020 2069 6620 2870 6572  .        if (per
+0008ac10: 665f 746f 7461 6c5f 7065 725f 6f70 5f75  f_total_per_op_u
+0008ac20: 735b 695d 203d 3d20 3029 207b 0a20 2020  s[i] == 0) {.   
+0008ac30: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0008ac40: 653b 0a20 2020 2020 2020 207d 0a0a 2020  e;.        }..  
+0008ac50: 2020 2020 2020 4747 4d4c 5f50 5249 4e54        GGML_PRINT
+0008ac60: 2822 7065 7266 5f74 6f74 616c 5f70 6572  ("perf_total_per
+0008ac70: 5f6f 705f 7573 5b25 3136 735d 203d 2025  _op_us[%16s] = %
+0008ac80: 372e 3366 206d 735c 6e22 2c20 4747 4d4c  7.3f ms\n", GGML
+0008ac90: 5f4f 505f 4e41 4d45 5b69 5d2c 2028 646f  _OP_NAME[i], (do
+0008aca0: 7562 6c65 2920 7065 7266 5f74 6f74 616c  uble) perf_total
+0008acb0: 5f70 6572 5f6f 705f 7573 5b69 5d20 2f20  _per_op_us[i] / 
+0008acc0: 3130 3030 2e30 293b 0a20 2020 207d 0a0a  1000.0);.    }..
+0008acd0: 2020 2020 4747 4d4c 5f50 5249 4e54 2822      GGML_PRINT("
+0008ace0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0008acf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0008ad00: 3d3d 3d3d 3d3d 3d3d 5c6e 2229 3b0a 7d0a  ========\n");.}.
+0008ad10: 0a2f 2f20 6368 6563 6b20 6966 206e 6f64  .// check if nod
+0008ad20: 6520 6973 2070 6172 7420 6f66 2074 6865  e is part of the
+0008ad30: 2067 7261 7068 0a73 7461 7469 6320 626f   graph.static bo
+0008ad40: 6f6c 2067 676d 6c5f 6772 6170 685f 6669  ol ggml_graph_fi
+0008ad50: 6e64 2863 6f6e 7374 2073 7472 7563 7420  nd(const struct 
+0008ad60: 6767 6d6c 5f63 6772 6170 6820 2a20 6367  ggml_cgraph * cg
+0008ad70: 7261 7068 2c20 636f 6e73 7420 7374 7275  raph, const stru
+0008ad80: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
+0008ad90: 206e 6f64 6529 207b 0a20 2020 2069 6620   node) {.    if 
+0008ada0: 2863 6772 6170 6820 3d3d 204e 554c 4c29  (cgraph == NULL)
+0008adb0: 207b 0a20 2020 2020 2020 2072 6574 7572   {.        retur
+0008adc0: 6e20 7472 7565 3b0a 2020 2020 7d0a 0a20  n true;.    }.. 
 0008add0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
 0008ade0: 303b 2069 203c 2063 6772 6170 682d 3e6e  0; i < cgraph->n
 0008adf0: 5f6e 6f64 6573 3b20 692b 2b29 207b 0a20  _nodes; i++) {. 
-0008ae00: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0008ae10: 6d6c 5f74 656e 736f 7220 2a20 7061 7265  ml_tensor * pare
-0008ae20: 6e74 203d 2063 6772 6170 682d 3e6e 6f64  nt = cgraph->nod
-0008ae30: 6573 5b69 5d3b 0a0a 2020 2020 2020 2020  es[i];..        
-0008ae40: 6966 2028 7061 7265 6e74 2d3e 6772 6164  if (parent->grad
-0008ae50: 203d 3d20 6e6f 6465 2920 7b0a 2020 2020   == node) {.    
-0008ae60: 2020 2020 2020 2020 7265 7475 726e 2070          return p
-0008ae70: 6172 656e 743b 0a20 2020 2020 2020 207d  arent;.        }
-0008ae80: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-0008ae90: 726e 204e 554c 4c3b 0a7d 0a0a 7374 6174  rn NULL;.}..stat
-0008aea0: 6963 2076 6f69 6420 6767 6d6c 5f67 7261  ic void ggml_gra
-0008aeb0: 7068 5f64 756d 705f 646f 745f 6e6f 6465  ph_dump_dot_node
-0008aec0: 5f65 6467 6528 4649 4c45 202a 2066 702c  _edge(FILE * fp,
-0008aed0: 2063 6f6e 7374 2073 7472 7563 7420 6767   const struct gg
-0008aee0: 6d6c 5f63 6772 6170 6820 2a20 6762 2c20  ml_cgraph * gb, 
-0008aef0: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0008af00: 6f72 202a 206e 6f64 652c 2073 7472 7563  or * node, struc
-0008af10: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
-0008af20: 7061 7265 6e74 2c20 636f 6e73 7420 6368  parent, const ch
-0008af30: 6172 202a 206c 6162 656c 2920 207b 0a20  ar * label)  {. 
-0008af40: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-0008af50: 656e 736f 7220 2a20 6770 6172 656e 7420  ensor * gparent 
-0008af60: 3d20 6767 6d6c 5f67 7261 7068 5f67 6574  = ggml_graph_get
-0008af70: 5f70 6172 656e 7428 6762 2c20 6e6f 6465  _parent(gb, node
-0008af80: 293b 0a20 2020 2073 7472 7563 7420 6767  );.    struct gg
-0008af90: 6d6c 5f74 656e 736f 7220 2a20 6770 6172  ml_tensor * gpar
-0008afa0: 656e 7430 203d 2067 676d 6c5f 6772 6170  ent0 = ggml_grap
-0008afb0: 685f 6765 745f 7061 7265 6e74 2867 622c  h_get_parent(gb,
-0008afc0: 2070 6172 656e 7429 3b0a 2020 2020 6670   parent);.    fp
-0008afd0: 7269 6e74 6628 6670 2c20 2220 205c 2225  rintf(fp, "  \"%
-0008afe0: 705c 223a 2573 202d 3e20 5c22 2570 5c22  p\":%s -> \"%p\"
-0008aff0: 3a25 7320 5b20 6172 726f 7768 6561 6420  :%s [ arrowhead 
-0008b000: 3d20 2573 3b20 7374 796c 6520 3d20 2573  = %s; style = %s
-0008b010: 3b20 6c61 6265 6c20 3d20 5c22 2573 5c22  ; label = \"%s\"
-0008b020: 3b20 5d5c 6e22 2c0a 2020 2020 2020 2020  ; ]\n",.        
-0008b030: 2020 2020 6770 6172 656e 7430 203f 2028      gparent0 ? (
-0008b040: 766f 6964 202a 2920 6770 6172 656e 7430  void *) gparent0
-0008b050: 203a 2028 766f 6964 202a 2920 7061 7265   : (void *) pare
-0008b060: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0008b070: 6770 6172 656e 7430 203f 2022 6722 203a  gparent0 ? "g" :
-0008b080: 2022 7822 2c0a 2020 2020 2020 2020 2020   "x",.          
-0008b090: 2020 6770 6172 656e 7420 3f20 2876 6f69    gparent ? (voi
-0008b0a0: 6420 2a29 2067 7061 7265 6e74 203a 2028  d *) gparent : (
-0008b0b0: 766f 6964 202a 2920 6e6f 6465 2c0a 2020  void *) node,.  
-0008b0c0: 2020 2020 2020 2020 2020 6770 6172 656e            gparen
-0008b0d0: 7420 3f20 2267 2220 3a20 2278 222c 0a20  t ? "g" : "x",. 
-0008b0e0: 2020 2020 2020 2020 2020 2067 7061 7265             gpare
-0008b0f0: 6e74 203f 2022 656d 7074 7922 203a 2022  nt ? "empty" : "
-0008b100: 7665 6522 2c0a 2020 2020 2020 2020 2020  vee",.          
-0008b110: 2020 6770 6172 656e 7420 3f20 2264 6173    gparent ? "das
-0008b120: 6865 6422 203a 2022 736f 6c69 6422 2c0a  hed" : "solid",.
-0008b130: 2020 2020 2020 2020 2020 2020 6c61 6265              labe
-0008b140: 6c29 3b0a 7d0a 0a73 7461 7469 6320 766f  l);.}..static vo
-0008b150: 6964 2067 676d 6c5f 6772 6170 685f 6475  id ggml_graph_du
-0008b160: 6d70 5f64 6f74 5f6c 6561 665f 6564 6765  mp_dot_leaf_edge
-0008b170: 2846 494c 4520 2a20 6670 2c20 7374 7275  (FILE * fp, stru
-0008b180: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0008b190: 206e 6f64 652c 2073 7472 7563 7420 6767   node, struct gg
-0008b1a0: 6d6c 5f74 656e 736f 7220 2a20 7061 7265  ml_tensor * pare
-0008b1b0: 6e74 2c20 636f 6e73 7420 6368 6172 202a  nt, const char *
-0008b1c0: 206c 6162 656c 2920 207b 0a20 2020 2066   label)  {.    f
-0008b1d0: 7072 696e 7466 2866 702c 2022 2020 5c22  printf(fp, "  \"
-0008b1e0: 2570 5c22 3a25 7320 2d3e 205c 2225 705c  %p\":%s -> \"%p\
-0008b1f0: 223a 2573 205b 206c 6162 656c 203d 205c  ":%s [ label = \
-0008b200: 2225 735c 223b 205d 5c6e 222c 0a20 2020  "%s\"; ]\n",.   
-0008b210: 2020 2020 2020 2020 2028 766f 6964 202a           (void *
-0008b220: 2920 7061 7265 6e74 2c20 2278 222c 0a20  ) parent, "x",. 
-0008b230: 2020 2020 2020 2020 2020 2028 766f 6964             (void
-0008b240: 202a 2920 6e6f 6465 2c20 2278 222c 0a20   *) node, "x",. 
-0008b250: 2020 2020 2020 2020 2020 206c 6162 656c             label
-0008b260: 293b 0a7d 0a0a 766f 6964 2067 676d 6c5f  );.}..void ggml_
-0008b270: 6772 6170 685f 6475 6d70 5f64 6f74 2863  graph_dump_dot(c
-0008b280: 6f6e 7374 2073 7472 7563 7420 6767 6d6c  onst struct ggml
-0008b290: 5f63 6772 6170 6820 2a20 6762 2c20 636f  _cgraph * gb, co
-0008b2a0: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
-0008b2b0: 6367 7261 7068 202a 2067 662c 2063 6f6e  cgraph * gf, con
-0008b2c0: 7374 2063 6861 7220 2a20 6669 6c65 6e61  st char * filena
-0008b2d0: 6d65 2920 7b0a 2020 2020 6368 6172 2063  me) {.    char c
-0008b2e0: 6f6c 6f72 5b31 365d 3b0a 0a20 2020 2046  olor[16];..    F
-0008b2f0: 494c 4520 2a20 6670 203d 2066 6f70 656e  ILE * fp = fopen
-0008b300: 2866 696c 656e 616d 652c 2022 7722 293b  (filename, "w");
-0008b310: 0a20 2020 2047 474d 4c5f 4153 5345 5254  .    GGML_ASSERT
-0008b320: 2866 7029 3b0a 0a20 2020 2066 7072 696e  (fp);..    fprin
-0008b330: 7466 2866 702c 2022 6469 6772 6170 6820  tf(fp, "digraph 
-0008b340: 4720 7b5c 6e22 293b 0a20 2020 2066 7072  G {\n");.    fpr
-0008b350: 696e 7466 2866 702c 2022 2020 6e65 7772  intf(fp, "  newr
-0008b360: 616e 6b20 3d20 7472 7565 3b5c 6e22 293b  ank = true;\n");
-0008b370: 0a20 2020 2066 7072 696e 7466 2866 702c  .    fprintf(fp,
-0008b380: 2022 2020 7261 6e6b 6469 7220 3d20 4c52   "  rankdir = LR
-0008b390: 3b5c 6e22 293b 0a0a 2020 2020 666f 7220  ;\n");..    for 
-0008b3a0: 2869 6e74 2069 203d 2030 3b20 6920 3c20  (int i = 0; i < 
-0008b3b0: 6762 2d3e 6e5f 6e6f 6465 733b 2069 2b2b  gb->n_nodes; i++
-0008b3c0: 2920 7b0a 2020 2020 2020 2020 7374 7275  ) {.        stru
-0008b3d0: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-0008b3e0: 206e 6f64 6520 3d20 6762 2d3e 6e6f 6465   node = gb->node
-0008b3f0: 735b 695d 3b0a 0a20 2020 2020 2020 2069  s[i];..        i
-0008b400: 6620 2867 676d 6c5f 6772 6170 685f 6765  f (ggml_graph_ge
-0008b410: 745f 7061 7265 6e74 2867 622c 206e 6f64  t_parent(gb, nod
-0008b420: 6529 2021 3d20 4e55 4c4c 2920 7b0a 2020  e) != NULL) {.  
-0008b430: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0008b440: 7565 3b0a 2020 2020 2020 2020 7d0a 0a20  ue;.        }.. 
-0008b450: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
-0008b460: 3e69 735f 7061 7261 6d29 207b 0a20 2020  >is_param) {.   
-0008b470: 2020 2020 2020 2020 2073 6e70 7269 6e74           snprint
-0008b480: 6628 636f 6c6f 722c 2073 697a 656f 6628  f(color, sizeof(
-0008b490: 636f 6c6f 7229 2c20 2279 656c 6c6f 7722  color), "yellow"
-0008b4a0: 293b 0a20 2020 2020 2020 207d 2065 6c73  );.        } els
-0008b4b0: 6520 6966 2028 6e6f 6465 2d3e 6772 6164  e if (node->grad
-0008b4c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-0008b4d0: 6966 2028 6767 6d6c 5f67 7261 7068 5f66  if (ggml_graph_f
-0008b4e0: 696e 6428 6766 2c20 6e6f 6465 2929 207b  ind(gf, node)) {
-0008b4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008b500: 2073 6e70 7269 6e74 6628 636f 6c6f 722c   snprintf(color,
-0008b510: 2073 697a 656f 6628 636f 6c6f 7229 2c20   sizeof(color), 
-0008b520: 2267 7265 656e 2229 3b0a 2020 2020 2020  "green");.      
-0008b530: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
-0008b540: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0008b550: 6e70 7269 6e74 6628 636f 6c6f 722c 2073  nprintf(color, s
-0008b560: 697a 656f 6628 636f 6c6f 7229 2c20 226c  izeof(color), "l
-0008b570: 6967 6874 626c 7565 2229 3b0a 2020 2020  ightblue");.    
-0008b580: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0008b590: 2020 7d20 656c 7365 207b 0a20 2020 2020    } else {.     
-0008b5a0: 2020 2020 2020 2073 6e70 7269 6e74 6628         snprintf(
-0008b5b0: 636f 6c6f 722c 2073 697a 656f 6628 636f  color, sizeof(co
-0008b5c0: 6c6f 7229 2c20 2277 6869 7465 2229 3b0a  lor), "white");.
-0008b5d0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0008b5e0: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
-0008b5f0: 2020 5c22 2570 5c22 205b 2022 0a20 2020    \"%p\" [ ".   
+0008ae00: 2020 2020 2020 2069 6620 2863 6772 6170         if (cgrap
+0008ae10: 682d 3e6e 6f64 6573 5b69 5d20 3d3d 206e  h->nodes[i] == n
+0008ae20: 6f64 6529 207b 0a20 2020 2020 2020 2020  ode) {.         
+0008ae30: 2020 2072 6574 7572 6e20 7472 7565 3b0a     return true;.
+0008ae40: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0008ae50: 0a20 2020 2072 6574 7572 6e20 6661 6c73  .    return fals
+0008ae60: 653b 0a7d 0a0a 7374 6174 6963 2073 7472  e;.}..static str
+0008ae70: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0008ae80: 2a20 6767 6d6c 5f67 7261 7068 5f67 6574  * ggml_graph_get
+0008ae90: 5f70 6172 656e 7428 636f 6e73 7420 7374  _parent(const st
+0008aea0: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+0008aeb0: 202a 2063 6772 6170 682c 2063 6f6e 7374   * cgraph, const
+0008aec0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0008aed0: 736f 7220 2a20 6e6f 6465 2920 7b0a 2020  sor * node) {.  
+0008aee0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+0008aef0: 3b20 6920 3c20 6367 7261 7068 2d3e 6e5f  ; i < cgraph->n_
+0008af00: 6e6f 6465 733b 2069 2b2b 2920 7b0a 2020  nodes; i++) {.  
+0008af10: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008af20: 6c5f 7465 6e73 6f72 202a 2070 6172 656e  l_tensor * paren
+0008af30: 7420 3d20 6367 7261 7068 2d3e 6e6f 6465  t = cgraph->node
+0008af40: 735b 695d 3b0a 0a20 2020 2020 2020 2069  s[i];..        i
+0008af50: 6620 2870 6172 656e 742d 3e67 7261 6420  f (parent->grad 
+0008af60: 3d3d 206e 6f64 6529 207b 0a20 2020 2020  == node) {.     
+0008af70: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0008af80: 7265 6e74 3b0a 2020 2020 2020 2020 7d0a  rent;.        }.
+0008af90: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
+0008afa0: 6e20 4e55 4c4c 3b0a 7d0a 0a73 7461 7469  n NULL;.}..stati
+0008afb0: 6320 766f 6964 2067 676d 6c5f 6772 6170  c void ggml_grap
+0008afc0: 685f 6475 6d70 5f64 6f74 5f6e 6f64 655f  h_dump_dot_node_
+0008afd0: 6564 6765 2846 494c 4520 2a20 6670 2c20  edge(FILE * fp, 
+0008afe0: 636f 6e73 7420 7374 7275 6374 2067 676d  const struct ggm
+0008aff0: 6c5f 6367 7261 7068 202a 2067 622c 2073  l_cgraph * gb, s
+0008b000: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0008b010: 7220 2a20 6e6f 6465 2c20 7374 7275 6374  r * node, struct
+0008b020: 2067 676d 6c5f 7465 6e73 6f72 202a 2070   ggml_tensor * p
+0008b030: 6172 656e 742c 2063 6f6e 7374 2063 6861  arent, const cha
+0008b040: 7220 2a20 6c61 6265 6c29 2020 7b0a 2020  r * label)  {.  
+0008b050: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+0008b060: 6e73 6f72 202a 2067 7061 7265 6e74 203d  nsor * gparent =
+0008b070: 2067 676d 6c5f 6772 6170 685f 6765 745f   ggml_graph_get_
+0008b080: 7061 7265 6e74 2867 622c 206e 6f64 6529  parent(gb, node)
+0008b090: 3b0a 2020 2020 7374 7275 6374 2067 676d  ;.    struct ggm
+0008b0a0: 6c5f 7465 6e73 6f72 202a 2067 7061 7265  l_tensor * gpare
+0008b0b0: 6e74 3020 3d20 6767 6d6c 5f67 7261 7068  nt0 = ggml_graph
+0008b0c0: 5f67 6574 5f70 6172 656e 7428 6762 2c20  _get_parent(gb, 
+0008b0d0: 7061 7265 6e74 293b 0a20 2020 2066 7072  parent);.    fpr
+0008b0e0: 696e 7466 2866 702c 2022 2020 5c22 2570  intf(fp, "  \"%p
+0008b0f0: 5c22 3a25 7320 2d3e 205c 2225 705c 223a  \":%s -> \"%p\":
+0008b100: 2573 205b 2061 7272 6f77 6865 6164 203d  %s [ arrowhead =
+0008b110: 2025 733b 2073 7479 6c65 203d 2025 733b   %s; style = %s;
+0008b120: 206c 6162 656c 203d 205c 2225 735c 223b   label = \"%s\";
+0008b130: 205d 5c6e 222c 0a20 2020 2020 2020 2020   ]\n",.         
+0008b140: 2020 2067 7061 7265 6e74 3020 3f20 2876     gparent0 ? (v
+0008b150: 6f69 6420 2a29 2067 7061 7265 6e74 3020  oid *) gparent0 
+0008b160: 3a20 2876 6f69 6420 2a29 2070 6172 656e  : (void *) paren
+0008b170: 742c 0a20 2020 2020 2020 2020 2020 2067  t,.            g
+0008b180: 7061 7265 6e74 3020 3f20 2267 2220 3a20  parent0 ? "g" : 
+0008b190: 2278 222c 0a20 2020 2020 2020 2020 2020  "x",.           
+0008b1a0: 2067 7061 7265 6e74 203f 2028 766f 6964   gparent ? (void
+0008b1b0: 202a 2920 6770 6172 656e 7420 3a20 2876   *) gparent : (v
+0008b1c0: 6f69 6420 2a29 206e 6f64 652c 0a20 2020  oid *) node,.   
+0008b1d0: 2020 2020 2020 2020 2067 7061 7265 6e74           gparent
+0008b1e0: 203f 2022 6722 203a 2022 7822 2c0a 2020   ? "g" : "x",.  
+0008b1f0: 2020 2020 2020 2020 2020 6770 6172 656e            gparen
+0008b200: 7420 3f20 2265 6d70 7479 2220 3a20 2276  t ? "empty" : "v
+0008b210: 6565 222c 0a20 2020 2020 2020 2020 2020  ee",.           
+0008b220: 2067 7061 7265 6e74 203f 2022 6461 7368   gparent ? "dash
+0008b230: 6564 2220 3a20 2273 6f6c 6964 222c 0a20  ed" : "solid",. 
+0008b240: 2020 2020 2020 2020 2020 206c 6162 656c             label
+0008b250: 293b 0a7d 0a0a 7374 6174 6963 2076 6f69  );.}..static voi
+0008b260: 6420 6767 6d6c 5f67 7261 7068 5f64 756d  d ggml_graph_dum
+0008b270: 705f 646f 745f 6c65 6166 5f65 6467 6528  p_dot_leaf_edge(
+0008b280: 4649 4c45 202a 2066 702c 2073 7472 7563  FILE * fp, struc
+0008b290: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0008b2a0: 6e6f 6465 2c20 7374 7275 6374 2067 676d  node, struct ggm
+0008b2b0: 6c5f 7465 6e73 6f72 202a 2070 6172 656e  l_tensor * paren
+0008b2c0: 742c 2063 6f6e 7374 2063 6861 7220 2a20  t, const char * 
+0008b2d0: 6c61 6265 6c29 2020 7b0a 2020 2020 6670  label)  {.    fp
+0008b2e0: 7269 6e74 6628 6670 2c20 2220 205c 2225  rintf(fp, "  \"%
+0008b2f0: 705c 223a 2573 202d 3e20 5c22 2570 5c22  p\":%s -> \"%p\"
+0008b300: 3a25 7320 5b20 6c61 6265 6c20 3d20 5c22  :%s [ label = \"
+0008b310: 2573 5c22 3b20 5d5c 6e22 2c0a 2020 2020  %s\"; ]\n",.    
+0008b320: 2020 2020 2020 2020 2876 6f69 6420 2a29          (void *)
+0008b330: 2070 6172 656e 742c 2022 7822 2c0a 2020   parent, "x",.  
+0008b340: 2020 2020 2020 2020 2020 2876 6f69 6420            (void 
+0008b350: 2a29 206e 6f64 652c 2022 7822 2c0a 2020  *) node, "x",.  
+0008b360: 2020 2020 2020 2020 2020 6c61 6265 6c29            label)
+0008b370: 3b0a 7d0a 0a76 6f69 6420 6767 6d6c 5f67  ;.}..void ggml_g
+0008b380: 7261 7068 5f64 756d 705f 646f 7428 636f  raph_dump_dot(co
+0008b390: 6e73 7420 7374 7275 6374 2067 676d 6c5f  nst struct ggml_
+0008b3a0: 6367 7261 7068 202a 2067 622c 2063 6f6e  cgraph * gb, con
+0008b3b0: 7374 2073 7472 7563 7420 6767 6d6c 5f63  st struct ggml_c
+0008b3c0: 6772 6170 6820 2a20 6766 2c20 636f 6e73  graph * gf, cons
+0008b3d0: 7420 6368 6172 202a 2066 696c 656e 616d  t char * filenam
+0008b3e0: 6529 207b 0a20 2020 2063 6861 7220 636f  e) {.    char co
+0008b3f0: 6c6f 725b 3136 5d3b 0a0a 2020 2020 4649  lor[16];..    FI
+0008b400: 4c45 202a 2066 7020 3d20 666f 7065 6e28  LE * fp = fopen(
+0008b410: 6669 6c65 6e61 6d65 2c20 2277 2229 3b0a  filename, "w");.
+0008b420: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+0008b430: 6670 293b 0a0a 2020 2020 6670 7269 6e74  fp);..    fprint
+0008b440: 6628 6670 2c20 2264 6967 7261 7068 2047  f(fp, "digraph G
+0008b450: 207b 5c6e 2229 3b0a 2020 2020 6670 7269   {\n");.    fpri
+0008b460: 6e74 6628 6670 2c20 2220 206e 6577 7261  ntf(fp, "  newra
+0008b470: 6e6b 203d 2074 7275 653b 5c6e 2229 3b0a  nk = true;\n");.
+0008b480: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0008b490: 2220 2072 616e 6b64 6972 203d 204c 523b  "  rankdir = LR;
+0008b4a0: 5c6e 2229 3b0a 0a20 2020 2066 6f72 2028  \n");..    for (
+0008b4b0: 696e 7420 6920 3d20 303b 2069 203c 2067  int i = 0; i < g
+0008b4c0: 622d 3e6e 5f6e 6f64 6573 3b20 692b 2b29  b->n_nodes; i++)
+0008b4d0: 207b 0a20 2020 2020 2020 2073 7472 7563   {.        struc
+0008b4e0: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+0008b4f0: 6e6f 6465 203d 2067 622d 3e6e 6f64 6573  node = gb->nodes
+0008b500: 5b69 5d3b 0a0a 2020 2020 2020 2020 6966  [i];..        if
+0008b510: 2028 6767 6d6c 5f67 7261 7068 5f67 6574   (ggml_graph_get
+0008b520: 5f70 6172 656e 7428 6762 2c20 6e6f 6465  _parent(gb, node
+0008b530: 2920 213d 204e 554c 4c29 207b 0a20 2020  ) != NULL) {.   
+0008b540: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+0008b550: 653b 0a20 2020 2020 2020 207d 0a0a 2020  e;.        }..  
+0008b560: 2020 2020 2020 6966 2028 6e6f 6465 2d3e        if (node->
+0008b570: 6973 5f70 6172 616d 2920 7b0a 2020 2020  is_param) {.    
+0008b580: 2020 2020 2020 2020 736e 7072 696e 7466          snprintf
+0008b590: 2863 6f6c 6f72 2c20 7369 7a65 6f66 2863  (color, sizeof(c
+0008b5a0: 6f6c 6f72 292c 2022 7965 6c6c 6f77 2229  olor), "yellow")
+0008b5b0: 3b0a 2020 2020 2020 2020 7d20 656c 7365  ;.        } else
+0008b5c0: 2069 6620 286e 6f64 652d 3e67 7261 6429   if (node->grad)
+0008b5d0: 207b 0a20 2020 2020 2020 2020 2020 2069   {.            i
+0008b5e0: 6620 2867 676d 6c5f 6772 6170 685f 6669  f (ggml_graph_fi
+0008b5f0: 6e64 2867 662c 206e 6f64 6529 2920 7b0a  nd(gf, node)) {.
 0008b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008b610: 2022 7374 796c 6520 3d20 6669 6c6c 6564   "style = filled
-0008b620: 3b20 6669 6c6c 636f 6c6f 7220 3d20 2573  ; fillcolor = %s
-0008b630: 3b20 7368 6170 6520 3d20 7265 636f 7264  ; shape = record
-0008b640: 3b20 220a 2020 2020 2020 2020 2020 2020  ; ".            
-0008b650: 2020 2020 2020 2020 226c 6162 656c 3d5c          "label=\
-0008b660: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-0008b670: 2020 2020 2876 6f69 6420 2a29 206e 6f64      (void *) nod
-0008b680: 652c 2063 6f6c 6f72 293b 0a0a 2020 2020  e, color);..    
-0008b690: 2020 2020 6966 2028 7374 726c 656e 286e      if (strlen(n
-0008b6a0: 6f64 652d 3e6e 616d 6529 203e 2030 2920  ode->name) > 0) 
-0008b6b0: 7b0a 2020 2020 2020 2020 2020 2020 6670  {.            fp
-0008b6c0: 7269 6e74 6628 6670 2c20 2225 7320 2825  rintf(fp, "%s (%
-0008b6d0: 7329 7c22 2c20 6e6f 6465 2d3e 6e61 6d65  s)|", node->name
-0008b6e0: 2c20 6767 6d6c 5f74 7970 655f 6e61 6d65  , ggml_type_name
-0008b6f0: 286e 6f64 652d 3e74 7970 6529 293b 0a20  (node->type));. 
-0008b700: 2020 2020 2020 207d 2065 6c73 6520 7b0a         } else {.
-0008b710: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-0008b720: 6e74 6628 6670 2c20 2228 2573 297c 222c  ntf(fp, "(%s)|",
-0008b730: 2067 676d 6c5f 7479 7065 5f6e 616d 6528   ggml_type_name(
-0008b740: 6e6f 6465 2d3e 7479 7065 2929 3b0a 2020  node->type));.  
-0008b750: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0008b760: 2069 6620 286e 6f64 652d 3e6e 5f64 696d   if (node->n_dim
-0008b770: 7320 3d3d 2032 2920 7b0a 2020 2020 2020  s == 2) {.      
-0008b780: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
-0008b790: 2c20 2225 6420 5b25 2220 5052 4964 3634  , "%d [%" PRId64
-0008b7a0: 2022 2c20 2522 2050 5249 6436 3420 225d   ", %" PRId64 "]
-0008b7b0: 207c 203c 783e 2573 222c 2069 2c20 6e6f   | <x>%s", i, no
-0008b7c0: 6465 2d3e 6e65 5b30 5d2c 206e 6f64 652d  de->ne[0], node-
-0008b7d0: 3e6e 655b 315d 2c20 4747 4d4c 5f4f 505f  >ne[1], GGML_OP_
-0008b7e0: 5359 4d42 4f4c 5b6e 6f64 652d 3e6f 705d  SYMBOL[node->op]
-0008b7f0: 293b 0a20 2020 2020 2020 207d 2065 6c73  );.        } els
-0008b800: 6520 7b0a 2020 2020 2020 2020 2020 2020  e {.            
-0008b810: 6670 7269 6e74 6628 6670 2c20 2225 6420  fprintf(fp, "%d 
-0008b820: 5b25 2220 5052 4964 3634 2022 2c20 2522  [%" PRId64 ", %"
-0008b830: 2050 5249 6436 3420 222c 2025 2220 5052   PRId64 ", %" PR
-0008b840: 4964 3634 2022 5d20 7c20 3c78 3e25 7322  Id64 "] | <x>%s"
-0008b850: 2c20 692c 206e 6f64 652d 3e6e 655b 305d  , i, node->ne[0]
-0008b860: 2c20 6e6f 6465 2d3e 6e65 5b31 5d2c 206e  , node->ne[1], n
-0008b870: 6f64 652d 3e6e 655b 325d 2c20 4747 4d4c  ode->ne[2], GGML
-0008b880: 5f4f 505f 5359 4d42 4f4c 5b6e 6f64 652d  _OP_SYMBOL[node-
-0008b890: 3e6f 705d 293b 0a20 2020 2020 2020 207d  >op]);.        }
-0008b8a0: 0a0a 2020 2020 2020 2020 6966 2028 6e6f  ..        if (no
-0008b8b0: 6465 2d3e 6772 6164 2920 7b0a 2020 2020  de->grad) {.    
-0008b8c0: 2020 2020 2020 2020 6670 7269 6e74 6628          fprintf(
-0008b8d0: 6670 2c20 2220 7c20 3c67 3e25 735c 223b  fp, " | <g>%s\";
-0008b8e0: 205d 5c6e 222c 2047 474d 4c5f 4f50 5f53   ]\n", GGML_OP_S
-0008b8f0: 594d 424f 4c5b 6e6f 6465 2d3e 6772 6164  YMBOL[node->grad
-0008b900: 2d3e 6f70 5d29 3b0a 2020 2020 2020 2020  ->op]);.        
-0008b910: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-0008b920: 2020 2020 2066 7072 696e 7466 2866 702c       fprintf(fp,
-0008b930: 2022 5c22 3b20 5d5c 6e22 293b 0a20 2020   "\"; ]\n");.   
-0008b940: 2020 2020 207d 0a20 2020 207d 0a0a 2020       }.    }..  
-0008b950: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0008b960: 3b20 6920 3c20 6762 2d3e 6e5f 6c65 6166  ; i < gb->n_leaf
-0008b970: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-0008b980: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0008b990: 6e73 6f72 202a 206e 6f64 6520 3d20 6762  nsor * node = gb
-0008b9a0: 2d3e 6c65 6166 735b 695d 3b0a 0a20 2020  ->leafs[i];..   
-0008b9b0: 2020 2020 2073 6e70 7269 6e74 6628 636f       snprintf(co
-0008b9c0: 6c6f 722c 2073 697a 656f 6628 636f 6c6f  lor, sizeof(colo
-0008b9d0: 7229 2c20 2270 696e 6b22 293b 0a0a 2020  r), "pink");..  
-0008b9e0: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
-0008b9f0: 2c20 2220 205c 2225 705c 2220 5b20 220a  , "  \"%p\" [ ".
-0008ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ba10: 2020 2020 2273 7479 6c65 203d 2066 696c      "style = fil
-0008ba20: 6c65 643b 2066 696c 6c63 6f6c 6f72 203d  led; fillcolor =
-0008ba30: 2025 733b 2073 6861 7065 203d 2072 6563   %s; shape = rec
-0008ba40: 6f72 643b 2022 0a20 2020 2020 2020 2020  ord; ".         
-0008ba50: 2020 2020 2020 2020 2020 2022 6c61 6265             "labe
-0008ba60: 6c3d 5c22 3c78 3e22 2c0a 2020 2020 2020  l=\"<x>",.      
-0008ba70: 2020 2020 2020 2020 2020 2876 6f69 6420            (void 
-0008ba80: 2a29 206e 6f64 652c 2063 6f6c 6f72 293b  *) node, color);
-0008ba90: 0a0a 2020 2020 2020 2020 6966 2028 7374  ..        if (st
-0008baa0: 726c 656e 286e 6f64 652d 3e6e 616d 6529  rlen(node->name)
-0008bab0: 203e 2030 2920 7b0a 2020 2020 2020 2020   > 0) {.        
-0008bac0: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
-0008bad0: 2225 7320 2825 7329 7c22 2c20 6e6f 6465  "%s (%s)|", node
-0008bae0: 2d3e 6e61 6d65 2c20 6767 6d6c 5f74 7970  ->name, ggml_typ
-0008baf0: 655f 6e61 6d65 286e 6f64 652d 3e74 7970  e_name(node->typ
-0008bb00: 6529 293b 0a20 2020 2020 2020 207d 2065  e));.        } e
-0008bb10: 6c73 6520 7b0a 2020 2020 2020 2020 2020  lse {.          
-0008bb20: 2020 6670 7269 6e74 6628 6670 2c20 2228    fprintf(fp, "(
-0008bb30: 2573 297c 222c 2067 676d 6c5f 7479 7065  %s)|", ggml_type
-0008bb40: 5f6e 616d 6528 6e6f 6465 2d3e 7479 7065  _name(node->type
-0008bb50: 2929 3b0a 2020 2020 2020 2020 7d0a 0a20  ));.        }.. 
-0008bb60: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
-0008bb70: 702c 2022 434f 4e53 5420 2564 205b 2522  p, "CONST %d [%"
-0008bb80: 2050 5249 6436 3420 222c 2025 2220 5052   PRId64 ", %" PR
-0008bb90: 4964 3634 2022 5d22 2c20 692c 206e 6f64  Id64 "]", i, nod
-0008bba0: 652d 3e6e 655b 305d 2c20 6e6f 6465 2d3e  e->ne[0], node->
-0008bbb0: 6e65 5b31 5d29 3b0a 2020 2020 2020 2020  ne[1]);.        
-0008bbc0: 6966 2028 6767 6d6c 5f6e 656c 656d 656e  if (ggml_nelemen
-0008bbd0: 7473 286e 6f64 6529 203c 2035 2920 7b0a  ts(node) < 5) {.
-0008bbe0: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-0008bbf0: 6e74 6628 6670 2c20 2220 7c20 2822 293b  ntf(fp, " | (");
-0008bc00: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0008bc10: 2028 696e 7420 6a20 3d20 303b 206a 203c   (int j = 0; j <
-0008bc20: 2067 676d 6c5f 6e65 6c65 6d65 6e74 7328   ggml_nelements(
-0008bc30: 6e6f 6465 293b 206a 2b2b 2920 7b0a 2020  node); j++) {.  
-0008bc40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0008bc50: 2028 6e6f 6465 2d3e 7479 7065 203d 3d20   (node->type == 
-0008bc60: 4747 4d4c 5f54 5950 455f 4938 207c 7c20  GGML_TYPE_I8 || 
-0008bc70: 6e6f 6465 2d3e 7479 7065 203d 3d20 4747  node->type == GG
-0008bc80: 4d4c 5f54 5950 455f 4931 3620 7c7c 206e  ML_TYPE_I16 || n
-0008bc90: 6f64 652d 3e74 7970 6520 3d3d 2047 474d  ode->type == GGM
-0008bca0: 4c5f 5459 5045 5f49 3332 2920 7b0a 2020  L_TYPE_I32) {.  
-0008bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bcc0: 2020 6670 7269 6e74 6628 6670 2c20 2225    fprintf(fp, "%
-0008bcd0: 6422 2c20 6767 6d6c 5f67 6574 5f69 3332  d", ggml_get_i32
-0008bce0: 5f31 6428 6e6f 6465 2c20 6a29 293b 0a20  _1d(node, j));. 
-0008bcf0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0008bd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0008bd10: 2065 6c73 6520 6966 2028 6e6f 6465 2d3e   else if (node->
-0008bd20: 7479 7065 203d 3d20 4747 4d4c 5f54 5950  type == GGML_TYP
-0008bd30: 455f 4633 3220 7c7c 206e 6f64 652d 3e74  E_F32 || node->t
-0008bd40: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
-0008bd50: 5f46 3136 2920 7b0a 2020 2020 2020 2020  _F16) {.        
-0008bd60: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-0008bd70: 6e74 6628 6670 2c20 2225 2e31 6522 2c20  ntf(fp, "%.1e", 
-0008bd80: 2864 6f75 626c 6529 6767 6d6c 5f67 6574  (double)ggml_get
-0008bd90: 5f66 3332 5f31 6428 6e6f 6465 2c20 6a29  _f32_1d(node, j)
-0008bda0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-0008bdb0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0008bdc0: 2020 2020 2065 6c73 6520 7b0a 2020 2020       else {.    
-0008bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008bde0: 6670 7269 6e74 6628 6670 2c20 2223 2229  fprintf(fp, "#")
-0008bdf0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0008be00: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0008be10: 2020 2020 6966 2028 6a20 3c20 6767 6d6c      if (j < ggml
-0008be20: 5f6e 656c 656d 656e 7473 286e 6f64 6529  _nelements(node)
-0008be30: 202d 2031 2920 7b0a 2020 2020 2020 2020   - 1) {.        
-0008be40: 2020 2020 2020 2020 2020 2020 6670 7269              fpri
-0008be50: 6e74 6628 6670 2c20 222c 2022 293b 0a20  ntf(fp, ", ");. 
-0008be60: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0008be70: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-0008be80: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
-0008be90: 7466 2866 702c 2022 2922 293b 0a20 2020  tf(fp, ")");.   
-0008bea0: 2020 2020 207d 0a20 2020 2020 2020 2066       }.        f
-0008beb0: 7072 696e 7466 2866 702c 2022 5c22 3b20  printf(fp, "\"; 
-0008bec0: 5d5c 6e22 293b 0a20 2020 207d 0a0a 2020  ]\n");.    }..  
-0008bed0: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
-0008bee0: 3b20 6920 3c20 6762 2d3e 6e5f 6e6f 6465  ; i < gb->n_node
-0008bef0: 733b 2069 2b2b 2920 7b0a 2020 2020 2020  s; i++) {.      
-0008bf00: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
-0008bf10: 6e73 6f72 202a 206e 6f64 6520 3d20 6762  nsor * node = gb
-0008bf20: 2d3e 6e6f 6465 735b 695d 3b0a 0a20 2020  ->nodes[i];..   
-0008bf30: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-0008bf40: 3d20 303b 206a 203c 2047 474d 4c5f 4d41  = 0; j < GGML_MA
-0008bf50: 585f 5352 433b 206a 2b2b 2920 7b0a 2020  X_SRC; j++) {.  
-0008bf60: 2020 2020 2020 2020 2020 6966 2028 6e6f            if (no
-0008bf70: 6465 2d3e 7372 635b 6a5d 2920 7b0a 2020  de->src[j]) {.  
-0008bf80: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-0008bf90: 6172 206c 6162 656c 5b31 365d 3b0a 2020  ar label[16];.  
-0008bfa0: 2020 2020 2020 2020 2020 2020 2020 736e                sn
-0008bfb0: 7072 696e 7466 286c 6162 656c 2c20 7369  printf(label, si
-0008bfc0: 7a65 6f66 286c 6162 656c 292c 2022 7372  zeof(label), "sr
-0008bfd0: 6320 2564 222c 206a 293b 0a20 2020 2020  c %d", j);.     
-0008bfe0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0008bff0: 6772 6170 685f 6475 6d70 5f64 6f74 5f6e  graph_dump_dot_n
-0008c000: 6f64 655f 6564 6765 2866 702c 2067 622c  ode_edge(fp, gb,
-0008c010: 206e 6f64 652c 206e 6f64 652d 3e73 7263   node, node->src
-0008c020: 5b6a 5d2c 206c 6162 656c 293b 0a20 2020  [j], label);.   
-0008c030: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0008c040: 2020 207d 0a20 2020 207d 0a0a 2020 2020     }.    }..    
-0008c050: 666f 7220 2869 6e74 2069 203d 2030 3b20  for (int i = 0; 
-0008c060: 6920 3c20 6762 2d3e 6e5f 6c65 6166 733b  i < gb->n_leafs;
-0008c070: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
-0008c080: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
-0008c090: 6f72 202a 206e 6f64 6520 3d20 6762 2d3e  or * node = gb->
-0008c0a0: 6c65 6166 735b 695d 3b0a 0a20 2020 2020  leafs[i];..     
-0008c0b0: 2020 2066 6f72 2028 696e 7420 6a20 3d20     for (int j = 
-0008c0c0: 303b 206a 203c 2047 474d 4c5f 4d41 585f  0; j < GGML_MAX_
-0008c0d0: 5352 433b 206a 2b2b 2920 7b0a 2020 2020  SRC; j++) {.    
-0008c0e0: 2020 2020 2020 2020 6966 2028 6e6f 6465          if (node
-0008c0f0: 2d3e 7372 635b 6a5d 2920 7b0a 2020 2020  ->src[j]) {.    
-0008c100: 2020 2020 2020 2020 2020 2020 6368 6172              char
-0008c110: 206c 6162 656c 5b31 365d 3b0a 2020 2020   label[16];.    
-0008c120: 2020 2020 2020 2020 2020 2020 736e 7072              snpr
-0008c130: 696e 7466 286c 6162 656c 2c20 7369 7a65  intf(label, size
-0008c140: 6f66 286c 6162 656c 292c 2022 7372 6320  of(label), "src 
-0008c150: 2564 222c 206a 293b 0a20 2020 2020 2020  %d", j);.       
-0008c160: 2020 2020 2020 2020 2067 676d 6c5f 6772           ggml_gr
-0008c170: 6170 685f 6475 6d70 5f64 6f74 5f6c 6561  aph_dump_dot_lea
-0008c180: 665f 6564 6765 2866 702c 206e 6f64 652c  f_edge(fp, node,
-0008c190: 206e 6f64 652d 3e73 7263 5b6a 5d2c 206c   node->src[j], l
-0008c1a0: 6162 656c 293b 0a20 2020 2020 2020 2020  abel);.         
-0008c1b0: 2020 207d 0a20 2020 2020 2020 207d 0a20     }.        }. 
-0008c1c0: 2020 207d 0a0a 2020 2020 6670 7269 6e74     }..    fprint
-0008c1d0: 6628 6670 2c20 227d 5c6e 2229 3b0a 0a20  f(fp, "}\n");.. 
-0008c1e0: 2020 2066 636c 6f73 6528 6670 293b 0a0a     fclose(fp);..
-0008c1f0: 2020 2020 4747 4d4c 5f50 5249 4e54 2822      GGML_PRINT("
-0008c200: 2573 3a20 646f 7420 2d54 706e 6720 2573  %s: dot -Tpng %s
-0008c210: 202d 6f20 2573 2e70 6e67 2026 2620 6f70   -o %s.png && op
-0008c220: 656e 2025 732e 706e 675c 6e22 2c20 5f5f  en %s.png\n", __
-0008c230: 6675 6e63 5f5f 2c20 6669 6c65 6e61 6d65  func__, filename
-0008c240: 2c20 6669 6c65 6e61 6d65 2c20 6669 6c65  , filename, file
-0008c250: 6e61 6d65 293b 0a7d 0a0a 2f2f 2f2f 2f2f  name);.}..//////
-0008c260: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008c270: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008c280: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008c290: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-0008c2a0: 2f2f 2f2f 2f2f 2f2f 2f2f 0a0a 7374 6174  //////////..stat
-0008c2b0: 6963 2076 6f69 6420 6767 6d6c 5f6f 7074  ic void ggml_opt
-0008c2c0: 5f73 6574 5f70 6172 616d 7328 696e 7420  _set_params(int 
-0008c2d0: 6e70 2c20 7374 7275 6374 2067 676d 6c5f  np, struct ggml_
-0008c2e0: 7465 6e73 6f72 202a 2063 6f6e 7374 2070  tensor * const p
-0008c2f0: 735b 5d2c 2063 6f6e 7374 2066 6c6f 6174  s[], const float
-0008c300: 202a 2078 2920 7b0a 2020 2020 696e 7420   * x) {.    int 
-0008c310: 6920 3d20 303b 0a20 2020 2066 6f72 2028  i = 0;.    for (
-0008c320: 696e 7420 7020 3d20 303b 2070 203c 206e  int p = 0; p < n
-0008c330: 703b 202b 2b70 2920 7b0a 2020 2020 2020  p; ++p) {.      
-0008c340: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0008c350: 6e65 203d 2067 676d 6c5f 6e65 6c65 6d65  ne = ggml_neleme
-0008c360: 6e74 7328 7073 5b70 5d29 203b 0a20 2020  nts(ps[p]) ;.   
-0008c370: 2020 2020 202f 2f20 544f 444f 3a20 6164       // TODO: ad
-0008c380: 6420 6675 6e63 7469 6f6e 2074 6f20 7365  d function to se
-0008c390: 7420 7465 6e73 6f72 2066 726f 6d20 6172  t tensor from ar
-0008c3a0: 7261 790a 2020 2020 2020 2020 666f 7220  ray.        for 
-0008c3b0: 2869 6e74 3634 5f74 206a 203d 2030 3b20  (int64_t j = 0; 
-0008c3c0: 6a20 3c20 6e65 3b20 2b2b 6a29 207b 0a20  j < ne; ++j) {. 
-0008c3d0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
-0008c3e0: 7365 745f 6633 325f 3164 2870 735b 705d  set_f32_1d(ps[p]
-0008c3f0: 2c20 6a2c 2078 5b69 2b2b 5d29 3b0a 2020  , j, x[i++]);.  
-0008c400: 2020 2020 2020 7d0a 2020 2020 7d0a 7d0a        }.    }.}.
-0008c410: 0a73 7461 7469 6320 766f 6964 2067 676d  .static void ggm
-0008c420: 6c5f 6f70 745f 6765 745f 7061 7261 6d73  l_opt_get_params
-0008c430: 2869 6e74 206e 702c 2073 7472 7563 7420  (int np, struct 
-0008c440: 6767 6d6c 5f74 656e 736f 7220 2a20 636f  ggml_tensor * co
-0008c450: 6e73 7420 7073 5b5d 2c20 666c 6f61 7420  nst ps[], float 
-0008c460: 2a20 7829 207b 0a20 2020 2069 6e74 2069  * x) {.    int i
-0008c470: 203d 2030 3b0a 2020 2020 666f 7220 2869   = 0;.    for (i
-0008c480: 6e74 2070 203d 2030 3b20 7020 3c20 6e70  nt p = 0; p < np
-0008c490: 3b20 2b2b 7029 207b 0a20 2020 2020 2020  ; ++p) {.       
-0008c4a0: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
-0008c4b0: 6520 3d20 6767 6d6c 5f6e 656c 656d 656e  e = ggml_nelemen
-0008c4c0: 7473 2870 735b 705d 2920 3b0a 2020 2020  ts(ps[p]) ;.    
-0008c4d0: 2020 2020 2f2f 2054 4f44 4f3a 2061 6464      // TODO: add
-0008c4e0: 2066 756e 6374 696f 6e20 746f 2067 6574   function to get
-0008c4f0: 2061 6c6c 2065 6c65 6d65 6e74 7320 6174   all elements at
-0008c500: 206f 6e63 650a 2020 2020 2020 2020 666f   once.        fo
-0008c510: 7220 2869 6e74 3634 5f74 206a 203d 2030  r (int64_t j = 0
-0008c520: 3b20 6a20 3c20 6e65 3b20 2b2b 6a29 207b  ; j < ne; ++j) {
-0008c530: 0a20 2020 2020 2020 2020 2020 2078 5b69  .            x[i
-0008c540: 2b2b 5d20 3d20 6767 6d6c 5f67 6574 5f66  ++] = ggml_get_f
-0008c550: 3332 5f31 6428 7073 5b70 5d2c 206a 293b  32_1d(ps[p], j);
-0008c560: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
-0008c570: 0a7d 0a0a 7374 6174 6963 2076 6f69 6420  .}..static void 
-0008c580: 6767 6d6c 5f6f 7074 5f67 6574 5f67 7261  ggml_opt_get_gra
-0008c590: 6428 696e 7420 6e70 2c20 7374 7275 6374  d(int np, struct
-0008c5a0: 2067 676d 6c5f 7465 6e73 6f72 202a 2063   ggml_tensor * c
-0008c5b0: 6f6e 7374 2070 735b 5d2c 2066 6c6f 6174  onst ps[], float
-0008c5c0: 202a 2067 2920 7b0a 2020 2020 696e 7420   * g) {.    int 
-0008c5d0: 6920 3d20 303b 0a20 2020 2066 6f72 2028  i = 0;.    for (
-0008c5e0: 696e 7420 7020 3d20 303b 2070 203c 206e  int p = 0; p < n
-0008c5f0: 703b 202b 2b70 2920 7b0a 2020 2020 2020  p; ++p) {.      
-0008c600: 2020 636f 6e73 7420 696e 7436 345f 7420    const int64_t 
-0008c610: 6e65 203d 2067 676d 6c5f 6e65 6c65 6d65  ne = ggml_neleme
-0008c620: 6e74 7328 7073 5b70 5d29 203b 0a20 2020  nts(ps[p]) ;.   
-0008c630: 2020 2020 202f 2f20 544f 444f 3a20 6164       // TODO: ad
-0008c640: 6420 6675 6e63 7469 6f6e 2074 6f20 6765  d function to ge
-0008c650: 7420 616c 6c20 656c 656d 656e 7473 2061  t all elements a
-0008c660: 7420 6f6e 6365 0a20 2020 2020 2020 2066  t once.        f
-0008c670: 6f72 2028 696e 7436 345f 7420 6a20 3d20  or (int64_t j = 
-0008c680: 303b 206a 203c 206e 653b 202b 2b6a 2920  0; j < ne; ++j) 
-0008c690: 7b0a 2020 2020 2020 2020 2020 2020 675b  {.            g[
-0008c6a0: 692b 2b5d 203d 2067 676d 6c5f 6765 745f  i++] = ggml_get_
-0008c6b0: 6633 325f 3164 2870 735b 705d 2d3e 6772  f32_1d(ps[p]->gr
-0008c6c0: 6164 2c20 6a29 3b0a 2020 2020 2020 2020  ad, j);.        
-0008c6d0: 7d0a 2020 2020 7d0a 7d0a 0a2f 2f0a 2f2f  }.    }.}..//.//
-0008c6e0: 2041 4441 4d0a 2f2f 0a2f 2f20 2020 7265   ADAM.//.//   re
-0008c6f0: 663a 2068 7474 7073 3a2f 2f61 7278 6976  f: https://arxiv
-0008c700: 2e6f 7267 2f70 6466 2f31 3431 322e 3639  .org/pdf/1412.69
-0008c710: 3830 2e70 6466 0a2f 2f0a 0a73 7461 7469  80.pdf.//..stati
-0008c720: 6320 656e 756d 2067 676d 6c5f 6f70 745f  c enum ggml_opt_
-0008c730: 7265 7375 6c74 2067 676d 6c5f 6f70 745f  result ggml_opt_
-0008c740: 6164 616d 280a 2020 2020 2020 2020 7374  adam(.        st
-0008c750: 7275 6374 2067 676d 6c5f 636f 6e74 6578  ruct ggml_contex
-0008c760: 7420 2a20 6374 782c 0a20 2020 2020 2020  t * ctx,.       
-0008c770: 2073 7472 7563 7420 6767 6d6c 5f6f 7074   struct ggml_opt
-0008c780: 5f63 6f6e 7465 7874 202a 206f 7074 2c0a  _context * opt,.
-0008c790: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
-0008c7a0: 676d 6c5f 6f70 745f 7061 7261 6d73 2070  gml_opt_params p
-0008c7b0: 6172 616d 732c 0a20 2020 2020 2020 2073  arams,.        s
-0008c7c0: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0008c7d0: 7220 2a20 662c 0a20 2020 2020 2020 2073  r * f,.        s
-0008c7e0: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
-0008c7f0: 6820 2a20 6766 2c0a 2020 2020 2020 2020  h * gf,.        
-0008c800: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
-0008c810: 7068 202a 2067 6229 207b 0a20 2020 2047  ph * gb) {.    G
-0008c820: 474d 4c5f 4153 5345 5254 2867 676d 6c5f  GML_ASSERT(ggml_
-0008c830: 6973 5f73 6361 6c61 7228 6629 293b 0a0a  is_scalar(f));..
-0008c840: 2020 2020 2f2f 2074 6865 7365 2077 696c      // these wil
-0008c850: 6c20 7374 6f72 6520 7468 6520 7061 7261  l store the para
-0008c860: 6d65 7465 7273 2077 6520 7761 6e74 2074  meters we want t
-0008c870: 6f20 6f70 7469 6d69 7a65 0a20 2020 2073  o optimize.    s
-0008c880: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
-0008c890: 7220 2a20 7073 5b47 474d 4c5f 4d41 585f  r * ps[GGML_MAX_
-0008c8a0: 5041 5241 4d53 5d3b 0a0a 2020 2020 696e  PARAMS];..    in
-0008c8b0: 7420 6e70 203d 2030 3b0a 2020 2020 696e  t np = 0;.    in
-0008c8c0: 7420 6e78 203d 2030 3b0a 2020 2020 666f  t nx = 0;.    fo
-0008c8d0: 7220 2869 6e74 2069 203d 2030 3b20 6920  r (int i = 0; i 
-0008c8e0: 3c20 6766 2d3e 6e5f 6e6f 6465 733b 202b  < gf->n_nodes; +
-0008c8f0: 2b69 2920 7b0a 2020 2020 2020 2020 6966  +i) {.        if
-0008c900: 2028 6766 2d3e 6e6f 6465 735b 695d 2d3e   (gf->nodes[i]->
-0008c910: 6973 5f70 6172 616d 2920 7b0a 2020 2020  is_param) {.    
-0008c920: 2020 2020 2020 2020 4747 4d4c 5f50 5249          GGML_PRI
-0008c930: 4e54 5f44 4542 5547 2822 666f 756e 6420  NT_DEBUG("found 
-0008c940: 7061 7261 6d20 2564 3a20 6772 6164 2d3e  param %d: grad->
-0008c950: 6f70 203d 2025 645c 6e22 2c20 6e70 2c20  op = %d\n", np, 
-0008c960: 6766 2d3e 6e6f 6465 735b 695d 2d3e 6772  gf->nodes[i]->gr
-0008c970: 6164 2d3e 6f70 293b 0a0a 2020 2020 2020  ad->op);..      
-0008c980: 2020 2020 2020 4747 4d4c 5f41 5353 4552        GGML_ASSER
-0008c990: 5428 6e70 203c 2047 474d 4c5f 4d41 585f  T(np < GGML_MAX_
-0008c9a0: 5041 5241 4d53 293b 0a0a 2020 2020 2020  PARAMS);..      
-0008c9b0: 2020 2020 2020 7073 5b6e 702b 2b5d 203d        ps[np++] =
-0008c9c0: 2067 662d 3e6e 6f64 6573 5b69 5d3b 0a20   gf->nodes[i];. 
-0008c9d0: 2020 2020 2020 2020 2020 206e 7820 2b3d             nx +=
-0008c9e0: 2067 676d 6c5f 6e65 6c65 6d65 6e74 7328   ggml_nelements(
-0008c9f0: 6766 2d3e 6e6f 6465 735b 695d 293b 0a20  gf->nodes[i]);. 
-0008ca00: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-0008ca10: 2020 2020 6966 2028 286f 7074 2d3e 7061      if ((opt->pa
-0008ca20: 7261 6d73 2e74 7970 6520 213d 2070 6172  rams.type != par
-0008ca30: 616d 732e 7479 7065 2920 7c7c 2028 6f70  ams.type) || (op
-0008ca40: 742d 3e6e 7820 213d 206e 7829 207c 7c20  t->nx != nx) || 
-0008ca50: 286f 7074 2d3e 7061 7261 6d73 2e70 6173  (opt->params.pas
-0008ca60: 7420 213d 2070 6172 616d 732e 7061 7374  t != params.past
-0008ca70: 2929 207b 0a20 2020 2020 2020 2069 6e74  )) {.        int
-0008ca80: 2069 7465 7220 3d20 6f70 742d 3e69 7465   iter = opt->ite
-0008ca90: 723b 0a20 2020 2020 2020 2067 676d 6c5f  r;.        ggml_
-0008caa0: 6f70 745f 696e 6974 286f 7074 2d3e 6374  opt_init(opt->ct
-0008cab0: 782c 206f 7074 2c20 7061 7261 6d73 2c20  x, opt, params, 
-0008cac0: 6e78 293b 0a20 2020 2020 2020 206f 7074  nx);.        opt
-0008cad0: 2d3e 6974 6572 203d 2069 7465 723b 0a20  ->iter = iter;. 
-0008cae0: 2020 207d 0a0a 2020 2020 2f2f 2063 6f6e     }..    // con
-0008caf0: 7374 616e 7473 0a20 2020 2063 6f6e 7374  stants.    const
-0008cb00: 2066 6c6f 6174 2073 6368 6564 203d 2070   float sched = p
-0008cb10: 6172 616d 732e 6164 616d 2e73 6368 6564  arams.adam.sched
-0008cb20: 3b0a 2020 2020 636f 6e73 7420 666c 6f61  ;.    const floa
-0008cb30: 7420 6465 6361 7920 3d20 7061 7261 6d73  t decay = params
-0008cb40: 2e61 6461 6d2e 6465 6361 7920 2a20 7363  .adam.decay * sc
-0008cb50: 6865 643b 0a20 2020 2063 6f6e 7374 2066  hed;.    const f
-0008cb60: 6c6f 6174 2061 6c70 6861 203d 2070 6172  loat alpha = par
-0008cb70: 616d 732e 6164 616d 2e61 6c70 6861 202a  ams.adam.alpha *
-0008cb80: 2073 6368 6564 3b0a 2020 2020 636f 6e73   sched;.    cons
-0008cb90: 7420 666c 6f61 7420 6265 7461 3120 3d20  t float beta1 = 
-0008cba0: 7061 7261 6d73 2e61 6461 6d2e 6265 7461  params.adam.beta
-0008cbb0: 313b 0a20 2020 2063 6f6e 7374 2066 6c6f  1;.    const flo
-0008cbc0: 6174 2062 6574 6132 203d 2070 6172 616d  at beta2 = param
-0008cbd0: 732e 6164 616d 2e62 6574 6132 3b0a 2020  s.adam.beta2;.  
-0008cbe0: 2020 636f 6e73 7420 666c 6f61 7420 6570    const float ep
-0008cbf0: 7320 2020 3d20 7061 7261 6d73 2e61 6461  s   = params.ada
-0008cc00: 6d2e 6570 733b 0a0a 2020 2020 666c 6f61  m.eps;..    floa
-0008cc10: 7420 2a20 7820 203d 206f 7074 2d3e 6164  t * x  = opt->ad
-0008cc20: 616d 2e78 2d3e 6461 7461 3b20 202f 2f20  am.x->data;  // 
-0008cc30: 7669 6577 206f 6620 7468 6520 7061 7261  view of the para
-0008cc40: 6d65 7465 7273 0a20 2020 2066 6c6f 6174  meters.    float
-0008cc50: 202a 2067 3120 3d20 6f70 742d 3e61 6461   * g1 = opt->ada
-0008cc60: 6d2e 6731 2d3e 6461 7461 3b20 2f2f 2067  m.g1->data; // g
-0008cc70: 7261 6469 656e 740a 2020 2020 666c 6f61  radient.    floa
-0008cc80: 7420 2a20 6732 203d 206f 7074 2d3e 6164  t * g2 = opt->ad
-0008cc90: 616d 2e67 322d 3e64 6174 613b 202f 2f20  am.g2->data; // 
-0008cca0: 6772 6164 6965 6e74 2073 7175 6172 6564  gradient squared
-0008ccb0: 0a20 2020 2066 6c6f 6174 202a 206d 2020  .    float * m  
-0008ccc0: 3d20 6f70 742d 3e61 6461 6d2e 6d2d 3e64  = opt->adam.m->d
-0008ccd0: 6174 613b 2020 2f2f 2066 6972 7374 206d  ata;  // first m
-0008cce0: 6f6d 656e 740a 2020 2020 666c 6f61 7420  oment.    float 
-0008ccf0: 2a20 7620 203d 206f 7074 2d3e 6164 616d  * v  = opt->adam
-0008cd00: 2e76 2d3e 6461 7461 3b20 202f 2f20 7365  .v->data;  // se
-0008cd10: 636f 6e64 206d 6f6d 656e 740a 2020 2020  cond moment.    
-0008cd20: 666c 6f61 7420 2a20 6d68 203d 206f 7074  float * mh = opt
-0008cd30: 2d3e 6164 616d 2e6d 682d 3e64 6174 613b  ->adam.mh->data;
-0008cd40: 202f 2f20 6669 7273 7420 6d6f 6d65 6e74   // first moment
-0008cd50: 2068 6174 0a20 2020 2066 6c6f 6174 202a   hat.    float *
-0008cd60: 2076 6820 3d20 6f70 742d 3e61 6461 6d2e   vh = opt->adam.
-0008cd70: 7668 2d3e 6461 7461 3b20 2f2f 2073 6563  vh->data; // sec
-0008cd80: 6f6e 6420 6d6f 6d65 6e74 2068 6174 0a0a  ond moment hat..
-0008cd90: 2020 2020 666c 6f61 7420 2a20 7066 203d      float * pf =
-0008cda0: 2070 6172 616d 732e 7061 7374 203e 2030   params.past > 0
-0008cdb0: 203f 206f 7074 2d3e 6164 616d 2e70 662d   ? opt->adam.pf-
-0008cdc0: 3e64 6174 6120 3a20 4e55 4c4c 3b20 2f2f  >data : NULL; //
-0008cdd0: 2070 6173 7420 6675 6e63 7469 6f6e 2076   past function v
-0008cde0: 616c 7565 730a 0a20 2020 202f 2f20 7570  alues..    // up
-0008cdf0: 6461 7465 2076 6965 770a 2020 2020 6767  date view.    gg
-0008ce00: 6d6c 5f6f 7074 5f67 6574 5f70 6172 616d  ml_opt_get_param
-0008ce10: 7328 6e70 2c20 7073 2c20 7829 3b0a 0a20  s(np, ps, x);.. 
-0008ce20: 2020 202f 2f20 636f 6d70 7574 6520 7468     // compute th
-0008ce30: 6520 6675 6e63 7469 6f6e 2076 616c 7565  e function value
-0008ce40: 0a20 2020 2067 676d 6c5f 6772 6170 685f  .    ggml_graph_
-0008ce50: 7265 7365 7420 2028 6766 293b 0a20 2020  reset  (gf);.   
-0008ce60: 2067 676d 6c5f 7365 745f 6633 3220 2020   ggml_set_f32   
-0008ce70: 2020 2028 662d 3e67 7261 642c 2031 2e30     (f->grad, 1.0
-0008ce80: 6629 3b0a 0a20 2020 2067 676d 6c5f 6772  f);..    ggml_gr
-0008ce90: 6170 685f 636f 6d70 7574 655f 7769 7468  aph_compute_with
-0008cea0: 5f63 7478 2863 7478 2c20 6762 2c20 7061  _ctx(ctx, gb, pa
-0008ceb0: 7261 6d73 2e6e 5f74 6872 6561 6473 293b  rams.n_threads);
-0008cec0: 0a0a 2020 2020 6f70 742d 3e61 6461 6d2e  ..    opt->adam.
-0008ced0: 6678 5f70 7265 7620 3d20 6767 6d6c 5f67  fx_prev = ggml_g
-0008cee0: 6574 5f66 3332 5f31 6428 662c 2030 293b  et_f32_1d(f, 0);
-0008cef0: 0a20 2020 206f 7074 2d3e 6164 616d 2e66  .    opt->adam.f
-0008cf00: 785f 6265 7374 203d 206f 7074 2d3e 6164  x_best = opt->ad
-0008cf10: 616d 2e66 785f 7072 6576 3b0a 2020 2020  am.fx_prev;.    
-0008cf20: 6966 2028 7066 2920 7b0a 2020 2020 2020  if (pf) {.      
-0008cf30: 2020 7066 5b6f 7074 2d3e 6974 6572 2025    pf[opt->iter %
-0008cf40: 2070 6172 616d 732e 7061 7374 5d20 3d20   params.past] = 
-0008cf50: 6f70 742d 3e61 6461 6d2e 6678 5f70 7265  opt->adam.fx_pre
-0008cf60: 763b 0a20 2020 207d 0a0a 2020 2020 2f2f  v;.    }..    //
-0008cf70: 2069 6e69 7469 616c 697a 650a 2020 2020   initialize.    
-0008cf80: 6966 2028 6f70 742d 3e6a 7573 745f 696e  if (opt->just_in
-0008cf90: 6974 6961 6c69 7a65 6429 207b 0a20 2020  itialized) {.   
-0008cfa0: 2020 2020 206f 7074 2d3e 6164 616d 2e6e       opt->adam.n
-0008cfb0: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
-0008cfc0: 3d20 303b 0a20 2020 2020 2020 206f 7074  = 0;.        opt
-0008cfd0: 2d3e 6a75 7374 5f69 6e69 7469 616c 697a  ->just_initializ
-0008cfe0: 6564 203d 2066 616c 7365 3b0a 2020 2020  ed = false;.    
-0008cff0: 7d0a 0a20 2020 2066 6c6f 6174 202a 2066  }..    float * f
-0008d000: 785f 6265 7374 203d 2026 6f70 742d 3e61  x_best = &opt->a
-0008d010: 6461 6d2e 6678 5f62 6573 743b 0a20 2020  dam.fx_best;.   
-0008d020: 2066 6c6f 6174 202a 2066 785f 7072 6576   float * fx_prev
-0008d030: 203d 2026 6f70 742d 3e61 6461 6d2e 6678   = &opt->adam.fx
-0008d040: 5f70 7265 763b 0a20 2020 2069 6e74 202a  _prev;.    int *
-0008d050: 206e 5f6e 6f5f 696d 7072 6f76 656d 656e   n_no_improvemen
-0008d060: 7420 3d20 266f 7074 2d3e 6164 616d 2e6e  t = &opt->adam.n
-0008d070: 5f6e 6f5f 696d 7072 6f76 656d 656e 743b  _no_improvement;
-0008d080: 0a0a 2020 2020 696e 7420 6974 6572 3020  ..    int iter0 
-0008d090: 3d20 6f70 742d 3e69 7465 723b 0a0a 2020  = opt->iter;..  
-0008d0a0: 2020 2f2f 2072 756e 2074 6865 206f 7074    // run the opt
-0008d0b0: 696d 697a 6572 0a20 2020 2066 6f72 2028  imizer.    for (
-0008d0c0: 696e 7420 7420 3d20 303b 2074 203c 2070  int t = 0; t < p
-0008d0d0: 6172 616d 732e 6164 616d 2e6e 5f69 7465  arams.adam.n_ite
-0008d0e0: 723b 202b 2b74 2920 7b0a 2020 2020 2020  r; ++t) {.      
-0008d0f0: 2020 6f70 742d 3e69 7465 7220 3d20 6974    opt->iter = it
-0008d100: 6572 3020 2b20 7420 2b20 313b 0a20 2020  er0 + t + 1;.   
-0008d110: 2020 2020 2047 474d 4c5f 5052 494e 545f       GGML_PRINT_
-0008d120: 4445 4255 4720 2028 223d 3d3d 2069 7465  DEBUG  ("=== ite
-0008d130: 7220 2564 203d 3d3d 5c6e 222c 2074 293b  r %d ===\n", t);
-0008d140: 0a0a 2020 2020 2020 2020 4747 4d4c 5f50  ..        GGML_P
-0008d150: 5249 4e54 5f44 4542 5547 2020 2822 6620  RINT_DEBUG  ("f 
-0008d160: 2020 2020 203d 2025 3130 2e36 665c 6e22       = %10.6f\n"
-0008d170: 2c20 6767 6d6c 5f67 6574 5f66 3332 5f31  , ggml_get_f32_1
-0008d180: 6428 662c 2030 2929 3b0a 2020 2020 2020  d(f, 0));.      
-0008d190: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
-0008d1a0: 5547 5f35 2822 6466 2f64 7830 203d 2025  UG_5("df/dx0 = %
-0008d1b0: 3130 2e36 665c 6e22 2c20 6767 6d6c 5f67  10.6f\n", ggml_g
-0008d1c0: 6574 5f66 3332 5f31 6428 7073 5b30 5d2d  et_f32_1d(ps[0]-
-0008d1d0: 3e67 7261 642c 2030 2929 3b0a 2020 2020  >grad, 0));.    
-0008d1e0: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
-0008d1f0: 4542 5547 5f35 2822 6466 2f64 7831 203d  EBUG_5("df/dx1 =
-0008d200: 2025 3130 2e36 665c 6e22 2c20 6767 6d6c   %10.6f\n", ggml
-0008d210: 5f67 6574 5f66 3332 5f31 6428 7073 5b31  _get_f32_1d(ps[1
-0008d220: 5d2d 3e67 7261 642c 2030 2929 3b0a 0a20  ]->grad, 0));.. 
-0008d230: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-0008d240: 6920 3d20 303b 2069 203c 206e 703b 202b  i = 0; i < np; +
-0008d250: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
-0008d260: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
-0008d270: 5547 2822 7061 7261 6d20 2564 3a20 2531  UG("param %d: %1
-0008d280: 302e 3666 2c20 6720 3d20 2531 302e 3666  0.6f, g = %10.6f
-0008d290: 5c6e 222c 2069 2c0a 2020 2020 2020 2020  \n", i,.        
-0008d2a0: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0008d2b0: 5f67 6574 5f66 3332 5f31 6428 7073 5b69  _get_f32_1d(ps[i
-0008d2c0: 5d2c 2030 292c 2067 676d 6c5f 6765 745f  ], 0), ggml_get_
-0008d2d0: 6633 325f 3164 2870 735b 695d 2d3e 6772  f32_1d(ps[i]->gr
-0008d2e0: 6164 2c20 3029 293b 0a20 2020 2020 2020  ad, 0));.       
-0008d2f0: 207d 0a0a 2020 2020 2020 2020 636f 6e73   }..        cons
-0008d300: 7420 696e 7436 345f 7420 745f 7374 6172  t int64_t t_star
-0008d310: 745f 7761 6c6c 203d 2067 676d 6c5f 7469  t_wall = ggml_ti
-0008d320: 6d65 5f75 7328 293b 0a20 2020 2020 2020  me_us();.       
-0008d330: 2063 6f6e 7374 2069 6e74 3634 5f74 2074   const int64_t t
-0008d340: 5f73 7461 7274 5f63 7075 203d 2067 676d  _start_cpu = ggm
-0008d350: 6c5f 6379 636c 6573 2829 3b0a 2020 2020  l_cycles();.    
-0008d360: 2020 2020 554e 5553 4544 2874 5f73 7461      UNUSED(t_sta
-0008d370: 7274 5f77 616c 6c29 3b0a 2020 2020 2020  rt_wall);.      
-0008d380: 2020 554e 5553 4544 2874 5f73 7461 7274    UNUSED(t_start
-0008d390: 5f63 7075 293b 0a0a 2020 2020 2020 2020  _cpu);..        
-0008d3a0: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
-0008d3b0: 2075 7064 6174 6520 7468 6520 6772 6164   update the grad
-0008d3c0: 6965 6e74 0a20 2020 2020 2020 2020 2020  ient.           
-0008d3d0: 2067 676d 6c5f 6f70 745f 6765 745f 6772   ggml_opt_get_gr
-0008d3e0: 6164 286e 702c 2070 732c 2067 3129 3b0a  ad(np, ps, g1);.
-0008d3f0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0008d400: 6d5f 7420 3d20 6265 7461 312a 6d5f 742d  m_t = beta1*m_t-
-0008d410: 3120 2b20 2831 202d 2062 6574 6131 292a  1 + (1 - beta1)*
-0008d420: 675f 740a 2020 2020 2020 2020 2020 2020  g_t.            
-0008d430: 6767 6d6c 5f76 6563 5f73 6361 6c65 5f66  ggml_vec_scale_f
-0008d440: 3332 286e 782c 206d 2c20 6265 7461 3129  32(nx, m, beta1)
-0008d450: 3b0a 2020 2020 2020 2020 2020 2020 6767  ;.            gg
-0008d460: 6d6c 5f76 6563 5f6d 6164 5f66 3332 2020  ml_vec_mad_f32  
-0008d470: 286e 782c 206d 2c20 6731 2c20 312e 3066  (nx, m, g1, 1.0f
-0008d480: 202d 2062 6574 6131 293b 0a0a 2020 2020   - beta1);..    
-0008d490: 2020 2020 2020 2020 2f2f 2067 3220 3d20          // g2 = 
-0008d4a0: 6731 5e32 0a20 2020 2020 2020 2020 2020  g1^2.           
-0008d4b0: 2067 676d 6c5f 7665 635f 7371 725f 6633   ggml_vec_sqr_f3
-0008d4c0: 3220 2028 6e78 2c20 6732 2c20 6731 293b  2  (nx, g2, g1);
-0008d4d0: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-0008d4e0: 2076 5f74 203d 2062 6574 6132 2a76 5f74   v_t = beta2*v_t
-0008d4f0: 2d31 202b 2028 3120 2d20 6265 7461 3229  -1 + (1 - beta2)
-0008d500: 2a67 5f74 5e32 0a20 2020 2020 2020 2020  *g_t^2.         
-0008d510: 2020 2067 676d 6c5f 7665 635f 7363 616c     ggml_vec_scal
-0008d520: 655f 6633 3228 6e78 2c20 762c 2062 6574  e_f32(nx, v, bet
-0008d530: 6132 293b 0a20 2020 2020 2020 2020 2020  a2);.           
-0008d540: 2067 676d 6c5f 7665 635f 6d61 645f 6633   ggml_vec_mad_f3
-0008d550: 3220 2028 6e78 2c20 762c 2067 322c 2031  2  (nx, v, g2, 1
-0008d560: 2e30 6620 2d20 6265 7461 3229 3b0a 0a20  .0f - beta2);.. 
-0008d570: 2020 2020 2020 2020 2020 202f 2f20 6d5e             // m^
-0008d580: 6861 7420 3d20 6d5f 7420 2f20 2831 202d  hat = m_t / (1 -
-0008d590: 2062 6574 6131 5e74 290a 2020 2020 2020   beta1^t).      
-0008d5a0: 2020 2020 2020 2f2f 2076 5e68 6174 203d        // v^hat =
-0008d5b0: 2076 5f74 202f 2028 3120 2d20 6265 7461   v_t / (1 - beta
-0008d5c0: 325e 7429 0a20 2020 2020 2020 2020 2020  2^t).           
-0008d5d0: 202f 2f20 785f 7420 3d20 785f 742d 3120   // x_t = x_t-1 
-0008d5e0: 2d20 7363 6865 642a 2861 6c70 6861 2a6d  - sched*(alpha*m
-0008d5f0: 5e68 6174 2f28 7371 7274 2876 5e68 6174  ^hat/(sqrt(v^hat
-0008d600: 2920 2b20 6570 7329 202b 2064 6563 6179  ) + eps) + decay
-0008d610: 2a78 5f74 2d31 290a 2020 2020 2020 2020  *x_t-1).        
-0008d620: 2020 2020 2f2f 2078 5f74 203d 2078 5f74      // x_t = x_t
-0008d630: 2d31 202d 2073 6368 6564 2a61 6c70 6861  -1 - sched*alpha
-0008d640: 2a6d 5e68 6174 2f28 7371 7274 2876 5e68  *m^hat/(sqrt(v^h
-0008d650: 6174 2920 2b20 6570 7329 202d 2073 6368  at) + eps) - sch
-0008d660: 6564 2a64 6563 6179 2a78 5f74 2d31 0a20  ed*decay*x_t-1. 
-0008d670: 2020 2020 2020 2020 2020 202f 2f20 785f             // x_
-0008d680: 7420 3d20 785f 742d 312a 2831 2d73 6368  t = x_t-1*(1-sch
-0008d690: 6564 2a64 6563 6179 2920 2d20 7363 6865  ed*decay) - sche
-0008d6a0: 642a 616c 7068 612a 6d5e 6861 742f 2873  d*alpha*m^hat/(s
-0008d6b0: 7172 7428 765e 6861 7429 202b 2065 7073  qrt(v^hat) + eps
-0008d6c0: 290a 2020 2020 2020 2020 2020 2020 2f2f  ).            //
-0008d6d0: 2078 5f74 203d 2078 5f74 2d31 2a28 312d   x_t = x_t-1*(1-
-0008d6e0: 7363 6865 642a 6465 6361 7929 202b 2073  sched*decay) + s
-0008d6f0: 6368 6564 2a64 6563 6179 2a28 2d61 6c70  ched*decay*(-alp
-0008d700: 6861 2f64 6563 6179 292a 6d5e 6861 742f  ha/decay)*m^hat/
-0008d710: 2873 7172 7428 765e 6861 7429 202b 2065  (sqrt(v^hat) + e
-0008d720: 7073 290a 2020 2020 2020 2020 2020 2020  ps).            
-0008d730: 2f2f 2078 5f74 203d 206d 6978 2878 5f74  // x_t = mix(x_t
-0008d740: 2d31 2c20 282d 616c 7068 612f 6465 6361  -1, (-alpha/deca
-0008d750: 7929 2a6d 5e68 6174 2f28 7371 7274 2876  y)*m^hat/(sqrt(v
-0008d760: 5e68 6174 2920 2b20 6570 7329 2c20 7363  ^hat) + eps), sc
-0008d770: 6865 642a 6465 6361 7929 0a20 2020 2020  hed*decay).     
-0008d780: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0008d790: 6370 795f 6633 3220 2028 6e78 2c20 6d68  cpy_f32  (nx, mh
-0008d7a0: 2c20 6d29 3b0a 2020 2020 2020 2020 2020  , m);.          
-0008d7b0: 2020 6767 6d6c 5f76 6563 5f63 7079 5f66    ggml_vec_cpy_f
-0008d7c0: 3332 2020 286e 782c 2076 682c 2076 293b  32  (nx, vh, v);
-0008d7d0: 0a0a 2020 2020 2020 2020 2020 2020 6767  ..            gg
-0008d7e0: 6d6c 5f76 6563 5f73 6361 6c65 5f66 3332  ml_vec_scale_f32
-0008d7f0: 286e 782c 206d 682c 2061 6c70 6861 2f28  (nx, mh, alpha/(
-0008d800: 312e 3066 202d 2070 6f77 6628 6265 7461  1.0f - powf(beta
-0008d810: 312c 206f 7074 2d3e 6974 6572 2929 293b  1, opt->iter)));
-0008d820: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-0008d830: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
-0008d840: 6e78 2c20 7668 2c20 2031 2e30 662f 2831  nx, vh,  1.0f/(1
-0008d850: 2e30 6620 2d20 706f 7766 2862 6574 6132  .0f - powf(beta2
-0008d860: 2c20 6f70 742d 3e69 7465 7229 2929 3b0a  , opt->iter)));.
-0008d870: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-0008d880: 6c5f 7665 635f 7371 7274 5f66 3332 2028  l_vec_sqrt_f32 (
-0008d890: 6e78 2c20 7668 2c20 7668 293b 0a20 2020  nx, vh, vh);.   
-0008d8a0: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-0008d8b0: 635f 6163 6331 5f66 3332 2028 6e78 2c20  c_acc1_f32 (nx, 
-0008d8c0: 7668 2c20 6570 7329 3b0a 0a20 2020 2020  vh, eps);..     
-0008d8d0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0008d8e0: 6469 765f 6633 3220 2028 6e78 2c20 6d68  div_f32  (nx, mh
-0008d8f0: 2c20 6d68 2c20 7668 293b 0a20 2020 2020  , mh, vh);.     
-0008d900: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0008d910: 7363 616c 655f 6633 3228 6e78 2c20 782c  scale_f32(nx, x,
-0008d920: 2020 312e 3066 202d 2064 6563 6179 293b    1.0f - decay);
-0008d930: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
-0008d940: 6c5f 7665 635f 7375 625f 6633 3220 2028  l_vec_sub_f32  (
-0008d950: 6e78 2c20 782c 2020 782c 2020 6d68 293b  nx, x,  x,  mh);
-0008d960: 0a0a 2020 2020 2020 2020 2020 2020 2f2f  ..            //
-0008d970: 2075 7064 6174 6520 7468 6520 7061 7261   update the para
-0008d980: 6d65 7465 7273 0a20 2020 2020 2020 2020  meters.         
-0008d990: 2020 2067 676d 6c5f 6f70 745f 7365 745f     ggml_opt_set_
-0008d9a0: 7061 7261 6d73 286e 702c 2070 732c 2078  params(np, ps, x
-0008d9b0: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
-0008d9c0: 2020 2020 2020 6767 6d6c 5f67 7261 7068        ggml_graph
-0008d9d0: 5f72 6573 6574 2020 2867 6629 3b0a 2020  _reset  (gf);.  
-0008d9e0: 2020 2020 2020 6767 6d6c 5f73 6574 5f66        ggml_set_f
-0008d9f0: 3332 2020 2020 2020 2866 2d3e 6772 6164  32      (f->grad
-0008da00: 2c20 312e 3066 293b 0a0a 2020 2020 2020  , 1.0f);..      
-0008da10: 2020 6767 6d6c 5f67 7261 7068 5f63 6f6d    ggml_graph_com
-0008da20: 7075 7465 5f77 6974 685f 6374 7828 6374  pute_with_ctx(ct
-0008da30: 782c 2067 622c 2070 6172 616d 732e 6e5f  x, gb, params.n_
-0008da40: 7468 7265 6164 7329 3b0a 0a20 2020 2020  threads);..     
-0008da50: 2020 2063 6f6e 7374 2066 6c6f 6174 2066     const float f
-0008da60: 7820 3d20 6767 6d6c 5f67 6574 5f66 3332  x = ggml_get_f32
-0008da70: 5f31 6428 662c 2030 293b 0a0a 2020 2020  _1d(f, 0);..    
-0008da80: 2020 2020 2f2f 2063 6865 636b 2063 6f6e      // check con
-0008da90: 7665 7267 656e 6365 0a20 2020 2020 2020  vergence.       
-0008daa0: 2069 6620 2866 6162 7366 2866 7820 2d20   if (fabsf(fx - 
-0008dab0: 6678 5f70 7265 765b 305d 292f 6678 203c  fx_prev[0])/fx <
-0008dac0: 2070 6172 616d 732e 6164 616d 2e65 7073   params.adam.eps
-0008dad0: 5f66 2920 7b0a 2020 2020 2020 2020 2020  _f) {.          
-0008dae0: 2020 4747 4d4c 5f50 5249 4e54 5f44 4542    GGML_PRINT_DEB
-0008daf0: 5547 2822 636f 6e76 6572 6765 645c 6e22  UG("converged\n"
-0008db00: 293b 0a0a 2020 2020 2020 2020 2020 2020  );..            
-0008db10: 7265 7475 726e 2047 474d 4c5f 4f50 545f  return GGML_OPT_
-0008db20: 4f4b 3b0a 2020 2020 2020 2020 7d0a 0a20  OK;.        }.. 
-0008db30: 2020 2020 2020 202f 2f20 6465 6c74 612d         // delta-
-0008db40: 6261 7365 6420 636f 6e76 6572 6765 6e63  based convergenc
-0008db50: 6520 7465 7374 0a20 2020 2020 2020 2069  e test.        i
-0008db60: 6620 2870 6620 213d 204e 554c 4c29 207b  f (pf != NULL) {
-0008db70: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
-0008db80: 6e65 6564 2061 7420 6c65 6173 7420 7061  need at least pa
-0008db90: 7261 6d73 2e70 6173 7420 6974 6572 6174  rams.past iterat
-0008dba0: 696f 6e73 2074 6f20 7374 6172 7420 6368  ions to start ch
-0008dbb0: 6563 6b69 6e67 2066 6f72 2063 6f6e 7665  ecking for conve
-0008dbc0: 7267 656e 6365 0a20 2020 2020 2020 2020  rgence.         
-0008dbd0: 2020 2069 6620 2870 6172 616d 732e 7061     if (params.pa
-0008dbe0: 7374 203c 3d20 6974 6572 3020 2b20 7429  st <= iter0 + t)
-0008dbf0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008dc00: 2020 2063 6f6e 7374 2066 6c6f 6174 2072     const float r
-0008dc10: 6174 6520 3d20 2870 665b 2869 7465 7230  ate = (pf[(iter0
-0008dc20: 202b 2074 2925 7061 7261 6d73 2e70 6173   + t)%params.pas
-0008dc30: 745d 202d 2066 7829 2f66 783b 0a0a 2020  t] - fx)/fx;..  
-0008dc40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0008dc50: 2028 6661 6273 6628 7261 7465 2920 3c20   (fabsf(rate) < 
-0008dc60: 7061 7261 6d73 2e64 656c 7461 2920 7b0a  params.delta) {.
-0008dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008dc80: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
-0008dc90: 4f50 545f 4f4b 3b0a 2020 2020 2020 2020  OPT_OK;.        
-0008dca0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0008dcb0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-0008dcc0: 2020 2020 2070 665b 2869 7465 7230 202b       pf[(iter0 +
-0008dcd0: 2074 2925 7061 7261 6d73 2e70 6173 745d   t)%params.past]
-0008dce0: 203d 2066 783b 0a20 2020 2020 2020 207d   = fx;.        }
-0008dcf0: 0a0a 2020 2020 2020 2020 2f2f 2063 6865  ..        // che
-0008dd00: 636b 2066 6f72 2069 6d70 726f 7665 6d65  ck for improveme
-0008dd10: 6e74 0a20 2020 2020 2020 2069 6620 2870  nt.        if (p
-0008dd20: 6172 616d 732e 6d61 785f 6e6f 5f69 6d70  arams.max_no_imp
-0008dd30: 726f 7665 6d65 6e74 203e 2030 2920 7b0a  rovement > 0) {.
-0008dd40: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0008dd50: 6678 5f62 6573 745b 305d 203e 2066 7829  fx_best[0] > fx)
-0008dd60: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008dd70: 2020 2066 785f 6265 7374 5b30 5d20 3d20     fx_best[0] = 
-0008dd80: 6678 3b0a 2020 2020 2020 2020 2020 2020  fx;.            
-0008dd90: 2020 2020 6e5f 6e6f 5f69 6d70 726f 7665      n_no_improve
-0008dda0: 6d65 6e74 5b30 5d20 3d20 303b 0a20 2020  ment[0] = 0;.   
-0008ddb0: 2020 2020 2020 2020 207d 2065 6c73 6520           } else 
-0008ddc0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0008ddd0: 2020 2b2b 6e5f 6e6f 5f69 6d70 726f 7665    ++n_no_improve
-0008dde0: 6d65 6e74 5b30 5d3b 0a0a 2020 2020 2020  ment[0];..      
-0008ddf0: 2020 2020 2020 2020 2020 6966 2028 6e5f            if (n_
-0008de00: 6e6f 5f69 6d70 726f 7665 6d65 6e74 5b30  no_improvement[0
-0008de10: 5d20 3e3d 2070 6172 616d 732e 6d61 785f  ] >= params.max_
-0008de20: 6e6f 5f69 6d70 726f 7665 6d65 6e74 2920  no_improvement) 
-0008de30: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0008de40: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
-0008de50: 4c5f 4f50 545f 4f4b 3b0a 2020 2020 2020  L_OPT_OK;.      
-0008de60: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0008de70: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-0008de80: 2020 7d0a 0a20 2020 2020 2020 2066 785f    }..        fx_
-0008de90: 7072 6576 5b30 5d20 3d20 6678 3b0a 0a20  prev[0] = fx;.. 
-0008dea0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0008deb0: 2020 2020 2063 6f6e 7374 2069 6e74 3634       const int64
-0008dec0: 5f74 2074 5f65 6e64 5f63 7075 203d 2067  _t t_end_cpu = g
-0008ded0: 676d 6c5f 6379 636c 6573 2829 3b0a 2020  gml_cycles();.  
-0008dee0: 2020 2020 2020 2020 2020 4747 4d4c 5f50            GGML_P
-0008def0: 5249 4e54 5f44 4542 5547 2822 7469 6d65  RINT_DEBUG("time
-0008df00: 2069 7465 723a 2020 2020 2020 2535 2e33   iter:      %5.3
-0008df10: 6620 735c 6e22 2c20 2828 666c 6f61 7429  f s\n", ((float)
-0008df20: 2874 5f65 6e64 5f63 7075 202d 2074 5f73  (t_end_cpu - t_s
-0008df30: 7461 7274 5f63 7075 2929 2f43 4c4f 434b  tart_cpu))/CLOCK
-0008df40: 535f 5045 525f 5345 4329 3b0a 2020 2020  S_PER_SEC);.    
-0008df50: 2020 2020 2020 2020 554e 5553 4544 2874          UNUSED(t
-0008df60: 5f65 6e64 5f63 7075 293b 0a0a 2020 2020  _end_cpu);..    
-0008df70: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0008df80: 7436 345f 7420 745f 656e 645f 7761 6c6c  t64_t t_end_wall
-0008df90: 203d 2067 676d 6c5f 7469 6d65 5f75 7328   = ggml_time_us(
-0008dfa0: 293b 0a20 2020 2020 2020 2020 2020 2047  );.            G
-0008dfb0: 474d 4c5f 5052 494e 545f 4445 4255 4728  GML_PRINT_DEBUG(
-0008dfc0: 2277 616c 6c20 7469 6d65 2069 7465 723a  "wall time iter:
-0008dfd0: 2025 352e 3366 2073 5c6e 222c 2028 745f   %5.3f s\n", (t_
-0008dfe0: 656e 645f 7761 6c6c 202d 2074 5f73 7461  end_wall - t_sta
-0008dff0: 7274 5f77 616c 6c29 2f31 6536 293b 0a20  rt_wall)/1e6);. 
-0008e000: 2020 2020 2020 2020 2020 2055 4e55 5345             UNUSE
-0008e010: 4428 745f 656e 645f 7761 6c6c 293b 0a20  D(t_end_wall);. 
-0008e020: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
-0008e030: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
-0008e040: 4f50 545f 4449 445f 4e4f 545f 434f 4e56  OPT_DID_NOT_CONV
-0008e050: 4552 4745 3b0a 7d0a 0a2f 2f0a 2f2f 204c  ERGE;.}..//.// L
-0008e060: 2d42 4647 530a 2f2f 0a2f 2f20 7468 6520  -BFGS.//.// the 
-0008e070: 4c2d 4246 4753 2069 6d70 6c65 6d65 6e74  L-BFGS implement
-0008e080: 6174 696f 6e20 6265 6c6f 7720 6973 2062  ation below is b
-0008e090: 6173 6564 206f 6e20 7468 6520 666f 6c6c  ased on the foll
-0008e0a0: 6f77 696e 6720 696d 706c 656d 656e 7461  owing implementa
-0008e0b0: 7469 6f6e 3a0a 2f2f 0a2f 2f20 2020 6874  tion:.//.//   ht
-0008e0c0: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
-0008e0d0: 2f63 686f 6b6b 616e 2f6c 6962 6c62 6667  /chokkan/liblbfg
-0008e0e0: 730a 2f2f 0a0a 7374 7275 6374 2067 676d  s.//..struct ggm
-0008e0f0: 6c5f 6c62 6667 735f 6974 6572 6174 696f  l_lbfgs_iteratio
-0008e100: 6e5f 6461 7461 207b 0a20 2020 2066 6c6f  n_data {.    flo
-0008e110: 6174 2061 6c70 6861 3b0a 2020 2020 666c  at alpha;.    fl
-0008e120: 6f61 7420 7973 3b0a 2020 2020 666c 6f61  oat ys;.    floa
-0008e130: 7420 2a20 733b 0a20 2020 2066 6c6f 6174  t * s;.    float
-0008e140: 202a 2079 3b0a 7d3b 0a0a 7374 6174 6963   * y;.};..static
-0008e150: 2065 6e75 6d20 6767 6d6c 5f6f 7074 5f72   enum ggml_opt_r
-0008e160: 6573 756c 7420 6c69 6e65 7365 6172 6368  esult linesearch
-0008e170: 5f62 6163 6b74 7261 636b 696e 6728 0a20  _backtracking(. 
-0008e180: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0008e190: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-0008e1a0: 2c0a 2020 2020 2020 2020 636f 6e73 7420  ,.        const 
-0008e1b0: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
-0008e1c0: 7061 7261 6d73 202a 2070 6172 616d 732c  params * params,
-0008e1d0: 0a20 2020 2020 2020 2069 6e74 206e 782c  .        int nx,
-0008e1e0: 0a20 2020 2020 2020 2066 6c6f 6174 202a  .        float *
-0008e1f0: 2078 2c0a 2020 2020 2020 2020 666c 6f61   x,.        floa
-0008e200: 7420 2a20 6678 2c0a 2020 2020 2020 2020  t * fx,.        
-0008e210: 666c 6f61 7420 2a20 672c 0a20 2020 2020  float * g,.     
-0008e220: 2020 2066 6c6f 6174 202a 2064 2c0a 2020     float * d,.  
-0008e230: 2020 2020 2020 666c 6f61 7420 2a20 7374        float * st
-0008e240: 6570 2c0a 2020 2020 2020 2020 636f 6e73  ep,.        cons
-0008e250: 7420 666c 6f61 7420 2a20 7870 2c0a 2020  t float * xp,.  
-0008e260: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008e270: 6c5f 7465 6e73 6f72 202a 2066 2c0a 2020  l_tensor * f,.  
-0008e280: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
-0008e290: 6c5f 6367 7261 7068 202a 2067 662c 0a20  l_cgraph * gf,. 
-0008e2a0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-0008e2b0: 6d6c 5f63 6772 6170 6820 2a20 6762 2c0a  ml_cgraph * gb,.
-0008e2c0: 2020 2020 2020 2020 636f 6e73 7420 696e          const in
-0008e2d0: 7420 6e70 2c0a 2020 2020 2020 2020 7374  t np,.        st
-0008e2e0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
-0008e2f0: 202a 2070 735b 5d29 207b 0a20 2020 2069   * ps[]) {.    i
-0008e300: 6e74 2063 6f75 6e74 203d 2030 3b0a 0a20  nt count = 0;.. 
-0008e310: 2020 2066 6c6f 6174 2077 6964 7468 2020     float width  
-0008e320: 3d20 302e 3066 3b0a 2020 2020 666c 6f61  = 0.0f;.    floa
-0008e330: 7420 6467 2020 2020 203d 2030 2e30 663b  t dg     = 0.0f;
-0008e340: 0a20 2020 2066 6c6f 6174 2066 696e 6974  .    float finit
-0008e350: 2020 3d20 302e 3066 3b0a 2020 2020 666c    = 0.0f;.    fl
-0008e360: 6f61 7420 6467 696e 6974 203d 2030 2e30  oat dginit = 0.0
-0008e370: 663b 0a20 2020 2066 6c6f 6174 2064 6774  f;.    float dgt
-0008e380: 6573 7420 3d20 302e 3066 3b0a 0a20 2020  est = 0.0f;..   
-0008e390: 2063 6f6e 7374 2066 6c6f 6174 2064 6563   const float dec
-0008e3a0: 203d 2030 2e35 663b 0a20 2020 2063 6f6e   = 0.5f;.    con
-0008e3b0: 7374 2066 6c6f 6174 2069 6e63 203d 2032  st float inc = 2
-0008e3c0: 2e31 663b 0a0a 2020 2020 6966 2028 2a73  .1f;..    if (*s
-0008e3d0: 7465 7020 3c3d 2030 2e66 2920 7b0a 2020  tep <= 0.f) {.  
-0008e3e0: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
-0008e3f0: 4c5f 4c49 4e45 5345 4152 4348 5f49 4e56  L_LINESEARCH_INV
-0008e400: 414c 4944 5f50 4152 414d 4554 4552 533b  ALID_PARAMETERS;
-0008e410: 0a20 2020 207d 0a0a 2020 2020 2f2f 2063  .    }..    // c
-0008e420: 6f6d 7075 7465 2074 6865 2069 6e69 7469  ompute the initi
-0008e430: 616c 2067 7261 6469 656e 7420 696e 2074  al gradient in t
-0008e440: 6865 2073 6561 7263 6820 6469 7265 6374  he search direct
-0008e450: 696f 6e0a 2020 2020 6767 6d6c 5f76 6563  ion.    ggml_vec
-0008e460: 5f64 6f74 5f66 3332 286e 782c 2026 6467  _dot_f32(nx, &dg
-0008e470: 696e 6974 2c20 672c 2064 293b 0a0a 2020  init, g, d);..  
-0008e480: 2020 2f2f 206d 616b 6520 7375 7265 2074    // make sure t
-0008e490: 6861 7420 6420 706f 696e 7473 2074 6f20  hat d points to 
-0008e4a0: 6120 6465 7363 656e 7420 6469 7265 6374  a descent direct
-0008e4b0: 696f 6e0a 2020 2020 6966 2028 3020 3c20  ion.    if (0 < 
-0008e4c0: 6467 696e 6974 2920 7b0a 2020 2020 2020  dginit) {.      
-0008e4d0: 2020 7265 7475 726e 2047 474d 4c5f 4c49    return GGML_LI
-0008e4e0: 4e45 5345 4152 4348 5f46 4149 4c3b 0a20  NESEARCH_FAIL;. 
-0008e4f0: 2020 207d 0a0a 2020 2020 2f2f 2069 6e69     }..    // ini
-0008e500: 7469 616c 697a 6520 6c6f 6361 6c20 7661  tialize local va
-0008e510: 7269 6162 6c65 730a 2020 2020 6669 6e69  riables.    fini
-0008e520: 7420 3d20 2a66 783b 0a20 2020 2064 6774  t = *fx;.    dgt
-0008e530: 6573 7420 3d20 7061 7261 6d73 2d3e 6c62  est = params->lb
-0008e540: 6667 732e 6674 6f6c 2a64 6769 6e69 743b  fgs.ftol*dginit;
-0008e550: 0a0a 2020 2020 7768 696c 6520 2874 7275  ..    while (tru
-0008e560: 6529 207b 0a20 2020 2020 2020 2067 676d  e) {.        ggm
-0008e570: 6c5f 7665 635f 6370 795f 6633 3228 6e78  l_vec_cpy_f32(nx
-0008e580: 2c20 782c 2078 7029 3b0a 2020 2020 2020  , x, xp);.      
-0008e590: 2020 6767 6d6c 5f76 6563 5f6d 6164 5f66    ggml_vec_mad_f
-0008e5a0: 3332 286e 782c 2078 2c20 642c 202a 7374  32(nx, x, d, *st
-0008e5b0: 6570 293b 0a0a 2020 2020 2020 2020 2f2f  ep);..        //
-0008e5c0: 2065 7661 6c75 6174 6520 7468 6520 6675   evaluate the fu
-0008e5d0: 6e63 7469 6f6e 2061 6e64 2067 7261 6469  nction and gradi
-0008e5e0: 656e 7420 7661 6c75 6573 0a20 2020 2020  ent values.     
-0008e5f0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0008e600: 2067 676d 6c5f 6f70 745f 7365 745f 7061   ggml_opt_set_pa
-0008e610: 7261 6d73 286e 702c 2070 732c 2078 293b  rams(np, ps, x);
-0008e620: 0a0a 2020 2020 2020 2020 2020 2020 6767  ..            gg
-0008e630: 6d6c 5f67 7261 7068 5f72 6573 6574 2020  ml_graph_reset  
-0008e640: 2867 6629 3b0a 2020 2020 2020 2020 2020  (gf);.          
-0008e650: 2020 6767 6d6c 5f73 6574 5f66 3332 2020    ggml_set_f32  
-0008e660: 2020 2020 2866 2d3e 6772 6164 2c20 312e      (f->grad, 1.
-0008e670: 3066 293b 0a0a 2020 2020 2020 2020 2020  0f);..          
-0008e680: 2020 6767 6d6c 5f67 7261 7068 5f63 6f6d    ggml_graph_com
-0008e690: 7075 7465 5f77 6974 685f 6374 7828 6374  pute_with_ctx(ct
-0008e6a0: 782c 2067 622c 2070 6172 616d 732d 3e6e  x, gb, params->n
-0008e6b0: 5f74 6872 6561 6473 293b 0a0a 2020 2020  _threads);..    
-0008e6c0: 2020 2020 2020 2020 6767 6d6c 5f6f 7074          ggml_opt
-0008e6d0: 5f67 6574 5f67 7261 6428 6e70 2c20 7073  _get_grad(np, ps
-0008e6e0: 2c20 6729 3b0a 0a20 2020 2020 2020 2020  , g);..         
-0008e6f0: 2020 202a 6678 203d 2067 676d 6c5f 6765     *fx = ggml_ge
-0008e700: 745f 6633 325f 3164 2866 2c20 3029 3b0a  t_f32_1d(f, 0);.
-0008e710: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0008e720: 2020 202b 2b63 6f75 6e74 3b0a 0a20 2020     ++count;..   
-0008e730: 2020 2020 2069 6620 282a 6678 203e 2066       if (*fx > f
-0008e740: 696e 6974 202b 2028 2a73 7465 7029 2a64  init + (*step)*d
-0008e750: 6774 6573 7429 207b 0a20 2020 2020 2020  gtest) {.       
-0008e760: 2020 2020 2077 6964 7468 203d 2064 6563       width = dec
-0008e770: 3b0a 2020 2020 2020 2020 7d20 656c 7365  ;.        } else
-0008e780: 207b 0a20 2020 2020 2020 2020 2020 202f   {.            /
-0008e790: 2f20 4172 6d69 6a6f 2063 6f6e 6469 7469  / Armijo conditi
-0008e7a0: 6f6e 2069 7320 7361 7469 7366 6965 640a  on is satisfied.
-0008e7b0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0008e7c0: 7061 7261 6d73 2d3e 6c62 6667 732e 6c69  params->lbfgs.li
-0008e7d0: 6e65 7365 6172 6368 203d 3d20 4747 4d4c  nesearch == GGML
-0008e7e0: 5f4c 494e 4553 4541 5243 485f 4241 434b  _LINESEARCH_BACK
-0008e7f0: 5452 4143 4b49 4e47 5f41 524d 494a 4f29  TRACKING_ARMIJO)
-0008e800: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008e810: 2020 2072 6574 7572 6e20 636f 756e 743b     return count;
-0008e820: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-0008e830: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-0008e840: 5f76 6563 5f64 6f74 5f66 3332 286e 782c  _vec_dot_f32(nx,
-0008e850: 2026 6467 2c20 672c 2064 293b 0a0a 2020   &dg, g, d);..  
-0008e860: 2020 2020 2020 2020 2020 2f2f 2063 6865            // che
-0008e870: 636b 2074 6865 2057 6f6c 6665 2063 6f6e  ck the Wolfe con
-0008e880: 6469 7469 6f6e 0a20 2020 2020 2020 2020  dition.         
-0008e890: 2020 2069 6620 2864 6720 3c20 7061 7261     if (dg < para
-0008e8a0: 6d73 2d3e 6c62 6667 732e 776f 6c66 6520  ms->lbfgs.wolfe 
-0008e8b0: 2a20 6467 696e 6974 2920 7b0a 2020 2020  * dginit) {.    
-0008e8c0: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-0008e8d0: 6820 3d20 696e 633b 0a20 2020 2020 2020  h = inc;.       
-0008e8e0: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
-0008e8f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0008e900: 2870 6172 616d 732d 3e6c 6266 6773 2e6c  (params->lbfgs.l
-0008e910: 696e 6573 6561 7263 6820 3d3d 2047 474d  inesearch == GGM
-0008e920: 4c5f 4c49 4e45 5345 4152 4348 5f42 4143  L_LINESEARCH_BAC
-0008e930: 4b54 5241 434b 494e 475f 574f 4c46 4529  KTRACKING_WOLFE)
-0008e940: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0008e950: 2020 2020 2020 202f 2f20 7265 6775 6c61         // regula
-0008e960: 7220 576f 6c66 6520 636f 6e64 6974 696f  r Wolfe conditio
-0008e970: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
-0008e980: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
-0008e990: 756e 743b 0a20 2020 2020 2020 2020 2020  unt;.           
-0008e9a0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008e9b0: 2020 2020 2020 2020 6966 2864 6720 3e20          if(dg > 
-0008e9c0: 2d70 6172 616d 732d 3e6c 6266 6773 2e77  -params->lbfgs.w
-0008e9d0: 6f6c 6665 2a64 6769 6e69 7429 207b 0a20  olfe*dginit) {. 
-0008e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008e9f0: 2020 2077 6964 7468 203d 2064 6563 3b0a     width = dec;.
-0008ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008ea10: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
-0008ea20: 2020 2020 2020 2020 2020 2020 202f 2f20               // 
-0008ea30: 7374 726f 6e67 2057 6f6c 6665 2063 6f6e  strong Wolfe con
-0008ea40: 6469 7469 6f6e 2028 4747 4d4c 5f4c 494e  dition (GGML_LIN
-0008ea50: 4553 4541 5243 485f 4241 434b 5452 4143  ESEARCH_BACKTRAC
-0008ea60: 4b49 4e47 5f53 5452 4f4e 475f 574f 4c46  KING_STRONG_WOLF
-0008ea70: 4529 0a20 2020 2020 2020 2020 2020 2020  E).             
-0008ea80: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
-0008ea90: 756e 743b 0a20 2020 2020 2020 2020 2020  unt;.           
-0008eaa0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0008eab0: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
-0008eac0: 756e 743b 0a20 2020 2020 2020 2020 2020  unt;.           
-0008ead0: 207d 0a20 2020 2020 2020 207d 0a0a 2020   }.        }..  
-0008eae0: 2020 2020 2020 6966 2028 2a73 7465 7020        if (*step 
-0008eaf0: 3c20 7061 7261 6d73 2d3e 6c62 6667 732e  < params->lbfgs.
-0008eb00: 6d69 6e5f 7374 6570 2920 7b0a 2020 2020  min_step) {.    
-0008eb10: 2020 2020 2020 2020 7265 7475 726e 2047          return G
-0008eb20: 474d 4c5f 4c49 4e45 5345 4152 4348 5f4d  GML_LINESEARCH_M
-0008eb30: 494e 494d 554d 5f53 5445 503b 0a20 2020  INIMUM_STEP;.   
-0008eb40: 2020 2020 207d 0a20 2020 2020 2020 2069       }.        i
-0008eb50: 6620 282a 7374 6570 203e 2070 6172 616d  f (*step > param
-0008eb60: 732d 3e6c 6266 6773 2e6d 6178 5f73 7465  s->lbfgs.max_ste
-0008eb70: 7029 207b 0a20 2020 2020 2020 2020 2020  p) {.           
-0008eb80: 2072 6574 7572 6e20 4747 4d4c 5f4c 494e   return GGML_LIN
-0008eb90: 4553 4541 5243 485f 4d41 5849 4d55 4d5f  ESEARCH_MAXIMUM_
-0008eba0: 5354 4550 3b0a 2020 2020 2020 2020 7d0a  STEP;.        }.
-0008ebb0: 2020 2020 2020 2020 6966 2028 7061 7261          if (para
-0008ebc0: 6d73 2d3e 6c62 6667 732e 6d61 785f 6c69  ms->lbfgs.max_li
-0008ebd0: 6e65 7365 6172 6368 203c 3d20 636f 756e  nesearch <= coun
-0008ebe0: 7429 207b 0a20 2020 2020 2020 2020 2020  t) {.           
-0008ebf0: 2072 6574 7572 6e20 4747 4d4c 5f4c 494e   return GGML_LIN
-0008ec00: 4553 4541 5243 485f 4d41 5849 4d55 4d5f  ESEARCH_MAXIMUM_
-0008ec10: 4954 4552 4154 494f 4e53 3b0a 2020 2020  ITERATIONS;.    
-0008ec20: 2020 2020 7d0a 0a20 2020 2020 2020 2028      }..        (
-0008ec30: 2a73 7465 7029 202a 3d20 7769 6474 683b  *step) *= width;
-0008ec40: 0a20 2020 207d 0a0a 2020 2020 7265 7475  .    }..    retu
-0008ec50: 726e 2047 474d 4c5f 4c49 4e45 5345 4152  rn GGML_LINESEAR
-0008ec60: 4348 5f46 4149 4c3b 0a7d 0a0a 7374 6174  CH_FAIL;.}..stat
-0008ec70: 6963 2065 6e75 6d20 6767 6d6c 5f6f 7074  ic enum ggml_opt
-0008ec80: 5f72 6573 756c 7420 6767 6d6c 5f6f 7074  _result ggml_opt
-0008ec90: 5f6c 6266 6773 280a 2020 2020 2020 2020  _lbfgs(.        
-0008eca0: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-0008ecb0: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-0008ecc0: 2020 2073 7472 7563 7420 6767 6d6c 5f6f     struct ggml_o
-0008ecd0: 7074 5f63 6f6e 7465 7874 202a 206f 7074  pt_context * opt
-0008ece0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-0008ecf0: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
-0008ed00: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-0008ed10: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-0008ed20: 736f 7220 2a20 662c 0a20 2020 2020 2020  sor * f,.       
-0008ed30: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
-0008ed40: 6170 6820 2a20 6766 2c0a 2020 2020 2020  aph * gf,.      
-0008ed50: 2020 7374 7275 6374 2067 676d 6c5f 6367    struct ggml_cg
-0008ed60: 7261 7068 202a 2067 6229 207b 0a20 2020  raph * gb) {.   
-0008ed70: 2069 6620 2870 6172 616d 732e 6c62 6667   if (params.lbfg
-0008ed80: 732e 6c69 6e65 7365 6172 6368 203d 3d20  s.linesearch == 
-0008ed90: 4747 4d4c 5f4c 494e 4553 4541 5243 485f  GGML_LINESEARCH_
-0008eda0: 4241 434b 5452 4143 4b49 4e47 5f57 4f4c  BACKTRACKING_WOL
-0008edb0: 4645 207c 7c0a 2020 2020 2020 2020 7061  FE ||.        pa
-0008edc0: 7261 6d73 2e6c 6266 6773 2e6c 696e 6573  rams.lbfgs.lines
-0008edd0: 6561 7263 6820 3d3d 2047 474d 4c5f 4c49  earch == GGML_LI
-0008ede0: 4e45 5345 4152 4348 5f42 4143 4b54 5241  NESEARCH_BACKTRA
-0008edf0: 434b 494e 475f 5354 524f 4e47 5f57 4f4c  CKING_STRONG_WOL
-0008ee00: 4645 2920 7b0a 2020 2020 2020 2020 6966  FE) {.        if
-0008ee10: 2028 7061 7261 6d73 2e6c 6266 6773 2e77   (params.lbfgs.w
-0008ee20: 6f6c 6665 203c 3d20 7061 7261 6d73 2e6c  olfe <= params.l
-0008ee30: 6266 6773 2e66 746f 6c20 7c7c 2031 2e66  bfgs.ftol || 1.f
-0008ee40: 203c 3d20 7061 7261 6d73 2e6c 6266 6773   <= params.lbfgs
-0008ee50: 2e77 6f6c 6665 2920 7b0a 2020 2020 2020  .wolfe) {.      
-0008ee60: 2020 2020 2020 7265 7475 726e 2047 474d        return GGM
-0008ee70: 4c5f 4f50 545f 494e 5641 4c49 445f 574f  L_OPT_INVALID_WO
-0008ee80: 4c46 453b 0a20 2020 2020 2020 207d 0a20  LFE;.        }. 
-0008ee90: 2020 207d 0a0a 2020 2020 636f 6e73 7420     }..    const 
-0008eea0: 696e 7420 6d20 3d20 7061 7261 6d73 2e6c  int m = params.l
-0008eeb0: 6266 6773 2e6d 3b0a 0a20 2020 202f 2f20  bfgs.m;..    // 
-0008eec0: 7468 6573 6520 7769 6c6c 2073 746f 7265  these will store
-0008eed0: 2074 6865 2070 6172 616d 6574 6572 7320   the parameters 
-0008eee0: 7765 2077 616e 7420 746f 206f 7074 696d  we want to optim
-0008eef0: 697a 650a 2020 2020 7374 7275 6374 2067  ize.    struct g
-0008ef00: 676d 6c5f 7465 6e73 6f72 202a 2070 735b  gml_tensor * ps[
-0008ef10: 4747 4d4c 5f4d 4158 5f50 4152 414d 535d  GGML_MAX_PARAMS]
-0008ef20: 3b0a 0a20 2020 2069 6e74 206e 7020 3d20  ;..    int np = 
-0008ef30: 303b 0a20 2020 2069 6e74 206e 7820 3d20  0;.    int nx = 
-0008ef40: 303b 0a20 2020 2066 6f72 2028 696e 7420  0;.    for (int 
-0008ef50: 6920 3d20 303b 2069 203c 2067 662d 3e6e  i = 0; i < gf->n
-0008ef60: 5f6e 6f64 6573 3b20 2b2b 6929 207b 0a20  _nodes; ++i) {. 
-0008ef70: 2020 2020 2020 2069 6620 2867 662d 3e6e         if (gf->n
-0008ef80: 6f64 6573 5b69 5d2d 3e69 735f 7061 7261  odes[i]->is_para
-0008ef90: 6d29 207b 0a20 2020 2020 2020 2020 2020  m) {.           
-0008efa0: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
-0008efb0: 4728 2266 6f75 6e64 2070 6172 616d 2025  G("found param %
-0008efc0: 643a 2067 7261 642d 3e6f 7020 3d20 2564  d: grad->op = %d
-0008efd0: 5c6e 222c 206e 702c 2067 662d 3e6e 6f64  \n", np, gf->nod
-0008efe0: 6573 5b69 5d2d 3e67 7261 642d 3e6f 7029  es[i]->grad->op)
-0008eff0: 3b0a 0a20 2020 2020 2020 2020 2020 2047  ;..            G
-0008f000: 474d 4c5f 4153 5345 5254 286e 7020 3c20  GML_ASSERT(np < 
-0008f010: 4747 4d4c 5f4d 4158 5f50 4152 414d 5329  GGML_MAX_PARAMS)
-0008f020: 3b0a 0a20 2020 2020 2020 2020 2020 2070  ;..            p
-0008f030: 735b 6e70 2b2b 5d20 3d20 6766 2d3e 6e6f  s[np++] = gf->no
-0008f040: 6465 735b 695d 3b0a 2020 2020 2020 2020  des[i];.        
-0008f050: 2020 2020 6e78 202b 3d20 6767 6d6c 5f6e      nx += ggml_n
-0008f060: 656c 656d 656e 7473 2867 662d 3e6e 6f64  elements(gf->nod
-0008f070: 6573 5b69 5d29 3b0a 2020 2020 2020 2020  es[i]);.        
-0008f080: 7d0a 2020 2020 7d0a 0a20 2020 2069 6620  }.    }..    if 
-0008f090: 2828 6f70 742d 3e70 6172 616d 732e 7479  ((opt->params.ty
-0008f0a0: 7065 2021 3d20 7061 7261 6d73 2e74 7970  pe != params.typ
-0008f0b0: 6529 207c 7c20 286f 7074 2d3e 6e78 2021  e) || (opt->nx !
-0008f0c0: 3d20 6e78 2920 7c7c 2028 6f70 742d 3e70  = nx) || (opt->p
-0008f0d0: 6172 616d 732e 7061 7374 2021 3d20 7061  arams.past != pa
-0008f0e0: 7261 6d73 2e70 6173 7429 207c 7c20 286f  rams.past) || (o
-0008f0f0: 7074 2d3e 7061 7261 6d73 2e6c 6266 6773  pt->params.lbfgs
-0008f100: 2e6d 2021 3d20 7061 7261 6d73 2e6c 6266  .m != params.lbf
-0008f110: 6773 2e6d 2929 207b 0a20 2020 2020 2020  gs.m)) {.       
-0008f120: 2069 6e74 2069 7465 7220 3d20 6f70 742d   int iter = opt-
-0008f130: 3e69 7465 723b 0a20 2020 2020 2020 2067  >iter;.        g
-0008f140: 676d 6c5f 6f70 745f 696e 6974 2863 7478  gml_opt_init(ctx
-0008f150: 2c20 6f70 742c 2070 6172 616d 732c 206e  , opt, params, n
-0008f160: 7829 3b0a 2020 2020 2020 2020 6f70 742d  x);.        opt-
-0008f170: 3e69 7465 7220 3d20 6974 6572 3b0a 2020  >iter = iter;.  
-0008f180: 2020 7d0a 0a20 2020 2066 6c6f 6174 202a    }..    float *
-0008f190: 2078 2020 3d20 6f70 742d 3e6c 6266 6773   x  = opt->lbfgs
-0008f1a0: 2e78 2d3e 6461 7461 3b20 202f 2f20 6375  .x->data;  // cu
-0008f1b0: 7272 656e 7420 7061 7261 6d65 7465 7273  rrent parameters
-0008f1c0: 0a20 2020 2066 6c6f 6174 202a 2078 7020  .    float * xp 
-0008f1d0: 3d20 6f70 742d 3e6c 6266 6773 2e78 702d  = opt->lbfgs.xp-
-0008f1e0: 3e64 6174 613b 202f 2f20 7072 6576 696f  >data; // previo
-0008f1f0: 7573 2070 6172 616d 6574 6572 730a 2020  us parameters.  
-0008f200: 2020 666c 6f61 7420 2a20 6720 203d 206f    float * g  = o
-0008f210: 7074 2d3e 6c62 6667 732e 672d 3e64 6174  pt->lbfgs.g->dat
-0008f220: 613b 2020 2f2f 2063 7572 7265 6e74 2067  a;  // current g
-0008f230: 7261 6469 656e 740a 2020 2020 666c 6f61  radient.    floa
-0008f240: 7420 2a20 6770 203d 206f 7074 2d3e 6c62  t * gp = opt->lb
-0008f250: 6667 732e 6770 2d3e 6461 7461 3b20 2f2f  fgs.gp->data; //
-0008f260: 2070 7265 7669 6f75 7320 6772 6164 6965   previous gradie
-0008f270: 6e74 0a20 2020 2066 6c6f 6174 202a 2064  nt.    float * d
-0008f280: 2020 3d20 6f70 742d 3e6c 6266 6773 2e64    = opt->lbfgs.d
-0008f290: 2d3e 6461 7461 3b20 202f 2f20 7365 6172  ->data;  // sear
-0008f2a0: 6368 2064 6972 6563 7469 6f6e 0a0a 2020  ch direction..  
-0008f2b0: 2020 666c 6f61 7420 2a20 7066 203d 2070    float * pf = p
-0008f2c0: 6172 616d 732e 7061 7374 203e 2030 203f  arams.past > 0 ?
-0008f2d0: 206f 7074 2d3e 6c62 6667 732e 7066 2d3e   opt->lbfgs.pf->
-0008f2e0: 6461 7461 203a 204e 554c 4c3b 202f 2f20  data : NULL; // 
-0008f2f0: 7061 7374 2066 756e 6374 696f 6e20 7661  past function va
-0008f300: 6c75 6573 0a0a 2020 2020 666c 6f61 7420  lues..    float 
-0008f310: 6678 2020 2020 3d20 302e 3066 3b20 2f2f  fx    = 0.0f; //
-0008f320: 2063 6f73 7420 6675 6e63 7469 6f6e 2076   cost function v
-0008f330: 616c 7565 0a20 2020 2066 6c6f 6174 2078  alue.    float x
-0008f340: 6e6f 726d 203d 2030 2e30 663b 202f 2f20  norm = 0.0f; // 
-0008f350: 7c7c 787c 7c0a 2020 2020 666c 6f61 7420  ||x||.    float 
-0008f360: 676e 6f72 6d20 3d20 302e 3066 3b20 2f2f  gnorm = 0.0f; //
-0008f370: 207c 7c67 7c7c 0a0a 2020 2020 2f2f 2069   ||g||..    // i
-0008f380: 6e69 7469 616c 697a 6520 7820 6672 6f6d  nitialize x from
-0008f390: 2074 6865 2067 7261 7068 206e 6f64 6573   the graph nodes
-0008f3a0: 0a20 2020 2067 676d 6c5f 6f70 745f 6765  .    ggml_opt_ge
-0008f3b0: 745f 7061 7261 6d73 286e 702c 2070 732c  t_params(np, ps,
-0008f3c0: 2078 293b 0a0a 2020 2020 2f2f 2074 6865   x);..    // the
-0008f3d0: 204c 2d42 4647 5320 6d65 6d6f 7279 0a20   L-BFGS memory. 
-0008f3e0: 2020 2066 6c6f 6174 202a 206c 6d5f 616c     float * lm_al
-0008f3f0: 7068 6120 3d20 6f70 742d 3e6c 6266 6773  pha = opt->lbfgs
-0008f400: 2e6c 6d61 6c2d 3e64 6174 613b 0a20 2020  .lmal->data;.   
-0008f410: 2066 6c6f 6174 202a 206c 6d5f 7973 2020   float * lm_ys  
-0008f420: 2020 3d20 6f70 742d 3e6c 6266 6773 2e6c    = opt->lbfgs.l
-0008f430: 6d79 732d 3e64 6174 613b 0a20 2020 2066  mys->data;.    f
-0008f440: 6c6f 6174 202a 206c 6d5f 7320 2020 2020  loat * lm_s     
-0008f450: 3d20 6f70 742d 3e6c 6266 6773 2e6c 6d73  = opt->lbfgs.lms
-0008f460: 2d3e 6461 7461 3b0a 2020 2020 666c 6f61  ->data;.    floa
-0008f470: 7420 2a20 6c6d 5f79 2020 2020 203d 206f  t * lm_y     = o
-0008f480: 7074 2d3e 6c62 6667 732e 6c6d 792d 3e64  pt->lbfgs.lmy->d
-0008f490: 6174 613b 0a0a 2020 2020 2f2f 2065 7661  ata;..    // eva
-0008f4a0: 6c75 6174 6520 7468 6520 6675 6e63 7469  luate the functi
-0008f4b0: 6f6e 2076 616c 7565 2061 6e64 2069 7473  on value and its
-0008f4c0: 2067 7261 6469 656e 740a 2020 2020 7b0a   gradient.    {.
-0008f4d0: 2020 2020 2020 2020 6767 6d6c 5f6f 7074          ggml_opt
-0008f4e0: 5f73 6574 5f70 6172 616d 7328 6e70 2c20  _set_params(np, 
-0008f4f0: 7073 2c20 7829 3b0a 0a20 2020 2020 2020  ps, x);..       
-0008f500: 2067 676d 6c5f 6772 6170 685f 7265 7365   ggml_graph_rese
-0008f510: 7420 2028 6766 293b 0a20 2020 2020 2020  t  (gf);.       
-0008f520: 2067 676d 6c5f 7365 745f 6633 3220 2020   ggml_set_f32   
-0008f530: 2020 2028 662d 3e67 7261 642c 2031 2e30     (f->grad, 1.0
-0008f540: 6629 3b0a 0a20 2020 2020 2020 2067 676d  f);..        ggm
-0008f550: 6c5f 6772 6170 685f 636f 6d70 7574 655f  l_graph_compute_
-0008f560: 7769 7468 5f63 7478 2863 7478 2c20 6762  with_ctx(ctx, gb
-0008f570: 2c20 7061 7261 6d73 2e6e 5f74 6872 6561  , params.n_threa
-0008f580: 6473 293b 0a0a 2020 2020 2020 2020 6767  ds);..        gg
-0008f590: 6d6c 5f6f 7074 5f67 6574 5f67 7261 6428  ml_opt_get_grad(
-0008f5a0: 6e70 2c20 7073 2c20 6729 3b0a 0a20 2020  np, ps, g);..   
-0008f5b0: 2020 2020 2066 7820 3d20 6767 6d6c 5f67       fx = ggml_g
-0008f5c0: 6574 5f66 3332 5f31 6428 662c 2030 293b  et_f32_1d(f, 0);
-0008f5d0: 0a20 2020 207d 0a0a 2020 2020 2f2f 2073  .    }..    // s
-0008f5e0: 6561 7263 6820 6469 7265 6374 696f 6e20  earch direction 
-0008f5f0: 3d20 2d67 7261 6469 656e 740a 2020 2020  = -gradient.    
-0008f600: 6767 6d6c 5f76 6563 5f6e 6567 5f66 3332  ggml_vec_neg_f32
-0008f610: 286e 782c 2064 2c20 6729 3b0a 0a20 2020  (nx, d, g);..   
-0008f620: 202f 2f20 7c7c 787c 7c2c 207c 7c67 7c7c   // ||x||, ||g||
-0008f630: 0a20 2020 2067 676d 6c5f 7665 635f 6e6f  .    ggml_vec_no
-0008f640: 726d 5f66 3332 286e 782c 2026 786e 6f72  rm_f32(nx, &xnor
-0008f650: 6d2c 2078 293b 0a20 2020 2067 676d 6c5f  m, x);.    ggml_
-0008f660: 7665 635f 6e6f 726d 5f66 3332 286e 782c  vec_norm_f32(nx,
-0008f670: 2026 676e 6f72 6d2c 2067 293b 0a0a 2020   &gnorm, g);..  
-0008f680: 2020 6966 2028 786e 6f72 6d20 3c20 312e    if (xnorm < 1.
-0008f690: 3066 2920 7b0a 2020 2020 2020 2020 786e  0f) {.        xn
-0008f6a0: 6f72 6d20 3d20 312e 3066 3b0a 2020 2020  orm = 1.0f;.    
-0008f6b0: 7d0a 0a20 2020 202f 2f20 616c 7265 6164  }..    // alread
-0008f6c0: 7920 6f70 7469 6d69 7a65 640a 2020 2020  y optimized.    
-0008f6d0: 6966 2028 676e 6f72 6d2f 786e 6f72 6d20  if (gnorm/xnorm 
-0008f6e0: 3c3d 2070 6172 616d 732e 6c62 6667 732e  <= params.lbfgs.
-0008f6f0: 6570 7329 207b 0a20 2020 2020 2020 2072  eps) {.        r
-0008f700: 6574 7572 6e20 4747 4d4c 5f4f 5054 5f4f  eturn GGML_OPT_O
-0008f710: 4b3b 0a20 2020 207d 0a0a 2020 2020 6966  K;.    }..    if
-0008f720: 2028 6f70 742d 3e6a 7573 745f 696e 6974   (opt->just_init
-0008f730: 6961 6c69 7a65 6429 207b 0a20 2020 2020  ialized) {.     
-0008f740: 2020 2069 6620 2870 6629 207b 0a20 2020     if (pf) {.   
-0008f750: 2020 2020 2020 2020 2070 665b 305d 203d           pf[0] =
-0008f760: 2066 783b 0a20 2020 2020 2020 207d 0a20   fx;.        }. 
-0008f770: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
-0008f780: 732e 6678 5f62 6573 7420 3d20 6678 3b0a  s.fx_best = fx;.
-0008f790: 0a20 2020 2020 2020 202f 2f20 696e 6974  .        // init
-0008f7a0: 6961 6c20 7374 6570 0a20 2020 2020 2020  ial step.       
-0008f7b0: 2067 676d 6c5f 7665 635f 6e6f 726d 5f69   ggml_vec_norm_i
-0008f7c0: 6e76 5f66 3332 286e 782c 2026 6f70 742d  nv_f32(nx, &opt-
-0008f7d0: 3e6c 6266 6773 2e73 7465 702c 2064 293b  >lbfgs.step, d);
-0008f7e0: 0a20 2020 2020 2020 206f 7074 2d3e 6c62  .        opt->lb
-0008f7f0: 6667 732e 6a20 2020 2020 2020 2020 2020  fgs.j           
-0008f800: 2020 2020 203d 2030 3b0a 2020 2020 2020       = 0;.      
-0008f810: 2020 6f70 742d 3e6c 6266 6773 2e6b 2020    opt->lbfgs.k  
-0008f820: 2020 2020 2020 2020 2020 2020 2020 3d20                = 
-0008f830: 313b 0a20 2020 2020 2020 206f 7074 2d3e  1;.        opt->
-0008f840: 6c62 6667 732e 656e 6420 2020 2020 2020  lbfgs.end       
-0008f850: 2020 2020 2020 203d 2030 3b0a 2020 2020         = 0;.    
-0008f860: 2020 2020 6f70 742d 3e6c 6266 6773 2e6e      opt->lbfgs.n
-0008f870: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
-0008f880: 3d20 303b 0a20 2020 2020 2020 206f 7074  = 0;.        opt
-0008f890: 2d3e 6a75 7374 5f69 6e69 7469 616c 697a  ->just_initializ
-0008f8a0: 6564 2020 2020 2020 203d 2066 616c 7365  ed       = false
-0008f8b0: 3b0a 2020 2020 7d0a 0a20 2020 2066 6c6f  ;.    }..    flo
-0008f8c0: 6174 202a 2066 785f 6265 7374 2020 2020  at * fx_best    
-0008f8d0: 2020 2020 3d20 266f 7074 2d3e 6c62 6667      = &opt->lbfg
-0008f8e0: 732e 6678 5f62 6573 743b 0a20 2020 2066  s.fx_best;.    f
-0008f8f0: 6c6f 6174 202a 2073 7465 7020 2020 2020  loat * step     
-0008f900: 2020 2020 2020 3d20 266f 7074 2d3e 6c62        = &opt->lb
-0008f910: 6667 732e 7374 6570 3b0a 2020 2020 696e  fgs.step;.    in
-0008f920: 7420 2a20 6a20 2020 2020 2020 2020 2020  t * j           
-0008f930: 2020 2020 203d 2026 6f70 742d 3e6c 6266       = &opt->lbf
-0008f940: 6773 2e6a 3b0a 2020 2020 696e 7420 2a20  gs.j;.    int * 
-0008f950: 6b20 2020 2020 2020 2020 2020 2020 2020  k               
-0008f960: 203d 2026 6f70 742d 3e6c 6266 6773 2e6b   = &opt->lbfgs.k
-0008f970: 3b0a 2020 2020 696e 7420 2a20 656e 6420  ;.    int * end 
-0008f980: 2020 2020 2020 2020 2020 2020 203d 2026               = &
-0008f990: 6f70 742d 3e6c 6266 6773 2e65 6e64 3b0a  opt->lbfgs.end;.
-0008f9a0: 2020 2020 696e 7420 2a20 6e5f 6e6f 5f69      int * n_no_i
-0008f9b0: 6d70 726f 7665 6d65 6e74 203d 2026 6f70  mprovement = &op
-0008f9c0: 742d 3e6c 6266 6773 2e6e 5f6e 6f5f 696d  t->lbfgs.n_no_im
-0008f9d0: 7072 6f76 656d 656e 743b 0a0a 2020 2020  provement;..    
-0008f9e0: 696e 7420 6c73 2020 2020 203d 2030 3b0a  int ls     = 0;.
-0008f9f0: 2020 2020 696e 7420 626f 756e 6420 203d      int bound  =
-0008fa00: 2030 3b0a 0a20 2020 2066 6c6f 6174 2079   0;..    float y
-0008fa10: 7320 2020 3d20 302e 3066 3b0a 2020 2020  s   = 0.0f;.    
-0008fa20: 666c 6f61 7420 7979 2020 203d 2030 2e30  float yy   = 0.0
-0008fa30: 663b 0a20 2020 2066 6c6f 6174 2062 6574  f;.    float bet
-0008fa40: 6120 3d20 302e 3066 3b0a 0a20 2020 2069  a = 0.0f;..    i
-0008fa50: 6e74 2069 7420 3d20 303b 0a0a 2020 2020  nt it = 0;..    
-0008fa60: 7768 696c 6520 2874 7275 6529 207b 0a20  while (true) {. 
-0008fa70: 2020 2020 2020 202f 2f20 7374 6f72 6520         // store 
-0008fa80: 7468 6520 6375 7272 656e 7420 706f 7369  the current posi
-0008fa90: 7469 6f6e 2061 6e64 2067 7261 6469 656e  tion and gradien
-0008faa0: 7420 7665 6374 6f72 730a 2020 2020 2020  t vectors.      
-0008fab0: 2020 6767 6d6c 5f76 6563 5f63 7079 5f66    ggml_vec_cpy_f
-0008fac0: 3332 286e 782c 2078 702c 2078 293b 0a20  32(nx, xp, x);. 
-0008fad0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0008fae0: 6370 795f 6633 3228 6e78 2c20 6770 2c20  cpy_f32(nx, gp, 
-0008faf0: 6729 3b0a 0a20 2020 2020 2020 206c 7320  g);..        ls 
-0008fb00: 3d20 6c69 6e65 7365 6172 6368 5f62 6163  = linesearch_bac
-0008fb10: 6b74 7261 636b 696e 6728 6374 782c 2026  ktracking(ctx, &
-0008fb20: 7061 7261 6d73 2c20 6e78 2c20 782c 2026  params, nx, x, &
-0008fb30: 6678 2c20 672c 2064 2c20 7374 6570 2c20  fx, g, d, step, 
-0008fb40: 7870 2c20 662c 2067 662c 2067 622c 206e  xp, f, gf, gb, n
-0008fb50: 702c 2070 7329 3b0a 0a20 2020 2020 2020  p, ps);..       
-0008fb60: 2069 6620 286c 7320 3c20 3029 207b 0a20   if (ls < 0) {. 
-0008fb70: 2020 2020 2020 2020 2020 202f 2f20 6c69             // li
-0008fb80: 6e65 7365 6172 6368 2066 6169 6c65 6420  nesearch failed 
-0008fb90: 2d20 676f 2062 6163 6b20 746f 2074 6865  - go back to the
-0008fba0: 2070 7265 7669 6f75 7320 706f 696e 7420   previous point 
-0008fbb0: 616e 6420 7265 7475 726e 0a20 2020 2020  and return.     
-0008fbc0: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
-0008fbd0: 6370 795f 6633 3228 6e78 2c20 782c 2078  cpy_f32(nx, x, x
-0008fbe0: 7029 3b0a 2020 2020 2020 2020 2020 2020  p);.            
-0008fbf0: 6767 6d6c 5f76 6563 5f63 7079 5f66 3332  ggml_vec_cpy_f32
-0008fc00: 286e 782c 2067 2c20 6770 293b 0a0a 2020  (nx, g, gp);..  
-0008fc10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0008fc20: 206c 733b 0a20 2020 2020 2020 207d 0a0a   ls;.        }..
-0008fc30: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
-0008fc40: 5f6e 6f72 6d5f 6633 3228 6e78 2c20 2678  _norm_f32(nx, &x
-0008fc50: 6e6f 726d 2c20 7829 3b0a 2020 2020 2020  norm, x);.      
-0008fc60: 2020 6767 6d6c 5f76 6563 5f6e 6f72 6d5f    ggml_vec_norm_
-0008fc70: 6633 3228 6e78 2c20 2667 6e6f 726d 2c20  f32(nx, &gnorm, 
-0008fc80: 6729 3b0a 0a20 2020 2020 2020 2047 474d  g);..        GGM
-0008fc90: 4c5f 5052 494e 545f 4445 4255 4728 2266  L_PRINT_DEBUG("f
-0008fca0: 203d 2025 3130 2e36 665c 6e22 2c20 6767   = %10.6f\n", gg
-0008fcb0: 6d6c 5f67 6574 5f66 3332 5f31 6428 662c  ml_get_f32_1d(f,
-0008fcc0: 2030 2929 3b0a 0a20 2020 2020 2020 2069   0));..        i
-0008fcd0: 6620 2878 6e6f 726d 203c 2031 2e30 6629  f (xnorm < 1.0f)
-0008fce0: 207b 0a20 2020 2020 2020 2020 2020 2078   {.            x
-0008fcf0: 6e6f 726d 203d 2031 2e30 663b 0a20 2020  norm = 1.0f;.   
-0008fd00: 2020 2020 207d 0a20 2020 2020 2020 2069       }.        i
-0008fd10: 6620 2867 6e6f 726d 2f78 6e6f 726d 203c  f (gnorm/xnorm <
-0008fd20: 3d20 7061 7261 6d73 2e6c 6266 6773 2e65  = params.lbfgs.e
-0008fd30: 7073 2920 7b0a 2020 2020 2020 2020 2020  ps) {.          
-0008fd40: 2020 2f2f 2063 6f6e 7665 7267 6564 0a20    // converged. 
-0008fd50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0008fd60: 6e20 4747 4d4c 5f4f 5054 5f4f 4b3b 0a20  n GGML_OPT_OK;. 
-0008fd70: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0008fd80: 2020 2f2f 2064 656c 7461 2d62 6173 6564    // delta-based
-0008fd90: 2063 6f6e 7665 7267 656e 6365 2074 6573   convergence tes
-0008fda0: 740a 2020 2020 2020 2020 6966 2028 7066  t.        if (pf
-0008fdb0: 2021 3d20 4e55 4c4c 2920 7b0a 2020 2020   != NULL) {.    
-0008fdc0: 2020 2020 2020 2020 2f2f 206e 6565 6420          // need 
-0008fdd0: 6174 206c 6561 7374 2070 6172 616d 732e  at least params.
-0008fde0: 7061 7374 2069 7465 7261 7469 6f6e 7320  past iterations 
-0008fdf0: 746f 2073 7461 7274 2063 6865 636b 696e  to start checkin
-0008fe00: 6720 666f 7220 636f 6e76 6572 6765 6e63  g for convergenc
-0008fe10: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-0008fe20: 2028 7061 7261 6d73 2e70 6173 7420 3c3d   (params.past <=
-0008fe30: 206b 5b30 5d29 207b 0a20 2020 2020 2020   k[0]) {.       
-0008fe40: 2020 2020 2020 2020 2063 6f6e 7374 2066           const f
-0008fe50: 6c6f 6174 2072 6174 6520 3d20 2870 665b  loat rate = (pf[
-0008fe60: 6b5b 305d 2570 6172 616d 732e 7061 7374  k[0]%params.past
-0008fe70: 5d20 2d20 6678 292f 6678 3b0a 0a20 2020  ] - fx)/fx;..   
-0008fe80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0008fe90: 2866 6162 7366 2872 6174 6529 203c 2070  (fabsf(rate) < p
-0008fea0: 6172 616d 732e 6465 6c74 6129 207b 0a20  arams.delta) {. 
-0008feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0008fec0: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
-0008fed0: 5054 5f4f 4b3b 0a20 2020 2020 2020 2020  PT_OK;.         
-0008fee0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0008fef0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
-0008ff00: 2020 2020 7066 5b6b 5b30 5d25 7061 7261      pf[k[0]%para
-0008ff10: 6d73 2e70 6173 745d 203d 2066 783b 0a20  ms.past] = fx;. 
-0008ff20: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0008ff30: 2020 2f2f 2063 6865 636b 2066 6f72 2069    // check for i
-0008ff40: 6d70 726f 7665 6d65 6e74 0a20 2020 2020  mprovement.     
-0008ff50: 2020 2069 6620 2870 6172 616d 732e 6d61     if (params.ma
-0008ff60: 785f 6e6f 5f69 6d70 726f 7665 6d65 6e74  x_no_improvement
-0008ff70: 203e 2030 2920 7b0a 2020 2020 2020 2020   > 0) {.        
-0008ff80: 2020 2020 6966 2028 6678 203c 2066 785f      if (fx < fx_
-0008ff90: 6265 7374 5b30 5d29 207b 0a20 2020 2020  best[0]) {.     
-0008ffa0: 2020 2020 2020 2020 2020 2066 785f 6265             fx_be
-0008ffb0: 7374 5b30 5d20 3d20 6678 3b0a 2020 2020  st[0] = fx;.    
-0008ffc0: 2020 2020 2020 2020 2020 2020 6e5f 6e6f              n_no
-0008ffd0: 5f69 6d70 726f 7665 6d65 6e74 5b30 5d20  _improvement[0] 
-0008ffe0: 3d20 303b 0a20 2020 2020 2020 2020 2020  = 0;.           
-0008fff0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
-00090000: 2020 2020 2020 2020 2020 6e5f 6e6f 5f69            n_no_i
-00090010: 6d70 726f 7665 6d65 6e74 5b30 5d2b 2b3b  mprovement[0]++;
-00090020: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00090030: 2020 6966 2028 6e5f 6e6f 5f69 6d70 726f    if (n_no_impro
-00090040: 7665 6d65 6e74 5b30 5d20 3e3d 2070 6172  vement[0] >= par
-00090050: 616d 732e 6d61 785f 6e6f 5f69 6d70 726f  ams.max_no_impro
-00090060: 7665 6d65 6e74 2920 7b0a 2020 2020 2020  vement) {.      
-00090070: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00090080: 7475 726e 2047 474d 4c5f 4f50 545f 4f4b  turn GGML_OPT_OK
-00090090: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000900a0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000900b0: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
-000900c0: 2020 2020 2069 6620 2870 6172 616d 732e       if (params.
-000900d0: 6c62 6667 732e 6e5f 6974 6572 2021 3d20  lbfgs.n_iter != 
-000900e0: 3020 2626 2070 6172 616d 732e 6c62 6667  0 && params.lbfg
-000900f0: 732e 6e5f 6974 6572 203c 2069 7420 2b20  s.n_iter < it + 
-00090100: 3129 207b 0a20 2020 2020 2020 2020 2020  1) {.           
-00090110: 202f 2f20 7265 6163 6865 6420 7468 6520   // reached the 
-00090120: 6d61 7869 6d75 6d20 6e75 6d62 6572 206f  maximum number o
-00090130: 6620 6974 6572 6174 696f 6e73 0a20 2020  f iterations.   
-00090140: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00090150: 4747 4d4c 5f4f 5054 5f44 4944 5f4e 4f54  GGML_OPT_DID_NOT
-00090160: 5f43 4f4e 5645 5247 453b 0a20 2020 2020  _CONVERGE;.     
-00090170: 2020 207d 0a0a 2020 2020 2020 2020 2f2f     }..        //
-00090180: 2075 7064 6174 6520 7665 6374 6f72 7320   update vectors 
-00090190: 7320 616e 6420 793a 0a20 2020 2020 2020  s and y:.       
-000901a0: 202f 2f20 2020 735f 7b6b 2b31 7d20 3d20   //   s_{k+1} = 
-000901b0: 785f 7b6b 2b31 7d20 2d20 785f 7b6b 7d20  x_{k+1} - x_{k} 
-000901c0: 3d20 5c73 7465 7020 2a20 645f 7b6b 7d2e  = \step * d_{k}.
-000901d0: 0a20 2020 2020 2020 202f 2f20 2020 795f  .        //   y_
-000901e0: 7b6b 2b31 7d20 3d20 675f 7b6b 2b31 7d20  {k+1} = g_{k+1} 
-000901f0: 2d20 675f 7b6b 7d2e 0a20 2020 2020 2020  - g_{k}..       
-00090200: 202f 2f0a 2020 2020 2020 2020 6767 6d6c   //.        ggml
-00090210: 5f76 6563 5f73 7562 5f66 3332 286e 782c  _vec_sub_f32(nx,
-00090220: 2026 6c6d 5f73 5b65 6e64 5b30 5d2a 6e78   &lm_s[end[0]*nx
-00090230: 5d2c 2078 2c20 7870 293b 0a20 2020 2020  ], x, xp);.     
-00090240: 2020 2067 676d 6c5f 7665 635f 7375 625f     ggml_vec_sub_
-00090250: 6633 3228 6e78 2c20 266c 6d5f 795b 656e  f32(nx, &lm_y[en
-00090260: 645b 305d 2a6e 785d 2c20 672c 2067 7029  d[0]*nx], g, gp)
-00090270: 3b0a 0a20 2020 2020 2020 202f 2f20 636f  ;..        // co
-00090280: 6d70 7574 6520 7363 616c 6172 7320 7973  mpute scalars ys
-00090290: 2061 6e64 2079 793a 0a20 2020 2020 2020   and yy:.       
-000902a0: 202f 2f20 2020 2020 7973 203d 2079 5e74   //     ys = y^t
-000902b0: 205c 6364 6f74 2073 2020 2020 2d3e 2031   \cdot s    -> 1
-000902c0: 202f 205c 7268 6f2e 0a20 2020 2020 2020   / \rho..       
-000902d0: 202f 2f20 2020 2020 7979 203d 2079 5e74   //     yy = y^t
-000902e0: 205c 6364 6f74 2079 2e0a 2020 2020 2020   \cdot y..      
-000902f0: 2020 2f2f 0a20 2020 2020 2020 2067 676d    //.        ggm
-00090300: 6c5f 7665 635f 646f 745f 6633 3228 6e78  l_vec_dot_f32(nx
-00090310: 2c20 2679 732c 2026 6c6d 5f79 5b65 6e64  , &ys, &lm_y[end
-00090320: 5b30 5d2a 6e78 5d2c 2026 6c6d 5f73 5b65  [0]*nx], &lm_s[e
-00090330: 6e64 5b30 5d20 2a6e 785d 293b 0a20 2020  nd[0] *nx]);.   
-00090340: 2020 2020 2067 676d 6c5f 7665 635f 646f       ggml_vec_do
-00090350: 745f 6633 3228 6e78 2c20 2679 792c 2026  t_f32(nx, &yy, &
-00090360: 6c6d 5f79 5b65 6e64 5b30 5d2a 6e78 5d2c  lm_y[end[0]*nx],
-00090370: 2026 6c6d 5f79 5b65 6e64 5b30 5d2a 6e78   &lm_y[end[0]*nx
-00090380: 5d29 3b0a 0a20 2020 2020 2020 206c 6d5f  ]);..        lm_
-00090390: 7973 5b65 6e64 5b30 5d5d 203d 2079 733b  ys[end[0]] = ys;
-000903a0: 0a0a 2020 2020 2020 2020 2f2f 2066 696e  ..        // fin
-000903b0: 6420 6e65 7720 7365 6172 6368 2064 6972  d new search dir
-000903c0: 6563 7469 6f6e 0a20 2020 2020 2020 202f  ection.        /
-000903d0: 2f20 2020 7265 663a 2068 7474 7073 3a2f  /   ref: https:/
-000903e0: 2f65 6e2e 7769 6b69 7065 6469 612e 6f72  /en.wikipedia.or
-000903f0: 672f 7769 6b69 2f4c 696d 6974 6564 2d6d  g/wiki/Limited-m
-00090400: 656d 6f72 795f 4246 4753 0a0a 2020 2020  emory_BFGS..    
-00090410: 2020 2020 626f 756e 6420 3d20 286d 203c      bound = (m <
-00090420: 3d20 6b5b 305d 2920 3f20 6d20 3a20 6b5b  = k[0]) ? m : k[
-00090430: 305d 3b0a 2020 2020 2020 2020 6b5b 305d  0];.        k[0]
-00090440: 2b2b 3b0a 2020 2020 2020 2020 6974 2b2b  ++;.        it++
-00090450: 3b0a 2020 2020 2020 2020 656e 645b 305d  ;.        end[0]
-00090460: 203d 2028 656e 645b 305d 202b 2031 2925   = (end[0] + 1)%
-00090470: 6d3b 0a0a 2020 2020 2020 2020 2f2f 2069  m;..        // i
-00090480: 6e69 7469 616c 697a 6520 7365 6172 6368  nitialize search
-00090490: 2064 6972 6563 7469 6f6e 2077 6974 6820   direction with 
-000904a0: 2d67 0a20 2020 2020 2020 2067 676d 6c5f  -g.        ggml_
-000904b0: 7665 635f 6e65 675f 6633 3228 6e78 2c20  vec_neg_f32(nx, 
-000904c0: 642c 2067 293b 0a0a 2020 2020 2020 2020  d, g);..        
-000904d0: 6a5b 305d 203d 2065 6e64 5b30 5d3b 0a20  j[0] = end[0];. 
-000904e0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000904f0: 6920 3d20 303b 2069 203c 2062 6f75 6e64  i = 0; i < bound
-00090500: 3b20 2b2b 6929 207b 0a20 2020 2020 2020  ; ++i) {.       
-00090510: 2020 2020 206a 5b30 5d20 3d20 286a 5b30       j[0] = (j[0
-00090520: 5d20 2b20 6d20 2d20 3129 2025 206d 3b0a  ] + m - 1) % m;.
-00090530: 2020 2020 2020 2020 2020 2020 2f2f 205c              // \
-00090540: 616c 7068 615f 7b6a 7d20 3d20 5c72 686f  alpha_{j} = \rho
-00090550: 5f7b 6a7d 2073 5e7b 747d 5f7b 6a7d 205c  _{j} s^{t}_{j} \
-00090560: 6364 6f74 2071 5f7b 6b2b 317d 0a20 2020  cdot q_{k+1}.   
-00090570: 2020 2020 2020 2020 2067 676d 6c5f 7665           ggml_ve
-00090580: 635f 646f 745f 6633 3228 6e78 2c20 266c  c_dot_f32(nx, &l
-00090590: 6d5f 616c 7068 615b 6a5b 305d 5d2c 2026  m_alpha[j[0]], &
-000905a0: 6c6d 5f73 5b6a 5b30 5d2a 6e78 5d2c 2064  lm_s[j[0]*nx], d
-000905b0: 293b 0a20 2020 2020 2020 2020 2020 206c  );.            l
-000905c0: 6d5f 616c 7068 615b 6a5b 305d 5d20 2f3d  m_alpha[j[0]] /=
-000905d0: 206c 6d5f 7973 5b6a 5b30 5d5d 3b0a 2020   lm_ys[j[0]];.  
-000905e0: 2020 2020 2020 2020 2020 2f2f 2071 5f7b            // q_{
-000905f0: 697d 203d 2071 5f7b 692b 317d 202d 205c  i} = q_{i+1} - \
-00090600: 616c 7068 615f 7b69 7d20 795f 7b69 7d0a  alpha_{i} y_{i}.
-00090610: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
-00090620: 5f76 6563 5f6d 6164 5f66 3332 286e 782c  _vec_mad_f32(nx,
-00090630: 2064 2c20 266c 6d5f 795b 6a5b 305d 2a6e   d, &lm_y[j[0]*n
-00090640: 785d 2c20 2d6c 6d5f 616c 7068 615b 6a5b  x], -lm_alpha[j[
-00090650: 305d 5d29 3b0a 2020 2020 2020 2020 7d0a  0]]);.        }.
-00090660: 0a20 2020 2020 2020 2067 676d 6c5f 7665  .        ggml_ve
-00090670: 635f 7363 616c 655f 6633 3228 6e78 2c20  c_scale_f32(nx, 
-00090680: 642c 2079 732f 7979 293b 0a0a 2020 2020  d, ys/yy);..    
-00090690: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
-000906a0: 2030 3b20 6920 3c20 626f 756e 643b 202b   0; i < bound; +
-000906b0: 2b69 2920 7b0a 2020 2020 2020 2020 2020  +i) {.          
-000906c0: 2020 2f2f 205c 6265 7461 5f7b 6a7d 203d    // \beta_{j} =
-000906d0: 205c 7268 6f5f 7b6a 7d20 795e 745f 7b6a   \rho_{j} y^t_{j
-000906e0: 7d20 5c63 646f 7420 5c67 616d 6d61 5f7b  } \cdot \gamma_{
-000906f0: 697d 0a20 2020 2020 2020 2020 2020 2067  i}.            g
-00090700: 676d 6c5f 7665 635f 646f 745f 6633 3228  gml_vec_dot_f32(
-00090710: 6e78 2c20 2662 6574 612c 2026 6c6d 5f79  nx, &beta, &lm_y
-00090720: 5b6a 5b30 5d2a 6e78 5d2c 2064 293b 0a20  [j[0]*nx], d);. 
-00090730: 2020 2020 2020 2020 2020 2062 6574 6120             beta 
-00090740: 2f3d 206c 6d5f 7973 5b6a 5b30 5d5d 3b0a  /= lm_ys[j[0]];.
-00090750: 2020 2020 2020 2020 2020 2020 2f2f 205c              // \
-00090760: 6761 6d6d 615f 7b69 2b31 7d20 3d20 5c67  gamma_{i+1} = \g
-00090770: 616d 6d61 5f7b 697d 202b 2028 5c61 6c70  amma_{i} + (\alp
-00090780: 6861 5f7b 6a7d 202d 205c 6265 7461 5f7b  ha_{j} - \beta_{
-00090790: 6a7d 2920 735f 7b6a 7d0a 2020 2020 2020  j}) s_{j}.      
-000907a0: 2020 2020 2020 6767 6d6c 5f76 6563 5f6d        ggml_vec_m
-000907b0: 6164 5f66 3332 286e 782c 2064 2c20 266c  ad_f32(nx, d, &l
-000907c0: 6d5f 735b 6a5b 305d 2a6e 785d 2c20 6c6d  m_s[j[0]*nx], lm
-000907d0: 5f61 6c70 6861 5b6a 5b30 5d5d 202d 2062  _alpha[j[0]] - b
-000907e0: 6574 6129 3b0a 2020 2020 2020 2020 2020  eta);.          
-000907f0: 2020 6a5b 305d 203d 2028 6a5b 305d 202b    j[0] = (j[0] +
-00090800: 2031 2925 6d3b 0a20 2020 2020 2020 207d   1)%m;.        }
-00090810: 0a0a 2020 2020 2020 2020 7374 6570 5b30  ..        step[0
-00090820: 5d20 3d20 312e 303b 0a20 2020 207d 0a0a  ] = 1.0;.    }..
-00090830: 2020 2020 7265 7475 726e 2047 474d 4c5f      return GGML_
-00090840: 4f50 545f 4449 445f 4e4f 545f 434f 4e56  OPT_DID_NOT_CONV
-00090850: 4552 4745 3b0a 7d0a 0a73 7472 7563 7420  ERGE;.}..struct 
-00090860: 6767 6d6c 5f6f 7074 5f70 6172 616d 7320  ggml_opt_params 
-00090870: 6767 6d6c 5f6f 7074 5f64 6566 6175 6c74  ggml_opt_default
-00090880: 5f70 6172 616d 7328 656e 756d 2067 676d  _params(enum ggm
-00090890: 6c5f 6f70 745f 7479 7065 2074 7970 6529  l_opt_type type)
-000908a0: 207b 0a20 2020 2073 7472 7563 7420 6767   {.    struct gg
-000908b0: 6d6c 5f6f 7074 5f70 6172 616d 7320 7265  ml_opt_params re
-000908c0: 7375 6c74 3b0a 0a20 2020 2073 7769 7463  sult;..    switc
-000908d0: 6820 2874 7970 6529 207b 0a20 2020 2020  h (type) {.     
-000908e0: 2020 2063 6173 6520 4747 4d4c 5f4f 5054     case GGML_OPT
-000908f0: 5f41 4441 4d3a 0a20 2020 2020 2020 2020  _ADAM:.         
-00090900: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00090910: 2020 2020 2072 6573 756c 7420 3d20 2873       result = (s
-00090920: 7472 7563 7420 6767 6d6c 5f6f 7074 5f70  truct ggml_opt_p
-00090930: 6172 616d 7329 207b 0a20 2020 2020 2020  arams) {.       
-00090940: 2020 2020 2020 2020 2020 2020 202e 7479               .ty
-00090950: 7065 2020 2020 2020 3d20 4747 4d4c 5f4f  pe      = GGML_O
-00090960: 5054 5f41 4441 4d2c 0a20 2020 2020 2020  PT_ADAM,.       
-00090970: 2020 2020 2020 2020 2020 2020 202e 6e5f               .n_
-00090980: 7468 7265 6164 7320 3d20 312c 0a20 2020  threads = 1,.   
-00090990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000909a0: 202e 7061 7374 2020 2020 2020 3d20 302c   .past      = 0,
-000909b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000909c0: 2020 2020 202e 6465 6c74 6120 2020 2020       .delta     
-000909d0: 3d20 3165 2d35 662c 0a0a 2020 2020 2020  = 1e-5f,..      
-000909e0: 2020 2020 2020 2020 2020 2020 2020 2e6d                .m
-000909f0: 6178 5f6e 6f5f 696d 7072 6f76 656d 656e  ax_no_improvemen
-00090a00: 7420 3d20 3130 302c 0a0a 2020 2020 2020  t = 100,..      
-00090a10: 2020 2020 2020 2020 2020 2020 2020 2e70                .p
-00090a20: 7269 6e74 5f66 6f72 7761 7264 5f67 7261  rint_forward_gra
-00090a30: 7068 2020 3d20 7472 7565 2c0a 2020 2020  ph  = true,.    
-00090a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090a50: 2e70 7269 6e74 5f62 6163 6b77 6172 645f  .print_backward_
-00090a60: 6772 6170 6820 3d20 7472 7565 2c0a 0a20  graph = true,.. 
-00090a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090a80: 2020 202e 6164 616d 203d 207b 0a20 2020     .adam = {.   
-00090a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090aa0: 2020 2020 202e 6e5f 6974 6572 203d 2031       .n_iter = 1
-00090ab0: 3030 3030 2c0a 2020 2020 2020 2020 2020  0000,.          
-00090ac0: 2020 2020 2020 2020 2020 2020 2020 2e73                .s
-00090ad0: 6368 6564 2020 3d20 312e 3030 3066 2c0a  ched  = 1.000f,.
-00090ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090af0: 2020 2020 2020 2020 2e64 6563 6179 2020          .decay  
-00090b00: 3d20 302e 3030 3166 2c0a 2020 2020 2020  = 0.001f,.      
-00090b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090b20: 2020 2e61 6c70 6861 2020 3d20 302e 3030    .alpha  = 0.00
-00090b30: 3166 2c0a 2020 2020 2020 2020 2020 2020  1f,.            
-00090b40: 2020 2020 2020 2020 2020 2020 2e62 6574              .bet
-00090b50: 6131 2020 3d20 302e 3966 2c0a 2020 2020  a1  = 0.9f,.    
-00090b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090b70: 2020 2020 2e62 6574 6132 2020 3d20 302e      .beta2  = 0.
-00090b80: 3939 3966 2c0a 2020 2020 2020 2020 2020  999f,.          
-00090b90: 2020 2020 2020 2020 2020 2020 2020 2e65                .e
-00090ba0: 7073 2020 2020 3d20 3165 2d38 662c 0a20  ps    = 1e-8f,. 
-00090bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090bc0: 2020 2020 2020 202e 6570 735f 6620 203d         .eps_f  =
-00090bd0: 2031 652d 3566 2c0a 2020 2020 2020 2020   1e-5f,.        
-00090be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090bf0: 2e65 7073 5f67 2020 3d20 3165 2d33 662c  .eps_g  = 1e-3f,
-00090c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00090c10: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00090c20: 2020 2020 2020 2020 7d3b 0a20 2020 2020          };.     
-00090c30: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00090c40: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
-00090c50: 4c5f 4f50 545f 4c42 4647 533a 0a20 2020  L_OPT_LBFGS:.   
-00090c60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00090c70: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00090c80: 7420 3d20 2873 7472 7563 7420 6767 6d6c  t = (struct ggml
-00090c90: 5f6f 7074 5f70 6172 616d 7329 207b 0a20  _opt_params) {. 
-00090ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090cb0: 2020 202e 7479 7065 2020 2020 2020 3d20     .type      = 
-00090cc0: 4747 4d4c 5f4f 5054 5f4c 4246 4753 2c0a  GGML_OPT_LBFGS,.
-00090cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090ce0: 2020 2020 2e6e 5f74 6872 6561 6473 203d      .n_threads =
-00090cf0: 2031 2c0a 2020 2020 2020 2020 2020 2020   1,.            
-00090d00: 2020 2020 2020 2020 2e70 6173 7420 2020          .past   
-00090d10: 2020 203d 2030 2c0a 2020 2020 2020 2020     = 0,.        
-00090d20: 2020 2020 2020 2020 2020 2020 2e64 656c              .del
-00090d30: 7461 2020 2020 203d 2031 652d 3566 2c0a  ta     = 1e-5f,.
-00090d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00090d50: 2020 2020 202e 6d61 785f 6e6f 5f69 6d70       .max_no_imp
-00090d60: 726f 7665 6d65 6e74 203d 2030 2c0a 0a20  rovement = 0,.. 
-00090d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090d80: 2020 202e 7072 696e 745f 666f 7277 6172     .print_forwar
-00090d90: 645f 6772 6170 6820 203d 2074 7275 652c  d_graph  = true,
-00090da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00090db0: 2020 2020 202e 7072 696e 745f 6261 636b       .print_back
-00090dc0: 7761 7264 5f67 7261 7068 203d 2074 7275  ward_graph = tru
-00090dd0: 652c 0a0a 2020 2020 2020 2020 2020 2020  e,..            
-00090de0: 2020 2020 2020 2020 2e6c 6266 6773 203d          .lbfgs =
-00090df0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00090e00: 2020 2020 2020 2020 2020 202e 6d20 2020             .m   
-00090e10: 2020 2020 2020 2020 2020 203d 2036 2c0a             = 6,.
-00090e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090e30: 2020 2020 2020 2020 2e6e 5f69 7465 7220          .n_iter 
-00090e40: 2020 2020 2020 2020 3d20 3130 302c 0a20          = 100,. 
+0008b610: 736e 7072 696e 7466 2863 6f6c 6f72 2c20  snprintf(color, 
+0008b620: 7369 7a65 6f66 2863 6f6c 6f72 292c 2022  sizeof(color), "
+0008b630: 6772 6565 6e22 293b 0a20 2020 2020 2020  green");.       
+0008b640: 2020 2020 207d 2065 6c73 6520 7b0a 2020       } else {.  
+0008b650: 2020 2020 2020 2020 2020 2020 2020 736e                sn
+0008b660: 7072 696e 7466 2863 6f6c 6f72 2c20 7369  printf(color, si
+0008b670: 7a65 6f66 2863 6f6c 6f72 292c 2022 6c69  zeof(color), "li
+0008b680: 6768 7462 6c75 6522 293b 0a20 2020 2020  ghtblue");.     
+0008b690: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0008b6a0: 207d 2065 6c73 6520 7b0a 2020 2020 2020   } else {.      
+0008b6b0: 2020 2020 2020 736e 7072 696e 7466 2863        snprintf(c
+0008b6c0: 6f6c 6f72 2c20 7369 7a65 6f66 2863 6f6c  olor, sizeof(col
+0008b6d0: 6f72 292c 2022 7768 6974 6522 293b 0a20  or), "white");. 
+0008b6e0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0008b6f0: 2020 6670 7269 6e74 6628 6670 2c20 2220    fprintf(fp, " 
+0008b700: 205c 2225 705c 2220 5b20 220a 2020 2020   \"%p\" [ ".    
+0008b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008b720: 2273 7479 6c65 203d 2066 696c 6c65 643b  "style = filled;
+0008b730: 2066 696c 6c63 6f6c 6f72 203d 2025 733b   fillcolor = %s;
+0008b740: 2073 6861 7065 203d 2072 6563 6f72 643b   shape = record;
+0008b750: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0008b760: 2020 2020 2020 2022 6c61 6265 6c3d 5c22         "label=\"
+0008b770: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0008b780: 2020 2028 766f 6964 202a 2920 6e6f 6465     (void *) node
+0008b790: 2c20 636f 6c6f 7229 3b0a 0a20 2020 2020  , color);..     
+0008b7a0: 2020 2069 6620 2873 7472 6c65 6e28 6e6f     if (strlen(no
+0008b7b0: 6465 2d3e 6e61 6d65 2920 3e20 3029 207b  de->name) > 0) {
+0008b7c0: 0a20 2020 2020 2020 2020 2020 2066 7072  .            fpr
+0008b7d0: 696e 7466 2866 702c 2022 2573 2028 2573  intf(fp, "%s (%s
+0008b7e0: 297c 222c 206e 6f64 652d 3e6e 616d 652c  )|", node->name,
+0008b7f0: 2067 676d 6c5f 7479 7065 5f6e 616d 6528   ggml_type_name(
+0008b800: 6e6f 6465 2d3e 7479 7065 2929 3b0a 2020  node->type));.  
+0008b810: 2020 2020 2020 7d20 656c 7365 207b 0a20        } else {. 
+0008b820: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+0008b830: 7466 2866 702c 2022 2825 7329 7c22 2c20  tf(fp, "(%s)|", 
+0008b840: 6767 6d6c 5f74 7970 655f 6e61 6d65 286e  ggml_type_name(n
+0008b850: 6f64 652d 3e74 7970 6529 293b 0a20 2020  ode->type));.   
+0008b860: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0008b870: 6966 2028 6e6f 6465 2d3e 6e5f 6469 6d73  if (node->n_dims
+0008b880: 203d 3d20 3229 207b 0a20 2020 2020 2020   == 2) {.       
+0008b890: 2020 2020 2066 7072 696e 7466 2866 702c       fprintf(fp,
+0008b8a0: 2022 2564 205b 2522 2050 5249 6436 3420   "%d [%" PRId64 
+0008b8b0: 222c 2025 2220 5052 4964 3634 2022 5d20  ", %" PRId64 "] 
+0008b8c0: 7c20 3c78 3e25 7322 2c20 692c 206e 6f64  | <x>%s", i, nod
+0008b8d0: 652d 3e6e 655b 305d 2c20 6e6f 6465 2d3e  e->ne[0], node->
+0008b8e0: 6e65 5b31 5d2c 2047 474d 4c5f 4f50 5f53  ne[1], GGML_OP_S
+0008b8f0: 594d 424f 4c5b 6e6f 6465 2d3e 6f70 5d29  YMBOL[node->op])
+0008b900: 3b0a 2020 2020 2020 2020 7d20 656c 7365  ;.        } else
+0008b910: 207b 0a20 2020 2020 2020 2020 2020 2066   {.            f
+0008b920: 7072 696e 7466 2866 702c 2022 2564 205b  printf(fp, "%d [
+0008b930: 2522 2050 5249 6436 3420 222c 2025 2220  %" PRId64 ", %" 
+0008b940: 5052 4964 3634 2022 2c20 2522 2050 5249  PRId64 ", %" PRI
+0008b950: 6436 3420 225d 207c 203c 783e 2573 222c  d64 "] | <x>%s",
+0008b960: 2069 2c20 6e6f 6465 2d3e 6e65 5b30 5d2c   i, node->ne[0],
+0008b970: 206e 6f64 652d 3e6e 655b 315d 2c20 6e6f   node->ne[1], no
+0008b980: 6465 2d3e 6e65 5b32 5d2c 2047 474d 4c5f  de->ne[2], GGML_
+0008b990: 4f50 5f53 594d 424f 4c5b 6e6f 6465 2d3e  OP_SYMBOL[node->
+0008b9a0: 6f70 5d29 3b0a 2020 2020 2020 2020 7d0a  op]);.        }.
+0008b9b0: 0a20 2020 2020 2020 2069 6620 286e 6f64  .        if (nod
+0008b9c0: 652d 3e67 7261 6429 207b 0a20 2020 2020  e->grad) {.     
+0008b9d0: 2020 2020 2020 2066 7072 696e 7466 2866         fprintf(f
+0008b9e0: 702c 2022 207c 203c 673e 2573 5c22 3b20  p, " | <g>%s\"; 
+0008b9f0: 5d5c 6e22 2c20 4747 4d4c 5f4f 505f 5359  ]\n", GGML_OP_SY
+0008ba00: 4d42 4f4c 5b6e 6f64 652d 3e67 7261 642d  MBOL[node->grad-
+0008ba10: 3e6f 705d 293b 0a20 2020 2020 2020 207d  >op]);.        }
+0008ba20: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+0008ba30: 2020 2020 6670 7269 6e74 6628 6670 2c20      fprintf(fp, 
+0008ba40: 225c 223b 205d 5c6e 2229 3b0a 2020 2020  "\"; ]\n");.    
+0008ba50: 2020 2020 7d0a 2020 2020 7d0a 0a20 2020      }.    }..   
+0008ba60: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0008ba70: 2069 203c 2067 622d 3e6e 5f6c 6561 6673   i < gb->n_leafs
+0008ba80: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+0008ba90: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0008baa0: 736f 7220 2a20 6e6f 6465 203d 2067 622d  sor * node = gb-
+0008bab0: 3e6c 6561 6673 5b69 5d3b 0a0a 2020 2020  >leafs[i];..    
+0008bac0: 2020 2020 736e 7072 696e 7466 2863 6f6c      snprintf(col
+0008bad0: 6f72 2c20 7369 7a65 6f66 2863 6f6c 6f72  or, sizeof(color
+0008bae0: 292c 2022 7069 6e6b 2229 3b0a 0a20 2020  ), "pink");..   
+0008baf0: 2020 2020 2066 7072 696e 7466 2866 702c       fprintf(fp,
+0008bb00: 2022 2020 5c22 2570 5c22 205b 2022 0a20   "  \"%p\" [ ". 
+0008bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bb20: 2020 2022 7374 796c 6520 3d20 6669 6c6c     "style = fill
+0008bb30: 6564 3b20 6669 6c6c 636f 6c6f 7220 3d20  ed; fillcolor = 
+0008bb40: 2573 3b20 7368 6170 6520 3d20 7265 636f  %s; shape = reco
+0008bb50: 7264 3b20 220a 2020 2020 2020 2020 2020  rd; ".          
+0008bb60: 2020 2020 2020 2020 2020 226c 6162 656c            "label
+0008bb70: 3d5c 223c 783e 222c 0a20 2020 2020 2020  =\"<x>",.       
+0008bb80: 2020 2020 2020 2020 2028 766f 6964 202a           (void *
+0008bb90: 2920 6e6f 6465 2c20 636f 6c6f 7229 3b0a  ) node, color);.
+0008bba0: 0a20 2020 2020 2020 2069 6620 2873 7472  .        if (str
+0008bbb0: 6c65 6e28 6e6f 6465 2d3e 6e61 6d65 2920  len(node->name) 
+0008bbc0: 3e20 3029 207b 0a20 2020 2020 2020 2020  > 0) {.         
+0008bbd0: 2020 2066 7072 696e 7466 2866 702c 2022     fprintf(fp, "
+0008bbe0: 2573 2028 2573 297c 222c 206e 6f64 652d  %s (%s)|", node-
+0008bbf0: 3e6e 616d 652c 2067 676d 6c5f 7479 7065  >name, ggml_type
+0008bc00: 5f6e 616d 6528 6e6f 6465 2d3e 7479 7065  _name(node->type
+0008bc10: 2929 3b0a 2020 2020 2020 2020 7d20 656c  ));.        } el
+0008bc20: 7365 207b 0a20 2020 2020 2020 2020 2020  se {.           
+0008bc30: 2066 7072 696e 7466 2866 702c 2022 2825   fprintf(fp, "(%
+0008bc40: 7329 7c22 2c20 6767 6d6c 5f74 7970 655f  s)|", ggml_type_
+0008bc50: 6e61 6d65 286e 6f64 652d 3e74 7970 6529  name(node->type)
+0008bc60: 293b 0a20 2020 2020 2020 207d 0a0a 2020  );.        }..  
+0008bc70: 2020 2020 2020 6670 7269 6e74 6628 6670        fprintf(fp
+0008bc80: 2c20 2243 4f4e 5354 2025 6420 5b25 2220  , "CONST %d [%" 
+0008bc90: 5052 4964 3634 2022 2c20 2522 2050 5249  PRId64 ", %" PRI
+0008bca0: 6436 3420 225d 222c 2069 2c20 6e6f 6465  d64 "]", i, node
+0008bcb0: 2d3e 6e65 5b30 5d2c 206e 6f64 652d 3e6e  ->ne[0], node->n
+0008bcc0: 655b 315d 293b 0a20 2020 2020 2020 2069  e[1]);.        i
+0008bcd0: 6620 2867 676d 6c5f 6e65 6c65 6d65 6e74  f (ggml_nelement
+0008bce0: 7328 6e6f 6465 2920 3c20 3529 207b 0a20  s(node) < 5) {. 
+0008bcf0: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+0008bd00: 7466 2866 702c 2022 207c 2028 2229 3b0a  tf(fp, " | (");.
+0008bd10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0008bd20: 2869 6e74 206a 203d 2030 3b20 6a20 3c20  (int j = 0; j < 
+0008bd30: 6767 6d6c 5f6e 656c 656d 656e 7473 286e  ggml_nelements(n
+0008bd40: 6f64 6529 3b20 6a2b 2b29 207b 0a20 2020  ode); j++) {.   
+0008bd50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0008bd60: 286e 6f64 652d 3e74 7970 6520 3d3d 2047  (node->type == G
+0008bd70: 474d 4c5f 5459 5045 5f49 3820 7c7c 206e  GML_TYPE_I8 || n
+0008bd80: 6f64 652d 3e74 7970 6520 3d3d 2047 474d  ode->type == GGM
+0008bd90: 4c5f 5459 5045 5f49 3136 207c 7c20 6e6f  L_TYPE_I16 || no
+0008bda0: 6465 2d3e 7479 7065 203d 3d20 4747 4d4c  de->type == GGML
+0008bdb0: 5f54 5950 455f 4933 3229 207b 0a20 2020  _TYPE_I32) {.   
+0008bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008bdd0: 2066 7072 696e 7466 2866 702c 2022 2564   fprintf(fp, "%d
+0008bde0: 222c 2067 676d 6c5f 6765 745f 6933 325f  ", ggml_get_i32_
+0008bdf0: 3164 286e 6f64 652c 206a 2929 3b0a 2020  1d(node, j));.  
+0008be00: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0008be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008be20: 656c 7365 2069 6620 286e 6f64 652d 3e74  else if (node->t
+0008be30: 7970 6520 3d3d 2047 474d 4c5f 5459 5045  ype == GGML_TYPE
+0008be40: 5f46 3332 207c 7c20 6e6f 6465 2d3e 7479  _F32 || node->ty
+0008be50: 7065 203d 3d20 4747 4d4c 5f54 5950 455f  pe == GGML_TYPE_
+0008be60: 4631 3629 207b 0a20 2020 2020 2020 2020  F16) {.         
+0008be70: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+0008be80: 7466 2866 702c 2022 252e 3165 222c 2028  tf(fp, "%.1e", (
+0008be90: 646f 7562 6c65 2967 676d 6c5f 6765 745f  double)ggml_get_
+0008bea0: 6633 325f 3164 286e 6f64 652c 206a 2929  f32_1d(node, j))
+0008beb0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+0008bec0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0008bed0: 2020 2020 656c 7365 207b 0a20 2020 2020      else {.     
+0008bee0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0008bef0: 7072 696e 7466 2866 702c 2022 2322 293b  printf(fp, "#");
+0008bf00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008bf10: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+0008bf20: 2020 2069 6620 286a 203c 2067 676d 6c5f     if (j < ggml_
+0008bf30: 6e65 6c65 6d65 6e74 7328 6e6f 6465 2920  nelements(node) 
+0008bf40: 2d20 3129 207b 0a20 2020 2020 2020 2020  - 1) {.         
+0008bf50: 2020 2020 2020 2020 2020 2066 7072 696e             fprin
+0008bf60: 7466 2866 702c 2022 2c20 2229 3b0a 2020  tf(fp, ", ");.  
+0008bf70: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0008bf80: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0008bf90: 2020 2020 2020 2020 2020 6670 7269 6e74            fprint
+0008bfa0: 6628 6670 2c20 2229 2229 3b0a 2020 2020  f(fp, ")");.    
+0008bfb0: 2020 2020 7d0a 2020 2020 2020 2020 6670      }.        fp
+0008bfc0: 7269 6e74 6628 6670 2c20 225c 223b 205d  rintf(fp, "\"; ]
+0008bfd0: 5c6e 2229 3b0a 2020 2020 7d0a 0a20 2020  \n");.    }..   
+0008bfe0: 2066 6f72 2028 696e 7420 6920 3d20 303b   for (int i = 0;
+0008bff0: 2069 203c 2067 622d 3e6e 5f6e 6f64 6573   i < gb->n_nodes
+0008c000: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
+0008c010: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
+0008c020: 736f 7220 2a20 6e6f 6465 203d 2067 622d  sor * node = gb-
+0008c030: 3e6e 6f64 6573 5b69 5d3b 0a0a 2020 2020  >nodes[i];..    
+0008c040: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+0008c050: 2030 3b20 6a20 3c20 4747 4d4c 5f4d 4158   0; j < GGML_MAX
+0008c060: 5f53 5243 3b20 6a2b 2b29 207b 0a20 2020  _SRC; j++) {.   
+0008c070: 2020 2020 2020 2020 2069 6620 286e 6f64           if (nod
+0008c080: 652d 3e73 7263 5b6a 5d29 207b 0a20 2020  e->src[j]) {.   
+0008c090: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+0008c0a0: 7220 6c61 6265 6c5b 3136 5d3b 0a20 2020  r label[16];.   
+0008c0b0: 2020 2020 2020 2020 2020 2020 2073 6e70               snp
+0008c0c0: 7269 6e74 6628 6c61 6265 6c2c 2073 697a  rintf(label, siz
+0008c0d0: 656f 6628 6c61 6265 6c29 2c20 2273 7263  eof(label), "src
+0008c0e0: 2025 6422 2c20 6a29 3b0a 2020 2020 2020   %d", j);.      
+0008c0f0: 2020 2020 2020 2020 2020 6767 6d6c 5f67            ggml_g
+0008c100: 7261 7068 5f64 756d 705f 646f 745f 6e6f  raph_dump_dot_no
+0008c110: 6465 5f65 6467 6528 6670 2c20 6762 2c20  de_edge(fp, gb, 
+0008c120: 6e6f 6465 2c20 6e6f 6465 2d3e 7372 635b  node, node->src[
+0008c130: 6a5d 2c20 6c61 6265 6c29 3b0a 2020 2020  j], label);.    
+0008c140: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0008c150: 2020 7d0a 2020 2020 7d0a 0a20 2020 2066    }.    }..    f
+0008c160: 6f72 2028 696e 7420 6920 3d20 303b 2069  or (int i = 0; i
+0008c170: 203c 2067 622d 3e6e 5f6c 6561 6673 3b20   < gb->n_leafs; 
+0008c180: 692b 2b29 207b 0a20 2020 2020 2020 2073  i++) {.        s
+0008c190: 7472 7563 7420 6767 6d6c 5f74 656e 736f  truct ggml_tenso
+0008c1a0: 7220 2a20 6e6f 6465 203d 2067 622d 3e6c  r * node = gb->l
+0008c1b0: 6561 6673 5b69 5d3b 0a0a 2020 2020 2020  eafs[i];..      
+0008c1c0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
+0008c1d0: 3b20 6a20 3c20 4747 4d4c 5f4d 4158 5f53  ; j < GGML_MAX_S
+0008c1e0: 5243 3b20 6a2b 2b29 207b 0a20 2020 2020  RC; j++) {.     
+0008c1f0: 2020 2020 2020 2069 6620 286e 6f64 652d         if (node-
+0008c200: 3e73 7263 5b6a 5d29 207b 0a20 2020 2020  >src[j]) {.     
+0008c210: 2020 2020 2020 2020 2020 2063 6861 7220             char 
+0008c220: 6c61 6265 6c5b 3136 5d3b 0a20 2020 2020  label[16];.     
+0008c230: 2020 2020 2020 2020 2020 2073 6e70 7269             snpri
+0008c240: 6e74 6628 6c61 6265 6c2c 2073 697a 656f  ntf(label, sizeo
+0008c250: 6628 6c61 6265 6c29 2c20 2273 7263 2025  f(label), "src %
+0008c260: 6422 2c20 6a29 3b0a 2020 2020 2020 2020  d", j);.        
+0008c270: 2020 2020 2020 2020 6767 6d6c 5f67 7261          ggml_gra
+0008c280: 7068 5f64 756d 705f 646f 745f 6c65 6166  ph_dump_dot_leaf
+0008c290: 5f65 6467 6528 6670 2c20 6e6f 6465 2c20  _edge(fp, node, 
+0008c2a0: 6e6f 6465 2d3e 7372 635b 6a5d 2c20 6c61  node->src[j], la
+0008c2b0: 6265 6c29 3b0a 2020 2020 2020 2020 2020  bel);.          
+0008c2c0: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
+0008c2d0: 2020 7d0a 0a20 2020 2066 7072 696e 7466    }..    fprintf
+0008c2e0: 2866 702c 2022 7d5c 6e22 293b 0a0a 2020  (fp, "}\n");..  
+0008c2f0: 2020 6663 6c6f 7365 2866 7029 3b0a 0a20    fclose(fp);.. 
+0008c300: 2020 2047 474d 4c5f 5052 494e 5428 2225     GGML_PRINT("%
+0008c310: 733a 2064 6f74 202d 5470 6e67 2025 7320  s: dot -Tpng %s 
+0008c320: 2d6f 2025 732e 706e 6720 2626 206f 7065  -o %s.png && ope
+0008c330: 6e20 2573 2e70 6e67 5c6e 222c 205f 5f66  n %s.png\n", __f
+0008c340: 756e 635f 5f2c 2066 696c 656e 616d 652c  unc__, filename,
+0008c350: 2066 696c 656e 616d 652c 2066 696c 656e   filename, filen
+0008c360: 616d 6529 3b0a 7d0a 0a2f 2f2f 2f2f 2f2f  ame);.}..///////
+0008c370: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008c380: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008c390: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008c3a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+0008c3b0: 2f2f 2f2f 2f2f 2f2f 2f0a 0a73 7461 7469  /////////..stati
+0008c3c0: 6320 766f 6964 2067 676d 6c5f 6f70 745f  c void ggml_opt_
+0008c3d0: 7365 745f 7061 7261 6d73 2869 6e74 206e  set_params(int n
+0008c3e0: 702c 2073 7472 7563 7420 6767 6d6c 5f74  p, struct ggml_t
+0008c3f0: 656e 736f 7220 2a20 636f 6e73 7420 7073  ensor * const ps
+0008c400: 5b5d 2c20 636f 6e73 7420 666c 6f61 7420  [], const float 
+0008c410: 2a20 7829 207b 0a20 2020 2069 6e74 2069  * x) {.    int i
+0008c420: 203d 2030 3b0a 2020 2020 666f 7220 2869   = 0;.    for (i
+0008c430: 6e74 2070 203d 2030 3b20 7020 3c20 6e70  nt p = 0; p < np
+0008c440: 3b20 2b2b 7029 207b 0a20 2020 2020 2020  ; ++p) {.       
+0008c450: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0008c460: 6520 3d20 6767 6d6c 5f6e 656c 656d 656e  e = ggml_nelemen
+0008c470: 7473 2870 735b 705d 2920 3b0a 2020 2020  ts(ps[p]) ;.    
+0008c480: 2020 2020 2f2f 2054 4f44 4f3a 2061 6464      // TODO: add
+0008c490: 2066 756e 6374 696f 6e20 746f 2073 6574   function to set
+0008c4a0: 2074 656e 736f 7220 6672 6f6d 2061 7272   tensor from arr
+0008c4b0: 6179 0a20 2020 2020 2020 2066 6f72 2028  ay.        for (
+0008c4c0: 696e 7436 345f 7420 6a20 3d20 303b 206a  int64_t j = 0; j
+0008c4d0: 203c 206e 653b 202b 2b6a 2920 7b0a 2020   < ne; ++j) {.  
+0008c4e0: 2020 2020 2020 2020 2020 6767 6d6c 5f73            ggml_s
+0008c4f0: 6574 5f66 3332 5f31 6428 7073 5b70 5d2c  et_f32_1d(ps[p],
+0008c500: 206a 2c20 785b 692b 2b5d 293b 0a20 2020   j, x[i++]);.   
+0008c510: 2020 2020 207d 0a20 2020 207d 0a7d 0a0a       }.    }.}..
+0008c520: 7374 6174 6963 2076 6f69 6420 6767 6d6c  static void ggml
+0008c530: 5f6f 7074 5f67 6574 5f70 6172 616d 7328  _opt_get_params(
+0008c540: 696e 7420 6e70 2c20 7374 7275 6374 2067  int np, struct g
+0008c550: 676d 6c5f 7465 6e73 6f72 202a 2063 6f6e  gml_tensor * con
+0008c560: 7374 2070 735b 5d2c 2066 6c6f 6174 202a  st ps[], float *
+0008c570: 2078 2920 7b0a 2020 2020 696e 7420 6920   x) {.    int i 
+0008c580: 3d20 303b 0a20 2020 2066 6f72 2028 696e  = 0;.    for (in
+0008c590: 7420 7020 3d20 303b 2070 203c 206e 703b  t p = 0; p < np;
+0008c5a0: 202b 2b70 2920 7b0a 2020 2020 2020 2020   ++p) {.        
+0008c5b0: 636f 6e73 7420 696e 7436 345f 7420 6e65  const int64_t ne
+0008c5c0: 203d 2067 676d 6c5f 6e65 6c65 6d65 6e74   = ggml_nelement
+0008c5d0: 7328 7073 5b70 5d29 203b 0a20 2020 2020  s(ps[p]) ;.     
+0008c5e0: 2020 202f 2f20 544f 444f 3a20 6164 6420     // TODO: add 
+0008c5f0: 6675 6e63 7469 6f6e 2074 6f20 6765 7420  function to get 
+0008c600: 616c 6c20 656c 656d 656e 7473 2061 7420  all elements at 
+0008c610: 6f6e 6365 0a20 2020 2020 2020 2066 6f72  once.        for
+0008c620: 2028 696e 7436 345f 7420 6a20 3d20 303b   (int64_t j = 0;
+0008c630: 206a 203c 206e 653b 202b 2b6a 2920 7b0a   j < ne; ++j) {.
+0008c640: 2020 2020 2020 2020 2020 2020 785b 692b              x[i+
+0008c650: 2b5d 203d 2067 676d 6c5f 6765 745f 6633  +] = ggml_get_f3
+0008c660: 325f 3164 2870 735b 705d 2c20 6a29 3b0a  2_1d(ps[p], j);.
+0008c670: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
+0008c680: 7d0a 0a73 7461 7469 6320 766f 6964 2067  }..static void g
+0008c690: 676d 6c5f 6f70 745f 6765 745f 6772 6164  gml_opt_get_grad
+0008c6a0: 2869 6e74 206e 702c 2073 7472 7563 7420  (int np, struct 
+0008c6b0: 6767 6d6c 5f74 656e 736f 7220 2a20 636f  ggml_tensor * co
+0008c6c0: 6e73 7420 7073 5b5d 2c20 666c 6f61 7420  nst ps[], float 
+0008c6d0: 2a20 6729 207b 0a20 2020 2069 6e74 2069  * g) {.    int i
+0008c6e0: 203d 2030 3b0a 2020 2020 666f 7220 2869   = 0;.    for (i
+0008c6f0: 6e74 2070 203d 2030 3b20 7020 3c20 6e70  nt p = 0; p < np
+0008c700: 3b20 2b2b 7029 207b 0a20 2020 2020 2020  ; ++p) {.       
+0008c710: 2063 6f6e 7374 2069 6e74 3634 5f74 206e   const int64_t n
+0008c720: 6520 3d20 6767 6d6c 5f6e 656c 656d 656e  e = ggml_nelemen
+0008c730: 7473 2870 735b 705d 2920 3b0a 2020 2020  ts(ps[p]) ;.    
+0008c740: 2020 2020 2f2f 2054 4f44 4f3a 2061 6464      // TODO: add
+0008c750: 2066 756e 6374 696f 6e20 746f 2067 6574   function to get
+0008c760: 2061 6c6c 2065 6c65 6d65 6e74 7320 6174   all elements at
+0008c770: 206f 6e63 650a 2020 2020 2020 2020 666f   once.        fo
+0008c780: 7220 2869 6e74 3634 5f74 206a 203d 2030  r (int64_t j = 0
+0008c790: 3b20 6a20 3c20 6e65 3b20 2b2b 6a29 207b  ; j < ne; ++j) {
+0008c7a0: 0a20 2020 2020 2020 2020 2020 2067 5b69  .            g[i
+0008c7b0: 2b2b 5d20 3d20 6767 6d6c 5f67 6574 5f66  ++] = ggml_get_f
+0008c7c0: 3332 5f31 6428 7073 5b70 5d2d 3e67 7261  32_1d(ps[p]->gra
+0008c7d0: 642c 206a 293b 0a20 2020 2020 2020 207d  d, j);.        }
+0008c7e0: 0a20 2020 207d 0a7d 0a0a 2f2f 0a2f 2f20  .    }.}..//.// 
+0008c7f0: 4144 414d 0a2f 2f0a 2f2f 2020 2072 6566  ADAM.//.//   ref
+0008c800: 3a20 6874 7470 733a 2f2f 6172 7869 762e  : https://arxiv.
+0008c810: 6f72 672f 7064 662f 3134 3132 2e36 3938  org/pdf/1412.698
+0008c820: 302e 7064 660a 2f2f 0a0a 7374 6174 6963  0.pdf.//..static
+0008c830: 2065 6e75 6d20 6767 6d6c 5f6f 7074 5f72   enum ggml_opt_r
+0008c840: 6573 756c 7420 6767 6d6c 5f6f 7074 5f61  esult ggml_opt_a
+0008c850: 6461 6d28 0a20 2020 2020 2020 2073 7472  dam(.        str
+0008c860: 7563 7420 6767 6d6c 5f63 6f6e 7465 7874  uct ggml_context
+0008c870: 202a 2063 7478 2c0a 2020 2020 2020 2020   * ctx,.        
+0008c880: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
+0008c890: 636f 6e74 6578 7420 2a20 6f70 742c 0a20  context * opt,. 
+0008c8a0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
+0008c8b0: 6d6c 5f6f 7074 5f70 6172 616d 7320 7061  ml_opt_params pa
+0008c8c0: 7261 6d73 2c0a 2020 2020 2020 2020 7374  rams,.        st
+0008c8d0: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0008c8e0: 202a 2066 2c0a 2020 2020 2020 2020 7374   * f,.        st
+0008c8f0: 7275 6374 2067 676d 6c5f 6367 7261 7068  ruct ggml_cgraph
+0008c900: 202a 2067 662c 0a20 2020 2020 2020 2073   * gf,.        s
+0008c910: 7472 7563 7420 6767 6d6c 5f63 6772 6170  truct ggml_cgrap
+0008c920: 6820 2a20 6762 2920 7b0a 2020 2020 4747  h * gb) {.    GG
+0008c930: 4d4c 5f41 5353 4552 5428 6767 6d6c 5f69  ML_ASSERT(ggml_i
+0008c940: 735f 7363 616c 6172 2866 2929 3b0a 0a20  s_scalar(f));.. 
+0008c950: 2020 202f 2f20 7468 6573 6520 7769 6c6c     // these will
+0008c960: 2073 746f 7265 2074 6865 2070 6172 616d   store the param
+0008c970: 6574 6572 7320 7765 2077 616e 7420 746f  eters we want to
+0008c980: 206f 7074 696d 697a 650a 2020 2020 7374   optimize.    st
+0008c990: 7275 6374 2067 676d 6c5f 7465 6e73 6f72  ruct ggml_tensor
+0008c9a0: 202a 2070 735b 4747 4d4c 5f4d 4158 5f50   * ps[GGML_MAX_P
+0008c9b0: 4152 414d 535d 3b0a 0a20 2020 2069 6e74  ARAMS];..    int
+0008c9c0: 206e 7020 3d20 303b 0a20 2020 2069 6e74   np = 0;.    int
+0008c9d0: 206e 7820 3d20 303b 0a20 2020 2066 6f72   nx = 0;.    for
+0008c9e0: 2028 696e 7420 6920 3d20 303b 2069 203c   (int i = 0; i <
+0008c9f0: 2067 662d 3e6e 5f6e 6f64 6573 3b20 2b2b   gf->n_nodes; ++
+0008ca00: 6929 207b 0a20 2020 2020 2020 2069 6620  i) {.        if 
+0008ca10: 2867 662d 3e6e 6f64 6573 5b69 5d2d 3e69  (gf->nodes[i]->i
+0008ca20: 735f 7061 7261 6d29 207b 0a20 2020 2020  s_param) {.     
+0008ca30: 2020 2020 2020 2047 474d 4c5f 5052 494e         GGML_PRIN
+0008ca40: 545f 4445 4255 4728 2266 6f75 6e64 2070  T_DEBUG("found p
+0008ca50: 6172 616d 2025 643a 2067 7261 642d 3e6f  aram %d: grad->o
+0008ca60: 7020 3d20 2564 5c6e 222c 206e 702c 2067  p = %d\n", np, g
+0008ca70: 662d 3e6e 6f64 6573 5b69 5d2d 3e67 7261  f->nodes[i]->gra
+0008ca80: 642d 3e6f 7029 3b0a 0a20 2020 2020 2020  d->op);..       
+0008ca90: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
+0008caa0: 286e 7020 3c20 4747 4d4c 5f4d 4158 5f50  (np < GGML_MAX_P
+0008cab0: 4152 414d 5329 3b0a 0a20 2020 2020 2020  ARAMS);..       
+0008cac0: 2020 2020 2070 735b 6e70 2b2b 5d20 3d20       ps[np++] = 
+0008cad0: 6766 2d3e 6e6f 6465 735b 695d 3b0a 2020  gf->nodes[i];.  
+0008cae0: 2020 2020 2020 2020 2020 6e78 202b 3d20            nx += 
+0008caf0: 6767 6d6c 5f6e 656c 656d 656e 7473 2867  ggml_nelements(g
+0008cb00: 662d 3e6e 6f64 6573 5b69 5d29 3b0a 2020  f->nodes[i]);.  
+0008cb10: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+0008cb20: 2020 2069 6620 2828 6f70 742d 3e70 6172     if ((opt->par
+0008cb30: 616d 732e 7479 7065 2021 3d20 7061 7261  ams.type != para
+0008cb40: 6d73 2e74 7970 6529 207c 7c20 286f 7074  ms.type) || (opt
+0008cb50: 2d3e 6e78 2021 3d20 6e78 2920 7c7c 2028  ->nx != nx) || (
+0008cb60: 6f70 742d 3e70 6172 616d 732e 7061 7374  opt->params.past
+0008cb70: 2021 3d20 7061 7261 6d73 2e70 6173 7429   != params.past)
+0008cb80: 2920 7b0a 2020 2020 2020 2020 696e 7420  ) {.        int 
+0008cb90: 6974 6572 203d 206f 7074 2d3e 6974 6572  iter = opt->iter
+0008cba0: 3b0a 2020 2020 2020 2020 6767 6d6c 5f6f  ;.        ggml_o
+0008cbb0: 7074 5f69 6e69 7428 6f70 742d 3e63 7478  pt_init(opt->ctx
+0008cbc0: 2c20 6f70 742c 2070 6172 616d 732c 206e  , opt, params, n
+0008cbd0: 7829 3b0a 2020 2020 2020 2020 6f70 742d  x);.        opt-
+0008cbe0: 3e69 7465 7220 3d20 6974 6572 3b0a 2020  >iter = iter;.  
+0008cbf0: 2020 7d0a 0a20 2020 202f 2f20 636f 6e73    }..    // cons
+0008cc00: 7461 6e74 730a 2020 2020 636f 6e73 7420  tants.    const 
+0008cc10: 666c 6f61 7420 7363 6865 6420 3d20 7061  float sched = pa
+0008cc20: 7261 6d73 2e61 6461 6d2e 7363 6865 643b  rams.adam.sched;
+0008cc30: 0a20 2020 2063 6f6e 7374 2066 6c6f 6174  .    const float
+0008cc40: 2064 6563 6179 203d 2070 6172 616d 732e   decay = params.
+0008cc50: 6164 616d 2e64 6563 6179 202a 2073 6368  adam.decay * sch
+0008cc60: 6564 3b0a 2020 2020 636f 6e73 7420 666c  ed;.    const fl
+0008cc70: 6f61 7420 616c 7068 6120 3d20 7061 7261  oat alpha = para
+0008cc80: 6d73 2e61 6461 6d2e 616c 7068 6120 2a20  ms.adam.alpha * 
+0008cc90: 7363 6865 643b 0a20 2020 2063 6f6e 7374  sched;.    const
+0008cca0: 2066 6c6f 6174 2062 6574 6131 203d 2070   float beta1 = p
+0008ccb0: 6172 616d 732e 6164 616d 2e62 6574 6131  arams.adam.beta1
+0008ccc0: 3b0a 2020 2020 636f 6e73 7420 666c 6f61  ;.    const floa
+0008ccd0: 7420 6265 7461 3220 3d20 7061 7261 6d73  t beta2 = params
+0008cce0: 2e61 6461 6d2e 6265 7461 323b 0a20 2020  .adam.beta2;.   
+0008ccf0: 2063 6f6e 7374 2066 6c6f 6174 2065 7073   const float eps
+0008cd00: 2020 203d 2070 6172 616d 732e 6164 616d     = params.adam
+0008cd10: 2e65 7073 3b0a 0a20 2020 2066 6c6f 6174  .eps;..    float
+0008cd20: 202a 2078 2020 3d20 6f70 742d 3e61 6461   * x  = opt->ada
+0008cd30: 6d2e 782d 3e64 6174 613b 2020 2f2f 2076  m.x->data;  // v
+0008cd40: 6965 7720 6f66 2074 6865 2070 6172 616d  iew of the param
+0008cd50: 6574 6572 730a 2020 2020 666c 6f61 7420  eters.    float 
+0008cd60: 2a20 6731 203d 206f 7074 2d3e 6164 616d  * g1 = opt->adam
+0008cd70: 2e67 312d 3e64 6174 613b 202f 2f20 6772  .g1->data; // gr
+0008cd80: 6164 6965 6e74 0a20 2020 2066 6c6f 6174  adient.    float
+0008cd90: 202a 2067 3220 3d20 6f70 742d 3e61 6461   * g2 = opt->ada
+0008cda0: 6d2e 6732 2d3e 6461 7461 3b20 2f2f 2067  m.g2->data; // g
+0008cdb0: 7261 6469 656e 7420 7371 7561 7265 640a  radient squared.
+0008cdc0: 2020 2020 666c 6f61 7420 2a20 6d20 203d      float * m  =
+0008cdd0: 206f 7074 2d3e 6164 616d 2e6d 2d3e 6461   opt->adam.m->da
+0008cde0: 7461 3b20 202f 2f20 6669 7273 7420 6d6f  ta;  // first mo
+0008cdf0: 6d65 6e74 0a20 2020 2066 6c6f 6174 202a  ment.    float *
+0008ce00: 2076 2020 3d20 6f70 742d 3e61 6461 6d2e   v  = opt->adam.
+0008ce10: 762d 3e64 6174 613b 2020 2f2f 2073 6563  v->data;  // sec
+0008ce20: 6f6e 6420 6d6f 6d65 6e74 0a20 2020 2066  ond moment.    f
+0008ce30: 6c6f 6174 202a 206d 6820 3d20 6f70 742d  loat * mh = opt-
+0008ce40: 3e61 6461 6d2e 6d68 2d3e 6461 7461 3b20  >adam.mh->data; 
+0008ce50: 2f2f 2066 6972 7374 206d 6f6d 656e 7420  // first moment 
+0008ce60: 6861 740a 2020 2020 666c 6f61 7420 2a20  hat.    float * 
+0008ce70: 7668 203d 206f 7074 2d3e 6164 616d 2e76  vh = opt->adam.v
+0008ce80: 682d 3e64 6174 613b 202f 2f20 7365 636f  h->data; // seco
+0008ce90: 6e64 206d 6f6d 656e 7420 6861 740a 0a20  nd moment hat.. 
+0008cea0: 2020 2066 6c6f 6174 202a 2070 6620 3d20     float * pf = 
+0008ceb0: 7061 7261 6d73 2e70 6173 7420 3e20 3020  params.past > 0 
+0008cec0: 3f20 6f70 742d 3e61 6461 6d2e 7066 2d3e  ? opt->adam.pf->
+0008ced0: 6461 7461 203a 204e 554c 4c3b 202f 2f20  data : NULL; // 
+0008cee0: 7061 7374 2066 756e 6374 696f 6e20 7661  past function va
+0008cef0: 6c75 6573 0a0a 2020 2020 2f2f 2075 7064  lues..    // upd
+0008cf00: 6174 6520 7669 6577 0a20 2020 2067 676d  ate view.    ggm
+0008cf10: 6c5f 6f70 745f 6765 745f 7061 7261 6d73  l_opt_get_params
+0008cf20: 286e 702c 2070 732c 2078 293b 0a0a 2020  (np, ps, x);..  
+0008cf30: 2020 2f2f 2063 6f6d 7075 7465 2074 6865    // compute the
+0008cf40: 2066 756e 6374 696f 6e20 7661 6c75 650a   function value.
+0008cf50: 2020 2020 6767 6d6c 5f67 7261 7068 5f72      ggml_graph_r
+0008cf60: 6573 6574 2020 2867 6629 3b0a 2020 2020  eset  (gf);.    
+0008cf70: 6767 6d6c 5f73 6574 5f66 3332 2020 2020  ggml_set_f32    
+0008cf80: 2020 2866 2d3e 6772 6164 2c20 312e 3066    (f->grad, 1.0f
+0008cf90: 293b 0a0a 2020 2020 6767 6d6c 5f67 7261  );..    ggml_gra
+0008cfa0: 7068 5f63 6f6d 7075 7465 5f77 6974 685f  ph_compute_with_
+0008cfb0: 6374 7828 6374 782c 2067 622c 2070 6172  ctx(ctx, gb, par
+0008cfc0: 616d 732e 6e5f 7468 7265 6164 7329 3b0a  ams.n_threads);.
+0008cfd0: 0a20 2020 206f 7074 2d3e 6164 616d 2e66  .    opt->adam.f
+0008cfe0: 785f 7072 6576 203d 2067 676d 6c5f 6765  x_prev = ggml_ge
+0008cff0: 745f 6633 325f 3164 2866 2c20 3029 3b0a  t_f32_1d(f, 0);.
+0008d000: 2020 2020 6f70 742d 3e61 6461 6d2e 6678      opt->adam.fx
+0008d010: 5f62 6573 7420 3d20 6f70 742d 3e61 6461  _best = opt->ada
+0008d020: 6d2e 6678 5f70 7265 763b 0a20 2020 2069  m.fx_prev;.    i
+0008d030: 6620 2870 6629 207b 0a20 2020 2020 2020  f (pf) {.       
+0008d040: 2070 665b 6f70 742d 3e69 7465 7220 2520   pf[opt->iter % 
+0008d050: 7061 7261 6d73 2e70 6173 745d 203d 206f  params.past] = o
+0008d060: 7074 2d3e 6164 616d 2e66 785f 7072 6576  pt->adam.fx_prev
+0008d070: 3b0a 2020 2020 7d0a 0a20 2020 202f 2f20  ;.    }..    // 
+0008d080: 696e 6974 6961 6c69 7a65 0a20 2020 2069  initialize.    i
+0008d090: 6620 286f 7074 2d3e 6a75 7374 5f69 6e69  f (opt->just_ini
+0008d0a0: 7469 616c 697a 6564 2920 7b0a 2020 2020  tialized) {.    
+0008d0b0: 2020 2020 6f70 742d 3e61 6461 6d2e 6e5f      opt->adam.n_
+0008d0c0: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203d  no_improvement =
+0008d0d0: 2030 3b0a 2020 2020 2020 2020 6f70 742d   0;.        opt-
+0008d0e0: 3e6a 7573 745f 696e 6974 6961 6c69 7a65  >just_initialize
+0008d0f0: 6420 3d20 6661 6c73 653b 0a20 2020 207d  d = false;.    }
+0008d100: 0a0a 2020 2020 666c 6f61 7420 2a20 6678  ..    float * fx
+0008d110: 5f62 6573 7420 3d20 266f 7074 2d3e 6164  _best = &opt->ad
+0008d120: 616d 2e66 785f 6265 7374 3b0a 2020 2020  am.fx_best;.    
+0008d130: 666c 6f61 7420 2a20 6678 5f70 7265 7620  float * fx_prev 
+0008d140: 3d20 266f 7074 2d3e 6164 616d 2e66 785f  = &opt->adam.fx_
+0008d150: 7072 6576 3b0a 2020 2020 696e 7420 2a20  prev;.    int * 
+0008d160: 6e5f 6e6f 5f69 6d70 726f 7665 6d65 6e74  n_no_improvement
+0008d170: 203d 2026 6f70 742d 3e61 6461 6d2e 6e5f   = &opt->adam.n_
+0008d180: 6e6f 5f69 6d70 726f 7665 6d65 6e74 3b0a  no_improvement;.
+0008d190: 0a20 2020 2069 6e74 2069 7465 7230 203d  .    int iter0 =
+0008d1a0: 206f 7074 2d3e 6974 6572 3b0a 0a20 2020   opt->iter;..   
+0008d1b0: 202f 2f20 7275 6e20 7468 6520 6f70 7469   // run the opti
+0008d1c0: 6d69 7a65 720a 2020 2020 666f 7220 2869  mizer.    for (i
+0008d1d0: 6e74 2074 203d 2030 3b20 7420 3c20 7061  nt t = 0; t < pa
+0008d1e0: 7261 6d73 2e61 6461 6d2e 6e5f 6974 6572  rams.adam.n_iter
+0008d1f0: 3b20 2b2b 7429 207b 0a20 2020 2020 2020  ; ++t) {.       
+0008d200: 206f 7074 2d3e 6974 6572 203d 2069 7465   opt->iter = ite
+0008d210: 7230 202b 2074 202b 2031 3b0a 2020 2020  r0 + t + 1;.    
+0008d220: 2020 2020 4747 4d4c 5f50 5249 4e54 5f44      GGML_PRINT_D
+0008d230: 4542 5547 2020 2822 3d3d 3d20 6974 6572  EBUG  ("=== iter
+0008d240: 2025 6420 3d3d 3d5c 6e22 2c20 7429 3b0a   %d ===\n", t);.
+0008d250: 0a20 2020 2020 2020 2047 474d 4c5f 5052  .        GGML_PR
+0008d260: 494e 545f 4445 4255 4720 2028 2266 2020  INT_DEBUG  ("f  
+0008d270: 2020 2020 3d20 2531 302e 3666 5c6e 222c      = %10.6f\n",
+0008d280: 2067 676d 6c5f 6765 745f 6633 325f 3164   ggml_get_f32_1d
+0008d290: 2866 2c20 3029 293b 0a20 2020 2020 2020  (f, 0));.       
+0008d2a0: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+0008d2b0: 475f 3528 2264 662f 6478 3020 3d20 2531  G_5("df/dx0 = %1
+0008d2c0: 302e 3666 5c6e 222c 2067 676d 6c5f 6765  0.6f\n", ggml_ge
+0008d2d0: 745f 6633 325f 3164 2870 735b 305d 2d3e  t_f32_1d(ps[0]->
+0008d2e0: 6772 6164 2c20 3029 293b 0a20 2020 2020  grad, 0));.     
+0008d2f0: 2020 2047 474d 4c5f 5052 494e 545f 4445     GGML_PRINT_DE
+0008d300: 4255 475f 3528 2264 662f 6478 3120 3d20  BUG_5("df/dx1 = 
+0008d310: 2531 302e 3666 5c6e 222c 2067 676d 6c5f  %10.6f\n", ggml_
+0008d320: 6765 745f 6633 325f 3164 2870 735b 315d  get_f32_1d(ps[1]
+0008d330: 2d3e 6772 6164 2c20 3029 293b 0a0a 2020  ->grad, 0));..  
+0008d340: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+0008d350: 203d 2030 3b20 6920 3c20 6e70 3b20 2b2b   = 0; i < np; ++
+0008d360: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
+0008d370: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+0008d380: 4728 2270 6172 616d 2025 643a 2025 3130  G("param %d: %10
+0008d390: 2e36 662c 2067 203d 2025 3130 2e36 665c  .6f, g = %10.6f\
+0008d3a0: 6e22 2c20 692c 0a20 2020 2020 2020 2020  n", i,.         
+0008d3b0: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0008d3c0: 6765 745f 6633 325f 3164 2870 735b 695d  get_f32_1d(ps[i]
+0008d3d0: 2c20 3029 2c20 6767 6d6c 5f67 6574 5f66  , 0), ggml_get_f
+0008d3e0: 3332 5f31 6428 7073 5b69 5d2d 3e67 7261  32_1d(ps[i]->gra
+0008d3f0: 642c 2030 2929 3b0a 2020 2020 2020 2020  d, 0));.        
+0008d400: 7d0a 0a20 2020 2020 2020 2063 6f6e 7374  }..        const
+0008d410: 2069 6e74 3634 5f74 2074 5f73 7461 7274   int64_t t_start
+0008d420: 5f77 616c 6c20 3d20 6767 6d6c 5f74 696d  _wall = ggml_tim
+0008d430: 655f 7573 2829 3b0a 2020 2020 2020 2020  e_us();.        
+0008d440: 636f 6e73 7420 696e 7436 345f 7420 745f  const int64_t t_
+0008d450: 7374 6172 745f 6370 7520 3d20 6767 6d6c  start_cpu = ggml
+0008d460: 5f63 7963 6c65 7328 293b 0a20 2020 2020  _cycles();.     
+0008d470: 2020 2055 4e55 5345 4428 745f 7374 6172     UNUSED(t_star
+0008d480: 745f 7761 6c6c 293b 0a20 2020 2020 2020  t_wall);.       
+0008d490: 2055 4e55 5345 4428 745f 7374 6172 745f   UNUSED(t_start_
+0008d4a0: 6370 7529 3b0a 0a20 2020 2020 2020 207b  cpu);..        {
+0008d4b0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0008d4c0: 7570 6461 7465 2074 6865 2067 7261 6469  update the gradi
+0008d4d0: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0008d4e0: 6767 6d6c 5f6f 7074 5f67 6574 5f67 7261  ggml_opt_get_gra
+0008d4f0: 6428 6e70 2c20 7073 2c20 6731 293b 0a0a  d(np, ps, g1);..
+0008d500: 2020 2020 2020 2020 2020 2020 2f2f 206d              // m
+0008d510: 5f74 203d 2062 6574 6131 2a6d 5f74 2d31  _t = beta1*m_t-1
+0008d520: 202b 2028 3120 2d20 6265 7461 3129 2a67   + (1 - beta1)*g
+0008d530: 5f74 0a20 2020 2020 2020 2020 2020 2067  _t.            g
+0008d540: 676d 6c5f 7665 635f 7363 616c 655f 6633  gml_vec_scale_f3
+0008d550: 3228 6e78 2c20 6d2c 2062 6574 6131 293b  2(nx, m, beta1);
+0008d560: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0008d570: 6c5f 7665 635f 6d61 645f 6633 3220 2028  l_vec_mad_f32  (
+0008d580: 6e78 2c20 6d2c 2067 312c 2031 2e30 6620  nx, m, g1, 1.0f 
+0008d590: 2d20 6265 7461 3129 3b0a 0a20 2020 2020  - beta1);..     
+0008d5a0: 2020 2020 2020 202f 2f20 6732 203d 2067         // g2 = g
+0008d5b0: 315e 320a 2020 2020 2020 2020 2020 2020  1^2.            
+0008d5c0: 6767 6d6c 5f76 6563 5f73 7172 5f66 3332  ggml_vec_sqr_f32
+0008d5d0: 2020 286e 782c 2067 322c 2067 3129 3b0a    (nx, g2, g1);.
+0008d5e0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0008d5f0: 765f 7420 3d20 6265 7461 322a 765f 742d  v_t = beta2*v_t-
+0008d600: 3120 2b20 2831 202d 2062 6574 6132 292a  1 + (1 - beta2)*
+0008d610: 675f 745e 320a 2020 2020 2020 2020 2020  g_t^2.          
+0008d620: 2020 6767 6d6c 5f76 6563 5f73 6361 6c65    ggml_vec_scale
+0008d630: 5f66 3332 286e 782c 2076 2c20 6265 7461  _f32(nx, v, beta
+0008d640: 3229 3b0a 2020 2020 2020 2020 2020 2020  2);.            
+0008d650: 6767 6d6c 5f76 6563 5f6d 6164 5f66 3332  ggml_vec_mad_f32
+0008d660: 2020 286e 782c 2076 2c20 6732 2c20 312e    (nx, v, g2, 1.
+0008d670: 3066 202d 2062 6574 6132 293b 0a0a 2020  0f - beta2);..  
+0008d680: 2020 2020 2020 2020 2020 2f2f 206d 5e68            // m^h
+0008d690: 6174 203d 206d 5f74 202f 2028 3120 2d20  at = m_t / (1 - 
+0008d6a0: 6265 7461 315e 7429 0a20 2020 2020 2020  beta1^t).       
+0008d6b0: 2020 2020 202f 2f20 765e 6861 7420 3d20       // v^hat = 
+0008d6c0: 765f 7420 2f20 2831 202d 2062 6574 6132  v_t / (1 - beta2
+0008d6d0: 5e74 290a 2020 2020 2020 2020 2020 2020  ^t).            
+0008d6e0: 2f2f 2078 5f74 203d 2078 5f74 2d31 202d  // x_t = x_t-1 -
+0008d6f0: 2073 6368 6564 2a28 616c 7068 612a 6d5e   sched*(alpha*m^
+0008d700: 6861 742f 2873 7172 7428 765e 6861 7429  hat/(sqrt(v^hat)
+0008d710: 202b 2065 7073 2920 2b20 6465 6361 792a   + eps) + decay*
+0008d720: 785f 742d 3129 0a20 2020 2020 2020 2020  x_t-1).         
+0008d730: 2020 202f 2f20 785f 7420 3d20 785f 742d     // x_t = x_t-
+0008d740: 3120 2d20 7363 6865 642a 616c 7068 612a  1 - sched*alpha*
+0008d750: 6d5e 6861 742f 2873 7172 7428 765e 6861  m^hat/(sqrt(v^ha
+0008d760: 7429 202b 2065 7073 2920 2d20 7363 6865  t) + eps) - sche
+0008d770: 642a 6465 6361 792a 785f 742d 310a 2020  d*decay*x_t-1.  
+0008d780: 2020 2020 2020 2020 2020 2f2f 2078 5f74            // x_t
+0008d790: 203d 2078 5f74 2d31 2a28 312d 7363 6865   = x_t-1*(1-sche
+0008d7a0: 642a 6465 6361 7929 202d 2073 6368 6564  d*decay) - sched
+0008d7b0: 2a61 6c70 6861 2a6d 5e68 6174 2f28 7371  *alpha*m^hat/(sq
+0008d7c0: 7274 2876 5e68 6174 2920 2b20 6570 7329  rt(v^hat) + eps)
+0008d7d0: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0008d7e0: 785f 7420 3d20 785f 742d 312a 2831 2d73  x_t = x_t-1*(1-s
+0008d7f0: 6368 6564 2a64 6563 6179 2920 2b20 7363  ched*decay) + sc
+0008d800: 6865 642a 6465 6361 792a 282d 616c 7068  hed*decay*(-alph
+0008d810: 612f 6465 6361 7929 2a6d 5e68 6174 2f28  a/decay)*m^hat/(
+0008d820: 7371 7274 2876 5e68 6174 2920 2b20 6570  sqrt(v^hat) + ep
+0008d830: 7329 0a20 2020 2020 2020 2020 2020 202f  s).            /
+0008d840: 2f20 785f 7420 3d20 6d69 7828 785f 742d  / x_t = mix(x_t-
+0008d850: 312c 2028 2d61 6c70 6861 2f64 6563 6179  1, (-alpha/decay
+0008d860: 292a 6d5e 6861 742f 2873 7172 7428 765e  )*m^hat/(sqrt(v^
+0008d870: 6861 7429 202b 2065 7073 292c 2073 6368  hat) + eps), sch
+0008d880: 6564 2a64 6563 6179 290a 2020 2020 2020  ed*decay).      
+0008d890: 2020 2020 2020 6767 6d6c 5f76 6563 5f63        ggml_vec_c
+0008d8a0: 7079 5f66 3332 2020 286e 782c 206d 682c  py_f32  (nx, mh,
+0008d8b0: 206d 293b 0a20 2020 2020 2020 2020 2020   m);.           
+0008d8c0: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
+0008d8d0: 3220 2028 6e78 2c20 7668 2c20 7629 3b0a  2  (nx, vh, v);.
+0008d8e0: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0008d8f0: 6c5f 7665 635f 7363 616c 655f 6633 3228  l_vec_scale_f32(
+0008d900: 6e78 2c20 6d68 2c20 616c 7068 612f 2831  nx, mh, alpha/(1
+0008d910: 2e30 6620 2d20 706f 7766 2862 6574 6131  .0f - powf(beta1
+0008d920: 2c20 6f70 742d 3e69 7465 7229 2929 3b0a  , opt->iter)));.
+0008d930: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0008d940: 5f76 6563 5f73 6361 6c65 5f66 3332 286e  _vec_scale_f32(n
+0008d950: 782c 2076 682c 2020 312e 3066 2f28 312e  x, vh,  1.0f/(1.
+0008d960: 3066 202d 2070 6f77 6628 6265 7461 322c  0f - powf(beta2,
+0008d970: 206f 7074 2d3e 6974 6572 2929 293b 0a0a   opt->iter)));..
+0008d980: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0008d990: 5f76 6563 5f73 7172 745f 6633 3220 286e  _vec_sqrt_f32 (n
+0008d9a0: 782c 2076 682c 2076 6829 3b0a 2020 2020  x, vh, vh);.    
+0008d9b0: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+0008d9c0: 5f61 6363 315f 6633 3220 286e 782c 2076  _acc1_f32 (nx, v
+0008d9d0: 682c 2065 7073 293b 0a0a 2020 2020 2020  h, eps);..      
+0008d9e0: 2020 2020 2020 6767 6d6c 5f76 6563 5f64        ggml_vec_d
+0008d9f0: 6976 5f66 3332 2020 286e 782c 206d 682c  iv_f32  (nx, mh,
+0008da00: 206d 682c 2076 6829 3b0a 2020 2020 2020   mh, vh);.      
+0008da10: 2020 2020 2020 6767 6d6c 5f76 6563 5f73        ggml_vec_s
+0008da20: 6361 6c65 5f66 3332 286e 782c 2078 2c20  cale_f32(nx, x, 
+0008da30: 2031 2e30 6620 2d20 6465 6361 7929 3b0a   1.0f - decay);.
+0008da40: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+0008da50: 5f76 6563 5f73 7562 5f66 3332 2020 286e  _vec_sub_f32  (n
+0008da60: 782c 2078 2c20 2078 2c20 206d 6829 3b0a  x, x,  x,  mh);.
+0008da70: 0a20 2020 2020 2020 2020 2020 202f 2f20  .            // 
+0008da80: 7570 6461 7465 2074 6865 2070 6172 616d  update the param
+0008da90: 6574 6572 730a 2020 2020 2020 2020 2020  eters.          
+0008daa0: 2020 6767 6d6c 5f6f 7074 5f73 6574 5f70    ggml_opt_set_p
+0008dab0: 6172 616d 7328 6e70 2c20 7073 2c20 7829  arams(np, ps, x)
+0008dac0: 3b0a 2020 2020 2020 2020 7d0a 0a20 2020  ;.        }..   
+0008dad0: 2020 2020 2067 676d 6c5f 6772 6170 685f       ggml_graph_
+0008dae0: 7265 7365 7420 2028 6766 293b 0a20 2020  reset  (gf);.   
+0008daf0: 2020 2020 2067 676d 6c5f 7365 745f 6633       ggml_set_f3
+0008db00: 3220 2020 2020 2028 662d 3e67 7261 642c  2      (f->grad,
+0008db10: 2031 2e30 6629 3b0a 0a20 2020 2020 2020   1.0f);..       
+0008db20: 2067 676d 6c5f 6772 6170 685f 636f 6d70   ggml_graph_comp
+0008db30: 7574 655f 7769 7468 5f63 7478 2863 7478  ute_with_ctx(ctx
+0008db40: 2c20 6762 2c20 7061 7261 6d73 2e6e 5f74  , gb, params.n_t
+0008db50: 6872 6561 6473 293b 0a0a 2020 2020 2020  hreads);..      
+0008db60: 2020 636f 6e73 7420 666c 6f61 7420 6678    const float fx
+0008db70: 203d 2067 676d 6c5f 6765 745f 6633 325f   = ggml_get_f32_
+0008db80: 3164 2866 2c20 3029 3b0a 0a20 2020 2020  1d(f, 0);..     
+0008db90: 2020 202f 2f20 6368 6563 6b20 636f 6e76     // check conv
+0008dba0: 6572 6765 6e63 650a 2020 2020 2020 2020  ergence.        
+0008dbb0: 6966 2028 6661 6273 6628 6678 202d 2066  if (fabsf(fx - f
+0008dbc0: 785f 7072 6576 5b30 5d29 2f66 7820 3c20  x_prev[0])/fx < 
+0008dbd0: 7061 7261 6d73 2e61 6461 6d2e 6570 735f  params.adam.eps_
+0008dbe0: 6629 207b 0a20 2020 2020 2020 2020 2020  f) {.           
+0008dbf0: 2047 474d 4c5f 5052 494e 545f 4445 4255   GGML_PRINT_DEBU
+0008dc00: 4728 2263 6f6e 7665 7267 6564 5c6e 2229  G("converged\n")
+0008dc10: 3b0a 0a20 2020 2020 2020 2020 2020 2072  ;..            r
+0008dc20: 6574 7572 6e20 4747 4d4c 5f4f 5054 5f4f  eturn GGML_OPT_O
+0008dc30: 4b3b 0a20 2020 2020 2020 207d 0a0a 2020  K;.        }..  
+0008dc40: 2020 2020 2020 2f2f 2064 656c 7461 2d62        // delta-b
+0008dc50: 6173 6564 2063 6f6e 7665 7267 656e 6365  ased convergence
+0008dc60: 2074 6573 740a 2020 2020 2020 2020 6966   test.        if
+0008dc70: 2028 7066 2021 3d20 4e55 4c4c 2920 7b0a   (pf != NULL) {.
+0008dc80: 2020 2020 2020 2020 2020 2020 2f2f 206e              // n
+0008dc90: 6565 6420 6174 206c 6561 7374 2070 6172  eed at least par
+0008dca0: 616d 732e 7061 7374 2069 7465 7261 7469  ams.past iterati
+0008dcb0: 6f6e 7320 746f 2073 7461 7274 2063 6865  ons to start che
+0008dcc0: 636b 696e 6720 666f 7220 636f 6e76 6572  cking for conver
+0008dcd0: 6765 6e63 650a 2020 2020 2020 2020 2020  gence.          
+0008dce0: 2020 6966 2028 7061 7261 6d73 2e70 6173    if (params.pas
+0008dcf0: 7420 3c3d 2069 7465 7230 202b 2074 2920  t <= iter0 + t) 
+0008dd00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008dd10: 2020 636f 6e73 7420 666c 6f61 7420 7261    const float ra
+0008dd20: 7465 203d 2028 7066 5b28 6974 6572 3020  te = (pf[(iter0 
+0008dd30: 2b20 7429 2570 6172 616d 732e 7061 7374  + t)%params.past
+0008dd40: 5d20 2d20 6678 292f 6678 3b0a 0a20 2020  ] - fx)/fx;..   
+0008dd50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0008dd60: 2866 6162 7366 2872 6174 6529 203c 2070  (fabsf(rate) < p
+0008dd70: 6172 616d 732e 6465 6c74 6129 207b 0a20  arams.delta) {. 
+0008dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008dd90: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
+0008dda0: 5054 5f4f 4b3b 0a20 2020 2020 2020 2020  PT_OK;.         
+0008ddb0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0008ddc0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+0008ddd0: 2020 2020 7066 5b28 6974 6572 3020 2b20      pf[(iter0 + 
+0008dde0: 7429 2570 6172 616d 732e 7061 7374 5d20  t)%params.past] 
+0008ddf0: 3d20 6678 3b0a 2020 2020 2020 2020 7d0a  = fx;.        }.
+0008de00: 0a20 2020 2020 2020 202f 2f20 6368 6563  .        // chec
+0008de10: 6b20 666f 7220 696d 7072 6f76 656d 656e  k for improvemen
+0008de20: 740a 2020 2020 2020 2020 6966 2028 7061  t.        if (pa
+0008de30: 7261 6d73 2e6d 6178 5f6e 6f5f 696d 7072  rams.max_no_impr
+0008de40: 6f76 656d 656e 7420 3e20 3029 207b 0a20  ovement > 0) {. 
+0008de50: 2020 2020 2020 2020 2020 2069 6620 2866             if (f
+0008de60: 785f 6265 7374 5b30 5d20 3e20 6678 2920  x_best[0] > fx) 
+0008de70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008de80: 2020 6678 5f62 6573 745b 305d 203d 2066    fx_best[0] = f
+0008de90: 783b 0a20 2020 2020 2020 2020 2020 2020  x;.             
+0008dea0: 2020 206e 5f6e 6f5f 696d 7072 6f76 656d     n_no_improvem
+0008deb0: 656e 745b 305d 203d 2030 3b0a 2020 2020  ent[0] = 0;.    
+0008dec0: 2020 2020 2020 2020 7d20 656c 7365 207b          } else {
+0008ded0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008dee0: 202b 2b6e 5f6e 6f5f 696d 7072 6f76 656d   ++n_no_improvem
+0008def0: 656e 745b 305d 3b0a 0a20 2020 2020 2020  ent[0];..       
+0008df00: 2020 2020 2020 2020 2069 6620 286e 5f6e           if (n_n
+0008df10: 6f5f 696d 7072 6f76 656d 656e 745b 305d  o_improvement[0]
+0008df20: 203e 3d20 7061 7261 6d73 2e6d 6178 5f6e   >= params.max_n
+0008df30: 6f5f 696d 7072 6f76 656d 656e 7429 207b  o_improvement) {
+0008df40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0008df50: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+0008df60: 5f4f 5054 5f4f 4b3b 0a20 2020 2020 2020  _OPT_OK;.       
+0008df70: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+0008df80: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0008df90: 207d 0a0a 2020 2020 2020 2020 6678 5f70   }..        fx_p
+0008dfa0: 7265 765b 305d 203d 2066 783b 0a0a 2020  rev[0] = fx;..  
+0008dfb0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0008dfc0: 2020 2020 636f 6e73 7420 696e 7436 345f      const int64_
+0008dfd0: 7420 745f 656e 645f 6370 7520 3d20 6767  t t_end_cpu = gg
+0008dfe0: 6d6c 5f63 7963 6c65 7328 293b 0a20 2020  ml_cycles();.   
+0008dff0: 2020 2020 2020 2020 2047 474d 4c5f 5052           GGML_PR
+0008e000: 494e 545f 4445 4255 4728 2274 696d 6520  INT_DEBUG("time 
+0008e010: 6974 6572 3a20 2020 2020 2025 352e 3366  iter:      %5.3f
+0008e020: 2073 5c6e 222c 2028 2866 6c6f 6174 2928   s\n", ((float)(
+0008e030: 745f 656e 645f 6370 7520 2d20 745f 7374  t_end_cpu - t_st
+0008e040: 6172 745f 6370 7529 292f 434c 4f43 4b53  art_cpu))/CLOCKS
+0008e050: 5f50 4552 5f53 4543 293b 0a20 2020 2020  _PER_SEC);.     
+0008e060: 2020 2020 2020 2055 4e55 5345 4428 745f         UNUSED(t_
+0008e070: 656e 645f 6370 7529 3b0a 0a20 2020 2020  end_cpu);..     
+0008e080: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0008e090: 3634 5f74 2074 5f65 6e64 5f77 616c 6c20  64_t t_end_wall 
+0008e0a0: 3d20 6767 6d6c 5f74 696d 655f 7573 2829  = ggml_time_us()
+0008e0b0: 3b0a 2020 2020 2020 2020 2020 2020 4747  ;.            GG
+0008e0c0: 4d4c 5f50 5249 4e54 5f44 4542 5547 2822  ML_PRINT_DEBUG("
+0008e0d0: 7761 6c6c 2074 696d 6520 6974 6572 3a20  wall time iter: 
+0008e0e0: 2535 2e33 6620 735c 6e22 2c20 2874 5f65  %5.3f s\n", (t_e
+0008e0f0: 6e64 5f77 616c 6c20 2d20 745f 7374 6172  nd_wall - t_star
+0008e100: 745f 7761 6c6c 292f 3165 3629 3b0a 2020  t_wall)/1e6);.  
+0008e110: 2020 2020 2020 2020 2020 554e 5553 4544            UNUSED
+0008e120: 2874 5f65 6e64 5f77 616c 6c29 3b0a 2020  (t_end_wall);.  
+0008e130: 2020 2020 2020 7d0a 2020 2020 7d0a 0a20        }.    }.. 
+0008e140: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
+0008e150: 5054 5f44 4944 5f4e 4f54 5f43 4f4e 5645  PT_DID_NOT_CONVE
+0008e160: 5247 453b 0a7d 0a0a 2f2f 0a2f 2f20 4c2d  RGE;.}..//.// L-
+0008e170: 4246 4753 0a2f 2f0a 2f2f 2074 6865 204c  BFGS.//.// the L
+0008e180: 2d42 4647 5320 696d 706c 656d 656e 7461  -BFGS implementa
+0008e190: 7469 6f6e 2062 656c 6f77 2069 7320 6261  tion below is ba
+0008e1a0: 7365 6420 6f6e 2074 6865 2066 6f6c 6c6f  sed on the follo
+0008e1b0: 7769 6e67 2069 6d70 6c65 6d65 6e74 6174  wing implementat
+0008e1c0: 696f 6e3a 0a2f 2f0a 2f2f 2020 2068 7474  ion:.//.//   htt
+0008e1d0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+0008e1e0: 6368 6f6b 6b61 6e2f 6c69 626c 6266 6773  chokkan/liblbfgs
+0008e1f0: 0a2f 2f0a 0a73 7472 7563 7420 6767 6d6c  .//..struct ggml
+0008e200: 5f6c 6266 6773 5f69 7465 7261 7469 6f6e  _lbfgs_iteration
+0008e210: 5f64 6174 6120 7b0a 2020 2020 666c 6f61  _data {.    floa
+0008e220: 7420 616c 7068 613b 0a20 2020 2066 6c6f  t alpha;.    flo
+0008e230: 6174 2079 733b 0a20 2020 2066 6c6f 6174  at ys;.    float
+0008e240: 202a 2073 3b0a 2020 2020 666c 6f61 7420   * s;.    float 
+0008e250: 2a20 793b 0a7d 3b0a 0a73 7461 7469 6320  * y;.};..static 
+0008e260: 656e 756d 2067 676d 6c5f 6f70 745f 7265  enum ggml_opt_re
+0008e270: 7375 6c74 206c 696e 6573 6561 7263 685f  sult linesearch_
+0008e280: 6261 636b 7472 6163 6b69 6e67 280a 2020  backtracking(.  
+0008e290: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008e2a0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+0008e2b0: 0a20 2020 2020 2020 2063 6f6e 7374 2073  .        const s
+0008e2c0: 7472 7563 7420 6767 6d6c 5f6f 7074 5f70  truct ggml_opt_p
+0008e2d0: 6172 616d 7320 2a20 7061 7261 6d73 2c0a  arams * params,.
+0008e2e0: 2020 2020 2020 2020 696e 7420 6e78 2c0a          int nx,.
+0008e2f0: 2020 2020 2020 2020 666c 6f61 7420 2a20          float * 
+0008e300: 782c 0a20 2020 2020 2020 2066 6c6f 6174  x,.        float
+0008e310: 202a 2066 782c 0a20 2020 2020 2020 2066   * fx,.        f
+0008e320: 6c6f 6174 202a 2067 2c0a 2020 2020 2020  loat * g,.      
+0008e330: 2020 666c 6f61 7420 2a20 642c 0a20 2020    float * d,.   
+0008e340: 2020 2020 2066 6c6f 6174 202a 2073 7465       float * ste
+0008e350: 702c 0a20 2020 2020 2020 2063 6f6e 7374  p,.        const
+0008e360: 2066 6c6f 6174 202a 2078 702c 0a20 2020   float * xp,.   
+0008e370: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0008e380: 5f74 656e 736f 7220 2a20 662c 0a20 2020  _tensor * f,.   
+0008e390: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
+0008e3a0: 5f63 6772 6170 6820 2a20 6766 2c0a 2020  _cgraph * gf,.  
+0008e3b0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+0008e3c0: 6c5f 6367 7261 7068 202a 2067 622c 0a20  l_cgraph * gb,. 
+0008e3d0: 2020 2020 2020 2063 6f6e 7374 2069 6e74         const int
+0008e3e0: 206e 702c 0a20 2020 2020 2020 2073 7472   np,.        str
+0008e3f0: 7563 7420 6767 6d6c 5f74 656e 736f 7220  uct ggml_tensor 
+0008e400: 2a20 7073 5b5d 2920 7b0a 2020 2020 696e  * ps[]) {.    in
+0008e410: 7420 636f 756e 7420 3d20 303b 0a0a 2020  t count = 0;..  
+0008e420: 2020 666c 6f61 7420 7769 6474 6820 203d    float width  =
+0008e430: 2030 2e30 663b 0a20 2020 2066 6c6f 6174   0.0f;.    float
+0008e440: 2064 6720 2020 2020 3d20 302e 3066 3b0a   dg     = 0.0f;.
+0008e450: 2020 2020 666c 6f61 7420 6669 6e69 7420      float finit 
+0008e460: 203d 2030 2e30 663b 0a20 2020 2066 6c6f   = 0.0f;.    flo
+0008e470: 6174 2064 6769 6e69 7420 3d20 302e 3066  at dginit = 0.0f
+0008e480: 3b0a 2020 2020 666c 6f61 7420 6467 7465  ;.    float dgte
+0008e490: 7374 203d 2030 2e30 663b 0a0a 2020 2020  st = 0.0f;..    
+0008e4a0: 636f 6e73 7420 666c 6f61 7420 6465 6320  const float dec 
+0008e4b0: 3d20 302e 3566 3b0a 2020 2020 636f 6e73  = 0.5f;.    cons
+0008e4c0: 7420 666c 6f61 7420 696e 6320 3d20 322e  t float inc = 2.
+0008e4d0: 3166 3b0a 0a20 2020 2069 6620 282a 7374  1f;..    if (*st
+0008e4e0: 6570 203c 3d20 302e 6629 207b 0a20 2020  ep <= 0.f) {.   
+0008e4f0: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+0008e500: 5f4c 494e 4553 4541 5243 485f 494e 5641  _LINESEARCH_INVA
+0008e510: 4c49 445f 5041 5241 4d45 5445 5253 3b0a  LID_PARAMETERS;.
+0008e520: 2020 2020 7d0a 0a20 2020 202f 2f20 636f      }..    // co
+0008e530: 6d70 7574 6520 7468 6520 696e 6974 6961  mpute the initia
+0008e540: 6c20 6772 6164 6965 6e74 2069 6e20 7468  l gradient in th
+0008e550: 6520 7365 6172 6368 2064 6972 6563 7469  e search directi
+0008e560: 6f6e 0a20 2020 2067 676d 6c5f 7665 635f  on.    ggml_vec_
+0008e570: 646f 745f 6633 3228 6e78 2c20 2664 6769  dot_f32(nx, &dgi
+0008e580: 6e69 742c 2067 2c20 6429 3b0a 0a20 2020  nit, g, d);..   
+0008e590: 202f 2f20 6d61 6b65 2073 7572 6520 7468   // make sure th
+0008e5a0: 6174 2064 2070 6f69 6e74 7320 746f 2061  at d points to a
+0008e5b0: 2064 6573 6365 6e74 2064 6972 6563 7469   descent directi
+0008e5c0: 6f6e 0a20 2020 2069 6620 2830 203c 2064  on.    if (0 < d
+0008e5d0: 6769 6e69 7429 207b 0a20 2020 2020 2020  ginit) {.       
+0008e5e0: 2072 6574 7572 6e20 4747 4d4c 5f4c 494e   return GGML_LIN
+0008e5f0: 4553 4541 5243 485f 4641 494c 3b0a 2020  ESEARCH_FAIL;.  
+0008e600: 2020 7d0a 0a20 2020 202f 2f20 696e 6974    }..    // init
+0008e610: 6961 6c69 7a65 206c 6f63 616c 2076 6172  ialize local var
+0008e620: 6961 626c 6573 0a20 2020 2066 696e 6974  iables.    finit
+0008e630: 203d 202a 6678 3b0a 2020 2020 6467 7465   = *fx;.    dgte
+0008e640: 7374 203d 2070 6172 616d 732d 3e6c 6266  st = params->lbf
+0008e650: 6773 2e66 746f 6c2a 6467 696e 6974 3b0a  gs.ftol*dginit;.
+0008e660: 0a20 2020 2077 6869 6c65 2028 7472 7565  .    while (true
+0008e670: 2920 7b0a 2020 2020 2020 2020 6767 6d6c  ) {.        ggml
+0008e680: 5f76 6563 5f63 7079 5f66 3332 286e 782c  _vec_cpy_f32(nx,
+0008e690: 2078 2c20 7870 293b 0a20 2020 2020 2020   x, xp);.       
+0008e6a0: 2067 676d 6c5f 7665 635f 6d61 645f 6633   ggml_vec_mad_f3
+0008e6b0: 3228 6e78 2c20 782c 2064 2c20 2a73 7465  2(nx, x, d, *ste
+0008e6c0: 7029 3b0a 0a20 2020 2020 2020 202f 2f20  p);..        // 
+0008e6d0: 6576 616c 7561 7465 2074 6865 2066 756e  evaluate the fun
+0008e6e0: 6374 696f 6e20 616e 6420 6772 6164 6965  ction and gradie
+0008e6f0: 6e74 2076 616c 7565 730a 2020 2020 2020  nt values.      
+0008e700: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0008e710: 6767 6d6c 5f6f 7074 5f73 6574 5f70 6172  ggml_opt_set_par
+0008e720: 616d 7328 6e70 2c20 7073 2c20 7829 3b0a  ams(np, ps, x);.
+0008e730: 0a20 2020 2020 2020 2020 2020 2067 676d  .            ggm
+0008e740: 6c5f 6772 6170 685f 7265 7365 7420 2028  l_graph_reset  (
+0008e750: 6766 293b 0a20 2020 2020 2020 2020 2020  gf);.           
+0008e760: 2067 676d 6c5f 7365 745f 6633 3220 2020   ggml_set_f32   
+0008e770: 2020 2028 662d 3e67 7261 642c 2031 2e30     (f->grad, 1.0
+0008e780: 6629 3b0a 0a20 2020 2020 2020 2020 2020  f);..           
+0008e790: 2067 676d 6c5f 6772 6170 685f 636f 6d70   ggml_graph_comp
+0008e7a0: 7574 655f 7769 7468 5f63 7478 2863 7478  ute_with_ctx(ctx
+0008e7b0: 2c20 6762 2c20 7061 7261 6d73 2d3e 6e5f  , gb, params->n_
+0008e7c0: 7468 7265 6164 7329 3b0a 0a20 2020 2020  threads);..     
+0008e7d0: 2020 2020 2020 2067 676d 6c5f 6f70 745f         ggml_opt_
+0008e7e0: 6765 745f 6772 6164 286e 702c 2070 732c  get_grad(np, ps,
+0008e7f0: 2067 293b 0a0a 2020 2020 2020 2020 2020   g);..          
+0008e800: 2020 2a66 7820 3d20 6767 6d6c 5f67 6574    *fx = ggml_get
+0008e810: 5f66 3332 5f31 6428 662c 2030 293b 0a20  _f32_1d(f, 0);. 
+0008e820: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+0008e830: 2020 2b2b 636f 756e 743b 0a0a 2020 2020    ++count;..    
+0008e840: 2020 2020 6966 2028 2a66 7820 3e20 6669      if (*fx > fi
+0008e850: 6e69 7420 2b20 282a 7374 6570 292a 6467  nit + (*step)*dg
+0008e860: 7465 7374 2920 7b0a 2020 2020 2020 2020  test) {.        
+0008e870: 2020 2020 7769 6474 6820 3d20 6465 633b      width = dec;
+0008e880: 0a20 2020 2020 2020 207d 2065 6c73 6520  .        } else 
+0008e890: 7b0a 2020 2020 2020 2020 2020 2020 2f2f  {.            //
+0008e8a0: 2041 726d 696a 6f20 636f 6e64 6974 696f   Armijo conditio
+0008e8b0: 6e20 6973 2073 6174 6973 6669 6564 0a20  n is satisfied. 
+0008e8c0: 2020 2020 2020 2020 2020 2069 6620 2870             if (p
+0008e8d0: 6172 616d 732d 3e6c 6266 6773 2e6c 696e  arams->lbfgs.lin
+0008e8e0: 6573 6561 7263 6820 3d3d 2047 474d 4c5f  esearch == GGML_
+0008e8f0: 4c49 4e45 5345 4152 4348 5f42 4143 4b54  LINESEARCH_BACKT
+0008e900: 5241 434b 494e 475f 4152 4d49 4a4f 2920  RACKING_ARMIJO) 
+0008e910: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008e920: 2020 7265 7475 726e 2063 6f75 6e74 3b0a    return count;.
+0008e930: 2020 2020 2020 2020 2020 2020 7d0a 0a20              }.. 
+0008e940: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+0008e950: 7665 635f 646f 745f 6633 3228 6e78 2c20  vec_dot_f32(nx, 
+0008e960: 2664 672c 2067 2c20 6429 3b0a 0a20 2020  &dg, g, d);..   
+0008e970: 2020 2020 2020 2020 202f 2f20 6368 6563           // chec
+0008e980: 6b20 7468 6520 576f 6c66 6520 636f 6e64  k the Wolfe cond
+0008e990: 6974 696f 6e0a 2020 2020 2020 2020 2020  ition.          
+0008e9a0: 2020 6966 2028 6467 203c 2070 6172 616d    if (dg < param
+0008e9b0: 732d 3e6c 6266 6773 2e77 6f6c 6665 202a  s->lbfgs.wolfe *
+0008e9c0: 2064 6769 6e69 7429 207b 0a20 2020 2020   dginit) {.     
+0008e9d0: 2020 2020 2020 2020 2020 2077 6964 7468             width
+0008e9e0: 203d 2069 6e63 3b0a 2020 2020 2020 2020   = inc;.        
+0008e9f0: 2020 2020 7d20 656c 7365 207b 0a20 2020      } else {.   
+0008ea00: 2020 2020 2020 2020 2020 2020 2069 6628               if(
+0008ea10: 7061 7261 6d73 2d3e 6c62 6667 732e 6c69  params->lbfgs.li
+0008ea20: 6e65 7365 6172 6368 203d 3d20 4747 4d4c  nesearch == GGML
+0008ea30: 5f4c 494e 4553 4541 5243 485f 4241 434b  _LINESEARCH_BACK
+0008ea40: 5452 4143 4b49 4e47 5f57 4f4c 4645 2920  TRACKING_WOLFE) 
+0008ea50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0008ea60: 2020 2020 2020 2f2f 2072 6567 756c 6172        // regular
+0008ea70: 2057 6f6c 6665 2063 6f6e 6469 7469 6f6e   Wolfe condition
+0008ea80: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0008ea90: 2020 2020 2020 7265 7475 726e 2063 6f75        return cou
+0008eaa0: 6e74 3b0a 2020 2020 2020 2020 2020 2020  nt;.            
+0008eab0: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+0008eac0: 2020 2020 2020 2069 6628 6467 203e 202d         if(dg > -
+0008ead0: 7061 7261 6d73 2d3e 6c62 6667 732e 776f  params->lbfgs.wo
+0008eae0: 6c66 652a 6467 696e 6974 2920 7b0a 2020  lfe*dginit) {.  
+0008eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008eb00: 2020 7769 6474 6820 3d20 6465 633b 0a20    width = dec;. 
+0008eb10: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+0008eb20: 2065 6c73 6520 7b0a 2020 2020 2020 2020   else {.        
+0008eb30: 2020 2020 2020 2020 2020 2020 2f2f 2073              // s
+0008eb40: 7472 6f6e 6720 576f 6c66 6520 636f 6e64  trong Wolfe cond
+0008eb50: 6974 696f 6e20 2847 474d 4c5f 4c49 4e45  ition (GGML_LINE
+0008eb60: 5345 4152 4348 5f42 4143 4b54 5241 434b  SEARCH_BACKTRACK
+0008eb70: 494e 475f 5354 524f 4e47 5f57 4f4c 4645  ING_STRONG_WOLFE
+0008eb80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0008eb90: 2020 2020 2020 7265 7475 726e 2063 6f75        return cou
+0008eba0: 6e74 3b0a 2020 2020 2020 2020 2020 2020  nt;.            
+0008ebb0: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0008ebc0: 2020 2020 2020 7265 7475 726e 2063 6f75        return cou
+0008ebd0: 6e74 3b0a 2020 2020 2020 2020 2020 2020  nt;.            
+0008ebe0: 7d0a 2020 2020 2020 2020 7d0a 0a20 2020  }.        }..   
+0008ebf0: 2020 2020 2069 6620 282a 7374 6570 203c       if (*step <
+0008ec00: 2070 6172 616d 732d 3e6c 6266 6773 2e6d   params->lbfgs.m
+0008ec10: 696e 5f73 7465 7029 207b 0a20 2020 2020  in_step) {.     
+0008ec20: 2020 2020 2020 2072 6574 7572 6e20 4747         return GG
+0008ec30: 4d4c 5f4c 494e 4553 4541 5243 485f 4d49  ML_LINESEARCH_MI
+0008ec40: 4e49 4d55 4d5f 5354 4550 3b0a 2020 2020  NIMUM_STEP;.    
+0008ec50: 2020 2020 7d0a 2020 2020 2020 2020 6966      }.        if
+0008ec60: 2028 2a73 7465 7020 3e20 7061 7261 6d73   (*step > params
+0008ec70: 2d3e 6c62 6667 732e 6d61 785f 7374 6570  ->lbfgs.max_step
+0008ec80: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008ec90: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
+0008eca0: 5345 4152 4348 5f4d 4158 494d 554d 5f53  SEARCH_MAXIMUM_S
+0008ecb0: 5445 503b 0a20 2020 2020 2020 207d 0a20  TEP;.        }. 
+0008ecc0: 2020 2020 2020 2069 6620 2870 6172 616d         if (param
+0008ecd0: 732d 3e6c 6266 6773 2e6d 6178 5f6c 696e  s->lbfgs.max_lin
+0008ece0: 6573 6561 7263 6820 3c3d 2063 6f75 6e74  esearch <= count
+0008ecf0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008ed00: 7265 7475 726e 2047 474d 4c5f 4c49 4e45  return GGML_LINE
+0008ed10: 5345 4152 4348 5f4d 4158 494d 554d 5f49  SEARCH_MAXIMUM_I
+0008ed20: 5445 5241 5449 4f4e 533b 0a20 2020 2020  TERATIONS;.     
+0008ed30: 2020 207d 0a0a 2020 2020 2020 2020 282a     }..        (*
+0008ed40: 7374 6570 2920 2a3d 2077 6964 7468 3b0a  step) *= width;.
+0008ed50: 2020 2020 7d0a 0a20 2020 2072 6574 7572      }..    retur
+0008ed60: 6e20 4747 4d4c 5f4c 494e 4553 4541 5243  n GGML_LINESEARC
+0008ed70: 485f 4641 494c 3b0a 7d0a 0a73 7461 7469  H_FAIL;.}..stati
+0008ed80: 6320 656e 756d 2067 676d 6c5f 6f70 745f  c enum ggml_opt_
+0008ed90: 7265 7375 6c74 2067 676d 6c5f 6f70 745f  result ggml_opt_
+0008eda0: 6c62 6667 7328 0a20 2020 2020 2020 2073  lbfgs(.        s
+0008edb0: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+0008edc0: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+0008edd0: 2020 7374 7275 6374 2067 676d 6c5f 6f70    struct ggml_op
+0008ede0: 745f 636f 6e74 6578 7420 2a20 6f70 742c  t_context * opt,
+0008edf0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+0008ee00: 6767 6d6c 5f6f 7074 5f70 6172 616d 7320  ggml_opt_params 
+0008ee10: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+0008ee20: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+0008ee30: 6f72 202a 2066 2c0a 2020 2020 2020 2020  or * f,.        
+0008ee40: 7374 7275 6374 2067 676d 6c5f 6367 7261  struct ggml_cgra
+0008ee50: 7068 202a 2067 662c 0a20 2020 2020 2020  ph * gf,.       
+0008ee60: 2073 7472 7563 7420 6767 6d6c 5f63 6772   struct ggml_cgr
+0008ee70: 6170 6820 2a20 6762 2920 7b0a 2020 2020  aph * gb) {.    
+0008ee80: 6966 2028 7061 7261 6d73 2e6c 6266 6773  if (params.lbfgs
+0008ee90: 2e6c 696e 6573 6561 7263 6820 3d3d 2047  .linesearch == G
+0008eea0: 474d 4c5f 4c49 4e45 5345 4152 4348 5f42  GML_LINESEARCH_B
+0008eeb0: 4143 4b54 5241 434b 494e 475f 574f 4c46  ACKTRACKING_WOLF
+0008eec0: 4520 7c7c 0a20 2020 2020 2020 2070 6172  E ||.        par
+0008eed0: 616d 732e 6c62 6667 732e 6c69 6e65 7365  ams.lbfgs.linese
+0008eee0: 6172 6368 203d 3d20 4747 4d4c 5f4c 494e  arch == GGML_LIN
+0008eef0: 4553 4541 5243 485f 4241 434b 5452 4143  ESEARCH_BACKTRAC
+0008ef00: 4b49 4e47 5f53 5452 4f4e 475f 574f 4c46  KING_STRONG_WOLF
+0008ef10: 4529 207b 0a20 2020 2020 2020 2069 6620  E) {.        if 
+0008ef20: 2870 6172 616d 732e 6c62 6667 732e 776f  (params.lbfgs.wo
+0008ef30: 6c66 6520 3c3d 2070 6172 616d 732e 6c62  lfe <= params.lb
+0008ef40: 6667 732e 6674 6f6c 207c 7c20 312e 6620  fgs.ftol || 1.f 
+0008ef50: 3c3d 2070 6172 616d 732e 6c62 6667 732e  <= params.lbfgs.
+0008ef60: 776f 6c66 6529 207b 0a20 2020 2020 2020  wolfe) {.       
+0008ef70: 2020 2020 2072 6574 7572 6e20 4747 4d4c       return GGML
+0008ef80: 5f4f 5054 5f49 4e56 414c 4944 5f57 4f4c  _OPT_INVALID_WOL
+0008ef90: 4645 3b0a 2020 2020 2020 2020 7d0a 2020  FE;.        }.  
+0008efa0: 2020 7d0a 0a20 2020 2063 6f6e 7374 2069    }..    const i
+0008efb0: 6e74 206d 203d 2070 6172 616d 732e 6c62  nt m = params.lb
+0008efc0: 6667 732e 6d3b 0a0a 2020 2020 2f2f 2074  fgs.m;..    // t
+0008efd0: 6865 7365 2077 696c 6c20 7374 6f72 6520  hese will store 
+0008efe0: 7468 6520 7061 7261 6d65 7465 7273 2077  the parameters w
+0008eff0: 6520 7761 6e74 2074 6f20 6f70 7469 6d69  e want to optimi
+0008f000: 7a65 0a20 2020 2073 7472 7563 7420 6767  ze.    struct gg
+0008f010: 6d6c 5f74 656e 736f 7220 2a20 7073 5b47  ml_tensor * ps[G
+0008f020: 474d 4c5f 4d41 585f 5041 5241 4d53 5d3b  GML_MAX_PARAMS];
+0008f030: 0a0a 2020 2020 696e 7420 6e70 203d 2030  ..    int np = 0
+0008f040: 3b0a 2020 2020 696e 7420 6e78 203d 2030  ;.    int nx = 0
+0008f050: 3b0a 2020 2020 666f 7220 2869 6e74 2069  ;.    for (int i
+0008f060: 203d 2030 3b20 6920 3c20 6766 2d3e 6e5f   = 0; i < gf->n_
+0008f070: 6e6f 6465 733b 202b 2b69 2920 7b0a 2020  nodes; ++i) {.  
+0008f080: 2020 2020 2020 6966 2028 6766 2d3e 6e6f        if (gf->no
+0008f090: 6465 735b 695d 2d3e 6973 5f70 6172 616d  des[i]->is_param
+0008f0a0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+0008f0b0: 4747 4d4c 5f50 5249 4e54 5f44 4542 5547  GGML_PRINT_DEBUG
+0008f0c0: 2822 666f 756e 6420 7061 7261 6d20 2564  ("found param %d
+0008f0d0: 3a20 6772 6164 2d3e 6f70 203d 2025 645c  : grad->op = %d\
+0008f0e0: 6e22 2c20 6e70 2c20 6766 2d3e 6e6f 6465  n", np, gf->node
+0008f0f0: 735b 695d 2d3e 6772 6164 2d3e 6f70 293b  s[i]->grad->op);
+0008f100: 0a0a 2020 2020 2020 2020 2020 2020 4747  ..            GG
+0008f110: 4d4c 5f41 5353 4552 5428 6e70 203c 2047  ML_ASSERT(np < G
+0008f120: 474d 4c5f 4d41 585f 5041 5241 4d53 293b  GML_MAX_PARAMS);
+0008f130: 0a0a 2020 2020 2020 2020 2020 2020 7073  ..            ps
+0008f140: 5b6e 702b 2b5d 203d 2067 662d 3e6e 6f64  [np++] = gf->nod
+0008f150: 6573 5b69 5d3b 0a20 2020 2020 2020 2020  es[i];.         
+0008f160: 2020 206e 7820 2b3d 2067 676d 6c5f 6e65     nx += ggml_ne
+0008f170: 6c65 6d65 6e74 7328 6766 2d3e 6e6f 6465  lements(gf->node
+0008f180: 735b 695d 293b 0a20 2020 2020 2020 207d  s[i]);.        }
+0008f190: 0a20 2020 207d 0a0a 2020 2020 6966 2028  .    }..    if (
+0008f1a0: 286f 7074 2d3e 7061 7261 6d73 2e74 7970  (opt->params.typ
+0008f1b0: 6520 213d 2070 6172 616d 732e 7479 7065  e != params.type
+0008f1c0: 2920 7c7c 2028 6f70 742d 3e6e 7820 213d  ) || (opt->nx !=
+0008f1d0: 206e 7829 207c 7c20 286f 7074 2d3e 7061   nx) || (opt->pa
+0008f1e0: 7261 6d73 2e70 6173 7420 213d 2070 6172  rams.past != par
+0008f1f0: 616d 732e 7061 7374 2920 7c7c 2028 6f70  ams.past) || (op
+0008f200: 742d 3e70 6172 616d 732e 6c62 6667 732e  t->params.lbfgs.
+0008f210: 6d20 213d 2070 6172 616d 732e 6c62 6667  m != params.lbfg
+0008f220: 732e 6d29 2920 7b0a 2020 2020 2020 2020  s.m)) {.        
+0008f230: 696e 7420 6974 6572 203d 206f 7074 2d3e  int iter = opt->
+0008f240: 6974 6572 3b0a 2020 2020 2020 2020 6767  iter;.        gg
+0008f250: 6d6c 5f6f 7074 5f69 6e69 7428 6374 782c  ml_opt_init(ctx,
+0008f260: 206f 7074 2c20 7061 7261 6d73 2c20 6e78   opt, params, nx
+0008f270: 293b 0a20 2020 2020 2020 206f 7074 2d3e  );.        opt->
+0008f280: 6974 6572 203d 2069 7465 723b 0a20 2020  iter = iter;.   
+0008f290: 207d 0a0a 2020 2020 666c 6f61 7420 2a20   }..    float * 
+0008f2a0: 7820 203d 206f 7074 2d3e 6c62 6667 732e  x  = opt->lbfgs.
+0008f2b0: 782d 3e64 6174 613b 2020 2f2f 2063 7572  x->data;  // cur
+0008f2c0: 7265 6e74 2070 6172 616d 6574 6572 730a  rent parameters.
+0008f2d0: 2020 2020 666c 6f61 7420 2a20 7870 203d      float * xp =
+0008f2e0: 206f 7074 2d3e 6c62 6667 732e 7870 2d3e   opt->lbfgs.xp->
+0008f2f0: 6461 7461 3b20 2f2f 2070 7265 7669 6f75  data; // previou
+0008f300: 7320 7061 7261 6d65 7465 7273 0a20 2020  s parameters.   
+0008f310: 2066 6c6f 6174 202a 2067 2020 3d20 6f70   float * g  = op
+0008f320: 742d 3e6c 6266 6773 2e67 2d3e 6461 7461  t->lbfgs.g->data
+0008f330: 3b20 202f 2f20 6375 7272 656e 7420 6772  ;  // current gr
+0008f340: 6164 6965 6e74 0a20 2020 2066 6c6f 6174  adient.    float
+0008f350: 202a 2067 7020 3d20 6f70 742d 3e6c 6266   * gp = opt->lbf
+0008f360: 6773 2e67 702d 3e64 6174 613b 202f 2f20  gs.gp->data; // 
+0008f370: 7072 6576 696f 7573 2067 7261 6469 656e  previous gradien
+0008f380: 740a 2020 2020 666c 6f61 7420 2a20 6420  t.    float * d 
+0008f390: 203d 206f 7074 2d3e 6c62 6667 732e 642d   = opt->lbfgs.d-
+0008f3a0: 3e64 6174 613b 2020 2f2f 2073 6561 7263  >data;  // searc
+0008f3b0: 6820 6469 7265 6374 696f 6e0a 0a20 2020  h direction..   
+0008f3c0: 2066 6c6f 6174 202a 2070 6620 3d20 7061   float * pf = pa
+0008f3d0: 7261 6d73 2e70 6173 7420 3e20 3020 3f20  rams.past > 0 ? 
+0008f3e0: 6f70 742d 3e6c 6266 6773 2e70 662d 3e64  opt->lbfgs.pf->d
+0008f3f0: 6174 6120 3a20 4e55 4c4c 3b20 2f2f 2070  ata : NULL; // p
+0008f400: 6173 7420 6675 6e63 7469 6f6e 2076 616c  ast function val
+0008f410: 7565 730a 0a20 2020 2066 6c6f 6174 2066  ues..    float f
+0008f420: 7820 2020 203d 2030 2e30 663b 202f 2f20  x    = 0.0f; // 
+0008f430: 636f 7374 2066 756e 6374 696f 6e20 7661  cost function va
+0008f440: 6c75 650a 2020 2020 666c 6f61 7420 786e  lue.    float xn
+0008f450: 6f72 6d20 3d20 302e 3066 3b20 2f2f 207c  orm = 0.0f; // |
+0008f460: 7c78 7c7c 0a20 2020 2066 6c6f 6174 2067  |x||.    float g
+0008f470: 6e6f 726d 203d 2030 2e30 663b 202f 2f20  norm = 0.0f; // 
+0008f480: 7c7c 677c 7c0a 0a20 2020 202f 2f20 696e  ||g||..    // in
+0008f490: 6974 6961 6c69 7a65 2078 2066 726f 6d20  itialize x from 
+0008f4a0: 7468 6520 6772 6170 6820 6e6f 6465 730a  the graph nodes.
+0008f4b0: 2020 2020 6767 6d6c 5f6f 7074 5f67 6574      ggml_opt_get
+0008f4c0: 5f70 6172 616d 7328 6e70 2c20 7073 2c20  _params(np, ps, 
+0008f4d0: 7829 3b0a 0a20 2020 202f 2f20 7468 6520  x);..    // the 
+0008f4e0: 4c2d 4246 4753 206d 656d 6f72 790a 2020  L-BFGS memory.  
+0008f4f0: 2020 666c 6f61 7420 2a20 6c6d 5f61 6c70    float * lm_alp
+0008f500: 6861 203d 206f 7074 2d3e 6c62 6667 732e  ha = opt->lbfgs.
+0008f510: 6c6d 616c 2d3e 6461 7461 3b0a 2020 2020  lmal->data;.    
+0008f520: 666c 6f61 7420 2a20 6c6d 5f79 7320 2020  float * lm_ys   
+0008f530: 203d 206f 7074 2d3e 6c62 6667 732e 6c6d   = opt->lbfgs.lm
+0008f540: 7973 2d3e 6461 7461 3b0a 2020 2020 666c  ys->data;.    fl
+0008f550: 6f61 7420 2a20 6c6d 5f73 2020 2020 203d  oat * lm_s     =
+0008f560: 206f 7074 2d3e 6c62 6667 732e 6c6d 732d   opt->lbfgs.lms-
+0008f570: 3e64 6174 613b 0a20 2020 2066 6c6f 6174  >data;.    float
+0008f580: 202a 206c 6d5f 7920 2020 2020 3d20 6f70   * lm_y     = op
+0008f590: 742d 3e6c 6266 6773 2e6c 6d79 2d3e 6461  t->lbfgs.lmy->da
+0008f5a0: 7461 3b0a 0a20 2020 202f 2f20 6576 616c  ta;..    // eval
+0008f5b0: 7561 7465 2074 6865 2066 756e 6374 696f  uate the functio
+0008f5c0: 6e20 7661 6c75 6520 616e 6420 6974 7320  n value and its 
+0008f5d0: 6772 6164 6965 6e74 0a20 2020 207b 0a20  gradient.    {. 
+0008f5e0: 2020 2020 2020 2067 676d 6c5f 6f70 745f         ggml_opt_
+0008f5f0: 7365 745f 7061 7261 6d73 286e 702c 2070  set_params(np, p
+0008f600: 732c 2078 293b 0a0a 2020 2020 2020 2020  s, x);..        
+0008f610: 6767 6d6c 5f67 7261 7068 5f72 6573 6574  ggml_graph_reset
+0008f620: 2020 2867 6629 3b0a 2020 2020 2020 2020    (gf);.        
+0008f630: 6767 6d6c 5f73 6574 5f66 3332 2020 2020  ggml_set_f32    
+0008f640: 2020 2866 2d3e 6772 6164 2c20 312e 3066    (f->grad, 1.0f
+0008f650: 293b 0a0a 2020 2020 2020 2020 6767 6d6c  );..        ggml
+0008f660: 5f67 7261 7068 5f63 6f6d 7075 7465 5f77  _graph_compute_w
+0008f670: 6974 685f 6374 7828 6374 782c 2067 622c  ith_ctx(ctx, gb,
+0008f680: 2070 6172 616d 732e 6e5f 7468 7265 6164   params.n_thread
+0008f690: 7329 3b0a 0a20 2020 2020 2020 2067 676d  s);..        ggm
+0008f6a0: 6c5f 6f70 745f 6765 745f 6772 6164 286e  l_opt_get_grad(n
+0008f6b0: 702c 2070 732c 2067 293b 0a0a 2020 2020  p, ps, g);..    
+0008f6c0: 2020 2020 6678 203d 2067 676d 6c5f 6765      fx = ggml_ge
+0008f6d0: 745f 6633 325f 3164 2866 2c20 3029 3b0a  t_f32_1d(f, 0);.
+0008f6e0: 2020 2020 7d0a 0a20 2020 202f 2f20 7365      }..    // se
+0008f6f0: 6172 6368 2064 6972 6563 7469 6f6e 203d  arch direction =
+0008f700: 202d 6772 6164 6965 6e74 0a20 2020 2067   -gradient.    g
+0008f710: 676d 6c5f 7665 635f 6e65 675f 6633 3228  gml_vec_neg_f32(
+0008f720: 6e78 2c20 642c 2067 293b 0a0a 2020 2020  nx, d, g);..    
+0008f730: 2f2f 207c 7c78 7c7c 2c20 7c7c 677c 7c0a  // ||x||, ||g||.
+0008f740: 2020 2020 6767 6d6c 5f76 6563 5f6e 6f72      ggml_vec_nor
+0008f750: 6d5f 6633 3228 6e78 2c20 2678 6e6f 726d  m_f32(nx, &xnorm
+0008f760: 2c20 7829 3b0a 2020 2020 6767 6d6c 5f76  , x);.    ggml_v
+0008f770: 6563 5f6e 6f72 6d5f 6633 3228 6e78 2c20  ec_norm_f32(nx, 
+0008f780: 2667 6e6f 726d 2c20 6729 3b0a 0a20 2020  &gnorm, g);..   
+0008f790: 2069 6620 2878 6e6f 726d 203c 2031 2e30   if (xnorm < 1.0
+0008f7a0: 6629 207b 0a20 2020 2020 2020 2078 6e6f  f) {.        xno
+0008f7b0: 726d 203d 2031 2e30 663b 0a20 2020 207d  rm = 1.0f;.    }
+0008f7c0: 0a0a 2020 2020 2f2f 2061 6c72 6561 6479  ..    // already
+0008f7d0: 206f 7074 696d 697a 6564 0a20 2020 2069   optimized.    i
+0008f7e0: 6620 2867 6e6f 726d 2f78 6e6f 726d 203c  f (gnorm/xnorm <
+0008f7f0: 3d20 7061 7261 6d73 2e6c 6266 6773 2e65  = params.lbfgs.e
+0008f800: 7073 2920 7b0a 2020 2020 2020 2020 7265  ps) {.        re
+0008f810: 7475 726e 2047 474d 4c5f 4f50 545f 4f4b  turn GGML_OPT_OK
+0008f820: 3b0a 2020 2020 7d0a 0a20 2020 2069 6620  ;.    }..    if 
+0008f830: 286f 7074 2d3e 6a75 7374 5f69 6e69 7469  (opt->just_initi
+0008f840: 616c 697a 6564 2920 7b0a 2020 2020 2020  alized) {.      
+0008f850: 2020 6966 2028 7066 2920 7b0a 2020 2020    if (pf) {.    
+0008f860: 2020 2020 2020 2020 7066 5b30 5d20 3d20          pf[0] = 
+0008f870: 6678 3b0a 2020 2020 2020 2020 7d0a 2020  fx;.        }.  
+0008f880: 2020 2020 2020 6f70 742d 3e6c 6266 6773        opt->lbfgs
+0008f890: 2e66 785f 6265 7374 203d 2066 783b 0a0a  .fx_best = fx;..
+0008f8a0: 2020 2020 2020 2020 2f2f 2069 6e69 7469          // initi
+0008f8b0: 616c 2073 7465 700a 2020 2020 2020 2020  al step.        
+0008f8c0: 6767 6d6c 5f76 6563 5f6e 6f72 6d5f 696e  ggml_vec_norm_in
+0008f8d0: 765f 6633 3228 6e78 2c20 266f 7074 2d3e  v_f32(nx, &opt->
+0008f8e0: 6c62 6667 732e 7374 6570 2c20 6429 3b0a  lbfgs.step, d);.
+0008f8f0: 2020 2020 2020 2020 6f70 742d 3e6c 6266          opt->lbf
+0008f900: 6773 2e6a 2020 2020 2020 2020 2020 2020  gs.j            
+0008f910: 2020 2020 3d20 303b 0a20 2020 2020 2020      = 0;.       
+0008f920: 206f 7074 2d3e 6c62 6667 732e 6b20 2020   opt->lbfgs.k   
+0008f930: 2020 2020 2020 2020 2020 2020 203d 2031               = 1
+0008f940: 3b0a 2020 2020 2020 2020 6f70 742d 3e6c  ;.        opt->l
+0008f950: 6266 6773 2e65 6e64 2020 2020 2020 2020  bfgs.end        
+0008f960: 2020 2020 2020 3d20 303b 0a20 2020 2020        = 0;.     
+0008f970: 2020 206f 7074 2d3e 6c62 6667 732e 6e5f     opt->lbfgs.n_
+0008f980: 6e6f 5f69 6d70 726f 7665 6d65 6e74 203d  no_improvement =
+0008f990: 2030 3b0a 2020 2020 2020 2020 6f70 742d   0;.        opt-
+0008f9a0: 3e6a 7573 745f 696e 6974 6961 6c69 7a65  >just_initialize
+0008f9b0: 6420 2020 2020 2020 3d20 6661 6c73 653b  d       = false;
+0008f9c0: 0a20 2020 207d 0a0a 2020 2020 666c 6f61  .    }..    floa
+0008f9d0: 7420 2a20 6678 5f62 6573 7420 2020 2020  t * fx_best     
+0008f9e0: 2020 203d 2026 6f70 742d 3e6c 6266 6773     = &opt->lbfgs
+0008f9f0: 2e66 785f 6265 7374 3b0a 2020 2020 666c  .fx_best;.    fl
+0008fa00: 6f61 7420 2a20 7374 6570 2020 2020 2020  oat * step      
+0008fa10: 2020 2020 203d 2026 6f70 742d 3e6c 6266       = &opt->lbf
+0008fa20: 6773 2e73 7465 703b 0a20 2020 2069 6e74  gs.step;.    int
+0008fa30: 202a 206a 2020 2020 2020 2020 2020 2020   * j            
+0008fa40: 2020 2020 3d20 266f 7074 2d3e 6c62 6667      = &opt->lbfg
+0008fa50: 732e 6a3b 0a20 2020 2069 6e74 202a 206b  s.j;.    int * k
+0008fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008fa70: 3d20 266f 7074 2d3e 6c62 6667 732e 6b3b  = &opt->lbfgs.k;
+0008fa80: 0a20 2020 2069 6e74 202a 2065 6e64 2020  .    int * end  
+0008fa90: 2020 2020 2020 2020 2020 2020 3d20 266f              = &o
+0008faa0: 7074 2d3e 6c62 6667 732e 656e 643b 0a20  pt->lbfgs.end;. 
+0008fab0: 2020 2069 6e74 202a 206e 5f6e 6f5f 696d     int * n_no_im
+0008fac0: 7072 6f76 656d 656e 7420 3d20 266f 7074  provement = &opt
+0008fad0: 2d3e 6c62 6667 732e 6e5f 6e6f 5f69 6d70  ->lbfgs.n_no_imp
+0008fae0: 726f 7665 6d65 6e74 3b0a 0a20 2020 2069  rovement;..    i
+0008faf0: 6e74 206c 7320 2020 2020 3d20 303b 0a20  nt ls     = 0;. 
+0008fb00: 2020 2069 6e74 2062 6f75 6e64 2020 3d20     int bound  = 
+0008fb10: 303b 0a0a 2020 2020 666c 6f61 7420 7973  0;..    float ys
+0008fb20: 2020 203d 2030 2e30 663b 0a20 2020 2066     = 0.0f;.    f
+0008fb30: 6c6f 6174 2079 7920 2020 3d20 302e 3066  loat yy   = 0.0f
+0008fb40: 3b0a 2020 2020 666c 6f61 7420 6265 7461  ;.    float beta
+0008fb50: 203d 2030 2e30 663b 0a0a 2020 2020 696e   = 0.0f;..    in
+0008fb60: 7420 6974 203d 2030 3b0a 0a20 2020 2077  t it = 0;..    w
+0008fb70: 6869 6c65 2028 7472 7565 2920 7b0a 2020  hile (true) {.  
+0008fb80: 2020 2020 2020 2f2f 2073 746f 7265 2074        // store t
+0008fb90: 6865 2063 7572 7265 6e74 2070 6f73 6974  he current posit
+0008fba0: 696f 6e20 616e 6420 6772 6164 6965 6e74  ion and gradient
+0008fbb0: 2076 6563 746f 7273 0a20 2020 2020 2020   vectors.       
+0008fbc0: 2067 676d 6c5f 7665 635f 6370 795f 6633   ggml_vec_cpy_f3
+0008fbd0: 3228 6e78 2c20 7870 2c20 7829 3b0a 2020  2(nx, xp, x);.  
+0008fbe0: 2020 2020 2020 6767 6d6c 5f76 6563 5f63        ggml_vec_c
+0008fbf0: 7079 5f66 3332 286e 782c 2067 702c 2067  py_f32(nx, gp, g
+0008fc00: 293b 0a0a 2020 2020 2020 2020 6c73 203d  );..        ls =
+0008fc10: 206c 696e 6573 6561 7263 685f 6261 636b   linesearch_back
+0008fc20: 7472 6163 6b69 6e67 2863 7478 2c20 2670  tracking(ctx, &p
+0008fc30: 6172 616d 732c 206e 782c 2078 2c20 2666  arams, nx, x, &f
+0008fc40: 782c 2067 2c20 642c 2073 7465 702c 2078  x, g, d, step, x
+0008fc50: 702c 2066 2c20 6766 2c20 6762 2c20 6e70  p, f, gf, gb, np
+0008fc60: 2c20 7073 293b 0a0a 2020 2020 2020 2020  , ps);..        
+0008fc70: 6966 2028 6c73 203c 2030 2920 7b0a 2020  if (ls < 0) {.  
+0008fc80: 2020 2020 2020 2020 2020 2f2f 206c 696e            // lin
+0008fc90: 6573 6561 7263 6820 6661 696c 6564 202d  esearch failed -
+0008fca0: 2067 6f20 6261 636b 2074 6f20 7468 6520   go back to the 
+0008fcb0: 7072 6576 696f 7573 2070 6f69 6e74 2061  previous point a
+0008fcc0: 6e64 2072 6574 7572 6e0a 2020 2020 2020  nd return.      
+0008fcd0: 2020 2020 2020 6767 6d6c 5f76 6563 5f63        ggml_vec_c
+0008fce0: 7079 5f66 3332 286e 782c 2078 2c20 7870  py_f32(nx, x, xp
+0008fcf0: 293b 0a20 2020 2020 2020 2020 2020 2067  );.            g
+0008fd00: 676d 6c5f 7665 635f 6370 795f 6633 3228  gml_vec_cpy_f32(
+0008fd10: 6e78 2c20 672c 2067 7029 3b0a 0a20 2020  nx, g, gp);..   
+0008fd20: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0008fd30: 6c73 3b0a 2020 2020 2020 2020 7d0a 0a20  ls;.        }.. 
+0008fd40: 2020 2020 2020 2067 676d 6c5f 7665 635f         ggml_vec_
+0008fd50: 6e6f 726d 5f66 3332 286e 782c 2026 786e  norm_f32(nx, &xn
+0008fd60: 6f72 6d2c 2078 293b 0a20 2020 2020 2020  orm, x);.       
+0008fd70: 2067 676d 6c5f 7665 635f 6e6f 726d 5f66   ggml_vec_norm_f
+0008fd80: 3332 286e 782c 2026 676e 6f72 6d2c 2067  32(nx, &gnorm, g
+0008fd90: 293b 0a0a 2020 2020 2020 2020 4747 4d4c  );..        GGML
+0008fda0: 5f50 5249 4e54 5f44 4542 5547 2822 6620  _PRINT_DEBUG("f 
+0008fdb0: 3d20 2531 302e 3666 5c6e 222c 2067 676d  = %10.6f\n", ggm
+0008fdc0: 6c5f 6765 745f 6633 325f 3164 2866 2c20  l_get_f32_1d(f, 
+0008fdd0: 3029 293b 0a0a 2020 2020 2020 2020 6966  0));..        if
+0008fde0: 2028 786e 6f72 6d20 3c20 312e 3066 2920   (xnorm < 1.0f) 
+0008fdf0: 7b0a 2020 2020 2020 2020 2020 2020 786e  {.            xn
+0008fe00: 6f72 6d20 3d20 312e 3066 3b0a 2020 2020  orm = 1.0f;.    
+0008fe10: 2020 2020 7d0a 2020 2020 2020 2020 6966      }.        if
+0008fe20: 2028 676e 6f72 6d2f 786e 6f72 6d20 3c3d   (gnorm/xnorm <=
+0008fe30: 2070 6172 616d 732e 6c62 6667 732e 6570   params.lbfgs.ep
+0008fe40: 7329 207b 0a20 2020 2020 2020 2020 2020  s) {.           
+0008fe50: 202f 2f20 636f 6e76 6572 6765 640a 2020   // converged.  
+0008fe60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0008fe70: 2047 474d 4c5f 4f50 545f 4f4b 3b0a 2020   GGML_OPT_OK;.  
+0008fe80: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+0008fe90: 202f 2f20 6465 6c74 612d 6261 7365 6420   // delta-based 
+0008fea0: 636f 6e76 6572 6765 6e63 6520 7465 7374  convergence test
+0008feb0: 0a20 2020 2020 2020 2069 6620 2870 6620  .        if (pf 
+0008fec0: 213d 204e 554c 4c29 207b 0a20 2020 2020  != NULL) {.     
+0008fed0: 2020 2020 2020 202f 2f20 6e65 6564 2061         // need a
+0008fee0: 7420 6c65 6173 7420 7061 7261 6d73 2e70  t least params.p
+0008fef0: 6173 7420 6974 6572 6174 696f 6e73 2074  ast iterations t
+0008ff00: 6f20 7374 6172 7420 6368 6563 6b69 6e67  o start checking
+0008ff10: 2066 6f72 2063 6f6e 7665 7267 656e 6365   for convergence
+0008ff20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0008ff30: 2870 6172 616d 732e 7061 7374 203c 3d20  (params.past <= 
+0008ff40: 6b5b 305d 2920 7b0a 2020 2020 2020 2020  k[0]) {.        
+0008ff50: 2020 2020 2020 2020 636f 6e73 7420 666c          const fl
+0008ff60: 6f61 7420 7261 7465 203d 2028 7066 5b6b  oat rate = (pf[k
+0008ff70: 5b30 5d25 7061 7261 6d73 2e70 6173 745d  [0]%params.past]
+0008ff80: 202d 2066 7829 2f66 783b 0a0a 2020 2020   - fx)/fx;..    
+0008ff90: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+0008ffa0: 6661 6273 6628 7261 7465 2920 3c20 7061  fabsf(rate) < pa
+0008ffb0: 7261 6d73 2e64 656c 7461 2920 7b0a 2020  rams.delta) {.  
+0008ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0008ffd0: 2020 7265 7475 726e 2047 474d 4c5f 4f50    return GGML_OP
+0008ffe0: 545f 4f4b 3b0a 2020 2020 2020 2020 2020  T_OK;.          
+0008fff0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00090000: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00090010: 2020 2070 665b 6b5b 305d 2570 6172 616d     pf[k[0]%param
+00090020: 732e 7061 7374 5d20 3d20 6678 3b0a 2020  s.past] = fx;.  
+00090030: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00090040: 202f 2f20 6368 6563 6b20 666f 7220 696d   // check for im
+00090050: 7072 6f76 656d 656e 740a 2020 2020 2020  provement.      
+00090060: 2020 6966 2028 7061 7261 6d73 2e6d 6178    if (params.max
+00090070: 5f6e 6f5f 696d 7072 6f76 656d 656e 7420  _no_improvement 
+00090080: 3e20 3029 207b 0a20 2020 2020 2020 2020  > 0) {.         
+00090090: 2020 2069 6620 2866 7820 3c20 6678 5f62     if (fx < fx_b
+000900a0: 6573 745b 305d 2920 7b0a 2020 2020 2020  est[0]) {.      
+000900b0: 2020 2020 2020 2020 2020 6678 5f62 6573            fx_bes
+000900c0: 745b 305d 203d 2066 783b 0a20 2020 2020  t[0] = fx;.     
+000900d0: 2020 2020 2020 2020 2020 206e 5f6e 6f5f             n_no_
+000900e0: 696d 7072 6f76 656d 656e 745b 305d 203d  improvement[0] =
+000900f0: 2030 3b0a 2020 2020 2020 2020 2020 2020   0;.            
+00090100: 7d20 656c 7365 207b 0a20 2020 2020 2020  } else {.       
+00090110: 2020 2020 2020 2020 206e 5f6e 6f5f 696d           n_no_im
+00090120: 7072 6f76 656d 656e 745b 305d 2b2b 3b0a  provement[0]++;.
+00090130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00090140: 2069 6620 286e 5f6e 6f5f 696d 7072 6f76   if (n_no_improv
+00090150: 656d 656e 745b 305d 203e 3d20 7061 7261  ement[0] >= para
+00090160: 6d73 2e6d 6178 5f6e 6f5f 696d 7072 6f76  ms.max_no_improv
+00090170: 656d 656e 7429 207b 0a20 2020 2020 2020  ement) {.       
+00090180: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00090190: 7572 6e20 4747 4d4c 5f4f 5054 5f4f 4b3b  urn GGML_OPT_OK;
+000901a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000901b0: 207d 0a20 2020 2020 2020 2020 2020 207d   }.            }
+000901c0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+000901d0: 2020 2020 6966 2028 7061 7261 6d73 2e6c      if (params.l
+000901e0: 6266 6773 2e6e 5f69 7465 7220 213d 2030  bfgs.n_iter != 0
+000901f0: 2026 2620 7061 7261 6d73 2e6c 6266 6773   && params.lbfgs
+00090200: 2e6e 5f69 7465 7220 3c20 6974 202b 2031  .n_iter < it + 1
+00090210: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
+00090220: 2f2f 2072 6561 6368 6564 2074 6865 206d  // reached the m
+00090230: 6178 696d 756d 206e 756d 6265 7220 6f66  aximum number of
+00090240: 2069 7465 7261 7469 6f6e 730a 2020 2020   iterations.    
+00090250: 2020 2020 2020 2020 7265 7475 726e 2047          return G
+00090260: 474d 4c5f 4f50 545f 4449 445f 4e4f 545f  GML_OPT_DID_NOT_
+00090270: 434f 4e56 4552 4745 3b0a 2020 2020 2020  CONVERGE;.      
+00090280: 2020 7d0a 0a20 2020 2020 2020 202f 2f20    }..        // 
+00090290: 7570 6461 7465 2076 6563 746f 7273 2073  update vectors s
+000902a0: 2061 6e64 2079 3a0a 2020 2020 2020 2020   and y:.        
+000902b0: 2f2f 2020 2073 5f7b 6b2b 317d 203d 2078  //   s_{k+1} = x
+000902c0: 5f7b 6b2b 317d 202d 2078 5f7b 6b7d 203d  _{k+1} - x_{k} =
+000902d0: 205c 7374 6570 202a 2064 5f7b 6b7d 2e0a   \step * d_{k}..
+000902e0: 2020 2020 2020 2020 2f2f 2020 2079 5f7b          //   y_{
+000902f0: 6b2b 317d 203d 2067 5f7b 6b2b 317d 202d  k+1} = g_{k+1} -
+00090300: 2067 5f7b 6b7d 2e0a 2020 2020 2020 2020   g_{k}..        
+00090310: 2f2f 0a20 2020 2020 2020 2067 676d 6c5f  //.        ggml_
+00090320: 7665 635f 7375 625f 6633 3228 6e78 2c20  vec_sub_f32(nx, 
+00090330: 266c 6d5f 735b 656e 645b 305d 2a6e 785d  &lm_s[end[0]*nx]
+00090340: 2c20 782c 2078 7029 3b0a 2020 2020 2020  , x, xp);.      
+00090350: 2020 6767 6d6c 5f76 6563 5f73 7562 5f66    ggml_vec_sub_f
+00090360: 3332 286e 782c 2026 6c6d 5f79 5b65 6e64  32(nx, &lm_y[end
+00090370: 5b30 5d2a 6e78 5d2c 2067 2c20 6770 293b  [0]*nx], g, gp);
+00090380: 0a0a 2020 2020 2020 2020 2f2f 2063 6f6d  ..        // com
+00090390: 7075 7465 2073 6361 6c61 7273 2079 7320  pute scalars ys 
+000903a0: 616e 6420 7979 3a0a 2020 2020 2020 2020  and yy:.        
+000903b0: 2f2f 2020 2020 2079 7320 3d20 795e 7420  //     ys = y^t 
+000903c0: 5c63 646f 7420 7320 2020 202d 3e20 3120  \cdot s    -> 1 
+000903d0: 2f20 5c72 686f 2e0a 2020 2020 2020 2020  / \rho..        
+000903e0: 2f2f 2020 2020 2079 7920 3d20 795e 7420  //     yy = y^t 
+000903f0: 5c63 646f 7420 792e 0a20 2020 2020 2020  \cdot y..       
+00090400: 202f 2f0a 2020 2020 2020 2020 6767 6d6c   //.        ggml
+00090410: 5f76 6563 5f64 6f74 5f66 3332 286e 782c  _vec_dot_f32(nx,
+00090420: 2026 7973 2c20 266c 6d5f 795b 656e 645b   &ys, &lm_y[end[
+00090430: 305d 2a6e 785d 2c20 266c 6d5f 735b 656e  0]*nx], &lm_s[en
+00090440: 645b 305d 202a 6e78 5d29 3b0a 2020 2020  d[0] *nx]);.    
+00090450: 2020 2020 6767 6d6c 5f76 6563 5f64 6f74      ggml_vec_dot
+00090460: 5f66 3332 286e 782c 2026 7979 2c20 266c  _f32(nx, &yy, &l
+00090470: 6d5f 795b 656e 645b 305d 2a6e 785d 2c20  m_y[end[0]*nx], 
+00090480: 266c 6d5f 795b 656e 645b 305d 2a6e 785d  &lm_y[end[0]*nx]
+00090490: 293b 0a0a 2020 2020 2020 2020 6c6d 5f79  );..        lm_y
+000904a0: 735b 656e 645b 305d 5d20 3d20 7973 3b0a  s[end[0]] = ys;.
+000904b0: 0a20 2020 2020 2020 202f 2f20 6669 6e64  .        // find
+000904c0: 206e 6577 2073 6561 7263 6820 6469 7265   new search dire
+000904d0: 6374 696f 6e0a 2020 2020 2020 2020 2f2f  ction.        //
+000904e0: 2020 2072 6566 3a20 6874 7470 733a 2f2f     ref: https://
+000904f0: 656e 2e77 696b 6970 6564 6961 2e6f 7267  en.wikipedia.org
+00090500: 2f77 696b 692f 4c69 6d69 7465 642d 6d65  /wiki/Limited-me
+00090510: 6d6f 7279 5f42 4647 530a 0a20 2020 2020  mory_BFGS..     
+00090520: 2020 2062 6f75 6e64 203d 2028 6d20 3c3d     bound = (m <=
+00090530: 206b 5b30 5d29 203f 206d 203a 206b 5b30   k[0]) ? m : k[0
+00090540: 5d3b 0a20 2020 2020 2020 206b 5b30 5d2b  ];.        k[0]+
+00090550: 2b3b 0a20 2020 2020 2020 2069 742b 2b3b  +;.        it++;
+00090560: 0a20 2020 2020 2020 2065 6e64 5b30 5d20  .        end[0] 
+00090570: 3d20 2865 6e64 5b30 5d20 2b20 3129 256d  = (end[0] + 1)%m
+00090580: 3b0a 0a20 2020 2020 2020 202f 2f20 696e  ;..        // in
+00090590: 6974 6961 6c69 7a65 2073 6561 7263 6820  itialize search 
+000905a0: 6469 7265 6374 696f 6e20 7769 7468 202d  direction with -
+000905b0: 670a 2020 2020 2020 2020 6767 6d6c 5f76  g.        ggml_v
+000905c0: 6563 5f6e 6567 5f66 3332 286e 782c 2064  ec_neg_f32(nx, d
+000905d0: 2c20 6729 3b0a 0a20 2020 2020 2020 206a  , g);..        j
+000905e0: 5b30 5d20 3d20 656e 645b 305d 3b0a 2020  [0] = end[0];.  
+000905f0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00090600: 203d 2030 3b20 6920 3c20 626f 756e 643b   = 0; i < bound;
+00090610: 202b 2b69 2920 7b0a 2020 2020 2020 2020   ++i) {.        
+00090620: 2020 2020 6a5b 305d 203d 2028 6a5b 305d      j[0] = (j[0]
+00090630: 202b 206d 202d 2031 2920 2520 6d3b 0a20   + m - 1) % m;. 
+00090640: 2020 2020 2020 2020 2020 202f 2f20 5c61             // \a
+00090650: 6c70 6861 5f7b 6a7d 203d 205c 7268 6f5f  lpha_{j} = \rho_
+00090660: 7b6a 7d20 735e 7b74 7d5f 7b6a 7d20 5c63  {j} s^{t}_{j} \c
+00090670: 646f 7420 715f 7b6b 2b31 7d0a 2020 2020  dot q_{k+1}.    
+00090680: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00090690: 5f64 6f74 5f66 3332 286e 782c 2026 6c6d  _dot_f32(nx, &lm
+000906a0: 5f61 6c70 6861 5b6a 5b30 5d5d 2c20 266c  _alpha[j[0]], &l
+000906b0: 6d5f 735b 6a5b 305d 2a6e 785d 2c20 6429  m_s[j[0]*nx], d)
+000906c0: 3b0a 2020 2020 2020 2020 2020 2020 6c6d  ;.            lm
+000906d0: 5f61 6c70 6861 5b6a 5b30 5d5d 202f 3d20  _alpha[j[0]] /= 
+000906e0: 6c6d 5f79 735b 6a5b 305d 5d3b 0a20 2020  lm_ys[j[0]];.   
+000906f0: 2020 2020 2020 2020 202f 2f20 715f 7b69           // q_{i
+00090700: 7d20 3d20 715f 7b69 2b31 7d20 2d20 5c61  } = q_{i+1} - \a
+00090710: 6c70 6861 5f7b 697d 2079 5f7b 697d 0a20  lpha_{i} y_{i}. 
+00090720: 2020 2020 2020 2020 2020 2067 676d 6c5f             ggml_
+00090730: 7665 635f 6d61 645f 6633 3228 6e78 2c20  vec_mad_f32(nx, 
+00090740: 642c 2026 6c6d 5f79 5b6a 5b30 5d2a 6e78  d, &lm_y[j[0]*nx
+00090750: 5d2c 202d 6c6d 5f61 6c70 6861 5b6a 5b30  ], -lm_alpha[j[0
+00090760: 5d5d 293b 0a20 2020 2020 2020 207d 0a0a  ]]);.        }..
+00090770: 2020 2020 2020 2020 6767 6d6c 5f76 6563          ggml_vec
+00090780: 5f73 6361 6c65 5f66 3332 286e 782c 2064  _scale_f32(nx, d
+00090790: 2c20 7973 2f79 7929 3b0a 0a20 2020 2020  , ys/yy);..     
+000907a0: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
+000907b0: 303b 2069 203c 2062 6f75 6e64 3b20 2b2b  0; i < bound; ++
+000907c0: 6929 207b 0a20 2020 2020 2020 2020 2020  i) {.           
+000907d0: 202f 2f20 5c62 6574 615f 7b6a 7d20 3d20   // \beta_{j} = 
+000907e0: 5c72 686f 5f7b 6a7d 2079 5e74 5f7b 6a7d  \rho_{j} y^t_{j}
+000907f0: 205c 6364 6f74 205c 6761 6d6d 615f 7b69   \cdot \gamma_{i
+00090800: 7d0a 2020 2020 2020 2020 2020 2020 6767  }.            gg
+00090810: 6d6c 5f76 6563 5f64 6f74 5f66 3332 286e  ml_vec_dot_f32(n
+00090820: 782c 2026 6265 7461 2c20 266c 6d5f 795b  x, &beta, &lm_y[
+00090830: 6a5b 305d 2a6e 785d 2c20 6429 3b0a 2020  j[0]*nx], d);.  
+00090840: 2020 2020 2020 2020 2020 6265 7461 202f            beta /
+00090850: 3d20 6c6d 5f79 735b 6a5b 305d 5d3b 0a20  = lm_ys[j[0]];. 
+00090860: 2020 2020 2020 2020 2020 202f 2f20 5c67             // \g
+00090870: 616d 6d61 5f7b 692b 317d 203d 205c 6761  amma_{i+1} = \ga
+00090880: 6d6d 615f 7b69 7d20 2b20 285c 616c 7068  mma_{i} + (\alph
+00090890: 615f 7b6a 7d20 2d20 5c62 6574 615f 7b6a  a_{j} - \beta_{j
+000908a0: 7d29 2073 5f7b 6a7d 0a20 2020 2020 2020  }) s_{j}.       
+000908b0: 2020 2020 2067 676d 6c5f 7665 635f 6d61       ggml_vec_ma
+000908c0: 645f 6633 3228 6e78 2c20 642c 2026 6c6d  d_f32(nx, d, &lm
+000908d0: 5f73 5b6a 5b30 5d2a 6e78 5d2c 206c 6d5f  _s[j[0]*nx], lm_
+000908e0: 616c 7068 615b 6a5b 305d 5d20 2d20 6265  alpha[j[0]] - be
+000908f0: 7461 293b 0a20 2020 2020 2020 2020 2020  ta);.           
+00090900: 206a 5b30 5d20 3d20 286a 5b30 5d20 2b20   j[0] = (j[0] + 
+00090910: 3129 256d 3b0a 2020 2020 2020 2020 7d0a  1)%m;.        }.
+00090920: 0a20 2020 2020 2020 2073 7465 705b 305d  .        step[0]
+00090930: 203d 2031 2e30 3b0a 2020 2020 7d0a 0a20   = 1.0;.    }.. 
+00090940: 2020 2072 6574 7572 6e20 4747 4d4c 5f4f     return GGML_O
+00090950: 5054 5f44 4944 5f4e 4f54 5f43 4f4e 5645  PT_DID_NOT_CONVE
+00090960: 5247 453b 0a7d 0a0a 7374 7275 6374 2067  RGE;.}..struct g
+00090970: 676d 6c5f 6f70 745f 7061 7261 6d73 2067  gml_opt_params g
+00090980: 676d 6c5f 6f70 745f 6465 6661 756c 745f  gml_opt_default_
+00090990: 7061 7261 6d73 2865 6e75 6d20 6767 6d6c  params(enum ggml
+000909a0: 5f6f 7074 5f74 7970 6520 7479 7065 2920  _opt_type type) 
+000909b0: 7b0a 2020 2020 7374 7275 6374 2067 676d  {.    struct ggm
+000909c0: 6c5f 6f70 745f 7061 7261 6d73 2072 6573  l_opt_params res
+000909d0: 756c 743b 0a0a 2020 2020 7377 6974 6368  ult;..    switch
+000909e0: 2028 7479 7065 2920 7b0a 2020 2020 2020   (type) {.      
+000909f0: 2020 6361 7365 2047 474d 4c5f 4f50 545f    case GGML_OPT_
+00090a00: 4144 414d 3a0a 2020 2020 2020 2020 2020  ADAM:.          
+00090a10: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00090a20: 2020 2020 7265 7375 6c74 203d 2028 7374      result = (st
+00090a30: 7275 6374 2067 676d 6c5f 6f70 745f 7061  ruct ggml_opt_pa
+00090a40: 7261 6d73 2920 7b0a 2020 2020 2020 2020  rams) {.        
+00090a50: 2020 2020 2020 2020 2020 2020 2e74 7970              .typ
+00090a60: 6520 2020 2020 203d 2047 474d 4c5f 4f50  e      = GGML_OP
+00090a70: 545f 4144 414d 2c0a 2020 2020 2020 2020  T_ADAM,.        
+00090a80: 2020 2020 2020 2020 2020 2020 2e6e 5f74              .n_t
+00090a90: 6872 6561 6473 203d 2031 2c0a 2020 2020  hreads = 1,.    
+00090aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090ab0: 2e70 6173 7420 2020 2020 203d 2030 2c0a  .past      = 0,.
+00090ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090ad0: 2020 2020 2e64 656c 7461 2020 2020 203d      .delta     =
+00090ae0: 2031 652d 3566 2c0a 0a20 2020 2020 2020   1e-5f,..       
+00090af0: 2020 2020 2020 2020 2020 2020 202e 6d61               .ma
+00090b00: 785f 6e6f 5f69 6d70 726f 7665 6d65 6e74  x_no_improvement
+00090b10: 203d 2031 3030 2c0a 0a20 2020 2020 2020   = 100,..       
+00090b20: 2020 2020 2020 2020 2020 2020 202e 7072               .pr
+00090b30: 696e 745f 666f 7277 6172 645f 6772 6170  int_forward_grap
+00090b40: 6820 203d 2074 7275 652c 0a20 2020 2020  h  = true,.     
+00090b50: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00090b60: 7072 696e 745f 6261 636b 7761 7264 5f67  print_backward_g
+00090b70: 7261 7068 203d 2074 7275 652c 0a0a 2020  raph = true,..  
+00090b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090b90: 2020 2e61 6461 6d20 3d20 7b0a 2020 2020    .adam = {.    
+00090ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090bb0: 2020 2020 2e6e 5f69 7465 7220 3d20 3130      .n_iter = 10
+00090bc0: 3030 302c 0a20 2020 2020 2020 2020 2020  000,.           
+00090bd0: 2020 2020 2020 2020 2020 2020 202e 7363               .sc
+00090be0: 6865 6420 203d 2031 2e30 3030 662c 0a20  hed  = 1.000f,. 
+00090bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090c00: 2020 2020 2020 202e 6465 6361 7920 203d         .decay  =
+00090c10: 2030 2e30 3031 662c 0a20 2020 2020 2020   0.001f,.       
+00090c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090c30: 202e 616c 7068 6120 203d 2030 2e30 3031   .alpha  = 0.001
+00090c40: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
+00090c50: 2020 2020 2020 2020 2020 202e 6265 7461             .beta
+00090c60: 3120 203d 2030 2e39 662c 0a20 2020 2020  1  = 0.9f,.     
+00090c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090c80: 2020 202e 6265 7461 3220 203d 2030 2e39     .beta2  = 0.9
+00090c90: 3939 662c 0a20 2020 2020 2020 2020 2020  99f,.           
+00090ca0: 2020 2020 2020 2020 2020 2020 202e 6570               .ep
+00090cb0: 7320 2020 203d 2031 652d 3866 2c0a 2020  s    = 1e-8f,.  
+00090cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090cd0: 2020 2020 2020 2e65 7073 5f66 2020 3d20        .eps_f  = 
+00090ce0: 3165 2d35 662c 0a20 2020 2020 2020 2020  1e-5f,.         
+00090cf0: 2020 2020 2020 2020 2020 2020 2020 202e                 .
+00090d00: 6570 735f 6720 203d 2031 652d 3366 2c0a  eps_g  = 1e-3f,.
+00090d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090d20: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00090d30: 2020 2020 2020 207d 3b0a 2020 2020 2020         };.      
+00090d40: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
+00090d50: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
+00090d60: 5f4f 5054 5f4c 4246 4753 3a0a 2020 2020  _OPT_LBFGS:.    
+00090d70: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00090d80: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00090d90: 203d 2028 7374 7275 6374 2067 676d 6c5f   = (struct ggml_
+00090da0: 6f70 745f 7061 7261 6d73 2920 7b0a 2020  opt_params) {.  
+00090db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090dc0: 2020 2e74 7970 6520 2020 2020 203d 2047    .type      = G
+00090dd0: 474d 4c5f 4f50 545f 4c42 4647 532c 0a20  GML_OPT_LBFGS,. 
+00090de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090df0: 2020 202e 6e5f 7468 7265 6164 7320 3d20     .n_threads = 
+00090e00: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+00090e10: 2020 2020 2020 202e 7061 7374 2020 2020         .past    
+00090e20: 2020 3d20 302c 0a20 2020 2020 2020 2020    = 0,.         
+00090e30: 2020 2020 2020 2020 2020 202e 6465 6c74             .delt
+00090e40: 6120 2020 2020 3d20 3165 2d35 662c 0a0a  a     = 1e-5f,..
 00090e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090e60: 2020 2020 2020 202e 6d61 785f 6c69 6e65         .max_line
-00090e70: 7365 6172 6368 203d 2032 302c 0a0a 2020  search = 20,..  
+00090e60: 2020 2020 2e6d 6178 5f6e 6f5f 696d 7072      .max_no_impr
+00090e70: 6f76 656d 656e 7420 3d20 302c 0a0a 2020  ovement = 0,..  
 00090e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090e90: 2020 2020 2020 2e65 7073 2020 2020 2020        .eps      
-00090ea0: 3d20 3165 2d35 662c 0a20 2020 2020 2020  = 1e-5f,.       
+00090e90: 2020 2e70 7269 6e74 5f66 6f72 7761 7264    .print_forward
+00090ea0: 5f67 7261 7068 2020 3d20 7472 7565 2c0a  _graph  = true,.
 00090eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090ec0: 202e 6674 6f6c 2020 2020 203d 2031 652d   .ftol     = 1e-
-00090ed0: 3466 2c0a 2020 2020 2020 2020 2020 2020  4f,.            
-00090ee0: 2020 2020 2020 2020 2020 2020 2e77 6f6c              .wol
-00090ef0: 6665 2020 2020 3d20 302e 3966 2c0a 2020  fe    = 0.9f,.  
-00090f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090f10: 2020 2020 2020 2e6d 696e 5f73 7465 7020        .min_step 
-00090f20: 3d20 3165 2d32 3066 2c0a 2020 2020 2020  = 1e-20f,.      
+00090ec0: 2020 2020 2e70 7269 6e74 5f62 6163 6b77      .print_backw
+00090ed0: 6172 645f 6772 6170 6820 3d20 7472 7565  ard_graph = true
+00090ee0: 2c0a 0a20 2020 2020 2020 2020 2020 2020  ,..             
+00090ef0: 2020 2020 2020 202e 6c62 6667 7320 3d20         .lbfgs = 
+00090f00: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00090f10: 2020 2020 2020 2020 2020 2e6d 2020 2020            .m    
+00090f20: 2020 2020 2020 2020 2020 3d20 362c 0a20            = 6,. 
 00090f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00090f40: 2020 2e6d 6178 5f73 7465 7020 3d20 3165    .max_step = 1e
-00090f50: 2b32 3066 2c0a 0a20 2020 2020 2020 2020  +20f,..         
-00090f60: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-00090f70: 6c69 6e65 7365 6172 6368 203d 2047 474d  linesearch = GGM
-00090f80: 4c5f 4c49 4e45 5345 4152 4348 5f44 4546  L_LINESEARCH_DEF
-00090f90: 4155 4c54 2c0a 2020 2020 2020 2020 2020  AULT,.          
-00090fa0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-00090fb0: 2020 2020 2020 2020 2020 2020 207d 3b0a               };.
-00090fc0: 2020 2020 2020 2020 2020 2020 7d20 6272              } br
-00090fd0: 6561 6b3b 0a20 2020 207d 0a0a 2020 2020  eak;.    }..    
-00090fe0: 7265 7475 726e 2072 6573 756c 743b 0a7d  return result;.}
-00090ff0: 0a0a 4747 4d4c 5f41 5049 2076 6f69 6420  ..GGML_API void 
-00091000: 6767 6d6c 5f6f 7074 5f69 6e69 7428 0a20  ggml_opt_init(. 
-00091010: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00091020: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00091030: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00091040: 2067 676d 6c5f 6f70 745f 636f 6e74 6578   ggml_opt_contex
-00091050: 7420 2a20 6f70 742c 0a20 2020 2020 2020  t * opt,.       
-00091060: 2073 7472 7563 7420 6767 6d6c 5f6f 7074   struct ggml_opt
-00091070: 5f70 6172 616d 7320 7061 7261 6d73 2c0a  _params params,.
-00091080: 2020 2020 2020 2020 696e 7436 345f 7420          int64_t 
-00091090: 6e78 2920 7b0a 2020 2020 6f70 742d 3e63  nx) {.    opt->c
-000910a0: 7478 203d 2063 7478 3b0a 2020 2020 6f70  tx = ctx;.    op
-000910b0: 742d 3e70 6172 616d 7320 3d20 7061 7261  t->params = para
-000910c0: 6d73 3b0a 2020 2020 6f70 742d 3e69 7465  ms;.    opt->ite
-000910d0: 7220 3d20 303b 0a20 2020 206f 7074 2d3e  r = 0;.    opt->
-000910e0: 6e78 203d 206e 783b 0a20 2020 206f 7074  nx = nx;.    opt
-000910f0: 2d3e 6a75 7374 5f69 6e69 7469 616c 697a  ->just_initializ
-00091100: 6564 203d 2074 7275 653b 0a20 2020 2073  ed = true;.    s
-00091110: 7769 7463 6820 286f 7074 2d3e 7061 7261  witch (opt->para
-00091120: 6d73 2e74 7970 6529 207b 0a20 2020 2020  ms.type) {.     
-00091130: 2020 2063 6173 6520 4747 4d4c 5f4f 5054     case GGML_OPT
-00091140: 5f41 4441 4d3a 0a20 2020 2020 2020 2020  _ADAM:.         
-00091150: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00091160: 2020 2020 206f 7074 2d3e 6164 616d 2e78       opt->adam.x
-00091170: 2020 3d20 6767 6d6c 5f6e 6577 5f74 656e    = ggml_new_ten
-00091180: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
-00091190: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
-000911a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000911b0: 6f70 742d 3e61 6461 6d2e 6731 203d 2067  opt->adam.g1 = g
-000911c0: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
-000911d0: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
-000911e0: 5f46 3332 2c20 6e78 293b 0a20 2020 2020  _F32, nx);.     
-000911f0: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
-00091200: 6164 616d 2e67 3220 3d20 6767 6d6c 5f6e  adam.g2 = ggml_n
-00091210: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-00091220: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
-00091230: 206e 7829 3b0a 2020 2020 2020 2020 2020   nx);.          
-00091240: 2020 2020 2020 6f70 742d 3e61 6461 6d2e        opt->adam.
-00091250: 6d20 203d 2067 676d 6c5f 6e65 775f 7465  m  = ggml_new_te
-00091260: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
-00091270: 4c5f 5459 5045 5f46 3332 2c20 6e78 293b  L_TYPE_F32, nx);
-00091280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00091290: 206f 7074 2d3e 6164 616d 2e76 2020 3d20   opt->adam.v  = 
-000912a0: 6767 6d6c 5f6e 6577 5f74 656e 736f 725f  ggml_new_tensor_
-000912b0: 3164 2863 7478 2c20 4747 4d4c 5f54 5950  1d(ctx, GGML_TYP
-000912c0: 455f 4633 322c 206e 7829 3b0a 2020 2020  E_F32, nx);.    
-000912d0: 2020 2020 2020 2020 2020 2020 6f70 742d              opt-
-000912e0: 3e61 6461 6d2e 6d68 203d 2067 676d 6c5f  >adam.mh = ggml_
-000912f0: 6e65 775f 7465 6e73 6f72 5f31 6428 6374  new_tensor_1d(ct
-00091300: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
-00091310: 2c20 6e78 293b 0a20 2020 2020 2020 2020  , nx);.         
-00091320: 2020 2020 2020 206f 7074 2d3e 6164 616d         opt->adam
-00091330: 2e76 6820 3d20 6767 6d6c 5f6e 6577 5f74  .vh = ggml_new_t
-00091340: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
-00091350: 4d4c 5f54 5950 455f 4633 322c 206e 7829  ML_TYPE_F32, nx)
-00091360: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00091370: 2020 6f70 742d 3e61 6461 6d2e 7066 203d    opt->adam.pf =
-00091380: 2070 6172 616d 732e 7061 7374 203e 2030   params.past > 0
-00091390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000913a0: 2020 2020 203f 2067 676d 6c5f 6e65 775f       ? ggml_new_
-000913b0: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
-000913c0: 474d 4c5f 5459 5045 5f46 3332 2c20 7061  GML_TYPE_F32, pa
-000913d0: 7261 6d73 2e70 6173 7429 0a20 2020 2020  rams.past).     
-000913e0: 2020 2020 2020 2020 2020 2020 2020 203a                 :
-000913f0: 204e 554c 4c3b 0a20 2020 2020 2020 2020   NULL;.         
-00091400: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
-00091410: 7a65 726f 286f 7074 2d3e 6164 616d 2e78  zero(opt->adam.x
-00091420: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00091430: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
-00091440: 286f 7074 2d3e 6164 616d 2e67 3129 3b0a  (opt->adam.g1);.
-00091450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00091460: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
-00091470: 742d 3e61 6461 6d2e 6732 293b 0a20 2020  t->adam.g2);.   
-00091480: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
-00091490: 6c5f 7365 745f 7a65 726f 286f 7074 2d3e  l_set_zero(opt->
-000914a0: 6164 616d 2e6d 293b 0a20 2020 2020 2020  adam.m);.       
-000914b0: 2020 2020 2020 2020 2067 676d 6c5f 7365           ggml_se
-000914c0: 745f 7a65 726f 286f 7074 2d3e 6164 616d  t_zero(opt->adam
-000914d0: 2e76 293b 0a20 2020 2020 2020 2020 2020  .v);.           
-000914e0: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-000914f0: 726f 286f 7074 2d3e 6164 616d 2e6d 6829  ro(opt->adam.mh)
-00091500: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00091510: 2020 6767 6d6c 5f73 6574 5f7a 6572 6f28    ggml_set_zero(
-00091520: 6f70 742d 3e61 6461 6d2e 7668 293b 0a20  opt->adam.vh);. 
-00091530: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00091540: 6620 286f 7074 2d3e 6164 616d 2e70 6629  f (opt->adam.pf)
-00091550: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00091560: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
-00091570: 7a65 726f 286f 7074 2d3e 6164 616d 2e70  zero(opt->adam.p
-00091580: 6629 3b0a 2020 2020 2020 2020 2020 2020  f);.            
-00091590: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-000915a0: 2020 7d20 6272 6561 6b3b 0a20 2020 2020    } break;.     
-000915b0: 2020 2063 6173 6520 4747 4d4c 5f4f 5054     case GGML_OPT
-000915c0: 5f4c 4246 4753 3a0a 2020 2020 2020 2020  _LBFGS:.        
-000915d0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000915e0: 2020 2020 2020 6f70 742d 3e6c 6266 6773        opt->lbfgs
-000915f0: 2e78 2020 3d20 6767 6d6c 5f6e 6577 5f74  .x  = ggml_new_t
-00091600: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
-00091610: 4d4c 5f54 5950 455f 4633 322c 206e 7829  ML_TYPE_F32, nx)
-00091620: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00091630: 2020 6f70 742d 3e6c 6266 6773 2e78 7020    opt->lbfgs.xp 
-00091640: 3d20 6767 6d6c 5f6e 6577 5f74 656e 736f  = ggml_new_tenso
-00091650: 725f 3164 2863 7478 2c20 4747 4d4c 5f54  r_1d(ctx, GGML_T
-00091660: 5950 455f 4633 322c 206e 7829 3b0a 2020  YPE_F32, nx);.  
-00091670: 2020 2020 2020 2020 2020 2020 2020 6f70                op
-00091680: 742d 3e6c 6266 6773 2e67 2020 3d20 6767  t->lbfgs.g  = gg
-00091690: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-000916a0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-000916b0: 4633 322c 206e 7829 3b0a 2020 2020 2020  F32, nx);.      
-000916c0: 2020 2020 2020 2020 2020 6f70 742d 3e6c            opt->l
-000916d0: 6266 6773 2e67 7020 3d20 6767 6d6c 5f6e  bfgs.gp = ggml_n
-000916e0: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-000916f0: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
-00091700: 206e 7829 3b0a 2020 2020 2020 2020 2020   nx);.          
-00091710: 2020 2020 2020 6f70 742d 3e6c 6266 6773        opt->lbfgs
-00091720: 2e64 2020 3d20 6767 6d6c 5f6e 6577 5f74  .d  = ggml_new_t
-00091730: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
-00091740: 4d4c 5f54 5950 455f 4633 322c 206e 7829  ML_TYPE_F32, nx)
-00091750: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00091760: 2020 6f70 742d 3e6c 6266 6773 2e70 6620    opt->lbfgs.pf 
-00091770: 3d20 7061 7261 6d73 2e70 6173 7420 3e20  = params.past > 
-00091780: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00091790: 2020 2020 2020 3f20 6767 6d6c 5f6e 6577        ? ggml_new
-000917a0: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
-000917b0: 4747 4d4c 5f54 5950 455f 4633 322c 2070  GGML_TYPE_F32, p
-000917c0: 6172 616d 732e 7061 7374 290a 2020 2020  arams.past).    
-000917d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000917e0: 3a20 4e55 4c4c 3b0a 2020 2020 2020 2020  : NULL;.        
-000917f0: 2020 2020 2020 2020 6f70 742d 3e6c 6266          opt->lbf
-00091800: 6773 2e6c 6d61 6c20 3d20 6767 6d6c 5f6e  gs.lmal = ggml_n
-00091810: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
-00091820: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
-00091830: 2070 6172 616d 732e 6c62 6667 732e 6d29   params.lbfgs.m)
-00091840: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00091850: 2020 6f70 742d 3e6c 6266 6773 2e6c 6d79    opt->lbfgs.lmy
-00091860: 7320 3d20 6767 6d6c 5f6e 6577 5f74 656e  s = ggml_new_ten
-00091870: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
-00091880: 5f54 5950 455f 4633 322c 2070 6172 616d  _TYPE_F32, param
-00091890: 732e 6c62 6667 732e 6d29 3b0a 2020 2020  s.lbfgs.m);.    
-000918a0: 2020 2020 2020 2020 2020 2020 6f70 742d              opt-
-000918b0: 3e6c 6266 6773 2e6c 6d73 2020 3d20 6767  >lbfgs.lms  = gg
-000918c0: 6d6c 5f6e 6577 5f74 656e 736f 725f 3264  ml_new_tensor_2d
-000918d0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-000918e0: 4633 322c 206e 782c 2070 6172 616d 732e  F32, nx, params.
-000918f0: 6c62 6667 732e 6d29 3b0a 2020 2020 2020  lbfgs.m);.      
-00091900: 2020 2020 2020 2020 2020 6f70 742d 3e6c            opt->l
-00091910: 6266 6773 2e6c 6d79 2020 3d20 6767 6d6c  bfgs.lmy  = ggml
-00091920: 5f6e 6577 5f74 656e 736f 725f 3264 2863  _new_tensor_2d(c
-00091930: 7478 2c20 4747 4d4c 5f54 5950 455f 4633  tx, GGML_TYPE_F3
-00091940: 322c 206e 782c 2070 6172 616d 732e 6c62  2, nx, params.lb
-00091950: 6667 732e 6d29 3b0a 2020 2020 2020 2020  fgs.m);.        
-00091960: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
-00091970: 5f7a 6572 6f28 6f70 742d 3e6c 6266 6773  _zero(opt->lbfgs
-00091980: 2e78 293b 0a20 2020 2020 2020 2020 2020  .x);.           
-00091990: 2020 2020 2067 676d 6c5f 7365 745f 7a65       ggml_set_ze
-000919a0: 726f 286f 7074 2d3e 6c62 6667 732e 7870  ro(opt->lbfgs.xp
-000919b0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000919c0: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
-000919d0: 286f 7074 2d3e 6c62 6667 732e 6729 3b0a  (opt->lbfgs.g);.
-000919e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000919f0: 6767 6d6c 5f73 6574 5f7a 6572 6f28 6f70  ggml_set_zero(op
-00091a00: 742d 3e6c 6266 6773 2e67 7029 3b0a 2020  t->lbfgs.gp);.  
-00091a10: 2020 2020 2020 2020 2020 2020 2020 6767                gg
-00091a20: 6d6c 5f73 6574 5f7a 6572 6f28 6f70 742d  ml_set_zero(opt-
-00091a30: 3e6c 6266 6773 2e64 293b 0a20 2020 2020  >lbfgs.d);.     
-00091a40: 2020 2020 2020 2020 2020 2069 6620 286f             if (o
-00091a50: 7074 2d3e 6c62 6667 732e 7066 2920 7b0a  pt->lbfgs.pf) {.
-00091a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00091a70: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-00091a80: 6f28 6f70 742d 3e6c 6266 6773 2e70 6629  o(opt->lbfgs.pf)
-00091a90: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00091aa0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-00091ab0: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-00091ac0: 6f28 6f70 742d 3e6c 6266 6773 2e6c 6d61  o(opt->lbfgs.lma
-00091ad0: 6c29 3b0a 2020 2020 2020 2020 2020 2020  l);.            
-00091ae0: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-00091af0: 6f28 6f70 742d 3e6c 6266 6773 2e6c 6d79  o(opt->lbfgs.lmy
-00091b00: 7329 3b0a 2020 2020 2020 2020 2020 2020  s);.            
-00091b10: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
-00091b20: 6f28 6f70 742d 3e6c 6266 6773 2e6c 6d73  o(opt->lbfgs.lms
-00091b30: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-00091b40: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
-00091b50: 286f 7074 2d3e 6c62 6667 732e 6c6d 7929  (opt->lbfgs.lmy)
-00091b60: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00091b70: 6272 6561 6b3b 0a20 2020 207d 0a7d 0a0a  break;.    }.}..
-00091b80: 656e 756d 2067 676d 6c5f 6f70 745f 7265  enum ggml_opt_re
-00091b90: 7375 6c74 2067 676d 6c5f 6f70 7428 0a20  sult ggml_opt(. 
-00091ba0: 2020 2020 2020 2073 7472 7563 7420 6767         struct gg
-00091bb0: 6d6c 5f63 6f6e 7465 7874 202a 2063 7478  ml_context * ctx
-00091bc0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00091bd0: 2067 676d 6c5f 6f70 745f 7061 7261 6d73   ggml_opt_params
-00091be0: 2070 6172 616d 732c 0a20 2020 2020 2020   params,.       
-00091bf0: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00091c00: 736f 7220 2a20 6629 207b 0a20 2020 2062  sor * f) {.    b
-00091c10: 6f6f 6c20 6672 6565 5f63 7478 203d 2066  ool free_ctx = f
-00091c20: 616c 7365 3b0a 2020 2020 6966 2028 6374  alse;.    if (ct
-00091c30: 7820 3d3d 204e 554c 4c29 207b 0a20 2020  x == NULL) {.   
-00091c40: 2020 2020 2073 7472 7563 7420 6767 6d6c       struct ggml
-00091c50: 5f69 6e69 745f 7061 7261 6d73 2070 6172  _init_params par
-00091c60: 616d 735f 6374 7820 3d20 7b0a 2020 2020  ams_ctx = {.    
-00091c70: 2020 2020 2020 2020 2e6d 656d 5f73 697a          .mem_siz
-00091c80: 6520 2020 3d20 3136 2a31 3032 342a 3130  e   = 16*1024*10
-00091c90: 3234 2c0a 2020 2020 2020 2020 2020 2020  24,.            
-00091ca0: 2e6d 656d 5f62 7566 6665 7220 3d20 4e55  .mem_buffer = NU
-00091cb0: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
-00091cc0: 2e6e 6f5f 616c 6c6f 6320 2020 3d20 6661  .no_alloc   = fa
-00091cd0: 6c73 652c 0a20 2020 2020 2020 207d 3b0a  lse,.        };.
-00091ce0: 0a20 2020 2020 2020 2063 7478 203d 2067  .        ctx = g
-00091cf0: 676d 6c5f 696e 6974 2870 6172 616d 735f  gml_init(params_
-00091d00: 6374 7829 3b0a 2020 2020 2020 2020 6966  ctx);.        if
-00091d10: 2028 6374 7820 3d3d 204e 554c 4c29 207b   (ctx == NULL) {
-00091d20: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00091d30: 7572 6e20 4747 4d4c 5f4f 5054 5f4e 4f5f  urn GGML_OPT_NO_
-00091d40: 434f 4e54 4558 543b 0a20 2020 2020 2020  CONTEXT;.       
-00091d50: 207d 0a0a 2020 2020 2020 2020 6672 6565   }..        free
-00091d60: 5f63 7478 203d 2074 7275 653b 0a20 2020  _ctx = true;.   
-00091d70: 207d 0a0a 2020 2020 656e 756d 2067 676d   }..    enum ggm
-00091d80: 6c5f 6f70 745f 7265 7375 6c74 2072 6573  l_opt_result res
-00091d90: 756c 7420 3d20 4747 4d4c 5f4f 5054 5f4f  ult = GGML_OPT_O
-00091da0: 4b3b 0a0a 2020 2020 7374 7275 6374 2067  K;..    struct g
-00091db0: 676d 6c5f 6f70 745f 636f 6e74 6578 7420  gml_opt_context 
-00091dc0: 2a20 6f70 7420 3d20 2873 7472 7563 7420  * opt = (struct 
-00091dd0: 6767 6d6c 5f6f 7074 5f63 6f6e 7465 7874  ggml_opt_context
-00091de0: 202a 2920 616c 6c6f 6361 2873 697a 656f   *) alloca(sizeo
-00091df0: 6628 7374 7275 6374 2067 676d 6c5f 6f70  f(struct ggml_op
-00091e00: 745f 636f 6e74 6578 7429 293b 0a0a 2020  t_context));..  
-00091e10: 2020 6767 6d6c 5f6f 7074 5f69 6e69 7428    ggml_opt_init(
-00091e20: 6374 782c 206f 7074 2c20 7061 7261 6d73  ctx, opt, params
-00091e30: 2c20 3029 3b0a 2020 2020 7265 7375 6c74  , 0);.    result
-00091e40: 203d 2067 676d 6c5f 6f70 745f 7265 7375   = ggml_opt_resu
-00091e50: 6d65 2863 7478 2c20 6f70 742c 2066 293b  me(ctx, opt, f);
-00091e60: 0a0a 2020 2020 6966 2028 6672 6565 5f63  ..    if (free_c
-00091e70: 7478 2920 7b0a 2020 2020 2020 2020 6767  tx) {.        gg
-00091e80: 6d6c 5f66 7265 6528 6374 7829 3b0a 2020  ml_free(ctx);.  
-00091e90: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-00091ea0: 7265 7375 6c74 3b0a 7d0a 0a65 6e75 6d20  result;.}..enum 
-00091eb0: 6767 6d6c 5f6f 7074 5f72 6573 756c 7420  ggml_opt_result 
-00091ec0: 6767 6d6c 5f6f 7074 5f72 6573 756d 6528  ggml_opt_resume(
-00091ed0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
-00091ee0: 6767 6d6c 5f63 6f6e 7465 7874 202a 2063  ggml_context * c
-00091ef0: 7478 2c0a 2020 2020 2020 2020 7374 7275  tx,.        stru
-00091f00: 6374 2067 676d 6c5f 6f70 745f 636f 6e74  ct ggml_opt_cont
-00091f10: 6578 7420 2a20 6f70 742c 0a20 2020 2020  ext * opt,.     
-00091f20: 2020 2073 7472 7563 7420 6767 6d6c 5f74     struct ggml_t
-00091f30: 656e 736f 7220 2a20 6629 207b 0a0a 2020  ensor * f) {..  
-00091f40: 2020 2f2f 2062 7569 6c64 2066 6f72 7761    // build forwa
-00091f50: 7264 202b 2062 6163 6b77 6172 6420 636f  rd + backward co
-00091f60: 6d70 7574 6520 6772 6170 6873 0a20 2020  mpute graphs.   
-00091f70: 2073 7472 7563 7420 6767 6d6c 5f74 656e   struct ggml_ten
-00091f80: 736f 7220 2a20 6766 6275 6620 3d20 6767  sor * gfbuf = gg
-00091f90: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
-00091fa0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
-00091fb0: 4933 322c 2073 697a 656f 6628 7374 7275  I32, sizeof(stru
-00091fc0: 6374 2067 676d 6c5f 6367 7261 7068 2920  ct ggml_cgraph) 
-00091fd0: 2f20 4747 4d4c 5f54 5950 455f 5349 5a45  / GGML_TYPE_SIZE
-00091fe0: 5b47 474d 4c5f 5459 5045 5f49 3332 5d2b  [GGML_TYPE_I32]+
-00091ff0: 2028 7369 7a65 6f66 2873 7472 7563 7420   (sizeof(struct 
-00092000: 6767 6d6c 5f63 6772 6170 6829 2025 2047  ggml_cgraph) % G
-00092010: 474d 4c5f 5459 5045 5f53 495a 455b 4747  GML_TYPE_SIZE[GG
-00092020: 4d4c 5f54 5950 455f 4933 325d 203f 2031  ML_TYPE_I32] ? 1
-00092030: 203a 2030 2929 3b0a 2020 2020 7374 7275   : 0));.    stru
-00092040: 6374 2067 676d 6c5f 7465 6e73 6f72 202a  ct ggml_tensor *
-00092050: 2067 6262 7566 203d 2067 676d 6c5f 6e65   gbbuf = ggml_ne
-00092060: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
-00092070: 2047 474d 4c5f 5459 5045 5f49 3332 2c20   GGML_TYPE_I32, 
-00092080: 7369 7a65 6f66 2873 7472 7563 7420 6767  sizeof(struct gg
-00092090: 6d6c 5f63 6772 6170 6829 202f 2047 474d  ml_cgraph) / GGM
-000920a0: 4c5f 5459 5045 5f53 495a 455b 4747 4d4c  L_TYPE_SIZE[GGML
-000920b0: 5f54 5950 455f 4933 325d 2b20 2873 697a  _TYPE_I32]+ (siz
-000920c0: 656f 6628 7374 7275 6374 2067 676d 6c5f  eof(struct ggml_
-000920d0: 6367 7261 7068 2920 2520 4747 4d4c 5f54  cgraph) % GGML_T
-000920e0: 5950 455f 5349 5a45 5b47 474d 4c5f 5459  YPE_SIZE[GGML_TY
-000920f0: 5045 5f49 3332 5d20 3f20 3120 3a20 3029  PE_I32] ? 1 : 0)
-00092100: 293b 0a0a 2020 2020 7374 7275 6374 2067  );..    struct g
-00092110: 676d 6c5f 6367 7261 7068 202a 2067 6620  gml_cgraph * gf 
-00092120: 3d20 2873 7472 7563 7420 6767 6d6c 5f63  = (struct ggml_c
-00092130: 6772 6170 6820 2a29 2067 6662 7566 2d3e  graph *) gfbuf->
-00092140: 6461 7461 3b0a 2020 2020 7374 7275 6374  data;.    struct
-00092150: 2067 676d 6c5f 6367 7261 7068 202a 2067   ggml_cgraph * g
-00092160: 6220 3d20 2873 7472 7563 7420 6767 6d6c  b = (struct ggml
-00092170: 5f63 6772 6170 6820 2a29 2067 6262 7566  _cgraph *) gbbuf
-00092180: 2d3e 6461 7461 3b0a 0a20 2020 202a 6766  ->data;..    *gf
-00092190: 203d 2067 676d 6c5f 6275 696c 645f 666f   = ggml_build_fo
-000921a0: 7277 6172 6420 2866 293b 0a20 2020 202a  rward (f);.    *
-000921b0: 6762 203d 2067 676d 6c5f 6275 696c 645f  gb = ggml_build_
-000921c0: 6261 636b 7761 7264 2863 7478 2c20 6766  backward(ctx, gf
-000921d0: 2c20 7472 7565 293b 0a0a 2020 2020 7265  , true);..    re
-000921e0: 7475 726e 2067 676d 6c5f 6f70 745f 7265  turn ggml_opt_re
-000921f0: 7375 6d65 5f67 2863 7478 2c20 6f70 742c  sume_g(ctx, opt,
-00092200: 2066 2c20 6766 2c20 6762 293b 0a7d 0a0a   f, gf, gb);.}..
-00092210: 656e 756d 2067 676d 6c5f 6f70 745f 7265  enum ggml_opt_re
-00092220: 7375 6c74 2067 676d 6c5f 6f70 745f 7265  sult ggml_opt_re
-00092230: 7375 6d65 5f67 280a 2020 2020 2020 2020  sume_g(.        
-00092240: 7374 7275 6374 2067 676d 6c5f 636f 6e74  struct ggml_cont
-00092250: 6578 7420 2a20 6374 782c 0a20 2020 2020  ext * ctx,.     
-00092260: 2020 2073 7472 7563 7420 6767 6d6c 5f6f     struct ggml_o
-00092270: 7074 5f63 6f6e 7465 7874 202a 206f 7074  pt_context * opt
-00092280: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-00092290: 2067 676d 6c5f 7465 6e73 6f72 202a 2066   ggml_tensor * f
-000922a0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
-000922b0: 2067 676d 6c5f 6367 7261 7068 202a 2067   ggml_cgraph * g
-000922c0: 662c 0a20 2020 2020 2020 2073 7472 7563  f,.        struc
-000922d0: 7420 6767 6d6c 5f63 6772 6170 6820 2a20  t ggml_cgraph * 
-000922e0: 6762 2920 7b0a 0a20 2020 202f 2f20 6275  gb) {..    // bu
-000922f0: 696c 6420 666f 7277 6172 6420 2b20 6261  ild forward + ba
-00092300: 636b 7761 7264 2063 6f6d 7075 7465 2067  ckward compute g
-00092310: 7261 7068 730a 2020 2020 656e 756d 2067  raphs.    enum g
-00092320: 676d 6c5f 6f70 745f 7265 7375 6c74 2072  gml_opt_result r
-00092330: 6573 756c 7420 3d20 4747 4d4c 5f4f 5054  esult = GGML_OPT
-00092340: 5f4f 4b3b 0a0a 2020 2020 7377 6974 6368  _OK;..    switch
-00092350: 2028 6f70 742d 3e70 6172 616d 732e 7479   (opt->params.ty
-00092360: 7065 2920 7b0a 2020 2020 2020 2020 6361  pe) {.        ca
-00092370: 7365 2047 474d 4c5f 4f50 545f 4144 414d  se GGML_OPT_ADAM
-00092380: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
-00092390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000923a0: 7265 7375 6c74 203d 2067 676d 6c5f 6f70  result = ggml_op
-000923b0: 745f 6164 616d 2863 7478 2c20 6f70 742c  t_adam(ctx, opt,
-000923c0: 206f 7074 2d3e 7061 7261 6d73 2c20 662c   opt->params, f,
-000923d0: 2067 662c 2067 6229 3b0a 2020 2020 2020   gf, gb);.      
-000923e0: 2020 2020 2020 7d20 6272 6561 6b3b 0a20        } break;. 
-000923f0: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00092400: 5f4f 5054 5f4c 4246 4753 3a0a 2020 2020  _OPT_LBFGS:.    
-00092410: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00092420: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00092430: 203d 2067 676d 6c5f 6f70 745f 6c62 6667   = ggml_opt_lbfg
-00092440: 7328 6374 782c 206f 7074 2c20 6f70 742d  s(ctx, opt, opt-
-00092450: 3e70 6172 616d 732c 2066 2c20 6766 2c20  >params, f, gf, 
-00092460: 6762 293b 0a20 2020 2020 2020 2020 2020  gb);.           
-00092470: 207d 2062 7265 616b 3b0a 2020 2020 7d0a   } break;.    }.
-00092480: 0a20 2020 2069 6620 286f 7074 2d3e 7061  .    if (opt->pa
-00092490: 7261 6d73 2e70 7269 6e74 5f66 6f72 7761  rams.print_forwa
-000924a0: 7264 5f67 7261 7068 2920 7b0a 2020 2020  rd_graph) {.    
-000924b0: 2020 2020 6767 6d6c 5f67 7261 7068 5f70      ggml_graph_p
-000924c0: 7269 6e74 2020 2028 6766 293b 0a20 2020  rint   (gf);.   
-000924d0: 2020 2020 2067 676d 6c5f 6772 6170 685f       ggml_graph_
-000924e0: 6475 6d70 5f64 6f74 2867 662c 204e 554c  dump_dot(gf, NUL
-000924f0: 4c2c 2022 6f70 742d 666f 7277 6172 642e  L, "opt-forward.
-00092500: 646f 7422 293b 0a20 2020 207d 0a0a 2020  dot");.    }..  
-00092510: 2020 6966 2028 6f70 742d 3e70 6172 616d    if (opt->param
-00092520: 732e 7072 696e 745f 6261 636b 7761 7264  s.print_backward
-00092530: 5f67 7261 7068 2920 7b0a 2020 2020 2020  _graph) {.      
-00092540: 2020 6767 6d6c 5f67 7261 7068 5f70 7269    ggml_graph_pri
-00092550: 6e74 2020 2028 6762 293b 0a20 2020 2020  nt   (gb);.     
-00092560: 2020 2067 676d 6c5f 6772 6170 685f 6475     ggml_graph_du
-00092570: 6d70 5f64 6f74 2867 622c 2067 662c 2022  mp_dot(gb, gf, "
-00092580: 6f70 742d 6261 636b 7761 7264 2e64 6f74  opt-backward.dot
-00092590: 2229 3b0a 2020 2020 7d0a 0a20 2020 2072  ");.    }..    r
-000925a0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
-000925b0: 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .///////////////
-000925c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000925d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000925e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000925f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00092600: 2f0a 0a73 697a 655f 7420 6767 6d6c 5f71  /..size_t ggml_q
-00092610: 7561 6e74 697a 655f 7134 5f30 2863 6f6e  uantize_q4_0(con
-00092620: 7374 2066 6c6f 6174 202a 2073 7263 2c20  st float * src, 
-00092630: 766f 6964 202a 2064 7374 2c20 696e 7420  void * dst, int 
-00092640: 6e2c 2069 6e74 206b 2c20 696e 7436 345f  n, int k, int64_
-00092650: 7420 2a20 6869 7374 2920 7b0a 2020 2020  t * hist) {.    
-00092660: 6173 7365 7274 286b 2025 2051 4b34 5f30  assert(k % QK4_0
-00092670: 203d 3d20 3029 3b0a 2020 2020 636f 6e73   == 0);.    cons
-00092680: 7420 696e 7420 6e62 203d 206b 202f 2051  t int nb = k / Q
-00092690: 4b34 5f30 3b0a 0a20 2020 2066 6f72 2028  K4_0;..    for (
-000926a0: 696e 7420 6220 3d20 303b 2062 203c 206e  int b = 0; b < n
-000926b0: 3b20 6220 2b3d 206b 2920 7b0a 2020 2020  ; b += k) {.    
-000926c0: 2020 2020 626c 6f63 6b5f 7134 5f30 202a      block_q4_0 *
-000926d0: 2072 6573 7472 6963 7420 7920 3d20 2862   restrict y = (b
-000926e0: 6c6f 636b 5f71 345f 3020 2a29 2064 7374  lock_q4_0 *) dst
-000926f0: 202b 2062 2f51 4b34 5f30 3b0a 0a20 2020   + b/QK4_0;..   
-00092700: 2020 2020 2071 7561 6e74 697a 655f 726f       quantize_ro
-00092710: 775f 7134 5f30 5f72 6566 6572 656e 6365  w_q4_0_reference
-00092720: 2873 7263 202b 2062 2c20 792c 206b 293b  (src + b, y, k);
-00092730: 0a0a 2020 2020 2020 2020 666f 7220 2869  ..        for (i
-00092740: 6e74 2069 203d 2030 3b20 6920 3c20 6e62  nt i = 0; i < nb
-00092750: 3b20 692b 2b29 207b 0a20 2020 2020 2020  ; i++) {.       
-00092760: 2020 2020 2066 6f72 2028 696e 7420 6a20       for (int j 
-00092770: 3d20 303b 206a 203c 2051 4b34 5f30 3b20  = 0; j < QK4_0; 
-00092780: 6a20 2b3d 2032 2920 7b0a 2020 2020 2020  j += 2) {.      
-00092790: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-000927a0: 7569 6e74 385f 7420 7669 3020 3d20 795b  uint8_t vi0 = y[
-000927b0: 695d 2e71 735b 6a2f 325d 2026 2030 7830  i].qs[j/2] & 0x0
-000927c0: 463b 0a20 2020 2020 2020 2020 2020 2020  F;.             
-000927d0: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
-000927e0: 2076 6931 203d 2079 5b69 5d2e 7173 5b6a   vi1 = y[i].qs[j
-000927f0: 2f32 5d20 3e3e 2034 3b0a 0a20 2020 2020  /2] >> 4;..     
-00092800: 2020 2020 2020 2020 2020 2068 6973 745b             hist[
-00092810: 7669 305d 2b2b 3b0a 2020 2020 2020 2020  vi0]++;.        
-00092820: 2020 2020 2020 2020 6869 7374 5b76 6931          hist[vi1
-00092830: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
-00092840: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
-00092850: 207d 0a0a 2020 2020 7265 7475 726e 2028   }..    return (
-00092860: 6e2f 514b 345f 302a 7369 7a65 6f66 2862  n/QK4_0*sizeof(b
-00092870: 6c6f 636b 5f71 345f 3029 293b 0a7d 0a0a  lock_q4_0));.}..
-00092880: 7369 7a65 5f74 2067 676d 6c5f 7175 616e  size_t ggml_quan
-00092890: 7469 7a65 5f71 345f 3128 636f 6e73 7420  tize_q4_1(const 
-000928a0: 666c 6f61 7420 2a20 7372 632c 2076 6f69  float * src, voi
-000928b0: 6420 2a20 6473 742c 2069 6e74 206e 2c20  d * dst, int n, 
-000928c0: 696e 7420 6b2c 2069 6e74 3634 5f74 202a  int k, int64_t *
-000928d0: 2068 6973 7429 207b 0a20 2020 2061 7373   hist) {.    ass
-000928e0: 6572 7428 6b20 2520 514b 345f 3120 3d3d  ert(k % QK4_1 ==
-000928f0: 2030 293b 0a20 2020 2063 6f6e 7374 2069   0);.    const i
-00092900: 6e74 206e 6220 3d20 6b20 2f20 514b 345f  nt nb = k / QK4_
-00092910: 313b 0a0a 2020 2020 666f 7220 2869 6e74  1;..    for (int
-00092920: 2062 203d 2030 3b20 6220 3c20 6e3b 2062   b = 0; b < n; b
-00092930: 202b 3d20 6b29 207b 0a20 2020 2020 2020   += k) {.       
-00092940: 2062 6c6f 636b 5f71 345f 3120 2a20 7265   block_q4_1 * re
-00092950: 7374 7269 6374 2079 203d 2028 626c 6f63  strict y = (bloc
-00092960: 6b5f 7134 5f31 202a 2920 6473 7420 2b20  k_q4_1 *) dst + 
-00092970: 622f 514b 345f 313b 0a0a 2020 2020 2020  b/QK4_1;..      
-00092980: 2020 7175 616e 7469 7a65 5f72 6f77 5f71    quantize_row_q
-00092990: 345f 315f 7265 6665 7265 6e63 6528 7372  4_1_reference(sr
-000929a0: 6320 2b20 622c 2079 2c20 6b29 3b0a 0a20  c + b, y, k);.. 
-000929b0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-000929c0: 6920 3d20 303b 2069 203c 206e 623b 2069  i = 0; i < nb; i
-000929d0: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-000929e0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
-000929f0: 3b20 6a20 3c20 514b 345f 313b 206a 202b  ; j < QK4_1; j +
-00092a00: 3d20 3229 207b 0a20 2020 2020 2020 2020  = 2) {.         
-00092a10: 2020 2020 2020 2063 6f6e 7374 2075 696e         const uin
-00092a20: 7438 5f74 2076 6930 203d 2079 5b69 5d2e  t8_t vi0 = y[i].
-00092a30: 7173 5b6a 2f32 5d20 2620 3078 3046 3b0a  qs[j/2] & 0x0F;.
-00092a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00092a50: 636f 6e73 7420 7569 6e74 385f 7420 7669  const uint8_t vi
-00092a60: 3120 3d20 795b 695d 2e71 735b 6a2f 325d  1 = y[i].qs[j/2]
-00092a70: 203e 3e20 343b 0a0a 2020 2020 2020 2020   >> 4;..        
-00092a80: 2020 2020 2020 2020 6869 7374 5b76 6930          hist[vi0
-00092a90: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
-00092aa0: 2020 2020 2068 6973 745b 7669 315d 2b2b       hist[vi1]++
-00092ab0: 3b0a 2020 2020 2020 2020 2020 2020 7d0a  ;.            }.
-00092ac0: 2020 2020 2020 2020 7d0a 2020 2020 7d0a          }.    }.
-00092ad0: 0a20 2020 2072 6574 7572 6e20 286e 2f51  .    return (n/Q
-00092ae0: 4b34 5f31 2a73 697a 656f 6628 626c 6f63  K4_1*sizeof(bloc
-00092af0: 6b5f 7134 5f31 2929 3b0a 7d0a 0a73 697a  k_q4_1));.}..siz
-00092b00: 655f 7420 6767 6d6c 5f71 7561 6e74 697a  e_t ggml_quantiz
-00092b10: 655f 7135 5f30 2863 6f6e 7374 2066 6c6f  e_q5_0(const flo
-00092b20: 6174 202a 2073 7263 2c20 766f 6964 202a  at * src, void *
-00092b30: 2064 7374 2c20 696e 7420 6e2c 2069 6e74   dst, int n, int
-00092b40: 206b 2c20 696e 7436 345f 7420 2a20 6869   k, int64_t * hi
-00092b50: 7374 2920 7b0a 2020 2020 6173 7365 7274  st) {.    assert
-00092b60: 286b 2025 2051 4b35 5f30 203d 3d20 3029  (k % QK5_0 == 0)
-00092b70: 3b0a 2020 2020 636f 6e73 7420 696e 7420  ;.    const int 
-00092b80: 6e62 203d 206b 202f 2051 4b35 5f30 3b0a  nb = k / QK5_0;.
-00092b90: 0a20 2020 2066 6f72 2028 696e 7420 6220  .    for (int b 
-00092ba0: 3d20 303b 2062 203c 206e 3b20 6220 2b3d  = 0; b < n; b +=
-00092bb0: 206b 2920 7b0a 2020 2020 2020 2020 626c   k) {.        bl
-00092bc0: 6f63 6b5f 7135 5f30 202a 2072 6573 7472  ock_q5_0 * restr
-00092bd0: 6963 7420 7920 3d20 2862 6c6f 636b 5f71  ict y = (block_q
-00092be0: 355f 3020 2a29 6473 7420 2b20 622f 514b  5_0 *)dst + b/QK
-00092bf0: 355f 303b 0a0a 2020 2020 2020 2020 7175  5_0;..        qu
-00092c00: 616e 7469 7a65 5f72 6f77 5f71 355f 305f  antize_row_q5_0_
-00092c10: 7265 6665 7265 6e63 6528 7372 6320 2b20  reference(src + 
-00092c20: 622c 2079 2c20 6b29 3b0a 0a20 2020 2020  b, y, k);..     
-00092c30: 2020 2066 6f72 2028 696e 7420 6920 3d20     for (int i = 
-00092c40: 303b 2069 203c 206e 623b 2069 2b2b 2920  0; i < nb; i++) 
-00092c50: 7b0a 2020 2020 2020 2020 2020 2020 7569  {.            ui
-00092c60: 6e74 3332 5f74 2071 683b 0a20 2020 2020  nt32_t qh;.     
-00092c70: 2020 2020 2020 206d 656d 6370 7928 2671         memcpy(&q
-00092c80: 682c 2026 795b 695d 2e71 682c 2073 697a  h, &y[i].qh, siz
-00092c90: 656f 6628 7168 2929 3b0a 0a20 2020 2020  eof(qh));..     
-00092ca0: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00092cb0: 6a20 3d20 303b 206a 203c 2051 4b35 5f30  j = 0; j < QK5_0
-00092cc0: 3b20 6a20 2b3d 2032 2920 7b0a 2020 2020  ; j += 2) {.    
-00092cd0: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00092ce0: 7420 7569 6e74 385f 7420 7668 3020 3d20  t uint8_t vh0 = 
-00092cf0: 2828 7168 2026 2028 3175 203c 3c20 286a  ((qh & (1u << (j
-00092d00: 202b 2030 2029 2929 203e 3e20 286a 202b   + 0 ))) >> (j +
-00092d10: 2030 2029 2920 3c3c 2034 3b0a 2020 2020   0 )) << 4;.    
-00092d20: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
-00092d30: 7420 7569 6e74 385f 7420 7668 3120 3d20  t uint8_t vh1 = 
-00092d40: 2828 7168 2026 2028 3175 203c 3c20 286a  ((qh & (1u << (j
-00092d50: 202b 2031 3629 2929 203e 3e20 286a 202b   + 16))) >> (j +
-00092d60: 2031 3229 293b 0a0a 2020 2020 2020 2020   12));..        
-00092d70: 2020 2020 2020 2020 2f2f 2063 6173 7420          // cast 
-00092d80: 746f 2031 3620 6269 6e73 0a20 2020 2020  to 16 bins.     
-00092d90: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-00092da0: 2075 696e 7438 5f74 2076 6930 203d 2028   uint8_t vi0 = (
-00092db0: 2879 5b69 5d2e 7173 5b6a 2f32 5d20 2620  (y[i].qs[j/2] & 
-00092dc0: 3078 3046 2920 7c20 7668 3029 202f 2032  0x0F) | vh0) / 2
-00092dd0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00092de0: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
-00092df0: 7669 3120 3d20 2828 795b 695d 2e71 735b  vi1 = ((y[i].qs[
-00092e00: 6a2f 325d 203e 3e20 2020 3429 207c 2076  j/2] >>   4) | v
-00092e10: 6831 2920 2f20 323b 0a0a 2020 2020 2020  h1) / 2;..      
-00092e20: 2020 2020 2020 2020 2020 6869 7374 5b76            hist[v
-00092e30: 6930 5d2b 2b3b 0a20 2020 2020 2020 2020  i0]++;.         
-00092e40: 2020 2020 2020 2068 6973 745b 7669 315d         hist[vi1]
-00092e50: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
-00092e60: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
-00092e70: 7d0a 0a20 2020 2072 6574 7572 6e20 286e  }..    return (n
-00092e80: 2f51 4b35 5f30 2a73 697a 656f 6628 626c  /QK5_0*sizeof(bl
-00092e90: 6f63 6b5f 7135 5f30 2929 3b0a 7d0a 0a73  ock_q5_0));.}..s
-00092ea0: 697a 655f 7420 6767 6d6c 5f71 7561 6e74  ize_t ggml_quant
-00092eb0: 697a 655f 7135 5f31 2863 6f6e 7374 2066  ize_q5_1(const f
-00092ec0: 6c6f 6174 202a 2073 7263 2c20 766f 6964  loat * src, void
-00092ed0: 202a 2064 7374 2c20 696e 7420 6e2c 2069   * dst, int n, i
-00092ee0: 6e74 206b 2c20 696e 7436 345f 7420 2a20  nt k, int64_t * 
-00092ef0: 6869 7374 2920 7b0a 2020 2020 6173 7365  hist) {.    asse
-00092f00: 7274 286b 2025 2051 4b35 5f31 203d 3d20  rt(k % QK5_1 == 
-00092f10: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
-00092f20: 7420 6e62 203d 206b 202f 2051 4b35 5f31  t nb = k / QK5_1
-00092f30: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
-00092f40: 6220 3d20 303b 2062 203c 206e 3b20 6220  b = 0; b < n; b 
-00092f50: 2b3d 206b 2920 7b0a 2020 2020 2020 2020  += k) {.        
-00092f60: 626c 6f63 6b5f 7135 5f31 202a 2072 6573  block_q5_1 * res
-00092f70: 7472 6963 7420 7920 3d20 2862 6c6f 636b  trict y = (block
-00092f80: 5f71 355f 3120 2a29 6473 7420 2b20 622f  _q5_1 *)dst + b/
-00092f90: 514b 355f 313b 0a0a 2020 2020 2020 2020  QK5_1;..        
-00092fa0: 7175 616e 7469 7a65 5f72 6f77 5f71 355f  quantize_row_q5_
-00092fb0: 315f 7265 6665 7265 6e63 6528 7372 6320  1_reference(src 
-00092fc0: 2b20 622c 2079 2c20 6b29 3b0a 0a20 2020  + b, y, k);..   
-00092fd0: 2020 2020 2066 6f72 2028 696e 7420 6920       for (int i 
-00092fe0: 3d20 303b 2069 203c 206e 623b 2069 2b2b  = 0; i < nb; i++
-00092ff0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-00093000: 7569 6e74 3332 5f74 2071 683b 0a20 2020  uint32_t qh;.   
-00093010: 2020 2020 2020 2020 206d 656d 6370 7928           memcpy(
-00093020: 2671 682c 2026 795b 695d 2e71 682c 2073  &qh, &y[i].qh, s
-00093030: 697a 656f 6628 7168 2929 3b0a 0a20 2020  izeof(qh));..   
-00093040: 2020 2020 2020 2020 2066 6f72 2028 696e           for (in
-00093050: 7420 6a20 3d20 303b 206a 203c 2051 4b35  t j = 0; j < QK5
-00093060: 5f31 3b20 6a20 2b3d 2032 2920 7b0a 2020  _1; j += 2) {.  
-00093070: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00093080: 6e73 7420 7569 6e74 385f 7420 7668 3020  nst uint8_t vh0 
-00093090: 3d20 2828 7168 2026 2028 3175 203c 3c20  = ((qh & (1u << 
-000930a0: 286a 202b 2030 2029 2929 203e 3e20 286a  (j + 0 ))) >> (j
-000930b0: 202b 2030 2029 2920 3c3c 2034 3b0a 2020   + 0 )) << 4;.  
-000930c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000930d0: 6e73 7420 7569 6e74 385f 7420 7668 3120  nst uint8_t vh1 
-000930e0: 3d20 2828 7168 2026 2028 3175 203c 3c20  = ((qh & (1u << 
-000930f0: 286a 202b 2031 3629 2929 203e 3e20 286a  (j + 16))) >> (j
-00093100: 202b 2031 3229 293b 0a0a 2020 2020 2020   + 12));..      
-00093110: 2020 2020 2020 2020 2020 2f2f 2063 6173            // cas
-00093120: 7420 746f 2031 3620 6269 6e73 0a20 2020  t to 16 bins.   
-00093130: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00093140: 7374 2075 696e 7438 5f74 2076 6930 203d  st uint8_t vi0 =
-00093150: 2028 2879 5b69 5d2e 7173 5b6a 2f32 5d20   ((y[i].qs[j/2] 
-00093160: 2620 3078 3046 2920 7c20 7668 3029 202f  & 0x0F) | vh0) /
-00093170: 2032 3b0a 2020 2020 2020 2020 2020 2020   2;.            
-00093180: 2020 2020 636f 6e73 7420 7569 6e74 385f      const uint8_
-00093190: 7420 7669 3120 3d20 2828 795b 695d 2e71  t vi1 = ((y[i].q
-000931a0: 735b 6a2f 325d 203e 3e20 2020 3429 207c  s[j/2] >>   4) |
-000931b0: 2076 6831 2920 2f20 323b 0a0a 2020 2020   vh1) / 2;..    
-000931c0: 2020 2020 2020 2020 2020 2020 6869 7374              hist
-000931d0: 5b76 6930 5d2b 2b3b 0a20 2020 2020 2020  [vi0]++;.       
-000931e0: 2020 2020 2020 2020 2068 6973 745b 7669           hist[vi
-000931f0: 315d 2b2b 3b0a 2020 2020 2020 2020 2020  1]++;.          
-00093200: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-00093210: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-00093220: 286e 2f51 4b35 5f31 2a73 697a 656f 6628  (n/QK5_1*sizeof(
-00093230: 626c 6f63 6b5f 7135 5f31 2929 3b0a 7d0a  block_q5_1));.}.
-00093240: 0a73 697a 655f 7420 6767 6d6c 5f71 7561  .size_t ggml_qua
-00093250: 6e74 697a 655f 7138 5f30 2863 6f6e 7374  ntize_q8_0(const
-00093260: 2066 6c6f 6174 202a 2073 7263 2c20 766f   float * src, vo
-00093270: 6964 202a 2064 7374 2c20 696e 7420 6e2c  id * dst, int n,
-00093280: 2069 6e74 206b 2c20 696e 7436 345f 7420   int k, int64_t 
-00093290: 2a20 6869 7374 2920 7b0a 2020 2020 6173  * hist) {.    as
-000932a0: 7365 7274 286b 2025 2051 4b38 5f30 203d  sert(k % QK8_0 =
-000932b0: 3d20 3029 3b0a 2020 2020 636f 6e73 7420  = 0);.    const 
-000932c0: 696e 7420 6e62 203d 206b 202f 2051 4b38  int nb = k / QK8
-000932d0: 5f30 3b0a 0a20 2020 2066 6f72 2028 696e  _0;..    for (in
-000932e0: 7420 6220 3d20 303b 2062 203c 206e 3b20  t b = 0; b < n; 
-000932f0: 6220 2b3d 206b 2920 7b0a 2020 2020 2020  b += k) {.      
-00093300: 2020 626c 6f63 6b5f 7138 5f30 202a 2072    block_q8_0 * r
-00093310: 6573 7472 6963 7420 7920 3d20 2862 6c6f  estrict y = (blo
-00093320: 636b 5f71 385f 3020 2a29 6473 7420 2b20  ck_q8_0 *)dst + 
-00093330: 622f 514b 385f 303b 0a0a 2020 2020 2020  b/QK8_0;..      
-00093340: 2020 7175 616e 7469 7a65 5f72 6f77 5f71    quantize_row_q
-00093350: 385f 305f 7265 6665 7265 6e63 6528 7372  8_0_reference(sr
-00093360: 6320 2b20 622c 2079 2c20 6b29 3b0a 0a20  c + b, y, k);.. 
-00093370: 2020 2020 2020 2066 6f72 2028 696e 7420         for (int 
-00093380: 6920 3d20 303b 2069 203c 206e 623b 2069  i = 0; i < nb; i
-00093390: 2b2b 2920 7b0a 2020 2020 2020 2020 2020  ++) {.          
-000933a0: 2020 666f 7220 2869 6e74 206a 203d 2030    for (int j = 0
-000933b0: 3b20 6a20 3c20 514b 385f 303b 202b 2b6a  ; j < QK8_0; ++j
-000933c0: 2920 7b0a 2020 2020 2020 2020 2020 2020  ) {.            
-000933d0: 2020 2020 636f 6e73 7420 696e 7438 5f74      const int8_t
-000933e0: 2076 6920 3d20 795b 695d 2e71 735b 6a5d   vi = y[i].qs[j]
-000933f0: 3b0a 0a20 2020 2020 2020 2020 2020 2020  ;..             
-00093400: 2020 2068 6973 745b 7669 2f31 3620 2b20     hist[vi/16 + 
-00093410: 385d 2b2b 3b0a 2020 2020 2020 2020 2020  8]++;.          
-00093420: 2020 7d0a 2020 2020 2020 2020 7d0a 2020    }.        }.  
-00093430: 2020 7d0a 0a20 2020 2072 6574 7572 6e20    }..    return 
-00093440: 286e 2f51 4b38 5f30 2a73 697a 656f 6628  (n/QK8_0*sizeof(
-00093450: 626c 6f63 6b5f 7138 5f30 2929 3b0a 7d0a  block_q8_0));.}.
-00093460: 0a73 697a 655f 7420 6767 6d6c 5f71 7561  .size_t ggml_qua
-00093470: 6e74 697a 655f 6368 756e 6b28 656e 756d  ntize_chunk(enum
-00093480: 2067 676d 6c5f 7479 7065 2074 7970 652c   ggml_type type,
-00093490: 2063 6f6e 7374 2066 6c6f 6174 202a 2073   const float * s
-000934a0: 7263 2c20 766f 6964 202a 2064 7374 2c20  rc, void * dst, 
-000934b0: 696e 7420 7374 6172 742c 2069 6e74 206e  int start, int n
-000934c0: 2c20 696e 7436 345f 7420 2a20 6869 7374  , int64_t * hist
-000934d0: 2920 7b0a 2020 2020 7369 7a65 5f74 2072  ) {.    size_t r
-000934e0: 6573 756c 7420 3d20 303b 0a20 2020 2073  esult = 0;.    s
-000934f0: 7769 7463 6820 2874 7970 6529 207b 0a20  witch (type) {. 
-00093500: 2020 2020 2020 2063 6173 6520 4747 4d4c         case GGML
-00093510: 5f54 5950 455f 5134 5f30 3a0a 2020 2020  _TYPE_Q4_0:.    
-00093520: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-00093530: 2020 2020 2020 2020 2020 4747 4d4c 5f41            GGML_A
-00093540: 5353 4552 5428 7374 6172 7420 2520 514b  SSERT(start % QK
-00093550: 345f 3020 3d3d 2030 293b 0a20 2020 2020  4_0 == 0);.     
-00093560: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
-00093570: 5f71 345f 3020 2a20 626c 6f63 6b20 3d20  _q4_0 * block = 
-00093580: 2862 6c6f 636b 5f71 345f 302a 2964 7374  (block_q4_0*)dst
-00093590: 202b 2073 7461 7274 202f 2051 4b34 5f30   + start / QK4_0
-000935a0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-000935b0: 2020 7265 7375 6c74 203d 2067 676d 6c5f    result = ggml_
-000935c0: 7175 616e 7469 7a65 5f71 345f 3028 7372  quantize_q4_0(sr
-000935d0: 6320 2b20 7374 6172 742c 2062 6c6f 636b  c + start, block
-000935e0: 2c20 6e2c 206e 2c20 6869 7374 293b 0a20  , n, n, hist);. 
-000935f0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00093600: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00093610: 2047 474d 4c5f 5459 5045 5f51 345f 313a   GGML_TYPE_Q4_1:
-00093620: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00093630: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00093640: 474d 4c5f 4153 5345 5254 2873 7461 7274  GML_ASSERT(start
-00093650: 2025 2051 4b34 5f31 203d 3d20 3029 3b0a   % QK4_1 == 0);.
-00093660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00093670: 626c 6f63 6b5f 7134 5f31 202a 2062 6c6f  block_q4_1 * blo
-00093680: 636b 203d 2028 626c 6f63 6b5f 7134 5f31  ck = (block_q4_1
-00093690: 2a29 6473 7420 2b20 7374 6172 7420 2f20  *)dst + start / 
-000936a0: 514b 345f 313b 0a20 2020 2020 2020 2020  QK4_1;.         
-000936b0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-000936c0: 6767 6d6c 5f71 7561 6e74 697a 655f 7134  ggml_quantize_q4
-000936d0: 5f31 2873 7263 202b 2073 7461 7274 2c20  _1(src + start, 
-000936e0: 626c 6f63 6b2c 206e 2c20 6e2c 2068 6973  block, n, n, his
-000936f0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
-00093700: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
-00093710: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
-00093720: 5135 5f30 3a0a 2020 2020 2020 2020 2020  Q5_0:.          
-00093730: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00093740: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
-00093750: 7374 6172 7420 2520 514b 355f 3020 3d3d  start % QK5_0 ==
-00093760: 2030 293b 0a20 2020 2020 2020 2020 2020   0);.           
-00093770: 2020 2020 2062 6c6f 636b 5f71 355f 3020       block_q5_0 
-00093780: 2a20 626c 6f63 6b20 3d20 2862 6c6f 636b  * block = (block
-00093790: 5f71 355f 302a 2964 7374 202b 2073 7461  _q5_0*)dst + sta
-000937a0: 7274 202f 2051 4b35 5f30 3b0a 2020 2020  rt / QK5_0;.    
-000937b0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-000937c0: 6c74 203d 2067 676d 6c5f 7175 616e 7469  lt = ggml_quanti
-000937d0: 7a65 5f71 355f 3028 7372 6320 2b20 7374  ze_q5_0(src + st
-000937e0: 6172 742c 2062 6c6f 636b 2c20 6e2c 206e  art, block, n, n
-000937f0: 2c20 6869 7374 293b 0a20 2020 2020 2020  , hist);.       
-00093800: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
-00093810: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
-00093820: 5459 5045 5f51 355f 313a 0a20 2020 2020  TYPE_Q5_1:.     
-00093830: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00093840: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
-00093850: 5345 5254 2873 7461 7274 2025 2051 4b35  SERT(start % QK5
-00093860: 5f31 203d 3d20 3029 3b0a 2020 2020 2020  _1 == 0);.      
-00093870: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
-00093880: 7135 5f31 202a 2062 6c6f 636b 203d 2028  q5_1 * block = (
-00093890: 626c 6f63 6b5f 7135 5f31 2a29 6473 7420  block_q5_1*)dst 
-000938a0: 2b20 7374 6172 7420 2f20 514b 355f 313b  + start / QK5_1;
-000938b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000938c0: 2072 6573 756c 7420 3d20 6767 6d6c 5f71   result = ggml_q
-000938d0: 7561 6e74 697a 655f 7135 5f31 2873 7263  uantize_q5_1(src
-000938e0: 202b 2073 7461 7274 2c20 626c 6f63 6b2c   + start, block,
-000938f0: 206e 2c20 6e2c 2068 6973 7429 3b0a 2020   n, n, hist);.  
-00093900: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
-00093910: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
-00093920: 4747 4d4c 5f54 5950 455f 5138 5f30 3a0a  GGML_TYPE_Q8_0:.
-00093930: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00093940: 2020 2020 2020 2020 2020 2020 2020 4747                GG
-00093950: 4d4c 5f41 5353 4552 5428 7374 6172 7420  ML_ASSERT(start 
-00093960: 2520 514b 385f 3020 3d3d 2030 293b 0a20  % QK8_0 == 0);. 
-00093970: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00093980: 6c6f 636b 5f71 385f 3020 2a20 626c 6f63  lock_q8_0 * bloc
-00093990: 6b20 3d20 2862 6c6f 636b 5f71 385f 302a  k = (block_q8_0*
-000939a0: 2964 7374 202b 2073 7461 7274 202f 2051  )dst + start / Q
-000939b0: 4b38 5f30 3b0a 2020 2020 2020 2020 2020  K8_0;.          
-000939c0: 2020 2020 2020 7265 7375 6c74 203d 2067        result = g
-000939d0: 676d 6c5f 7175 616e 7469 7a65 5f71 385f  gml_quantize_q8_
-000939e0: 3028 7372 6320 2b20 7374 6172 742c 2062  0(src + start, b
-000939f0: 6c6f 636b 2c20 6e2c 206e 2c20 6869 7374  lock, n, n, hist
-00093a00: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00093a10: 2062 7265 616b 3b0a 2369 6664 6566 2047   break;.#ifdef G
-00093a20: 474d 4c5f 5553 455f 4b5f 5155 414e 5453  GML_USE_K_QUANTS
-00093a30: 0a20 2020 2020 2020 2063 6173 6520 4747  .        case GG
-00093a40: 4d4c 5f54 5950 455f 5132 5f4b 3a0a 2020  ML_TYPE_Q2_K:.  
-00093a50: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00093a60: 2020 2020 2020 2020 2020 2020 4747 4d4c              GGML
-00093a70: 5f41 5353 4552 5428 7374 6172 7420 2520  _ASSERT(start % 
-00093a80: 514b 5f4b 203d 3d20 3029 3b0a 2020 2020  QK_K == 0);.    
-00093a90: 2020 2020 2020 2020 2020 2020 626c 6f63              bloc
-00093aa0: 6b5f 7132 5f4b 202a 2062 6c6f 636b 203d  k_q2_K * block =
-00093ab0: 2028 626c 6f63 6b5f 7132 5f4b 2a29 6473   (block_q2_K*)ds
-00093ac0: 7420 2b20 7374 6172 7420 2f20 514b 5f4b  t + start / QK_K
-00093ad0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00093ae0: 2020 7265 7375 6c74 203d 2067 676d 6c5f    result = ggml_
-00093af0: 7175 616e 7469 7a65 5f71 325f 4b28 7372  quantize_q2_K(sr
-00093b00: 6320 2b20 7374 6172 742c 2062 6c6f 636b  c + start, block
-00093b10: 2c20 6e2c 206e 2c20 6869 7374 293b 0a20  , n, n, hist);. 
-00093b20: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00093b30: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00093b40: 2047 474d 4c5f 5459 5045 5f51 335f 4b3a   GGML_TYPE_Q3_K:
-00093b50: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00093b60: 2020 2020 2020 2020 2020 2020 2020 2047                 G
-00093b70: 474d 4c5f 4153 5345 5254 2873 7461 7274  GML_ASSERT(start
-00093b80: 2025 2051 4b5f 4b20 3d3d 2030 293b 0a20   % QK_K == 0);. 
-00093b90: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00093ba0: 6c6f 636b 5f71 335f 4b20 2a20 626c 6f63  lock_q3_K * bloc
-00093bb0: 6b20 3d20 2862 6c6f 636b 5f71 335f 4b2a  k = (block_q3_K*
-00093bc0: 2964 7374 202b 2073 7461 7274 202f 2051  )dst + start / Q
-00093bd0: 4b5f 4b3b 0a20 2020 2020 2020 2020 2020  K_K;.           
-00093be0: 2020 2020 2072 6573 756c 7420 3d20 6767       result = gg
-00093bf0: 6d6c 5f71 7561 6e74 697a 655f 7133 5f4b  ml_quantize_q3_K
-00093c00: 2873 7263 202b 2073 7461 7274 2c20 626c  (src + start, bl
-00093c10: 6f63 6b2c 206e 2c20 6e2c 2068 6973 7429  ock, n, n, hist)
-00093c20: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
-00093c30: 6272 6561 6b3b 0a20 2020 2020 2020 2063  break;.        c
-00093c40: 6173 6520 4747 4d4c 5f54 5950 455f 5134  ase GGML_TYPE_Q4
-00093c50: 5f4b 3a0a 2020 2020 2020 2020 2020 2020  _K:.            
-00093c60: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00093c70: 2020 4747 4d4c 5f41 5353 4552 5428 7374    GGML_ASSERT(st
-00093c80: 6172 7420 2520 514b 5f4b 203d 3d20 3029  art % QK_K == 0)
-00093c90: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00093ca0: 2020 626c 6f63 6b5f 7134 5f4b 202a 2062    block_q4_K * b
-00093cb0: 6c6f 636b 203d 2028 626c 6f63 6b5f 7134  lock = (block_q4
-00093cc0: 5f4b 2a29 6473 7420 2b20 7374 6172 7420  _K*)dst + start 
-00093cd0: 2f20 514b 5f4b 3b0a 2020 2020 2020 2020  / QK_K;.        
-00093ce0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00093cf0: 2067 676d 6c5f 7175 616e 7469 7a65 5f71   ggml_quantize_q
-00093d00: 345f 4b28 7372 6320 2b20 7374 6172 742c  4_K(src + start,
-00093d10: 2062 6c6f 636b 2c20 6e2c 206e 2c20 6869   block, n, n, hi
-00093d20: 7374 293b 0a20 2020 2020 2020 2020 2020  st);.           
-00093d30: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
-00093d40: 2020 6361 7365 2047 474d 4c5f 5459 5045    case GGML_TYPE
-00093d50: 5f51 355f 4b3a 0a20 2020 2020 2020 2020  _Q5_K:.         
-00093d60: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00093d70: 2020 2020 2047 474d 4c5f 4153 5345 5254       GGML_ASSERT
-00093d80: 2873 7461 7274 2025 2051 4b5f 4b20 3d3d  (start % QK_K ==
-00093d90: 2030 293b 0a20 2020 2020 2020 2020 2020   0);.           
-00093da0: 2020 2020 2062 6c6f 636b 5f71 355f 4b20       block_q5_K 
-00093db0: 2a20 626c 6f63 6b20 3d20 2862 6c6f 636b  * block = (block
-00093dc0: 5f71 355f 4b2a 2964 7374 202b 2073 7461  _q5_K*)dst + sta
-00093dd0: 7274 202f 2051 4b5f 4b3b 0a20 2020 2020  rt / QK_K;.     
-00093de0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
-00093df0: 7420 3d20 6767 6d6c 5f71 7561 6e74 697a  t = ggml_quantiz
-00093e00: 655f 7135 5f4b 2873 7263 202b 2073 7461  e_q5_K(src + sta
-00093e10: 7274 2c20 626c 6f63 6b2c 206e 2c20 6e2c  rt, block, n, n,
-00093e20: 2068 6973 7429 3b0a 2020 2020 2020 2020   hist);.        
-00093e30: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
-00093e40: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
-00093e50: 5950 455f 5136 5f4b 3a0a 2020 2020 2020  YPE_Q6_K:.      
-00093e60: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-00093e70: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
-00093e80: 4552 5428 7374 6172 7420 2520 514b 5f4b  ERT(start % QK_K
-00093e90: 203d 3d20 3029 3b0a 2020 2020 2020 2020   == 0);.        
-00093ea0: 2020 2020 2020 2020 626c 6f63 6b5f 7136          block_q6
-00093eb0: 5f4b 202a 2062 6c6f 636b 203d 2028 626c  _K * block = (bl
-00093ec0: 6f63 6b5f 7136 5f4b 2a29 6473 7420 2b20  ock_q6_K*)dst + 
-00093ed0: 7374 6172 7420 2f20 514b 5f4b 3b0a 2020  start / QK_K;.  
-00093ee0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00093ef0: 7375 6c74 203d 2067 676d 6c5f 7175 616e  sult = ggml_quan
-00093f00: 7469 7a65 5f71 365f 4b28 7372 6320 2b20  tize_q6_K(src + 
-00093f10: 7374 6172 742c 2062 6c6f 636b 2c20 6e2c  start, block, n,
-00093f20: 206e 2c20 6869 7374 293b 0a20 2020 2020   n, hist);.     
-00093f30: 2020 2020 2020 207d 2062 7265 616b 3b0a         } break;.
-00093f40: 2365 6e64 6966 0a20 2020 2020 2020 2063  #endif.        c
-00093f50: 6173 6520 4747 4d4c 5f54 5950 455f 4631  ase GGML_TYPE_F1
-00093f60: 363a 0a20 2020 2020 2020 2020 2020 207b  6:.            {
-00093f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00093f80: 2069 6e74 2065 6c65 6d73 697a 6520 3d20   int elemsize = 
-00093f90: 7369 7a65 6f66 2867 676d 6c5f 6670 3136  sizeof(ggml_fp16
-00093fa0: 5f74 293b 0a20 2020 2020 2020 2020 2020  _t);.           
-00093fb0: 2020 2020 2067 676d 6c5f 6670 3332 5f74       ggml_fp32_t
-00093fc0: 6f5f 6670 3136 5f72 6f77 2873 7263 202b  o_fp16_row(src +
-00093fd0: 2073 7461 7274 2c20 2867 676d 6c5f 6670   start, (ggml_fp
-00093fe0: 3136 5f74 202a 2964 7374 202b 2073 7461  16_t *)dst + sta
-00093ff0: 7274 2c20 6e29 3b0a 2020 2020 2020 2020  rt, n);.        
-00094000: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00094010: 206e 202a 2065 6c65 6d73 697a 653b 0a20   n * elemsize;. 
-00094020: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
-00094030: 616b 3b0a 2020 2020 2020 2020 6361 7365  ak;.        case
-00094040: 2047 474d 4c5f 5459 5045 5f46 3332 3a0a   GGML_TYPE_F32:.
-00094050: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00094060: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00094070: 7420 656c 656d 7369 7a65 203d 2073 697a  t elemsize = siz
-00094080: 656f 6628 666c 6f61 7429 3b0a 2020 2020  eof(float);.    
-00094090: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-000940a0: 6c74 203d 206e 202a 2065 6c65 6d73 697a  lt = n * elemsiz
-000940b0: 653b 0a20 2020 2020 2020 2020 2020 2020  e;.             
-000940c0: 2020 206d 656d 6370 7928 2875 696e 7438     memcpy((uint8
-000940d0: 5f74 202a 2964 7374 202b 2073 7461 7274  _t *)dst + start
-000940e0: 202a 2065 6c65 6d73 697a 652c 2073 7263   * elemsize, src
-000940f0: 202b 2073 7461 7274 2c20 7265 7375 6c74   + start, result
-00094100: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
-00094110: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
-00094120: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
-00094130: 2020 2020 2061 7373 6572 7428 6661 6c73       assert(fals
-00094140: 6529 3b0a 2020 2020 7d0a 2020 2020 7265  e);.    }.    re
-00094150: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
-00094160: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00094170: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00094180: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00094190: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000941a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-000941b0: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
-000941c0: 6173 5f61 7678 2876 6f69 6429 207b 0a23  as_avx(void) {.#
-000941d0: 6966 2064 6566 696e 6564 285f 5f41 5658  if defined(__AVX
-000941e0: 5f5f 290a 2020 2020 7265 7475 726e 2031  __).    return 1
-000941f0: 3b0a 2365 6c73 650a 2020 2020 7265 7475  ;.#else.    retu
-00094200: 726e 2030 3b0a 2365 6e64 6966 0a7d 0a0a  rn 0;.#endif.}..
-00094210: 696e 7420 6767 6d6c 5f63 7075 5f68 6173  int ggml_cpu_has
-00094220: 5f61 7678 3228 766f 6964 2920 7b0a 2369  _avx2(void) {.#i
-00094230: 6620 6465 6669 6e65 6428 5f5f 4156 5832  f defined(__AVX2
-00094240: 5f5f 290a 2020 2020 7265 7475 726e 2031  __).    return 1
-00094250: 3b0a 2365 6c73 650a 2020 2020 7265 7475  ;.#else.    retu
-00094260: 726e 2030 3b0a 2365 6e64 6966 0a7d 0a0a  rn 0;.#endif.}..
-00094270: 696e 7420 6767 6d6c 5f63 7075 5f68 6173  int ggml_cpu_has
-00094280: 5f61 7678 3531 3228 766f 6964 2920 7b0a  _avx512(void) {.
-00094290: 2369 6620 6465 6669 6e65 6428 5f5f 4156  #if defined(__AV
-000942a0: 5835 3132 465f 5f29 0a20 2020 2072 6574  X512F__).    ret
-000942b0: 7572 6e20 313b 0a23 656c 7365 0a20 2020  urn 1;.#else.   
-000942c0: 2072 6574 7572 6e20 303b 0a23 656e 6469   return 0;.#endi
-000942d0: 660a 7d0a 0a69 6e74 2067 676d 6c5f 6370  f.}..int ggml_cp
-000942e0: 755f 6861 735f 6176 7835 3132 5f76 626d  u_has_avx512_vbm
-000942f0: 6928 766f 6964 2920 7b0a 2369 6620 6465  i(void) {.#if de
-00094300: 6669 6e65 6428 5f5f 4156 5835 3132 5642  fined(__AVX512VB
-00094310: 4d49 5f5f 290a 2020 2020 7265 7475 726e  MI__).    return
-00094320: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
-00094330: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
-00094340: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
-00094350: 6173 5f61 7678 3531 325f 766e 6e69 2876  as_avx512_vnni(v
-00094360: 6f69 6429 207b 0a23 6966 2064 6566 696e  oid) {.#if defin
-00094370: 6564 285f 5f41 5658 3531 3256 4e4e 495f  ed(__AVX512VNNI_
-00094380: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
-00094390: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
-000943a0: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
-000943b0: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
-000943c0: 666d 6128 766f 6964 2920 7b0a 2369 6620  fma(void) {.#if 
-000943d0: 6465 6669 6e65 6428 5f5f 464d 415f 5f29  defined(__FMA__)
-000943e0: 0a20 2020 2072 6574 7572 6e20 313b 0a23  .    return 1;.#
-000943f0: 656c 7365 0a20 2020 2072 6574 7572 6e20  else.    return 
-00094400: 303b 0a23 656e 6469 660a 7d0a 0a69 6e74  0;.#endif.}..int
-00094410: 2067 676d 6c5f 6370 755f 6861 735f 6e65   ggml_cpu_has_ne
-00094420: 6f6e 2876 6f69 6429 207b 0a23 6966 2064  on(void) {.#if d
-00094430: 6566 696e 6564 285f 5f41 524d 5f4e 454f  efined(__ARM_NEO
-00094440: 4e29 0a20 2020 2072 6574 7572 6e20 313b  N).    return 1;
-00094450: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
-00094460: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
-00094470: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
-00094480: 6172 6d5f 666d 6128 766f 6964 2920 7b0a  arm_fma(void) {.
-00094490: 2369 6620 6465 6669 6e65 6428 5f5f 4152  #if defined(__AR
-000944a0: 4d5f 4645 4154 5552 455f 464d 4129 0a20  M_FEATURE_FMA). 
-000944b0: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
-000944c0: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
-000944d0: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
-000944e0: 676d 6c5f 6370 755f 6861 735f 6631 3663  gml_cpu_has_f16c
-000944f0: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
-00094500: 696e 6564 285f 5f46 3136 435f 5f29 0a20  ined(__F16C__). 
-00094510: 2020 2072 6574 7572 6e20 313b 0a23 656c     return 1;.#el
-00094520: 7365 0a20 2020 2072 6574 7572 6e20 303b  se.    return 0;
-00094530: 0a23 656e 6469 660a 7d0a 0a69 6e74 2067  .#endif.}..int g
-00094540: 676d 6c5f 6370 755f 6861 735f 6670 3136  gml_cpu_has_fp16
-00094550: 5f76 6128 766f 6964 2920 7b0a 2369 6620  _va(void) {.#if 
-00094560: 6465 6669 6e65 6428 5f5f 4152 4d5f 4645  defined(__ARM_FE
-00094570: 4154 5552 455f 4650 3136 5f56 4543 544f  ATURE_FP16_VECTO
-00094580: 525f 4152 4954 484d 4554 4943 290a 2020  R_ARITHMETIC).  
-00094590: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
-000945a0: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
-000945b0: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
-000945c0: 6d6c 5f63 7075 5f68 6173 5f77 6173 6d5f  ml_cpu_has_wasm_
-000945d0: 7369 6d64 2876 6f69 6429 207b 0a23 6966  simd(void) {.#if
-000945e0: 2064 6566 696e 6564 285f 5f77 6173 6d5f   defined(__wasm_
-000945f0: 7369 6d64 3132 385f 5f29 0a20 2020 2072  simd128__).    r
-00094600: 6574 7572 6e20 313b 0a23 656c 7365 0a20  eturn 1;.#else. 
-00094610: 2020 2072 6574 7572 6e20 303b 0a23 656e     return 0;.#en
-00094620: 6469 660a 7d0a 0a69 6e74 2067 676d 6c5f  dif.}..int ggml_
-00094630: 6370 755f 6861 735f 626c 6173 2876 6f69  cpu_has_blas(voi
-00094640: 6429 207b 0a23 6966 2064 6566 696e 6564  d) {.#if defined
-00094650: 2847 474d 4c5f 5553 455f 4143 4345 4c45  (GGML_USE_ACCELE
-00094660: 5241 5445 2920 7c7c 2064 6566 696e 6564  RATE) || defined
-00094670: 2847 474d 4c5f 5553 455f 4f50 454e 424c  (GGML_USE_OPENBL
-00094680: 4153 2920 7c7c 2064 6566 696e 6564 2847  AS) || defined(G
-00094690: 474d 4c5f 5553 455f 4355 424c 4153 2920  GML_USE_CUBLAS) 
-000946a0: 7c7c 2064 6566 696e 6564 2847 474d 4c5f  || defined(GGML_
-000946b0: 5553 455f 434c 424c 4153 5429 0a20 2020  USE_CLBLAST).   
-000946c0: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
-000946d0: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
-000946e0: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
-000946f0: 6c5f 6370 755f 6861 735f 6375 626c 6173  l_cpu_has_cublas
-00094700: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
-00094710: 696e 6564 2847 474d 4c5f 5553 455f 4355  ined(GGML_USE_CU
-00094720: 424c 4153 290a 2020 2020 7265 7475 726e  BLAS).    return
-00094730: 2031 3b0a 2365 6c73 650a 2020 2020 7265   1;.#else.    re
-00094740: 7475 726e 2030 3b0a 2365 6e64 6966 0a7d  turn 0;.#endif.}
-00094750: 0a0a 696e 7420 6767 6d6c 5f63 7075 5f68  ..int ggml_cpu_h
-00094760: 6173 5f63 6c62 6c61 7374 2876 6f69 6429  as_clblast(void)
-00094770: 207b 0a23 6966 2064 6566 696e 6564 2847   {.#if defined(G
-00094780: 474d 4c5f 5553 455f 434c 424c 4153 5429  GML_USE_CLBLAST)
-00094790: 0a20 2020 2072 6574 7572 6e20 313b 0a23  .    return 1;.#
-000947a0: 656c 7365 0a20 2020 2072 6574 7572 6e20  else.    return 
-000947b0: 303b 0a23 656e 6469 660a 7d0a 0a69 6e74  0;.#endif.}..int
-000947c0: 2067 676d 6c5f 6370 755f 6861 735f 6770   ggml_cpu_has_gp
-000947d0: 7562 6c61 7328 766f 6964 2920 7b0a 2020  ublas(void) {.  
-000947e0: 2020 7265 7475 726e 2067 676d 6c5f 6370    return ggml_cp
-000947f0: 755f 6861 735f 6375 626c 6173 2829 207c  u_has_cublas() |
-00094800: 7c20 6767 6d6c 5f63 7075 5f68 6173 5f63  | ggml_cpu_has_c
-00094810: 6c62 6c61 7374 2829 3b0a 7d0a 0a69 6e74  lblast();.}..int
-00094820: 2067 676d 6c5f 6370 755f 6861 735f 7373   ggml_cpu_has_ss
-00094830: 6533 2876 6f69 6429 207b 0a23 6966 2064  e3(void) {.#if d
-00094840: 6566 696e 6564 285f 5f53 5345 335f 5f29  efined(__SSE3__)
-00094850: 0a20 2020 2072 6574 7572 6e20 313b 0a23  .    return 1;.#
-00094860: 656c 7365 0a20 2020 2072 6574 7572 6e20  else.    return 
-00094870: 303b 0a23 656e 6469 660a 7d0a 0a69 6e74  0;.#endif.}..int
-00094880: 2067 676d 6c5f 6370 755f 6861 735f 7673   ggml_cpu_has_vs
-00094890: 7828 766f 6964 2920 7b0a 2369 6620 6465  x(void) {.#if de
-000948a0: 6669 6e65 6428 5f5f 504f 5745 5239 5f56  fined(__POWER9_V
-000948b0: 4543 544f 525f 5f29 0a20 2020 2072 6574  ECTOR__).    ret
-000948c0: 7572 6e20 313b 0a23 656c 7365 0a20 2020  urn 1;.#else.   
-000948d0: 2072 6574 7572 6e20 303b 0a23 656e 6469   return 0;.#endi
-000948e0: 660a 7d0a 0a2f 2f2f 2f2f 2f2f 2f2f 2f2f  f.}..///////////
-000948f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00094900: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00094910: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00094920: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
-00094930: 2f2f 2f2f 2f0a                           /////.
+00090f40: 2020 2020 2020 202e 6e5f 6974 6572 2020         .n_iter  
+00090f50: 2020 2020 2020 203d 2031 3030 2c0a 2020         = 100,.  
+00090f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090f70: 2020 2020 2020 2e6d 6178 5f6c 696e 6573        .max_lines
+00090f80: 6561 7263 6820 3d20 3230 2c0a 0a20 2020  earch = 20,..   
+00090f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090fa0: 2020 2020 202e 6570 7320 2020 2020 203d       .eps      =
+00090fb0: 2031 652d 3566 2c0a 2020 2020 2020 2020   1e-5f,.        
+00090fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00090fd0: 2e66 746f 6c20 2020 2020 3d20 3165 2d34  .ftol     = 1e-4
+00090fe0: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
+00090ff0: 2020 2020 2020 2020 2020 202e 776f 6c66             .wolf
+00091000: 6520 2020 203d 2030 2e39 662c 0a20 2020  e    = 0.9f,.   
+00091010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00091020: 2020 2020 202e 6d69 6e5f 7374 6570 203d       .min_step =
+00091030: 2031 652d 3230 662c 0a20 2020 2020 2020   1e-20f,.       
+00091040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00091050: 202e 6d61 785f 7374 6570 203d 2031 652b   .max_step = 1e+
+00091060: 3230 662c 0a0a 2020 2020 2020 2020 2020  20f,..          
+00091070: 2020 2020 2020 2020 2020 2020 2020 2e6c                .l
+00091080: 696e 6573 6561 7263 6820 3d20 4747 4d4c  inesearch = GGML
+00091090: 5f4c 494e 4553 4541 5243 485f 4445 4641  _LINESEARCH_DEFA
+000910a0: 554c 542c 0a20 2020 2020 2020 2020 2020  ULT,.           
+000910b0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+000910c0: 2020 2020 2020 2020 2020 2020 7d3b 0a20              };. 
+000910d0: 2020 2020 2020 2020 2020 207d 2062 7265             } bre
+000910e0: 616b 3b0a 2020 2020 7d0a 0a20 2020 2072  ak;.    }..    r
+000910f0: 6574 7572 6e20 7265 7375 6c74 3b0a 7d0a  eturn result;.}.
+00091100: 0a47 474d 4c5f 4150 4920 766f 6964 2067  .GGML_API void g
+00091110: 676d 6c5f 6f70 745f 696e 6974 280a 2020  gml_opt_init(.  
+00091120: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00091130: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+00091140: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00091150: 6767 6d6c 5f6f 7074 5f63 6f6e 7465 7874  ggml_opt_context
+00091160: 202a 206f 7074 2c0a 2020 2020 2020 2020   * opt,.        
+00091170: 7374 7275 6374 2067 676d 6c5f 6f70 745f  struct ggml_opt_
+00091180: 7061 7261 6d73 2070 6172 616d 732c 0a20  params params,. 
+00091190: 2020 2020 2020 2069 6e74 3634 5f74 206e         int64_t n
+000911a0: 7829 207b 0a20 2020 206f 7074 2d3e 6374  x) {.    opt->ct
+000911b0: 7820 3d20 6374 783b 0a20 2020 206f 7074  x = ctx;.    opt
+000911c0: 2d3e 7061 7261 6d73 203d 2070 6172 616d  ->params = param
+000911d0: 733b 0a20 2020 206f 7074 2d3e 6974 6572  s;.    opt->iter
+000911e0: 203d 2030 3b0a 2020 2020 6f70 742d 3e6e   = 0;.    opt->n
+000911f0: 7820 3d20 6e78 3b0a 2020 2020 6f70 742d  x = nx;.    opt-
+00091200: 3e6a 7573 745f 696e 6974 6961 6c69 7a65  >just_initialize
+00091210: 6420 3d20 7472 7565 3b0a 2020 2020 7377  d = true;.    sw
+00091220: 6974 6368 2028 6f70 742d 3e70 6172 616d  itch (opt->param
+00091230: 732e 7479 7065 2920 7b0a 2020 2020 2020  s.type) {.      
+00091240: 2020 6361 7365 2047 474d 4c5f 4f50 545f    case GGML_OPT_
+00091250: 4144 414d 3a0a 2020 2020 2020 2020 2020  ADAM:.          
+00091260: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00091270: 2020 2020 6f70 742d 3e61 6461 6d2e 7820      opt->adam.x 
+00091280: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+00091290: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+000912a0: 5459 5045 5f46 3332 2c20 6e78 293b 0a20  TYPE_F32, nx);. 
+000912b0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000912c0: 7074 2d3e 6164 616d 2e67 3120 3d20 6767  pt->adam.g1 = gg
+000912d0: 6d6c 5f6e 6577 5f74 656e 736f 725f 3164  ml_new_tensor_1d
+000912e0: 2863 7478 2c20 4747 4d4c 5f54 5950 455f  (ctx, GGML_TYPE_
+000912f0: 4633 322c 206e 7829 3b0a 2020 2020 2020  F32, nx);.      
+00091300: 2020 2020 2020 2020 2020 6f70 742d 3e61            opt->a
+00091310: 6461 6d2e 6732 203d 2067 676d 6c5f 6e65  dam.g2 = ggml_ne
+00091320: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+00091330: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+00091340: 6e78 293b 0a20 2020 2020 2020 2020 2020  nx);.           
+00091350: 2020 2020 206f 7074 2d3e 6164 616d 2e6d       opt->adam.m
+00091360: 2020 3d20 6767 6d6c 5f6e 6577 5f74 656e    = ggml_new_ten
+00091370: 736f 725f 3164 2863 7478 2c20 4747 4d4c  sor_1d(ctx, GGML
+00091380: 5f54 5950 455f 4633 322c 206e 7829 3b0a  _TYPE_F32, nx);.
+00091390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000913a0: 6f70 742d 3e61 6461 6d2e 7620 203d 2067  opt->adam.v  = g
+000913b0: 676d 6c5f 6e65 775f 7465 6e73 6f72 5f31  gml_new_tensor_1
+000913c0: 6428 6374 782c 2047 474d 4c5f 5459 5045  d(ctx, GGML_TYPE
+000913d0: 5f46 3332 2c20 6e78 293b 0a20 2020 2020  _F32, nx);.     
+000913e0: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
+000913f0: 6164 616d 2e6d 6820 3d20 6767 6d6c 5f6e  adam.mh = ggml_n
+00091400: 6577 5f74 656e 736f 725f 3164 2863 7478  ew_tensor_1d(ctx
+00091410: 2c20 4747 4d4c 5f54 5950 455f 4633 322c  , GGML_TYPE_F32,
+00091420: 206e 7829 3b0a 2020 2020 2020 2020 2020   nx);.          
+00091430: 2020 2020 2020 6f70 742d 3e61 6461 6d2e        opt->adam.
+00091440: 7668 203d 2067 676d 6c5f 6e65 775f 7465  vh = ggml_new_te
+00091450: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+00091460: 4c5f 5459 5045 5f46 3332 2c20 6e78 293b  L_TYPE_F32, nx);
+00091470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00091480: 206f 7074 2d3e 6164 616d 2e70 6620 3d20   opt->adam.pf = 
+00091490: 7061 7261 6d73 2e70 6173 7420 3e20 300a  params.past > 0.
+000914a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000914b0: 2020 2020 3f20 6767 6d6c 5f6e 6577 5f74      ? ggml_new_t
+000914c0: 656e 736f 725f 3164 2863 7478 2c20 4747  ensor_1d(ctx, GG
+000914d0: 4d4c 5f54 5950 455f 4633 322c 2070 6172  ML_TYPE_F32, par
+000914e0: 616d 732e 7061 7374 290a 2020 2020 2020  ams.past).      
+000914f0: 2020 2020 2020 2020 2020 2020 2020 3a20                : 
+00091500: 4e55 4c4c 3b0a 2020 2020 2020 2020 2020  NULL;.          
+00091510: 2020 2020 2020 6767 6d6c 5f73 6574 5f7a        ggml_set_z
+00091520: 6572 6f28 6f70 742d 3e61 6461 6d2e 7829  ero(opt->adam.x)
+00091530: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00091540: 2020 6767 6d6c 5f73 6574 5f7a 6572 6f28    ggml_set_zero(
+00091550: 6f70 742d 3e61 6461 6d2e 6731 293b 0a20  opt->adam.g1);. 
+00091560: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00091570: 676d 6c5f 7365 745f 7a65 726f 286f 7074  gml_set_zero(opt
+00091580: 2d3e 6164 616d 2e67 3229 3b0a 2020 2020  ->adam.g2);.    
+00091590: 2020 2020 2020 2020 2020 2020 6767 6d6c              ggml
+000915a0: 5f73 6574 5f7a 6572 6f28 6f70 742d 3e61  _set_zero(opt->a
+000915b0: 6461 6d2e 6d29 3b0a 2020 2020 2020 2020  dam.m);.        
+000915c0: 2020 2020 2020 2020 6767 6d6c 5f73 6574          ggml_set
+000915d0: 5f7a 6572 6f28 6f70 742d 3e61 6461 6d2e  _zero(opt->adam.
+000915e0: 7629 3b0a 2020 2020 2020 2020 2020 2020  v);.            
+000915f0: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
+00091600: 6f28 6f70 742d 3e61 6461 6d2e 6d68 293b  o(opt->adam.mh);
+00091610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00091620: 2067 676d 6c5f 7365 745f 7a65 726f 286f   ggml_set_zero(o
+00091630: 7074 2d3e 6164 616d 2e76 6829 3b0a 2020  pt->adam.vh);.  
+00091640: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00091650: 2028 6f70 742d 3e61 6461 6d2e 7066 2920   (opt->adam.pf) 
+00091660: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00091670: 2020 2020 2020 6767 6d6c 5f73 6574 5f7a        ggml_set_z
+00091680: 6572 6f28 6f70 742d 3e61 6461 6d2e 7066  ero(opt->adam.pf
+00091690: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+000916a0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+000916b0: 207d 2062 7265 616b 3b0a 2020 2020 2020   } break;.      
+000916c0: 2020 6361 7365 2047 474d 4c5f 4f50 545f    case GGML_OPT_
+000916d0: 4c42 4647 533a 0a20 2020 2020 2020 2020  LBFGS:.         
+000916e0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000916f0: 2020 2020 206f 7074 2d3e 6c62 6667 732e       opt->lbfgs.
+00091700: 7820 203d 2067 676d 6c5f 6e65 775f 7465  x  = ggml_new_te
+00091710: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+00091720: 4c5f 5459 5045 5f46 3332 2c20 6e78 293b  L_TYPE_F32, nx);
+00091730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00091740: 206f 7074 2d3e 6c62 6667 732e 7870 203d   opt->lbfgs.xp =
+00091750: 2067 676d 6c5f 6e65 775f 7465 6e73 6f72   ggml_new_tensor
+00091760: 5f31 6428 6374 782c 2047 474d 4c5f 5459  _1d(ctx, GGML_TY
+00091770: 5045 5f46 3332 2c20 6e78 293b 0a20 2020  PE_F32, nx);.   
+00091780: 2020 2020 2020 2020 2020 2020 206f 7074               opt
+00091790: 2d3e 6c62 6667 732e 6720 203d 2067 676d  ->lbfgs.g  = ggm
+000917a0: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
+000917b0: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
+000917c0: 3332 2c20 6e78 293b 0a20 2020 2020 2020  32, nx);.       
+000917d0: 2020 2020 2020 2020 206f 7074 2d3e 6c62           opt->lb
+000917e0: 6667 732e 6770 203d 2067 676d 6c5f 6e65  fgs.gp = ggml_ne
+000917f0: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+00091800: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+00091810: 6e78 293b 0a20 2020 2020 2020 2020 2020  nx);.           
+00091820: 2020 2020 206f 7074 2d3e 6c62 6667 732e       opt->lbfgs.
+00091830: 6420 203d 2067 676d 6c5f 6e65 775f 7465  d  = ggml_new_te
+00091840: 6e73 6f72 5f31 6428 6374 782c 2047 474d  nsor_1d(ctx, GGM
+00091850: 4c5f 5459 5045 5f46 3332 2c20 6e78 293b  L_TYPE_F32, nx);
+00091860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00091870: 206f 7074 2d3e 6c62 6667 732e 7066 203d   opt->lbfgs.pf =
+00091880: 2070 6172 616d 732e 7061 7374 203e 2030   params.past > 0
+00091890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000918a0: 2020 2020 203f 2067 676d 6c5f 6e65 775f       ? ggml_new_
+000918b0: 7465 6e73 6f72 5f31 6428 6374 782c 2047  tensor_1d(ctx, G
+000918c0: 474d 4c5f 5459 5045 5f46 3332 2c20 7061  GML_TYPE_F32, pa
+000918d0: 7261 6d73 2e70 6173 7429 0a20 2020 2020  rams.past).     
+000918e0: 2020 2020 2020 2020 2020 2020 2020 203a                 :
+000918f0: 204e 554c 4c3b 0a20 2020 2020 2020 2020   NULL;.         
+00091900: 2020 2020 2020 206f 7074 2d3e 6c62 6667         opt->lbfg
+00091910: 732e 6c6d 616c 203d 2067 676d 6c5f 6e65  s.lmal = ggml_ne
+00091920: 775f 7465 6e73 6f72 5f31 6428 6374 782c  w_tensor_1d(ctx,
+00091930: 2047 474d 4c5f 5459 5045 5f46 3332 2c20   GGML_TYPE_F32, 
+00091940: 7061 7261 6d73 2e6c 6266 6773 2e6d 293b  params.lbfgs.m);
+00091950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00091960: 206f 7074 2d3e 6c62 6667 732e 6c6d 7973   opt->lbfgs.lmys
+00091970: 203d 2067 676d 6c5f 6e65 775f 7465 6e73   = ggml_new_tens
+00091980: 6f72 5f31 6428 6374 782c 2047 474d 4c5f  or_1d(ctx, GGML_
+00091990: 5459 5045 5f46 3332 2c20 7061 7261 6d73  TYPE_F32, params
+000919a0: 2e6c 6266 6773 2e6d 293b 0a20 2020 2020  .lbfgs.m);.     
+000919b0: 2020 2020 2020 2020 2020 206f 7074 2d3e             opt->
+000919c0: 6c62 6667 732e 6c6d 7320 203d 2067 676d  lbfgs.lms  = ggm
+000919d0: 6c5f 6e65 775f 7465 6e73 6f72 5f32 6428  l_new_tensor_2d(
+000919e0: 6374 782c 2047 474d 4c5f 5459 5045 5f46  ctx, GGML_TYPE_F
+000919f0: 3332 2c20 6e78 2c20 7061 7261 6d73 2e6c  32, nx, params.l
+00091a00: 6266 6773 2e6d 293b 0a20 2020 2020 2020  bfgs.m);.       
+00091a10: 2020 2020 2020 2020 206f 7074 2d3e 6c62           opt->lb
+00091a20: 6667 732e 6c6d 7920 203d 2067 676d 6c5f  fgs.lmy  = ggml_
+00091a30: 6e65 775f 7465 6e73 6f72 5f32 6428 6374  new_tensor_2d(ct
+00091a40: 782c 2047 474d 4c5f 5459 5045 5f46 3332  x, GGML_TYPE_F32
+00091a50: 2c20 6e78 2c20 7061 7261 6d73 2e6c 6266  , nx, params.lbf
+00091a60: 6773 2e6d 293b 0a20 2020 2020 2020 2020  gs.m);.         
+00091a70: 2020 2020 2020 2067 676d 6c5f 7365 745f         ggml_set_
+00091a80: 7a65 726f 286f 7074 2d3e 6c62 6667 732e  zero(opt->lbfgs.
+00091a90: 7829 3b0a 2020 2020 2020 2020 2020 2020  x);.            
+00091aa0: 2020 2020 6767 6d6c 5f73 6574 5f7a 6572      ggml_set_zer
+00091ab0: 6f28 6f70 742d 3e6c 6266 6773 2e78 7029  o(opt->lbfgs.xp)
+00091ac0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00091ad0: 2020 6767 6d6c 5f73 6574 5f7a 6572 6f28    ggml_set_zero(
+00091ae0: 6f70 742d 3e6c 6266 6773 2e67 293b 0a20  opt->lbfgs.g);. 
+00091af0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00091b00: 676d 6c5f 7365 745f 7a65 726f 286f 7074  gml_set_zero(opt
+00091b10: 2d3e 6c62 6667 732e 6770 293b 0a20 2020  ->lbfgs.gp);.   
+00091b20: 2020 2020 2020 2020 2020 2020 2067 676d               ggm
+00091b30: 6c5f 7365 745f 7a65 726f 286f 7074 2d3e  l_set_zero(opt->
+00091b40: 6c62 6667 732e 6429 3b0a 2020 2020 2020  lbfgs.d);.      
+00091b50: 2020 2020 2020 2020 2020 6966 2028 6f70            if (op
+00091b60: 742d 3e6c 6266 6773 2e70 6629 207b 0a20  t->lbfgs.pf) {. 
+00091b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00091b80: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
+00091b90: 286f 7074 2d3e 6c62 6667 732e 7066 293b  (opt->lbfgs.pf);
+00091ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00091bb0: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00091bc0: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
+00091bd0: 286f 7074 2d3e 6c62 6667 732e 6c6d 616c  (opt->lbfgs.lmal
+00091be0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00091bf0: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
+00091c00: 286f 7074 2d3e 6c62 6667 732e 6c6d 7973  (opt->lbfgs.lmys
+00091c10: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
+00091c20: 2020 2067 676d 6c5f 7365 745f 7a65 726f     ggml_set_zero
+00091c30: 286f 7074 2d3e 6c62 6667 732e 6c6d 7329  (opt->lbfgs.lms)
+00091c40: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00091c50: 2020 6767 6d6c 5f73 6574 5f7a 6572 6f28    ggml_set_zero(
+00091c60: 6f70 742d 3e6c 6266 6773 2e6c 6d79 293b  opt->lbfgs.lmy);
+00091c70: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00091c80: 7265 616b 3b0a 2020 2020 7d0a 7d0a 0a65  reak;.    }.}..e
+00091c90: 6e75 6d20 6767 6d6c 5f6f 7074 5f72 6573  num ggml_opt_res
+00091ca0: 756c 7420 6767 6d6c 5f6f 7074 280a 2020  ult ggml_opt(.  
+00091cb0: 2020 2020 2020 7374 7275 6374 2067 676d        struct ggm
+00091cc0: 6c5f 636f 6e74 6578 7420 2a20 6374 782c  l_context * ctx,
+00091cd0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+00091ce0: 6767 6d6c 5f6f 7074 5f70 6172 616d 7320  ggml_opt_params 
+00091cf0: 7061 7261 6d73 2c0a 2020 2020 2020 2020  params,.        
+00091d00: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00091d10: 6f72 202a 2066 2920 7b0a 2020 2020 626f  or * f) {.    bo
+00091d20: 6f6c 2066 7265 655f 6374 7820 3d20 6661  ol free_ctx = fa
+00091d30: 6c73 653b 0a20 2020 2069 6620 2863 7478  lse;.    if (ctx
+00091d40: 203d 3d20 4e55 4c4c 2920 7b0a 2020 2020   == NULL) {.    
+00091d50: 2020 2020 7374 7275 6374 2067 676d 6c5f      struct ggml_
+00091d60: 696e 6974 5f70 6172 616d 7320 7061 7261  init_params para
+00091d70: 6d73 5f63 7478 203d 207b 0a20 2020 2020  ms_ctx = {.     
+00091d80: 2020 2020 2020 202e 6d65 6d5f 7369 7a65         .mem_size
+00091d90: 2020 203d 2031 362a 3130 3234 2a31 3032     = 16*1024*102
+00091da0: 342c 0a20 2020 2020 2020 2020 2020 202e  4,.            .
+00091db0: 6d65 6d5f 6275 6666 6572 203d 204e 554c  mem_buffer = NUL
+00091dc0: 4c2c 0a20 2020 2020 2020 2020 2020 202e  L,.            .
+00091dd0: 6e6f 5f61 6c6c 6f63 2020 203d 2066 616c  no_alloc   = fal
+00091de0: 7365 2c0a 2020 2020 2020 2020 7d3b 0a0a  se,.        };..
+00091df0: 2020 2020 2020 2020 6374 7820 3d20 6767          ctx = gg
+00091e00: 6d6c 5f69 6e69 7428 7061 7261 6d73 5f63  ml_init(params_c
+00091e10: 7478 293b 0a20 2020 2020 2020 2069 6620  tx);.        if 
+00091e20: 2863 7478 203d 3d20 4e55 4c4c 2920 7b0a  (ctx == NULL) {.
+00091e30: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00091e40: 726e 2047 474d 4c5f 4f50 545f 4e4f 5f43  rn GGML_OPT_NO_C
+00091e50: 4f4e 5445 5854 3b0a 2020 2020 2020 2020  ONTEXT;.        
+00091e60: 7d0a 0a20 2020 2020 2020 2066 7265 655f  }..        free_
+00091e70: 6374 7820 3d20 7472 7565 3b0a 2020 2020  ctx = true;.    
+00091e80: 7d0a 0a20 2020 2065 6e75 6d20 6767 6d6c  }..    enum ggml
+00091e90: 5f6f 7074 5f72 6573 756c 7420 7265 7375  _opt_result resu
+00091ea0: 6c74 203d 2047 474d 4c5f 4f50 545f 4f4b  lt = GGML_OPT_OK
+00091eb0: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+00091ec0: 6d6c 5f6f 7074 5f63 6f6e 7465 7874 202a  ml_opt_context *
+00091ed0: 206f 7074 203d 2028 7374 7275 6374 2067   opt = (struct g
+00091ee0: 676d 6c5f 6f70 745f 636f 6e74 6578 7420  gml_opt_context 
+00091ef0: 2a29 2061 6c6c 6f63 6128 7369 7a65 6f66  *) alloca(sizeof
+00091f00: 2873 7472 7563 7420 6767 6d6c 5f6f 7074  (struct ggml_opt
+00091f10: 5f63 6f6e 7465 7874 2929 3b0a 0a20 2020  _context));..   
+00091f20: 2067 676d 6c5f 6f70 745f 696e 6974 2863   ggml_opt_init(c
+00091f30: 7478 2c20 6f70 742c 2070 6172 616d 732c  tx, opt, params,
+00091f40: 2030 293b 0a20 2020 2072 6573 756c 7420   0);.    result 
+00091f50: 3d20 6767 6d6c 5f6f 7074 5f72 6573 756d  = ggml_opt_resum
+00091f60: 6528 6374 782c 206f 7074 2c20 6629 3b0a  e(ctx, opt, f);.
+00091f70: 0a20 2020 2069 6620 2866 7265 655f 6374  .    if (free_ct
+00091f80: 7829 207b 0a20 2020 2020 2020 2067 676d  x) {.        ggm
+00091f90: 6c5f 6672 6565 2863 7478 293b 0a20 2020  l_free(ctx);.   
+00091fa0: 207d 0a0a 2020 2020 7265 7475 726e 2072   }..    return r
+00091fb0: 6573 756c 743b 0a7d 0a0a 656e 756d 2067  esult;.}..enum g
+00091fc0: 676d 6c5f 6f70 745f 7265 7375 6c74 2067  gml_opt_result g
+00091fd0: 676d 6c5f 6f70 745f 7265 7375 6d65 280a  gml_opt_resume(.
+00091fe0: 2020 2020 2020 2020 7374 7275 6374 2067          struct g
+00091ff0: 676d 6c5f 636f 6e74 6578 7420 2a20 6374  gml_context * ct
+00092000: 782c 0a20 2020 2020 2020 2073 7472 7563  x,.        struc
+00092010: 7420 6767 6d6c 5f6f 7074 5f63 6f6e 7465  t ggml_opt_conte
+00092020: 7874 202a 206f 7074 2c0a 2020 2020 2020  xt * opt,.      
+00092030: 2020 7374 7275 6374 2067 676d 6c5f 7465    struct ggml_te
+00092040: 6e73 6f72 202a 2066 2920 7b0a 0a20 2020  nsor * f) {..   
+00092050: 202f 2f20 6275 696c 6420 666f 7277 6172   // build forwar
+00092060: 6420 2b20 6261 636b 7761 7264 2063 6f6d  d + backward com
+00092070: 7075 7465 2067 7261 7068 730a 2020 2020  pute graphs.    
+00092080: 7374 7275 6374 2067 676d 6c5f 7465 6e73  struct ggml_tens
+00092090: 6f72 202a 2067 6662 7566 203d 2067 676d  or * gfbuf = ggm
+000920a0: 6c5f 6e65 775f 7465 6e73 6f72 5f31 6428  l_new_tensor_1d(
+000920b0: 6374 782c 2047 474d 4c5f 5459 5045 5f49  ctx, GGML_TYPE_I
+000920c0: 3332 2c20 7369 7a65 6f66 2873 7472 7563  32, sizeof(struc
+000920d0: 7420 6767 6d6c 5f63 6772 6170 6829 202f  t ggml_cgraph) /
+000920e0: 2047 474d 4c5f 5459 5045 5f53 495a 455b   GGML_TYPE_SIZE[
+000920f0: 4747 4d4c 5f54 5950 455f 4933 325d 2b20  GGML_TYPE_I32]+ 
+00092100: 2873 697a 656f 6628 7374 7275 6374 2067  (sizeof(struct g
+00092110: 676d 6c5f 6367 7261 7068 2920 2520 4747  gml_cgraph) % GG
+00092120: 4d4c 5f54 5950 455f 5349 5a45 5b47 474d  ML_TYPE_SIZE[GGM
+00092130: 4c5f 5459 5045 5f49 3332 5d20 3f20 3120  L_TYPE_I32] ? 1 
+00092140: 3a20 3029 293b 0a20 2020 2073 7472 7563  : 0));.    struc
+00092150: 7420 6767 6d6c 5f74 656e 736f 7220 2a20  t ggml_tensor * 
+00092160: 6762 6275 6620 3d20 6767 6d6c 5f6e 6577  gbbuf = ggml_new
+00092170: 5f74 656e 736f 725f 3164 2863 7478 2c20  _tensor_1d(ctx, 
+00092180: 4747 4d4c 5f54 5950 455f 4933 322c 2073  GGML_TYPE_I32, s
+00092190: 697a 656f 6628 7374 7275 6374 2067 676d  izeof(struct ggm
+000921a0: 6c5f 6367 7261 7068 2920 2f20 4747 4d4c  l_cgraph) / GGML
+000921b0: 5f54 5950 455f 5349 5a45 5b47 474d 4c5f  _TYPE_SIZE[GGML_
+000921c0: 5459 5045 5f49 3332 5d2b 2028 7369 7a65  TYPE_I32]+ (size
+000921d0: 6f66 2873 7472 7563 7420 6767 6d6c 5f63  of(struct ggml_c
+000921e0: 6772 6170 6829 2025 2047 474d 4c5f 5459  graph) % GGML_TY
+000921f0: 5045 5f53 495a 455b 4747 4d4c 5f54 5950  PE_SIZE[GGML_TYP
+00092200: 455f 4933 325d 203f 2031 203a 2030 2929  E_I32] ? 1 : 0))
+00092210: 3b0a 0a20 2020 2073 7472 7563 7420 6767  ;..    struct gg
+00092220: 6d6c 5f63 6772 6170 6820 2a20 6766 203d  ml_cgraph * gf =
+00092230: 2028 7374 7275 6374 2067 676d 6c5f 6367   (struct ggml_cg
+00092240: 7261 7068 202a 2920 6766 6275 662d 3e64  raph *) gfbuf->d
+00092250: 6174 613b 0a20 2020 2073 7472 7563 7420  ata;.    struct 
+00092260: 6767 6d6c 5f63 6772 6170 6820 2a20 6762  ggml_cgraph * gb
+00092270: 203d 2028 7374 7275 6374 2067 676d 6c5f   = (struct ggml_
+00092280: 6367 7261 7068 202a 2920 6762 6275 662d  cgraph *) gbbuf-
+00092290: 3e64 6174 613b 0a0a 2020 2020 2a67 6620  >data;..    *gf 
+000922a0: 3d20 6767 6d6c 5f62 7569 6c64 5f66 6f72  = ggml_build_for
+000922b0: 7761 7264 2028 6629 3b0a 2020 2020 2a67  ward (f);.    *g
+000922c0: 6220 3d20 6767 6d6c 5f62 7569 6c64 5f62  b = ggml_build_b
+000922d0: 6163 6b77 6172 6428 6374 782c 2067 662c  ackward(ctx, gf,
+000922e0: 2074 7275 6529 3b0a 0a20 2020 2072 6574   true);..    ret
+000922f0: 7572 6e20 6767 6d6c 5f6f 7074 5f72 6573  urn ggml_opt_res
+00092300: 756d 655f 6728 6374 782c 206f 7074 2c20  ume_g(ctx, opt, 
+00092310: 662c 2067 662c 2067 6229 3b0a 7d0a 0a65  f, gf, gb);.}..e
+00092320: 6e75 6d20 6767 6d6c 5f6f 7074 5f72 6573  num ggml_opt_res
+00092330: 756c 7420 6767 6d6c 5f6f 7074 5f72 6573  ult ggml_opt_res
+00092340: 756d 655f 6728 0a20 2020 2020 2020 2073  ume_g(.        s
+00092350: 7472 7563 7420 6767 6d6c 5f63 6f6e 7465  truct ggml_conte
+00092360: 7874 202a 2063 7478 2c0a 2020 2020 2020  xt * ctx,.      
+00092370: 2020 7374 7275 6374 2067 676d 6c5f 6f70    struct ggml_op
+00092380: 745f 636f 6e74 6578 7420 2a20 6f70 742c  t_context * opt,
+00092390: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000923a0: 6767 6d6c 5f74 656e 736f 7220 2a20 662c  ggml_tensor * f,
+000923b0: 0a20 2020 2020 2020 2073 7472 7563 7420  .        struct 
+000923c0: 6767 6d6c 5f63 6772 6170 6820 2a20 6766  ggml_cgraph * gf
+000923d0: 2c0a 2020 2020 2020 2020 7374 7275 6374  ,.        struct
+000923e0: 2067 676d 6c5f 6367 7261 7068 202a 2067   ggml_cgraph * g
+000923f0: 6229 207b 0a0a 2020 2020 2f2f 2062 7569  b) {..    // bui
+00092400: 6c64 2066 6f72 7761 7264 202b 2062 6163  ld forward + bac
+00092410: 6b77 6172 6420 636f 6d70 7574 6520 6772  kward compute gr
+00092420: 6170 6873 0a20 2020 2065 6e75 6d20 6767  aphs.    enum gg
+00092430: 6d6c 5f6f 7074 5f72 6573 756c 7420 7265  ml_opt_result re
+00092440: 7375 6c74 203d 2047 474d 4c5f 4f50 545f  sult = GGML_OPT_
+00092450: 4f4b 3b0a 0a20 2020 2073 7769 7463 6820  OK;..    switch 
+00092460: 286f 7074 2d3e 7061 7261 6d73 2e74 7970  (opt->params.typ
+00092470: 6529 207b 0a20 2020 2020 2020 2063 6173  e) {.        cas
+00092480: 6520 4747 4d4c 5f4f 5054 5f41 4441 4d3a  e GGML_OPT_ADAM:
+00092490: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+000924a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000924b0: 6573 756c 7420 3d20 6767 6d6c 5f6f 7074  esult = ggml_opt
+000924c0: 5f61 6461 6d28 6374 782c 206f 7074 2c20  _adam(ctx, opt, 
+000924d0: 6f70 742d 3e70 6172 616d 732c 2066 2c20  opt->params, f, 
+000924e0: 6766 2c20 6762 293b 0a20 2020 2020 2020  gf, gb);.       
+000924f0: 2020 2020 207d 2062 7265 616b 3b0a 2020       } break;.  
+00092500: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00092510: 4f50 545f 4c42 4647 533a 0a20 2020 2020  OPT_LBFGS:.     
+00092520: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00092530: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00092540: 3d20 6767 6d6c 5f6f 7074 5f6c 6266 6773  = ggml_opt_lbfgs
+00092550: 2863 7478 2c20 6f70 742c 206f 7074 2d3e  (ctx, opt, opt->
+00092560: 7061 7261 6d73 2c20 662c 2067 662c 2067  params, f, gf, g
+00092570: 6229 3b0a 2020 2020 2020 2020 2020 2020  b);.            
+00092580: 7d20 6272 6561 6b3b 0a20 2020 207d 0a0a  } break;.    }..
+00092590: 2020 2020 6966 2028 6f70 742d 3e70 6172      if (opt->par
+000925a0: 616d 732e 7072 696e 745f 666f 7277 6172  ams.print_forwar
+000925b0: 645f 6772 6170 6829 207b 0a20 2020 2020  d_graph) {.     
+000925c0: 2020 2067 676d 6c5f 6772 6170 685f 7072     ggml_graph_pr
+000925d0: 696e 7420 2020 2867 6629 3b0a 2020 2020  int   (gf);.    
+000925e0: 2020 2020 6767 6d6c 5f67 7261 7068 5f64      ggml_graph_d
+000925f0: 756d 705f 646f 7428 6766 2c20 4e55 4c4c  ump_dot(gf, NULL
+00092600: 2c20 226f 7074 2d66 6f72 7761 7264 2e64  , "opt-forward.d
+00092610: 6f74 2229 3b0a 2020 2020 7d0a 0a20 2020  ot");.    }..   
+00092620: 2069 6620 286f 7074 2d3e 7061 7261 6d73   if (opt->params
+00092630: 2e70 7269 6e74 5f62 6163 6b77 6172 645f  .print_backward_
+00092640: 6772 6170 6829 207b 0a20 2020 2020 2020  graph) {.       
+00092650: 2067 676d 6c5f 6772 6170 685f 7072 696e   ggml_graph_prin
+00092660: 7420 2020 2867 6229 3b0a 2020 2020 2020  t   (gb);.      
+00092670: 2020 6767 6d6c 5f67 7261 7068 5f64 756d    ggml_graph_dum
+00092680: 705f 646f 7428 6762 2c20 6766 2c20 226f  p_dot(gb, gf, "o
+00092690: 7074 2d62 6163 6b77 6172 642e 646f 7422  pt-backward.dot"
+000926a0: 293b 0a20 2020 207d 0a0a 2020 2020 7265  );.    }..    re
+000926b0: 7475 726e 2072 6573 756c 743b 0a7d 0a0a  turn result;.}..
+000926c0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000926d0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000926e0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000926f0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00092700: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00092710: 0a0a 7369 7a65 5f74 2067 676d 6c5f 7175  ..size_t ggml_qu
+00092720: 616e 7469 7a65 5f71 345f 3028 636f 6e73  antize_q4_0(cons
+00092730: 7420 666c 6f61 7420 2a20 7372 632c 2076  t float * src, v
+00092740: 6f69 6420 2a20 6473 742c 2069 6e74 206e  oid * dst, int n
+00092750: 2c20 696e 7420 6b2c 2069 6e74 3634 5f74  , int k, int64_t
+00092760: 202a 2068 6973 7429 207b 0a20 2020 2061   * hist) {.    a
+00092770: 7373 6572 7428 6b20 2520 514b 345f 3020  ssert(k % QK4_0 
+00092780: 3d3d 2030 293b 0a20 2020 2063 6f6e 7374  == 0);.    const
+00092790: 2069 6e74 206e 6220 3d20 6b20 2f20 514b   int nb = k / QK
+000927a0: 345f 303b 0a0a 2020 2020 666f 7220 2869  4_0;..    for (i
+000927b0: 6e74 2062 203d 2030 3b20 6220 3c20 6e3b  nt b = 0; b < n;
+000927c0: 2062 202b 3d20 6b29 207b 0a20 2020 2020   b += k) {.     
+000927d0: 2020 2062 6c6f 636b 5f71 345f 3020 2a20     block_q4_0 * 
+000927e0: 7265 7374 7269 6374 2079 203d 2028 626c  restrict y = (bl
+000927f0: 6f63 6b5f 7134 5f30 202a 2920 6473 7420  ock_q4_0 *) dst 
+00092800: 2b20 622f 514b 345f 303b 0a0a 2020 2020  + b/QK4_0;..    
+00092810: 2020 2020 7175 616e 7469 7a65 5f72 6f77      quantize_row
+00092820: 5f71 345f 305f 7265 6665 7265 6e63 6528  _q4_0_reference(
+00092830: 7372 6320 2b20 622c 2079 2c20 6b29 3b0a  src + b, y, k);.
+00092840: 0a20 2020 2020 2020 2066 6f72 2028 696e  .        for (in
+00092850: 7420 6920 3d20 303b 2069 203c 206e 623b  t i = 0; i < nb;
+00092860: 2069 2b2b 2920 7b0a 2020 2020 2020 2020   i++) {.        
+00092870: 2020 2020 666f 7220 2869 6e74 206a 203d      for (int j =
+00092880: 2030 3b20 6a20 3c20 514b 345f 303b 206a   0; j < QK4_0; j
+00092890: 202b 3d20 3229 207b 0a20 2020 2020 2020   += 2) {.       
+000928a0: 2020 2020 2020 2020 2063 6f6e 7374 2075           const u
+000928b0: 696e 7438 5f74 2076 6930 203d 2079 5b69  int8_t vi0 = y[i
+000928c0: 5d2e 7173 5b6a 2f32 5d20 2620 3078 3046  ].qs[j/2] & 0x0F
+000928d0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000928e0: 2020 636f 6e73 7420 7569 6e74 385f 7420    const uint8_t 
+000928f0: 7669 3120 3d20 795b 695d 2e71 735b 6a2f  vi1 = y[i].qs[j/
+00092900: 325d 203e 3e20 343b 0a0a 2020 2020 2020  2] >> 4;..      
+00092910: 2020 2020 2020 2020 2020 6869 7374 5b76            hist[v
+00092920: 6930 5d2b 2b3b 0a20 2020 2020 2020 2020  i0]++;.         
+00092930: 2020 2020 2020 2068 6973 745b 7669 315d         hist[vi1]
+00092940: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
+00092950: 7d0a 2020 2020 2020 2020 7d0a 2020 2020  }.        }.    
+00092960: 7d0a 0a20 2020 2072 6574 7572 6e20 286e  }..    return (n
+00092970: 2f51 4b34 5f30 2a73 697a 656f 6628 626c  /QK4_0*sizeof(bl
+00092980: 6f63 6b5f 7134 5f30 2929 3b0a 7d0a 0a73  ock_q4_0));.}..s
+00092990: 697a 655f 7420 6767 6d6c 5f71 7561 6e74  ize_t ggml_quant
+000929a0: 697a 655f 7134 5f31 2863 6f6e 7374 2066  ize_q4_1(const f
+000929b0: 6c6f 6174 202a 2073 7263 2c20 766f 6964  loat * src, void
+000929c0: 202a 2064 7374 2c20 696e 7420 6e2c 2069   * dst, int n, i
+000929d0: 6e74 206b 2c20 696e 7436 345f 7420 2a20  nt k, int64_t * 
+000929e0: 6869 7374 2920 7b0a 2020 2020 6173 7365  hist) {.    asse
+000929f0: 7274 286b 2025 2051 4b34 5f31 203d 3d20  rt(k % QK4_1 == 
+00092a00: 3029 3b0a 2020 2020 636f 6e73 7420 696e  0);.    const in
+00092a10: 7420 6e62 203d 206b 202f 2051 4b34 5f31  t nb = k / QK4_1
+00092a20: 3b0a 0a20 2020 2066 6f72 2028 696e 7420  ;..    for (int 
+00092a30: 6220 3d20 303b 2062 203c 206e 3b20 6220  b = 0; b < n; b 
+00092a40: 2b3d 206b 2920 7b0a 2020 2020 2020 2020  += k) {.        
+00092a50: 626c 6f63 6b5f 7134 5f31 202a 2072 6573  block_q4_1 * res
+00092a60: 7472 6963 7420 7920 3d20 2862 6c6f 636b  trict y = (block
+00092a70: 5f71 345f 3120 2a29 2064 7374 202b 2062  _q4_1 *) dst + b
+00092a80: 2f51 4b34 5f31 3b0a 0a20 2020 2020 2020  /QK4_1;..       
+00092a90: 2071 7561 6e74 697a 655f 726f 775f 7134   quantize_row_q4
+00092aa0: 5f31 5f72 6566 6572 656e 6365 2873 7263  _1_reference(src
+00092ab0: 202b 2062 2c20 792c 206b 293b 0a0a 2020   + b, y, k);..  
+00092ac0: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00092ad0: 203d 2030 3b20 6920 3c20 6e62 3b20 692b   = 0; i < nb; i+
+00092ae0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+00092af0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+00092b00: 206a 203c 2051 4b34 5f31 3b20 6a20 2b3d   j < QK4_1; j +=
+00092b10: 2032 2920 7b0a 2020 2020 2020 2020 2020   2) {.          
+00092b20: 2020 2020 2020 636f 6e73 7420 7569 6e74        const uint
+00092b30: 385f 7420 7669 3020 3d20 795b 695d 2e71  8_t vi0 = y[i].q
+00092b40: 735b 6a2f 325d 2026 2030 7830 463b 0a20  s[j/2] & 0x0F;. 
+00092b50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00092b60: 6f6e 7374 2075 696e 7438 5f74 2076 6931  onst uint8_t vi1
+00092b70: 203d 2079 5b69 5d2e 7173 5b6a 2f32 5d20   = y[i].qs[j/2] 
+00092b80: 3e3e 2034 3b0a 0a20 2020 2020 2020 2020  >> 4;..         
+00092b90: 2020 2020 2020 2068 6973 745b 7669 305d         hist[vi0]
+00092ba0: 2b2b 3b0a 2020 2020 2020 2020 2020 2020  ++;.            
+00092bb0: 2020 2020 6869 7374 5b76 6931 5d2b 2b3b      hist[vi1]++;
+00092bc0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
+00092bd0: 2020 2020 2020 207d 0a20 2020 207d 0a0a         }.    }..
+00092be0: 2020 2020 7265 7475 726e 2028 6e2f 514b      return (n/QK
+00092bf0: 345f 312a 7369 7a65 6f66 2862 6c6f 636b  4_1*sizeof(block
+00092c00: 5f71 345f 3129 293b 0a7d 0a0a 7369 7a65  _q4_1));.}..size
+00092c10: 5f74 2067 676d 6c5f 7175 616e 7469 7a65  _t ggml_quantize
+00092c20: 5f71 355f 3028 636f 6e73 7420 666c 6f61  _q5_0(const floa
+00092c30: 7420 2a20 7372 632c 2076 6f69 6420 2a20  t * src, void * 
+00092c40: 6473 742c 2069 6e74 206e 2c20 696e 7420  dst, int n, int 
+00092c50: 6b2c 2069 6e74 3634 5f74 202a 2068 6973  k, int64_t * his
+00092c60: 7429 207b 0a20 2020 2061 7373 6572 7428  t) {.    assert(
+00092c70: 6b20 2520 514b 355f 3020 3d3d 2030 293b  k % QK5_0 == 0);
+00092c80: 0a20 2020 2063 6f6e 7374 2069 6e74 206e  .    const int n
+00092c90: 6220 3d20 6b20 2f20 514b 355f 303b 0a0a  b = k / QK5_0;..
+00092ca0: 2020 2020 666f 7220 2869 6e74 2062 203d      for (int b =
+00092cb0: 2030 3b20 6220 3c20 6e3b 2062 202b 3d20   0; b < n; b += 
+00092cc0: 6b29 207b 0a20 2020 2020 2020 2062 6c6f  k) {.        blo
+00092cd0: 636b 5f71 355f 3020 2a20 7265 7374 7269  ck_q5_0 * restri
+00092ce0: 6374 2079 203d 2028 626c 6f63 6b5f 7135  ct y = (block_q5
+00092cf0: 5f30 202a 2964 7374 202b 2062 2f51 4b35  _0 *)dst + b/QK5
+00092d00: 5f30 3b0a 0a20 2020 2020 2020 2071 7561  _0;..        qua
+00092d10: 6e74 697a 655f 726f 775f 7135 5f30 5f72  ntize_row_q5_0_r
+00092d20: 6566 6572 656e 6365 2873 7263 202b 2062  eference(src + b
+00092d30: 2c20 792c 206b 293b 0a0a 2020 2020 2020  , y, k);..      
+00092d40: 2020 666f 7220 2869 6e74 2069 203d 2030    for (int i = 0
+00092d50: 3b20 6920 3c20 6e62 3b20 692b 2b29 207b  ; i < nb; i++) {
+00092d60: 0a20 2020 2020 2020 2020 2020 2075 696e  .            uin
+00092d70: 7433 325f 7420 7168 3b0a 2020 2020 2020  t32_t qh;.      
+00092d80: 2020 2020 2020 6d65 6d63 7079 2826 7168        memcpy(&qh
+00092d90: 2c20 2679 5b69 5d2e 7168 2c20 7369 7a65  , &y[i].qh, size
+00092da0: 6f66 2871 6829 293b 0a0a 2020 2020 2020  of(qh));..      
+00092db0: 2020 2020 2020 666f 7220 2869 6e74 206a        for (int j
+00092dc0: 203d 2030 3b20 6a20 3c20 514b 355f 303b   = 0; j < QK5_0;
+00092dd0: 206a 202b 3d20 3229 207b 0a20 2020 2020   j += 2) {.     
+00092de0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00092df0: 2075 696e 7438 5f74 2076 6830 203d 2028   uint8_t vh0 = (
+00092e00: 2871 6820 2620 2831 7520 3c3c 2028 6a20  (qh & (1u << (j 
+00092e10: 2b20 3020 2929 2920 3e3e 2028 6a20 2b20  + 0 ))) >> (j + 
+00092e20: 3020 2929 203c 3c20 343b 0a20 2020 2020  0 )) << 4;.     
+00092e30: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00092e40: 2075 696e 7438 5f74 2076 6831 203d 2028   uint8_t vh1 = (
+00092e50: 2871 6820 2620 2831 7520 3c3c 2028 6a20  (qh & (1u << (j 
+00092e60: 2b20 3136 2929 2920 3e3e 2028 6a20 2b20  + 16))) >> (j + 
+00092e70: 3132 2929 3b0a 0a20 2020 2020 2020 2020  12));..         
+00092e80: 2020 2020 2020 202f 2f20 6361 7374 2074         // cast t
+00092e90: 6f20 3136 2062 696e 730a 2020 2020 2020  o 16 bins.      
+00092ea0: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00092eb0: 7569 6e74 385f 7420 7669 3020 3d20 2828  uint8_t vi0 = ((
+00092ec0: 795b 695d 2e71 735b 6a2f 325d 2026 2030  y[i].qs[j/2] & 0
+00092ed0: 7830 4629 207c 2076 6830 2920 2f20 323b  x0F) | vh0) / 2;
+00092ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00092ef0: 2063 6f6e 7374 2075 696e 7438 5f74 2076   const uint8_t v
+00092f00: 6931 203d 2028 2879 5b69 5d2e 7173 5b6a  i1 = ((y[i].qs[j
+00092f10: 2f32 5d20 3e3e 2020 2034 2920 7c20 7668  /2] >>   4) | vh
+00092f20: 3129 202f 2032 3b0a 0a20 2020 2020 2020  1) / 2;..       
+00092f30: 2020 2020 2020 2020 2068 6973 745b 7669           hist[vi
+00092f40: 305d 2b2b 3b0a 2020 2020 2020 2020 2020  0]++;.          
+00092f50: 2020 2020 2020 6869 7374 5b76 6931 5d2b        hist[vi1]+
+00092f60: 2b3b 0a20 2020 2020 2020 2020 2020 207d  +;.            }
+00092f70: 0a20 2020 2020 2020 207d 0a20 2020 207d  .        }.    }
+00092f80: 0a0a 2020 2020 7265 7475 726e 2028 6e2f  ..    return (n/
+00092f90: 514b 355f 302a 7369 7a65 6f66 2862 6c6f  QK5_0*sizeof(blo
+00092fa0: 636b 5f71 355f 3029 293b 0a7d 0a0a 7369  ck_q5_0));.}..si
+00092fb0: 7a65 5f74 2067 676d 6c5f 7175 616e 7469  ze_t ggml_quanti
+00092fc0: 7a65 5f71 355f 3128 636f 6e73 7420 666c  ze_q5_1(const fl
+00092fd0: 6f61 7420 2a20 7372 632c 2076 6f69 6420  oat * src, void 
+00092fe0: 2a20 6473 742c 2069 6e74 206e 2c20 696e  * dst, int n, in
+00092ff0: 7420 6b2c 2069 6e74 3634 5f74 202a 2068  t k, int64_t * h
+00093000: 6973 7429 207b 0a20 2020 2061 7373 6572  ist) {.    asser
+00093010: 7428 6b20 2520 514b 355f 3120 3d3d 2030  t(k % QK5_1 == 0
+00093020: 293b 0a20 2020 2063 6f6e 7374 2069 6e74  );.    const int
+00093030: 206e 6220 3d20 6b20 2f20 514b 355f 313b   nb = k / QK5_1;
+00093040: 0a0a 2020 2020 666f 7220 2869 6e74 2062  ..    for (int b
+00093050: 203d 2030 3b20 6220 3c20 6e3b 2062 202b   = 0; b < n; b +
+00093060: 3d20 6b29 207b 0a20 2020 2020 2020 2062  = k) {.        b
+00093070: 6c6f 636b 5f71 355f 3120 2a20 7265 7374  lock_q5_1 * rest
+00093080: 7269 6374 2079 203d 2028 626c 6f63 6b5f  rict y = (block_
+00093090: 7135 5f31 202a 2964 7374 202b 2062 2f51  q5_1 *)dst + b/Q
+000930a0: 4b35 5f31 3b0a 0a20 2020 2020 2020 2071  K5_1;..        q
+000930b0: 7561 6e74 697a 655f 726f 775f 7135 5f31  uantize_row_q5_1
+000930c0: 5f72 6566 6572 656e 6365 2873 7263 202b  _reference(src +
+000930d0: 2062 2c20 792c 206b 293b 0a0a 2020 2020   b, y, k);..    
+000930e0: 2020 2020 666f 7220 2869 6e74 2069 203d      for (int i =
+000930f0: 2030 3b20 6920 3c20 6e62 3b20 692b 2b29   0; i < nb; i++)
+00093100: 207b 0a20 2020 2020 2020 2020 2020 2075   {.            u
+00093110: 696e 7433 325f 7420 7168 3b0a 2020 2020  int32_t qh;.    
+00093120: 2020 2020 2020 2020 6d65 6d63 7079 2826          memcpy(&
+00093130: 7168 2c20 2679 5b69 5d2e 7168 2c20 7369  qh, &y[i].qh, si
+00093140: 7a65 6f66 2871 6829 293b 0a0a 2020 2020  zeof(qh));..    
+00093150: 2020 2020 2020 2020 666f 7220 2869 6e74          for (int
+00093160: 206a 203d 2030 3b20 6a20 3c20 514b 355f   j = 0; j < QK5_
+00093170: 313b 206a 202b 3d20 3229 207b 0a20 2020  1; j += 2) {.   
+00093180: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00093190: 7374 2075 696e 7438 5f74 2076 6830 203d  st uint8_t vh0 =
+000931a0: 2028 2871 6820 2620 2831 7520 3c3c 2028   ((qh & (1u << (
+000931b0: 6a20 2b20 3020 2929 2920 3e3e 2028 6a20  j + 0 ))) >> (j 
+000931c0: 2b20 3020 2929 203c 3c20 343b 0a20 2020  + 0 )) << 4;.   
+000931d0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000931e0: 7374 2075 696e 7438 5f74 2076 6831 203d  st uint8_t vh1 =
+000931f0: 2028 2871 6820 2620 2831 7520 3c3c 2028   ((qh & (1u << (
+00093200: 6a20 2b20 3136 2929 2920 3e3e 2028 6a20  j + 16))) >> (j 
+00093210: 2b20 3132 2929 3b0a 0a20 2020 2020 2020  + 12));..       
+00093220: 2020 2020 2020 2020 202f 2f20 6361 7374           // cast
+00093230: 2074 6f20 3136 2062 696e 730a 2020 2020   to 16 bins.    
+00093240: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00093250: 7420 7569 6e74 385f 7420 7669 3020 3d20  t uint8_t vi0 = 
+00093260: 2828 795b 695d 2e71 735b 6a2f 325d 2026  ((y[i].qs[j/2] &
+00093270: 2030 7830 4629 207c 2076 6830 2920 2f20   0x0F) | vh0) / 
+00093280: 323b 0a20 2020 2020 2020 2020 2020 2020  2;.             
+00093290: 2020 2063 6f6e 7374 2075 696e 7438 5f74     const uint8_t
+000932a0: 2076 6931 203d 2028 2879 5b69 5d2e 7173   vi1 = ((y[i].qs
+000932b0: 5b6a 2f32 5d20 3e3e 2020 2034 2920 7c20  [j/2] >>   4) | 
+000932c0: 7668 3129 202f 2032 3b0a 0a20 2020 2020  vh1) / 2;..     
+000932d0: 2020 2020 2020 2020 2020 2068 6973 745b             hist[
+000932e0: 7669 305d 2b2b 3b0a 2020 2020 2020 2020  vi0]++;.        
+000932f0: 2020 2020 2020 2020 6869 7374 5b76 6931          hist[vi1
+00093300: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
+00093310: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+00093320: 207d 0a0a 2020 2020 7265 7475 726e 2028   }..    return (
+00093330: 6e2f 514b 355f 312a 7369 7a65 6f66 2862  n/QK5_1*sizeof(b
+00093340: 6c6f 636b 5f71 355f 3129 293b 0a7d 0a0a  lock_q5_1));.}..
+00093350: 7369 7a65 5f74 2067 676d 6c5f 7175 616e  size_t ggml_quan
+00093360: 7469 7a65 5f71 385f 3028 636f 6e73 7420  tize_q8_0(const 
+00093370: 666c 6f61 7420 2a20 7372 632c 2076 6f69  float * src, voi
+00093380: 6420 2a20 6473 742c 2069 6e74 206e 2c20  d * dst, int n, 
+00093390: 696e 7420 6b2c 2069 6e74 3634 5f74 202a  int k, int64_t *
+000933a0: 2068 6973 7429 207b 0a20 2020 2061 7373   hist) {.    ass
+000933b0: 6572 7428 6b20 2520 514b 385f 3020 3d3d  ert(k % QK8_0 ==
+000933c0: 2030 293b 0a20 2020 2063 6f6e 7374 2069   0);.    const i
+000933d0: 6e74 206e 6220 3d20 6b20 2f20 514b 385f  nt nb = k / QK8_
+000933e0: 303b 0a0a 2020 2020 666f 7220 2869 6e74  0;..    for (int
+000933f0: 2062 203d 2030 3b20 6220 3c20 6e3b 2062   b = 0; b < n; b
+00093400: 202b 3d20 6b29 207b 0a20 2020 2020 2020   += k) {.       
+00093410: 2062 6c6f 636b 5f71 385f 3020 2a20 7265   block_q8_0 * re
+00093420: 7374 7269 6374 2079 203d 2028 626c 6f63  strict y = (bloc
+00093430: 6b5f 7138 5f30 202a 2964 7374 202b 2062  k_q8_0 *)dst + b
+00093440: 2f51 4b38 5f30 3b0a 0a20 2020 2020 2020  /QK8_0;..       
+00093450: 2071 7561 6e74 697a 655f 726f 775f 7138   quantize_row_q8
+00093460: 5f30 5f72 6566 6572 656e 6365 2873 7263  _0_reference(src
+00093470: 202b 2062 2c20 792c 206b 293b 0a0a 2020   + b, y, k);..  
+00093480: 2020 2020 2020 666f 7220 2869 6e74 2069        for (int i
+00093490: 203d 2030 3b20 6920 3c20 6e62 3b20 692b   = 0; i < nb; i+
+000934a0: 2b29 207b 0a20 2020 2020 2020 2020 2020  +) {.           
+000934b0: 2066 6f72 2028 696e 7420 6a20 3d20 303b   for (int j = 0;
+000934c0: 206a 203c 2051 4b38 5f30 3b20 2b2b 6a29   j < QK8_0; ++j)
+000934d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000934e0: 2020 2063 6f6e 7374 2069 6e74 385f 7420     const int8_t 
+000934f0: 7669 203d 2079 5b69 5d2e 7173 5b6a 5d3b  vi = y[i].qs[j];
+00093500: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00093510: 2020 6869 7374 5b76 692f 3136 202b 2038    hist[vi/16 + 8
+00093520: 5d2b 2b3b 0a20 2020 2020 2020 2020 2020  ]++;.           
+00093530: 207d 0a20 2020 2020 2020 207d 0a20 2020   }.        }.   
+00093540: 207d 0a0a 2020 2020 7265 7475 726e 2028   }..    return (
+00093550: 6e2f 514b 385f 302a 7369 7a65 6f66 2862  n/QK8_0*sizeof(b
+00093560: 6c6f 636b 5f71 385f 3029 293b 0a7d 0a0a  lock_q8_0));.}..
+00093570: 7369 7a65 5f74 2067 676d 6c5f 7175 616e  size_t ggml_quan
+00093580: 7469 7a65 5f63 6875 6e6b 2865 6e75 6d20  tize_chunk(enum 
+00093590: 6767 6d6c 5f74 7970 6520 7479 7065 2c20  ggml_type type, 
+000935a0: 636f 6e73 7420 666c 6f61 7420 2a20 7372  const float * sr
+000935b0: 632c 2076 6f69 6420 2a20 6473 742c 2069  c, void * dst, i
+000935c0: 6e74 2073 7461 7274 2c20 696e 7420 6e2c  nt start, int n,
+000935d0: 2069 6e74 3634 5f74 202a 2068 6973 7429   int64_t * hist)
+000935e0: 207b 0a20 2020 2073 697a 655f 7420 7265   {.    size_t re
+000935f0: 7375 6c74 203d 2030 3b0a 2020 2020 7377  sult = 0;.    sw
+00093600: 6974 6368 2028 7479 7065 2920 7b0a 2020  itch (type) {.  
+00093610: 2020 2020 2020 6361 7365 2047 474d 4c5f        case GGML_
+00093620: 5459 5045 5f51 345f 303a 0a20 2020 2020  TYPE_Q4_0:.     
+00093630: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00093640: 2020 2020 2020 2020 2047 474d 4c5f 4153           GGML_AS
+00093650: 5345 5254 2873 7461 7274 2025 2051 4b34  SERT(start % QK4
+00093660: 5f30 203d 3d20 3029 3b0a 2020 2020 2020  _0 == 0);.      
+00093670: 2020 2020 2020 2020 2020 626c 6f63 6b5f            block_
+00093680: 7134 5f30 202a 2062 6c6f 636b 203d 2028  q4_0 * block = (
+00093690: 626c 6f63 6b5f 7134 5f30 2a29 6473 7420  block_q4_0*)dst 
+000936a0: 2b20 7374 6172 7420 2f20 514b 345f 303b  + start / QK4_0;
+000936b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000936c0: 2072 6573 756c 7420 3d20 6767 6d6c 5f71   result = ggml_q
+000936d0: 7561 6e74 697a 655f 7134 5f30 2873 7263  uantize_q4_0(src
+000936e0: 202b 2073 7461 7274 2c20 626c 6f63 6b2c   + start, block,
+000936f0: 206e 2c20 6e2c 2068 6973 7429 3b0a 2020   n, n, hist);.  
+00093700: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00093710: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00093720: 4747 4d4c 5f54 5950 455f 5134 5f31 3a0a  GGML_TYPE_Q4_1:.
+00093730: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00093740: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00093750: 4d4c 5f41 5353 4552 5428 7374 6172 7420  ML_ASSERT(start 
+00093760: 2520 514b 345f 3120 3d3d 2030 293b 0a20  % QK4_1 == 0);. 
+00093770: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00093780: 6c6f 636b 5f71 345f 3120 2a20 626c 6f63  lock_q4_1 * bloc
+00093790: 6b20 3d20 2862 6c6f 636b 5f71 345f 312a  k = (block_q4_1*
+000937a0: 2964 7374 202b 2073 7461 7274 202f 2051  )dst + start / Q
+000937b0: 4b34 5f31 3b0a 2020 2020 2020 2020 2020  K4_1;.          
+000937c0: 2020 2020 2020 7265 7375 6c74 203d 2067        result = g
+000937d0: 676d 6c5f 7175 616e 7469 7a65 5f71 345f  gml_quantize_q4_
+000937e0: 3128 7372 6320 2b20 7374 6172 742c 2062  1(src + start, b
+000937f0: 6c6f 636b 2c20 6e2c 206e 2c20 6869 7374  lock, n, n, hist
+00093800: 293b 0a20 2020 2020 2020 2020 2020 207d  );.            }
+00093810: 2062 7265 616b 3b0a 2020 2020 2020 2020   break;.        
+00093820: 6361 7365 2047 474d 4c5f 5459 5045 5f51  case GGML_TYPE_Q
+00093830: 355f 303a 0a20 2020 2020 2020 2020 2020  5_0:.           
+00093840: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00093850: 2020 2047 474d 4c5f 4153 5345 5254 2873     GGML_ASSERT(s
+00093860: 7461 7274 2025 2051 4b35 5f30 203d 3d20  tart % QK5_0 == 
+00093870: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+00093880: 2020 2020 626c 6f63 6b5f 7135 5f30 202a      block_q5_0 *
+00093890: 2062 6c6f 636b 203d 2028 626c 6f63 6b5f   block = (block_
+000938a0: 7135 5f30 2a29 6473 7420 2b20 7374 6172  q5_0*)dst + star
+000938b0: 7420 2f20 514b 355f 303b 0a20 2020 2020  t / QK5_0;.     
+000938c0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+000938d0: 7420 3d20 6767 6d6c 5f71 7561 6e74 697a  t = ggml_quantiz
+000938e0: 655f 7135 5f30 2873 7263 202b 2073 7461  e_q5_0(src + sta
+000938f0: 7274 2c20 626c 6f63 6b2c 206e 2c20 6e2c  rt, block, n, n,
+00093900: 2068 6973 7429 3b0a 2020 2020 2020 2020   hist);.        
+00093910: 2020 2020 7d20 6272 6561 6b3b 0a20 2020      } break;.   
+00093920: 2020 2020 2063 6173 6520 4747 4d4c 5f54       case GGML_T
+00093930: 5950 455f 5135 5f31 3a0a 2020 2020 2020  YPE_Q5_1:.      
+00093940: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00093950: 2020 2020 2020 2020 4747 4d4c 5f41 5353          GGML_ASS
+00093960: 4552 5428 7374 6172 7420 2520 514b 355f  ERT(start % QK5_
+00093970: 3120 3d3d 2030 293b 0a20 2020 2020 2020  1 == 0);.       
+00093980: 2020 2020 2020 2020 2062 6c6f 636b 5f71           block_q
+00093990: 355f 3120 2a20 626c 6f63 6b20 3d20 2862  5_1 * block = (b
+000939a0: 6c6f 636b 5f71 355f 312a 2964 7374 202b  lock_q5_1*)dst +
+000939b0: 2073 7461 7274 202f 2051 4b35 5f31 3b0a   start / QK5_1;.
+000939c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000939d0: 7265 7375 6c74 203d 2067 676d 6c5f 7175  result = ggml_qu
+000939e0: 616e 7469 7a65 5f71 355f 3128 7372 6320  antize_q5_1(src 
+000939f0: 2b20 7374 6172 742c 2062 6c6f 636b 2c20  + start, block, 
+00093a00: 6e2c 206e 2c20 6869 7374 293b 0a20 2020  n, n, hist);.   
+00093a10: 2020 2020 2020 2020 207d 2062 7265 616b           } break
+00093a20: 3b0a 2020 2020 2020 2020 6361 7365 2047  ;.        case G
+00093a30: 474d 4c5f 5459 5045 5f51 385f 303a 0a20  GML_TYPE_Q8_0:. 
+00093a40: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00093a50: 2020 2020 2020 2020 2020 2020 2047 474d               GGM
+00093a60: 4c5f 4153 5345 5254 2873 7461 7274 2025  L_ASSERT(start %
+00093a70: 2051 4b38 5f30 203d 3d20 3029 3b0a 2020   QK8_0 == 0);.  
+00093a80: 2020 2020 2020 2020 2020 2020 2020 626c                bl
+00093a90: 6f63 6b5f 7138 5f30 202a 2062 6c6f 636b  ock_q8_0 * block
+00093aa0: 203d 2028 626c 6f63 6b5f 7138 5f30 2a29   = (block_q8_0*)
+00093ab0: 6473 7420 2b20 7374 6172 7420 2f20 514b  dst + start / QK
+00093ac0: 385f 303b 0a20 2020 2020 2020 2020 2020  8_0;.           
+00093ad0: 2020 2020 2072 6573 756c 7420 3d20 6767       result = gg
+00093ae0: 6d6c 5f71 7561 6e74 697a 655f 7138 5f30  ml_quantize_q8_0
+00093af0: 2873 7263 202b 2073 7461 7274 2c20 626c  (src + start, bl
+00093b00: 6f63 6b2c 206e 2c20 6e2c 2068 6973 7429  ock, n, n, hist)
+00093b10: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00093b20: 6272 6561 6b3b 0a23 6966 6465 6620 4747  break;.#ifdef GG
+00093b30: 4d4c 5f55 5345 5f4b 5f51 5541 4e54 530a  ML_USE_K_QUANTS.
+00093b40: 2020 2020 2020 2020 6361 7365 2047 474d          case GGM
+00093b50: 4c5f 5459 5045 5f51 325f 4b3a 0a20 2020  L_TYPE_Q2_K:.   
+00093b60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00093b70: 2020 2020 2020 2020 2020 2047 474d 4c5f             GGML_
+00093b80: 4153 5345 5254 2873 7461 7274 2025 2051  ASSERT(start % Q
+00093b90: 4b5f 4b20 3d3d 2030 293b 0a20 2020 2020  K_K == 0);.     
+00093ba0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+00093bb0: 5f71 325f 4b20 2a20 626c 6f63 6b20 3d20  _q2_K * block = 
+00093bc0: 2862 6c6f 636b 5f71 325f 4b2a 2964 7374  (block_q2_K*)dst
+00093bd0: 202b 2073 7461 7274 202f 2051 4b5f 4b3b   + start / QK_K;
+00093be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00093bf0: 2072 6573 756c 7420 3d20 6767 6d6c 5f71   result = ggml_q
+00093c00: 7561 6e74 697a 655f 7132 5f4b 2873 7263  uantize_q2_K(src
+00093c10: 202b 2073 7461 7274 2c20 626c 6f63 6b2c   + start, block,
+00093c20: 206e 2c20 6e2c 2068 6973 7429 3b0a 2020   n, n, hist);.  
+00093c30: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00093c40: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00093c50: 4747 4d4c 5f54 5950 455f 5133 5f4b 3a0a  GGML_TYPE_Q3_K:.
+00093c60: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00093c70: 2020 2020 2020 2020 2020 2020 2020 4747                GG
+00093c80: 4d4c 5f41 5353 4552 5428 7374 6172 7420  ML_ASSERT(start 
+00093c90: 2520 514b 5f4b 203d 3d20 3029 3b0a 2020  % QK_K == 0);.  
+00093ca0: 2020 2020 2020 2020 2020 2020 2020 626c                bl
+00093cb0: 6f63 6b5f 7133 5f4b 202a 2062 6c6f 636b  ock_q3_K * block
+00093cc0: 203d 2028 626c 6f63 6b5f 7133 5f4b 2a29   = (block_q3_K*)
+00093cd0: 6473 7420 2b20 7374 6172 7420 2f20 514b  dst + start / QK
+00093ce0: 5f4b 3b0a 2020 2020 2020 2020 2020 2020  _K;.            
+00093cf0: 2020 2020 7265 7375 6c74 203d 2067 676d      result = ggm
+00093d00: 6c5f 7175 616e 7469 7a65 5f71 335f 4b28  l_quantize_q3_K(
+00093d10: 7372 6320 2b20 7374 6172 742c 2062 6c6f  src + start, blo
+00093d20: 636b 2c20 6e2c 206e 2c20 6869 7374 293b  ck, n, n, hist);
+00093d30: 0a20 2020 2020 2020 2020 2020 207d 2062  .            } b
+00093d40: 7265 616b 3b0a 2020 2020 2020 2020 6361  reak;.        ca
+00093d50: 7365 2047 474d 4c5f 5459 5045 5f51 345f  se GGML_TYPE_Q4_
+00093d60: 4b3a 0a20 2020 2020 2020 2020 2020 207b  K:.            {
+00093d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00093d80: 2047 474d 4c5f 4153 5345 5254 2873 7461   GGML_ASSERT(sta
+00093d90: 7274 2025 2051 4b5f 4b20 3d3d 2030 293b  rt % QK_K == 0);
+00093da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00093db0: 2062 6c6f 636b 5f71 345f 4b20 2a20 626c   block_q4_K * bl
+00093dc0: 6f63 6b20 3d20 2862 6c6f 636b 5f71 345f  ock = (block_q4_
+00093dd0: 4b2a 2964 7374 202b 2073 7461 7274 202f  K*)dst + start /
+00093de0: 2051 4b5f 4b3b 0a20 2020 2020 2020 2020   QK_K;.         
+00093df0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00093e00: 6767 6d6c 5f71 7561 6e74 697a 655f 7134  ggml_quantize_q4
+00093e10: 5f4b 2873 7263 202b 2073 7461 7274 2c20  _K(src + start, 
+00093e20: 626c 6f63 6b2c 206e 2c20 6e2c 2068 6973  block, n, n, his
+00093e30: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+00093e40: 7d20 6272 6561 6b3b 0a20 2020 2020 2020  } break;.       
+00093e50: 2063 6173 6520 4747 4d4c 5f54 5950 455f   case GGML_TYPE_
+00093e60: 5135 5f4b 3a0a 2020 2020 2020 2020 2020  Q5_K:.          
+00093e70: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+00093e80: 2020 2020 4747 4d4c 5f41 5353 4552 5428      GGML_ASSERT(
+00093e90: 7374 6172 7420 2520 514b 5f4b 203d 3d20  start % QK_K == 
+00093ea0: 3029 3b0a 2020 2020 2020 2020 2020 2020  0);.            
+00093eb0: 2020 2020 626c 6f63 6b5f 7135 5f4b 202a      block_q5_K *
+00093ec0: 2062 6c6f 636b 203d 2028 626c 6f63 6b5f   block = (block_
+00093ed0: 7135 5f4b 2a29 6473 7420 2b20 7374 6172  q5_K*)dst + star
+00093ee0: 7420 2f20 514b 5f4b 3b0a 2020 2020 2020  t / QK_K;.      
+00093ef0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00093f00: 203d 2067 676d 6c5f 7175 616e 7469 7a65   = ggml_quantize
+00093f10: 5f71 355f 4b28 7372 6320 2b20 7374 6172  _q5_K(src + star
+00093f20: 742c 2062 6c6f 636b 2c20 6e2c 206e 2c20  t, block, n, n, 
+00093f30: 6869 7374 293b 0a20 2020 2020 2020 2020  hist);.         
+00093f40: 2020 207d 2062 7265 616b 3b0a 2020 2020     } break;.    
+00093f50: 2020 2020 6361 7365 2047 474d 4c5f 5459      case GGML_TY
+00093f60: 5045 5f51 365f 4b3a 0a20 2020 2020 2020  PE_Q6_K:.       
+00093f70: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00093f80: 2020 2020 2020 2047 474d 4c5f 4153 5345         GGML_ASSE
+00093f90: 5254 2873 7461 7274 2025 2051 4b5f 4b20  RT(start % QK_K 
+00093fa0: 3d3d 2030 293b 0a20 2020 2020 2020 2020  == 0);.         
+00093fb0: 2020 2020 2020 2062 6c6f 636b 5f71 365f         block_q6_
+00093fc0: 4b20 2a20 626c 6f63 6b20 3d20 2862 6c6f  K * block = (blo
+00093fd0: 636b 5f71 365f 4b2a 2964 7374 202b 2073  ck_q6_K*)dst + s
+00093fe0: 7461 7274 202f 2051 4b5f 4b3b 0a20 2020  tart / QK_K;.   
+00093ff0: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00094000: 756c 7420 3d20 6767 6d6c 5f71 7561 6e74  ult = ggml_quant
+00094010: 697a 655f 7136 5f4b 2873 7263 202b 2073  ize_q6_K(src + s
+00094020: 7461 7274 2c20 626c 6f63 6b2c 206e 2c20  tart, block, n, 
+00094030: 6e2c 2068 6973 7429 3b0a 2020 2020 2020  n, hist);.      
+00094040: 2020 2020 2020 7d20 6272 6561 6b3b 0a23        } break;.#
+00094050: 656e 6469 660a 2020 2020 2020 2020 6361  endif.        ca
+00094060: 7365 2047 474d 4c5f 5459 5045 5f46 3136  se GGML_TYPE_F16
+00094070: 3a0a 2020 2020 2020 2020 2020 2020 7b0a  :.            {.
+00094080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00094090: 696e 7420 656c 656d 7369 7a65 203d 2073  int elemsize = s
+000940a0: 697a 656f 6628 6767 6d6c 5f66 7031 365f  izeof(ggml_fp16_
+000940b0: 7429 3b0a 2020 2020 2020 2020 2020 2020  t);.            
+000940c0: 2020 2020 6767 6d6c 5f66 7033 325f 746f      ggml_fp32_to
+000940d0: 5f66 7031 365f 726f 7728 7372 6320 2b20  _fp16_row(src + 
+000940e0: 7374 6172 742c 2028 6767 6d6c 5f66 7031  start, (ggml_fp1
+000940f0: 365f 7420 2a29 6473 7420 2b20 7374 6172  6_t *)dst + star
+00094100: 742c 206e 293b 0a20 2020 2020 2020 2020  t, n);.         
+00094110: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00094120: 6e20 2a20 656c 656d 7369 7a65 3b0a 2020  n * elemsize;.  
+00094130: 2020 2020 2020 2020 2020 7d20 6272 6561            } brea
+00094140: 6b3b 0a20 2020 2020 2020 2063 6173 6520  k;.        case 
+00094150: 4747 4d4c 5f54 5950 455f 4633 323a 0a20  GGML_TYPE_F32:. 
+00094160: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00094170: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+00094180: 2065 6c65 6d73 697a 6520 3d20 7369 7a65   elemsize = size
+00094190: 6f66 2866 6c6f 6174 293b 0a20 2020 2020  of(float);.     
+000941a0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+000941b0: 7420 3d20 6e20 2a20 656c 656d 7369 7a65  t = n * elemsize
+000941c0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+000941d0: 2020 6d65 6d63 7079 2828 7569 6e74 385f    memcpy((uint8_
+000941e0: 7420 2a29 6473 7420 2b20 7374 6172 7420  t *)dst + start 
+000941f0: 2a20 656c 656d 7369 7a65 2c20 7372 6320  * elemsize, src 
+00094200: 2b20 7374 6172 742c 2072 6573 756c 7429  + start, result)
+00094210: 3b0a 2020 2020 2020 2020 2020 2020 7d20  ;.            } 
+00094220: 6272 6561 6b3b 0a20 2020 2020 2020 2064  break;.        d
+00094230: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
+00094240: 2020 2020 6173 7365 7274 2866 616c 7365      assert(false
+00094250: 293b 0a20 2020 207d 0a20 2020 2072 6574  );.    }.    ret
+00094260: 7572 6e20 7265 7375 6c74 3b0a 7d0a 0a2f  urn result;.}../
+00094270: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00094280: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00094290: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000942a0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+000942b0: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f0a  ///////////////.
+000942c0: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
+000942d0: 735f 6176 7828 766f 6964 2920 7b0a 2369  s_avx(void) {.#i
+000942e0: 6620 6465 6669 6e65 6428 5f5f 4156 585f  f defined(__AVX_
+000942f0: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
+00094300: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+00094310: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+00094320: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+00094330: 6176 7832 2876 6f69 6429 207b 0a23 6966  avx2(void) {.#if
+00094340: 2064 6566 696e 6564 285f 5f41 5658 325f   defined(__AVX2_
+00094350: 5f29 0a20 2020 2072 6574 7572 6e20 313b  _).    return 1;
+00094360: 0a23 656c 7365 0a20 2020 2072 6574 7572  .#else.    retur
+00094370: 6e20 303b 0a23 656e 6469 660a 7d0a 0a69  n 0;.#endif.}..i
+00094380: 6e74 2067 676d 6c5f 6370 755f 6861 735f  nt ggml_cpu_has_
+00094390: 6176 7835 3132 2876 6f69 6429 207b 0a23  avx512(void) {.#
+000943a0: 6966 2064 6566 696e 6564 285f 5f41 5658  if defined(__AVX
+000943b0: 3531 3246 5f5f 290a 2020 2020 7265 7475  512F__).    retu
+000943c0: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
+000943d0: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
+000943e0: 0a7d 0a0a 696e 7420 6767 6d6c 5f63 7075  .}..int ggml_cpu
+000943f0: 5f68 6173 5f61 7678 3531 325f 7662 6d69  _has_avx512_vbmi
+00094400: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
+00094410: 696e 6564 285f 5f41 5658 3531 3256 424d  ined(__AVX512VBM
+00094420: 495f 5f29 0a20 2020 2072 6574 7572 6e20  I__).    return 
+00094430: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
+00094440: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
+00094450: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
+00094460: 735f 6176 7835 3132 5f76 6e6e 6928 766f  s_avx512_vnni(vo
+00094470: 6964 2920 7b0a 2369 6620 6465 6669 6e65  id) {.#if define
+00094480: 6428 5f5f 4156 5835 3132 564e 4e49 5f5f  d(__AVX512VNNI__
+00094490: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
+000944a0: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
+000944b0: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
+000944c0: 7420 6767 6d6c 5f63 7075 5f68 6173 5f66  t ggml_cpu_has_f
+000944d0: 6d61 2876 6f69 6429 207b 0a23 6966 2064  ma(void) {.#if d
+000944e0: 6566 696e 6564 285f 5f46 4d41 5f5f 290a  efined(__FMA__).
+000944f0: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+00094500: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+00094510: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+00094520: 6767 6d6c 5f63 7075 5f68 6173 5f6e 656f  ggml_cpu_has_neo
+00094530: 6e28 766f 6964 2920 7b0a 2369 6620 6465  n(void) {.#if de
+00094540: 6669 6e65 6428 5f5f 4152 4d5f 4e45 4f4e  fined(__ARM_NEON
+00094550: 290a 2020 2020 7265 7475 726e 2031 3b0a  ).    return 1;.
+00094560: 2365 6c73 650a 2020 2020 7265 7475 726e  #else.    return
+00094570: 2030 3b0a 2365 6e64 6966 0a7d 0a0a 696e   0;.#endif.}..in
+00094580: 7420 6767 6d6c 5f63 7075 5f68 6173 5f61  t ggml_cpu_has_a
+00094590: 726d 5f66 6d61 2876 6f69 6429 207b 0a23  rm_fma(void) {.#
+000945a0: 6966 2064 6566 696e 6564 285f 5f41 524d  if defined(__ARM
+000945b0: 5f46 4541 5455 5245 5f46 4d41 290a 2020  _FEATURE_FMA).  
+000945c0: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
+000945d0: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
+000945e0: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
+000945f0: 6d6c 5f63 7075 5f68 6173 5f66 3136 6328  ml_cpu_has_f16c(
+00094600: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
+00094610: 6e65 6428 5f5f 4631 3643 5f5f 290a 2020  ned(__F16C__).  
+00094620: 2020 7265 7475 726e 2031 3b0a 2365 6c73    return 1;.#els
+00094630: 650a 2020 2020 7265 7475 726e 2030 3b0a  e.    return 0;.
+00094640: 2365 6e64 6966 0a7d 0a0a 696e 7420 6767  #endif.}..int gg
+00094650: 6d6c 5f63 7075 5f68 6173 5f66 7031 365f  ml_cpu_has_fp16_
+00094660: 7661 2876 6f69 6429 207b 0a23 6966 2064  va(void) {.#if d
+00094670: 6566 696e 6564 285f 5f41 524d 5f46 4541  efined(__ARM_FEA
+00094680: 5455 5245 5f46 5031 365f 5645 4354 4f52  TURE_FP16_VECTOR
+00094690: 5f41 5249 5448 4d45 5449 4329 0a20 2020  _ARITHMETIC).   
+000946a0: 2072 6574 7572 6e20 313b 0a23 656c 7365   return 1;.#else
+000946b0: 0a20 2020 2072 6574 7572 6e20 303b 0a23  .    return 0;.#
+000946c0: 656e 6469 660a 7d0a 0a69 6e74 2067 676d  endif.}..int ggm
+000946d0: 6c5f 6370 755f 6861 735f 7761 736d 5f73  l_cpu_has_wasm_s
+000946e0: 696d 6428 766f 6964 2920 7b0a 2369 6620  imd(void) {.#if 
+000946f0: 6465 6669 6e65 6428 5f5f 7761 736d 5f73  defined(__wasm_s
+00094700: 696d 6431 3238 5f5f 290a 2020 2020 7265  imd128__).    re
+00094710: 7475 726e 2031 3b0a 2365 6c73 650a 2020  turn 1;.#else.  
+00094720: 2020 7265 7475 726e 2030 3b0a 2365 6e64    return 0;.#end
+00094730: 6966 0a7d 0a0a 696e 7420 6767 6d6c 5f63  if.}..int ggml_c
+00094740: 7075 5f68 6173 5f62 6c61 7328 766f 6964  pu_has_blas(void
+00094750: 2920 7b0a 2369 6620 6465 6669 6e65 6428  ) {.#if defined(
+00094760: 4747 4d4c 5f55 5345 5f41 4343 454c 4552  GGML_USE_ACCELER
+00094770: 4154 4529 207c 7c20 6465 6669 6e65 6428  ATE) || defined(
+00094780: 4747 4d4c 5f55 5345 5f4f 5045 4e42 4c41  GGML_USE_OPENBLA
+00094790: 5329 207c 7c20 6465 6669 6e65 6428 4747  S) || defined(GG
+000947a0: 4d4c 5f55 5345 5f43 5542 4c41 5329 207c  ML_USE_CUBLAS) |
+000947b0: 7c20 6465 6669 6e65 6428 4747 4d4c 5f55  | defined(GGML_U
+000947c0: 5345 5f43 4c42 4c41 5354 290a 2020 2020  SE_CLBLAST).    
+000947d0: 7265 7475 726e 2031 3b0a 2365 6c73 650a  return 1;.#else.
+000947e0: 2020 2020 7265 7475 726e 2030 3b0a 2365      return 0;.#e
+000947f0: 6e64 6966 0a7d 0a0a 696e 7420 6767 6d6c  ndif.}..int ggml
+00094800: 5f63 7075 5f68 6173 5f63 7562 6c61 7328  _cpu_has_cublas(
+00094810: 766f 6964 2920 7b0a 2369 6620 6465 6669  void) {.#if defi
+00094820: 6e65 6428 4747 4d4c 5f55 5345 5f43 5542  ned(GGML_USE_CUB
+00094830: 4c41 5329 0a20 2020 2072 6574 7572 6e20  LAS).    return 
+00094840: 313b 0a23 656c 7365 0a20 2020 2072 6574  1;.#else.    ret
+00094850: 7572 6e20 303b 0a23 656e 6469 660a 7d0a  urn 0;.#endif.}.
+00094860: 0a69 6e74 2067 676d 6c5f 6370 755f 6861  .int ggml_cpu_ha
+00094870: 735f 636c 626c 6173 7428 766f 6964 2920  s_clblast(void) 
+00094880: 7b0a 2369 6620 6465 6669 6e65 6428 4747  {.#if defined(GG
+00094890: 4d4c 5f55 5345 5f43 4c42 4c41 5354 290a  ML_USE_CLBLAST).
+000948a0: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+000948b0: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+000948c0: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+000948d0: 6767 6d6c 5f63 7075 5f68 6173 5f67 7075  ggml_cpu_has_gpu
+000948e0: 626c 6173 2876 6f69 6429 207b 0a20 2020  blas(void) {.   
+000948f0: 2072 6574 7572 6e20 6767 6d6c 5f63 7075   return ggml_cpu
+00094900: 5f68 6173 5f63 7562 6c61 7328 2920 7c7c  _has_cublas() ||
+00094910: 2067 676d 6c5f 6370 755f 6861 735f 636c   ggml_cpu_has_cl
+00094920: 626c 6173 7428 293b 0a7d 0a0a 696e 7420  blast();.}..int 
+00094930: 6767 6d6c 5f63 7075 5f68 6173 5f73 7365  ggml_cpu_has_sse
+00094940: 3328 766f 6964 2920 7b0a 2369 6620 6465  3(void) {.#if de
+00094950: 6669 6e65 6428 5f5f 5353 4533 5f5f 290a  fined(__SSE3__).
+00094960: 2020 2020 7265 7475 726e 2031 3b0a 2365      return 1;.#e
+00094970: 6c73 650a 2020 2020 7265 7475 726e 2030  lse.    return 0
+00094980: 3b0a 2365 6e64 6966 0a7d 0a0a 696e 7420  ;.#endif.}..int 
+00094990: 6767 6d6c 5f63 7075 5f68 6173 5f76 7378  ggml_cpu_has_vsx
+000949a0: 2876 6f69 6429 207b 0a23 6966 2064 6566  (void) {.#if def
+000949b0: 696e 6564 285f 5f50 4f57 4552 395f 5645  ined(__POWER9_VE
+000949c0: 4354 4f52 5f5f 290a 2020 2020 7265 7475  CTOR__).    retu
+000949d0: 726e 2031 3b0a 2365 6c73 650a 2020 2020  rn 1;.#else.    
+000949e0: 7265 7475 726e 2030 3b0a 2365 6e64 6966  return 0;.#endif
+000949f0: 0a7d 0a0a 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  .}..////////////
+00094a00: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00094a10: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00094a20: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00094a30: 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f 2f2f  ////////////////
+00094a40: 2f2f 2f2f 0a                             ////.
```

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml/tests/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-blas0.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-blas0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-grad0.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-grad0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat0.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-mul-mat0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat1.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-mul-mat1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-mul-mat2.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-mul-mat2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-opt.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-opt.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-pool.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-pool.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-quantize-fns.cpp` & `ggml-python-0.0.9/vendor/ggml/tests/test-quantize-fns.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-quantize-perf.cpp` & `ggml-python-0.0.9/vendor/ggml/tests/test-quantize-perf.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-svd0.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-svd0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-vec0.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-vec0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-vec1.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-vec1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test-vec2.c` & `ggml-python-0.0.9/vendor/ggml/tests/test-vec2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test0.c` & `ggml-python-0.0.9/vendor/ggml/tests/test0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test0.zig` & `ggml-python-0.0.9/vendor/ggml/tests/test0.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test1.c` & `ggml-python-0.0.9/vendor/ggml/tests/test1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test1.zig` & `ggml-python-0.0.9/vendor/ggml/tests/test1.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test2.c` & `ggml-python-0.0.9/vendor/ggml/tests/test2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test2.zig` & `ggml-python-0.0.9/vendor/ggml/tests/test2.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test3.c` & `ggml-python-0.0.9/vendor/ggml/tests/test3.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml/tests/test3.zig` & `ggml-python-0.0.9/vendor/ggml/tests/test3.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/.github/workflows/ci.yml` & `ggml-python-0.0.9/vendor/ggml-cpy/.github/workflows/ci.yml`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/LICENSE` & `ggml-python-0.0.9/vendor/ggml-cpy/LICENSE`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/build.zig` & `ggml-python-0.0.9/vendor/ggml-cpy/build.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/cmake/BuildTypes.cmake` & `ggml-python-0.0.9/vendor/ggml-cpy/cmake/BuildTypes.cmake`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/cmake/GitVars.cmake` & `ggml-python-0.0.9/vendor/ggml-cpy/cmake/GitVars.cmake`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/common-ggml.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/common-ggml.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/common.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/common.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/common.h` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/common.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/dolly-v2/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/dolly-v2/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/dr_wav.h` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/dr_wav.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-cerebras-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/convert-cerebras-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-ckpt-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/convert-ckpt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/download-ggml-model.sh` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/download-model.sh` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-2/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-2/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/download-ggml-model.sh` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/download-ggml-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/download-model.sh` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/download-model.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-j/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-j/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/gpt-neox/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/gpt-neox/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-cpu.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main-cpu.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main-mtl.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main-mtl.m` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main-mtl.m`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mnist/web/index.html` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mnist/web/index.html`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mpt/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mpt/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/mpt/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/mpt/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/dolly-v2.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/dolly-v2.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-2.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-2.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-j.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-j.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/gpt-neox.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/gpt-neox.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/replit.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/replit.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/starcoder.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/starcoder.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/test-cases.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/test-cases.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/tokenize_huggingface.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/tokenize_huggingface.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/prompts/whisper.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/prompts/whisper.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/convert-h5-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/replit/convert-h5-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/replit/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/replit/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/replit/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/convert-hf-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/convert-hf-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/starcoder/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/starcoder/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/README.md` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/README.md`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/convert-pt-to-ggml.py` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/convert-pt-to-ggml.py`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/main.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/main.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/quantize.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/quantize.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/whisper.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/examples/whisper/whisper.h` & `ggml-python-0.0.9/vendor/ggml-cpy/examples/whisper/whisper.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/include/ggml/ggml.h` & `ggml-python-0.0.9/vendor/ggml-cpy/include/ggml/ggml.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/scripts/sync-llama.sh` & `ggml-python-0.0.9/vendor/ggml-cpy/scripts/sync-llama.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/scripts/sync-whisper.sh` & `ggml-python-0.0.9/vendor/ggml-cpy/scripts/sync-whisper.sh`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/src/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.cu` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-cuda.cu`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-cuda.h` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-cuda.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.h` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-metal.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.m` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-metal.m`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-metal.metal` & `ggml-python-0.0.9/vendor/ggml/src/ggml-metal.metal`

 * *Files 4% similar despite different names*

```diff
@@ -361,148 +361,189 @@
 
     device float * y = dst + tgpig*ne00;
     for (int i00 = tpitg; i00 < ne00; i00 += ntg) {
         y[i00] = x[i00] * scale;
     }
 }
 
+// putting them in the kernel cause a significant performance penalty
+#define N_DST 4 // each SIMD group works on 4 rows
+#define N_SIMDGROUP 2 // number of SIMD groups in a thread group
+#define N_SIMDWIDTH 32 // assuming SIMD group size is 32
 kernel void kernel_mul_mat_q4_0_f32(
         device const  void * src0,
         device const float * src1,
         device       float * dst,
         constant   int64_t & ne00,
         constant   int64_t & ne10,
         constant   int64_t & ne0,
-        threadgroup float  * sum [[threadgroup(0)]],
+        constant   int64_t & ne01[[buffer(4)]],
         uint2 tgpig[[threadgroup_position_in_grid]],
-        uint2 tpitg[[thread_position_in_threadgroup]],
-        uint2  tptg[[threads_per_threadgroup]]) {
+        uint tiisg[[thread_index_in_simdgroup]],
+        uint sgitg[[simdgroup_index_in_threadgroup]]) {
     const int nb = ne00/QK4_0;
-
-    const int64_t r0 = tgpig.x;
-    const int64_t r1 = tgpig.y;
-
-    device const block_q4_0 * x = (device const block_q4_0 *) src0 + r0*nb;
+    const int r0 = tgpig.x;
+    const int r1 = tgpig.y;
+    device const block_q4_0 * x = (device const block_q4_0 *) src0 + (r0 * N_SIMDGROUP + sgitg) * N_DST * nb;
     device const float      * y = (device const float      *) src1 + r1*ne10;
-
-    const int nth = tptg.x*tptg.y;
-    const int ith = tptg.y*tpitg.x + tpitg.y;
-
-    const int ix = tpitg.y/4;           // 0 or 1
-    const int iy = tpitg.y - 4*ix;      // 0...3
-
-    const int first = 4 * iy;
-
-    float sumf = 0;
-
-    for (int i = 2*tpitg.x + ix; i < nb; i += 2*tptg.x) {
-
-        const float d = (float)x[i].d;
-
-        device const uint8_t * xl = x[i].qs + first;
-        device const float   * yl = y + i * QK4_0 + first;
-
-        float2 acc = {0.0f, 0.0f};
-
-        for (int j = 0; j < 4; ++j) {
-
-            acc[0] += yl[j] * (xl[j] & 0xF) + yl[j+16] * (xl[j] >> 4);
-            acc[1] += yl[j] + yl[j+16];
-
+    block_q4_0 qb_curr, qb_next;
+    float4 y_curr[8];       // src1 vector cache
+    float sumf[N_DST]={0.f}, all_sum;
+    thread float * yl=(thread float *)y_curr;
+
+    // bootstrap
+    qb_curr = x[tiisg];
+    // each thread in a SIMD group deals with 1 block.
+    for (int column = 0; column < nb / N_SIMDWIDTH; column++) {
+
+        float sumy = 0;
+        for (int i = 0; i < QK4_0 / 4; i++) {
+            y_curr[i] = *((device float4  *)(y + N_SIMDWIDTH * (tiisg + column * QK4_0) + 4 * i));
+            sumy += y_curr[i][0] + y_curr[i][1] + y_curr[i][2] + y_curr[i][3];
         }
+        sumy *= (-8.f);
 
-        sumf += d * (acc[0] - 8.f*acc[1]);
+        for (int row = 0; row < N_DST; row++) {
+            // prefetch next x block
+            qb_next = x[tiisg + ((row + 1) % N_DST) * nb + (column + ((row + 1) / N_DST)) * N_SIMDWIDTH];
+
+            // calculate
+            float d = qb_curr.d;
+            float acc = sumy;
+            for (int i = 0; i < 16; i++) {
+                acc += yl[i] * (qb_curr.qs[i] & 0xF) + yl[i+16] * (qb_curr.qs[i] >> 4);
+            }
+            sumf[row] += d * acc;
+            qb_curr = qb_next;
+        }
     }
 
-    sum[ith] = sumf;
+    if (nb % N_SIMDWIDTH == 0) {
+        for (int row = 0; row < N_DST; ++row) {
+            all_sum = simd_sum(sumf[row]);
+            if (tiisg == 0 && ((r0 * N_SIMDGROUP + sgitg) * N_DST + row) < ne01) {
+                dst[r1*ne0 + (r0 * N_SIMDGROUP + sgitg) * N_DST + row] = all_sum;
+            }
+        }
+    } else {
 
-    //
-    // Accumulate the sum from all threads in the threadgroup
-    //
-    threadgroup_barrier(mem_flags::mem_threadgroup);
-    if (ith%4 == 0) {
-        sum[ith] += sum[ith+1] + sum[ith+2] + sum[ith+3];
-    }
-    threadgroup_barrier(mem_flags::mem_threadgroup);
-    if (ith%16 == 0) {
-        sum[ith] += sum[ith+4] + sum[ith+8] + sum[ith+12];
-    }
-    threadgroup_barrier(mem_flags::mem_threadgroup);
-    if (ith == 0) {
-        for (int i = 16; i < nth; i += 16) sum[0] += sum[i];
-        dst[r1*ne0 + r0] = sum[0];
+        float sumy = 0;
+        for (int i = 0; i < QK4_0 / 4; i++) {
+            y_curr[i] = *((device float4 *)(y + N_SIMDWIDTH * (tiisg + (nb / N_SIMDWIDTH) * QK4_0) + 4 * i));
+            sumy += y_curr[i][0] + y_curr[i][1] + y_curr[i][2] + y_curr[i][3];
+        }
+        sumy *= (-8.f);
+
+        for (int row = 0; row < N_DST; row++) {
+            // prefetch next x block
+            qb_next = x[tiisg + ((row + 1) % N_DST) * nb + (nb / N_SIMDWIDTH + ((row + 1) / N_DST)) * N_SIMDWIDTH];
+
+            // calculate
+            float d = qb_curr.d;
+            float acc = sumy;
+            for (int i = 0; i < 16; i++) {
+                acc += yl[i] * (qb_curr.qs[i] & 0xF) + yl[i+16] * (qb_curr.qs[i] >> 4);
+            }
+            if (tiisg < nb % N_SIMDWIDTH) {
+                sumf[row] += d * acc;
+            }
+            qb_curr = qb_next;
+
+            all_sum = simd_sum(sumf[row]);
+            if (tiisg == 0 && ((r0 * N_SIMDGROUP + sgitg) * N_DST + row) < ne01) {
+                dst[r1*ne0 + (r0 * N_SIMDGROUP + sgitg) * N_DST + row] = all_sum;
+            }
+        }
     }
 }
 
 kernel void kernel_mul_mat_q4_1_f32(
         device const  void * src0,
         device const float * src1,
         device       float * dst,
         constant   int64_t & ne00,
         constant   int64_t & ne10,
         constant   int64_t & ne0,
-        threadgroup float  * sum [[threadgroup(0)]],
+        constant   int64_t & ne01[[buffer(4)]],
         uint2 tgpig[[threadgroup_position_in_grid]],
-        uint2 tpitg[[thread_position_in_threadgroup]],
-        uint2  tptg[[threads_per_threadgroup]]) {
-    const int nb = ne00/QK4_1;
-
-    const int64_t r0 = tgpig.x;
-    const int64_t r1 = tgpig.y;
-
-    device const block_q4_1 * x = (device const block_q4_1 *) src0 + r0*nb;
+        uint tiisg[[thread_index_in_simdgroup]],
+        uint sgitg[[simdgroup_index_in_threadgroup]]) {
+    const int nb = ne00/QK4_0;
+    const int r0 = tgpig.x;
+    const int r1 = tgpig.y;
+    device const block_q4_1 * x = (device const block_q4_1 *) src0 + (r0 * N_SIMDGROUP + sgitg) * N_DST * nb;
     device const float      * y = (device const float      *) src1 + r1*ne10;
-
-    const uint nth = tptg.x*tptg.y;
-    const uint ith = tptg.y*tpitg.x + tpitg.y;
-
-    const int ix = tpitg.y/4;           // 0 or 1
-    const int iy = tpitg.y - 4*ix;      // 0...3
-
-    const int first = 4 * iy;
-
-    float sumf = 0;
-
-    for (int i = 2*tpitg.x + ix; i < nb; i += 2*tptg.x) {
-
-        const float d = (float)x[i].d;
-        const float m = (float)x[i].m;
-
-        device const uint8_t * xl = x[i].qs + first;
-        device const float   * yl = y + i * QK4_1 + first;
-
-        float2 acc = {0.0f, 0.0f};
-
-        for (int j = 0; j < 4; ++j) {
-
-            acc[0] += yl[j+ 0] * (d * (xl[j] & 0xF) + m);
-            acc[1] += yl[j+16] * (d * (xl[j] >>  4) + m);
-
+    block_q4_1 qb_curr, qb_next;
+    float4 y_curr[8];       // src1 vector cache
+    float sumf[N_DST]={0.f}, all_sum;
+    thread float * yl=(thread float *)y_curr;
+
+    // bootstrap
+    qb_curr = x[tiisg];
+    // each thread in a SIMD group deals with 1 block.
+    for (int column = 0; column < nb / N_SIMDWIDTH; column++) {
+
+        float sumy = 0;
+        for (int i = 0; i < QK4_0 / 4; i++) {
+            y_curr[i] = *((device float4  *)(y + N_SIMDWIDTH * (tiisg + column * QK4_0) + 4 * i));
+            sumy += y_curr[i][0] + y_curr[i][1] + y_curr[i][2] + y_curr[i][3];
         }
 
-        sumf += acc[0] + acc[1];
+        for (int row = 0; row < N_DST; row++) {
+            // prefetch next x block
+            qb_next = x[tiisg + ((row + 1) % N_DST) * nb + (column + ((row + 1) / N_DST)) * N_SIMDWIDTH];
+
+            // calculate
+            const float d = qb_curr.d;
+            const float m = qb_curr.m;
+            float acc = 0.f;
+            for (int i = 0; i < 16; i++) {
+                acc += yl[i] * (qb_curr.qs[i] & 0xF) + yl[i+16] * (qb_curr.qs[i] >> 4);
+            }
+            sumf[row] += d * acc + m * sumy;
+            qb_curr = qb_next;
+        }
     }
 
-    sum[ith] = sumf;
+    if (nb % N_SIMDWIDTH == 0) {
+        for (int row = 0; row < N_DST; ++row) {
+            all_sum = simd_sum(sumf[row]);
+            if (tiisg == 0 && ((r0 * N_SIMDGROUP + sgitg) * N_DST + row) < ne01) {
+                dst[r1*ne0 + (r0 * N_SIMDGROUP + sgitg) * N_DST + row] = all_sum;
+            }
+        }
+    } else {
+
+        float sumy = 0;
+        for (int i = 0; i < QK4_0 / 4; i++) {
+            y_curr[i] = *((device float4 *)(y + N_SIMDWIDTH * (tiisg + (nb / N_SIMDWIDTH) * QK4_0) + 4 * i));
+            sumy += y_curr[i][0] + y_curr[i][1] + y_curr[i][2] + y_curr[i][3];
+        }
 
-    //
-    // Accumulate the sum from all threads in the threadgroup
-    //
-    threadgroup_barrier(mem_flags::mem_threadgroup);
-    if (ith%4 == 0) {
-        sum[ith] += sum[ith+1] + sum[ith+2] + sum[ith+3];
-    }
-    threadgroup_barrier(mem_flags::mem_threadgroup);
-    if (ith%16 == 0) {
-        sum[ith] += sum[ith+4] + sum[ith+8] + sum[ith+12];
-    }
-    threadgroup_barrier(mem_flags::mem_threadgroup);
-    if (ith == 0) {
-        for (uint i = 16; i < nth; i += 16) sum[0] += sum[i];
-        dst[r1*ne0 + r0] = sum[0];
+        for (int row = 0; row < N_DST; row++) {
+            // prefetch next x block
+            qb_next = x[tiisg + ((row + 1) % N_DST) * nb + (nb / N_SIMDWIDTH + ((row + 1) / N_DST)) * N_SIMDWIDTH];
+
+            // calculate
+            const float d = qb_curr.d;
+            const float m = qb_curr.m;
+            float acc = 0.f;
+            for (int i = 0; i < 16; i++) {
+                acc += yl[i] * (qb_curr.qs[i] & 0xF) + yl[i+16] * (qb_curr.qs[i] >> 4);
+            }
+            if (tiisg < nb % N_SIMDWIDTH) {
+                sumf[row] += d * acc + m * sumy;
+            }
+            qb_curr = qb_next;
+
+            all_sum = simd_sum(sumf[row]);
+            if (tiisg == 0 && ((r0 * N_SIMDGROUP + sgitg) * N_DST + row) < ne01) {
+                dst[r1*ne0 + (r0 * N_SIMDGROUP + sgitg) * N_DST + row] = all_sum;
+            }
+        }
     }
 }
 
 kernel void kernel_mul_mat_f16_f32(
         device const  char * src0,
         device const  char * src1,
         device       float * dst,
```

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-opencl.cpp` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-opencl.cpp`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml-opencl.h` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml-opencl.h`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/src/ggml.c` & `ggml-python-0.0.9/vendor/ggml-cpy/src/ggml.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/CMakeLists.txt` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/CMakeLists.txt`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-blas0.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-blas0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-grad0.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-grad0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat0.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-mul-mat0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat1.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-mul-mat1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-mul-mat2.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-mul-mat2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-opt.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-opt.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-svd0.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-svd0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec0.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-vec0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec1.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-vec1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test-vec2.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test-vec2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test0.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test0.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test0.zig` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test0.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test1.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test1.zig` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test1.zig`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test2.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test2.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/vendor/ggml-cpy/tests/test3.c` & `ggml-python-0.0.9/vendor/ggml-cpy/tests/test3.c`

 * *Files identical despite different names*

### Comparing `ggml-python-0.0.8/PKG-INFO` & `ggml-python-0.0.9/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ggml-python
-Version: 0.0.8
+Version: 0.0.9
 Summary: Python bindings for ggml
 Author-Email: Andrei Betlen <abetlen@gmail.com>
 License: MIT
 Classifier: Programming Language :: Python :: 3
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
```

